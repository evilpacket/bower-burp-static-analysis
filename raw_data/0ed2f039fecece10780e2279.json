{
    "url": "http://localhost:9999/basisjs/basisjs/test/runner/script.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.href</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>baseEl.setAttribute(\"href\", location.href);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/basisjs/basisjs/test/runner/script.js",
                "path": "/basisjs/basisjs/test/runner/script.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9iYXNpc2pzL2Jhc2lzanMvdGVzdC9ydW5uZXIvc2NyaXB0LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTUxMzgzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjExOjA0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMjoxMDo1OCBHTVQNCg0KLy8gcmVzb3VyY2VzICg0MCk6Ci8vICBbc3RyaW5nXSBbdW5rbm93biMxXSAtPiAwLmNzcwovLyAgW3N0cmluZ10gY29yZS9lbnYvaWZyYW1lX2luamVjdC5jb2RlIC0+IDAuY29kZQovLyAgW2FycmF5XSByZXBvcnRlci90ZW1wbGF0ZS92aWV3LnRtcGwgLT4gOC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL21vZHVsZS90b2MvdGVtcGxhdGUvdG9jLWl0ZW0udG1wbCAtPiAxLnRtcGwKLy8gIFthcnJheV0gcmVwb3J0ZXIvbW9kdWxlL3RvYy90ZW1wbGF0ZS90b2MudG1wbCAtPiAyLnRtcGwKLy8gIFthcnJheV0gY29yZS9lbnYvaWZyYW1lLnRtcGwgLT4gMC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LnRtcGwgLT4gNC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LXN1aXRlLnRtcGwgLT4gNS50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LWNhc2UudG1wbCAtPiA2LnRtcGwKLy8gIFthcnJheV0gcmVwb3J0ZXIvbW9kdWxlL3Rlc3QtdHJlZS90ZW1wbGF0ZS92aWV3LnRtcGwgLT4gNy50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LXNvdXJjZS50bXBsIC0+IDMudG1wbAovLyAgW3N0cmluZ10gY29yZS5qcyAtPiBiLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvcnVubmVyLmpzIC0+IGMuanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy9kYXRhL2RhdGFzZXQuanMgLT4gZC5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2RhdGEvaW5kZXguanMgLT4gZS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2RhdGEvdmFsdWUuanMgLT4gZi5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3V0aWxzL2JlbmNobWFyay5qcyAtPiBnLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvdGVzdC5qcyAtPiBoLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvdXRpbHMuanMgLT4gcC5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3V0aWxzL2luZm8uanMgLT4gaS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2FwcC5qcyAtPiAxLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvZW52L2lmcmFtZS5qcyAtPiBxLmpzCi8vICBbZnVuY3Rpb25dIHJlcG9ydGVyL2FwcC5qcyAtPiAwLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvdWkuanMgLT4gMi5qcwovLyAgW2Z1bmN0aW9uXSBjb3JlL2FzdC5qcyAtPiBrLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvZXNwcmltYS9lc3ByaW1hLmpzIC0+IGwuanMKLy8gIFtmdW5jdGlvbl0gcmVwb3J0ZXIvbW9kdWxlL3RvYy9pbmRleC5qcyAtPiByLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvbDEwbi5qcyAtPiAzLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZXZlbnQuanMgLT4gNC5qcwovLyAgW2Z1bmN0aW9uXSByZXBvcnRlci9tb2R1bGUvdGVzdC10cmVlL2luZGV4LmpzIC0+IHMuanMKLy8gIFtmdW5jdGlvbl0gcmVwb3J0ZXIvYXBwL3Rlc3QuanMgLT4gbS5qcwovLyAgW2Z1bmN0aW9uXSByZXBvcnRlci9hcHAvaGlnaGxpZ2h0LmpzIC0+IG4uanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9qc2RpZmYvZGlmZi5qcyAtPiBvLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZGF0YS5qcyAtPiA1LmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZG9tL3dyYXBwZXIuanMgLT4gNi5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3RlbXBsYXRlLmpzIC0+IDcuanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sLmpzIC0+IDguanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy9kb20vZXZlbnQuanMgLT4gOS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3RlbXBsYXRlL2h0bWxmZ2VuLmpzIC0+IGEuanMKLy8gIFtmdW5jdGlvbl0gY29yZS9lbnYuanMgLT4gai5qcwovLwovLyBmaWxlbGlzdCAoNCk6IAovLyAgIHJlcG9ydGVyL2FwcC5qcwovLyAgIGNvcmUuanMKLy8gICAuLi9ib3dlcl9jb21wb25lbnRzL2VzcHJpbWEvZXNwcmltYS5qcwovLyAgIC4uL2Jvd2VyX2NvbXBvbmVudHMvanNkaWZmL2RpZmYuanMKKGZ1bmN0aW9uKCl7CiJ1c2Ugc3RyaWN0IjsKCnZhciBfX25hbWVzcGFjZV9tYXBfXyA9IHsiMC5qcyI6ImFwcCIsIjEuanMiOiJiYXNpcy5hcHAiLCIyLmpzIjoiYmFzaXMudWkiLCIzLmpzIjoiYmFzaXMubDEwbiIsIjQuanMiOiJiYXNpcy5ldmVudCIsIjUuanMiOiJiYXNpcy5kYXRhIiwiNi5qcyI6ImJhc2lzLmRvbS53cmFwcGVyIiwiNy5qcyI6ImJhc2lzLnRlbXBsYXRlIiwiOC5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWwiLCI5LmpzIjoiYmFzaXMuZG9tLmV2ZW50IiwiYS5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWxmZ2VuIiwiYi5qcyI6ImNvcmUiLCJjLmpzIjoiY29yZS5ydW5uZXIiLCJkLmpzIjoiYmFzaXMuZGF0YS5kYXRhc2V0IiwiZS5qcyI6ImJhc2lzLmRhdGEuaW5kZXgiLCJmLmpzIjoiYmFzaXMuZGF0YS52YWx1ZSIsImcuanMiOiJiYXNpcy51dGlscy5iZW5jaG1hcmsiLCJoLmpzIjoiY29yZS50ZXN0IiwiaS5qcyI6ImJhc2lzLnV0aWxzLmluZm8iLCJqLmpzIjoiY29yZS5lbnYiLCJrLmpzIjoiY29yZS5hc3QiLCJsLmpzIjoiZXNwcmltYSIsIm0uanMiOiJhcHAudGVzdCIsIm4uanMiOiJhcHAuaGlnaGxpZ2h0Iiwiby5qcyI6ImRpZmYifTsKdmFyIF9fcmVzb3VyY2VzX18gPSB7CiAgIjAuY3NzIjogIiIsCiAgIjAuY29kZSI6ICJmdW5jdGlvbiBpbXBvcnRTY3JpcHRzKCl7XG4gIGZ1bmN0aW9uIGltcG9ydFNjcmlwdCh1cmwpe1xuICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICByZXEub3BlbignR0VUJywgdXJsLCBmYWxzZSk7XG4gICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgbmV3IERhdGUoMCkudG9HTVRTdHJpbmcoKSk7XG4gICAgcmVxLnNlbmQobnVsbCk7XG5cbiAgICBpZiAocmVxLnN0YXR1cyA+PSAyMDAgJiYgcmVxLnN0YXR1cyA8IDQwMClcbiAgICAgICh3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihmbil7XG4gICAgICAgIHdpbmRvd1snZXZhbCddLmNhbGwod2luZG93LCBmbik7XG4gICAgICB9KShyZXEucmVzcG9uc2VUZXh0KTtcbiAgICBlbHNlXG4gICAgICB0aHJvdyAnQ2FuXFwndCBsb2FkIHNjcmlwdDogJyArIHVybDtcbiAgfVxuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKVxuICAgIGltcG9ydFNjcmlwdChhcmd1bWVudHNbaV0pXG59XG5cbmZ1bmN0aW9uIF9faW5pdFRlc3RFbnZpcm9ubWVudChpbml0Q29kZSwgZGVwcmVjYXRlVGVzdEVudmlyb25tZW50KXtcbiAgLy8gYmFzaXMuanMgZGVmYXVsdCBiZWhhdmlvdXJcbiAgaWYgKHR5cGVvZiBiYXNpc2pzVG9vbHNGaWxlU3luYyAhPSAndW5kZWZpbmVkJylcbiAgICBiYXNpc2pzVG9vbHNGaWxlU3luYy5ub3RpZmljYXRpb25zLmF0dGFjaChmdW5jdGlvbih0eXBlLCBmaWxlbmFtZSl7XG4gICAgICBpZiAodHlwZW9mIGJhc2lzID09ICd1bmRlZmluZWQnKVxuICAgICAgICByZXR1cm47IC8vIG5vIGJhc2lzLmpzIGF2YWlsYWJsZVxuXG4gICAgICBpZiAodHlwZSA9PSAndXBkYXRlJyAmJiAoXG4gICAgICAgICAgICAoYmFzaXMuZmlsZW5hbWVfID09IGZpbGVuYW1lKSB8fFxuICAgICAgICAgICAgKGJhc2lzLnJlc291cmNlICYmIGJhc2lzLnJlc291cmNlLmV4aXN0cyhmaWxlbmFtZSkpXG4gICAgICAgICApKVxuICAgICAgICBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQoKTtcbiAgICB9KTtcblxuICAvLyBmYWxsYmFjayBkZXByZWNhdGUgZnVuY3Rpb25cbiAgaWYgKHR5cGVvZiBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQgIT0gJ2Z1bmN0aW9uJylcbiAgICBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQgPSBmdW5jdGlvbigpe307XG5cbiAgLy8gbWFpbiBwYXJ0XG4gIHJldHVybiBldmFsKGluaXRDb2RlICsgJzsoZnVuY3Rpb24oX19jb2RlKXtcXG4nICtcbiAgJyAgcmV0dXJuIGV2YWwoXCIoXCIgKyBfX2NvZGUgKyBcIilcIik7JyArXG4gICd9KScpO1xufVxuIiwKICAiOC50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDIsIDAsIDAsICJpZCIsICJsYXlvdXQiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgMiwgMCwgMCwgImlkIiwgImhlYWRlciIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImhlYWRlci1jYXB0aW9uIiBdLCBbIDMsIDAsIDAsICJCYXNpcy5qcyB0ZXN0IHJ1bm5lciIgXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJoZWFkZXItYnV0dG9ucyIgXSwgWyAxLCAwLCAwLCAiYnV0dG9uIiwgWyA0LCAwLCAwLCAiaGVhZGVyLWJ1dHRvbiIgXSwgWyA2LCAiY2xpY2siLCAicnVuIiBdLCBbIDMsIDAsIDAsICJydW4iIF0gXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJoZWFkZXItdGVzdC1zdWl0ZS1sb2NhdGlvbiIgXSwgWyAzLCAxLCBbICJuYW1lIiBdIF0sIFsgMywgMCwgMCwgIiAiIF0sIFsgMywgMSwgWyAiZG9uZSIgXSBdLCBbIDMsIDAsIDAsICIgLyAiIF0sIFsgMywgMSwgWyAidG90YWwiIF0gXSwgWyAzLCAwLCAwLCAiICgiIF0sIFsgMywgMSwgWyAiYXNzZXJ0IiBdIF0sIFsgMywgMCwgMCwgIikgKHRpbWU6ICIgXSwgWyAzLCAxLCBbICJ0aW1lIiBdIF0sIFsgMywgMCwgMCwgIiBtcykiIF0gXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDIsIDAsIDAsICJpZCIsICJzaWRlYmFyIiBdLCBbIDgsIDEsIFsgInRvYyIgXSBdIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgMiwgMCwgMCwgImlkIiwgImNvbnRlbnQiIF0sIFsgOCwgMSwgWyAidGVzdHMiIF0gXSBdIF0gXSwKICAiMS50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDQsIFsgWyAiYXBwLXRvYy1pdGVtXyIsICJzZWxlY3RlZCIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtIiBdLCBbIDYsICJjbGljayIsICJzZWxlY3QiIF0sIFsgNiwgImRibGNsaWNrIiwgInBpY2t1cCIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdG9jLWl0ZW1fX3Byb2dyZXNzXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtX19wcm9ncmVzcyIgXSwgWyA1LCBbIFsgWyAicHJvZ3Jlc3MiIF0sIFsgMCwgIiUiIF0sICJ3aWR0aCIgXSBdLCAwIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdG9jLWl0ZW1fX3N0YXRlLSIsICJzdGF0ZSIgXSwgWyAiYXBwLXRvYy1pdGVtX19zdGF0ZS0iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtX19zdGF0ZSIgXSwgWyAzLCAxLCBbICJzdGF0ZU1lc3NhZ2UiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRvYy1pdGVtX19uYW1lIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdIF0gXSwKICAiMi50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdG9jIiBdLCBbIDgsIDEsIFsgImxldmVsVXAiIF0gXSwgWyA4LCAxLCBbICJmYXVsdFRlc3RzIiBdIF0gXSBdLAogICIwLnRtcGwiOiBbIFsgMSwgMCwgWyAiZWxlbWVudCIgXSwgImlmcmFtZSIsIFsgMiwgWyBbICJzcmMiIF0sIFsgMCBdIF0sIDAsICJzcmMiLCAie3NyY30iIF0sIFsgNiwgImxvYWQiLCAicmVhZHkiIF0sIFsgNSwgMCwgMCwgIndpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7IHRvcDogLTEwMHB4OyBwb3NpdGlvbjogYWJzb2x1dGU7IGJvcmRlcjogbm9uZTsgb3BhY2l0eTogMC4wMDAxOyIgXSBdIF0sCiAgIjQudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LSIsICJoYXNPd25FbnZpcm9ubWVudCIgXSBdLCAwLCAiYXBwLXRlc3QiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LWhlYWRlciIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0X19zZWxlY3QtYnV0dG9uIiBdLCBbIDYsICJjbGljayIsICJzZWxlY3QiIF0sIFsgMywgMCwgMCwgInBpY2sgdXAiIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LW5hbWUiIF0sIFsgMywgMSwgWyAibmFtZSIgXSBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3BsaXR0ZXJfIiwgInN0YXRlIiBdIF0sIDAsICJhcHAtdGVzdC1zcGxpdHRlciIgXSwgWyAzLCAwLCAwLCAiIOKAlCAiIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdGVzdC1zdGF0ZV9zdGF0ZS0iLCAic3RhdGUiIF0sIFsgImFwcC10ZXN0LXN0YXRlXyIsICJwZW5kaW5nIiBdIF0sIDAsICJhcHAtdGVzdC1zdGF0ZSIgXSwgWyAzLCAxLCBbICJzdGF0ZU1lc3NhZ2UiIF0gXSBdIF0gXSBdLAogICI1LnRtcGwiOiBbIFsgMSwgMCwgWyAiZWxlbWVudCIgXSwgImRpdiIsIFsgNCwgWyBbICJhcHAtdGVzdC0iLCAiaGFzT3duRW52aXJvbm1lbnQiIF0gXSwgMCwgImFwcC10ZXN0IGFwcC10ZXN0LXN1aXRlIiBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdGVzdC1oZWFkZXIiIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdF9fc2VsZWN0LWJ1dHRvbiIgXSwgWyA2LCAiY2xpY2siLCAic2VsZWN0IiBdLCBbIDMsIDAsIDAsICJwaWNrIHVwIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdC1uYW1lIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXNwbGl0dGVyXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRlc3Qtc3BsaXR0ZXIiIF0sIFsgMywgMCwgMCwgIiDigJQgIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3RhdGVfc3RhdGUtIiwgInN0YXRlIiBdLCBbICJhcHAtdGVzdC1zdGF0ZV8iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRlc3Qtc3RhdGUiIF0sIFsgMywgMSwgWyAic3RhdGVNZXNzYWdlIiBdIF0gXSBdLCBbIDEsIDEsIFsgImNoaWxkTm9kZXNFbGVtZW50IiBdLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3Qtc3VpdGVfX2NvbnRlbnQiIF0gXSBdIF0sCiAgIjYudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LSIsICJoYXNPd25FbnZpcm9ubWVudCIgXSBdLCAwLCAiYXBwLXRlc3QgYXBwLXRlc3QtY2FzZSIgXSwgWyAxLCAwLCAwLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtaGVhZGVyIiBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRlc3RfX3NlbGVjdC1idXR0b24iIF0sIFsgNiwgImNsaWNrIiwgInNlbGVjdCIgXSwgWyAzLCAwLCAwLCAicGljayB1cCIgXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtbmFtZSIgXSwgWyAzLCAxLCBbICJuYW1lIiBdIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdGVzdC1zcGxpdHRlcl8iLCAic3RhdGUiIF0gXSwgMCwgImFwcC10ZXN0LXNwbGl0dGVyIiBdLCBbIDMsIDAsIDAsICIg4oCUICIgXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXN0YXRlX3N0YXRlLSIsICJzdGF0ZSIgXSwgWyAiYXBwLXRlc3Qtc3RhdGVfIiwgInBlbmRpbmciIF0gXSwgMCwgImFwcC10ZXN0LXN0YXRlIiBdLCBbIDMsIDEsIFsgInN0YXRlTWVzc2FnZSIgXSBdIF0gXSwgWyA4LCAxLCBbICJzb3VyY2UiIF0gXSBdLCBbIDgsIDAsIDAsICc8YjphZnRlciByZWY9InN0YXRlTWVzc2FnZSI+XG4gICAgwqAgwqB7ZXJyb3JNZXNzYWdlfVxuICA8L2I6YWZ0ZXI+JyBdIF0sCiAgIjcudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LXRyZWVfIiwgImhhc0RlbGVnYXRlIiBdIF0sIDAsICJhcHAtdGVzdC10cmVlIiBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdGVzdC10cmVlX19oZWFkZXIiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LXRyZWVfX2J1dHRvbnMiIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3QtdHJlZV9fYnV0dG9uLXBpY2t1cF8iLCAidHlwZSIgXSBdLCAwLCAiYXBwLXRlc3QtdHJlZV9fYnV0dG9uIGFwcC10ZXN0LXRyZWVfX2J1dHRvbi1waWNrdXAiIF0sIFsgNiwgImNsaWNrIiwgInNlbGVjdCIgXSwgWyAzLCAwLCAwLCAicGljayB1cCIgXSBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdC10cmVlX19jYXB0aW9uIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXNwbGl0dGVyXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRlc3Qtc3BsaXR0ZXIiIF0sIFsgMywgMCwgMCwgIiDigJQgIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3RhdGVfc3RhdGUtIiwgInN0YXRlIiBdLCBbICJhcHAtdGVzdC1zdGF0ZV8iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRlc3Qtc3RhdGUiIF0sIFsgMywgMSwgWyAic3RhdGVNZXNzYWdlIiBdIF0gXSBdLCBbIDEsIDEsIFsgImNoaWxkTm9kZXNFbGVtZW50IiBdLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtdHJlZV9fY29udGVudCIgXSBdLCBbIDgsIDEsIFsgInNvdXJjZUNvZGUiIF0gXSBdIF0sCiAgIjMudG1wbCI6IFsgWyAxLCAxLCBbICJjb2RlIiwgImVsZW1lbnQiIF0sICJwcmUiLCBbIDQsIDAsIDAsICJCYXNpcy1TeW50YXhIaWdobGlnaHQiIF0sIFsgMywgMSwgWyAic291cmNlQ29kZSIgXSBdIF0gXSwKICAiYi5qcyI6ICIvKiBKYXZhc2NyaXB0IGZpbGUgL1VzZXJzL3Jkdm9ybm92L0Rlc2t0b3AvZ2l0L3Rlc3QtcnVubmVyL3NyYy9jb3JlLmpzIG5vdCBmb3VuZCAqLyIsCiAgImMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9kLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2UuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgdmFyIFRlc3RDYXNlID0gYmFzaXMucmVxdWlyZSgiLi9oLmpzIikuVGVzdENhc2U7CiAgICB2YXIgdGVzdHNUb1J1biA9IG5ldyBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgYXdhaXRQcm9jZXNzaW5nVGVzdHMgPSBuZXcgYmFzaXMuZGF0YS5EYXRhc2V0KHsKICAgICAgbGlzdGVuOiB7CiAgICAgICAgaXRlbTogewogICAgICAgICAgc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGlmIChpdGVtLnN0YXRlICE9IGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORykgdGhpcy5yZW1vdmUoaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBmYXVsdFRlc3RzID0gbmV3IGJhc2lzLmRhdGEuZGF0YXNldC5TdWJzZXQoewogICAgICBzb3VyY2U6IHRlc3RzVG9SdW4sCiAgICAgIHJ1bGVFdmVudHM6ICJzdGF0ZUNoYW5nZWQiLAogICAgICBydWxlOiBmdW5jdGlvbih0ZXN0KSB7CiAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5FUlJPUjsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcHJvY2Vzc2luZ1F1ZXVlID0gbmV3IGJhc2lzLmRhdGEuZGF0YXNldC5TdWJzZXQoewogICAgICBydWxlRXZlbnRzOiAic3RhdGVDaGFuZ2VkIiwKICAgICAgcnVsZTogZnVuY3Rpb24odGVzdCkgewogICAgICAgIHJldHVybiB0ZXN0LnN0YXRlICE9IGJhc2lzLmRhdGEuU1RBVEUuUkVBRFkgJiYgdGVzdC5zdGF0ZSAhPSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SOwogICAgICB9CiAgICB9KTsKICAgIHZhciBwcm9jZXNzaW5nUXVldWVUb3AgPSBuZXcgYmFzaXMuZGF0YS5kYXRhc2V0LlNsaWNlKHsKICAgICAgc291cmNlOiBwcm9jZXNzaW5nUXVldWUsCiAgICAgIHJ1bGU6ICJiYXNpc09iamVjdElkIiwKICAgICAgbGltaXQ6IDEsCiAgICAgIGhhbmRsZXI6IHsKICAgICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNlbmRlciwgZGVsdGEpIHsKICAgICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgZGVsdGEuaW5zZXJ0ZWQuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChwcm9jZXNzaW5nUXVldWVUb3AuaGFzKGl0ZW0pKSBpdGVtLnJ1bigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgdGVzdFN0YXJ0VGltZTsKICAgIHZhciB0aW1lID0gbmV3IGJhc2lzLmRhdGEuVmFsdWUoewogICAgICB2YWx1ZTogMAogICAgfSk7CiAgICB2YXIgYXNzZXJ0Q291bnQgPSBiYXNpcy5kYXRhLmluZGV4LnN1bSh0ZXN0c1RvUnVuLCAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24odGVzdCkgewogICAgICBpZiAodGVzdC5zdGF0ZS5kYXRhIGluc3RhbmNlb2YgYmFzaXMuZGF0YS5PYmplY3QpIHJldHVybiB0ZXN0LnN0YXRlLmRhdGEuZGF0YS50ZXN0Q291bnQ7CiAgICAgIHJldHVybiAwOwogICAgfSk7CiAgICB2YXIgdGVzdENvdW50ID0gYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRlc3RzVG9SdW4sICJpdGVtc0NoYW5nZWQiLCAiaXRlbUNvdW50Iik7CiAgICB2YXIgdGVzdERvbmUgPSBiYXNpcy5kYXRhLmluZGV4LmNvdW50KHRlc3RzVG9SdW4sICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbih0ZXN0KSB7CiAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgfHwgdGVzdC5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLlJFQURZOwogICAgfSk7CiAgICB2YXIgdGVzdExlZnQgPSBuZXcgYmFzaXMuZGF0YS52YWx1ZS5FeHByZXNzaW9uKHRlc3RDb3VudCwgdGVzdERvbmUsIGZ1bmN0aW9uKHRvdGFsLCBkb25lKSB7CiAgICAgIHJldHVybiB0b3RhbCAtIGRvbmU7CiAgICB9KTsKICAgIHRlc3RMZWZ0LmFkZEhhbmRsZXIoewogICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlciwgb2xkVmFsdWUpIHsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiAhb2xkVmFsdWUpIHRlc3RTdGFydFRpbWUgPSBiYXNpcy51dGlscy5iZW5jaG1hcmsudGltZSgpOwogICAgICAgIHRpbWUuc2V0KGJhc2lzLnV0aWxzLmJlbmNobWFyay50aW1lKHRlc3RTdGFydFRpbWUpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBleHRyYWN0VGVzdHMoZGF0YSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZGF0YVtpXTsgaSsrKSB7CiAgICAgICAgdmFyIHRlc3QgPSBpdGVtLnJvb3Q7CiAgICAgICAgaWYgKHRlc3QgaW5zdGFuY2VvZiBUZXN0Q2FzZSkgcmVzdWx0LnB1c2godGVzdCk7CiAgICAgICAgaWYgKHRlc3QuZmlyc3RDaGlsZCkgcmVzdWx0LnB1c2guYXBwbHkocmVzdWx0LCBleHRyYWN0VGVzdHModGVzdC5jaGlsZE5vZGVzKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGxvYWRUZXN0cyhkYXRhKSB7CiAgICAgIHN0b3AoKTsKICAgICAgdGVzdHNUb1J1bi5zZXQoZXh0cmFjdFRlc3RzKGRhdGEpKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJ1bihkYXRhKSB7CiAgICAgIHN0b3AoKTsKICAgICAgaWYgKGF3YWl0UHJvY2Vzc2luZ1Rlc3RzLml0ZW1Db3VudCkgcmV0dXJuIHNldFRpbWVvdXQocnVuLCAxMCk7CiAgICAgIHRlc3RzVG9SdW4uZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgdmFyIGVudiA9IGl0ZW0uZ2V0RW52UnVubmVyKCk7CiAgICAgICAgaWYgKGVudikgZW52LmRlc3Ryb3koKTsKICAgICAgICBpdGVtLnJvb3QucmVzZXQoKTsKICAgICAgfSk7CiAgICAgIHByb2Nlc3NpbmdRdWV1ZS5zZXRTb3VyY2UodGVzdHNUb1J1bik7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wKCkgewogICAgICBpZiAocHJvY2Vzc2luZ1F1ZXVlLml0ZW1Db3VudCkgewogICAgICAgIGF3YWl0UHJvY2Vzc2luZ1Rlc3RzLmFkZChwcm9jZXNzaW5nUXVldWUuZ2V0SXRlbXMoKS5maWx0ZXIoZnVuY3Rpb24odGVzdCkgewogICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOwogICAgICAgIH0pKTsKICAgICAgfQogICAgICBwcm9jZXNzaW5nUXVldWUuc2V0U291cmNlKCk7CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgdGltZTogdGltZSwKICAgICAgZmF1bHRUZXN0czogZmF1bHRUZXN0cywKICAgICAgY291bnQ6IHsKICAgICAgICBhc3NlcnQ6IGFzc2VydENvdW50LAogICAgICAgIHRvdGFsOiB0ZXN0Q291bnQsCiAgICAgICAgbGVmdDogdGVzdExlZnQsCiAgICAgICAgZG9uZTogdGVzdERvbmUKICAgICAgfSwKICAgICAgbG9hZFRlc3RzOiBsb2FkVGVzdHMsCiAgICAgIHJ1bjogcnVuLAogICAgICBzdG9wOiBzdG9wCiAgICB9OwogIH0sCiAgImQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgb25lRnVuY3Rpb25Qcm9wZXJ0eSA9IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHk7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciB2YWx1ZXMgPSBiYXNpcy5vYmplY3QudmFsdWVzOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyICR0cnVlID0gYmFzaXMuZm4uJHRydWU7CiAgICB2YXIgJGZhbHNlID0gYmFzaXMuZm4uJGZhbHNlOwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgU1VCU0NSSVBUSU9OID0gYmFzaXMuZGF0YS5TVUJTQ1JJUFRJT047CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIEtleU9iamVjdE1hcCA9IGJhc2lzLmRhdGEuS2V5T2JqZWN0TWFwOwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgU1VCU0NSSVBUSU9OLmFkZCgiU09VUkNFIiwgewogICAgICBzb3VyY2VDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIG9sZFNvdXJjZSkgewogICAgICAgIGlmIChvbGRTb3VyY2UpIFNVQlNDUklQVElPTi51bmxpbmsoInNvdXJjZSIsIG9iamVjdCwgb2xkU291cmNlKTsKICAgICAgICBpZiAob2JqZWN0LnNvdXJjZSkgU1VCU0NSSVBUSU9OLmxpbmsoInNvdXJjZSIsIG9iamVjdCwgb2JqZWN0LnNvdXJjZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZXNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGFycmF5W2ldOyBpKyspIFNVQlNDUklQVElPTi5saW5rKCJzb3VyY2UiLCBvYmplY3QsIGFycmF5W2ldKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGFycmF5W2ldOyBpKyspIFNVQlNDUklQVElPTi51bmxpbmsoInNvdXJjZSIsIG9iamVjdCwgYXJyYXlbaV0pOwogICAgICB9CiAgICB9LCBmdW5jdGlvbihhY3Rpb24sIG9iamVjdCkgewogICAgICB2YXIgc291cmNlcyA9IG9iamVjdC5zb3VyY2VzIHx8IChvYmplY3Quc291cmNlID8gWyBvYmplY3Quc291cmNlIF0gOiBbXSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2U7IHNvdXJjZSA9IHNvdXJjZXNbaSsrXTsgKSBhY3Rpb24oInNvdXJjZSIsIG9iamVjdCwgc291cmNlKTsKICAgIH0pOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJtaW51ZW5kIik7CiAgICBTVUJTQ1JJUFRJT04uYWRkUHJvcGVydHkoInN1YnRyYWhlbmQiKTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVJ1bGVFdmVudHMoZm4sIGV2ZW50cykgewogICAgICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlUnVsZUV2ZW50c19fZXh0ZW5kX18oZXZlbnRzKSB7CiAgICAgICAgaWYgKCFldmVudHMpIHJldHVybiBudWxsOwogICAgICAgIGlmIChldmVudHMuX19leHRlbmRfXykgcmV0dXJuIGV2ZW50czsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50cyAhPSAic3RyaW5nIiAmJiAhQXJyYXkuaXNBcnJheShldmVudHMpKSB7CiAgICAgICAgICBldmVudHMgPSB0eXBlb2YgZXZlbnRzID09ICJvYmplY3QiID8gYmFzaXMub2JqZWN0LmtleXMoZXZlbnRzKSA6IG51bGw7CiAgICAgICAgICBpZiAoZXZlbnRzKSBiYXNpcy5kZXYud2FybigiVXNpbmcgYW4gb2JqZWN0IGZvciBydWxlRXZlbnRzIGlzIGRlcHJlY2F0ZWQsIHVzZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMgc3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3MgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4dGVuZChiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgZm4pLCB7CiAgICAgICAgICBfX2V4dGVuZF9fOiBjcmVhdGVSdWxlRXZlbnRzX19leHRlbmRfXwogICAgICAgIH0pOwogICAgICB9KGV2ZW50cyk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVLZXlNYXAoY29uZmlnLCBrZXlHZXR0ZXIsIGl0ZW1DbGFzcywgU3Vic2V0Q2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBLZXlPYmplY3RNYXAoZXh0ZW5kKHsKICAgICAgICBrZXlHZXR0ZXI6IGtleUdldHRlciwKICAgICAgICBpdGVtQ2xhc3M6IGl0ZW1DbGFzcywKICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgICB2YXIgb2JqID0gS2V5T2JqZWN0TWFwLnByb3RvdHlwZS5jcmVhdGUuY2FsbCh0aGlzLCBrZXksIG9iamVjdCk7CiAgICAgICAgICBvYmouc2V0RGF0YXNldChuZXcgU3Vic2V0Q2xhc3MoewogICAgICAgICAgICBydWxlVmFsdWU6IGtleQogICAgICAgICAgfSkpOwogICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICAgIH0sIGNvbmZpZykpOwogICAgfQogICAgdmFyIE1FUkdFX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIHVwZGF0ZWQgPSB7fTsKICAgICAgICB2YXIgb2JqZWN0OwogICAgICAgIHZhciBvYmplY3RJZDsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBvYmplY3QgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW29iamVjdElkXSA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgb2JqZWN0ID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIHVwZGF0ZWRbb2JqZWN0SWRdID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSh1cGRhdGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdGhpcy5yZW1vdmVTb3VyY2Uoc291cmNlKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNZXJnZSA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlNPVVJDRSwKICAgICAgZW1pdF9zb3VyY2VzQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZXNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHJ1bGU6IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICAgIHJldHVybiBjb3VudCA+IDA7CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUVSR0VfREFUQVNFVF9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VzID0gdGhpcy5zb3VyY2VzOwogICAgICAgIHRoaXMuc291cmNlcyA9IFtdOwogICAgICAgIGlmIChzb3VyY2VzKSBzb3VyY2VzLmZvckVhY2godGhpcy5hZGRTb3VyY2UsIHRoaXMpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBydWxlICE9ICJmdW5jdGlvbiIpIHJ1bGUgPSBNZXJnZS5VTklPTjsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB0aGlzLnJ1bGUgPSBydWxlOwogICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgcnVsZSA9IHRoaXMucnVsZTsKICAgICAgICB2YXIgc291cmNlQ291bnQgPSB0aGlzLnNvdXJjZXMubGVuZ3RoOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIG1lbWJlckNvdW50ZXI7CiAgICAgICAgdmFyIGlzTWVtYmVyOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNjb3BlKSBzY29wZSA9IG1lbWJlck1hcDsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiBzY29wZSkgewogICAgICAgICAgbWVtYmVyQ291bnRlciA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICBpc01lbWJlciA9IHNvdXJjZUNvdW50ICYmIG1lbWJlckNvdW50ZXIuY291bnQgJiYgcnVsZShtZW1iZXJDb3VudGVyLmNvdW50LCBzb3VyY2VDb3VudCk7CiAgICAgICAgICBpZiAoaXNNZW1iZXIgIT0gISF0aGlzLml0ZW1zX1tvYmplY3RJZF0pIChpc01lbWJlciA/IGluc2VydGVkIDogZGVsZXRlZCkucHVzaChtZW1iZXJDb3VudGVyLm9iamVjdCk7CiAgICAgICAgICBpZiAobWVtYmVyQ291bnRlci5jb3VudCA9PSAwKSBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGFkZFNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCkgewogICAgICAgICAgaWYgKGJhc2lzLmFycmF5LmFkZCh0aGlzLnNvdXJjZXMsIHNvdXJjZSkpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlzdGVuLnNvdXJjZSkgc291cmNlLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlLCB0aGlzKTsKICAgICAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIHNvdXJjZS5pdGVtc18pIHsKICAgICAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2UuaXRlbXNfW29iamVjdElkXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICAgICAgdGhpcy5lbWl0X3NvdXJjZXNDaGFuZ2VkKHsKICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2UgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIi5hZGRTb3VyY2U6IHNvdXJjZSBpc24ndCBpbnN0YW5jZSBvZiBBYnN0cmFjdERhdGFzZXQiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZVNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLnNvdXJjZXMsIHNvdXJjZSkpIHsKICAgICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIHNvdXJjZS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLnNvdXJjZSwgdGhpcyk7CiAgICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIHNvdXJjZS5pdGVtc18pIG1lbWJlck1hcFtvYmplY3RJZF0uY291bnQtLTsKICAgICAgICAgIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgICB0aGlzLmVtaXRfc291cmNlc0NoYW5nZWQoewogICAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZSBdCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIucmVtb3ZlU291cmNlOiBzb3VyY2UgaXNuJ3QgaW4gZGF0YXNldCBzb3VyY2UgbGlzdCIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U291cmNlczogZnVuY3Rpb24oc291cmNlcykgewogICAgICAgIHZhciBleGlzdHMgPSBhcnJheUZyb20odGhpcy5zb3VyY2VzKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlOyBzb3VyY2UgPSBzb3VyY2VzW2ldOyBpKyspIHsKICAgICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGFzZXQpIHsKICAgICAgICAgICAgaWYgKCFiYXNpcy5hcnJheS5yZW1vdmUoZXhpc3RzLCBzb3VyY2UpKSB0aGlzLmFkZFNvdXJjZShzb3VyY2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiLnNldFNvdXJjZXM6IHNvdXJjZSBpc24ndCB0eXBlIG9mIEFic3RyYWN0RGF0YXNldCIsIHNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4aXN0cy5mb3JFYWNoKHRoaXMucmVtb3ZlU291cmNlLCB0aGlzKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIGFycmF5RnJvbSh0aGlzLnNvdXJjZXMpLmZvckVhY2godGhpcy5yZW1vdmVTb3VyY2UsIHRoaXMpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnNvdXJjZXMgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIE1lcmdlLlVOSU9OID0gTWVyZ2UucHJvdG90eXBlLnJ1bGU7CiAgICBNZXJnZS5JTlRFUlNFQ1RJT04gPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIGNvdW50ID09IHNvdXJjZUNvdW50OwogICAgfTsKICAgIE1lcmdlLkRJRkZFUkVOQ0UgPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIGNvdW50ID09IDE7CiAgICB9OwogICAgTWVyZ2UuTU9SRV9USEFOX09ORV9JTkNMVURFID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBzb3VyY2VDb3VudCA9PSAxIHx8IGNvdW50ID4gMTsKICAgIH07CiAgICBNZXJnZS5BVF9MRUFTVF9PTkVfRVhDTFVERSA9IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICByZXR1cm4gc291cmNlQ291bnQgPT0gMSB8fCBjb3VudCA8IHNvdXJjZUNvdW50OwogICAgfTsKICAgIHZhciBkYXRhc2V0QWJzZW50RmlsdGVyID0gZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKGl0ZW0pOwogICAgfTsKICAgIHZhciBTVUJUUkFDVERBVEFTRVRfTUlOVUVORF9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgaWYgKCF0aGlzLnN1YnRyYWhlbmQpIHJldHVybjsKICAgICAgICB2YXIgbmV3RGVsdGEgPSBnZXREZWx0YShkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIoZGF0YXNldEFic2VudEZpbHRlciwgdGhpcy5zdWJ0cmFoZW5kKSwgZGVsdGEuZGVsZXRlZCAmJiBkZWx0YS5kZWxldGVkLmZpbHRlcih0aGlzLmhhcywgdGhpcykpOwogICAgICAgIGlmIChuZXdEZWx0YSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChuZXdEZWx0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0T3BlcmFuZHMobnVsbCwgdGhpcy5zdWJ0cmFoZW5kKTsKICAgICAgfQogICAgfTsKICAgIHZhciBTVUJUUkFDVERBVEFTRVRfU1VCVFJBSEVORF9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgaWYgKCF0aGlzLm1pbnVlbmQpIHJldHVybjsKICAgICAgICB2YXIgbmV3RGVsdGEgPSBnZXREZWx0YShkZWx0YS5kZWxldGVkICYmIGRlbHRhLmRlbGV0ZWQuZmlsdGVyKGRhdGFzZXRBYnNlbnRGaWx0ZXIsIHRoaXMpLCBkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldE9wZXJhbmRzKHRoaXMubWludWVuZCwgbnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU3VidHJhY3QgPSBDbGFzcyhBYnN0cmFjdERhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlN1YnRyYWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5NSU5VRU5EICsgU1VCU0NSSVBUSU9OLlNVQlRSQUhFTkQsCiAgICAgIG1pbnVlbmQ6IG51bGwsCiAgICAgIGVtaXRfbWludWVuZENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJtaW51ZW5kQ2hhbmdlZCIsICJvbGRNaW51ZW5kIiksCiAgICAgIHN1YnRyYWhlbmQ6IG51bGwsCiAgICAgIGVtaXRfc3VidHJhaGVuZENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJzdWJ0cmFoZW5kQ2hhbmdlZCIsICJvbGRTdWJ0cmFoZW5kIiksCiAgICAgIGxpc3RlbjogewogICAgICAgIG1pbnVlbmQ6IFNVQlRSQUNUREFUQVNFVF9NSU5VRU5EX0hBTkRMRVIsCiAgICAgICAgc3VidHJhaGVuZDogU1VCVFJBQ1REQVRBU0VUX1NVQlRSQUhFTkRfSEFORExFUgogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgbWludWVuZCA9IHRoaXMubWludWVuZDsKICAgICAgICB2YXIgc3VidHJhaGVuZCA9IHRoaXMuc3VidHJhaGVuZDsKICAgICAgICB0aGlzLm1pbnVlbmQgPSBudWxsOwogICAgICAgIHRoaXMuc3VidHJhaGVuZCA9IG51bGw7CiAgICAgICAgaWYgKG1pbnVlbmQgfHwgc3VidHJhaGVuZCkgdGhpcy5zZXRPcGVyYW5kcyhtaW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgc2V0T3BlcmFuZHM6IGZ1bmN0aW9uKG1pbnVlbmQsIHN1YnRyYWhlbmQpIHsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgdmFyIG9wZXJhbmRzQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgIGlmIChtaW51ZW5kIGluc3RhbmNlb2YgQWJzdHJhY3REYXRhc2V0ID09IGZhbHNlKSBtaW51ZW5kID0gbnVsbDsKICAgICAgICBpZiAoc3VidHJhaGVuZCBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCA9PSBmYWxzZSkgc3VidHJhaGVuZCA9IG51bGw7CiAgICAgICAgdmFyIG9sZE1pbnVlbmQgPSB0aGlzLm1pbnVlbmQ7CiAgICAgICAgdmFyIG9sZFN1YnRyYWhlbmQgPSB0aGlzLnN1YnRyYWhlbmQ7CiAgICAgICAgaWYgKG9sZE1pbnVlbmQgIT09IG1pbnVlbmQpIHsKICAgICAgICAgIG9wZXJhbmRzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLm1pbnVlbmQgPSBtaW51ZW5kOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5taW51ZW5kOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZE1pbnVlbmQpIG9sZE1pbnVlbmQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKG1pbnVlbmQpIG1pbnVlbmQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9taW51ZW5kQ2hhbmdlZChvbGRNaW51ZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9sZFN1YnRyYWhlbmQgIT09IHN1YnRyYWhlbmQpIHsKICAgICAgICAgIG9wZXJhbmRzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLnN1YnRyYWhlbmQgPSBzdWJ0cmFoZW5kOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5zdWJ0cmFoZW5kOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZFN1YnRyYWhlbmQpIG9sZFN1YnRyYWhlbmQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKHN1YnRyYWhlbmQpIHN1YnRyYWhlbmQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zdWJ0cmFoZW5kQ2hhbmdlZChvbGRTdWJ0cmFoZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFvcGVyYW5kc0NoYW5nZWQpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoIW1pbnVlbmQgfHwgIXN1YnRyYWhlbmQpIHsKICAgICAgICAgIGlmICh0aGlzLml0ZW1Db3VudCkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSA9IHsKICAgICAgICAgICAgZGVsZXRlZDogdGhpcy5nZXRJdGVtcygpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuaXRlbXNfKSBpZiAoIW1pbnVlbmQuaXRlbXNfW2tleV0gfHwgc3VidHJhaGVuZC5pdGVtc19ba2V5XSkgZGVsZXRlZC5wdXNoKHRoaXMuaXRlbXNfW2tleV0pOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIG1pbnVlbmQuaXRlbXNfKSBpZiAoIXRoaXMuaXRlbXNfW2tleV0gJiYgIXN1YnRyYWhlbmQuaXRlbXNfW2tleV0pIGluc2VydGVkLnB1c2gobWludWVuZC5pdGVtc19ba2V5XSk7CiAgICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldE1pbnVlbmQ6IGZ1bmN0aW9uKG1pbnVlbmQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRPcGVyYW5kcyhtaW51ZW5kLCB0aGlzLnN1YnRyYWhlbmQpOwogICAgICB9LAogICAgICBzZXRTdWJ0cmFoZW5kOiBmdW5jdGlvbihzdWJ0cmFoZW5kKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0T3BlcmFuZHModGhpcy5taW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0T3BlcmFuZHMoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU291cmNlRGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU291cmNlRGF0YXNldCIsCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uU09VUkNFLAogICAgICBzb3VyY2U6IG51bGwsCiAgICAgIGVtaXRfc291cmNlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZUNoYW5nZWQiLCAib2xkU291cmNlIiksCiAgICAgIHNvdXJjZUFkYXB0ZXJfOiBudWxsLAogICAgICBzb3VyY2VNYXBfOiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuc291cmNlQWRhcHRlcl8pIHRoaXMuc2V0U291cmNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZU1hcF8gPSB7fTsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgc291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgdGhpcy5zb3VyY2UgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXRTb3VyY2Uoc291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgc291cmNlID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldFNvdXJjZSwgc291cmNlLCAic291cmNlQWRhcHRlcl8iKTsKICAgICAgICBpZiAodGhpcy5zb3VyY2UgIT09IHNvdXJjZSkgewogICAgICAgICAgdmFyIG9sZFNvdXJjZSA9IHRoaXMuc291cmNlOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5zb3VyY2U7CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBpdGVtc0NoYW5nZWRIYW5kbGVyID0gbGlzdGVuSGFuZGxlci5pdGVtc0NoYW5nZWQ7CiAgICAgICAgICAgIGlmIChvbGRTb3VyY2UpIHsKICAgICAgICAgICAgICBvbGRTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoaXRlbXNDaGFuZ2VkSGFuZGxlcikgaXRlbXNDaGFuZ2VkSGFuZGxlci5jYWxsKHRoaXMsIG9sZFNvdXJjZSwgewogICAgICAgICAgICAgICAgZGVsZXRlZDogb2xkU291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGl0ZW1zQ2hhbmdlZEhhbmRsZXIpIGl0ZW1zQ2hhbmdlZEhhbmRsZXIuY2FsbCh0aGlzLCBzb3VyY2UsIHsKICAgICAgICAgICAgICAgIGluc2VydGVkOiBzb3VyY2UuZ2V0SXRlbXMoKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfc291cmNlQ2hhbmdlZChvbGRTb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0U291cmNlKCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc291cmNlTWFwXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1BUEZJTFRFUl9TT1VSQ0VPQkpFQ1RfVVBEQVRFID0gZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgIHZhciBuZXdNZW1iZXIgPSB0aGlzLm1hcCA/IHRoaXMubWFwKHNvdXJjZU9iamVjdCkgOiBvYmplY3Q7CiAgICAgIGlmIChuZXdNZW1iZXIgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID09IGZhbHNlIHx8IHRoaXMuZmlsdGVyKG5ld01lbWJlcikpIG5ld01lbWJlciA9IG51bGw7CiAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgY3VyTWVtYmVyID0gc291cmNlTWFwLm1lbWJlcjsKICAgICAgaWYgKGN1ck1lbWJlciAhPT0gbmV3TWVtYmVyKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZDsKICAgICAgICBzb3VyY2VNYXAubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgIGlmIChjdXJNZW1iZXIpIHsKICAgICAgICAgIHZhciBjdXJNZW1iZXJJZCA9IGN1ck1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihjdXJNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICBpZiAoLS1tZW1iZXJNYXBbY3VyTWVtYmVySWRdID09IDApIHsKICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICAgIGRlbGV0ZWQgPSBbIGN1ck1lbWJlciBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobmV3TWVtYmVyKSB7CiAgICAgICAgICB2YXIgbmV3TWVtYmVySWQgPSBuZXdNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIGlmICh0aGlzLmFkZE1lbWJlclJlZikgdGhpcy5hZGRNZW1iZXJSZWYobmV3TWVtYmVyLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgaWYgKG1lbWJlck1hcFtuZXdNZW1iZXJJZF0pIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSA9IDE7CiAgICAgICAgICAgIGluc2VydGVkID0gWyBuZXdNZW1iZXIgXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNQVBGSUxURVJfU09VUkNFX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oc291cmNlLCBkZWx0YSkgewogICAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF87CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJZDsKICAgICAgICB2YXIgbWVtYmVyOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgbWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgICBpZiAobWVtYmVyIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSB8fCB0aGlzLmZpbHRlcihtZW1iZXIpKSBtZW1iZXIgPSBudWxsOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgbWVtYmVyOiBtZW1iZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbbWVtYmVySWRdKSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbWVtYmVySWRdKys7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lbWJlck1hcFttZW1iZXJJZF0gPSAxOwogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChtZW1iZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5hZGRNZW1iZXJSZWYpIHRoaXMuYWRkTWVtYmVyUmVmKG1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBtZW1iZXIgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLm1lbWJlcjsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmICgtLW1lbWJlck1hcFttZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFttZW1iZXJJZF07CiAgICAgICAgICAgICAgICBkZWxldGVkLnB1c2gobWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihtZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgTWFwRmlsdGVyID0gQ2xhc3MoU291cmNlRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWFwRmlsdGVyIiwKICAgICAgbWFwOiAkc2VsZiwKICAgICAgZmlsdGVyOiAkZmFsc2UsCiAgICAgIHJ1bGU6IGdldHRlcigkdHJ1ZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoTUFQRklMVEVSX1NPVVJDRU9CSkVDVF9VUERBVEUsICJ1cGRhdGUiKSwKICAgICAgYWRkTWVtYmVyUmVmOiBudWxsLAogICAgICByZW1vdmVNZW1iZXJSZWY6IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUFQRklMVEVSX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIHNldE1hcDogZnVuY3Rpb24obWFwKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtYXAgIT0gImZ1bmN0aW9uIikgbWFwID0gJHNlbGY7CiAgICAgICAgaWYgKHRoaXMubWFwICE9PSBtYXApIHsKICAgICAgICAgIHRoaXMubWFwID0gbWFwOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRGaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlcikgewogICAgICAgIGlmICh0eXBlb2YgZmlsdGVyICE9ICJmdW5jdGlvbiIpIGZpbHRlciA9ICRmYWxzZTsKICAgICAgICBpZiAodGhpcy5maWx0ZXIgIT09IGZpbHRlcikgewogICAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFJ1bGU6IGZ1bmN0aW9uKHJ1bGUpIHsKICAgICAgICBpZiAodHlwZW9mIHJ1bGUgIT0gImZ1bmN0aW9uIikgcnVsZSA9ICR0cnVlOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT09IHJ1bGUpIHsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgY3VyTWVtYmVyOwogICAgICAgIHZhciBuZXdNZW1iZXI7CiAgICAgICAgdmFyIGN1ck1lbWJlcklkOwogICAgICAgIHZhciBuZXdNZW1iZXJJZDsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIHNvdXJjZU9iamVjdElkIGluIHNvdXJjZU1hcCkgewogICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZU9iamVjdDsKICAgICAgICAgIGN1ck1lbWJlciA9IHNvdXJjZU9iamVjdEluZm8ubWVtYmVyOwogICAgICAgICAgbmV3TWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJNZW1iZXIgIT0gbmV3TWVtYmVyKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8ubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgICAgICBpZiAoY3VyTWVtYmVyKSB7CiAgICAgICAgICAgICAgY3VyTWVtYmVySWQgPSBjdXJNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbY3VyTWVtYmVySWRdLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld01lbWJlcikgewogICAgICAgICAgICAgIG5ld01lbWJlcklkID0gbmV3TWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgICAgaWYgKG5ld01lbWJlcklkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgICAgIGluc2VydGVkLnB1c2gobmV3TWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjdXJNZW1iZXJJZCBpbiB0aGlzLml0ZW1zXykgaWYgKG1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2godGhpcy5pdGVtc19bY3VyTWVtYmVySWRdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1YnNldCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3Vic2V0IiwKICAgICAgZmlsdGVyOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gIXRoaXMucnVsZShvYmplY3QpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTcGxpdCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3BsaXQiLAogICAgICBzdWJzZXRDbGFzczogQWJzdHJhY3REYXRhc2V0LAogICAgICBzdWJzZXRXcmFwcGVyQ2xhc3M6IERhdGFzZXRXcmFwcGVyLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLnJlc29sdmUoc291cmNlT2JqZWN0KTsKICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgICAgIGlmICh0eXBlb2YgcnVsZSAhPSAiZnVuY3Rpb24iKSBydWxlID0gJHRydWU7CiAgICAgICAgaWYgKHRoaXMucnVsZSAhPT0gcnVsZSkgewogICAgICAgICAgdGhpcy5ydWxlID0gcnVsZTsKICAgICAgICAgIHRoaXMua2V5TWFwLmtleUdldHRlciA9IHJ1bGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZE1lbWJlclJlZjogZnVuY3Rpb24od3JhcHBlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgd3JhcHBlci5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGluc2VydGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHJlbW92ZU1lbWJlclJlZjogZnVuY3Rpb24od3JhcHBlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgd3JhcHBlci5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBjcmVhdGVLZXlNYXAodGhpcy5rZXlNYXAsIHRoaXMucnVsZSwgdGhpcy5zdWJzZXRXcmFwcGVyQ2xhc3MsIHRoaXMuc3Vic2V0Q2xhc3MpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBnZXRTdWJzZXQ6IGZ1bmN0aW9uKGRhdGEsIGF1dG9jcmVhdGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5rZXlNYXAuZ2V0KGRhdGEsIGF1dG9jcmVhdGUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBNYXBGaWx0ZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmtleU1hcC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5rZXlNYXAgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGJpbmFyeVNlYXJjaFBvcyhhcnJheSwgbWFwKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHZhbHVlID0gbWFwLnZhbHVlOwogICAgICB2YXIgaWQgPSBtYXAub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBjbXBWYWx1ZTsKICAgICAgdmFyIGNtcElkOwogICAgICB2YXIgcG9zOwogICAgICB2YXIgaXRlbTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGl0ZW0gPSBhcnJheVtwb3NdOwogICAgICAgIGNtcFZhbHVlID0gaXRlbS52YWx1ZTsKICAgICAgICBpZiAodmFsdWUgPCBjbXBWYWx1ZSkgciA9IHBvcyAtIDE7IGVsc2UgaWYgKHZhbHVlID4gY21wVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHsKICAgICAgICAgIGNtcElkID0gaXRlbS5vYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIGlmIChpZCA8IGNtcElkKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoaWQgPiBjbXBJZCkgbCA9IHBvcyArIDE7IGVsc2UgcmV0dXJuIHBvczsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKGwgPD0gcik7CiAgICAgIHJldHVybiBwb3MgKyAoY21wVmFsdWUgPT0gdmFsdWUgPyBjbXBJZCA8IGlkIDogY21wVmFsdWUgPCB2YWx1ZSk7CiAgICB9CiAgICB2YXIgU0xJQ0VfU09VUkNFT0JKRUNUX1VQREFURSA9IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICB2YXIgc291cmNlT2JqZWN0SW5mbyA9IHRoaXMuc291cmNlTWFwX1tzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIHZhciBuZXdWYWx1ZSA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpOwogICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4XzsKICAgICAgaWYgKG5ld1ZhbHVlICE9PSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlKSB7CiAgICAgICAgdmFyIHBvcyA9IGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgdmFyIHByZXYgPSBpbmRleFtwb3MgLSAxXTsKICAgICAgICB2YXIgbmV4dCA9IGluZGV4W3BvcyArIDFdOwogICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICBpZiAocHJldiAmJiAocHJldi52YWx1ZSA+IG5ld1ZhbHVlIHx8IHByZXYudmFsdWUgPT0gbmV3VmFsdWUgJiYgcHJldi5vYmplY3QuYmFzaXNPYmplY3RJZCA+IHNvdXJjZU9iamVjdEluZm8ub2JqZWN0LmJhc2lzT2JqZWN0SWQpIHx8IG5leHQgJiYgKG5leHQudmFsdWUgPCBuZXdWYWx1ZSB8fCBuZXh0LnZhbHVlID09IG5ld1ZhbHVlICYmIG5leHQub2JqZWN0LmJhc2lzT2JqZWN0SWQgPCBzb3VyY2VPYmplY3RJbmZvLm9iamVjdC5iYXNpc09iamVjdElkKSkgewogICAgICAgICAgaW5kZXguc3BsaWNlKHBvcywgMSk7CiAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgICB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIHNsaWNlSW5kZXhTb3J0KGEsIGIpIHsKICAgICAgcmV0dXJuICsoYS52YWx1ZSA+IGIudmFsdWUpIHx8IC0oYS52YWx1ZSA8IGIudmFsdWUpIHx8IGEub2JqZWN0LmJhc2lzT2JqZWN0SWQgLSBiLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgfQogICAgdmFyIFNMSUNFX1NPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNvdXJjZSwgZGVsdGEpIHsKICAgICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhfOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIHZhciBkcm9wSW5kZXggPSBmYWxzZTsKICAgICAgICB2YXIgYnVpbGRJbmRleCA9IGZhbHNlOwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICBpZiAoZGVsZXRlZCkgewogICAgICAgICAgaWYgKGRlbGV0ZWQubGVuZ3RoID4gaW5kZXgubGVuZ3RoIC0gZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgICAgZHJvcEluZGV4ID0gdHJ1ZTsKICAgICAgICAgICAgYnVpbGRJbmRleCA9IGRlbGV0ZWQubGVuZ3RoICE9IGluZGV4Lmxlbmd0aDsKICAgICAgICAgICAgaW5kZXgubGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2VPYmplY3Q7IHNvdXJjZU9iamVjdCA9IGRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBpZiAoIWRyb3BJbmRleCkgewogICAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICAgIGluZGV4LnNwbGljZShiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ1aWxkSW5kZXgpIGZvciAodmFyIGtleSBpbiBzb3VyY2VNYXApIHsKICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtrZXldOwogICAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRlZCkgewogICAgICAgICAgYnVpbGRJbmRleCA9ICFpbmRleC5sZW5ndGg7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBpbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSB7CiAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgdmFsdWU6IHRoaXMucnVsZShzb3VyY2VPYmplY3QpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgICAgICBpZiAoIWJ1aWxkSW5kZXgpIGluZGV4LnNwbGljZShiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pLCAwLCBzb3VyY2VPYmplY3RJbmZvKTsgZWxzZSBpbmRleC5wdXNoKHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYnVpbGRJbmRleCkgaW5kZXguc29ydChzbGljZUluZGV4U29ydCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU2xpY2UgPSBDbGFzcyhTb3VyY2VEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TbGljZSIsCiAgICAgIHJ1bGU6IGdldHRlcigkdHJ1ZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoU0xJQ0VfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBpbmRleF86IG51bGwsCiAgICAgIG9yZGVyRGVzYzogZmFsc2UsCiAgICAgIG9mZnNldDogMCwKICAgICAgbGltaXQ6IDEwLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IFNMSUNFX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGVtaXRfcmFuZ2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgicmFuZ2VDaGFuZ2VkIiwgIm9sZE9mZnNldCIsICJvbGRMaW1pdCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmluZGV4XyA9IFtdOwogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0UmFuZ2U6IGZ1bmN0aW9uKG9mZnNldCwgbGltaXQpIHsKICAgICAgICB2YXIgb2xkT2Zmc2V0ID0gdGhpcy5vZmZzZXQ7CiAgICAgICAgdmFyIG9sZExpbWl0ID0gdGhpcy5saW1pdDsKICAgICAgICB2YXIgZGVsdGEgPSBmYWxzZTsKICAgICAgICBpZiAob2xkT2Zmc2V0ICE9IG9mZnNldCB8fCBvbGRMaW1pdCAhPSBsaW1pdCkgewogICAgICAgICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgICB0aGlzLmxpbWl0ID0gbGltaXQ7CiAgICAgICAgICBkZWx0YSA9IHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgICB0aGlzLmVtaXRfcmFuZ2VDaGFuZ2VkKG9sZE9mZnNldCwgb2xkTGltaXQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldE9mZnNldDogZnVuY3Rpb24ob2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0UmFuZ2Uob2Zmc2V0LCB0aGlzLmxpbWl0KTsKICAgICAgfSwKICAgICAgc2V0TGltaXQ6IGZ1bmN0aW9uKGxpbWl0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0UmFuZ2UodGhpcy5vZmZzZXQsIGxpbWl0KTsKICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSwgb3JkZXJEZXNjKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlKTsKICAgICAgICB0aGlzLm9yZGVyRGVzYyA9ICEhb3JkZXJEZXNjOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT0gcnVsZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleF87CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgaSsrKSBpbmRleFtpXS52YWx1ZSA9IHJ1bGUoaW5kZXhbaV0ub2JqZWN0KTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICBpbmRleC5zb3J0KHNsaWNlSW5kZXhTb3J0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5vZmZzZXQ7CiAgICAgICAgdmFyIGVuZCA9IHN0YXJ0ICsgdGhpcy5saW1pdDsKICAgICAgICBpZiAodGhpcy5vcmRlckRlc2MpIHsKICAgICAgICAgIHN0YXJ0ID0gdGhpcy5pbmRleF8ubGVuZ3RoIC0gZW5kOwogICAgICAgICAgZW5kID0gc3RhcnQgKyB0aGlzLmxpbWl0OwogICAgICAgIH0KICAgICAgICB2YXIgY3VyU2V0ID0gYmFzaXMub2JqZWN0LnNsaWNlKHRoaXMubWVtYmVyc18pOwogICAgICAgIHZhciBuZXdTZXQgPSB0aGlzLmluZGV4Xy5zbGljZShNYXRoLm1heCgwLCBzdGFydCksIE1hdGgubWF4KDAsIGVuZCkpOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IG5ld1NldFtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBpdGVtLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKGN1clNldFtvYmplY3RJZF0pIGRlbGV0ZSBjdXJTZXRbb2JqZWN0SWRdOyBlbHNlIHsKICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChpdGVtLm9iamVjdCk7CiAgICAgICAgICAgIHRoaXMubWVtYmVyc19bb2JqZWN0SWRdID0gaXRlbS5vYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGN1clNldCkgZGVsZXRlIHRoaXMubWVtYmVyc19bb2JqZWN0SWRdOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCB2YWx1ZXMoY3VyU2V0KSkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQ0xPVURfU09VUkNFT0JKRUNUX1VQREFURSA9IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgdmFyIHNvdXJjZU9iamVjdElkID0gc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBvbGRMaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICB2YXIgbmV3TGlzdCA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF0ubGlzdCA9IHt9OwogICAgICB2YXIgbGlzdCA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpOwogICAgICB2YXIgZGVsdGE7CiAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICB2YXIgc3Vic2V0OwogICAgICBpZiAoQXJyYXkuaXNBcnJheShsaXN0KSkgZm9yICh2YXIgaiA9IDA7IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgc3Vic2V0ID0gdGhpcy5rZXlNYXAuZ2V0KGxpc3Rbal0sIHRydWUpOwogICAgICAgIGlmIChzdWJzZXQgJiYgIXN1YnNldC5oYXMoc291cmNlT2JqZWN0KSkgewogICAgICAgICAgc3Vic2V0SWQgPSBzdWJzZXQuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIG5ld0xpc3Rbc3Vic2V0SWRdID0gc3Vic2V0OwogICAgICAgICAgaWYgKCFvbGRMaXN0W3N1YnNldElkXSkgewogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgIGluc2VydGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbc3Vic2V0SWRdID0gMTsKICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgc3Vic2V0SWQgaW4gb2xkTGlzdCkgaWYgKCFuZXdMaXN0W3N1YnNldElkXSkgewogICAgICAgIHZhciBzdWJzZXQgPSBvbGRMaXN0W3N1YnNldElkXTsKICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgIGRlbGV0ZSBtZW1iZXJNYXBbc3Vic2V0SWRdOwogICAgICAgICAgZGVsZXRlZC5wdXNoKHN1YnNldCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICB9OwogICAgdmFyIENMT1VEX1NPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgdXBkYXRlSGFuZGxlciA9IHRoaXMucnVsZUV2ZW50czsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgdmFyIHN1YnNldDsKICAgICAgICB2YXIgc3Vic2V0SWQ7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZSh0cnVlKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gYXJyYXlbaV07IGkrKykgewogICAgICAgICAgdmFyIGxpc3QgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdCwKICAgICAgICAgICAgbGlzdDoge30KICAgICAgICAgIH07CiAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMCwgZHVwRmlsdGVyID0ge307IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHN1YnNldCA9IHRoaXMua2V5TWFwLmdldChsaXN0W2pdLCB0cnVlKTsKICAgICAgICAgICAgaWYgKHN1YnNldCAmJiAhZHVwRmlsdGVyW3N1YnNldC5iYXNpc09iamVjdElkXSkgewogICAgICAgICAgICAgIHN1YnNldElkID0gc3Vic2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgZHVwRmlsdGVyW3N1YnNldElkXSA9IHRydWU7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mby5saXN0W3N1YnNldElkXSA9IHN1YnNldDsKICAgICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgICAgbWVtYmVyTWFwW3N1YnNldElkXSA9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBhcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIHZhciBsaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBsaXN0KSB7CiAgICAgICAgICAgIHN1YnNldCA9IGxpc3Rbc3Vic2V0SWRdOwogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgZGVsZXRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW3N1YnNldElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgfQogICAgfTsKICAgIHZhciBDbG91ZCA9IENsYXNzKFNvdXJjZURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNsb3VkIiwKICAgICAgc3Vic2V0Q2xhc3M6IEFic3RyYWN0RGF0YXNldCwKICAgICAgc3Vic2V0V3JhcHBlckNsYXNzOiBEYXRhc2V0V3JhcHBlciwKICAgICAgcnVsZTogZ2V0dGVyKCRmYWxzZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoQ0xPVURfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogJHNlbGYsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogQ0xPVURfU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBjcmVhdGVLZXlNYXAodGhpcy5rZXlNYXAsIHRoaXMucnVsZSwgdGhpcy5zdWJzZXRXcmFwcGVyQ2xhc3MsIHRoaXMuc3Vic2V0Q2xhc3MpOwogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0U3Vic2V0OiBmdW5jdGlvbihkYXRhLCBhdXRvY3JlYXRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChkYXRhLCBhdXRvY3JlYXRlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMua2V5TWFwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmtleU1hcCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZVJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMsCiAgICAgIE1lcmdlOiBNZXJnZSwKICAgICAgU3VidHJhY3Q6IFN1YnRyYWN0LAogICAgICBTb3VyY2VEYXRhc2V0OiBTb3VyY2VEYXRhc2V0LAogICAgICBNYXBGaWx0ZXI6IE1hcEZpbHRlciwKICAgICAgU3Vic2V0OiBTdWJzZXQsCiAgICAgIFNwbGl0OiBTcGxpdCwKICAgICAgU2xpY2U6IFNsaWNlLAogICAgICBDbG91ZDogQ2xvdWQKICAgIH07CiAgfSwKICAiZS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2QuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBBYnN0cmFjdERhdGFzZXQgPSBiYXNpcy5kYXRhLkFic3RyYWN0RGF0YXNldDsKICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IGJhc2lzLmRhdGEuRGF0YXNldFdyYXBwZXI7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIE1hcEZpbHRlciA9IGJhc2lzLmRhdGEuZGF0YXNldC5NYXBGaWx0ZXI7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNtcFZhbHVlOwogICAgICB2YXIgbCA9IDA7CiAgICAgIHZhciByID0gYXJyYXkubGVuZ3RoIC0gMTsKICAgICAgZG8gewogICAgICAgIHBvcyA9IGwgKyByID4+IDE7CiAgICAgICAgY21wVmFsdWUgPSBhcnJheVtwb3NdIHx8IDA7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSByZXR1cm4gdmFsdWUgPT0gY21wVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIEluZGV4ID0gQ2xhc3MoVmFsdWUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4IiwKICAgICAgYXV0b0Rlc3Ryb3k6IHRydWUsCiAgICAgIGluZGV4Q2FjaGVfOiBudWxsLAogICAgICB2YWx1ZUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHVwZGF0ZUV2ZW50czoge30sCiAgICAgIHZhbHVlOiAwLAogICAgICBzZXROdWxsT25FbWl0dGVyRGVzdHJveTogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhDYWNoZV8gPSB7fTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkge30sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7fSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7fSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpIHx8IDA7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFZhbHVlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleENhY2hlXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1bSA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TdW0iLAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgKz0gdmFsdWU7CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSAtPSB2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtIG9sZFZhbHVlICsgbmV3VmFsdWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDb3VudCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db3VudCIsCiAgICAgIHZhbHVlR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlICs9IHZhbHVlOwogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgLT0gdmFsdWU7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtICEhb2xkVmFsdWUgKyAhIW5ld1ZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQXZnID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkF2ZyIsCiAgICAgIHN1bV86IDAsCiAgICAgIGNvdW50XzogMCwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gdmFsdWU7CiAgICAgICAgdGhpcy5jb3VudF8gKz0gMTsKICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF87CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zdW1fIC09IHZhbHVlOwogICAgICAgIHRoaXMuY291bnRfIC09IDE7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuY291bnRfID8gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF8gOiAwOwogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gbmV3VmFsdWUgLSBvbGRWYWx1ZTsKICAgICAgICB0aGlzLnNldCh0aGlzLnN1bV8gLyB0aGlzLmNvdW50Xyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFZlY3RvckluZGV4ID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlZlY3RvckluZGV4IiwKICAgICAgaXRlbUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHZlY3Rvcl86IG51bGwsCiAgICAgIHZhbHVlOiB1bmRlZmluZWQsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudmVjdG9yXyA9IFtdOwogICAgICAgIEluZGV4LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGFkZF86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLnZlY3Rvcl8uc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyh0aGlzLnZlY3Rvcl8sIHZhbHVlKSwgMCwgdmFsdWUpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMudmVjdG9yR2V0dGVyKHRoaXMudmVjdG9yXyk7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCB2YWx1ZSksIDEpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMudmVjdG9yR2V0dGVyKHRoaXMudmVjdG9yXyk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG51bGwpIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgb2xkVmFsdWUpLCAxKTsKICAgICAgICBpZiAobmV3VmFsdWUgIT09IG51bGwpIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgbmV3VmFsdWUpLCAwLCBuZXdWYWx1ZSk7CiAgICAgICAgdGhpcy5zZXQodGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKSk7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJzdHJpbmciIHx8IHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiA/IHZhbHVlIDogbnVsbDsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnZlY3Rvcl8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBNaW4gPSBDbGFzcyhWZWN0b3JJbmRleCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWluIiwKICAgICAgdmVjdG9yR2V0dGVyOiBmdW5jdGlvbih2ZWN0b3IpIHsKICAgICAgICByZXR1cm4gdmVjdG9yWzBdOwogICAgICB9CiAgICB9KTsKICAgIHZhciBNYXggPSBDbGFzcyhWZWN0b3JJbmRleCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWF4IiwKICAgICAgdmVjdG9yR2V0dGVyOiBmdW5jdGlvbih2ZWN0b3IpIHsKICAgICAgICByZXR1cm4gdmVjdG9yW3ZlY3Rvci5sZW5ndGggLSAxXTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgaW5kZXhDb25zdHJ1Y3RvcnNfID0ge307CiAgICB2YXIgREFUQVNFVF9JTkRFWF9IQU5ETEVSID0gewogICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZW1vdmVEYXRhc2V0SW5kZXgodGhpcywgb2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIEluZGV4Q29uc3RydWN0b3IoKSB7fQogICAgZnVuY3Rpb24gZ2V0SW5kZXhDb25zdHJ1Y3RvcihCYXNlQ2xhc3MsIGdldHRlciwgZXZlbnRzKSB7CiAgICAgIGlmICghQ2xhc3MuaXNDbGFzcyhCYXNlQ2xhc3MpIHx8ICFCYXNlQ2xhc3MuaXNTdWJjbGFzc09mKEluZGV4KSkgdGhyb3cgIldyb25nIGNsYXNzIGZvciBpbmRleCBjb25zdHJ1Y3RvciI7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICBldmVudHMgPSBldmVudHMgfHwgInVwZGF0ZSI7CiAgICAgIGlmICh0eXBlb2YgZXZlbnRzICE9ICJzdHJpbmciKSB0aHJvdyAiRXZlbnRzIG11c3QgYmUgYSBldmVudCBuYW1lcyBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIjsKICAgICAgZXZlbnRzID0gZXZlbnRzLnRyaW0oKS5zcGxpdCgiICIpLnNvcnQoKTsKICAgICAgdmFyIGluZGV4SWQgPSBbIEJhc2VDbGFzcy5iYXNpc0NsYXNzSWRfLCBnZXR0ZXIuYmFzaXNHZXR0ZXJJZF8sIGV2ZW50cyBdLmpvaW4oIl8iKTsKICAgICAgdmFyIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgIGlmIChpbmRleENvbnN0cnVjdG9yKSByZXR1cm4gaW5kZXhDb25zdHJ1Y3Rvci5vd25lcjsKICAgICAgdmFyIGV2ZW50c18gPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIGV2ZW50c19bZXZlbnRzW2ldXSA9IHRydWU7CiAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBuZXcgSW5kZXhDb25zdHJ1Y3RvcjsKICAgICAgaW5kZXhDb25zdHJ1Y3RvcnNfW2luZGV4SWRdID0gewogICAgICAgIG93bmVyOiBpbmRleENvbnN0cnVjdG9yLAogICAgICAgIGluZGV4Q2xhc3M6IEJhc2VDbGFzcy5zdWJjbGFzcyh7CiAgICAgICAgICBpbmRleElkOiBpbmRleElkLAogICAgICAgICAgdXBkYXRlRXZlbnRzOiBldmVudHNfLAogICAgICAgICAgdmFsdWVHZXR0ZXI6IGdldHRlcgogICAgICAgIH0pCiAgICAgIH07CiAgICAgIGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZCA9IGluZGV4SWQ7CiAgICAgIHJldHVybiBpbmRleENvbnN0cnVjdG9yOwogICAgfQogICAgdmFyIGNyZWF0ZUluZGV4Q29uc3RydWN0b3IgPSBmdW5jdGlvbihJbmRleENsYXNzLCBkZWZHZXR0ZXIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgdmFyIGRhdGFzZXQ7CiAgICAgICAgaWYgKGV2ZW50cyBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCB8fCBldmVudHMgaW5zdGFuY2VvZiBEYXRhc2V0V3JhcHBlcikgewogICAgICAgICAgZGF0YXNldCA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlciA9IGFyZ3VtZW50c1syXTsKICAgICAgICB9CiAgICAgICAgaWYgKCFnZXR0ZXIpIHsKICAgICAgICAgIGdldHRlciA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAoZXZlbnRzKSBpZiAodHlwZW9mIGdldHRlciA9PSAic3RyaW5nIiAmJiBnZXR0ZXIuc3BsaXQoL1xzKy8pLnNvbWUoZnVuY3Rpb24oZSkgewogICAgICAgICAgcmV0dXJuIGUgaW4gYmFzaXMuZXZlbnQuZXZlbnRzOwogICAgICAgIH0pIHx8IEFycmF5LmlzQXJyYXkoZ2V0dGVyKSAmJiBnZXR0ZXIuc29tZShmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXR1cm4gZSBpbiBiYXNpcy5ldmVudC5ldmVudHM7CiAgICAgICAgfSkpIGJhc2lzLmRldi53YXJuKCJldmVudHMgbXVzdCBiZSBiZWZvcmUgZ2V0dGVyIGluIGJhc2lzLmRhdGEuaW5kZXggY29uc3RydWN0b3IiKTsKICAgICAgICB2YXIgaW5kZXhDb25zdHJ1Y3RvciA9IGdldEluZGV4Q29uc3RydWN0b3IoSW5kZXhDbGFzcywgZ2V0dGVyIHx8IGRlZkdldHRlciwgZXZlbnRzKTsKICAgICAgICBpZiAoZGF0YXNldCkgcmV0dXJuIGdldERhdGFzZXRJbmRleChkYXRhc2V0LCBpbmRleENvbnN0cnVjdG9yKTsgZWxzZSByZXR1cm4gaW5kZXhDb25zdHJ1Y3RvcjsKICAgICAgfTsKICAgIH07CiAgICB2YXIgY291bnQgPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKENvdW50LCBiYXNpcy5mbi4kdHJ1ZSk7CiAgICB2YXIgc3VtID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihTdW0pOwogICAgdmFyIGF2ZyA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoQXZnKTsKICAgIHZhciBtaW4gPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKE1pbik7CiAgICB2YXIgbWF4ID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihNYXgpOwogICAgZnVuY3Rpb24gYXBwbHlJbmRleERlbHRhKGluZGV4LCBpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgaW5kZXhDYWNoZSA9IGluZGV4LmluZGV4Q2FjaGVfOwogICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgIGluZGV4LmxvY2soKTsKICAgICAgaWYgKGluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBpbnNlcnRlZFtpKytdOyApIHsKICAgICAgICB2YXIgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgaW5kZXhDYWNoZVtvYmplY3QuYmFzaXNPYmplY3RJZF0gPSBuZXdWYWx1ZTsKICAgICAgICBpbmRleC5hZGRfKG5ld1ZhbHVlKTsKICAgICAgfQogICAgICBpZiAoZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gZGVsZXRlZFtpKytdOyApIHsKICAgICAgICBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGluZGV4LnJlbW92ZV8oaW5kZXhDYWNoZVtvYmplY3RJZF0pOwogICAgICAgIGRlbGV0ZSBpbmRleENhY2hlW29iamVjdElkXTsKICAgICAgfQogICAgICBpbmRleC51bmxvY2soKTsKICAgIH0KICAgIHZhciBJVEVNX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgICIqIjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIHZhciBpbmRleDsKICAgICAgICB2YXIgZXZlbnRUeXBlID0gZXZlbnQudHlwZTsKICAgICAgICB2YXIgb2JqZWN0ID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBmb3IgKHZhciBpbmRleElkIGluIGluZGV4ZXMpIHsKICAgICAgICAgIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgICAgIGlmIChpbmRleC51cGRhdGVFdmVudHNbZXZlbnRUeXBlXSkgewogICAgICAgICAgICBvbGRWYWx1ZSA9IGluZGV4LmluZGV4Q2FjaGVfW29iamVjdElkXTsKICAgICAgICAgICAgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICBpbmRleC51cGRhdGVfKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaW5kZXguaW5kZXhDYWNoZV9bb2JqZWN0SWRdID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5hZGRIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5yZW1vdmVIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgYXBwbHlJbmRleERlbHRhKGluZGV4ZXNbaW5kZXhJZF0sIGRlbHRhLmluc2VydGVkLCBkZWx0YS5kZWxldGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgcmVtb3ZlRGF0YXNldEluZGV4KHRoaXMsIGluZGV4ZXNbaW5kZXhJZF0pOwogICAgICB9CiAgICB9OwogICAgdmFyIGRhdGFzZXRJbmRleGVzID0ge307CiAgICBmdW5jdGlvbiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3RvcikgewogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvciBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IgPT0gZmFsc2UpIHRocm93ICJpbmRleENvbnN0cnVjdG9yIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgSW5kZXhDb25zdHJ1Y3RvciI7CiAgICAgIHZhciBkYXRhc2V0SWQgPSBkYXRhc2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbZGF0YXNldElkXTsKICAgICAgaWYgKCFpbmRleGVzKSB7CiAgICAgICAgaW5kZXhlcyA9IGRhdGFzZXRJbmRleGVzW2RhdGFzZXRJZF0gPSB7fTsKICAgICAgICBkYXRhc2V0LmFkZEhhbmRsZXIoREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIpOwogICAgICAgIERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSLml0ZW1zQ2hhbmdlZC5jYWxsKGRhdGFzZXQsIGRhdGFzZXQsIHsKICAgICAgICAgIGluc2VydGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgaW5kZXhJZCA9IGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZDsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgaWYgKCFpbmRleCkgewogICAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgICAgaWYgKCFpbmRleENvbnN0cnVjdG9yKSB0aHJvdyAiV3JvbmcgaW5kZXggY29uc3RydWN0b3IiOwogICAgICAgIGluZGV4ID0gbmV3IGluZGV4Q29uc3RydWN0b3IuaW5kZXhDbGFzczsKICAgICAgICBpbmRleC5hZGRIYW5kbGVyKERBVEFTRVRfSU5ERVhfSEFORExFUiwgZGF0YXNldCk7CiAgICAgICAgaW5kZXhlc1tpbmRleElkXSA9IGluZGV4OwogICAgICAgIGFwcGx5SW5kZXhEZWx0YShpbmRleCwgZGF0YXNldC5nZXRJdGVtcygpKTsKICAgICAgfQogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVEYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXgpIHsKICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICBpZiAoaW5kZXhlcyAmJiBpbmRleGVzW2luZGV4LmluZGV4SWRdKSB7CiAgICAgICAgZGVsZXRlIGluZGV4ZXNbaW5kZXguaW5kZXhJZF07CiAgICAgICAgaW5kZXgucmVtb3ZlSGFuZGxlcihEQVRBU0VUX0lOREVYX0hBTkRMRVIsIGRhdGFzZXQpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBpbmRleGVzKSByZXR1cm47CiAgICAgICAgZGF0YXNldC5yZW1vdmVIYW5kbGVyKERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSKTsKICAgICAgICBkZWxldGUgZGF0YXNldEluZGV4ZXNbZGF0YXNldC5iYXNpc09iamVjdElkXTsKICAgICAgfQogICAgfQogICAgdmFyIENhbGNJbmRleFByZXNldCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNhbGNJbmRleFByZXNldCIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5kZXhlczoge30sCiAgICAgIGNhbGM6IGJhc2lzLmZuLiRudWxsCiAgICB9KTsKICAgIHZhciBjYWxjSW5kZXhQcmVzZXRTZWVkID0gMTsKICAgIGZ1bmN0aW9uIGdldFVuaXF1ZUNhbGNJbmRleElkKCkgewogICAgICByZXR1cm4gImNhbGMtaW5kZXgtcHJlc2V0LSIgKyBiYXNpcy5udW1iZXIubGVhZChjYWxjSW5kZXhQcmVzZXRTZWVkKyssIDgpOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mUmFuZ2UoZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIG1pbkluZGV4ID0gIm1pbl8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIG1heEluZGV4ID0gIm1heF8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgaW5kZXhlc1ttaW5JbmRleF0gPSBtaW4oZXZlbnRzLCBnZXR0ZXIpOwogICAgICBpbmRleGVzW21heEluZGV4XSA9IG1heChldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIChnZXR0ZXIob2JqZWN0KSAtIGluZGV4W21pbkluZGV4XSkgLyAoaW5kZXhbbWF4SW5kZXhdIC0gaW5kZXhbbWluSW5kZXhdKTsKICAgICAgfTsKICAgICAgcmV0dXJuIGNhbGMucHJlc2V0ID0gbmV3IENhbGNJbmRleFByZXNldCh7CiAgICAgICAgaW5kZXhlczogaW5kZXhlcywKICAgICAgICBjYWxjOiBjYWxjCiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mTWF4KGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHZhciBtYXhJbmRleCA9ICJtYXhfIiArIGdldFVuaXF1ZUNhbGNJbmRleElkKCk7CiAgICAgIHZhciBpbmRleGVzID0ge307CiAgICAgIGluZGV4ZXNbbWF4SW5kZXhdID0gbWF4KGV2ZW50cywgZ2V0dGVyKTsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlciB8fCBldmVudHMpOwogICAgICB2YXIgY2FsYyA9IGZ1bmN0aW9uKGRhdGEsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdCkgLyBpbmRleFttYXhJbmRleF07CiAgICAgIH07CiAgICAgIHJldHVybiBjYWxjLnByZXNldCA9IG5ldyBDYWxjSW5kZXhQcmVzZXQoewogICAgICAgIGluZGV4ZXM6IGluZGV4ZXMsCiAgICAgICAgY2FsYzogY2FsYwogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHBlcmNlbnRPZlN1bShnZXR0ZXIsIGV2ZW50cykgewogICAgICB2YXIgc3VtSW5kZXggPSAic3VtXyIgKyBnZXRVbmlxdWVDYWxjSW5kZXhJZCgpOwogICAgICB2YXIgaW5kZXhlcyA9IHt9OwogICAgICBpbmRleGVzW3N1bUluZGV4XSA9IHN1bShldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGdldHRlcihvYmplY3QpIC8gaW5kZXhbc3VtSW5kZXhdOwogICAgICB9OwogICAgICByZXR1cm4gY2FsYy5wcmVzZXQgPSBuZXcgQ2FsY0luZGV4UHJlc2V0KHsKICAgICAgICBpbmRleGVzOiBpbmRleGVzLAogICAgICAgIGNhbGM6IGNhbGMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgSW5kZXhNYXAgPSBDbGFzcyhNYXBGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4TWFwIiwKICAgICAgY2FsY3M6IG51bGwsCiAgICAgIGluZGV4ZXM6IG51bGwsCiAgICAgIGluZGV4ZXNfOiBudWxsLAogICAgICBpbmRleGVzQmluZF86IG51bGwsCiAgICAgIHRpbWVyXzogdW5kZWZpbmVkLAogICAgICBpbmRleFVwZGF0ZWQ6IG51bGwsCiAgICAgIGluZGV4VmFsdWVzOiBudWxsLAogICAgICBtZW1iZXJTb3VyY2VNYXA6IG51bGwsCiAgICAgIGtleU1hcDogbnVsbCwKICAgICAgbWFwOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChpdGVtLCB0cnVlKTsKICAgICAgfSwKICAgICAgYWRkTWVtYmVyUmVmOiBmdW5jdGlvbihtZW1iZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXSA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5tZW1iZXIpIG1lbWJlci5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLm1lbWJlciwgdGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXS51cGRhdGVkID0gdHJ1ZTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCA+IDApIHRoaXMuY2FsY01lbWJlcihtZW1iZXIpOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKG1lbWJlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4ubWVtYmVyKSBtZW1iZXIucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5tZW1iZXIsIHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFNvdXJjZSkgewogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZW1pdF9zb3VyY2VDaGFuZ2VkLmNhbGwodGhpcywgb2xkU291cmNlKTsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzXykgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleGVzX1tpbmRleE5hbWVdOwogICAgICAgICAgaWYgKG9sZFNvdXJjZSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgICAgIHJlbW92ZURhdGFzZXRJbmRleChvbGRTb3VyY2UsIHRoaXMuaW5kZXhlc1tpbmRleE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSkgdGhpcy5hZGRJbmRleChpbmRleE5hbWUsIGdldERhdGFzZXRJbmRleCh0aGlzLnNvdXJjZSwgaW5kZXgpKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIGluZGV4OiB7CiAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICB2YXIgaW5kZXhNYXAgPSB0aGlzLmluZGV4TWFwOwogICAgICAgICAgICBpbmRleE1hcC5pbmRleFZhbHVlc1t0aGlzLmtleV0gPSBzZW5kZXIudmFsdWU7CiAgICAgICAgICAgIGluZGV4TWFwLmluZGV4VXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIGluZGV4TWFwLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1lbWJlcjogewogICAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgICAgIGlmIChvYmplY3Quc3Vic2NyaWJlckNvdW50ID4gMCkgdGhpcy5jYWxjTWVtYmVyKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBydWxlRXZlbnRzOiBiYXNpcy5kYXRhLmRhdGFzZXQuY3JlYXRlUnVsZUV2ZW50cyhmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5ydWxlRXZlbnRzLnVwZGF0ZS5jYWxsKHRoaXMsIHNlbmRlciwgZGVsdGEpOwogICAgICAgIHRoaXMuc291cmNlTWFwX1tzZW5kZXIuYmFzaXNPYmplY3RJZF0udXBkYXRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZWNhbGNSZXF1ZXN0KCk7CiAgICAgIH0sICJ1cGRhdGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZWNhbGMgPSB0aGlzLnJlY2FsYy5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSB7fTsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IHt9OwogICAgICAgIHZhciBpbmRleGVzID0gdGhpcy5pbmRleGVzOwogICAgICAgIHRoaXMuaW5kZXhlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXhlc18gPSB7fTsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0ge307CiAgICAgICAgdmFyIGNhbGNzID0gdGhpcy5jYWxjczsKICAgICAgICB0aGlzLmNhbGNzID0ge307CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBuZXcgS2V5T2JqZWN0TWFwKGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgY29uZmlnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoY29uZmlnKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzLmtleU1hcCkpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGluZGV4ZXMsIHRoaXMuYWRkSW5kZXgsIHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGNhbGNzLCB0aGlzLmFkZENhbGMsIHRoaXMpOwogICAgICB9LAogICAgICBhZGRJbmRleDogZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgIGlmICghdGhpcy5pbmRleGVzW2tleV0pIHsKICAgICAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4ZXNfW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLmluZGV4ZXNfW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc291cmNlID8gZ2V0RGF0YXNldEluZGV4KHRoaXMuc291cmNlLCBpbmRleCkgOiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgewogICAgICAgICAgICB0aGlzLmluZGV4VmFsdWVzW2tleV0gPSBpbmRleC52YWx1ZTsKICAgICAgICAgICAgdGhpcy5pbmRleGVzW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgdGhpcy5pbmRleGVzQmluZF9ba2V5XSA9IHsKICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICBpbmRleE1hcDogdGhpcwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmluZGV4OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICAgIGluZGV4LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcy5pbmRleGVzQmluZF9ba2V5XSk7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIuY2hhbmdlKSBsaXN0ZW5IYW5kbGVyLmNoYW5nZS5jYWxsKHRoaXMuaW5kZXhlc0JpbmRfW2tleV0sIGluZGV4LCBpbmRleC52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBzaG91bGQgYmUgaW5zdGFuY2Ugb2YgYGJhc2lzLmRhdGEuaW5kZXguSW5kZXhgIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVJbmRleDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHRoaXMuaW5kZXhlc19ba2V5XSB8fCB0aGlzLmluZGV4ZXNba2V5XSkgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXhlc1trZXldICYmIHRoaXMubGlzdGVuLmluZGV4KSB0aGlzLmluZGV4ZXNba2V5XS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLmluZGV4LCB0aGlzLmluZGV4ZXNCaW5kX1trZXldKTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4VmFsdWVzW2tleV07CiAgICAgICAgICBkZWxldGUgdGhpcy5pbmRleGVzQmluZF9ba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNfW2tleV07CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRDYWxjOiBmdW5jdGlvbihuYW1lLCBjYWxjQ2ZnKSB7CiAgICAgICAgaWYgKGNhbGNDZmcgaW5zdGFuY2VvZiBDYWxjSW5kZXhQcmVzZXQpIHsKICAgICAgICAgIHRoaXMuY2FsY3NbbmFtZV0gPSBjYWxjQ2ZnLmNhbGM7CiAgICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gY2FsY0NmZy5pbmRleGVzKSB0aGlzLmFkZEluZGV4KGluZGV4TmFtZSwgY2FsY0NmZy5pbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0gZWxzZSB0aGlzLmNhbGNzW25hbWVdID0gY2FsY0NmZzsKICAgICAgICB0aGlzLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2FsYzogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBjYWxjQ2ZnID0gdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgICBpZiAoY2FsY0NmZyAmJiBjYWxjQ2ZnLnByZXNldCBpbnN0YW5jZW9mIENhbGNJbmRleFByZXNldCkgewogICAgICAgICAgdmFyIGluZGV4ZXMgPSBjYWxjQ2ZnLnByZXNldC5pbmRleGVzOwogICAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIGluZGV4ZXMpIHRoaXMucmVtb3ZlSW5kZXgoaW5kZXhOYW1lLCBpbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS5sb2NrKCk7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS51bmxvY2soKTsKICAgICAgfSwKICAgICAgcmVjYWxjUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy5yZWNhbGMpOwogICAgICB9LAogICAgICByZWNhbGM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGlkeCBpbiB0aGlzLml0ZW1zXykgdGhpcy5jYWxjTWVtYmVyKHRoaXMuaXRlbXNfW2lkeF0pOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgIH0sCiAgICAgIGNhbGNNZW1iZXI6IGZ1bmN0aW9uKG1lbWJlcikgewogICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSB0aGlzLnNvdXJjZU1hcF9bdGhpcy5tZW1iZXJTb3VyY2VNYXBbbWVtYmVyLmJhc2lzT2JqZWN0SWRdXTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCAmJiAoc291cmNlT2JqZWN0LnVwZGF0ZWQgfHwgdGhpcy5pbmRleFVwZGF0ZWQpKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3QudXBkYXRlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgIHZhciBvbGRWYWx1ZTsKICAgICAgICAgIHZhciB1cGRhdGU7CiAgICAgICAgICBmb3IgKHZhciBjYWxjTmFtZSBpbiB0aGlzLmNhbGNzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5jYWxjc1tjYWxjTmFtZV0oc291cmNlT2JqZWN0LnNvdXJjZU9iamVjdC5kYXRhLCB0aGlzLmluZGV4VmFsdWVzLCBzb3VyY2VPYmplY3Quc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgb2xkVmFsdWUgPSBtZW1iZXIuZGF0YVtjYWxjTmFtZV07CiAgICAgICAgICAgIGlmIChtZW1iZXIuZGF0YVtjYWxjTmFtZV0gIT09IG5ld1ZhbHVlICYmICh0eXBlb2YgbmV3VmFsdWUgIT0gIm51bWJlciIgfHwgdHlwZW9mIG9sZFZhbHVlICE9ICJudW1iZXIiIHx8ICFpc05hTihuZXdWYWx1ZSkgfHwgIWlzTmFOKG9sZFZhbHVlKSkpIHsKICAgICAgICAgICAgICBkYXRhW2NhbGNOYW1lXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cGRhdGUpIG1lbWJlci51cGRhdGUoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRNZW1iZXI6IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoc291cmNlT2JqZWN0LCB0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICAgIHRoaXMuY2FsY3MgPSBudWxsOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gbnVsbDsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSBudWxsOwogICAgICAgIHRoaXMua2V5TWFwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmtleU1hcCA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIHRoaXMuaW5kZXhlcykgdGhpcy5yZW1vdmVJbmRleChpbmRleE5hbWUpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbmRleENvbnN0cnVjdG9yOiBJbmRleENvbnN0cnVjdG9yLAogICAgICBjcmVhdGVJbmRleENvbnN0cnVjdG9yOiBjcmVhdGVJbmRleENvbnN0cnVjdG9yLAogICAgICBnZXREYXRhc2V0SW5kZXg6IGdldERhdGFzZXRJbmRleCwKICAgICAgcmVtb3ZlRGF0YXNldEluZGV4OiByZW1vdmVEYXRhc2V0SW5kZXgsCiAgICAgIEluZGV4OiBJbmRleCwKICAgICAgQ291bnQ6IENvdW50LAogICAgICBTdW06IFN1bSwKICAgICAgQXZnOiBBdmcsCiAgICAgIFZlY3RvckluZGV4OiBWZWN0b3JJbmRleCwKICAgICAgTWluOiBNaW4sCiAgICAgIE1heDogTWF4LAogICAgICBjb3VudDogY291bnQsCiAgICAgIHN1bTogc3VtLAogICAgICBhdmc6IGF2ZywKICAgICAgbWF4OiBtYXgsCiAgICAgIG1pbjogbWluLAogICAgICBDYWxjSW5kZXhQcmVzZXQ6IENhbGNJbmRleFByZXNldCwKICAgICAgcGVyY2VudE9mUmFuZ2U6IHBlcmNlbnRPZlJhbmdlLAogICAgICBwZXJjZW50T2ZNYXg6IHBlcmNlbnRPZk1heCwKICAgICAgcGVyY2VudE9mU3VtOiBwZXJjZW50T2ZTdW0sCiAgICAgIEluZGV4TWFwOiBJbmRleE1hcAogICAgfTsKICB9LAogICJmLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBnZXR0ZXIgPSBiYXNpcy5nZXR0ZXI7CiAgICB2YXIgY2xlYW5lciA9IGJhc2lzLmNsZWFuZXI7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIFNUQVRFID0gYmFzaXMuZGF0YS5TVEFURTsKICAgIHZhciBQcm9wZXJ0eSA9IFZhbHVlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlByb3BlcnR5IiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiBmYWxzZSwKICAgICAgaW5pdDogZnVuY3Rpb24oaW5pdFZhbHVlLCBoYW5kbGVyLCBwcm94eSkgewogICAgICAgIHRoaXMudmFsdWUgPSBpbml0VmFsdWU7CiAgICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICB0aGlzLnByb3h5ID0gcHJveHk7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgT0JKRUNUU0VUX1NUQVRFX1BSSU9SSVRZID0gU1RBVEUucHJpb3JpdHk7CiAgICB2YXIgT0JKRUNUU0VUX0hBTkRMRVIgPSB7CiAgICAgIHN0YXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKGZhbHNlLCB0cnVlKTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSk7CiAgICAgIH0sCiAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKHRydWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB0aGlzLnJlbW92ZShvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgdmFyIE9iamVjdFNldCA9IFZhbHVlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk9iamVjdFNldCIsCiAgICAgIG9iamVjdHM6IG51bGwsCiAgICAgIHZhbHVlOiAwLAogICAgICB2YWx1ZUNoYW5nZWRfOiBmYWxzZSwKICAgICAgY2FsY3VsYXRlVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlICsgMTsKICAgICAgfSwKICAgICAgY2FsY3VsYXRlT25Jbml0OiBmYWxzZSwKICAgICAgc3RhdGVQcmlvcml0eTogT0JKRUNUU0VUX1NUQVRFX1BSSU9SSVRZLAogICAgICBzdGF0ZUNoYW5nZWRfOiB0cnVlLAogICAgICB0aW1lcl86IGZhbHNlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBvYmplY3RzID0gdGhpcy5vYmplY3RzOwogICAgICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgICAgIGlmIChvYmplY3RzICYmIEFycmF5LmlzQXJyYXkob2JqZWN0cykpIHsKICAgICAgICAgIHRoaXMubG9jaygpOwogICAgICAgICAgdGhpcy5hZGQuYXBwbHkodGhpcywgb2JqZWN0cyk7CiAgICAgICAgICB0aGlzLnVubG9jaygpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZF8gPSB0aGlzLnN0YXRlQ2hhbmdlZF8gPSAhIXRoaXMuY2FsY3VsYXRlT25Jbml0OwogICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGEpIHsKICAgICAgICAgICAgaWYgKGJhc2lzLmFycmF5LmFkZCh0aGlzLm9iamVjdHMsIG9iamVjdCkpIG9iamVjdC5hZGRIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB0aHJvdyB0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIjYWRkOiBJbnN0YW5jZSBvZiBBYnN0cmFjdERhdGEgcmVxdWlyZWQiOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIHJlbW92ZTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLm9iamVjdHMsIG9iamVjdCkpIG9iamVjdC5yZW1vdmVIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSB0aGlzLm9iamVjdHNbaV07IGkrKykgb2JqZWN0LnJlbW92ZUhhbmRsZXIoT0JKRUNUU0VUX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIHRoaXMub2JqZWN0cy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuZmlyZSh0cnVlLCB0cnVlKTsKICAgICAgfSwKICAgICAgZmlyZTogZnVuY3Rpb24odmFsdWVDaGFuZ2VkLCBzdGF0ZUNoYW5nZWQpIHsKICAgICAgICBpZiAoIXRoaXMubG9ja2VkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZF8gPSB0aGlzLnZhbHVlQ2hhbmdlZF8gfHwgISF2YWx1ZUNoYW5nZWQ7CiAgICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlZF8gPSB0aGlzLnN0YXRlQ2hhbmdlZF8gfHwgISFzdGF0ZUNoYW5nZWQ7CiAgICAgICAgICBpZiAoIXRoaXMudGltZXJfICYmICh0aGlzLnZhbHVlQ2hhbmdlZF8gfHwgdGhpcy5zdGF0ZUNoYW5nZWRfKSkgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy51cGRhdGUuYmluZCh0aGlzKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBsb2NrOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdmFsdWVDaGFuZ2VkID0gdGhpcy52YWx1ZUNoYW5nZWRfOwogICAgICAgIHZhciBzdGF0ZUNoYW5nZWQgPSB0aGlzLnN0YXRlQ2hhbmdlZF87CiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gZmFsc2U7CiAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZWRfID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgaWYgKCFjbGVhbmVyLmdsb2JhbERlc3Ryb3kpIHsKICAgICAgICAgIGlmICh2YWx1ZUNoYW5nZWQpIHRoaXMuc2V0KHRoaXMuY2FsY3VsYXRlVmFsdWUoKSk7CiAgICAgICAgICBpZiAoc3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLm9iamVjdHMubGVuZ3RoOwogICAgICAgICAgICBpZiAoIWxlbikgdGhpcy5zZXRTdGF0ZShTVEFURS5VTkRFRklORUQpOyBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbWF4V2VpZ2h0ID0gLTI7CiAgICAgICAgICAgICAgdmFyIGN1ck9iamVjdDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0gdGhpcy5vYmplY3RzW2ldOwogICAgICAgICAgICAgICAgdmFyIHdlaWdodCA9IHRoaXMuc3RhdGVQcmlvcml0eS5pbmRleE9mKFN0cmluZyhvYmplY3Quc3RhdGUpKTsKICAgICAgICAgICAgICAgIGlmICh3ZWlnaHQgPiBtYXhXZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgY3VyT2JqZWN0ID0gb2JqZWN0OwogICAgICAgICAgICAgICAgICBtYXhXZWlnaHQgPSB3ZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJPYmplY3QpIHRoaXMuc2V0U3RhdGUoY3VyT2JqZWN0LnN0YXRlLCBjdXJPYmplY3Quc3RhdGUuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubG9jaygpOwogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICBpZiAodGhpcy50aW1lcl8pIGJhc2lzLmNsZWFySW1tZWRpYXRlKHRoaXMudGltZXJfKTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFeHByZXNzaW9uID0gUHJvcGVydHkuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXhwcmVzc2lvbiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGFyZ3MsIGNhbGMpIHsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBhcmdzID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKTsKICAgICAgICB2YXIgY2FsYyA9IGFyZ3MucG9wKCk7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxjICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIjogbGFzdCBhcmd1bWVudCBvZiBjb25zdHJ1Y3RvciBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgIGNhbGMgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgfQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICBhcmdzWzBdLmxpbmsodGhpcywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zZXQoY2FsYy5jYWxsKHRoaXMsIHZhbHVlKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMSkgewogICAgICAgICAgdmFyIGNoYW5nZVdhdGNoZXIgPSBuZXcgT2JqZWN0U2V0KHsKICAgICAgICAgICAgb2JqZWN0czogYXJncywKICAgICAgICAgICAgY2FsY3VsYXRlT25Jbml0OiB0cnVlLAogICAgICAgICAgICBjYWxjdWxhdGVWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGMuYXBwbHkodGhpcywgYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNoYW5nZVdhdGNoZXIubGluayh0aGlzLCB0aGlzLnNldCk7CiAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoewogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIWNsZWFuZXIuZ2xvYmFsRGVzdHJveSkgY2hhbmdlV2F0Y2hlci5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgUHJvcGVydHk6IFByb3BlcnR5LAogICAgICBPYmplY3RTZXQ6IE9iamVjdFNldCwKICAgICAgRXhwcmVzc2lvbjogRXhwcmVzc2lvbgogICAgfTsKICB9LAogICJnLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgaG9zdCA9IHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gInVuZGVmaW5lZCIgPyBwZXJmb3JtYW5jZSA6IERhdGU7CiAgICB2YXIgbm93TWV0aG9kID0gIndlYmtpdE5vdyIgaW4gaG9zdCA/ICJ3ZWJraXROb3ciIDogIm5vdyI7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgdGltZTogZnVuY3Rpb24odGltZSkgewogICAgICAgIHJldHVybiAhYXJndW1lbnRzLmxlbmd0aCA/IGhvc3Rbbm93TWV0aG9kXSgpIDogcGFyc2VJbnQoaG9zdFtub3dNZXRob2RdKCkgLSB0aW1lKTsKICAgICAgfSwKICAgICAgdGVzdDogZnVuY3Rpb24odGltZXMsIGZuKSB7CiAgICAgICAgdmFyIHQgPSB0aGlzLnRpbWUoKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVzOyBpKyspIGZuKGkpOwogICAgICAgIHJldHVybiB0aGlzLnRpbWUodCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAiaC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2YuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9kLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzYuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgdmFyIHV0aWxzID0gYmFzaXMucmVxdWlyZSgiLi9wLmpzIik7CiAgICB2YXIgZW52RmFjdG9yeSA9IGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpOwogICAgdmFyIGFzdFRvb2xzID0gYmFzaXMucmVxdWlyZSgiLi9rLmpzIik7CiAgICB2YXIgRVJST1JfVEVTVF9GQVVMVCA9ICJFUlJPUl9URVNUX0ZBVUxUIjsKICAgIHZhciBFUlJPUl9FTVBUWSA9ICJFUlJPUl9FTVBUWSI7CiAgICB2YXIgRVJST1JfVEVTVF9DUkFTSCA9ICJFUlJPUl9URVNUX0NSQVNIIjsKICAgIHZhciBFUlJPUl9USU1FT1VUID0gIkVSUk9SX1RJTUVPVVQiOwogICAgdmFyIE5PUCA9IGZ1bmN0aW9uKCkge307CiAgICB2YXIgdGVzdE1hcCA9IHt9OwogICAgZnVuY3Rpb24gY3JlYXRlVGVzdEZhY3RvcnkoZGF0YSkgewogICAgICBpZiAoZGF0YS50ZXN0Y2FzZSkgYmFzaXMuZGV2Lndhcm4oImB0ZXN0Y2FzZWAgc2V0dGluZyBpcyBkZXByZWNhdGVkLCB1c2UgYHRlc3RgIGluc3RlYWQiKTsKICAgICAgdmFyIHRlc3QgPSBkYXRhLnRlc3QgfHwgZGF0YS50ZXN0Y2FzZTsKICAgICAgZGF0YSA9IGJhc2lzLm9iamVjdC5zbGljZShkYXRhKTsKICAgICAgYmFzaXMub2JqZWN0LnNwbGljZShkYXRhLCBbICJ0ZXN0IiwgInRlc3RjYXNlIiBdKTsKICAgICAgaWYgKHRlc3QpIHsKICAgICAgICBpZiAoYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZShkYXRhKSkgdGVzdCA9IHRlc3QuZmV0Y2goKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZXN0ID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfQogICAgICBpZiAoIWRhdGEubmFtZSkgZGF0YS5uYW1lID0gIlVudGl0bGVkIHRlc3QiOwogICAgICB2YXIgQ2xhc3M7CiAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgZGF0YTogZGF0YQogICAgICB9OwogICAgICBpZiAodHlwZW9mIHRlc3QgPT0gImZ1bmN0aW9uIikgewogICAgICAgIHZhciBmbkluZm8gPSB1dGlscy5nZXRGbkluZm8odGVzdCk7CiAgICAgICAgY29uZmlnLmRhdGEuYXN5bmMgPSAhIWZuSW5mby5hcmdzLmxlbmd0aDsKICAgICAgICBjb25maWcuZGF0YS50ZXN0QXJncyA9IGZuSW5mby5hcmdzOwogICAgICAgIGNvbmZpZy5kYXRhLnRlc3RTb3VyY2UgPSBmbkluZm8uY29kZTsKICAgICAgICBDbGFzcyA9IFRlc3RDYXNlOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZy5jaGlsZE5vZGVzID0gIUFycmF5LmlzQXJyYXkodGVzdCkgPyBbXSA6IHRlc3Q7CiAgICAgICAgQ2xhc3MgPSBUZXN0U3VpdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBDbGFzcyhjb25maWcpOwogICAgfQogICAgdmFyIEZJTEVfSEFORExFUiA9IHsKICAgICAgdXBkYXRlOiBmdW5jdGlvbihmaWxlLCBkZWx0YSkgewogICAgICAgIGlmICgiY29udGVudCIgaW4gZGVsdGEpIHsKICAgICAgICAgIHZhciBleHBvcnRzID0gYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzIl0oZmlsZS5kYXRhLmNvbnRlbnQsIGZpbGUuZGF0YS5maWxlbmFtZSArICIuIiArIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgdmFyIGNvbmZpZyA9IEFycmF5LmlzQXJyYXkoZXhwb3J0cykgPyB7CiAgICAgICAgICAgIHRlc3Q6IGV4cG9ydHMKICAgICAgICAgIH0gOiBleHBvcnRzOwogICAgICAgICAgdmFyIG5ld05vZGUgPSBjcmVhdGVUZXN0RmFjdG9yeShjb25maWcpOwogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdOb2RlLCB0aGlzKTsKICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciBBYnN0cmFjdFRlc3QgPSBiYXNpcy5kb20ud3JhcHBlci5Ob2RlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiAiQWJzdHJhY3RUZXN0IiwKICAgICAgbmFtZTogIiIsCiAgICAgIGVudlJ1bm5lcjogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMuZG9tLndyYXBwZXIuTm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBoYXNPd25FbnZpcm9ubWVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5kYXRhLmluaXQgfHwgdGhpcy5kYXRhLmh0bWwgfHwgIXRoaXMucGFyZW50Tm9kZSk7CiAgICAgIH0sCiAgICAgIGdldEh0bWw6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlICghY3Vyc29yLmRhdGEuaHRtbCAmJiBjdXJzb3IucGFyZW50Tm9kZSkgY3Vyc29yID0gY3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgcmV0dXJuIGN1cnNvci5kYXRhLmh0bWw7CiAgICAgIH0sCiAgICAgIGdldEVudlJ1bm5lcjogZnVuY3Rpb24oYXV0b2NyZWF0ZSkgewogICAgICAgIGlmICh0aGlzLmVudlJ1bm5lcikgcmV0dXJuIHRoaXMuZW52UnVubmVyOwogICAgICAgIHZhciBlbnZSdW5uZXI7CiAgICAgICAgaWYgKCF0aGlzLmRhdGEuaW5pdCkgZW52UnVubmVyID0gdGhpcy5wYXJlbnROb2RlICYmIHRoaXMucGFyZW50Tm9kZS5nZXRFbnZSdW5uZXIoYXV0b2NyZWF0ZSk7CiAgICAgICAgaWYgKCh0aGlzLmRhdGEuaW5pdCB8fCB0aGlzLmRhdGEuaHRtbCB8fCAhZW52UnVubmVyKSAmJiBhdXRvY3JlYXRlKSB7CiAgICAgICAgICBlbnZSdW5uZXIgPSBlbnZGYWN0b3J5LmNyZWF0ZSh0aGlzLmRhdGEuaW5pdCwgdGhpcy5nZXRIdG1sKCkpOwogICAgICAgICAgZW52UnVubmVyLmFkZEhhbmRsZXIoewogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgIHRoaXMuZW52UnVubmVyID0gZW52UnVubmVyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW52UnVubmVyOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuZW52UnVubmVyKSB7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lci5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kb20ud3JhcHBlci5Ob2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZW52UnVubmVyKSB7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lci5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmZpbGUpIHsKICAgICAgICAgIHRoaXMuZmlsZS5yZW1vdmVIYW5kbGVyKEZJTEVfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB0aGlzLmZpbGUgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVzdENhc2UgPSBBYnN0cmFjdFRlc3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6ICJUZXN0Q2FzZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICB0ZXN0U291cmNlOiBudWxsLAogICAgICB0ZXN0V3JhcHBlZFNvdXJjZXM6IG51bGwsCiAgICAgIGNoaWxkQ2xhc3M6IG51bGwsCiAgICAgIGdldFNvdXJjZUNvZGU6IGZ1bmN0aW9uKGJyZWFrcG9pbnRBdCkgewogICAgICAgIGlmICh0aGlzLnRlc3RXcmFwcGVkU291cmNlcyA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy50ZXN0V3JhcHBlZFNvdXJjZXMgPSB7fTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBicmVha3BvaW50QXQgIT0gIm51bWJlciIpIGJyZWFrcG9pbnRBdCA9ICJub25lIjsKICAgICAgICBpZiAoIXRoaXMudGVzdFdyYXBwZWRTb3VyY2VzW2JyZWFrcG9pbnRBdF0pIHsKICAgICAgICAgIHZhciBhc3QgPSBhc3RUb29scy5wYXJzZSh0aGlzLmRhdGEudGVzdFNvdXJjZSk7CiAgICAgICAgICBpZiAoYnJlYWtwb2ludEF0ID09ICJub25lIikgewogICAgICAgICAgICBhc3RUb29scy50cmF2ZXJzZUFzdChhc3QsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50eXBlID09ICJQcm9ncmFtIikgcmV0dXJuOwogICAgICAgICAgICAgIGlmIChub2RlLnR5cGUgPT0gIkZ1bmN0aW9uRXhwcmVzc2lvbiIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbnMgPSBhc3RUb29scy5nZXROb2RlUmFuZ2VUb2tlbnMobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgb3JpZyA9IGFzdFRvb2xzLnRyYW5zbGF0ZUFzdChhc3QsIHRva2Vuc1swXS5yYW5nZVswXSwgdG9rZW5zWzFdLnJhbmdlWzFdKTsKICAgICAgICAgICAgICAgIHRva2Vuc1swXS52YWx1ZSA9ICJfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24oIiArIHRva2Vuc1swXS52YWx1ZTsKICAgICAgICAgICAgICAgIHRva2Vuc1sxXS52YWx1ZSArPSAiLCAiICsgb3JpZyArICIpIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAiRnVuY3Rpb25EZWNsYXJhdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbnMgPSBhc3RUb29scy5nZXROb2RlUmFuZ2VUb2tlbnMobm9kZS5ib2R5KTsKICAgICAgICAgICAgICAgIHRva2Vuc1swXS52YWx1ZSArPSAiXG50cnkge1xuIjsKICAgICAgICAgICAgICAgIHRva2Vuc1sxXS52YWx1ZSA9ICJcbn0gY2F0Y2goZSkgeyIgKyAiX19leGNlcHRpb24oZSk7IiArICJ0aHJvdyBlOyIgKyAifVxuIiArIHRva2Vuc1sxXS52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAiQ2FsbEV4cHJlc3Npb24iKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlLnR5cGUgPT0gIkV4cHJlc3Npb25TdGF0ZW1lbnQiKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGFzdFRvb2xzLmdldE5vZGVSYW5nZVRva2Vucyhub2RlKVswXTsKICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSAiX19pc0ZvcihbIiArIG5vZGUucmFuZ2UgKyAiXSwgIiArIChub2RlLmxvYy5lbmQubGluZSAtIDEpICsgIikgfHwgIiArIHRva2VuLnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAobm9kZS5hcmd1bWVudHMubGVuZ3RoID09IDEgJiYgbm9kZS5hcmd1bWVudHNbMF0udHlwZSA9PSAiQmluYXJ5RXhwcmVzc2lvbiIgJiYgbm9kZS5hcmd1bWVudHNbMF0ub3BlcmF0b3IubWF0Y2goL14oPT09PykkLykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdFRva2VuID0gYXN0VG9vbHMuZ2V0Tm9kZVJhbmdlVG9rZW5zKG5vZGUuYXJndW1lbnRzWzBdLmxlZnQpOwogICAgICAgICAgICAgICAgICAgIHZhciByaWdodFRva2VuID0gYXN0VG9vbHMuZ2V0Tm9kZVJhbmdlVG9rZW5zKG5vZGUuYXJndW1lbnRzWzBdLnJpZ2h0KTsKICAgICAgICAgICAgICAgICAgICBsZWZ0VG9rZW5bMF0udmFsdWUgPSAnX19hY3R1YWwoIicgKyBub2RlLmFyZ3VtZW50c1swXS5vcGVyYXRvciArICciLCcgKyBsZWZ0VG9rZW5bMF0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgbGVmdFRva2VuWzFdLnZhbHVlICs9ICIpIjsKICAgICAgICAgICAgICAgICAgICByaWdodFRva2VuWzBdLnZhbHVlID0gIl9fZXhwZWN0ZWQoIiArIHJpZ2h0VG9rZW5bMF0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmlnaHRUb2tlblsxXS52YWx1ZSArPSAiKSI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZS50eXBlID09ICJCbG9ja1N0YXRlbWVudCIgfHwgbm9kZS5wYXJlbnROb2RlLnR5cGUgPT0gIlByb2dyYW0iKSB7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RUb2tlbiA9IGFzdFRvb2xzLmdldE5vZGVSYW5nZVRva2Vucyhub2RlKVswXTsKICAgICAgICAgICAgICAgIGZpcnN0VG9rZW4udmFsdWUgPSAiX19lbnRlckxpbmUoIiArIChmaXJzdFRva2VuLmxvYy5zdGFydC5saW5lIC0gMSkgKyAiKTsiICsgZmlyc3RUb2tlbi52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdyYXBwZXJTb3VyY2UgPSBhc3RUb29scy50cmFuc2xhdGVBc3QoYXN0LCAwLCBhc3Quc291cmNlLmxlbmd0aCk7CiAgICAgICAgICB0aGlzLnRlc3RXcmFwcGVkU291cmNlc1ticmVha3BvaW50QXRdID0gImZ1bmN0aW9uKCIgKyB0aGlzLmRhdGEudGVzdEFyZ3MuY29uY2F0KCJhc3NlcnQiLCAiX19pc0ZvciIsICJfX2VudGVyTGluZSIsICJfX2V4Y2VwdGlvbiIsICJfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24iLCAiX19hY3R1YWwiLCAiX19leHBlY3RlZCIpLmpvaW4oIiwgIikgKyAiKXtcbiIgKyB3cmFwcGVyU291cmNlICsgIlxufSI7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlc3RXcmFwcGVkU291cmNlc1ticmVha3BvaW50QXRdOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3RUZXN0LnByb3RvdHlwZS5yZXNldC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc2V0U3RhdGUoYmFzaXMuZGF0YS5TVEFURS5VTkRFRklORUQpOwogICAgICB9LAogICAgICBydW46IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB3YXJuTWVzc2FnZXMgPSBbXTsKICAgICAgICB2YXIgZXJyb3JNZXNzYWdlcyA9IFtdOwogICAgICAgIHZhciBlcnJvcjsKICAgICAgICB2YXIgdGltZSA9IE5hTjsKICAgICAgICB2YXIgc3RhcnRUaW1lOwogICAgICAgIHZhciB0aW1lb3V0VGltZXI7CiAgICAgICAgdmFyIGFzeW5jID0gdGhpcy5kYXRhLmFzeW5jID8gMSA6IDA7CiAgICAgICAgdmFyIGlzTm9kZSA9IG51bGw7CiAgICAgICAgdmFyIGltcGxpY2l0Q29tcGFyZTsKICAgICAgICB2YXIgYWN0dWFsXzsKICAgICAgICB2YXIgZXhwZWN0ZWRfOwogICAgICAgIHZhciByZXBvcnQgPSB7CiAgICAgICAgICB0ZXN0OiBudWxsLAogICAgICAgICAgdGVzdFNvdXJjZTogdGhpcy5kYXRhLnRlc3RTb3VyY2UsCiAgICAgICAgICB0aW1lOiB0aW1lLAogICAgICAgICAgbGFzdExpbmU6IDAsCiAgICAgICAgICBwZW5kaW5nOiBmYWxzZSwKICAgICAgICAgIHN1Y2Nlc3NDb3VudDogMCwKICAgICAgICAgIHRlc3RDb3VudDogMCwKICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgZXhjZXB0aW9uOiBudWxsLAogICAgICAgICAgZXJyb3JMaW5lczoge30sCiAgICAgICAgICB3YXJuczogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIGVudiA9IHsKICAgICAgICAgIGFzeW5jOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICBhc3luYysrOwogICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoYXN5bmMgPiAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBmbi5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbihlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIGlmIChhc3luYyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIS0tYXN5bmMpIHRlc3REb25lKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgICAgICB9LAogICAgICAgICAgaXM6IGZ1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwsIGRlZXApIHsKICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IgPSB1dGlscy5pc1RydXRoeShleHBlY3RlZCk7CiAgICAgICAgICAgICAgaWYgKGltcGxpY2l0Q29tcGFyZSkgewogICAgICAgICAgICAgICAgYWN0dWFsID0gYWN0dWFsXzsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gZXhwZWN0ZWRfOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhY3R1YWwgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXJyb3IgPSB1dGlscy5jb21wYXJlVmFsdWVzKGV4cGVjdGVkLCBhY3R1YWwsIGRlZXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgIGlmIChpc05vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBsaW5lID0gaXNOb2RlLmxpbmU7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JzID0gcmVwb3J0LmVycm9yTGluZXNbbGluZV07CiAgICAgICAgICAgICAgICBpZiAoIWVycm9ycykgZXJyb3JzID0gcmVwb3J0LmVycm9yTGluZXNbbGluZV0gPSBbXTsKICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbnVtOiByZXBvcnQudGVzdENvdW50LAogICAgICAgICAgICAgICAgICBub2RlOiBpc05vZGUsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQ6IHV0aWxzLm1ha2VTdGF0aWNDb3B5KGV4cGVjdGVkKSwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRTdHI6IHV0aWxzLnZhbHVlMnN0cmluZyhleHBlY3RlZCwgZmFsc2UsIGRlZXApLAogICAgICAgICAgICAgICAgICBhY3R1YWw6IHV0aWxzLm1ha2VTdGF0aWNDb3B5KGFjdHVhbCksCiAgICAgICAgICAgICAgICAgIGFjdHVhbFN0cjogdXRpbHMudmFsdWUyc3RyaW5nKGFjdHVhbCwgZmFsc2UsIGRlZXApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW1wbGljaXRDb21wYXJlID0gZmFsc2U7CiAgICAgICAgICAgIGFjdHVhbF8gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGV4cGVjdGVkXyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgcmVwb3J0LnN1Y2Nlc3NDb3VudCArPSAhZXJyb3I7CiAgICAgICAgICAgIHJlcG9ydC50ZXN0Q291bnQrKzsKICAgICAgICAgIH0sCiAgICAgICAgICByZXBvcnQ6IHJlcG9ydAogICAgICAgIH07CiAgICAgICAgdmFyIF9fYWN0dWFsID0gZnVuY3Rpb24ob3BlcmF0b3IsIHZhbHVlKSB7CiAgICAgICAgICBpbXBsaWNpdENvbXBhcmUgPSBvcGVyYXRvcjsKICAgICAgICAgIGFjdHVhbF8gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwogICAgICAgIHZhciBfX2V4cGVjdGVkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGV4cGVjdGVkXyA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CiAgICAgICAgdmFyIF9faXNGb3IgPSBmdW5jdGlvbihyYW5nZSwgbGluZSkgewogICAgICAgICAgcmVwb3J0Lmxhc3RMaW5lID0gbGluZTsKICAgICAgICAgIGlzTm9kZSA9IHsKICAgICAgICAgICAgcmFuZ2U6IHJhbmdlLAogICAgICAgICAgICBsaW5lOiBsaW5lCiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgdmFyIF9fZW50ZXJMaW5lID0gZnVuY3Rpb24obGluZSkgewogICAgICAgICAgcmVwb3J0Lmxhc3RMaW5lID0gbGluZTsKICAgICAgICB9OwogICAgICAgIHZhciBfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24gPSBmdW5jdGlvbihmbiwgb3JpZykgewogICAgICAgICAgdmFyIHdyYXBwZWRGbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgX19leGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdyYXBwZWRGbi5vcmlnaW5hbEZuXyA9IG9yaWc7CiAgICAgICAgICByZXR1cm4gd3JhcHBlZEZuOwogICAgICAgIH07CiAgICAgICAgdmFyIF9fZXhjZXB0aW9uID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgaWYgKHJlcG9ydC5leGNlcHRpb24pIHJldHVybjsKICAgICAgICAgIHJlcG9ydC5leGNlcHRpb24gPSBlOwogICAgICAgICAgcmVwb3J0LnRlc3RDb3VudCA9IDA7CiAgICAgICAgICByZXBvcnQuc3VjY2Vzc0NvdW50ID0gMDsKICAgICAgICAgIHRlc3REb25lKEVSUk9SX1RFU1RfQ1JBU0gpOwogICAgICAgIH07CiAgICAgICAgdmFyIGFzeW5jRG9uZSA9IGFzeW5jID8gYmFzaXMuZm4ucnVuT25jZShmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChhc3luYyA+IDApIGFzeW5jLS07CiAgICAgICAgICBpZiAoIWFzeW5jKSB0ZXN0RG9uZSgpOwogICAgICAgIH0pIDogTk9QOwogICAgICAgIHZhciB0ZXN0RG9uZSA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICB0aW1lID0gYmFzaXMudXRpbHMuYmVuY2htYXJrLnRpbWUoc3RhcnRUaW1lKTsKICAgICAgICAgIHRpbWVvdXRUaW1lciA9IGNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICAgICAgYXN5bmMgPSAwOwogICAgICAgICAgaWYgKCFlcnJvciAmJiByZXBvcnQudGVzdENvdW50ICE9IHJlcG9ydC5zdWNjZXNzQ291bnQpIGVycm9yID0gRVJST1JfVEVTVF9GQVVMVDsKICAgICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQocmVwb3J0LCB7CiAgICAgICAgICAgIHRlc3Q6IHRoaXMsCiAgICAgICAgICAgIHRpbWU6IHRpbWUsCiAgICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgICAgcGVuZGluZzogIWVycm9yICYmICFyZXBvcnQudGVzdENvdW50LAogICAgICAgICAgICB3YXJuczogd2Fybk1lc3NhZ2VzLmxlbmd0aCA/IHdhcm5NZXNzYWdlcyA6IG51bGwKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5zZXRTdGF0ZShlcnJvciB8fCBlcnJvck1lc3NhZ2VzLmxlbmd0aCA/IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgOiBiYXNpcy5kYXRhLlNUQVRFLlJFQURZLCBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgICAgICBkYXRhOiByZXBvcnQKICAgICAgICAgIH0pKTsKICAgICAgICB9LmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy5zZXRTdGF0ZShiYXNpcy5kYXRhLlNUQVRFLlBST0NFU1NJTkcpOwogICAgICAgIGlmICh0aGlzLmRhdGEucGVuZGluZykgcmV0dXJuIHRlc3REb25lKCk7CiAgICAgICAgdGhpcy5nZXRFbnZSdW5uZXIodHJ1ZSkucnVuKHRoaXMuZ2V0U291cmNlQ29kZSgpLCB0aGlzLCBmdW5jdGlvbih0ZXN0Rm4pIHsKICAgICAgICAgIHN0YXJ0VGltZSA9IGJhc2lzLnV0aWxzLmJlbmNobWFyay50aW1lKCk7CiAgICAgICAgICB2YXIgYXNzZXJ0ID0gZW52LmlzLmJpbmQoZW52KTsKICAgICAgICAgIGFzc2VydC5leGNlcHRpb24gPSBhc3NlcnQudGhyb3dzID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXBvcnQuZXhjZXB0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgIGFzc2VydChmYWxzZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBhc3NlcnQodHJ1ZSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgcmVwb3J0LmV4Y2VwdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgYXNzZXJ0LmRlZXAgPSBmdW5jdGlvbihleHBlY3RlZCwgYWN0dWFsKSB7CiAgICAgICAgICAgIGFzc2VydChleHBlY3RlZCwgYWN0dWFsLCB0cnVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5LmNyZWF0ZSh0aGlzLmRhdGEudGVzdEFyZ3MubGVuZ3RoKTsKICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCkgYXJnc1swXSA9IGFzeW5jRG9uZTsKICAgICAgICAgIGFyZ3MucHVzaChhc3NlcnQsIF9faXNGb3IsIF9fZW50ZXJMaW5lLCBfX2V4Y2VwdGlvbiwgX193cmFwRnVuY3Rpb25FeHByZXNzaW9uLCBfX2FjdHVhbCwgX19leHBlY3RlZCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0ZXN0Rm4uYXBwbHkoZW52LCBhcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIF9fZXhjZXB0aW9uKGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFhc3luYykgdGVzdERvbmUoKTsgZWxzZSB0aW1lb3V0VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0ZXN0RG9uZShFUlJPUl9USU1FT1VUKTsKICAgICAgICAgIH0sIHRoaXMuZGF0YS50aW1lb3V0IHx8IDI1MCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFRlc3RTdWl0ZSA9IEFic3RyYWN0VGVzdC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogIlRlc3RTdWl0ZSIsCiAgICAgIGNoaWxkRmFjdG9yeTogY3JlYXRlVGVzdEZhY3RvcnksCiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0VGVzdCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3RUZXN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5uZXN0ZWRUZXN0c18gPSBuZXcgYmFzaXMuZGF0YS5EYXRhc2V0KHsKICAgICAgICAgIGl0ZW1zOiB0aGlzLmNoaWxkTm9kZXMucmVkdWNlKGZ1bmN0aW9uKHJlcywgaXRlbSkgewogICAgICAgICAgICByZXR1cm4gcmVzLmNvbmNhdChpdGVtIGluc3RhbmNlb2YgVGVzdFN1aXRlID8gaXRlbS5uZXN0ZWRUZXN0c18uZ2V0SXRlbXMoKSA6IGl0ZW0pOwogICAgICAgICAgfSwgW10pCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy50ZXN0QnlTdGF0ZV8gPSBuZXcgYmFzaXMuZGF0YS5kYXRhc2V0LlNwbGl0KHsKICAgICAgICAgIHNvdXJjZTogdGhpcy5uZXN0ZWRUZXN0c18sCiAgICAgICAgICBydWxlRXZlbnRzOiAic3RhdGVDaGFuZ2VkIiwKICAgICAgICAgIHJ1bGU6IGZ1bmN0aW9uKHRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5SRUFEWSAmJiB0ZXN0LnN0YXRlLmRhdGEuZGF0YS5wZW5kaW5nID8gInBlbmRpbmciIDogU3RyaW5nKHRlc3Quc3RhdGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMuc3RhdGVfID0gbmV3IGJhc2lzLmRhdGEudmFsdWUuRXhwcmVzc2lvbihiYXNpcy5kYXRhLlZhbHVlLmZyb20odGhpcy5uZXN0ZWRUZXN0c18sICJpdGVtc0NoYW5nZWQiLCAiaXRlbUNvdW50IiksIGJhc2lzLmRhdGEuVmFsdWUuZnJvbSh0aGlzLnRlc3RCeVN0YXRlXy5nZXRTdWJzZXQoInByb2Nlc3NpbmciLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgiZXJyb3IiLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgicmVhZHkiLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgicGVuZGluZyIsIHRydWUpLCAiaXRlbXNDaGFuZ2VkIiwgIml0ZW1Db3VudCIpLCBmdW5jdGlvbihjb3VudCwgcHJvY2Vzc2luZywgZXJyb3IsIHJlYWR5LCBwZW5kaW5nKSB7CiAgICAgICAgICBpZiAoIWNvdW50KSByZXR1cm4gWyBiYXNpcy5kYXRhLlNUQVRFLlJFQURZLCBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgcGVuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICB0ZXN0Q291bnQ6IGNvdW50LAogICAgICAgICAgICAgIHN1Y2Nlc3NDb3VudDogcmVhZHkKICAgICAgICAgICAgfQogICAgICAgICAgfSkgXTsKICAgICAgICAgIGlmIChwcm9jZXNzaW5nICsgZXJyb3IgKyByZWFkeSArIHBlbmRpbmcgPT0gMCkgcmV0dXJuIFsgYmFzaXMuZGF0YS5TVEFURS5VTkRFRklORUQgXTsKICAgICAgICAgIGlmIChwcm9jZXNzaW5nIHx8IGVycm9yICsgcmVhZHkgKyBwZW5kaW5nIDwgY291bnQpIHJldHVybiBbIGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORywgKGVycm9yICsgcmVhZHkpIC8gY291bnQgXTsKICAgICAgICAgIHJldHVybiBbIGVycm9yID8gYmFzaXMuZGF0YS5TVEFURS5FUlJPUiA6IGJhc2lzLmRhdGEuU1RBVEUuUkVBRFksIG5ldyBiYXNpcy5kYXRhLk9iamVjdCh7CiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBwZW5kaW5nID09IGNvdW50LAogICAgICAgICAgICAgIGVycm9yOiBlcnJvciA/IEVSUk9SX1RFU1RfRkFVTFQgOiBudWxsLAogICAgICAgICAgICAgIHRlc3RDb3VudDogY291bnQsCiAgICAgICAgICAgICAgc3VjY2Vzc0NvdW50OiByZWFkeSArIHBlbmRpbmcKICAgICAgICAgICAgfQogICAgICAgICAgfSkgXTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0YXRlXy5jaGFuZ2VXYXRjaGVyID0gdGhpcy5zdGF0ZV8uaGFuZGxlci5oYW5kbGVyLmNvbnRleHQudmFsdWU7CiAgICAgICAgdGhpcy5zdGF0ZV8ubGluayh0aGlzLCBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgICAgdGhpcy5zZXRTdGF0ZS5hcHBseSh0aGlzLCBzdGF0ZSk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRlc3QucHJvdG90eXBlLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zdGF0ZV8ubG9jaygpOwogICAgICAgIHRoaXMuY2hpbGROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHRlc3QpIHsKICAgICAgICAgIHRlc3QucmVzZXQoKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0YXRlXy51bmxvY2soKTsKICAgICAgICB0aGlzLnN0YXRlXy5jaGFuZ2VXYXRjaGVyLnVwZGF0ZSgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRlc3RCeVN0YXRlXy5kZXN0cm95KCk7CiAgICAgICAgdGhpcy50ZXN0QnlTdGF0ZV8gPSBudWxsOwogICAgICAgIHRoaXMubmVzdGVkVGVzdHNfLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLm5lc3RlZFRlc3RzXyA9IG51bGw7CiAgICAgICAgdGhpcy5zdGF0ZV8uZGVzdHJveSgpOwogICAgICAgIHRoaXMuc3RhdGVfID0gbnVsbDsKICAgICAgICBBYnN0cmFjdFRlc3QucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgQWJzdHJhY3RUZXN0OiBBYnN0cmFjdFRlc3QsCiAgICAgIFRlc3RDYXNlOiBUZXN0Q2FzZSwKICAgICAgVGVzdFN1aXRlOiBUZXN0U3VpdGUsCiAgICAgIG1hcDogdGVzdE1hcCwKICAgICAgY3JlYXRlOiBjcmVhdGVUZXN0RmFjdG9yeQogICAgfTsKICB9LAogICJwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIE9CSkVDVF9UT1NUUklORyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CiAgICB2YXIgRVJST1JfV1JPTkdfQU5TV0VSID0gIkVSUk9SX1dST05HX0FOU1dFUiI7CiAgICB2YXIgRVJST1JfVFlQRV9NSVNTTUFUQ0ggPSAiRVJST1JfVFlQRV9NSVNTTUFUQ0giOwogICAgZnVuY3Rpb24gc2xpY2VPd25Pbmx5KG9iaikgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VTdGF0aWNDb3B5KHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IGFycmF5RnJvbSh2YWx1ZSkgOiBzbGljZU93bk9ubHkodmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBmdW5jdGlvbiB2YWx1ZTJzdHJpbmcodmFsdWUsIGxpbmVhciwgZGVlcCkgewogICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICByZXR1cm4gIiciICsgdmFsdWUucmVwbGFjZSgvXCcvZywgIlxcJyIpICsgIiciOwogICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgIGlmICh2YWx1ZS5vcmlnaW5hbEZuXykgdmFsdWUgPSB2YWx1ZS5vcmlnaW5hbEZuXzsKICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgIHJldHVybiAhbGluZWFyID8gdmFsdWUgOiB2YWx1ZS5yZXBsYWNlKC9ceyhbXHJcbl18LikqXH0vLCAiey4ufSIpOwogICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiAibnVsbCI7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiAiWyIgKyB2YWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTJzdHJpbmcodmFsLCAhZGVlcCwgZGVlcCk7CiAgICAgICAgICB9KS5qb2luKCIsICIpICsgIl0iOwogICAgICAgICAgaWYgKE9CSkVDVF9UT1NUUklORy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgRGF0ZV0iIHx8IE9CSkVDVF9UT1NUUklORy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgUmVnRXhwXSIpIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBOdW1iZXIpIGRlYnVnZ2VyOwogICAgICAgICAgaWYgKCFsaW5lYXIpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIGlmICh2YWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXMucHVzaChrZXkgKyAiOiAiICsgdmFsdWUyc3RyaW5nKHZhbHVlW2tleV0sICFkZWVwLCBkZWVwKSk7CiAgICAgICAgICAgIGlmICghcmVzLmxlbmd0aCAmJiB2YWx1ZS52YWx1ZU9mKCkgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIG0gPSB2YWx1ZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpLm1hdGNoKC9mdW5jdGlvbiAoTnVtYmVyfFN0cmluZ3xCb29sZWFuKS8pOwogICAgICAgICAgICAgIGlmIChtKSByZXR1cm4gIm5ldyBPYmplY3QoIiArIHZhbHVlMnN0cmluZyh2YWx1ZS52YWx1ZU9mKCkpICsgIikiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAieyAiICsgKHJlcy5sZW5ndGggPyByZXMuam9pbigiLCAiKSArICIgIiA6ICIiKSArICJ9IjsKICAgICAgICAgIH0gZWxzZSByZXR1cm4gIntvYmplY3R9IjsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuICJ1bmtub3duIHR5cGUgYCIgKyB0eXBlb2YgdmFsdWUgKyAiYCI7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzVHJ1dGh5KHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlVmFsdWVzKGFjdHVhbCwgZXhwZWN0ZWQsIGRlZXApIHsKICAgICAgdmFyIGVycm9yOwogICAgICBpZiAoYWN0dWFsID09PSBleHBlY3RlZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIGFjdHVhbCAhPSB0eXBlb2YgZXhwZWN0ZWQpIHJldHVybiBFUlJPUl9UWVBFX01JU1NNQVRDSDsKICAgICAgaWYgKGFjdHVhbCAhPSBudWxsICYmIGV4cGVjdGVkICE9IG51bGwgJiYgYWN0dWFsLmNvbnN0cnVjdG9yICE9PSBleHBlY3RlZC5jb25zdHJ1Y3RvcikgcmV0dXJuIEVSUk9SX1RZUEVfTUlTU01BVENIOwogICAgICBpZiAoYWN0dWFsID09IGV4cGVjdGVkKSByZXR1cm47CiAgICAgIHN3aXRjaCAodHlwZW9mIGFjdHVhbCkgewogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgIGlmIChhY3R1YWwgIT09IGFjdHVhbCAmJiBleHBlY3RlZCAhPT0gZXhwZWN0ZWQpIHJldHVybjsKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKGV4cGVjdGVkLm9yaWdpbmFsRm5fKSBleHBlY3RlZCA9IGV4cGVjdGVkLm9yaWdpbmFsRm5fOwogICAgICAgICAgaWYgKGFjdHVhbC5vcmlnaW5hbEZuXykgYWN0dWFsID0gYWN0dWFsLm9yaWdpbmFsRm5fOwogICAgICAgICAgaWYgKFN0cmluZyhleHBlY3RlZCkgPT0gU3RyaW5nKGFjdHVhbCkpIHJldHVybjsKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmICghZXhwZWN0ZWQgJiYgYWN0dWFsIHx8IGV4cGVjdGVkICYmICFhY3R1YWwpIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgICBpZiAoU3RyaW5nKGV4cGVjdGVkKSAhPSBTdHJpbmcoYWN0dWFsKSkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgIGlmIChhY3R1YWwgJiYgImxlbmd0aCIgaW4gYWN0dWFsKSB7CiAgICAgICAgICAgIGlmIChhY3R1YWwubGVuZ3RoICE9IGV4cGVjdGVkLmxlbmd0aCkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY3R1YWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoYWN0dWFsW2ldICE9PSBleHBlY3RlZFtpXSkgewogICAgICAgICAgICAgICAgaWYgKGRlZXAgJiYgIWFjdHVhbC5fX2FudGlyZWN1cnNpb25fXykgewogICAgICAgICAgICAgICAgICBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX18gPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbXBhcmVWYWx1ZXMoYWN0dWFsW2ldLCBleHBlY3RlZFtpXSwgZGVlcCk7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX187CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuIGVycm9yOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBpIGluIGFjdHVhbCkgaWYgKGkgaW4gZXhwZWN0ZWQgPT0gZmFsc2UgfHwgYWN0dWFsW2ldICE9PSBleHBlY3RlZFtpXSkgewogICAgICAgICAgICAgIGlmIChkZWVwICYmIGkgaW4gZXhwZWN0ZWQgJiYgIWFjdHVhbC5fX2FudGlyZWN1cnNpb25fXykgewogICAgICAgICAgICAgICAgYWN0dWFsLl9fYW50aXJlY3Vyc2lvbl9fID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yID0gY29tcGFyZVZhbHVlcyhhY3R1YWxbaV0sIGV4cGVjdGVkW2ldLCBkZWVwKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX187CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiBlcnJvcjsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gRVJST1JfV1JPTkdfQU5TV0VSOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gZXhwZWN0ZWQpIGlmIChpIGluIGFjdHVhbCA9PSBmYWxzZSkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0Rm5JbmZvKHRlc3QpIHsKICAgICAgdmFyIGluZm8gPSBiYXNpcy51dGlscy5pbmZvLmZuKHRlc3QpOwogICAgICB2YXIgYXJncyA9IGluZm8uYXJncyA/IGluZm8uYXJncy5zcGxpdCgvXHMqLFxzKi8pIDogW107CiAgICAgIHZhciBjb2RlID0gaW5mby5ib2R5LnJlcGxhY2UoLyhbXHJcbl18XHMpKlwidXNlIHN0cmljdFwiOy8sICIiKS5yZXBsYWNlKC9cci9nLCAiIikucmVwbGFjZSgvXihccypcbikrfChcblxzKikqJC9nLCAiIik7CiAgICAgIHZhciBtaW5PZmZzZXQgPSBjb2RlLnNwbGl0KC9cbisvKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgIHJldHVybiBsaW5lLm1hdGNoKC9eKFxzKikvKVswXTsKICAgICAgfSkuc29ydCgpWzBdOwogICAgICByZXR1cm4gewogICAgICAgIGFyZ3M6IGFyZ3MsCiAgICAgICAgY29kZTogY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoIihefFxcbikiICsgbWluT2Zmc2V0LCAiZyIpLCAiJDEiKSB8fCAiLy8gbm8gc291cmNlIGNvZGUiCiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgc2xpY2VPd25Pbmx5OiBzbGljZU93bk9ubHksCiAgICAgIG1ha2VTdGF0aWNDb3B5OiBtYWtlU3RhdGljQ29weSwKICAgICAgdmFsdWUyc3RyaW5nOiB2YWx1ZTJzdHJpbmcsCiAgICAgIGNvbXBhcmVWYWx1ZXM6IGNvbXBhcmVWYWx1ZXMsCiAgICAgIGlzVHJ1dGh5OiBpc1RydXRoeSwKICAgICAgZ2V0Rm5JbmZvOiBnZXRGbkluZm8KICAgIH07CiAgfSwKICAiaS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgZnVuY3Rpb24gcmVzb2x2ZUdldHRlcihnZXR0ZXIpIHsKICAgICAgaWYgKGdldHRlci5iYXNpc0dldHRlcklkXyA+IDApIHsKICAgICAgICB2YXIgcmVzdWx0ID0gImdldHRlcigiOwogICAgICAgIGlmICh0eXBlb2YgZ2V0dGVyLmJhc2UgPT0gInN0cmluZyIpIHJlc3VsdCArPSAnIicgKyBnZXR0ZXIuYmFzZS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsgZWxzZSB7CiAgICAgICAgICBpZiAoIWdldHRlci5tb2QpIHJldHVybiByZXNvbHZlR2V0dGVyKGdldHRlci5iYXNlKTsgZWxzZSByZXN1bHQgKz0gcmVzb2x2ZUdldHRlcihnZXR0ZXIuYmFzZSk7CiAgICAgICAgfQogICAgICAgIGlmIChnZXR0ZXIubW9kKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGdldHRlci5tb2QgPT0gInN0cmluZyIpIHJlc3VsdCArPSAnLCAiJyArIGdldHRlci5tb2QucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7IGVsc2UgcmVzdWx0ICs9ICIsICIgKyByZXNvbHZlR2V0dGVyKGdldHRlci5tb2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0ICsgIikiOwogICAgICB9IGVsc2UgcmV0dXJuIEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGdldHRlcik7CiAgICB9CiAgICBmdW5jdGlvbiB0b2tlbml6ZUZ1bmN0aW9uU291cmNlKHNvdXJjZSkgewogICAgICB2YXIgY2hhcnMgPSBzb3VyY2Uuc3BsaXQoIiIpOwogICAgICB2YXIgcmVzID0gW107CiAgICAgIHZhciBsYXN0ID0gMDsKICAgICAgdmFyIGo7CiAgICAgIGZ1bmN0aW9uIHN0b3JlKHR5cGUsIHBvcykgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9IDIpIHBvcyA9IGk7CiAgICAgICAgaWYgKGxhc3QgIT0gcG9zKSB7CiAgICAgICAgICByZXMucHVzaChbIHR5cGUgfHwgImNvbnRlbnQiLCBzb3VyY2Uuc3Vic3RyaW5nKGxhc3QsIHBvcykgXSk7CiAgICAgICAgICBsYXN0ID0gcG9zOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYXJzLmxlbmd0aDsgaSsrKSBtYWluX2xvb3AgOiB7CiAgICAgICAgdmFyIGNoID0gY2hhcnNbaV07CiAgICAgICAgc3dpdGNoIChjaCkgewogICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgIHN0b3JlKCk7CiAgICAgICAgICAgIGogPSBpOwogICAgICAgICAgICBpZiAoY2hhcnNbaiArIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICBqID0gaiArIDI7CiAgICAgICAgICAgICAgd2hpbGUgKGogPCBjaGFycy5sZW5ndGggJiYgY2hhcnNbal0gIT09ICJcbiIgJiYgY2hhcnNbal0gIT09ICJcciIpIGorKzsKICAgICAgICAgICAgICBzdG9yZSgiY29tbWVudCIsIGopOwogICAgICAgICAgICAgIGkgPSBsYXN0IC0gMTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hhcnNbaiArIDFdID09ICIqIikgewogICAgICAgICAgICAgIGogPSBqICsgMjsKICAgICAgICAgICAgICB3aGlsZSAoaiA8IGNoYXJzLmxlbmd0aCAmJiAhKGNoYXJzW2pdID09PSAiKiIgJiYgY2hhcnNbaiArIDFdID09PSAiLyIpKSBqKys7CiAgICAgICAgICAgICAgc3RvcmUoImNvbW1lbnQiLCBqICsgMik7CiAgICAgICAgICAgICAgaSA9IGxhc3QgLSAxOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChqIDwgY2hhcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgIGlmIChjaGFyc1tqXSA9PSAiXG4iKSBicmVhayBtYWluX2xvb3A7CiAgICAgICAgICAgICAgaWYgKGNoYXJzW2pdID09ICJcXCIpIHsKICAgICAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGNoYXJzW2pdID09IGNoKSBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RvcmUoInJlZ2V4cCIsIGogKyAxKTsKICAgICAgICAgICAgaSA9IGxhc3QgLSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICAgIHN0b3JlKCk7CiAgICAgICAgICAgIGogPSBpOwogICAgICAgICAgICB3aGlsZSAoaiA8IGNoYXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgICBpZiAoY2hhcnNbal0gPT0gIlxcIikgewogICAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhcnNbal0gPT0gY2gpIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yZSgic3RyaW5nIiwgaiArIDEpOwogICAgICAgICAgICBpID0gbGFzdCAtIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiKCI6CiAgICAgICAgICBjYXNlICJ7IjoKICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgbGFzdCA9IGkgKyAxOwogICAgICAgICAgICByZXMucHVzaChbICJvcGVuIiwgY2ggXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiKSI6CiAgICAgICAgICBjYXNlICJ9IjoKICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgbGFzdCA9IGkgKyAxOwogICAgICAgICAgICByZXMucHVzaChbICJjbG9zZSIsIGNoIF0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGlmICgvXHMvLnRlc3QoY2gpKSB7CiAgICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgICBqID0gaSArIDE7CiAgICAgICAgICAgICAgd2hpbGUgKGogPCBjaGFycy5sZW5ndGggJiYgL1xzLy50ZXN0KGNoYXJzW2pdKSkgaisrOwogICAgICAgICAgICAgIHN0b3JlKCJzcGFjZSIsIGopOwogICAgICAgICAgICAgIGkgPSBsYXN0IC0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBzdG9yZSgpOwogICAgICByZXR1cm4gcmVzOwogICAgfQogICAgZnVuY3Rpb24gZnVuY3Rpb25JbmZvKGZuKSB7CiAgICAgIHZhciBnZXR0ZXIgPSByZXNvbHZlR2V0dGVyKGZuKTsKICAgICAgdmFyIHNvdXJjZSA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZuKTsKICAgICAgdmFyIHRva2VucyA9IHRva2VuaXplRnVuY3Rpb25Tb3VyY2Uoc291cmNlKTsKICAgICAgdmFyIG5hbWUgPSAiYW5vbnltb3VzIjsKICAgICAgdmFyIGFyZ3NDb250ZXh0ID0gZmFsc2U7CiAgICAgIHZhciB3YXNDb250ZW50ID0gdHJ1ZTsKICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgdmFyIHRva2VuOwogICAgICB3aGlsZSAodG9rZW4gPSB0b2tlbnMuc2hpZnQoKSkgewogICAgICAgIGlmICh0b2tlblsxXSA9PSAieyIpIGJyZWFrOwogICAgICAgIGlmICh0b2tlblswXSA9PSAiY29udGVudCIpIHsKICAgICAgICAgIHdhc0NvbnRlbnQgPSB0cnVlOwogICAgICAgICAgaWYgKGFyZ3NDb250ZXh0KSBhcmdzLnB1c2godG9rZW5bMV0pOyBlbHNlIHsKICAgICAgICAgICAgaWYgKHRva2VuWzFdICE9ICJmdW5jdGlvbiIpIG5hbWUgPSB0b2tlblsxXTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFhcmdzQ29udGV4dCkgYXJnc0NvbnRleHQgPSB3YXNDb250ZW50ICYmIHRva2VuWzFdID09ICIoIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKHRva2VuID0gdG9rZW5zLnBvcCgpKSBpZiAodG9rZW5bMV0gPT0gIn0iKSBicmVhazsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHRva2Vuc1tpXSA9IHRva2Vuc1tpXVsxXTsKICAgICAgYXJncyA9IGFyZ3Muam9pbigiIikudHJpbSgpLnJlcGxhY2UoL1xzKixccyovZywgIiwgIik7CiAgICAgIHJldHVybiB7CiAgICAgICAgc291cmNlOiBzb3VyY2UsCiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBmdWxsbmFtZTogbmFtZSArICIoIiArIGFyZ3MgKyAiKSIsCiAgICAgICAgYXJnczogYXJncywKICAgICAgICBib2R5OiB0b2tlbnMuam9pbigiIiksCiAgICAgICAgZ2V0dGVyOiBnZXR0ZXIgIT0gc291cmNlID8gZ2V0dGVyIDogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBmbjogZnVuY3Rpb25JbmZvCiAgICB9OwogIH0sCiAgIjEuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudCB8fCB7CiAgICAgIHRpdGxlOiAidW5rbm93biIKICAgIH07CiAgICB2YXIgYXBwVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKICAgIHZhciBhcHBJbml0ID0gYmFzaXMuZm4uJHVuZGVmOwogICAgdmFyIGFwcEluamVjdFBvaW50OwogICAgdmFyIGFwcEVsOwogICAgZnVuY3Rpb24gdXBkYXRlVGl0bGUodmFsdWUpIHsKICAgICAgZG9jdW1lbnQudGl0bGUgPSB2YWx1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc29sdmVOb2RlKHJlZikgewogICAgICByZXR1cm4gdHlwZW9mIHJlZiA9PSAic3RyaW5nIiA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJlZikgOiByZWY7CiAgICB9CiAgICBmdW5jdGlvbiByZXBsYWNlTm9kZShvbGRDaGlsZCwgbmV3Q2hpbGQpIHsKICAgICAgb2xkQ2hpbGQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Q2hpbGQsIG9sZENoaWxkKTsKICAgIH0KICAgIHZhciBjcmVhdGVBcHAgPSBiYXNpcy5mbi5sYXp5SW5pdChmdW5jdGlvbihjb25maWcpIHsKICAgICAgdmFyIHJlYWR5SGFuZGxlcnMgPSBbXTsKICAgICAgdmFyIGluaXRlZCA9IGZhbHNlOwogICAgICB2YXIgYXBwID0gewogICAgICAgIGluaXRlZDogZmFsc2UsCiAgICAgICAgc2V0VGl0bGU6IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICAgICAgICBpZiAodGl0bGUgIT0gYXBwVGl0bGUpIHsKICAgICAgICAgICAgaWYgKGFwcFRpdGxlIGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIGFwcFRpdGxlLmRldGFjaCh1cGRhdGVUaXRsZSk7CiAgICAgICAgICAgIGlmICh0aXRsZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSB7CiAgICAgICAgICAgICAgdGl0bGUuYXR0YWNoKHVwZGF0ZVRpdGxlKTsKICAgICAgICAgICAgICB1cGRhdGVUaXRsZSh0aXRsZS5nZXQoKSk7CiAgICAgICAgICAgIH0gZWxzZSB1cGRhdGVUaXRsZSh0aXRsZSk7CiAgICAgICAgICAgIGFwcFRpdGxlID0gdGl0bGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgdmFyIG5ld0FwcEVsID0gcmVzb2x2ZU5vZGUoZWwpOwogICAgICAgICAgaWYgKGFwcEVsID09IG5ld0FwcEVsKSByZXR1cm47CiAgICAgICAgICBpZiAoYXBwRWwpIHsKICAgICAgICAgICAgcmVwbGFjZU5vZGUoYXBwRWwsIG5ld0FwcEVsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIGFwcEVsID0gbmV3QXBwRWw7CiAgICAgICAgICBpZiAoIWFwcEluamVjdFBvaW50KSBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgdHlwZTogImFwcGVuZCIsCiAgICAgICAgICAgIG5vZGU6IGRvY3VtZW50LmJvZHkKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbm9kZSA9IHJlc29sdmVOb2RlKGFwcEluamVjdFBvaW50Lm5vZGUpOwogICAgICAgICAgaWYgKCFub2RlKSByZXR1cm47CiAgICAgICAgICBpZiAoYXBwSW5qZWN0UG9pbnQudHlwZSA9PSAiYXBwZW5kIikgbm9kZS5hcHBlbmRDaGlsZChhcHBFbCk7IGVsc2UgcmVwbGFjZU5vZGUobm9kZSwgYXBwRWwpOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoaW5pdGVkKSBmbi5jYWxsKGNvbnRleHQsIGFwcCk7IGVsc2UgcmVhZHlIYW5kbGVycy5wdXNoKHsKICAgICAgICAgICAgZm46IGZuLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGZvciAodmFyIGtleSBpbiBjb25maWcpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb25maWdba2V5XTsKICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgY2FzZSAidGl0bGUiOgogICAgICAgICAgICBhcHAuc2V0VGl0bGUodmFsdWUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImNvbnRhaW5lciI6CiAgICAgICAgICAgIGFwcEluamVjdFBvaW50ID0gewogICAgICAgICAgICAgIHR5cGU6ICJhcHBlbmQiLAogICAgICAgICAgICAgIG5vZGU6IHZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAicmVwbGFjZSI6CiAgICAgICAgICAgIGFwcEluamVjdFBvaW50ID0gewogICAgICAgICAgICAgIHR5cGU6ICJyZXBsYWNlIiwKICAgICAgICAgICAgICBub2RlOiB2YWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImVsZW1lbnQiOgogICAgICAgICAgICBhcHBFbCA9IHZhbHVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImluaXQiOgogICAgICAgICAgICBhcHBJbml0ID0gdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgPyB2YWx1ZSA6IGFwcEluaXQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gY29uZmlnIHByb3BlcnR5IGAiICsga2V5ICsgImAgZm9yIGFwcCwgdmFsdWU6IiwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5zZXJ0RWwgPSBhcHBFbDsKICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGFwcEluaXQuY2FsbChhcHApOwogICAgICAgIGlmIChpbml0UmVzdWx0KSB7CiAgICAgICAgICBpZiAoaW5pdFJlc3VsdC5lbGVtZW50KSBpbnNlcnRFbCA9IGluaXRSZXN1bHQuZWxlbWVudDsgZWxzZSBpbnNlcnRFbCA9IGluaXRSZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGFwcEVsID0gbnVsbDsKICAgICAgICBhcHAuc2V0RWxlbWVudChpbnNlcnRFbCk7CiAgICAgICAgaW5pdGVkID0gdHJ1ZTsKICAgICAgICBhcHAuaW5pdGVkID0gdHJ1ZTsKICAgICAgICB2YXIgaGFuZGxlcjsKICAgICAgICB3aGlsZSAoaGFuZGxlciA9IHJlYWR5SGFuZGxlcnMuc2hpZnQoKSkgaGFuZGxlci5mbi5jYWxsKGhhbmRsZXIuY29udGV4dCwgYXBwKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBhcHA7CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZUFwcAogICAgfTsKICB9LAogICJxLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgZnVuY3Rpb24gcnVuSW5Db250ZXh0KGNvbnRleHRXaW5kb3csIGNvZGUpIHsKICAgICAgKGNvbnRleHRXaW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihjb2RlKSB7CiAgICAgICAgY29udGV4dFdpbmRvd1siZXZhbCJdLmNhbGwoY29udGV4dFdpbmRvdywgY29kZSk7CiAgICAgIH0pKGNvZGUpOwogICAgfQogICAgdmFyIEZyYW1lRW52ID0gYmFzaXMudWkuTm9kZS5zdWJjbGFzcyh7CiAgICAgIGFwcGx5RW52aXJvbm1lbnQ6IG51bGwsCiAgICAgIGluaXRFbnY6IG51bGwsCiAgICAgIGh0bWw6IG51bGwsCiAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy51aS5Ob2RlLnByb3RvdHlwZS5wb3N0SW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLmRvYy5ib2R5LmFkZCh0aGlzLmVsZW1lbnQpOwogICAgICB9LAogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjMSIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgc3JjOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS5odG1sICYmIG5vZGUuaHRtbCAhPSAiZGVmYXVsdCIpIHJldHVybiBub2RlLmh0bWw7CiAgICAgICAgICByZXR1cm4gYmFzaXMucGF0aC5yZXNvbHZlKGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpLmJhc2VVUkkgfHwgIiIsICJyZXMvX09YY19ZQy1KTllrRDRDeTg5RUJDZy5odG1sIik7CiAgICAgICAgfQogICAgICB9LAogICAgICBhY3Rpb246IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZnJhbWVXaW5kb3cgPSB0aGlzLmVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgIHZhciBpbml0Q29kZSA9ICIiOwogICAgICAgICAgdmFyIGNvZGUgPSBiYXNpcy5yZXNvdXJjZSgiLi8wLmNvZGUiKS5mZXRjaCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBjb2RlID09ICJmdW5jdGlvbiIpIGNvZGUgPSBiYXNpcy51dGlscy5pbmZvLmZuKGNvZGUpLmJvZHk7CiAgICAgICAgICBydW5JbkNvbnRleHQoZnJhbWVXaW5kb3csIGNvZGUpOwogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmluaXRFbnYgPT0gImZ1bmN0aW9uIikgaW5pdENvZGUgPSBiYXNpcy51dGlscy5pbmZvLmZuKHRoaXMuaW5pdEVudikuYm9keTsKICAgICAgICAgIHRoaXMuYXBwbHlFbnZpcm9ubWVudCA9IGZyYW1lV2luZG93Ll9faW5pdFRlc3RFbnZpcm9ubWVudChpbml0Q29kZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICAgIGlmICh0aGlzLnJ1bkFyZ3MpIHsKICAgICAgICAgICAgdGhpcy5ydW4uYXBwbHkodGhpcywgdGhpcy5ydW5BcmdzKTsKICAgICAgICAgICAgdGhpcy5ydW5BcmdzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJ1bjogZnVuY3Rpb24oY29kZSwgY29udGV4dCwgcnVuVGVzdCkgewogICAgICAgIGlmICh0aGlzLmFwcGx5RW52aXJvbm1lbnQpIHJ1blRlc3QuY2FsbChjb250ZXh0LCB0aGlzLmFwcGx5RW52aXJvbm1lbnQoY29kZSkpOyBlbHNlIHRoaXMucnVuQXJncyA9IGFyZ3VtZW50czsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMudWkuTm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYXBwbHlFbnZpcm9ubWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5ydW5BcmdzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IEZyYW1lRW52OwogIH0sCiAgIjAuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgcnVubmVyID0gYmFzaXMucmVxdWlyZSgiLi9jLmpzIik7CiAgICB2YXIgdG9jID0gYmFzaXMucmVxdWlyZSgiLi9yLmpzIik7CiAgICB2YXIgdGVzdERldGFpbHMgPSBiYXNpcy5yZXF1aXJlKCIuL3MuanMiKTsKICAgIHZhciByb290VGVzdFN1aXRlID0gbmV3IGJhc2lzLmRhdGEuT2JqZWN0KHsKICAgICAgZ2V0Q2hpbGROb2Rlc0RhdGFzZXQ6IGZ1bmN0aW9uKCkge30KICAgIH0pOwogICAgZnVuY3Rpb24gZmluZFRlc3QodGVzdCwgZmlsZW5hbWUpIHsKICAgICAgaWYgKHRlc3QuZGF0YS5maWxlbmFtZV8gPT09IGZpbGVuYW1lKSByZXR1cm4gdGVzdDsKICAgICAgaWYgKHRlc3QuY2hpbGROb2RlcykgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IHRlc3QuY2hpbGROb2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgdmFyIHJlcyA9IGZpbmRUZXN0KGNoaWxkLCBmaWxlbmFtZSk7CiAgICAgICAgaWYgKHJlcykgcmV0dXJuIHJlczsKICAgICAgfQogICAgfQogICAgdG9jLmFkZEhhbmRsZXIoewogICAgICBkZWxlZ2F0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlICghY3Vyc29yLmRhdGEuZmlsZW5hbWVfICYmIGN1cnNvci5yb290LnBhcmVudE5vZGUpIGN1cnNvciA9IGN1cnNvci5yb290LnBhcmVudE5vZGU7CiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICIjIiArIChjdXJzb3Iucm9vdC5wYXJlbnROb2RlICYmIGN1cnNvci5kYXRhLmZpbGVuYW1lXyA/IGN1cnNvci5kYXRhLmZpbGVuYW1lXyA6ICIiKTsKICAgICAgfSwKICAgICAgY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbigpIHsKICAgICAgICBydW5uZXIubG9hZFRlc3RzKHRoaXMuY2hpbGROb2Rlcy5zbGljZSgwKSk7CiAgICAgIH0KICAgIH0pOwogICAgdG9jLnNlbGVjdGlvbi5hZGRIYW5kbGVyKHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICB0aGlzLnNldERlbGVnYXRlKHNlbGVjdGlvbi5waWNrKCkpOwogICAgICB9CiAgICB9LCB0ZXN0RGV0YWlscyk7CiAgICB0ZXN0RGV0YWlscy5zZWxlY3Rpb24uYWRkSGFuZGxlcih7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oc2VsZWN0aW9uKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0aW9uLnBpY2soKTsKICAgICAgICBpZiAoc2VsZWN0ZWQpIHRoaXMuc2V0RGVsZWdhdGUoc2VsZWN0ZWQucm9vdCk7CiAgICAgIH0KICAgIH0sIHRvYyk7CiAgICB2YXIgdmlldyA9IG5ldyBiYXNpcy51aS5Ob2RlKHsKICAgICAgdGVtcGxhdGU6IGJhc2lzLnRlbXBsYXRlLmdldCgiIzkiKSwKICAgICAgYWN0aW9uOiB7CiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdG9jLnNldERlbGVnYXRlKHJvb3RUZXN0U3VpdGUpOwogICAgICAgIH0sCiAgICAgICAgcnVuOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJ1bm5lci5ydW4oKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICB0b2M6IHRvYywKICAgICAgICB0ZXN0czogdGVzdERldGFpbHMsCiAgICAgICAgbmFtZTogYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHJvb3RUZXN0U3VpdGUsICJ1cGRhdGUiLCAiZGF0YS5uYW1lIiksCiAgICAgICAgdGltZTogcnVubmVyLnRpbWUsCiAgICAgICAgdG90YWw6IHJ1bm5lci5jb3VudC50b3RhbCwKICAgICAgICBhc3NlcnQ6IHJ1bm5lci5jb3VudC5hc3NlcnQsCiAgICAgICAgbGVmdDogcnVubmVyLmNvdW50LmxlZnQsCiAgICAgICAgZG9uZTogcnVubmVyLmNvdW50LmRvbmUKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgbG9hZFRlc3RzOiBmdW5jdGlvbihkYXRhLCByZWZlcmVuY2UpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IHsKICAgICAgICAgIHRlc3Q6IGRhdGEKICAgICAgICB9OwogICAgICAgIHZhciByb290VGVzdCA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpLmNyZWF0ZShkYXRhKTsKICAgICAgICB2YXIgbWFya2VyID0gbG9jYXRpb24uaGFzaC5zdWJzdHIoMSk7CiAgICAgICAgdmFyIHRlc3RCeUZpbGVuYW1lOwogICAgICAgIGlmIChtYXJrZXIpIHRlc3RCeUZpbGVuYW1lID0gZmluZFRlc3Qocm9vdFRlc3QsIG1hcmtlcik7CiAgICAgICAgdG9jLnNldERlbGVnYXRlKHRlc3RCeUZpbGVuYW1lIHx8IHJvb3RUZXN0U3VpdGUpOwogICAgICAgIHJvb3RUZXN0U3VpdGUuc2V0RGVsZWdhdGUocm9vdFRlc3QpOwogICAgICB9CiAgICB9OwogICAgaWYgKGJhc2lzLmNvbmZpZy5leHBvcnRzKSB7CiAgICAgIGdsb2JhbC5iYXNpc2pzVGVzdFJ1bm5lciA9IGJhc2lzLm9iamVjdC5leHRlbmQobW9kdWxlLmV4cG9ydHMsIHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbmZpZ1trZXldOwogICAgICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgICAgIGNhc2UgImVsZW1lbnQiOgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh2aWV3LmVsZW1lbnQpOwogICAgICAgICAgICAgICAgfS5iaW5kKHZhbHVlKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJiYXNlVVJJIjoKICAgICAgICAgICAgICAgIGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpLmJhc2VVUkkgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBydW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgcnVubmVyLnJ1bigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kb2MuYm9keS5hZGQodmlldy5lbGVtZW50KTsKICAgICAgfSk7CiAgICB9CiAgfSwKICAiMi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi83LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBIdG1sVGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5odG1sLlRlbXBsYXRlOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIERXTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLk5vZGU7CiAgICB2YXIgRFdQYXJ0aXRpb25Ob2RlID0gYmFzaXMuZG9tLndyYXBwZXIuUGFydGl0aW9uTm9kZTsKICAgIHZhciBEV0dyb3VwaW5nTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZTsKICAgIHZhciBiaW5kaW5nU2VlZCA9IDE7CiAgICB2YXIgdW5rbm93bkV2ZW50QmluZGluZ0NoZWNrID0ge307CiAgICBmdW5jdGlvbiBleHRlbmRCaW5kaW5nKGJpbmRpbmcsIGV4dGVuc2lvbikgewogICAgICBiaW5kaW5nLmJpbmRpbmdJZCA9IGJpbmRpbmdTZWVkKys7CiAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICB2YXIgZGVmID0gbnVsbDsKICAgICAgICB2YXIgdmFsdWUgPSBleHRlbnNpb25ba2V5XTsKICAgICAgICBpZiAoTm9kZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIE5vZGUgfHwgYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZSh2YWx1ZSkpIHsKICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24oa2V5LCBzYXRlbGxpdGUpIHsKICAgICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSB0eXBlb2Ygc2F0ZWxsaXRlID09ICJmdW5jdGlvbiIgPyBzYXRlbGxpdGUgOiBudWxsOwogICAgICAgICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaW5pdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgIHNhdGVsbGl0ZSA9IHJlc291cmNlKCk7CiAgICAgICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBOb2RlID09IGZhbHNlKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0U2F0ZWxsaXRlKGtleSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNhdGVsbGl0ZVtrZXldICE9PSBzYXRlbGxpdGUpIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aS5iaW5kaW5nOiBpbXBsaWNpdCBzYXRlbGxpdGUgYCIgKyBrZXkgKyAiYCBhdHRhY2ggdG8gb3duZXIgZmFpbGVkIik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluaXQpIGluaXQobm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2UgfHwgKG5vZGUuc2F0ZWxsaXRlW2tleV0gPyBub2RlLnNhdGVsbGl0ZVtrZXldLmVsZW1lbnQgOiBudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KGtleSwgdmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBCSU5ESU5HX1BSRVNFVC5wcm9jZXNzKGtleSwgdmFsdWUpOyBlbHNlIGlmICh2YWx1ZS5iaW5kaW5nQnJpZGdlKSB2YWx1ZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBkZWYgPSB7CiAgICAgICAgICAgICAgICBnZXR0ZXI6IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBiYXNpcy5nZXR0ZXIodmFsdWUpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWVbMF0sCiAgICAgICAgICAgICAgICBnZXR0ZXI6IGJhc2lzLmdldHRlcih2YWx1ZVsxXSkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWUuZXZlbnRzLAogICAgICAgICAgICAgICAgZ2V0dGVyOiBiYXNpcy5nZXR0ZXIodmFsdWUuZ2V0dGVyKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmluZGluZ1trZXldID0gZGVmOwogICAgICB9CiAgICB9CiAgICB2YXIgQklORElOR19QUkVTRVQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByZXNldHMgPSB7fTsKICAgICAgdmFyIHByZWZpeFJlZ0V4cCA9IC9eKFthLXpfXVthLXowLTlfXSopOiguKikvaTsKICAgICAgcmV0dXJuIHsKICAgICAgICBhZGQ6IGZ1bmN0aW9uKHByZWZpeCwgZnVuYykgewogICAgICAgICAgaWYgKCFwcmVzZXRzW3ByZWZpeF0pIHsKICAgICAgICAgICAgcHJlc2V0c1twcmVmaXhdID0gZnVuYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJQcmVzZXQgYCIgKyBwcmVmaXggKyAiYCBhbHJlYWR5IGV4aXN0cywgbmV3IGRlZmluaXRpb24gaWdub3JlZCIpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgdmFyIHByZXNldDsKICAgICAgICAgIHZhciBtID0gdmFsdWUubWF0Y2gocHJlZml4UmVnRXhwKTsKICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHByZXNldCA9IHByZXNldHNbbVsxXV07CiAgICAgICAgICAgIHZhbHVlID0gbVsyXSB8fCBrZXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJlc2V0ID8gcHJlc2V0KHZhbHVlKSA6IHZhbHVlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIEJJTkRJTkdfUFJFU0VULmFkZCgiZGF0YSIsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBldmVudHM6ICJ1cGRhdGUiLAogICAgICAgIGdldHRlcjogImRhdGEuIiArIHBhdGgKICAgICAgfTsKICAgIH0pOwogICAgQklORElOR19QUkVTRVQuYWRkKCJzYXRlbGxpdGUiLCBmdW5jdGlvbihzYXRlbGxpdGVOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zYXRlbGxpdGVbc2F0ZWxsaXRlTmFtZV0gPyBub2RlLnNhdGVsbGl0ZVtzYXRlbGxpdGVOYW1lXS5lbGVtZW50IDogbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIHZhciBURU1QTEFURV9CSU5ESU5HID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoewogICAgICBzdGF0ZTogewogICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiB7CiAgICAgICAgZXZlbnRzOiAiY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuY2hpbGROb2Rlc1N0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ291bnQ6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuY2hpbGROb2RlcyA/IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggOiAwOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzQ2hpbGRyZW46IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZS5maXJzdENoaWxkOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1wdHk6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICFub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBleHRlbmRCaW5kaW5nKTsKICAgIHZhciBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSA9IHsKICAgICAgYXR0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURV9BQ1RJT04gPSBDbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoewogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKHRoaXMuaXNEaXNhYmxlZCgpKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuY29udGV4dFNlbGVjdGlvbiAmJiB0aGlzLmNvbnRleHRTZWxlY3Rpb24ubXVsdGlwbGUpIHRoaXMuc2VsZWN0KGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSk7IGVsc2UgdGhpcy5zZWxlY3QoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiA9IHsKICAgICAgIioiOiBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgaWYgKHN3aXRjaGVyICYmIHN3aXRjaGVyLnJ1bGVFdmVudHMgJiYgc3dpdGNoZXIucnVsZUV2ZW50c1tldmVudC50eXBlXSkgdGhpcy5zZXRUZW1wbGF0ZShzd2l0Y2hlci5yZXNvbHZlKHRoaXMpKTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURSA9IG5ldyBIdG1sVGVtcGxhdGUoIjxkaXYvPiIpOwogICAgdmFyIGZyYWdtZW50cyA9IFtdOwogICAgZnVuY3Rpb24gZ2V0RG9jdW1lbnRGcmFnbWVudCgpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50cy5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICB9CiAgICBmdW5jdGlvbiByZWluc2VydFBhcnRpdGlvbk5vZGVzKHBhcnRpdGlvbikgewogICAgICB2YXIgbm9kZXMgPSBwYXJ0aXRpb24ubm9kZXM7CiAgICAgIGlmIChub2RlcykgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDEsIGNoaWxkOyBjaGlsZCA9IG5vZGVzW2ldOyBpLS0pIGNoaWxkLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICB9CiAgICB2YXIgZm9jdXNUaW1lcjsKICAgIHZhciBUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGVtcGxhdGU6IFRFTVBMQVRFLAogICAgICAgIGVtaXRfdGVtcGxhdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgidGVtcGxhdGVDaGFuZ2VkIiksCiAgICAgICAgdGVtcGxhdGVTd2l0Y2hlcl86IG51bGwsCiAgICAgICAgYmluZGluZzogVEVNUExBVEVfQklORElORywKICAgICAgICBhY3Rpb246IFRFTVBMQVRFX0FDVElPTiwKICAgICAgICB0bXBsOiBudWxsLAogICAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgICAgZW1pdF91cGRhdGU6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlVXBkYXRlKHRoaXMudG1wbCwgInVwZGF0ZSIsIGRlbHRhKTsKICAgICAgICAgIHN1cGVyXy5lbWl0X3VwZGF0ZS5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB9LAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5lbGVtZW50ID0gdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IGdldERvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgIHN1cGVyXy5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgfSwKICAgICAgICBwb3N0SW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzdXBlcl8ucG9zdEluaXQuY2FsbCh0aGlzKTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIG5vZGVEb2N1bWVudEZyYWdtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgICB2YXIgYmluZGluZ0lkID0gdGhpcy5jb25zdHJ1Y3Rvci5iYXNpc0NsYXNzSWRfICsgIl8iICsgdGhpcy5iaW5kaW5nLmJpbmRpbmdJZDsKICAgICAgICAgICAgaWYgKGJpbmRpbmdJZCBpbiB1bmtub3duRXZlbnRCaW5kaW5nQ2hlY2sgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICB1bmtub3duRXZlbnRCaW5kaW5nQ2hlY2tbYmluZGluZ0lkXSA9IHRydWU7CiAgICAgICAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gdGhpcy5iaW5kaW5nKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5iaW5kaW5nW2JpbmROYW1lXSAmJiB0aGlzLmJpbmRpbmdbYmluZE5hbWVdLmV2ZW50czsKICAgICAgICAgICAgICAgIGlmIChldmVudHMpIHsKICAgICAgICAgICAgICAgICAgZXZlbnRzID0gU3RyaW5nKGV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKCJlbWl0XyIgKyBldmVudE5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBiaW5kaW5nIGAiICsgYmluZE5hbWUgKyAiYCBoYXMgdW5rbm93biBldmVudCBgIiArIGV2ZW50TmFtZSArICJgIGZvciAiICsgdGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgIGZyYWdtZW50cy5wdXNoKG5vZGVEb2N1bWVudEZyYWdtZW50KTsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50KTsKICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHRlbXBsYXRlU3luYzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgb2xkRWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgIHZhciB0bXBsID0gdGhpcy50ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZSh0aGlzLCB0aGlzLnRlbXBsYXRlQWN0aW9uLCB0aGlzLnRlbXBsYXRlU3luYywgdGhpcy5iaW5kaW5nLCBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSk7CiAgICAgICAgICB2YXIgbm9DaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIGlmICh0bXBsLmNoaWxkTm9kZXNIZXJlKSB7CiAgICAgICAgICAgIHRtcGwuY2hpbGROb2Rlc0VsZW1lbnQgPSB0bXBsLmNoaWxkTm9kZXNIZXJlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHRtcGwuY2hpbGROb2Rlc0VsZW1lbnQuaW5zZXJ0UG9pbnQgPSB0bXBsLmNoaWxkTm9kZXNIZXJlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy50bXBsID0gdG1wbDsKICAgICAgICAgIHRoaXMuZWxlbWVudCA9IHRtcGwuZWxlbWVudDsKICAgICAgICAgIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSB0bXBsLmNoaWxkTm9kZXNFbGVtZW50IHx8IHRtcGwuZWxlbWVudDsKICAgICAgICAgIG5vQ2hpbGROb2Rlc0VsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50Lm5vZGVUeXBlICE9IDE7CiAgICAgICAgICBpZiAobm9DaGlsZE5vZGVzRWxlbWVudCkgdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgIGlmIChub0NoaWxkTm9kZXNFbGVtZW50KSB0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfID0gdHJ1ZTsgZWxzZSBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICAgIHRoaXMuZ3JvdXBpbmcuc3luY0RvbVJlZnMoKTsKICAgICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChjdXJzb3IuZ3JvdXBpbmcpIGN1cnNvciA9IGN1cnNvci5ncm91cGluZzsKICAgICAgICAgICAgdmFyIHRvcEdyb3VwaW5nID0gY3Vyc29yOwogICAgICAgICAgICBmb3IgKHZhciBncm91cE5vZGUgPSB0b3BHcm91cGluZy5sYXN0Q2hpbGQ7IGdyb3VwTm9kZTsgZ3JvdXBOb2RlID0gZ3JvdXBOb2RlLnByZXZpb3VzU2libGluZykgewogICAgICAgICAgICAgIGlmIChncm91cE5vZGUgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSB0b3BHcm91cGluZy5pbnNlcnRCZWZvcmUoZ3JvdXBOb2RlLCBncm91cE5vZGUubmV4dFNpYmxpbmcpOyBlbHNlIHJlaW5zZXJ0UGFydGl0aW9uTm9kZXMoZ3JvdXBOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWluc2VydFBhcnRpdGlvbk5vZGVzKHRvcEdyb3VwaW5nLm51bGxHcm91cCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBjaGlsZCA9IHRoaXMubGFzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5wcmV2aW91c1NpYmxpbmcpIHRoaXMuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIFBhcnRpdGlvbk5vZGUpIHJlaW5zZXJ0UGFydGl0aW9uTm9kZXModGhpcyk7CiAgICAgICAgICBpZiAodGhpcy5jb250ZW50KSAodG1wbC5jb250ZW50IHx8IHRtcGwuZWxlbWVudCkuYXBwZW5kQ2hpbGQodGhpcy5jb250ZW50Lm5vZGVUeXBlID8gdGhpcy5jb250ZW50IDogZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGhpcy5jb250ZW50KSk7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlVXBkYXRlKHRoaXMudG1wbCk7CiAgICAgICAgICBpZiAob2xkRWxlbWVudCAmJiBvbGRFbGVtZW50ICE9PSB0aGlzLmVsZW1lbnQgJiYgb2xkRWxlbWVudC5ub2RlVHlwZSAhPSAxMSkgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG9sZEVsZW1lbnQgJiYgb2xkRWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmICh0aGlzLm93bmVyICYmIHRoaXMub3duZXIudG1wbCkgdGhpcy5vd25lci50bXBsLnNldChvbGRFbGVtZW50LCB0aGlzLmVsZW1lbnQpOwogICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQucGFyZW50Tm9kZSAhPT0gcGFyZW50Tm9kZSkgcGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy5lbGVtZW50LCBvbGRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3RlbXBsYXRlQ2hhbmdlZCgpOwogICAgICAgIH0sCiAgICAgICAgc2V0VGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICB2YXIgY3VyU3dpdGNoZXIgPSB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfOwogICAgICAgICAgdmFyIHN3aXRjaGVyOwogICAgICAgICAgaWYgKHRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hlcikgewogICAgICAgICAgICBzd2l0Y2hlciA9IHRlbXBsYXRlOwogICAgICAgICAgICB0ZW1wbGF0ZSA9IHN3aXRjaGVyLnJlc29sdmUodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGVtcGxhdGUgaW5zdGFuY2VvZiBIdG1sVGVtcGxhdGUgPT0gZmFsc2UpIHRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpLk5vZGUjc2V0VGVtcGxhdGU6IHNldCBudWxsIHRvIHRlbXBsYXRlIHBvc3NpYmxlIG9ubHkgb24gbm9kZSBkZXN0cm95Iik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzd2l0Y2hlcikgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gc3dpdGNoZXI7CiAgICAgICAgICAgIGlmICghY3VyU3dpdGNoZXIpIHRoaXMuYWRkSGFuZGxlcihURU1QTEFURV9TV0lUQ0hFUl9IQU5ETEVSLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJTd2l0Y2hlciAmJiBjdXJTd2l0Y2hlci5yZXNvbHZlKHRoaXMpICE9PSB0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMudGVtcGxhdGUgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZVN5bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVwZGF0ZUJpbmQ6IGZ1bmN0aW9uKGJpbmROYW1lKSB7CiAgICAgICAgICB2YXIgYmluZGluZyA9IHRoaXMuYmluZGluZ1tiaW5kTmFtZV07CiAgICAgICAgICB2YXIgZ2V0dGVyID0gYmluZGluZyAmJiBiaW5kaW5nLmdldHRlcjsKICAgICAgICAgIGlmIChnZXR0ZXIgJiYgdGhpcy50bXBsKSB0aGlzLnRtcGwuc2V0KGJpbmROYW1lLCBnZXR0ZXIodGhpcykpOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVBY3Rpb246IGZ1bmN0aW9uKGFjdGlvbk5hbWUsIGV2ZW50KSB7CiAgICAgICAgICB2YXIgYWN0aW9uID0gdGhpcy5hY3Rpb25bYWN0aW9uTmFtZV07CiAgICAgICAgICBpZiAoYWN0aW9uKSBhY3Rpb24uY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgICBpZiAoIWFjdGlvbikgYmFzaXMuZGV2Lndhcm4oInRlbXBsYXRlIGNhbGwgYCIgKyBhY3Rpb25OYW1lICsgImAgYWN0aW9uLCBidXQgaXQgaXNuJ3QgZGVmaW5lZCBpbiBhY3Rpb24gbGlzdCIpOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVVcGRhdGU6IGZ1bmN0aW9uKHRtcGwsIGV2ZW50TmFtZSwgZGVsdGEpIHt9LAogICAgICAgIGZvY3VzOiBmdW5jdGlvbihzZWxlY3QpIHsKICAgICAgICAgIHZhciBmb2N1c0VsZW1lbnQgPSB0aGlzLnRtcGwgPyB0aGlzLnRtcGwuZm9jdXMgfHwgdGhpcy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIGlmIChmb2N1c0VsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGZvY3VzVGltZXIpIGZvY3VzVGltZXIgPSBiYXNpcy5jbGVhckltbWVkaWF0ZShmb2N1c1RpbWVyKTsKICAgICAgICAgICAgZm9jdXNUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9jdXNFbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0KSBmb2N1c0VsZW1lbnQuc2VsZWN0KCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBibHVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c0VsZW1lbnQgPSB0aGlzLnRtcGwgPyB0aGlzLnRtcGwuZm9jdXMgfHwgdGhpcy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIGlmIChmb2N1c0VsZW1lbnQpIHRyeSB7CiAgICAgICAgICAgIGZvY3VzRWxlbWVudC5ibHVyKCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlOwogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICBpZiAodGhpcy50ZW1wbGF0ZVN3aXRjaGVyXykgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGVtcGxhdGUuY2xlYXJJbnN0YW5jZSh0aGlzLnRtcGwpOwogICAgICAgICAgc3VwZXJfLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICAgIHRoaXMudG1wbCA9IG51bGw7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgICAgdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKHBhcmVudE5vZGUgJiYgcGFyZW50Tm9kZS5ub2RlVHlwZSA9PSAxKSBwYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgICB2YXIgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiA9IGZ1bmN0aW9uKHN1cGVyXykgewogICAgICByZXR1cm4gewogICAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XykgewogICAgICAgICAgICBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBUZW1wbGF0ZSBoYXMgbm8gY2hpbGROb2Rlc0VsZW1lbnQgY29udGFpbmVyLCBidXQgaW5zZXJ0QmVmb3JlIG1ldGhvZCBjYWxsZWQ7IHByb2JhYmx5IGl0J3MgYSBidWciKTsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NoaWxkID0gc3VwZXJfLmluc2VydEJlZm9yZS5jYWxsKHRoaXMsIG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmV3Q2hpbGQuZ3JvdXBOb2RlIHx8IHRoaXM7CiAgICAgICAgICB2YXIgY29udGFpbmVyID0gdGFyZ2V0LmNoaWxkTm9kZXNFbGVtZW50IHx8IHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBuZXdDaGlsZC5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBpbnNlcnRQb2ludCA9IG5leHRTaWJsaW5nICYmIG5leHRTaWJsaW5nLmVsZW1lbnQucGFyZW50Tm9kZSA9PSBjb250YWluZXIgPyBuZXh0U2libGluZy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIHZhciBjaGlsZEVsZW1lbnQgPSBuZXdDaGlsZC5lbGVtZW50OwogICAgICAgICAgdmFyIHJlZk5vZGUgPSBpbnNlcnRQb2ludCB8fCBjb250YWluZXIuaW5zZXJ0UG9pbnQgfHwgbnVsbDsKICAgICAgICAgIGlmIChjaGlsZEVsZW1lbnQucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyIHx8IGNoaWxkRWxlbWVudC5uZXh0U2libGluZyAhPT0gcmVmTm9kZSkgY29udGFpbmVyLmluc2VydEJlZm9yZShjaGlsZEVsZW1lbnQsIHJlZk5vZGUpOwogICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgICBzdXBlcl8ucmVtb3ZlQ2hpbGQuY2FsbCh0aGlzLCBvbGRDaGlsZCk7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IG9sZENoaWxkLmVsZW1lbnQ7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG9sZENoaWxkOwogICAgICAgIH0sCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgICBpZiAoYWxpdmUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBub2RlLmVsZW1lbnQ7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1cGVyXy5jbGVhci5jYWxsKHRoaXMsIGFsaXZlKTsKICAgICAgICB9LAogICAgICAgIHNldENoaWxkTm9kZXM6IGZ1bmN0aW9uKGNoaWxkTm9kZXMsIGtlZXBBbGl2ZSkgewogICAgICAgICAgaWYgKHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF8pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF87CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aTogVGVtcGxhdGUgaGFzIG5vIGNoaWxkTm9kZXNFbGVtZW50IGNvbnRhaW5lciwgYnV0IHNldENoaWxkTm9kZXMgbWV0aG9kIGNhbGxlZDsgcHJvYmFibHkgaXQncyBhIGJ1ZyIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuZ3JvdXBpbmcgfHwgdGhpczsKICAgICAgICAgIHZhciBjb250YWluZXIgPSB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb21GcmFnbWVudDsKICAgICAgICAgIHN1cGVyXy5zZXRDaGlsZE5vZGVzLmNhbGwodGhpcywgY2hpbGROb2Rlcywga2VlcEFsaXZlKTsKICAgICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoZG9tRnJhZ21lbnQsIGNvbnRhaW5lci5pbnNlcnRQb2ludCB8fCBudWxsKTsKICAgICAgICAgIHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudCA9IGNvbnRhaW5lcjsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwogICAgdmFyIFBhcnRpdGlvbk5vZGUgPSBDbGFzcyhEV1BhcnRpdGlvbk5vZGUsIFRlbXBsYXRlTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlBhcnRpdGlvbk5vZGUiLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgdGl0bGU6ICJkYXRhOiIKICAgICAgfQogICAgfSk7CiAgICB2YXIgR3JvdXBpbmdOb2RlID0gQ2xhc3MoRFdHcm91cGluZ05vZGUsIENvbnRhaW5lclRlbXBsYXRlTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkdyb3VwaW5nTm9kZSIsCiAgICAgIGNoaWxkQ2xhc3M6IFBhcnRpdGlvbk5vZGUsCiAgICAgIGdyb3VwaW5nQ2xhc3M6IENsYXNzLlNFTEYsCiAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgIGNoaWxkTm9kZXNFbGVtZW50OiBudWxsLAogICAgICBlbWl0X293bmVyQ2hhbmdlZDogZnVuY3Rpb24ob2xkT3duZXIpIHsKICAgICAgICB0aGlzLnN5bmNEb21SZWZzKCk7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmVtaXRfb3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgIERXR3JvdXBpbmdOb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHN5bmNEb21SZWZzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIHZhciBlbGVtZW50ID0gbnVsbDsKICAgICAgICBpZiAob3duZXIpIGVsZW1lbnQgPSBvd25lci50bXBsICYmIG93bmVyLnRtcGwuZ3JvdXBzRWxlbWVudCB8fCBvd25lci5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICBkbyB7CiAgICAgICAgICBjdXJzb3IuZWxlbWVudCA9IGN1cnNvci5jaGlsZE5vZGVzRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgfSB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmdyb3VwaW5nKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBOb2RlID0gQ2xhc3MoRFdOb2RlLCBUZW1wbGF0ZU1peGluLCBDb250YWluZXJUZW1wbGF0ZU1peGluLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ob2RlIiwKICAgICAgYmluZGluZzogewogICAgICAgIHNlbGVjdGVkOiB7CiAgICAgICAgICBldmVudHM6ICJzZWxlY3QgdW5zZWxlY3QiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLnNlbGVjdGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdW5zZWxlY3RlZDogewogICAgICAgICAgZXZlbnRzOiAic2VsZWN0IHVuc2VsZWN0IiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gIW5vZGUuc2VsZWN0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkaXNhYmxlZDogewogICAgICAgICAgZXZlbnRzOiAiZGlzYWJsZSBlbmFibGUiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLmRpc2FibGVkIHx8IG5vZGUuY29udGV4dERpc2FibGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZW5hYmxlZDogewogICAgICAgICAgZXZlbnRzOiAiZGlzYWJsZSBlbmFibGUiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiAhKG5vZGUuZGlzYWJsZWQgfHwgbm9kZS5jb250ZXh0RGlzYWJsZWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogQ2xhc3MuU0VMRiwKICAgICAgY2hpbGRGYWN0b3J5OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuY2hpbGRDbGFzcyhjb25maWcpOwogICAgICB9LAogICAgICBncm91cGluZ0NsYXNzOiBHcm91cGluZ05vZGUKICAgIH0pOwogICAgdmFyIFNoYWRvd05vZGVMaXN0ID0gTm9kZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TaGFkb3dOb2RlTGlzdCIsCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIE5vZGUucHJvdG90eXBlLmVtaXRfb3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSh0aGlzLm93bmVyICYmIHRoaXMub3duZXIuZ2V0Q2hpbGROb2Rlc0RhdGFzZXQoKSk7CiAgICAgIH0sCiAgICAgIGdldENoaWxkTm9kZXNFbGVtZW50OiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgfSwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgb3duZXI6IHsKICAgICAgICAgIHRlbXBsYXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZChjaGlsZC5lbGVtZW50KTsKICAgICAgICAgICAgfSwgdGhpcy5nZXRDaGlsZE5vZGVzRWxlbWVudCh0aGlzLm93bmVyKSB8fCB0aGlzLm93bmVyLmVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogewogICAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TaGFkb3dOb2RlIiwKICAgICAgICBnZXRFbGVtZW50OiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5lbGVtZW50OwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVTeW5jOiBmdW5jdGlvbigpIHsKICAgICAgICAgIE5vZGUucHJvdG90eXBlLnRlbXBsYXRlU3luYy5jYWxsKHRoaXMpOwogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQodGhpcy5kZWxlZ2F0ZSk7CiAgICAgICAgICBpZiAobmV3RWxlbWVudCkgewogICAgICAgICAgICBuZXdFbGVtZW50LmJhc2lzVGVtcGxhdGVJZCA9IHRoaXMuZGVsZWdhdGUuZWxlbWVudC5iYXNpc1RlbXBsYXRlSWQ7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG5ld0VsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsaXN0ZW46IHsKICAgICAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgICAgIHRlbXBsYXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgICAgdmFyIG9sZEVsZW1lbnRQYXJlbnQgPSBvbGRFbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQodGhpcy5kZWxlZ2F0ZSk7CiAgICAgICAgICAgICAgaWYgKG5ld0VsZW1lbnQpIG5ld0VsZW1lbnQuYmFzaXNUZW1wbGF0ZUlkID0gdGhpcy5kZWxlZ2F0ZS5lbGVtZW50LmJhc2lzVGVtcGxhdGVJZDsKICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBuZXdFbGVtZW50IHx8IHRoaXMudG1wbC5lbGVtZW50OwogICAgICAgICAgICAgIGlmIChvbGRFbGVtZW50UGFyZW50KSBvbGRFbGVtZW50UGFyZW50LnJlcGxhY2VDaGlsZCh0aGlzLmVsZW1lbnQsIG9sZEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBCSU5ESU5HX1BSRVNFVDogQklORElOR19QUkVTRVQsCiAgICAgIE5vZGU6IE5vZGUsCiAgICAgIFBhcnRpdGlvbk5vZGU6IFBhcnRpdGlvbk5vZGUsCiAgICAgIEdyb3VwaW5nTm9kZTogR3JvdXBpbmdOb2RlLAogICAgICBTaGFkb3dOb2RlTGlzdDogU2hhZG93Tm9kZUxpc3QsCiAgICAgIFNoYWRvd05vZGU6IFNoYWRvd05vZGVMaXN0LnByb3RvdHlwZS5jaGlsZENsYXNzCiAgICB9OwogIH0sCiAgImsuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBlc3ByaW1hID0gYmFzaXMucmVxdWlyZSgiLi9sLmpzIik7CiAgICB2YXIgVFJBVkVSU0VfQUJPUlQgPSAxOwogICAgdmFyIFRSQVZFUlNFX1NUT1BfREVFUCA9IDI7CiAgICB2YXIgTk9ERV9CUkFOQ0hFUyA9IHsKICAgICAgQXJyYXlFeHByZXNzaW9uOiBbICJlbGVtZW50cyIgXSwKICAgICAgQXNzaWdubWVudEV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIEJpbmFyeUV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIEJsb2NrU3RhdGVtZW50OiBbICJib2R5IiBdLAogICAgICBCcmVha1N0YXRlbWVudDogWyAibGFiZWwiIF0sCiAgICAgIENhbGxFeHByZXNzaW9uOiBbICJjYWxsZWUiLCAiYXJndW1lbnRzIiBdLAogICAgICBDYXRjaENsYXVzZTogWyAicGFyYW0iLCAiYm9keSIgXSwKICAgICAgQ29uZGl0aW9uYWxFeHByZXNzaW9uOiBbICJ0ZXN0IiwgImNvbnNlcXVlbnQiLCAiYWx0ZXJuYXRlIiBdLAogICAgICBDb250aW51ZVN0YXRlbWVudDogWyAibGFiZWwiIF0sCiAgICAgIERlYnVnZ2VyU3RhdGVtZW50OiBbXSwKICAgICAgRG9XaGlsZVN0YXRlbWVudDogWyAidGVzdCIsICJib2R5IiBdLAogICAgICBFbXB0eVN0YXRlbWVudDogW10sCiAgICAgIEV4cHJlc3Npb25TdGF0ZW1lbnQ6IFsgImV4cHJlc3Npb24iIF0sCiAgICAgIEZvckluU3RhdGVtZW50OiBbICJsZWZ0IiwgInJpZ2h0IiwgImJvZHkiIF0sCiAgICAgIEZvclN0YXRlbWVudDogWyAiaW5pdCIsICJ0ZXN0IiwgInVwZGF0ZSIsICJib2R5IiBdLAogICAgICBGdW5jdGlvbkRlY2xhcmF0aW9uOiBbICJpZCIsICJwYXJhbXMiLCAiYm9keSIgXSwKICAgICAgRnVuY3Rpb25FeHByZXNzaW9uOiBbICJpZCIsICJwYXJhbXMiLCAiZGVmYXVsdHMiLCAiYm9keSIgXSwKICAgICAgSWRlbnRpZmllcjogW10sCiAgICAgIElmU3RhdGVtZW50OiBbICJ0ZXN0IiwgImNvbnNlcXVlbnQiLCAiYWx0ZXJuYXRlIiBdLAogICAgICBMYWJlbGVkU3RhdGVtZW50OiBbICJsYWJlbCIsICJib2R5IiBdLAogICAgICBMaXRlcmFsOiBbXSwKICAgICAgTG9naWNhbEV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIE1lbWJlckV4cHJlc3Npb246IFsgIm9iamVjdCIsICJwcm9wZXJ0eSIgXSwKICAgICAgTmV3RXhwcmVzc2lvbjogWyAiY2FsbGVlIiwgImFyZ3VtZW50cyIgXSwKICAgICAgT2JqZWN0RXhwcmVzc2lvbjogWyAicHJvcGVydGllcyIgXSwKICAgICAgUHJvZ3JhbTogWyAiYm9keSIgXSwKICAgICAgUHJvcGVydHk6IFsgImtleSIsICJ2YWx1ZSIgXSwKICAgICAgUmV0dXJuU3RhdGVtZW50OiBbICJhcmd1bWVudCIgXSwKICAgICAgU2VxdWVuY2VFeHByZXNzaW9uOiBbICJleHByZXNzaW9ucyIgXSwKICAgICAgU3dpdGNoQ2FzZTogWyAidGVzdCIsICJjb25zZXF1ZW50IiBdLAogICAgICBTd2l0Y2hTdGF0ZW1lbnQ6IFsgImRpc2NyaW1pbmFudCIsICJjYXNlcyIgXSwKICAgICAgVGhpc0V4cHJlc3Npb246IFtdLAogICAgICBUaHJvd1N0YXRlbWVudDogWyAiYXJndW1lbnQiIF0sCiAgICAgIFRyeVN0YXRlbWVudDogWyAiYmxvY2siLCAiaGFuZGxlcnMiLCAiZmluYWxpemVyIiBdLAogICAgICBVbmFyeUV4cHJlc3Npb246IFsgImFyZ3VtZW50IiBdLAogICAgICBVcGRhdGVFeHByZXNzaW9uOiBbICJhcmd1bWVudCIgXSwKICAgICAgVmFyaWFibGVEZWNsYXJhdGlvbjogWyAiZGVjbGFyYXRpb25zIiBdLAogICAgICBWYXJpYWJsZURlY2xhcmF0b3I6IFsgImlkIiwgImluaXQiIF0sCiAgICAgIFdoaWxlU3RhdGVtZW50OiBbICJ0ZXN0IiwgImJvZHkiIF0sCiAgICAgIFdpdGhTdGF0ZW1lbnQ6IFsgIm9iamVjdCIsICJib2R5IiBdCiAgICB9OwogICAgZnVuY3Rpb24gcGFyc2UoY29kZSkgewogICAgICBmdW5jdGlvbiBwb3N0UHJvY2Vzc2luZyhub2RlKSB7CiAgICAgICAgdmFyIGJyYW5jaGVzID0gTk9ERV9CUkFOQ0hFU1tub2RlLnR5cGVdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGJyYW5jaGVzW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGVba2V5XTsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFsdWUuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgcG9zdFByb2Nlc3NpbmcoY2hpbGQpOwogICAgICAgICAgICAgICAgY2hpbGQucm9vdCA9IHJlc3VsdDsKICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgY2hpbGQucGFyZW50Q29sbGVjdGlvbiA9IHZhbHVlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvc3RQcm9jZXNzaW5nKHZhbHVlKTsKICAgICAgICAgICAgICB2YWx1ZS5yb290ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhbHVlLnBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciByZXN1bHQgPSBlc3ByaW1hLnBhcnNlKGNvZGUsIHsKICAgICAgICBsb2M6IHRydWUsCiAgICAgICAgcmFuZ2U6IHRydWUsCiAgICAgICAgY29tbWVudDogdHJ1ZSwKICAgICAgICB0b2tlbnM6IHRydWUKICAgICAgfSk7CiAgICAgIHBvc3RQcm9jZXNzaW5nKHJlc3VsdCk7CiAgICAgIHJlc3VsdC5zb3VyY2UgPSBjb2RlOwogICAgICByZXN1bHQucm9vdCA9IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIHRyYXZlcnNlQXN0KG5vZGUsIHZpc2l0b3IpIHsKICAgICAgdmFyIHJlcyA9IHZpc2l0b3IuY2FsbChudWxsLCBub2RlKTsKICAgICAgaWYgKHJlcykgcmV0dXJuIHJlcyA9PSBUUkFWRVJTRV9BQk9SVCA/IHJlcyA6IGZhbHNlOwogICAgICB2YXIgYnJhbmNoZXMgPSBOT0RFX0JSQU5DSEVTW25vZGUudHlwZV07CiAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGJyYW5jaGVzW2ldOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBub2RlW2tleV07CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjaGlsZDsgY2hpbGQgPSB2YWx1ZVtqXTsgaisrKSBpZiAodHJhdmVyc2VBc3QoY2hpbGQsIHZpc2l0b3IpICYgVFJBVkVSU0VfQUJPUlQpIHJldHVybiBUUkFWRVJTRV9BQk9SVDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZUFzdCh2YWx1ZSwgdmlzaXRvcikgJiBUUkFWRVJTRV9BQk9SVCkgcmV0dXJuIFRSQVZFUlNFX0FCT1JUOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0UmFuZ2VUb2tlbnMoYXN0LCBzdGFydCwgZW5kKSB7CiAgICAgIHZhciBmaXJzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIHByZSwgcHJldiwgdG9rZW47IGkgPCBhc3QudG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9rZW4gPSBhc3QudG9rZW5zW2ldOwogICAgICAgIGlmICh0b2tlbi5yYW5nZVswXSA8IHN0YXJ0KSBjb250aW51ZTsKICAgICAgICBpZiAodG9rZW4ucmFuZ2VbMV0gPiBlbmQpIHsKICAgICAgICAgIHRva2VuID0gcHJldjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoIWZpcnN0KSBmaXJzdCA9IHRva2VuOwogICAgICAgIHByZXYgPSB0b2tlbjsKICAgICAgfQogICAgICByZXR1cm4gWyBmaXJzdCwgdG9rZW4gXTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGVSYW5nZVRva2Vucyhub2RlKSB7CiAgICAgIHJldHVybiBnZXRSYW5nZVRva2Vucyhub2RlLnJvb3QsIG5vZGUucmFuZ2VbMF0sIG5vZGUucmFuZ2VbMV0pOwogICAgfQogICAgZnVuY3Rpb24gdHJhbnNsYXRlQXN0KGFzdCwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgc291cmNlID0gYXN0LnNvdXJjZTsKICAgICAgdmFyIGJ1ZmZlciA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgcHJlLCBwcmV2LCB0b2tlbjsgaSA8IGFzdC50b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0b2tlbiA9IGFzdC50b2tlbnNbaV07CiAgICAgICAgaWYgKHRva2VuLnJhbmdlWzBdIDwgc3RhcnQpIGNvbnRpbnVlOwogICAgICAgIGlmICh0b2tlbi5yYW5nZVsxXSA+IGVuZCkgewogICAgICAgICAgdG9rZW4gPSBwcmV2OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHByZSA9IHNvdXJjZS5zdWJzdHJpbmcocHJldiA/IHByZXYucmFuZ2VbMV0gOiBzdGFydCwgdG9rZW4ucmFuZ2VbMF0pOwogICAgICAgIGlmIChwcmUpIGJ1ZmZlci5wdXNoKHByZSk7CiAgICAgICAgYnVmZmVyLnB1c2godG9rZW4udmFsdWUpOwogICAgICAgIHByZXYgPSB0b2tlbjsKICAgICAgfQogICAgICBidWZmZXIucHVzaChzb3VyY2Uuc3Vic3RyaW5nKHRva2VuID8gdG9rZW4ucmFuZ2VbMV0gOiBzdGFydCwgZW5kKSk7CiAgICAgIHJldHVybiBidWZmZXIuam9pbigiIik7CiAgICB9CiAgICBmdW5jdGlvbiB0cmFuc2xhdGVOb2RlKG5vZGUpIHsKICAgICAgcmV0dXJuIHRyYW5zbGF0ZUFzdChub2RlLnJvb3QsIG5vZGUucmFuZ2VbMF0sIG5vZGUucmFuZ2VbMV0pOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFRSQVZFUlNFX0FCT1JUOiBUUkFWRVJTRV9BQk9SVCwKICAgICAgVFJBVkVSU0VfU1RPUF9ERUVQOiBUUkFWRVJTRV9TVE9QX0RFRVAsCiAgICAgIHBhcnNlOiBwYXJzZSwKICAgICAgdHJhdmVyc2VBc3Q6IHRyYXZlcnNlQXN0LAogICAgICB0cmFuc2xhdGVBc3Q6IHRyYW5zbGF0ZUFzdCwKICAgICAgdHJhbnNsYXRlTm9kZTogdHJhbnNsYXRlTm9kZSwKICAgICAgZ2V0UmFuZ2VUb2tlbnM6IGdldFJhbmdlVG9rZW5zLAogICAgICBnZXROb2RlUmFuZ2VUb2tlbnM6IGdldE5vZGVSYW5nZVRva2VucwogICAgfTsKICB9LAogICJsLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoWyAiZXhwb3J0cyIgXSwgZmFjdG9yeSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgZmFjdG9yeShleHBvcnRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmYWN0b3J5KHJvb3QuZXNwcmltYSA9IHt9KTsKICAgICAgfQogICAgfSkodGhpcywgZnVuY3Rpb24oZXhwb3J0cykgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBUb2tlbiwgVG9rZW5OYW1lLCBTeW50YXgsIFByb3BlcnR5S2luZCwgTWVzc2FnZXMsIFJlZ2V4LCBzb3VyY2UsIHN0cmljdCwgaW5kZXgsIGxpbmVOdW1iZXIsIGxpbmVTdGFydCwgbGVuZ3RoLCBidWZmZXIsIHN0YXRlLCBleHRyYTsKICAgICAgVG9rZW4gPSB7CiAgICAgICAgQm9vbGVhbkxpdGVyYWw6IDEsCiAgICAgICAgRU9GOiAyLAogICAgICAgIElkZW50aWZpZXI6IDMsCiAgICAgICAgS2V5d29yZDogNCwKICAgICAgICBOdWxsTGl0ZXJhbDogNSwKICAgICAgICBOdW1lcmljTGl0ZXJhbDogNiwKICAgICAgICBQdW5jdHVhdG9yOiA3LAogICAgICAgIFN0cmluZ0xpdGVyYWw6IDgKICAgICAgfTsKICAgICAgVG9rZW5OYW1lID0ge307CiAgICAgIFRva2VuTmFtZVtUb2tlbi5Cb29sZWFuTGl0ZXJhbF0gPSAiQm9vbGVhbiI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5FT0ZdID0gIjxlbmQ+IjsKICAgICAgVG9rZW5OYW1lW1Rva2VuLklkZW50aWZpZXJdID0gIklkZW50aWZpZXIiOwogICAgICBUb2tlbk5hbWVbVG9rZW4uS2V5d29yZF0gPSAiS2V5d29yZCI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5OdWxsTGl0ZXJhbF0gPSAiTnVsbCI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5OdW1lcmljTGl0ZXJhbF0gPSAiTnVtZXJpYyI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5QdW5jdHVhdG9yXSA9ICJQdW5jdHVhdG9yIjsKICAgICAgVG9rZW5OYW1lW1Rva2VuLlN0cmluZ0xpdGVyYWxdID0gIlN0cmluZyI7CiAgICAgIFN5bnRheCA9IHsKICAgICAgICBBc3NpZ25tZW50RXhwcmVzc2lvbjogIkFzc2lnbm1lbnRFeHByZXNzaW9uIiwKICAgICAgICBBcnJheUV4cHJlc3Npb246ICJBcnJheUV4cHJlc3Npb24iLAogICAgICAgIEJsb2NrU3RhdGVtZW50OiAiQmxvY2tTdGF0ZW1lbnQiLAogICAgICAgIEJpbmFyeUV4cHJlc3Npb246ICJCaW5hcnlFeHByZXNzaW9uIiwKICAgICAgICBCcmVha1N0YXRlbWVudDogIkJyZWFrU3RhdGVtZW50IiwKICAgICAgICBDYWxsRXhwcmVzc2lvbjogIkNhbGxFeHByZXNzaW9uIiwKICAgICAgICBDYXRjaENsYXVzZTogIkNhdGNoQ2xhdXNlIiwKICAgICAgICBDb25kaXRpb25hbEV4cHJlc3Npb246ICJDb25kaXRpb25hbEV4cHJlc3Npb24iLAogICAgICAgIENvbnRpbnVlU3RhdGVtZW50OiAiQ29udGludWVTdGF0ZW1lbnQiLAogICAgICAgIERvV2hpbGVTdGF0ZW1lbnQ6ICJEb1doaWxlU3RhdGVtZW50IiwKICAgICAgICBEZWJ1Z2dlclN0YXRlbWVudDogIkRlYnVnZ2VyU3RhdGVtZW50IiwKICAgICAgICBFbXB0eVN0YXRlbWVudDogIkVtcHR5U3RhdGVtZW50IiwKICAgICAgICBFeHByZXNzaW9uU3RhdGVtZW50OiAiRXhwcmVzc2lvblN0YXRlbWVudCIsCiAgICAgICAgRm9yU3RhdGVtZW50OiAiRm9yU3RhdGVtZW50IiwKICAgICAgICBGb3JJblN0YXRlbWVudDogIkZvckluU3RhdGVtZW50IiwKICAgICAgICBGdW5jdGlvbkRlY2xhcmF0aW9uOiAiRnVuY3Rpb25EZWNsYXJhdGlvbiIsCiAgICAgICAgRnVuY3Rpb25FeHByZXNzaW9uOiAiRnVuY3Rpb25FeHByZXNzaW9uIiwKICAgICAgICBJZGVudGlmaWVyOiAiSWRlbnRpZmllciIsCiAgICAgICAgSWZTdGF0ZW1lbnQ6ICJJZlN0YXRlbWVudCIsCiAgICAgICAgTGl0ZXJhbDogIkxpdGVyYWwiLAogICAgICAgIExhYmVsZWRTdGF0ZW1lbnQ6ICJMYWJlbGVkU3RhdGVtZW50IiwKICAgICAgICBMb2dpY2FsRXhwcmVzc2lvbjogIkxvZ2ljYWxFeHByZXNzaW9uIiwKICAgICAgICBNZW1iZXJFeHByZXNzaW9uOiAiTWVtYmVyRXhwcmVzc2lvbiIsCiAgICAgICAgTmV3RXhwcmVzc2lvbjogIk5ld0V4cHJlc3Npb24iLAogICAgICAgIE9iamVjdEV4cHJlc3Npb246ICJPYmplY3RFeHByZXNzaW9uIiwKICAgICAgICBQcm9ncmFtOiAiUHJvZ3JhbSIsCiAgICAgICAgUHJvcGVydHk6ICJQcm9wZXJ0eSIsCiAgICAgICAgUmV0dXJuU3RhdGVtZW50OiAiUmV0dXJuU3RhdGVtZW50IiwKICAgICAgICBTZXF1ZW5jZUV4cHJlc3Npb246ICJTZXF1ZW5jZUV4cHJlc3Npb24iLAogICAgICAgIFN3aXRjaFN0YXRlbWVudDogIlN3aXRjaFN0YXRlbWVudCIsCiAgICAgICAgU3dpdGNoQ2FzZTogIlN3aXRjaENhc2UiLAogICAgICAgIFRoaXNFeHByZXNzaW9uOiAiVGhpc0V4cHJlc3Npb24iLAogICAgICAgIFRocm93U3RhdGVtZW50OiAiVGhyb3dTdGF0ZW1lbnQiLAogICAgICAgIFRyeVN0YXRlbWVudDogIlRyeVN0YXRlbWVudCIsCiAgICAgICAgVW5hcnlFeHByZXNzaW9uOiAiVW5hcnlFeHByZXNzaW9uIiwKICAgICAgICBVcGRhdGVFeHByZXNzaW9uOiAiVXBkYXRlRXhwcmVzc2lvbiIsCiAgICAgICAgVmFyaWFibGVEZWNsYXJhdGlvbjogIlZhcmlhYmxlRGVjbGFyYXRpb24iLAogICAgICAgIFZhcmlhYmxlRGVjbGFyYXRvcjogIlZhcmlhYmxlRGVjbGFyYXRvciIsCiAgICAgICAgV2hpbGVTdGF0ZW1lbnQ6ICJXaGlsZVN0YXRlbWVudCIsCiAgICAgICAgV2l0aFN0YXRlbWVudDogIldpdGhTdGF0ZW1lbnQiCiAgICAgIH07CiAgICAgIFByb3BlcnR5S2luZCA9IHsKICAgICAgICBEYXRhOiAxLAogICAgICAgIEdldDogMiwKICAgICAgICBTZXQ6IDQKICAgICAgfTsKICAgICAgTWVzc2FnZXMgPSB7CiAgICAgICAgVW5leHBlY3RlZFRva2VuOiAiVW5leHBlY3RlZCB0b2tlbiAlMCIsCiAgICAgICAgVW5leHBlY3RlZE51bWJlcjogIlVuZXhwZWN0ZWQgbnVtYmVyIiwKICAgICAgICBVbmV4cGVjdGVkU3RyaW5nOiAiVW5leHBlY3RlZCBzdHJpbmciLAogICAgICAgIFVuZXhwZWN0ZWRJZGVudGlmaWVyOiAiVW5leHBlY3RlZCBpZGVudGlmaWVyIiwKICAgICAgICBVbmV4cGVjdGVkUmVzZXJ2ZWQ6ICJVbmV4cGVjdGVkIHJlc2VydmVkIHdvcmQiLAogICAgICAgIFVuZXhwZWN0ZWRFT1M6ICJVbmV4cGVjdGVkIGVuZCBvZiBpbnB1dCIsCiAgICAgICAgTmV3bGluZUFmdGVyVGhyb3c6ICJJbGxlZ2FsIG5ld2xpbmUgYWZ0ZXIgdGhyb3ciLAogICAgICAgIEludmFsaWRSZWdFeHA6ICJJbnZhbGlkIHJlZ3VsYXIgZXhwcmVzc2lvbiIsCiAgICAgICAgVW50ZXJtaW5hdGVkUmVnRXhwOiAiSW52YWxpZCByZWd1bGFyIGV4cHJlc3Npb246IG1pc3NpbmcgLyIsCiAgICAgICAgSW52YWxpZExIU0luQXNzaWdubWVudDogIkludmFsaWQgbGVmdC1oYW5kIHNpZGUgaW4gYXNzaWdubWVudCIsCiAgICAgICAgSW52YWxpZExIU0luRm9ySW46ICJJbnZhbGlkIGxlZnQtaGFuZCBzaWRlIGluIGZvci1pbiIsCiAgICAgICAgTXVsdGlwbGVEZWZhdWx0c0luU3dpdGNoOiAiTW9yZSB0aGFuIG9uZSBkZWZhdWx0IGNsYXVzZSBpbiBzd2l0Y2ggc3RhdGVtZW50IiwKICAgICAgICBOb0NhdGNoT3JGaW5hbGx5OiAiTWlzc2luZyBjYXRjaCBvciBmaW5hbGx5IGFmdGVyIHRyeSIsCiAgICAgICAgVW5rbm93bkxhYmVsOiAiVW5kZWZpbmVkIGxhYmVsICclMCciLAogICAgICAgIFJlZGVjbGFyYXRpb246ICIlMCAnJTEnIGhhcyBhbHJlYWR5IGJlZW4gZGVjbGFyZWQiLAogICAgICAgIElsbGVnYWxDb250aW51ZTogIklsbGVnYWwgY29udGludWUgc3RhdGVtZW50IiwKICAgICAgICBJbGxlZ2FsQnJlYWs6ICJJbGxlZ2FsIGJyZWFrIHN0YXRlbWVudCIsCiAgICAgICAgSWxsZWdhbFJldHVybjogIklsbGVnYWwgcmV0dXJuIHN0YXRlbWVudCIsCiAgICAgICAgU3RyaWN0TW9kZVdpdGg6ICJTdHJpY3QgbW9kZSBjb2RlIG1heSBub3QgaW5jbHVkZSBhIHdpdGggc3RhdGVtZW50IiwKICAgICAgICBTdHJpY3RDYXRjaFZhcmlhYmxlOiAiQ2F0Y2ggdmFyaWFibGUgbWF5IG5vdCBiZSBldmFsIG9yIGFyZ3VtZW50cyBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0VmFyTmFtZTogIlZhcmlhYmxlIG5hbWUgbWF5IG5vdCBiZSBldmFsIG9yIGFyZ3VtZW50cyBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0UGFyYW1OYW1lOiAiUGFyYW1ldGVyIG5hbWUgZXZhbCBvciBhcmd1bWVudHMgaXMgbm90IGFsbG93ZWQgaW4gc3RyaWN0IG1vZGUiLAogICAgICAgIFN0cmljdFBhcmFtRHVwZTogIlN0cmljdCBtb2RlIGZ1bmN0aW9uIG1heSBub3QgaGF2ZSBkdXBsaWNhdGUgcGFyYW1ldGVyIG5hbWVzIiwKICAgICAgICBTdHJpY3RGdW5jdGlvbk5hbWU6ICJGdW5jdGlvbiBuYW1lIG1heSBub3QgYmUgZXZhbCBvciBhcmd1bWVudHMgaW4gc3RyaWN0IG1vZGUiLAogICAgICAgIFN0cmljdE9jdGFsTGl0ZXJhbDogIk9jdGFsIGxpdGVyYWxzIGFyZSBub3QgYWxsb3dlZCBpbiBzdHJpY3QgbW9kZS4iLAogICAgICAgIFN0cmljdERlbGV0ZTogIkRlbGV0ZSBvZiBhbiB1bnF1YWxpZmllZCBpZGVudGlmaWVyIGluIHN0cmljdCBtb2RlLiIsCiAgICAgICAgU3RyaWN0RHVwbGljYXRlUHJvcGVydHk6ICJEdXBsaWNhdGUgZGF0YSBwcm9wZXJ0eSBpbiBvYmplY3QgbGl0ZXJhbCBub3QgYWxsb3dlZCBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgQWNjZXNzb3JEYXRhUHJvcGVydHk6ICJPYmplY3QgbGl0ZXJhbCBtYXkgbm90IGhhdmUgZGF0YSBhbmQgYWNjZXNzb3IgcHJvcGVydHkgd2l0aCB0aGUgc2FtZSBuYW1lIiwKICAgICAgICBBY2Nlc3NvckdldFNldDogIk9iamVjdCBsaXRlcmFsIG1heSBub3QgaGF2ZSBtdWx0aXBsZSBnZXQvc2V0IGFjY2Vzc29ycyB3aXRoIHRoZSBzYW1lIG5hbWUiLAogICAgICAgIFN0cmljdExIU0Fzc2lnbm1lbnQ6ICJBc3NpZ25tZW50IHRvIGV2YWwgb3IgYXJndW1lbnRzIGlzIG5vdCBhbGxvd2VkIGluIHN0cmljdCBtb2RlIiwKICAgICAgICBTdHJpY3RMSFNQb3N0Zml4OiAiUG9zdGZpeCBpbmNyZW1lbnQvZGVjcmVtZW50IG1heSBub3QgaGF2ZSBldmFsIG9yIGFyZ3VtZW50cyBvcGVyYW5kIGluIHN0cmljdCBtb2RlIiwKICAgICAgICBTdHJpY3RMSFNQcmVmaXg6ICJQcmVmaXggaW5jcmVtZW50L2RlY3JlbWVudCBtYXkgbm90IGhhdmUgZXZhbCBvciBhcmd1bWVudHMgb3BlcmFuZCBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0UmVzZXJ2ZWRXb3JkOiAiVXNlIG9mIGZ1dHVyZSByZXNlcnZlZCB3b3JkIGluIHN0cmljdCBtb2RlIgogICAgICB9OwogICAgICBSZWdleCA9IHsKICAgICAgICBOb25Bc2NpaUlkZW50aWZpZXJTdGFydDogbmV3IFJlZ0V4cCgiW8KqwrXCusOALcOWw5gtw7bDuC3LgcuGLcuRy6Aty6TLrMuuzbAtzbTNts23zbotzb3Ohs6ILc6KzozOji3Ooc6jLc+1z7ct0oHSii3Up9SxLdWW1ZnVoS3Wh9eQLdeq17At17LYoC3Zitmu2a/ZsS3bk9uV26Xbptuu26/bui3bvNu/3JDcki3cr92NLd6l3rHfii3fqt+037XfuuCggC3goJXgoJrgoKTgoKjgoYAt4KGY4KKg4KKiLeCirOCkhC3gpLngpL3gpZDgpZgt4KWh4KWxLeClt+CluS3gpb/gpoUt4KaM4KaP4KaQ4KaTLeCmqOCmqi3gprDgprLgprYt4Ka54Ka94KeO4Kec4Ked4KefLeCnoeCnsOCnseCohS3gqIrgqI/gqJDgqJMt4Kio4KiqLeCosOCosuCos+CoteCotuCouOCoueCpmS3gqZzgqZ7gqbIt4Km04KqFLeCqjeCqjy3gqpHgqpMt4Kqo4KqqLeCqsOCqsuCqs+CqtS3gqrngqr3gq5Dgq6Dgq6HgrIUt4KyM4KyP4KyQ4KyTLeCsqOCsqi3grLDgrLLgrLPgrLUt4Ky54Ky94K2c4K2d4K2fLeCtoeCtseCug+CuhS3grorgro4t4K6Q4K6SLeCuleCumeCumuCunOCunuCun+Cuo+CupOCuqC3grqrgrq4t4K654K+Q4LCFLeCwjOCwji3gsJDgsJIt4LCo4LCqLeCws+CwtS3gsLngsL3gsZjgsZngsaDgsaHgsoUt4LKM4LKOLeCykOCyki3gsqjgsqot4LKz4LK1LeCyueCyveCznuCzoOCzoeCzseCzsuC0hS3gtIzgtI4t4LSQ4LSSLeC0uuC0veC1juC1oOC1oeC1ui3gtb/gtoUt4LaW4LaaLeC2seC2sy3gtrvgtr3gt4At4LeG4LiBLeC4sOC4suC4s+C5gC3guYbguoHguoLguoTguofguojguorguo3gupQt4LqX4LqZLeC6n+C6oS3guqPguqXguqfguqrguqvguq0t4Lqw4Lqy4Lqz4Lq94LuALeC7hOC7huC7nC3gu5/gvIDgvYAt4L2H4L2JLeC9rOC+iC3gvozhgIAt4YCq4YC/4YGQLeGBleGBmi3hgZ3hgaHhgaXhgabhga4t4YGw4YG1LeGCgeGCjuGCoC3hg4Xhg4fhg43hg5At4YO64YO8LeGJiOGJii3hiY3hiZAt4YmW4YmY4YmaLeGJneGJoC3hiojhioot4YqN4YqQLeGKsOGKsi3hirXhirgt4Yq+4YuA4YuCLeGLheGLiC3hi5bhi5gt4YyQ4YySLeGMleGMmC3hjZrhjoAt4Y6P4Y6gLeGPtOGQgS3hmazhma8t4Zm/4ZqBLeGamuGaoC3hm6rhm64t4Zuw4ZyALeGcjOGcji3hnJHhnKAt4Zyx4Z2ALeGdkeGdoC3hnazhna4t4Z2w4Z6ALeGes+Gfl+GfnOGgoC3hobfhooAt4aKo4aKq4aKwLeGjteGkgC3hpJzhpZAt4aWt4aWwLeGltOGmgC3hpqvhp4Et4aeH4aiALeGoluGooC3hqZThqqfhrIUt4ayz4a2FLeGti+Gugy3hrqDhrq7hrq/hrrot4a+l4bCALeGwo+GxjS3hsY/hsZot4bG94bOpLeGzrOGzri3hs7Hhs7Xhs7bhtIAt4ba/4biALeG8leG8mC3hvJ3hvKAt4b2F4b2ILeG9jeG9kC3hvZfhvZnhvZvhvZ3hvZ8t4b294b6ALeG+tOG+ti3hvrzhvr7hv4It4b+E4b+GLeG/jOG/kC3hv5Phv5Yt4b+b4b+gLeG/rOG/si3hv7Thv7Yt4b+84oGx4oG/4oKQLeKCnOKEguKEh+KEii3ihJPihJXihJkt4oSd4oSk4oSm4oSo4oSqLeKEreKEry3ihLnihLwt4oS/4oWFLeKFieKFjuKFoC3ihojisIAt4rCu4rCwLeKxnuKxoC3is6Tis6st4rOu4rOy4rOz4rSALeK0peK0p+K0reK0sC3itafita/itoAt4raW4ragLeK2puK2qC3itq7itrAt4ra24ra4LeK2vuK3gC3it4bit4gt4reO4reQLeK3luK3mC3it57iuK/jgIUt44CH44ChLeOAqeOAsS3jgLXjgLgt44C844GBLeOCluOCnS3jgp/jgqEt44O644O8LeODv+OEhS3jhK3jhLEt44aO44agLeOGuuOHsC3jh7/jkIAt5La15LiALem/jOqAgC3qkozqk5At6pO96pSALeqYjOqYkC3qmJ/qmKrqmKvqmYAt6pmu6pm/Leqal+qaoC3qm6/qnJct6pyf6pyiLeqeiOqeiy3qno7qnpAt6p6T6p6gLeqequqfuC3qoIHqoIMt6qCF6qCHLeqgiuqgjC3qoKLqoYAt6qGz6qKCLeqis+qjsi3qo7fqo7vqpIot6qSl6qSwLeqlhuqloC3qpbzqpoQt6qay6qeP6qiALeqoqOqpgC3qqYLqqYQt6qmL6qmgLeqptuqpuuqqgC3qqq/qqrHqqrXqqrbqqrkt6qq96quA6quC6qubLeqrneqroC3qq6rqq7It6qu06qyBLeqshuqsiS3qrI7qrJEt6qyW6qygLeqspuqsqC3qrK7qr4At6q+i6rCALe2eo+2esC3tn4btn4st7Z+776SALe+pre+psC3vq5nvrIAt76yG76yTLe+sl++sne+sny3vrKjvrKot76y276y4Le+svO+svu+tgO+tge+tg++thO+thi3vrrHvr5Mt77S977WQLe+2j++2ki3vt4fvt7At77e777mwLe+5tO+5ti3vu7zvvKEt77y6772BLe+9mu+9pi3vvr7vv4It77+H77+KLe+/j++/ki3vv5fvv5ot77+cXSIpLAogICAgICAgIE5vbkFzY2lpSWRlbnRpZmllclBhcnQ6IG5ldyBSZWdFeHAoIlvCqsK1wrrDgC3DlsOYLcO2w7gty4HLhi3LkcugLcuky6zLrsyALc20zbbNt826Lc29zobOiC3Ois6Mzo4tzqHOoy3Ptc+3LdKB0oMt0ofSii3Up9SxLdWW1ZnVoS3Wh9aRLda91r/XgdeC14TXhdeH15At16rXsC3XstiQLdia2KAt2anZri3bk9uVLduc258t26jbqi3bvNu/3JAt3YrdjS3esd+ALd+137rgoIAt4KCt4KGALeChm+CioOCioi3goqzgo6Qt4KO+4KSALeClo+Clpi3gpa/gpbEt4KW34KW5LeClv+CmgS3gpoPgpoUt4KaM4KaP4KaQ4KaTLeCmqOCmqi3gprDgprLgprYt4Ka54Ka8LeCnhOCnh+CniOCniy3gp47gp5fgp5zgp53gp58t4Kej4KemLeCnseCogS3gqIPgqIUt4KiK4KiP4KiQ4KiTLeCoqOCoqi3gqLDgqLLgqLPgqLXgqLbgqLjgqLngqLzgqL4t4KmC4KmH4KmI4KmLLeCpjeCpkeCpmS3gqZzgqZ7gqaYt4Km14KqBLeCqg+CqhS3gqo3gqo8t4KqR4KqTLeCqqOCqqi3gqrDgqrLgqrPgqrUt4Kq54Kq8LeCrheCrhy3gq4ngq4st4KuN4KuQ4KugLeCro+Crpi3gq6/grIEt4KyD4KyFLeCsjOCsj+CskOCsky3grKjgrKot4Kyw4Kyy4Kyz4Ky1LeCsueCsvC3grYTgrYfgrYjgrYst4K2N4K2W4K2X4K2c4K2d4K2fLeCto+Ctpi3gra/grbHgroLgroPgroUt4K6K4K6OLeCukOCuki3grpXgrpngrprgrpzgrp7grp/grqPgrqTgrqgt4K6q4K6uLeCuueCuvi3gr4Lgr4Yt4K+I4K+KLeCvjeCvkOCvl+Cvpi3gr6/gsIEt4LCD4LCFLeCwjOCwji3gsJDgsJIt4LCo4LCqLeCws+CwtS3gsLngsL0t4LGE4LGGLeCxiOCxii3gsY3gsZXgsZbgsZjgsZngsaAt4LGj4LGmLeCxr+CyguCyg+CyhS3gsozgso4t4LKQ4LKSLeCyqOCyqi3gsrPgsrUt4LK54LK8LeCzhOCzhi3gs4jgs4ot4LON4LOV4LOW4LOe4LOgLeCzo+Czpi3gs6/gs7Hgs7LgtILgtIPgtIUt4LSM4LSOLeC0kOC0ki3gtLrgtL0t4LWE4LWGLeC1iOC1ii3gtY7gtZfgtaAt4LWj4LWmLeC1r+C1ui3gtb/gtoLgtoPgtoUt4LaW4LaaLeC2seC2sy3gtrvgtr3gt4At4LeG4LeK4LePLeC3lOC3luC3mC3gt5/gt7Lgt7PguIEt4Li64LmALeC5juC5kC3guZnguoHguoLguoTguofguojguorguo3gupQt4LqX4LqZLeC6n+C6oS3guqPguqXguqfguqrguqvguq0t4Lq54Lq7LeC6veC7gC3gu4Tgu4bgu4gt4LuN4LuQLeC7meC7nC3gu5/gvIDgvJjgvJngvKAt4Lyp4Ly14Ly34Ly54Ly+LeC9h+C9iS3gvazgvbEt4L6E4L6GLeC+l+C+mS3gvrzgv4bhgIAt4YGJ4YGQLeGCneGCoC3hg4Xhg4fhg43hg5At4YO64YO8LeGJiOGJii3hiY3hiZAt4YmW4YmY4YmaLeGJneGJoC3hiojhioot4YqN4YqQLeGKsOGKsi3hirXhirgt4Yq+4YuA4YuCLeGLheGLiC3hi5bhi5gt4YyQ4YySLeGMleGMmC3hjZrhjZ0t4Y2f4Y6ALeGOj+GOoC3hj7ThkIEt4Zms4ZmvLeGZv+GagS3hmprhmqAt4Zuq4ZuuLeGbsOGcgC3hnIzhnI4t4ZyU4ZygLeGctOGdgC3hnZPhnaAt4Z2s4Z2uLeGdsOGdsuGds+GegC3hn5Phn5fhn5zhn53hn6At4Z+p4aCLLeGgjeGgkC3hoJnhoKAt4aG34aKALeGiquGisC3ho7XhpIAt4aSc4aSgLeGkq+GksC3hpLvhpYYt4aWt4aWwLeGltOGmgC3hpqvhprAt4aeJ4aeQLeGnmeGogC3hqJvhqKAt4ame4amgLeGpvOGpvy3hqonhqpAt4aqZ4aqn4ayALeGti+GtkC3hrZnhrast4a2z4a6ALeGvs+GwgC3hsLfhsYAt4bGJ4bGNLeGxveGzkC3hs5Lhs5Qt4bO24bSALeG3puG3vC3hvJXhvJgt4byd4bygLeG9heG9iC3hvY3hvZAt4b2X4b2Z4b2b4b2d4b2fLeG9veG+gC3hvrThvrYt4b684b6+4b+CLeG/hOG/hi3hv4zhv5At4b+T4b+WLeG/m+G/oC3hv6zhv7It4b+04b+2LeG/vOKAjOKAjeKAv+KBgOKBlOKBseKBv+KCkC3igpzig5At4oOc4oOh4oOlLeKDsOKEguKEh+KEii3ihJPihJXihJkt4oSd4oSk4oSm4oSo4oSqLeKEreKEry3ihLnihLwt4oS/4oWFLeKFieKFjuKFoC3ihojisIAt4rCu4rCwLeKxnuKxoC3is6Tis6st4rOz4rSALeK0peK0p+K0reK0sC3itafita/itb8t4raW4ragLeK2puK2qC3itq7itrAt4ra24ra4LeK2vuK3gC3it4bit4gt4reO4reQLeK3luK3mC3it57it6At4re/4riv44CFLeOAh+OAoS3jgK/jgLEt44C144C4LeOAvOOBgS3jgpbjgpnjgprjgp0t44Kf44KhLeODuuODvC3jg7/jhIUt44St44SxLeOGjuOGoC3jhrrjh7At44e/45CALeS2teS4gC3pv4zqgIAt6pKM6pOQLeqTveqUgC3qmIzqmJAt6pir6pmALeqZr+qZtC3qmb3qmb8t6pqX6pqfLeqbseqcly3qnJ/qnKIt6p6I6p6LLeqejuqekC3qnpPqnqAt6p6q6p+4Leqgp+qhgC3qobPqooAt6qOE6qOQLeqjmeqjoC3qo7fqo7vqpIAt6qSt6qSwLeqlk+qloC3qpbzqpoAt6qeA6qePLeqnmeqogC3qqLbqqYAt6qmN6qmQLeqpmeqpoC3qqbbqqbrqqbvqqoAt6quC6qubLeqrneqroC3qq6/qq7It6qu26qyBLeqshuqsiS3qrI7qrJEt6qyW6qygLeqspuqsqC3qrK7qr4At6q+q6q+s6q+t6q+wLeqvueqwgC3tnqPtnrAt7Z+G7Z+LLe2fu++kgC3vqa3vqbAt76uZ76yALe+shu+sky3vrJfvrJ0t76yo76yqLe+stu+suC3vrLzvrL7vrYDvrYHvrYPvrYTvrYYt766x76+TLe+0ve+1kC3vto/vtpIt77eH77ewLe+3u++4gC3vuI/vuKAt77im77iz77i077mNLe+5j++5sC3vubTvubYt77u877yQLe+8me+8oS3vvLrvvL/vvYEt772a772mLe++vu+/gi3vv4fvv4ot77+P77+SLe+/l++/mi3vv5xdIikKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbWVzc2FnZSkgewogICAgICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFTU0VSVDogIiArIG1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzbGljZVNvdXJjZShmcm9tLCB0bykgewogICAgICAgIHJldHVybiBzb3VyY2Uuc2xpY2UoZnJvbSwgdG8pOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgImVzcHJpbWEiWzBdID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHNsaWNlU291cmNlID0gZnVuY3Rpb24gc2xpY2VBcnJheVNvdXJjZShmcm9tLCB0bykgewogICAgICAgICAgcmV0dXJuIHNvdXJjZS5zbGljZShmcm9tLCB0bykuam9pbigiIik7CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0RlY2ltYWxEaWdpdChjaCkgewogICAgICAgIHJldHVybiAiMDEyMzQ1Njc4OSIuaW5kZXhPZihjaCkgPj0gMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0hleERpZ2l0KGNoKSB7CiAgICAgICAgcmV0dXJuICIwMTIzNDU2Nzg5YWJjZGVmQUJDREVGIi5pbmRleE9mKGNoKSA+PSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzT2N0YWxEaWdpdChjaCkgewogICAgICAgIHJldHVybiAiMDEyMzQ1NjciLmluZGV4T2YoY2gpID49IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNXaGl0ZVNwYWNlKGNoKSB7CiAgICAgICAgcmV0dXJuIGNoID09PSAiICIgfHwgY2ggPT09ICIJIiB8fCBjaCA9PT0gIgsiIHx8IGNoID09PSAiXGYiIHx8IGNoID09PSAiwqAiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gNTc2MCAmJiAi4ZqA4aCO4oCA4oCB4oCC4oCD4oCE4oCF4oCG4oCH4oCI4oCJ4oCK4oCv4oGf44CA77u/Ii5pbmRleE9mKGNoKSA+PSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzTGluZVRlcm1pbmF0b3IoY2gpIHsKICAgICAgICByZXR1cm4gY2ggPT09ICJcbiIgfHwgY2ggPT09ICJcciIgfHwgY2ggPT09ICJcdTIwMjgiIHx8IGNoID09PSAiXHUyMDI5IjsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0lkZW50aWZpZXJTdGFydChjaCkgewogICAgICAgIHJldHVybiBjaCA9PT0gIiQiIHx8IGNoID09PSAiXyIgfHwgY2ggPT09ICJcXCIgfHwgY2ggPj0gImEiICYmIGNoIDw9ICJ6IiB8fCBjaCA+PSAiQSIgJiYgY2ggPD0gIloiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gMTI4ICYmIFJlZ2V4Lk5vbkFzY2lpSWRlbnRpZmllclN0YXJ0LnRlc3QoY2gpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzSWRlbnRpZmllclBhcnQoY2gpIHsKICAgICAgICByZXR1cm4gY2ggPT09ICIkIiB8fCBjaCA9PT0gIl8iIHx8IGNoID09PSAiXFwiIHx8IGNoID49ICJhIiAmJiBjaCA8PSAieiIgfHwgY2ggPj0gIkEiICYmIGNoIDw9ICJaIiB8fCBjaCA+PSAiMCIgJiYgY2ggPD0gIjkiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gMTI4ICYmIFJlZ2V4Lk5vbkFzY2lpSWRlbnRpZmllclBhcnQudGVzdChjaCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNGdXR1cmVSZXNlcnZlZFdvcmQoaWQpIHsKICAgICAgICBzd2l0Y2ggKGlkKSB7CiAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICBjYXNlICJlbnVtIjoKICAgICAgICAgIGNhc2UgImV4cG9ydCI6CiAgICAgICAgICBjYXNlICJleHRlbmRzIjoKICAgICAgICAgIGNhc2UgImltcG9ydCI6CiAgICAgICAgICBjYXNlICJzdXBlciI6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNTdHJpY3RNb2RlUmVzZXJ2ZWRXb3JkKGlkKSB7CiAgICAgICAgc3dpdGNoIChpZCkgewogICAgICAgICAgY2FzZSAiaW1wbGVtZW50cyI6CiAgICAgICAgICBjYXNlICJpbnRlcmZhY2UiOgogICAgICAgICAgY2FzZSAicGFja2FnZSI6CiAgICAgICAgICBjYXNlICJwcml2YXRlIjoKICAgICAgICAgIGNhc2UgInByb3RlY3RlZCI6CiAgICAgICAgICBjYXNlICJwdWJsaWMiOgogICAgICAgICAgY2FzZSAic3RhdGljIjoKICAgICAgICAgIGNhc2UgInlpZWxkIjoKICAgICAgICAgIGNhc2UgImxldCI6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNSZXN0cmljdGVkV29yZChpZCkgewogICAgICAgIHJldHVybiBpZCA9PT0gImV2YWwiIHx8IGlkID09PSAiYXJndW1lbnRzIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0tleXdvcmQoaWQpIHsKICAgICAgICB2YXIga2V5d29yZCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAoaWQubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gImlmIiB8fCBpZCA9PT0gImluIiB8fCBpZCA9PT0gImRvIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gInZhciIgfHwgaWQgPT09ICJmb3IiIHx8IGlkID09PSAibmV3IiB8fCBpZCA9PT0gInRyeSI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBrZXl3b3JkID0gaWQgPT09ICJ0aGlzIiB8fCBpZCA9PT0gImVsc2UiIHx8IGlkID09PSAiY2FzZSIgfHwgaWQgPT09ICJ2b2lkIiB8fCBpZCA9PT0gIndpdGgiOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAid2hpbGUiIHx8IGlkID09PSAiYnJlYWsiIHx8IGlkID09PSAiY2F0Y2giIHx8IGlkID09PSAidGhyb3ciOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAicmV0dXJuIiB8fCBpZCA9PT0gInR5cGVvZiIgfHwgaWQgPT09ICJkZWxldGUiIHx8IGlkID09PSAic3dpdGNoIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gImRlZmF1bHQiIHx8IGlkID09PSAiZmluYWxseSI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBrZXl3b3JkID0gaWQgPT09ICJmdW5jdGlvbiIgfHwgaWQgPT09ICJjb250aW51ZSIgfHwgaWQgPT09ICJkZWJ1Z2dlciI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAiaW5zdGFuY2VvZiI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5d29yZCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoaWQpIHsKICAgICAgICAgIGNhc2UgImNvbnN0IjoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICBjYXNlICJ5aWVsZCI6CiAgICAgICAgICBjYXNlICJsZXQiOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmljdCAmJiBpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQoaWQpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzRnV0dXJlUmVzZXJ2ZWRXb3JkKGlkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBza2lwQ29tbWVudCgpIHsKICAgICAgICB2YXIgY2gsIGJsb2NrQ29tbWVudCwgbGluZUNvbW1lbnQ7CiAgICAgICAgYmxvY2tDb21tZW50ID0gZmFsc2U7CiAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChsaW5lQ29tbWVudCkgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgaWYgKGlzTGluZVRlcm1pbmF0b3IoY2gpKSB7CiAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4XSA9PT0gIlxuIikgewogICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGJsb2NrQ29tbWVudCkgewogICAgICAgICAgICBpZiAoaXNMaW5lVGVybWluYXRvcihjaCkpIHsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4ICsgMV0gPT09ICJcbiIpIHsKICAgICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICsrbGluZU51bWJlcjsKICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY2ggPT09ICIqIikgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICAgICAgYmxvY2tDb21tZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXggKyAxXTsKICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIioiKSB7CiAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICBibG9ja0NvbW1lbnQgPSB0cnVlOwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZVNwYWNlKGNoKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4XSA9PT0gIlxuIikgewogICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzY2FuSGV4RXNjYXBlKHByZWZpeCkgewogICAgICAgIHZhciBpLCBsZW4sIGNoLCBjb2RlID0gMDsKICAgICAgICBsZW4gPSBwcmVmaXggPT09ICJ1IiA/IDQgOiAyOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoICYmIGlzSGV4RGlnaXQoc291cmNlW2luZGV4XSkpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGNvZGUgPSBjb2RlICogMTYgKyAiMDEyMzQ1Njc4OWFiY2RlZiIuaW5kZXhPZihjaC50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhbklkZW50aWZpZXIoKSB7CiAgICAgICAgdmFyIGNoLCBzdGFydCwgaWQsIHJlc3RvcmU7CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGlmICghaXNJZGVudGlmaWVyU3RhcnQoY2gpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgaWYgKGNoID09PSAiXFwiKSB7CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gIT09ICJ1IikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgcmVzdG9yZSA9IGluZGV4OwogICAgICAgICAgY2ggPSBzY2FuSGV4RXNjYXBlKCJ1Iik7CiAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgaWYgKGNoID09PSAiXFwiIHx8ICFpc0lkZW50aWZpZXJTdGFydChjaCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgPSBjaDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgaWQgPSAidSI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gc291cmNlW2luZGV4KytdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmICghaXNJZGVudGlmaWVyUGFydChjaCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2ggPT09ICJcXCIpIHsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gIT09ICJ1IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICByZXN0b3JlID0gaW5kZXg7CiAgICAgICAgICAgIGNoID0gc2NhbkhleEVzY2FwZSgidSIpOwogICAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcXCIgfHwgIWlzSWRlbnRpZmllclBhcnQoY2gpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkICs9IGNoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgICBpZCArPSAidSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlkICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlkLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uSWRlbnRpZmllciwKICAgICAgICAgICAgdmFsdWU6IGlkLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChpc0tleXdvcmQoaWQpKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5LZXl3b3JkLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGlkID09PSAibnVsbCIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLk51bGxMaXRlcmFsLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGlkID09PSAidHJ1ZSIgfHwgaWQgPT09ICJmYWxzZSIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLkJvb2xlYW5MaXRlcmFsLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFRva2VuLklkZW50aWZpZXIsCiAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhblB1bmN0dWF0b3IoKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gaW5kZXgsIGNoMSA9IHNvdXJjZVtpbmRleF0sIGNoMiwgY2gzLCBjaDQ7CiAgICAgICAgaWYgKGNoMSA9PT0gIjsiIHx8IGNoMSA9PT0gInsiIHx8IGNoMSA9PT0gIn0iKSB7CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6IGNoMSwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiLCIgfHwgY2gxID09PSAiKCIgfHwgY2gxID09PSAiKSIpIHsKICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogY2gxLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGNoMiA9IHNvdXJjZVtpbmRleCArIDFdOwogICAgICAgIGlmIChjaDEgPT09ICIuIiAmJiAhaXNEZWNpbWFsRGlnaXQoY2gyKSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6IHNvdXJjZVtpbmRleCsrXSwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjaDMgPSBzb3VyY2VbaW5kZXggKyAyXTsKICAgICAgICBjaDQgPSBzb3VyY2VbaW5kZXggKyAzXTsKICAgICAgICBpZiAoY2gxID09PSAiPiIgJiYgY2gyID09PSAiPiIgJiYgY2gzID09PSAiPiIpIHsKICAgICAgICAgIGlmIChjaDQgPT09ICI9IikgewogICAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgICAgdmFsdWU6ICI+Pj49IiwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaDEgPT09ICI9IiAmJiBjaDIgPT09ICI9IiAmJiBjaDMgPT09ICI9IikgewogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgIHZhbHVlOiAiPT09IiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiISIgJiYgY2gyID09PSAiPSIgJiYgY2gzID09PSAiPSIpIHsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogIiE9PSIsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoMSA9PT0gIj4iICYmIGNoMiA9PT0gIj4iICYmIGNoMyA9PT0gIj4iKSB7CiAgICAgICAgICBpbmRleCArPSAzOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6ICI+Pj4iLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChjaDEgPT09ICI8IiAmJiBjaDIgPT09ICI8IiAmJiBjaDMgPT09ICI9IikgewogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgIHZhbHVlOiAiPDw9IiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiPiIgJiYgY2gyID09PSAiPiIgJiYgY2gzID09PSAiPSIpIHsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogIj4+PSIsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoMiA9PT0gIj0iKSB7CiAgICAgICAgICBpZiAoIjw+PSErLSolJnxeLyIuaW5kZXhPZihjaDEpID49IDApIHsKICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICAgIHZhbHVlOiBjaDEgKyBjaDIsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSBjaDIgJiYgIistPD4mfCIuaW5kZXhPZihjaDEpID49IDApIHsKICAgICAgICAgIGlmICgiKy08PiZ8Ii5pbmRleE9mKGNoMikgPj0gMCkgewogICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgICAgdmFsdWU6IGNoMSArIGNoMiwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgiW108PistKiUmfF4hfj86PS8iLmluZGV4T2YoY2gxKSA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogc291cmNlW2luZGV4KytdLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNjYW5OdW1lcmljTGl0ZXJhbCgpIHsKICAgICAgICB2YXIgbnVtYmVyLCBzdGFydCwgY2g7CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGFzc2VydChpc0RlY2ltYWxEaWdpdChjaCkgfHwgY2ggPT09ICIuIiwgIk51bWVyaWMgbGl0ZXJhbCBtdXN0IHN0YXJ0IHdpdGggYSBkZWNpbWFsIGRpZ2l0IG9yIGEgZGVjaW1hbCBwb2ludCIpOwogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgbnVtYmVyID0gIiI7CiAgICAgICAgaWYgKGNoICE9PSAiLiIpIHsKICAgICAgICAgIG51bWJlciA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChudW1iZXIgPT09ICIwIikgewogICAgICAgICAgICBpZiAoY2ggPT09ICJ4IiB8fCBjaCA9PT0gIlgiKSB7CiAgICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICghaXNIZXhEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBudW1iZXIgKz0gc291cmNlW2luZGV4KytdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobnVtYmVyLmxlbmd0aCA8PSAyKSB7CiAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGlzSWRlbnRpZmllclN0YXJ0KGNoKSkgewogICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiBUb2tlbi5OdW1lcmljTGl0ZXJhbCwKICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJzZUludChudW1iZXIsIDE2KSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc09jdGFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICghaXNPY3RhbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGlzSWRlbnRpZmllclN0YXJ0KGNoKSB8fCBpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogVG9rZW4uTnVtZXJpY0xpdGVyYWwsCiAgICAgICAgICAgICAgICB2YWx1ZTogcGFyc2VJbnQobnVtYmVyLCA4KSwKICAgICAgICAgICAgICAgIG9jdGFsOiB0cnVlLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICAgIGlmICghaXNEZWNpbWFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGNoID09PSAiLiIpIHsKICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICBpZiAoIWlzRGVjaW1hbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaCA9PT0gImUiIHx8IGNoID09PSAiRSIpIHsKICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAoY2ggPT09ICIrIiB8fCBjaCA9PT0gIi0iKSB7CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAoaXNEZWNpbWFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoIWlzRGVjaW1hbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoID0gImNoYXJhY3RlciAiICsgY2g7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICBjaCA9ICI8ZW5kPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChpc0lkZW50aWZpZXJTdGFydChjaCkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogVG9rZW4uTnVtZXJpY0xpdGVyYWwsCiAgICAgICAgICB2YWx1ZTogcGFyc2VGbG9hdChudW1iZXIpLAogICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNjYW5TdHJpbmdMaXRlcmFsKCkgewogICAgICAgIHZhciBzdHIgPSAiIiwgcXVvdGUsIHN0YXJ0LCBjaCwgY29kZSwgdW5lc2NhcGVkLCByZXN0b3JlLCBvY3RhbCA9IGZhbHNlOwogICAgICAgIHF1b3RlID0gc291cmNlW2luZGV4XTsKICAgICAgICBhc3NlcnQocXVvdGUgPT09ICInIiB8fCBxdW90ZSA9PT0gJyInLCAiU3RyaW5nIGxpdGVyYWwgbXVzdCBzdGFydHMgd2l0aCBhIHF1b3RlIik7CiAgICAgICAgc3RhcnQgPSBpbmRleDsKICAgICAgICArK2luZGV4OwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBpZiAoY2ggPT09IHF1b3RlKSB7CiAgICAgICAgICAgIHF1b3RlID0gIiI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIlxcIikgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgaWYgKCFpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoY2gpIHsKICAgICAgICAgICAgICAgIGNhc2UgIm4iOgogICAgICAgICAgICAgICAgICBzdHIgKz0gIlxuIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyIjoKICAgICAgICAgICAgICAgICAgc3RyICs9ICJcciI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidCI6CiAgICAgICAgICAgICAgICAgIHN0ciArPSAiCSI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidSI6CiAgICAgICAgICAgICAgICBjYXNlICJ4IjoKICAgICAgICAgICAgICAgICAgcmVzdG9yZSA9IGluZGV4OwogICAgICAgICAgICAgICAgICB1bmVzY2FwZWQgPSBzY2FuSGV4RXNjYXBlKGNoKTsKICAgICAgICAgICAgICAgICAgaWYgKHVuZXNjYXBlZCkgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSB1bmVzY2FwZWQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSByZXN0b3JlOwogICAgICAgICAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImIiOgogICAgICAgICAgICAgICAgICBzdHIgKz0gIlxiIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJmIjoKICAgICAgICAgICAgICAgICAgc3RyICs9ICJcZiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidiI6CiAgICAgICAgICAgICAgICAgIHN0ciArPSAiCyI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgaWYgKGlzT2N0YWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgICBjb2RlID0gIjAxMjM0NTY3Ii5pbmRleE9mKGNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29kZSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgb2N0YWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGggJiYgaXNPY3RhbERpZ2l0KHNvdXJjZVtpbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICBvY3RhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZSAqIDggKyAiMDEyMzQ1NjciLmluZGV4T2Yoc291cmNlW2luZGV4KytdKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICgiMDEyMyIuaW5kZXhPZihjaCkgPj0gMCAmJiBpbmRleCA8IGxlbmd0aCAmJiBpc09jdGFsRGlnaXQoc291cmNlW2luZGV4XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUgKiA4ICsgIjAxMjM0NTY3Ii5pbmRleE9mKHNvdXJjZVtpbmRleCsrXSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXhdID09PSAiXG4iKSB7CiAgICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHF1b3RlICE9PSAiIikgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogVG9rZW4uU3RyaW5nTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiBzdHIsCiAgICAgICAgICBvY3RhbDogb2N0YWwsCiAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhblJlZ0V4cCgpIHsKICAgICAgICB2YXIgc3RyLCBjaCwgc3RhcnQsIHBhdHRlcm4sIGZsYWdzLCB2YWx1ZSwgY2xhc3NNYXJrZXIgPSBmYWxzZSwgcmVzdG9yZSwgdGVybWluYXRlZCA9IGZhbHNlOwogICAgICAgIGJ1ZmZlciA9IG51bGw7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBzdGFydCA9IGluZGV4OwogICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICBhc3NlcnQoY2ggPT09ICIvIiwgIlJlZ3VsYXIgZXhwcmVzc2lvbiBsaXRlcmFsIG11c3Qgc3RhcnQgd2l0aCBhIHNsYXNoIik7CiAgICAgICAgc3RyID0gc291cmNlW2luZGV4KytdOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBzdHIgKz0gY2g7CiAgICAgICAgICBpZiAoY2ggPT09ICJcXCIpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVudGVybWluYXRlZFJlZ0V4cCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RyICs9IGNoOwogICAgICAgICAgfSBlbHNlIGlmIChjbGFzc01hcmtlcikgewogICAgICAgICAgICBpZiAoY2ggPT09ICJdIikgewogICAgICAgICAgICAgIGNsYXNzTWFya2VyID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgdGVybWluYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICJbIikgewogICAgICAgICAgICAgIGNsYXNzTWFya2VyID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVudGVybWluYXRlZFJlZ0V4cCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0ZXJtaW5hdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbnRlcm1pbmF0ZWRSZWdFeHApOwogICAgICAgIH0KICAgICAgICBwYXR0ZXJuID0gc3RyLnN1YnN0cigxLCBzdHIubGVuZ3RoIC0gMik7CiAgICAgICAgZmxhZ3MgPSAiIjsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmICghaXNJZGVudGlmaWVyUGFydChjaCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgaWYgKGNoID09PSAiXFwiICYmIGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgaWYgKGNoID09PSAidSIpIHsKICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIHJlc3RvcmUgPSBpbmRleDsKICAgICAgICAgICAgICBjaCA9IHNjYW5IZXhFc2NhcGUoInUiKTsKICAgICAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgICAgIGZsYWdzICs9IGNoOwogICAgICAgICAgICAgICAgc3RyICs9ICJcXHUiOwogICAgICAgICAgICAgICAgZm9yICg7IHJlc3RvcmUgPCBpbmRleDsgKytyZXN0b3JlKSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBzb3VyY2VbcmVzdG9yZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgICAgIGZsYWdzICs9ICJ1IjsKICAgICAgICAgICAgICAgIHN0ciArPSAiXFx1IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyICs9ICJcXCI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZsYWdzICs9IGNoOwogICAgICAgICAgICBzdHIgKz0gY2g7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICB2YWx1ZSA9IG5ldyBSZWdFeHAocGF0dGVybiwgZmxhZ3MpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLkludmFsaWRSZWdFeHApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgbGl0ZXJhbDogc3RyLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzSWRlbnRpZmllck5hbWUodG9rZW4pIHsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllciB8fCB0b2tlbi50eXBlID09PSBUb2tlbi5LZXl3b3JkIHx8IHRva2VuLnR5cGUgPT09IFRva2VuLkJvb2xlYW5MaXRlcmFsIHx8IHRva2VuLnR5cGUgPT09IFRva2VuLk51bGxMaXRlcmFsOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkdmFuY2UoKSB7CiAgICAgICAgdmFyIGNoLCB0b2tlbjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLkVPRiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIGluZGV4LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB0b2tlbiA9IHNjYW5QdW5jdHVhdG9yKCk7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICB9CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGlmIChjaCA9PT0gIiciIHx8IGNoID09PSAnIicpIHsKICAgICAgICAgIHJldHVybiBzY2FuU3RyaW5nTGl0ZXJhbCgpOwogICAgICAgIH0KICAgICAgICBpZiAoY2ggPT09ICIuIiB8fCBpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgIHJldHVybiBzY2FuTnVtZXJpY0xpdGVyYWwoKTsKICAgICAgICB9CiAgICAgICAgdG9rZW4gPSBzY2FuSWRlbnRpZmllcigpOwogICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgfQogICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHRva2VuOwogICAgICAgIGlmIChidWZmZXIpIHsKICAgICAgICAgIGluZGV4ID0gYnVmZmVyLnJhbmdlWzFdOwogICAgICAgICAgbGluZU51bWJlciA9IGJ1ZmZlci5saW5lTnVtYmVyOwogICAgICAgICAgbGluZVN0YXJ0ID0gYnVmZmVyLmxpbmVTdGFydDsKICAgICAgICAgIHRva2VuID0gYnVmZmVyOwogICAgICAgICAgYnVmZmVyID0gbnVsbDsKICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICB9CiAgICAgICAgYnVmZmVyID0gbnVsbDsKICAgICAgICByZXR1cm4gYWR2YW5jZSgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvb2thaGVhZCgpIHsKICAgICAgICB2YXIgcG9zLCBsaW5lLCBzdGFydDsKICAgICAgICBpZiAoYnVmZmVyICE9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgICAgIH0KICAgICAgICBwb3MgPSBpbmRleDsKICAgICAgICBsaW5lID0gbGluZU51bWJlcjsKICAgICAgICBzdGFydCA9IGxpbmVTdGFydDsKICAgICAgICBidWZmZXIgPSBhZHZhbmNlKCk7CiAgICAgICAgaW5kZXggPSBwb3M7CiAgICAgICAgbGluZU51bWJlciA9IGxpbmU7CiAgICAgICAgbGluZVN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwZWVrTGluZVRlcm1pbmF0b3IoKSB7CiAgICAgICAgdmFyIHBvcywgbGluZSwgc3RhcnQsIGZvdW5kOwogICAgICAgIHBvcyA9IGluZGV4OwogICAgICAgIGxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgIHN0YXJ0ID0gbGluZVN0YXJ0OwogICAgICAgIHNraXBDb21tZW50KCk7CiAgICAgICAgZm91bmQgPSBsaW5lTnVtYmVyICE9PSBsaW5lOwogICAgICAgIGluZGV4ID0gcG9zOwogICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lOwogICAgICAgIGxpbmVTdGFydCA9IHN0YXJ0OwogICAgICAgIHJldHVybiBmb3VuZDsKICAgICAgfQogICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKHRva2VuLCBtZXNzYWdlRm9ybWF0KSB7CiAgICAgICAgdmFyIGVycm9yLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwgbXNnID0gbWVzc2FnZUZvcm1hdC5yZXBsYWNlKC8lKFxkKS9nLCBmdW5jdGlvbih3aG9sZSwgaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBhcmdzW2luZGV4XSB8fCAiIjsKICAgICAgICB9KTsKICAgICAgICBpZiAodHlwZW9mIHRva2VuLmxpbmVOdW1iZXIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcigiTGluZSAiICsgdG9rZW4ubGluZU51bWJlciArICI6ICIgKyBtc2cpOwogICAgICAgICAgZXJyb3IuaW5kZXggPSB0b2tlbi5yYW5nZVswXTsKICAgICAgICAgIGVycm9yLmxpbmVOdW1iZXIgPSB0b2tlbi5saW5lTnVtYmVyOwogICAgICAgICAgZXJyb3IuY29sdW1uID0gdG9rZW4ucmFuZ2VbMF0gLSBsaW5lU3RhcnQgKyAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcigiTGluZSAiICsgbGluZU51bWJlciArICI6ICIgKyBtc2cpOwogICAgICAgICAgZXJyb3IuaW5kZXggPSBpbmRleDsKICAgICAgICAgIGVycm9yLmxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyOwogICAgICAgICAgZXJyb3IuY29sdW1uID0gaW5kZXggLSBsaW5lU3RhcnQgKyAxOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yVG9sZXJhbnQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRocm93RXJyb3IuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoZXh0cmEuZXJyb3JzKSB7CiAgICAgICAgICAgIGV4dHJhLmVycm9ycy5wdXNoKGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdGhyb3dVbmV4cGVjdGVkKHRva2VuKSB7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRikgewogICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZEVPUyk7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5OdW1lcmljTGl0ZXJhbCkgewogICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZE51bWJlcik7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5TdHJpbmdMaXRlcmFsKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkU3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIHRocm93RXJyb3IodG9rZW4sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRJZGVudGlmaWVyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLktleXdvcmQpIHsKICAgICAgICAgIGlmIChpc0Z1dHVyZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZFJlc2VydmVkKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaWN0ICYmIGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvd0Vycm9yKHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sIHRva2VuLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCB0b2tlbi52YWx1ZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZXhwZWN0KHZhbHVlKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLlB1bmN0dWF0b3IgfHwgdG9rZW4udmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBleHBlY3RLZXl3b3JkKGtleXdvcmQpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsZXgoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uS2V5d29yZCB8fCB0b2tlbi52YWx1ZSAhPT0ga2V5d29yZCkgewogICAgICAgICAgdGhyb3dVbmV4cGVjdGVkKHRva2VuKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbWF0Y2godmFsdWUpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uUHVuY3R1YXRvciAmJiB0b2tlbi52YWx1ZSA9PT0gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbWF0Y2hLZXl3b3JkKGtleXdvcmQpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uS2V5d29yZCAmJiB0b2tlbi52YWx1ZSA9PT0ga2V5d29yZDsKICAgICAgfQogICAgICBmdW5jdGlvbiBtYXRjaEFzc2lnbigpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKSwgb3AgPSB0b2tlbi52YWx1ZTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uUHVuY3R1YXRvcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3AgPT09ICI9IiB8fCBvcCA9PT0gIio9IiB8fCBvcCA9PT0gIi89IiB8fCBvcCA9PT0gIiU9IiB8fCBvcCA9PT0gIis9IiB8fCBvcCA9PT0gIi09IiB8fCBvcCA9PT0gIjw8PSIgfHwgb3AgPT09ICI+Pj0iIHx8IG9wID09PSAiPj4+PSIgfHwgb3AgPT09ICImPSIgfHwgb3AgPT09ICJePSIgfHwgb3AgPT09ICJ8PSI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29uc3VtZVNlbWljb2xvbigpIHsKICAgICAgICB2YXIgdG9rZW4sIGxpbmU7CiAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gPT09ICI7IikgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgIHNraXBDb21tZW50KCk7CiAgICAgICAgaWYgKGxpbmVOdW1iZXIgIT09IGxpbmUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKCI7IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5FT0YgJiYgIW1hdGNoKCJ9IikpIHsKICAgICAgICAgIHRocm93VW5leHBlY3RlZCh0b2tlbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzTGVmdEhhbmRTaWRlKGV4cHIpIHsKICAgICAgICByZXR1cm4gZXhwci50eXBlID09PSBTeW50YXguSWRlbnRpZmllciB8fCBleHByLnR5cGUgPT09IFN5bnRheC5NZW1iZXJFeHByZXNzaW9uOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlQXJyYXlJbml0aWFsaXNlcigpIHsKICAgICAgICB2YXIgZWxlbWVudHMgPSBbXTsKICAgICAgICBleHBlY3QoIlsiKTsKICAgICAgICB3aGlsZSAoIW1hdGNoKCJdIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiLCIpKSB7CiAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICBlbGVtZW50cy5wdXNoKG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudHMucHVzaChwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCkpOwogICAgICAgICAgICBpZiAoIW1hdGNoKCJdIikpIHsKICAgICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHBlY3QoIl0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkFycmF5RXhwcmVzc2lvbiwKICAgICAgICAgIGVsZW1lbnRzOiBlbGVtZW50cwogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKHBhcmFtLCBmaXJzdCkgewogICAgICAgIHZhciBwcmV2aW91c1N0cmljdCwgYm9keTsKICAgICAgICBwcmV2aW91c1N0cmljdCA9IHN0cmljdDsKICAgICAgICBib2R5ID0gcGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzKCk7CiAgICAgICAgaWYgKGZpcnN0ICYmIHN0cmljdCAmJiBpc1Jlc3RyaWN0ZWRXb3JkKHBhcmFtWzBdLm5hbWUpKSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoZmlyc3QsIE1lc3NhZ2VzLlN0cmljdFBhcmFtTmFtZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25FeHByZXNzaW9uLAogICAgICAgICAgaWQ6IG51bGwsCiAgICAgICAgICBwYXJhbXM6IHBhcmFtLAogICAgICAgICAgZGVmYXVsdHM6IFtdLAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHJlc3Q6IG51bGwsCiAgICAgICAgICBnZW5lcmF0b3I6IGZhbHNlLAogICAgICAgICAgZXhwcmVzc2lvbjogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlT2JqZWN0UHJvcGVydHlLZXkoKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLlN0cmluZ0xpdGVyYWwgfHwgdG9rZW4udHlwZSA9PT0gVG9rZW4uTnVtZXJpY0xpdGVyYWwpIHsKICAgICAgICAgIGlmIChzdHJpY3QgJiYgdG9rZW4ub2N0YWwpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RPY3RhbExpdGVyYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICBuYW1lOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VPYmplY3RQcm9wZXJ0eSgpIHsKICAgICAgICB2YXIgdG9rZW4sIGtleSwgaWQsIHBhcmFtOwogICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIGlkID0gcGFyc2VPYmplY3RQcm9wZXJ0eUtleSgpOwogICAgICAgICAgaWYgKHRva2VuLnZhbHVlID09PSAiZ2V0IiAmJiAhbWF0Y2goIjoiKSkgewogICAgICAgICAgICBrZXkgPSBwYXJzZU9iamVjdFByb3BlcnR5S2V5KCk7CiAgICAgICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguUHJvcGVydHksCiAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgdmFsdWU6IHBhcnNlUHJvcGVydHlGdW5jdGlvbihbXSksCiAgICAgICAgICAgICAga2luZDogImdldCIKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udmFsdWUgPT09ICJzZXQiICYmICFtYXRjaCgiOiIpKSB7CiAgICAgICAgICAgIGtleSA9IHBhcnNlT2JqZWN0UHJvcGVydHlLZXkoKTsKICAgICAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sIHRva2VuLnZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlByb3BlcnR5LAogICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICB2YWx1ZTogcGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKFtdKSwKICAgICAgICAgICAgICAgIGtpbmQ6ICJzZXQiCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJhbSA9IFsgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKSBdOwogICAgICAgICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiBTeW50YXguUHJvcGVydHksCiAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJzZVByb3BlcnR5RnVuY3Rpb24ocGFyYW0sIHRva2VuKSwKICAgICAgICAgICAgICAgIGtpbmQ6ICJzZXQiCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlByb3BlcnR5LAogICAgICAgICAgICAgIGtleTogaWQsCiAgICAgICAgICAgICAgdmFsdWU6IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKSwKICAgICAgICAgICAgICBraW5kOiAiaW5pdCIKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRiB8fCB0b2tlbi50eXBlID09PSBUb2tlbi5QdW5jdHVhdG9yKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXkgPSBwYXJzZU9iamVjdFByb3BlcnR5S2V5KCk7CiAgICAgICAgICBleHBlY3QoIjoiKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Qcm9wZXJ0eSwKICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgIHZhbHVlOiBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCksCiAgICAgICAgICAgIGtpbmQ6ICJpbml0IgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VPYmplY3RJbml0aWFsaXNlcigpIHsKICAgICAgICB2YXIgcHJvcGVydGllcyA9IFtdLCBwcm9wZXJ0eSwgbmFtZSwga2luZCwgbWFwID0ge30sIHRvU3RyaW5nID0gU3RyaW5nOwogICAgICAgIGV4cGVjdCgieyIpOwogICAgICAgIHdoaWxlICghbWF0Y2goIn0iKSkgewogICAgICAgICAgcHJvcGVydHkgPSBwYXJzZU9iamVjdFByb3BlcnR5KCk7CiAgICAgICAgICBpZiAocHJvcGVydHkua2V5LnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgIG5hbWUgPSBwcm9wZXJ0eS5rZXkubmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSB0b1N0cmluZyhwcm9wZXJ0eS5rZXkudmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAga2luZCA9IHByb3BlcnR5LmtpbmQgPT09ICJpbml0IiA/IFByb3BlcnR5S2luZC5EYXRhIDogcHJvcGVydHkua2luZCA9PT0gImdldCIgPyBQcm9wZXJ0eUtpbmQuR2V0IDogUHJvcGVydHlLaW5kLlNldDsKICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobWFwLCBuYW1lKSkgewogICAgICAgICAgICBpZiAobWFwW25hbWVdID09PSBQcm9wZXJ0eUtpbmQuRGF0YSkgewogICAgICAgICAgICAgIGlmIChzdHJpY3QgJiYga2luZCA9PT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0RHVwbGljYXRlUHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2luZCAhPT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuQWNjZXNzb3JEYXRhUHJvcGVydHkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoa2luZCA9PT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuQWNjZXNzb3JEYXRhUHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwW25hbWVdICYga2luZCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHt9LCBNZXNzYWdlcy5BY2Nlc3NvckdldFNldCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcFtuYW1lXSB8PSBraW5kOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWFwW25hbWVdID0ga2luZDsKICAgICAgICAgIH0KICAgICAgICAgIHByb3BlcnRpZXMucHVzaChwcm9wZXJ0eSk7CiAgICAgICAgICBpZiAoIW1hdGNoKCJ9IikpIHsKICAgICAgICAgICAgZXhwZWN0KCIsIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgifSIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguT2JqZWN0RXhwcmVzc2lvbiwKICAgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlR3JvdXBFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVByaW1hcnlFeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiA9IGxvb2thaGVhZCgpLCB0eXBlID0gdG9rZW4udHlwZTsKICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllcikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICAgIG5hbWU6IGxleCgpLnZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uU3RyaW5nTGl0ZXJhbCB8fCB0eXBlID09PSBUb2tlbi5OdW1lcmljTGl0ZXJhbCkgewogICAgICAgICAgaWYgKHN0cmljdCAmJiB0b2tlbi5vY3RhbCkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQodG9rZW4sIE1lc3NhZ2VzLlN0cmljdE9jdGFsTGl0ZXJhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlTGl0ZXJhbChsZXgoKSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlID09PSBUb2tlbi5LZXl3b3JkKSB7CiAgICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJ0aGlzIikpIHsKICAgICAgICAgICAgbGV4KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlRoaXNFeHByZXNzaW9uCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIHJldHVybiBwYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uQm9vbGVhbkxpdGVyYWwpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdG9rZW4udmFsdWUgPSB0b2tlbi52YWx1ZSA9PT0gInRydWUiOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uTnVsbExpdGVyYWwpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdG9rZW4udmFsdWUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goIlsiKSkgewogICAgICAgICAgcmV0dXJuIHBhcnNlQXJyYXlJbml0aWFsaXNlcigpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goInsiKSkgewogICAgICAgICAgcmV0dXJuIHBhcnNlT2JqZWN0SW5pdGlhbGlzZXIoKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKCIoIikpIHsKICAgICAgICAgIHJldHVybiBwYXJzZUdyb3VwRXhwcmVzc2lvbigpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goIi8iKSB8fCBtYXRjaCgiLz0iKSkgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwoc2NhblJlZ0V4cCgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRocm93VW5leHBlY3RlZChsZXgoKSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VBcmd1bWVudHMoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBleHBlY3QoIigiKTsKICAgICAgICBpZiAoIW1hdGNoKCIpIikpIHsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICBhcmdzLnB1c2gocGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VOb25Db21wdXRlZFByb3BlcnR5KCkgewogICAgICAgIHZhciB0b2tlbiA9IGxleCgpOwogICAgICAgIGlmICghaXNJZGVudGlmaWVyTmFtZSh0b2tlbikpIHsKICAgICAgICAgIHRocm93VW5leHBlY3RlZCh0b2tlbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguSWRlbnRpZmllciwKICAgICAgICAgIG5hbWU6IHRva2VuLnZhbHVlCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZU5vbkNvbXB1dGVkTWVtYmVyKCkgewogICAgICAgIGV4cGVjdCgiLiIpOwogICAgICAgIHJldHVybiBwYXJzZU5vbkNvbXB1dGVkUHJvcGVydHkoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkgewogICAgICAgIHZhciBleHByOwogICAgICAgIGV4cGVjdCgiWyIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIl0iKTsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZU5ld0V4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHI7CiAgICAgICAgZXhwZWN0S2V5d29yZCgibmV3Iik7CiAgICAgICAgZXhwciA9IHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5OZXdFeHByZXNzaW9uLAogICAgICAgICAgY2FsbGVlOiBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24oKSwKICAgICAgICAgIGFyZ3VtZW50czogW10KICAgICAgICB9OwogICAgICAgIGlmIChtYXRjaCgiKCIpKSB7CiAgICAgICAgICBleHByWyJhcmd1bWVudHMiXSA9IHBhcnNlQXJndW1lbnRzKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTGVmdEhhbmRTaWRlRXhwcmVzc2lvbkFsbG93Q2FsbCgpIHsKICAgICAgICB2YXIgZXhwcjsKICAgICAgICBleHByID0gbWF0Y2hLZXl3b3JkKCJuZXciKSA/IHBhcnNlTmV3RXhwcmVzc2lvbigpIDogcGFyc2VQcmltYXJ5RXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiLiIpIHx8IG1hdGNoKCJbIikgfHwgbWF0Y2goIigiKSkgewogICAgICAgICAgaWYgKG1hdGNoKCIoIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguQ2FsbEV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY2FsbGVlOiBleHByLAogICAgICAgICAgICAgIGFyZ3VtZW50czogcGFyc2VBcmd1bWVudHMoKQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaCgiWyIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgb2JqZWN0OiBleHByLAogICAgICAgICAgICAgIHByb3BlcnR5OiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTGVmdEhhbmRTaWRlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwcjsKICAgICAgICBleHByID0gbWF0Y2hLZXl3b3JkKCJuZXciKSA/IHBhcnNlTmV3RXhwcmVzc2lvbigpIDogcGFyc2VQcmltYXJ5RXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiLiIpIHx8IG1hdGNoKCJbIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiWyIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgb2JqZWN0OiBleHByLAogICAgICAgICAgICAgIHByb3BlcnR5OiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlUG9zdGZpeEV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwoKSwgdG9rZW47CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uUHVuY3R1YXRvcikgewogICAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgICAgfQogICAgICAgIGlmICgobWF0Y2goIisrIikgfHwgbWF0Y2goIi0tIikpICYmICFwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdExIU1Bvc3RmaXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0xlZnRIYW5kU2lkZShleHByKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLkludmFsaWRMSFNJbkFzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlVwZGF0ZUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgYXJndW1lbnQ6IGV4cHIsCiAgICAgICAgICAgIHByZWZpeDogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlVW5hcnlFeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiwgZXhwcjsKICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5QdW5jdHVhdG9yICYmIHRva2VuLnR5cGUgIT09IFRva2VuLktleXdvcmQpIHsKICAgICAgICAgIHJldHVybiBwYXJzZVBvc3RmaXhFeHByZXNzaW9uKCk7CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaCgiKysiKSB8fCBtYXRjaCgiLS0iKSkgewogICAgICAgICAgdG9rZW4gPSBsZXgoKTsKICAgICAgICAgIGV4cHIgPSBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpOwogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdExIU1ByZWZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzTGVmdEhhbmRTaWRlKGV4cHIpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSW52YWxpZExIU0luQXNzaWdubWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguVXBkYXRlRXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IHRva2VuLnZhbHVlLAogICAgICAgICAgICBhcmd1bWVudDogZXhwciwKICAgICAgICAgICAgcHJlZml4OiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaCgiKyIpIHx8IG1hdGNoKCItIikgfHwgbWF0Y2goIn4iKSB8fCBtYXRjaCgiISIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguVW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGFyZ3VtZW50OiBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpLAogICAgICAgICAgICBwcmVmaXg6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiZGVsZXRlIikgfHwgbWF0Y2hLZXl3b3JkKCJ2b2lkIikgfHwgbWF0Y2hLZXl3b3JkKCJ0eXBlb2YiKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlVuYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBhcmd1bWVudDogcGFyc2VVbmFyeUV4cHJlc3Npb24oKSwKICAgICAgICAgICAgcHJlZml4OiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLm9wZXJhdG9yID09PSAiZGVsZXRlIiAmJiBleHByLmFyZ3VtZW50LnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0RGVsZXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHByOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyc2VQb3N0Zml4RXhwcmVzc2lvbigpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VVbmFyeUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIioiKSB8fCBtYXRjaCgiLyIpIHx8IG1hdGNoKCIlIikpIHsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5CaW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUFkZGl0aXZlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCIrIikgfHwgbWF0Y2goIi0iKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU2hpZnRFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIjw8IikgfHwgbWF0Y2goIj4+IikgfHwgbWF0Y2goIj4+PiIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQmluYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciwgcHJldmlvdXNBbGxvd0luOwogICAgICAgIHByZXZpb3VzQWxsb3dJbiA9IHN0YXRlLmFsbG93SW47CiAgICAgICAgc3RhdGUuYWxsb3dJbiA9IHRydWU7CiAgICAgICAgZXhwciA9IHBhcnNlU2hpZnRFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCI8IikgfHwgbWF0Y2goIj4iKSB8fCBtYXRjaCgiPD0iKSB8fCBtYXRjaCgiPj0iKSB8fCBwcmV2aW91c0FsbG93SW4gJiYgbWF0Y2hLZXl3b3JkKCJpbiIpIHx8IG1hdGNoS2V5d29yZCgiaW5zdGFuY2VvZiIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQmluYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VTaGlmdEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgc3RhdGUuYWxsb3dJbiA9IHByZXZpb3VzQWxsb3dJbjsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIj09IikgfHwgbWF0Y2goIiE9IikgfHwgbWF0Y2goIj09PSIpIHx8IG1hdGNoKCIhPT0iKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlRXF1YWxpdHlFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCImIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiAiJiIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiXiIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5CaW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogIl4iLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCJ8IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiAifCIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIiYmIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkxvZ2ljYWxFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogIiYmIiwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCJ8fCIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Mb2dpY2FsRXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6ICJ8fCIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlQ29uZGl0aW9uYWxFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByLCBwcmV2aW91c0FsbG93SW4sIGNvbnNlcXVlbnQ7CiAgICAgICAgZXhwciA9IHBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbigpOwogICAgICAgIGlmIChtYXRjaCgiPyIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIHByZXZpb3VzQWxsb3dJbiA9IHN0YXRlLmFsbG93SW47CiAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gdHJ1ZTsKICAgICAgICAgIGNvbnNlcXVlbnQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gcHJldmlvdXNBbGxvd0luOwogICAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQ29uZGl0aW9uYWxFeHByZXNzaW9uLAogICAgICAgICAgICB0ZXN0OiBleHByLAogICAgICAgICAgICBjb25zZXF1ZW50OiBjb25zZXF1ZW50LAogICAgICAgICAgICBhbHRlcm5hdGU6IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgdG9rZW4sIGV4cHI7CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBleHByID0gcGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24oKTsKICAgICAgICBpZiAobWF0Y2hBc3NpZ24oKSkgewogICAgICAgICAgaWYgKCFpc0xlZnRIYW5kU2lkZShleHByKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLkludmFsaWRMSFNJbkFzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQodG9rZW4sIE1lc3NhZ2VzLlN0cmljdExIU0Fzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkFzc2lnbm1lbnRFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKTsKICAgICAgICBpZiAobWF0Y2goIiwiKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlNlcXVlbmNlRXhwcmVzc2lvbiwKICAgICAgICAgICAgZXhwcmVzc2lvbnM6IFsgZXhwciBdCiAgICAgICAgICB9OwogICAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICghbWF0Y2goIiwiKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICBleHByLmV4cHJlc3Npb25zLnB1c2gocGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTdGF0ZW1lbnRMaXN0KCkgewogICAgICAgIHZhciBsaXN0ID0gW10sIHN0YXRlbWVudDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGVtZW50ID0gcGFyc2VTb3VyY2VFbGVtZW50KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlbWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBsaXN0LnB1c2goc3RhdGVtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCbG9jaygpIHsKICAgICAgICB2YXIgYmxvY2s7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgYmxvY2sgPSBwYXJzZVN0YXRlbWVudExpc3QoKTsKICAgICAgICBleHBlY3QoIn0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkJsb2NrU3RhdGVtZW50LAogICAgICAgICAgYm9keTogYmxvY2sKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCkgewogICAgICAgIHZhciB0b2tlbiA9IGxleCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5JZGVudGlmaWVyKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICBuYW1lOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uKGtpbmQpIHsKICAgICAgICB2YXIgaWQgPSBwYXJzZVZhcmlhYmxlSWRlbnRpZmllcigpLCBpbml0ID0gbnVsbDsKICAgICAgICBpZiAoc3RyaWN0ICYmIGlzUmVzdHJpY3RlZFdvcmQoaWQubmFtZSkpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0VmFyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGlmIChraW5kID09PSAiY29uc3QiKSB7CiAgICAgICAgICBleHBlY3QoIj0iKTsKICAgICAgICAgIGluaXQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaCgiPSIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGluaXQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguVmFyaWFibGVEZWNsYXJhdG9yLAogICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgaW5pdDogaW5pdAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uTGlzdChraW5kKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICBkbyB7CiAgICAgICAgICBsaXN0LnB1c2gocGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uKGtpbmQpKTsKICAgICAgICAgIGlmICghbWF0Y2goIiwiKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGxleCgpOwogICAgICAgIH0gd2hpbGUgKGluZGV4IDwgbGVuZ3RoKTsKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVZhcmlhYmxlU3RhdGVtZW50KCkgewogICAgICAgIHZhciBkZWNsYXJhdGlvbnM7CiAgICAgICAgZXhwZWN0S2V5d29yZCgidmFyIik7CiAgICAgICAgZGVjbGFyYXRpb25zID0gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uTGlzdCgpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlZhcmlhYmxlRGVjbGFyYXRpb24sCiAgICAgICAgICBkZWNsYXJhdGlvbnM6IGRlY2xhcmF0aW9ucywKICAgICAgICAgIGtpbmQ6ICJ2YXIiCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbnN0TGV0RGVjbGFyYXRpb24oa2luZCkgewogICAgICAgIHZhciBkZWNsYXJhdGlvbnM7CiAgICAgICAgZXhwZWN0S2V5d29yZChraW5kKTsKICAgICAgICBkZWNsYXJhdGlvbnMgPSBwYXJzZVZhcmlhYmxlRGVjbGFyYXRpb25MaXN0KGtpbmQpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlZhcmlhYmxlRGVjbGFyYXRpb24sCiAgICAgICAgICBkZWNsYXJhdGlvbnM6IGRlY2xhcmF0aW9ucywKICAgICAgICAgIGtpbmQ6IGtpbmQKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRW1wdHlTdGF0ZW1lbnQoKSB7CiAgICAgICAgZXhwZWN0KCI7Iik7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5FbXB0eVN0YXRlbWVudAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VFeHByZXNzaW9uU3RhdGVtZW50KCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRXhwcmVzc2lvblN0YXRlbWVudCwKICAgICAgICAgIGV4cHJlc3Npb246IGV4cHIKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlSWZTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIHRlc3QsIGNvbnNlcXVlbnQsIGFsdGVybmF0ZTsKICAgICAgICBleHBlY3RLZXl3b3JkKCJpZiIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIHRlc3QgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICBjb25zZXF1ZW50ID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJlbHNlIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgYWx0ZXJuYXRlID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5JZlN0YXRlbWVudCwKICAgICAgICAgIHRlc3Q6IHRlc3QsCiAgICAgICAgICBjb25zZXF1ZW50OiBjb25zZXF1ZW50LAogICAgICAgICAgYWx0ZXJuYXRlOiBhbHRlcm5hdGUKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRG9XaGlsZVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgYm9keSwgdGVzdCwgb2xkSW5JdGVyYXRpb247CiAgICAgICAgZXhwZWN0S2V5d29yZCgiZG8iKTsKICAgICAgICBvbGRJbkl0ZXJhdGlvbiA9IHN0YXRlLmluSXRlcmF0aW9uOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gdHJ1ZTsKICAgICAgICBib2R5ID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICBzdGF0ZS5pbkl0ZXJhdGlvbiA9IG9sZEluSXRlcmF0aW9uOwogICAgICAgIGV4cGVjdEtleXdvcmQoIndoaWxlIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIGlmIChtYXRjaCgiOyIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Eb1doaWxlU3RhdGVtZW50LAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHRlc3Q6IHRlc3QKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlV2hpbGVTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIHRlc3QsIGJvZHksIG9sZEluSXRlcmF0aW9uOwogICAgICAgIGV4cGVjdEtleXdvcmQoIndoaWxlIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSB0cnVlOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gb2xkSW5JdGVyYXRpb247CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5XaGlsZVN0YXRlbWVudCwKICAgICAgICAgIHRlc3Q6IHRlc3QsCiAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24oKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5WYXJpYWJsZURlY2xhcmF0aW9uLAogICAgICAgICAgZGVjbGFyYXRpb25zOiBwYXJzZVZhcmlhYmxlRGVjbGFyYXRpb25MaXN0KCksCiAgICAgICAgICBraW5kOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VGb3JTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIGluaXQsIHRlc3QsIHVwZGF0ZSwgbGVmdCwgcmlnaHQsIGJvZHksIG9sZEluSXRlcmF0aW9uOwogICAgICAgIGluaXQgPSB0ZXN0ID0gdXBkYXRlID0gbnVsbDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJmb3IiKTsKICAgICAgICBleHBlY3QoIigiKTsKICAgICAgICBpZiAobWF0Y2goIjsiKSkgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChtYXRjaEtleXdvcmQoInZhciIpIHx8IG1hdGNoS2V5d29yZCgibGV0IikpIHsKICAgICAgICAgICAgc3RhdGUuYWxsb3dJbiA9IGZhbHNlOwogICAgICAgICAgICBpbml0ID0gcGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uKCk7CiAgICAgICAgICAgIHN0YXRlLmFsbG93SW4gPSB0cnVlOwogICAgICAgICAgICBpZiAoaW5pdC5kZWNsYXJhdGlvbnMubGVuZ3RoID09PSAxICYmIG1hdGNoS2V5d29yZCgiaW4iKSkgewogICAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICAgIGxlZnQgPSBpbml0OwogICAgICAgICAgICAgIHJpZ2h0ID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgaW5pdCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLmFsbG93SW4gPSBmYWxzZTsKICAgICAgICAgICAgaW5pdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiaW4iKSkgewogICAgICAgICAgICAgIGlmICghaXNMZWZ0SGFuZFNpZGUoaW5pdCkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSW52YWxpZExIU0luRm9ySW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsZXgoKTsKICAgICAgICAgICAgICBsZWZ0ID0gaW5pdDsKICAgICAgICAgICAgICByaWdodCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICAgIGluaXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGV4cGVjdCgiOyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICBpZiAoIW1hdGNoKCI7IikpIHsKICAgICAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgfQogICAgICAgICAgZXhwZWN0KCI7Iik7CiAgICAgICAgICBpZiAoIW1hdGNoKCIpIikpIHsKICAgICAgICAgICAgdXBkYXRlID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSB0cnVlOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gb2xkSW5JdGVyYXRpb247CiAgICAgICAgaWYgKHR5cGVvZiBsZWZ0ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkZvclN0YXRlbWVudCwKICAgICAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICAgICAgdGVzdDogdGVzdCwKICAgICAgICAgICAgdXBkYXRlOiB1cGRhdGUsCiAgICAgICAgICAgIGJvZHk6IGJvZHkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRm9ySW5TdGF0ZW1lbnQsCiAgICAgICAgICBsZWZ0OiBsZWZ0LAogICAgICAgICAgcmlnaHQ6IHJpZ2h0LAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIGVhY2g6IGZhbHNlCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbnRpbnVlU3RhdGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiwgbGFiZWwgPSBudWxsOwogICAgICAgIGV4cGVjdEtleXdvcmQoImNvbnRpbnVlIik7CiAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gPT09ICI7IikgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICBpZiAoIXN0YXRlLmluSXRlcmF0aW9uKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxDb250aW51ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQ29udGludWVTdGF0ZW1lbnQsCiAgICAgICAgICAgIGxhYmVsOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAocGVla0xpbmVUZXJtaW5hdG9yKCkpIHsKICAgICAgICAgIGlmICghc3RhdGUuaW5JdGVyYXRpb24pIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuSWxsZWdhbENvbnRpbnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Db250aW51ZVN0YXRlbWVudCwKICAgICAgICAgICAgbGFiZWw6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIGxhYmVsID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN0YXRlLmxhYmVsU2V0LCBsYWJlbC5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5Vbmtub3duTGFiZWwsIGxhYmVsLm5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdW1lU2VtaWNvbG9uKCk7CiAgICAgICAgaWYgKGxhYmVsID09PSBudWxsICYmICFzdGF0ZS5pbkl0ZXJhdGlvbikgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuSWxsZWdhbENvbnRpbnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Db250aW51ZVN0YXRlbWVudCwKICAgICAgICAgIGxhYmVsOiBsYWJlbAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCcmVha1N0YXRlbWVudCgpIHsKICAgICAgICB2YXIgdG9rZW4sIGxhYmVsID0gbnVsbDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJicmVhayIpOwogICAgICAgIGlmIChzb3VyY2VbaW5kZXhdID09PSAiOyIpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgaWYgKCEoc3RhdGUuaW5JdGVyYXRpb24gfHwgc3RhdGUuaW5Td2l0Y2gpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxCcmVhayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQnJlYWtTdGF0ZW1lbnQsCiAgICAgICAgICAgIGxhYmVsOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAocGVla0xpbmVUZXJtaW5hdG9yKCkpIHsKICAgICAgICAgIGlmICghKHN0YXRlLmluSXRlcmF0aW9uIHx8IHN0YXRlLmluU3dpdGNoKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5JbGxlZ2FsQnJlYWspOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJyZWFrU3RhdGVtZW50LAogICAgICAgICAgICBsYWJlbDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllcikgewogICAgICAgICAgbGFiZWwgPSBwYXJzZVZhcmlhYmxlSWRlbnRpZmllcigpOwogICAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RhdGUubGFiZWxTZXQsIGxhYmVsLm5hbWUpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVua25vd25MYWJlbCwgbGFiZWwubmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICBpZiAobGFiZWwgPT09IG51bGwgJiYgIShzdGF0ZS5pbkl0ZXJhdGlvbiB8fCBzdGF0ZS5pblN3aXRjaCkpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxCcmVhayk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguQnJlYWtTdGF0ZW1lbnQsCiAgICAgICAgICBsYWJlbDogbGFiZWwKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlUmV0dXJuU3RhdGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiwgYXJndW1lbnQgPSBudWxsOwogICAgICAgIGV4cGVjdEtleXdvcmQoInJldHVybiIpOwogICAgICAgIGlmICghc3RhdGUuaW5GdW5jdGlvbkJvZHkpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSWxsZWdhbFJldHVybik7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2VbaW5kZXhdID09PSAiICIpIHsKICAgICAgICAgIGlmIChpc0lkZW50aWZpZXJTdGFydChzb3VyY2VbaW5kZXggKyAxXSkpIHsKICAgICAgICAgICAgYXJndW1lbnQgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFN5bnRheC5SZXR1cm5TdGF0ZW1lbnQsCiAgICAgICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlJldHVyblN0YXRlbWVudCwKICAgICAgICAgICAgYXJndW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmICghbWF0Y2goIjsiKSkgewogICAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICAgIGlmICghbWF0Y2goIn0iKSAmJiB0b2tlbi50eXBlICE9PSBUb2tlbi5FT0YpIHsKICAgICAgICAgICAgYXJndW1lbnQgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguUmV0dXJuU3RhdGVtZW50LAogICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVdpdGhTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIG9iamVjdCwgYm9keTsKICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdE1vZGVXaXRoKTsKICAgICAgICB9CiAgICAgICAgZXhwZWN0S2V5d29yZCgid2l0aCIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIG9iamVjdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguV2l0aFN0YXRlbWVudCwKICAgICAgICAgIG9iamVjdDogb2JqZWN0LAogICAgICAgICAgYm9keTogYm9keQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTd2l0Y2hDYXNlKCkgewogICAgICAgIHZhciB0ZXN0LCBjb25zZXF1ZW50ID0gW10sIHN0YXRlbWVudDsKICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJkZWZhdWx0IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdGVzdCA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4cGVjdEtleXdvcmQoImNhc2UiKTsKICAgICAgICAgIHRlc3QgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICB9CiAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAobWF0Y2goIn0iKSB8fCBtYXRjaEtleXdvcmQoImRlZmF1bHQiKSB8fCBtYXRjaEtleXdvcmQoImNhc2UiKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlbWVudCA9IHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlbWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zZXF1ZW50LnB1c2goc3RhdGVtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Td2l0Y2hDYXNlLAogICAgICAgICAgdGVzdDogdGVzdCwKICAgICAgICAgIGNvbnNlcXVlbnQ6IGNvbnNlcXVlbnQKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU3dpdGNoU3RhdGVtZW50KCkgewogICAgICAgIHZhciBkaXNjcmltaW5hbnQsIGNhc2VzLCBjbGF1c2UsIG9sZEluU3dpdGNoLCBkZWZhdWx0Rm91bmQ7CiAgICAgICAgZXhwZWN0S2V5d29yZCgic3dpdGNoIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgZGlzY3JpbWluYW50ID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgY2FzZXMgPSBbXTsKICAgICAgICBpZiAobWF0Y2goIn0iKSkgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguU3dpdGNoU3RhdGVtZW50LAogICAgICAgICAgICBkaXNjcmltaW5hbnQ6IGRpc2NyaW1pbmFudCwKICAgICAgICAgICAgY2FzZXM6IGNhc2VzCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBvbGRJblN3aXRjaCA9IHN0YXRlLmluU3dpdGNoOwogICAgICAgIHN0YXRlLmluU3dpdGNoID0gdHJ1ZTsKICAgICAgICBkZWZhdWx0Rm91bmQgPSBmYWxzZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2xhdXNlID0gcGFyc2VTd2l0Y2hDYXNlKCk7CiAgICAgICAgICBpZiAoY2xhdXNlLnRlc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGRlZmF1bHRGb3VuZCkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLk11bHRpcGxlRGVmYXVsdHNJblN3aXRjaCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdEZvdW5kID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2VzLnB1c2goY2xhdXNlKTsKICAgICAgICB9CiAgICAgICAgc3RhdGUuaW5Td2l0Y2ggPSBvbGRJblN3aXRjaDsKICAgICAgICBleHBlY3QoIn0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlN3aXRjaFN0YXRlbWVudCwKICAgICAgICAgIGRpc2NyaW1pbmFudDogZGlzY3JpbWluYW50LAogICAgICAgICAgY2FzZXM6IGNhc2VzCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVRocm93U3RhdGVtZW50KCkgewogICAgICAgIHZhciBhcmd1bWVudDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJ0aHJvdyIpOwogICAgICAgIGlmIChwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuTmV3bGluZUFmdGVyVGhyb3cpOwogICAgICAgIH0KICAgICAgICBhcmd1bWVudCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlRocm93U3RhdGVtZW50LAogICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNhdGNoQ2xhdXNlKCkgewogICAgICAgIHZhciBwYXJhbTsKICAgICAgICBleHBlY3RLZXl3b3JkKCJjYXRjaCIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmIChtYXRjaCgiKSIpKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQobG9va2FoZWFkKCkpOwogICAgICAgIH0KICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgaWYgKHN0cmljdCAmJiBpc1Jlc3RyaWN0ZWRXb3JkKHBhcmFtLm5hbWUpKSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdENhdGNoVmFyaWFibGUpOwogICAgICAgIH0KICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkNhdGNoQ2xhdXNlLAogICAgICAgICAgcGFyYW06IHBhcmFtLAogICAgICAgICAgYm9keTogcGFyc2VCbG9jaygpCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVRyeVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgYmxvY2ssIGhhbmRsZXJzID0gW10sIGZpbmFsaXplciA9IG51bGw7CiAgICAgICAgZXhwZWN0S2V5d29yZCgidHJ5Iik7CiAgICAgICAgYmxvY2sgPSBwYXJzZUJsb2NrKCk7CiAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiY2F0Y2giKSkgewogICAgICAgICAgaGFuZGxlcnMucHVzaChwYXJzZUNhdGNoQ2xhdXNlKCkpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJmaW5hbGx5IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZmluYWxpemVyID0gcGFyc2VCbG9jaygpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFuZGxlcnMubGVuZ3RoID09PSAwICYmICFmaW5hbGl6ZXIpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLk5vQ2F0Y2hPckZpbmFsbHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlRyeVN0YXRlbWVudCwKICAgICAgICAgIGJsb2NrOiBibG9jaywKICAgICAgICAgIGd1YXJkZWRIYW5kbGVyczogW10sCiAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMsCiAgICAgICAgICBmaW5hbGl6ZXI6IGZpbmFsaXplcgogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VEZWJ1Z2dlclN0YXRlbWVudCgpIHsKICAgICAgICBleHBlY3RLZXl3b3JkKCJkZWJ1Z2dlciIpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkRlYnVnZ2VyU3RhdGVtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKSwgZXhwciwgbGFiZWxlZEJvZHk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRikgewogICAgICAgICAgdGhyb3dVbmV4cGVjdGVkKHRva2VuKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLlB1bmN0dWF0b3IpIHsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiOyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRW1wdHlTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAieyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlQmxvY2soKTsKICAgICAgICAgICAgY2FzZSAiKCI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRXhwcmVzc2lvblN0YXRlbWVudCgpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW4uS2V5d29yZCkgewogICAgICAgICAgc3dpdGNoICh0b2tlbi52YWx1ZSkgewogICAgICAgICAgICBjYXNlICJicmVhayI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlQnJlYWtTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAiY29udGludWUiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUNvbnRpbnVlU3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgImRlYnVnZ2VyIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VEZWJ1Z2dlclN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJkbyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRG9XaGlsZVN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJmb3IiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUZvclN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRnVuY3Rpb25EZWNsYXJhdGlvbigpOwogICAgICAgICAgICBjYXNlICJpZiI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlSWZTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAicmV0dXJuIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VSZXR1cm5TdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAic3dpdGNoIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VTd2l0Y2hTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAidGhyb3ciOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVRocm93U3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgInRyeSI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVHJ5U3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgInZhciI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVmFyaWFibGVTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAid2hpbGUiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVdoaWxlU3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgIndpdGgiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVdpdGhTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwciA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGlmIChleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIG1hdGNoKCI6IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdGF0ZS5sYWJlbFNldCwgZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5SZWRlY2xhcmF0aW9uLCAiTGFiZWwiLCBleHByLm5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUubGFiZWxTZXRbZXhwci5uYW1lXSA9IHRydWU7CiAgICAgICAgICBsYWJlbGVkQm9keSA9IHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgICBkZWxldGUgc3RhdGUubGFiZWxTZXRbZXhwci5uYW1lXTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5MYWJlbGVkU3RhdGVtZW50LAogICAgICAgICAgICBsYWJlbDogZXhwciwKICAgICAgICAgICAgYm9keTogbGFiZWxlZEJvZHkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkV4cHJlc3Npb25TdGF0ZW1lbnQsCiAgICAgICAgICBleHByZXNzaW9uOiBleHByCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMoKSB7CiAgICAgICAgdmFyIHNvdXJjZUVsZW1lbnQsIHNvdXJjZUVsZW1lbnRzID0gW10sIHRva2VuLCBkaXJlY3RpdmUsIGZpcnN0UmVzdHJpY3RlZCwgb2xkTGFiZWxTZXQsIG9sZEluSXRlcmF0aW9uLCBvbGRJblN3aXRjaCwgb2xkSW5GdW5jdGlvbkJvZHk7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLlN0cmluZ0xpdGVyYWwpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBzb3VyY2VFbGVtZW50ID0gcGFyc2VTb3VyY2VFbGVtZW50KCk7CiAgICAgICAgICBzb3VyY2VFbGVtZW50cy5wdXNoKHNvdXJjZUVsZW1lbnQpOwogICAgICAgICAgaWYgKHNvdXJjZUVsZW1lbnQuZXhwcmVzc2lvbi50eXBlICE9PSBTeW50YXguTGl0ZXJhbCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGRpcmVjdGl2ZSA9IHNsaWNlU291cmNlKHRva2VuLnJhbmdlWzBdICsgMSwgdG9rZW4ucmFuZ2VbMV0gLSAxKTsKICAgICAgICAgIGlmIChkaXJlY3RpdmUgPT09ICJ1c2Ugc3RyaWN0IikgewogICAgICAgICAgICBzdHJpY3QgPSB0cnVlOwogICAgICAgICAgICBpZiAoZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KGZpcnN0UmVzdHJpY3RlZCwgTWVzc2FnZXMuU3RyaWN0T2N0YWxMaXRlcmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFmaXJzdFJlc3RyaWN0ZWQgJiYgdG9rZW4ub2N0YWwpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvbGRMYWJlbFNldCA9IHN0YXRlLmxhYmVsU2V0OwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgb2xkSW5Td2l0Y2ggPSBzdGF0ZS5pblN3aXRjaDsKICAgICAgICBvbGRJbkZ1bmN0aW9uQm9keSA9IHN0YXRlLmluRnVuY3Rpb25Cb2R5OwogICAgICAgIHN0YXRlLmxhYmVsU2V0ID0ge307CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSBmYWxzZTsKICAgICAgICBzdGF0ZS5pblN3aXRjaCA9IGZhbHNlOwogICAgICAgIHN0YXRlLmluRnVuY3Rpb25Cb2R5ID0gdHJ1ZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgc291cmNlRWxlbWVudCA9IHBhcnNlU291cmNlRWxlbWVudCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VFbGVtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgifSIpOwogICAgICAgIHN0YXRlLmxhYmVsU2V0ID0gb2xkTGFiZWxTZXQ7CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSBvbGRJbkl0ZXJhdGlvbjsKICAgICAgICBzdGF0ZS5pblN3aXRjaCA9IG9sZEluU3dpdGNoOwogICAgICAgIHN0YXRlLmluRnVuY3Rpb25Cb2R5ID0gb2xkSW5GdW5jdGlvbkJvZHk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5CbG9ja1N0YXRlbWVudCwKICAgICAgICAgIGJvZHk6IHNvdXJjZUVsZW1lbnRzCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24oKSB7CiAgICAgICAgdmFyIGlkLCBwYXJhbSwgcGFyYW1zID0gW10sIGJvZHksIHRva2VuLCBzdHJpY3RlZCwgZmlyc3RSZXN0cmljdGVkLCBtZXNzYWdlLCBwcmV2aW91c1N0cmljdCwgcGFyYW1TZXQ7CiAgICAgICAgZXhwZWN0S2V5d29yZCgiZnVuY3Rpb24iKTsKICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlkID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmICghbWF0Y2goIikiKSkgewogICAgICAgICAgcGFyYW1TZXQgPSB7fTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1OYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtU2V0LCB0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RQYXJhbU5hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1TZXQsIHRva2VuLnZhbHVlKSkgewogICAgICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICAgIHBhcmFtU2V0W3BhcmFtLm5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcHJldmlvdXNTdHJpY3QgPSBzdHJpY3Q7CiAgICAgICAgYm9keSA9IHBhcnNlRnVuY3Rpb25Tb3VyY2VFbGVtZW50cygpOwogICAgICAgIGlmIChzdHJpY3QgJiYgZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKGZpcnN0UmVzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpY3QgJiYgc3RyaWN0ZWQpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudChzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25EZWNsYXJhdGlvbiwKICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgICAgZGVmYXVsdHM6IFtdLAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHJlc3Q6IG51bGwsCiAgICAgICAgICBnZW5lcmF0b3I6IGZhbHNlLAogICAgICAgICAgZXhwcmVzc2lvbjogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRnVuY3Rpb25FeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiwgaWQgPSBudWxsLCBzdHJpY3RlZCwgZmlyc3RSZXN0cmljdGVkLCBtZXNzYWdlLCBwYXJhbSwgcGFyYW1zID0gW10sIGJvZHksIHByZXZpb3VzU3RyaWN0LCBwYXJhbVNldDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJmdW5jdGlvbiIpOwogICAgICAgIGlmICghbWF0Y2goIigiKSkgewogICAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICAgIGlkID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0RnVuY3Rpb25OYW1lOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UmVzZXJ2ZWRXb3JkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmICghbWF0Y2goIikiKSkgewogICAgICAgICAgcGFyYW1TZXQgPSB7fTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1OYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtU2V0LCB0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RQYXJhbU5hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1TZXQsIHRva2VuLnZhbHVlKSkgewogICAgICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICAgIHBhcmFtU2V0W3BhcmFtLm5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcHJldmlvdXNTdHJpY3QgPSBzdHJpY3Q7CiAgICAgICAgYm9keSA9IHBhcnNlRnVuY3Rpb25Tb3VyY2VFbGVtZW50cygpOwogICAgICAgIGlmIChzdHJpY3QgJiYgZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKGZpcnN0UmVzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpY3QgJiYgc3RyaWN0ZWQpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudChzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25FeHByZXNzaW9uLAogICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICBkZWZhdWx0czogW10sCiAgICAgICAgICBib2R5OiBib2R5LAogICAgICAgICAgcmVzdDogbnVsbCwKICAgICAgICAgIGdlbmVyYXRvcjogZmFsc2UsCiAgICAgICAgICBleHByZXNzaW9uOiBmYWxzZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTb3VyY2VFbGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5LZXl3b3JkKSB7CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImNvbnN0IjoKICAgICAgICAgICAgY2FzZSAibGV0IjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VDb25zdExldERlY2xhcmF0aW9uKHRva2VuLnZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24oKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLkVPRikgewogICAgICAgICAgcmV0dXJuIHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU291cmNlRWxlbWVudHMoKSB7CiAgICAgICAgdmFyIHNvdXJjZUVsZW1lbnQsIHNvdXJjZUVsZW1lbnRzID0gW10sIHRva2VuLCBkaXJlY3RpdmUsIGZpcnN0UmVzdHJpY3RlZDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uU3RyaW5nTGl0ZXJhbCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnQgPSBwYXJzZVNvdXJjZUVsZW1lbnQoKTsKICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgICBpZiAoc291cmNlRWxlbWVudC5leHByZXNzaW9uLnR5cGUgIT09IFN5bnRheC5MaXRlcmFsKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgZGlyZWN0aXZlID0gc2xpY2VTb3VyY2UodG9rZW4ucmFuZ2VbMF0gKyAxLCB0b2tlbi5yYW5nZVsxXSAtIDEpOwogICAgICAgICAgaWYgKGRpcmVjdGl2ZSA9PT0gInVzZSBzdHJpY3QiKSB7CiAgICAgICAgICAgIHN0cmljdCA9IHRydWU7CiAgICAgICAgICAgIGlmIChmaXJzdFJlc3RyaWN0ZWQpIHsKICAgICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoZmlyc3RSZXN0cmljdGVkLCBNZXNzYWdlcy5TdHJpY3RPY3RhbExpdGVyYWwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWZpcnN0UmVzdHJpY3RlZCAmJiB0b2tlbi5vY3RhbCkgewogICAgICAgICAgICAgIGZpcnN0UmVzdHJpY3RlZCA9IHRva2VuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgc291cmNlRWxlbWVudCA9IHBhcnNlU291cmNlRWxlbWVudCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VFbGVtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzb3VyY2VFbGVtZW50czsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVByb2dyYW0oKSB7CiAgICAgICAgdmFyIHByb2dyYW07CiAgICAgICAgc3RyaWN0ID0gZmFsc2U7CiAgICAgICAgcHJvZ3JhbSA9IHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Qcm9ncmFtLAogICAgICAgICAgYm9keTogcGFyc2VTb3VyY2VFbGVtZW50cygpCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gcHJvZ3JhbTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRDb21tZW50KHR5cGUsIHZhbHVlLCBzdGFydCwgZW5kLCBsb2MpIHsKICAgICAgICBhc3NlcnQodHlwZW9mIHN0YXJ0ID09PSAibnVtYmVyIiwgIkNvbW1lbnQgbXVzdCBoYXZlIHZhbGlkIHBvc2l0aW9uIik7CiAgICAgICAgaWYgKGV4dHJhLmNvbW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGlmIChleHRyYS5jb21tZW50c1tleHRyYS5jb21tZW50cy5sZW5ndGggLSAxXS5yYW5nZVsxXSA+IHN0YXJ0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0cmEuY29tbWVudHMucHVzaCh7CiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGVuZCBdLAogICAgICAgICAgbG9jOiBsb2MKICAgICAgICB9KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzY2FuQ29tbWVudCgpIHsKICAgICAgICB2YXIgY29tbWVudCwgY2gsIGxvYywgc3RhcnQsIGJsb2NrQ29tbWVudCwgbGluZUNvbW1lbnQ7CiAgICAgICAgY29tbWVudCA9ICIiOwogICAgICAgIGJsb2NrQ29tbWVudCA9IGZhbHNlOwogICAgICAgIGxpbmVDb21tZW50ID0gZmFsc2U7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAobGluZUNvbW1lbnQpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydCAtIDEKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgYWRkQ29tbWVudCgiTGluZSIsIGNvbW1lbnQsIHN0YXJ0LCBpbmRleCAtIDEsIGxvYyk7CiAgICAgICAgICAgICAgaWYgKGNoID09PSAiXHIiICYmIHNvdXJjZVtpbmRleF0gPT09ICJcbiIpIHsKICAgICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICsrbGluZU51bWJlcjsKICAgICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBjb21tZW50ID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICBjb21tZW50ICs9IGNoOwogICAgICAgICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgY29sdW1uOiBsZW5ndGggLSBsaW5lU3RhcnQKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGFkZENvbW1lbnQoIkxpbmUiLCBjb21tZW50LCBzdGFydCwgbGVuZ3RoLCBsb2MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1lbnQgKz0gY2g7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tDb21tZW50KSB7CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXggKyAxXSA9PT0gIlxuIikgewogICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICAgIGNvbW1lbnQgKz0gIlxyXG4iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21tZW50ICs9IGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICArK2xpbmVOdW1iZXI7CiAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4KytdOwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWVudCArPSBjaDsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICIqIikgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgY29tbWVudCA9IGNvbW1lbnQuc3Vic3RyKDAsIGNvbW1lbnQubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrQ29tbWVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgICAgICBsb2MuZW5kID0gewogICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBhZGRDb21tZW50KCJCbG9jayIsIGNvbW1lbnQsIHN0YXJ0LCBpbmRleCwgbG9jKTsKICAgICAgICAgICAgICAgICAgY29tbWVudCA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4ICsgMV07CiAgICAgICAgICAgIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgbG9jID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBsb2MuZW5kID0gewogICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGFkZENvbW1lbnQoIkxpbmUiLCBjb21tZW50LCBzdGFydCwgaW5kZXgsIGxvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiKiIpIHsKICAgICAgICAgICAgICBzdGFydCA9IGluZGV4OwogICAgICAgICAgICAgIGluZGV4ICs9IDI7CiAgICAgICAgICAgICAgYmxvY2tDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2MgPSB7CiAgICAgICAgICAgICAgICBzdGFydDogewogICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0IC0gMgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc1doaXRlU3BhY2UoY2gpKSB7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzTGluZVRlcm1pbmF0b3IoY2gpKSB7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXhdID09PSAiXG4iKSB7CiAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2xpbmVOdW1iZXI7CiAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZpbHRlckNvbW1lbnRMb2NhdGlvbigpIHsKICAgICAgICB2YXIgaSwgZW50cnksIGNvbW1lbnQsIGNvbW1lbnRzID0gW107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV4dHJhLmNvbW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBlbnRyeSA9IGV4dHJhLmNvbW1lbnRzW2ldOwogICAgICAgICAgY29tbWVudCA9IHsKICAgICAgICAgICAgdHlwZTogZW50cnkudHlwZSwKICAgICAgICAgICAgdmFsdWU6IGVudHJ5LnZhbHVlCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGV4dHJhLnJhbmdlKSB7CiAgICAgICAgICAgIGNvbW1lbnQucmFuZ2UgPSBlbnRyeS5yYW5nZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRyYS5sb2MpIHsKICAgICAgICAgICAgY29tbWVudC5sb2MgPSBlbnRyeS5sb2M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21tZW50cy5wdXNoKGNvbW1lbnQpOwogICAgICAgIH0KICAgICAgICBleHRyYS5jb21tZW50cyA9IGNvbW1lbnRzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbGxlY3RUb2tlbigpIHsKICAgICAgICB2YXIgc3RhcnQsIGxvYywgdG9rZW4sIHJhbmdlLCB2YWx1ZTsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgbG9jID0gewogICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdG9rZW4gPSBleHRyYS5hZHZhbmNlKCk7CiAgICAgICAgbG9jLmVuZCA9IHsKICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0CiAgICAgICAgfTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uRU9GKSB7CiAgICAgICAgICByYW5nZSA9IFsgdG9rZW4ucmFuZ2VbMF0sIHRva2VuLnJhbmdlWzFdIF07CiAgICAgICAgICB2YWx1ZSA9IHNsaWNlU291cmNlKHRva2VuLnJhbmdlWzBdLCB0b2tlbi5yYW5nZVsxXSk7CiAgICAgICAgICBleHRyYS50b2tlbnMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6IFRva2VuTmFtZVt0b2tlbi50eXBlXSwKICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICByYW5nZTogcmFuZ2UsCiAgICAgICAgICAgIGxvYzogbG9jCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbGxlY3RSZWdleCgpIHsKICAgICAgICB2YXIgcG9zLCBsb2MsIHJlZ2V4LCB0b2tlbjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIHBvcyA9IGluZGV4OwogICAgICAgIGxvYyA9IHsKICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbHVtbjogaW5kZXggLSBsaW5lU3RhcnQKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlZ2V4ID0gZXh0cmEuc2NhblJlZ0V4cCgpOwogICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgIH07CiAgICAgICAgaWYgKGV4dHJhLnRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0b2tlbiA9IGV4dHJhLnRva2Vuc1tleHRyYS50b2tlbnMubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAodG9rZW4ucmFuZ2VbMF0gPT09IHBvcyAmJiB0b2tlbi50eXBlID09PSAiUHVuY3R1YXRvciIpIHsKICAgICAgICAgICAgaWYgKHRva2VuLnZhbHVlID09PSAiLyIgfHwgdG9rZW4udmFsdWUgPT09ICIvPSIpIHsKICAgICAgICAgICAgICBleHRyYS50b2tlbnMucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0cmEudG9rZW5zLnB1c2goewogICAgICAgICAgdHlwZTogIlJlZ3VsYXJFeHByZXNzaW9uIiwKICAgICAgICAgIHZhbHVlOiByZWdleC5saXRlcmFsLAogICAgICAgICAgcmFuZ2U6IFsgcG9zLCBpbmRleCBdLAogICAgICAgICAgbG9jOiBsb2MKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVnZXg7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZmlsdGVyVG9rZW5Mb2NhdGlvbigpIHsKICAgICAgICB2YXIgaSwgZW50cnksIHRva2VuLCB0b2tlbnMgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXh0cmEudG9rZW5zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBlbnRyeSA9IGV4dHJhLnRva2Vuc1tpXTsKICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICB0eXBlOiBlbnRyeS50eXBlLAogICAgICAgICAgICB2YWx1ZTogZW50cnkudmFsdWUKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UpIHsKICAgICAgICAgICAgdG9rZW4ucmFuZ2UgPSBlbnRyeS5yYW5nZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRyYS5sb2MpIHsKICAgICAgICAgICAgdG9rZW4ubG9jID0gZW50cnkubG9jOwogICAgICAgICAgfQogICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgIH0KICAgICAgICBleHRyYS50b2tlbnMgPSB0b2tlbnM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlTGl0ZXJhbCh0b2tlbikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlUmF3TGl0ZXJhbCh0b2tlbikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiB0b2tlbi52YWx1ZSwKICAgICAgICAgIHJhdzogc2xpY2VTb3VyY2UodG9rZW4ucmFuZ2VbMF0sIHRva2VuLnJhbmdlWzFdKQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlTG9jYXRpb25NYXJrZXIoKSB7CiAgICAgICAgdmFyIG1hcmtlciA9IHt9OwogICAgICAgIG1hcmtlci5yYW5nZSA9IFsgaW5kZXgsIGluZGV4IF07CiAgICAgICAgbWFya2VyLmxvYyA9IHsKICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbHVtbjogaW5kZXggLSBsaW5lU3RhcnQKICAgICAgICAgIH0sCiAgICAgICAgICBlbmQ6IHsKICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbWFya2VyLmVuZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yYW5nZVsxXSA9IGluZGV4OwogICAgICAgICAgdGhpcy5sb2MuZW5kLmxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgICAgdGhpcy5sb2MuZW5kLmNvbHVtbiA9IGluZGV4IC0gbGluZVN0YXJ0OwogICAgICAgIH07CiAgICAgICAgbWFya2VyLmFwcGx5R3JvdXAgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UpIHsKICAgICAgICAgICAgbm9kZS5ncm91cFJhbmdlID0gWyB0aGlzLnJhbmdlWzBdLCB0aGlzLnJhbmdlWzFdIF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEubG9jKSB7CiAgICAgICAgICAgIG5vZGUuZ3JvdXBMb2MgPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgIGxpbmU6IHRoaXMubG9jLnN0YXJ0LmxpbmUsCiAgICAgICAgICAgICAgICBjb2x1bW46IHRoaXMubG9jLnN0YXJ0LmNvbHVtbgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZW5kOiB7CiAgICAgICAgICAgICAgICBsaW5lOiB0aGlzLmxvYy5lbmQubGluZSwKICAgICAgICAgICAgICAgIGNvbHVtbjogdGhpcy5sb2MuZW5kLmNvbHVtbgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIG1hcmtlci5hcHBseSA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIGlmIChleHRyYS5yYW5nZSkgewogICAgICAgICAgICBub2RlLnJhbmdlID0gWyB0aGlzLnJhbmdlWzBdLCB0aGlzLnJhbmdlWzFdIF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEubG9jKSB7CiAgICAgICAgICAgIG5vZGUubG9jID0gewogICAgICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgICAgICBsaW5lOiB0aGlzLmxvYy5zdGFydC5saW5lLAogICAgICAgICAgICAgICAgY29sdW1uOiB0aGlzLmxvYy5zdGFydC5jb2x1bW4KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGVuZDogewogICAgICAgICAgICAgICAgbGluZTogdGhpcy5sb2MuZW5kLmxpbmUsCiAgICAgICAgICAgICAgICBjb2x1bW46IHRoaXMubG9jLmVuZC5jb2x1bW4KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbWFya2VyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRyYWNrR3JvdXBFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBtYXJrZXIsIGV4cHI7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBtYXJrZXIgPSBjcmVhdGVMb2NhdGlvbk1hcmtlcigpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgbWFya2VyLmFwcGx5R3JvdXAoZXhwcik7CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBtYXJrZXIsIGV4cHI7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBtYXJrZXIgPSBjcmVhdGVMb2NhdGlvbk1hcmtlcigpOwogICAgICAgIGV4cHIgPSBtYXRjaEtleXdvcmQoIm5ldyIpID8gcGFyc2VOZXdFeHByZXNzaW9uKCkgOiBwYXJzZVByaW1hcnlFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCIuIikgfHwgbWF0Y2goIlsiKSkgewogICAgICAgICAgaWYgKG1hdGNoKCJbIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguTWVtYmVyRXhwcmVzc2lvbiwKICAgICAgICAgICAgICBjb21wdXRlZDogdHJ1ZSwKICAgICAgICAgICAgICBvYmplY3Q6IGV4cHIsCiAgICAgICAgICAgICAgcHJvcGVydHk6IHBhcnNlQ29tcHV0ZWRNZW1iZXIoKQogICAgICAgICAgICB9OwogICAgICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgICAgIG1hcmtlci5hcHBseShleHByKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1hcmtlci5lbmQoKTsKICAgICAgICAgICAgbWFya2VyLmFwcGx5KGV4cHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0cmFja0xlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwoKSB7CiAgICAgICAgdmFyIG1hcmtlciwgZXhwcjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIG1hcmtlciA9IGNyZWF0ZUxvY2F0aW9uTWFya2VyKCk7CiAgICAgICAgZXhwciA9IG1hdGNoS2V5d29yZCgibmV3IikgPyBwYXJzZU5ld0V4cHJlc3Npb24oKSA6IHBhcnNlUHJpbWFyeUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIi4iKSB8fCBtYXRjaCgiWyIpIHx8IG1hdGNoKCIoIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiKCIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LkNhbGxFeHByZXNzaW9uLAogICAgICAgICAgICAgIGNhbGxlZTogZXhwciwKICAgICAgICAgICAgICBhcmd1bWVudHM6IHBhcnNlQXJndW1lbnRzKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbWFya2VyLmVuZCgpOwogICAgICAgICAgICBtYXJrZXIuYXBwbHkoZXhwcik7CiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoKCJbIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguTWVtYmVyRXhwcmVzc2lvbiwKICAgICAgICAgICAgICBjb21wdXRlZDogdHJ1ZSwKICAgICAgICAgICAgICBvYmplY3Q6IGV4cHIsCiAgICAgICAgICAgICAgcHJvcGVydHk6IHBhcnNlQ29tcHV0ZWRNZW1iZXIoKQogICAgICAgICAgICB9OwogICAgICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgICAgIG1hcmtlci5hcHBseShleHByKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1hcmtlci5lbmQoKTsKICAgICAgICAgICAgbWFya2VyLmFwcGx5KGV4cHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBmaWx0ZXJHcm91cChub2RlKSB7CiAgICAgICAgdmFyIG4sIGksIGVudHJ5OwogICAgICAgIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KG5vZGUpID09PSAiW29iamVjdCBBcnJheV0iID8gW10gOiB7fTsKICAgICAgICBmb3IgKGkgaW4gbm9kZSkgewogICAgICAgICAgaWYgKG5vZGUuaGFzT3duUHJvcGVydHkoaSkgJiYgaSAhPT0gImdyb3VwUmFuZ2UiICYmIGkgIT09ICJncm91cExvYyIpIHsKICAgICAgICAgICAgZW50cnkgPSBub2RlW2ldOwogICAgICAgICAgICBpZiAoZW50cnkgPT09IG51bGwgfHwgdHlwZW9mIGVudHJ5ICE9PSAib2JqZWN0IiB8fCBlbnRyeSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICAgIG5baV0gPSBlbnRyeTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuW2ldID0gZmlsdGVyR3JvdXAoZW50cnkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHdyYXBUcmFja2luZ0Z1bmN0aW9uKHJhbmdlLCBsb2MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocGFyc2VGdW5jdGlvbikgewogICAgICAgICAgZnVuY3Rpb24gaXNCaW5hcnkobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50eXBlID09PSBTeW50YXguTG9naWNhbEV4cHJlc3Npb24gfHwgbm9kZS50eXBlID09PSBTeW50YXguQmluYXJ5RXhwcmVzc2lvbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHZpc2l0KG5vZGUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0LCBlbmQ7CiAgICAgICAgICAgIGlmIChpc0JpbmFyeShub2RlLmxlZnQpKSB7CiAgICAgICAgICAgICAgdmlzaXQobm9kZS5sZWZ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCaW5hcnkobm9kZS5yaWdodCkpIHsKICAgICAgICAgICAgICB2aXNpdChub2RlLnJpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmFuZ2UpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5sZWZ0Lmdyb3VwUmFuZ2UgfHwgbm9kZS5yaWdodC5ncm91cFJhbmdlKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IG5vZGUubGVmdC5ncm91cFJhbmdlID8gbm9kZS5sZWZ0Lmdyb3VwUmFuZ2VbMF0gOiBub2RlLmxlZnQucmFuZ2VbMF07CiAgICAgICAgICAgICAgICBlbmQgPSBub2RlLnJpZ2h0Lmdyb3VwUmFuZ2UgPyBub2RlLnJpZ2h0Lmdyb3VwUmFuZ2VbMV0gOiBub2RlLnJpZ2h0LnJhbmdlWzFdOwogICAgICAgICAgICAgICAgbm9kZS5yYW5nZSA9IFsgc3RhcnQsIGVuZCBdOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5vZGUucmFuZ2UgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IG5vZGUubGVmdC5yYW5nZVswXTsKICAgICAgICAgICAgICAgIGVuZCA9IG5vZGUucmlnaHQucmFuZ2VbMV07CiAgICAgICAgICAgICAgICBub2RlLnJhbmdlID0gWyBzdGFydCwgZW5kIF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb2MpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5sZWZ0Lmdyb3VwTG9jIHx8IG5vZGUucmlnaHQuZ3JvdXBMb2MpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbm9kZS5sZWZ0Lmdyb3VwTG9jID8gbm9kZS5sZWZ0Lmdyb3VwTG9jLnN0YXJ0IDogbm9kZS5sZWZ0LmxvYy5zdGFydDsKICAgICAgICAgICAgICAgIGVuZCA9IG5vZGUucmlnaHQuZ3JvdXBMb2MgPyBub2RlLnJpZ2h0Lmdyb3VwTG9jLmVuZCA6IG5vZGUucmlnaHQubG9jLmVuZDsKICAgICAgICAgICAgICAgIG5vZGUubG9jID0gewogICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZDogZW5kCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5vZGUubG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgbm9kZS5sb2MgPSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLmxlZnQubG9jLnN0YXJ0LAogICAgICAgICAgICAgICAgICBlbmQ6IG5vZGUucmlnaHQubG9jLmVuZAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG1hcmtlciwgbm9kZTsKICAgICAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICAgICAgbWFya2VyID0gY3JlYXRlTG9jYXRpb25NYXJrZXIoKTsKICAgICAgICAgICAgbm9kZSA9IHBhcnNlRnVuY3Rpb24uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgbWFya2VyLmVuZCgpOwogICAgICAgICAgICBpZiAocmFuZ2UgJiYgdHlwZW9mIG5vZGUucmFuZ2UgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgbWFya2VyLmFwcGx5KG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb2MgJiYgdHlwZW9mIG5vZGUubG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG1hcmtlci5hcHBseShub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCaW5hcnkobm9kZSkpIHsKICAgICAgICAgICAgICB2aXNpdChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXRjaCgpIHsKICAgICAgICB2YXIgd3JhcFRyYWNraW5nOwogICAgICAgIGlmIChleHRyYS5jb21tZW50cykgewogICAgICAgICAgZXh0cmEuc2tpcENvbW1lbnQgPSBza2lwQ29tbWVudDsKICAgICAgICAgIHNraXBDb21tZW50ID0gc2NhbkNvbW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChleHRyYS5yYXcpIHsKICAgICAgICAgIGV4dHJhLmNyZWF0ZUxpdGVyYWwgPSBjcmVhdGVMaXRlcmFsOwogICAgICAgICAgY3JlYXRlTGl0ZXJhbCA9IGNyZWF0ZVJhd0xpdGVyYWw7CiAgICAgICAgfQogICAgICAgIGlmIChleHRyYS5yYW5nZSB8fCBleHRyYS5sb2MpIHsKICAgICAgICAgIGV4dHJhLnBhcnNlR3JvdXBFeHByZXNzaW9uID0gcGFyc2VHcm91cEV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwgPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGw7CiAgICAgICAgICBwYXJzZUdyb3VwRXhwcmVzc2lvbiA9IHRyYWNrR3JvdXBFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uID0gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uQWxsb3dDYWxsID0gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uQWxsb3dDYWxsOwogICAgICAgICAgd3JhcFRyYWNraW5nID0gd3JhcFRyYWNraW5nRnVuY3Rpb24oZXh0cmEucmFuZ2UsIGV4dHJhLmxvYyk7CiAgICAgICAgICBleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbiA9IHBhcnNlQWRkaXRpdmVFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbiA9IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUJpdHdpc2VBTkRFeHByZXNzaW9uID0gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbiA9IHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQml0d2lzZVhPUkV4cHJlc3Npb24gPSBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VCbG9jayA9IHBhcnNlQmxvY2s7CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMgPSBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHM7CiAgICAgICAgICBleHRyYS5wYXJzZUNhdGNoQ2xhdXNlID0gcGFyc2VDYXRjaENsYXVzZTsKICAgICAgICAgIGV4dHJhLnBhcnNlQ29tcHV0ZWRNZW1iZXIgPSBwYXJzZUNvbXB1dGVkTWVtYmVyOwogICAgICAgICAgZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24gPSBwYXJzZUNvbmRpdGlvbmFsRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbiA9IHBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlRXF1YWxpdHlFeHByZXNzaW9uID0gcGFyc2VFcXVhbGl0eUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUV4cHJlc3Npb24gPSBwYXJzZUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24gPSBwYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb247CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24gPSBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb247CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbiA9IHBhcnNlRnVuY3Rpb25FeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbiA9IHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24gPSBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZU11bHRpcGxpY2F0aXZlRXhwcmVzc2lvbiA9IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VOZXdFeHByZXNzaW9uID0gcGFyc2VOZXdFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VOb25Db21wdXRlZFByb3BlcnR5ID0gcGFyc2VOb25Db21wdXRlZFByb3BlcnR5OwogICAgICAgICAgZXh0cmEucGFyc2VPYmplY3RQcm9wZXJ0eSA9IHBhcnNlT2JqZWN0UHJvcGVydHk7CiAgICAgICAgICBleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5ID0gcGFyc2VPYmplY3RQcm9wZXJ0eUtleTsKICAgICAgICAgIGV4dHJhLnBhcnNlUG9zdGZpeEV4cHJlc3Npb24gPSBwYXJzZVBvc3RmaXhFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VQcmltYXJ5RXhwcmVzc2lvbiA9IHBhcnNlUHJpbWFyeUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZVByb2dyYW0gPSBwYXJzZVByb2dyYW07CiAgICAgICAgICBleHRyYS5wYXJzZVByb3BlcnR5RnVuY3Rpb24gPSBwYXJzZVByb3BlcnR5RnVuY3Rpb247CiAgICAgICAgICBleHRyYS5wYXJzZVJlbGF0aW9uYWxFeHByZXNzaW9uID0gcGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlU3RhdGVtZW50ID0gcGFyc2VTdGF0ZW1lbnQ7CiAgICAgICAgICBleHRyYS5wYXJzZVNoaWZ0RXhwcmVzc2lvbiA9IHBhcnNlU2hpZnRFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VTd2l0Y2hDYXNlID0gcGFyc2VTd2l0Y2hDYXNlOwogICAgICAgICAgZXh0cmEucGFyc2VVbmFyeUV4cHJlc3Npb24gPSBwYXJzZVVuYXJ5RXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbiA9IHBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlVmFyaWFibGVJZGVudGlmaWVyID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXI7CiAgICAgICAgICBwYXJzZUFkZGl0aXZlRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VBTkRFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VCaXR3aXNlWE9SRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlQmxvY2sgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VCbG9jayk7CiAgICAgICAgICBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzKTsKICAgICAgICAgIHBhcnNlQ2F0Y2hDbGF1c2UgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VDYXRjaENsYXVzZSk7CiAgICAgICAgICBwYXJzZUNvbXB1dGVkTWVtYmVyID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQ29tcHV0ZWRNZW1iZXIpOwogICAgICAgICAgcGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VDb25zdExldERlY2xhcmF0aW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbik7CiAgICAgICAgICBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUVxdWFsaXR5RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlRm9yVmFyaWFibGVEZWNsYXJhdGlvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24pOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlRnVuY3Rpb25EZWNsYXJhdGlvbik7CiAgICAgICAgICBwYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcocGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VMb2dpY2FsT1JFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTmV3RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZU5ld0V4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VOb25Db21wdXRlZFByb3BlcnR5ID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlTm9uQ29tcHV0ZWRQcm9wZXJ0eSk7CiAgICAgICAgICBwYXJzZU9iamVjdFByb3BlcnR5ID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlT2JqZWN0UHJvcGVydHkpOwogICAgICAgICAgcGFyc2VPYmplY3RQcm9wZXJ0eUtleSA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5KTsKICAgICAgICAgIHBhcnNlUG9zdGZpeEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VQb3N0Zml4RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVByaW1hcnlFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlUHJpbWFyeUV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VQcm9ncmFtID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlUHJvZ3JhbSk7CiAgICAgICAgICBwYXJzZVByb3BlcnR5RnVuY3Rpb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKTsKICAgICAgICAgIHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVN0YXRlbWVudCA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVN0YXRlbWVudCk7CiAgICAgICAgICBwYXJzZVNoaWZ0RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVNoaWZ0RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVN3aXRjaENhc2UgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VTd2l0Y2hDYXNlKTsKICAgICAgICAgIHBhcnNlVW5hcnlFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlVW5hcnlFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVZhcmlhYmxlRGVjbGFyYXRpb24pOwogICAgICAgICAgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VWYXJpYWJsZUlkZW50aWZpZXIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGV4dHJhLnRva2VucyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGV4dHJhLmFkdmFuY2UgPSBhZHZhbmNlOwogICAgICAgICAgZXh0cmEuc2NhblJlZ0V4cCA9IHNjYW5SZWdFeHA7CiAgICAgICAgICBhZHZhbmNlID0gY29sbGVjdFRva2VuOwogICAgICAgICAgc2NhblJlZ0V4cCA9IGNvbGxlY3RSZWdleDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdW5wYXRjaCgpIHsKICAgICAgICBpZiAodHlwZW9mIGV4dHJhLnNraXBDb21tZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBza2lwQ29tbWVudCA9IGV4dHJhLnNraXBDb21tZW50OwogICAgICAgIH0KICAgICAgICBpZiAoZXh0cmEucmF3KSB7CiAgICAgICAgICBjcmVhdGVMaXRlcmFsID0gZXh0cmEuY3JlYXRlTGl0ZXJhbDsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dHJhLnJhbmdlIHx8IGV4dHJhLmxvYykgewogICAgICAgICAgcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlQml0d2lzZUFOREV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUJpdHdpc2VPUkV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uID0gZXh0cmEucGFyc2VCaXR3aXNlWE9SRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlQmxvY2sgPSBleHRyYS5wYXJzZUJsb2NrOwogICAgICAgICAgcGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzID0gZXh0cmEucGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzOwogICAgICAgICAgcGFyc2VDYXRjaENsYXVzZSA9IGV4dHJhLnBhcnNlQ2F0Y2hDbGF1c2U7CiAgICAgICAgICBwYXJzZUNvbXB1dGVkTWVtYmVyID0gZXh0cmEucGFyc2VDb21wdXRlZE1lbWJlcjsKICAgICAgICAgIHBhcnNlQ29uZGl0aW9uYWxFeHByZXNzaW9uID0gZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUNvbnN0TGV0RGVjbGFyYXRpb24gPSBleHRyYS5wYXJzZUNvbnN0TGV0RGVjbGFyYXRpb247CiAgICAgICAgICBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlRXF1YWxpdHlFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VFeHByZXNzaW9uID0gZXh0cmEucGFyc2VFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlR3JvdXBFeHByZXNzaW9uID0gZXh0cmEucGFyc2VHcm91cEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwgPSBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGw7CiAgICAgICAgICBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uID0gZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uID0gZXh0cmEucGFyc2VNdWx0aXBsaWNhdGl2ZUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZU5ld0V4cHJlc3Npb24gPSBleHRyYS5wYXJzZU5ld0V4cHJlc3Npb247CiAgICAgICAgICBwYXJzZU5vbkNvbXB1dGVkUHJvcGVydHkgPSBleHRyYS5wYXJzZU5vbkNvbXB1dGVkUHJvcGVydHk7CiAgICAgICAgICBwYXJzZU9iamVjdFByb3BlcnR5ID0gZXh0cmEucGFyc2VPYmplY3RQcm9wZXJ0eTsKICAgICAgICAgIHBhcnNlT2JqZWN0UHJvcGVydHlLZXkgPSBleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5OwogICAgICAgICAgcGFyc2VQcmltYXJ5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlUHJpbWFyeUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZVBvc3RmaXhFeHByZXNzaW9uID0gZXh0cmEucGFyc2VQb3N0Zml4RXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlUHJvZ3JhbSA9IGV4dHJhLnBhcnNlUHJvZ3JhbTsKICAgICAgICAgIHBhcnNlUHJvcGVydHlGdW5jdGlvbiA9IGV4dHJhLnBhcnNlUHJvcGVydHlGdW5jdGlvbjsKICAgICAgICAgIHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24gPSBleHRyYS5wYXJzZVJlbGF0aW9uYWxFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VTdGF0ZW1lbnQgPSBleHRyYS5wYXJzZVN0YXRlbWVudDsKICAgICAgICAgIHBhcnNlU2hpZnRFeHByZXNzaW9uID0gZXh0cmEucGFyc2VTaGlmdEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZVN3aXRjaENhc2UgPSBleHRyYS5wYXJzZVN3aXRjaENhc2U7CiAgICAgICAgICBwYXJzZVVuYXJ5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlVW5hcnlFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIgPSBleHRyYS5wYXJzZVZhcmlhYmxlSWRlbnRpZmllcjsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBleHRyYS5zY2FuUmVnRXhwID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBhZHZhbmNlID0gZXh0cmEuYWR2YW5jZTsKICAgICAgICAgIHNjYW5SZWdFeHAgPSBleHRyYS5zY2FuUmVnRXhwOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzdHJpbmdUb0FycmF5KHN0cikgewogICAgICAgIHZhciBsZW5ndGggPSBzdHIubGVuZ3RoLCByZXN1bHQgPSBbXSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IHN0ci5jaGFyQXQoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2UoY29kZSwgb3B0aW9ucykgewogICAgICAgIHZhciBwcm9ncmFtLCB0b1N0cmluZzsKICAgICAgICB0b1N0cmluZyA9IFN0cmluZzsKICAgICAgICBpZiAodHlwZW9mIGNvZGUgIT09ICJzdHJpbmciICYmICEoY29kZSBpbnN0YW5jZW9mIFN0cmluZykpIHsKICAgICAgICAgIGNvZGUgPSB0b1N0cmluZyhjb2RlKTsKICAgICAgICB9CiAgICAgICAgc291cmNlID0gY29kZTsKICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgbGluZU51bWJlciA9IHNvdXJjZS5sZW5ndGggPiAwID8gMSA6IDA7CiAgICAgICAgbGluZVN0YXJ0ID0gMDsKICAgICAgICBsZW5ndGggPSBzb3VyY2UubGVuZ3RoOwogICAgICAgIGJ1ZmZlciA9IG51bGw7CiAgICAgICAgc3RhdGUgPSB7CiAgICAgICAgICBhbGxvd0luOiB0cnVlLAogICAgICAgICAgbGFiZWxTZXQ6IHt9LAogICAgICAgICAgaW5GdW5jdGlvbkJvZHk6IGZhbHNlLAogICAgICAgICAgaW5JdGVyYXRpb246IGZhbHNlLAogICAgICAgICAgaW5Td2l0Y2g6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICBleHRyYSA9IHt9OwogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGV4dHJhLnJhbmdlID0gdHlwZW9mIG9wdGlvbnMucmFuZ2UgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnJhbmdlOwogICAgICAgICAgZXh0cmEubG9jID0gdHlwZW9mIG9wdGlvbnMubG9jID09PSAiYm9vbGVhbiIgJiYgb3B0aW9ucy5sb2M7CiAgICAgICAgICBleHRyYS5yYXcgPSB0eXBlb2Ygb3B0aW9ucy5yYXcgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnJhdzsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy50b2tlbnMgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnRva2VucykgewogICAgICAgICAgICBleHRyYS50b2tlbnMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jb21tZW50ID09PSAiYm9vbGVhbiIgJiYgb3B0aW9ucy5jb21tZW50KSB7CiAgICAgICAgICAgIGV4dHJhLmNvbW1lbnRzID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMudG9sZXJhbnQgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnRvbGVyYW50KSB7CiAgICAgICAgICAgIGV4dHJhLmVycm9ycyA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VbMF0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGlmIChjb2RlIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgICAgICAgc291cmNlID0gY29kZS52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VbMF0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgc291cmNlID0gc3RyaW5nVG9BcnJheShjb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwYXRjaCgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBwcm9ncmFtID0gcGFyc2VQcm9ncmFtKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGV4dHJhLmNvbW1lbnRzICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBmaWx0ZXJDb21tZW50TG9jYXRpb24oKTsKICAgICAgICAgICAgcHJvZ3JhbS5jb21tZW50cyA9IGV4dHJhLmNvbW1lbnRzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBleHRyYS50b2tlbnMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGZpbHRlclRva2VuTG9jYXRpb24oKTsKICAgICAgICAgICAgcHJvZ3JhbS50b2tlbnMgPSBleHRyYS50b2tlbnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGV4dHJhLmVycm9ycyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcHJvZ3JhbS5lcnJvcnMgPSBleHRyYS5lcnJvcnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UgfHwgZXh0cmEubG9jKSB7CiAgICAgICAgICAgIHByb2dyYW0uYm9keSA9IGZpbHRlckdyb3VwKHByb2dyYW0uYm9keSk7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdW5wYXRjaCgpOwogICAgICAgICAgZXh0cmEgPSB7fTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW07CiAgICAgIH0KICAgICAgZXhwb3J0cy52ZXJzaW9uID0gIjEuMC40IjsKICAgICAgZXhwb3J0cy5wYXJzZSA9IHBhcnNlOwogICAgICBleHBvcnRzLlN5bnRheCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBuYW1lLCB0eXBlcyA9IHt9OwogICAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdHlwZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0KICAgICAgICBmb3IgKG5hbWUgaW4gU3ludGF4KSB7CiAgICAgICAgICBpZiAoU3ludGF4Lmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIHR5cGVzW25hbWVdID0gU3ludGF4W25hbWVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIE9iamVjdC5mcmVlemUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIE9iamVjdC5mcmVlemUodHlwZXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZXM7CiAgICAgIH0oKTsKICAgIH0pOwogIH0sCiAgInIuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgdmFyIHJ1bm5lciA9IGJhc2lzLnJlcXVpcmUoIi4vYy5qcyIpOwogICAgdmFyIFRlc3RTdWl0ZSA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpLlRlc3RTdWl0ZTsKICAgIHZhciBJdGVtID0gYmFzaXMudWkuTm9kZS5zdWJjbGFzcyh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiMyIiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBuYW1lOiAiZGF0YToiLAogICAgICAgIHByb2dyZXNzOiBbICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gMTAwICogKG5vZGUuc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HID8gbm9kZS5zdGF0ZS5kYXRhIDogMSk7CiAgICAgICAgfSBdLAogICAgICAgIHBlbmRpbmc6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCAmJiAhIW5vZGUuc3RhdGUuZGF0YS5kYXRhLnBlbmRpbmc7CiAgICAgICAgfSBdLAogICAgICAgIHN0YXRlTWVzc2FnZTogWyAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgdmFyIHJlcG9ydCA9IG5vZGUuc3RhdGUuZGF0YTsKICAgICAgICAgIHN3aXRjaCAoU3RyaW5nKG5vZGUuc3RhdGUpKSB7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5SRUFEWToKICAgICAgICAgICAgICBpZiAocmVwb3J0LmRhdGEgJiYgcmVwb3J0LmRhdGEucGVuZGluZykgcmV0dXJuICJQZW5kaW5nIjsKICAgICAgICAgICAgICByZXR1cm4gIk9LIjsKICAgICAgICAgICAgY2FzZSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SOgogICAgICAgICAgICAgIGlmIChyZXBvcnQgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCA9PSBmYWxzZSkgcmV0dXJuICJFcnJvciI7CiAgICAgICAgICAgICAgaWYgKHJlcG9ydC5kYXRhLmV4Y2VwdGlvbikgcmV0dXJuICJFeGNlcHRpb24iOwogICAgICAgICAgICAgIGlmIChyZXBvcnQuZGF0YS5lcnJvciA9PSAiRVJST1JfVElNRU9VVCIpIHJldHVybiAiVGltZW91dCI7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcG9ydC5kYXRhLnRlc3RDb3VudCAtIHJlcG9ydC5kYXRhLnN1Y2Nlc3NDb3VudCArICIgb2YgIiArIHJlcG9ydC5kYXRhLnRlc3RDb3VudCArICIgZmF1bHQiOwogICAgICAgICAgICBjYXNlIGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORzoKICAgICAgICAgICAgICByZXR1cm4gInJ1bm5pbmciOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9IF0KICAgICAgfSwKICAgICAgYWN0aW9uOiB7CiAgICAgICAgcGlja3VwOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAmJiB0aGlzLnJvb3QgaW5zdGFuY2VvZiBUZXN0U3VpdGUpIHRoaXMucGFyZW50Tm9kZS5zZXREZWxlZ2F0ZSh0aGlzLnJvb3QpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgdmlldyA9IG5ldyBiYXNpcy51aS5Ob2RlKHsKICAgICAgZGF0YVNvdXJjZTogYmFzaXMuZGF0YS5WYWx1ZS5mYWN0b3J5KCJyb290Q2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5yb290LmdldENoaWxkTm9kZXNEYXRhc2V0KCk7CiAgICAgIH0pLAogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjMyIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgZmF1bHRUZXN0czogInNhdGVsbGl0ZToiLAogICAgICAgIGxldmVsVXA6ICJzYXRlbGxpdGU6IgogICAgICB9LAogICAgICBzZWxlY3Rpb246IHRydWUsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNlbGVjdGlvbjogewogICAgICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICAgICAgaWYgKCFzZWxlY3Rpb24uaXRlbUNvdW50KSB0aGlzLnNhdGVsbGl0ZS5mYXVsdFRlc3RzLnNlbGVjdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogSXRlbQogICAgfSk7CiAgICB2aWV3LnNldFNhdGVsbGl0ZSgiZmF1bHRUZXN0cyIsIG5ldyBJdGVtKHsKICAgICAgY29udGV4dFNlbGVjdGlvbjogdmlldy5zZWxlY3Rpb24sCiAgICAgIGRlbGVnYXRlOiBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIG5hbWU6ICJTdW1tYXJ5IgogICAgICAgIH0sCiAgICAgICAgZ2V0Q2hpbGROb2Rlc0RhdGFzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHJ1bm5lci5mYXVsdFRlc3RzOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pKTsKICAgIHZpZXcuc2V0U2F0ZWxsaXRlKCJsZXZlbFVwIiwgewogICAgICBldmVudHM6ICJyb290Q2hhbmdlZCIsCiAgICAgIGV4aXN0c0lmOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5yb290LnBhcmVudE5vZGU7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5yb290LnBhcmVudE5vZGU7CiAgICAgIH0sCiAgICAgIGluc3RhbmNlOiBuZXcgSXRlbSh7CiAgICAgICAgYmluZGluZzogewogICAgICAgICAgbmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiLi4iOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWN0aW9uOiB7CiAgICAgICAgICBzZWxlY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLm93bmVyLnNldERlbGVnYXRlKHRoaXMucm9vdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSk7CiAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgaWYgKCF2aWV3LnNlbGVjdGlvbi5pdGVtQ291bnQpIHZpZXcuc2F0ZWxsaXRlLmZhdWx0VGVzdHMuc2VsZWN0KCk7CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gdmlldzsKICB9LAogICIzLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBiYXNpcy5yZXNvdXJjZS5leHRlbnNpb25zWyIubDEwbiJdID0gZnVuY3Rpb24oY29udGVudCwgdXJsKSB7CiAgICAgIHJldHVybiByZXNvbHZlRGljdGlvbmFyeSh1cmwpLnVwZGF0ZShiYXNpcy5yZXNvdXJjZS5leHRlbnNpb25zWyIuanNvbiJdKGNvbnRlbnQsIHVybCkpOwogICAgfTsKICAgIGZ1bmN0aW9uIG93bktleXMob2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSByZXN1bHQucHVzaChrZXkpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIHRva2VuSW5kZXggPSBbXTsKICAgIHZhciB0b2tlbkNvbXB1dGVGbiA9IHt9OwogICAgdmFyIHRva2VuQ29tcHV0ZXMgPSB7fTsKICAgIHZhciBDb21wdXRlVG9rZW4gPSBDbGFzcyhiYXNpcy5Ub2tlbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ29tcHV0ZVRva2VuIiwKICAgICAgaW5pdDogZnVuY3Rpb24odmFsdWUsIHRva2VuKSB7CiAgICAgICAgdG9rZW4uY29tcHV0ZVRva2Vuc1t0aGlzLmJhc2lzT2JqZWN0SWRdID0gdGhpczsKICAgICAgICB0aGlzLnRva2VuID0gdG9rZW47CiAgICAgICAgdGhpcy5nZXQgPSB0b2tlbi5jb21wdXRlR2V0TWV0aG9kOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBjb21wdXRlR2V0TWV0aG9kOiBmdW5jdGlvbigpIHt9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IHt9OwogICAgICAgIHZhciB0b2tlbnMgPSB0aGlzLmNvbXB1dGVUb2tlbnM7CiAgICAgICAgdmFyIGdldCA9IHRoaXMudHlwZSA9PSAicGx1cmFsIiA/IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHZhbHVlc1tjdWx0dXJlc1tjdXJyZW50Q3VsdHVyZV0ucGx1cmFsKHRoaXMudmFsdWUpXTsKICAgICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWVzW3RoaXMudmFsdWVdOwogICAgICAgIH07CiAgICAgICAgdGhpcy5jb21wdXRlR2V0TWV0aG9kID0gZ2V0OwogICAgICAgIGlmICh0aGlzLnR5cGUgPT0gInBsdXJhbCIgJiYgQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSB8fCB0aGlzLnR5cGUgPT0gImRlZmF1bHQiICYmIHR5cGVvZiB0aGlzLnZhbHVlID09ICJvYmplY3QiKSB2YWx1ZXMgPSBiYXNpcy5vYmplY3Quc2xpY2UodGhpcy52YWx1ZSwgb3duS2V5cyh0aGlzLnZhbHVlKSk7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VucykgewogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IHRva2Vuc1trZXldOwogICAgICAgICAgdmFyIGN1clZhbHVlID0gY29tcHV0ZVRva2VuLmdldCgpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gZ2V0LmNhbGwoY29tcHV0ZVRva2VuKTsKICAgICAgICAgIGNvbXB1dGVUb2tlbi5nZXQgPSBnZXQ7CiAgICAgICAgICBpZiAoY3VyVmFsdWUgIT09IG5ld1ZhbHVlKSBjb21wdXRlVG9rZW4uYXBwbHkoKTsKICAgICAgICB9CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmFwcGx5LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyLmJhc2lzR2V0dGVySWRfKS5qb2luKCJfIik7CiAgICAgICAgaWYgKHRva2VuQ29tcHV0ZUZuW2VudW1JZF0pIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdOwogICAgICAgIHZhciB0b2tlbiA9IHRoaXM7CiAgICAgICAgdmFyIG9iamVjdFRva2VuTWFwID0ge307CiAgICAgICAgdmFyIHVwZGF0ZVZhbHVlID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB0aGlzLnNldChnZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgb2JqZWN0VG9rZW5NYXBbb2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSBpZiAoZXZlbnROYW1lICE9ICJkZXN0cm95IikgaGFuZGxlcltldmVudE5hbWVdID0gdXBkYXRlVmFsdWU7CiAgICAgICAgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF0gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBFbWl0dGVyID09IGZhbHNlKSB0aHJvdyAiYmFzaXMubDEwbi5Ub2tlbiNjb21wdXRlOiBvYmplY3QgbXVzdCBiZSBhbiBpbnN0YW5jZW9mIEVtaXR0ZXIiOwogICAgICAgICAgdmFyIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICB2YXIgY29tcHV0ZVRva2VuID0gb2JqZWN0VG9rZW5NYXBbb2JqZWN0SWRdOwogICAgICAgICAgaWYgKCFjb21wdXRlVG9rZW4pIHsKICAgICAgICAgICAgY29tcHV0ZVRva2VuID0gb2JqZWN0VG9rZW5NYXBbb2JqZWN0SWRdID0gbmV3IENvbXB1dGVUb2tlbihnZXR0ZXIob2JqZWN0KSwgdG9rZW4pOwogICAgICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb21wdXRlVG9rZW4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbXB1dGVUb2tlbjsKICAgICAgICB9OwogICAgICB9LAogICAgICBjb21wdXRlVG9rZW46IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb21wdXRlVG9rZW4odmFsdWUsIHRoaXMpOwogICAgICB9LAogICAgICB0b2tlbjogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGlmICh0aGlzLnR5cGUgPT0gInBsdXJhbCIpIG5hbWUgPSBjdWx0dXJlc1tjdXJyZW50Q3VsdHVyZV0ucGx1cmFsKG5hbWUpOwogICAgICAgIGlmICh0aGlzLmRpY3Rpb25hcnkpIHJldHVybiB0aGlzLmRpY3Rpb25hcnkudG9rZW4odGhpcy5uYW1lICsgIi4iICsgbmFtZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNvbXB1dGVUb2tlbnMpIHRoaXMuY29tcHV0ZVRva2Vuc1trZXldLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSBudWxsOwogICAgICAgIHRoaXMudmFsdWUgPSBudWxsOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcmVzb2x2ZVRva2VuKHBhdGgpIHsKICAgICAgaWYgKHBhdGguY2hhckF0KDApID09ICIjIikgewogICAgICAgIHJldHVybiB0b2tlbkluZGV4W3BhcnNlSW50KHBhdGguc3Vic3RyKDEpLCAzNildOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwYXJ0cyA9IHBhdGgubWF0Y2goL14oLis/KUAoLispJC8pOwogICAgICAgIGlmIChwYXJ0cykgcmV0dXJuIHJlc29sdmVEaWN0aW9uYXJ5KGJhc2lzLnBhdGgucmVzb2x2ZShwYXJ0c1syXSkpLnRva2VuKHBhcnRzWzFdKTsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi50b2tlbiBhY2NlcHRzIHRva2VuIHJlZmVyZW5jZXMgaW4gZm9ybWF0IGB0b2tlbi5wYXRoQHBhdGgvdG8vZGljdC5sMTBuYCBvbmx5Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBkaWN0aW9uYXJpZXMgPSBbXTsKICAgIHZhciBkaWN0aW9uYXJ5QnlVcmwgPSB7fTsKICAgIHZhciBjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIgPSBuZXcgYmFzaXMuVG9rZW47CiAgICBmdW5jdGlvbiB3YWxrVG9rZW5zKGRpY3Rpb25hcnksIGN1bHR1cmUsIHRva2VucywgcGF0aCkgewogICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IGRpY3Rpb25hcnkuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXTsKICAgICAgcGF0aCA9IHBhdGggPyBwYXRoICsgIi4iIDogIiI7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gdG9rZW5zKSBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh0b2tlbnMsIG5hbWUpKSB7CiAgICAgICAgdmFyIHRva2VuTmFtZSA9IHBhdGggKyBuYW1lOwogICAgICAgIHZhciB0b2tlblZhbHVlID0gdG9rZW5zW25hbWVdOwogICAgICAgIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXSA9IHRva2VuVmFsdWU7CiAgICAgICAgaWYgKHRva2VuVmFsdWUgJiYgKHR5cGVvZiB0b2tlblZhbHVlID09ICJvYmplY3QiIHx8IEFycmF5LmlzQXJyYXkodG9rZW5WYWx1ZSkpKSB3YWxrVG9rZW5zKGRpY3Rpb25hcnksIGN1bHR1cmUsIHRva2VuVmFsdWUsIHRva2VuTmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHZhciBEaWN0aW9uYXJ5ID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGljdGlvbmFyeSIsCiAgICAgIHRva2VuczogbnVsbCwKICAgICAgdHlwZXM6IG51bGwsCiAgICAgIGN1bHR1cmVWYWx1ZXM6IG51bGwsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIHJlc291cmNlOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgdGhpcy50b2tlbnMgPSB7fTsKICAgICAgICB0aGlzLnR5cGVzID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgdGhpcy5pbmRleCA9IGRpY3Rpb25hcmllcy5wdXNoKHRoaXMpIC0gMTsKICAgICAgICBpZiAoYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZShjb250ZW50KSkgewogICAgICAgICAgdmFyIHJlc291cmNlID0gY29udGVudDsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTsKICAgICAgICAgIGlmICghZGljdGlvbmFyeUJ5VXJsW3Jlc291cmNlLnVybF0pIHsKICAgICAgICAgICAgZGljdGlvbmFyeUJ5VXJsW3Jlc291cmNlLnVybF0gPSB0aGlzOwogICAgICAgICAgICBjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIuc2V0KHJlc291cmNlLnVybCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNvdXJjZS5mZXRjaCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiVXNlIG9iamVjdCBhcyBjb250ZW50IG9mIGRpY3Rpb25hcnkgaXMgZXhwZXJpbWVudGFsIGFuZCBub3QgcHJvZHVjdGlvbi1yZWFkeSIpOwogICAgICAgICAgdGhpcy51cGRhdGUoY29udGVudCB8fCB7fSk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBpZiAoIWRhdGEpIGRhdGEgPSB7fTsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSB7fTsKICAgICAgICBmb3IgKHZhciBjdWx0dXJlIGluIGRhdGEpIGlmICghL15ffF8kLy50ZXN0KGN1bHR1cmUpKSB7CiAgICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV0gPSB7fTsKICAgICAgICAgIHdhbGtUb2tlbnModGhpcywgY3VsdHVyZSwgZGF0YVtjdWx0dXJlXSk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHlwZXMgPSBkYXRhLl9tZXRhICYmIGRhdGEuX21ldGEudHlwZSB8fCB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy50b2tlbnMpIHRoaXMudG9rZW5zW2tleV0uc2V0VHlwZSh0aGlzLnR5cGVzW2tleV0pOwogICAgICAgIHRoaXMuc3luY1ZhbHVlcygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBzeW5jVmFsdWVzOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciB0b2tlbk5hbWUgaW4gdGhpcy50b2tlbnMpIHRoaXMudG9rZW5zW3Rva2VuTmFtZV0uc2V0KHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICI0LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICBzZW5kZXI6IHRoaXMsCiAgICAgICAgICAgIHR5cGU6IGV2ZW50TmFtZSwKICAgICAgICAgICAgYXJnczogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgInMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBjb3JlVGVzdCA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpOwogICAgdmFyIGFwcFRlc3QgPSBiYXNpcy5yZXF1aXJlKCIuL20uanMiKTsKICAgIHZhciB2aWV3ID0gbmV3IGFwcFRlc3QuVGVzdFN1aXRlTm9kZSh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM4IiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzb3VyY2VDb2RlOiAic2F0ZWxsaXRlOiIsCiAgICAgICAgdHlwZTogWyAicm9vdENoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS5yb290IGluc3RhbmNlb2YgY29yZVRlc3QuVGVzdFN1aXRlKSByZXR1cm4gInN1aXRlIjsKICAgICAgICAgIGlmIChub2RlLnJvb3QgaW5zdGFuY2VvZiBjb3JlVGVzdC5UZXN0Q2FzZSkgcmV0dXJuICJjYXNlIjsKICAgICAgICAgIHJldHVybiAidW5rbm93biI7CiAgICAgICAgfSBdLAogICAgICAgIGhhc0RlbGVnYXRlOiBbICJkZWxlZ2F0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gISFub2RlLmRlbGVnYXRlOwogICAgICAgIH0gXQogICAgICB9LAogICAgICBzZWxlY3Rpb246IHRydWUsCiAgICAgIHNhdGVsbGl0ZTogewogICAgICAgIHNvdXJjZUNvZGU6IHsKICAgICAgICAgIGluc3RhbmNlT2Y6IGFwcFRlc3QuQ29kZVZpZXcsCiAgICAgICAgICBldmVudHM6ICJyb290Q2hhbmdlZCBzdGF0ZUNoYW5nZWQiLAogICAgICAgICAgZXhpc3RzSWY6IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgICAgICAgIHJldHVybiBvd25lci5yb290IGluc3RhbmNlb2YgY29yZVRlc3QuVGVzdENhc2U7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsZWdhdGU6IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgICAgICAgIHJldHVybiBvd25lci5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SICYmIG93bmVyLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCA/IG93bmVyLnN0YXRlLmRhdGEgOiBvd25lcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5jb250ZXh0U2VsZWN0aW9uID0gdmlldy5zZWxlY3Rpb247CiAgICB2aWV3LmFkZEhhbmRsZXIoewogICAgICBkZWxlZ2F0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2VsZWN0aW9uLmNsZWFyKCk7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB2aWV3OwogIH0sCiAgIm0uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgaGlnaGxpZ2h0ID0gYmFzaXMucmVxdWlyZSgiLi9uLmpzIik7CiAgICB2YXIgVGVzdENhc2UgPSBiYXNpcy5yZXF1aXJlKCIuL2guanMiKS5UZXN0Q2FzZTsKICAgIHZhciBzdHJEaWZmID0gYmFzaXMucmVxdWlyZSgiLi9vLmpzIik7CiAgICBmdW5jdGlvbiBodG1sRXNjYXBlKHN0cikgewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyYvZywgIiZhbXA7IikucmVwbGFjZSgvPC9nLCAiJmx0OyIpLnJlcGxhY2UoLz4vZywgIiZndDsiKTsKICAgIH0KICAgIHZhciBDb2RlVmlldyA9IGJhc2lzLnVpLk5vZGUuc3ViY2xhc3MoewogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjNCIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgc291cmNlQ29kZTogImNvZGVFbGVtZW50IgogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNvZGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgYmFzaXMudWkuTm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc3luY0NvZGUoKTsKICAgICAgfSwKICAgICAgaGFuZGxlcjogewogICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnN5bmNDb2RlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzeW5jQ29kZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jb2RlRWxlbWVudC5pbm5lckhUTUwgPSBoaWdobGlnaHQodGhpcy5kYXRhLnRlc3RTb3VyY2UsIHsKICAgICAgICAgIGtlZXBGb3JtYXQ6IHRydWUsCiAgICAgICAgICBub0xpbmVOdW1iZXI6IHRydWUKICAgICAgICB9KTsKICAgICAgICB2YXIgbGluZXMgPSB0aGlzLmNvZGVFbGVtZW50LmNoaWxkTm9kZXM7CiAgICAgICAgaWYgKHRoaXMuZGF0YS5leGNlcHRpb24pIHsKICAgICAgICAgIHZhciBzdGFydExpbmUgPSB0aGlzLmRhdGEubGFzdExpbmU7CiAgICAgICAgICBsaW5lc1tzdGFydExpbmUrK10uY2xhc3NOYW1lICs9ICIgZXhjZXB0aW9uLWxpbmUiOwogICAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0TGluZTsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSBsaW5lc1tpXS5jbGFzc05hbWUgKz0gIiBkaXNhYmxlZC1saW5lIjsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGVycm9yTGluZXMgPSB0aGlzLmRhdGEuZXJyb3JMaW5lczsKICAgICAgICBmb3IgKHZhciBsaW5lTnVtIGluIGVycm9yTGluZXMpIHsKICAgICAgICAgIGxpbmVzW2xpbmVOdW1dLmNsYXNzTmFtZSArPSAiIGVycm9yLWxpbmUiOwogICAgICAgICAgbGluZXNbbGluZU51bV0uaW5uZXJIVE1MICs9ICc8ZGl2IGNsYXNzPSJlcnJvci1saW5lLWRldGFpbHMiPicgKyBlcnJvckxpbmVzW2xpbmVOdW1dLm1hcChmdW5jdGlvbihsaW5lRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGRpZmZUeXBlID0gdHlwZW9mIGxpbmVFcnJvci5leHBlY3RlZCA9PSAic3RyaW5nIiAmJiB0eXBlb2YgbGluZUVycm9yLmFjdHVhbCA9PSAic3RyaW5nIiA/ICJkaWZmQ2hhcnMiIDogImRpZmZXb3JkcyI7CiAgICAgICAgICAgIHZhciBkaWZmID0gc3RyRGlmZltkaWZmVHlwZV0obGluZUVycm9yLmV4cGVjdGVkU3RyLCBsaW5lRXJyb3IuYWN0dWFsU3RyKTsKICAgICAgICAgICAgdmFyIGV4cGVjdGVkID0gIiI7CiAgICAgICAgICAgIHZhciBhY3R1YWwgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNodW5rOyBjaHVuayA9IGRpZmZbaV07IGkrKykgewogICAgICAgICAgICAgIGlmIChjaHVuay5yZW1vdmVkKSB7CiAgICAgICAgICAgICAgICBleHBlY3RlZCArPSAnPHNwYW4gY2xhc3M9ImRpZmYtcmVtb3ZlZCI+JyArIGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpICsgIjwvc3Bhbj4iOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjaHVuay5hZGRlZCkgewogICAgICAgICAgICAgICAgYWN0dWFsICs9ICc8c3BhbiBjbGFzcz0iZGlmZi1hZGRlZCI+JyArIGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpICsgIjwvc3Bhbj4iOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4cGVjdGVkICs9IGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpOwogICAgICAgICAgICAgIGFjdHVhbCArPSBodG1sRXNjYXBlKGNodW5rLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9ImVycm9yLWxpbmUtZGV0YWlscy1pdGVtIj4nICsgJzxzcGFuIGNsYXNzPSJudW0iPicgKyAobGluZUVycm9yLm51bSArIDEpICsgIjwvc3Bhbj4iICsgJzxzcGFuIGNsYXNzPSJjYXB0aW9uIj5FeHBlY3RlZDo8L3NwYW4+JyArICc8c3BhbiBjbGFzcz0iZXhwZWN0ZWQiPicgKyBleHBlY3RlZCArICI8L3NwYW4+IiArICc8c3BhbiBjbGFzcz0iY2FwdGlvbiI+QWN0dWFsOjwvc3Bhbj4nICsgJzxzcGFuIGNsYXNzPSJhY3R1YWwiPicgKyBhY3R1YWwgKyAiPC9zcGFuPiIgKyAiPC9kaXY+IjsKICAgICAgICAgIH0pLmpvaW4oIiIpICsgIjwvZGl2PiI7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0Tm9kZSA9IGJhc2lzLnVpLk5vZGUuc3ViY2xhc3MoewogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjNSIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgbmFtZTogImRhdGE6IiwKICAgICAgICBoYXNPd25FbnZpcm9ubWVudDogWyAicm9vdENoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5yb290Lmhhc093bkVudmlyb25tZW50KCk7CiAgICAgICAgfSBdLAogICAgICAgIHRpbWU6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgJiYgbm9kZS5zdGF0ZS5kYXRhLmRhdGEgJiYgbm9kZS5zdGF0ZS5kYXRhLmRhdGEudGltZTsKICAgICAgICB9IF0sCiAgICAgICAgZXJyb3JNZXNzYWdlOiBbICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SICYmIG5vZGUuc3RhdGUuZGF0YSA/IG5vZGUuc3RhdGUuZGF0YS5kYXRhLmVycm9yIDogIiI7CiAgICAgICAgfSBdLAogICAgICAgIHBlbmRpbmc6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCAmJiAhIW5vZGUuc3RhdGUuZGF0YS5kYXRhLnBlbmRpbmc7CiAgICAgICAgfSBdLAogICAgICAgIHN0YXRlRGF0YTogWyAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HID8gKDEwMCAqIG5vZGUuc3RhdGUuZGF0YSB8fCAwKS50b0ZpeGVkKDIpIDogbm9kZS5zdGF0ZS5kYXRhICYmIG5vZGUuc3RhdGUuZGF0YS5kYXRhLmVycm9yIHx8ICIiOwogICAgICAgIH0gXSwKICAgICAgICBzdGF0ZU1lc3NhZ2U6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHZhciByZXBvcnQgPSBub2RlLnN0YXRlLmRhdGE7CiAgICAgICAgICBzd2l0Y2ggKFN0cmluZyhub2RlLnN0YXRlKSkgewogICAgICAgICAgICBjYXNlIGJhc2lzLmRhdGEuU1RBVEUuUkVBRFk6CiAgICAgICAgICAgICAgaWYgKHJlcG9ydCBpbnN0YW5jZW9mIGJhc2lzLmRhdGEuT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBpZiAocmVwb3J0LmRhdGEucGVuZGluZykgcmV0dXJuICJQZW5kaW5nIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJPSyI7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5FUlJPUjoKICAgICAgICAgICAgICBpZiAocmVwb3J0IGluc3RhbmNlb2YgYmFzaXMuZGF0YS5PYmplY3QgPT0gZmFsc2UpIHJldHVybiAiRXJyb3IiOwogICAgICAgICAgICAgIGlmIChyZXBvcnQuZGF0YS5leGNlcHRpb24pIHJldHVybiByZXBvcnQuZGF0YS5leGNlcHRpb247CiAgICAgICAgICAgICAgaWYgKHJlcG9ydC5kYXRhLmVycm9yID09ICJFUlJPUl9USU1FT1VUIikgcmV0dXJuICJUaW1lb3V0IjsKICAgICAgICAgICAgICByZXR1cm4gcmVwb3J0LmRhdGEudGVzdENvdW50IC0gcmVwb3J0LmRhdGEuc3VjY2Vzc0NvdW50ICsgIiBvZiAiICsgcmVwb3J0LmRhdGEudGVzdENvdW50ICsgIiBmYXVsdCI7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOgogICAgICAgICAgICAgIHJldHVybiAicnVubmluZyI7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0gXQogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0U3VpdGVOb2RlID0gVGVzdE5vZGUuc3ViY2xhc3MoewogICAgICBkYXRhU291cmNlOiBiYXNpcy5kYXRhLlZhbHVlLmZhY3RvcnkoInJvb3RDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgIHJldHVybiBub2RlLnJvb3QuZ2V0Q2hpbGROb2Rlc0RhdGFzZXQoKTsKICAgICAgfSksCiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM2IiksCiAgICAgIGNoaWxkQ2xhc3M6IFRlc3ROb2RlLAogICAgICBjaGlsZEZhY3Rvcnk6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUucm9vdCBpbnN0YW5jZW9mIFRlc3RDYXNlKSByZXR1cm4gbmV3IFRlc3RDYXNlTm9kZShjb25maWcpOyBlbHNlIHJldHVybiBuZXcgVGVzdFN1aXRlTm9kZShjb25maWcpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0Q2FzZU5vZGUgPSBUZXN0Tm9kZS5zdWJjbGFzcyh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM3IiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzb3VyY2U6ICJzYXRlbGxpdGU6IgogICAgICB9LAogICAgICBzYXRlbGxpdGU6IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgICBleGlzdHNJZjogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICAgICAgcmV0dXJuIG93bmVyLnN0YXRlID09IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgJiYgb3duZXIuc3RhdGUuZGF0YSAmJiBvd25lci5zdGF0ZS5kYXRhLmRhdGEgJiYgb3duZXIuc3RhdGUuZGF0YS5kYXRhLnRlc3RTb3VyY2U7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsZWdhdGU6ICJzdGF0ZS5kYXRhIiwKICAgICAgICAgIGluc3RhbmNlT2Y6IENvZGVWaWV3CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBUZXN0Tm9kZTogVGVzdE5vZGUsCiAgICAgIFRlc3RDYXNlTm9kZTogVGVzdENhc2VOb2RlLAogICAgICBUZXN0U3VpdGVOb2RlOiBUZXN0U3VpdGVOb2RlLAogICAgICBDb2RlVmlldzogQ29kZVZpZXcKICAgIH07CiAgfSwKICAibi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgdmFyIGxlYWQgPSBiYXNpcy5udW1iZXIubGVhZDsKICAgIHZhciByZXBlYXQgPSBiYXNpcy5zdHJpbmcucmVwZWF0OwogICAgdmFyIGtleXdvcmRzID0gImJyZWFrIGNhc2UgY2F0Y2ggY29udGludWUgIiArICJkZWZhdWx0IGRlbGV0ZSBkbyBlbHNlIGZhbHNlICIgKyAiZm9yIGZ1bmN0aW9uIGlmIGluIGluc3RhbmNlb2YgIiArICJuZXcgbnVsbCByZXR1cm4gc3VwZXIgc3dpdGNoICIgKyAidGhpcyB0aHJvdyB0cnVlIHRyeSB0eXBlb2YgdmFyIHdoaWxlIHdpdGgiOwogICAgdmFyIGtleXdvcmRSZWdFeHAgPSBuZXcgUmVnRXhwKCJcXGIoIiArIGtleXdvcmRzLnNwbGl0KCIgIikuam9pbigifCIpICsgIilcXGIiLCAiZyIpOwogICAgZnVuY3Rpb24gcGFyc2UodGV4dCkgewogICAgICBmdW5jdGlvbiBhZGRNYXRjaChraW5kLCBzdGFydCwgZW5kLCBybikgewogICAgICAgIGlmIChsYXN0TWF0Y2hQb3MgIT0gc3RhcnQpIHJlc3VsdC5wdXNoKHRleHQuc3Vic3RyaW5nKGxhc3RNYXRjaFBvcywgc3RhcnQpLnJlcGxhY2Uoa2V5d29yZFJlZ0V4cCwgJzxzcGFuIGNsYXNzPSJ0b2tlbi1rZXl3b3JkIj4kMTwvc3Bhbj4nKSk7CiAgICAgICAgbGFzdE1hdGNoUG9zID0gZW5kICsgMTsKICAgICAgICBpZiAoa2luZCkgcmVzdWx0LnB1c2goJzxzcGFuIGNsYXNzPSJ0b2tlbi0nICsga2luZCArICciPicgKyB0ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kICsgMSkgKyAiPC9zcGFuPiIgKyAocm4gfHwgIiIpKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBzeW0gPSB0ZXh0LnNwbGl0KCIiKTsKICAgICAgdmFyIHN0YXJ0OwogICAgICB2YXIgbGFzdE1hdGNoUG9zID0gMDsKICAgICAgdmFyIHN0clN5bTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzeW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3ltW2ldID09ICInIiB8fCBzeW1baV0gPT0gJyInKSB7CiAgICAgICAgICBzdHJTeW0gPSBzeW1baV07CiAgICAgICAgICBzdGFydCA9IGk7CiAgICAgICAgICB3aGlsZSAoKytpIDwgc3ltLmxlbmd0aCkgewogICAgICAgICAgICBpZiAoc3ltW2ldID09ICJcXCIpIHsKICAgICAgICAgICAgICBpZiAoc3ltW2kgKyAxXSA9PSAiXG4iKSB7CiAgICAgICAgICAgICAgICBhZGRNYXRjaCgic3RyaW5nIiwgc3RhcnQsIGkpOwogICAgICAgICAgICAgICAgc3RhcnQgPSArK2kgKyAxOwogICAgICAgICAgICAgIH0gZWxzZSBpICs9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSBzdHJTeW0pIHsKICAgICAgICAgICAgICBhZGRNYXRjaCgic3RyaW5nIiwgc3RhcnQsIGkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxuIikgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChzeW1baV0gPT0gIi8iKSB7CiAgICAgICAgICBzdGFydCA9IGk7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoc3ltW2ldID09ICIvIikgewogICAgICAgICAgICB3aGlsZSAoKytpIDwgc3ltLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxuIikgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkTWF0Y2goImNvbW1lbnQiLCBzdGFydCwgaSAtIDEpOwogICAgICAgICAgfSBlbHNlIGlmIChzeW1baV0gPT0gIioiKSB7CiAgICAgICAgICAgIHdoaWxlICgrK2kgPCBzeW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSAiKiIgJiYgc3ltW2kgKyAxXSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIGFkZE1hdGNoKCJjb21tZW50Iiwgc3RhcnQsICsraSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN5bVtpXSA9PSAiXG4iKSB7CiAgICAgICAgICAgICAgICBhZGRNYXRjaCgiY29tbWVudCIsIHN0YXJ0LCBpIC0gMSwgIlxuIik7CiAgICAgICAgICAgICAgICBsYXN0TWF0Y2hQb3MgPSBzdGFydCA9IGkgKyAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBhZGRNYXRjaChudWxsLCB0ZXh0Lmxlbmd0aCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBoaWdobGlnaHQodGV4dCwgb3B0aW9ucykgewogICAgICBmdW5jdGlvbiBub3JtYWxpemUodGV4dCkgewogICAgICAgIHRleHQgPSB0ZXh0LnRyaW1SaWdodCgpLnJlcGxhY2UoL1xyXG58XG5ccnxcci9nLCAiXG4iKTsKICAgICAgICBpZiAoIW9wdGlvbnMua2VlcEZvcm1hdCkgdGV4dCA9IHRleHQucmVwbGFjZSgvXig/OlxzKltcbl0rKSs/KFsgXHRdKikvLCAiJDEiKTsKICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cblsgXHRdKy9nLCBmdW5jdGlvbihtKSB7CiAgICAgICAgICByZXR1cm4gbS5yZXBsYWNlKC9cdC9nLCAiICAiKTsKICAgICAgICB9KS5yZXBsYWNlKC9cblsgXHRdK1xuL2csICJcblxuIik7CiAgICAgICAgaWYgKCFvcHRpb25zLmtlZXBGb3JtYXQpIHsKICAgICAgICAgIHZhciBtaW5PZmZzZXQgPSAxZTM7CiAgICAgICAgICB2YXIgbGluZXMgPSB0ZXh0LnNwbGl0KC9cbisvKTsKICAgICAgICAgIHZhciBzdGFydExpbmUgPSBOdW1iZXIodGV4dC5tYXRjaCgvXmZ1bmN0aW9uLykgIT0gbnVsbCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gc3RhcnRMaW5lOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG0gPSBsaW5lc1tpXS5tYXRjaCgvXlxzKi8pOwogICAgICAgICAgICBpZiAobVswXS5sZW5ndGggPCBtaW5PZmZzZXQpIG1pbk9mZnNldCA9IG1bMF0ubGVuZ3RoOwogICAgICAgICAgICBpZiAobWluT2Zmc2V0ID09IDApIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1pbk9mZnNldCA+IDApIHRleHQgPSB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cCgiKF58XFxuKSB7IiArIG1pbk9mZnNldCArICJ9IiwgImciKSwgIiQxIik7CiAgICAgICAgfQogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cCgiKF58XFxuKSggKykiLCAiZyIpLCBmdW5jdGlvbihtLCBhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSArIHJlcGVhdCgiwqAiLCBiLmxlbmd0aCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgIHZhciBodG1sID0gcGFyc2Uobm9ybWFsaXplKHRleHQgfHwgIiIpLnJlcGxhY2UoLzwvZywgIiZsdDsiKSk7CiAgICAgIHZhciBsaW5lcyA9IGh0bWwuam9pbigiIikuc3BsaXQoIlxuIik7CiAgICAgIHZhciBudW1iZXJXaWR0aCA9IFN0cmluZyhsaW5lcy5sZW5ndGgpLmxlbmd0aDsKICAgICAgdmFyIGxpbmVDbGFzcyA9IG9wdGlvbnMubm9MaW5lTnVtYmVyID8gIiIgOiAiIGhhc0xpbmVOdW1iZXIiOwogICAgICB2YXIgcmVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHJlcy5wdXNoKCc8ZGl2IGNsYXNzPSJsaW5lICcgKyAoaSAlIDIgPyAib2RkIiA6ICJldmVuIikgKyBsaW5lQ2xhc3MgKyAnIj4nICsgJzxzcGFuIGNsYXNzPSJsaW5lQ29udGVudCI+JyArICghb3B0aW9ucy5ub0xpbmVOdW1iZXIgPyAnPGlucHV0IGNsYXNzPSJsaW5lTnVtYmVyIiB2YWx1ZT0iJyArIGxlYWQoaSArIDEsIG51bWJlcldpZHRoKSArICciIHR5cGU9Im5vbmUiIHVuc2VsZWN0YWJsZT0ib24iIHJlYWRvbmx5PSJyZWFkb25seSIgdGFiaW5kZXg9Ii0xIiAvPicgKyAnPHNwYW4gY2xhc3M9Im92ZXIiPjwvc3Bhbj4nIDogIiIpICsgKGxpbmVzW2ldICsgIlxyXG4iKSArICI8L3NwYW4+IiArICI8L2Rpdj4iKTsKICAgICAgcmV0dXJuIHJlcy5qb2luKCIiKTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gaGlnaGxpZ2h0OwogIH0sCiAgIm8uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBKc0RpZmYgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gY2xvbmVQYXRoKHBhdGgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3UG9zOiBwYXRoLm5ld1BvcywKICAgICAgICAgIGNvbXBvbmVudHM6IHBhdGguY29tcG9uZW50cy5zbGljZSgwKQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVtb3ZlRW1wdHkoYXJyYXkpIHsKICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGFycmF5W2ldKSB7CiAgICAgICAgICAgIHJldC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgICBmdW5jdGlvbiBlc2NhcGVIVE1MKHMpIHsKICAgICAgICB2YXIgbiA9IHM7CiAgICAgICAgbiA9IG4ucmVwbGFjZSgvJi9nLCAiJmFtcDsiKTsKICAgICAgICBuID0gbi5yZXBsYWNlKC88L2csICImbHQ7Iik7CiAgICAgICAgbiA9IG4ucmVwbGFjZSgvPi9nLCAiJmd0OyIpOwogICAgICAgIG4gPSBuLnJlcGxhY2UoLyIvZywgIiZxdW90OyIpOwogICAgICAgIHJldHVybiBuOwogICAgICB9CiAgICAgIHZhciBEaWZmID0gZnVuY3Rpb24oaWdub3JlV2hpdGVzcGFjZSkgewogICAgICAgIHRoaXMuaWdub3JlV2hpdGVzcGFjZSA9IGlnbm9yZVdoaXRlc3BhY2U7CiAgICAgIH07CiAgICAgIERpZmYucHJvdG90eXBlID0gewogICAgICAgIGRpZmY6IGZ1bmN0aW9uKG9sZFN0cmluZywgbmV3U3RyaW5nKSB7CiAgICAgICAgICBpZiAobmV3U3RyaW5nID09PSBvbGRTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIFsgewogICAgICAgICAgICAgIHZhbHVlOiBuZXdTdHJpbmcKICAgICAgICAgICAgfSBdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFuZXdTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIFsgewogICAgICAgICAgICAgIHZhbHVlOiBvbGRTdHJpbmcsCiAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZQogICAgICAgICAgICB9IF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9sZFN0cmluZykgewogICAgICAgICAgICByZXR1cm4gWyB7CiAgICAgICAgICAgICAgdmFsdWU6IG5ld1N0cmluZywKICAgICAgICAgICAgICBhZGRlZDogdHJ1ZQogICAgICAgICAgICB9IF07CiAgICAgICAgICB9CiAgICAgICAgICBuZXdTdHJpbmcgPSB0aGlzLnRva2VuaXplKG5ld1N0cmluZyk7CiAgICAgICAgICBvbGRTdHJpbmcgPSB0aGlzLnRva2VuaXplKG9sZFN0cmluZyk7CiAgICAgICAgICB2YXIgbmV3TGVuID0gbmV3U3RyaW5nLmxlbmd0aCwgb2xkTGVuID0gb2xkU3RyaW5nLmxlbmd0aDsKICAgICAgICAgIHZhciBtYXhFZGl0TGVuZ3RoID0gbmV3TGVuICsgb2xkTGVuOwogICAgICAgICAgdmFyIGJlc3RQYXRoID0gWyB7CiAgICAgICAgICAgIG5ld1BvczogLTEsCiAgICAgICAgICAgIGNvbXBvbmVudHM6IFtdCiAgICAgICAgICB9IF07CiAgICAgICAgICB2YXIgb2xkUG9zID0gdGhpcy5leHRyYWN0Q29tbW9uKGJlc3RQYXRoWzBdLCBuZXdTdHJpbmcsIG9sZFN0cmluZywgMCk7CiAgICAgICAgICBpZiAoYmVzdFBhdGhbMF0ubmV3UG9zICsgMSA+PSBuZXdMZW4gJiYgb2xkUG9zICsgMSA+PSBvbGRMZW4pIHsKICAgICAgICAgICAgcmV0dXJuIGJlc3RQYXRoWzBdLmNvbXBvbmVudHM7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBlZGl0TGVuZ3RoID0gMTsgZWRpdExlbmd0aCA8PSBtYXhFZGl0TGVuZ3RoOyBlZGl0TGVuZ3RoKyspIHsKICAgICAgICAgICAgZm9yICh2YXIgZGlhZ29uYWxQYXRoID0gLTEgKiBlZGl0TGVuZ3RoOyBkaWFnb25hbFBhdGggPD0gZWRpdExlbmd0aDsgZGlhZ29uYWxQYXRoICs9IDIpIHsKICAgICAgICAgICAgICB2YXIgYmFzZVBhdGg7CiAgICAgICAgICAgICAgdmFyIGFkZFBhdGggPSBiZXN0UGF0aFtkaWFnb25hbFBhdGggLSAxXSwgcmVtb3ZlUGF0aCA9IGJlc3RQYXRoW2RpYWdvbmFsUGF0aCArIDFdOwogICAgICAgICAgICAgIG9sZFBvcyA9IChyZW1vdmVQYXRoID8gcmVtb3ZlUGF0aC5uZXdQb3MgOiAwKSAtIGRpYWdvbmFsUGF0aDsKICAgICAgICAgICAgICBpZiAoYWRkUGF0aCkgewogICAgICAgICAgICAgICAgYmVzdFBhdGhbZGlhZ29uYWxQYXRoIC0gMV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjYW5BZGQgPSBhZGRQYXRoICYmIGFkZFBhdGgubmV3UG9zICsgMSA8IG5ld0xlbjsKICAgICAgICAgICAgICB2YXIgY2FuUmVtb3ZlID0gcmVtb3ZlUGF0aCAmJiAwIDw9IG9sZFBvcyAmJiBvbGRQb3MgPCBvbGRMZW47CiAgICAgICAgICAgICAgaWYgKCFjYW5BZGQgJiYgIWNhblJlbW92ZSkgewogICAgICAgICAgICAgICAgYmVzdFBhdGhbZGlhZ29uYWxQYXRoXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWNhbkFkZCB8fCBjYW5SZW1vdmUgJiYgYWRkUGF0aC5uZXdQb3MgPCByZW1vdmVQYXRoLm5ld1BvcykgewogICAgICAgICAgICAgICAgYmFzZVBhdGggPSBjbG9uZVBhdGgocmVtb3ZlUGF0aCk7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hDb21wb25lbnQoYmFzZVBhdGguY29tcG9uZW50cywgb2xkU3RyaW5nW29sZFBvc10sIHVuZGVmaW5lZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJhc2VQYXRoID0gY2xvbmVQYXRoKGFkZFBhdGgpOwogICAgICAgICAgICAgICAgYmFzZVBhdGgubmV3UG9zKys7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hDb21wb25lbnQoYmFzZVBhdGguY29tcG9uZW50cywgbmV3U3RyaW5nW2Jhc2VQYXRoLm5ld1Bvc10sIHRydWUsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvbGRQb3MgPSB0aGlzLmV4dHJhY3RDb21tb24oYmFzZVBhdGgsIG5ld1N0cmluZywgb2xkU3RyaW5nLCBkaWFnb25hbFBhdGgpOwogICAgICAgICAgICAgIGlmIChiYXNlUGF0aC5uZXdQb3MgKyAxID49IG5ld0xlbiAmJiBvbGRQb3MgKyAxID49IG9sZExlbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGJhc2VQYXRoLmNvbXBvbmVudHM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJlc3RQYXRoW2RpYWdvbmFsUGF0aF0gPSBiYXNlUGF0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHB1c2hDb21wb25lbnQ6IGZ1bmN0aW9uKGNvbXBvbmVudHMsIHZhbHVlLCBhZGRlZCwgcmVtb3ZlZCkgewogICAgICAgICAgdmFyIGxhc3QgPSBjb21wb25lbnRzW2NvbXBvbmVudHMubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAobGFzdCAmJiBsYXN0LmFkZGVkID09PSBhZGRlZCAmJiBsYXN0LnJlbW92ZWQgPT09IHJlbW92ZWQpIHsKICAgICAgICAgICAgY29tcG9uZW50c1tjb21wb25lbnRzLmxlbmd0aCAtIDFdID0gewogICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmpvaW4obGFzdC52YWx1ZSwgdmFsdWUpLAogICAgICAgICAgICAgIGFkZGVkOiBhZGRlZCwKICAgICAgICAgICAgICByZW1vdmVkOiByZW1vdmVkCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb21wb25lbnRzLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBhZGRlZDogYWRkZWQsCiAgICAgICAgICAgICAgcmVtb3ZlZDogcmVtb3ZlZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGV4dHJhY3RDb21tb246IGZ1bmN0aW9uKGJhc2VQYXRoLCBuZXdTdHJpbmcsIG9sZFN0cmluZywgZGlhZ29uYWxQYXRoKSB7CiAgICAgICAgICB2YXIgbmV3TGVuID0gbmV3U3RyaW5nLmxlbmd0aCwgb2xkTGVuID0gb2xkU3RyaW5nLmxlbmd0aCwgbmV3UG9zID0gYmFzZVBhdGgubmV3UG9zLCBvbGRQb3MgPSBuZXdQb3MgLSBkaWFnb25hbFBhdGg7CiAgICAgICAgICB3aGlsZSAobmV3UG9zICsgMSA8IG5ld0xlbiAmJiBvbGRQb3MgKyAxIDwgb2xkTGVuICYmIHRoaXMuZXF1YWxzKG5ld1N0cmluZ1tuZXdQb3MgKyAxXSwgb2xkU3RyaW5nW29sZFBvcyArIDFdKSkgewogICAgICAgICAgICBuZXdQb3MrKzsKICAgICAgICAgICAgb2xkUG9zKys7CiAgICAgICAgICAgIHRoaXMucHVzaENvbXBvbmVudChiYXNlUGF0aC5jb21wb25lbnRzLCBuZXdTdHJpbmdbbmV3UG9zXSwgdW5kZWZpbmVkLCB1bmRlZmluZWQpOwogICAgICAgICAgfQogICAgICAgICAgYmFzZVBhdGgubmV3UG9zID0gbmV3UG9zOwogICAgICAgICAgcmV0dXJuIG9sZFBvczsKICAgICAgICB9LAogICAgICAgIGVxdWFsczogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgIHZhciByZVdoaXRlc3BhY2UgPSAvXFMvOwogICAgICAgICAgaWYgKHRoaXMuaWdub3JlV2hpdGVzcGFjZSAmJiAhcmVXaGl0ZXNwYWNlLnRlc3QobGVmdCkgJiYgIXJlV2hpdGVzcGFjZS50ZXN0KHJpZ2h0KSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGpvaW46IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICByZXR1cm4gbGVmdCArIHJpZ2h0OwogICAgICAgIH0sCiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgQ2hhckRpZmYgPSBuZXcgRGlmZjsKICAgICAgdmFyIFdvcmREaWZmID0gbmV3IERpZmYodHJ1ZSk7CiAgICAgIHZhciBXb3JkV2l0aFNwYWNlRGlmZiA9IG5ldyBEaWZmOwogICAgICBXb3JkRGlmZi50b2tlbml6ZSA9IFdvcmRXaXRoU3BhY2VEaWZmLnRva2VuaXplID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVtb3ZlRW1wdHkodmFsdWUuc3BsaXQoLyhccyt8XGIpLykpOwogICAgICB9OwogICAgICB2YXIgQ3NzRGlmZiA9IG5ldyBEaWZmKHRydWUpOwogICAgICBDc3NEaWZmLnRva2VuaXplID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVtb3ZlRW1wdHkodmFsdWUuc3BsaXQoLyhbe306OyxdfFxzKykvKSk7CiAgICAgIH07CiAgICAgIHZhciBMaW5lRGlmZiA9IG5ldyBEaWZmOwogICAgICBMaW5lRGlmZi50b2tlbml6ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIHJldExpbmVzID0gW10sIGxpbmVzID0gdmFsdWUuc3BsaXQoL14vbSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGxpbmUgPSBsaW5lc1tpXSwgbGFzdExpbmUgPSBsaW5lc1tpIC0gMV07CiAgICAgICAgICBpZiAobGluZSA9PSAiXG4iICYmIGxhc3RMaW5lICYmIGxhc3RMaW5lW2xhc3RMaW5lLmxlbmd0aCAtIDFdID09PSAiXHIiKSB7CiAgICAgICAgICAgIHJldExpbmVzW3JldExpbmVzLmxlbmd0aCAtIDFdICs9ICJcbiI7CiAgICAgICAgICB9IGVsc2UgaWYgKGxpbmUpIHsKICAgICAgICAgICAgcmV0TGluZXMucHVzaChsaW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldExpbmVzOwogICAgICB9OwogICAgICByZXR1cm4gewogICAgICAgIERpZmY6IERpZmYsCiAgICAgICAgZGlmZkNoYXJzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIENoYXJEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZldvcmRzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIFdvcmREaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZldvcmRzV2l0aFNwYWNlOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIFdvcmRXaXRoU3BhY2VEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZkxpbmVzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIExpbmVEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZkNzczogZnVuY3Rpb24ob2xkU3RyLCBuZXdTdHIpIHsKICAgICAgICAgIHJldHVybiBDc3NEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlUGF0Y2g6IGZ1bmN0aW9uKGZpbGVOYW1lLCBvbGRTdHIsIG5ld1N0ciwgb2xkSGVhZGVyLCBuZXdIZWFkZXIpIHsKICAgICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICAgIHJldC5wdXNoKCJJbmRleDogIiArIGZpbGVOYW1lKTsKICAgICAgICAgIHJldC5wdXNoKCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Iik7CiAgICAgICAgICByZXQucHVzaCgiLS0tICIgKyBmaWxlTmFtZSArICh0eXBlb2Ygb2xkSGVhZGVyID09PSAidW5kZWZpbmVkIiA/ICIiIDogIgkiICsgb2xkSGVhZGVyKSk7CiAgICAgICAgICByZXQucHVzaCgiKysrICIgKyBmaWxlTmFtZSArICh0eXBlb2YgbmV3SGVhZGVyID09PSAidW5kZWZpbmVkIiA/ICIiIDogIgkiICsgbmV3SGVhZGVyKSk7CiAgICAgICAgICB2YXIgZGlmZiA9IExpbmVEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgICAgaWYgKCFkaWZmW2RpZmYubGVuZ3RoIC0gMV0udmFsdWUpIHsKICAgICAgICAgICAgZGlmZi5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICAgIGRpZmYucHVzaCh7CiAgICAgICAgICAgIHZhbHVlOiAiIiwKICAgICAgICAgICAgbGluZXM6IFtdCiAgICAgICAgICB9KTsKICAgICAgICAgIGZ1bmN0aW9uIGNvbnRleHRMaW5lcyhsaW5lcykgewogICAgICAgICAgICByZXR1cm4gbGluZXMubWFwKGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICIgIiArIGVudHJ5OwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVvZk5MKGN1clJhbmdlLCBpLCBjdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBsYXN0ID0gZGlmZltkaWZmLmxlbmd0aCAtIDJdLCBpc0xhc3QgPSBpID09PSBkaWZmLmxlbmd0aCAtIDIsIGlzTGFzdE9mVHlwZSA9IGkgPT09IGRpZmYubGVuZ3RoIC0gMyAmJiAoY3VycmVudC5hZGRlZCAhPT0gbGFzdC5hZGRlZCB8fCBjdXJyZW50LnJlbW92ZWQgIT09IGxhc3QucmVtb3ZlZCk7CiAgICAgICAgICAgIGlmICghL1xuJC8udGVzdChjdXJyZW50LnZhbHVlKSAmJiAoaXNMYXN0IHx8IGlzTGFzdE9mVHlwZSkpIHsKICAgICAgICAgICAgICBjdXJSYW5nZS5wdXNoKCJcXCBObyBuZXdsaW5lIGF0IGVuZCBvZiBmaWxlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBvbGRSYW5nZVN0YXJ0ID0gMCwgbmV3UmFuZ2VTdGFydCA9IDAsIGN1clJhbmdlID0gW10sIG9sZExpbmUgPSAxLCBuZXdMaW5lID0gMTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlmZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IGRpZmZbaV0sIGxpbmVzID0gY3VycmVudC5saW5lcyB8fCBjdXJyZW50LnZhbHVlLnJlcGxhY2UoL1xuJC8sICIiKS5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgY3VycmVudC5saW5lcyA9IGxpbmVzOwogICAgICAgICAgICBpZiAoY3VycmVudC5hZGRlZCB8fCBjdXJyZW50LnJlbW92ZWQpIHsKICAgICAgICAgICAgICBpZiAoIW9sZFJhbmdlU3RhcnQpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gZGlmZltpIC0gMV07CiAgICAgICAgICAgICAgICBvbGRSYW5nZVN0YXJ0ID0gb2xkTGluZTsKICAgICAgICAgICAgICAgIG5ld1JhbmdlU3RhcnQgPSBuZXdMaW5lOwogICAgICAgICAgICAgICAgaWYgKHByZXYpIHsKICAgICAgICAgICAgICAgICAgY3VyUmFuZ2UgPSBjb250ZXh0TGluZXMocHJldi5saW5lcy5zbGljZSgtNCkpOwogICAgICAgICAgICAgICAgICBvbGRSYW5nZVN0YXJ0IC09IGN1clJhbmdlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgbmV3UmFuZ2VTdGFydCAtPSBjdXJSYW5nZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1clJhbmdlLnB1c2guYXBwbHkoY3VyUmFuZ2UsIGxpbmVzLm1hcChmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuIChjdXJyZW50LmFkZGVkID8gIisiIDogIi0iKSArIGVudHJ5OwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICBlb2ZOTChjdXJSYW5nZSwgaSwgY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuYWRkZWQpIHsKICAgICAgICAgICAgICAgIG5ld0xpbmUgKz0gbGluZXMubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvbGRMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKG9sZFJhbmdlU3RhcnQpIHsKICAgICAgICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGggPD0gOCAmJiBpIDwgZGlmZi5sZW5ndGggLSAyKSB7CiAgICAgICAgICAgICAgICAgIGN1clJhbmdlLnB1c2guYXBwbHkoY3VyUmFuZ2UsIGNvbnRleHRMaW5lcyhsaW5lcykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHRTaXplID0gTWF0aC5taW4obGluZXMubGVuZ3RoLCA0KTsKICAgICAgICAgICAgICAgICAgcmV0LnB1c2goIkBAIC0iICsgb2xkUmFuZ2VTdGFydCArICIsIiArIChvbGRMaW5lIC0gb2xkUmFuZ2VTdGFydCArIGNvbnRleHRTaXplKSArICIgKyIgKyBuZXdSYW5nZVN0YXJ0ICsgIiwiICsgKG5ld0xpbmUgLSBuZXdSYW5nZVN0YXJ0ICsgY29udGV4dFNpemUpICsgIiBAQCIpOwogICAgICAgICAgICAgICAgICByZXQucHVzaC5hcHBseShyZXQsIGN1clJhbmdlKTsKICAgICAgICAgICAgICAgICAgcmV0LnB1c2guYXBwbHkocmV0LCBjb250ZXh0TGluZXMobGluZXMuc2xpY2UoMCwgY29udGV4dFNpemUpKSk7CiAgICAgICAgICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGggPD0gNCkgewogICAgICAgICAgICAgICAgICAgIGVvZk5MKHJldCwgaSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgb2xkUmFuZ2VTdGFydCA9IDA7CiAgICAgICAgICAgICAgICAgIG5ld1JhbmdlU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgICBjdXJSYW5nZSA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvbGRMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgICBuZXdMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJldC5qb2luKCJcbiIpICsgIlxuIjsKICAgICAgICB9LAogICAgICAgIGFwcGx5UGF0Y2g6IGZ1bmN0aW9uKG9sZFN0ciwgdW5pRGlmZikgewogICAgICAgICAgdmFyIGRpZmZzdHIgPSB1bmlEaWZmLnNwbGl0KCJcbiIpOwogICAgICAgICAgdmFyIGRpZmYgPSBbXTsKICAgICAgICAgIHZhciByZW1FT0ZOTCA9IGZhbHNlLCBhZGRFT0ZOTCA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIgaSA9IGRpZmZzdHJbMF1bMF0gPT09ICJJIiA/IDQgOiAwOyBpIDwgZGlmZnN0ci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZGlmZnN0cltpXVswXSA9PT0gIkAiKSB7CiAgICAgICAgICAgICAgdmFyIG1laCA9IGRpZmZzdHJbaV0uc3BsaXQoL0BAIC0oXGQrKSwoXGQrKSBcKyhcZCspLChcZCspIEBALyk7CiAgICAgICAgICAgICAgZGlmZi51bnNoaWZ0KHsKICAgICAgICAgICAgICAgIHN0YXJ0OiBtZWhbM10sCiAgICAgICAgICAgICAgICBvbGRsZW5ndGg6IG1laFsyXSwKICAgICAgICAgICAgICAgIG9sZGxpbmVzOiBbXSwKICAgICAgICAgICAgICAgIG5ld2xlbmd0aDogbWVoWzRdLAogICAgICAgICAgICAgICAgbmV3bGluZXM6IFtdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlmZnN0cltpXVswXSA9PT0gIisiKSB7CiAgICAgICAgICAgICAgZGlmZlswXS5uZXdsaW5lcy5wdXNoKGRpZmZzdHJbaV0uc3Vic3RyKDEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkaWZmc3RyW2ldWzBdID09PSAiLSIpIHsKICAgICAgICAgICAgICBkaWZmWzBdLm9sZGxpbmVzLnB1c2goZGlmZnN0cltpXS5zdWJzdHIoMSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRpZmZzdHJbaV1bMF0gPT09ICIgIikgewogICAgICAgICAgICAgIGRpZmZbMF0ubmV3bGluZXMucHVzaChkaWZmc3RyW2ldLnN1YnN0cigxKSk7CiAgICAgICAgICAgICAgZGlmZlswXS5vbGRsaW5lcy5wdXNoKGRpZmZzdHJbaV0uc3Vic3RyKDEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkaWZmc3RyW2ldWzBdID09PSAiXFwiKSB7CiAgICAgICAgICAgICAgaWYgKGRpZmZzdHJbaSAtIDFdWzBdID09PSAiKyIpIHsKICAgICAgICAgICAgICAgIHJlbUVPRk5MID0gdHJ1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpZmZzdHJbaSAtIDFdWzBdID09PSAiLSIpIHsKICAgICAgICAgICAgICAgIGFkZEVPRk5MID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdHIgPSBvbGRTdHIuc3BsaXQoIlxuIik7CiAgICAgICAgICBmb3IgKHZhciBpID0gZGlmZi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICB2YXIgZCA9IGRpZmZbaV07CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZC5vbGRsZW5ndGg7IGorKykgewogICAgICAgICAgICAgIGlmIChzdHJbZC5zdGFydCAtIDEgKyBqXSAhPT0gZC5vbGRsaW5lc1tqXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KHN0ciwgWyBkLnN0YXJ0IC0gMSwgK2Qub2xkbGVuZ3RoIF0uY29uY2F0KGQubmV3bGluZXMpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZW1FT0ZOTCkgewogICAgICAgICAgICB3aGlsZSAoIXN0cltzdHIubGVuZ3RoIC0gMV0pIHsKICAgICAgICAgICAgICBzdHIucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYWRkRU9GTkwpIHsKICAgICAgICAgICAgc3RyLnB1c2goIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0ci5qb2luKCJcbiIpOwogICAgICAgIH0sCiAgICAgICAgY29udmVydENoYW5nZXNUb1hNTDogZnVuY3Rpb24oY2hhbmdlcykgewogICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VzW2ldOwogICAgICAgICAgICBpZiAoY2hhbmdlLmFkZGVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjxpbnM+Iik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnJlbW92ZWQpIHsKICAgICAgICAgICAgICByZXQucHVzaCgiPGRlbD4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXQucHVzaChlc2NhcGVIVE1MKGNoYW5nZS52YWx1ZSkpOwogICAgICAgICAgICBpZiAoY2hhbmdlLmFkZGVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjwvaW5zPiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS5yZW1vdmVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjwvZGVsPiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmV0LmpvaW4oIiIpOwogICAgICAgIH0sCiAgICAgICAgY29udmVydENoYW5nZXNUb0RNUDogZnVuY3Rpb24oY2hhbmdlcykgewogICAgICAgICAgdmFyIHJldCA9IFtdLCBjaGFuZ2U7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2hhbmdlID0gY2hhbmdlc1tpXTsKICAgICAgICAgICAgcmV0LnB1c2goWyBjaGFuZ2UuYWRkZWQgPyAxIDogY2hhbmdlLnJlbW92ZWQgPyAtMSA6IDAsIGNoYW5nZS52YWx1ZSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICB9OwogICAgfSgpOwogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gSnNEaWZmOwogICAgfQogIH0sCiAgIjUuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIHZhbHVlcyA9IGJhc2lzLm9iamVjdC52YWx1ZXM7CiAgICB2YXIgJHNlbGYgPSBiYXNpcy5mbi4kc2VsZjsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBldmVudHMgPSBiYXNpcy5ldmVudC5ldmVudHM7CiAgICB2YXIgTlVMTF9PQkpFQ1QgPSB7fTsKICAgIHZhciBFTVBUWV9BUlJBWSA9IFtdOwogICAgdmFyIFNUQVRFX0VYSVNUUyA9IHt9OwogICAgdmFyIFNUQVRFID0gewogICAgICBwcmlvcml0eTogW10sCiAgICAgIHZhbHVlczoge30sCiAgICAgIGFkZDogZnVuY3Rpb24oc3RhdGUsIG9yZGVyKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzdGF0ZTsKICAgICAgICB2YXIgdmFsdWUgPSBzdGF0ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIFNUQVRFW25hbWVdID0gdmFsdWU7CiAgICAgICAgU1RBVEVfRVhJU1RTW3ZhbHVlXSA9IG5hbWU7CiAgICAgICAgdGhpcy52YWx1ZXNbdmFsdWVdID0gbmFtZTsKICAgICAgICBpZiAob3JkZXIpIG9yZGVyID0gdGhpcy5wcmlvcml0eS5pbmRleE9mKG9yZGVyKTsgZWxzZSBvcmRlciA9IC0xOwogICAgICAgIGlmIChvcmRlciA9PSAtMSkgdGhpcy5wcmlvcml0eS5wdXNoKHZhbHVlKTsgZWxzZSB0aGlzLnByaW9yaXR5LnNwbGljZShvcmRlciwgMCwgdmFsdWUpOwogICAgICB9LAogICAgICBnZXRMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdmFsdWVzKFNUQVRFX0VYSVNUUyk7CiAgICAgIH0KICAgIH07CiAgICBTVEFURS5hZGQoIlJFQURZIik7CiAgICBTVEFURS5hZGQoIkRFUFJFQ0FURUQiKTsKICAgIFNUQVRFLmFkZCgiVU5ERUZJTkVEIik7CiAgICBTVEFURS5hZGQoIkVSUk9SIik7CiAgICBTVEFURS5hZGQoIlBST0NFU1NJTkciKTsKICAgIHZhciBzdWJzY3JpcHRpb25Db25maWcgPSB7fTsKICAgIHZhciBzdWJzY3JpcHRpb25TZWVkID0gMTsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSB7CiAgICAgIE5PTkU6IDAsCiAgICAgIEFMTDogMCwKICAgICAgbGluazogZnVuY3Rpb24odHlwZSwgZnJvbSwgdG8pIHsKICAgICAgICB2YXIgc3Vic2NyaWJlcklkID0gdHlwZSArIGZyb20uYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgc3Vic2NyaWJlcnMgPSB0by5zdWJzY3JpYmVyc187CiAgICAgICAgaWYgKCFzdWJzY3JpYmVycykgc3Vic2NyaWJlcnMgPSB0by5zdWJzY3JpYmVyc18gPSB7fTsKICAgICAgICBpZiAoIXN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF0pIHsKICAgICAgICAgIHN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF0gPSBmcm9tOwogICAgICAgICAgdmFyIGNvdW50ID0gdG8uc3Vic2NyaWJlckNvdW50ICs9IDE7CiAgICAgICAgICBpZiAoY291bnQgPT0gMSkgdG8uZW1pdF9zdWJzY3JpYmVyc0NoYW5nZWQoKzEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiQXR0ZW1wdCB0byBhZGQgZHVwbGljYXRlIHN1YnNjcmlwdGlvbiIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdW5saW5rOiBmdW5jdGlvbih0eXBlLCBmcm9tLCB0bykgewogICAgICAgIHZhciBzdWJzY3JpYmVySWQgPSB0eXBlICsgZnJvbS5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXzsKICAgICAgICBpZiAoc3Vic2NyaWJlcnMgJiYgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSkgewogICAgICAgICAgZGVsZXRlIHN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF07CiAgICAgICAgICB2YXIgY291bnQgPSB0by5zdWJzY3JpYmVyQ291bnQgLT0gMTsKICAgICAgICAgIGlmIChjb3VudCA9PSAwKSB7CiAgICAgICAgICAgIHRvLmVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkKC0xKTsKICAgICAgICAgICAgdG8uc3Vic2NyaWJlcnNfID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlRyeWluZyByZW1vdmUgbm9uLWV4aXN0cyBzdWJzY3JpcHRpb24iKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24obmFtZSwgaGFuZGxlciwgYWN0aW9uKSB7CiAgICAgICAgc3Vic2NyaXB0aW9uQ29uZmlnW3N1YnNjcmlwdGlvblNlZWRdID0gewogICAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICAgIGFjdGlvbjogYWN0aW9uCiAgICAgICAgfTsKICAgICAgICBTVUJTQ1JJUFRJT05bbmFtZV0gPSBzdWJzY3JpcHRpb25TZWVkOwogICAgICAgIFNVQlNDUklQVElPTi5BTEwgfD0gc3Vic2NyaXB0aW9uU2VlZDsKICAgICAgICBzdWJzY3JpcHRpb25TZWVkIDw8PSAxOwogICAgICB9LAogICAgICBhZGRQcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHlOYW1lLCBldmVudE5hbWUpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IHt9OwogICAgICAgIGhhbmRsZXJbZXZlbnROYW1lIHx8IHByb3BlcnR5TmFtZSArICJDaGFuZ2VkIl0gPSBmdW5jdGlvbihvYmplY3QsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZiAob2xkVmFsdWUpIFNVQlNDUklQVElPTi51bmxpbmsocHJvcGVydHlOYW1lLCBvYmplY3QsIG9sZFZhbHVlKTsKICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHlOYW1lXSkgU1VCU0NSSVBUSU9OLmxpbmsocHJvcGVydHlOYW1lLCBvYmplY3QsIG9iamVjdFtwcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9OwogICAgICAgIHRoaXMuYWRkKHByb3BlcnR5TmFtZS50b1VwcGVyQ2FzZSgpLCBoYW5kbGVyLCBmdW5jdGlvbihmbiwgb2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0W3Byb3BlcnR5TmFtZV0pIGZuKHByb3BlcnR5TmFtZSwgb2JqZWN0LCBvYmplY3RbcHJvcGVydHlOYW1lXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgbWFza0NvbmZpZyA9IHt9OwogICAgZnVuY3Rpb24gbWl4RnVuY3Rpb25zKGZuQSwgZm5CKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBmbkEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBmbkIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE1hc2tDb25maWcobWFzaykgewogICAgICB2YXIgY29uZmlnID0gbWFza0NvbmZpZ1ttYXNrXTsKICAgICAgaWYgKCFjb25maWcpIHsKICAgICAgICB2YXIgYWN0aW9ucyA9IFtdOwogICAgICAgIHZhciBoYW5kbGVyID0ge307CiAgICAgICAgdmFyIGlkeCA9IDE7CiAgICAgICAgY29uZmlnID0gbWFza0NvbmZpZ1ttYXNrXSA9IHsKICAgICAgICAgIGFjdGlvbnM6IGFjdGlvbnMsCiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyCiAgICAgICAgfTsKICAgICAgICB3aGlsZSAobWFzaykgewogICAgICAgICAgaWYgKG1hc2sgJiAxKSB7CiAgICAgICAgICAgIHZhciBjZmcgPSBzdWJzY3JpcHRpb25Db25maWdbaWR4XTsKICAgICAgICAgICAgYWN0aW9ucy5wdXNoKGNmZy5hY3Rpb24pOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2ZnLmhhbmRsZXIpIGhhbmRsZXJba2V5XSA9IGhhbmRsZXJba2V5XSA/IG1peEZ1bmN0aW9ucyhoYW5kbGVyW2tleV0sIGNmZy5oYW5kbGVyW2tleV0pIDogY2ZnLmhhbmRsZXJba2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgIG1hc2sgPj49IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjb25maWc7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRTdWIob2JqZWN0LCBtYXNrKSB7CiAgICAgIHZhciBjb25maWcgPSBnZXRNYXNrQ29uZmlnKG1hc2spOwogICAgICBmb3IgKHZhciBpID0gMCwgYWN0aW9uOyBhY3Rpb24gPSBjb25maWcuYWN0aW9uc1tpXTsgaSsrKSBhY3Rpb24oU1VCU0NSSVBUSU9OLmxpbmssIG9iamVjdCk7CiAgICAgIG9iamVjdC5hZGRIYW5kbGVyKGNvbmZpZy5oYW5kbGVyKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbVN1YihvYmplY3QsIG1hc2spIHsKICAgICAgdmFyIGNvbmZpZyA9IGdldE1hc2tDb25maWcobWFzayk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2krK107ICkgYWN0aW9uKFNVQlNDUklQVElPTi51bmxpbmssIG9iamVjdCk7CiAgICAgIG9iamVjdC5yZW1vdmVIYW5kbGVyKGNvbmZpZy5oYW5kbGVyKTsKICAgIH0KICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgiZGVsZWdhdGUiKTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgidGFyZ2V0Iik7CiAgICBTVUJTQ1JJUFRJT04uYWRkUHJvcGVydHkoImRhdGFzZXQiKTsKICAgIHZhciBBYnN0cmFjdERhdGEgPSBDbGFzcyhFbWl0dGVyLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdERhdGEiLAogICAgICBzdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X3N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInN0YXRlQ2hhbmdlZCIsICJvbGRTdGF0ZSIpLAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBlbWl0X2FjdGl2ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJhY3RpdmVDaGFuZ2VkIiksCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uTk9ORSwKICAgICAgc3Vic2NyaWJlckNvdW50OiAwLAogICAgICBzdWJzY3JpYmVyc186IG51bGwsCiAgICAgIGVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3Vic2NyaWJlcnNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHN5bmNFdmVudHM6IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHkoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNTeW5jUmVxdWlyZWQoKSkgdGhpcy5zeW5jQWN0aW9uKCk7CiAgICAgIH0sIHsKICAgICAgICBzdGF0ZUNoYW5nZWQ6IHRydWUsCiAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiB0cnVlCiAgICAgIH0pLAogICAgICBzeW5jQWN0aW9uOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLmFkZEhhbmRsZXIoZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKS5oYW5kbGVyKTsKICAgICAgICB2YXIgc3luY0FjdGlvbiA9IHRoaXMuc3luY0FjdGlvbjsKICAgICAgICBpZiAoc3luY0FjdGlvbikgewogICAgICAgICAgdGhpcy5zeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0U3luY0FjdGlvbihzeW5jQWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN0YXRlOiBmdW5jdGlvbihzdGF0ZSwgZGF0YSkgewogICAgICAgIHZhciBzdGF0ZUNvZGUgPSBTdHJpbmcoc3RhdGUpOwogICAgICAgIGlmICghU1RBVEVfRVhJU1RTW3N0YXRlQ29kZV0pIHRocm93IG5ldyBFcnJvcigiV3Jvbmcgc3RhdGUgdmFsdWUiKTsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgdGhpcy5zdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLnN0YXRlLmRhdGEgPSBkYXRhOwogICAgICAgICAgdGhpcy5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBkZXByZWNhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0YXRlICE9IFNUQVRFLlBST0NFU1NJTkcpIHRoaXMuc2V0U3RhdGUoU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldEFjdGl2ZTogZnVuY3Rpb24oaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9ICEhaXNBY3RpdmU7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlICE9IGlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgdGhpcy5lbWl0X2FjdGl2ZUNoYW5nZWQoKTsKICAgICAgICAgIGlmIChpc0FjdGl2ZSkgYWRkU3ViKHRoaXMsIHRoaXMuc3Vic2NyaWJlVG8pOyBlbHNlIHJlbVN1Yih0aGlzLCB0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIHNldFN1YnNjcmlwdGlvbjogZnVuY3Rpb24oc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIHZhciBjdXJTdWJzY3JpcHRpb25UeXBlID0gdGhpcy5zdWJzY3JpYmVUbzsKICAgICAgICB2YXIgbmV3U3Vic2NyaXB0aW9uVHlwZSA9IHN1YnNjcmlwdGlvblR5cGUgJiBTVUJTQ1JJUFRJT04uQUxMOwogICAgICAgIHZhciBkZWx0YSA9IGN1clN1YnNjcmlwdGlvblR5cGUgXiBuZXdTdWJzY3JpcHRpb25UeXBlOwogICAgICAgIGlmIChkZWx0YSkgewogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUbyA9IG5ld1N1YnNjcmlwdGlvblR5cGU7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgdmFyIGN1ckNvbmZpZyA9IGdldE1hc2tDb25maWcoY3VyU3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIHZhciBuZXdDb25maWcgPSBnZXRNYXNrQ29uZmlnKG5ld1N1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoY3VyQ29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIobmV3Q29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICAgICAgd2hpbGUgKGRlbHRhKSB7CiAgICAgICAgICAgICAgaWYgKGRlbHRhICYgMSkgewogICAgICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICAgICAgaWYgKGN1clN1YnNjcmlwdGlvblR5cGUgJiBpZHgpIGNmZy5hY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgdGhpcyk7IGVsc2UgY2ZnLmFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgdGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgICAgICBkZWx0YSA+Pj0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZXJDb3VudCA+IDAgJiYgKHRoaXMuc3RhdGUgPT0gU1RBVEUuVU5ERUZJTkVEIHx8IHRoaXMuc3RhdGUgPT0gU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICB2YXIgb2xkQWN0aW9uID0gdGhpcy5zeW5jQWN0aW9uOwogICAgICAgIGlmICh0eXBlb2Ygc3luY0FjdGlvbiAhPSAiZnVuY3Rpb24iKSBzeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICB0aGlzLnN5bmNBY3Rpb24gPSBzeW5jQWN0aW9uOwogICAgICAgIGlmIChzeW5jQWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW9sZEFjdGlvbikgdGhpcy5hZGRIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgICBpZiAodGhpcy5pc1N5bmNSZXF1aXJlZCgpKSB0aGlzLnN5bmNBY3Rpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9sZEFjdGlvbikgdGhpcy5yZW1vdmVIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04udW5saW5rLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGF0ZSA9IFNUQVRFLlVOREVGSU5FRDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgY29tcHV0ZUZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIHZhbHVlU2V0dGVycyA9IHt9OwogICAgdmFyIHZhbHVlU3luY1Rva2VuID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5zZXQodGhpcy5mbih2YWx1ZSkpOwogICAgfTsKICAgIHZhciBWQUxVRV9FTU1JVEVSX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHRoaXMudmFsdWUudW5saW5rKG9iamVjdCwgdGhpcy5mbik7CiAgICAgIH0KICAgIH07CiAgICB2YXIgVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHRoaXMuc2V0KG51bGwpOwogICAgICB9CiAgICB9OwogICAgdmFyIFZhbHVlID0gQ2xhc3MoQWJzdHJhY3REYXRhLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5WYWx1ZSIsCiAgICAgIGVtaXRfY2hhbmdlOiBjcmVhdGVFdmVudCgiY2hhbmdlIiwgIm9sZFZhbHVlIikgJiYgZnVuY3Rpb24ob2xkVmFsdWUpIHsKICAgICAgICBldmVudHMuY2hhbmdlLmNhbGwodGhpcywgb2xkVmFsdWUpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBjdXJzb3IuZm4uY2FsbChjdXJzb3IuY29udGV4dCwgdGhpcy52YWx1ZSwgb2xkVmFsdWUpOwogICAgICB9LAogICAgICB2YWx1ZTogbnVsbCwKICAgICAgaW5pdFZhbHVlOiBudWxsLAogICAgICBwcm94eTogbnVsbCwKICAgICAgbG9ja2VkOiBmYWxzZSwKICAgICAgbG9ja2VkVmFsdWVfOiBudWxsLAogICAgICBsaW5rc186IG51bGwsCiAgICAgIHNldE51bGxPbkVtaXR0ZXJEZXN0cm95OiB0cnVlLAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbihob3N0LCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaG9zdC5saW5rKGNvbnRleHQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGhvc3QudW5saW5rKGNvbnRleHQsIGNhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgICAgcmV0dXJuIGhvc3QudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5wcm94eSkgdGhpcy52YWx1ZSA9IHRoaXMucHJveHkodGhpcy52YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kgJiYgdGhpcy52YWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIHRoaXMudmFsdWUuYWRkSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy52YWx1ZTsKICAgICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnByb3h5ID8gdGhpcy5wcm94eSh2YWx1ZSkgOiB2YWx1ZTsKICAgICAgICB2YXIgY2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBvbGRWYWx1ZTsKICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgb2xkVmFsdWUucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIG5ld1ZhbHVlLmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgdGhpcy5lbWl0X2NoYW5nZShvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy5pbml0VmFsdWUpOwogICAgICB9LAogICAgICBsb2NrOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMubG9ja2VkKSB7CiAgICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLmxvY2tlZFZhbHVlXyA9IHRoaXMudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmxvY2tlZCkgewogICAgICAgICAgdmFyIGxvY2tlZFZhbHVlID0gdGhpcy5sb2NrZWRWYWx1ZV87CiAgICAgICAgICB0aGlzLmxvY2tlZFZhbHVlXyA9IG51bGw7CiAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IGxvY2tlZFZhbHVlKSB0aGlzLmVtaXRfY2hhbmdlKGxvY2tlZFZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICBmbiA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBob3N0VmFsdWUgPSB0aGlzOwogICAgICAgIHZhciBoYW5kbGVyID0gYmFzaXMuZXZlbnQuY3JlYXRlSGFuZGxlcihldmVudHMsIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgdGhpcy5zZXQoZm4ob2JqZWN0LCBob3N0VmFsdWUudmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgZ2V0Q29tcHV0ZVRva2VuSWQgPSBoYW5kbGVyLmV2ZW50cy5jb25jYXQoU3RyaW5nKGZuKSwgdGhpcy5iYXNpc09iamVjdElkKS5qb2luKCJfIik7CiAgICAgICAgdmFyIGdldENvbXB1dGVUb2tlbiA9IGNvbXB1dGVGdW5jdGlvbnNbZ2V0Q29tcHV0ZVRva2VuSWRdOwogICAgICAgIGlmICghZ2V0Q29tcHV0ZVRva2VuKSB7CiAgICAgICAgICB2YXIgdG9rZW5NYXAgPSB7fTsKICAgICAgICAgIGhhbmRsZXIuZGVzdHJveSA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgdG9rZW5NYXBbb2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoewogICAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0b2tlbk1hcCkgewogICAgICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtrZXldOwogICAgICAgICAgICAgICAgcGFpci50b2tlbi5zZXQoZm4ocGFpci5vYmplY3QsIHRoaXMudmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0b2tlbk1hcCkgewogICAgICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtrZXldOwogICAgICAgICAgICAgICAgcGFpci5vYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBwYWlyLnRva2VuKTsKICAgICAgICAgICAgICAgIHBhaXIudG9rZW4uZGVzdHJveSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0b2tlbk1hcCA9IG51bGw7CiAgICAgICAgICAgICAgaG9zdFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBnZXRDb21wdXRlVG9rZW4gPSBjb21wdXRlRnVuY3Rpb25zW2dldENvbXB1dGVUb2tlbklkXSA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlciA9PSBmYWxzZSkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRhdGEuVmFsdWUjY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBiYXNpcy5ldmVudC5FbWl0dGVyIik7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZm4ob2JqZWN0LCBob3N0VmFsdWUudmFsdWUpOwogICAgICAgICAgICBpZiAoIXBhaXIpIHsKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBuZXcgYmFzaXMuVG9rZW4odmFsdWUpOwogICAgICAgICAgICAgIG9iamVjdC5hZGRIYW5kbGVyKGhhbmRsZXIsIHRva2VuKTsKICAgICAgICAgICAgICBwYWlyID0gdG9rZW5NYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgICAgdG9rZW46IHRva2VuLAogICAgICAgICAgICAgICAgb2JqZWN0OiBvYmplY3QKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhaXIudG9rZW4uc2V0KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFpci50b2tlbjsKICAgICAgICAgIH07CiAgICAgICAgICBnZXRDb21wdXRlVG9rZW4uZGVmZXJyZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wdXRlVG9rZW4ob2JqZWN0KS5kZWZlcnJlZCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldENvbXB1dGVUb2tlbjsKICAgICAgfSwKICAgICAgYXM6IGZ1bmN0aW9uKGZuLCBkZWZlcnJlZCkgewogICAgICAgIGlmICh0aGlzLmxpbmtzXykgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4gJiYgY3Vyc29yLmNvbnRleHQuZm4gPT0gU3RyaW5nKGZuKSkgcmV0dXJuIGRlZmVycmVkID8gY3Vyc29yLmNvbnRleHQuZGVmZXJyZWQoKSA6IGN1cnNvci5jb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgdG9rZW4gPSBuZXcgYmFzaXMuVG9rZW47CiAgICAgICAgdG9rZW4uZm4gPSBmbjsKICAgICAgICB0aGlzLmxpbmsodG9rZW4sIHZhbHVlU3luY1Rva2VuKTsKICAgICAgICByZXR1cm4gZGVmZXJyZWQgPyB0b2tlbi5kZWZlcnJlZCgpIDogdG9rZW47CiAgICAgIH0sCiAgICAgIGRlZmVycmVkOiBmdW5jdGlvbihmbikgewogICAgICAgIHJldHVybiB0aGlzLmFzKGZuLCB0cnVlKTsKICAgICAgfSwKICAgICAgbGluazogZnVuY3Rpb24oY29udGV4dCwgZm4sIG5vQXBwbHkpIHsKICAgICAgICBpZiAodHlwZW9mIGZuICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eSA9IFN0cmluZyhmbik7CiAgICAgICAgICBmbiA9IHZhbHVlU2V0dGVyc1twcm9wZXJ0eV07CiAgICAgICAgICBpZiAoIWZuKSBmbiA9IHZhbHVlU2V0dGVyc1twcm9wZXJ0eV0gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5saW5rc18pIGlmIChjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCAmJiBjdXJzb3IuZm4gPT09IGZuKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIjYXR0YWNoOiBEdXBsaWNhdGUgbGluayBwYWlyIGNvbnRleHQtZm4iKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB0aGlzLmxpbmtzXyA9IHsKICAgICAgICAgIHZhbHVlOiB0aGlzLAogICAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgIGxpbmtzXzogdGhpcy5saW5rc18KICAgICAgICB9OwogICAgICAgIGlmIChjb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY29udGV4dC5hZGRIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgdGhpcy5saW5rc18pOwogICAgICAgIGlmICghbm9BcHBseSkgZm4uY2FsbChjb250ZXh0LCB0aGlzLnZhbHVlKTsKICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgfSwKICAgICAgdW5saW5rOiBmdW5jdGlvbihjb250ZXh0LCBmbikgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHZhciBwcmV2OwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBpZiAoY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQgJiYgKCFmbiB8fCBjdXJzb3IuZm4gPT09IGZuKSkgewogICAgICAgICAgY3Vyc29yLmZuID0gYmFzaXMuZm4uJHVuZGVmOwogICAgICAgICAgcHJldi5saW5rc18gPSBjdXJzb3IubGlua3NfOwogICAgICAgICAgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY3Vyc29yLmNvbnRleHQucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0hBTkRMRVIsIGN1cnNvcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5zZXROdWxsT25FbWl0dGVyRGVzdHJveSAmJiB0aGlzLnZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgdGhpcy52YWx1ZS5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfREVTVFJPWV9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY3Vyc29yLmNvbnRleHQucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0hBTkRMRVIsIGN1cnNvcik7CiAgICAgICAgdGhpcy5wcm94eSA9IG51bGw7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSBudWxsOwogICAgICAgIHRoaXMudmFsdWUgPSBudWxsOwogICAgICAgIHRoaXMubG9ja2VkVmFsdWVfID0gbnVsbDsKICAgICAgICB0aGlzLmxpbmtzXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGNhc3RWYWx1ZU1hcCA9IHt9OwogICAgVmFsdWUuZnJvbSA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICBpZiAob2JqIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgaGFuZGxlciA9IGJhc2lzLmV2ZW50LmNyZWF0ZUhhbmRsZXIoZXZlbnRzLCBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHRoaXMuc2V0KGdldHRlcihvYmplY3QpKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaWQgPSBoYW5kbGVyLmV2ZW50cy5jb25jYXQoU3RyaW5nKGdldHRlciksIG9iai5iYXNpc09iamVjdElkKS5qb2luKCJfIik7CiAgICAgICAgcmVzdWx0ID0gY2FzdFZhbHVlTWFwW2lkXTsKICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlcik7CiAgICAgICAgICByZXN1bHQgPSBjYXN0VmFsdWVNYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgdmFsdWU6IGdldHRlcihvYmopCiAgICAgICAgICB9KTsKICAgICAgICAgIGhhbmRsZXIuZGVzdHJveSA9IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICBkZWxldGUgY2FzdFZhbHVlTWFwW2lkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9OwogICAgICAgICAgb2JqLmFkZEhhbmRsZXIoaGFuZGxlciwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICB2YXIgaWQgPSBvYmouYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgYmluZGluZ0JyaWRnZSA9IG9iai5iaW5kaW5nQnJpZGdlOwogICAgICAgIGlmIChpZCAmJiBiaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICByZXN1bHQgPSBjYXN0VmFsdWVNYXBbaWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gY2FzdFZhbHVlTWFwW2lkXSA9IG5ldyBWYWx1ZSh7CiAgICAgICAgICAgICAgdmFsdWU6IGJpbmRpbmdCcmlkZ2UuZ2V0KG9iaikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJpbmRpbmdCcmlkZ2UuYXR0YWNoKG9iaiwgcmVzdWx0LnNldCwgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFyZXN1bHQpIHRocm93ICJCYWQgb2JqZWN0IHR5cGUiOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIFZhbHVlLmZhY3RvcnkgPSBmdW5jdGlvbihldmVudHMsIGdldHRlcikgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIFZhbHVlLmZyb20ob2JqZWN0LCBldmVudHMsIGdldHRlcik7CiAgICAgIH07CiAgICB9OwogICAgZnVuY3Rpb24gaXNDb25uZWN0ZWQoYSwgYikgewogICAgICB3aGlsZSAoYiAmJiBiICE9PSBhICYmIGIgIT09IGIuZGVsZWdhdGUpIGIgPSBiLmRlbGVnYXRlOwogICAgICByZXR1cm4gYiA9PT0gYTsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RGVsZWdhdGVDaGFuZ2VzKG9iamVjdCwgb2xkUm9vdCwgb2xkVGFyZ2V0KSB7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IG9iamVjdC5kZWxlZ2F0ZTsKICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgb2JqZWN0LnJvb3QgPSBkZWxlZ2F0ZS5yb290OwogICAgICAgIG9iamVjdC50YXJnZXQgPSBkZWxlZ2F0ZS50YXJnZXQ7CiAgICAgICAgb2JqZWN0LmRhdGEgPSBkZWxlZ2F0ZS5kYXRhOwogICAgICAgIG9iamVjdC5zdGF0ZSA9IGRlbGVnYXRlLnN0YXRlOwogICAgICB9CiAgICAgIGlmIChvYmplY3Qucm9vdCAhPT0gb2xkUm9vdCkgewogICAgICAgIHZhciByb290TGlzdGVuSGFuZGxlciA9IG9iamVjdC5saXN0ZW4ucm9vdDsKICAgICAgICBpZiAocm9vdExpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgIGlmIChvbGRSb290ICYmIG9sZFJvb3QgIT09IG9iamVjdCkgb2xkUm9vdC5yZW1vdmVIYW5kbGVyKHJvb3RMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgICAgaWYgKG9iamVjdC5yb290ICYmIG9iamVjdC5yb290ICE9PSBvYmplY3QpIG9iamVjdC5yb290LmFkZEhhbmRsZXIocm9vdExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgfQogICAgICAgIG9iamVjdC5lbWl0X3Jvb3RDaGFuZ2VkKG9sZFJvb3QpOwogICAgICB9CiAgICAgIGlmIChvYmplY3QudGFyZ2V0ICE9PSBvbGRUYXJnZXQpIHsKICAgICAgICB2YXIgdGFyZ2V0TGlzdGVuSGFuZGxlciA9IG9iamVjdC5saXN0ZW4udGFyZ2V0OwogICAgICAgIGlmICh0YXJnZXRMaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICBpZiAob2xkVGFyZ2V0ICYmIG9sZFRhcmdldCAhPT0gb2JqZWN0KSBvbGRUYXJnZXQucmVtb3ZlSGFuZGxlcih0YXJnZXRMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgICAgaWYgKG9iamVjdC50YXJnZXQgJiYgb2JqZWN0LnRhcmdldCAhPT0gb2JqZWN0KSBvYmplY3QudGFyZ2V0LmFkZEhhbmRsZXIodGFyZ2V0TGlzdGVuSGFuZGxlciwgb2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LmVtaXRfdGFyZ2V0Q2hhbmdlZChvbGRUYXJnZXQpOwogICAgICB9CiAgICAgIHZhciBjdXJzb3IgPSBvYmplY3QuZGVsZWdhdGVzXzsKICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIGFwcGx5RGVsZWdhdGVDaGFuZ2VzKGN1cnNvci5kZWxlZ2F0ZSwgb2xkUm9vdCwgb2xkVGFyZ2V0KTsKICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgfQogICAgfQogICAgdmFyIERhdGFPYmplY3QgPSBDbGFzcyhBYnN0cmFjdERhdGEsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk9iamVjdCIsCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uREVMRUdBVEUgKyBTVUJTQ1JJUFRJT04uVEFSR0VULAogICAgICBkYXRhOiBudWxsLAogICAgICBlbWl0X3VwZGF0ZTogY3JlYXRlRXZlbnQoInVwZGF0ZSIsICJkZWx0YSIpICYmIGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICBldmVudHMudXBkYXRlLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIGN1cnNvci5kZWxlZ2F0ZS5lbWl0X3VwZGF0ZShkZWx0YSk7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVtaXRfc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihvbGRTdGF0ZSkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5lbWl0X3N0YXRlQ2hhbmdlZC5jYWxsKHRoaXMsIG9sZFN0YXRlKTsKICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmRlbGVnYXRlKSB7CiAgICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5zdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlOiBudWxsLAogICAgICBkZWxlZ2F0ZXNfOiBudWxsLAogICAgICBkZWJ1Z19kZWxlZ2F0ZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGN1cnNvci5kZWxlZ2F0ZSk7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZW1pdF9kZWxlZ2F0ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJkZWxlZ2F0ZUNoYW5nZWQiLCAib2xkRGVsZWdhdGUiKSwKICAgICAgdGFyZ2V0OiBudWxsLAogICAgICBlbWl0X3RhcmdldENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJ0YXJnZXRDaGFuZ2VkIiwgIm9sZFRhcmdldCIpLAogICAgICByb290OiBudWxsLAogICAgICBlbWl0X3Jvb3RDaGFuZ2VkOiBjcmVhdGVFdmVudCgicm9vdENoYW5nZWQiLCAib2xkUm9vdCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvb3QgPSB0aGlzOwogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXMuZGVsZWdhdGU7CiAgICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGF0YSA9IGRlbGVnYXRlLmRhdGE7CiAgICAgICAgICB0aGlzLnN0YXRlID0gZGVsZWdhdGUuc3RhdGU7CiAgICAgICAgICB0aGlzLnNldERlbGVnYXRlKGRlbGVnYXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCF0aGlzLmRhdGEpIHRoaXMuZGF0YSA9IHt9OwogICAgICAgICAgaWYgKHRoaXMudGFyZ2V0ICE9PSBudWxsKSB0aGlzLnRhcmdldCA9IHRoaXM7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTeW5jQWN0aW9uOiBmdW5jdGlvbihzeW5jQWN0aW9uKSB7CiAgICAgICAgaWYgKHN5bmNBY3Rpb24gJiYgdGhpcy5kZWxlZ2F0ZSkgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5zeW5jQWN0aW9uICsgIiBpbnN0YW5jZSBoYXMgYSBkZWxlZ2F0ZSBhbmQgc3luY0FjdGlvbiAtIGl0IG1heSBwcm9kdWNlIGNvbmZsaWNzIHdpdGggZGF0YSAmIHN0YXRlIik7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5zZXRTeW5jQWN0aW9uLmNhbGwodGhpcywgc3luY0FjdGlvbik7CiAgICAgIH0sCiAgICAgIHNldERlbGVnYXRlOiBmdW5jdGlvbihuZXdEZWxlZ2F0ZSkgewogICAgICAgIGlmIChuZXdEZWxlZ2F0ZSAmJiBuZXdEZWxlZ2F0ZSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZSAmJiBpc0Nvbm5lY3RlZCh0aGlzLCBuZXdEZWxlZ2F0ZSkpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIk5ldyBkZWxlZ2F0ZSBoYXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gb2JqZWN0LiBEZWxlZ2F0ZSBhc3NpZ25tZW50IGhhcyBiZWVuIGlnbm9yZWQuIiwgdGhpcywgbmV3RGVsZWdhdGUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld0RlbGVnYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUgIT09IG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLnN0YXRlOwogICAgICAgICAgdmFyIG9sZERhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICB2YXIgb2xkRGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwogICAgICAgICAgdmFyIG9sZFRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgICAgdmFyIG9sZFJvb3QgPSB0aGlzLnJvb3Q7CiAgICAgICAgICB2YXIgZGVsdGEgPSB7fTsKICAgICAgICAgIHZhciBkYXRhQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRlbGVnYXRlTGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmRlbGVnYXRlOwogICAgICAgICAgaWYgKG9sZERlbGVnYXRlKSB7CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG9sZERlbGVnYXRlLnJlbW92ZUhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgdmFyIGN1cnNvciA9IG9sZERlbGVnYXRlLmRlbGVnYXRlc187CiAgICAgICAgICAgIHZhciBwcmV2ID0gb2xkRGVsZWdhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgICAgICBpZiAoY3Vyc29yLmRlbGVnYXRlID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBjdXJzb3IuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKHByZXYgPT09IG9sZERlbGVnYXRlKSBvbGREZWxlZ2F0ZS5kZWxlZ2F0ZXNfID0gY3Vyc29yLm5leHQ7IGVsc2UgcHJldi5uZXh0ID0gY3Vyc29yLm5leHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldiA9IGN1cnNvcjsKICAgICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBuZXdEZWxlZ2F0ZTsKICAgICAgICAgICAgbmV3RGVsZWdhdGUuZGVsZWdhdGVzXyA9IHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcywKICAgICAgICAgICAgICBuZXh0OiBuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZXNfCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdEZWxlZ2F0ZS5kYXRhKSBpZiAoa2V5IGluIG9sZERhdGEgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZGF0YUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgIGRlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9sZERhdGEpIGlmIChvbGREYXRhW2tleV0gIT09IG5ld0RlbGVnYXRlLmRhdGFba2V5XSkgewogICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICBkZWx0YVtrZXldID0gb2xkRGF0YVtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG5ld0RlbGVnYXRlLmFkZEhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2xkRGF0YSkgdGhpcy5kYXRhW2tleV0gPSBvbGREYXRhW2tleV07CiAgICAgICAgICB9CiAgICAgICAgICBhcHBseURlbGVnYXRlQ2hhbmdlcyh0aGlzLCBvbGRSb290LCBvbGRUYXJnZXQpOwogICAgICAgICAgaWYgKGRhdGFDaGFuZ2VkKSB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIGlmIChvbGRTdGF0ZSAhPT0gdGhpcy5zdGF0ZSAmJiAoU3RyaW5nKG9sZFN0YXRlKSAhPSB0aGlzLnN0YXRlIHx8IG9sZFN0YXRlLmRhdGEgIT09IHRoaXMuc3RhdGUuZGF0YSkpIHRoaXMuZW1pdF9zdGF0ZUNoYW5nZWQob2xkU3RhdGUpOwogICAgICAgICAgdGhpcy5lbWl0X2RlbGVnYXRlQ2hhbmdlZChvbGREZWxlZ2F0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBzZXRTdGF0ZTogZnVuY3Rpb24oc3RhdGUsIGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgcmV0dXJuIHRoaXMucm9vdC5zZXRTdGF0ZShzdGF0ZSwgZGF0YSk7IGVsc2UgcmV0dXJuIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuc2V0U3RhdGUuY2FsbCh0aGlzLCBzdGF0ZSwgZGF0YSk7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGlmICh0aGlzLmRlbGVnYXRlKSByZXR1cm4gdGhpcy5yb290LnVwZGF0ZShkYXRhKTsKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgdmFyIGRlbHRhID0ge307CiAgICAgICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBkYXRhKSBpZiAodGhpcy5kYXRhW3Byb3BdICE9PSBkYXRhW3Byb3BdKSB7CiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICBkZWx0YVtwcm9wXSA9IHRoaXMuZGF0YVtwcm9wXTsKICAgICAgICAgICAgdGhpcy5kYXRhW3Byb3BdID0gZGF0YVtwcm9wXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgICAgIHRoaXMuZW1pdF91cGRhdGUoZGVsdGEpOwogICAgICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICB0aGlzLmRlbGVnYXRlc18gPSBudWxsOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5zZXREZWxlZ2F0ZSgpOwogICAgICAgICAgY3Vyc29yID0gY3Vyc29yLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRlbGVnYXRlKSB0aGlzLnNldERlbGVnYXRlKCk7CiAgICAgICAgdGhpcy5kYXRhID0gTlVMTF9PQkpFQ1Q7CiAgICAgICAgdGhpcy5yb290ID0gbnVsbDsKICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFNsb3QgPSBDbGFzcyhEYXRhT2JqZWN0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TbG90IgogICAgfSk7CiAgICB2YXIgS0VZT0JKRUNUTUFQX01FTUJFUl9IQU5ETEVSID0gewogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBkZWxldGUgdGhpcy5tYXBbdGhpcy5pdGVtSWRdOwogICAgICB9CiAgICB9OwogICAgdmFyIEtleU9iamVjdE1hcCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLktleU9iamVjdE1hcCIsCiAgICAgIGl0ZW1DbGFzczogRGF0YU9iamVjdCwKICAgICAga2V5R2V0dGVyOiAkc2VsZiwKICAgICAgbWFwXzogbnVsbCwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1hcF8gPSB7fTsKICAgICAgICBjbGVhbmVyLmFkZCh0aGlzKTsKICAgICAgfSwKICAgICAgcmVzb2x2ZTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHRoaXMua2V5R2V0dGVyKG9iamVjdCksIG9iamVjdCk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZTogZnVuY3Rpb24oa2V5LCBvYmplY3QpIHsKICAgICAgICB2YXIgaXRlbUNvbmZpZyA9IHt9OwogICAgICAgIGlmIChrZXkgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICBpdGVtQ29uZmlnLmRlbGVnYXRlID0ga2V5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVtQ29uZmlnLmRhdGEgPSB7CiAgICAgICAgICAgIGlkOiBrZXksCiAgICAgICAgICAgIHRpdGxlOiBrZXkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoaXRlbUNvbmZpZyk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBvYmplY3QpIHsKICAgICAgICB2YXIgaXRlbUlkID0ga2V5IGluc3RhbmNlb2YgRGF0YU9iamVjdCA/IGtleS5iYXNpc09iamVjdElkIDoga2V5OwogICAgICAgIHZhciBpdGVtID0gdGhpcy5tYXBfW2l0ZW1JZF07CiAgICAgICAgaWYgKCFpdGVtICYmIG9iamVjdCkgewogICAgICAgICAgaXRlbSA9IHRoaXMubWFwX1tpdGVtSWRdID0gdGhpcy5jcmVhdGUoa2V5LCBvYmplY3QpOwogICAgICAgICAgaXRlbS5hZGRIYW5kbGVyKEtFWU9CSkVDVE1BUF9NRU1CRVJfSEFORExFUiwgewogICAgICAgICAgICBtYXA6IHRoaXMubWFwXywKICAgICAgICAgICAgaXRlbUlkOiBpdGVtSWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYW5lci5yZW1vdmUodGhpcyk7CiAgICAgICAgdmFyIGl0ZW1zID0gdmFsdWVzKHRoaXMubWFwXyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBpdGVtc1tpKytdOyApIGl0ZW0uZGVzdHJveSgpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERhdGFzZXREZWx0YShhLCBiKSB7CiAgICAgIGlmICghYSB8fCAhYS5pdGVtQ291bnQpIHsKICAgICAgICBpZiAoYiAmJiBiLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgIGluc2VydGVkOiBiLmdldEl0ZW1zKCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghYiB8fCAhYi5pdGVtQ291bnQpIHsKICAgICAgICAgIGlmIChhLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgICAgZGVsZXRlZDogYS5nZXRJdGVtcygpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYS5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBhLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGIuaXRlbXNfID09IGZhbHNlKSBkZWxldGVkLnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYi5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBiLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGEuaXRlbXNfID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRhdGFzZXRXcmFwcGVyIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTRVQsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFzZXQ6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICAgICAgdGhpcy5pdGVtQ291bnQgPSBkYXRhc2V0Lml0ZW1Db3VudDsKICAgICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YXNldCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGF0YXNldDogbnVsbCwKICAgICAgZGF0YXNldEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X2RhdGFzZXRDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YXNldENoYW5nZWQiLCAib2xkRGF0YXNldCIpLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogY3JlYXRlRXZlbnQoIml0ZW1zQ2hhbmdlZCIsICJkZWx0YSIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRhdGFzZXQgPSB0aGlzLmRhdGFzZXQ7CiAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgIHRoaXMuZGF0YXNldCA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldERhdGFzZXQoZGF0YXNldCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhc2V0OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgZGF0YXNldCA9IHJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YXNldCwgZGF0YXNldCwgImRhdGFzZXRBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFzZXQgIT09IGRhdGFzZXQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGF0YXNldDsKICAgICAgICAgIHZhciBvbGREYXRhc2V0ID0gdGhpcy5kYXRhc2V0OwogICAgICAgICAgdmFyIGRlbHRhOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFzZXQpIG9sZERhdGFzZXQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKGRhdGFzZXQpIGRhdGFzZXQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXRlbUNvdW50ID0gZGF0YXNldCA/IGRhdGFzZXQuaXRlbUNvdW50IDogMDsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERhdGFzZXREZWx0YShvbGREYXRhc2V0LCBkYXRhc2V0KSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgICAgdGhpcy5lbWl0X2RhdGFzZXRDaGFuZ2VkKG9sZERhdGFzZXQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LmhhcyhvYmplY3QpIDogbnVsbDsKICAgICAgfSwKICAgICAgZ2V0SXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXQgPyB0aGlzLmRhdGFzZXQuZ2V0SXRlbXMoKSA6IFtdOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnBpY2soKSA6IG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnRvcChjb3VudCkgOiBbXTsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0KSByZXR1cm4gdGhpcy5kYXRhc2V0LmZvckVhY2goZm4pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0IHx8IHRoaXMuZGF0YXNldEFkYXB0ZXJfKSB0aGlzLnNldERhdGFzZXQoKTsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3REYXRhc2V0IiwKICAgICAgaXRlbUNvdW50OiAwLAogICAgICBpdGVtc186IG51bGwsCiAgICAgIG1lbWJlcnNfOiBudWxsLAogICAgICBjYWNoZV86IG51bGwsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBjcmVhdGVFdmVudCgiaXRlbXNDaGFuZ2VkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgaXRlbXM7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBvYmplY3Q7CiAgICAgICAgaWYgKGl0ZW1zID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIHdoaWxlIChvYmplY3QgPSBpdGVtc1tpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgdGhpcy5pdGVtc19bb2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXMgPSBkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICB3aGlsZSAob2JqZWN0ID0gaXRlbXNbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuaXRlbUNvdW50ICs9IGluc2VydENvdW50IC0gZGVsZXRlQ291bnQ7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBpbnNlcnRDb3VudCA9PSB0aGlzLml0ZW1Db3VudCA/IGRlbHRhLmluc2VydGVkIDogbnVsbDsKICAgICAgICBldmVudHMuaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1lbWJlcnNfID0ge307CiAgICAgICAgdGhpcy5pdGVtc18gPSB7fTsKICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gISEob2JqZWN0ICYmIHRoaXMuaXRlbXNfW29iamVjdC5iYXNpc09iamVjdElkXSk7CiAgICAgIH0sCiAgICAgIGdldEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuY2FjaGVfKSB0aGlzLmNhY2hlXyA9IHZhbHVlcyh0aGlzLml0ZW1zXyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVfOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiB0aGlzLml0ZW1zXykgcmV0dXJuIHRoaXMuaXRlbXNfW29iamVjdElkXTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAgICAgdG9wOiBmdW5jdGlvbihjb3VudCkgewogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBpZiAoY291bnQpIGZvciAodmFyIG9iamVjdElkIGluIHRoaXMuaXRlbXNfKSBpZiAocmVzdWx0LnB1c2godGhpcy5pdGVtc19bb2JqZWN0SWRdKSA+PSBjb3VudCkgYnJlYWs7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICB2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgZm4oaXRlbXNbaV0pOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7fSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY2FjaGVfID0gRU1QVFlfQVJSQVk7CiAgICAgICAgdGhpcy5pdGVtQ291bnQgPSAwOwogICAgICAgIHRoaXMubWVtYmVyc18gPSBudWxsOwogICAgICAgIHRoaXMuaXRlbXNfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGF0YXNldCIsCiAgICAgIGxpc3RlbjogewogICAgICAgIGl0ZW06IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICB0aGlzLnJlbW92ZShbIG9iamVjdCBdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBpdGVtcyA9IHRoaXMuaXRlbXM7CiAgICAgICAgaWYgKGl0ZW1zKSB7CiAgICAgICAgICB0aGlzLml0ZW1zID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0KGl0ZW1zKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGlmIChpdGVtcyAmJiAhQXJyYXkuaXNBcnJheShpdGVtcykpIGl0ZW1zID0gWyBpdGVtcyBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBpdGVtc1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBpZiAoIW1lbWJlck1hcFtvYmplY3RJZF0pIHsKICAgICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBpbnNlcnRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBkYXRhIHR5cGU6IHZhbHVlIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgYmFzaXMuZGF0YS5PYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGluc2VydGVkLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSA9IHsKICAgICAgICAgICAgaW5zZXJ0ZWQ6IGluc2VydGVkCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKGl0ZW1zKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5pdGVtOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGlmIChpdGVtcyAmJiAhQXJyYXkuaXNBcnJheShpdGVtcykpIGl0ZW1zID0gWyBpdGVtcyBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBpdGVtc1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2gob2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIldyb25nIGRhdGEgdHlwZTogdmFsdWUgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBiYXNpcy5kYXRhLk9iamVjdCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICBpZiAoIXRoaXMuaXRlbUNvdW50KSByZXR1cm4gdGhpcy5hZGQoaXRlbXMpOwogICAgICAgIGlmICghaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xlYXIoKTsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGV4aXN0cyA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIG9iamVjdDsKICAgICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgZXhpc3RzW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZGF0YSB0eXBlOiB2YWx1ZSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRhdGEuT2JqZWN0Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgaWYgKCFleGlzdHNbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgIG9iamVjdCA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc3luYzogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICB2YXIgZGVsdGEgPSB0aGlzLnNldChpdGVtcykgfHwge307CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBkZWx0YS5kZWxldGVkOwogICAgICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWxldGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBkZWxldGVkW2ldOyBpKyspIG9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIHJldHVybiBkZWx0YS5pbnNlcnRlZDsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkZWxldGVkID0gdGhpcy5nZXRJdGVtcygpOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKGRlbGV0ZWQubGVuZ3RoKSB7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGVkLmxlbmd0aDsgaSsrKSBkZWxldGVkW2ldLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhID0gewogICAgICAgICAgICBkZWxldGVkOiBkZWxldGVkCiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMubWVtYmVyc18gPSB7fTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEYXRhc2V0QWRhcHRlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGZuLCBzb3VyY2UsIGhhbmRsZXIpIHsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgIH07CiAgICBEYXRhc2V0QWRhcHRlci5wcm90b3R5cGUuYWRhcHRlcl8gPSBudWxsOwogICAgRGF0YXNldEFkYXB0ZXIucHJvdG90eXBlLnByb3h5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHRoaXMuc291cmNlKTsKICAgIH07CiAgICB2YXIgREFUQVNFVFdSQVBQRVJfQURBUFRFUl9IQU5ETEVSID0gewogICAgICBkYXRhc2V0Q2hhbmdlZDogZnVuY3Rpb24od3JhcHBlcikgewogICAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHdyYXBwZXIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9BREFQVEVSX0hBTkRMRVIgPSB7CiAgICAgIGNoYW5nZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCB2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIG51bGwpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gcmVzb2x2ZURhdGFzZXQoY29udGV4dCwgZm4sIHNvdXJjZSwgcHJvcGVydHkpIHsKICAgICAgdmFyIG9sZEFkYXB0ZXIgPSBjb250ZXh0W3Byb3BlcnR5XSB8fCBudWxsOwogICAgICB2YXIgbmV3QWRhcHRlciA9IG51bGw7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIpIHNvdXJjZSA9IHNvdXJjZS5jYWxsKGNvbnRleHQsIGNvbnRleHQpOwogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgRGF0YXNldFdyYXBwZXIpIHsKICAgICAgICBuZXdBZGFwdGVyID0gbmV3IERhdGFzZXRBZGFwdGVyKGNvbnRleHQsIGZuLCBzb3VyY2UsIERBVEFTRVRXUkFQUEVSX0FEQVBURVJfSEFORExFUik7CiAgICAgICAgc291cmNlID0gc291cmNlLmRhdGFzZXQ7CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSBzb3VyY2UgPSBWYWx1ZS5mcm9tKHNvdXJjZSk7CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgIG5ld0FkYXB0ZXIgPSBuZXcgRGF0YXNldEFkYXB0ZXIoY29udGV4dCwgZm4sIHNvdXJjZSwgVkFMVUVfQURBUFRFUl9IQU5ETEVSKTsKICAgICAgICBzb3VyY2UgPSByZXNvbHZlRGF0YXNldChuZXdBZGFwdGVyLCBuZXdBZGFwdGVyLnByb3h5LCBzb3VyY2UudmFsdWUsICJhZGFwdGVyXyIpOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGFzZXQgPT0gZmFsc2UpIHNvdXJjZSA9IG51bGw7CiAgICAgIGlmIChwcm9wZXJ0eSAmJiBvbGRBZGFwdGVyICE9PSBuZXdBZGFwdGVyKSB7CiAgICAgICAgaWYgKG9sZEFkYXB0ZXIpIHsKICAgICAgICAgIG9sZEFkYXB0ZXIuc291cmNlLnJlbW92ZUhhbmRsZXIob2xkQWRhcHRlci5oYW5kbGVyLCBvbGRBZGFwdGVyKTsKICAgICAgICAgIGlmIChvbGRBZGFwdGVyLmFkYXB0ZXJfKSByZXNvbHZlRGF0YXNldChvbGRBZGFwdGVyLCBudWxsLCBudWxsLCAiYWRhcHRlcl8iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5ld0FkYXB0ZXIpIG5ld0FkYXB0ZXIuc291cmNlLmFkZEhhbmRsZXIobmV3QWRhcHRlci5oYW5kbGVyLCBuZXdBZGFwdGVyKTsKICAgICAgICBjb250ZXh0W3Byb3BlcnR5XSA9IG5ld0FkYXB0ZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0KICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm90byA9IEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGU7CiAgICAgIHZhciByZWFsRXZlbnQgPSBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZDsKICAgICAgdmFyIHNldFN0YXRlQ291bnQgPSAwOwogICAgICB2YXIgdXJnZW50VGltZXI7CiAgICAgIHZhciBldmVudENhY2hlID0ge307CiAgICAgIGZ1bmN0aW9uIGZsdXNoQ2FjaGUoY2FjaGUpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IGNhY2hlLmRhdGFzZXQ7CiAgICAgICAgcmVhbEV2ZW50LmNhbGwoZGF0YXNldCwgY2FjaGUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsdXNoQWxsRGF0YXNldCgpIHsKICAgICAgICB2YXIgZXZlbnRDYWNoZUNvcHkgPSBldmVudENhY2hlOwogICAgICAgIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgICBmb3IgKHZhciBkYXRhc2V0SWQgaW4gZXZlbnRDYWNoZUNvcHkpIGZsdXNoQ2FjaGUoZXZlbnRDYWNoZUNvcHlbZGF0YXNldElkXSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RvcmVEYXRhc2V0RGVsdGEoZGVsdGEpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IHRoaXM7CiAgICAgICAgdmFyIGRhdGFzZXRJZCA9IGRhdGFzZXQuYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgdmFyIGNhY2hlID0gZXZlbnRDYWNoZVtkYXRhc2V0SWRdOwogICAgICAgIGlmIChpbnNlcnRlZCAmJiBkZWxldGVkKSB7CiAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgZGVsZXRlIGV2ZW50Q2FjaGVbZGF0YXNldElkXTsKICAgICAgICAgICAgZmx1c2hDYWNoZShjYWNoZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZWFsRXZlbnQuY2FsbChkYXRhc2V0LCBkZWx0YSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBtb2RlID0gaW5zZXJ0ZWQgPyAiaW5zZXJ0ZWQiIDogImRlbGV0ZWQiOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgdmFyIGFycmF5ID0gY2FjaGVbbW9kZV07CiAgICAgICAgICBpZiAoIWFycmF5KSBmbHVzaENhY2hlKGNhY2hlKTsgZWxzZSB7CiAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIGluc2VydGVkIHx8IGRlbGV0ZWQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV2ZW50Q2FjaGVbZGF0YXNldElkXSA9IGRlbHRhOwogICAgICAgIGRlbHRhLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVyZ2VudEZsdXNoKCkgewogICAgICAgIHVyZ2VudFRpbWVyID0gbnVsbDsKICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIihkZWJ1ZykgVXJnZW50IGZsdXNoIGRhdGFzZXQgY2hhbmdlcyIpOwogICAgICAgICAgc2V0U3RhdGVDb3VudCA9IDA7CiAgICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0QWNjdW11bGF0ZVN0YXRlT2ZmKCkgewogICAgICAgIHByb3RvLmVtaXRfaXRlbXNDaGFuZ2VkID0gcmVhbEV2ZW50OwogICAgICAgIGZsdXNoQWxsRGF0YXNldCgpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIGlmIChzdGF0ZSkgewogICAgICAgICAgaWYgKHNldFN0YXRlQ291bnQgPT0gMCkgewogICAgICAgICAgICBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZCA9IHN0b3JlRGF0YXNldERlbHRhOwogICAgICAgICAgICBpZiAoIXVyZ2VudFRpbWVyKSB1cmdlbnRUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZSh1cmdlbnRGbHVzaCk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXRTdGF0ZUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNldFN0YXRlQ291bnQgLT0gc2V0U3RhdGVDb3VudCA+IDA7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiB3cmFwRGF0YShkYXRhKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSByZXR1cm4gZGF0YS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBpdGVtCiAgICAgICAgfTsKICAgICAgfSk7IGVsc2UgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwT2JqZWN0KGRhdGEpIHsKICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuY29uc3RydWN0b3IgIT09IE9iamVjdCkgZGF0YSA9IHsKICAgICAgICB2YWx1ZTogZGF0YQogICAgICB9OwogICAgICByZXR1cm4gbmV3IERhdGFPYmplY3QoewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCByZXRPYmplY3QpIHsKICAgICAgdmFyIHdyYXBwZXIgPSByZXRPYmplY3QgPyB3cmFwT2JqZWN0IDogd3JhcERhdGE7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLm1hcCh3cmFwcGVyKSA6IHdyYXBwZXIodmFsdWUpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFNUQVRFOiBTVEFURSwKICAgICAgU1VCU0NSSVBUSU9OOiBTVUJTQ1JJUFRJT04sCiAgICAgIEFic3RyYWN0RGF0YTogQWJzdHJhY3REYXRhLAogICAgICBWYWx1ZTogVmFsdWUsCiAgICAgIE9iamVjdDogRGF0YU9iamVjdCwKICAgICAgU2xvdDogU2xvdCwKICAgICAgS2V5T2JqZWN0TWFwOiBLZXlPYmplY3RNYXAsCiAgICAgIEFic3RyYWN0RGF0YXNldDogQWJzdHJhY3REYXRhc2V0LAogICAgICBEYXRhc2V0OiBEYXRhc2V0LAogICAgICBEYXRhc2V0V3JhcHBlcjogRGF0YXNldFdyYXBwZXIsCiAgICAgIERhdGFzZXRBZGFwdGVyOiBEYXRhc2V0QWRhcHRlciwKICAgICAgaXNDb25uZWN0ZWQ6IGlzQ29ubmVjdGVkLAogICAgICBnZXREYXRhc2V0RGVsdGE6IGdldERhdGFzZXREZWx0YSwKICAgICAgcmVzb2x2ZURhdGFzZXQ6IHJlc29sdmVEYXRhc2V0LAogICAgICB3cmFwRGF0YTogd3JhcERhdGEsCiAgICAgIHdyYXBPYmplY3Q6IHdyYXBPYmplY3QsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheTsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciAkdW5kZWYgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIG51bGxHZXR0ZXIgPSBiYXNpcy5mbi5udWxsR2V0dGVyOwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBDbGFzcy5vbmVGdW5jdGlvblByb3BlcnR5OwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSBiYXNpcy5kYXRhLlNVQlNDUklQVElPTjsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgdmFyIEVYQ0VQVElPTl9DQU5UX0lOU0VSVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgYmUgaW5zZXJ0ZWQgYXQgc3BlY2lmaWVkIHBvaW50IGluIGhpZXJhcmNoeSI7CiAgICB2YXIgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EID0gbmFtZXNwYWNlICsgIjogTm9kZSB3YXMgbm90IGZvdW5kIjsKICAgIHZhciBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBoYXMgd3JvbmcgY2xhc3MiOwogICAgdmFyIEVYQ0VQVElPTl9OVUxMX0NISUxEID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBpcyBudWxsIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE9wZXJhdGlvbiBpcyBub3QgYWxsb3dlZCBiZWNhdXNlIG5vZGUgaXMgdW5kZXIgZGF0YVNvdXJjZSBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1QgPSBuYW1lc3BhY2UgKyAiOiBPcGVyYXRpb24gaXMgbm90IGFsbG93ZWQgYmVjYXVzZSBub2RlIGlzIHVuZGVyIGRhdGFTb3VyY2UgYWRhcHRlciBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIG93bmVyIGFuZCBwYXJlbnROb2RlIjsKICAgIHZhciBFWENFUFRJT05fTk9fQ0hJTERDTEFTUyA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIGNoaWxkcmVuIGFuZCBkYXRhU291cmNlIGFzIGNoaWxkQ2xhc3MgaXNuJ3Qgc3BlY2lmaWVkIjsKICAgIHZhciBERUxFR0FURSA9IHsKICAgICAgQU5ZOiB0cnVlLAogICAgICBOT05FOiBmYWxzZSwKICAgICAgUEFSRU5UOiAicGFyZW50IiwKICAgICAgT1dORVI6ICJvd25lciIKICAgIH07CiAgICB2YXIgY2hpbGROb2Rlc0RhdGFzZXRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogbm9kZSBjYW4ndCBiZSBkZXN0cm95ZWQgYXMgcmVwcmVzZW50aW5nIGRhdGFTb3VyY2UgaXRlbSwgZGVzdHJveSBkZWxlZ2F0ZSBpdGVtIG9yIHJlbW92ZSBpdCBmcm9tIGRhdGFTb3VyY2UgZmlyc3QiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBvd25lciBhcyBpdCBhdXRvLXNhdGVsbGl0ZSIpOwogICAgfQogICAgZnVuY3Rpb24gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGJlIGRlc3Ryb3llZCBhcyBpdCBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUsIGFuZCBjb3VsZCBiZSBkZXN0cm95ZWQgb24gb3duZXIgZGVzdHJveSIpOwogICAgfQogICAgZnVuY3Rpb24gbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIG5vZGUuc2V0RGVsZWdhdGUgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgIG5vZGUuZGVzdHJveSA9IHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveTsKICAgIH0KICAgIGZ1bmN0aW9uIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIHZhciBwcm90byA9IG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICBub2RlLnNldERlbGVnYXRlID0gcHJvdG8uc2V0RGVsZWdhdGU7CiAgICAgIG5vZGUuZGVzdHJveSA9IHByb3RvLmRlc3Ryb3k7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0aW5nU2VhcmNoKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0QXNjKGEsIGIpIHsKICAgICAgYSA9IGEuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICAgIGIgPSBiLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICByZXR1cm4gKyhhID4gYikgfHwgLShhIDwgYik7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0RGVzYyhhLCBiKSB7CiAgICAgIGEgPSBhLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICBiID0gYi5zb3J0aW5nVmFsdWUgfHwgMDsKICAgICAgcmV0dXJuIC0oYSA+IGIpIHx8ICsoYSA8IGIpOwogICAgfQogICAgZnVuY3Rpb24gc29ydENoaWxkTm9kZXMob2JqKSB7CiAgICAgIHJldHVybiBvYmouY2hpbGROb2Rlcy5zb3J0KG9iai5zb3J0aW5nRGVzYyA/IHNvcnREZXNjIDogc29ydEFzYyk7CiAgICB9CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlLCBnZXR0ZXJfLCBkZXNjKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgZGVzYyA9ICEhZGVzYzsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNvbXBhcmVWYWx1ZTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGNvbXBhcmVWYWx1ZSA9IGdldHRlcl8oYXJyYXlbcG9zXSk7CiAgICAgICAgaWYgKGRlc2MgPyB2YWx1ZSA+IGNvbXBhcmVWYWx1ZSA6IHZhbHVlIDwgY29tcGFyZVZhbHVlKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoZGVzYyA/IHZhbHVlIDwgY29tcGFyZVZhbHVlIDogdmFsdWUgPiBjb21wYXJlVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiB2YWx1ZSA9PSBjb21wYXJlVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNvbXBhcmVWYWx1ZSA8IHZhbHVlIF4gZGVzYyk7CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihyb290LCBvbGRTZWxlY3Rpb24sIG5ld1NlbGVjdGlvbiwgcm9vdFVwZGF0ZSwgaWdub3JlUm9vdFNlbGVjdGlvbikgewogICAgICBpZiAob2xkU2VsZWN0aW9uID09PSBuZXdTZWxlY3Rpb24pIHJldHVybjsKICAgICAgdmFyIG5leHROb2RlOwogICAgICB2YXIgY3Vyc29yID0gcm9vdDsKICAgICAgdmFyIHNlbGVjdGVkID0gW107CiAgICAgIGlmIChyb290VXBkYXRlKSB7CiAgICAgICAgcm9vdC5jb250ZXh0U2VsZWN0aW9uID0gbmV3U2VsZWN0aW9uOwogICAgICAgIGlmIChyb290LnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKHJvb3QpOwogICAgICB9CiAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICBuZXh0Tm9kZSA9ICFjdXJzb3Iuc2VsZWN0aW9uIHx8IGlnbm9yZVJvb3RTZWxlY3Rpb24gJiYgY3Vyc29yID09PSByb290ID8gY3Vyc29yLmZpcnN0Q2hpbGQgOiBudWxsOwogICAgICAgIGlmIChuZXh0Tm9kZSAmJiBuZXh0Tm9kZS5jb250ZXh0U2VsZWN0aW9uICE9PSBvbGRTZWxlY3Rpb24pIHRocm93ICJUcnkgY2hhbmdlIHdyb25nIGNvbnRleHQgc2VsZWN0aW9uIjsKICAgICAgICB3aGlsZSAoIW5leHROb2RlKSB7CiAgICAgICAgICBpZiAoY3Vyc29yID09PSByb290KSB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAob2xkU2VsZWN0aW9uKSBvbGRTZWxlY3Rpb24ucmVtb3ZlKHNlbGVjdGVkKTsKICAgICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9uKSBuZXdTZWxlY3Rpb24uYWRkKHNlbGVjdGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0Tm9kZSA9IGN1cnNvci5uZXh0U2libGluZzsKICAgICAgICAgIGlmICghbmV4dE5vZGUpIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBjdXJzb3IgPSBuZXh0Tm9kZTsKICAgICAgICBpZiAoY3Vyc29yLnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKGN1cnNvcik7CiAgICAgICAgY3Vyc29yLmNvbnRleHRTZWxlY3Rpb24gPSBuZXdTZWxlY3Rpb247CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChub2RlLCBkaXNhYmxlZCkgewogICAgICBpZiAobm9kZS5jb250ZXh0RGlzYWJsZWQgIT0gZGlzYWJsZWQpIHsKICAgICAgICBub2RlLmNvbnRleHREaXNhYmxlZCA9IGRpc2FibGVkOwogICAgICAgIGlmIChub2RlLmRpc2FibGVkKSByZXR1cm47CiAgICAgICAgaWYgKGRpc2FibGVkKSBub2RlLmVtaXRfZGlzYWJsZSgpOyBlbHNlIG5vZGUuZW1pdF9lbmFibGUoKTsKICAgICAgfQogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJvd25lciIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkYXRhU291cmNlIik7CiAgICBmdW5jdGlvbiBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBudWxsOwogICAgICBpZiAodmFsdWUuaXNTYXRlbGxpdGVDb25maWcpIHJldHVybiB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlKSkgdmFsdWUgPSB7CiAgICAgICAgaW5zdGFuY2VPZjogdmFsdWUKICAgICAgfTsKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICB2YXIgaGFuZGxlclJlcXVpcmVkID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAgIGlzU2F0ZWxsaXRlQ29uZmlnOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgaW5zdGFuY2VDbGFzczsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICBjYXNlICJpbnN0YW5jZSI6CiAgICAgICAgICAgIGlmICh2YWx1ZVtrZXldIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSBjb25maWdba2V5XSA9IHZhbHVlW2tleV07IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZWAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiaW5zdGFuY2VPZiI6CiAgICAgICAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlW2tleV0pICYmIHZhbHVlW2tleV0uaXNTdWJjbGFzc09mKEFic3RyYWN0Tm9kZSkpIGluc3RhbmNlQ2xhc3MgPSB2YWx1ZVtrZXldOyBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBgaW5zdGFuY2VPZmAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGEgc3ViY2xhc3Mgb2YgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJleGlzdHNJZiI6CiAgICAgICAgICBjYXNlICJkZWxlZ2F0ZSI6CiAgICAgICAgICBjYXNlICJkYXRhU291cmNlIjoKICAgICAgICAgICAgaGFuZGxlclJlcXVpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnW2tleV0gPSBnZXR0ZXIodmFsdWVba2V5XSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiY29uZmlnIjoKICAgICAgICAgICAgY29uZmlnW2tleV0gPSB2YWx1ZVtrZXldOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFjb25maWcuaW5zdGFuY2UpIGNvbmZpZy5pbnN0YW5jZU9mID0gaW5zdGFuY2VDbGFzcyB8fCBBYnN0cmFjdE5vZGU7IGVsc2UgewogICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZU9mYCBjYW4ndCBiZSBzZXQgd2l0aCBgaW5zdGFuY2VgIHZhbHVlIGluIHNhdGVsbGl0ZSBjb25maWcsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhhbmRsZXJSZXF1aXJlZCkgewogICAgICAgICAgdmFyIGV2ZW50cyA9ICJldmVudHMiIGluIHZhbHVlID8gdmFsdWUuZXZlbnRzIDogInVwZGF0ZSI7CiAgICAgICAgICBpZiAoImhvb2siIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgiZXZlbnRzIiBpbiB2YWx1ZSA9PSBmYWxzZSkgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGhvb2sgcHJvcGVydHkgaW4gc2F0ZWxsaXRlIGNvbmZpZyBpcyBkZXByZWNhdGVkLCB1c2UgZXZlbnRzIHByb3BlcnR5IGluc3RlYWQiKTsKICAgICAgICAgICAgICBldmVudHMgPSBiYXNpcy5vYmplY3Qua2V5cyh2YWx1ZS5ob29rKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBob29rIHByb3BlcnR5IGluIHNhdGVsbGl0ZSBjb25maWcgd2FzIGlnbm9yZWQgKGV2ZW50cyBwcm9wZXJ0eSB1c2VkKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBldmVudHMuam9pbigiICIpOwogICAgICAgICAgaWYgKHR5cGVvZiBldmVudHMgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KC9ccysvKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICBoYW5kbGVyW2V2ZW50TmFtZV0gPSBTQVRFTExJVEVfVVBEQVRFOwogICAgICAgICAgICAgIGNvbmZpZy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gZXh0ZW5kU2F0ZWxsaXRlQ29uZmlnKHJlc3VsdCwgZXh0ZW5kKSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXh0ZW5kKSByZXN1bHRbbmFtZV0gPSBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKGV4dGVuZFtuYW1lXSk7CiAgICB9CiAgICBmdW5jdGlvbiBhcHBseVNhdGVsbGl0ZXMobm9kZSwgc2F0ZWxsaXRlcykgewogICAgICBmb3IgKHZhciBuYW1lIGluIHNhdGVsbGl0ZXMpIGlmIChzYXRlbGxpdGVzW25hbWVdICYmIHR5cGVvZiBzYXRlbGxpdGVzW25hbWVdID09ICJvYmplY3QiKSBub2RlLnNldFNhdGVsbGl0ZShuYW1lLCBzYXRlbGxpdGVzW25hbWVdKTsKICAgIH0KICAgIHZhciBOVUxMX1NBVEVMTElURV9DT05GSUcgPSBDbGFzcy5jdXN0b21FeHRlbmRQcm9wZXJ0eSh7fSwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbmQpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGV4dGVuZCkgewogICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kb20ud3JhcHBlci5BYnN0cmFjdE5vZGUjc2F0ZWxsaXRlQ29uZmlnIGlzIGRlcHJlY2F0ZWQgbm93LCB1c2UgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlI3NhdGVsbGl0ZSBpbnN0ZWFkIik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgZXh0ZW5kU2F0ZWxsaXRlQ29uZmlnKHJlc3VsdCwgZXh0ZW5kKTsKICAgIH0pOwogICAgdmFyIE5VTExfU0FURUxMSVRFID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoe30sIGV4dGVuZFNhdGVsbGl0ZUNvbmZpZyk7CiAgICB2YXIgU0FURUxMSVRFX1VQREFURSA9IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgIHZhciBuYW1lID0gdGhpcy5uYW1lOwogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIHZhciBleGlzdHMgPSAhY29uZmlnLmV4aXN0c0lmIHx8IGNvbmZpZy5leGlzdHNJZihvd25lcik7CiAgICAgIHZhciBzYXRlbGxpdGUgPSBvd25lci5zYXRlbGxpdGVbbmFtZV07CiAgICAgIGlmIChleGlzdHMpIHsKICAgICAgICBpZiAoc2F0ZWxsaXRlKSB7CiAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSBzYXRlbGxpdGUuc2V0RGVsZWdhdGUoY29uZmlnLmRlbGVnYXRlKG93bmVyKSk7CiAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZS5zZXREYXRhU291cmNlKGNvbmZpZy5kYXRhU291cmNlKG93bmVyKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhdGVsbGl0ZSA9IGNvbmZpZy5pbnN0YW5jZTsKICAgICAgICAgIGlmICghc2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIHZhciBzYXRlbGxpdGVDb25maWcgPSAodHlwZW9mIGNvbmZpZy5jb25maWcgPT0gImZ1bmN0aW9uIiA/IGNvbmZpZy5jb25maWcob3duZXIpIDogY29uZmlnLmNvbmZpZykgfHwge307CiAgICAgICAgICAgIHNhdGVsbGl0ZUNvbmZpZy5vd25lciA9IG93bmVyOwogICAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSB7CiAgICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLmF1dG9EZWxlZ2F0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHNhdGVsbGl0ZUNvbmZpZy5kZWxlZ2F0ZSA9IGNvbmZpZy5kZWxlZ2F0ZShvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGVDb25maWcuZGF0YVNvdXJjZSA9IGNvbmZpZy5kYXRhU291cmNlKG93bmVyKTsKICAgICAgICAgICAgc2F0ZWxsaXRlID0gbmV3IGNvbmZpZy5pbnN0YW5jZU9mKHNhdGVsbGl0ZUNvbmZpZyk7CiAgICAgICAgICAgIHNhdGVsbGl0ZS5kZXN0cm95ID0gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveTsKICAgICAgICAgICAgaWYgKG93bmVyLmxpc3RlbiAmJiBvd25lci5saXN0ZW4uc2F0ZWxsaXRlKSBzYXRlbGxpdGUuYWRkSGFuZGxlcihvd25lci5saXN0ZW4gJiYgb3duZXIubGlzdGVuLnNhdGVsbGl0ZSwgb3duZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKGNvbmZpZy5kZWxlZ2F0ZShvd25lcikpOwogICAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZS5zZXREYXRhU291cmNlKGNvbmZpZy5kYXRhU291cmNlKG93bmVyKSk7CiAgICAgICAgICB9CiAgICAgICAgICBvd25lci5zYXRlbGxpdGUuX19hdXRvX19bbmFtZV0uaW5zdGFuY2UgPSBzYXRlbGxpdGU7CiAgICAgICAgICBvd25lci5zZXRTYXRlbGxpdGUobmFtZSwgc2F0ZWxsaXRlLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgaWYgKGNvbmZpZy5pbnN0YW5jZSkgewogICAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSBzYXRlbGxpdGUuc2V0RGVsZWdhdGUoKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZSgpOwogICAgICAgICAgfQogICAgICAgICAgb3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fW25hbWVdLmluc3RhbmNlID0gbnVsbDsKICAgICAgICAgIG93bmVyLnNldFNhdGVsbGl0ZShuYW1lLCBudWxsLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vd25lci5zZXRTYXRlbGxpdGUodGhpcy5uYW1lLCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBBYnN0cmFjdE5vZGUgPSBDbGFzcyhEYXRhT2JqZWN0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdE5vZGUiLAogICAgICBzdWJzY3JpYmVUbzogRGF0YU9iamVjdC5wcm90b3R5cGUuc3Vic2NyaWJlVG8gKyBTVUJTQ1JJUFRJT04uREFUQVNPVVJDRSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0YXRlID09IFNUQVRFLlVOREVGSU5FRCB8fCB0aGlzLnN0YXRlID09IFNUQVRFLkRFUFJFQ0FURUQ7CiAgICAgIH0sCiAgICAgIHN5bmNFdmVudHM6IHsKICAgICAgICBhY3RpdmVDaGFuZ2VkOiBmYWxzZQogICAgICB9LAogICAgICBlbWl0X3VwZGF0ZTogZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5lbWl0X3VwZGF0ZS5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50Tm9kZSkgewogICAgICAgICAgaWYgKHBhcmVudE5vZGUubWF0Y2hGdW5jdGlvbikgdGhpcy5tYXRjaChwYXJlbnROb2RlLm1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcywgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBsaXN0ZW46IHsKICAgICAgICBvd25lcjogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vd25lclNhdGVsbGl0ZU5hbWUpIHRoaXMuc2V0T3duZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGF1dG9EZWxlZ2F0ZTogREVMRUdBVEUuTk9ORSwKICAgICAgbmFtZTogbnVsbCwKICAgICAgY2hpbGROb2RlczogbnVsbCwKICAgICAgZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ6IGNyZWF0ZUV2ZW50KCJjaGlsZE5vZGVzTW9kaWZpZWQiLCAiZGVsdGEiKSAmJiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIGV2ZW50cy5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdmFyIGxpc3RlbiA9IHRoaXMubGlzdGVuLmNoaWxkTm9kZTsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgaWYgKGxpc3RlbikgewogICAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuaW5zZXJ0ZWQpIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBhcnJheVtpXTsgaSsrKSBjaGlsZC5hZGRIYW5kbGVyKGxpc3RlbiwgdGhpcyk7CiAgICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaV07IGkrKykgY2hpbGQucmVtb3ZlSGFuZGxlcihsaXN0ZW4sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiBTVEFURS5VTkRFRklORUQsCiAgICAgIGVtaXRfY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImNoaWxkTm9kZXNTdGF0ZUNoYW5nZWQiLCAib2xkU3RhdGUiKSwKICAgICAgY2hpbGRDbGFzczogQWJzdHJhY3ROb2RlLAogICAgICBkYXRhU291cmNlOiBudWxsLAogICAgICBlbWl0X2RhdGFTb3VyY2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YVNvdXJjZUNoYW5nZWQiLCAib2xkRGF0YVNvdXJjZSIpLAogICAgICBkYXRhU291cmNlQWRhcHRlcl86IG51bGwsCiAgICAgIGRhdGFTb3VyY2VNYXBfOiBudWxsLAogICAgICBkZXN0cm95RGF0YVNvdXJjZU1lbWJlcjogdHJ1ZSwKICAgICAgcGFyZW50Tm9kZTogbnVsbCwKICAgICAgbmV4dFNpYmxpbmc6IG51bGwsCiAgICAgIHByZXZpb3VzU2libGluZzogbnVsbCwKICAgICAgZmlyc3RDaGlsZDogbnVsbCwKICAgICAgbGFzdENoaWxkOiBudWxsLAogICAgICBzb3J0aW5nOiBudWxsR2V0dGVyLAogICAgICBzb3J0aW5nRGVzYzogZmFsc2UsCiAgICAgIGVtaXRfc29ydGluZ0NoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJzb3J0aW5nQ2hhbmdlZCIsICJvbGRTb3J0aW5nIiwgIm9sZFNvcnRpbmdEZXNjIiksCiAgICAgIGdyb3VwaW5nQ2xhc3M6IG51bGwsCiAgICAgIGdyb3VwaW5nOiBudWxsLAogICAgICBlbWl0X2dyb3VwaW5nQ2hhbmdlZDogY3JlYXRlRXZlbnQoImdyb3VwaW5nQ2hhbmdlZCIsICJvbGRHcm91cGluZyIpLAogICAgICBncm91cE5vZGU6IG51bGwsCiAgICAgIGdyb3VwSWQ6IE5hTiwKICAgICAgc2F0ZWxsaXRlQ29uZmlnOiBOVUxMX1NBVEVMTElURV9DT05GSUcsCiAgICAgIHNhdGVsbGl0ZTogTlVMTF9TQVRFTExJVEUsCiAgICAgIG93bmVyU2F0ZWxsaXRlTmFtZTogbnVsbCwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgic2F0ZWxsaXRlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNhdGVsbGl0ZSIpLAogICAgICBvd25lcjogbnVsbCwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJvd25lckNoYW5nZWQiLCAib2xkT3duZXIiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIGlmIChkYXRhU291cmNlKSB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciBncm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0R3JvdXBpbmcoZ3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jaGlsZENsYXNzKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBbXTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZShkYXRhU291cmNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLnNldENoaWxkTm9kZXMoY2hpbGROb2Rlcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzYXRlbGxpdGVzID0gdGhpcy5zYXRlbGxpdGU7CiAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlQ29uZmlnICE9PSBOVUxMX1NBVEVMTElURV9DT05GSUcpIHsKICAgICAgICAgIGlmICh0aGlzLnNhdGVsbGl0ZUNvbmZpZyAhPT0gdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuc2F0ZWxsaXRlQ29uZmlnKSBiYXNpcy5kZXYud2FybigiYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlI3NhdGVsbGl0ZUNvbmZpZyBpcyBkZXByZWNhdGVkIG5vdywgdXNlIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSNzYXRlbGxpdGUgaW5zdGVhZCIpOwogICAgICAgICAgc2F0ZWxsaXRlcyA9IGJhc2lzLm9iamVjdC5tZXJnZShzYXRlbGxpdGVzLCB0aGlzLnNhdGVsbGl0ZUNvbmZpZyk7CiAgICAgICAgfQogICAgICAgIGlmIChzYXRlbGxpdGVzICE9PSBOVUxMX1NBVEVMTElURSkgewogICAgICAgICAgdGhpcy5zYXRlbGxpdGUgPSBOVUxMX1NBVEVMTElURTsKICAgICAgICAgIGFwcGx5U2F0ZWxsaXRlcyh0aGlzLCBzYXRlbGxpdGVzKTsKICAgICAgICB9CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgIHRoaXMub3duZXIgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXRPd25lcihvd25lcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRDaGlsZE5vZGVzU3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCBkYXRhKSB7CiAgICAgICAgdmFyIHN0YXRlQ29kZSA9IFN0cmluZyhzdGF0ZSk7CiAgICAgICAgdmFyIG9sZFN0YXRlID0gdGhpcy5jaGlsZE5vZGVzU3RhdGU7CiAgICAgICAgaWYgKCFTVEFURS52YWx1ZXNbc3RhdGVDb2RlXSkgdGhyb3cgbmV3IEVycm9yKCJXcm9uZyBzdGF0ZSB2YWx1ZSIpOwogICAgICAgIGlmIChvbGRTdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgb2xkU3RhdGUuZGF0YSAhPSBkYXRhKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNTdGF0ZSA9IE9iamVjdChzdGF0ZUNvZGUpOwogICAgICAgICAgdGhpcy5jaGlsZE5vZGVzU3RhdGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQpIHt9LAogICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5ld0NoaWxkLCByZWZDaGlsZCkge30sCiAgICAgIHJlbW92ZUNoaWxkOiBmdW5jdGlvbihvbGRDaGlsZCkge30sCiAgICAgIHJlcGxhY2VDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQsIG9sZENoaWxkKSB7fSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7fSwKICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24obm9kZXMpIHt9LAogICAgICBzZXRHcm91cGluZzogZnVuY3Rpb24oZ3JvdXBpbmcsIGFsaXZlKSB7fSwKICAgICAgc2V0U29ydGluZzogZnVuY3Rpb24oc29ydGluZywgZGVzYykge30sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHt9LAogICAgICBzZXRPd25lcjogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICBpZiAoIW93bmVyIHx8IG93bmVyIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlID09IGZhbHNlKSBvd25lciA9IG51bGw7CiAgICAgICAgaWYgKG93bmVyICYmIHRoaXMucGFyZW50Tm9kZSkgdGhyb3cgRVhDRVBUSU9OX1BBUkVOVE5PREVfT1dORVJfQ09ORkxJQ1Q7CiAgICAgICAgdmFyIG9sZE93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob2xkT3duZXIgIT09IG93bmVyKSB7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLm93bmVyOwogICAgICAgICAgaWYgKG9sZE93bmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSAmJiBvbGRPd25lci5zYXRlbGxpdGUuX19hdXRvX18gJiYgdGhpcy5vd25lclNhdGVsbGl0ZU5hbWUgaW4gb2xkT3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogYXV0by1zYXRlbGxpdGUgY2FuJ3QgY2hhbmdlIGl0J3Mgb3duZXIiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9sZE93bmVyLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIGlmICh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSkgewogICAgICAgICAgICAgIHRoaXMub3duZXIgPSBudWxsOwogICAgICAgICAgICAgIG9sZE93bmVyLnNldFNhdGVsbGl0ZSh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvd25lciAmJiBsaXN0ZW5IYW5kbGVyKSBvd25lci5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgdGhpcy5vd25lciA9IG93bmVyOwogICAgICAgICAgdGhpcy5lbWl0X293bmVyQ2hhbmdlZChvbGRPd25lcik7CiAgICAgICAgICBpZiAodGhpcy5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuT1dORVIgfHwgdGhpcy5hdXRvRGVsZWdhdGUgPT09IERFTEVHQVRFLkFOWSkgdGhpcy5zZXREZWxlZ2F0ZShvd25lcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTYXRlbGxpdGU6IGZ1bmN0aW9uKG5hbWUsIHNhdGVsbGl0ZSwgYXV0b1NldCkgewogICAgICAgIHZhciBvbGRTYXRlbGxpdGUgPSB0aGlzLnNhdGVsbGl0ZVtuYW1lXSB8fCBudWxsOwogICAgICAgIHZhciBhdXRvID0gdGhpcy5zYXRlbGxpdGUuX19hdXRvX187CiAgICAgICAgdmFyIGF1dG9Db25maWcgPSBhdXRvICYmIGF1dG9bbmFtZV07CiAgICAgICAgdmFyIHByZXNlcnZlQXV0byA9IGF1dG9TZXQgJiYgYXV0b0NvbmZpZzsKICAgICAgICBpZiAocHJlc2VydmVBdXRvKSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBhdXRvQ29uZmlnLmluc3RhbmNlOwogICAgICAgICAgaWYgKGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUpIGRlbGV0ZSBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZS5zZXRPd25lcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2F0ZWxsaXRlID0gcHJvY2Vzc1NhdGVsbGl0ZUNvbmZpZyhzYXRlbGxpdGUpOwogICAgICAgICAgaWYgKHNhdGVsbGl0ZSAmJiBzYXRlbGxpdGUub3duZXIgJiYgYXV0byAmJiBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lICYmIGF1dG9bc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZV0pIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogYXV0by1jcmVhdGUgc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBuYW1lIGluc2lkZSBvd25lciIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXV0b0NvbmZpZykgewogICAgICAgICAgICBkZWxldGUgYXV0b1tuYW1lXTsKICAgICAgICAgICAgaWYgKGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlKSBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZS5yZW1vdmVIYW5kbGVyKEFVVE9fU0FURUxMSVRFX0lOU1RBTkNFX0hBTkRMRVIsIGF1dG9Db25maWcpOwogICAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaGFuZGxlcikgdGhpcy5yZW1vdmVIYW5kbGVyKGF1dG9Db25maWcuY29uZmlnLmhhbmRsZXIsIGF1dG9Db25maWcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2xkU2F0ZWxsaXRlICE9PSBzYXRlbGxpdGUpIHsKICAgICAgICAgIHZhciBzYXRlbGxpdGVMaXN0ZW4gPSB0aGlzLmxpc3Rlbi5zYXRlbGxpdGU7CiAgICAgICAgICB2YXIgZGVzdHJveVNhdGVsbGl0ZTsKICAgICAgICAgIGlmIChvbGRTYXRlbGxpdGUpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2F0ZWxsaXRlW25hbWVdOwogICAgICAgICAgICBvbGRTYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgaWYgKGF1dG9Db25maWcgJiYgb2xkU2F0ZWxsaXRlLmRlc3Ryb3kgPT09IHdhcm5PbkF1dG9TYXRlbGxpdGVEZXN0b3kpIHsKICAgICAgICAgICAgICBkZXN0cm95U2F0ZWxsaXRlID0gb2xkU2F0ZWxsaXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGVMaXN0ZW4pIG9sZFNhdGVsbGl0ZS5yZW1vdmVIYW5kbGVyKHNhdGVsbGl0ZUxpc3RlbiwgdGhpcyk7CiAgICAgICAgICAgICAgb2xkU2F0ZWxsaXRlLnNldE93bmVyKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcmVzZXJ2ZUF1dG8gJiYgIXNhdGVsbGl0ZSAmJiBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZSkgYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2Uuc2V0T3duZXIgPSB3YXJuT25BdXRvU2F0ZWxsaXRlT3duZXJDaGFuZ2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBBYnN0cmFjdE5vZGUgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICB2YXIgYXV0b0NvbmZpZyA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0aGlzLAogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGNvbmZpZzogc2F0ZWxsaXRlLAogICAgICAgICAgICAgICAgaW5zdGFuY2U6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUuaGFuZGxlcikgdGhpcy5hZGRIYW5kbGVyKHNhdGVsbGl0ZS5oYW5kbGVyLCBhdXRvQ29uZmlnKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLmluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBzYXRlbGxpdGUuaW5zdGFuY2UuYWRkSGFuZGxlcihBVVRPX1NBVEVMTElURV9JTlNUQU5DRV9IQU5ETEVSLCBhdXRvQ29uZmlnKTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5pbnN0YW5jZS5zZXRPd25lciA9IHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFhdXRvKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zYXRlbGxpdGUgPT09IE5VTExfU0FURUxMSVRFKSB0aGlzLnNhdGVsbGl0ZSA9IHt9OwogICAgICAgICAgICAgICAgYXV0byA9IHRoaXMuc2F0ZWxsaXRlLl9fYXV0b19fID0ge307CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF1dG9bbmFtZV0gPSBhdXRvQ29uZmlnOwogICAgICAgICAgICAgIFNBVEVMTElURV9VUERBVEUuY2FsbChhdXRvQ29uZmlnLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIWF1dG9Db25maWcuaW5zdGFuY2UgJiYgb2xkU2F0ZWxsaXRlKSB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgICAgICAgIGlmIChkZXN0cm95U2F0ZWxsaXRlKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgaWYgKGF1dG9Db25maWcgJiYgYXV0b0NvbmZpZy5jb25maWcuZGVsZWdhdGUpIHsKICAgICAgICAgICAgICAgIHZhciBhdXRvRGVsZWdhdGUgPSBzYXRlbGxpdGUuYXV0b0RlbGVnYXRlOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLnNldE93bmVyKHRoaXMpOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZSA9IGF1dG9EZWxlZ2F0ZTsKICAgICAgICAgICAgICB9IGVsc2Ugc2F0ZWxsaXRlLnNldE93bmVyKHRoaXMpOwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUub3duZXIgIT09IHRoaXMpIHJldHVybjsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlTGlzdGVuKSBzYXRlbGxpdGUuYWRkSGFuZGxlcihzYXRlbGxpdGVMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zYXRlbGxpdGVbc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lLCBzYXRlbGxpdGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zYXRlbGxpdGUgPT0gTlVMTF9TQVRFTExJVEUpIHRoaXMuc2F0ZWxsaXRlID0ge307CiAgICAgICAgICAgIHRoaXMuc2F0ZWxsaXRlW25hbWVdID0gc2F0ZWxsaXRlOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zYXRlbGxpdGVDaGFuZ2VkKG5hbWUsIG9sZFNhdGVsbGl0ZSk7CiAgICAgICAgICBpZiAoZGVzdHJveVNhdGVsbGl0ZSkgewogICAgICAgICAgICBkZWxldGUgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICBkZXN0cm95U2F0ZWxsaXRlLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldENoaWxkTm9kZXNEYXRhc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY2hpbGROb2Rlc0RhdGFzZXRNYXBbdGhpcy5iYXNpc09iamVjdElkXSB8fCBuZXcgQ2hpbGROb2Rlc0RhdGFzZXQoewogICAgICAgICAgc291cmNlTm9kZTogdGhpcwogICAgICAgIH0pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSB8fCB0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgewogICAgICAgICAgdGhpcy5zZXREYXRhU291cmNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHRoaXMuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nLnNldE93bmVyKCk7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3duZXIpIHRoaXMuc2V0T3duZXIoKTsKICAgICAgICB2YXIgc2F0ZWxsaXRlcyA9IHRoaXMuc2F0ZWxsaXRlOwogICAgICAgIGlmIChzYXRlbGxpdGVzICE9PSBOVUxMX1NBVEVMTElURSkgewogICAgICAgICAgdmFyIGF1dG8gPSBzYXRlbGxpdGVzLl9fYXV0b19fOwogICAgICAgICAgZGVsZXRlIHNhdGVsbGl0ZXMuX19hdXRvX187CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGF1dG8pIGlmIChhdXRvW25hbWVdLmNvbmZpZy5pbnN0YW5jZSAmJiAhYXV0b1tuYW1lXS5pbnN0YW5jZSkgYXV0b1tuYW1lXS5jb25maWcuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBzYXRlbGxpdGVzKSB7CiAgICAgICAgICAgIHZhciBzYXRlbGxpdGUgPSBzYXRlbGxpdGVzW25hbWVdOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXIgPSBudWxsOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5kZXN0cm95ID09PSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95KSBkZWxldGUgc2F0ZWxsaXRlLmRlc3Ryb3k7CiAgICAgICAgICAgIHNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNhdGVsbGl0ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hpbGROb2RlcyA9IG51bGw7CiAgICAgICAgdGhpcy5wYXJlbnROb2RlID0gbnVsbDsKICAgICAgICB0aGlzLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5maXJzdENoaWxkID0gbnVsbDsKICAgICAgICB0aGlzLmxhc3RDaGlsZCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFBhcnRpdGlvbk5vZGUgPSBDbGFzcyhBYnN0cmFjdE5vZGUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlBhcnRpdGlvbk5vZGUiLAogICAgICBhdXRvRGVzdHJveUlmRW1wdHk6IGZhbHNlLAogICAgICBub2RlczogbnVsbCwKICAgICAgZmlyc3Q6IG51bGwsCiAgICAgIGxhc3Q6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubm9kZXMgPSBbXTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgaW5zZXJ0OiBmdW5jdGlvbihuZXdOb2RlLCByZWZOb2RlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICB2YXIgcG9zID0gcmVmTm9kZSA/IG5vZGVzLmluZGV4T2YocmVmTm9kZSkgOiAtMTsKICAgICAgICBpZiAocG9zID09IC0xKSB7CiAgICAgICAgICBub2Rlcy5wdXNoKG5ld05vZGUpOwogICAgICAgICAgdGhpcy5sYXN0ID0gbmV3Tm9kZTsKICAgICAgICB9IGVsc2Ugbm9kZXMuc3BsaWNlKHBvcywgMCwgbmV3Tm9kZSk7CiAgICAgICAgdGhpcy5maXJzdCA9IG5vZGVzWzBdOwogICAgICAgIG5ld05vZGUuZ3JvdXBOb2RlID0gdGhpczsKICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGluc2VydGVkOiBbIG5ld05vZGUgXQogICAgICAgIH0pOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9sZE5vZGUpIHsKICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLm5vZGVzOwogICAgICAgIGlmIChhcnJheVJlbW92ZShub2Rlcywgb2xkTm9kZSkpIHsKICAgICAgICAgIHRoaXMuZmlyc3QgPSBub2Rlc1swXSB8fCBudWxsOwogICAgICAgICAgdGhpcy5sYXN0ID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKICAgICAgICAgIG9sZE5vZGUuZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICBkZWxldGVkOiBbIG9sZE5vZGUgXQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5maXJzdCAmJiB0aGlzLmF1dG9EZXN0cm95SWZFbXB0eSkgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuZmlyc3QpIHJldHVybjsKICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLm5vZGVzOwogICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGg7IGktLSA+IDA7ICkgbm9kZXNbaV0uZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICB0aGlzLm5vZGVzID0gW107CiAgICAgICAgdGhpcy5maXJzdCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGRlbGV0ZWQ6IG5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuYXV0b0Rlc3Ryb3lJZkVtcHR5KSB0aGlzLmRlc3Ryb3koKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5ub2RlcyA9IG51bGw7CiAgICAgICAgdGhpcy5maXJzdCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRE9NTUlYSU5fREFUQVNPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFTb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG5ld0RlbHRhID0ge307CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgbmV3RGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgICAgICBpZiAodGhpcy5jaGlsZE5vZGVzLmxlbmd0aCA9PSBkZWx0YS5kZWxldGVkLmxlbmd0aCkgewogICAgICAgICAgICBkZWxldGVkID0gYXJyYXlGcm9tKHRoaXMuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBkZWxldGVkW2ldOyBpKyspIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShjaGlsZCk7CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmRhdGFTb3VyY2U7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2xlYXIodHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IHRtcDsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwXyA9IHt9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWx0YS5kZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgZGVsZWdhdGVJZCA9IGl0ZW0uYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICB2YXIgb2xkQ2hpbGQgPSB0aGlzLmRhdGFTb3VyY2VNYXBfW2RlbGVnYXRlSWRdOwogICAgICAgICAgICAgIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShvbGRDaGlsZCk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZGF0YVNvdXJjZU1hcF9bZGVsZWdhdGVJZF07CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9sZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIG5ld0RlbHRhLmluc2VydGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlQ2hpbGRCeUZhY3RvcnkodGhpcywgewogICAgICAgICAgICAgIGRlbGVnYXRlOiBpdGVtCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsb2NrRGF0YVNvdXJjZUl0ZW1Ob2RlKG5ld0NoaWxkKTsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwX1tpdGVtLmJhc2lzT2JqZWN0SWRdID0gbmV3Q2hpbGQ7CiAgICAgICAgICAgIG5ld0RlbHRhLmluc2VydGVkLnB1c2gobmV3Q2hpbGQpOwogICAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5maXJzdENoaWxkKSB0aGlzLnNldENoaWxkTm9kZXMobmV3RGVsdGEuaW5zZXJ0ZWQpOyBlbHNlIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQobmV3RGVsdGEpOwogICAgICAgIGlmICh0aGlzLmRlc3Ryb3lEYXRhU291cmNlTWVtYmVyICYmIGRlbGV0ZWQubGVuZ3RoKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGRlbGV0ZWRbaV07IGkrKykgaXRlbS5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIHN0YXRlQ2hhbmdlZDogZnVuY3Rpb24oZGF0YVNvdXJjZSkgewogICAgICAgIHRoaXMuc2V0Q2hpbGROb2Rlc1N0YXRlKGRhdGFTb3VyY2Uuc3RhdGUsIGRhdGFTb3VyY2Uuc3RhdGUuZGF0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICBpZiAoIXRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aGlzLnNldERhdGFTb3VyY2UoKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNSVhJTl9EQVRBU09VUkNFX1dSQVBQRVJfSEFORExFUiA9IHsKICAgICAgZGF0YXNldENoYW5nZWQ6IGZ1bmN0aW9uKHdyYXBwZXIpIHsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2Uod3JhcHBlcik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSgpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gZmFzdENoaWxkTm9kZXNPcmRlcihub2RlLCBvcmRlcikgewogICAgICB2YXIgbGFzdEluZGV4ID0gb3JkZXIubGVuZ3RoIC0gMTsKICAgICAgbm9kZS5jaGlsZE5vZGVzID0gb3JkZXI7CiAgICAgIG5vZGUuZmlyc3RDaGlsZCA9IG9yZGVyWzBdIHx8IG51bGw7CiAgICAgIG5vZGUubGFzdENoaWxkID0gb3JkZXJbbGFzdEluZGV4XSB8fCBudWxsOwogICAgICBmb3IgKHZhciBvcmRlck5vZGUsIGkgPSBsYXN0SW5kZXg7IG9yZGVyTm9kZSA9IG9yZGVyW2ldOyBpLS0pIHsKICAgICAgICBvcmRlck5vZGUubmV4dFNpYmxpbmcgPSBvcmRlcltpICsgMV0gfHwgbnVsbDsKICAgICAgICBvcmRlck5vZGUucHJldmlvdXNTaWJsaW5nID0gb3JkZXJbaSAtIDFdIHx8IG51bGw7CiAgICAgICAgbm9kZS5pbnNlcnRCZWZvcmUob3JkZXJOb2RlLCBvcmRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBmYXN0Q2hpbGROb2Rlc0dyb3VwT3JkZXIobm9kZSwgb3JkZXIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IG9yZGVyW2ldOyBpKyspIGNoaWxkLmdyb3VwTm9kZS5ub2Rlcy5wdXNoKGNoaWxkKTsKICAgICAgb3JkZXIubGVuZ3RoID0gMDsKICAgICAgZm9yICh2YXIgZ3JvdXAgPSBub2RlLmdyb3VwaW5nLm51bGxHcm91cDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIHsKICAgICAgICB2YXIgbm9kZXMgPSBncm91cC5ub2RlczsKICAgICAgICBncm91cC5maXJzdCA9IG5vZGVzWzBdIHx8IG51bGw7CiAgICAgICAgZ3JvdXAubGFzdCA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgICAgICAgb3JkZXIucHVzaC5hcHBseShvcmRlciwgbm9kZXMpOwogICAgICAgIGdyb3VwLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGluc2VydGVkOiBub2RlcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkQnlGYWN0b3J5KG5vZGUsIGNvbmZpZykgewogICAgICB2YXIgY2hpbGQ7CiAgICAgIGlmICh0eXBlb2Ygbm9kZS5jaGlsZEZhY3RvcnkgPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNoaWxkID0gbm9kZS5jaGlsZEZhY3RvcnkoY29uZmlnKTsKICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBub2RlLmNoaWxkQ2xhc3MpIHJldHVybiBjaGlsZDsKICAgICAgfQogICAgICBpZiAoIWNoaWxkKSB0aHJvdyBFWENFUFRJT05fTlVMTF9DSElMRDsKICAgICAgYmFzaXMuZGV2Lndhcm4oRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUyArICIgKGV4cGVjdGVkICIgKyAobm9kZS5jaGlsZENsYXNzICYmIG5vZGUuY2hpbGRDbGFzcy5jbGFzc05hbWUpICsgIiBidXQgIiArIChjaGlsZCAmJiBjaGlsZC5jb25zdHJ1Y3RvciAmJiBjaGlsZC5jb25zdHJ1Y3Rvci5jbGFzc05hbWUpICsgIikiKTsKICAgICAgdGhyb3cgRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUzsKICAgIH0KICAgIHZhciBEb21NaXhpbiA9IHsKICAgICAgY2hpbGRDbGFzczogQWJzdHJhY3ROb2RlLAogICAgICBjaGlsZEZhY3Rvcnk6IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFTb3VyY2U6IERPTU1JWElOX0RBVEFTT1VSQ0VfSEFORExFUgogICAgICB9LAogICAgICBnZXRDaGlsZDogZnVuY3Rpb24odmFsdWUsIGdldHRlcikgewogICAgICAgIHJldHVybiBiYXNpcy5hcnJheS5zZWFyY2godGhpcy5jaGlsZE5vZGVzLCB2YWx1ZSwgZ2V0dGVyKTsKICAgICAgfSwKICAgICAgZ2V0Q2hpbGRCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRDaGlsZChuYW1lLCAibmFtZSIpOwogICAgICB9LAogICAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQpOwogICAgICB9LAogICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5ld0NoaWxkLCByZWZDaGlsZCkgewogICAgICAgIGlmICghdGhpcy5jaGlsZENsYXNzKSB0aHJvdyBFWENFUFRJT05fTk9fQ0hJTERDTEFTUzsKICAgICAgICBpZiAobmV3Q2hpbGQuZmlyc3RDaGlsZCkgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKGN1cnNvciA9PT0gbmV3Q2hpbGQpIHRocm93IEVYQ0VQVElPTl9DQU5UX0lOU0VSVDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQ2hpbGRDbGFzc0luc3RhbmNlID0gbmV3Q2hpbGQgJiYgbmV3Q2hpbGQgaW5zdGFuY2VvZiB0aGlzLmNoaWxkQ2xhc3M7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSkgewogICAgICAgICAgaWYgKCFpc0NoaWxkQ2xhc3NJbnN0YW5jZSB8fCAhbmV3Q2hpbGQuZGVsZWdhdGUgfHwgdGhpcy5kYXRhU291cmNlTWFwX1tuZXdDaGlsZC5kZWxlZ2F0ZS5iYXNpc09iamVjdElkXSAhPT0gbmV3Q2hpbGQpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0NoaWxkQ2xhc3NJbnN0YW5jZSkgbmV3Q2hpbGQgPSBjcmVhdGVDaGlsZEJ5RmFjdG9yeSh0aGlzLCBuZXdDaGlsZCBpbnN0YW5jZW9mIERhdGFPYmplY3QgPyB7CiAgICAgICAgICBkZWxlZ2F0ZTogbmV3Q2hpbGQKICAgICAgICB9IDogbmV3Q2hpbGQpOwogICAgICAgIGlmIChuZXdDaGlsZC5vd25lcikgdGhyb3cgRVhDRVBUSU9OX1BBUkVOVE5PREVfT1dORVJfQ09ORkxJQ1Q7CiAgICAgICAgdmFyIGlzSW5zaWRlID0gbmV3Q2hpbGQucGFyZW50Tm9kZSA9PT0gdGhpczsKICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHRoaXMuY2hpbGROb2RlczsKICAgICAgICB2YXIgZ3JvdXBpbmcgPSB0aGlzLmdyb3VwaW5nOwogICAgICAgIHZhciBncm91cE5vZGVzOwogICAgICAgIHZhciBjdXJyZW50TmV3Q2hpbGRHcm91cCA9IG5ld0NoaWxkLmdyb3VwTm9kZTsKICAgICAgICB2YXIgZ3JvdXAgPSBudWxsOwogICAgICAgIHZhciBzb3J0aW5nID0gdGhpcy5zb3J0aW5nOwogICAgICAgIHZhciBzb3J0aW5nRGVzYzsKICAgICAgICB2YXIgY29ycmVjdFNvcnRQb3MgPSBmYWxzZTsKICAgICAgICB2YXIgbmV3Q2hpbGRWYWx1ZTsKICAgICAgICB2YXIgcG9zID0gLTE7CiAgICAgICAgdmFyIG5leHRTaWJsaW5nOwogICAgICAgIHZhciBwcmV2U2libGluZzsKICAgICAgICBpZiAoaXNJbnNpZGUpIHsKICAgICAgICAgIG5leHRTaWJsaW5nID0gbmV3Q2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICBwcmV2U2libGluZyA9IG5ld0NoaWxkLnByZXZpb3VzU2libGluZzsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIHsKICAgICAgICAgIHJlZkNoaWxkID0gbnVsbDsKICAgICAgICAgIHNvcnRpbmdEZXNjID0gdGhpcy5zb3J0aW5nRGVzYzsKICAgICAgICAgIG5ld0NoaWxkVmFsdWUgPSBzb3J0aW5nKG5ld0NoaWxkKSB8fCAwOwogICAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZFZhbHVlID09PSBuZXdDaGlsZC5zb3J0aW5nVmFsdWUpIHsKICAgICAgICAgICAgICBjb3JyZWN0U29ydFBvcyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCghbmV4dFNpYmxpbmcgfHwgKHNvcnRpbmdEZXNjID8gbmV4dFNpYmxpbmcuc29ydGluZ1ZhbHVlIDw9IG5ld0NoaWxkVmFsdWUgOiBuZXh0U2libGluZy5zb3J0aW5nVmFsdWUgPj0gbmV3Q2hpbGRWYWx1ZSkpICYmICghcHJldlNpYmxpbmcgfHwgKHNvcnRpbmdEZXNjID8gcHJldlNpYmxpbmcuc29ydGluZ1ZhbHVlID49IG5ld0NoaWxkVmFsdWUgOiBwcmV2U2libGluZy5zb3J0aW5nVmFsdWUgPD0gbmV3Q2hpbGRWYWx1ZSkpKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZC5zb3J0aW5nVmFsdWUgPSBuZXdDaGlsZFZhbHVlOwogICAgICAgICAgICAgICAgY29ycmVjdFNvcnRQb3MgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ3JvdXBpbmcpIHsKICAgICAgICAgIHZhciBjdXJzb3I7CiAgICAgICAgICBncm91cCA9IGdyb3VwaW5nLmdldEdyb3VwTm9kZShuZXdDaGlsZCwgdHJ1ZSk7CiAgICAgICAgICBncm91cE5vZGVzID0gZ3JvdXAubm9kZXM7CiAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgPT09IGdyb3VwKSBpZiAoY29ycmVjdFNvcnRQb3MgfHwgc29ydGluZyA9PT0gbnVsbEdldHRlciAmJiBuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCA9PT0gZ3JvdXAgJiYgY29ycmVjdFNvcnRQb3MpIHsKICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcgJiYgbmV4dFNpYmxpbmcuZ3JvdXBOb2RlID09PSBncm91cCkgcG9zID0gZ3JvdXBOb2Rlcy5pbmRleE9mKG5leHRTaWJsaW5nKTsgZWxzZSBwb3MgPSBncm91cE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoZ3JvdXBOb2RlcywgbmV3Q2hpbGRWYWx1ZSwgc29ydGluZ1NlYXJjaCwgc29ydGluZ0Rlc2MpOwogICAgICAgICAgICAgIG5ld0NoaWxkLnNvcnRpbmdWYWx1ZSA9IG5ld0NoaWxkVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZWZDaGlsZCAmJiByZWZDaGlsZC5ncm91cE5vZGUgPT09IGdyb3VwKSBwb3MgPSBncm91cE5vZGVzLmluZGV4T2YocmVmQ2hpbGQpOyBlbHNlIHBvcyA9IGdyb3VwTm9kZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IGdyb3VwTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJlZkNoaWxkID0gZ3JvdXBOb2Rlc1twb3NdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGdyb3VwLmxhc3QpIHsKICAgICAgICAgICAgICByZWZDaGlsZCA9IGdyb3VwLmxhc3QubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY3Vyc29yID0gZ3JvdXA7CiAgICAgICAgICAgICAgcmVmQ2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubmV4dFNpYmxpbmcpIGlmIChyZWZDaGlsZCA9IGN1cnNvci5maXJzdCkgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdDaGlsZCA9PT0gcmVmQ2hpbGQgfHwgaXNJbnNpZGUgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCAhPT0gZ3JvdXApIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXApIGN1cnJlbnROZXdDaGlsZEdyb3VwLnJlbW92ZShuZXdDaGlsZCk7CiAgICAgICAgICAgICAgZ3JvdXAuaW5zZXJ0KG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcG9zID0gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICAgIGlmIChjb3JyZWN0U29ydFBvcykgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgICAgICBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoY2hpbGROb2RlcywgbmV3Q2hpbGRWYWx1ZSwgc29ydGluZ1NlYXJjaCwgc29ydGluZ0Rlc2MpOwogICAgICAgICAgICByZWZDaGlsZCA9IGNoaWxkTm9kZXNbcG9zXTsKICAgICAgICAgICAgbmV3Q2hpbGQuc29ydGluZ1ZhbHVlID0gbmV3Q2hpbGRWYWx1ZTsKICAgICAgICAgICAgaWYgKG5ld0NoaWxkID09PSByZWZDaGlsZCB8fCBpc0luc2lkZSAmJiBuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZWZDaGlsZCAmJiByZWZDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgICAgIGlmIChuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQgPT09IHJlZkNoaWxkKSB0aHJvdyBFWENFUFRJT05fQ0FOVF9JTlNFUlQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICBpZiAobmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nID0gcHJldlNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB0aGlzLmxhc3RDaGlsZCA9IHByZXZTaWJsaW5nOwogICAgICAgICAgaWYgKHByZXZTaWJsaW5nKSB7CiAgICAgICAgICAgIHByZXZTaWJsaW5nLm5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgdGhpcy5maXJzdENoaWxkID0gbmV4dFNpYmxpbmc7CiAgICAgICAgICBpZiAocG9zID09IC0xKSBhcnJheVJlbW92ZShjaGlsZE5vZGVzLCBuZXdDaGlsZCk7IGVsc2UgewogICAgICAgICAgICB2YXIgb2xkUG9zID0gY2hpbGROb2Rlcy5pbmRleE9mKG5ld0NoaWxkKTsKICAgICAgICAgICAgY2hpbGROb2Rlcy5zcGxpY2Uob2xkUG9zLCAxKTsKICAgICAgICAgICAgcG9zIC09IG9sZFBvcyA8IHBvczsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCkgewogICAgICAgICAgICBjdXJyZW50TmV3Q2hpbGRHcm91cC5yZW1vdmUobmV3Q2hpbGQpOwogICAgICAgICAgICBjdXJyZW50TmV3Q2hpbGRHcm91cCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuZXdDaGlsZC5wYXJlbnROb2RlKSBuZXdDaGlsZC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5ld0NoaWxkKTsKICAgICAgICB9CiAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwICE9IGdyb3VwKSBncm91cC5pbnNlcnQobmV3Q2hpbGQsIHJlZkNoaWxkKTsKICAgICAgICBpZiAocmVmQ2hpbGQpIHsKICAgICAgICAgIGlmIChwb3MgPT0gLTEpIHBvcyA9IGNoaWxkTm9kZXMuaW5kZXhPZihyZWZDaGlsZCk7CiAgICAgICAgICBpZiAocG9zID09IC0xKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgICBuZXdDaGlsZC5uZXh0U2libGluZyA9IHJlZkNoaWxkOwogICAgICAgICAgY2hpbGROb2Rlcy5zcGxpY2UocG9zLCAwLCBuZXdDaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBvcyA9IGNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgICAgY2hpbGROb2Rlcy5wdXNoKG5ld0NoaWxkKTsKICAgICAgICAgIHJlZkNoaWxkID0gewogICAgICAgICAgICBwcmV2aW91c1NpYmxpbmc6IHRoaXMubGFzdENoaWxkCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgbmV3Q2hpbGQucGFyZW50Tm9kZSA9IHRoaXM7CiAgICAgICAgbmV3Q2hpbGQucHJldmlvdXNTaWJsaW5nID0gcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nOwogICAgICAgIGlmIChwb3MgPT0gMCkgdGhpcy5maXJzdENoaWxkID0gbmV3Q2hpbGQ7IGVsc2UgcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nLm5leHRTaWJsaW5nID0gbmV3Q2hpbGQ7CiAgICAgICAgcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nID0gbmV3Q2hpbGQ7CiAgICAgICAgaWYgKCFpc0luc2lkZSkgewogICAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24obmV3Q2hpbGQsIG5ld0NoaWxkLmNvbnRleHRTZWxlY3Rpb24sIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgdHJ1ZSk7CiAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQobmV3Q2hpbGQsIHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5jb250ZXh0RGlzYWJsZWQpOwogICAgICAgICAgaWYgKChuZXdDaGlsZC51bmRlck1hdGNoXyB8fCB0aGlzLm1hdGNoRnVuY3Rpb24pICYmIG5ld0NoaWxkLm1hdGNoKSBuZXdDaGlsZC5tYXRjaCh0aGlzLm1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgaWYgKG5ld0NoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgbmV3Q2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIG5ld0NoaWxkLnNldERlbGVnYXRlKHRoaXMpOwogICAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UpIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICBpbnNlcnRlZDogWyBuZXdDaGlsZCBdCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChuZXdDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSkgdGhpcy5hZGRIYW5kbGVyKG5ld0NoaWxkLmxpc3Rlbi5wYXJlbnROb2RlLCBuZXdDaGlsZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgaWYgKCFvbGRDaGlsZCB8fCBvbGRDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgaWYgKG9sZENoaWxkIGluc3RhbmNlb2YgdGhpcy5jaGlsZENsYXNzID09IGZhbHNlKSB0aHJvdyBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHsKICAgICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UuaGFzKG9sZENoaWxkLmRlbGVnYXRlKSkgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VfQ09ORkxJQ1Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VBREFQVEVSX0NPTkZMSUNUOwogICAgICAgIH0KICAgICAgICB2YXIgcG9zID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2Yob2xkQ2hpbGQpOwogICAgICAgIGlmIChwb3MgPT0gLTEpIHRocm93IEVYQ0VQVElPTl9OT0RFX05PVF9GT1VORDsKICAgICAgICB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKHBvcywgMSk7CiAgICAgICAgb2xkQ2hpbGQucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgaWYgKG9sZENoaWxkLm5leHRTaWJsaW5nKSBvbGRDaGlsZC5uZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmcgPSBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmc7IGVsc2UgdGhpcy5sYXN0Q2hpbGQgPSBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgaWYgKG9sZENoaWxkLnByZXZpb3VzU2libGluZykgb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nLm5leHRTaWJsaW5nID0gb2xkQ2hpbGQubmV4dFNpYmxpbmc7IGVsc2UgdGhpcy5maXJzdENoaWxkID0gb2xkQ2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgb2xkQ2hpbGQubmV4dFNpYmxpbmcgPSBudWxsOwogICAgICAgIG9sZENoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgaWYgKG9sZENoaWxkLmxpc3Rlbi5wYXJlbnROb2RlKSB0aGlzLnJlbW92ZUhhbmRsZXIob2xkQ2hpbGQubGlzdGVuLnBhcmVudE5vZGUsIG9sZENoaWxkKTsKICAgICAgICB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihvbGRDaGlsZCwgb2xkQ2hpbGQuY29udGV4dFNlbGVjdGlvbiwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgaWYgKG9sZENoaWxkLmdyb3VwTm9kZSkgb2xkQ2hpbGQuZ3JvdXBOb2RlLnJlbW92ZShvbGRDaGlsZCk7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UpIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgZGVsZXRlZDogWyBvbGRDaGlsZCBdCiAgICAgICAgfSk7CiAgICAgICAgaWYgKG9sZENoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgb2xkQ2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIG9sZENoaWxkLnNldERlbGVnYXRlKCk7CiAgICAgICAgcmV0dXJuIG9sZENoaWxkOwogICAgICB9LAogICAgICByZXBsYWNlQ2hpbGQ6IGZ1bmN0aW9uKG5ld0NoaWxkLCBvbGRDaGlsZCkgewogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VBREFQVEVSX0NPTkZMSUNUOwogICAgICAgIGlmIChvbGRDaGlsZCA9PSBudWxsIHx8IG9sZENoaWxkLnBhcmVudE5vZGUgIT09IHRoaXMpIHRocm93IEVYQ0VQVElPTl9OT0RFX05PVF9GT1VORDsKICAgICAgICB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZCwgb2xkQ2hpbGQpOwogICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUNoaWxkKG9sZENoaWxkKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLmRhdGFTb3VyY2UuaXRlbUNvdW50KSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICBpZiAoIXRoaXMuZmlyc3RDaGlsZCkgcmV0dXJuOwogICAgICAgIGlmIChhbGl2ZSkgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24odGhpcywgdGhpcy5zZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBudWxsLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgdGhpcy5maXJzdENoaWxkID0gbnVsbDsKICAgICAgICB0aGlzLmxhc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5jaGlsZE5vZGVzID0gW107CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBkZWxldGVkOiBjaGlsZE5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgZm9yICh2YXIgaSA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGNoaWxkTm9kZXNbaV07CiAgICAgICAgICBpZiAoY2hpbGQubGlzdGVuLnBhcmVudE5vZGUpIGNoaWxkLnBhcmVudE5vZGUucmVtb3ZlSGFuZGxlcihjaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSwgY2hpbGQpOwogICAgICAgICAgY2hpbGQucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBjaGlsZC5ncm91cE5vZGUgPSBudWxsOwogICAgICAgICAgaWYgKGFsaXZlKSB7CiAgICAgICAgICAgIGNoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgaWYgKGNoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgY2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIGNoaWxkLnNldERlbGVnYXRlKCk7CiAgICAgICAgICB9IGVsc2UgY2hpbGQuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgZm9yICh2YXIgY2hpbGROb2RlcyA9IHRoaXMuZ3JvdXBpbmcuY2hpbGROb2RlcywgaSA9IGNoaWxkTm9kZXMubGVuZ3RoIC0gMSwgZ3JvdXA7IGdyb3VwID0gY2hpbGROb2Rlc1tpXTsgaS0tKSBncm91cC5jbGVhcigpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24obmV3Q2hpbGROb2Rlcywga2VlcEFsaXZlKSB7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UgJiYgIXRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aGlzLmNsZWFyKGtlZXBBbGl2ZSk7CiAgICAgICAgaWYgKG5ld0NoaWxkTm9kZXMpIHsKICAgICAgICAgIGlmICgibGVuZ3RoIiBpbiBuZXdDaGlsZE5vZGVzID09IGZhbHNlKSBuZXdDaGlsZE5vZGVzID0gWyBuZXdDaGlsZE5vZGVzIF07CiAgICAgICAgICBpZiAobmV3Q2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHRtcCA9IHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQgPSAkdW5kZWY7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBuZXdDaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZE5vZGVzW2ldKTsKICAgICAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCA9IHRtcDsKICAgICAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IHRoaXMuY2hpbGROb2RlcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICBpZiAoIXRoaXMuY2hpbGRDbGFzcykgdGhyb3cgRVhDRVBUSU9OX05PX0NISUxEQ0xBU1M7CiAgICAgICAgZGF0YVNvdXJjZSA9IGJhc2lzLmRhdGEucmVzb2x2ZURhdGFzZXQodGhpcywgdGhpcy5zZXREYXRhU291cmNlLCBkYXRhU291cmNlLCAiZGF0YVNvdXJjZUFkYXB0ZXJfIik7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAhPT0gZGF0YVNvdXJjZSkgewogICAgICAgICAgdmFyIG9sZERhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2U7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmRhdGFTb3VyY2U7CiAgICAgICAgICBpZiAob2xkRGF0YVNvdXJjZSkgewogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VNYXBfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9sZERhdGFTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFTb3VyY2UpIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSB0aGlzLmNoaWxkTm9kZXNbaV07IGkrKykgdW5sb2NrRGF0YVNvdXJjZUl0ZW1Ob2RlKGNoaWxkKTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5kYXRhU291cmNlID0gZGF0YVNvdXJjZTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF8gPSB7fTsKICAgICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzU3RhdGUoZGF0YVNvdXJjZS5zdGF0ZSwgZGF0YVNvdXJjZS5zdGF0ZS5kYXRhKTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgICBkYXRhU291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGRhdGFTb3VyY2UuaXRlbUNvdW50ICYmIGxpc3RlbkhhbmRsZXIuaXRlbXNDaGFuZ2VkKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZC5jYWxsKHRoaXMsIGRhdGFTb3VyY2UsIHsKICAgICAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IGRhdGFTb3VyY2UuZ2V0SXRlbXMoKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNldENoaWxkTm9kZXNTdGF0ZShTVEFURS5VTkRFRklORUQpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X2RhdGFTb3VyY2VDaGFuZ2VkKG9sZERhdGFTb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0R3JvdXBpbmc6IGZ1bmN0aW9uKGdyb3VwaW5nLCBhbGl2ZSkgewogICAgICAgIGlmICh0eXBlb2YgZ3JvdXBpbmcgPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZ3JvdXBpbmcgPT0gInN0cmluZyIpIGdyb3VwaW5nID0gewogICAgICAgICAgcnVsZTogZ3JvdXBpbmcKICAgICAgICB9OwogICAgICAgIGlmIChncm91cGluZyBpbnN0YW5jZW9mIEdyb3VwaW5nTm9kZSA9PSBmYWxzZSkgewogICAgICAgICAgZ3JvdXBpbmcgPSBncm91cGluZyAmJiB0eXBlb2YgZ3JvdXBpbmcgPT0gIm9iamVjdCIgPyBuZXcgdGhpcy5ncm91cGluZ0NsYXNzKGdyb3VwaW5nKSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmdyb3VwaW5nICE9PSBncm91cGluZykgewogICAgICAgICAgdmFyIG9sZEdyb3VwaW5nID0gdGhpcy5ncm91cGluZzsKICAgICAgICAgIHZhciBvcmRlcjsKICAgICAgICAgIGlmIChvbGRHcm91cGluZykgewogICAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFncm91cGluZykgewogICAgICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIG9yZGVyID0gc29ydENoaWxkTm9kZXModGhpcyk7IGVsc2Ugb3JkZXIgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgICAgICAgICBvbGRHcm91cGluZy5udWxsR3JvdXAuY2xlYXIoKTsKICAgICAgICAgICAgICAgIHZhciBncm91cHMgPSBvbGRHcm91cGluZy5jaGlsZE5vZGVzLnNsaWNlKDApOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cHMubGVuZ3RoOyBpKyspIGdyb3Vwc1tpXS5jbGVhcigpOwogICAgICAgICAgICAgICAgZmFzdENoaWxkTm9kZXNPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG9sZEdyb3VwaW5nLnNldE93bmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ3JvdXBpbmcpIHsKICAgICAgICAgICAgdGhpcy5ncm91cGluZyA9IGdyb3VwaW5nOwogICAgICAgICAgICBncm91cGluZy5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIG9yZGVyID0gc29ydENoaWxkTm9kZXModGhpcyk7IGVsc2Ugb3JkZXIgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IG9yZGVyW2ldOyBpKyspIGNoaWxkLmdyb3VwTm9kZSA9IHRoaXMuZ3JvdXBpbmcuZ2V0R3JvdXBOb2RlKGNoaWxkLCB0cnVlKTsKICAgICAgICAgICAgICBvcmRlciA9IGZhc3RDaGlsZE5vZGVzR3JvdXBPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgICAgZmFzdENoaWxkTm9kZXNPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9ncm91cGluZ0NoYW5nZWQob2xkR3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U29ydGluZzogZnVuY3Rpb24oc29ydGluZywgc29ydGluZ0Rlc2MpIHsKICAgICAgICBzb3J0aW5nID0gZ2V0dGVyKHNvcnRpbmcpOwogICAgICAgIHNvcnRpbmdEZXNjID0gISFzb3J0aW5nRGVzYzsKICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBzb3J0aW5nIHx8IHRoaXMuc29ydGluZ0Rlc2MgIT0gISFzb3J0aW5nRGVzYykgewogICAgICAgICAgdmFyIG9sZFNvcnRpbmcgPSB0aGlzLnNvcnRpbmc7CiAgICAgICAgICB2YXIgb2xkU29ydGluZ0Rlc2MgPSB0aGlzLnNvcnRpbmdEZXNjOwogICAgICAgICAgdGhpcy5zb3J0aW5nID0gc29ydGluZzsKICAgICAgICAgIHRoaXMuc29ydGluZ0Rlc2MgPSAhIXNvcnRpbmdEZXNjOwogICAgICAgICAgaWYgKHNvcnRpbmcgIT09IG51bGxHZXR0ZXIgJiYgdGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgIHZhciBvcmRlciA9IFtdOwogICAgICAgICAgICB2YXIgbm9kZXM7CiAgICAgICAgICAgIGZvciAodmFyIG5vZGUgPSB0aGlzLmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSBub2RlLnNvcnRpbmdWYWx1ZSA9IHNvcnRpbmcobm9kZSkgfHwgMDsKICAgICAgICAgICAgaWYgKHRoaXMuZ3JvdXBpbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBncm91cCA9IHRoaXMuZ3JvdXBpbmcubnVsbEdyb3VwOyBncm91cDsgZ3JvdXAgPSBncm91cC5uZXh0U2libGluZykgewogICAgICAgICAgICAgICAgbm9kZXMgPSBncm91cC5ub2RlcyA9IHNvcnRDaGlsZE5vZGVzKHsKICAgICAgICAgICAgICAgICAgY2hpbGROb2RlczogZ3JvdXAubm9kZXMsCiAgICAgICAgICAgICAgICAgIHNvcnRpbmdEZXNjOiB0aGlzLnNvcnRpbmdEZXNjCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdyb3VwLmZpcnN0ID0gbm9kZXNbMF0gfHwgbnVsbDsKICAgICAgICAgICAgICAgIGdyb3VwLmxhc3QgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXSB8fCBudWxsOwogICAgICAgICAgICAgICAgb3JkZXIucHVzaC5hcHBseShvcmRlciwgbm9kZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3NvcnRpbmdDaGFuZ2VkKG9sZFNvcnRpbmcsIG9sZFNvcnRpbmdEZXNjKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldE1hdGNoRnVuY3Rpb246IGZ1bmN0aW9uKG1hdGNoRnVuY3Rpb24pIHsKICAgICAgICBpZiAodGhpcy5tYXRjaEZ1bmN0aW9uICE9IG1hdGNoRnVuY3Rpb24pIHsKICAgICAgICAgIHZhciBvbGRNYXRjaEZ1bmN0aW9uID0gdGhpcy5tYXRjaEZ1bmN0aW9uOwogICAgICAgICAgdGhpcy5tYXRjaEZ1bmN0aW9uID0gbWF0Y2hGdW5jdGlvbjsKICAgICAgICAgIGZvciAodmFyIG5vZGUgPSB0aGlzLmxhc3RDaGlsZDsgbm9kZTsgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSBub2RlLm1hdGNoKG1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgdGhpcy5lbWl0X21hdGNoRnVuY3Rpb25DaGFuZ2VkKG9sZE1hdGNoRnVuY3Rpb24pOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciBOb2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCBEb21NaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTm9kZSIsCiAgICAgIGVtaXRfZW5hYmxlOiBjcmVhdGVFdmVudCgiZW5hYmxlIikgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQoY2hpbGQsIGZhbHNlKTsKICAgICAgICBldmVudHMuZW5hYmxlLmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGVtaXRfZGlzYWJsZTogY3JlYXRlRXZlbnQoImRpc2FibGUiKSAmJiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBjaGlsZCA9IHRoaXMuZmlyc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQubmV4dFNpYmxpbmcpIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChjaGlsZCwgdHJ1ZSk7CiAgICAgICAgZXZlbnRzLmRpc2FibGUuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBmdW5jdGlvbihuYW1lLCBvbGRTYXRlbGxpdGUpIHsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZC5jYWxsKHRoaXMsIG5hbWUsIG9sZFNhdGVsbGl0ZSk7CiAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlW25hbWVdIGluc3RhbmNlb2YgTm9kZSkgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMuc2F0ZWxsaXRlW25hbWVdLCB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkKTsKICAgICAgfSwKICAgICAgZW1pdF9zZWxlY3Q6IGNyZWF0ZUV2ZW50KCJzZWxlY3QiKSwKICAgICAgZW1pdF91bnNlbGVjdDogY3JlYXRlRXZlbnQoInVuc2VsZWN0IiksCiAgICAgIGVtaXRfbWF0Y2g6IGNyZWF0ZUV2ZW50KCJtYXRjaCIpLAogICAgICBlbWl0X3VubWF0Y2g6IGNyZWF0ZUV2ZW50KCJ1bm1hdGNoIiksCiAgICAgIGVtaXRfbWF0Y2hGdW5jdGlvbkNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJtYXRjaEZ1bmN0aW9uQ2hhbmdlZCIsICJvbGRNYXRjaEZ1bmN0aW9uIiksCiAgICAgIHNlbGVjdGFibGU6IHRydWUsCiAgICAgIHNlbGVjdGVkOiBmYWxzZSwKICAgICAgc2VsZWN0aW9uOiBudWxsLAogICAgICBjb250ZXh0U2VsZWN0aW9uOiBudWxsLAogICAgICBtYXRjaEZ1bmN0aW9uOiBudWxsLAogICAgICBtYXRjaGVkOiB0cnVlLAogICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgIGNvbnRleHREaXNhYmxlZDogZmFsc2UsCiAgICAgIGxpc3RlbjogewogICAgICAgIG93bmVyOiB7CiAgICAgICAgICBlbmFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQodGhpcywgZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQodGhpcywgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHsKICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGlvbiBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCA9PSBmYWxzZSkgdGhpcy5zZWxlY3Rpb24gPSBuZXcgU2VsZWN0aW9uKHRoaXMuc2VsZWN0aW9uKTsKICAgICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zZWxlY3Rpb24pIHRoaXMuc2VsZWN0aW9uLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc2VsZWN0aW9uLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHRoaXMuZW1pdF9kaXNhYmxlKCk7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2VsZWN0KHRydWUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U2VsZWN0aW9uOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gIT09IHNlbGVjdGlvbikgewogICAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24odGhpcywgdGhpcy5zZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBzZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gJiYgdGhpcy5saXN0ZW4uc2VsZWN0aW9uKSB0aGlzLnNlbGVjdGlvbi5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLnNlbGVjdGlvbiwgdGhpcyk7CiAgICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbjsKICAgICAgICAgIGlmIChzZWxlY3Rpb24gJiYgdGhpcy5saXN0ZW4uc2VsZWN0aW9uKSBzZWxlY3Rpb24uYWRkSGFuZGxlcih0aGlzLmxpc3Rlbi5zZWxlY3Rpb24sIHRoaXMpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZDsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5jb250ZXh0U2VsZWN0aW9uOwogICAgICAgIGlmIChzZWxlY3Rpb24pIHsKICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0YWJsZSkgc2VsZWN0aW9uLnNldChbIHRoaXMgXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc2VsZWN0ZWQpIHNlbGVjdGlvbi5yZW1vdmUoWyB0aGlzIF0pOyBlbHNlIHNlbGVjdGlvbi5hZGQoWyB0aGlzIF0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkICYmIHRoaXMuc2VsZWN0YWJsZSkgewogICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLmVtaXRfc2VsZWN0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkICE9IHNlbGVjdGVkOwogICAgICB9LAogICAgICB1bnNlbGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZDsKICAgICAgICBpZiAoc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB0aGlzLmNvbnRleHRTZWxlY3Rpb247CiAgICAgICAgICBpZiAoc2VsZWN0aW9uKSBzZWxlY3Rpb24ucmVtb3ZlKFsgdGhpcyBdKTsgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbWl0X3Vuc2VsZWN0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkICE9IHNlbGVjdGVkOwogICAgICB9LAogICAgICBzZXRTZWxlY3RlZDogZnVuY3Rpb24oc2VsZWN0ZWQsIG11bHRpcGxlKSB7CiAgICAgICAgcmV0dXJuIHNlbGVjdGVkID8gdGhpcy5zZWxlY3QobXVsdGlwbGUpIDogdGhpcy51bnNlbGVjdCgpOwogICAgICB9LAogICAgICBlbmFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkaXNhYmxlZCA9IHRoaXMuZGlzYWJsZWQ7CiAgICAgICAgaWYgKGRpc2FibGVkKSB7CiAgICAgICAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGV4dERpc2FibGVkKSB0aGlzLmVtaXRfZW5hYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkICE9IGRpc2FibGVkOwogICAgICB9LAogICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGlzYWJsZWQgPSB0aGlzLmRpc2FibGVkOwogICAgICAgIGlmICghZGlzYWJsZWQpIHsKICAgICAgICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgaWYgKCF0aGlzLmNvbnRleHREaXNhYmxlZCkgdGhpcy5lbWl0X2Rpc2FibGUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgIT0gZGlzYWJsZWQ7CiAgICAgIH0sCiAgICAgIHNldERpc2FibGVkOiBmdW5jdGlvbihkaXNhYmxlZCkgewogICAgICAgIHJldHVybiBkaXNhYmxlZCA/IHRoaXMuZGlzYWJsZSgpIDogdGhpcy5lbmFibGUoKTsKICAgICAgfSwKICAgICAgaXNEaXNhYmxlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5jb250ZXh0RGlzYWJsZWQ7CiAgICAgIH0sCiAgICAgIG1hdGNoOiBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgaWYgKHR5cGVvZiBmdW5jICE9ICJmdW5jdGlvbiIpIGZ1bmMgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnVuZGVyTWF0Y2hfICYmICFmdW5jKSB0aGlzLnVuZGVyTWF0Y2hfKHRoaXMsIHRydWUpOwogICAgICAgIHRoaXMudW5kZXJNYXRjaF8gPSBmdW5jOwogICAgICAgIHZhciBtYXRjaGVkID0gIWZ1bmMgfHwgZnVuYyh0aGlzKTsKICAgICAgICBpZiAodGhpcy5tYXRjaGVkICE9IG1hdGNoZWQpIHsKICAgICAgICAgIHRoaXMubWF0Y2hlZCA9IG1hdGNoZWQ7CiAgICAgICAgICBpZiAobWF0Y2hlZCkgdGhpcy5lbWl0X21hdGNoKCk7IGVsc2UgdGhpcy5lbWl0X3VubWF0Y2goKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudW5zZWxlY3QoKTsKICAgICAgICB0aGlzLmNvbnRleHRTZWxlY3Rpb24gPSBudWxsOwogICAgICAgIGlmICh0aGlzLnNlbGVjdGlvbikgdGhpcy5zZXRTZWxlY3Rpb24oKTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgR3JvdXBpbmdOb2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCBEb21NaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuR3JvdXBpbmdOb2RlIiwKICAgICAgZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgZXZlbnRzLmNoaWxkTm9kZXNNb2RpZmllZC5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB0aGlzLm51bGxHcm91cC5uZXh0U2libGluZyA9IHRoaXMuZmlyc3RDaGlsZDsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBhcnJheVtpKytdOyApIHsKICAgICAgICAgICAgY2hpbGQuZ3JvdXBJZF8gPSBjaGlsZC5kZWxlZ2F0ZSA/IGNoaWxkLmRlbGVnYXRlLmJhc2lzT2JqZWN0SWQgOiBjaGlsZC5kYXRhLmlkOwogICAgICAgICAgICB0aGlzLm1hcF9bY2hpbGQuZ3JvdXBJZF9dID0gY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlICYmIHRoaXMubnVsbEdyb3VwLmZpcnN0KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gdGhpcy5vd25lcjsKICAgICAgICAgICAgdmFyIG5vZGVzID0gYXJyYXlGcm9tKHRoaXMubnVsbEdyb3VwLm5vZGVzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aDsgaS0tID4gMDsgKSBwYXJlbnROb2RlLmluc2VydEJlZm9yZShub2Rlc1tpXSwgbm9kZXNbaV0ubmV4dFNpYmxpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGZ1bmN0aW9uKG9sZE93bmVyKSB7CiAgICAgICAgaWYgKG9sZE93bmVyICYmIG9sZE93bmVyLmdyb3VwaW5nID09PSB0aGlzKSBvbGRPd25lci5zZXRHcm91cGluZyhudWxsLCB0cnVlKTsKICAgICAgICBpZiAodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLmdyb3VwaW5nICE9PSB0aGlzKSB0aGlzLm93bmVyLnNldEdyb3VwaW5nKHRoaXMpOwogICAgICAgIGV2ZW50cy5vd25lckNoYW5nZWQuY2FsbCh0aGlzLCBvbGRPd25lcik7CiAgICAgICAgaWYgKCF0aGlzLm93bmVyICYmIHRoaXMuYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lcikgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIG1hcF86IG51bGwsCiAgICAgIG51bGxHcm91cDogbnVsbCwKICAgICAgYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lcjogdHJ1ZSwKICAgICAgYXV0b0Rlc3Ryb3lFbXB0eUdyb3VwczogdHJ1ZSwKICAgICAgcnVsZTogbnVsbEdldHRlciwKICAgICAgY2hpbGRDbGFzczogUGFydGl0aW9uTm9kZSwKICAgICAgY2hpbGRGYWN0b3J5OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuY2hpbGRDbGFzcyhjb21wbGV0ZSh7CiAgICAgICAgICBhdXRvRGVzdHJveUlmRW1wdHk6IHRoaXMuZGF0YVNvdXJjZSA/IGZhbHNlIDogdGhpcy5hdXRvRGVzdHJveUVtcHR5R3JvdXBzCiAgICAgICAgfSwgY29uZmlnKSk7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICAgIHRoaXMubnVsbEdyb3VwID0gbmV3IFBhcnRpdGlvbk5vZGU7CiAgICAgICAgaWYgKCJncm91cEdldHRlciIgaW4gdGhpcykgewogICAgICAgICAgdGhpcy5ydWxlID0gZ2V0dGVyKHRoaXMuZ3JvdXBHZXR0ZXIpOwogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZSNncm91cEdldHRlciBpcyBkZXByZWNhdGVkIG5vdywgdXNlIGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZSNydWxlIGluc3RlYWQuIGdyb3VwR2V0dGVyIHZhbHVlIHdhcyBzZXQgdG8gcnVsZSBwcm9wZXJ0eS4iKTsKICAgICAgICB9CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGdldEdyb3VwTm9kZTogZnVuY3Rpb24obm9kZSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHZhciBncm91cFJlZiA9IHRoaXMucnVsZShub2RlKTsKICAgICAgICB2YXIgaXNEZWxlZ2F0ZSA9IGdyb3VwUmVmIGluc3RhbmNlb2YgRGF0YU9iamVjdDsKICAgICAgICB2YXIgZ3JvdXAgPSB0aGlzLm1hcF9baXNEZWxlZ2F0ZSA/IGdyb3VwUmVmLmJhc2lzT2JqZWN0SWQgOiBncm91cFJlZl07CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSkgYXV0b2NyZWF0ZSA9IGZhbHNlOwogICAgICAgIGlmICghZ3JvdXAgJiYgYXV0b2NyZWF0ZSkgewogICAgICAgICAgZ3JvdXAgPSB0aGlzLmFwcGVuZENoaWxkKGlzRGVsZWdhdGUgPyBncm91cFJlZiA6IHsKICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgIGlkOiBncm91cFJlZiwKICAgICAgICAgICAgICB0aXRsZTogZ3JvdXBSZWYKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBncm91cCB8fCB0aGlzLm51bGxHcm91cDsKICAgICAgfSwKICAgICAgc2V0RGF0YVNvdXJjZTogZnVuY3Rpb24oZGF0YVNvdXJjZSkgewogICAgICAgIHZhciBjdXJEYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIERvbU1peGluLnNldERhdGFTb3VyY2UuY2FsbCh0aGlzLCBkYXRhU291cmNlKTsKICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvd25lciAmJiB0aGlzLmRhdGFTb3VyY2UgIT09IGN1ckRhdGFTb3VyY2UpIHsKICAgICAgICAgIHZhciBub2RlcyA9IGFycmF5RnJvbShvd25lci5jaGlsZE5vZGVzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgb3duZXIuaW5zZXJ0QmVmb3JlKG5vZGVzW2ldLCBub2Rlc1tpICsgMV0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICBuZXdDaGlsZCA9IERvbU1peGluLmluc2VydEJlZm9yZS5jYWxsKHRoaXMsIG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgdmFyIGZpcnN0Tm9kZSA9IG5ld0NoaWxkLmZpcnN0OwogICAgICAgIGlmIChmaXJzdE5vZGUpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaXJzdE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHZhciBsYXN0Tm9kZSA9IG5ld0NoaWxkLmxhc3Q7CiAgICAgICAgICB2YXIgYmVmb3JlUHJldjsKICAgICAgICAgIHZhciBiZWZvcmVOZXh0OwogICAgICAgICAgdmFyIGFmdGVyUHJldjsKICAgICAgICAgIHZhciBhZnRlck5leHQgPSBudWxsOwogICAgICAgICAgdmFyIGN1cnNvciA9IG5ld0NoaWxkOwogICAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoYWZ0ZXJOZXh0ID0gY3Vyc29yLmZpcnN0KSBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFmdGVyUHJldiA9IGFmdGVyTmV4dCA/IGFmdGVyTmV4dC5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOwogICAgICAgICAgYmVmb3JlUHJldiA9IGZpcnN0Tm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICBiZWZvcmVOZXh0ID0gbGFzdE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICBpZiAoYmVmb3JlTmV4dCAhPT0gYWZ0ZXJOZXh0KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRDaGlsZE5vZGVzID0gcGFyZW50LmNoaWxkTm9kZXM7CiAgICAgICAgICAgIHZhciBub2RlcyA9IG5ld0NoaWxkLm5vZGVzOwogICAgICAgICAgICB2YXIgbm9kZXNDb3VudCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGJlZm9yZVByZXYpIGJlZm9yZVByZXYubmV4dFNpYmxpbmcgPSBiZWZvcmVOZXh0OwogICAgICAgICAgICBpZiAoYmVmb3JlTmV4dCkgYmVmb3JlTmV4dC5wcmV2aW91c1NpYmxpbmcgPSBiZWZvcmVQcmV2OwogICAgICAgICAgICBpZiAoYWZ0ZXJQcmV2KSBhZnRlclByZXYubmV4dFNpYmxpbmcgPSBmaXJzdE5vZGU7CiAgICAgICAgICAgIGlmIChhZnRlck5leHQpIGFmdGVyTmV4dC5wcmV2aW91c1NpYmxpbmcgPSBsYXN0Tm9kZTsKICAgICAgICAgICAgZmlyc3ROb2RlLnByZXZpb3VzU2libGluZyA9IGFmdGVyUHJldjsKICAgICAgICAgICAgbGFzdE5vZGUubmV4dFNpYmxpbmcgPSBhZnRlck5leHQ7CiAgICAgICAgICAgIHZhciBmaXJzdFBvcyA9IHBhcmVudENoaWxkTm9kZXMuaW5kZXhPZihmaXJzdE5vZGUpOwogICAgICAgICAgICB2YXIgYWZ0ZXJOZXh0UG9zID0gYWZ0ZXJOZXh0ID8gcGFyZW50Q2hpbGROb2Rlcy5pbmRleE9mKGFmdGVyTmV4dCkgOiBwYXJlbnRDaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGFmdGVyTmV4dFBvcyA+IGZpcnN0UG9zKSBhZnRlck5leHRQb3MgLT0gbm9kZXNDb3VudDsKICAgICAgICAgICAgcGFyZW50Q2hpbGROb2Rlcy5zcGxpY2UoZmlyc3RQb3MsIG5vZGVzQ291bnQpOwogICAgICAgICAgICBwYXJlbnRDaGlsZE5vZGVzLnNwbGljZS5hcHBseShwYXJlbnRDaGlsZE5vZGVzLCBbIGFmdGVyTmV4dFBvcywgMCBdLmNvbmNhdChub2RlcykpOwogICAgICAgICAgICBpZiAoIWFmdGVyUHJldiB8fCAhYmVmb3JlUHJldikgcGFyZW50LmZpcnN0Q2hpbGQgPSBwYXJlbnRDaGlsZE5vZGVzWzBdOwogICAgICAgICAgICBpZiAoIWFmdGVyTmV4dCB8fCAhYmVmb3JlTmV4dCkgcGFyZW50Lmxhc3RDaGlsZCA9IHBhcmVudENoaWxkTm9kZXNbcGFyZW50Q2hpbGROb2Rlcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgaWYgKGZpcnN0Tm9kZSBpbnN0YW5jZW9mIFBhcnRpdGlvbk5vZGUpIGZvciAodmFyIGkgPSBub2Rlc0NvdW50LCBpbnNlcnRCZWZvcmUgPSBhZnRlck5leHQ7IGktLSA+IDA7ICkgewogICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZXNbaV0sIGluc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlID0gbm9kZXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICB9LAogICAgICByZW1vdmVDaGlsZDogZnVuY3Rpb24ob2xkQ2hpbGQpIHsKICAgICAgICBpZiAob2xkQ2hpbGQgPSBEb21NaXhpbi5yZW1vdmVDaGlsZC5jYWxsKHRoaXMsIG9sZENoaWxkKSkgewogICAgICAgICAgZGVsZXRlIHRoaXMubWFwX1tvbGRDaGlsZC5ncm91cElkX107CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbm9kZTsgbm9kZSA9IG9sZENoaWxkLm5vZGVzW2ldOyBpKyspIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvbGRDaGlsZDsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgdmFyIGdldEdyb3VwTm9kZSA9IHRoaXMuZ2V0R3JvdXBOb2RlOwogICAgICAgIHZhciBudWxsR3JvdXAgPSB0aGlzLm51bGxHcm91cDsKICAgICAgICB0aGlzLmdldEdyb3VwTm9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG51bGxHcm91cDsKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGdyb3VwID0gdGhpcy5maXJzdENoaWxkOyBncm91cDsgZ3JvdXAgPSBncm91cC5uZXh0U2libGluZykgbm9kZXMucHVzaC5hcHBseShub2RlcywgZ3JvdXAubm9kZXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBub2Rlc1tpXTsgaSsrKSBjaGlsZC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCk7CiAgICAgICAgdGhpcy5nZXRHcm91cE5vZGUgPSBnZXRHcm91cE5vZGU7CiAgICAgICAgRG9tTWl4aW4uY2xlYXIuY2FsbCh0aGlzLCBhbGl2ZSk7CiAgICAgICAgdGhpcy5tYXBfID0ge307CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lciA9IGZhbHNlOwogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMubnVsbEdyb3VwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLm51bGxHcm91cCA9IG51bGw7CiAgICAgICAgdGhpcy5tYXBfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmdyb3VwaW5nQ2xhc3MgPSBHcm91cGluZ05vZGU7CiAgICB2YXIgQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIG5ld0RlbHRhID0ge307CiAgICAgICAgdmFyIG5vZGU7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSB7CiAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICAgICAgd2hpbGUgKG5vZGUgPSBpbnNlcnRlZFtpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25vZGUuYmFzaXNPYmplY3RJZF0gPSBub2RlOwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgewogICAgICAgICAgbmV3RGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgICAgICB3aGlsZSAobm9kZSA9IGRlbGV0ZWRbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZW1iZXJNYXBbbm9kZS5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGluc2VydENvdW50IHx8IGRlbGV0ZUNvdW50KSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKG5ld0RlbHRhKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQ2hpbGROb2Rlc0RhdGFzZXQgPSBDbGFzcyhBYnN0cmFjdERhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNoaWxkTm9kZXNEYXRhc2V0IiwKICAgICAgc291cmNlTm9kZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIHNvdXJjZU5vZGUgPSB0aGlzLnNvdXJjZU5vZGU7CiAgICAgICAgY2hpbGROb2Rlc0RhdGFzZXRNYXBbc291cmNlTm9kZS5iYXNpc09iamVjdElkXSA9IHRoaXM7CiAgICAgICAgaWYgKHNvdXJjZU5vZGUuZmlyc3RDaGlsZCkgQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUi5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBzb3VyY2VOb2RlLCB7CiAgICAgICAgICBpbnNlcnRlZDogc291cmNlTm9kZS5jaGlsZE5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgc291cmNlTm9kZS5hZGRIYW5kbGVyKENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIsIHRoaXMpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZU5vZGUucmVtb3ZlSGFuZGxlcihDSElMRE5PREVTREFUQVNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICBkZWxldGUgY2hpbGROb2Rlc0RhdGFzZXRNYXBbdGhpcy5zb3VyY2VOb2RlLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTZWxlY3Rpb24gPSBDbGFzcyhEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TZWxlY3Rpb24iLAogICAgICBtdWx0aXBsZTogZmFsc2UsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIERhdGFzZXQucHJvdG90eXBlLmVtaXRfaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmICghbm9kZS5zZWxlY3RlZCkgewogICAgICAgICAgICAgIG5vZGUuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIG5vZGUuZW1pdF9zZWxlY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBkZWx0YS5kZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgaWYgKG5vZGUuc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICBub2RlLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgbm9kZS5lbWl0X3Vuc2VsZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24obm9kZXMpIHsKICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIHsKICAgICAgICAgIGlmICh0aGlzLml0ZW1Db3VudCkgcmV0dXJuIHRoaXMuc2V0KG5vZGVzKTsgZWxzZSBub2RlcyA9IFsgbm9kZXNbMF0gXTsKICAgICAgICB9CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAobm9kZS5jb250ZXh0U2VsZWN0aW9uID09IHRoaXMgJiYgbm9kZS5zZWxlY3RhYmxlKSBpdGVtcy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRGF0YXNldC5wcm90b3R5cGUuYWRkLmNhbGwodGhpcywgaXRlbXMpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAobm9kZS5jb250ZXh0U2VsZWN0aW9uID09IHRoaXMgJiYgbm9kZS5zZWxlY3RhYmxlKSBpdGVtcy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIGl0ZW1zLnNwbGljZSgxKTsKICAgICAgICByZXR1cm4gRGF0YXNldC5wcm90b3R5cGUuc2V0LmNhbGwodGhpcywgaXRlbXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUxFR0FURTogREVMRUdBVEUsCiAgICAgIEFic3RyYWN0Tm9kZTogQWJzdHJhY3ROb2RlLAogICAgICBOb2RlOiBOb2RlLAogICAgICBHcm91cGluZ05vZGU6IEdyb3VwaW5nTm9kZSwKICAgICAgUGFydGl0aW9uTm9kZTogUGFydGl0aW9uTm9kZSwKICAgICAgQ2hpbGROb2Rlc0RhdGFzZXQ6IENoaWxkTm9kZXNEYXRhc2V0LAogICAgICBTZWxlY3Rpb246IFNlbGVjdGlvbiwKICAgICAgbnVsbFNlbGVjdGlvbjogbmV3IEFic3RyYWN0RGF0YXNldAogICAgfTsKICB9LAogICI3LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjbGVhbmVyID0gYmFzaXMuY2xlYW5lcjsKICAgIHZhciBwYXRoID0gYmFzaXMucGF0aDsKICAgIHZhciBhcnJheVNlYXJjaCA9IGJhc2lzLmFycmF5LnNlYXJjaDsKICAgIHZhciBhcnJheUFkZCA9IGJhc2lzLmFycmF5LmFkZDsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciB0ZW1wbGF0ZUxpc3QgPSBbXTsKICAgIHZhciB0bXBsRmlsZXNNYXAgPSB7fTsKICAgIHZhciBERUNMQVJBVElPTl9WRVJTSU9OID0gMjsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSAxOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gMjsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9DTEFTUyA9IDQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfU1RZTEUgPSA1OwogICAgdmFyIFRZUEVfQVRUUklCVVRFX0VWRU5UID0gNjsKICAgIHZhciBUWVBFX1RFWFQgPSAzOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IDg7CiAgICB2YXIgVE9LRU5fVFlQRSA9IDA7CiAgICB2YXIgVE9LRU5fQklORElOR1MgPSAxOwogICAgdmFyIFRPS0VOX1JFRlMgPSAyOwogICAgdmFyIEFUVFJfTkFNRSA9IDM7CiAgICB2YXIgQVRUUl9WQUxVRSA9IDQ7CiAgICB2YXIgQVRUUl9FVkVOVF9SWCA9IC9eZXZlbnQtKC4rKSQvOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gewogICAgICA0OiAiY2xhc3MiLAogICAgICA1OiAic3R5bGUiCiAgICB9OwogICAgdmFyIEFUVFJfVFlQRV9CWV9OQU1FID0gewogICAgICAiY2xhc3MiOiBUWVBFX0FUVFJJQlVURV9DTEFTUywKICAgICAgc3R5bGU6IFRZUEVfQVRUUklCVVRFX1NUWUxFCiAgICB9OwogICAgdmFyIEFUVFJfVkFMVUVfSU5ERVggPSB7CiAgICAgIDI6IEFUVFJfVkFMVUUsCiAgICAgIDQ6IEFUVFJfVkFMVUUgLSAxLAogICAgICA1OiBBVFRSX1ZBTFVFIC0gMSwKICAgICAgNjogMgogICAgfTsKICAgIHZhciBFTEVNRU5UX05BTUUgPSAzOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSA0OwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gNTsKICAgIHZhciBURVhUX1ZBTFVFID0gMzsKICAgIHZhciBDT01NRU5UX1ZBTFVFID0gMzsKICAgIHZhciBTWU5UQVhfRVJST1IgPSAiSW52YWxpZCBvciB1bnN1cHBvcnRlZCBzeW50YXgiOwogICAgdmFyIFRFWFQgPSAvKCg/Oi58W1xyXG5dKSo/KShceyg/OmwxMG46KFthLXpBLVpfXVthLXpBLVowLTlfXC1dKig/OlwuW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKSooPzpcLlx7W2EtekEtWl9dW2EtekEtWjAtOV9cLV0qXH0pPylcfSk/fDwoXC98IS0tKFxzKlx7KT8pP3wkKS9nOwogICAgdmFyIFRBR19OQU1FID0gLyhbYS16X11bYS16MC05XC1fXSopKDp8XHt8XHMqKFwvPz4pPykvaWc7CiAgICB2YXIgQVRUUklCVVRFX05BTUVfT1JfRU5EID0gLyhbYS16X11bYS16MC05X1wtXSopKDp8XHt8PXxccyopfChcLz8+KS9pZzsKICAgIHZhciBDT01NRU5UID0gLygufFtcclxuXSkqPy0tPi9nOwogICAgdmFyIENMT1NFX1RBRyA9IC8oW2Etel9dW2EtejAtOV9cLV0qKD86OlthLXpfXVthLXowLTlfXC1dKik/KT4vaWc7CiAgICB2YXIgUkVGRVJFTkNFID0gLyhbYS16X11bYS16MC05X10qKShcfHxcfVxzKikvaWc7CiAgICB2YXIgQVRUUklCVVRFX1ZBTFVFID0gLyIoKD86KFxcIil8W14iXSkqPykiXHMqL2c7CiAgICB2YXIgQlJFQUtfVEFHX1BBUlNFID0gL14vZzsKICAgIHZhciBUQUdfSUdOT1JFX0NPTlRFTlQgPSB7CiAgICAgIHRleHQ6IC8oKD86LnxbXHJcbl0pKj8pKD86PFwvYjp0ZXh0PnwkKS9nCiAgICB9OwogICAgdmFyIHF1b3RlVW5lc2NhcGUgPSAvXFwiL2c7CiAgICB2YXIgdG9rZW5pemUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgdGFnU3RhY2sgPSBbXTsKICAgICAgdmFyIGxhc3RUYWcgPSB7CiAgICAgICAgY2hpbGRzOiByZXN1bHQKICAgICAgfTsKICAgICAgdmFyIHNvdXJjZVRleHQ7CiAgICAgIHZhciB0b2tlbjsKICAgICAgdmFyIGJ1ZmZlclBvczsKICAgICAgdmFyIHN0YXJ0UG9zOwogICAgICB2YXIgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgdmFyIHRleHRTdGF0ZUVuZFBvcyA9IDA7CiAgICAgIHZhciB0ZXh0RW5kUG9zOwogICAgICB2YXIgc3RhdGUgPSBURVhUOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG07CiAgICAgIHNvdXJjZSA9IHNvdXJjZS50cmltKCk7CiAgICAgIHJlc3VsdC53YXJucyA9IFtdOwogICAgICB3aGlsZSAocG9zIDwgc291cmNlLmxlbmd0aCB8fCBzdGF0ZSAhPSBURVhUKSB7CiAgICAgICAgc3RhdGUubGFzdEluZGV4ID0gcG9zOwogICAgICAgIHN0YXJ0UG9zID0gcG9zOwogICAgICAgIG0gPSBzdGF0ZS5leGVjKHNvdXJjZSk7CiAgICAgICAgaWYgKCFtIHx8IG0uaW5kZXggIT09IHBvcykgewogICAgICAgICAgaWYgKHN0YXRlID09IFJFRkVSRU5DRSAmJiB0b2tlbiAmJiB0b2tlbi50eXBlID09IFRZUEVfQ09NTUVOVCkgewogICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnNlVGFnKSBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICBpZiAodG9rZW4pIGxhc3RUYWcuY2hpbGRzLnBvcCgpOwogICAgICAgICAgaWYgKHRva2VuID0gbGFzdFRhZy5jaGlsZHMucG9wKCkpIHsKICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9URVhUICYmICF0b2tlbi5yZWZzKSB0ZXh0U3RhdGVFbmRQb3MgLT0gImxlbiIgaW4gdG9rZW4gPyB0b2tlbi5sZW4gOiB0b2tlbi52YWx1ZS5sZW5ndGg7IGVsc2UgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJzZVRhZyA9IGZhbHNlOwogICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHBvcyA9IHN0YXRlLmxhc3RJbmRleDsKICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7CiAgICAgICAgICBjYXNlIFRFWFQ6CiAgICAgICAgICAgIHRleHRFbmRQb3MgPSBzdGFydFBvcyArIG1bMV0ubGVuZ3RoOwogICAgICAgICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHRleHRFbmRQb3MpIHsKICAgICAgICAgICAgICBzb3VyY2VUZXh0ID0gdGV4dFN0YXRlRW5kUG9zID09IHN0YXJ0UG9zID8gbVsxXSA6IHNvdXJjZS5zdWJzdHJpbmcodGV4dFN0YXRlRW5kUG9zLCB0ZXh0RW5kUG9zKTsKICAgICAgICAgICAgICB0b2tlbiA9IHNvdXJjZVRleHQucmVwbGFjZSgvXHMqKFxyXG4/fFxuXHI/KVxzKi9nLCAiIik7CiAgICAgICAgICAgICAgaWYgKHRva2VuKSBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIGxlbjogc291cmNlVGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICB2YWx1ZTogdG9rZW4KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZXh0U3RhdGVFbmRQb3MgPSB0ZXh0RW5kUG9zOwogICAgICAgICAgICBpZiAobVszXSkgewogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgcmVmczogWyAibDEwbjoiICsgbVszXSBdLAogICAgICAgICAgICAgICAgdmFsdWU6ICJ7bDEwbjoiICsgbVszXSArICJ9IgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1bMl0gPT0gInsiKSB7CiAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zIC0gMTsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhUCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgc3RhdGUgPSBSRUZFUkVOQ0U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVs0XSkgewogICAgICAgICAgICAgIGlmIChtWzRdID09ICIvIikgewogICAgICAgICAgICAgICAgdG9rZW4gPSBudWxsOwogICAgICAgICAgICAgICAgc3RhdGUgPSBDTE9TRV9UQUc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQ09NTUVOVAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAobVs1XSkgewogICAgICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3MgLSBtWzVdLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBSRUZFUkVOQ0U7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3M7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVsyXSkgewogICAgICAgICAgICAgIHBhcnNlVGFnID0gdHJ1ZTsKICAgICAgICAgICAgICB0YWdTdGFjay5wdXNoKGxhc3RUYWcpOwogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICBhdHRyczogW10sCiAgICAgICAgICAgICAgICBjaGlsZHM6IFtdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgbGFzdFRhZyA9IHRva2VuOwogICAgICAgICAgICAgIHN0YXRlID0gVEFHX05BTUU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENMT1NFX1RBRzoKICAgICAgICAgICAgaWYgKG1bMV0gIT09IChsYXN0VGFnLnByZWZpeCA/IGxhc3RUYWcucHJlZml4ICsgIjoiIDogIiIpICsgbGFzdFRhZy5uYW1lKSB7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICB2YWx1ZTogIjwvIiArIG1bMF0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVEFHX05BTUU6CiAgICAgICAgICBjYXNlIEFUVFJJQlVURV9OQU1FX09SX0VORDoKICAgICAgICAgICAgaWYgKG1bMl0gPT0gIjoiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnByZWZpeCkgc3RhdGUgPSBCUkVBS19UQUdfUEFSU0U7IGVsc2UgdG9rZW4ucHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsxXSkgewogICAgICAgICAgICAgIHRva2VuLm5hbWUgPSBtWzFdOwogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfQVRUUklCVVRFKSBsYXN0VGFnLmF0dHJzLnB1c2godG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzJdID09ICJ7IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfRUxFTUVOVCkgc3RhdGUgPSBSRUZFUkVOQ0U7IGVsc2Ugc3RhdGUgPSBCUkVBS19UQUdfUEFSU0U7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bM10pIHsKICAgICAgICAgICAgICBwYXJzZVRhZyA9IGZhbHNlOwogICAgICAgICAgICAgIGlmIChtWzNdID09ICIvPiIpIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsgZWxzZSBpZiAobGFzdFRhZy5wcmVmaXggPT0gImIiICYmIGxhc3RUYWcubmFtZSBpbiBUQUdfSUdOT1JFX0NPTlRFTlQpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gVEFHX0lHTk9SRV9DT05URU5UW2xhc3RUYWcubmFtZV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzJdID09ICI9IikgewogICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX1ZBTFVFOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ09NTUVOVDoKICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBzb3VyY2Uuc3Vic3RyaW5nKGJ1ZmZlclBvcywgcG9zIC0gMyk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFJFRkVSRU5DRToKICAgICAgICAgICAgaWYgKHRva2VuLnJlZnMpIHRva2VuLnJlZnMucHVzaChtWzFdKTsgZWxzZSB0b2tlbi5yZWZzID0gWyBtWzFdIF07CiAgICAgICAgICAgIGlmIChtWzJdICE9ICJ8IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgcG9zIC09IG1bMl0ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gc291cmNlLnN1YnN0cmluZyhidWZmZXJQb3MsIHBvcyk7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50eXBlID09IFRZUEVfQ09NTUVOVCkgewogICAgICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0FUVFJJQlVURSAmJiBzb3VyY2VbcG9zXSA9PSAiPSIpIHsKICAgICAgICAgICAgICAgIHBvcysrOwogICAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfVkFMVUU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQVRUUklCVVRFX1ZBTFVFOgogICAgICAgICAgICB0b2tlbi52YWx1ZSA9IG1bMV0ucmVwbGFjZShxdW90ZVVuZXNjYXBlLCAnIicpOwogICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICB9OwogICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRBR19JR05PUkVfQ09OVEVOVC50ZXh0OgogICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgdmFsdWU6IG1bMV0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93ICJQYXJzZXIgYnVnIjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlID09IFRFWFQpIHRleHRTdGF0ZUVuZFBvcyA9IHBvczsKICAgICAgfQogICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHBvcykgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgIHZhbHVlOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgcG9zKQogICAgICB9KTsKICAgICAgaWYgKGxhc3RUYWcubmFtZSkgcmVzdWx0Lndhcm5zLnB1c2goIk5vIGNsb3NlIHRhZyBmb3IgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiIpOwogICAgICBpZiAoIXJlc3VsdC53YXJucy5sZW5ndGgpIGRlbGV0ZSByZXN1bHQud2FybnM7CiAgICAgIHJlc3VsdC50ZW1wbGF0ZVRva2VucyA9IHRydWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgdmFyIHRva2VuVGVtcGxhdGUgPSB7fTsKICAgIHZhciBMMTBuUHJveHlUb2tlbiA9IGJhc2lzLlRva2VuLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkwxMG5Qcm94eVRva2VuIiwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgdGhpcy51cmwgPSB0b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICI6IiArIHRva2VuLm5hbWU7CiAgICAgICAgdGhpcy50b2tlbiA9IHRva2VuOwogICAgICAgIHRoaXMuc2V0KCk7CiAgICAgICAgdG9rZW4uYXR0YWNoKHRoaXMuc2V0LCB0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuVG9rZW4ucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIiA/IHByb2Nlc3NNYXJrdXAodGhpcy50b2tlbi52YWx1ZSwgdGhpcy50b2tlbi5uYW1lICsgIkAiICsgdGhpcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCkgOiAiIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50b2tlbiA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcHJvY2Vzc01hcmt1cCh2YWx1ZSwgaWQpIHsKICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz0iYmFzaXNqcy1tYXJrdXAiIGRhdGEtYmFzaXNqcy1sMTBuPSInICsgaWQgKyAnIj4nICsgU3RyaW5nKHZhbHVlKSArICI8L3NwYW4+IjsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICBpZiAodHlwZW9mIHRva2VuID09ICJzdHJpbmciKSB0b2tlbiA9IGJhc2lzLmwxMG4udG9rZW4odG9rZW4pOwogICAgICBpZiAoIXRva2VuKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIGlkID0gdG9rZW4uYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF07CiAgICAgIGlmICghdGVtcGxhdGUpIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF0gPSBuZXcgVGVtcGxhdGUobmV3IEwxMG5Qcm94eVRva2VuKHRva2VuKSk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIHZhciBtYWtlRGVjbGFyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIElERU5UID0gL15bYS16X11bYS16MC05X1wtXSokL2k7CiAgICAgIHZhciBDTEFTU19BVFRSX1BBUlRTID0gLyhcUyspL2c7CiAgICAgIHZhciBDTEFTU19BVFRSX0JJTkRJTkcgPSAvXihbYS16X11bYS16MC05X1wtXSopP1x7KChhbmltOik/W2Etel9dW2EtejAtOV9cLV0qKVx9JC9pOwogICAgICB2YXIgU1RZTEVfQVRUUl9QQVJUUyA9IC9ccypbXjpdKz9ccyo6KD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyg/Ojt8JCkvZ2k7CiAgICAgIHZhciBTVFlMRV9QUk9QRVJUWSA9IC9ccyooW146XSs/KVxzKjooKD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyk7PyQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfQklORElORyA9IC9ceyhbYS16X11bYS16MC05X10qKVx9L2k7CiAgICAgIHZhciBBVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKnxsMTBuOlthLXpfXVthLXowLTlfXSooPzpcLlthLXpfXVthLXowLTlfXSopKig/OlwuXHtbYS16X11bYS16MC05X10qXH0pPylcfS9pOwogICAgICB2YXIgTkFNRURfQ0hBUkFDVEVSX1JFRiA9IC8mKFthLXpdK3wjWzAtOV0rfCN4WzAtOWEtZl17MSw0fSk7Py9naTsKICAgICAgdmFyIHRva2VuTWFwID0gYmFzaXMuTk9ERV9FTlYgPyBub2RlX3JlcXVpcmUoIi4vdGVtcGxhdGUvaHRtbGVudGl0eS5qc29uIikgOiB7fTsKICAgICAgdmFyIHRva2VuRWxlbWVudCA9ICFiYXNpcy5OT0RFX0VOViA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpIDogbnVsbDsKICAgICAgdmFyIGluY2x1ZGVTdGFjayA9IFtdOwogICAgICBmdW5jdGlvbiBuYW1lKHRva2VuKSB7CiAgICAgICAgcmV0dXJuICh0b2tlbi5wcmVmaXggPyB0b2tlbi5wcmVmaXggKyAiOiIgOiAiIikgKyB0b2tlbi5uYW1lOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5hbWVkQ2hhclJlcGxhY2UobSwgdG9rZW4pIHsKICAgICAgICBpZiAoIXRva2VuTWFwW3Rva2VuXSkgewogICAgICAgICAgaWYgKHRva2VuLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gU3RyaW5nLmZyb21DaGFyQ29kZSh0b2tlbi5jaGFyQXQoMSkgPT0gIngiIHx8IHRva2VuLmNoYXJBdCgxKSA9PSAiWCIgPyBwYXJzZUludCh0b2tlbi5zdWJzdHIoMiksIDE2KSA6IHRva2VuLnN1YnN0cigxKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodG9rZW5FbGVtZW50KSB7CiAgICAgICAgICAgICAgdG9rZW5FbGVtZW50LmlubmVySFRNTCA9IG07CiAgICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gdG9rZW5FbGVtZW50LmZpcnN0Q2hpbGQgPyB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgOiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbk1hcFt0b2tlbl0gfHwgbTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1bnRva2VuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoTkFNRURfQ0hBUkFDVEVSX1JFRiwgbmFtZWRDaGFyUmVwbGFjZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVmTGlzdCh0b2tlbikgewogICAgICAgIHZhciBhcnJheSA9IHRva2VuLnJlZnM7CiAgICAgICAgaWYgKCFhcnJheSB8fCAhYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzc0F0dHIobmFtZSwgdmFsdWUpIHsKICAgICAgICBmdW5jdGlvbiBidWlsZEV4cHJlc3Npb24ocGFydHMpIHsKICAgICAgICAgIHZhciBiaW5kTmFtZTsKICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBbXTsKICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIGlmIChqICUgMikgewogICAgICAgICAgICBiaW5kTmFtZSA9IHBhcnRzW2pdOwogICAgICAgICAgICBpZiAoIW1hcFtiaW5kTmFtZV0pIHsKICAgICAgICAgICAgICBtYXBbYmluZE5hbWVdID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgIG5hbWVzLnB1c2goYmluZE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChtYXBbYmluZE5hbWVdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChwYXJ0c1tqXSkgZXhwcmVzc2lvbi5wdXNoKHVudG9rZW4ocGFydHNbal0pKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbIG5hbWVzLCBleHByZXNzaW9uIF07CiAgICAgICAgfQogICAgICAgIHZhciBiaW5kaW5ncyA9IDA7CiAgICAgICAgdmFyIHBhcnRzOwogICAgICAgIHZhciBtOwogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChDTEFTU19BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gW107CiAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChtID0gcGFydC5tYXRjaChDTEFTU19BVFRSX0JJTkRJTkcpKSBiaW5kaW5ncy5wdXNoKFsgbVsxXSB8fCAiIiwgbVsyXSBdKTsgZWxzZSBuZXdWYWx1ZS5wdXNoKHBhcnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWUgPSBuZXdWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gW107CiAgICAgICAgICAgICAgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChTVFlMRV9BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtID0gcGFydC5tYXRjaChTVFlMRV9QUk9QRVJUWSk7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBtWzFdOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBtWzJdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlUGFydHMgPSB2YWx1ZS5zcGxpdChTVFlMRV9BVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWVQYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cHIgPSBidWlsZEV4cHJlc3Npb24odmFsdWVQYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgZXhwci5wdXNoKHByb3BlcnR5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChleHByKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHByb3BzLnB1c2gocHJvcGVydHlOYW1lICsgIjogIiArIHVudG9rZW4odmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdCh2YWx1ZSkpIGJhc2lzLmRldi53YXJuKCJCYWQgdmFsdWUgZm9yIHN0eWxlIGF0dHJpYnV0ZSAodmFsdWUgaWdub3JlZCk6IiwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IHByb3BzLmpvaW4oIjsgIik7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB2YWx1ZSArPSAiOyI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcGFydHMgPSB2YWx1ZS5zcGxpdChBVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBiaW5kaW5ncyA9IGJ1aWxkRXhwcmVzc2lvbihwYXJ0cyk7IGVsc2UgdmFsdWUgPSB1bnRva2VuKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGJpbmRpbmdzICYmICFiaW5kaW5ncy5sZW5ndGgpIGJpbmRpbmdzID0gMDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgYmluZGluZzogYmluZGluZ3MsCiAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICB0eXBlOiBBVFRSX1RZUEVfQllfTkFNRVtuYW1lXSB8fCAyCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhdHRycyh0b2tlbiwgZGVjbFRva2VuLCBvcHRpbWl6ZVNpemUpIHsKICAgICAgICB2YXIgYXR0cnMgPSB0b2tlbi5hdHRyczsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIG07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoYXR0ci5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicmVmIjoKICAgICAgICAgICAgICAgIHZhciByZWZzID0gKGF0dHIudmFsdWUgfHwgIiIpLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZnMubGVuZ3RoOyBqKyspIGFkZFRva2VuUmVmKGRlY2xUb2tlbiwgcmVmc1tqXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtID0gYXR0ci5uYW1lLm1hdGNoKEFUVFJfRVZFTlRfUlgpKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1bMV0gPT0gYXR0ci52YWx1ZSA/IFsgVFlQRV9BVFRSSUJVVEVfRVZFTlQsIG1bMV0gXSA6IFsgVFlQRV9BVFRSSUJVVEVfRVZFTlQsIG1bMV0sIGF0dHIudmFsdWUgXSk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHIubmFtZSwgYXR0ci52YWx1ZSk7CiAgICAgICAgICB2YXIgaXRlbSA9IFsgcGFyc2VkLnR5cGUsIHBhcnNlZC5iaW5kaW5nLCByZWZMaXN0KGF0dHIpIF07CiAgICAgICAgICBpZiAocGFyc2VkLnR5cGUgPT0gMikgaXRlbS5wdXNoKG5hbWUoYXR0cikpOwogICAgICAgICAgaWYgKHBhcnNlZC52YWx1ZSAmJiAoIW9wdGltaXplU2l6ZSB8fCAhcGFyc2VkLmJpbmRpbmcgfHwgcGFyc2VkLnR5cGUgIT0gMikpIGl0ZW0ucHVzaChwYXJzZWQudmFsdWUpOwogICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0IDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRUb2tlblJlZih0b2tlbiwgcmVmTmFtZSkgewogICAgICAgIGlmICghdG9rZW5bVE9LRU5fUkVGU10pIHRva2VuW1RPS0VOX1JFRlNdID0gW107CiAgICAgICAgYXJyYXlBZGQodG9rZW5bVE9LRU5fUkVGU10sIHJlZk5hbWUpOwogICAgICAgIGlmIChyZWZOYW1lICE9ICJlbGVtZW50IikgdG9rZW5bVE9LRU5fQklORElOR1NdID0gdG9rZW5bVE9LRU5fUkVGU10ubGVuZ3RoID09IDEgPyByZWZOYW1lIDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSkgewogICAgICAgIHZhciBpZHggPSB0b2tlbltUT0tFTl9SRUZTXS5pbmRleE9mKHJlZk5hbWUpOwogICAgICAgIGlmIChpZHggIT0gLTEpIHsKICAgICAgICAgIHZhciBpbmRleEJpbmRpbmcgPSB0b2tlbltUT0tFTl9CSU5ESU5HU10gJiYgdHlwZW9mIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9PSAibnVtYmVyIjsKICAgICAgICAgIHRva2VuW1RPS0VOX1JFRlNdLnNwbGljZShpZHgsIDEpOwogICAgICAgICAgaWYgKGluZGV4QmluZGluZykgaWYgKGlkeCA9PSB0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSByZWZOYW1lOwogICAgICAgICAgaWYgKCF0b2tlbltUT0tFTl9SRUZTXS5sZW5ndGgpIHRva2VuW1RPS0VOX1JFRlNdID0gMDsgZWxzZSB7CiAgICAgICAgICAgIGlmIChpbmRleEJpbmRpbmcpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtPSBpZHggPCB0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB0b2tlbkF0dHJzKHRva2VuKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgIGlmICh0b2tlbi5hdHRycykgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSB0b2tlbi5hdHRyc1tpXTsgaSsrKSByZXN1bHRbbmFtZShhdHRyKV0gPSBhdHRyLnZhbHVlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWRkVW5pcXVlKGFycmF5LCBpdGVtcykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIGFycmF5QWRkKGFycmF5LCBpdGVtc1tpXSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzcyh0b2tlbnMsIHRlbXBsYXRlLCBvcHRpb25zKSB7CiAgICAgICAgZnVuY3Rpb24gbW9kaWZ5QXR0cih0b2tlbiwgbmFtZSwgYWN0aW9uKSB7CiAgICAgICAgICB2YXIgYXR0cnMgPSB0b2tlbkF0dHJzKHRva2VuKTsKICAgICAgICAgIGlmIChuYW1lKSBhdHRycy5uYW1lID0gbmFtZTsKICAgICAgICAgIGlmICghYXR0cnMubmFtZSkgewogICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJJbnN0cnVjdGlvbiA8YjoiICsgdG9rZW4ubmFtZSArICI+IGhhcyBubyBhdHRyaWJ1dGUgbmFtZSIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIUlERU5ULnRlc3QoYXR0cnMubmFtZSkpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGF0dHJpYnV0ZSBuYW1lIGAiICsgYXR0cnMubmFtZSArICJgIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbmNsdWRlZFRva2VuID0gdG9rZW5SZWZNYXBbYXR0cnMucmVmIHx8ICJlbGVtZW50Il07CiAgICAgICAgICBpZiAoaW5jbHVkZWRUb2tlbikgewogICAgICAgICAgICBpZiAoaW5jbHVkZWRUb2tlbi50b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgICB2YXIgaXRBdHRycyA9IGluY2x1ZGVkVG9rZW4udG9rZW47CiAgICAgICAgICAgICAgdmFyIGlzRXZlbnQgPSBhdHRycy5uYW1lLm1hdGNoKEFUVFJfRVZFTlRfUlgpOwogICAgICAgICAgICAgIHZhciBpdFR5cGUgPSBpc0V2ZW50ID8gVFlQRV9BVFRSSUJVVEVfRVZFTlQgOiBBVFRSX1RZUEVfQllfTkFNRVthdHRycy5uYW1lXSB8fCBUWVBFX0FUVFJJQlVURTsKICAgICAgICAgICAgICB2YXIgdmFsdWVJZHggPSBBVFRSX1ZBTFVFX0lOREVYW2l0VHlwZV0gfHwgQVRUUl9WQUxVRTsKICAgICAgICAgICAgICB2YXIgaXRBdHRyVG9rZW4gPSBpdEF0dHJzICYmIGFycmF5U2VhcmNoKGl0QXR0cnMsIGF0dHJzLm5hbWUsIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIHJldHVybiAiZXZlbnQtIiArIHRva2VuWzFdOwogICAgICAgICAgICAgICAgcmV0dXJuIEFUVFJfTkFNRV9CWV9UWVBFW3Rva2VuW1RPS0VOX1RZUEVdXSB8fCB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICAgIH0sIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgICAgIGlmICghaXRBdHRyVG9rZW4gJiYgYWN0aW9uICE9ICJyZW1vdmUiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNFdmVudCkgewogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbiA9IFsgaXRUeXBlLCBpc0V2ZW50WzFdIF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbiA9IFsgaXRUeXBlLCAwLCAwLCBpdFR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgPyBhdHRycy5uYW1lIDogIiIgXTsKICAgICAgICAgICAgICAgICAgaWYgKGl0VHlwZSA9PSBUWVBFX0FUVFJJQlVURSkgaXRBdHRyVG9rZW4ucHVzaCgiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWl0QXR0cnMpIHsKICAgICAgICAgICAgICAgICAgaXRBdHRycyA9IFtdOwogICAgICAgICAgICAgICAgICBpbmNsdWRlZFRva2VuLnRva2VuLnB1c2goaXRBdHRycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpdEF0dHJzLnB1c2goaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2xhc3NPclN0eWxlID0gYXR0cnMubmFtZSA9PSAiY2xhc3MiIHx8IGF0dHJzLm5hbWUgPT0gInN0eWxlIjsKICAgICAgICAgICAgICBzd2l0Y2ggKGFjdGlvbikgewogICAgICAgICAgICAgICAgY2FzZSAic2V0IjoKICAgICAgICAgICAgICAgICAgaWYgKGl0QXR0clRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzLnZhbHVlID09IGlzRXZlbnRbMV0pIGl0QXR0clRva2VuLmxlbmd0aCA9IDI7IGVsc2UgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gYXR0cnMudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRycy5uYW1lLCBhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHBhcnNlZC5iaW5kaW5nOwogICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMub3B0aW1pemVTaXplIHx8ICFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gfHwgY2xhc3NPclN0eWxlKSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSBwYXJzZWQudmFsdWUgfHwgIiI7IGVsc2UgaXRBdHRyVG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgICAgICAgIGlmIChjbGFzc09yU3R5bGUpIGlmICghaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdICYmICFpdEF0dHJUb2tlblt2YWx1ZUlkeF0pIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHJzLm5hbWUsIGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZC5iaW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ckJpbmRpbmdzID0gaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGF0dHJzLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkQmluZGluZ01hcCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG9sZEJpbmRpbmc7IG9sZEJpbmRpbmcgPSBhdHRyQmluZGluZ3NbaV07IGkrKykgb2xkQmluZGluZ01hcFtvbGRCaW5kaW5nWzJdXSA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmV3QmluZGluZzsgbmV3QmluZGluZyA9IHBhcnNlZC5iaW5kaW5nW2ldOyBpKyspIGlmIChuZXdCaW5kaW5nWzJdIGluIG9sZEJpbmRpbmdNYXApIGF0dHJCaW5kaW5nc1tvbGRCaW5kaW5nTWFwW25ld0JpbmRpbmdbMl1dXSA9IG5ld0JpbmRpbmc7IGVsc2UgYXR0ckJpbmRpbmdzLnB1c2gobmV3QmluZGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyQmluZGluZ3MucHVzaC5hcHBseShhdHRyQmluZGluZ3MsIHBhcnNlZC5iaW5kaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWQuYmluZGluZ1swXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlBZGQodGhpcywgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBhdHRyQmluZGluZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJzZWQuYmluZGluZ1sxXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZWQuYmluZGluZ1sxXVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIikgdmFsdWUgPSBhdHRyQmluZGluZ3NbMF0uaW5kZXhPZihwYXJzZWQuYmluZGluZ1swXVt2YWx1ZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyQmluZGluZ3NbMV0ucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHBhcnNlZC5iaW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsYXNzT3JTdHlsZSkgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdWzFdLnVuc2hpZnQoaXRBdHRyVG9rZW5bdmFsdWVJZHhdKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbGFzc09yU3R5bGUgJiYgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdKSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU11bMV0ucHVzaChhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChwYXJzZWQudmFsdWUpIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IChpdEF0dHJUb2tlblt2YWx1ZUlkeF0gfHwgIiIpICsgKGl0QXR0clRva2VuW3ZhbHVlSWR4XSAmJiAoaXNFdmVudCB8fCBjbGFzc09yU3R5bGUpID8gIiAiIDogIiIpICsgcGFyc2VkLnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoY2xhc3NPclN0eWxlKSBpZiAoIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiAhaXRBdHRyVG9rZW5bdmFsdWVJZHhdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZSI6CiAgICAgICAgICAgICAgICAgIGlmIChpdEF0dHJUb2tlbikgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQXR0cmlidXRlIG1vZGlmaWNhdG9yIGlzIG5vdCByZWZlcmVuY2UgdG8gZWxlbWVudCB0b2tlbiAocmVmZXJlbmNlIG5hbWU6ICIgKyAoYXR0cnMucmVmIHx8ICJlbGVtZW50IikgKyAiKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdG9rZW4sIGl0ZW07IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciByZWZzID0gcmVmTGlzdCh0b2tlbik7CiAgICAgICAgICB2YXIgYmluZGluZ3MgPSByZWZzICYmIHJlZnMubGVuZ3RoID09IDEgPyByZWZzWzBdIDogMDsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgICBpZiAodG9rZW4ucHJlZml4ID09ICJiIikgewogICAgICAgICAgICAgICAgdmFyIGVsQXR0cnMgPSB0b2tlbkF0dHJzKHRva2VuKTsKICAgICAgICAgICAgICAgIHN3aXRjaCAodG9rZW4ubmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJyZXNvdXJjZSI6CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4ubmFtZSA9PSAicmVzb3VyY2UiKSBiYXNpcy5kZXYud2FybigiPGI6cmVzb3VyY2U+IGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIFVzZSA8YjpzdHlsZT4gaW5zdGVhZC4iICsgKHRlbXBsYXRlLnNvdXJjZVVybCA/ICIgRmlsZTogIiArIHRlbXBsYXRlLnNvdXJjZVVybCA6ICIiKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZWxBdHRycy5zcmMpKSBiYXNpcy5kZXYud2FybigiQmFkIHVzYWdlOiA8YjoiICsgdG9rZW4ubmFtZSArICcgc3JjPSInICsgZWxBdHRycy5zcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLnJlc291cmNlcy5wdXNoKHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgZWxBdHRycy5zcmMpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImwxMG4iOgogICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQpIHRlbXBsYXRlLndhcm5zLnB1c2goIjxiOmwxMG4+IG11c3QgYmUgZGVjbGFyZWQgYmVmb3JlIGFueSBgbDEwbjpgIHRva2VuIChpbnN0cnVjdGlvbiBpZ25vcmVkKSIpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnNyYykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGVsQXR0cnMuc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIGVsQXR0cnMuc3JjICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kaWN0VVJJID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkksIGVsQXR0cnMuc3JjKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImRlZmluZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCJuYW1lIiBpbiBlbEF0dHJzICYmICF0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZWxBdHRycy50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2wiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSA9IFsgZWxBdHRyc1siZGVmYXVsdCJdID09ICJ0cnVlIiA/IDEgOiAwIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVudW0iOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBlbEF0dHJzLnZhbHVlcyA/IGVsQXR0cnMudmFsdWVzLnRyaW0oKS5zcGxpdCgiICIpIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyB2YWx1ZXMuaW5kZXhPZihlbEF0dHJzWyJkZWZhdWx0Il0pICsgMSwgdmFsdWVzIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGRlZmluZSB0eXBlIGAiICsgZWxBdHRycy50eXBlICsgImAgZm9yICIgKyBlbEF0dHJzLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSBiYXNpcy5vYmplY3QuZXh0ZW5kKHRleHQsIHsKICAgICAgICAgICAgICAgICAgICAgIHJlZnM6IChlbEF0dHJzLnJlZiB8fCAiIikudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAibm90cmltIiBpbiBlbEF0dHJzID8gdGV4dC52YWx1ZSA6IHRleHQudmFsdWUucmVwbGFjZSgvXlxzKltcclxuXSt8W1xyXG5dXHMqJC9nLCAiIikKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaW5jbHVkZSI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlU3JjID0gZWxBdHRycy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlU3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNUZW1wbGF0ZVJlZiA9IC9eI1xkKyQvLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IGlzVGVtcGxhdGVSZWYgPyB0ZW1wbGF0ZVNyYy5zdWJzdHIoMSkgOiB0ZW1wbGF0ZVNyYzsKICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlUmVmKSByZXNvdXJjZSA9IHRlbXBsYXRlTGlzdFt1cmxdOyBlbHNlIGlmICgvXlthLXowLTlcLl0rJC9pLnRlc3QodXJsKSAmJiAhL1wudG1wbCQvLnRlc3QodXJsKSkgcmVzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgodXJsKTsgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdCh1cmwpKSBiYXNpcy5kZXYud2FybignQmFkIHVzYWdlOiA8YjppbmNsdWRlIHNyYz0iJyArIHVybCArICciLz4uXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgdXJsKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goJzxiOmluY2x1ZGUgc3JjPSInICsgdGVtcGxhdGVTcmMgKyAnIj4gaXMgbm90IHJlc29sdmVkLCBpbnN0cnVjdGlvbiBpZ25vcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCc8YjppbmNsdWRlIHNyYz0iJyArIHRlbXBsYXRlU3JjICsgJyI+IGlzIG5vdCByZXNvbHZlZCwgaW5zdHJ1Y3Rpb24gaWdub3JlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlU3RhY2suaW5kZXhPZihyZXNvdXJjZSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlY2w7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZVN0YWNrLnB1c2gocmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZS5zb3VyY2UuYmluZGluZ0JyaWRnZSkgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2Uuc291cmNlLCByZXNvdXJjZS5iYXNlVVJJLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2UsIHJlc291cmNlLnVybCA/IHBhdGguZGlybmFtZShyZXNvdXJjZS51cmwpICsgIi8iIDogIiIsIHRydWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGVTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wucmVzb3VyY2VzICYmICJuby1zdHlsZSIgaW4gZWxBdHRycyA9PSBmYWxzZSkgYWRkVW5pcXVlKHRlbXBsYXRlLnJlc291cmNlcywgZGVjbC5yZXNvdXJjZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5kZXBzKSBhZGRVbmlxdWUodGVtcGxhdGUuZGVwcywgZGVjbC5kZXBzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wubDEwbikgYWRkVW5pcXVlKHRlbXBsYXRlLmwxMG4sIGRlY2wubDEwbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlblJlZk1hcCA9IG5vcm1hbGl6ZVJlZnMoZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdHJ1Y3Rpb25zID0gKHRva2VuLmNoaWxkcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnNbImNsYXNzIl0pIGluc3RydWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4OiAiYiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogImFwcGVuZC1jbGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM6IFsgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAidmFsdWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVsQXR0cnNbImNsYXNzIl0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IF0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLmlkKSBpbnN0cnVjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogImIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJzZXQtYXR0ciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM6IFsgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAibmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogImlkIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBlbEF0dHJzLmlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBdCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRycy5yZWYpIGlmICh0b2tlblJlZk1hcC5lbGVtZW50KSBlbEF0dHJzLnJlZi50cmltKCkuc3BsaXQoL1xzKy8pLm1hcChmdW5jdGlvbihyZWZOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkVG9rZW5SZWYodG9rZW5SZWZNYXAuZWxlbWVudC50b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgY2hpbGQ7IGNoaWxkID0gaW5zdHJ1Y3Rpb25zW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PSBUWVBFX0VMRU1FTlQgJiYgY2hpbGQucHJlZml4ID09ICJiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJiZWZvcmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZnRlciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VPclJlbW92ZSA9IGNoaWxkLm5hbWUgPT0gInJlcGxhY2UiIHx8IGNoaWxkLm5hbWUgPT0gInJlbW92ZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyB8fCAhcmVwbGFjZU9yUmVtb3ZlID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gdG9rZW5SZWYub3duZXIuaW5kZXhPZih0b2tlblJlZi50b2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gWyBwb3MgKyAoY2hpbGQubmFtZSA9PSAiYWZ0ZXIiKSwgcmVwbGFjZU9yUmVtb3ZlIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lICE9ICJyZW1vdmUiKSBhcmdzID0gYXJncy5jb25jYXQocHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuUmVmLm93bmVyLnNwbGljZS5hcHBseSh0b2tlblJlZi5vd25lciwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJwcmVwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcyA9IHByb2Nlc3MoY2hpbGQuY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQubmFtZSA9PSAicHJlcGVuZCIpIHRva2VuLnNwbGljZS5hcHBseSh0b2tlbiwgWyBFTEVNRU5UX0FUVFJTLCAwIF0uY29uY2F0KGNoaWxkcykpOyBlbHNlIHRva2VuLnB1c2guYXBwbHkodG9rZW4sIGNoaWxkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJyZW1vdmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJhcHBlbmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZGQtcmVmIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIGNoaWxkQXR0cnMubmFtZSkgYWRkVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4pIHJlbW92ZVRva2VuUmVmKHRva2VuLCBjaGlsZEF0dHJzLm5hbWUgfHwgY2hpbGRBdHRycy5yZWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVua25vd24gaW5zdHJ1Y3Rpb24gdGFnIDxiOiIgKyBjaGlsZC5uYW1lICsgIj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgZGVjbC50b2tlbnMucHVzaC5hcHBseShkZWNsLnRva2VucywgcHJvY2VzcyhbIGNoaWxkIF0sIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIHJlbW92ZVRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sICJlbGVtZW50Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gaW5jbHVkZVN0YWNrLnNsaWNlKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSB8fCAwKS5jb25jYXQocmVzb3VyY2UpLm1hcChmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJlcyA9IHJlcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIEwxMG5Qcm94eVRva2VuKSByZXR1cm4gIntsMTBuOiIgKyByZXMudG9rZW4ubmFtZSArICJAIiArIHJlcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICJ9IjsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnVybCB8fCAiW2lubGluZSB0ZW1wbGF0ZV0iOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiUmVjdXJzaW9uOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiUmVjdXJzaW9uIGluIHRlbXBsYXRlICIgKyAodGVtcGxhdGUuc291cmNlVXJsIHx8ICJbaW5saW5lIHRlbXBsYXRlXSIpICsgIjogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMSwgYmluZGluZ3MsIHJlZnMsIG5hbWUodG9rZW4pIF07CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIGF0dHJzKHRva2VuLCBpdGVtLCBvcHRpb25zLm9wdGltaXplU2l6ZSkgfHwgW10pOwogICAgICAgICAgICAgIGl0ZW0ucHVzaC5hcHBseShpdGVtLCBwcm9jZXNzKHRva2VuLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgaWYgKHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMiAmJiBhcnJheVNlYXJjaChyZWZzLCAiZWxlbWVudCIpKSBiaW5kaW5ncyA9IHJlZnNbKyFyZWZzLmxhc3RTZWFyY2hJbmRleF07CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBhYnNsMTBuKGJpbmRpbmdzLCB0ZW1wbGF0ZS5kaWN0VVJJKTsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGwxMG5CaW5kaW5nLnNwbGl0KC9bOkBce10vKTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHMubGVuZ3RoID09IDMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0c1syXSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHJlZnMsIGJpbmRpbmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVmcy5sZW5ndGggPT0gMCkgcmVmcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSAwOwogICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gdG9rZW4udmFsdWUucmVwbGFjZSgvXH0kLywgIkB1bmRlZmluZWR9Iik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5JZCA9IHBhcnRzLnNsaWNlKDEpLmpvaW4oIkAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihsMTBuSWQpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVGVtcGxhdGUgPSBnZXRMMTBuVGVtcGxhdGUobDEwblRva2VuKTsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChsMTBuVGVtcGxhdGUgJiYgbDEwblRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1tpLS1dID0gdG9rZW5pemUoJzxiOmluY2x1ZGUgc3JjPSIjJyArIGwxMG5UZW1wbGF0ZS50ZW1wbGF0ZUlkICsgJyIvPicpWzBdOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGFycmF5QWRkKHRlbXBsYXRlLmwxMG4sIGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMywgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICAgIGlmIChvcHRpb25zLm9wdGltaXplU2l6ZSAmJiAhYmluZGluZ3MgJiYgIXJlZnMpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGl0ZW0gPSBbIDgsIGJpbmRpbmdzLCByZWZzIF07CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSkgaWYgKCFyZWZzIHx8IHRva2VuLnZhbHVlICE9ICJ7IiArIHJlZnMuam9pbigifCIpICsgIn0iKSBpdGVtLnB1c2godW50b2tlbih0b2tlbi52YWx1ZSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGl0ZW1baXRlbS5sZW5ndGggLSAxXSA9PT0gMCkgaXRlbS5wb3AoKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWJzbDEwbih2YWx1ZSwgZGljdFVSSSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gInN0cmluZyIpIHJldHVybiB2YWx1ZTsKICAgICAgICB2YXIgcGFydHMgPSB2YWx1ZS5zcGxpdCgiOiIpOwogICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMiAmJiBwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHNbMV0uaW5kZXhPZigiQCIpID09IC0xKSBwYXJ0c1sxXSA9IHBhcnRzWzFdICsgIkAiICsgZGljdFVSSTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbigiOiIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVJlZnModG9rZW5zLCBkaWN0VVJJLCBtYXAsIHN0SWR4KSB7CiAgICAgICAgaWYgKCFtYXApIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSBjb250aW51ZTsKICAgICAgICAgIHZhciByZWZzID0gdG9rZW5bVE9LRU5fUkVGU107CiAgICAgICAgICBpZiAocmVmcykgewogICAgICAgICAgICBmb3IgKHZhciBqID0gcmVmcy5sZW5ndGggLSAxLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tqXTsgai0tKSB7CiAgICAgICAgICAgICAgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hcFtyZWZOYW1lXSkgcmVtb3ZlVG9rZW5SZWYobWFwW3JlZk5hbWVdLnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdID09IHJlZk5hbWUpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGogKyAxOwogICAgICAgICAgICAgIG1hcFtyZWZOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0b2tlbnMsCiAgICAgICAgICAgICAgICB0b2tlbjogdG9rZW4KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICAgIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGFic2wxMG4odG9rZW5bVE9LRU5fQklORElOR1NdLCBkaWN0VVJJKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0FUVFJJQlVURToKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSB0b2tlbltUT0tFTl9CSU5ESU5HU11bMF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSBhcnJheVtqXSA9IGFic2wxMG4oYXJyYXlbal0sIGRpY3RVUkkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgbm9ybWFsaXplUmVmcyh0b2tlbiwgZGljdFVSSSwgbWFwLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhcHBseURlZmluZXModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgc3RJZHgpIHsKICAgICAgICB2YXIgdW5wcmVkaWN0YWJsZSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB1bnByZWRpY3RhYmxlICs9IGFwcGx5RGVmaW5lcyh0b2tlbiwgdGVtcGxhdGUsIG9wdGlvbnMsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0NMQVNTIHx8IHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUUgLSAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MpOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICB2YXIgbmV3QXR0clZhbHVlID0gKHRva2VuW3ZhbHVlSWR4XSB8fCAiIikudHJpbSgpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmQ7IGJpbmQgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYmluZC5sZW5ndGggPiAyKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRbMV0uc3BsaXQoIjoiKS5wb3AoKTsKICAgICAgICAgICAgICAgIHZhciBiaW5kRGVmID0gdGVtcGxhdGUuZGVmaW5lc1tiaW5kTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoYmluZERlZikgewogICAgICAgICAgICAgICAgICBiaW5kLnB1c2guYXBwbHkoYmluZCwgYmluZERlZik7CiAgICAgICAgICAgICAgICAgIGJpbmREZWYudXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmREZWYubGVuZ3RoID09IDEpIGFycmF5QWRkKG5ld0F0dHJWYWx1ZSwgYmluZFswXSArIGJpbmROYW1lKTsgZWxzZSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kRGVmWzFdW2JpbmREZWZbMF0gLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVucHJlZGljdGFibGUgdmFsdWUgYCIgKyBiaW5kTmFtZSArICJgIGluIGNsYXNzIGJpbmRpbmc6ICIgKyBiaW5kWzBdICsgInsiICsgYmluZFsxXSArICJ9Iik7CiAgICAgICAgICAgICAgICAgIHVucHJlZGljdGFibGUrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG9rZW5bdmFsdWVJZHhdID0gbmV3QXR0clZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5vcHRpbWl6ZVNpemUgJiYgIXRva2VuW3ZhbHVlSWR4XSkgdG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVucHJlZGljdGFibGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1ha2VEZWNsYXJhdGlvbihzb3VyY2UsIGJhc2VVUkksIG9wdGlvbnMsIHNvdXJjZVVybCkgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHZhciB3YXJucyA9IFtdOwogICAgICAgIHZhciBzb3VyY2VfOwogICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICBzb3VyY2VVcmw6IHNvdXJjZVVybCwKICAgICAgICAgIGJhc2VVUkk6IGJhc2VVUkkgfHwgIiIsCiAgICAgICAgICB0b2tlbnM6IG51bGwsCiAgICAgICAgICByZXNvdXJjZXM6IFtdLAogICAgICAgICAgZGVwczogW10sCiAgICAgICAgICBsMTBuOiBbXSwKICAgICAgICAgIGRlZmluZXM6IHt9LAogICAgICAgICAgdW5wcmVkaWN0YWJsZTogdHJ1ZSwKICAgICAgICAgIHdhcm5zOiB3YXJucwogICAgICAgIH07CiAgICAgICAgcmVzdWx0LmRpY3RVUkkgPSBzb3VyY2VVcmwgPyBiYXNpcy5wYXRoLnJlc29sdmUoc291cmNlVXJsKSA6IGJhc2VVUkkgfHwgIiI7CiAgICAgICAgaWYgKHJlc3VsdC5kaWN0VVJJKSB7CiAgICAgICAgICB2YXIgZXh0bmFtZSA9IGJhc2lzLnBhdGguZXh0bmFtZShyZXN1bHQuZGljdFVSSSk7CiAgICAgICAgICBpZiAoZXh0bmFtZSAmJiBleHRuYW1lICE9ICIubDEwbiIpIHJlc3VsdC5kaWN0VVJJID0gcmVzdWx0LmRpY3RVUkkuc3Vic3RyKDAsIHJlc3VsdC5kaWN0VVJJLmxlbmd0aCAtIGV4dG5hbWUubGVuZ3RoKSArICIubDEwbiI7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlLnRlbXBsYXRlVG9rZW5zKSB7CiAgICAgICAgICBzb3VyY2VfID0gc291cmNlOwogICAgICAgICAgc291cmNlID0gdG9rZW5pemUoU3RyaW5nKHNvdXJjZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc291cmNlLndhcm5zKSB3YXJucy5wdXNoLmFwcGx5KHdhcm5zLCBzb3VyY2Uud2FybnMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQudG9rZW5zID0gcHJvY2Vzcyhzb3VyY2UsIHJlc3VsdCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFyZXN1bHQudG9rZW5zKSByZXN1bHQudG9rZW5zID0gWyBbIDMsIDAsIDAsICIiIF0gXTsKICAgICAgICBpZiAoc291cmNlXykgcmVzdWx0LnRva2Vucy5zb3VyY2VfID0gc291cmNlXzsKICAgICAgICBhZGRUb2tlblJlZihyZXN1bHQudG9rZW5zWzBdLCAiZWxlbWVudCIpOwogICAgICAgIG5vcm1hbGl6ZVJlZnMocmVzdWx0LnRva2VucywgcmVzdWx0LmRpY3RVUkkpOwogICAgICAgIHJlc3VsdC51bnByZWRpY3RhYmxlID0gISFhcHBseURlZmluZXMocmVzdWx0LnRva2VucywgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcmVzdWx0LmRlZmluZXMpIGlmICghcmVzdWx0LmRlZmluZXNba2V5XS51c2VkKSB3YXJucy5wdXNoKCJVbnVzZWQgZGVmaW5lIGZvciAiICsga2V5KTsKICAgICAgICBkZWxldGUgcmVzdWx0LmRlZmluZXM7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5sMTBuUmVzb2x2ZWQ7CiAgICAgICAgaWYgKCF3YXJucy5sZW5ndGgpIHJlc3VsdC53YXJucyA9IGZhbHNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgdXNhYmxlUmVzb3VyY2VzID0gewogICAgICAiLmNzcyI6IHRydWUKICAgIH07CiAgICBmdW5jdGlvbiBzdGFydFVzZVJlc291cmNlKHVyaSkgewogICAgICBpZiAodXNhYmxlUmVzb3VyY2VzW3BhdGguZXh0bmFtZSh1cmkpXSkgYmFzaXMucmVzb3VyY2UodXJpKSgpLnN0YXJ0VXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wVXNlUmVzb3VyY2UodXJpKSB7CiAgICAgIGlmICh1c2FibGVSZXNvdXJjZXNbcGF0aC5leHRuYW1lKHVyaSldKSBiYXNpcy5yZXNvdXJjZSh1cmkpKCkuc3RvcFVzZSgpOwogICAgfQogICAgZnVuY3Rpb24gdGVtcGxhdGVTb3VyY2VVcGRhdGUoKSB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRhY2g7IGF0dGFjaCA9IHRoaXMuYXR0YWNoZXNfW2ldOyBpKyspIGF0dGFjaC5oYW5kbGVyLmNhbGwoYXR0YWNoLmNvbnRleHQpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWNsKGFycmF5KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgaWYgKGFycmF5LnNvdXJjZV8pIHJlc3VsdC5zb3VyY2VfID0gYXJyYXkuc291cmNlXzsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgcmVzdWx0LnB1c2goQXJyYXkuaXNBcnJheShhcnJheVtpXSkgPyBjbG9uZURlY2woYXJyYXlbaV0pIDogYXJyYXlbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVjbEZyb21Tb3VyY2Uoc291cmNlLCBiYXNlVVJJLCBjbG9uZSwgb3B0aW9ucykgewogICAgICB2YXIgcmVzdWx0ID0gc291cmNlOwogICAgICB2YXIgc291cmNlVXJsOwogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQoKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIHsKICAgICAgICBiYXNlVVJJID0gImJhc2VVUkkiIGluIHNvdXJjZSA/IHNvdXJjZS5iYXNlVVJJIDogYmFzZVVSSTsKICAgICAgICBzb3VyY2VVcmwgPSAidXJsIiBpbiBzb3VyY2UgPyBzb3VyY2UudXJsIDogc291cmNlVXJsOwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5nZXQoKTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgICAgaWYgKGNsb25lKSByZXN1bHQgPSBjbG9uZURlY2wocmVzdWx0KTsKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICB0b2tlbnM6IHJlc3VsdAogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gIm9iamVjdCIgfHwgIUFycmF5LmlzQXJyYXkocmVzdWx0LnRva2VucykpIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJzdHJpbmciKSByZXN1bHQgPSBtYWtlRGVjbGFyYXRpb24ocmVzdWx0LCBiYXNlVVJJLCBvcHRpb25zLCBzb3VyY2VVcmwpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gbDEwbkhhbmRsZXIodmFsdWUpIHsKICAgICAgaWYgKHRoaXMudHlwZSAhPSAibWFya3VwIiAmJiB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcy50ZW1wbGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGJ1aWxkVGVtcGxhdGUoKSB7CiAgICAgIHZhciBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UodGhpcy5zb3VyY2UsIHRoaXMuYmFzZVVSSSk7CiAgICAgIHZhciBkZXN0cm95QnVpbGRlciA9IHRoaXMuZGVzdHJveUJ1aWxkZXI7CiAgICAgIHZhciBmdW5jcyA9IHRoaXMuYnVpbGRlcihkZWNsLnRva2VucywgdGhpcyk7CiAgICAgIHZhciBkZXBzID0gdGhpcy5kZXBzXzsKICAgICAgdmFyIGwxMG4gPSB0aGlzLmwxMG5fOwogICAgICBpZiAoZGVwcykgewogICAgICAgIHRoaXMuZGVwc18gPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZXA7IGRlcCA9IGRlcHNbaV07IGkrKykgZGVwLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKGRlcCwgYnVpbGRUZW1wbGF0ZSwgdGhpcyk7CiAgICAgIH0KICAgICAgaWYgKGwxMG4pIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gbDEwbltpXTsgaSsrKSBpdGVtLnRva2VuLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKGl0ZW0udG9rZW4sIGwxMG5IYW5kbGVyLCBpdGVtKTsKICAgICAgaWYgKGRlY2wuZGVwcyAmJiBkZWNsLmRlcHMubGVuZ3RoKSB7CiAgICAgICAgZGVwcyA9IGRlY2wuZGVwczsKICAgICAgICB0aGlzLmRlcHNfID0gZGVwczsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGVwOyBkZXAgPSBkZXBzW2ldOyBpKyspIGRlcC5iaW5kaW5nQnJpZGdlLmF0dGFjaChkZXAsIGJ1aWxkVGVtcGxhdGUsIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChkZWNsLmwxMG4pIHsKICAgICAgICBsMTBuID0gZGVjbC5sMTBuOwogICAgICAgIHRoaXMubDEwbl8gPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBsMTBuW2ldOyBpKyspIHsKICAgICAgICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKGtleSk7CiAgICAgICAgICBsMTBuVG9rZW4uYmluZGluZ0JyaWRnZS5hdHRhY2gobDEwblRva2VuLCBsMTBuSGFuZGxlciwgdGhpcy5sMTBuX1trZXldID0gewogICAgICAgICAgICB0ZW1wbGF0ZTogdGhpcywKICAgICAgICAgICAgdG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICAgICAgdHlwZTogbDEwblRva2VuLnR5cGUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gZnVuY3MuY3JlYXRlSW5zdGFuY2U7CiAgICAgIHRoaXMuY2xlYXJJbnN0YW5jZSA9IGZ1bmNzLmRlc3Ryb3lJbnN0YW5jZTsKICAgICAgdGhpcy5nZXRCaW5kaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5hbWVzOiBmdW5jcy5rZXlzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgdGhpcy5kZXN0cm95QnVpbGRlciA9IGZ1bmNzLmRlc3Ryb3k7CiAgICAgIHRoaXMuaW5zdGFuY2VzXyA9IGZ1bmNzLmluc3RhbmNlc187CiAgICAgIHRoaXMuZGVjbF8gPSBkZWNsOwogICAgICB2YXIgZGVjbFJlc291cmNlcyA9IGRlY2wucmVzb3VyY2VzICYmIGRlY2wucmVzb3VyY2VzLmxlbmd0aCA+IDAgPyBkZWNsLnJlc291cmNlcyA6IG51bGw7CiAgICAgIGlmIChkZWNsUmVzb3VyY2VzKSBmb3IgKHZhciBpID0gMCwgcmVzOyByZXMgPSBkZWNsUmVzb3VyY2VzW2ldOyBpKyspIHN0YXJ0VXNlUmVzb3VyY2UocmVzKTsKICAgICAgaWYgKHRoaXMucmVzb3VyY2VzKSBmb3IgKHZhciBpID0gMCwgcmVzOyByZXMgPSB0aGlzLnJlc291cmNlc1tpXTsgaSsrKSBzdG9wVXNlUmVzb3VyY2UocmVzKTsKICAgICAgdGhpcy5yZXNvdXJjZXMgPSBkZWNsUmVzb3VyY2VzOwogICAgICBpZiAoZGVzdHJveUJ1aWxkZXIpIGRlc3Ryb3lCdWlsZGVyKHRydWUpOwogICAgfQogICAgZnVuY3Rpb24gc291cmNlQnlJZChzb3VyY2VJZCkgewogICAgICB2YXIgaG9zdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNvdXJjZUlkKTsKICAgICAgaWYgKGhvc3QgJiYgaG9zdC50YWdOYW1lID09ICJTQ1JJUFQiKSB7CiAgICAgICAgaWYgKGhvc3QudHlwZSA9PSAidGV4dC9iYXNpcy10ZW1wbGF0ZSIpIHJldHVybiBob3N0LnRleHRDb250ZW50IHx8IGhvc3QudGV4dDsKICAgICAgICBiYXNpcy5kZXYud2FybigiVGVtcGxhdGUgc2NyaXB0IGVsZW1lbnQgd2l0aCB3cm9uZyB0eXBlIiwgaG9zdC50eXBlKTsKICAgICAgICByZXR1cm4gIiI7CiAgICAgIH0KICAgICAgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHNjcmlwdCBlbGVtZW50IHdpdGggaWQgYCIgKyBzb3VyY2VJZCArICJgIG5vdCBmb3VuZCIpOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlU291cmNlQnlJZChzb3VyY2VJZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNvdXJjZUJ5SWQoc291cmNlSWQpOwogICAgICB9OwogICAgfQogICAgdmFyIFRlbXBsYXRlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZTogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBpZiAodGVtcGxhdGVMaXN0Lmxlbmd0aCA9PSA0MDk2KSB0aHJvdyAiVG9vIG1hbnkgdGVtcGxhdGVzIChtYXhpbXVtIDQwOTYpIjsKICAgICAgICB0aGlzLmF0dGFjaGVzXyA9IFtdOwogICAgICAgIHRoaXMuc2V0U291cmNlKHNvdXJjZSB8fCAiIik7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUlkID0gdGVtcGxhdGVMaXN0LnB1c2godGhpcykgLSAxOwogICAgICB9LAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgcmV0dXJuOwogICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnB1c2goewogICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24odGVtcGxhdGUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaXN0ZW5lcjsgbGlzdGVuZXIgPSB0ZW1wbGF0ZS5hdHRhY2hlc19baV07IGkrKykgaWYgKGxpc3RlbmVyLmhhbmRsZXIgPT0gaGFuZGxlciAmJiBsaXN0ZW5lci5jb250ZXh0ID09IGNvbnRleHQpIHsKICAgICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHt9CiAgICAgIH0sCiAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5zdGFuY2Uob2JqZWN0LCBhY3Rpb25DYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkge30sCiAgICAgIGdldEJpbmRpbmc6IGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLmdldEJpbmRpbmcoYmluZGluZ3MpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAob2xkU291cmNlICE9IHNvdXJjZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIG0gPSBzb3VyY2UubWF0Y2goL14oW2Etel0rKTovKTsKICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2Uuc3Vic3RyKG1bMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHByZWZpeCkgewogICAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlU291cmNlQnlJZChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInRva2VucyI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnN0cmluZy50b09iamVjdChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBzb3VyY2UuaXNEZWNsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyYXciOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInBhdGgiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgoc291cmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLlRlbXBsYXRlLnNldFNvdXJjZTogVW5rbm93biBwcmVmaXggIiArIHByZWZpeCArICIgZm9yIHRlbXBsYXRlIHNvdXJjZSB3YXMgaW5nbm9yZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU291cmNlICYmIG9sZFNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIHZhciB0bXBsTGlzdCA9IG9sZFNvdXJjZS51cmwgJiYgdG1wbEZpbGVzTWFwW29sZFNvdXJjZS51cmxdOwogICAgICAgICAgICBpZiAodG1wbExpc3QpIHsKICAgICAgICAgICAgICBhcnJheVJlbW92ZSh0bXBsTGlzdCwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0bXBsTGlzdC5sZW5ndGgpIGRlbGV0ZSB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gIiI7CiAgICAgICAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZFNvdXJjZSwgdGVtcGxhdGVTb3VyY2VVcGRhdGUsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgICBpZiAoc291cmNlLnVybCkgewogICAgICAgICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGguZGlybmFtZShzb3VyY2UudXJsKSArICIvIjsKICAgICAgICAgICAgICBpZiAoIXRtcGxGaWxlc01hcFtzb3VyY2UudXJsXSkgdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdID0gW107CiAgICAgICAgICAgICAgYXJyYXlBZGQodG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UuYmluZGluZ0JyaWRnZS5hdHRhY2goc291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIHRlbXBsYXRlU291cmNlVXBkYXRlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgdGhpcy5kZXN0cm95QnVpbGRlcigpOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB0aGlzLmdldEJpbmRpbmcgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnN0YW5jZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmRlY2xfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCBjb25maWcpOwogICAgfTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHJ1bGVSZXRfOiBudWxsLAogICAgICB0ZW1wbGF0ZXNfOiBudWxsLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBUZW1wbGF0ZSwKICAgICAgcnVsZUV2ZW50czogbnVsbCwKICAgICAgcnVsZTogU3RyaW5nLAogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICB0aGlzLnJ1bGVSZXRfID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZXNfID0gW107CiAgICAgICAgdGhpcy5ydWxlID0gY29uZmlnLnJ1bGU7CiAgICAgICAgdmFyIGV2ZW50cyA9IGNvbmZpZy5ldmVudHM7CiAgICAgICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnJ1bGVFdmVudHMgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSB0aGlzLnJ1bGVFdmVudHNbZXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGNsZWFuZXIuYWRkKHRoaXMpOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB2YXIgcmV0ID0gdGhpcy5ydWxlKG9iamVjdCk7CiAgICAgICAgdmFyIGlkeCA9IHRoaXMucnVsZVJldF8uaW5kZXhPZihyZXQpOwogICAgICAgIGlmIChpZHggPT0gLTEpIHsKICAgICAgICAgIHRoaXMucnVsZVJldF8ucHVzaChyZXQpOwogICAgICAgICAgaWR4ID0gdGhpcy50ZW1wbGF0ZXNfLnB1c2gobmV3IHRoaXMudGVtcGxhdGVDbGFzcyhyZXQpKSAtIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc19baWR4XTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5ydWxlID0gbnVsbDsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBudWxsOwogICAgICAgIHRoaXMucnVsZVJldF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHN3aXRjaGVyKGV2ZW50cywgcnVsZSkgewogICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgIHZhciBydWxlID0gYXJncy5wb3AoKTsKICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaENvbmZpZyh7CiAgICAgICAgcnVsZTogcnVsZSwKICAgICAgICBldmVudHM6IGFyZ3Muam9pbigiICIpLnRyaW0oKS5zcGxpdCgvXHMrLykKICAgICAgfSk7CiAgICB9CiAgICB2YXIgVGhlbWUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UaGVtZSIsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoCiAgICB9KTsKICAgIHZhciBTb3VyY2VXcmFwcGVyID0gQ2xhc3MoYmFzaXMuVG9rZW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlNvdXJjZVdyYXBwZXIiLAogICAgICBwYXRoOiAiIiwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlLCBwYXRoKSB7CiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsICIiKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UgPyB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZ2V0KHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudCA9IGdldFRoZW1lU291cmNlKGN1cnJlbnRUaGVtZU5hbWUsIHRoaXMucGF0aCk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT0gY29udGVudCkgewogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMudmFsdWUgPSBjb250ZW50OwogICAgICAgICAgdGhpcy51cmwgPSBjb250ZW50ICYmIGNvbnRlbnQudXJsIHx8ICIiOwogICAgICAgICAgdGhpcy5iYXNlVVJJID0gKHR5cGVvZiBjb250ZW50ID09ICJvYmplY3QiIHx8IHR5cGVvZiBjb250ZW50ID09ICJmdW5jdGlvbiIpICYmICJiYXNlVVJJIiBpbiBjb250ZW50ID8gY29udGVudC5iYXNlVVJJIDogcGF0aC5kaXJuYW1lKHRoaXMudXJsKSArICIvIjsKICAgICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmF0dGFjaCh0aGlzLnZhbHVlLCBTb3VyY2VXcmFwcGVyLnByb3RvdHlwZS5hcHBseSwgdGhpcyk7CiAgICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVybCA9IG51bGw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gbnVsbDsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgdGhpcy5hcHBseSwgdGhpcyk7CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBnZXRTb3VyY2VCeVBhdGgoKSB7CiAgICAgIHZhciBwYXRoID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5qb2luKCIuIik7CiAgICAgIHZhciBzb3VyY2UgPSBzb3VyY2VCeVBhdGhbcGF0aF07CiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgc291cmNlID0gbmV3IFNvdXJjZVdyYXBwZXIoIiIsIHBhdGgpOwogICAgICAgIHNvdXJjZUJ5UGF0aFtwYXRoXSA9IHNvdXJjZTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgZnVuY3Rpb24gbm9ybWFsaXplKGxpc3QpIHsKICAgICAgdmFyIHVzZWQgPSB7fTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGlmICghdXNlZFtsaXN0W2ldXSkgewogICAgICAgIHVzZWRbbGlzdFtpXV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKGxpc3RbaV0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRGYWxsYmFjayh0aGVtZU5hbWUsIGxpc3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICByZXN1bHQuc291cmNlID0gbm9ybWFsaXplKGxpc3QpLmpvaW4oIi8iKTsKICAgICAgdmFyIHVzZWQgPSB7CiAgICAgICAgYmFzZTogdHJ1ZQogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbmFtZSA9IGxpc3RbaV0gfHwgImJhc2UiOwogICAgICAgIGlmIChuYW1lID09IHRoZW1lTmFtZSB8fCB1c2VkW25hbWVdKSBjb250aW51ZTsKICAgICAgICB2YXIgdGhlbWUgPSBnZXRUaGVtZShuYW1lKTsKICAgICAgICB1c2VkW25hbWVdID0gdHJ1ZTsKICAgICAgICByZXN1bHQucHVzaChuYW1lKTsKICAgICAgICBsaXN0LnNwbGljZS5hcHBseShsaXN0LCBbIGkgKyAxLCAwIF0uY29uY2F0KHRoZW1lc1tuYW1lXS5mYWxsYmFjaykpOwogICAgICB9CiAgICAgIHJlc3VsdC51bnNoaWZ0KHRoZW1lTmFtZSk7CiAgICAgIGlmICh0aGVtZU5hbWUgIT0gImJhc2UiKSByZXN1bHQucHVzaCgiYmFzZSIpOwogICAgICByZXN1bHQudmFsdWUgPSByZXN1bHQuam9pbigiLyIpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgewogICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1tuYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIG1hcDsgbWFwID0gc291cmNlTGlzdFtpXTsgaSsrKSBpZiAobWFwLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gbWFwW3BhdGhdOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiB0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpIHsKICAgICAgcmV0dXJuIHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjay5pbmRleE9mKHRoZW1lTmFtZSkgIT0gLTE7CiAgICB9CiAgICBmdW5jdGlvbiBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKSB7CiAgICAgIGdldFNvdXJjZUJ5UGF0aChwYXRoKS5zZXQoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWUoY2hhbmdlZCkgewogICAgICBiYXNpcy5kZXYubG9nKCJyZS1hcHBseSB0ZW1wbGF0ZXMiKTsKICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWUobmFtZSkgewogICAgICBpZiAoIW5hbWUpIG5hbWUgPSAiYmFzZSI7CiAgICAgIGlmICh0aGVtZXNbbmFtZV0pIHJldHVybiB0aGVtZXNbbmFtZV0udGhlbWU7CiAgICAgIGlmICghL14oW2EtejAtOVxfXC1dKykkLy50ZXN0KG5hbWUpKSB0aHJvdyAiQmFkIG5hbWUgZm9yIHRoZW1lIC0gIiArIG5hbWU7CiAgICAgIHZhciBzb3VyY2VzID0ge307CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gWyBzb3VyY2VzIF07CiAgICAgIHZhciB0aGVtZUludGVyZmFjZSA9IG5ldyBUaGVtZTsKICAgICAgdGhlbWVzW25hbWVdID0gewogICAgICAgIHRoZW1lOiB0aGVtZUludGVyZmFjZSwKICAgICAgICBzb3VyY2VzOiBzb3VyY2VzLAogICAgICAgIHNvdXJjZXNMaXN0OiBzb3VyY2VMaXN0LAogICAgICAgIGZhbGxiYWNrOiBbXQogICAgICB9OwogICAgICB2YXIgYWRkU291cmNlID0gZnVuY3Rpb24ocGF0aCwgc291cmNlKSB7CiAgICAgICAgaWYgKHBhdGggaW4gc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgc291cmNlc1twYXRoXSA9IHNvdXJjZTsKICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgfSBlbHNlIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBwYXRoIGAiICsgcGF0aCArICJgIGlzIGFscmVhZHkgZGVmaW5lZCBmb3IgdGhlbWUgYCIgKyBuYW1lICsgImAgKGRlZmluaXRpb24gaWdub3JlZCkuIik7CiAgICAgICAgcmV0dXJuIGdldFNvdXJjZUJ5UGF0aChwYXRoKTsKICAgICAgfTsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGVtZUludGVyZmFjZSwgewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgZmFsbGJhY2s6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhlbWVJbnRlcmZhY2UgIT09IGJhc2VUaGVtZSAmJiBhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV3RmFsbGJhY2sgPSB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiLyIpIDogW107CiAgICAgICAgICAgIHZhciBjaGFuZ2VkID0ge307CiAgICAgICAgICAgIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgbmV3RmFsbGJhY2spOwogICAgICAgICAgICBpZiAodGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZSAhPSBuZXdGYWxsYmFjay5zb3VyY2UpIHsKICAgICAgICAgICAgICB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlID0gbmV3RmFsbGJhY2suc291cmNlOwogICAgICAgICAgICAgIGJhc2lzLmRldi5sb2coImZhbGxiYWNrIGNoYW5nZWQiKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gdGhlbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyRmFsbGJhY2sgPSB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgKGN1ckZhbGxiYWNrLnNvdXJjZSB8fCAiIikuc3BsaXQoIi8iKSk7CiAgICAgICAgICAgICAgICBpZiAobmV3RmFsbGJhY2sudmFsdWUgIT0gY3VyRmFsbGJhY2sudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY2hhbmdlZFt0aGVtZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbWVzW3RoZW1lTmFtZV0uZmFsbGJhY2sgPSBuZXdGYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZUxpc3QgPSB0aGVtZXNbdGhlbWVOYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgICAgICAgICAgICAgc291cmNlTGlzdC5sZW5ndGggPSBuZXdGYWxsYmFjay5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlTGlzdC5sZW5ndGg7IGkrKykgc291cmNlTGlzdFtpXSA9IHRoZW1lc1tuZXdGYWxsYmFja1tpXV0uc291cmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFjayA9IHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgZm9yICh2YXIgdGhlbWVOYW1lIGluIGNoYW5nZWQpIHsKICAgICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QodGhlbWVOYW1lKSkgewogICAgICAgICAgICAgICAgc3luY0N1cnJlbnRUaGVtZSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNsaWNlKDEpOwogICAgICAgICAgcmVzdWx0LnNvdXJjZSA9IHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgZGVmaW5lOiBmdW5jdGlvbih3aGF0LCB3aGVyZXdpdGgpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAiZnVuY3Rpb24iKSB3aGF0ID0gd2hhdCgpOwogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hlcmV3aXRoID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHdoYXQ7CiAgICAgICAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSB3aGVyZXdpdGg7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXN1bHRba2V5XSA9IGFkZFNvdXJjZShuYW1lc3BhY2UgKyAiLiIgKyBrZXksIGRpY3Rpb25hcnlba2V5XSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHdoYXQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWRkU291cmNlKHdoYXQsIHdoZXJld2l0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoYXQ7CiAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgYWRkU291cmNlKHBhdGgsIGRpY3Rpb25hcnlbcGF0aF0pOwogICAgICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZmlyc3QgYXJndW1lbnQgZm9yIGJhc2lzLnRlbXBsYXRlLlRoZW1lI2RlZmluZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobmFtZSAhPSBjdXJyZW50VGhlbWVOYW1lKSB7CiAgICAgICAgICAgIGN1cnJlbnRUaGVtZU5hbWUgPSBuYW1lOwogICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBoYW5kbGVyOyBoYW5kbGVyID0gdGhlbWVDaGFuZ2VIYW5kbGVyc1tpXTsgaSsrKSBoYW5kbGVyLmZuLmNhbGwoaGFuZGxlci5jb250ZXh0LCBuYW1lKTsKICAgICAgICAgICAgYmFzaXMuZGV2LmluZm8oIlRlbXBsYXRlIHRoZW1lIHN3aXRjaGVkIHRvIGAiICsgbmFtZSArICJgIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICAgICAgfSwKICAgICAgICBnZXRTb3VyY2U6IGZ1bmN0aW9uKHBhdGgsIHdpdGhGYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHdpdGhGYWxsYmFjayA/IGdldFRoZW1lU291cmNlKG5hbWUsIHBhdGgpIDogc291cmNlc1twYXRoXTsKICAgICAgICB9LAogICAgICAgIGRyb3A6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgIGlmIChzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGgpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2VzW3BhdGhdOwogICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QobmFtZSkpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKG5hbWUsIFtdKTsKICAgICAgc291cmNlTGlzdC5wdXNoKHRoZW1lc1siYmFzZSJdLnNvdXJjZXMpOwogICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICB9CiAgICB2YXIgdGhlbWVzID0ge307CiAgICB2YXIgc291cmNlQnlQYXRoID0ge307CiAgICB2YXIgYmFzZVRoZW1lID0gZ2V0VGhlbWUoKTsKICAgIHZhciBjdXJyZW50VGhlbWVOYW1lID0gImJhc2UiOwogICAgdmFyIHRoZW1lQ2hhbmdlSGFuZGxlcnMgPSBbXTsKICAgIGZ1bmN0aW9uIG9uVGhlbWVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgdGhlbWVDaGFuZ2VIYW5kbGVycy5wdXNoKHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudFRoZW1lTmFtZSk7CiAgICB9CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIHBhdGggaW4gc291cmNlQnlQYXRoKSBzb3VyY2VCeVBhdGhbcGF0aF0uZGVzdHJveSgpOwogICAgICAgIHRoZW1lcyA9IG51bGw7CiAgICAgICAgc291cmNlQnlQYXRoID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdGVtcGxhdGU7IHRlbXBsYXRlID0gdGVtcGxhdGVMaXN0W2ldOyBpKyspIHRlbXBsYXRlLmRlc3Ryb3koKTsKICAgICAgICB0ZW1wbGF0ZUxpc3QgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUNMQVJBVElPTl9WRVJTSU9OOiBERUNMQVJBVElPTl9WRVJTSU9OLAogICAgICBUWVBFX0VMRU1FTlQ6IFRZUEVfRUxFTUVOVCwKICAgICAgVFlQRV9BVFRSSUJVVEU6IFRZUEVfQVRUUklCVVRFLAogICAgICBUWVBFX0FUVFJJQlVURV9DTEFTUzogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIFRZUEVfQVRUUklCVVRFX1NUWUxFOiBUWVBFX0FUVFJJQlVURV9TVFlMRSwKICAgICAgVFlQRV9BVFRSSUJVVEVfRVZFTlQ6IFRZUEVfQVRUUklCVVRFX0VWRU5ULAogICAgICBUWVBFX1RFWFQ6IFRZUEVfVEVYVCwKICAgICAgVFlQRV9DT01NRU5UOiBUWVBFX0NPTU1FTlQsCiAgICAgIFRPS0VOX1RZUEU6IFRPS0VOX1RZUEUsCiAgICAgIFRPS0VOX0JJTkRJTkdTOiBUT0tFTl9CSU5ESU5HUywKICAgICAgVE9LRU5fUkVGUzogVE9LRU5fUkVGUywKICAgICAgQVRUUl9OQU1FOiBBVFRSX05BTUUsCiAgICAgIEFUVFJfVkFMVUU6IEFUVFJfVkFMVUUsCiAgICAgIEFUVFJfTkFNRV9CWV9UWVBFOiBBVFRSX05BTUVfQllfVFlQRSwKICAgICAgRUxFTUVOVF9OQU1FOiBFTEVNRU5UX05BTUUsCiAgICAgIEVMRU1FTlRfQVRUUlM6IEVMRU1FTlRfQVRUUlMsCiAgICAgIEVMRU1FTlRfQ0hJTERTOiBFTEVNRU5UX0NISUxEUywKICAgICAgVEVYVF9WQUxVRTogVEVYVF9WQUxVRSwKICAgICAgQ09NTUVOVF9WQUxVRTogQ09NTUVOVF9WQUxVRSwKICAgICAgTDEwblByb3h5VG9rZW46IEwxMG5Qcm94eVRva2VuLAogICAgICBUZW1wbGF0ZVN3aXRjaENvbmZpZzogVGVtcGxhdGVTd2l0Y2hDb25maWcsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IFRlbXBsYXRlU3dpdGNoZXIsCiAgICAgIFRlbXBsYXRlOiBUZW1wbGF0ZSwKICAgICAgU291cmNlV3JhcHBlcjogU291cmNlV3JhcHBlciwKICAgICAgc3dpdGNoZXI6IHN3aXRjaGVyLAogICAgICB0b2tlbml6ZTogdG9rZW5pemUsCiAgICAgIGdldERlY2xGcm9tU291cmNlOiBnZXREZWNsRnJvbVNvdXJjZSwKICAgICAgbWFrZURlY2xhcmF0aW9uOiBtYWtlRGVjbGFyYXRpb24sCiAgICAgIGdldEwxMG5UZW1wbGF0ZTogZ2V0TDEwblRlbXBsYXRlLAogICAgICBUaGVtZTogVGhlbWUsCiAgICAgIHRoZW1lOiBnZXRUaGVtZSwKICAgICAgZ2V0VGhlbWVMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXModGhlbWVzKTsKICAgICAgfSwKICAgICAgY3VycmVudFRoZW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLnRoZW1lOwogICAgICB9LAogICAgICBzZXRUaGVtZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBnZXRUaGVtZShuYW1lKS5hcHBseSgpOwogICAgICB9LAogICAgICBvblRoZW1lQ2hhbmdlOiBvblRoZW1lQ2hhbmdlLAogICAgICBkZWZpbmU6IGJhc2VUaGVtZS5kZWZpbmUsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoLAogICAgICBnZXRQYXRoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLm9iamVjdC5rZXlzKHNvdXJjZUJ5UGF0aCk7CiAgICAgIH0KICAgIH07CiAgICBnZXRUaGVtZSgiYmFzZSIpLmRlZmluZSh7CiAgICAgICIjMSI6IGJhc2lzLnJlc291cmNlKCIuLzAudG1wbCIpLAogICAgICAiIzIiOiBiYXNpcy5yZXNvdXJjZSgiLi8xLnRtcGwiKSwKICAgICAgIiMzIjogYmFzaXMucmVzb3VyY2UoIi4vMi50bXBsIiksCiAgICAgICIjNCI6IGJhc2lzLnJlc291cmNlKCIuLzMudG1wbCIpLAogICAgICAiIzUiOiBiYXNpcy5yZXNvdXJjZSgiLi80LnRtcGwiKSwKICAgICAgIiM2IjogYmFzaXMucmVzb3VyY2UoIi4vNS50bXBsIiksCiAgICAgICIjNyI6IGJhc2lzLnJlc291cmNlKCIuLzYudG1wbCIpLAogICAgICAiIzgiOiBiYXNpcy5yZXNvdXJjZSgiLi83LnRtcGwiKSwKICAgICAgIiM5IjogYmFzaXMucmVzb3VyY2UoIi4vOC50bXBsIikKICAgIH0pOwogIH0sCiAgIjguanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vOS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzcuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBkb21FdmVudCA9IGJhc2lzLmRvbS5ldmVudDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIGNhbWVsaXplID0gYmFzaXMuc3RyaW5nLmNhbWVsaXplOwogICAgdmFyIGwxMG5Ub2tlbiA9IGJhc2lzLmwxMG4udG9rZW47CiAgICB2YXIgZ2V0RnVuY3Rpb25zID0gYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4uZ2V0RnVuY3Rpb25zOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoQ29uZmlnID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGVTd2l0Y2hDb25maWc7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hlciA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlU3dpdGNoZXI7CiAgICB2YXIgVGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX1ZBTFVFOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIFRFWFRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5URVhUX1ZBTFVFOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5DT01NRU5UX1ZBTFVFOwogICAgdmFyIGV2ZW50QXR0ciA9IC9eZXZlbnQtKC4rKSsvOwogICAgdmFyIHRtcGxFdmVudExpc3RlbmVycyA9IHt9OwogICAgdmFyIHRlbXBsYXRlcyA9IHt9OwogICAgdmFyIG5hbWVzcGFjZVVSSSA9IHsKICAgICAgc3ZnOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB9OwogICAgdmFyIGFmdGVyRXZlbnRBY3Rpb24gPSB7fTsKICAgIHZhciBpbnNpZGVFbGVtZW50RXZlbnQgPSB7fTsKICAgIHZhciBNT1VTRV9FTlRFUl9MRUFWRV9TVVBQT1JUID0gIm9ubW91c2VlbnRlciIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgdmFyIENBUFRVUkVfRkFMTEJBQ0sgPSAhZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAmJiAiX19iYXNpc1RlbXBsYXRlIiArIHBhcnNlSW50KDFlOSAqIE1hdGgucmFuZG9tKCkpOwogICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIGdsb2JhbFtDQVBUVVJFX0ZBTExCQUNLXSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZXZlbnQpIHsKICAgICAgZG9tRXZlbnQuZmlyZUV2ZW50KGRvY3VtZW50LCBldmVudE5hbWUpOwogICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgIHZhciBsaXN0ZW5lciA9IHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdOwogICAgICBpZiAobGlzdGVuZXIpIGxpc3RlbmVyKG5ldyBkb21FdmVudC5FdmVudChldmVudCkpOwogICAgfTsKICAgIHZhciBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoImEiKSk7CiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoImEiKSk7CiAgICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKS5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxOwogICAgfSgpOwogICAgdmFyIFNFVF9DTEFTU19BVFRSSUJVVEVfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJjbGFzcyIsICJhIik7CiAgICAgIHJldHVybiAhZWxlbWVudC5jbGFzc05hbWU7CiAgICB9KCk7CiAgICB2YXIgU0VUX1NUWUxFX0FUVFJJQlVURV9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgInBvc2l0aW9uOmFic29sdXRlIik7CiAgICAgIHJldHVybiBlbGVtZW50LnN0eWxlLnBvc2l0aW9uICE9ICJhYnNvbHV0ZSI7CiAgICB9KCk7CiAgICB2YXIgSVNfU0VUX1NUWUxFX1NBRkUgPSAhIWZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuY29sb3IgPSAieCI7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9KCk7CiAgICBpZiAodHlwZW9mIE5vZGUgIT0gInVuZGVmaW5lZCIgJiYgIU5vZGUucHJvdG90eXBlLmNvbnRhaW5zKSBOb2RlLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHJldHVybiAhISh0aGlzLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGNoaWxkKSAmIDE2KTsKICAgIH07CiAgICB2YXIgbDEwblRlbXBsYXRlcyA9IHt9OwogICAgZnVuY3Rpb24gZ2V0TDEwblRlbXBsYXRlKHRva2VuKSB7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IGJhc2lzLnRlbXBsYXRlLmdldEwxMG5UZW1wbGF0ZSh0b2tlbik7CiAgICAgIHZhciBpZCA9IHRlbXBsYXRlLnRlbXBsYXRlSWQ7CiAgICAgIHZhciBodG1sVGVtcGxhdGUgPSBsMTBuVGVtcGxhdGVzW2lkXTsKICAgICAgaWYgKCFodG1sVGVtcGxhdGUpIGh0bWxUZW1wbGF0ZSA9IGwxMG5UZW1wbGF0ZXNbaWRdID0gbmV3IEh0bWxUZW1wbGF0ZSh0ZW1wbGF0ZS5zb3VyY2UpOwogICAgICByZXR1cm4gaHRtbFRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGF0dHJOYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmIChldmVudC50eXBlID09ICJjbGljayIgJiYgZXZlbnQud2hpY2ggPT0gMykgcmV0dXJuOwogICAgICAgIHZhciBidWJibGUgPSBpbnNpZGVFbGVtZW50RXZlbnRbZXZlbnQudHlwZV0gfHwgZXZlbnQudHlwZSAhPSAibW91c2VlbnRlciIgJiYgZXZlbnQudHlwZSAhPSAibW91c2VsZWF2ZSI7CiAgICAgICAgdmFyIGF0dHJDdXJzb3IgPSBldmVudC5zZW5kZXI7CiAgICAgICAgdmFyIGF0dHI7CiAgICAgICAgd2hpbGUgKGF0dHJDdXJzb3IpIHsKICAgICAgICAgIGF0dHIgPSBhdHRyQ3Vyc29yLmdldEF0dHJpYnV0ZSAmJiBhdHRyQ3Vyc29yLmdldEF0dHJpYnV0ZShhdHRyTmFtZSk7CiAgICAgICAgICBpZiAoIWJ1YmJsZSB8fCB0eXBlb2YgYXR0ciA9PSAic3RyaW5nIikgYnJlYWs7CiAgICAgICAgICBhdHRyQ3Vyc29yID0gYXR0ckN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGF0dHIgPT0gInN0cmluZyIpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSBhdHRyQ3Vyc29yOwogICAgICAgICAgdmFyIGFjdGlvblRhcmdldCA9IGN1cnNvcjsKICAgICAgICAgIHZhciByZWZJZDsKICAgICAgICAgIHZhciB0bXBsUmVmOwogICAgICAgICAgaWYgKGluc2lkZUVsZW1lbnRFdmVudFtldmVudC50eXBlXSkgewogICAgICAgICAgICB2YXIgcmVsVGFyZ2V0ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgaWYgKHJlbFRhcmdldCAmJiAoY3Vyc29yID09PSByZWxUYXJnZXQgfHwgY3Vyc29yLmNvbnRhaW5zKHJlbFRhcmdldCkpKSBjdXJzb3IgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgICByZWZJZCA9IGN1cnNvci5iYXNpc1RlbXBsYXRlSWQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmSWQgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodG1wbFJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bXBsUmVmICYmIHRtcGxSZWYuYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gYXR0ci50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICBldmVudC5hY3Rpb25UYXJnZXQgPSBhY3Rpb25UYXJnZXQ7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb25OYW1lOyBhY3Rpb25OYW1lID0gYWN0aW9uc1tpKytdOyApIHRtcGxSZWYuYWN0aW9uLmNhbGwodG1wbFJlZi5jb250ZXh0LCBhY3Rpb25OYW1lLCBldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudC50eXBlIGluIGFmdGVyRXZlbnRBY3Rpb24pIGFmdGVyRXZlbnRBY3Rpb25bZXZlbnQudHlwZV0oZXZlbnQsIGF0dHJDdXJzb3IpOwogICAgICB9OwogICAgfQogICAgdmFyIGJ1aWxkSHRtbCA9IGZ1bmN0aW9uKHRva2VucywgcGFyZW50KSB7CiAgICAgIGZ1bmN0aW9uIGVtdWxhdGVFdmVudChvcmlnRXZlbnROYW1lLCBlbXVsRXZlbnROYW1lKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGVtdWxFdmVudE5hbWUpOwogICAgICAgIGluc2lkZUVsZW1lbnRFdmVudFtvcmlnRXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgYWZ0ZXJFdmVudEFjdGlvbltlbXVsRXZlbnROYW1lXSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICBldmVudC50eXBlID0gb3JpZ0V2ZW50TmFtZTsKICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgfTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW29yaWdFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQsIGN1cnNvcikgewogICAgICAgICAgY3Vyc29yID0gY3Vyc29yICYmIGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKGN1cnNvcikgewogICAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgICBldmVudC5zZW5kZXIgPSBjdXJzb3I7CiAgICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKSB7CiAgICAgICAgaWYgKCF0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSkgewogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBjcmVhdGVFdmVudEhhbmRsZXIoImV2ZW50LSIgKyBldmVudE5hbWUpOwogICAgICAgICAgaWYgKCFDQVBUVVJFX0ZBTExCQUNLKSB7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlZW50ZXIiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3ZlciIpOwogICAgICAgICAgICBpZiAoIU1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgJiYgZXZlbnROYW1lID09ICJtb3VzZWxlYXZlIikgcmV0dXJuIGVtdWxhdGVFdmVudChldmVudE5hbWUsICJtb3VzZW91dCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmFtZXMgPSBkb21FdmVudC5icm93c2VyRXZlbnRzKGV2ZW50TmFtZSksIGJyb3dzZXJFdmVudE5hbWU7IGJyb3dzZXJFdmVudE5hbWUgPSBuYW1lc1tpXTsgaSsrKSBkb21FdmVudC5hZGRHbG9iYWxIYW5kbGVyKGJyb3dzZXJFdmVudE5hbWUsIHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhY3Rpb25zKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSk7CiAgICAgICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIHJlc3VsdC5zZXRBdHRyaWJ1dGUoIm9uIiArIGV2ZW50TmFtZSwgQ0FQVFVSRV9GQUxMQkFDSyArICcoIicgKyBldmVudE5hbWUgKyAnIixldmVudCknKTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKCJldmVudC0iICsgZXZlbnROYW1lLCBhY3Rpb25zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAoU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAiY2xhc3MiKSBuYW1lID0gImNsYXNzTmFtZSI7CiAgICAgICAgaWYgKFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHICYmIG5hbWUgPT0gInN0eWxlIikgcmV0dXJuIHJlc3VsdC5zdHlsZS5jc3NUZXh0ID0gdmFsdWU7CiAgICAgICAgcmVzdWx0LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHBhcmVudCB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGZvciAodmFyIGkgPSBwYXJlbnQgPyA0IDogMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgdmFyIHRhZ05hbWUgPSB0b2tlbltFTEVNRU5UX05BTUVdOwogICAgICAgICAgICB2YXIgcGFydHMgPSB0YWdOYW1lLnNwbGl0KC86Lyk7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gcGFydHMubGVuZ3RoID4gMSA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUklbcGFydHNbMF1dLCB0YWdOYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgICAgICAgICAgIGJ1aWxkSHRtbCh0b2tlbiwgZWxlbWVudCk7CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gdG9rZW5bQVRUUl9WQUxVRV07CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBhdHRyTmFtZS5yZXBsYWNlKC9eZXZlbnQtLywgIiIpOwogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9IGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhdHRyTmFtZSAhPSAiY2xhc3MiICYmIGF0dHJOYW1lICE9ICJzdHlsZSIgPyAhdG9rZW5bVE9LRU5fQklORElOR1NdIDogYXR0clZhbHVlKSBzZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFIC0gMV07CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0sIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZSh0b2tlblsxXSwgdG9rZW5bMl0gfHwgdG9rZW5bMV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0b2tlbltDT01NRU5UX1ZBTFVFXSB8fCAodG9rZW5bVE9LRU5fUkVGU10gPyAieyIgKyB0b2tlbltUT0tFTl9SRUZTXS5qb2luKCJ8IikgKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgaWYgKENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgJiYgaSAmJiB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpKTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRva2VuW1RFWFRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSB8fCAodG9rZW5bVE9LRU5fQklORElOR1NdID8gInsiICsgdG9rZW5bVE9LRU5fQklORElOR1NdICsgIn0iIDogIiIpKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXBhcmVudCAmJiB0b2tlbnMubGVuZ3RoID09IDEpIHJlc3VsdCA9IHJlc3VsdC5maXJzdENoaWxkOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZUJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlSWQgPSByZWZJZCAmIDQwOTU7CiAgICAgIHZhciBvYmplY3QgPSB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0LnRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIGluc3RhbmNlSWQgPSByZWZJZCA+PiAxMjsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QuaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZU9iamVjdEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5jb250ZXh0OwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZVRtcGxCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZVJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpOwogICAgICByZXR1cm4gdGVtcGxhdGVSZWYgJiYgdGVtcGxhdGVSZWYudG1wbDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlYnVnSW5mb0J5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZyAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZygpOwogICAgfQogICAgdmFyIGJ1aWxkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIFdISVRFU1BBQ0UgPSAvXHMrLzsKICAgICAgdmFyIFczQ19ET01fTk9ERV9TVVBQT1JURUQgPSB0eXBlb2YgTm9kZSA9PSAiZnVuY3Rpb24iICYmIGRvY3VtZW50IGluc3RhbmNlb2YgTm9kZTsKICAgICAgdmFyIENMQVNTTElTVF9TVVBQT1JURUQgPSBnbG9iYWwuRE9NVG9rZW5MaXN0ICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QgaW5zdGFuY2VvZiBnbG9iYWwuRE9NVG9rZW5MaXN0OwogICAgICB2YXIgYmluZF9ub2RlID0gVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgTm9kZSA/IG5ld1ZhbHVlIDogZG9tUmVmOwogICAgICAgIGlmIChuZXdOb2RlICE9PSBvbGROb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJvYmplY3QiID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG5ld05vZGUgPSBkb21SZWY7CiAgICAgICAgICAgIGlmIChvbGROb2RlICE9PSBuZXdOb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfZWxlbWVudCA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmICYmIHR5cGVvZiBuZXdWYWx1ZSA9PSAic3RyaW5nIikgZG9tUmVmLmlubmVySFRNTCA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9jb21tZW50ID0gYmluZF9ub2RlOwogICAgICB2YXIgYmluZF90ZXh0Tm9kZSA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmKSBkb21SZWYubm9kZVZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJDbGFzcyA9IENMQVNTTElTVF9TVVBQT1JURUQgPyBmdW5jdGlvbihkb21SZWYsIG9sZENsYXNzLCBuZXdWYWx1ZSwgcHJlZml4LCBhbmltKSB7CiAgICAgICAgdmFyIG5ld0NsYXNzID0gbmV3VmFsdWUgPyBwcmVmaXggKyBuZXdWYWx1ZSA6ICIiOwogICAgICAgIGlmIChuZXdDbGFzcyAhPSBvbGRDbGFzcykgewogICAgICAgICAgaWYgKG9sZENsYXNzKSBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QuYWRkKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gZG9tUmVmLmNsYXNzTmFtZTsKICAgICAgICAgIHZhciBjbGFzc05hbWVJc09iamVjdCA9IHR5cGVvZiBjbGFzc05hbWUgIT0gInN0cmluZyI7CiAgICAgICAgICB2YXIgY2xhc3NMaXN0OwogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBjbGFzc05hbWUgPSBjbGFzc05hbWUuYmFzZVZhbDsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTmFtZS5zcGxpdChXSElURVNQQUNFKTsKICAgICAgICAgIGlmIChvbGRDbGFzcykgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgb2xkQ2xhc3MpOwogICAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICAgIGNsYXNzTGlzdC5wdXNoKG5ld0NsYXNzKTsKICAgICAgICAgICAgaWYgKGFuaW0pIHsKICAgICAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNsYXNzTGlzdCA9IChjbGFzc05hbWVJc09iamVjdCA/IGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA6IGRvbVJlZi5jbGFzc05hbWUpLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgICAgICAgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgbmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICAgIGlmIChjbGFzc05hbWVJc09iamVjdCkgZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsgZWxzZSBkb21SZWYuY2xhc3NOYW1lID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJTdHlsZSA9IElTX1NFVF9TVFlMRV9TQUZFID8gZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgcHJvcGVydHlOYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkb21SZWYuc3R5bGVbY2FtZWxpemUocHJvcGVydHlOYW1lKV0gPSBuZXdWYWx1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ciA9IGZ1bmN0aW9uKGRvbVJlZiwgYXR0ck5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIGlmIChuZXdWYWx1ZSkgZG9tUmVmLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpOyBlbHNlIGRvbVJlZi5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3VmFsdWU7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF0dGFjaCgpIHsKICAgICAgICB0aGlzLnNldCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlc29sdmVWYWx1ZShiaW5kaW5nTmFtZSwgdmFsdWUsIEF0dGFjaGVzKSB7CiAgICAgICAgdmFyIGJyaWRnZSA9IHZhbHVlICYmIHZhbHVlLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgdmFyIG9sZEF0dGFjaCA9IHRoaXMuYXR0YWNoZXMgJiYgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV07CiAgICAgICAgdmFyIHRtcGwgPSBudWxsOwogICAgICAgIGlmIChicmlkZ2UgfHwgb2xkQXR0YWNoKSB7CiAgICAgICAgICBpZiAoYnJpZGdlKSB7CiAgICAgICAgICAgIGlmICghb2xkQXR0YWNoIHx8IHZhbHVlICE9PSBvbGRBdHRhY2gudmFsdWUpIHsKICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoLnRtcGwpIHsKICAgICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PSAibWFya3VwIiAmJiB2YWx1ZSBpbnN0YW5jZW9mIGJhc2lzLmwxMG4uVG9rZW4pIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0ludGVyZmFjZSA9IHRoaXMuYmluZGluZ0ludGVyZmFjZTsKICAgICAgICAgICAgICAgIHRtcGwgPSB0ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZShjb250ZXh0LCBudWxsLCBmdW5jdGlvbiBvblJlYnVpbGQoKSB7CiAgICAgICAgICAgICAgICAgIHRtcGwgPSBuZXdBdHRhY2gudG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUF0dGFjaC5jYWxsKG5ld0F0dGFjaCk7CiAgICAgICAgICAgICAgICB9LCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmF0dGFjaGVzKSB0aGlzLmF0dGFjaGVzID0gbmV3IEF0dGFjaGVzOwogICAgICAgICAgICAgIHZhciBuZXdBdHRhY2ggPSB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGJpbmRpbmdOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgdG1wbDogdG1wbCwKICAgICAgICAgICAgICAgIHNldDogdGhpcy50bXBsLnNldAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYnJpZGdlLmF0dGFjaCh2YWx1ZSwgdXBkYXRlQXR0YWNoLCBuZXdBdHRhY2gpOwogICAgICAgICAgICB9IGVsc2UgdG1wbCA9IHZhbHVlICYmIHZhbHVlLnR5cGUgPT0gIm1hcmt1cCIgPyBvbGRBdHRhY2gudG1wbCA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bXBsKSByZXR1cm4gdG1wbC5lbGVtZW50OwogICAgICAgICAgICB2YWx1ZSA9IGJyaWRnZS5nZXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZEF0dGFjaCkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICBnZXRMMTBuVGVtcGxhdGUob2xkQXR0YWNoLnZhbHVlKS5jbGVhckluc3RhbmNlKG9sZEF0dGFjaC50bXBsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ1VwZGF0ZXIobmFtZXMsIGdldHRlcnMpIHsKICAgICAgICB2YXIgbmFtZTEgPSBuYW1lc1swXTsKICAgICAgICB2YXIgbmFtZTIgPSBuYW1lc1sxXTsKICAgICAgICB2YXIgZ2V0dGVyMSA9IGdldHRlcnNbbmFtZTFdOwogICAgICAgIHZhciBnZXR0ZXIyID0gZ2V0dGVyc1tuYW1lMl07CiAgICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJpbmRpbmdVcGRhdGVyMShvYmplY3QpIHsKICAgICAgICAgICAgICB0aGlzKG5hbWUxLCBnZXR0ZXIxKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIyKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMiwgZ2V0dGVyMihvYmplY3QpKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZhciBnZXR0ZXJzXyA9IG5hbWVzLm1hcChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcnNbbmFtZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXJOKG9iamVjdCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHRoaXMobmFtZXNbaV0sIGdldHRlcnNfW2ldKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGV2ZW50cykgZXZlbnRzW25hbWVdID0gY3JlYXRlQmluZGluZ1VwZGF0ZXIoZXZlbnRzW25hbWVdLCBnZXR0ZXJzKTsKICAgICAgICByZXR1cm4gbmFtZSA/IGV2ZW50cyA6IG51bGw7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ0Z1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgYmluZGluZ0NhY2hlID0ge307CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGdldEJpbmRpbmcoYmluZGluZ3MsIG9iaiwgc2V0LCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICBpZiAoIWJpbmRpbmdzKSByZXR1cm4ge307CiAgICAgICAgICB2YXIgY2FjaGVJZCA9ICJiaW5kaW5nSWQiIGluIGJpbmRpbmdzID8gYmluZGluZ3MuYmluZGluZ0lkIDogbnVsbDsKICAgICAgICAgIGlmICghY2FjaGVJZCkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlLmdldEJpbmRpbmc6IGJpbmRpbmdzIGhhcyBubyBiaW5kaW5nSWQgcHJvcGVydHksIGNhY2hlIGlzIG5vdCB1c2VkIik7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gYmluZGluZ0NhY2hlW2NhY2hlSWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIHZhciBnZXR0ZXJzID0ge307CiAgICAgICAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGJpbmRpbmdOYW1lOyBiaW5kaW5nTmFtZSA9IGtleXNbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgICAgIGlmIChnZXR0ZXIpIHsKICAgICAgICAgICAgICAgIGdldHRlcnNbYmluZGluZ05hbWVdID0gZ2V0dGVyOwogICAgICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kaW5nTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZy5ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TGlzdCA9IFN0cmluZyhiaW5kaW5nLmV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudExpc3Rbal07IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudHNbZXZlbnROYW1lXSkgZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChiaW5kaW5nTmFtZSk7IGVsc2UgZXZlbnRzW2V2ZW50TmFtZV0gPSBbIGJpbmRpbmdOYW1lIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgIG5hbWVzOiBuYW1lcywKICAgICAgICAgICAgICBzeW5jOiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycyksCiAgICAgICAgICAgICAgaGFuZGxlcjogbWFrZUhhbmRsZXIoZXZlbnRzLCBnZXR0ZXJzKQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoY2FjaGVJZCkgYmluZGluZ0NhY2hlW2NhY2hlSWRdID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9iaiAmJiBzZXQpIHJlc3VsdC5zeW5jLmNhbGwoc2V0LCBvYmopOwogICAgICAgICAgaWYgKCFiaW5kaW5nSW50ZXJmYWNlKSByZXR1cm47CiAgICAgICAgICBpZiAocmVzdWx0LmhhbmRsZXIpIGJpbmRpbmdJbnRlcmZhY2UuYXR0YWNoKG9iaiwgcmVzdWx0LmhhbmRsZXIsIHNldCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LmhhbmRsZXI7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgdG9vbHMgPSB7CiAgICAgICAgYmluZF90ZXh0Tm9kZTogYmluZF90ZXh0Tm9kZSwKICAgICAgICBiaW5kX25vZGU6IGJpbmRfbm9kZSwKICAgICAgICBiaW5kX2VsZW1lbnQ6IGJpbmRfZWxlbWVudCwKICAgICAgICBiaW5kX2NvbW1lbnQ6IGJpbmRfY29tbWVudCwKICAgICAgICBiaW5kX2F0dHI6IGJpbmRfYXR0ciwKICAgICAgICBiaW5kX2F0dHJDbGFzczogYmluZF9hdHRyQ2xhc3MsCiAgICAgICAgYmluZF9hdHRyU3R5bGU6IGJpbmRfYXR0clN0eWxlLAogICAgICAgIHJlc29sdmU6IHJlc29sdmVWYWx1ZSwKICAgICAgICBsMTBuVG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICBjcmVhdGVCaW5kaW5nRnVuY3Rpb246IGNyZWF0ZUJpbmRpbmdGdW5jdGlvbgogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zKSB7CiAgICAgICAgdmFyIGZuID0gZ2V0RnVuY3Rpb25zKHRva2VucywgdHJ1ZSwgdGhpcy5zb3VyY2UudXJsLCB0b2tlbnMuc291cmNlXywgIUNMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgICB2YXIgaW5zdGFuY2VzID0ge307CiAgICAgICAgdmFyIGwxMG5NYXAgPSB7fTsKICAgICAgICB2YXIgbDEwbkxpbmtzID0gW107CiAgICAgICAgdmFyIHNlZWQgPSAwOwogICAgICAgIHZhciBwcm90byA9IGJ1aWxkSHRtbCh0b2tlbnMpOwogICAgICAgIHZhciBpZCA9IHRoaXMudGVtcGxhdGVJZDsKICAgICAgICB0ZW1wbGF0ZXNbaWRdID0gewogICAgICAgICAgdGVtcGxhdGU6IHRoaXMsCiAgICAgICAgICBpbnN0YW5jZXM6IGluc3RhbmNlcwogICAgICAgIH07CiAgICAgICAgaWYgKGZuLmNyZWF0ZUwxMG5TeW5jKSB7CiAgICAgICAgICB2YXIgbDEwblByb3RvU3luYyA9IGZuLmNyZWF0ZUwxMG5TeW5jKHByb3RvLCBsMTBuTWFwLCBiaW5kX2F0dHIsIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gZm4ubDEwbktleXNbaV07IGkrKykgbDEwblByb3RvU3luYyhrZXksIGwxMG5Ub2tlbihrZXkpLnZhbHVlKTsKICAgICAgICAgIGlmIChmbi5sMTBuS2V5cykgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gZm4ubDEwbktleXNbaV07IGkrKykgewogICAgICAgICAgICB2YXIgbGluayA9IHsKICAgICAgICAgICAgICBwYXRoOiBrZXksCiAgICAgICAgICAgICAgdG9rZW46IGwxMG5Ub2tlbihrZXkpLAogICAgICAgICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBsMTBuUHJvdG9TeW5jKHRoaXMucGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlcykgaW5zdGFuY2VzW2tleV0udG1wbC5zZXQodGhpcy5wYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBsaW5rLnRva2VuLmF0dGFjaChsaW5rLmhhbmRsZXIsIGxpbmspOwogICAgICAgICAgICBsMTBuTGlua3MucHVzaChsaW5rKTsKICAgICAgICAgICAgbGluayA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNyZWF0ZUluc3RhbmNlID0gZm4uY3JlYXRlSW5zdGFuY2UoaWQsIGluc3RhbmNlcywgcHJvdG8sIHRvb2xzLCBsMTBuTWFwLCBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uKG9iaiwgb25BY3Rpb24sIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlSWQgPSBzZWVkKys7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKGluc3RhbmNlSWQsIG9iaiwgb25BY3Rpb24sIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICBpbnN0YW5jZXNbaW5zdGFuY2VJZF0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLnRtcGw7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveUluc3RhbmNlOiBmdW5jdGlvbih0bXBsKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkID0gdG1wbC50ZW1wbGF0ZUlkXzsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuaGFuZGxlcikgaW5zdGFuY2UuYmluZGluZ0ludGVyZmFjZS5kZXRhY2goaW5zdGFuY2UuY29udGV4dCwgaW5zdGFuY2UuaGFuZGxlciwgaW5zdGFuY2UudG1wbC5zZXQpOwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZS5hdHRhY2hlcykgcmVzb2x2ZVZhbHVlLmNhbGwoaW5zdGFuY2UsIGtleSwgbnVsbCk7CiAgICAgICAgICAgICAgZGVsZXRlIGluc3RhbmNlc1tpbnN0YW5jZUlkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGtleXM6IGZuLmtleXMsCiAgICAgICAgICBpbnN0YW5jZXNfOiBpbnN0YW5jZXMsCiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihyZWJ1aWxkKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaW5rOyBsaW5rID0gbDEwbkxpbmtzW2ldOyBpKyspIGxpbmsudG9rZW4uZGV0YWNoKGxpbmsuaGFuZGxlciwgbGluayk7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZXMpIHsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBpbnN0YW5jZXNba2V5XTsKICAgICAgICAgICAgICBpZiAocmVidWlsZCAmJiBpbnN0YW5jZS5yZWJ1aWxkKSBpbnN0YW5jZS5yZWJ1aWxkLmNhbGwoaW5zdGFuY2UuY29udGV4dCk7CiAgICAgICAgICAgICAgaWYgKCFyZWJ1aWxkIHx8IGtleSBpbiBpbnN0YW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5oYW5kbGVyKSBpbnN0YW5jZS5iaW5kaW5nSW50ZXJmYWNlLmRldGFjaChpbnN0YW5jZS5jb250ZXh0LCBpbnN0YW5jZS5oYW5kbGVyLCBpbnN0YW5jZS50bXBsLnNldCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UuYXR0YWNoZXMpIHJlc29sdmVWYWx1ZS5jYWxsKGtleSwgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZXNbaWRdICYmIHRlbXBsYXRlc1tpZF0uaW5zdGFuY2VzID09PSBpbnN0YW5jZXMpIGRlbGV0ZSB0ZW1wbGF0ZXNbaWRdOwogICAgICAgICAgICBmbiA9IG51bGw7CiAgICAgICAgICAgIHByb3RvID0gbnVsbDsKICAgICAgICAgICAgbDEwbk1hcCA9IG51bGw7CiAgICAgICAgICAgIGwxMG5MaW5rcyA9IG51bGw7CiAgICAgICAgICAgIGwxMG5Qcm90b1N5bmMgPSBudWxsOwogICAgICAgICAgICBpbnN0YW5jZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgSHRtbFRlbXBsYXRlID0gVGVtcGxhdGUuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEh0bWxUZW1wbGF0ZSkgcmV0dXJuIHZhbHVlOwogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlU3dpdGNoQ29uZmlnKSByZXR1cm4gbmV3IEh0bWxUZW1wbGF0ZVN3aXRjaGVyKHZhbHVlKTsKICAgICAgICByZXR1cm4gbmV3IEh0bWxUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGJ1aWxkZXI6IGJ1aWxkZXIKICAgIH0pOwogICAgdmFyIEh0bWxUZW1wbGF0ZVN3aXRjaGVyID0gVGVtcGxhdGVTd2l0Y2hlci5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZVN3aXRjaGVyIiwKICAgICAgdGVtcGxhdGVDbGFzczogSHRtbFRlbXBsYXRlCiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBUZW1wbGF0ZTogSHRtbFRlbXBsYXRlLAogICAgICBUZW1wbGF0ZVN3aXRjaGVyOiBIdG1sVGVtcGxhdGVTd2l0Y2hlcgogICAgfTsKICAgIGJhc2lzLnRlbXBsYXRlLmV4dGVuZCh7CiAgICAgIGdldERlYnVnSW5mb0J5SWQ6IGdldERlYnVnSW5mb0J5SWQsCiAgICAgIGJ1aWxkSHRtbDogYnVpbGRIdG1sLAogICAgICByZXNvbHZlVGVtcGxhdGVCeUlkOiByZXNvbHZlVGVtcGxhdGVCeUlkLAogICAgICByZXNvbHZlT2JqZWN0QnlJZDogcmVzb2x2ZU9iamVjdEJ5SWQsCiAgICAgIHJlc29sdmVUbXBsQnlJZDogcmVzb2x2ZVRtcGxCeUlkCiAgICB9KTsKICB9LAogICI5LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyICRudWxsID0gYmFzaXMuZm4uJG51bGw7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBXM0NTVVBQT1JUID0gISFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyOwogICAgdmFyIEVWRU5UX0hPTERFUiA9ICJfX2Jhc2lzRXZlbnRzIjsKICAgIHZhciBLRVkgPSB7CiAgICAgIEJBQ0tTUEFDRTogOCwKICAgICAgVEFCOiA5LAogICAgICBDVFJMX0VOVEVSOiAxMCwKICAgICAgRU5URVI6IDEzLAogICAgICBTSElGVDogMTYsCiAgICAgIENUUkw6IDE3LAogICAgICBBTFQ6IDE4LAogICAgICBFU0M6IDI3LAogICAgICBFU0NBUEU6IDI3LAogICAgICBTUEFDRTogMzIsCiAgICAgIFBBR0VVUDogMzMsCiAgICAgIFBBR0VET1dOOiAzNCwKICAgICAgRU5EOiAzNSwKICAgICAgSE9NRTogMzYsCiAgICAgIExFRlQ6IDM3LAogICAgICBVUDogMzgsCiAgICAgIFJJR0hUOiAzOSwKICAgICAgRE9XTjogNDAsCiAgICAgIElOU0VSVDogNDUsCiAgICAgIERFTEVURTogNDYsCiAgICAgIEYxOiAxMTIsCiAgICAgIEYyOiAxMTMsCiAgICAgIEYzOiAxMTQsCiAgICAgIEY0OiAxMTUsCiAgICAgIEY1OiAxMTYsCiAgICAgIEY2OiAxMTcsCiAgICAgIEY3OiAxMTgsCiAgICAgIEY4OiAxMTksCiAgICAgIEY5OiAxMjAsCiAgICAgIEYxMDogMTIxLAogICAgICBGMTE6IDEyMiwKICAgICAgRjEyOiAxMjMKICAgIH07CiAgICB2YXIgTU9VU0VfTEVGVCA9IHsKICAgICAgVkFMVUU6IDEsCiAgICAgIEJJVDogMQogICAgfTsKICAgIHZhciBNT1VTRV9NSURETEUgPSB7CiAgICAgIFZBTFVFOiAyLAogICAgICBCSVQ6IDQKICAgIH07CiAgICB2YXIgTU9VU0VfUklHSFQgPSB7CiAgICAgIFZBTFVFOiAzLAogICAgICBCSVQ6IDIKICAgIH07CiAgICB2YXIgQlJPV1NFUl9FVkVOVFMgPSB7CiAgICAgIG1vdXNld2hlZWw6IFsgIm1vdXNld2hlZWwiLCAiRE9NTW91c2VTY3JvbGwiIF0KICAgIH07CiAgICBmdW5jdGlvbiBicm93c2VyRXZlbnRzKGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gQlJPV1NFUl9FVkVOVFNbZXZlbnROYW1lXSB8fCBbIGV2ZW50TmFtZSBdOwogICAgfQogICAgdmFyIEV2ZW50ID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXZlbnQiLAogICAgICBLRVk6IEtFWSwKICAgICAgaW5pdDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnQpIGlmIChuYW1lICE9ICJyZXR1cm5WYWx1ZSIgJiYgbmFtZSAhPSAia2V5TG9jYXRpb24iICYmIG5hbWUgIT0gImxheWVyWCIgJiYgbmFtZSAhPSAibGF5ZXJZIikgaWYgKHR5cGVvZiBldmVudFtuYW1lXSAhPSAiZnVuY3Rpb24iICYmIG5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgdGhpc1tuYW1lXSA9IGV2ZW50W25hbWVdOwogICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQodGhpcywgewogICAgICAgICAgZXZlbnRfOiBldmVudCwKICAgICAgICAgIHNlbmRlcjogc2VuZGVyKGV2ZW50KSwKICAgICAgICAgIGtleToga2V5KGV2ZW50KSwKICAgICAgICAgIGNoYXJDb2RlOiBjaGFyQ29kZShldmVudCksCiAgICAgICAgICBtb3VzZUxlZnQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9MRUZUKSwKICAgICAgICAgIG1vdXNlTWlkZGxlOiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTUlERExFKSwKICAgICAgICAgIG1vdXNlUmlnaHQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9SSUdIVCksCiAgICAgICAgICBtb3VzZVg6IG1vdXNlWChldmVudCksCiAgICAgICAgICBtb3VzZVk6IG1vdXNlWShldmVudCksCiAgICAgICAgICB3aGVlbERlbHRhOiB3aGVlbERlbHRhKGV2ZW50KQogICAgICAgIH0pOwogICAgICB9LAogICAgICBzdG9wQnViYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgIGNhbmNlbEJ1YmJsZSh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgZGllOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3BCdWJibGUoKTsKICAgICAgICB0aGlzLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gd3JhcChldmVudCkgewogICAgICByZXR1cm4gZXZlbnQgaW5zdGFuY2VvZiBFdmVudCA/IGV2ZW50LmV2ZW50XyA6IGV2ZW50IHx8IGdsb2JhbC5ldmVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGUocmVmKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcmVmID09ICJzdHJpbmciID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVmKSA6IHJlZjsKICAgIH0KICAgIGZ1bmN0aW9uIHNlbmRlcihldmVudCkgewogICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgIHJldHVybiB0YXJnZXQubm9kZVR5cGUgPT0gMyA/IHRhcmdldC5wYXJlbnROb2RlIDogdGFyZ2V0OwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsQnViYmxlKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyBlbHNlIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBjYW5jZWxEZWZhdWx0KGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsgZWxzZSBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24ga2lsbChldmVudCwgbm9kZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKG5vZGUpIGFkZEhhbmRsZXIobm9kZSwgZXZlbnQsIGtpbGwpOyBlbHNlIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KGV2ZW50KTsKICAgICAgICBjYW5jZWxCdWJibGUoZXZlbnQpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBrZXkoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2ggfHwgMDsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYXJDb2RlKGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZUJ1dHRvbihldmVudCwgYnV0dG9uKSB7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggPT0gIm51bWJlciIpIHJldHVybiBldmVudC53aGljaCA9PSBidXR0b24uVkFMVUU7IGVsc2UgcmV0dXJuICEhKGV2ZW50LmJ1dHRvbiAmIGJ1dHRvbi5CSVQpOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VYKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOyBlbHNlIGlmICgicGFnZVgiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVg7IGVsc2UgcmV0dXJuICJjbGllbnRYIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFggKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCkgOiAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VZKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZOyBlbHNlIGlmICgicGFnZVkiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVk7IGVsc2UgcmV0dXJuICJjbGllbnRZIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFkgKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIDogZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIHdoZWVsRGVsdGEoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgaWYgKCJ3aGVlbERlbHRhIiBpbiBldmVudCkgZGVsdGEgPSBldmVudC53aGVlbERlbHRhOyBlbHNlIGlmIChldmVudC50eXBlID09ICJET01Nb3VzZVNjcm9sbCIpIGRlbHRhID0gLWV2ZW50LmRldGFpbDsKICAgICAgcmV0dXJuIGRlbHRhICYmIGRlbHRhIC8gTWF0aC5hYnMoZGVsdGEpOwogICAgfQogICAgdmFyIGdsb2JhbEhhbmRsZXJzID0ge307CiAgICB2YXIgY2FwdHVyZUhhbmRsZXJzID0ge307CiAgICB2YXIgbm9DYXB0dXJlU2NoZW1lID0gIVczQ1NVUFBPUlQ7CiAgICBmdW5jdGlvbiBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGFycmF5RnJvbShnbG9iYWxIYW5kbGVyc1tldmVudC50eXBlXSk7CiAgICAgIHZhciBjYXB0dXJlSGFuZGxlciA9IGNhcHR1cmVIYW5kbGVyc1tldmVudC50eXBlXTsKICAgICAgdmFyIHdyYXBwZWRFdmVudCA9IG5ldyBFdmVudChldmVudCk7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcikgewogICAgICAgIGNhcHR1cmVIYW5kbGVyLmhhbmRsZXIuY2FsbChjYXB0dXJlSGFuZGxlci50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIGtpbGwoZXZlbnQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gaGFuZGxlcnMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gaGFuZGxlcnNbaV07CiAgICAgICAgICBoYW5kbGVyT2JqZWN0LmhhbmRsZXIuY2FsbChoYW5kbGVyT2JqZWN0LnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjYXB0dXJlRXZlbnQoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcnNbZXZlbnRUeXBlXSkgcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSk7CiAgICAgIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgICAgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0gPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiByZWxlYXNlRXZlbnQoZXZlbnRUeXBlKSB7CiAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXJPYmplY3QuaGFuZGxlciwgaGFuZGxlck9iamVjdC50aGlzT2JqZWN0KTsKICAgICAgICBkZWxldGUgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lKSBhZGRIYW5kbGVyKGRvY3VtZW50LCBldmVudFR5cGUsICRudWxsKTsgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgb2JzZXJ2ZUdsb2JhbEV2ZW50cywgdHJ1ZSk7CiAgICAgICAgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdID0gW107CiAgICAgIH0KICAgICAgaGFuZGxlcnMucHVzaCh7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBoYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGlmICghaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgcmVtb3ZlSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEhhbmRsZXIobm9kZSwgZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICBpZiAoIW5vZGUpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBjYW4ndCBhdHRhY2ggZXZlbnQgbGlzdGVuZXIgdG8gdW5kZWZpbmVkIjsKICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9ICJmdW5jdGlvbiIpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBoYW5kbGVyIGlzIG5vdCBhIGZ1bmN0aW9uIjsKICAgICAgaWYgKCFub2RlW0VWRU5UX0hPTERFUl0pIG5vZGVbRVZFTlRfSE9MREVSXSA9IHt9OwogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IHsKICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgIHRoaXNPYmplY3Q6IHRoaXNPYmplY3QKICAgICAgfTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzKSB7CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdID0gWyBoYW5kbGVyT2JqZWN0IF07CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lICYmIGV2ZW50ICYmIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG9ic2VydmVHbG9iYWxFdmVudHMoZXZlbnQpOwogICAgICAgICAgICAgIGlmIChldmVudC5jYW5jZWxCdWJibGUgPT09IHRydWUpIHJldHVybjsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlID09ICJ1bmRlZmluZWQiKSBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaSsrXTsgKSBpdGVtLmhhbmRsZXIuY2FsbChpdGVtLnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfTsKICAgICAgICBpZiAoVzNDU1VQUE9SVCkgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5hdHRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgICBldmVudFR5cGVIYW5kbGVycy5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVycyhub2RlLCBoYW5kbGVycywgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlcnNbZXZlbnRUeXBlXSwgdGhpc09iamVjdCk7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBldmVudFR5cGVIYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGlmICghZXZlbnRUeXBlSGFuZGxlcnMubGVuZ3RoKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50VHlwZSAhPSAic3RyaW5nIikgewogICAgICAgICAgZm9yIChldmVudFR5cGUgaW4gaGFuZGxlcnMpIGNsZWFySGFuZGxlcnMobm9kZSwgZXZlbnRUeXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgICBpZiAobm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKSBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQsIGZhbHNlKTsgZWxzZSBub2RlLmRldGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmlyZUV2ZW50KG5vZGUsIGV2ZW50VHlwZSwgZXZlbnQpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzICYmIGhhbmRsZXJzW2V2ZW50VHlwZV0pIGhhbmRsZXJzW2V2ZW50VHlwZV0uZmlyZUV2ZW50KGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9uVW5sb2FkKGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgYWRkSGFuZGxlcihnbG9iYWwsICJ1bmxvYWQiLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgIH0KICAgIHZhciB0YWdOYW1lRXZlbnRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEV2ZW50SW5mbyhldmVudE5hbWUsIHRhZ05hbWUpIHsKICAgICAgaWYgKCF0YWdOYW1lKSB0YWdOYW1lID0gImRpdiI7CiAgICAgIHZhciBpZCA9IHRhZ05hbWUgKyAiLSIgKyBldmVudE5hbWU7CiAgICAgIGlmICh0YWdOYW1lRXZlbnRNYXBbaWRdKSByZXR1cm4gdGFnTmFtZUV2ZW50TWFwW2lkXTsgZWxzZSB7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIHZhciBidWJibGUgPSBmYWxzZTsKICAgICAgICBpZiAoIVczQ1NVUFBPUlQpIHsKICAgICAgICAgIHZhciBvbmV2ZW50ID0gIm9uIiArIGV2ZW50TmFtZTsKICAgICAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gaG9zdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpKTsKICAgICAgICAgIGhvc3Rbb25ldmVudF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYnViYmxlID0gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0YXJnZXQuZmlyZUV2ZW50KG9uZXZlbnQpOwogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF0gPSB7CiAgICAgICAgICBzdXBwb3J0ZWQ6IHN1cHBvcnRlZCwKICAgICAgICAgIGJ1YmJsZTogYnViYmxlCiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gd3JhcEV2ZW50RnVuY3Rpb24oZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKICAgICAgICByZXR1cm4gZm4od3JhcChldmVudCksIGFyZyk7CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgVzNDU1VQUE9SVDogVzNDU1VQUE9SVCwKICAgICAgYnJvd3NlckV2ZW50czogYnJvd3NlckV2ZW50cywKICAgICAgZ2V0RXZlbnRJbmZvOiBnZXRFdmVudEluZm8sCiAgICAgIEtFWTogS0VZLAogICAgICBNT1VTRV9MRUZUOiBNT1VTRV9MRUZULAogICAgICBNT1VTRV9SSUdIVDogTU9VU0VfUklHSFQsCiAgICAgIE1PVVNFX01JRERMRTogTU9VU0VfTUlERExFLAogICAgICBFdmVudDogRXZlbnQsCiAgICAgIHNlbmRlcjogd3JhcEV2ZW50RnVuY3Rpb24oc2VuZGVyKSwKICAgICAgY2FuY2VsQnViYmxlOiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxCdWJibGUpLAogICAgICBjYW5jZWxEZWZhdWx0OiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxEZWZhdWx0KSwKICAgICAga2lsbDogd3JhcEV2ZW50RnVuY3Rpb24oa2lsbCksCiAgICAgIGtleTogd3JhcEV2ZW50RnVuY3Rpb24oa2V5KSwKICAgICAgY2hhckNvZGU6IHdyYXBFdmVudEZ1bmN0aW9uKGNoYXJDb2RlKSwKICAgICAgbW91c2VCdXR0b246IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlQnV0dG9uKSwKICAgICAgbW91c2VYOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVgpLAogICAgICBtb3VzZVk6IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlWSksCiAgICAgIHdoZWVsRGVsdGE6IHdyYXBFdmVudEZ1bmN0aW9uKHdoZWVsRGVsdGEpLAogICAgICBhZGRHbG9iYWxIYW5kbGVyOiBhZGRHbG9iYWxIYW5kbGVyLAogICAgICByZW1vdmVHbG9iYWxIYW5kbGVyOiByZW1vdmVHbG9iYWxIYW5kbGVyLAogICAgICBjYXB0dXJlRXZlbnQ6IGNhcHR1cmVFdmVudCwKICAgICAgcmVsZWFzZUV2ZW50OiByZWxlYXNlRXZlbnQsCiAgICAgIGFkZEhhbmRsZXI6IGFkZEhhbmRsZXIsCiAgICAgIGFkZEhhbmRsZXJzOiBhZGRIYW5kbGVycywKICAgICAgcmVtb3ZlSGFuZGxlcjogcmVtb3ZlSGFuZGxlciwKICAgICAgY2xlYXJIYW5kbGVyczogY2xlYXJIYW5kbGVycywKICAgICAgZmlyZUV2ZW50OiBmaXJlRXZlbnQsCiAgICAgIG9uVW5sb2FkOiBvblVubG9hZCwKICAgICAgd3JhcDogd3JhcAogICAgfTsKICB9LAogICJhLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzcuanMiKTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX0FUVFJTOwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9DSElMRFM7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgdG1wbEZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIGlubGluZVNlZWQgPSAxOwogICAgdmFyIGJ1aWxkUGF0aGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBQQVRIX1JFRl9OQU1FID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiLnNwbGl0KCIiKTsKICAgICAgdmFyIHBhdGhMaXN0OwogICAgICB2YXIgcmVmTGlzdDsKICAgICAgdmFyIGJpbmRpbmdMaXN0OwogICAgICB2YXIgbWFya2VkRWxlbWVudExpc3Q7CiAgICAgIHZhciByb290UGF0aDsKICAgICAgZnVuY3Rpb24gcHV0UmVmcyhyZWZzLCBwYXRoSWR4KSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHJlZk5hbWU7IHJlZk5hbWUgPSByZWZzW2ldOyBpKyspIGlmIChyZWZOYW1lLmluZGV4T2YoIjoiKSA9PSAtMSkgcmVmTGlzdC5wdXNoKHJlZk5hbWUgKyAiOiIgKyBwYXRoSWR4KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwdXRQYXRoKHBhdGgpIHsKICAgICAgICB2YXIgbGVuID0gcGF0aExpc3QubGVuZ3RoOwogICAgICAgIHZhciBwYXRoUmVmID0gUEFUSF9SRUZfTkFNRVtsZW5dIHx8ICJyIiArIGxlbjsKICAgICAgICBwYXRoTGlzdC5wdXNoKHBhdGhSZWYgKyAiPSIgKyBwYXRoKTsKICAgICAgICByZXR1cm4gcGF0aFJlZjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwdXRCaW5kaW5nKGJpbmRpbmcpIHsKICAgICAgICBiaW5kaW5nTGlzdC5wdXNoKGJpbmRpbmcpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3NUb2tlbnModG9rZW5zLCBwYXRoLCBub1RleHRCdWcpIHsKICAgICAgICB2YXIgbG9jYWxQYXRoOwogICAgICAgIHZhciByZWZzOwogICAgICAgIHZhciBteVJlZjsKICAgICAgICB2YXIgZXhwbGljaXRSZWY7CiAgICAgICAgdmFyIGJpbmRpbmdzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjcCA9IDAsIGNsb3NlVGV4dCA9IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrLCBjcCsrLCBleHBsaWNpdFJlZiA9IGZhbHNlKSB7CiAgICAgICAgICBpZiAoIWkpIGxvY2FsUGF0aCA9IHBhdGggKyAiLmZpcnN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgaWYgKCF0b2tlbnNbaSArIDFdKSBsb2NhbFBhdGggPSBwYXRoICsgIi5sYXN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gdG9rZW5zW2kgLSAxXVtUT0tFTl9UWVBFXSAmJiB0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQpIGNsb3NlVGV4dCsrOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHBhdGggKyAiLmNoaWxkTm9kZXNbIiArIChub1RleHRCdWcgPyBjcCA6IGNwICsgKGNsb3NlVGV4dCA/ICIgKyAiICsgY2xvc2VUZXh0ICsgIiAqIFRFWFRfQlVHIiA6ICIiKSkgKyAiXSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWZzID0gdG9rZW5bVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIHB1dFJlZnMocmVmcywgbG9jYWxQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXVt0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxXTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHV0QmluZGluZyhbIHRva2VuW1RPS0VOX1RZUEVdLCBsb2NhbFBhdGgsIHRva2VuW1RPS0VOX0JJTkRJTkdTXSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgbXlSZWYgPSAtMTsKICAgICAgICAgICAgaWYgKHBhdGggPT0gcm9vdFBhdGgpIG1hcmtlZEVsZW1lbnRMaXN0LnB1c2gobG9jYWxQYXRoICsgIi5iYXNpc1RlbXBsYXRlSWQiKTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgICBteVJlZiA9IHBhdGhMaXN0Lmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXR0cnMgPSBbXTsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSBFTEVNRU5UX0FUVFJTLCB0OyB0ID0gdG9rZW5bal07IGorKykgaWYgKHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UIHx8IHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9URVhUIHx8IHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9DT01NRU5UKSBjaGlsZHJlbi5wdXNoKHQpOyBlbHNlIGF0dHJzLnB1c2godCk7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBhdHRyOyBhdHRyID0gYXR0cnNbal07IGorKykgewogICAgICAgICAgICAgIGlmIChhdHRyW1RPS0VOX1RZUEVdID09IDYpIGNvbnRpbnVlOwogICAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IEFUVFJfTkFNRV9CWV9UWVBFW2F0dHJbVE9LRU5fVFlQRV1dIHx8IGF0dHJbQVRUUl9OQU1FXTsKICAgICAgICAgICAgICBpZiAocmVmcyA9IGF0dHJbVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHB1dFJlZnMocmVmcywgcHV0UGF0aChsb2NhbFBhdGggKyAnLmdldEF0dHJpYnV0ZU5vZGUoIicgKyBhdHRyTmFtZSArICciKScpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzID0gYXR0cltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3Nba107IGsrKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZGluZ1sxXSwgYXR0ck5hbWUsIGJpbmRpbmdbMF0gXS5jb25jYXQoYmluZGluZy5zbGljZSgyKSkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIHByb3BlcnR5OyBwcm9wZXJ0eSA9IGJpbmRpbmdzW2tdOyBrKyspIGZvciAodmFyIG0gPSAwLCBiaW5kTmFtZTsgYmluZE5hbWUgPSBwcm9wZXJ0eVswXVttXTsgbSsrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kTmFtZSwgYXR0ck5hbWUsIHByb3BlcnR5WzBdLCBwcm9wZXJ0eVsxXSwgcHJvcGVydHlbMl0gXSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmROYW1lOyBiaW5kTmFtZSA9IGJpbmRpbmdzWzBdW2tdOyBrKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmROYW1lLCBhdHRyTmFtZSwgYmluZGluZ3NbMF0sIGJpbmRpbmdzWzFdLCB0b2tlbltFTEVNRU5UX05BTUVdIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSBwcm9jZXNzVG9rZW5zKGNoaWxkcmVuLCBsb2NhbFBhdGgsIG5vVGV4dEJ1Zyk7CiAgICAgICAgICAgIGlmICghZXhwbGljaXRSZWYgJiYgbXlSZWYgPT0gcGF0aExpc3QubGVuZ3RoKSBwYXRoTGlzdC5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VucywgcGF0aCwgbm9UZXh0QnVnKSB7CiAgICAgICAgcGF0aExpc3QgPSBbXTsKICAgICAgICByZWZMaXN0ID0gW107CiAgICAgICAgYmluZGluZ0xpc3QgPSBbXTsKICAgICAgICBtYXJrZWRFbGVtZW50TGlzdCA9IFtdOwogICAgICAgIHJvb3RQYXRoID0gcGF0aCB8fCAiXyI7CiAgICAgICAgcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHJvb3RQYXRoLCBub1RleHRCdWcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXRoOiBwYXRoTGlzdCwKICAgICAgICAgIHJlZjogcmVmTGlzdCwKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdMaXN0LAogICAgICAgICAgbWFya2VkRWxlbWVudExpc3Q6IG1hcmtlZEVsZW1lbnRMaXN0CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBidWlsZEJpbmRpbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBMMTBOX0JJTkRJTkcgPSAvXC5ceyhbYS16QS1aX11bYS16QS1aMC05X1wtXSopXH0vOwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX01BUCA9IHsKICAgICAgICBkaXNhYmxlZDogIioiLAogICAgICAgIGNoZWNrZWQ6IFsgImlucHV0IiBdLAogICAgICAgIHZhbHVlOiBbICJpbnB1dCIsICJ0ZXh0YXJlYSIgXSwKICAgICAgICBtaW5sZW5ndGg6IFsgImlucHV0IiBdLAogICAgICAgIG1heGxlbmd0aDogWyAiaW5wdXQiIF0sCiAgICAgICAgcmVhZG9ubHk6IFsgImlucHV0IiBdLAogICAgICAgIHNlbGVjdGVkOiBbICJvcHRpb24iIF0sCiAgICAgICAgbXVsdGlwbGU6IFsgInNlbGVjdCIgXQogICAgICB9OwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX1NJTkdMRSA9IHsKICAgICAgICBkaXNhYmxlZDogdHJ1ZSwKICAgICAgICBjaGVja2VkOiB0cnVlLAogICAgICAgIHNlbGVjdGVkOiB0cnVlLAogICAgICAgIHJlYWRvbmx5OiB0cnVlLAogICAgICAgIG11bHRpcGxlOiB0cnVlCiAgICAgIH07CiAgICAgIHZhciBiaW5kRnVuY3Rpb25zID0gewogICAgICAgIDE6ICJiaW5kX2VsZW1lbnQiLAogICAgICAgIDM6ICJiaW5kX3RleHROb2RlIiwKICAgICAgICA4OiAiYmluZF9jb21tZW50IgogICAgICB9OwogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIHNwZWNpYWwsIGwxMG4pIHsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBzeW1ib2xzID0gYmluZGluZ1s1XTsKICAgICAgICB2YXIgZGljdGlvbmFyeSA9IGJpbmRpbmdbNF07CiAgICAgICAgdmFyIGV4cHJWYXI7CiAgICAgICAgdmFyIGNvbG9uUG9zOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3ltYm9scy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHR5cGVvZiBzeW1ib2xzW2pdID09ICJzdHJpbmciKSBleHByZXNzaW9uLnB1c2goJyInICsgc3ltYm9sc1tqXS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJyk7IGVsc2UgewogICAgICAgICAgICBleHByVmFyID0gZGljdGlvbmFyeVtzeW1ib2xzW2pdXTsKICAgICAgICAgICAgY29sb25Qb3MgPSBleHByVmFyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKGNvbG9uUG9zID09IC0xKSB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbi5wdXNoKHNwZWNpYWwgPT0gImwxMG4iID8gJyJ7JyArIGV4cHJWYXIgKyAnfSInIDogc3BlY2lhbCA9PSAiYm9vbCIgPyAiKF9fIiArIGV4cHJWYXIgKyAnfHwiIiknIDogIl9fIiArIGV4cHJWYXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGwxMG5QYXRoID0gZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKS5yZXBsYWNlKEwxME5fQklORElORywgZnVuY3Rpb24obSwgbmFtZSkgewogICAgICAgICAgICAgICAgYmluZGluZ05hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChiaW5kaW5nTmFtZSkgZXhwcmVzc2lvbi5wdXNoKGwxMG5bZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKV0pOyBlbHNlIGV4cHJlc3Npb24ucHVzaCgnX19sMTBuWyInICsgbDEwblBhdGggKyAnIl0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZXhwcmVzc2lvbi5sZW5ndGggPT0gMSkgZXhwcmVzc2lvbi5wdXNoKCciIicpOwogICAgICAgIHJldHVybiBleHByZXNzaW9uLmpvaW4oIisiKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oYmluZGluZ3MpIHsKICAgICAgICBmdW5jdGlvbiBwdXRCaW5kQ29kZSh0eXBlKSB7CiAgICAgICAgICB0b29sc1VzZWRbdHlwZV0gPSB0cnVlOwogICAgICAgICAgYmluZENvZGUucHVzaChiaW5kVmFyICsgIj0iICsgdHlwZSArICIoIiArIGJhc2lzLmFycmF5KGFyZ3VtZW50cywgMSkgKyAiKTsiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGJpbmRNYXAgPSB7fTsKICAgICAgICB2YXIgYmluZENvZGU7CiAgICAgICAgdmFyIGJpbmRWYXI7CiAgICAgICAgdmFyIHZhckxpc3QgPSBbXTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHZhck5hbWU7CiAgICAgICAgdmFyIGwxMG5NYXA7CiAgICAgICAgdmFyIGwxMG5Db21wdXRlID0gW107CiAgICAgICAgdmFyIGwxMG5CaW5kaW5ncyA9IHt9OwogICAgICAgIHZhciBsMTBuQmluZFNlZWQgPSAxOwogICAgICAgIHZhciB0b29sc1VzZWQgPSB7CiAgICAgICAgICByZXNvbHZlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbEF0dHI7CiAgICAgICAgdmFyIGRlYnVnTGlzdCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3NbaV07IGkrKykgewogICAgICAgICAgdmFyIGJpbmRUeXBlID0gYmluZGluZ1swXTsKICAgICAgICAgIHZhciBkb21SZWYgPSBiaW5kaW5nWzFdOwogICAgICAgICAgdmFyIGJpbmROYW1lID0gYmluZGluZ1syXTsKICAgICAgICAgIGlmIChbICJnZXQiLCAic2V0IiwgInRlbXBsYXRlSWRfIiBdLmluZGV4T2YoYmluZE5hbWUpICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiaW5kaW5nIG5hbWUgYCIgKyBiaW5kTmFtZSArICJgIGlzIHByb2hpYml0ZWQsIGJpbmRpbmcgaWdub3JlZCIpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lUGFydCA9IGJpbmROYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICB2YXIgYW5pbSA9IG5hbWVQYXJ0WzBdID09ICJhbmltIjsKICAgICAgICAgIGlmIChhbmltKSBiaW5kTmFtZSA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgIGlmIChuYW1lUGFydFswXSA9PSAibDEwbiIgJiYgbmFtZVBhcnRbMV0pIHsKICAgICAgICAgICAgdmFyIGwxMG5GdWxsUGF0aCA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbDEwbk5hbWUgPSBsMTBuRnVsbFBhdGgucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICBsMTBuQmluZGluZyA9IG5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGwxMG5CaW5kaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGwxMG5GdWxsUGF0aCBpbiBsMTBuQmluZGluZ3MgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhck5hbWUgPSAiJGwxMG5fIiArIGwxMG5CaW5kU2VlZCsrOwogICAgICAgICAgICAgICAgbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF0gPSB2YXJOYW1lOwogICAgICAgICAgICAgICAgbDEwbkNvbXB1dGUucHVzaCgnc2V0KCInICsgdmFyTmFtZSArICciLCcgKyB2YXJOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lICsgJz10b29scy5sMTBuVG9rZW4oIicgKyBsMTBuTmFtZSArICciKS5jb21wdXRlVG9rZW4oKScpOwogICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXTsKICAgICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXSA9IFtdOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goIl9fIiArIGwxMG5CaW5kaW5nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2godmFyTmFtZSArICIuc2V0KF9fIiArIGwxMG5CaW5kaW5nICsgIik7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJpbmROYW1lID0gbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF07CiAgICAgICAgICAgICAgYmluZFZhciA9ICJfIiArIGk7CiAgICAgICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdOwogICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIGJpbmRWYXIsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGJpbmRWYXIsICJ2YWx1ZSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9ICciJyArIGJpbmRpbmdbQVRUUl9OQU1FXSArICciJzsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgImF0dHI6IiArIGF0dHJOYW1lLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhcik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCBhdHRyTmFtZSwgYmluZFZhciwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbDEwbk1hcCkgbDEwbk1hcCA9IHt9OwogICAgICAgICAgICBpZiAoIWJpbmRNYXBbbDEwbk5hbWVdKSB7CiAgICAgICAgICAgICAgYmluZE1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuTmFtZV07CiAgICAgICAgICAgIGJpbmRDb2RlLmwxMG4gPSB0cnVlOwogICAgICAgICAgICBpZiAoYmluZFR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGwxMG5GdWxsUGF0aCArICciJywgImRvbToiICsgZG9tUmVmLCAndmFsOl9fbDEwblsiJyArIGwxMG5OYW1lICsgJyJdJywgJ2F0dGFjaG1lbnQ6bDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIiknIF0gKyAifSIpOwogICAgICAgICAgICAgIHRvb2xzVXNlZC5sMTBuVG9rZW4gPSB0cnVlOwogICAgICAgICAgICAgIGwxMG5NYXBbbDEwbk5hbWVdLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAnLm5vZGVWYWx1ZT1fX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScgKyAobDEwbkJpbmRpbmcgPyAiW19fIiArIGwxMG5CaW5kaW5nICsgIl0iIDogIiIpICsgIjsiKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKCJiaW5kX2F0dHIoIiArIFsgZG9tUmVmLCAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIicsICJOYU4iLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSBdICsgIik7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXSA9IFtdOwogICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmluZFR5cGUgIT0gVFlQRV9BVFRSSUJVVEUpIHsKICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIChiaW5kQ29kZS5ub2RlQmluZCA/IHZhck5hbWUgOiBiaW5kVmFyKSwgInVwZGF0ZXM6JCQiICsgYmluZE5hbWUsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgaWYgKCFiaW5kQ29kZS5ub2RlQmluZCkgewogICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICBiaW5kQ29kZS5ub2RlQmluZCA9IGJpbmRWYXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3dpdGNoIChiaW5kVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGRvbVJlZiwgInZhbHVlIT09bnVsbD9TdHJpbmcodmFsdWUpOm51bGwiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAiLm5vZGVWYWx1ZT12YWx1ZTsiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBiaW5kaW5nW0FUVFJfTkFNRV07CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAnYXR0cjoiJyArIGF0dHJOYW1lICsgJyInLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdEV4cHIgPSAiIjsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUV4cHIgPSAidmFsdWUiOwogICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IGJpbmRpbmdbNF07CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0xlbmd0aCA9IGJpbmRpbmcubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPj0gNikgewogICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0xlbmd0aCA9PSA2IHx8IHR5cGVvZiBiaW5kaW5nWzZdID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIic7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s1XSkgZGVmYXVsdEV4cHIgPSBwcmVmaXggKyBiaW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndmFsdWU/IicgKyBiaW5kaW5nWzZdICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s2XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFiaW5kaW5nWzZdLmxlbmd0aCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNykgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigifHwiKSArICc/dmFsdWU6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZGluZ1s2XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd2YWx1ZT09IicgKyB2YWwgKyAnIj8iJyArIHRoaXNbaWR4XSArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdbN10pLmpvaW4oIjoiKSArICc6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s3XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndHlwZW9mIHZhbHVlPT0ic3RyaW5nInx8dHlwZW9mIHZhbHVlPT0ibnVtYmVyIj92YWx1ZToodmFsdWU/IicgKyBiaW5kTmFtZSArICciOiIiKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICc9IicgKyBkZWZhdWx0RXhwciArICciJyk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyQ2xhc3MiLCBkb21SZWYsIGJpbmRWYXIsIHZhbHVlRXhwciwgJyInICsgcHJlZml4ICsgJyInLCBhbmltKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgJz0iIicpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0clN0eWxlIiwgZG9tUmVmLCAnIicgKyBiaW5kaW5nWzZdICsgJyInLCBiaW5kVmFyLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIGZhbHNlLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0ciA9IFNQRUNJQUxfQVRUUl9NQVBbYXR0ck5hbWVdOwogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIgKyAiPSIgKyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCAnIicgKyBhdHRyTmFtZSArICciJywgYmluZFZhciwgc3BlY2lhbEF0dHIgJiYgU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJib29sIiwgbDEwbkJpbmRpbmdzKSArICc/IicgKyBhdHRyTmFtZSArICciOiIiJyA6IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxBdHRyICYmIChzcGVjaWFsQXR0ciA9PSAiKiIgfHwgc3BlY2lhbEF0dHIuaW5kZXhPZihiaW5kaW5nWzZdLnRvTG93ZXJDYXNlKCkpICE9IC0xKSkgYmluZENvZGUucHVzaCgiaWYoIiArIGRvbVJlZiArICIuIiArIGF0dHJOYW1lICsgIiE9IiArIGJpbmRWYXIgKyAiKSIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICI9IiArIChTUEVDSUFMX0FUVFJfU0lOR0xFW2F0dHJOYW1lXSA/ICIhISIgKyBiaW5kVmFyIDogYmluZFZhcikgKyAiOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCI7ZnVuY3Rpb24gc2V0KGJpbmROYW1lLHZhbHVlKXsiICsgJ2lmKHR5cGVvZiBiaW5kTmFtZSE9InN0cmluZyIpJyk7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgaWYgKGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgiaWYoYmluZE5hbWU9PT0iICsgYmluZE1hcFtiaW5kTmFtZV0ubm9kZUJpbmQgKyAiKSIgKyAnYmluZE5hbWU9IicgKyBiaW5kTmFtZSArICciOycgKyAiZWxzZSAiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goInJldHVybjsiKTsKICAgICAgICByZXN1bHQucHVzaCgidmFsdWU9cmVzb2x2ZS5jYWxsKGluc3RhbmNlLGJpbmROYW1lLHZhbHVlLEF0dGFjaGVzKTsiICsgInN3aXRjaChiaW5kTmFtZSl7Iik7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgewogICAgICAgICAgaWYgKGJpbmROYW1lLmluZGV4T2YoIkAiKSA9PSAtMSkgdmFyTGlzdC5wdXNoKCIkJCIgKyBiaW5kTmFtZSArICI9MCIpOwogICAgICAgICAgcmVzdWx0LnB1c2goJ2Nhc2UiJyArIGJpbmROYW1lICsgJyI6JyArIChiaW5kTWFwW2JpbmROYW1lXS5sMTBuID8gYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgOiAiaWYoX18iICsgYmluZE5hbWUgKyAiIT09dmFsdWUpIiArICJ7IiArICIkJCIgKyBiaW5kTmFtZSArICIrKzsiICsgIl9fIiArIGJpbmROYW1lICsgIj12YWx1ZTsiICsgYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgKyAifSIpICsgImJyZWFrOyIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgifX0iKTsKICAgICAgICB2YXIgdG9vbHNWYXJMaXN0ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRvb2xzVXNlZCkgdG9vbHNWYXJMaXN0LnB1c2goa2V5ICsgIj10b29scy4iICsga2V5KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVidWdMaXN0OiBkZWJ1Z0xpc3QsCiAgICAgICAgICBrZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kTWFwKS5maWx0ZXIoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkuaW5kZXhPZigiQCIpID09IC0xOwogICAgICAgICAgfSksCiAgICAgICAgICB0b29sczogdG9vbHNWYXJMaXN0LAogICAgICAgICAgdmFyczogdmFyTGlzdCwKICAgICAgICAgIHNldDogcmVzdWx0LmpvaW4oIiIpLAogICAgICAgICAgbDEwbjogbDEwbk1hcCwKICAgICAgICAgIGwxMG5Db21wdXRlOiBsMTBuQ29tcHV0ZQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjb21waWxlRnVuY3Rpb24oYXJncywgYm9keSkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBiYXNpcy5kZXYuZXJyb3IoIkNhbid0IGJ1aWxkIHRlbXBsYXRlIGZ1bmN0aW9uOiAiICsgZSArICJcbiIsICJmdW5jdGlvbigiICsgYXJncyArICIpe1xuIiArIGJvZHkgKyAiXG59Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBnZXRGdW5jdGlvbnMgPSBmdW5jdGlvbih0b2tlbnMsIGRlYnVnLCB1cmksIHNvdXJjZSwgbm9UZXh0QnVnKSB7CiAgICAgIHZhciBmbiA9IHRtcGxGdW5jdGlvbnNbdXJpICYmIGJhc2lzLnBhdGgucmVsYXRpdmUodXJpKV07CiAgICAgIGlmIChmbikgcmV0dXJuIGZuOwogICAgICB2YXIgcGF0aHMgPSBidWlsZFBhdGhlcyh0b2tlbnMsICJfIiwgbm9UZXh0QnVnKTsKICAgICAgdmFyIGJpbmRpbmdzID0gYnVpbGRCaW5kaW5ncyhwYXRocy5iaW5kaW5nKTsKICAgICAgdmFyIG9iamVjdFJlZnMgPSBwYXRocy5tYXJrZWRFbGVtZW50TGlzdC5qb2luKCI9Iik7CiAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgdmFyIGZuQm9keTsKICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICBrZXlzOiBiaW5kaW5ncy5rZXlzLAogICAgICAgIGwxMG5LZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kaW5ncy5sMTBuKQogICAgICB9OwogICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PSAxKSBwYXRocy5wYXRoWzBdID0gImE9XyI7CiAgICAgIGlmICghdXJpKSB1cmkgPSBiYXNpcy5wYXRoLmJhc2VVUkkgKyAiaW5saW5lX3RlbXBsYXRlIiArIGlubGluZVNlZWQrKyArICIudG1wbCI7CiAgICAgIGlmIChiaW5kaW5ncy5sMTBuKSB7CiAgICAgICAgdmFyIGNvZGUgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYmluZGluZ3MubDEwbikgY29kZS5wdXNoKCdjYXNlIicgKyBrZXkgKyAnIjonICsgJ2lmKHZhbHVlPT1udWxsKXZhbHVlPSJ7JyArIGtleSArICd9IjsnICsgIl9fbDEwblt0b2tlbl09dmFsdWU7IiArIGJpbmRpbmdzLmwxMG5ba2V5XS5qb2luKCIiKSArICJicmVhazsiKTsKICAgICAgICByZXN1bHQuY3JlYXRlTDEwblN5bmMgPSBjb21waWxlRnVuY3Rpb24oWyAiXyIsICJfX2wxMG4iLCAiYmluZF9hdHRyIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciAiICsgcGF0aHMucGF0aCArICI7IiArICJyZXR1cm4gZnVuY3Rpb24odG9rZW4sIHZhbHVlKXsiICsgInN3aXRjaCh0b2tlbil7IiArIGNvZGUuam9pbigiIikgKyAifSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpICsgIl9sMTBuIik7CiAgICAgIH0KICAgICAgcmVzdWx0LmNyZWF0ZUluc3RhbmNlID0gY29tcGlsZUZ1bmN0aW9uKFsgInRpZCIsICJtYXAiLCAicHJvdG8iLCAidG9vbHMiLCAiX19sMTBuIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciBnZXRCaW5kaW5ncz10b29scy5jcmVhdGVCaW5kaW5nRnVuY3Rpb24oWyIgKyBiaW5kaW5ncy5rZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gJyInICsga2V5ICsgJyInOwogICAgICB9KSArICJdKSwiICsgKGJpbmRpbmdzLnRvb2xzLmxlbmd0aCA/IGJpbmRpbmdzLnRvb2xzICsgIiwiIDogIiIpICsgIkF0dGFjaGVzPWZ1bmN0aW9uKCl7fTsiICsgIkF0dGFjaGVzLnByb3RvdHlwZT17IiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBrZXkgKyAiOm51bGwiOwogICAgICB9KSArICJ9OyIgKyAicmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlXyhpZCxvYmosb25BY3Rpb24sb25SZWJ1aWxkLGJpbmRpbmdzLGJpbmRpbmdJbnRlcmZhY2UpeyIgKyAidmFyIF89cHJvdG8uY2xvbmVOb2RlKHRydWUpLCIgKyBwYXRocy5wYXRoLmNvbmNhdChiaW5kaW5ncy52YXJzKSArICIsIiArICJpbnN0YW5jZT17IiArICJjb250ZXh0Om9iaiwiICsgImFjdGlvbjpvbkFjdGlvbiwiICsgInJlYnVpbGQ6b25SZWJ1aWxkLCIgKyAoZGVidWcgPyAiZGVidWc6ZnVuY3Rpb24gZGVidWcoKXtyZXR1cm5bIiArIGJpbmRpbmdzLmRlYnVnTGlzdCArICJdfSwiIDogIiIpICsgImhhbmRsZXI6bnVsbCwiICsgImJpbmRpbmdzOmJpbmRpbmdzLCIgKyAiYmluZGluZ0ludGVyZmFjZTpiaW5kaW5nSW50ZXJmYWNlLCIgKyAiYXR0YWNoZXM6bnVsbCwiICsgInRtcGw6eyIgKyBbIHBhdGhzLnJlZiwgInRlbXBsYXRlSWRfOmlkIiwgInNldDpzZXQiIF0gKyAifSIgKyAifSIgKyAob2JqZWN0UmVmcyA/ICI7aWYob2JqfHxvbkFjdGlvbikiICsgb2JqZWN0UmVmcyArICI9KGlkPDwxMil8dGlkIiA6ICIiKSArIGJpbmRpbmdzLnNldCArICI7aWYoYmluZGluZ3MpaW5zdGFuY2UuaGFuZGxlcj1nZXRCaW5kaW5ncyhiaW5kaW5ncyxvYmosc2V0LGJpbmRpbmdJbnRlcmZhY2UpIiArICI7IiArIGJpbmRpbmdzLmwxMG5Db21wdXRlICsgIjtyZXR1cm4gaW5zdGFuY2UiICsgIn0iICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVyaSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldEZ1bmN0aW9uczogZ2V0RnVuY3Rpb25zCiAgICB9OwogIH0sCiAgImouanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBFbnZDbGFzczsKICAgIGlmIChkb2N1bWVudCkgRW52Q2xhc3MgPSBiYXNpcy5yZXNvdXJjZSgiLi9xLmpzIikuZmV0Y2goKTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGZ1bmN0aW9uKGluaXQsIGh0bWwpIHsKICAgICAgICByZXR1cm4gbmV3IEVudkNsYXNzKHsKICAgICAgICAgIGluaXRFbnY6IGluaXQsCiAgICAgICAgICBodG1sOiBodG1sCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfQp9OwoKKGZ1bmN0aW9uKGdsb2JhbCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgVkVSU0lPTiA9ICIxLjIuMiI7CiAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogIHZhciBPYmplY3RfdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzb3VyY2UpIHsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGNvbXBsZXRlKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgaWYgKGtleSBpbiBkZXN0ID09IGZhbHNlKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiBkZXN0OwogIH0KICBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goa2V5KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKG9iamVjdFtrZXldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNwbGljZShzb3VyY2UsIGtleXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICgha2V5cykgcmV0dXJuIGV4dGVuZChyZXN1bHQsIHNvdXJjZSk7CiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107ICkgaWYgKGtleSBpbiBzb3VyY2UpIHsKICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgZGVsZXRlIHNvdXJjZVtrZXldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gbWVyZ2UoKSB7CiAgICByZXR1cm4gYXJyYXlGcm9tKGFyZ3VtZW50cykucmVkdWNlKGV4dGVuZCwge30pOwogIH0KICBmdW5jdGlvbiBpdGVyYXRlKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwga2V5LCBvYmplY3Rba2V5XSkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gJHVuZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGRlZmluZWQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc051bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzTm90TnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgdmFsdWUgIT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNTYW1lKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRoaXM7CiAgfQogIGZ1bmN0aW9uICRpc05vdFNhbWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gdGhpczsKICB9CiAgZnVuY3Rpb24gJHNlbGYodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gJGNvbnN0KHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgfQogIGZ1bmN0aW9uICRmYWxzZSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gJHRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gJG51bGwoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gJHVuZGVmKCkge30KICB2YXIgZ2V0dGVyID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kaWZpY2F0b3JTZWVkID0gMTsKICAgIHZhciBzaW1wbGVQYXRoID0gL15bYS16JF9dW2EteiRfMC05XSooXC5bYS16JF9dW2EteiRfMC05XSopKiQvaTsKICAgIHZhciBnZXR0ZXJNYXAgPSBbXTsKICAgIHZhciBwYXRoQ2FjaGUgPSB7fTsKICAgIHZhciBtb2RDYWNoZSA9IHt9OwogICAgZnVuY3Rpb24gYnVpbGRGdW5jdGlvbihwYXRoKSB7CiAgICAgIGlmIChzaW1wbGVQYXRoLnRlc3QocGF0aCkpIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgICAgICAgdmFyIGZvbyA9IHBhcnRzWzBdOwogICAgICAgIHZhciBiYXIgPSBwYXJ0c1sxXTsKICAgICAgICB2YXIgYmF6ID0gcGFydHNbMl07CiAgICAgICAgdmFyIGZuOwogICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0W2Zvb10gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl1bYmF6XSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIGlmIChvYmplY3QgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2Zvb11bYmFyXVtiYXpdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDMsIGtleTsga2V5ID0gcGFydHNbaV07IGkrKykgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZuID0gRnVuY3Rpb24oInBhcnRzIiwgInJldHVybiAiICsgZm4udG9TdHJpbmcoKS5yZXBsYWNlKC8oZm9vfGJhcnxiYXopL2csIGZ1bmN0aW9uKG0sIHcpIHsKICAgICAgICAgIHJldHVybiAnIicgKyBwYXJ0c1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgICAgfSkucmVwbGFjZSgvXFtcIihbXiJdKylcIlxdL2csICIuJDEiKSkocGFydHMpOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJvYmplY3QiLCAicmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0LiIgKyBwYXRoICsgIiA6IG9iamVjdCIpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHBhdGgsIG1vZGlmaWNhdG9yKSB7CiAgICAgIHZhciBmdW5jOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgZ2V0dGVySWQ7CiAgICAgIGlmICghcGF0aCB8fCBwYXRoID09PSBudWxsR2V0dGVyKSByZXR1cm4gbnVsbEdldHRlcjsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBnZXR0ZXJJZCA9IHBhdGguYmFzaXNHZXR0ZXJJZF87CiAgICAgICAgaWYgKGdldHRlcklkKSB7CiAgICAgICAgICBmdW5jID0gZ2V0dGVyTWFwW01hdGguYWJzKGdldHRlcklkKSAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoKG9iamVjdCk7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBwYXRoLmJhc2lzR2V0dGVySWRfID0gLWdldHRlcklkOwogICAgICAgICAgZnVuYy5iYXNpc0dldHRlcklkXyA9IGdldHRlcklkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmdW5jID0gcGF0aENhY2hlW3BhdGhdOwogICAgICAgIGlmIChmdW5jKSB7CiAgICAgICAgICBnZXR0ZXJJZCA9IGZ1bmMuYmFzaXNHZXR0ZXJJZF87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZ1bmMgPSBidWlsZEZ1bmN0aW9uKHBhdGgpOwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBmdW5jLmJhc2lzR2V0dGVySWRfID0gZ2V0dGVySWQ7CiAgICAgICAgICBwYXRoQ2FjaGVbcGF0aF0gPSBmdW5jOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgbW9kVHlwZSA9IG1vZGlmaWNhdG9yICE9IG51bGwgJiYgdHlwZW9mIG1vZGlmaWNhdG9yOwogICAgICBpZiAoIW1vZFR5cGUpIHJldHVybiBmdW5jOwogICAgICB2YXIgbW9kTGlzdCA9IG1vZENhY2hlW2dldHRlcklkXTsKICAgICAgdmFyIG1vZElkOwogICAgICBpZiAobW9kVHlwZSA9PSAic3RyaW5nIikgbW9kSWQgPSBtb2RUeXBlICsgbW9kaWZpY2F0b3I7IGVsc2UgaWYgKG1vZFR5cGUgPT0gImZ1bmN0aW9uIikgbW9kSWQgPSBtb2RpZmljYXRvci5iYXNpc01vZElkXzsgZWxzZSBpZiAobW9kVHlwZSAhPSAib2JqZWN0IikgewogICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLmdldHRlcjogd3JvbmcgbW9kaWZpY2F0b3IgdHlwZSwgbW9kaWZpY2F0b3Igbm90IHVzZWQsIHBhdGg6ICIsIHBhdGgsICIsIG1vZGlmaWNhdG9yOiIsIG1vZGlmaWNhdG9yKTsKICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgfQogICAgICBpZiAobW9kSWQgJiYgbW9kTGlzdCAmJiBtb2RMaXN0W21vZElkXSkgcmV0dXJuIG1vZExpc3RbbW9kSWRdOwogICAgICBpZiAodHlwZW9mIGZ1bmMuYmFzZSA9PSAiZnVuY3Rpb24iKSBmdW5jID0gZnVuYy5iYXNlOwogICAgICBzd2l0Y2ggKG1vZFR5cGUpIHsKICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmdfZXh0ZW5zaW9ucy5mb3JtYXQobW9kaWZpY2F0b3IsIGZ1bmMob2JqZWN0KSk7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKCFtb2RJZCkgewogICAgICAgICAgICBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvclNlZWQrKzsKICAgICAgICAgICAgbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF8gPSBtb2RJZDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3IoZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcltmdW5jKG9iamVjdCldOwogICAgICAgICAgfTsKICAgICAgfQogICAgICByZXN1bHQuYmFzZSA9IGZ1bmMuYmFzZSB8fCBmdW5jOwogICAgICByZXN1bHQuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgaWYgKG1vZElkKSB7CiAgICAgICAgaWYgKCFtb2RMaXN0KSB7CiAgICAgICAgICBtb2RMaXN0ID0ge307CiAgICAgICAgICBtb2RDYWNoZVtnZXR0ZXJJZF0gPSBtb2RMaXN0OwogICAgICAgIH0KICAgICAgICBtb2RMaXN0W21vZElkXSA9IHJlc3VsdDsKICAgICAgICByZXN1bHQubW9kID0gbW9kaWZpY2F0b3I7CiAgICAgICAgcmVzdWx0LmJhc2lzR2V0dGVySWRfID0gZ2V0dGVyTWFwLnB1c2gocmVzdWx0KTsKICAgICAgfSBlbHNlIHt9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0oKTsKICB2YXIgbnVsbEdldHRlciA9IGV4dGVuZChmdW5jdGlvbigpIHt9LCB7CiAgICBfX2V4dGVuZF9fOiBnZXR0ZXIKICB9KTsKICBmdW5jdGlvbiB3cmFwcGVyKGtleSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGxhenlJbml0KGluaXQsIHRoaXNPYmplY3QpIHsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGluaXRlZCsrKSkgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhID0gaW5pdC5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICJ1bmRlZmluZWQiKSBjb25zb2xlTWV0aG9kcy53YXJuKCJsYXp5SW5pdCBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4iICsgaW5pdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KICBmdW5jdGlvbiBsYXp5SW5pdEFuZFJ1bihpbml0LCBydW4sIHRoaXNPYmplY3QpIHsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGluaXRlZCsrKSkgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhID0gaW5pdC5jYWxsKHRoaXNPYmplY3QgfHwgdGhpcyk7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICJ1bmRlZmluZWQiKSBjb25zb2xlTWV0aG9kcy53YXJuKCJsYXp5SW5pdEFuZFJ1biBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4iICsgaW5pdCk7CiAgICAgIH0KICAgICAgcnVuLmFwcGx5KGRhdGEsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CiAgZnVuY3Rpb24gcnVuT25jZShydW4sIHRoaXNPYmplY3QpIHsKICAgIHZhciBmaXJlZCA9IDA7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGZpcmVkKyspKSByZXR1cm4gcnVuLmFwcGx5KHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIHZhciBjb25zb2xlTWV0aG9kcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGxvZzogJHVuZGVmLAogICAgICBpbmZvOiAkdW5kZWYsCiAgICAgIHdhcm46ICR1bmRlZiwKICAgICAgZXJyb3I6ICR1bmRlZgogICAgfTsKICAgIGlmICh0eXBlb2YgY29uc29sZSAhPSAidW5kZWZpbmVkIikgaXRlcmF0ZShtZXRob2RzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIG1ldGhvZHNbbWV0aG9kTmFtZV0gPSAiYmluZCIgaW4gRnVuY3Rpb24ucHJvdG90eXBlICYmIHR5cGVvZiBjb25zb2xlW21ldGhvZE5hbWVdID09ICJmdW5jdGlvbiIgPyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUpIDogZnVuY3Rpb24oKSB7CiAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVttZXRob2ROYW1lXSwgY29uc29sZSwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIG1ldGhvZHM7CiAgfSgpOwogIHZhciBzZXRJbW1lZGlhdGUgPSBnbG9iYWwuc2V0SW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKICB2YXIgY2xlYXJJbW1lZGlhdGUgPSBnbG9iYWwuY2xlYXJJbW1lZGlhdGUgfHwgZ2xvYmFsLm1zU2V0SW1tZWRpYXRlOwogIGlmIChzZXRJbW1lZGlhdGUpIHNldEltbWVkaWF0ZSA9IHNldEltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CiAgaWYgKGNsZWFySW1tZWRpYXRlKSBjbGVhckltbWVkaWF0ZSA9IGNsZWFySW1tZWRpYXRlLmJpbmQoZ2xvYmFsKTsKICBpZiAoIXNldEltbWVkaWF0ZSkgKGZ1bmN0aW9uKCkgewogICAgdmFyIE1FU1NBR0VfTkFNRSA9ICJiYXNpc2pzLnNldEltbWVkaWF0ZSI7CiAgICB2YXIgcnVuVGFzayA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFza0J5SWQgPSB7fTsKICAgICAgdmFyIHRhc2tJZCA9IDE7CiAgICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRhc2tCeUlkWysrdGFza0lkXSA9IHsKICAgICAgICAgIGZuOiBhcmd1bWVudHNbMF0sCiAgICAgICAgICBhcmdzOiBhcnJheUZyb20oYXJndW1lbnRzLCAxKQogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgIHJldHVybiB0YXNrSWQ7CiAgICAgIH07CiAgICAgIGNsZWFySW1tZWRpYXRlID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oaWQpIHsKICAgICAgICB2YXIgdGFzayA9IHRhc2tCeUlkW2lkXTsKICAgICAgICBpZiAodGFzaykgewogICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICAgIGlmICh0eXBlb2YgdGFzay5mbiA9PSAiZnVuY3Rpb24iKSB0YXNrLmZuLmFwcGx5KHVuZGVmaW5lZCwgdGFzay5hcmdzKTsgZWxzZSB7CiAgICAgICAgICAgIChnbG9iYWwuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgIGdsb2JhbFsiZXZhbCJdLmNhbGwoZ2xvYmFsLCBmbik7CiAgICAgICAgICAgIH0pKFN0cmluZyh0YXNrLmZuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSgpOwogICAgdmFyIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgIH0sIDApOwogICAgfTsKICAgIGlmIChnbG9iYWwucHJvY2VzcyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgaWYgKGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCkgewogICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IGdsb2JhbC5NZXNzYWdlQ2hhbm5lbDsKICAgICAgICAgIHZhciBzZXRJbW1lZGlhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgIH07CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHNldEltbWVkaWF0ZUhhbmRsZXI7CiAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKCIiKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGdsb2JhbC5wb3N0TWVzc2FnZSAmJiAhZ2xvYmFsLmltcG9ydFNjcmlwdHM7CiAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKSB7CiAgICAgICAgICB2YXIgb2xkT25NZXNzYWdlID0gZ2xvYmFsLm9ubWVzc2FnZTsKICAgICAgICAgIGdsb2JhbC5vbm1lc3NhZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9zdE1lc3NhZ2VTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoIiIsICIqIik7CiAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gb2xkT25NZXNzYWdlOwogICAgICAgIH0KICAgICAgICBpZiAocG9zdE1lc3NhZ2VTdXBwb3J0ZWQpIHsKICAgICAgICAgIHZhciBzZXRJbW1lZGlhdGVIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnNvdXJjZSA9PSBnbG9iYWwpIHsKICAgICAgICAgICAgICB2YXIgdGFza0lkID0gU3RyaW5nKGV2ZW50LmRhdGEpLnNwbGl0KE1FU1NBR0VfTkFNRSlbMV07CiAgICAgICAgICAgICAgaWYgKHRhc2tJZCkgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIHNldEltbWVkaWF0ZUhhbmRsZXIsIHRydWUpOyBlbHNlIGdsb2JhbC5hdHRhY2hFdmVudCgib25tZXNzYWdlIiwgc2V0SW1tZWRpYXRlSGFuZGxlcik7CiAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICAgIGdsb2JhbC5wb3N0TWVzc2FnZShNRVNTQUdFX05BTUUgKyB0YXNrSWQsICIqIik7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3JlYXRlU2NyaXB0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZG9jdW1lbnQgJiYgIm9ucmVhZHlzdGF0ZWNoYW5nZSIgaW4gY3JlYXRlU2NyaXB0KCkpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRBZGRUb1F1ZXVlID0gYWRkVG9RdWV1ZTsKICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uIGJlZm9yZUhlYWRSZWFkeSh0YXNrSWQpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50SW50ZXJmYWNlICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZGVmYXVsdEFkZFRvUXVldWU7CiAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNjcmlwdEVsID0gY3JlYXRlU2NyaXB0KCk7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYWRkVG9RdWV1ZSA9PT0gYmVmb3JlSGVhZFJlYWR5KSBkZWZhdWx0QWRkVG9RdWV1ZSh0YXNrSWQpOyBlbHNlIGFkZFRvUXVldWUodGFza0lkKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KSgpOwogIHZhciBOT0RFX0VOViA9IHR5cGVvZiBwcm9jZXNzID09ICJvYmplY3QiICYmIE9iamVjdF90b1N0cmluZy5jYWxsKHByb2Nlc3MpID09ICJbb2JqZWN0IHByb2Nlc3NdIjsKICB2YXIgcGF0aFV0aWxzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgQUJTT0xVVEVfUlggPSAvXihbXlwvXSs6fFwvKS87CiAgICB2YXIgUFJPVE9DT0xfUlggPSAvXlthLXpBLVowLTlcLV0rOlwvPy87CiAgICB2YXIgT1JJR0lOX1JYID0gL14oPzpbYS16QS1aMC05XC1dKzopP1wvXC9bXlwvXStcLz8vOwogICAgdmFyIFNFQVJDSF9IQVNIX1JYID0gL1tcPyNdLiokLzsKICAgIHZhciB1dGlscyA9IHt9OwogICAgdmFyIG9yaWdpbiA9ICIiOwogICAgdmFyIGJhc2VVUkk7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIHBhdGggPSByZXF1aXJlKCJwYXRoIikucmVzb2x2ZSgiLiIpLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgIGJhc2VVUkkgPSBwYXRoLnJlcGxhY2UoL15bXlwvXSovLCAiIik7CiAgICAgIG9yaWdpbiA9IHBhdGgucmVwbGFjZSgvXC8uKi8sICIiKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVUkkgPSBsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSskLywgIiIpOwogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0OwogICAgfQogICAgdXRpbHMgPSB7CiAgICAgIGJhc2VVUkk6IGJhc2VVUkksCiAgICAgIG9yaWdpbjogb3JpZ2luLAogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICBwYXRoID0gKHBhdGggfHwgIiIpLnJlcGxhY2UoUFJPVE9DT0xfUlgsICIvIikucmVwbGFjZShPUklHSU5fUlgsICIvIikucmVwbGFjZShTRUFSQ0hfSEFTSF9SWCwgIiIpOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHBhcnRzW2ldID09ICIuLiIpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxIHx8IHJlc3VsdFswXSkgcmVzdWx0LnBvcCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChwYXJ0c1tpXSB8fCAhaSkgJiYgcGFydHNbaV0gIT0gIi4iKSByZXN1bHQucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQuam9pbigiLyIpIHx8IChwYXRoWzBdID09PSAiLyIgPyAiLyIgOiAiIik7CiAgICAgIH0sCiAgICAgIGRpcm5hbWU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdXRpbHMubm9ybWFsaXplKHBhdGgpOwogICAgICAgIHJldHVybiByZXN1bHQucmVwbGFjZSgvXC8oW15cL10qKSR8XlteXC9dKyQvLCAiIikgfHwgKHJlc3VsdFswXSA9PSAiLyIgPyAiLyIgOiAiLiIpOwogICAgICB9LAogICAgICBleHRuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIGV4dCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cL10oXC5bXlwvXC5dKikkLyk7CiAgICAgICAgcmV0dXJuIGV4dCA/IGV4dFsxXSA6ICIiOwogICAgICB9LAogICAgICBiYXNlbmFtZTogZnVuY3Rpb24ocGF0aCwgZXh0KSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gdXRpbHMubm9ybWFsaXplKHBhdGgpLm1hdGNoKC9bXlxcXC9dKiQvKTsKICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lID8gZmlsZW5hbWVbMF0gOiAiIjsKICAgICAgICBpZiAoZXh0ID09IHV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygwLCBmaWxlbmFtZS5sZW5ndGggLSBleHQubGVuZ3RoKTsKICAgICAgICByZXR1cm4gZmlsZW5hbWU7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcnJheUZyb20oYXJndW1lbnRzKS5yZXZlcnNlKCk7CiAgICAgICAgdmFyIHBhdGggPSBbXTsKICAgICAgICB2YXIgYWJzb2x1dGVGb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGkgPSAwOyAhYWJzb2x1dGVGb3VuZCAmJiBpIDwgYXJncy5sZW5ndGg7IGkrKykgaWYgKHR5cGVvZiBhcmdzW2ldID09ICJzdHJpbmciKSB7CiAgICAgICAgICBwYXRoLnVuc2hpZnQoYXJnc1tpXSk7CiAgICAgICAgICBhYnNvbHV0ZUZvdW5kID0gQUJTT0xVVEVfUlgudGVzdChhcmdzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhYnNvbHV0ZUZvdW5kKSBwYXRoLnVuc2hpZnQoYmFzZVVSSSA9PSAiLyIgPyAiIiA6IGJhc2VVUkkpOwogICAgICAgIHJldHVybiB1dGlscy5ub3JtYWxpemUocGF0aC5qb2luKCIvIikpOwogICAgICB9LAogICAgICByZWxhdGl2ZTogZnVuY3Rpb24oZnJvbSwgdG8pIHsKICAgICAgICBpZiAodHlwZW9mIHRvICE9ICJzdHJpbmciKSB7CiAgICAgICAgICB0byA9IGZyb207CiAgICAgICAgICBmcm9tID0gYmFzZVVSSTsKICAgICAgICB9CiAgICAgICAgZnJvbSA9IHV0aWxzLm5vcm1hbGl6ZShmcm9tKTsKICAgICAgICB0byA9IHV0aWxzLm5vcm1hbGl6ZSh0byk7CiAgICAgICAgaWYgKGZyb21bMF0gPT0gIi8iICYmIHRvWzBdICE9ICIvIikgcmV0dXJuIGZyb207CiAgICAgICAgaWYgKHRvWzBdID09ICIvIiAmJiBmcm9tWzBdICE9ICIvIikgcmV0dXJuIHRvOwogICAgICAgIHZhciBiYXNlID0gZnJvbS5yZXBsYWNlKC9eXC8kLywgIiIpLnNwbGl0KC9cLy8pOwogICAgICAgIHZhciBwYXRoID0gdG8ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIHdoaWxlIChwYXRoW2ldID09IGJhc2VbaV0gJiYgdHlwZW9mIGJhc2VbaV0gPT0gInN0cmluZyIpIGkrKzsKICAgICAgICBmb3IgKHZhciBqID0gYmFzZS5sZW5ndGggLSBpOyBqID4gMDsgai0tKSByZXN1bHQucHVzaCgiLi4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChwYXRoLnNsaWNlKGkpLmZpbHRlcihCb29sZWFuKSkuam9pbigiLyIpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHV0aWxzOwogIH0oKTsKICB2YXIgYmFzaXNGaWxlbmFtZSA9ICIiOwogIHZhciBjb25maWcgPSB7CiAgICBwYXRoOiB7CiAgICAgIGJhc2lzOiAiIiwKICAgICAgYXBwOiAiIiwKICAgICAgY29yZTogIiIsCiAgICAgIGVzcHJpbWE6ICIiLAogICAgICBkaWZmOiAiIgogICAgfSwKICAgIGV4dFByb3RvOiBmYWxzZSwKICAgIGV4cG9ydHM6IHRydWUsCiAgICBhdXRvbG9hZDogIi4vMC5qcyIKICB9OwogIHZhciBDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlU2VlZCA9IHsKICAgICAgaWQ6IDEKICAgIH07CiAgICB2YXIgY2xhc3NTZWVkID0gMTsKICAgIHZhciBjbGFzc2VzID0gW107CiAgICB2YXIgU0VMRiA9IHt9OwogICAgZnVuY3Rpb24gaXNDbGFzcyhvYmplY3QpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT0gImZ1bmN0aW9uIiAmJiAhIW9iamVjdC5iYXNpc0NsYXNzSWRfOwogICAgfQogICAgZnVuY3Rpb24gaXNTdWJjbGFzc09mKHN1cGVyQ2xhc3MpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgJiYgY3Vyc29yICE9PSBzdXBlckNsYXNzKSBjdXJzb3IgPSBjdXJzb3Iuc3VwZXJDbGFzc187CiAgICAgIHJldHVybiBjdXJzb3IgPT09IHN1cGVyQ2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBkZXZfdmVyYm9zZU5hbWVXcmFwKG5hbWUsIGFyZ3MsIGZuKSB7CiAgICAgIHJldHVybiAobmV3IEZ1bmN0aW9uKGtleXMoYXJncyksICdyZXR1cm4geyInICsgbmFtZSArICciOiAnICsgZm4gKyAnXG59WyInICsgbmFtZSArICciXScpKS5hcHBseShudWxsLCB2YWx1ZXMoYXJncykpOwogICAgfQogICAgdmFyIFRPU1RSSU5HX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gewogICAgICAgIHRvU3RyaW5nOiAxCiAgICAgIH0pIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjcmVhdGVDbGFzcyhTdXBlckNsYXNzLCBleHRlbnNpb25zKSB7CiAgICAgIHZhciBjbGFzc0lkID0gY2xhc3NTZWVkKys7CiAgICAgIGlmICh0eXBlb2YgU3VwZXJDbGFzcyAhPSAiZnVuY3Rpb24iKSBTdXBlckNsYXNzID0gQmFzZUNsYXNzOwogICAgICB2YXIgY2xhc3NOYW1lID0gIiI7CiAgICAgIGZvciAodmFyIGkgPSAxLCBleHRlbnNpb247IGV4dGVuc2lvbiA9IGFyZ3VtZW50c1tpXTsgaSsrKSBpZiAodHlwZW9mIGV4dGVuc2lvbiAhPSAiZnVuY3Rpb24iICYmIGV4dGVuc2lvbi5jbGFzc05hbWUpIGNsYXNzTmFtZSA9IGV4dGVuc2lvbi5jbGFzc05hbWU7CiAgICAgIGlmICghY2xhc3NOYW1lKSBjbGFzc05hbWUgPSBTdXBlckNsYXNzLmNsYXNzTmFtZSArICIuX0NsYXNzIiArIGNsYXNzSWQ7CiAgICAgIHZhciBOZXdDbGFzc1Byb3RvID0gZnVuY3Rpb24oKSB7fTsKICAgICAgTmV3Q2xhc3NQcm90byA9IGRldl92ZXJib3NlTmFtZVdyYXAoY2xhc3NOYW1lLCB7fSwgTmV3Q2xhc3NQcm90byk7CiAgICAgIE5ld0NsYXNzUHJvdG8ucHJvdG90eXBlID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CiAgICAgIHZhciBuZXdQcm90byA9IG5ldyBOZXdDbGFzc1Byb3RvOwogICAgICB2YXIgbmV3Q2xhc3NQcm9wcyA9IHsKICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZSwKICAgICAgICBiYXNpc0NsYXNzSWRfOiBjbGFzc0lkLAogICAgICAgIHN1cGVyQ2xhc3NfOiBTdXBlckNsYXNzLAogICAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogISFTdXBlckNsYXNzLmV4dGVuZENvbnN0cnVjdG9yXywKICAgICAgICBpc1N1YmNsYXNzT2Y6IGlzU3ViY2xhc3NPZiwKICAgICAgICBzdWJjbGFzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3MuYXBwbHkobnVsbCwgWyBuZXdDbGFzcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSkpOwogICAgICAgIH0sCiAgICAgICAgZXh0ZW5kOiBleHRlbmRDbGFzcywKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSBTRUxGICYmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3ModmFsdWUpKSkgcmV0dXJuIEJhc2VDbGFzcy5jcmVhdGUuY2FsbChudWxsLCBuZXdDbGFzcywgdmFsdWUpOyBlbHNlIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIHByb3RvdHlwZTogbmV3UHJvdG8KICAgICAgfTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIG5ld0NsYXNzUHJvcHMuZXh0ZW5kKGV4dGVuc2lvbik7CiAgICAgIGlmIChuZXdQcm90by5pbml0ICE9PSBCYXNlQ2xhc3MucHJvdG90eXBlLmluaXQgJiYgIS9eZnVuY3Rpb25bXihdKlwoXCkvLnRlc3QobmV3UHJvdG8uaW5pdCkgJiYgbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8pIGNvbnNvbGVNZXRob2RzLndhcm4oInByb2JhYmx5IHdyb25nIGV4dGVuZENvbnN0cnVjdG9yXyB2YWx1ZSBmb3IgIiArIG5ld0NsYXNzUHJvcHMuY2xhc3NOYW1lKTsKICAgICAgdmFyIG5ld0NsYXNzID0gbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8gPyBmdW5jdGlvbihleHRlbmQpIHsKICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKICAgICAgICB2YXIgcHJvcDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5kKSB7CiAgICAgICAgICBwcm9wID0gdGhpc1trZXldOwogICAgICAgICAgdGhpc1trZXldID0gcHJvcCAmJiBwcm9wLl9fZXh0ZW5kX18gPyBwcm9wLl9fZXh0ZW5kX18oZXh0ZW5kW2tleV0pIDogZXh0ZW5kW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfTsKICAgICAgbmV3Q2xhc3MgPSBkZXZfdmVyYm9zZU5hbWVXcmFwKGNsYXNzTmFtZSwgewogICAgICAgIGluc3RhbmNlU2VlZDogaW5zdGFuY2VTZWVkCiAgICAgIH0sIG5ld0NsYXNzKTsKICAgICAgbmV3UHJvdG8uY29uc3RydWN0b3IgPSBuZXdDbGFzczsKICAgICAgZm9yICh2YXIga2V5IGluIG5ld1Byb3RvKSBpZiAobmV3UHJvdG9ba2V5XSA9PT0gU0VMRikgbmV3UHJvdG9ba2V5XSA9IG5ld0NsYXNzOwogICAgICBleHRlbmQobmV3Q2xhc3MsIG5ld0NsYXNzUHJvcHMpOwogICAgICBjbGFzc2VzLnB1c2gobmV3Q2xhc3MpOwogICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRDbGFzcyhzb3VyY2UpIHsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3Moc291cmNlKSkgc291cmNlID0gc291cmNlKHRoaXMuc3VwZXJDbGFzc18ucHJvdG90eXBlKTsKICAgICAgaWYgKHNvdXJjZS5wcm90b3R5cGUpIHNvdXJjZSA9IHNvdXJjZS5wcm90b3R5cGU7CiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB2YXIgcHJvdG9WYWx1ZSA9IHByb3RvW2tleV07CiAgICAgICAgaWYgKGtleSA9PSAiY2xhc3NOYW1lIiB8fCBrZXkgPT0gImV4dGVuZENvbnN0cnVjdG9yXyIpIHRoaXNba2V5XSA9IHZhbHVlOyBlbHNlIHsKICAgICAgICAgIGlmIChwcm90b1ZhbHVlICYmIHByb3RvVmFsdWUuX19leHRlbmRfXykgcHJvdG9ba2V5XSA9IHByb3RvVmFsdWUuX19leHRlbmRfXyh2YWx1ZSk7IGVsc2UgewogICAgICAgICAgICBwcm90b1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChUT1NUUklOR19CVUcgJiYgc291cmNlW2tleSA9ICJ0b1N0cmluZyJdICE9PSBPYmplY3RfdG9TdHJpbmcpIHByb3RvW2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB2YXIgQmFzZUNsYXNzID0gZXh0ZW5kKGNyZWF0ZUNsYXNzLCB7CiAgICAgIGNsYXNzTmFtZTogImJhc2lzLkNsYXNzIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiBmYWxzZSwKICAgICAgcHJvdG90eXBlOiB7CiAgICAgICAgYmFzaXNPYmplY3RJZDogMCwKICAgICAgICBjb25zdHJ1Y3RvcjogbnVsbCwKICAgICAgICBpbml0OiBmdW5jdGlvbigpIHt9LAogICAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHt9LAogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAiW29iamVjdCAiICsgKHRoaXMuY29uc3RydWN0b3IgfHwgdGhpcykuY2xhc3NOYW1lICsgIl0iOwogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3ApKSB0aGlzW3Byb3BdID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVzdHJveSA9ICR1bmRlZjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGN1c3RvbUV4dGVuZFByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uLCBmbiwgZGV2TmFtZSkgewogICAgICByZXR1cm4gewogICAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICAgICAgaWYgKCFleHRlbnNpb24pIHJldHVybiBleHRlbnNpb247CiAgICAgICAgICBpZiAoZXh0ZW5zaW9uICYmIGV4dGVuc2lvbi5fX2V4dGVuZF9fKSByZXR1cm4gZXh0ZW5zaW9uOwogICAgICAgICAgdmFyIEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICAgICAgICAgQmFzZSA9IGRldl92ZXJib3NlTmFtZVdyYXAoZGV2TmFtZSB8fCAiY3VzdG9tRXh0ZW5kUHJvcGVydHkiLCB7fSwgQmFzZSk7CiAgICAgICAgICBCYXNlLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEJhc2U7CiAgICAgICAgICBmbihyZXN1bHQsIGV4dGVuc2lvbik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfS5fX2V4dGVuZF9fKGV4dGVuc2lvbiB8fCB7fSk7CiAgICB9OwogICAgdmFyIGV4dGVuc2libGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBleHRlbmQsICJleHRlbnNpYmxlUHJvcGVydHkiKTsKICAgIH07CiAgICB2YXIgbmVzdGVkRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgcmV0dXJuIGN1c3RvbUV4dGVuZFByb3BlcnR5KGV4dGVuc2lvbiwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbnNpb24pIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5zaW9uKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSByZXN1bHRba2V5XTsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUgJiYgdmFsdWUuX19leHRlbmRfXyA/IHZhbHVlLl9fZXh0ZW5kX18oZXh0ZW5zaW9uW2tleV0pIDogZXh0ZW5zaWJsZVByb3BlcnR5KGV4dGVuc2lvbltrZXldKTsKICAgICAgICB9CiAgICAgIH0sICJuZXN0ZWRFeHRlbmRQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBvbmVGdW5jdGlvblByb3BlcnR5ID0gZnVuY3Rpb24oZm4sIGtleXMpIHsKICAgICAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlCiAgICAgICAgfTsKICAgICAgICBpZiAoa2V5cykgewogICAgICAgICAgaWYgKGtleXMuX19leHRlbmRfXykgcmV0dXJuIGtleXM7CiAgICAgICAgICB2YXIgQ2xzID0gZGV2X3ZlcmJvc2VOYW1lV3JhcCgib25lRnVuY3Rpb25Qcm9wZXJ0eSIsIHt9LCBmdW5jdGlvbigpIHt9KTsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDbHM7CiAgICAgICAgICByZXN1bHQuX19leHRlbmRfXyA9IGNyZWF0ZTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSBpZiAoa2V5c1trZXldKSByZXN1bHRba2V5XSA9IGZuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlKGtleXMgfHwge30pOwogICAgfTsKICAgIHJldHVybiBleHRlbmQoQmFzZUNsYXNzLCB7CiAgICAgIGFsbF86IGNsYXNzZXMsCiAgICAgIFNFTEY6IFNFTEYsCiAgICAgIGNyZWF0ZTogY3JlYXRlQ2xhc3MsCiAgICAgIGlzQ2xhc3M6IGlzQ2xhc3MsCiAgICAgIGN1c3RvbUV4dGVuZFByb3BlcnR5OiBjdXN0b21FeHRlbmRQcm9wZXJ0eSwKICAgICAgZXh0ZW5zaWJsZVByb3BlcnR5OiBleHRlbnNpYmxlUHJvcGVydHksCiAgICAgIG5lc3RlZEV4dGVuZFByb3BlcnR5OiBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSwKICAgICAgb25lRnVuY3Rpb25Qcm9wZXJ0eTogb25lRnVuY3Rpb25Qcm9wZXJ0eQogICAgfSk7CiAgfSgpOwogIHZhciBUb2tlbiA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLlRva2VuIiwKICAgIHZhbHVlOiBudWxsLAogICAgaGFuZGxlcjogbnVsbCwKICAgIGRlZmVycmVkVG9rZW46IG51bGwsCiAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmRldGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgIHJldHVybiBob3N0LmdldCgpOwogICAgICB9CiAgICB9LAogICAgaW5pdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgfQogICAgfSwKICAgIGF0dGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2F0dGFjaDogZHVwbGljYXRlIGZuICYgY29udGV4dCBwYWlyIik7CiAgICAgIHRoaXMuaGFuZGxlciA9IHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgfTsKICAgIH0sCiAgICBkZXRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB2YXIgcHJldjsKICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBpZiAoY3Vyc29yLmZuID09PSBmbiAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgIGN1cnNvci5mbiA9ICR1bmRlZjsKICAgICAgICBwcmV2LmhhbmRsZXIgPSBjdXJzb3IuaGFuZGxlcjsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuVG9rZW4jZGV0YWNoOiBmbiAmIGNvbnRleHQgcGFpciBub3QgZm91bmQsIG5vdGhpbmcgd2FzIHJlbW92ZWQiKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGN1cnNvci5mbi5jYWxsKGN1cnNvci5jb250ZXh0LCB2YWx1ZSk7CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW47CiAgICAgIGlmICghdG9rZW4pIHsKICAgICAgICB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbiA9IG5ldyBEZWZlcnJlZFRva2VuKHRoaXMudmFsdWUpOwogICAgICAgIHRoaXMuYXR0YWNoKHRva2VuLnNldCwgdG9rZW4pOwogICAgICB9CiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuZGVmZXJyZWRUb2tlbikgewogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbi5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuID0gbnVsbDsKICAgICAgfQogICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5hdHRhY2ggPSAkdW5kZWY7CiAgICAgIHRoaXMuZGV0YWNoID0gJHVuZGVmOwogICAgfQogIH0pOwogIHZhciBhd2FpdFRvQXBwbHkgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbnMgPSB7fTsKICAgIHZhciB0aW1lcjsKICAgIGZ1bmN0aW9uIGFwcGx5VG9rZW5zKCkgewogICAgICB2YXIgbGlzdCA9IHRva2VuczsKICAgICAgdG9rZW5zID0ge307CiAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgZm9yICh2YXIga2V5IGluIGxpc3QpIGxpc3Rba2V5XS5hcHBseSgpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgIGlmICh0b2tlbi5iYXNpc09iamVjdElkIGluIHRva2VucykgcmV0dXJuOwogICAgICB0b2tlbnNbdG9rZW4uYmFzaXNPYmplY3RJZF0gPSB0b2tlbjsKICAgICAgaWYgKCF0aW1lcikgc2V0SW1tZWRpYXRlKGFwcGx5VG9rZW5zKTsKICAgIH07CiAgfSgpOwogIHZhciBEZWZlcnJlZFRva2VuID0gVG9rZW4uc3ViY2xhc3MoewogICAgY2xhc3NOYW1lOiAiYmFzaXMuRGVmZXJyZWRUb2tlbiIsCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBhd2FpdFRvQXBwbHkodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICBkZWZlcnJlZDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIHZhciByZXNvdXJjZXMgPSB7fTsKICB2YXIgcmVzb3VyY2VDb250ZW50Q2FjaGUgPSB7fTsKICB2YXIgcmVzb3VyY2VQYXRjaCA9IHt9OwogIHZhciByZXNvdXJjZVJlc29sdmluZ1N0YWNrID0gW107CiAgdmFyIHJlcXVpcmVzOwogIChmdW5jdGlvbigpIHsKICAgIHZhciBtYXAgPSB0eXBlb2YgX19yZXNvdXJjZXNfXyAhPSAidW5kZWZpbmVkIiA/IF9fcmVzb3VyY2VzX18gOiBudWxsOwogICAgaWYgKG1hcCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKSByZXNvdXJjZUNvbnRlbnRDYWNoZVtwYXRoVXRpbHMucmVzb2x2ZShrZXkpXSA9IG1hcFtrZXldOwogICAgICBfX3Jlc291cmNlc19fID0gbnVsbDsKICAgIH0KICB9KSgpOwogIGZ1bmN0aW9uIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKSB7CiAgICB2YXIgcGF0Y2hlcyA9IHJlc291cmNlUGF0Y2hbcmVzb3VyY2UudXJsXTsKICAgIGlmIChwYXRjaGVzKSBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc29sZU1ldGhvZHMuaW5mbygiQXBwbHkgcGF0Y2ggZm9yICIgKyByZXNvdXJjZS51cmwpOwogICAgICBwYXRjaGVzW2ldKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogICAgfQogIH0KICB2YXIgZ2V0UmVzb3VyY2VDb250ZW50ID0gZnVuY3Rpb24odXJsLCBpZ25vcmVDYWNoZSkgewogICAgaWYgKGlnbm9yZUNhY2hlIHx8ICFyZXNvdXJjZUNvbnRlbnRDYWNoZS5oYXNPd25Qcm9wZXJ0eSh1cmwpKSB7CiAgICAgIHZhciByZXNvdXJjZUNvbnRlbnQgPSAiIjsKICAgICAgaWYgKCFOT0RFX0VOVikgewogICAgICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICAgICAgcmVxLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIChuZXcgRGF0ZSgwKSkudG9HTVRTdHJpbmcoKSk7CiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoIlgtQmFzaXMtUmVzb3VyY2UiLCAxKTsKICAgICAgICByZXEuc2VuZCgiIik7CiAgICAgICAgaWYgKHJlcS5zdGF0dXMgPj0gMjAwICYmIHJlcS5zdGF0dXMgPCA0MDApIHJlc291cmNlQ29udGVudCA9IHJlcS5yZXNwb25zZVRleHQ7IGVsc2UgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsICsgIiAoc3RhdHVzIGNvZGUgIiArIHJlcS5zdGF0dXMgKyAiKSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcmVxdWlyZSgiZnMiKS5yZWFkRmlsZVN5bmModXJsLCAidXRmLTgiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMucmVzb3VyY2U6IFVuYWJsZSB0byBsb2FkICIgKyB1cmwsIGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdID0gcmVzb3VyY2VDb250ZW50OwogICAgfQogICAgcmV0dXJuIHJlc291cmNlQ29udGVudENhY2hlW3VybF07CiAgfTsKICB2YXIgZ2V0UmVzb3VyY2UgPSBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZSgnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwogICAgaWYgKCFyZXNvdXJjZXNbcmVzb3VyY2VVcmxdKSB7CiAgICAgIHZhciBjb250ZW50V3JhcHBlciA9IGdldFJlc291cmNlLmV4dGVuc2lvbnNbcGF0aFV0aWxzLmV4dG5hbWUocmVzb3VyY2VVcmwpXTsKICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CiAgICAgIHZhciB3cmFwcGVkID0gZmFsc2U7CiAgICAgIHZhciBjb250ZW50OwogICAgICB2YXIgd3JhcHBlZENvbnRlbnQ7CiAgICAgIHZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHVybENvbnRlbnQgPSBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpOwogICAgICAgIHZhciBpZHggPSByZXNvdXJjZVJlc29sdmluZ1N0YWNrLmluZGV4T2YocmVzb3VyY2VVcmwpOwogICAgICAgIGlmIChpZHggIT0gLTEpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnJlc291cmNlIHJlY3Vyc2lvbjoiLCByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnNsaWNlKGlkeCkuY29uY2F0KHJlc291cmNlVXJsKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlLCBwYXRoVXRpbHMpLmpvaW4oIiAtPiAiKSk7CiAgICAgICAgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wdXNoKHJlc291cmNlVXJsKTsKICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgIGlmICghd3JhcHBlZCkgewogICAgICAgICAgICB3cmFwcGVkID0gdHJ1ZTsKICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKHVybENvbnRlbnQsIHJlc291cmNlVXJsKTsKICAgICAgICAgICAgd3JhcHBlZENvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250ZW50ID0gdXJsQ29udGVudDsKICAgICAgICB9CiAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgIHJlc291cmNlUmVzb2x2aW5nU3RhY2sucG9wKCk7CiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICAgIH07CiAgICAgIGV4dGVuZChyZXNvdXJjZSwgZXh0ZW5kKG5ldyBUb2tlbiwgewogICAgICAgIHVybDogcmVzb3VyY2VVcmwsCiAgICAgICAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlKCk7CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltiYXNpcy5yZXNvdXJjZSAiICsgcmVzb3VyY2VVcmwgKyAiXSI7CiAgICAgICAgfSwKICAgICAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9LAogICAgICAgIGhhc0NoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdICE9PSB3cmFwcGVkQ29udGVudCA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihuZXdDb250ZW50KSB7CiAgICAgICAgICBuZXdDb250ZW50ID0gU3RyaW5nKG5ld0NvbnRlbnQpOwogICAgICAgICAgaWYgKCFyZXNvbHZlZCB8fCBuZXdDb250ZW50ICE9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSkgewogICAgICAgICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gPSBuZXdDb250ZW50OwogICAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgICAgICBpZiAod3JhcHBlZCAmJiAhY29udGVudFdyYXBwZXIucGVybWFuZW50KSB7CiAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIobmV3Q29udGVudCwgcmVzb3VyY2VVcmwpOwogICAgICAgICAgICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG9sZENvbnRlbnQgPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF07CiAgICAgICAgICB2YXIgbmV3Q29udGVudCA9IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCwgdHJ1ZSk7CiAgICAgICAgICBpZiAobmV3Q29udGVudCAhPSBvbGRDb250ZW50KSB7CiAgICAgICAgICAgIHJlc29sdmVkID0gZmFsc2U7CiAgICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShuZXdDb250ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICByZXR1cm4gc291cmNlID8gZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsKSA6IHJlc291cmNlKCk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgICBmbi5jYWxsKGNvbnRleHQsIHJlc291cmNlKCkpOwogICAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIgJiYgY29udGVudFdyYXBwZXIucGVybWFuZW50KSByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXNvdXJjZS5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICAgIH0KICAgICAgfSkpOwogICAgICByZXNvdXJjZXNbcmVzb3VyY2VVcmxdID0gcmVzb3VyY2U7CiAgICB9CiAgICByZXR1cm4gcmVzb3VyY2VzW3Jlc291cmNlVXJsXTsKICB9OwogIGV4dGVuZChnZXRSZXNvdXJjZSwgewogICAgaXNSZXNvdXJjZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gcmVzb3VyY2VzW3ZhbHVlLnVybF0gPT09IHZhbHVlIDogZmFsc2U7CiAgICB9LAogICAgaXNSZXNvbHZlZDogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KHJlc291cmNlVXJsKTsKICAgICAgcmV0dXJuIHJlc291cmNlID8gcmVzb3VyY2UuaXNSZXNvbHZlZCgpIDogZmFsc2U7CiAgICB9LAogICAgZXhpc3RzOiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlLmV4aXN0cygnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIHJlc291cmNlcy5oYXNPd25Qcm9wZXJ0eShwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCkpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZS5nZXQoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwogICAgICBpZiAoIWdldFJlc291cmNlLmV4aXN0cyhyZXNvdXJjZVVybCkpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gZ2V0UmVzb3VyY2UocmVzb3VyY2VVcmwpOwogICAgfSwKICAgIGdldEZpbGVzOiBmdW5jdGlvbihjYWNoZSkgewogICAgICByZXR1cm4ga2V5cyhjYWNoZSA/IHJlc291cmNlQ29udGVudENhY2hlIDogcmVzb3VyY2VzKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlKTsKICAgIH0sCiAgICBleHRlbnNpb25zOiB7CiAgICAgICIuanMiOiBleHRlbmQoZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXTsKICAgICAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGltcGxpY2l0TmFtZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgIG5hbWVzcGFjZSA9IHBhdGhVdGlscy5kaXJuYW1lKGZpbGVuYW1lKSArICIvIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKTsKICAgICAgICAgIGZvciAodmFyIG5zIGluIGNvbmZpZy5wYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gY29uZmlnLnBhdGhbbnNdICsgbnMgKyAiLyI7CiAgICAgICAgICAgIGlmIChmaWxlbmFtZS5zdWJzdHIoMCwgcGF0aC5sZW5ndGgpID09IHBhdGgpIHsKICAgICAgICAgICAgICBpbXBsaWNpdE5hbWVzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZS5zdWJzdHIoY29uZmlnLnBhdGhbbnNdLmxlbmd0aCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZS5yZXBsYWNlKC9cLi9nLCAiXyIpLnJlcGxhY2UoL15cLy9nLCAiIikucmVwbGFjZSgvXC8vZywgIi4iKTsKICAgICAgICAgIGlmIChpbXBsaWNpdE5hbWVzcGFjZSkgbmFtZXNwYWNlID0gImltcGxpY2l0LiIgKyBuYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIGlmIChyZXF1aXJlcykgQXJyYXlfZXh0ZW5zaW9ucy5hZGQocmVxdWlyZXMsIG5hbWVzcGFjZSk7CiAgICAgICAgaWYgKCFuYW1lc3BhY2VzW25hbWVzcGFjZV0pIHsKICAgICAgICAgIHZhciBucyA9IGdldE5hbWVzcGFjZShuYW1lc3BhY2UpOwogICAgICAgICAgdmFyIHNhdmVkUmVxdWlyZXMgPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gW107CiAgICAgICAgICBucy5leHBvcnRzID0gcnVuU2NyaXB0SW5Db250ZXh0KHsKICAgICAgICAgICAgcGF0aDogbnMucGF0aCwKICAgICAgICAgICAgZXhwb3J0czogbnMuZXhwb3J0cwogICAgICAgICAgfSwgZmlsZW5hbWUsIGNvbnRlbnQpLmV4cG9ydHM7CiAgICAgICAgICBpZiAobnMuZXhwb3J0cyAmJiBucy5leHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5zLCBucy5leHBvcnRzKTsKICAgICAgICAgIG5zLmZpbGVuYW1lXyA9IGZpbGVuYW1lOwogICAgICAgICAgbnMuc291cmNlXyA9IGNvbnRlbnQ7CiAgICAgICAgICBucy5yZXF1aXJlc18gPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gc2F2ZWRSZXF1aXJlczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5hbWVzcGFjZXNbbmFtZXNwYWNlXS5leHBvcnRzOwogICAgICB9LCB7CiAgICAgICAgcGVybWFuZW50OiB0cnVlCiAgICAgIH0pLAogICAgICAiLmNzcyI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIHZhciByZXNvdXJjZSA9IENzc1Jlc291cmNlLnJlc291cmNlc1t1cmxdOwogICAgICAgIGlmICghcmVzb3VyY2UpIHJlc291cmNlID0gbmV3IENzc1Jlc291cmNlKHVybCk7IGVsc2UgcmVzb3VyY2UudXBkYXRlQ3NzVGV4dChjb250ZW50KTsKICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgIH0sCiAgICAgICIuanNvbiI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PSAib2JqZWN0IikgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgY29udGVudCA9IFN0cmluZyhjb250ZW50KTsKICAgICAgICAgIHJlc3VsdCA9IGJhc2lzLmpzb24ucGFyc2UoY29udGVudCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2U6IENhbid0IHBhcnNlIEpTT04gZnJvbSAiICsgdXJsLCB7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKHNvdXJjZVVSTCwgYXJncywgYm9keSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihhcmdzLCBib2R5ICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICJsaW5lIiBpbiBlID09IGZhbHNlICYmICJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIHsKICAgICAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBmdW5jdGlvbiBvbmVycm9yKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQuZmlsZW5hbWUgPT0gcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCkgewogICAgICAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBvbmVycm9yKTsKICAgICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoIkNvbXBpbGF0aW9uIGVycm9yIGF0ICIgKyBldmVudC5maWxlbmFtZSArICI6IiArIGV2ZW50LmxpbmVubyArICI6ICIgKyBlKTsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IHNvdXJjZVVSTDsKICAgICAgICBzY3JpcHQuYXN5bmMgPSBmYWxzZTsKICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgc291cmNlVVJMICsgKCJsaW5lIiBpbiBlID8gIjoiICsgKGUubGluZSAtIDEpIDogIiIpICsgIjogIiArIGUpOwogICAgfQogIH0KICB2YXIgcnVuU2NyaXB0SW5Db250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCwgc291cmNlVVJMLCBzb3VyY2VDb2RlKSB7CiAgICB2YXIgYmFzZVVSTCA9IHBhdGhVdGlscy5kaXJuYW1lKHNvdXJjZVVSTCkgKyAiLyI7CiAgICB2YXIgY29tcGlsZWRTb3VyY2VDb2RlID0gc291cmNlQ29kZTsKICAgIGlmICghY29udGV4dC5leHBvcnRzKSBjb250ZXh0LmV4cG9ydHMgPSB7fTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlICE9ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZSA9IGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIFsgImV4cG9ydHMiLCAibW9kdWxlIiwgImJhc2lzIiwgImdsb2JhbCIsICJfX2ZpbGVuYW1lIiwgIl9fZGlybmFtZSIsICJyZXNvdXJjZSIsICJyZXF1aXJlIiBdLCAnInVzZSBzdHJpY3QiO1xuJyArIHNvdXJjZUNvZGUpOwogICAgaWYgKHR5cGVvZiBjb21waWxlZFNvdXJjZUNvZGUgPT0gImZ1bmN0aW9uIikgY29tcGlsZWRTb3VyY2VDb2RlLmNhbGwoY29udGV4dC5leHBvcnRzLCBjb250ZXh0LmV4cG9ydHMsIGNvbnRleHQsIGJhc2lzLCBnbG9iYWwsIHNvdXJjZVVSTCwgYmFzZVVSTCwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZWxhdGl2ZVBhdGgpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IHJlc291cmNlKCciICsgcmVsYXRpdmVQYXRoICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHBhdGhVdGlscy5yZXNvbHZlKGJhc2VVUkwsIHJlbGF0aXZlUGF0aCkpOwogICAgfSwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoLCBiYXNlKSB7CiAgICAgIHJldHVybiByZXF1aXJlTmFtZXNwYWNlKHJlbGF0aXZlUGF0aCwgYmFzZSB8fCBiYXNlVVJMKTsKICAgIH0pOwogICAgcmV0dXJuIGNvbnRleHQ7CiAgfTsKICB2YXIgbmFtZXNwYWNlcyA9IHt9OwogIHZhciBuYW1lc3BhY2UyZmlsZW5hbWUgPSB7fTsKICB2YXIgZmlsZW5hbWUybmFtZXNwYWNlID0ge307CiAgdmFyIG5zUm9vdFBhdGggPSBzbGljZShjb25maWcucGF0aCk7CiAgKGZ1bmN0aW9uKG1hcCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX25hbWVzcGFjZV9tYXBfXyAhPSAidW5kZWZpbmVkIiA/IF9fbmFtZXNwYWNlX21hcF9fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGtleSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IG1hcFtrZXldOwogICAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV0gPSBmaWxlbmFtZTsKICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5hbWVzcGFjZSA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLk5hbWVzcGFjZSIsCiAgICBpbml0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZXhwb3J0cyA9IHsKICAgICAgICBwYXRoOiB0aGlzLm5hbWUKICAgICAgfTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAiW2Jhc2lzLm5hbWVzcGFjZSAiICsgdGhpcy5wYXRoICsgIl0iOwogICAgfSwKICAgIGV4dGVuZDogZnVuY3Rpb24obmFtZXMpIHsKICAgICAgZXh0ZW5kKHRoaXMuZXhwb3J0cywgbmFtZXMpOwogICAgICByZXR1cm4gY29tcGxldGUodGhpcywgbmFtZXMpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHJlc29sdmVOU0ZpbGVuYW1lKG5hbWVzcGFjZSkgewogICAgdmFyIG5hbWVzcGFjZVJvb3QgPSBuYW1lc3BhY2Uuc3BsaXQoIi4iKVswXTsKICAgIHZhciBmaWxlbmFtZSA9IG5hbWVzcGFjZS5yZXBsYWNlKC9cLi9nLCAiLyIpICsgIi5qcyI7CiAgICBpZiAobmFtZXNwYWNlIGluIG5hbWVzcGFjZTJmaWxlbmFtZSA9PSBmYWxzZSkgewogICAgICBpZiAobmFtZXNwYWNlUm9vdCBpbiBuc1Jvb3RQYXRoID09IGZhbHNlKSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdID0gcGF0aFV0aWxzLmJhc2VVUkk7CiAgICAgIGlmIChuYW1lc3BhY2VSb290ID09IG5hbWVzcGFjZSkgZmlsZW5hbWUybmFtZXNwYWNlW25zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gKyBmaWxlbmFtZV0gPSBuYW1lc3BhY2VSb290OwogICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gKyBmaWxlbmFtZTsKICAgIH0KICAgIHJldHVybiBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXTsKICB9CiAgZnVuY3Rpb24gZ2V0Um9vdE5hbWVzcGFjZShuYW1lKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXTsKICAgIGlmICghbmFtZXNwYWNlKSB7CiAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZXNbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5hbWUpOwogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc18gPSB7fTsKICAgICAgbmFtZXNwYWNlLm5hbWVzcGFjZXNfW25hbWVdID0gbmFtZXNwYWNlOwogICAgICBpZiAoIWNvbmZpZy5ub0NvbmZsaWN0KSBnbG9iYWxbbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CiAgICByZXR1cm4gbmFtZXNwYWNlOwogIH0KICBmdW5jdGlvbiBnZXROYW1lc3BhY2UocGF0aCkgewogICAgcGF0aCA9IHBhdGguc3BsaXQoIi4iKTsKICAgIHZhciByb290TnMgPSBnZXRSb290TmFtZXNwYWNlKHBhdGhbMF0pOwogICAgdmFyIGN1cnNvciA9IHJvb3ROczsKICAgIGZvciAodmFyIGkgPSAxLCBuYW1lOyBuYW1lID0gcGF0aFtpXTsgaSsrKSB7CiAgICAgIGlmICghY3Vyc29yW25hbWVdKSB7CiAgICAgICAgdmFyIG5zcGF0aCA9IHBhdGguc2xpY2UoMCwgaSArIDEpLmpvaW4oIi4iKTsKICAgICAgICBjdXJzb3JbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5zcGF0aCk7CiAgICAgICAgcm9vdE5zLm5hbWVzcGFjZXNfW25zcGF0aF0gPSBjdXJzb3JbbmFtZV07CiAgICAgIH0KICAgICAgY3Vyc29yID0gY3Vyc29yW25hbWVdOwogICAgfQogICAgbmFtZXNwYWNlc1twYXRoLmpvaW4oIi4iKV0gPSBjdXJzb3I7CiAgICByZXR1cm4gY3Vyc29yOwogIH0KICB2YXIgcmVxdWlyZU5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKE5PREVfRU5WKSB7CiAgICAgIHZhciBtb2R1bGVQcm90byA9IG1vZHVsZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpIHx8IHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSA9PSAiLmpzIikgewogICAgICAgICAgdmFyIF9jb21waWxlID0gbW9kdWxlUHJvdG8uX2NvbXBpbGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0TmFtZXNwYWNlKGZpbGVuYW1lKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNpcyA9IGJhc2lzOwogICAgICAgICAgICBjb250ZW50ID0gInZhciBub2RlX3JlcXVpcmUgPSByZXF1aXJlO1xuIiArICJ2YXIgYmFzaXMgPSBtb2R1bGUuYmFzaXM7XG4iICsgJ3ZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKXsgcmV0dXJuIGJhc2lzLnJlc291cmNlKF9fZGlybmFtZSArICIvIiArIGZpbGVuYW1lKSB9O1xuJyArICJ2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBiYXNlVVJJKXsgcmV0dXJuIGJhc2lzLnJlcXVpcmUoZmlsZW5hbWUsIGJhc2VVUkkgfHwgX19kaXJuYW1lKSB9O1xuIiArIGNvbnRlbnQ7CiAgICAgICAgICAgIF9jb21waWxlLmNhbGwoZXh0ZW5kKHRoaXMsIG5hbWVzcGFjZSksIGNvbnRlbnQsIGZpbGVuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXhwb3J0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIi8iKSk7CiAgICAgICAgICBuYW1lc3BhY2UuZXhwb3J0cyA9IGV4cG9ydHM7CiAgICAgICAgICBpZiAoZXhwb3J0cyAmJiBleHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5hbWVzcGFjZSwgZXhwb3J0cyk7CiAgICAgICAgICBtb2R1bGVQcm90by5fY29tcGlsZSA9IF9jb21waWxlOwogICAgICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogcmVxdWlyZSgnIiArIGZpbGVuYW1lICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2UoZmlsZW5hbWUpLmZldGNoKCk7CiAgICAgIH07CiAgICB9CiAgfSgpOwogIGZ1bmN0aW9uIHBhdGNoKGZpbGVuYW1lLCBwYXRjaEZuKSB7CiAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gIi5qcyIpIHsKICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZmlsZW5hbWUpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnBhdGNoKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgIH0KICAgIGlmICghcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0pIHJlc291cmNlUGF0Y2hbZmlsZW5hbWVdID0gWyBwYXRjaEZuIF07IGVsc2UgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0ucHVzaChwYXRjaEZuKTsKICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChmaWxlbmFtZSk7CiAgICBpZiAocmVzb3VyY2UgJiYgcmVzb3VyY2UuaXNSZXNvbHZlZCgpKSBwYXRjaEZuKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogIH0KICBmdW5jdGlvbiBleHRlbmRQcm90byhjbHMsIGV4dGVuc2lvbnMpIHsKICAgIGlmIChjb25maWcuZXh0UHJvdG8pIGZvciAodmFyIGtleSBpbiBleHRlbnNpb25zKSBjbHMucHJvdG90eXBlW2tleV0gPSBmdW5jdGlvbihtZXRob2QsIGNsc05hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjb25maWcuZXh0UHJvdG8gPT0gIndhcm4iKSBjb25zb2xlTWV0aG9kcy53YXJuKGNsc05hbWUgKyAiIyIgKyBtZXRob2QgKyAiIGlzIG5vdCBhIHN0YW5kYXJkIG1ldGhvZCBhbmQgd2lsbCBiZSByZW1vdmVkIHNvb247IHVzZSBiYXNpcy4iICsgY2xzTmFtZS50b0xvd2VyQ2FzZSgpICsgIi4iICsgbWV0aG9kICsgIiBpbnN0ZWFkIik7CiAgICAgICAgdmFyIGFyZ3MgPSBbIHRoaXMgXTsKICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBleHRlbnNpb25zW21ldGhvZF0uYXBwbHkoZXh0ZW5zaW9ucywgYXJncyk7CiAgICAgIH07CiAgICB9KGtleSwgY2xzLm5hbWUgfHwgY2xzLnRvU3RyaW5nKCkubWF0Y2goL15ccypmdW5jdGlvblxzKihcdyopXHMqXCgvKVsxXSk7CiAgfQogIGNvbXBsZXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgYmluZDogZnVuY3Rpb24odGhpc09iamVjdCkgewogICAgICB2YXIgZm4gPSB0aGlzOwogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBwYXJhbXMubGVuZ3RoID8gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNPYmplY3QsIHBhcmFtcy5jb25jYXQuYXBwbHkocGFyYW1zLCBhcmd1bWVudHMpKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0pOwogIGNvbXBsZXRlKEFycmF5LCB7CiAgICBpc0FycmF5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gT2JqZWN0X3RvU3RyaW5nLmNhbGwodmFsdWUpID09PSAiW29iamVjdCBBcnJheV0iOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIGFycmF5RnJvbShvYmplY3QsIG9mZnNldCkgewogICAgaWYgKG9iamVjdCAhPSBudWxsKSB7CiAgICAgIHZhciBsZW4gPSBvYmplY3QubGVuZ3RoOwogICAgICBpZiAodHlwZW9mIGxlbiA9PSAidW5kZWZpbmVkIiB8fCBPYmplY3RfdG9TdHJpbmcuY2FsbChvYmplY3QpID09ICJbb2JqZWN0IEZ1bmN0aW9uXSIpIHJldHVybiBbIG9iamVjdCBdOwogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMDsKICAgICAgaWYgKGxlbiAtIG9mZnNldCA+IDApIHsKICAgICAgICBmb3IgKHZhciByZXN1bHQgPSBbXSwgayA9IDAsIGkgPSBvZmZzZXQ7IGkgPCBsZW47ICkgcmVzdWx0W2srK10gPSBvYmplY3RbaSsrXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW107CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUFycmF5KGxlbmd0aCwgZmlsbFZhbHVlLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICB2YXIgaXNGdW5jID0gdHlwZW9mIGZpbGxWYWx1ZSA9PSAiZnVuY3Rpb24iOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgcmVzdWx0W2ldID0gaXNGdW5jID8gZmlsbFZhbHVlLmNhbGwodGhpc09iamVjdCwgaSwgcmVzdWx0KSA6IGZpbGxWYWx1ZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGNvbXBsZXRlKEFycmF5LnByb3RvdHlwZSwgewogICAgaW5kZXhPZjogZnVuY3Rpb24oc2VhcmNoRWxlbWVudCwgb2Zmc2V0KSB7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApIHx8IDA7CiAgICAgIGlmIChvZmZzZXQgPCAwKSByZXR1cm4gLTE7CiAgICAgIGZvciAoOyBvZmZzZXQgPCB0aGlzLmxlbmd0aDsgb2Zmc2V0KyspIGlmICh0aGlzW29mZnNldF0gPT09IHNlYXJjaEVsZW1lbnQpIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBsYXN0SW5kZXhPZjogZnVuY3Rpb24oc2VhcmNoRWxlbWVudCwgb2Zmc2V0KSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCk7CiAgICAgIGlmIChpc05hTihvZmZzZXQpIHx8IG9mZnNldCA+PSBsZW4pIG9mZnNldCA9IGxlbiAtIDE7IGVsc2Ugb2Zmc2V0ID0gKG9mZnNldCArIGxlbikgJSBsZW47CiAgICAgIGZvciAoOyBvZmZzZXQgPj0gMDsgb2Zmc2V0LS0pIGlmICh0aGlzW29mZnNldF0gPT09IHNlYXJjaEVsZW1lbnQpIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBmb3JFYWNoOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgIH0sCiAgICBldmVyeTogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgIWNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgc29tZTogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0LnB1c2godGhpc1tpXSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSByZXN1bHRbaV0gPSBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIHJlZHVjZTogZnVuY3Rpb24oY2FsbGJhY2ssIGluaXRpYWxWYWx1ZSkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIHZhciBhcmdzTGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgaWYgKGxlbiA9PSAwICYmIGFyZ3NMZW4gPT0gMSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgdmFyIGluaXRlZCA9IDA7CiAgICAgIGlmIChhcmdzTGVuID4gMSkgewogICAgICAgIHJlc3VsdCA9IGluaXRpYWxWYWx1ZTsKICAgICAgICBpbml0ZWQgPSAxOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIGlmIChpbml0ZWQrKykgcmVzdWx0ID0gY2FsbGJhY2suY2FsbChudWxsLCByZXN1bHQsIHRoaXNbaV0sIGksIHRoaXMpOyBlbHNlIHJlc3VsdCA9IHRoaXNbaV07CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfSk7CiAgdmFyIEFycmF5X2V4dGVuc2lvbnMgPSB7CiAgICBmbGF0dGVuOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY29uY2F0LmFwcGx5KFtdLCB0aGlzXyk7CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIEFycmF5X2V4dGVuc2lvbnMuZmxhdHRlbihjcmVhdGVBcnJheShwYXJzZUludChjb3VudCwgMTApIHx8IDAsIHRoaXNfKSk7CiAgICB9LAogICAgc2VhcmNoOiBmdW5jdGlvbih0aGlzXywgdmFsdWUsIGdldHRlcl8sIG9mZnNldCkgewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKICAgICAgZm9yICh2YXIgaW5kZXggPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwLCBsZW4gPSB0aGlzXy5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKSBpZiAoZ2V0dGVyXyh0aGlzX1tpbmRleF0pID09PSB2YWx1ZSkgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGluZGV4XTsKICAgIH0sCiAgICBsYXN0U2VhcmNoOiBmdW5jdGlvbih0aGlzXywgdmFsdWUsIGdldHRlcl8sIG9mZnNldCkgewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKICAgICAgdmFyIGxlbiA9IHRoaXNfLmxlbmd0aDsKICAgICAgdmFyIGluZGV4ID0gaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPT0gbnVsbCA/IGxlbiA6IHBhcnNlSW50KG9mZnNldCwgMTApOwogICAgICBmb3IgKHZhciBpID0gaW5kZXggPiBsZW4gPyBsZW4gOiBpbmRleDsgaS0tID4gMDsgKSBpZiAoZ2V0dGVyXyh0aGlzX1tpXSkgPT09IHZhbHVlKSByZXR1cm4gdGhpc19bdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gaV07CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpID09IC0xICYmICEhdGhpc18ucHVzaCh2YWx1ZSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgdmFyIGluZGV4ID0gdGhpc18uaW5kZXhPZih2YWx1ZSk7CiAgICAgIHJldHVybiBpbmRleCAhPSAtMSAmJiAhIXRoaXNfLnNwbGljZShpbmRleCwgMSk7CiAgICB9LAogICAgaGFzOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpICE9IC0xOwogICAgfSwKICAgIHNvcnRBc09iamVjdDogZnVuY3Rpb24odGhpc18sIGdldHRlcl8sIGNvbXBhcmF0b3IsIGRlc2MpIHsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfKTsKICAgICAgZGVzYyA9IGRlc2MgPyAtMSA6IDE7CiAgICAgIHJldHVybiB0aGlzXy5tYXAoZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgaTogaW5kZXgsCiAgICAgICAgICB2OiBnZXR0ZXJfKGl0ZW0pCiAgICAgICAgfTsKICAgICAgfSkuc29ydChjb21wYXJhdG9yIHx8IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gZGVzYyAqIChhLnYgPiBiLnYgfHwgLShhLnYgPCBiLnYpIHx8IChhLmkgPiBiLmkgPyAxIDogLTEpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gdGhpc19baXRlbS5pXTsKICAgICAgfSwgdGhpc18pOwogICAgfQogIH07CiAgZXh0ZW5kUHJvdG8oQXJyYXksIEFycmF5X2V4dGVuc2lvbnMpOwogIGlmICghWyAxLCAyIF0uc3BsaWNlKDEpLmxlbmd0aCkgewogICAgdmFyIG5hdGl2ZUFycmF5U3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDIpIHBhcmFtc1sxXSA9IHRoaXMubGVuZ3RoOwogICAgICByZXR1cm4gbmF0aXZlQXJyYXlTcGxpY2UuYXBwbHkodGhpcywgcGFyYW1zKTsKICAgIH07CiAgfQogIHZhciBFU0NBUEVfRk9SX1JFR0VYUCA9IC8oW1wvXFxcKFwpXFtcXVw/XHtcfVx8XCpcK1wtXC5cXlwkXSkvZzsKICB2YXIgRk9STUFUX1JFR0VYUCA9IC9ceyhbYS16XGRfXSspKD86OihbXC4wXSkoXGQrKXw6KFw/KSk/XH0vZ2k7CiAgZnVuY3Rpb24gaXNFbXB0eVN0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgU3RyaW5nKHZhbHVlKSA9PSAiIjsKICB9CiAgZnVuY3Rpb24gaXNOb3RFbXB0eVN0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgU3RyaW5nKHZhbHVlKSAhPSAiIjsKICB9CiAgY29tcGxldGUoU3RyaW5nLCB7CiAgICB0b0xvd2VyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICB0b1VwcGVyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltKCk7CiAgICB9LAogICAgdHJpbUxlZnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1MZWZ0KCk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShTdHJpbmcucHJvdG90eXBlLCB7CiAgICB0cmltTGVmdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcGxhY2UoL15ccysvLCAiIik7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sICIiKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudHJpbUxlZnQoKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICB2YXIgU3RyaW5nX2V4dGVuc2lvbnMgPSB7CiAgICB0b09iamVjdDogZnVuY3Rpb24odGhpc18sIHJldGhyb3cpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuIDAsIiArIHRoaXNfKSkoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChyZXRocm93KSB0aHJvdyBlOwogICAgICB9CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIChuZXcgQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSArIDEgfHwgMCkpLmpvaW4odGhpc18pOwogICAgfSwKICAgIHF3OiBmdW5jdGlvbih0aGlzXykgewogICAgICB2YXIgdHJpbW1lZCA9IHRoaXNfLnRyaW0oKTsKICAgICAgcmV0dXJuIHRyaW1tZWQgPyB0cmltbWVkLnNwbGl0KC9ccysvKSA6IFtdOwogICAgfSwKICAgIGZvclJlZ0V4cDogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRVNDQVBFX0ZPUl9SRUdFWFAsICJcXCQxIik7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgZmlyc3QpIHsKICAgICAgdmFyIGRhdGEgPSBhcnJheUZyb20oYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKHR5cGVvZiBmaXJzdCA9PSAib2JqZWN0IikgZXh0ZW5kKGRhdGEsIGZpcnN0KTsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRk9STUFUX1JFR0VYUCwgZnVuY3Rpb24obSwga2V5LCBudW1Gb3JtYXQsIG51bSwgbm9OdWxsKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga2V5IGluIGRhdGEgPyBkYXRhW2tleV0gOiBub051bGwgPyAiIiA6IG07CiAgICAgICAgaWYgKG51bUZvcm1hdCAmJiAhaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICByZXR1cm4gbnVtRm9ybWF0ID09ICIuIiA/IHZhbHVlLnRvRml4ZWQobnVtKSA6IE51bWJlcl9leHRlbnNpb25zLmxlYWQodmFsdWUsIG51bSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSk7CiAgICB9LAogICAgY2FwaXRhbGl6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGhpc18uc3Vic3RyKDEpLnRvTG93ZXJDYXNlKCk7CiAgICB9LAogICAgY2FtZWxpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC8tKC4pL2csIGZ1bmN0aW9uKG0sIGNocikgewogICAgICAgIHJldHVybiBjaHIudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAogICAgZGFzaGVyaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obSkgewogICAgICAgIHJldHVybiAiLSIgKyBtLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfQogIH07CiAgZXh0ZW5kUHJvdG8oU3RyaW5nLCBTdHJpbmdfZXh0ZW5zaW9ucyk7CiAgaWYgKCJ8fHwiLnNwbGl0KC9cfC8pLmxlbmd0aCArICJ8fHwiLnNwbGl0KC8oXHwpLykubGVuZ3RoICE9IDExKSB7CiAgICB2YXIgbmF0aXZlU3RyaW5nU3BsaXQgPSBTdHJpbmcucHJvdG90eXBlLnNwbGl0OwogICAgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCA9IGZ1bmN0aW9uKHBhdHRlcm4sIGNvdW50KSB7CiAgICAgIGlmICghcGF0dGVybiB8fCBwYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwID09IGZhbHNlIHx8IHBhdHRlcm4uc291cmNlID09ICIiKSByZXR1cm4gbmF0aXZlU3RyaW5nU3BsaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG1hdGNoOwogICAgICBpZiAoIXBhdHRlcm4uZ2xvYmFsKSBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnNvdXJjZSwgL1wvKFttaV0qKSQvLmV4ZWMocGF0dGVybilbMV0gKyAiZyIpOwogICAgICB3aGlsZSAobWF0Y2ggPSBwYXR0ZXJuLmV4ZWModGhpcykpIHsKICAgICAgICBtYXRjaFswXSA9IHRoaXMuc3Vic3RyaW5nKHBvcywgbWF0Y2guaW5kZXgpOwogICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgbWF0Y2gpOwogICAgICAgIHBvcyA9IHBhdHRlcm4ubGFzdEluZGV4OwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3Vic3RyKHBvcykpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgaWYgKCIxMiIuc3Vic3RyKC0xKSAhPSAiMiIpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTdWJzdHIgPSBTdHJpbmcucHJvdG90eXBlLnN1YnN0cjsKICAgIFN0cmluZy5wcm90b3R5cGUuc3Vic3RyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbmF0aXZlU3RyaW5nU3Vic3RyLmNhbGwodGhpcywgc3RhcnQgPCAwID8gTWF0aC5tYXgoMCwgdGhpcy5sZW5ndGggKyBzdGFydCkgOiBzdGFydCwgZW5kKTsKICAgIH07CiAgfQogIHZhciBOdW1iZXJfZXh0ZW5zaW9ucyA9IHsKICAgIGZpdDogZnVuY3Rpb24odGhpc18sIG1pbiwgbWF4KSB7CiAgICAgIGlmICghaXNOYU4obWluKSAmJiB0aGlzXyA8IG1pbikgcmV0dXJuIE51bWJlcihtaW4pOwogICAgICBpZiAoIWlzTmFOKG1heCkgJiYgdGhpc18gPiBtYXgpIHJldHVybiBOdW1iZXIobWF4KTsKICAgICAgcmV0dXJuIHRoaXNfOwogICAgfSwKICAgIGxlYWQ6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIGxlYWRDaGFyKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiAobGVuIC09IG51bWJlci5sZW5ndGggLSAxKSA+IDEgPyAobmV3IEFycmF5KGxlbikpLmpvaW4obGVhZENoYXIgfHwgMCkgKyBudW1iZXIgOiBudW1iZXI7CiAgICAgIH0pOwogICAgfSwKICAgIGdyb3VwOiBmdW5jdGlvbih0aGlzXywgbGVuLCBzcGxpdHRlcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyLnJlcGxhY2UoL1xkL2csIGZ1bmN0aW9uKG0sIHBvcykgewogICAgICAgICAgcmV0dXJuICFwb3MgKyAobnVtYmVyLmxlbmd0aCAtIHBvcykgJSAobGVuIHx8IDMpID8gbSA6IChzcGxpdHRlciB8fCAiICIpICsgbTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgcHJlYywgZ3MsIHByZWZpeCwgcG9zdGZpeCwgY29tbWEpIHsKICAgICAgdmFyIHJlcyA9IHRoaXNfLnRvRml4ZWQocHJlYyk7CiAgICAgIGlmIChncyB8fCBjb21tYSkgcmVzID0gcmVzLnJlcGxhY2UoLyhcZCspKFwuPykvLCBmdW5jdGlvbihtLCBudW1iZXIsIGMpIHsKICAgICAgICByZXR1cm4gKGdzID8gYmFzaXMubnVtYmVyLmdyb3VwKE51bWJlcihudW1iZXIpLCAzLCBncykgOiBudW1iZXIpICsgKGMgPyBjb21tYSB8fCBjIDogIiIpOwogICAgICB9KTsKICAgICAgaWYgKHByZWZpeCkgcmVzID0gcmVzLnJlcGxhY2UoL14tPy8sICIkJiIgKyAocHJlZml4IHx8ICIiKSk7CiAgICAgIHJldHVybiByZXMgKyAocG9zdGZpeCB8fCAiIik7CiAgICB9CiAgfTsKICBleHRlbmRQcm90byhOdW1iZXIsIE51bWJlcl9leHRlbnNpb25zKTsKICBjb21wbGV0ZShEYXRlLCB7CiAgICBub3c6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gTnVtYmVyKG5ldyBEYXRlKTsKICAgIH0KICB9KTsKICB2YXIgcmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIGlzUmVhZHkoKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgJiYgISFkb2N1bWVudC5ib2R5OwogICAgfQogICAgdmFyIGZpcmVkID0gIWRvY3VtZW50IHx8IGlzUmVhZHkoKTsKICAgIHZhciBkZWZlcnJlZEhhbmRsZXI7CiAgICBmdW5jdGlvbiBydW5SZWFkeUhhbmRsZXIoaGFuZGxlcikgewogICAgICBoYW5kbGVyLmNhbGxiYWNrLmNhbGwoaGFuZGxlci5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVIYW5kbGVycygpIHsKICAgICAgaWYgKGlzUmVhZHkoKSkgaWYgKCEoZmlyZWQrKykpIHdoaWxlIChkZWZlcnJlZEhhbmRsZXIpIHsKICAgICAgICBydW5SZWFkeUhhbmRsZXIoZGVmZXJyZWRIYW5kbGVyKTsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSBkZWZlcnJlZEhhbmRsZXIubmV4dDsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICBmaXJlSGFuZGxlcnMoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghZmlyZWQpIHsKICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmaXJlSGFuZGxlcnMsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZmlyZUhhbmRsZXJzKTsKICAgICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZ2xvYmFsLmZyYW1lRWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwpIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGRlZmVycmVkSGFuZGxlciA9IHsKICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBuZXh0OiBkZWZlcnJlZEhhbmRsZXIKICAgICAgICB9OwogICAgICB9IGVsc2UgcnVuUmVhZHlIYW5kbGVyKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgIH07CiAgfSgpOwogIHZhciBkb2N1bWVudEludGVyZmFjZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRpbWVyOwogICAgdmFyIHJlZmVyZW5jZSA9IHt9OwogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaGVhZDogW10sCiAgICAgIGJvZHk6IFtdCiAgICB9OwogICAgZnVuY3Rpb24gZ2V0UGFyZW50KG5hbWUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICFyZWZlcmVuY2VbbmFtZV0pIHsKICAgICAgICByZWZlcmVuY2VbbmFtZV0gPSBkb2N1bWVudFtuYW1lXSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKVswXTsKICAgICAgICBpZiAocmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNiOyBjYiA9IGl0ZW1zW2ldOyBpKyspIGNiWzBdLmNhbGwoY2JbMV0sIHJlZmVyZW5jZVtuYW1lXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZWZlcmVuY2VbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiBhZGQoKSB7CiAgICAgIHZhciBuYW1lID0gdGhpc1swXTsKICAgICAgdmFyIG5vZGUgPSB0aGlzWzFdOwogICAgICB2YXIgcmVmID0gdGhpc1syXTsKICAgICAgcmVtb3ZlKG5vZGUpOwogICAgICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KG5hbWUpOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgaWYgKHJlZiA9PT0gdHJ1ZSkgcmVmID0gcGFyZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgaWYgKCFyZWYgfHwgcmVmLnBhcmVudE5vZGUgIT09IHBhcmVudCkgcmVmID0gbnVsbDsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZik7CiAgICAgIH0gZWxzZSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGFkZCwgWyBuYW1lLCBub2RlLCByZWYgXSBdKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRvY1JlYWR5KG5hbWUsIGZuLCBjb250ZXh0KSB7CiAgICAgIGlmIChjYWxsYmFja3NbbmFtZV0pIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFsgZm4sIGNvbnRleHQgXSk7IGVsc2UgZm4uY2FsbChjb250ZXh0LCByZWZlcmVuY2VbbmFtZV0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKG5vZGUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGNhbGxiYWNrcykgewogICAgICAgIHZhciBlbnRyeSA9IEFycmF5X2V4dGVuc2lvbnMuc2VhcmNoKGNhbGxiYWNrc1trZXldLCBub2RlLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICByZXR1cm4gaXRlbVsxXSAmJiBpdGVtWzFdWzFdOwogICAgICAgIH0pOwogICAgICAgIGlmIChlbnRyeSkgQXJyYXlfZXh0ZW5zaW9ucy5yZW1vdmUoY2FsbGJhY2tzW2tleV0sIGVudHJ5KTsKICAgICAgfQogICAgICBpZiAobm9kZSAmJiBub2RlLnBhcmVudE5vZGUgJiYgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoZWNrUGFyZW50cygpIHsKICAgICAgaWYgKHRpbWVyICYmIGdldFBhcmVudCgiaGVhZCIpICYmIGdldFBhcmVudCgiYm9keSIpKSB0aW1lciA9IGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgaWYgKGRvY3VtZW50ICYmICghZ2V0UGFyZW50KCJoZWFkIikgfHwgIWdldFBhcmVudCgiYm9keSIpKSkgewogICAgICB0aW1lciA9IHNldEludGVydmFsKGNoZWNrUGFyZW50cywgNSk7CiAgICAgIHJlYWR5KGNoZWNrUGFyZW50cyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBoZWFkOiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiaGVhZCIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJoZWFkIiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYm9keTogewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgZG9jUmVhZHkoImJvZHkiLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZikgewogICAgICAgICAgYWRkLmNhbGwoWyAiYm9keSIsIG5vZGUsIHJlZiBdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogcmVtb3ZlCiAgICB9OwogIH0oKTsKICB2YXIgY2xlYW5lciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG9iamVjdHMgPSBbXTsKICAgIGZ1bmN0aW9uIGRlc3Ryb3kobG9nKSB7CiAgICAgIHZhciBsb2dEZXN0cm95ID0gbG9nICYmIHR5cGVvZiBsb2cgPT0gImJvb2xlYW4iOwogICAgICByZXN1bHQuZ2xvYmFsRGVzdHJveSA9IHRydWU7CiAgICAgIHJlc3VsdC5hZGQgPSAkdW5kZWY7CiAgICAgIHJlc3VsdC5yZW1vdmUgPSAkdW5kZWY7CiAgICAgIHZhciBvYmplY3Q7CiAgICAgIHdoaWxlIChvYmplY3QgPSBvYmplY3RzLnBvcCgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZGVzdHJveSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobG9nRGVzdHJveSkgY29uc29sZU1ldGhvZHMubG9nKCJkZXN0cm95IiwgIlsiICsgU3RyaW5nKG9iamVjdC5jbGFzc05hbWUpICsgIl0iLCBvYmplY3QpOwogICAgICAgICAgICBvYmplY3QuZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKFN0cmluZyhvYmplY3QpLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIG9iamVjdFtwcm9wXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9iamVjdHMubGVuZ3RoID0gMDsKICAgIH0KICAgIGlmICgiYXR0YWNoRXZlbnQiIGluIGdsb2JhbCkgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlc3Ryb3kpOyBlbHNlIGlmICgiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigidW5sb2FkIiwgZGVzdHJveSwgZmFsc2UpOyBlbHNlIHJldHVybiB7CiAgICAgIGFkZDogJHVuZGVmLAogICAgICByZW1vdmU6ICR1bmRlZgogICAgfTsKICAgIHZhciByZXN1bHQgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCAhPSBudWxsKSBvYmplY3RzLnB1c2gob2JqZWN0KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBBcnJheV9leHRlbnNpb25zLnJlbW92ZShvYmplY3RzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgcmVzdWx0LmRlc3Ryb3lfID0gZGVzdHJveTsKICAgIHJlc3VsdC5vYmplY3RzXyA9IG9iamVjdHM7CiAgICByZXR1cm4gcmVzdWx0OwogIH0oKTsKICB2YXIgQ3NzUmVzb3VyY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjc3NSZXNvdXJjZXMgPSB7fTsKICAgIHZhciBjbGVhbnVwRG9tID0gdHJ1ZTsKICAgIHZhciBTVFlMRV9BUFBFTkRfQlVHR1kgPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIikuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KCk7CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFudXBEb20gPSBmYWxzZTsKICAgICAgICBmb3IgKHZhciB1cmwgaW4gY3NzUmVzb3VyY2VzKSBjc3NSZXNvdXJjZXNbdXJsXS5kZXN0cm95KCk7CiAgICAgICAgY3NzUmVzb3VyY2VzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgYmFzZUVsID0gZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgZnVuY3Rpb24gc2V0QmFzZShiYXNlVVJJKSB7CiAgICAgIGJhc2VFbC5zZXRBdHRyaWJ1dGUoImhyZWYiLCBiYXNlVVJJKTsKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoYmFzZUVsLCB0cnVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc3RvcmVCYXNlKCkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgbG9jYXRpb24uaHJlZik7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShiYXNlRWwpOwogICAgfQogICAgZnVuY3Rpb24gaW5qZWN0U3R5bGVUb0hlYWQoKSB7CiAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgaWYgKCF0aGlzLmVsZW1lbnQpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgIGlmICghU1RZTEVfQVBQRU5EX0JVR0dZKSB0aGlzLnRleHROb2RlID0gdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgic3JjIiwgcGF0aFV0aWxzLnJlbGF0aXZlKHRoaXMudXJsKSk7CiAgICAgIH0KICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQodGhpcy5lbGVtZW50KTsKICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICByZXN0b3JlQmFzZSgpOwogICAgfQogICAgdmFyIENzc1Jlc291cmNlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6ICJiYXNpcy5Dc3NSZXNvdXJjZSIsCiAgICAgIGluVXNlOiAwLAogICAgICB1cmw6ICIiLAogICAgICBiYXNlVVJJOiAiIiwKICAgICAgY3NzVGV4dDogIiIsCiAgICAgIHJlc291cmNlOiBudWxsLAogICAgICBlbGVtZW50OiBudWxsLAogICAgICB0ZXh0Tm9kZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdGhpcy51cmwgPSBwYXRoVXRpbHMucmVzb2x2ZSh1cmwpOwogICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGhVdGlscy5kaXJuYW1lKHVybCkgKyAiLyI7CiAgICAgICAgY3NzUmVzb3VyY2VzW3VybF0gPSB0aGlzOwogICAgICB9LAogICAgICB1cGRhdGVDc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICAgICAgaWYgKHRoaXMuY3NzVGV4dCAhPSBjc3NUZXh0KSB7CiAgICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgaWYgKHRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KSB7CiAgICAgICAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICAgICAgICByZXN0b3JlQmFzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgc3luY0Nzc1RleHQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRleHROb2RlKSB7CiAgICAgICAgICB0aGlzLnRleHROb2RlLm5vZGVWYWx1ZSA9IHRoaXMuY3NzVGV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuY3NzVGV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN0YXJ0VXNlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuaW5Vc2UpIHsKICAgICAgICAgIGlmICghdGhpcy5yZXNvdXJjZSkgewogICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBnZXRSZXNvdXJjZSh0aGlzLnVybCk7CiAgICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTsKICAgICAgICAgICAgdGhpcy5jc3NUZXh0ID0gcmVzb3VyY2UuZ2V0KHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShpbmplY3RTdHlsZVRvSGVhZCwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5Vc2UgKz0gMTsKICAgICAgfSwKICAgICAgc3RvcFVzZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaW5Vc2UpIHsKICAgICAgICAgIHRoaXMuaW5Vc2UgLT0gMTsKICAgICAgICAgIGlmICghdGhpcy5pblVzZSAmJiB0aGlzLmVsZW1lbnQpIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZSh0aGlzLmVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuZWxlbWVudCAmJiBjbGVhbnVwRG9tKSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMudGV4dE5vZGUgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIHRoaXMuY3NzVGV4dCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgQ3NzUmVzb3VyY2UucmVzb3VyY2VzID0gY3NzUmVzb3VyY2VzOwogICAgcmV0dXJuIENzc1Jlc291cmNlOwogIH0oKTsKICB2YXIgYmFzaXMgPSBnZXROYW1lc3BhY2UoImJhc2lzIikuZXh0ZW5kKHsKICAgIGZpbGVuYW1lXzogYmFzaXNGaWxlbmFtZSwKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBOT0RFX0VOVjogTk9ERV9FTlYsCiAgICBjb25maWc6IGNvbmZpZywKICAgIHBsYXRmb3JtRmVhdHVyZToge30sCiAgICByZXNvbHZlTlNGaWxlbmFtZTogcmVzb2x2ZU5TRmlsZW5hbWUsCiAgICBwYXRjaDogcGF0Y2gsCiAgICBuYW1lc3BhY2U6IGdldE5hbWVzcGFjZSwKICAgIHJlcXVpcmU6IHJlcXVpcmVOYW1lc3BhY2UsCiAgICByZXNvdXJjZTogZ2V0UmVzb3VyY2UsCiAgICBhc3NldDogZnVuY3Rpb24odXJsKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9LAogICAgc2V0SW1tZWRpYXRlOiBzZXRJbW1lZGlhdGUsCiAgICBjbGVhckltbWVkaWF0ZTogY2xlYXJJbW1lZGlhdGUsCiAgICBuZXh0VGljazogZnVuY3Rpb24oKSB7CiAgICAgIHNldEltbWVkaWF0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSwKICAgIENsYXNzOiBDbGFzcywKICAgIFRva2VuOiBUb2tlbiwKICAgIERlZmVycmVkVG9rZW46IERlZmVycmVkVG9rZW4sCiAgICBnZXR0ZXI6IGdldHRlciwKICAgIHJlYWR5OiByZWFkeSwKICAgIGNsZWFuZXI6IGNsZWFuZXIsCiAgICBjb25zb2xlOiBjb25zb2xlTWV0aG9kcywKICAgIHBhdGg6IHBhdGhVdGlscywKICAgIGRvYzogZG9jdW1lbnRJbnRlcmZhY2UsCiAgICBvYmplY3Q6IHsKICAgICAgZXh0ZW5kOiBleHRlbmQsCiAgICAgIGNvbXBsZXRlOiBjb21wbGV0ZSwKICAgICAga2V5czoga2V5cywKICAgICAgdmFsdWVzOiB2YWx1ZXMsCiAgICAgIHNsaWNlOiBzbGljZSwKICAgICAgc3BsaWNlOiBzcGxpY2UsCiAgICAgIG1lcmdlOiBtZXJnZSwKICAgICAgaXRlcmF0ZTogaXRlcmF0ZQogICAgfSwKICAgIGZuOiB7CiAgICAgICR1bmRlZmluZWQ6ICR1bmRlZmluZWQsCiAgICAgICRkZWZpbmVkOiAkZGVmaW5lZCwKICAgICAgJGlzTnVsbDogJGlzTnVsbCwKICAgICAgJGlzTm90TnVsbDogJGlzTm90TnVsbCwKICAgICAgJGlzU2FtZTogJGlzU2FtZSwKICAgICAgJGlzTm90U2FtZTogJGlzTm90U2FtZSwKICAgICAgJHNlbGY6ICRzZWxmLAogICAgICAkY29uc3Q6ICRjb25zdCwKICAgICAgJGZhbHNlOiAkZmFsc2UsCiAgICAgICR0cnVlOiAkdHJ1ZSwKICAgICAgJG51bGw6ICRudWxsLAogICAgICAkdW5kZWY6ICR1bmRlZiwKICAgICAgZ2V0dGVyOiBnZXR0ZXIsCiAgICAgIG51bGxHZXR0ZXI6IG51bGxHZXR0ZXIsCiAgICAgIHdyYXBwZXI6IHdyYXBwZXIsCiAgICAgIGxhenlJbml0OiBsYXp5SW5pdCwKICAgICAgbGF6eUluaXRBbmRSdW46IGxhenlJbml0QW5kUnVuLAogICAgICBydW5PbmNlOiBydW5PbmNlCiAgICB9LAogICAgYXJyYXk6IGV4dGVuZChhcnJheUZyb20sIG1lcmdlKEFycmF5X2V4dGVuc2lvbnMsIHsKICAgICAgZnJvbTogYXJyYXlGcm9tLAogICAgICBjcmVhdGU6IGNyZWF0ZUFycmF5CiAgICB9KSksCiAgICBzdHJpbmc6IG1lcmdlKFN0cmluZ19leHRlbnNpb25zLCB7CiAgICAgIGlzRW1wdHk6IGlzRW1wdHlTdHJpbmcsCiAgICAgIGlzTm90RW1wdHk6IGlzTm90RW1wdHlTdHJpbmcKICAgIH0pLAogICAgbnVtYmVyOiBOdW1iZXJfZXh0ZW5zaW9ucywKICAgIGJvb2w6IHsKICAgICAgaW52ZXJ0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICBqc29uOiB7CiAgICAgIHBhcnNlOiB0eXBlb2YgSlNPTiAhPSAidW5kZWZpbmVkIiA/IEpTT04ucGFyc2UgOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nX2V4dGVuc2lvbnMudG9PYmplY3Qoc3RyLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIGdldE5hbWVzcGFjZSgiYmFzaXMuZGV2IikuZXh0ZW5kKGNvbnNvbGVNZXRob2RzKTsKICBpZiAoY29uZmlnLmF1dG9sb2FkKSByZXF1aXJlTmFtZXNwYWNlKGNvbmZpZy5hdXRvbG9hZCk7Cn0pKHRoaXMpOwp9KS5jYWxsKHRoaXMpOw==",
                "body": "Ly8gcmVzb3VyY2VzICg0MCk6Ci8vICBbc3RyaW5nXSBbdW5rbm93biMxXSAtPiAwLmNzcwovLyAgW3N0cmluZ10gY29yZS9lbnYvaWZyYW1lX2luamVjdC5jb2RlIC0+IDAuY29kZQovLyAgW2FycmF5XSByZXBvcnRlci90ZW1wbGF0ZS92aWV3LnRtcGwgLT4gOC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL21vZHVsZS90b2MvdGVtcGxhdGUvdG9jLWl0ZW0udG1wbCAtPiAxLnRtcGwKLy8gIFthcnJheV0gcmVwb3J0ZXIvbW9kdWxlL3RvYy90ZW1wbGF0ZS90b2MudG1wbCAtPiAyLnRtcGwKLy8gIFthcnJheV0gY29yZS9lbnYvaWZyYW1lLnRtcGwgLT4gMC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LnRtcGwgLT4gNC50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LXN1aXRlLnRtcGwgLT4gNS50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LWNhc2UudG1wbCAtPiA2LnRtcGwKLy8gIFthcnJheV0gcmVwb3J0ZXIvbW9kdWxlL3Rlc3QtdHJlZS90ZW1wbGF0ZS92aWV3LnRtcGwgLT4gNy50bXBsCi8vICBbYXJyYXldIHJlcG9ydGVyL2FwcC90ZW1wbGF0ZS90ZXN0LXNvdXJjZS50bXBsIC0+IDMudG1wbAovLyAgW3N0cmluZ10gY29yZS5qcyAtPiBiLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvcnVubmVyLmpzIC0+IGMuanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy9kYXRhL2RhdGFzZXQuanMgLT4gZC5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2RhdGEvaW5kZXguanMgLT4gZS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2RhdGEvdmFsdWUuanMgLT4gZi5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3V0aWxzL2JlbmNobWFyay5qcyAtPiBnLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvdGVzdC5qcyAtPiBoLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvdXRpbHMuanMgLT4gcC5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3V0aWxzL2luZm8uanMgLT4gaS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL2FwcC5qcyAtPiAxLmpzCi8vICBbZnVuY3Rpb25dIGNvcmUvZW52L2lmcmFtZS5qcyAtPiBxLmpzCi8vICBbZnVuY3Rpb25dIHJlcG9ydGVyL2FwcC5qcyAtPiAwLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvdWkuanMgLT4gMi5qcwovLyAgW2Z1bmN0aW9uXSBjb3JlL2FzdC5qcyAtPiBrLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvZXNwcmltYS9lc3ByaW1hLmpzIC0+IGwuanMKLy8gIFtmdW5jdGlvbl0gcmVwb3J0ZXIvbW9kdWxlL3RvYy9pbmRleC5qcyAtPiByLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvbDEwbi5qcyAtPiAzLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZXZlbnQuanMgLT4gNC5qcwovLyAgW2Z1bmN0aW9uXSByZXBvcnRlci9tb2R1bGUvdGVzdC10cmVlL2luZGV4LmpzIC0+IHMuanMKLy8gIFtmdW5jdGlvbl0gcmVwb3J0ZXIvYXBwL3Rlc3QuanMgLT4gbS5qcwovLyAgW2Z1bmN0aW9uXSByZXBvcnRlci9hcHAvaGlnaGxpZ2h0LmpzIC0+IG4uanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9qc2RpZmYvZGlmZi5qcyAtPiBvLmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZGF0YS5qcyAtPiA1LmpzCi8vICBbZnVuY3Rpb25dIC4uL2Jvd2VyX2NvbXBvbmVudHMvYmFzaXNqcy9zcmMvYmFzaXMvZG9tL3dyYXBwZXIuanMgLT4gNi5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3RlbXBsYXRlLmpzIC0+IDcuanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sLmpzIC0+IDguanMKLy8gIFtmdW5jdGlvbl0gLi4vYm93ZXJfY29tcG9uZW50cy9iYXNpc2pzL3NyYy9iYXNpcy9kb20vZXZlbnQuanMgLT4gOS5qcwovLyAgW2Z1bmN0aW9uXSAuLi9ib3dlcl9jb21wb25lbnRzL2Jhc2lzanMvc3JjL2Jhc2lzL3RlbXBsYXRlL2h0bWxmZ2VuLmpzIC0+IGEuanMKLy8gIFtmdW5jdGlvbl0gY29yZS9lbnYuanMgLT4gai5qcwovLwovLyBmaWxlbGlzdCAoNCk6IAovLyAgIHJlcG9ydGVyL2FwcC5qcwovLyAgIGNvcmUuanMKLy8gICAuLi9ib3dlcl9jb21wb25lbnRzL2VzcHJpbWEvZXNwcmltYS5qcwovLyAgIC4uL2Jvd2VyX2NvbXBvbmVudHMvanNkaWZmL2RpZmYuanMKKGZ1bmN0aW9uKCl7CiJ1c2Ugc3RyaWN0IjsKCnZhciBfX25hbWVzcGFjZV9tYXBfXyA9IHsiMC5qcyI6ImFwcCIsIjEuanMiOiJiYXNpcy5hcHAiLCIyLmpzIjoiYmFzaXMudWkiLCIzLmpzIjoiYmFzaXMubDEwbiIsIjQuanMiOiJiYXNpcy5ldmVudCIsIjUuanMiOiJiYXNpcy5kYXRhIiwiNi5qcyI6ImJhc2lzLmRvbS53cmFwcGVyIiwiNy5qcyI6ImJhc2lzLnRlbXBsYXRlIiwiOC5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWwiLCI5LmpzIjoiYmFzaXMuZG9tLmV2ZW50IiwiYS5qcyI6ImJhc2lzLnRlbXBsYXRlLmh0bWxmZ2VuIiwiYi5qcyI6ImNvcmUiLCJjLmpzIjoiY29yZS5ydW5uZXIiLCJkLmpzIjoiYmFzaXMuZGF0YS5kYXRhc2V0IiwiZS5qcyI6ImJhc2lzLmRhdGEuaW5kZXgiLCJmLmpzIjoiYmFzaXMuZGF0YS52YWx1ZSIsImcuanMiOiJiYXNpcy51dGlscy5iZW5jaG1hcmsiLCJoLmpzIjoiY29yZS50ZXN0IiwiaS5qcyI6ImJhc2lzLnV0aWxzLmluZm8iLCJqLmpzIjoiY29yZS5lbnYiLCJrLmpzIjoiY29yZS5hc3QiLCJsLmpzIjoiZXNwcmltYSIsIm0uanMiOiJhcHAudGVzdCIsIm4uanMiOiJhcHAuaGlnaGxpZ2h0Iiwiby5qcyI6ImRpZmYifTsKdmFyIF9fcmVzb3VyY2VzX18gPSB7CiAgIjAuY3NzIjogIiIsCiAgIjAuY29kZSI6ICJmdW5jdGlvbiBpbXBvcnRTY3JpcHRzKCl7XG4gIGZ1bmN0aW9uIGltcG9ydFNjcmlwdCh1cmwpe1xuICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICByZXEub3BlbignR0VUJywgdXJsLCBmYWxzZSk7XG4gICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgbmV3IERhdGUoMCkudG9HTVRTdHJpbmcoKSk7XG4gICAgcmVxLnNlbmQobnVsbCk7XG5cbiAgICBpZiAocmVxLnN0YXR1cyA+PSAyMDAgJiYgcmVxLnN0YXR1cyA8IDQwMClcbiAgICAgICh3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihmbil7XG4gICAgICAgIHdpbmRvd1snZXZhbCddLmNhbGwod2luZG93LCBmbik7XG4gICAgICB9KShyZXEucmVzcG9uc2VUZXh0KTtcbiAgICBlbHNlXG4gICAgICB0aHJvdyAnQ2FuXFwndCBsb2FkIHNjcmlwdDogJyArIHVybDtcbiAgfVxuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKVxuICAgIGltcG9ydFNjcmlwdChhcmd1bWVudHNbaV0pXG59XG5cbmZ1bmN0aW9uIF9faW5pdFRlc3RFbnZpcm9ubWVudChpbml0Q29kZSwgZGVwcmVjYXRlVGVzdEVudmlyb25tZW50KXtcbiAgLy8gYmFzaXMuanMgZGVmYXVsdCBiZWhhdmlvdXJcbiAgaWYgKHR5cGVvZiBiYXNpc2pzVG9vbHNGaWxlU3luYyAhPSAndW5kZWZpbmVkJylcbiAgICBiYXNpc2pzVG9vbHNGaWxlU3luYy5ub3RpZmljYXRpb25zLmF0dGFjaChmdW5jdGlvbih0eXBlLCBmaWxlbmFtZSl7XG4gICAgICBpZiAodHlwZW9mIGJhc2lzID09ICd1bmRlZmluZWQnKVxuICAgICAgICByZXR1cm47IC8vIG5vIGJhc2lzLmpzIGF2YWlsYWJsZVxuXG4gICAgICBpZiAodHlwZSA9PSAndXBkYXRlJyAmJiAoXG4gICAgICAgICAgICAoYmFzaXMuZmlsZW5hbWVfID09IGZpbGVuYW1lKSB8fFxuICAgICAgICAgICAgKGJhc2lzLnJlc291cmNlICYmIGJhc2lzLnJlc291cmNlLmV4aXN0cyhmaWxlbmFtZSkpXG4gICAgICAgICApKVxuICAgICAgICBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQoKTtcbiAgICB9KTtcblxuICAvLyBmYWxsYmFjayBkZXByZWNhdGUgZnVuY3Rpb25cbiAgaWYgKHR5cGVvZiBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQgIT0gJ2Z1bmN0aW9uJylcbiAgICBkZXByZWNhdGVUZXN0RW52aXJvbm1lbnQgPSBmdW5jdGlvbigpe307XG5cbiAgLy8gbWFpbiBwYXJ0XG4gIHJldHVybiBldmFsKGluaXRDb2RlICsgJzsoZnVuY3Rpb24oX19jb2RlKXtcXG4nICtcbiAgJyAgcmV0dXJuIGV2YWwoXCIoXCIgKyBfX2NvZGUgKyBcIilcIik7JyArXG4gICd9KScpO1xufVxuIiwKICAiOC50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDIsIDAsIDAsICJpZCIsICJsYXlvdXQiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgMiwgMCwgMCwgImlkIiwgImhlYWRlciIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImhlYWRlci1jYXB0aW9uIiBdLCBbIDMsIDAsIDAsICJCYXNpcy5qcyB0ZXN0IHJ1bm5lciIgXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJoZWFkZXItYnV0dG9ucyIgXSwgWyAxLCAwLCAwLCAiYnV0dG9uIiwgWyA0LCAwLCAwLCAiaGVhZGVyLWJ1dHRvbiIgXSwgWyA2LCAiY2xpY2siLCAicnVuIiBdLCBbIDMsIDAsIDAsICJydW4iIF0gXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJoZWFkZXItdGVzdC1zdWl0ZS1sb2NhdGlvbiIgXSwgWyAzLCAxLCBbICJuYW1lIiBdIF0sIFsgMywgMCwgMCwgIiAiIF0sIFsgMywgMSwgWyAiZG9uZSIgXSBdLCBbIDMsIDAsIDAsICIgLyAiIF0sIFsgMywgMSwgWyAidG90YWwiIF0gXSwgWyAzLCAwLCAwLCAiICgiIF0sIFsgMywgMSwgWyAiYXNzZXJ0IiBdIF0sIFsgMywgMCwgMCwgIikgKHRpbWU6ICIgXSwgWyAzLCAxLCBbICJ0aW1lIiBdIF0sIFsgMywgMCwgMCwgIiBtcykiIF0gXSBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDIsIDAsIDAsICJpZCIsICJzaWRlYmFyIiBdLCBbIDgsIDEsIFsgInRvYyIgXSBdIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgMiwgMCwgMCwgImlkIiwgImNvbnRlbnQiIF0sIFsgOCwgMSwgWyAidGVzdHMiIF0gXSBdIF0gXSwKICAiMS50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDQsIFsgWyAiYXBwLXRvYy1pdGVtXyIsICJzZWxlY3RlZCIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtIiBdLCBbIDYsICJjbGljayIsICJzZWxlY3QiIF0sIFsgNiwgImRibGNsaWNrIiwgInBpY2t1cCIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdG9jLWl0ZW1fX3Byb2dyZXNzXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtX19wcm9ncmVzcyIgXSwgWyA1LCBbIFsgWyAicHJvZ3Jlc3MiIF0sIFsgMCwgIiUiIF0sICJ3aWR0aCIgXSBdLCAwIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdG9jLWl0ZW1fX3N0YXRlLSIsICJzdGF0ZSIgXSwgWyAiYXBwLXRvYy1pdGVtX19zdGF0ZS0iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRvYy1pdGVtX19zdGF0ZSIgXSwgWyAzLCAxLCBbICJzdGF0ZU1lc3NhZ2UiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRvYy1pdGVtX19uYW1lIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdIF0gXSwKICAiMi50bXBsIjogWyBbIDEsIDAsIFsgImVsZW1lbnQiIF0sICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdG9jIiBdLCBbIDgsIDEsIFsgImxldmVsVXAiIF0gXSwgWyA4LCAxLCBbICJmYXVsdFRlc3RzIiBdIF0gXSBdLAogICIwLnRtcGwiOiBbIFsgMSwgMCwgWyAiZWxlbWVudCIgXSwgImlmcmFtZSIsIFsgMiwgWyBbICJzcmMiIF0sIFsgMCBdIF0sIDAsICJzcmMiLCAie3NyY30iIF0sIFsgNiwgImxvYWQiLCAicmVhZHkiIF0sIFsgNSwgMCwgMCwgIndpZHRoOiAxMHB4OyBoZWlnaHQ6IDEwcHg7IHRvcDogLTEwMHB4OyBwb3NpdGlvbjogYWJzb2x1dGU7IGJvcmRlcjogbm9uZTsgb3BhY2l0eTogMC4wMDAxOyIgXSBdIF0sCiAgIjQudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LSIsICJoYXNPd25FbnZpcm9ubWVudCIgXSBdLCAwLCAiYXBwLXRlc3QiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LWhlYWRlciIgXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0X19zZWxlY3QtYnV0dG9uIiBdLCBbIDYsICJjbGljayIsICJzZWxlY3QiIF0sIFsgMywgMCwgMCwgInBpY2sgdXAiIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LW5hbWUiIF0sIFsgMywgMSwgWyAibmFtZSIgXSBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3BsaXR0ZXJfIiwgInN0YXRlIiBdIF0sIDAsICJhcHAtdGVzdC1zcGxpdHRlciIgXSwgWyAzLCAwLCAwLCAiIOKAlCAiIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdGVzdC1zdGF0ZV9zdGF0ZS0iLCAic3RhdGUiIF0sIFsgImFwcC10ZXN0LXN0YXRlXyIsICJwZW5kaW5nIiBdIF0sIDAsICJhcHAtdGVzdC1zdGF0ZSIgXSwgWyAzLCAxLCBbICJzdGF0ZU1lc3NhZ2UiIF0gXSBdIF0gXSBdLAogICI1LnRtcGwiOiBbIFsgMSwgMCwgWyAiZWxlbWVudCIgXSwgImRpdiIsIFsgNCwgWyBbICJhcHAtdGVzdC0iLCAiaGFzT3duRW52aXJvbm1lbnQiIF0gXSwgMCwgImFwcC10ZXN0IGFwcC10ZXN0LXN1aXRlIiBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdGVzdC1oZWFkZXIiIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdF9fc2VsZWN0LWJ1dHRvbiIgXSwgWyA2LCAiY2xpY2siLCAic2VsZWN0IiBdLCBbIDMsIDAsIDAsICJwaWNrIHVwIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdC1uYW1lIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXNwbGl0dGVyXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRlc3Qtc3BsaXR0ZXIiIF0sIFsgMywgMCwgMCwgIiDigJQgIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3RhdGVfc3RhdGUtIiwgInN0YXRlIiBdLCBbICJhcHAtdGVzdC1zdGF0ZV8iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRlc3Qtc3RhdGUiIF0sIFsgMywgMSwgWyAic3RhdGVNZXNzYWdlIiBdIF0gXSBdLCBbIDEsIDEsIFsgImNoaWxkTm9kZXNFbGVtZW50IiBdLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3Qtc3VpdGVfX2NvbnRlbnQiIF0gXSBdIF0sCiAgIjYudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LSIsICJoYXNPd25FbnZpcm9ubWVudCIgXSBdLCAwLCAiYXBwLXRlc3QgYXBwLXRlc3QtY2FzZSIgXSwgWyAxLCAwLCAwLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtaGVhZGVyIiBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRlc3RfX3NlbGVjdC1idXR0b24iIF0sIFsgNiwgImNsaWNrIiwgInNlbGVjdCIgXSwgWyAzLCAwLCAwLCAicGljayB1cCIgXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtbmFtZSIgXSwgWyAzLCAxLCBbICJuYW1lIiBdIF0gXSwgWyAxLCAwLCAwLCAic3BhbiIsIFsgNCwgWyBbICJhcHAtdGVzdC1zcGxpdHRlcl8iLCAic3RhdGUiIF0gXSwgMCwgImFwcC10ZXN0LXNwbGl0dGVyIiBdLCBbIDMsIDAsIDAsICIg4oCUICIgXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXN0YXRlX3N0YXRlLSIsICJzdGF0ZSIgXSwgWyAiYXBwLXRlc3Qtc3RhdGVfIiwgInBlbmRpbmciIF0gXSwgMCwgImFwcC10ZXN0LXN0YXRlIiBdLCBbIDMsIDEsIFsgInN0YXRlTWVzc2FnZSIgXSBdIF0gXSwgWyA4LCAxLCBbICJzb3VyY2UiIF0gXSBdLCBbIDgsIDAsIDAsICc8YjphZnRlciByZWY9InN0YXRlTWVzc2FnZSI+XG4gICAgwqAgwqB7ZXJyb3JNZXNzYWdlfVxuICA8L2I6YWZ0ZXI+JyBdIF0sCiAgIjcudG1wbCI6IFsgWyAxLCAwLCBbICJlbGVtZW50IiBdLCAiZGl2IiwgWyA0LCBbIFsgImFwcC10ZXN0LXRyZWVfIiwgImhhc0RlbGVnYXRlIiBdIF0sIDAsICJhcHAtdGVzdC10cmVlIiBdLCBbIDEsIDAsIDAsICJkaXYiLCBbIDQsIDAsIDAsICJhcHAtdGVzdC10cmVlX19oZWFkZXIiIF0sIFsgMSwgMCwgMCwgImRpdiIsIFsgNCwgMCwgMCwgImFwcC10ZXN0LXRyZWVfX2J1dHRvbnMiIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3QtdHJlZV9fYnV0dG9uLXBpY2t1cF8iLCAidHlwZSIgXSBdLCAwLCAiYXBwLXRlc3QtdHJlZV9fYnV0dG9uIGFwcC10ZXN0LXRyZWVfX2J1dHRvbi1waWNrdXAiIF0sIFsgNiwgImNsaWNrIiwgInNlbGVjdCIgXSwgWyAzLCAwLCAwLCAicGljayB1cCIgXSBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIDAsIDAsICJhcHAtdGVzdC10cmVlX19jYXB0aW9uIiBdLCBbIDMsIDEsIFsgIm5hbWUiIF0gXSBdLCBbIDEsIDAsIDAsICJzcGFuIiwgWyA0LCBbIFsgImFwcC10ZXN0LXNwbGl0dGVyXyIsICJzdGF0ZSIgXSBdLCAwLCAiYXBwLXRlc3Qtc3BsaXR0ZXIiIF0sIFsgMywgMCwgMCwgIiDigJQgIiBdIF0sIFsgMSwgMCwgMCwgInNwYW4iLCBbIDQsIFsgWyAiYXBwLXRlc3Qtc3RhdGVfc3RhdGUtIiwgInN0YXRlIiBdLCBbICJhcHAtdGVzdC1zdGF0ZV8iLCAicGVuZGluZyIgXSBdLCAwLCAiYXBwLXRlc3Qtc3RhdGUiIF0sIFsgMywgMSwgWyAic3RhdGVNZXNzYWdlIiBdIF0gXSBdLCBbIDEsIDEsIFsgImNoaWxkTm9kZXNFbGVtZW50IiBdLCAiZGl2IiwgWyA0LCAwLCAwLCAiYXBwLXRlc3QtdHJlZV9fY29udGVudCIgXSBdLCBbIDgsIDEsIFsgInNvdXJjZUNvZGUiIF0gXSBdIF0sCiAgIjMudG1wbCI6IFsgWyAxLCAxLCBbICJjb2RlIiwgImVsZW1lbnQiIF0sICJwcmUiLCBbIDQsIDAsIDAsICJCYXNpcy1TeW50YXhIaWdobGlnaHQiIF0sIFsgMywgMSwgWyAic291cmNlQ29kZSIgXSBdIF0gXSwKICAiYi5qcyI6ICIvKiBKYXZhc2NyaXB0IGZpbGUgL1VzZXJzL3Jkdm9ybm92L0Rlc2t0b3AvZ2l0L3Rlc3QtcnVubmVyL3NyYy9jb3JlLmpzIG5vdCBmb3VuZCAqLyIsCiAgImMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9kLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2UuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgdmFyIFRlc3RDYXNlID0gYmFzaXMucmVxdWlyZSgiLi9oLmpzIikuVGVzdENhc2U7CiAgICB2YXIgdGVzdHNUb1J1biA9IG5ldyBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgYXdhaXRQcm9jZXNzaW5nVGVzdHMgPSBuZXcgYmFzaXMuZGF0YS5EYXRhc2V0KHsKICAgICAgbGlzdGVuOiB7CiAgICAgICAgaXRlbTogewogICAgICAgICAgc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGlmIChpdGVtLnN0YXRlICE9IGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORykgdGhpcy5yZW1vdmUoaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBmYXVsdFRlc3RzID0gbmV3IGJhc2lzLmRhdGEuZGF0YXNldC5TdWJzZXQoewogICAgICBzb3VyY2U6IHRlc3RzVG9SdW4sCiAgICAgIHJ1bGVFdmVudHM6ICJzdGF0ZUNoYW5nZWQiLAogICAgICBydWxlOiBmdW5jdGlvbih0ZXN0KSB7CiAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5FUlJPUjsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcHJvY2Vzc2luZ1F1ZXVlID0gbmV3IGJhc2lzLmRhdGEuZGF0YXNldC5TdWJzZXQoewogICAgICBydWxlRXZlbnRzOiAic3RhdGVDaGFuZ2VkIiwKICAgICAgcnVsZTogZnVuY3Rpb24odGVzdCkgewogICAgICAgIHJldHVybiB0ZXN0LnN0YXRlICE9IGJhc2lzLmRhdGEuU1RBVEUuUkVBRFkgJiYgdGVzdC5zdGF0ZSAhPSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SOwogICAgICB9CiAgICB9KTsKICAgIHZhciBwcm9jZXNzaW5nUXVldWVUb3AgPSBuZXcgYmFzaXMuZGF0YS5kYXRhc2V0LlNsaWNlKHsKICAgICAgc291cmNlOiBwcm9jZXNzaW5nUXVldWUsCiAgICAgIHJ1bGU6ICJiYXNpc09iamVjdElkIiwKICAgICAgbGltaXQ6IDEsCiAgICAgIGhhbmRsZXI6IHsKICAgICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNlbmRlciwgZGVsdGEpIHsKICAgICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgZGVsdGEuaW5zZXJ0ZWQuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChwcm9jZXNzaW5nUXVldWVUb3AuaGFzKGl0ZW0pKSBpdGVtLnJ1bigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgdGVzdFN0YXJ0VGltZTsKICAgIHZhciB0aW1lID0gbmV3IGJhc2lzLmRhdGEuVmFsdWUoewogICAgICB2YWx1ZTogMAogICAgfSk7CiAgICB2YXIgYXNzZXJ0Q291bnQgPSBiYXNpcy5kYXRhLmluZGV4LnN1bSh0ZXN0c1RvUnVuLCAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24odGVzdCkgewogICAgICBpZiAodGVzdC5zdGF0ZS5kYXRhIGluc3RhbmNlb2YgYmFzaXMuZGF0YS5PYmplY3QpIHJldHVybiB0ZXN0LnN0YXRlLmRhdGEuZGF0YS50ZXN0Q291bnQ7CiAgICAgIHJldHVybiAwOwogICAgfSk7CiAgICB2YXIgdGVzdENvdW50ID0gYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRlc3RzVG9SdW4sICJpdGVtc0NoYW5nZWQiLCAiaXRlbUNvdW50Iik7CiAgICB2YXIgdGVzdERvbmUgPSBiYXNpcy5kYXRhLmluZGV4LmNvdW50KHRlc3RzVG9SdW4sICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbih0ZXN0KSB7CiAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgfHwgdGVzdC5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLlJFQURZOwogICAgfSk7CiAgICB2YXIgdGVzdExlZnQgPSBuZXcgYmFzaXMuZGF0YS52YWx1ZS5FeHByZXNzaW9uKHRlc3RDb3VudCwgdGVzdERvbmUsIGZ1bmN0aW9uKHRvdGFsLCBkb25lKSB7CiAgICAgIHJldHVybiB0b3RhbCAtIGRvbmU7CiAgICB9KTsKICAgIHRlc3RMZWZ0LmFkZEhhbmRsZXIoewogICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlciwgb2xkVmFsdWUpIHsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiAhb2xkVmFsdWUpIHRlc3RTdGFydFRpbWUgPSBiYXNpcy51dGlscy5iZW5jaG1hcmsudGltZSgpOwogICAgICAgIHRpbWUuc2V0KGJhc2lzLnV0aWxzLmJlbmNobWFyay50aW1lKHRlc3RTdGFydFRpbWUpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBleHRyYWN0VGVzdHMoZGF0YSkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZGF0YVtpXTsgaSsrKSB7CiAgICAgICAgdmFyIHRlc3QgPSBpdGVtLnJvb3Q7CiAgICAgICAgaWYgKHRlc3QgaW5zdGFuY2VvZiBUZXN0Q2FzZSkgcmVzdWx0LnB1c2godGVzdCk7CiAgICAgICAgaWYgKHRlc3QuZmlyc3RDaGlsZCkgcmVzdWx0LnB1c2guYXBwbHkocmVzdWx0LCBleHRyYWN0VGVzdHModGVzdC5jaGlsZE5vZGVzKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGxvYWRUZXN0cyhkYXRhKSB7CiAgICAgIHN0b3AoKTsKICAgICAgdGVzdHNUb1J1bi5zZXQoZXh0cmFjdFRlc3RzKGRhdGEpKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJ1bihkYXRhKSB7CiAgICAgIHN0b3AoKTsKICAgICAgaWYgKGF3YWl0UHJvY2Vzc2luZ1Rlc3RzLml0ZW1Db3VudCkgcmV0dXJuIHNldFRpbWVvdXQocnVuLCAxMCk7CiAgICAgIHRlc3RzVG9SdW4uZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgdmFyIGVudiA9IGl0ZW0uZ2V0RW52UnVubmVyKCk7CiAgICAgICAgaWYgKGVudikgZW52LmRlc3Ryb3koKTsKICAgICAgICBpdGVtLnJvb3QucmVzZXQoKTsKICAgICAgfSk7CiAgICAgIHByb2Nlc3NpbmdRdWV1ZS5zZXRTb3VyY2UodGVzdHNUb1J1bik7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wKCkgewogICAgICBpZiAocHJvY2Vzc2luZ1F1ZXVlLml0ZW1Db3VudCkgewogICAgICAgIGF3YWl0UHJvY2Vzc2luZ1Rlc3RzLmFkZChwcm9jZXNzaW5nUXVldWUuZ2V0SXRlbXMoKS5maWx0ZXIoZnVuY3Rpb24odGVzdCkgewogICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOwogICAgICAgIH0pKTsKICAgICAgfQogICAgICBwcm9jZXNzaW5nUXVldWUuc2V0U291cmNlKCk7CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgdGltZTogdGltZSwKICAgICAgZmF1bHRUZXN0czogZmF1bHRUZXN0cywKICAgICAgY291bnQ6IHsKICAgICAgICBhc3NlcnQ6IGFzc2VydENvdW50LAogICAgICAgIHRvdGFsOiB0ZXN0Q291bnQsCiAgICAgICAgbGVmdDogdGVzdExlZnQsCiAgICAgICAgZG9uZTogdGVzdERvbmUKICAgICAgfSwKICAgICAgbG9hZFRlc3RzOiBsb2FkVGVzdHMsCiAgICAgIHJ1bjogcnVuLAogICAgICBzdG9wOiBzdG9wCiAgICB9OwogIH0sCiAgImQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgb25lRnVuY3Rpb25Qcm9wZXJ0eSA9IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHk7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciB2YWx1ZXMgPSBiYXNpcy5vYmplY3QudmFsdWVzOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyICR0cnVlID0gYmFzaXMuZm4uJHRydWU7CiAgICB2YXIgJGZhbHNlID0gYmFzaXMuZm4uJGZhbHNlOwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgU1VCU0NSSVBUSU9OID0gYmFzaXMuZGF0YS5TVUJTQ1JJUFRJT047CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIEtleU9iamVjdE1hcCA9IGJhc2lzLmRhdGEuS2V5T2JqZWN0TWFwOwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgU1VCU0NSSVBUSU9OLmFkZCgiU09VUkNFIiwgewogICAgICBzb3VyY2VDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIG9sZFNvdXJjZSkgewogICAgICAgIGlmIChvbGRTb3VyY2UpIFNVQlNDUklQVElPTi51bmxpbmsoInNvdXJjZSIsIG9iamVjdCwgb2xkU291cmNlKTsKICAgICAgICBpZiAob2JqZWN0LnNvdXJjZSkgU1VCU0NSSVBUSU9OLmxpbmsoInNvdXJjZSIsIG9iamVjdCwgb2JqZWN0LnNvdXJjZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZXNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGFycmF5W2ldOyBpKyspIFNVQlNDUklQVElPTi5saW5rKCJzb3VyY2UiLCBvYmplY3QsIGFycmF5W2ldKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGFycmF5W2ldOyBpKyspIFNVQlNDUklQVElPTi51bmxpbmsoInNvdXJjZSIsIG9iamVjdCwgYXJyYXlbaV0pOwogICAgICB9CiAgICB9LCBmdW5jdGlvbihhY3Rpb24sIG9iamVjdCkgewogICAgICB2YXIgc291cmNlcyA9IG9iamVjdC5zb3VyY2VzIHx8IChvYmplY3Quc291cmNlID8gWyBvYmplY3Quc291cmNlIF0gOiBbXSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2U7IHNvdXJjZSA9IHNvdXJjZXNbaSsrXTsgKSBhY3Rpb24oInNvdXJjZSIsIG9iamVjdCwgc291cmNlKTsKICAgIH0pOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJtaW51ZW5kIik7CiAgICBTVUJTQ1JJUFRJT04uYWRkUHJvcGVydHkoInN1YnRyYWhlbmQiKTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVJ1bGVFdmVudHMoZm4sIGV2ZW50cykgewogICAgICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlUnVsZUV2ZW50c19fZXh0ZW5kX18oZXZlbnRzKSB7CiAgICAgICAgaWYgKCFldmVudHMpIHJldHVybiBudWxsOwogICAgICAgIGlmIChldmVudHMuX19leHRlbmRfXykgcmV0dXJuIGV2ZW50czsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50cyAhPSAic3RyaW5nIiAmJiAhQXJyYXkuaXNBcnJheShldmVudHMpKSB7CiAgICAgICAgICBldmVudHMgPSB0eXBlb2YgZXZlbnRzID09ICJvYmplY3QiID8gYmFzaXMub2JqZWN0LmtleXMoZXZlbnRzKSA6IG51bGw7CiAgICAgICAgICBpZiAoZXZlbnRzKSBiYXNpcy5kZXYud2FybigiVXNpbmcgYW4gb2JqZWN0IGZvciBydWxlRXZlbnRzIGlzIGRlcHJlY2F0ZWQsIHVzZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMgc3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3MgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4dGVuZChiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgZm4pLCB7CiAgICAgICAgICBfX2V4dGVuZF9fOiBjcmVhdGVSdWxlRXZlbnRzX19leHRlbmRfXwogICAgICAgIH0pOwogICAgICB9KGV2ZW50cyk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVLZXlNYXAoY29uZmlnLCBrZXlHZXR0ZXIsIGl0ZW1DbGFzcywgU3Vic2V0Q2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBLZXlPYmplY3RNYXAoZXh0ZW5kKHsKICAgICAgICBrZXlHZXR0ZXI6IGtleUdldHRlciwKICAgICAgICBpdGVtQ2xhc3M6IGl0ZW1DbGFzcywKICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgICB2YXIgb2JqID0gS2V5T2JqZWN0TWFwLnByb3RvdHlwZS5jcmVhdGUuY2FsbCh0aGlzLCBrZXksIG9iamVjdCk7CiAgICAgICAgICBvYmouc2V0RGF0YXNldChuZXcgU3Vic2V0Q2xhc3MoewogICAgICAgICAgICBydWxlVmFsdWU6IGtleQogICAgICAgICAgfSkpOwogICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICAgIH0sIGNvbmZpZykpOwogICAgfQogICAgdmFyIE1FUkdFX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIHVwZGF0ZWQgPSB7fTsKICAgICAgICB2YXIgb2JqZWN0OwogICAgICAgIHZhciBvYmplY3RJZDsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBvYmplY3QgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW29iamVjdElkXSA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgb2JqZWN0ID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIHVwZGF0ZWRbb2JqZWN0SWRdID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSh1cGRhdGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdGhpcy5yZW1vdmVTb3VyY2Uoc291cmNlKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNZXJnZSA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlNPVVJDRSwKICAgICAgZW1pdF9zb3VyY2VzQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZXNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHJ1bGU6IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICAgIHJldHVybiBjb3VudCA+IDA7CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUVSR0VfREFUQVNFVF9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VzID0gdGhpcy5zb3VyY2VzOwogICAgICAgIHRoaXMuc291cmNlcyA9IFtdOwogICAgICAgIGlmIChzb3VyY2VzKSBzb3VyY2VzLmZvckVhY2godGhpcy5hZGRTb3VyY2UsIHRoaXMpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBydWxlICE9ICJmdW5jdGlvbiIpIHJ1bGUgPSBNZXJnZS5VTklPTjsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB0aGlzLnJ1bGUgPSBydWxlOwogICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgcnVsZSA9IHRoaXMucnVsZTsKICAgICAgICB2YXIgc291cmNlQ291bnQgPSB0aGlzLnNvdXJjZXMubGVuZ3RoOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIG1lbWJlckNvdW50ZXI7CiAgICAgICAgdmFyIGlzTWVtYmVyOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNjb3BlKSBzY29wZSA9IG1lbWJlck1hcDsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiBzY29wZSkgewogICAgICAgICAgbWVtYmVyQ291bnRlciA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICBpc01lbWJlciA9IHNvdXJjZUNvdW50ICYmIG1lbWJlckNvdW50ZXIuY291bnQgJiYgcnVsZShtZW1iZXJDb3VudGVyLmNvdW50LCBzb3VyY2VDb3VudCk7CiAgICAgICAgICBpZiAoaXNNZW1iZXIgIT0gISF0aGlzLml0ZW1zX1tvYmplY3RJZF0pIChpc01lbWJlciA/IGluc2VydGVkIDogZGVsZXRlZCkucHVzaChtZW1iZXJDb3VudGVyLm9iamVjdCk7CiAgICAgICAgICBpZiAobWVtYmVyQ291bnRlci5jb3VudCA9PSAwKSBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGFkZFNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCkgewogICAgICAgICAgaWYgKGJhc2lzLmFycmF5LmFkZCh0aGlzLnNvdXJjZXMsIHNvdXJjZSkpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGlzdGVuLnNvdXJjZSkgc291cmNlLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlLCB0aGlzKTsKICAgICAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIHNvdXJjZS5pdGVtc18pIHsKICAgICAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2UuaXRlbXNfW29iamVjdElkXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICAgICAgdGhpcy5lbWl0X3NvdXJjZXNDaGFuZ2VkKHsKICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2UgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIi5hZGRTb3VyY2U6IHNvdXJjZSBpc24ndCBpbnN0YW5jZSBvZiBBYnN0cmFjdERhdGFzZXQiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZVNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLnNvdXJjZXMsIHNvdXJjZSkpIHsKICAgICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIHNvdXJjZS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLnNvdXJjZSwgdGhpcyk7CiAgICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIHNvdXJjZS5pdGVtc18pIG1lbWJlck1hcFtvYmplY3RJZF0uY291bnQtLTsKICAgICAgICAgIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgICB0aGlzLmVtaXRfc291cmNlc0NoYW5nZWQoewogICAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZSBdCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIucmVtb3ZlU291cmNlOiBzb3VyY2UgaXNuJ3QgaW4gZGF0YXNldCBzb3VyY2UgbGlzdCIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U291cmNlczogZnVuY3Rpb24oc291cmNlcykgewogICAgICAgIHZhciBleGlzdHMgPSBhcnJheUZyb20odGhpcy5zb3VyY2VzKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlOyBzb3VyY2UgPSBzb3VyY2VzW2ldOyBpKyspIHsKICAgICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGFzZXQpIHsKICAgICAgICAgICAgaWYgKCFiYXNpcy5hcnJheS5yZW1vdmUoZXhpc3RzLCBzb3VyY2UpKSB0aGlzLmFkZFNvdXJjZShzb3VyY2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiLnNldFNvdXJjZXM6IHNvdXJjZSBpc24ndCB0eXBlIG9mIEFic3RyYWN0RGF0YXNldCIsIHNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4aXN0cy5mb3JFYWNoKHRoaXMucmVtb3ZlU291cmNlLCB0aGlzKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIGFycmF5RnJvbSh0aGlzLnNvdXJjZXMpLmZvckVhY2godGhpcy5yZW1vdmVTb3VyY2UsIHRoaXMpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnNvdXJjZXMgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIE1lcmdlLlVOSU9OID0gTWVyZ2UucHJvdG90eXBlLnJ1bGU7CiAgICBNZXJnZS5JTlRFUlNFQ1RJT04gPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIGNvdW50ID09IHNvdXJjZUNvdW50OwogICAgfTsKICAgIE1lcmdlLkRJRkZFUkVOQ0UgPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIGNvdW50ID09IDE7CiAgICB9OwogICAgTWVyZ2UuTU9SRV9USEFOX09ORV9JTkNMVURFID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBzb3VyY2VDb3VudCA9PSAxIHx8IGNvdW50ID4gMTsKICAgIH07CiAgICBNZXJnZS5BVF9MRUFTVF9PTkVfRVhDTFVERSA9IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICByZXR1cm4gc291cmNlQ291bnQgPT0gMSB8fCBjb3VudCA8IHNvdXJjZUNvdW50OwogICAgfTsKICAgIHZhciBkYXRhc2V0QWJzZW50RmlsdGVyID0gZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKGl0ZW0pOwogICAgfTsKICAgIHZhciBTVUJUUkFDVERBVEFTRVRfTUlOVUVORF9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgaWYgKCF0aGlzLnN1YnRyYWhlbmQpIHJldHVybjsKICAgICAgICB2YXIgbmV3RGVsdGEgPSBnZXREZWx0YShkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIoZGF0YXNldEFic2VudEZpbHRlciwgdGhpcy5zdWJ0cmFoZW5kKSwgZGVsdGEuZGVsZXRlZCAmJiBkZWx0YS5kZWxldGVkLmZpbHRlcih0aGlzLmhhcywgdGhpcykpOwogICAgICAgIGlmIChuZXdEZWx0YSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChuZXdEZWx0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0T3BlcmFuZHMobnVsbCwgdGhpcy5zdWJ0cmFoZW5kKTsKICAgICAgfQogICAgfTsKICAgIHZhciBTVUJUUkFDVERBVEFTRVRfU1VCVFJBSEVORF9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgaWYgKCF0aGlzLm1pbnVlbmQpIHJldHVybjsKICAgICAgICB2YXIgbmV3RGVsdGEgPSBnZXREZWx0YShkZWx0YS5kZWxldGVkICYmIGRlbHRhLmRlbGV0ZWQuZmlsdGVyKGRhdGFzZXRBYnNlbnRGaWx0ZXIsIHRoaXMpLCBkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldE9wZXJhbmRzKHRoaXMubWludWVuZCwgbnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU3VidHJhY3QgPSBDbGFzcyhBYnN0cmFjdERhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlN1YnRyYWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5NSU5VRU5EICsgU1VCU0NSSVBUSU9OLlNVQlRSQUhFTkQsCiAgICAgIG1pbnVlbmQ6IG51bGwsCiAgICAgIGVtaXRfbWludWVuZENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJtaW51ZW5kQ2hhbmdlZCIsICJvbGRNaW51ZW5kIiksCiAgICAgIHN1YnRyYWhlbmQ6IG51bGwsCiAgICAgIGVtaXRfc3VidHJhaGVuZENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJzdWJ0cmFoZW5kQ2hhbmdlZCIsICJvbGRTdWJ0cmFoZW5kIiksCiAgICAgIGxpc3RlbjogewogICAgICAgIG1pbnVlbmQ6IFNVQlRSQUNUREFUQVNFVF9NSU5VRU5EX0hBTkRMRVIsCiAgICAgICAgc3VidHJhaGVuZDogU1VCVFJBQ1REQVRBU0VUX1NVQlRSQUhFTkRfSEFORExFUgogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgbWludWVuZCA9IHRoaXMubWludWVuZDsKICAgICAgICB2YXIgc3VidHJhaGVuZCA9IHRoaXMuc3VidHJhaGVuZDsKICAgICAgICB0aGlzLm1pbnVlbmQgPSBudWxsOwogICAgICAgIHRoaXMuc3VidHJhaGVuZCA9IG51bGw7CiAgICAgICAgaWYgKG1pbnVlbmQgfHwgc3VidHJhaGVuZCkgdGhpcy5zZXRPcGVyYW5kcyhtaW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgc2V0T3BlcmFuZHM6IGZ1bmN0aW9uKG1pbnVlbmQsIHN1YnRyYWhlbmQpIHsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgdmFyIG9wZXJhbmRzQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgIGlmIChtaW51ZW5kIGluc3RhbmNlb2YgQWJzdHJhY3REYXRhc2V0ID09IGZhbHNlKSBtaW51ZW5kID0gbnVsbDsKICAgICAgICBpZiAoc3VidHJhaGVuZCBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCA9PSBmYWxzZSkgc3VidHJhaGVuZCA9IG51bGw7CiAgICAgICAgdmFyIG9sZE1pbnVlbmQgPSB0aGlzLm1pbnVlbmQ7CiAgICAgICAgdmFyIG9sZFN1YnRyYWhlbmQgPSB0aGlzLnN1YnRyYWhlbmQ7CiAgICAgICAgaWYgKG9sZE1pbnVlbmQgIT09IG1pbnVlbmQpIHsKICAgICAgICAgIG9wZXJhbmRzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLm1pbnVlbmQgPSBtaW51ZW5kOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5taW51ZW5kOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZE1pbnVlbmQpIG9sZE1pbnVlbmQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKG1pbnVlbmQpIG1pbnVlbmQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9taW51ZW5kQ2hhbmdlZChvbGRNaW51ZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9sZFN1YnRyYWhlbmQgIT09IHN1YnRyYWhlbmQpIHsKICAgICAgICAgIG9wZXJhbmRzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLnN1YnRyYWhlbmQgPSBzdWJ0cmFoZW5kOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5zdWJ0cmFoZW5kOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZFN1YnRyYWhlbmQpIG9sZFN1YnRyYWhlbmQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKHN1YnRyYWhlbmQpIHN1YnRyYWhlbmQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zdWJ0cmFoZW5kQ2hhbmdlZChvbGRTdWJ0cmFoZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFvcGVyYW5kc0NoYW5nZWQpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoIW1pbnVlbmQgfHwgIXN1YnRyYWhlbmQpIHsKICAgICAgICAgIGlmICh0aGlzLml0ZW1Db3VudCkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSA9IHsKICAgICAgICAgICAgZGVsZXRlZDogdGhpcy5nZXRJdGVtcygpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuaXRlbXNfKSBpZiAoIW1pbnVlbmQuaXRlbXNfW2tleV0gfHwgc3VidHJhaGVuZC5pdGVtc19ba2V5XSkgZGVsZXRlZC5wdXNoKHRoaXMuaXRlbXNfW2tleV0pOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIG1pbnVlbmQuaXRlbXNfKSBpZiAoIXRoaXMuaXRlbXNfW2tleV0gJiYgIXN1YnRyYWhlbmQuaXRlbXNfW2tleV0pIGluc2VydGVkLnB1c2gobWludWVuZC5pdGVtc19ba2V5XSk7CiAgICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldE1pbnVlbmQ6IGZ1bmN0aW9uKG1pbnVlbmQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRPcGVyYW5kcyhtaW51ZW5kLCB0aGlzLnN1YnRyYWhlbmQpOwogICAgICB9LAogICAgICBzZXRTdWJ0cmFoZW5kOiBmdW5jdGlvbihzdWJ0cmFoZW5kKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0T3BlcmFuZHModGhpcy5taW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0T3BlcmFuZHMoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU291cmNlRGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU291cmNlRGF0YXNldCIsCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uU09VUkNFLAogICAgICBzb3VyY2U6IG51bGwsCiAgICAgIGVtaXRfc291cmNlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZUNoYW5nZWQiLCAib2xkU291cmNlIiksCiAgICAgIHNvdXJjZUFkYXB0ZXJfOiBudWxsLAogICAgICBzb3VyY2VNYXBfOiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuc291cmNlQWRhcHRlcl8pIHRoaXMuc2V0U291cmNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZU1hcF8gPSB7fTsKICAgICAgICBBYnN0cmFjdERhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgc291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgdGhpcy5zb3VyY2UgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXRTb3VyY2Uoc291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgc291cmNlID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldFNvdXJjZSwgc291cmNlLCAic291cmNlQWRhcHRlcl8iKTsKICAgICAgICBpZiAodGhpcy5zb3VyY2UgIT09IHNvdXJjZSkgewogICAgICAgICAgdmFyIG9sZFNvdXJjZSA9IHRoaXMuc291cmNlOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5zb3VyY2U7CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBpdGVtc0NoYW5nZWRIYW5kbGVyID0gbGlzdGVuSGFuZGxlci5pdGVtc0NoYW5nZWQ7CiAgICAgICAgICAgIGlmIChvbGRTb3VyY2UpIHsKICAgICAgICAgICAgICBvbGRTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoaXRlbXNDaGFuZ2VkSGFuZGxlcikgaXRlbXNDaGFuZ2VkSGFuZGxlci5jYWxsKHRoaXMsIG9sZFNvdXJjZSwgewogICAgICAgICAgICAgICAgZGVsZXRlZDogb2xkU291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGl0ZW1zQ2hhbmdlZEhhbmRsZXIpIGl0ZW1zQ2hhbmdlZEhhbmRsZXIuY2FsbCh0aGlzLCBzb3VyY2UsIHsKICAgICAgICAgICAgICAgIGluc2VydGVkOiBzb3VyY2UuZ2V0SXRlbXMoKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfc291cmNlQ2hhbmdlZChvbGRTb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0U291cmNlKCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc291cmNlTWFwXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1BUEZJTFRFUl9TT1VSQ0VPQkpFQ1RfVVBEQVRFID0gZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgIHZhciBuZXdNZW1iZXIgPSB0aGlzLm1hcCA/IHRoaXMubWFwKHNvdXJjZU9iamVjdCkgOiBvYmplY3Q7CiAgICAgIGlmIChuZXdNZW1iZXIgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID09IGZhbHNlIHx8IHRoaXMuZmlsdGVyKG5ld01lbWJlcikpIG5ld01lbWJlciA9IG51bGw7CiAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgY3VyTWVtYmVyID0gc291cmNlTWFwLm1lbWJlcjsKICAgICAgaWYgKGN1ck1lbWJlciAhPT0gbmV3TWVtYmVyKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZDsKICAgICAgICBzb3VyY2VNYXAubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgIGlmIChjdXJNZW1iZXIpIHsKICAgICAgICAgIHZhciBjdXJNZW1iZXJJZCA9IGN1ck1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihjdXJNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICBpZiAoLS1tZW1iZXJNYXBbY3VyTWVtYmVySWRdID09IDApIHsKICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICAgIGRlbGV0ZWQgPSBbIGN1ck1lbWJlciBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobmV3TWVtYmVyKSB7CiAgICAgICAgICB2YXIgbmV3TWVtYmVySWQgPSBuZXdNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIGlmICh0aGlzLmFkZE1lbWJlclJlZikgdGhpcy5hZGRNZW1iZXJSZWYobmV3TWVtYmVyLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgaWYgKG1lbWJlck1hcFtuZXdNZW1iZXJJZF0pIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSA9IDE7CiAgICAgICAgICAgIGluc2VydGVkID0gWyBuZXdNZW1iZXIgXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNQVBGSUxURVJfU09VUkNFX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oc291cmNlLCBkZWx0YSkgewogICAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF87CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJZDsKICAgICAgICB2YXIgbWVtYmVyOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgbWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgICBpZiAobWVtYmVyIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSB8fCB0aGlzLmZpbHRlcihtZW1iZXIpKSBtZW1iZXIgPSBudWxsOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgbWVtYmVyOiBtZW1iZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbbWVtYmVySWRdKSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbWVtYmVySWRdKys7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lbWJlck1hcFttZW1iZXJJZF0gPSAxOwogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChtZW1iZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5hZGRNZW1iZXJSZWYpIHRoaXMuYWRkTWVtYmVyUmVmKG1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBtZW1iZXIgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLm1lbWJlcjsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmICgtLW1lbWJlck1hcFttZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFttZW1iZXJJZF07CiAgICAgICAgICAgICAgICBkZWxldGVkLnB1c2gobWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihtZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgTWFwRmlsdGVyID0gQ2xhc3MoU291cmNlRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWFwRmlsdGVyIiwKICAgICAgbWFwOiAkc2VsZiwKICAgICAgZmlsdGVyOiAkZmFsc2UsCiAgICAgIHJ1bGU6IGdldHRlcigkdHJ1ZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoTUFQRklMVEVSX1NPVVJDRU9CSkVDVF9VUERBVEUsICJ1cGRhdGUiKSwKICAgICAgYWRkTWVtYmVyUmVmOiBudWxsLAogICAgICByZW1vdmVNZW1iZXJSZWY6IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUFQRklMVEVSX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIHNldE1hcDogZnVuY3Rpb24obWFwKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtYXAgIT0gImZ1bmN0aW9uIikgbWFwID0gJHNlbGY7CiAgICAgICAgaWYgKHRoaXMubWFwICE9PSBtYXApIHsKICAgICAgICAgIHRoaXMubWFwID0gbWFwOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRGaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlcikgewogICAgICAgIGlmICh0eXBlb2YgZmlsdGVyICE9ICJmdW5jdGlvbiIpIGZpbHRlciA9ICRmYWxzZTsKICAgICAgICBpZiAodGhpcy5maWx0ZXIgIT09IGZpbHRlcikgewogICAgICAgICAgdGhpcy5maWx0ZXIgPSBmaWx0ZXI7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFJ1bGU6IGZ1bmN0aW9uKHJ1bGUpIHsKICAgICAgICBpZiAodHlwZW9mIHJ1bGUgIT0gImZ1bmN0aW9uIikgcnVsZSA9ICR0cnVlOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT09IHJ1bGUpIHsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgY3VyTWVtYmVyOwogICAgICAgIHZhciBuZXdNZW1iZXI7CiAgICAgICAgdmFyIGN1ck1lbWJlcklkOwogICAgICAgIHZhciBuZXdNZW1iZXJJZDsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIHNvdXJjZU9iamVjdElkIGluIHNvdXJjZU1hcCkgewogICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZU9iamVjdDsKICAgICAgICAgIGN1ck1lbWJlciA9IHNvdXJjZU9iamVjdEluZm8ubWVtYmVyOwogICAgICAgICAgbmV3TWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJNZW1iZXIgIT0gbmV3TWVtYmVyKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8ubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgICAgICBpZiAoY3VyTWVtYmVyKSB7CiAgICAgICAgICAgICAgY3VyTWVtYmVySWQgPSBjdXJNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbY3VyTWVtYmVySWRdLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld01lbWJlcikgewogICAgICAgICAgICAgIG5ld01lbWJlcklkID0gbmV3TWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgICAgaWYgKG5ld01lbWJlcklkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgICAgIGluc2VydGVkLnB1c2gobmV3TWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjdXJNZW1iZXJJZCBpbiB0aGlzLml0ZW1zXykgaWYgKG1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2godGhpcy5pdGVtc19bY3VyTWVtYmVySWRdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1YnNldCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3Vic2V0IiwKICAgICAgZmlsdGVyOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gIXRoaXMucnVsZShvYmplY3QpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTcGxpdCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3BsaXQiLAogICAgICBzdWJzZXRDbGFzczogQWJzdHJhY3REYXRhc2V0LAogICAgICBzdWJzZXRXcmFwcGVyQ2xhc3M6IERhdGFzZXRXcmFwcGVyLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLnJlc29sdmUoc291cmNlT2JqZWN0KTsKICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgICAgIGlmICh0eXBlb2YgcnVsZSAhPSAiZnVuY3Rpb24iKSBydWxlID0gJHRydWU7CiAgICAgICAgaWYgKHRoaXMucnVsZSAhPT0gcnVsZSkgewogICAgICAgICAgdGhpcy5ydWxlID0gcnVsZTsKICAgICAgICAgIHRoaXMua2V5TWFwLmtleUdldHRlciA9IHJ1bGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZE1lbWJlclJlZjogZnVuY3Rpb24od3JhcHBlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgd3JhcHBlci5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGluc2VydGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHJlbW92ZU1lbWJlclJlZjogZnVuY3Rpb24od3JhcHBlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgd3JhcHBlci5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBjcmVhdGVLZXlNYXAodGhpcy5rZXlNYXAsIHRoaXMucnVsZSwgdGhpcy5zdWJzZXRXcmFwcGVyQ2xhc3MsIHRoaXMuc3Vic2V0Q2xhc3MpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBnZXRTdWJzZXQ6IGZ1bmN0aW9uKGRhdGEsIGF1dG9jcmVhdGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5rZXlNYXAuZ2V0KGRhdGEsIGF1dG9jcmVhdGUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBNYXBGaWx0ZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmtleU1hcC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5rZXlNYXAgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGJpbmFyeVNlYXJjaFBvcyhhcnJheSwgbWFwKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHZhbHVlID0gbWFwLnZhbHVlOwogICAgICB2YXIgaWQgPSBtYXAub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBjbXBWYWx1ZTsKICAgICAgdmFyIGNtcElkOwogICAgICB2YXIgcG9zOwogICAgICB2YXIgaXRlbTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGl0ZW0gPSBhcnJheVtwb3NdOwogICAgICAgIGNtcFZhbHVlID0gaXRlbS52YWx1ZTsKICAgICAgICBpZiAodmFsdWUgPCBjbXBWYWx1ZSkgciA9IHBvcyAtIDE7IGVsc2UgaWYgKHZhbHVlID4gY21wVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHsKICAgICAgICAgIGNtcElkID0gaXRlbS5vYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIGlmIChpZCA8IGNtcElkKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoaWQgPiBjbXBJZCkgbCA9IHBvcyArIDE7IGVsc2UgcmV0dXJuIHBvczsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKGwgPD0gcik7CiAgICAgIHJldHVybiBwb3MgKyAoY21wVmFsdWUgPT0gdmFsdWUgPyBjbXBJZCA8IGlkIDogY21wVmFsdWUgPCB2YWx1ZSk7CiAgICB9CiAgICB2YXIgU0xJQ0VfU09VUkNFT0JKRUNUX1VQREFURSA9IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICB2YXIgc291cmNlT2JqZWN0SW5mbyA9IHRoaXMuc291cmNlTWFwX1tzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIHZhciBuZXdWYWx1ZSA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpOwogICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4XzsKICAgICAgaWYgKG5ld1ZhbHVlICE9PSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlKSB7CiAgICAgICAgdmFyIHBvcyA9IGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgdmFyIHByZXYgPSBpbmRleFtwb3MgLSAxXTsKICAgICAgICB2YXIgbmV4dCA9IGluZGV4W3BvcyArIDFdOwogICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICBpZiAocHJldiAmJiAocHJldi52YWx1ZSA+IG5ld1ZhbHVlIHx8IHByZXYudmFsdWUgPT0gbmV3VmFsdWUgJiYgcHJldi5vYmplY3QuYmFzaXNPYmplY3RJZCA+IHNvdXJjZU9iamVjdEluZm8ub2JqZWN0LmJhc2lzT2JqZWN0SWQpIHx8IG5leHQgJiYgKG5leHQudmFsdWUgPCBuZXdWYWx1ZSB8fCBuZXh0LnZhbHVlID09IG5ld1ZhbHVlICYmIG5leHQub2JqZWN0LmJhc2lzT2JqZWN0SWQgPCBzb3VyY2VPYmplY3RJbmZvLm9iamVjdC5iYXNpc09iamVjdElkKSkgewogICAgICAgICAgaW5kZXguc3BsaWNlKHBvcywgMSk7CiAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgICB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIHNsaWNlSW5kZXhTb3J0KGEsIGIpIHsKICAgICAgcmV0dXJuICsoYS52YWx1ZSA+IGIudmFsdWUpIHx8IC0oYS52YWx1ZSA8IGIudmFsdWUpIHx8IGEub2JqZWN0LmJhc2lzT2JqZWN0SWQgLSBiLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgfQogICAgdmFyIFNMSUNFX1NPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNvdXJjZSwgZGVsdGEpIHsKICAgICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhfOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIHZhciBkcm9wSW5kZXggPSBmYWxzZTsKICAgICAgICB2YXIgYnVpbGRJbmRleCA9IGZhbHNlOwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICBpZiAoZGVsZXRlZCkgewogICAgICAgICAgaWYgKGRlbGV0ZWQubGVuZ3RoID4gaW5kZXgubGVuZ3RoIC0gZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgICAgZHJvcEluZGV4ID0gdHJ1ZTsKICAgICAgICAgICAgYnVpbGRJbmRleCA9IGRlbGV0ZWQubGVuZ3RoICE9IGluZGV4Lmxlbmd0aDsKICAgICAgICAgICAgaW5kZXgubGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2VPYmplY3Q7IHNvdXJjZU9iamVjdCA9IGRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBpZiAoIWRyb3BJbmRleCkgewogICAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICAgIGluZGV4LnNwbGljZShiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ1aWxkSW5kZXgpIGZvciAodmFyIGtleSBpbiBzb3VyY2VNYXApIHsKICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtrZXldOwogICAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRlZCkgewogICAgICAgICAgYnVpbGRJbmRleCA9ICFpbmRleC5sZW5ndGg7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBpbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSB7CiAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgdmFsdWU6IHRoaXMucnVsZShzb3VyY2VPYmplY3QpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgICAgICBpZiAoIWJ1aWxkSW5kZXgpIGluZGV4LnNwbGljZShiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pLCAwLCBzb3VyY2VPYmplY3RJbmZvKTsgZWxzZSBpbmRleC5wdXNoKHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYnVpbGRJbmRleCkgaW5kZXguc29ydChzbGljZUluZGV4U29ydCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU2xpY2UgPSBDbGFzcyhTb3VyY2VEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TbGljZSIsCiAgICAgIHJ1bGU6IGdldHRlcigkdHJ1ZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoU0xJQ0VfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBpbmRleF86IG51bGwsCiAgICAgIG9yZGVyRGVzYzogZmFsc2UsCiAgICAgIG9mZnNldDogMCwKICAgICAgbGltaXQ6IDEwLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IFNMSUNFX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGVtaXRfcmFuZ2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgicmFuZ2VDaGFuZ2VkIiwgIm9sZE9mZnNldCIsICJvbGRMaW1pdCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmluZGV4XyA9IFtdOwogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0UmFuZ2U6IGZ1bmN0aW9uKG9mZnNldCwgbGltaXQpIHsKICAgICAgICB2YXIgb2xkT2Zmc2V0ID0gdGhpcy5vZmZzZXQ7CiAgICAgICAgdmFyIG9sZExpbWl0ID0gdGhpcy5saW1pdDsKICAgICAgICB2YXIgZGVsdGEgPSBmYWxzZTsKICAgICAgICBpZiAob2xkT2Zmc2V0ICE9IG9mZnNldCB8fCBvbGRMaW1pdCAhPSBsaW1pdCkgewogICAgICAgICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgICB0aGlzLmxpbWl0ID0gbGltaXQ7CiAgICAgICAgICBkZWx0YSA9IHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgICB0aGlzLmVtaXRfcmFuZ2VDaGFuZ2VkKG9sZE9mZnNldCwgb2xkTGltaXQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldE9mZnNldDogZnVuY3Rpb24ob2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0UmFuZ2Uob2Zmc2V0LCB0aGlzLmxpbWl0KTsKICAgICAgfSwKICAgICAgc2V0TGltaXQ6IGZ1bmN0aW9uKGxpbWl0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0UmFuZ2UodGhpcy5vZmZzZXQsIGxpbWl0KTsKICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSwgb3JkZXJEZXNjKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlKTsKICAgICAgICB0aGlzLm9yZGVyRGVzYyA9ICEhb3JkZXJEZXNjOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT0gcnVsZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleF87CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgaSsrKSBpbmRleFtpXS52YWx1ZSA9IHJ1bGUoaW5kZXhbaV0ub2JqZWN0KTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICBpbmRleC5zb3J0KHNsaWNlSW5kZXhTb3J0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5vZmZzZXQ7CiAgICAgICAgdmFyIGVuZCA9IHN0YXJ0ICsgdGhpcy5saW1pdDsKICAgICAgICBpZiAodGhpcy5vcmRlckRlc2MpIHsKICAgICAgICAgIHN0YXJ0ID0gdGhpcy5pbmRleF8ubGVuZ3RoIC0gZW5kOwogICAgICAgICAgZW5kID0gc3RhcnQgKyB0aGlzLmxpbWl0OwogICAgICAgIH0KICAgICAgICB2YXIgY3VyU2V0ID0gYmFzaXMub2JqZWN0LnNsaWNlKHRoaXMubWVtYmVyc18pOwogICAgICAgIHZhciBuZXdTZXQgPSB0aGlzLmluZGV4Xy5zbGljZShNYXRoLm1heCgwLCBzdGFydCksIE1hdGgubWF4KDAsIGVuZCkpOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IG5ld1NldFtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBpdGVtLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKGN1clNldFtvYmplY3RJZF0pIGRlbGV0ZSBjdXJTZXRbb2JqZWN0SWRdOyBlbHNlIHsKICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChpdGVtLm9iamVjdCk7CiAgICAgICAgICAgIHRoaXMubWVtYmVyc19bb2JqZWN0SWRdID0gaXRlbS5vYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGN1clNldCkgZGVsZXRlIHRoaXMubWVtYmVyc19bb2JqZWN0SWRdOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCB2YWx1ZXMoY3VyU2V0KSkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQ0xPVURfU09VUkNFT0JKRUNUX1VQREFURSA9IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgdmFyIHNvdXJjZU9iamVjdElkID0gc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBvbGRMaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICB2YXIgbmV3TGlzdCA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF0ubGlzdCA9IHt9OwogICAgICB2YXIgbGlzdCA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpOwogICAgICB2YXIgZGVsdGE7CiAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICB2YXIgc3Vic2V0OwogICAgICBpZiAoQXJyYXkuaXNBcnJheShsaXN0KSkgZm9yICh2YXIgaiA9IDA7IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgc3Vic2V0ID0gdGhpcy5rZXlNYXAuZ2V0KGxpc3Rbal0sIHRydWUpOwogICAgICAgIGlmIChzdWJzZXQgJiYgIXN1YnNldC5oYXMoc291cmNlT2JqZWN0KSkgewogICAgICAgICAgc3Vic2V0SWQgPSBzdWJzZXQuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIG5ld0xpc3Rbc3Vic2V0SWRdID0gc3Vic2V0OwogICAgICAgICAgaWYgKCFvbGRMaXN0W3N1YnNldElkXSkgewogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgIGluc2VydGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbc3Vic2V0SWRdID0gMTsKICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgc3Vic2V0SWQgaW4gb2xkTGlzdCkgaWYgKCFuZXdMaXN0W3N1YnNldElkXSkgewogICAgICAgIHZhciBzdWJzZXQgPSBvbGRMaXN0W3N1YnNldElkXTsKICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgIGRlbGV0ZSBtZW1iZXJNYXBbc3Vic2V0SWRdOwogICAgICAgICAgZGVsZXRlZC5wdXNoKHN1YnNldCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICB9OwogICAgdmFyIENMT1VEX1NPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFzZXQsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgdXBkYXRlSGFuZGxlciA9IHRoaXMucnVsZUV2ZW50czsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgdmFyIHN1YnNldDsKICAgICAgICB2YXIgc3Vic2V0SWQ7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZSh0cnVlKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gYXJyYXlbaV07IGkrKykgewogICAgICAgICAgdmFyIGxpc3QgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdCwKICAgICAgICAgICAgbGlzdDoge30KICAgICAgICAgIH07CiAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMCwgZHVwRmlsdGVyID0ge307IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHN1YnNldCA9IHRoaXMua2V5TWFwLmdldChsaXN0W2pdLCB0cnVlKTsKICAgICAgICAgICAgaWYgKHN1YnNldCAmJiAhZHVwRmlsdGVyW3N1YnNldC5iYXNpc09iamVjdElkXSkgewogICAgICAgICAgICAgIHN1YnNldElkID0gc3Vic2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgZHVwRmlsdGVyW3N1YnNldElkXSA9IHRydWU7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mby5saXN0W3N1YnNldElkXSA9IHN1YnNldDsKICAgICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgICAgbWVtYmVyTWFwW3N1YnNldElkXSA9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBhcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIHZhciBsaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBsaXN0KSB7CiAgICAgICAgICAgIHN1YnNldCA9IGxpc3Rbc3Vic2V0SWRdOwogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgZGVsZXRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW3N1YnNldElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgfQogICAgfTsKICAgIHZhciBDbG91ZCA9IENsYXNzKFNvdXJjZURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNsb3VkIiwKICAgICAgc3Vic2V0Q2xhc3M6IEFic3RyYWN0RGF0YXNldCwKICAgICAgc3Vic2V0V3JhcHBlckNsYXNzOiBEYXRhc2V0V3JhcHBlciwKICAgICAgcnVsZTogZ2V0dGVyKCRmYWxzZSksCiAgICAgIHJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMoQ0xPVURfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogJHNlbGYsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogQ0xPVURfU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBjcmVhdGVLZXlNYXAodGhpcy5rZXlNYXAsIHRoaXMucnVsZSwgdGhpcy5zdWJzZXRXcmFwcGVyQ2xhc3MsIHRoaXMuc3Vic2V0Q2xhc3MpOwogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0U3Vic2V0OiBmdW5jdGlvbihkYXRhLCBhdXRvY3JlYXRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChkYXRhLCBhdXRvY3JlYXRlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMua2V5TWFwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmtleU1hcCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZVJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMsCiAgICAgIE1lcmdlOiBNZXJnZSwKICAgICAgU3VidHJhY3Q6IFN1YnRyYWN0LAogICAgICBTb3VyY2VEYXRhc2V0OiBTb3VyY2VEYXRhc2V0LAogICAgICBNYXBGaWx0ZXI6IE1hcEZpbHRlciwKICAgICAgU3Vic2V0OiBTdWJzZXQsCiAgICAgIFNwbGl0OiBTcGxpdCwKICAgICAgU2xpY2U6IFNsaWNlLAogICAgICBDbG91ZDogQ2xvdWQKICAgIH07CiAgfSwKICAiZS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2QuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBBYnN0cmFjdERhdGFzZXQgPSBiYXNpcy5kYXRhLkFic3RyYWN0RGF0YXNldDsKICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IGJhc2lzLmRhdGEuRGF0YXNldFdyYXBwZXI7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIE1hcEZpbHRlciA9IGJhc2lzLmRhdGEuZGF0YXNldC5NYXBGaWx0ZXI7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNtcFZhbHVlOwogICAgICB2YXIgbCA9IDA7CiAgICAgIHZhciByID0gYXJyYXkubGVuZ3RoIC0gMTsKICAgICAgZG8gewogICAgICAgIHBvcyA9IGwgKyByID4+IDE7CiAgICAgICAgY21wVmFsdWUgPSBhcnJheVtwb3NdIHx8IDA7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSByZXR1cm4gdmFsdWUgPT0gY21wVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIEluZGV4ID0gQ2xhc3MoVmFsdWUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4IiwKICAgICAgYXV0b0Rlc3Ryb3k6IHRydWUsCiAgICAgIGluZGV4Q2FjaGVfOiBudWxsLAogICAgICB2YWx1ZUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHVwZGF0ZUV2ZW50czoge30sCiAgICAgIHZhbHVlOiAwLAogICAgICBzZXROdWxsT25FbWl0dGVyRGVzdHJveTogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhDYWNoZV8gPSB7fTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkge30sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7fSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7fSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpIHx8IDA7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFZhbHVlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleENhY2hlXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1bSA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TdW0iLAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgKz0gdmFsdWU7CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSAtPSB2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtIG9sZFZhbHVlICsgbmV3VmFsdWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDb3VudCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db3VudCIsCiAgICAgIHZhbHVlR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlICs9IHZhbHVlOwogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgLT0gdmFsdWU7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtICEhb2xkVmFsdWUgKyAhIW5ld1ZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQXZnID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkF2ZyIsCiAgICAgIHN1bV86IDAsCiAgICAgIGNvdW50XzogMCwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gdmFsdWU7CiAgICAgICAgdGhpcy5jb3VudF8gKz0gMTsKICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF87CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zdW1fIC09IHZhbHVlOwogICAgICAgIHRoaXMuY291bnRfIC09IDE7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuY291bnRfID8gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF8gOiAwOwogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gbmV3VmFsdWUgLSBvbGRWYWx1ZTsKICAgICAgICB0aGlzLnNldCh0aGlzLnN1bV8gLyB0aGlzLmNvdW50Xyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFZlY3RvckluZGV4ID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlZlY3RvckluZGV4IiwKICAgICAgaXRlbUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHZlY3Rvcl86IG51bGwsCiAgICAgIHZhbHVlOiB1bmRlZmluZWQsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudmVjdG9yXyA9IFtdOwogICAgICAgIEluZGV4LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGFkZF86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLnZlY3Rvcl8uc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyh0aGlzLnZlY3Rvcl8sIHZhbHVlKSwgMCwgdmFsdWUpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMudmVjdG9yR2V0dGVyKHRoaXMudmVjdG9yXyk7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCB2YWx1ZSksIDEpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMudmVjdG9yR2V0dGVyKHRoaXMudmVjdG9yXyk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG51bGwpIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgb2xkVmFsdWUpLCAxKTsKICAgICAgICBpZiAobmV3VmFsdWUgIT09IG51bGwpIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgbmV3VmFsdWUpLCAwLCBuZXdWYWx1ZSk7CiAgICAgICAgdGhpcy5zZXQodGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKSk7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJzdHJpbmciIHx8IHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiA/IHZhbHVlIDogbnVsbDsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnZlY3Rvcl8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBNaW4gPSBDbGFzcyhWZWN0b3JJbmRleCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWluIiwKICAgICAgdmVjdG9yR2V0dGVyOiBmdW5jdGlvbih2ZWN0b3IpIHsKICAgICAgICByZXR1cm4gdmVjdG9yWzBdOwogICAgICB9CiAgICB9KTsKICAgIHZhciBNYXggPSBDbGFzcyhWZWN0b3JJbmRleCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWF4IiwKICAgICAgdmVjdG9yR2V0dGVyOiBmdW5jdGlvbih2ZWN0b3IpIHsKICAgICAgICByZXR1cm4gdmVjdG9yW3ZlY3Rvci5sZW5ndGggLSAxXTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgaW5kZXhDb25zdHJ1Y3RvcnNfID0ge307CiAgICB2YXIgREFUQVNFVF9JTkRFWF9IQU5ETEVSID0gewogICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZW1vdmVEYXRhc2V0SW5kZXgodGhpcywgb2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIEluZGV4Q29uc3RydWN0b3IoKSB7fQogICAgZnVuY3Rpb24gZ2V0SW5kZXhDb25zdHJ1Y3RvcihCYXNlQ2xhc3MsIGdldHRlciwgZXZlbnRzKSB7CiAgICAgIGlmICghQ2xhc3MuaXNDbGFzcyhCYXNlQ2xhc3MpIHx8ICFCYXNlQ2xhc3MuaXNTdWJjbGFzc09mKEluZGV4KSkgdGhyb3cgIldyb25nIGNsYXNzIGZvciBpbmRleCBjb25zdHJ1Y3RvciI7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICBldmVudHMgPSBldmVudHMgfHwgInVwZGF0ZSI7CiAgICAgIGlmICh0eXBlb2YgZXZlbnRzICE9ICJzdHJpbmciKSB0aHJvdyAiRXZlbnRzIG11c3QgYmUgYSBldmVudCBuYW1lcyBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIjsKICAgICAgZXZlbnRzID0gZXZlbnRzLnRyaW0oKS5zcGxpdCgiICIpLnNvcnQoKTsKICAgICAgdmFyIGluZGV4SWQgPSBbIEJhc2VDbGFzcy5iYXNpc0NsYXNzSWRfLCBnZXR0ZXIuYmFzaXNHZXR0ZXJJZF8sIGV2ZW50cyBdLmpvaW4oIl8iKTsKICAgICAgdmFyIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgIGlmIChpbmRleENvbnN0cnVjdG9yKSByZXR1cm4gaW5kZXhDb25zdHJ1Y3Rvci5vd25lcjsKICAgICAgdmFyIGV2ZW50c18gPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIGV2ZW50c19bZXZlbnRzW2ldXSA9IHRydWU7CiAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBuZXcgSW5kZXhDb25zdHJ1Y3RvcjsKICAgICAgaW5kZXhDb25zdHJ1Y3RvcnNfW2luZGV4SWRdID0gewogICAgICAgIG93bmVyOiBpbmRleENvbnN0cnVjdG9yLAogICAgICAgIGluZGV4Q2xhc3M6IEJhc2VDbGFzcy5zdWJjbGFzcyh7CiAgICAgICAgICBpbmRleElkOiBpbmRleElkLAogICAgICAgICAgdXBkYXRlRXZlbnRzOiBldmVudHNfLAogICAgICAgICAgdmFsdWVHZXR0ZXI6IGdldHRlcgogICAgICAgIH0pCiAgICAgIH07CiAgICAgIGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZCA9IGluZGV4SWQ7CiAgICAgIHJldHVybiBpbmRleENvbnN0cnVjdG9yOwogICAgfQogICAgdmFyIGNyZWF0ZUluZGV4Q29uc3RydWN0b3IgPSBmdW5jdGlvbihJbmRleENsYXNzLCBkZWZHZXR0ZXIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgdmFyIGRhdGFzZXQ7CiAgICAgICAgaWYgKGV2ZW50cyBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCB8fCBldmVudHMgaW5zdGFuY2VvZiBEYXRhc2V0V3JhcHBlcikgewogICAgICAgICAgZGF0YXNldCA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlciA9IGFyZ3VtZW50c1syXTsKICAgICAgICB9CiAgICAgICAgaWYgKCFnZXR0ZXIpIHsKICAgICAgICAgIGdldHRlciA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAoZXZlbnRzKSBpZiAodHlwZW9mIGdldHRlciA9PSAic3RyaW5nIiAmJiBnZXR0ZXIuc3BsaXQoL1xzKy8pLnNvbWUoZnVuY3Rpb24oZSkgewogICAgICAgICAgcmV0dXJuIGUgaW4gYmFzaXMuZXZlbnQuZXZlbnRzOwogICAgICAgIH0pIHx8IEFycmF5LmlzQXJyYXkoZ2V0dGVyKSAmJiBnZXR0ZXIuc29tZShmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXR1cm4gZSBpbiBiYXNpcy5ldmVudC5ldmVudHM7CiAgICAgICAgfSkpIGJhc2lzLmRldi53YXJuKCJldmVudHMgbXVzdCBiZSBiZWZvcmUgZ2V0dGVyIGluIGJhc2lzLmRhdGEuaW5kZXggY29uc3RydWN0b3IiKTsKICAgICAgICB2YXIgaW5kZXhDb25zdHJ1Y3RvciA9IGdldEluZGV4Q29uc3RydWN0b3IoSW5kZXhDbGFzcywgZ2V0dGVyIHx8IGRlZkdldHRlciwgZXZlbnRzKTsKICAgICAgICBpZiAoZGF0YXNldCkgcmV0dXJuIGdldERhdGFzZXRJbmRleChkYXRhc2V0LCBpbmRleENvbnN0cnVjdG9yKTsgZWxzZSByZXR1cm4gaW5kZXhDb25zdHJ1Y3RvcjsKICAgICAgfTsKICAgIH07CiAgICB2YXIgY291bnQgPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKENvdW50LCBiYXNpcy5mbi4kdHJ1ZSk7CiAgICB2YXIgc3VtID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihTdW0pOwogICAgdmFyIGF2ZyA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoQXZnKTsKICAgIHZhciBtaW4gPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKE1pbik7CiAgICB2YXIgbWF4ID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihNYXgpOwogICAgZnVuY3Rpb24gYXBwbHlJbmRleERlbHRhKGluZGV4LCBpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgaW5kZXhDYWNoZSA9IGluZGV4LmluZGV4Q2FjaGVfOwogICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgIGluZGV4LmxvY2soKTsKICAgICAgaWYgKGluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBpbnNlcnRlZFtpKytdOyApIHsKICAgICAgICB2YXIgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgaW5kZXhDYWNoZVtvYmplY3QuYmFzaXNPYmplY3RJZF0gPSBuZXdWYWx1ZTsKICAgICAgICBpbmRleC5hZGRfKG5ld1ZhbHVlKTsKICAgICAgfQogICAgICBpZiAoZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gZGVsZXRlZFtpKytdOyApIHsKICAgICAgICBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGluZGV4LnJlbW92ZV8oaW5kZXhDYWNoZVtvYmplY3RJZF0pOwogICAgICAgIGRlbGV0ZSBpbmRleENhY2hlW29iamVjdElkXTsKICAgICAgfQogICAgICBpbmRleC51bmxvY2soKTsKICAgIH0KICAgIHZhciBJVEVNX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgICIqIjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIHZhciBpbmRleDsKICAgICAgICB2YXIgZXZlbnRUeXBlID0gZXZlbnQudHlwZTsKICAgICAgICB2YXIgb2JqZWN0ID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBmb3IgKHZhciBpbmRleElkIGluIGluZGV4ZXMpIHsKICAgICAgICAgIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgICAgIGlmIChpbmRleC51cGRhdGVFdmVudHNbZXZlbnRUeXBlXSkgewogICAgICAgICAgICBvbGRWYWx1ZSA9IGluZGV4LmluZGV4Q2FjaGVfW29iamVjdElkXTsKICAgICAgICAgICAgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICBpbmRleC51cGRhdGVfKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaW5kZXguaW5kZXhDYWNoZV9bb2JqZWN0SWRdID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5hZGRIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5yZW1vdmVIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgYXBwbHlJbmRleERlbHRhKGluZGV4ZXNbaW5kZXhJZF0sIGRlbHRhLmluc2VydGVkLCBkZWx0YS5kZWxldGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgcmVtb3ZlRGF0YXNldEluZGV4KHRoaXMsIGluZGV4ZXNbaW5kZXhJZF0pOwogICAgICB9CiAgICB9OwogICAgdmFyIGRhdGFzZXRJbmRleGVzID0ge307CiAgICBmdW5jdGlvbiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3RvcikgewogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvciBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IgPT0gZmFsc2UpIHRocm93ICJpbmRleENvbnN0cnVjdG9yIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgSW5kZXhDb25zdHJ1Y3RvciI7CiAgICAgIHZhciBkYXRhc2V0SWQgPSBkYXRhc2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbZGF0YXNldElkXTsKICAgICAgaWYgKCFpbmRleGVzKSB7CiAgICAgICAgaW5kZXhlcyA9IGRhdGFzZXRJbmRleGVzW2RhdGFzZXRJZF0gPSB7fTsKICAgICAgICBkYXRhc2V0LmFkZEhhbmRsZXIoREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIpOwogICAgICAgIERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSLml0ZW1zQ2hhbmdlZC5jYWxsKGRhdGFzZXQsIGRhdGFzZXQsIHsKICAgICAgICAgIGluc2VydGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgaW5kZXhJZCA9IGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZDsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgaWYgKCFpbmRleCkgewogICAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgICAgaWYgKCFpbmRleENvbnN0cnVjdG9yKSB0aHJvdyAiV3JvbmcgaW5kZXggY29uc3RydWN0b3IiOwogICAgICAgIGluZGV4ID0gbmV3IGluZGV4Q29uc3RydWN0b3IuaW5kZXhDbGFzczsKICAgICAgICBpbmRleC5hZGRIYW5kbGVyKERBVEFTRVRfSU5ERVhfSEFORExFUiwgZGF0YXNldCk7CiAgICAgICAgaW5kZXhlc1tpbmRleElkXSA9IGluZGV4OwogICAgICAgIGFwcGx5SW5kZXhEZWx0YShpbmRleCwgZGF0YXNldC5nZXRJdGVtcygpKTsKICAgICAgfQogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVEYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXgpIHsKICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICBpZiAoaW5kZXhlcyAmJiBpbmRleGVzW2luZGV4LmluZGV4SWRdKSB7CiAgICAgICAgZGVsZXRlIGluZGV4ZXNbaW5kZXguaW5kZXhJZF07CiAgICAgICAgaW5kZXgucmVtb3ZlSGFuZGxlcihEQVRBU0VUX0lOREVYX0hBTkRMRVIsIGRhdGFzZXQpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBpbmRleGVzKSByZXR1cm47CiAgICAgICAgZGF0YXNldC5yZW1vdmVIYW5kbGVyKERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSKTsKICAgICAgICBkZWxldGUgZGF0YXNldEluZGV4ZXNbZGF0YXNldC5iYXNpc09iamVjdElkXTsKICAgICAgfQogICAgfQogICAgdmFyIENhbGNJbmRleFByZXNldCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNhbGNJbmRleFByZXNldCIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5kZXhlczoge30sCiAgICAgIGNhbGM6IGJhc2lzLmZuLiRudWxsCiAgICB9KTsKICAgIHZhciBjYWxjSW5kZXhQcmVzZXRTZWVkID0gMTsKICAgIGZ1bmN0aW9uIGdldFVuaXF1ZUNhbGNJbmRleElkKCkgewogICAgICByZXR1cm4gImNhbGMtaW5kZXgtcHJlc2V0LSIgKyBiYXNpcy5udW1iZXIubGVhZChjYWxjSW5kZXhQcmVzZXRTZWVkKyssIDgpOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mUmFuZ2UoZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIG1pbkluZGV4ID0gIm1pbl8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIG1heEluZGV4ID0gIm1heF8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgaW5kZXhlc1ttaW5JbmRleF0gPSBtaW4oZXZlbnRzLCBnZXR0ZXIpOwogICAgICBpbmRleGVzW21heEluZGV4XSA9IG1heChldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIChnZXR0ZXIob2JqZWN0KSAtIGluZGV4W21pbkluZGV4XSkgLyAoaW5kZXhbbWF4SW5kZXhdIC0gaW5kZXhbbWluSW5kZXhdKTsKICAgICAgfTsKICAgICAgcmV0dXJuIGNhbGMucHJlc2V0ID0gbmV3IENhbGNJbmRleFByZXNldCh7CiAgICAgICAgaW5kZXhlczogaW5kZXhlcywKICAgICAgICBjYWxjOiBjYWxjCiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mTWF4KGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHZhciBtYXhJbmRleCA9ICJtYXhfIiArIGdldFVuaXF1ZUNhbGNJbmRleElkKCk7CiAgICAgIHZhciBpbmRleGVzID0ge307CiAgICAgIGluZGV4ZXNbbWF4SW5kZXhdID0gbWF4KGV2ZW50cywgZ2V0dGVyKTsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlciB8fCBldmVudHMpOwogICAgICB2YXIgY2FsYyA9IGZ1bmN0aW9uKGRhdGEsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdCkgLyBpbmRleFttYXhJbmRleF07CiAgICAgIH07CiAgICAgIHJldHVybiBjYWxjLnByZXNldCA9IG5ldyBDYWxjSW5kZXhQcmVzZXQoewogICAgICAgIGluZGV4ZXM6IGluZGV4ZXMsCiAgICAgICAgY2FsYzogY2FsYwogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHBlcmNlbnRPZlN1bShnZXR0ZXIsIGV2ZW50cykgewogICAgICB2YXIgc3VtSW5kZXggPSAic3VtXyIgKyBnZXRVbmlxdWVDYWxjSW5kZXhJZCgpOwogICAgICB2YXIgaW5kZXhlcyA9IHt9OwogICAgICBpbmRleGVzW3N1bUluZGV4XSA9IHN1bShldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGdldHRlcihvYmplY3QpIC8gaW5kZXhbc3VtSW5kZXhdOwogICAgICB9OwogICAgICByZXR1cm4gY2FsYy5wcmVzZXQgPSBuZXcgQ2FsY0luZGV4UHJlc2V0KHsKICAgICAgICBpbmRleGVzOiBpbmRleGVzLAogICAgICAgIGNhbGM6IGNhbGMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgSW5kZXhNYXAgPSBDbGFzcyhNYXBGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4TWFwIiwKICAgICAgY2FsY3M6IG51bGwsCiAgICAgIGluZGV4ZXM6IG51bGwsCiAgICAgIGluZGV4ZXNfOiBudWxsLAogICAgICBpbmRleGVzQmluZF86IG51bGwsCiAgICAgIHRpbWVyXzogdW5kZWZpbmVkLAogICAgICBpbmRleFVwZGF0ZWQ6IG51bGwsCiAgICAgIGluZGV4VmFsdWVzOiBudWxsLAogICAgICBtZW1iZXJTb3VyY2VNYXA6IG51bGwsCiAgICAgIGtleU1hcDogbnVsbCwKICAgICAgbWFwOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChpdGVtLCB0cnVlKTsKICAgICAgfSwKICAgICAgYWRkTWVtYmVyUmVmOiBmdW5jdGlvbihtZW1iZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXSA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5tZW1iZXIpIG1lbWJlci5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLm1lbWJlciwgdGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXS51cGRhdGVkID0gdHJ1ZTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCA+IDApIHRoaXMuY2FsY01lbWJlcihtZW1iZXIpOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKG1lbWJlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4ubWVtYmVyKSBtZW1iZXIucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5tZW1iZXIsIHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFNvdXJjZSkgewogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZW1pdF9zb3VyY2VDaGFuZ2VkLmNhbGwodGhpcywgb2xkU291cmNlKTsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzXykgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleGVzX1tpbmRleE5hbWVdOwogICAgICAgICAgaWYgKG9sZFNvdXJjZSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgICAgIHJlbW92ZURhdGFzZXRJbmRleChvbGRTb3VyY2UsIHRoaXMuaW5kZXhlc1tpbmRleE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSkgdGhpcy5hZGRJbmRleChpbmRleE5hbWUsIGdldERhdGFzZXRJbmRleCh0aGlzLnNvdXJjZSwgaW5kZXgpKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIGluZGV4OiB7CiAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICB2YXIgaW5kZXhNYXAgPSB0aGlzLmluZGV4TWFwOwogICAgICAgICAgICBpbmRleE1hcC5pbmRleFZhbHVlc1t0aGlzLmtleV0gPSBzZW5kZXIudmFsdWU7CiAgICAgICAgICAgIGluZGV4TWFwLmluZGV4VXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIGluZGV4TWFwLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1lbWJlcjogewogICAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgICAgIGlmIChvYmplY3Quc3Vic2NyaWJlckNvdW50ID4gMCkgdGhpcy5jYWxjTWVtYmVyKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBydWxlRXZlbnRzOiBiYXNpcy5kYXRhLmRhdGFzZXQuY3JlYXRlUnVsZUV2ZW50cyhmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5ydWxlRXZlbnRzLnVwZGF0ZS5jYWxsKHRoaXMsIHNlbmRlciwgZGVsdGEpOwogICAgICAgIHRoaXMuc291cmNlTWFwX1tzZW5kZXIuYmFzaXNPYmplY3RJZF0udXBkYXRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZWNhbGNSZXF1ZXN0KCk7CiAgICAgIH0sICJ1cGRhdGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZWNhbGMgPSB0aGlzLnJlY2FsYy5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSB7fTsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IHt9OwogICAgICAgIHZhciBpbmRleGVzID0gdGhpcy5pbmRleGVzOwogICAgICAgIHRoaXMuaW5kZXhlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXhlc18gPSB7fTsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0ge307CiAgICAgICAgdmFyIGNhbGNzID0gdGhpcy5jYWxjczsKICAgICAgICB0aGlzLmNhbGNzID0ge307CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBuZXcgS2V5T2JqZWN0TWFwKGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgY29uZmlnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoY29uZmlnKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzLmtleU1hcCkpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGluZGV4ZXMsIHRoaXMuYWRkSW5kZXgsIHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGNhbGNzLCB0aGlzLmFkZENhbGMsIHRoaXMpOwogICAgICB9LAogICAgICBhZGRJbmRleDogZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgIGlmICghdGhpcy5pbmRleGVzW2tleV0pIHsKICAgICAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4ZXNfW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLmluZGV4ZXNfW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc291cmNlID8gZ2V0RGF0YXNldEluZGV4KHRoaXMuc291cmNlLCBpbmRleCkgOiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgewogICAgICAgICAgICB0aGlzLmluZGV4VmFsdWVzW2tleV0gPSBpbmRleC52YWx1ZTsKICAgICAgICAgICAgdGhpcy5pbmRleGVzW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgdGhpcy5pbmRleGVzQmluZF9ba2V5XSA9IHsKICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICBpbmRleE1hcDogdGhpcwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmluZGV4OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICAgIGluZGV4LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcy5pbmRleGVzQmluZF9ba2V5XSk7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIuY2hhbmdlKSBsaXN0ZW5IYW5kbGVyLmNoYW5nZS5jYWxsKHRoaXMuaW5kZXhlc0JpbmRfW2tleV0sIGluZGV4LCBpbmRleC52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBzaG91bGQgYmUgaW5zdGFuY2Ugb2YgYGJhc2lzLmRhdGEuaW5kZXguSW5kZXhgIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVJbmRleDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHRoaXMuaW5kZXhlc19ba2V5XSB8fCB0aGlzLmluZGV4ZXNba2V5XSkgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXhlc1trZXldICYmIHRoaXMubGlzdGVuLmluZGV4KSB0aGlzLmluZGV4ZXNba2V5XS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLmluZGV4LCB0aGlzLmluZGV4ZXNCaW5kX1trZXldKTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4VmFsdWVzW2tleV07CiAgICAgICAgICBkZWxldGUgdGhpcy5pbmRleGVzQmluZF9ba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNfW2tleV07CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRDYWxjOiBmdW5jdGlvbihuYW1lLCBjYWxjQ2ZnKSB7CiAgICAgICAgaWYgKGNhbGNDZmcgaW5zdGFuY2VvZiBDYWxjSW5kZXhQcmVzZXQpIHsKICAgICAgICAgIHRoaXMuY2FsY3NbbmFtZV0gPSBjYWxjQ2ZnLmNhbGM7CiAgICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gY2FsY0NmZy5pbmRleGVzKSB0aGlzLmFkZEluZGV4KGluZGV4TmFtZSwgY2FsY0NmZy5pbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0gZWxzZSB0aGlzLmNhbGNzW25hbWVdID0gY2FsY0NmZzsKICAgICAgICB0aGlzLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2FsYzogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBjYWxjQ2ZnID0gdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgICBpZiAoY2FsY0NmZyAmJiBjYWxjQ2ZnLnByZXNldCBpbnN0YW5jZW9mIENhbGNJbmRleFByZXNldCkgewogICAgICAgICAgdmFyIGluZGV4ZXMgPSBjYWxjQ2ZnLnByZXNldC5pbmRleGVzOwogICAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIGluZGV4ZXMpIHRoaXMucmVtb3ZlSW5kZXgoaW5kZXhOYW1lLCBpbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS5sb2NrKCk7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS51bmxvY2soKTsKICAgICAgfSwKICAgICAgcmVjYWxjUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy5yZWNhbGMpOwogICAgICB9LAogICAgICByZWNhbGM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGlkeCBpbiB0aGlzLml0ZW1zXykgdGhpcy5jYWxjTWVtYmVyKHRoaXMuaXRlbXNfW2lkeF0pOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgIH0sCiAgICAgIGNhbGNNZW1iZXI6IGZ1bmN0aW9uKG1lbWJlcikgewogICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSB0aGlzLnNvdXJjZU1hcF9bdGhpcy5tZW1iZXJTb3VyY2VNYXBbbWVtYmVyLmJhc2lzT2JqZWN0SWRdXTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCAmJiAoc291cmNlT2JqZWN0LnVwZGF0ZWQgfHwgdGhpcy5pbmRleFVwZGF0ZWQpKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3QudXBkYXRlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgIHZhciBvbGRWYWx1ZTsKICAgICAgICAgIHZhciB1cGRhdGU7CiAgICAgICAgICBmb3IgKHZhciBjYWxjTmFtZSBpbiB0aGlzLmNhbGNzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5jYWxjc1tjYWxjTmFtZV0oc291cmNlT2JqZWN0LnNvdXJjZU9iamVjdC5kYXRhLCB0aGlzLmluZGV4VmFsdWVzLCBzb3VyY2VPYmplY3Quc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgb2xkVmFsdWUgPSBtZW1iZXIuZGF0YVtjYWxjTmFtZV07CiAgICAgICAgICAgIGlmIChtZW1iZXIuZGF0YVtjYWxjTmFtZV0gIT09IG5ld1ZhbHVlICYmICh0eXBlb2YgbmV3VmFsdWUgIT0gIm51bWJlciIgfHwgdHlwZW9mIG9sZFZhbHVlICE9ICJudW1iZXIiIHx8ICFpc05hTihuZXdWYWx1ZSkgfHwgIWlzTmFOKG9sZFZhbHVlKSkpIHsKICAgICAgICAgICAgICBkYXRhW2NhbGNOYW1lXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cGRhdGUpIG1lbWJlci51cGRhdGUoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRNZW1iZXI6IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoc291cmNlT2JqZWN0LCB0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICAgIHRoaXMuY2FsY3MgPSBudWxsOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gbnVsbDsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSBudWxsOwogICAgICAgIHRoaXMua2V5TWFwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmtleU1hcCA9IG51bGw7CiAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIHRoaXMuaW5kZXhlcykgdGhpcy5yZW1vdmVJbmRleChpbmRleE5hbWUpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbmRleENvbnN0cnVjdG9yOiBJbmRleENvbnN0cnVjdG9yLAogICAgICBjcmVhdGVJbmRleENvbnN0cnVjdG9yOiBjcmVhdGVJbmRleENvbnN0cnVjdG9yLAogICAgICBnZXREYXRhc2V0SW5kZXg6IGdldERhdGFzZXRJbmRleCwKICAgICAgcmVtb3ZlRGF0YXNldEluZGV4OiByZW1vdmVEYXRhc2V0SW5kZXgsCiAgICAgIEluZGV4OiBJbmRleCwKICAgICAgQ291bnQ6IENvdW50LAogICAgICBTdW06IFN1bSwKICAgICAgQXZnOiBBdmcsCiAgICAgIFZlY3RvckluZGV4OiBWZWN0b3JJbmRleCwKICAgICAgTWluOiBNaW4sCiAgICAgIE1heDogTWF4LAogICAgICBjb3VudDogY291bnQsCiAgICAgIHN1bTogc3VtLAogICAgICBhdmc6IGF2ZywKICAgICAgbWF4OiBtYXgsCiAgICAgIG1pbjogbWluLAogICAgICBDYWxjSW5kZXhQcmVzZXQ6IENhbGNJbmRleFByZXNldCwKICAgICAgcGVyY2VudE9mUmFuZ2U6IHBlcmNlbnRPZlJhbmdlLAogICAgICBwZXJjZW50T2ZNYXg6IHBlcmNlbnRPZk1heCwKICAgICAgcGVyY2VudE9mU3VtOiBwZXJjZW50T2ZTdW0sCiAgICAgIEluZGV4TWFwOiBJbmRleE1hcAogICAgfTsKICB9LAogICJmLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBnZXR0ZXIgPSBiYXNpcy5nZXR0ZXI7CiAgICB2YXIgY2xlYW5lciA9IGJhc2lzLmNsZWFuZXI7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIFNUQVRFID0gYmFzaXMuZGF0YS5TVEFURTsKICAgIHZhciBQcm9wZXJ0eSA9IFZhbHVlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlByb3BlcnR5IiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiBmYWxzZSwKICAgICAgaW5pdDogZnVuY3Rpb24oaW5pdFZhbHVlLCBoYW5kbGVyLCBwcm94eSkgewogICAgICAgIHRoaXMudmFsdWUgPSBpbml0VmFsdWU7CiAgICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICB0aGlzLnByb3h5ID0gcHJveHk7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgT0JKRUNUU0VUX1NUQVRFX1BSSU9SSVRZID0gU1RBVEUucHJpb3JpdHk7CiAgICB2YXIgT0JKRUNUU0VUX0hBTkRMRVIgPSB7CiAgICAgIHN0YXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKGZhbHNlLCB0cnVlKTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSk7CiAgICAgIH0sCiAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKHRydWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB0aGlzLnJlbW92ZShvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgdmFyIE9iamVjdFNldCA9IFZhbHVlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk9iamVjdFNldCIsCiAgICAgIG9iamVjdHM6IG51bGwsCiAgICAgIHZhbHVlOiAwLAogICAgICB2YWx1ZUNoYW5nZWRfOiBmYWxzZSwKICAgICAgY2FsY3VsYXRlVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlICsgMTsKICAgICAgfSwKICAgICAgY2FsY3VsYXRlT25Jbml0OiBmYWxzZSwKICAgICAgc3RhdGVQcmlvcml0eTogT0JKRUNUU0VUX1NUQVRFX1BSSU9SSVRZLAogICAgICBzdGF0ZUNoYW5nZWRfOiB0cnVlLAogICAgICB0aW1lcl86IGZhbHNlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBvYmplY3RzID0gdGhpcy5vYmplY3RzOwogICAgICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgICAgIGlmIChvYmplY3RzICYmIEFycmF5LmlzQXJyYXkob2JqZWN0cykpIHsKICAgICAgICAgIHRoaXMubG9jaygpOwogICAgICAgICAgdGhpcy5hZGQuYXBwbHkodGhpcywgb2JqZWN0cyk7CiAgICAgICAgICB0aGlzLnVubG9jaygpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZF8gPSB0aGlzLnN0YXRlQ2hhbmdlZF8gPSAhIXRoaXMuY2FsY3VsYXRlT25Jbml0OwogICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGEpIHsKICAgICAgICAgICAgaWYgKGJhc2lzLmFycmF5LmFkZCh0aGlzLm9iamVjdHMsIG9iamVjdCkpIG9iamVjdC5hZGRIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB0aHJvdyB0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIjYWRkOiBJbnN0YW5jZSBvZiBBYnN0cmFjdERhdGEgcmVxdWlyZWQiOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIHJlbW92ZTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLm9iamVjdHMsIG9iamVjdCkpIG9iamVjdC5yZW1vdmVIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSB0aGlzLm9iamVjdHNbaV07IGkrKykgb2JqZWN0LnJlbW92ZUhhbmRsZXIoT0JKRUNUU0VUX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIHRoaXMub2JqZWN0cy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuZmlyZSh0cnVlLCB0cnVlKTsKICAgICAgfSwKICAgICAgZmlyZTogZnVuY3Rpb24odmFsdWVDaGFuZ2VkLCBzdGF0ZUNoYW5nZWQpIHsKICAgICAgICBpZiAoIXRoaXMubG9ja2VkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZF8gPSB0aGlzLnZhbHVlQ2hhbmdlZF8gfHwgISF2YWx1ZUNoYW5nZWQ7CiAgICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlZF8gPSB0aGlzLnN0YXRlQ2hhbmdlZF8gfHwgISFzdGF0ZUNoYW5nZWQ7CiAgICAgICAgICBpZiAoIXRoaXMudGltZXJfICYmICh0aGlzLnZhbHVlQ2hhbmdlZF8gfHwgdGhpcy5zdGF0ZUNoYW5nZWRfKSkgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy51cGRhdGUuYmluZCh0aGlzKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBsb2NrOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdmFsdWVDaGFuZ2VkID0gdGhpcy52YWx1ZUNoYW5nZWRfOwogICAgICAgIHZhciBzdGF0ZUNoYW5nZWQgPSB0aGlzLnN0YXRlQ2hhbmdlZF87CiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gZmFsc2U7CiAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZWRfID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgaWYgKCFjbGVhbmVyLmdsb2JhbERlc3Ryb3kpIHsKICAgICAgICAgIGlmICh2YWx1ZUNoYW5nZWQpIHRoaXMuc2V0KHRoaXMuY2FsY3VsYXRlVmFsdWUoKSk7CiAgICAgICAgICBpZiAoc3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLm9iamVjdHMubGVuZ3RoOwogICAgICAgICAgICBpZiAoIWxlbikgdGhpcy5zZXRTdGF0ZShTVEFURS5VTkRFRklORUQpOyBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbWF4V2VpZ2h0ID0gLTI7CiAgICAgICAgICAgICAgdmFyIGN1ck9iamVjdDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0gdGhpcy5vYmplY3RzW2ldOwogICAgICAgICAgICAgICAgdmFyIHdlaWdodCA9IHRoaXMuc3RhdGVQcmlvcml0eS5pbmRleE9mKFN0cmluZyhvYmplY3Quc3RhdGUpKTsKICAgICAgICAgICAgICAgIGlmICh3ZWlnaHQgPiBtYXhXZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgY3VyT2JqZWN0ID0gb2JqZWN0OwogICAgICAgICAgICAgICAgICBtYXhXZWlnaHQgPSB3ZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJPYmplY3QpIHRoaXMuc2V0U3RhdGUoY3VyT2JqZWN0LnN0YXRlLCBjdXJPYmplY3Quc3RhdGUuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubG9jaygpOwogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICBpZiAodGhpcy50aW1lcl8pIGJhc2lzLmNsZWFySW1tZWRpYXRlKHRoaXMudGltZXJfKTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFeHByZXNzaW9uID0gUHJvcGVydHkuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXhwcmVzc2lvbiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGFyZ3MsIGNhbGMpIHsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBhcmdzID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKTsKICAgICAgICB2YXIgY2FsYyA9IGFyZ3MucG9wKCk7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxjICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIjogbGFzdCBhcmd1bWVudCBvZiBjb25zdHJ1Y3RvciBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgIGNhbGMgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgfQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICBhcmdzWzBdLmxpbmsodGhpcywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zZXQoY2FsYy5jYWxsKHRoaXMsIHZhbHVlKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMSkgewogICAgICAgICAgdmFyIGNoYW5nZVdhdGNoZXIgPSBuZXcgT2JqZWN0U2V0KHsKICAgICAgICAgICAgb2JqZWN0czogYXJncywKICAgICAgICAgICAgY2FsY3VsYXRlT25Jbml0OiB0cnVlLAogICAgICAgICAgICBjYWxjdWxhdGVWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGMuYXBwbHkodGhpcywgYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNoYW5nZVdhdGNoZXIubGluayh0aGlzLCB0aGlzLnNldCk7CiAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoewogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIWNsZWFuZXIuZ2xvYmFsRGVzdHJveSkgY2hhbmdlV2F0Y2hlci5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgUHJvcGVydHk6IFByb3BlcnR5LAogICAgICBPYmplY3RTZXQ6IE9iamVjdFNldCwKICAgICAgRXhwcmVzc2lvbjogRXhwcmVzc2lvbgogICAgfTsKICB9LAogICJnLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgaG9zdCA9IHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gInVuZGVmaW5lZCIgPyBwZXJmb3JtYW5jZSA6IERhdGU7CiAgICB2YXIgbm93TWV0aG9kID0gIndlYmtpdE5vdyIgaW4gaG9zdCA/ICJ3ZWJraXROb3ciIDogIm5vdyI7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgdGltZTogZnVuY3Rpb24odGltZSkgewogICAgICAgIHJldHVybiAhYXJndW1lbnRzLmxlbmd0aCA/IGhvc3Rbbm93TWV0aG9kXSgpIDogcGFyc2VJbnQoaG9zdFtub3dNZXRob2RdKCkgLSB0aW1lKTsKICAgICAgfSwKICAgICAgdGVzdDogZnVuY3Rpb24odGltZXMsIGZuKSB7CiAgICAgICAgdmFyIHQgPSB0aGlzLnRpbWUoKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVzOyBpKyspIGZuKGkpOwogICAgICAgIHJldHVybiB0aGlzLnRpbWUodCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAiaC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi81LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2YuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9kLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzYuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgdmFyIHV0aWxzID0gYmFzaXMucmVxdWlyZSgiLi9wLmpzIik7CiAgICB2YXIgZW52RmFjdG9yeSA9IGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpOwogICAgdmFyIGFzdFRvb2xzID0gYmFzaXMucmVxdWlyZSgiLi9rLmpzIik7CiAgICB2YXIgRVJST1JfVEVTVF9GQVVMVCA9ICJFUlJPUl9URVNUX0ZBVUxUIjsKICAgIHZhciBFUlJPUl9FTVBUWSA9ICJFUlJPUl9FTVBUWSI7CiAgICB2YXIgRVJST1JfVEVTVF9DUkFTSCA9ICJFUlJPUl9URVNUX0NSQVNIIjsKICAgIHZhciBFUlJPUl9USU1FT1VUID0gIkVSUk9SX1RJTUVPVVQiOwogICAgdmFyIE5PUCA9IGZ1bmN0aW9uKCkge307CiAgICB2YXIgdGVzdE1hcCA9IHt9OwogICAgZnVuY3Rpb24gY3JlYXRlVGVzdEZhY3RvcnkoZGF0YSkgewogICAgICBpZiAoZGF0YS50ZXN0Y2FzZSkgYmFzaXMuZGV2Lndhcm4oImB0ZXN0Y2FzZWAgc2V0dGluZyBpcyBkZXByZWNhdGVkLCB1c2UgYHRlc3RgIGluc3RlYWQiKTsKICAgICAgdmFyIHRlc3QgPSBkYXRhLnRlc3QgfHwgZGF0YS50ZXN0Y2FzZTsKICAgICAgZGF0YSA9IGJhc2lzLm9iamVjdC5zbGljZShkYXRhKTsKICAgICAgYmFzaXMub2JqZWN0LnNwbGljZShkYXRhLCBbICJ0ZXN0IiwgInRlc3RjYXNlIiBdKTsKICAgICAgaWYgKHRlc3QpIHsKICAgICAgICBpZiAoYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZShkYXRhKSkgdGVzdCA9IHRlc3QuZmV0Y2goKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZXN0ID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfQogICAgICBpZiAoIWRhdGEubmFtZSkgZGF0YS5uYW1lID0gIlVudGl0bGVkIHRlc3QiOwogICAgICB2YXIgQ2xhc3M7CiAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgZGF0YTogZGF0YQogICAgICB9OwogICAgICBpZiAodHlwZW9mIHRlc3QgPT0gImZ1bmN0aW9uIikgewogICAgICAgIHZhciBmbkluZm8gPSB1dGlscy5nZXRGbkluZm8odGVzdCk7CiAgICAgICAgY29uZmlnLmRhdGEuYXN5bmMgPSAhIWZuSW5mby5hcmdzLmxlbmd0aDsKICAgICAgICBjb25maWcuZGF0YS50ZXN0QXJncyA9IGZuSW5mby5hcmdzOwogICAgICAgIGNvbmZpZy5kYXRhLnRlc3RTb3VyY2UgPSBmbkluZm8uY29kZTsKICAgICAgICBDbGFzcyA9IFRlc3RDYXNlOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZy5jaGlsZE5vZGVzID0gIUFycmF5LmlzQXJyYXkodGVzdCkgPyBbXSA6IHRlc3Q7CiAgICAgICAgQ2xhc3MgPSBUZXN0U3VpdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBDbGFzcyhjb25maWcpOwogICAgfQogICAgdmFyIEZJTEVfSEFORExFUiA9IHsKICAgICAgdXBkYXRlOiBmdW5jdGlvbihmaWxlLCBkZWx0YSkgewogICAgICAgIGlmICgiY29udGVudCIgaW4gZGVsdGEpIHsKICAgICAgICAgIHZhciBleHBvcnRzID0gYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzIl0oZmlsZS5kYXRhLmNvbnRlbnQsIGZpbGUuZGF0YS5maWxlbmFtZSArICIuIiArIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgdmFyIGNvbmZpZyA9IEFycmF5LmlzQXJyYXkoZXhwb3J0cykgPyB7CiAgICAgICAgICAgIHRlc3Q6IGV4cG9ydHMKICAgICAgICAgIH0gOiBleHBvcnRzOwogICAgICAgICAgdmFyIG5ld05vZGUgPSBjcmVhdGVUZXN0RmFjdG9yeShjb25maWcpOwogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdOb2RlLCB0aGlzKTsKICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciBBYnN0cmFjdFRlc3QgPSBiYXNpcy5kb20ud3JhcHBlci5Ob2RlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiAiQWJzdHJhY3RUZXN0IiwKICAgICAgbmFtZTogIiIsCiAgICAgIGVudlJ1bm5lcjogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMuZG9tLndyYXBwZXIuTm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBoYXNPd25FbnZpcm9ubWVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5kYXRhLmluaXQgfHwgdGhpcy5kYXRhLmh0bWwgfHwgIXRoaXMucGFyZW50Tm9kZSk7CiAgICAgIH0sCiAgICAgIGdldEh0bWw6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlICghY3Vyc29yLmRhdGEuaHRtbCAmJiBjdXJzb3IucGFyZW50Tm9kZSkgY3Vyc29yID0gY3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgcmV0dXJuIGN1cnNvci5kYXRhLmh0bWw7CiAgICAgIH0sCiAgICAgIGdldEVudlJ1bm5lcjogZnVuY3Rpb24oYXV0b2NyZWF0ZSkgewogICAgICAgIGlmICh0aGlzLmVudlJ1bm5lcikgcmV0dXJuIHRoaXMuZW52UnVubmVyOwogICAgICAgIHZhciBlbnZSdW5uZXI7CiAgICAgICAgaWYgKCF0aGlzLmRhdGEuaW5pdCkgZW52UnVubmVyID0gdGhpcy5wYXJlbnROb2RlICYmIHRoaXMucGFyZW50Tm9kZS5nZXRFbnZSdW5uZXIoYXV0b2NyZWF0ZSk7CiAgICAgICAgaWYgKCh0aGlzLmRhdGEuaW5pdCB8fCB0aGlzLmRhdGEuaHRtbCB8fCAhZW52UnVubmVyKSAmJiBhdXRvY3JlYXRlKSB7CiAgICAgICAgICBlbnZSdW5uZXIgPSBlbnZGYWN0b3J5LmNyZWF0ZSh0aGlzLmRhdGEuaW5pdCwgdGhpcy5nZXRIdG1sKCkpOwogICAgICAgICAgZW52UnVubmVyLmFkZEhhbmRsZXIoewogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgIHRoaXMuZW52UnVubmVyID0gZW52UnVubmVyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW52UnVubmVyOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuZW52UnVubmVyKSB7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lci5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kb20ud3JhcHBlci5Ob2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZW52UnVubmVyKSB7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lci5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLmVudlJ1bm5lciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmZpbGUpIHsKICAgICAgICAgIHRoaXMuZmlsZS5yZW1vdmVIYW5kbGVyKEZJTEVfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB0aGlzLmZpbGUgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVzdENhc2UgPSBBYnN0cmFjdFRlc3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6ICJUZXN0Q2FzZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICB0ZXN0U291cmNlOiBudWxsLAogICAgICB0ZXN0V3JhcHBlZFNvdXJjZXM6IG51bGwsCiAgICAgIGNoaWxkQ2xhc3M6IG51bGwsCiAgICAgIGdldFNvdXJjZUNvZGU6IGZ1bmN0aW9uKGJyZWFrcG9pbnRBdCkgewogICAgICAgIGlmICh0aGlzLnRlc3RXcmFwcGVkU291cmNlcyA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy50ZXN0V3JhcHBlZFNvdXJjZXMgPSB7fTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBicmVha3BvaW50QXQgIT0gIm51bWJlciIpIGJyZWFrcG9pbnRBdCA9ICJub25lIjsKICAgICAgICBpZiAoIXRoaXMudGVzdFdyYXBwZWRTb3VyY2VzW2JyZWFrcG9pbnRBdF0pIHsKICAgICAgICAgIHZhciBhc3QgPSBhc3RUb29scy5wYXJzZSh0aGlzLmRhdGEudGVzdFNvdXJjZSk7CiAgICAgICAgICBpZiAoYnJlYWtwb2ludEF0ID09ICJub25lIikgewogICAgICAgICAgICBhc3RUb29scy50cmF2ZXJzZUFzdChhc3QsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50eXBlID09ICJQcm9ncmFtIikgcmV0dXJuOwogICAgICAgICAgICAgIGlmIChub2RlLnR5cGUgPT0gIkZ1bmN0aW9uRXhwcmVzc2lvbiIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbnMgPSBhc3RUb29scy5nZXROb2RlUmFuZ2VUb2tlbnMobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgb3JpZyA9IGFzdFRvb2xzLnRyYW5zbGF0ZUFzdChhc3QsIHRva2Vuc1swXS5yYW5nZVswXSwgdG9rZW5zWzFdLnJhbmdlWzFdKTsKICAgICAgICAgICAgICAgIHRva2Vuc1swXS52YWx1ZSA9ICJfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24oIiArIHRva2Vuc1swXS52YWx1ZTsKICAgICAgICAgICAgICAgIHRva2Vuc1sxXS52YWx1ZSArPSAiLCAiICsgb3JpZyArICIpIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAiRnVuY3Rpb25EZWNsYXJhdGlvbiIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbnMgPSBhc3RUb29scy5nZXROb2RlUmFuZ2VUb2tlbnMobm9kZS5ib2R5KTsKICAgICAgICAgICAgICAgIHRva2Vuc1swXS52YWx1ZSArPSAiXG50cnkge1xuIjsKICAgICAgICAgICAgICAgIHRva2Vuc1sxXS52YWx1ZSA9ICJcbn0gY2F0Y2goZSkgeyIgKyAiX19leGNlcHRpb24oZSk7IiArICJ0aHJvdyBlOyIgKyAifVxuIiArIHRva2Vuc1sxXS52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAiQ2FsbEV4cHJlc3Npb24iKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlLnR5cGUgPT0gIkV4cHJlc3Npb25TdGF0ZW1lbnQiKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGFzdFRvb2xzLmdldE5vZGVSYW5nZVRva2Vucyhub2RlKVswXTsKICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSAiX19pc0ZvcihbIiArIG5vZGUucmFuZ2UgKyAiXSwgIiArIChub2RlLmxvYy5lbmQubGluZSAtIDEpICsgIikgfHwgIiArIHRva2VuLnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAobm9kZS5hcmd1bWVudHMubGVuZ3RoID09IDEgJiYgbm9kZS5hcmd1bWVudHNbMF0udHlwZSA9PSAiQmluYXJ5RXhwcmVzc2lvbiIgJiYgbm9kZS5hcmd1bWVudHNbMF0ub3BlcmF0b3IubWF0Y2goL14oPT09PykkLykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdFRva2VuID0gYXN0VG9vbHMuZ2V0Tm9kZVJhbmdlVG9rZW5zKG5vZGUuYXJndW1lbnRzWzBdLmxlZnQpOwogICAgICAgICAgICAgICAgICAgIHZhciByaWdodFRva2VuID0gYXN0VG9vbHMuZ2V0Tm9kZVJhbmdlVG9rZW5zKG5vZGUuYXJndW1lbnRzWzBdLnJpZ2h0KTsKICAgICAgICAgICAgICAgICAgICBsZWZ0VG9rZW5bMF0udmFsdWUgPSAnX19hY3R1YWwoIicgKyBub2RlLmFyZ3VtZW50c1swXS5vcGVyYXRvciArICciLCcgKyBsZWZ0VG9rZW5bMF0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgbGVmdFRva2VuWzFdLnZhbHVlICs9ICIpIjsKICAgICAgICAgICAgICAgICAgICByaWdodFRva2VuWzBdLnZhbHVlID0gIl9fZXhwZWN0ZWQoIiArIHJpZ2h0VG9rZW5bMF0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmlnaHRUb2tlblsxXS52YWx1ZSArPSAiKSI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZS50eXBlID09ICJCbG9ja1N0YXRlbWVudCIgfHwgbm9kZS5wYXJlbnROb2RlLnR5cGUgPT0gIlByb2dyYW0iKSB7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RUb2tlbiA9IGFzdFRvb2xzLmdldE5vZGVSYW5nZVRva2Vucyhub2RlKVswXTsKICAgICAgICAgICAgICAgIGZpcnN0VG9rZW4udmFsdWUgPSAiX19lbnRlckxpbmUoIiArIChmaXJzdFRva2VuLmxvYy5zdGFydC5saW5lIC0gMSkgKyAiKTsiICsgZmlyc3RUb2tlbi52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdyYXBwZXJTb3VyY2UgPSBhc3RUb29scy50cmFuc2xhdGVBc3QoYXN0LCAwLCBhc3Quc291cmNlLmxlbmd0aCk7CiAgICAgICAgICB0aGlzLnRlc3RXcmFwcGVkU291cmNlc1ticmVha3BvaW50QXRdID0gImZ1bmN0aW9uKCIgKyB0aGlzLmRhdGEudGVzdEFyZ3MuY29uY2F0KCJhc3NlcnQiLCAiX19pc0ZvciIsICJfX2VudGVyTGluZSIsICJfX2V4Y2VwdGlvbiIsICJfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24iLCAiX19hY3R1YWwiLCAiX19leHBlY3RlZCIpLmpvaW4oIiwgIikgKyAiKXtcbiIgKyB3cmFwcGVyU291cmNlICsgIlxufSI7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlc3RXcmFwcGVkU291cmNlc1ticmVha3BvaW50QXRdOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3RUZXN0LnByb3RvdHlwZS5yZXNldC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc2V0U3RhdGUoYmFzaXMuZGF0YS5TVEFURS5VTkRFRklORUQpOwogICAgICB9LAogICAgICBydW46IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB3YXJuTWVzc2FnZXMgPSBbXTsKICAgICAgICB2YXIgZXJyb3JNZXNzYWdlcyA9IFtdOwogICAgICAgIHZhciBlcnJvcjsKICAgICAgICB2YXIgdGltZSA9IE5hTjsKICAgICAgICB2YXIgc3RhcnRUaW1lOwogICAgICAgIHZhciB0aW1lb3V0VGltZXI7CiAgICAgICAgdmFyIGFzeW5jID0gdGhpcy5kYXRhLmFzeW5jID8gMSA6IDA7CiAgICAgICAgdmFyIGlzTm9kZSA9IG51bGw7CiAgICAgICAgdmFyIGltcGxpY2l0Q29tcGFyZTsKICAgICAgICB2YXIgYWN0dWFsXzsKICAgICAgICB2YXIgZXhwZWN0ZWRfOwogICAgICAgIHZhciByZXBvcnQgPSB7CiAgICAgICAgICB0ZXN0OiBudWxsLAogICAgICAgICAgdGVzdFNvdXJjZTogdGhpcy5kYXRhLnRlc3RTb3VyY2UsCiAgICAgICAgICB0aW1lOiB0aW1lLAogICAgICAgICAgbGFzdExpbmU6IDAsCiAgICAgICAgICBwZW5kaW5nOiBmYWxzZSwKICAgICAgICAgIHN1Y2Nlc3NDb3VudDogMCwKICAgICAgICAgIHRlc3RDb3VudDogMCwKICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgZXhjZXB0aW9uOiBudWxsLAogICAgICAgICAgZXJyb3JMaW5lczoge30sCiAgICAgICAgICB3YXJuczogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIGVudiA9IHsKICAgICAgICAgIGFzeW5jOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICBhc3luYysrOwogICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoYXN5bmMgPiAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBmbi5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbihlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIGlmIChhc3luYyA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIS0tYXN5bmMpIHRlc3REb25lKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgICAgICB9LAogICAgICAgICAgaXM6IGZ1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwsIGRlZXApIHsKICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IgPSB1dGlscy5pc1RydXRoeShleHBlY3RlZCk7CiAgICAgICAgICAgICAgaWYgKGltcGxpY2l0Q29tcGFyZSkgewogICAgICAgICAgICAgICAgYWN0dWFsID0gYWN0dWFsXzsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gZXhwZWN0ZWRfOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhY3R1YWwgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXJyb3IgPSB1dGlscy5jb21wYXJlVmFsdWVzKGV4cGVjdGVkLCBhY3R1YWwsIGRlZXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgIGlmIChpc05vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBsaW5lID0gaXNOb2RlLmxpbmU7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JzID0gcmVwb3J0LmVycm9yTGluZXNbbGluZV07CiAgICAgICAgICAgICAgICBpZiAoIWVycm9ycykgZXJyb3JzID0gcmVwb3J0LmVycm9yTGluZXNbbGluZV0gPSBbXTsKICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgbnVtOiByZXBvcnQudGVzdENvdW50LAogICAgICAgICAgICAgICAgICBub2RlOiBpc05vZGUsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQ6IHV0aWxzLm1ha2VTdGF0aWNDb3B5KGV4cGVjdGVkKSwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRTdHI6IHV0aWxzLnZhbHVlMnN0cmluZyhleHBlY3RlZCwgZmFsc2UsIGRlZXApLAogICAgICAgICAgICAgICAgICBhY3R1YWw6IHV0aWxzLm1ha2VTdGF0aWNDb3B5KGFjdHVhbCksCiAgICAgICAgICAgICAgICAgIGFjdHVhbFN0cjogdXRpbHMudmFsdWUyc3RyaW5nKGFjdHVhbCwgZmFsc2UsIGRlZXApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW1wbGljaXRDb21wYXJlID0gZmFsc2U7CiAgICAgICAgICAgIGFjdHVhbF8gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGV4cGVjdGVkXyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgcmVwb3J0LnN1Y2Nlc3NDb3VudCArPSAhZXJyb3I7CiAgICAgICAgICAgIHJlcG9ydC50ZXN0Q291bnQrKzsKICAgICAgICAgIH0sCiAgICAgICAgICByZXBvcnQ6IHJlcG9ydAogICAgICAgIH07CiAgICAgICAgdmFyIF9fYWN0dWFsID0gZnVuY3Rpb24ob3BlcmF0b3IsIHZhbHVlKSB7CiAgICAgICAgICBpbXBsaWNpdENvbXBhcmUgPSBvcGVyYXRvcjsKICAgICAgICAgIGFjdHVhbF8gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwogICAgICAgIHZhciBfX2V4cGVjdGVkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGV4cGVjdGVkXyA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CiAgICAgICAgdmFyIF9faXNGb3IgPSBmdW5jdGlvbihyYW5nZSwgbGluZSkgewogICAgICAgICAgcmVwb3J0Lmxhc3RMaW5lID0gbGluZTsKICAgICAgICAgIGlzTm9kZSA9IHsKICAgICAgICAgICAgcmFuZ2U6IHJhbmdlLAogICAgICAgICAgICBsaW5lOiBsaW5lCiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgdmFyIF9fZW50ZXJMaW5lID0gZnVuY3Rpb24obGluZSkgewogICAgICAgICAgcmVwb3J0Lmxhc3RMaW5lID0gbGluZTsKICAgICAgICB9OwogICAgICAgIHZhciBfX3dyYXBGdW5jdGlvbkV4cHJlc3Npb24gPSBmdW5jdGlvbihmbiwgb3JpZykgewogICAgICAgICAgdmFyIHdyYXBwZWRGbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgX19leGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdyYXBwZWRGbi5vcmlnaW5hbEZuXyA9IG9yaWc7CiAgICAgICAgICByZXR1cm4gd3JhcHBlZEZuOwogICAgICAgIH07CiAgICAgICAgdmFyIF9fZXhjZXB0aW9uID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgaWYgKHJlcG9ydC5leGNlcHRpb24pIHJldHVybjsKICAgICAgICAgIHJlcG9ydC5leGNlcHRpb24gPSBlOwogICAgICAgICAgcmVwb3J0LnRlc3RDb3VudCA9IDA7CiAgICAgICAgICByZXBvcnQuc3VjY2Vzc0NvdW50ID0gMDsKICAgICAgICAgIHRlc3REb25lKEVSUk9SX1RFU1RfQ1JBU0gpOwogICAgICAgIH07CiAgICAgICAgdmFyIGFzeW5jRG9uZSA9IGFzeW5jID8gYmFzaXMuZm4ucnVuT25jZShmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChhc3luYyA+IDApIGFzeW5jLS07CiAgICAgICAgICBpZiAoIWFzeW5jKSB0ZXN0RG9uZSgpOwogICAgICAgIH0pIDogTk9QOwogICAgICAgIHZhciB0ZXN0RG9uZSA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICB0aW1lID0gYmFzaXMudXRpbHMuYmVuY2htYXJrLnRpbWUoc3RhcnRUaW1lKTsKICAgICAgICAgIHRpbWVvdXRUaW1lciA9IGNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICAgICAgYXN5bmMgPSAwOwogICAgICAgICAgaWYgKCFlcnJvciAmJiByZXBvcnQudGVzdENvdW50ICE9IHJlcG9ydC5zdWNjZXNzQ291bnQpIGVycm9yID0gRVJST1JfVEVTVF9GQVVMVDsKICAgICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQocmVwb3J0LCB7CiAgICAgICAgICAgIHRlc3Q6IHRoaXMsCiAgICAgICAgICAgIHRpbWU6IHRpbWUsCiAgICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgICAgcGVuZGluZzogIWVycm9yICYmICFyZXBvcnQudGVzdENvdW50LAogICAgICAgICAgICB3YXJuczogd2Fybk1lc3NhZ2VzLmxlbmd0aCA/IHdhcm5NZXNzYWdlcyA6IG51bGwKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5zZXRTdGF0ZShlcnJvciB8fCBlcnJvck1lc3NhZ2VzLmxlbmd0aCA/IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgOiBiYXNpcy5kYXRhLlNUQVRFLlJFQURZLCBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgICAgICBkYXRhOiByZXBvcnQKICAgICAgICAgIH0pKTsKICAgICAgICB9LmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy5zZXRTdGF0ZShiYXNpcy5kYXRhLlNUQVRFLlBST0NFU1NJTkcpOwogICAgICAgIGlmICh0aGlzLmRhdGEucGVuZGluZykgcmV0dXJuIHRlc3REb25lKCk7CiAgICAgICAgdGhpcy5nZXRFbnZSdW5uZXIodHJ1ZSkucnVuKHRoaXMuZ2V0U291cmNlQ29kZSgpLCB0aGlzLCBmdW5jdGlvbih0ZXN0Rm4pIHsKICAgICAgICAgIHN0YXJ0VGltZSA9IGJhc2lzLnV0aWxzLmJlbmNobWFyay50aW1lKCk7CiAgICAgICAgICB2YXIgYXNzZXJ0ID0gZW52LmlzLmJpbmQoZW52KTsKICAgICAgICAgIGFzc2VydC5leGNlcHRpb24gPSBhc3NlcnQudGhyb3dzID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXBvcnQuZXhjZXB0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgIGFzc2VydChmYWxzZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBhc3NlcnQodHJ1ZSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgcmVwb3J0LmV4Y2VwdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgYXNzZXJ0LmRlZXAgPSBmdW5jdGlvbihleHBlY3RlZCwgYWN0dWFsKSB7CiAgICAgICAgICAgIGFzc2VydChleHBlY3RlZCwgYWN0dWFsLCB0cnVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5LmNyZWF0ZSh0aGlzLmRhdGEudGVzdEFyZ3MubGVuZ3RoKTsKICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCkgYXJnc1swXSA9IGFzeW5jRG9uZTsKICAgICAgICAgIGFyZ3MucHVzaChhc3NlcnQsIF9faXNGb3IsIF9fZW50ZXJMaW5lLCBfX2V4Y2VwdGlvbiwgX193cmFwRnVuY3Rpb25FeHByZXNzaW9uLCBfX2FjdHVhbCwgX19leHBlY3RlZCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0ZXN0Rm4uYXBwbHkoZW52LCBhcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIF9fZXhjZXB0aW9uKGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFhc3luYykgdGVzdERvbmUoKTsgZWxzZSB0aW1lb3V0VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0ZXN0RG9uZShFUlJPUl9USU1FT1VUKTsKICAgICAgICAgIH0sIHRoaXMuZGF0YS50aW1lb3V0IHx8IDI1MCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFRlc3RTdWl0ZSA9IEFic3RyYWN0VGVzdC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogIlRlc3RTdWl0ZSIsCiAgICAgIGNoaWxkRmFjdG9yeTogY3JlYXRlVGVzdEZhY3RvcnksCiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0VGVzdCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3RUZXN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5uZXN0ZWRUZXN0c18gPSBuZXcgYmFzaXMuZGF0YS5EYXRhc2V0KHsKICAgICAgICAgIGl0ZW1zOiB0aGlzLmNoaWxkTm9kZXMucmVkdWNlKGZ1bmN0aW9uKHJlcywgaXRlbSkgewogICAgICAgICAgICByZXR1cm4gcmVzLmNvbmNhdChpdGVtIGluc3RhbmNlb2YgVGVzdFN1aXRlID8gaXRlbS5uZXN0ZWRUZXN0c18uZ2V0SXRlbXMoKSA6IGl0ZW0pOwogICAgICAgICAgfSwgW10pCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy50ZXN0QnlTdGF0ZV8gPSBuZXcgYmFzaXMuZGF0YS5kYXRhc2V0LlNwbGl0KHsKICAgICAgICAgIHNvdXJjZTogdGhpcy5uZXN0ZWRUZXN0c18sCiAgICAgICAgICBydWxlRXZlbnRzOiAic3RhdGVDaGFuZ2VkIiwKICAgICAgICAgIHJ1bGU6IGZ1bmN0aW9uKHRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5SRUFEWSAmJiB0ZXN0LnN0YXRlLmRhdGEuZGF0YS5wZW5kaW5nID8gInBlbmRpbmciIDogU3RyaW5nKHRlc3Quc3RhdGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMuc3RhdGVfID0gbmV3IGJhc2lzLmRhdGEudmFsdWUuRXhwcmVzc2lvbihiYXNpcy5kYXRhLlZhbHVlLmZyb20odGhpcy5uZXN0ZWRUZXN0c18sICJpdGVtc0NoYW5nZWQiLCAiaXRlbUNvdW50IiksIGJhc2lzLmRhdGEuVmFsdWUuZnJvbSh0aGlzLnRlc3RCeVN0YXRlXy5nZXRTdWJzZXQoInByb2Nlc3NpbmciLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgiZXJyb3IiLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgicmVhZHkiLCB0cnVlKSwgIml0ZW1zQ2hhbmdlZCIsICJpdGVtQ291bnQiKSwgYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHRoaXMudGVzdEJ5U3RhdGVfLmdldFN1YnNldCgicGVuZGluZyIsIHRydWUpLCAiaXRlbXNDaGFuZ2VkIiwgIml0ZW1Db3VudCIpLCBmdW5jdGlvbihjb3VudCwgcHJvY2Vzc2luZywgZXJyb3IsIHJlYWR5LCBwZW5kaW5nKSB7CiAgICAgICAgICBpZiAoIWNvdW50KSByZXR1cm4gWyBiYXNpcy5kYXRhLlNUQVRFLlJFQURZLCBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgcGVuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICB0ZXN0Q291bnQ6IGNvdW50LAogICAgICAgICAgICAgIHN1Y2Nlc3NDb3VudDogcmVhZHkKICAgICAgICAgICAgfQogICAgICAgICAgfSkgXTsKICAgICAgICAgIGlmIChwcm9jZXNzaW5nICsgZXJyb3IgKyByZWFkeSArIHBlbmRpbmcgPT0gMCkgcmV0dXJuIFsgYmFzaXMuZGF0YS5TVEFURS5VTkRFRklORUQgXTsKICAgICAgICAgIGlmIChwcm9jZXNzaW5nIHx8IGVycm9yICsgcmVhZHkgKyBwZW5kaW5nIDwgY291bnQpIHJldHVybiBbIGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORywgKGVycm9yICsgcmVhZHkpIC8gY291bnQgXTsKICAgICAgICAgIHJldHVybiBbIGVycm9yID8gYmFzaXMuZGF0YS5TVEFURS5FUlJPUiA6IGJhc2lzLmRhdGEuU1RBVEUuUkVBRFksIG5ldyBiYXNpcy5kYXRhLk9iamVjdCh7CiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBwZW5kaW5nID09IGNvdW50LAogICAgICAgICAgICAgIGVycm9yOiBlcnJvciA/IEVSUk9SX1RFU1RfRkFVTFQgOiBudWxsLAogICAgICAgICAgICAgIHRlc3RDb3VudDogY291bnQsCiAgICAgICAgICAgICAgc3VjY2Vzc0NvdW50OiByZWFkeSArIHBlbmRpbmcKICAgICAgICAgICAgfQogICAgICAgICAgfSkgXTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0YXRlXy5jaGFuZ2VXYXRjaGVyID0gdGhpcy5zdGF0ZV8uaGFuZGxlci5oYW5kbGVyLmNvbnRleHQudmFsdWU7CiAgICAgICAgdGhpcy5zdGF0ZV8ubGluayh0aGlzLCBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgICAgdGhpcy5zZXRTdGF0ZS5hcHBseSh0aGlzLCBzdGF0ZSk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRlc3QucHJvdG90eXBlLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zdGF0ZV8ubG9jaygpOwogICAgICAgIHRoaXMuY2hpbGROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHRlc3QpIHsKICAgICAgICAgIHRlc3QucmVzZXQoKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0YXRlXy51bmxvY2soKTsKICAgICAgICB0aGlzLnN0YXRlXy5jaGFuZ2VXYXRjaGVyLnVwZGF0ZSgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnRlc3RCeVN0YXRlXy5kZXN0cm95KCk7CiAgICAgICAgdGhpcy50ZXN0QnlTdGF0ZV8gPSBudWxsOwogICAgICAgIHRoaXMubmVzdGVkVGVzdHNfLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLm5lc3RlZFRlc3RzXyA9IG51bGw7CiAgICAgICAgdGhpcy5zdGF0ZV8uZGVzdHJveSgpOwogICAgICAgIHRoaXMuc3RhdGVfID0gbnVsbDsKICAgICAgICBBYnN0cmFjdFRlc3QucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgQWJzdHJhY3RUZXN0OiBBYnN0cmFjdFRlc3QsCiAgICAgIFRlc3RDYXNlOiBUZXN0Q2FzZSwKICAgICAgVGVzdFN1aXRlOiBUZXN0U3VpdGUsCiAgICAgIG1hcDogdGVzdE1hcCwKICAgICAgY3JlYXRlOiBjcmVhdGVUZXN0RmFjdG9yeQogICAgfTsKICB9LAogICJwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIE9CSkVDVF9UT1NUUklORyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CiAgICB2YXIgRVJST1JfV1JPTkdfQU5TV0VSID0gIkVSUk9SX1dST05HX0FOU1dFUiI7CiAgICB2YXIgRVJST1JfVFlQRV9NSVNTTUFUQ0ggPSAiRVJST1JfVFlQRV9NSVNTTUFUQ0giOwogICAgZnVuY3Rpb24gc2xpY2VPd25Pbmx5KG9iaikgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VTdGF0aWNDb3B5KHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIpIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IGFycmF5RnJvbSh2YWx1ZSkgOiBzbGljZU93bk9ubHkodmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBmdW5jdGlvbiB2YWx1ZTJzdHJpbmcodmFsdWUsIGxpbmVhciwgZGVlcCkgewogICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICByZXR1cm4gIiciICsgdmFsdWUucmVwbGFjZSgvXCcvZywgIlxcJyIpICsgIiciOwogICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgIGlmICh2YWx1ZS5vcmlnaW5hbEZuXykgdmFsdWUgPSB2YWx1ZS5vcmlnaW5hbEZuXzsKICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgIHJldHVybiAhbGluZWFyID8gdmFsdWUgOiB2YWx1ZS5yZXBsYWNlKC9ceyhbXHJcbl18LikqXH0vLCAiey4ufSIpOwogICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiAibnVsbCI7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiAiWyIgKyB2YWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTJzdHJpbmcodmFsLCAhZGVlcCwgZGVlcCk7CiAgICAgICAgICB9KS5qb2luKCIsICIpICsgIl0iOwogICAgICAgICAgaWYgKE9CSkVDVF9UT1NUUklORy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgRGF0ZV0iIHx8IE9CSkVDVF9UT1NUUklORy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgUmVnRXhwXSIpIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBOdW1iZXIpIGRlYnVnZ2VyOwogICAgICAgICAgaWYgKCFsaW5lYXIpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIGlmICh2YWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXMucHVzaChrZXkgKyAiOiAiICsgdmFsdWUyc3RyaW5nKHZhbHVlW2tleV0sICFkZWVwLCBkZWVwKSk7CiAgICAgICAgICAgIGlmICghcmVzLmxlbmd0aCAmJiB2YWx1ZS52YWx1ZU9mKCkgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIG0gPSB2YWx1ZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpLm1hdGNoKC9mdW5jdGlvbiAoTnVtYmVyfFN0cmluZ3xCb29sZWFuKS8pOwogICAgICAgICAgICAgIGlmIChtKSByZXR1cm4gIm5ldyBPYmplY3QoIiArIHZhbHVlMnN0cmluZyh2YWx1ZS52YWx1ZU9mKCkpICsgIikiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAieyAiICsgKHJlcy5sZW5ndGggPyByZXMuam9pbigiLCAiKSArICIgIiA6ICIiKSArICJ9IjsKICAgICAgICAgIH0gZWxzZSByZXR1cm4gIntvYmplY3R9IjsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuICJ1bmtub3duIHR5cGUgYCIgKyB0eXBlb2YgdmFsdWUgKyAiYCI7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzVHJ1dGh5KHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlVmFsdWVzKGFjdHVhbCwgZXhwZWN0ZWQsIGRlZXApIHsKICAgICAgdmFyIGVycm9yOwogICAgICBpZiAoYWN0dWFsID09PSBleHBlY3RlZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIGFjdHVhbCAhPSB0eXBlb2YgZXhwZWN0ZWQpIHJldHVybiBFUlJPUl9UWVBFX01JU1NNQVRDSDsKICAgICAgaWYgKGFjdHVhbCAhPSBudWxsICYmIGV4cGVjdGVkICE9IG51bGwgJiYgYWN0dWFsLmNvbnN0cnVjdG9yICE9PSBleHBlY3RlZC5jb25zdHJ1Y3RvcikgcmV0dXJuIEVSUk9SX1RZUEVfTUlTU01BVENIOwogICAgICBpZiAoYWN0dWFsID09IGV4cGVjdGVkKSByZXR1cm47CiAgICAgIHN3aXRjaCAodHlwZW9mIGFjdHVhbCkgewogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgIGlmIChhY3R1YWwgIT09IGFjdHVhbCAmJiBleHBlY3RlZCAhPT0gZXhwZWN0ZWQpIHJldHVybjsKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKGV4cGVjdGVkLm9yaWdpbmFsRm5fKSBleHBlY3RlZCA9IGV4cGVjdGVkLm9yaWdpbmFsRm5fOwogICAgICAgICAgaWYgKGFjdHVhbC5vcmlnaW5hbEZuXykgYWN0dWFsID0gYWN0dWFsLm9yaWdpbmFsRm5fOwogICAgICAgICAgaWYgKFN0cmluZyhleHBlY3RlZCkgPT0gU3RyaW5nKGFjdHVhbCkpIHJldHVybjsKICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmICghZXhwZWN0ZWQgJiYgYWN0dWFsIHx8IGV4cGVjdGVkICYmICFhY3R1YWwpIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgICBpZiAoU3RyaW5nKGV4cGVjdGVkKSAhPSBTdHJpbmcoYWN0dWFsKSkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgIGlmIChhY3R1YWwgJiYgImxlbmd0aCIgaW4gYWN0dWFsKSB7CiAgICAgICAgICAgIGlmIChhY3R1YWwubGVuZ3RoICE9IGV4cGVjdGVkLmxlbmd0aCkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY3R1YWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoYWN0dWFsW2ldICE9PSBleHBlY3RlZFtpXSkgewogICAgICAgICAgICAgICAgaWYgKGRlZXAgJiYgIWFjdHVhbC5fX2FudGlyZWN1cnNpb25fXykgewogICAgICAgICAgICAgICAgICBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX18gPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbXBhcmVWYWx1ZXMoYWN0dWFsW2ldLCBleHBlY3RlZFtpXSwgZGVlcCk7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX187CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgcmV0dXJuIGVycm9yOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBFUlJPUl9XUk9OR19BTlNXRVI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBpIGluIGFjdHVhbCkgaWYgKGkgaW4gZXhwZWN0ZWQgPT0gZmFsc2UgfHwgYWN0dWFsW2ldICE9PSBleHBlY3RlZFtpXSkgewogICAgICAgICAgICAgIGlmIChkZWVwICYmIGkgaW4gZXhwZWN0ZWQgJiYgIWFjdHVhbC5fX2FudGlyZWN1cnNpb25fXykgewogICAgICAgICAgICAgICAgYWN0dWFsLl9fYW50aXJlY3Vyc2lvbl9fID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yID0gY29tcGFyZVZhbHVlcyhhY3R1YWxbaV0sIGV4cGVjdGVkW2ldLCBkZWVwKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBhY3R1YWwuX19hbnRpcmVjdXJzaW9uX187CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiBlcnJvcjsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gRVJST1JfV1JPTkdfQU5TV0VSOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gZXhwZWN0ZWQpIGlmIChpIGluIGFjdHVhbCA9PSBmYWxzZSkgcmV0dXJuIEVSUk9SX1dST05HX0FOU1dFUjsKICAgICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0Rm5JbmZvKHRlc3QpIHsKICAgICAgdmFyIGluZm8gPSBiYXNpcy51dGlscy5pbmZvLmZuKHRlc3QpOwogICAgICB2YXIgYXJncyA9IGluZm8uYXJncyA/IGluZm8uYXJncy5zcGxpdCgvXHMqLFxzKi8pIDogW107CiAgICAgIHZhciBjb2RlID0gaW5mby5ib2R5LnJlcGxhY2UoLyhbXHJcbl18XHMpKlwidXNlIHN0cmljdFwiOy8sICIiKS5yZXBsYWNlKC9cci9nLCAiIikucmVwbGFjZSgvXihccypcbikrfChcblxzKikqJC9nLCAiIik7CiAgICAgIHZhciBtaW5PZmZzZXQgPSBjb2RlLnNwbGl0KC9cbisvKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgIHJldHVybiBsaW5lLm1hdGNoKC9eKFxzKikvKVswXTsKICAgICAgfSkuc29ydCgpWzBdOwogICAgICByZXR1cm4gewogICAgICAgIGFyZ3M6IGFyZ3MsCiAgICAgICAgY29kZTogY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoIihefFxcbikiICsgbWluT2Zmc2V0LCAiZyIpLCAiJDEiKSB8fCAiLy8gbm8gc291cmNlIGNvZGUiCiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgc2xpY2VPd25Pbmx5OiBzbGljZU93bk9ubHksCiAgICAgIG1ha2VTdGF0aWNDb3B5OiBtYWtlU3RhdGljQ29weSwKICAgICAgdmFsdWUyc3RyaW5nOiB2YWx1ZTJzdHJpbmcsCiAgICAgIGNvbXBhcmVWYWx1ZXM6IGNvbXBhcmVWYWx1ZXMsCiAgICAgIGlzVHJ1dGh5OiBpc1RydXRoeSwKICAgICAgZ2V0Rm5JbmZvOiBnZXRGbkluZm8KICAgIH07CiAgfSwKICAiaS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgZnVuY3Rpb24gcmVzb2x2ZUdldHRlcihnZXR0ZXIpIHsKICAgICAgaWYgKGdldHRlci5iYXNpc0dldHRlcklkXyA+IDApIHsKICAgICAgICB2YXIgcmVzdWx0ID0gImdldHRlcigiOwogICAgICAgIGlmICh0eXBlb2YgZ2V0dGVyLmJhc2UgPT0gInN0cmluZyIpIHJlc3VsdCArPSAnIicgKyBnZXR0ZXIuYmFzZS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsgZWxzZSB7CiAgICAgICAgICBpZiAoIWdldHRlci5tb2QpIHJldHVybiByZXNvbHZlR2V0dGVyKGdldHRlci5iYXNlKTsgZWxzZSByZXN1bHQgKz0gcmVzb2x2ZUdldHRlcihnZXR0ZXIuYmFzZSk7CiAgICAgICAgfQogICAgICAgIGlmIChnZXR0ZXIubW9kKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGdldHRlci5tb2QgPT0gInN0cmluZyIpIHJlc3VsdCArPSAnLCAiJyArIGdldHRlci5tb2QucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7IGVsc2UgcmVzdWx0ICs9ICIsICIgKyByZXNvbHZlR2V0dGVyKGdldHRlci5tb2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0ICsgIikiOwogICAgICB9IGVsc2UgcmV0dXJuIEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGdldHRlcik7CiAgICB9CiAgICBmdW5jdGlvbiB0b2tlbml6ZUZ1bmN0aW9uU291cmNlKHNvdXJjZSkgewogICAgICB2YXIgY2hhcnMgPSBzb3VyY2Uuc3BsaXQoIiIpOwogICAgICB2YXIgcmVzID0gW107CiAgICAgIHZhciBsYXN0ID0gMDsKICAgICAgdmFyIGo7CiAgICAgIGZ1bmN0aW9uIHN0b3JlKHR5cGUsIHBvcykgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9IDIpIHBvcyA9IGk7CiAgICAgICAgaWYgKGxhc3QgIT0gcG9zKSB7CiAgICAgICAgICByZXMucHVzaChbIHR5cGUgfHwgImNvbnRlbnQiLCBzb3VyY2Uuc3Vic3RyaW5nKGxhc3QsIHBvcykgXSk7CiAgICAgICAgICBsYXN0ID0gcG9zOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYXJzLmxlbmd0aDsgaSsrKSBtYWluX2xvb3AgOiB7CiAgICAgICAgdmFyIGNoID0gY2hhcnNbaV07CiAgICAgICAgc3dpdGNoIChjaCkgewogICAgICAgICAgY2FzZSAiLyI6CiAgICAgICAgICAgIHN0b3JlKCk7CiAgICAgICAgICAgIGogPSBpOwogICAgICAgICAgICBpZiAoY2hhcnNbaiArIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICBqID0gaiArIDI7CiAgICAgICAgICAgICAgd2hpbGUgKGogPCBjaGFycy5sZW5ndGggJiYgY2hhcnNbal0gIT09ICJcbiIgJiYgY2hhcnNbal0gIT09ICJcciIpIGorKzsKICAgICAgICAgICAgICBzdG9yZSgiY29tbWVudCIsIGopOwogICAgICAgICAgICAgIGkgPSBsYXN0IC0gMTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hhcnNbaiArIDFdID09ICIqIikgewogICAgICAgICAgICAgIGogPSBqICsgMjsKICAgICAgICAgICAgICB3aGlsZSAoaiA8IGNoYXJzLmxlbmd0aCAmJiAhKGNoYXJzW2pdID09PSAiKiIgJiYgY2hhcnNbaiArIDFdID09PSAiLyIpKSBqKys7CiAgICAgICAgICAgICAgc3RvcmUoImNvbW1lbnQiLCBqICsgMik7CiAgICAgICAgICAgICAgaSA9IGxhc3QgLSAxOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChqIDwgY2hhcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgIGlmIChjaGFyc1tqXSA9PSAiXG4iKSBicmVhayBtYWluX2xvb3A7CiAgICAgICAgICAgICAgaWYgKGNoYXJzW2pdID09ICJcXCIpIHsKICAgICAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGNoYXJzW2pdID09IGNoKSBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RvcmUoInJlZ2V4cCIsIGogKyAxKTsKICAgICAgICAgICAgaSA9IGxhc3QgLSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICAgIHN0b3JlKCk7CiAgICAgICAgICAgIGogPSBpOwogICAgICAgICAgICB3aGlsZSAoaiA8IGNoYXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgICBpZiAoY2hhcnNbal0gPT0gIlxcIikgewogICAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhcnNbal0gPT0gY2gpIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yZSgic3RyaW5nIiwgaiArIDEpOwogICAgICAgICAgICBpID0gbGFzdCAtIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiKCI6CiAgICAgICAgICBjYXNlICJ7IjoKICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgbGFzdCA9IGkgKyAxOwogICAgICAgICAgICByZXMucHVzaChbICJvcGVuIiwgY2ggXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiKSI6CiAgICAgICAgICBjYXNlICJ9IjoKICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgbGFzdCA9IGkgKyAxOwogICAgICAgICAgICByZXMucHVzaChbICJjbG9zZSIsIGNoIF0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGlmICgvXHMvLnRlc3QoY2gpKSB7CiAgICAgICAgICAgICAgc3RvcmUoKTsKICAgICAgICAgICAgICBqID0gaSArIDE7CiAgICAgICAgICAgICAgd2hpbGUgKGogPCBjaGFycy5sZW5ndGggJiYgL1xzLy50ZXN0KGNoYXJzW2pdKSkgaisrOwogICAgICAgICAgICAgIHN0b3JlKCJzcGFjZSIsIGopOwogICAgICAgICAgICAgIGkgPSBsYXN0IC0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBzdG9yZSgpOwogICAgICByZXR1cm4gcmVzOwogICAgfQogICAgZnVuY3Rpb24gZnVuY3Rpb25JbmZvKGZuKSB7CiAgICAgIHZhciBnZXR0ZXIgPSByZXNvbHZlR2V0dGVyKGZuKTsKICAgICAgdmFyIHNvdXJjZSA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZuKTsKICAgICAgdmFyIHRva2VucyA9IHRva2VuaXplRnVuY3Rpb25Tb3VyY2Uoc291cmNlKTsKICAgICAgdmFyIG5hbWUgPSAiYW5vbnltb3VzIjsKICAgICAgdmFyIGFyZ3NDb250ZXh0ID0gZmFsc2U7CiAgICAgIHZhciB3YXNDb250ZW50ID0gdHJ1ZTsKICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgdmFyIHRva2VuOwogICAgICB3aGlsZSAodG9rZW4gPSB0b2tlbnMuc2hpZnQoKSkgewogICAgICAgIGlmICh0b2tlblsxXSA9PSAieyIpIGJyZWFrOwogICAgICAgIGlmICh0b2tlblswXSA9PSAiY29udGVudCIpIHsKICAgICAgICAgIHdhc0NvbnRlbnQgPSB0cnVlOwogICAgICAgICAgaWYgKGFyZ3NDb250ZXh0KSBhcmdzLnB1c2godG9rZW5bMV0pOyBlbHNlIHsKICAgICAgICAgICAgaWYgKHRva2VuWzFdICE9ICJmdW5jdGlvbiIpIG5hbWUgPSB0b2tlblsxXTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFhcmdzQ29udGV4dCkgYXJnc0NvbnRleHQgPSB3YXNDb250ZW50ICYmIHRva2VuWzFdID09ICIoIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKHRva2VuID0gdG9rZW5zLnBvcCgpKSBpZiAodG9rZW5bMV0gPT0gIn0iKSBicmVhazsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHRva2Vuc1tpXSA9IHRva2Vuc1tpXVsxXTsKICAgICAgYXJncyA9IGFyZ3Muam9pbigiIikudHJpbSgpLnJlcGxhY2UoL1xzKixccyovZywgIiwgIik7CiAgICAgIHJldHVybiB7CiAgICAgICAgc291cmNlOiBzb3VyY2UsCiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBmdWxsbmFtZTogbmFtZSArICIoIiArIGFyZ3MgKyAiKSIsCiAgICAgICAgYXJnczogYXJncywKICAgICAgICBib2R5OiB0b2tlbnMuam9pbigiIiksCiAgICAgICAgZ2V0dGVyOiBnZXR0ZXIgIT0gc291cmNlID8gZ2V0dGVyIDogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBmbjogZnVuY3Rpb25JbmZvCiAgICB9OwogIH0sCiAgIjEuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudCB8fCB7CiAgICAgIHRpdGxlOiAidW5rbm93biIKICAgIH07CiAgICB2YXIgYXBwVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKICAgIHZhciBhcHBJbml0ID0gYmFzaXMuZm4uJHVuZGVmOwogICAgdmFyIGFwcEluamVjdFBvaW50OwogICAgdmFyIGFwcEVsOwogICAgZnVuY3Rpb24gdXBkYXRlVGl0bGUodmFsdWUpIHsKICAgICAgZG9jdW1lbnQudGl0bGUgPSB2YWx1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc29sdmVOb2RlKHJlZikgewogICAgICByZXR1cm4gdHlwZW9mIHJlZiA9PSAic3RyaW5nIiA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJlZikgOiByZWY7CiAgICB9CiAgICBmdW5jdGlvbiByZXBsYWNlTm9kZShvbGRDaGlsZCwgbmV3Q2hpbGQpIHsKICAgICAgb2xkQ2hpbGQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Q2hpbGQsIG9sZENoaWxkKTsKICAgIH0KICAgIHZhciBjcmVhdGVBcHAgPSBiYXNpcy5mbi5sYXp5SW5pdChmdW5jdGlvbihjb25maWcpIHsKICAgICAgdmFyIHJlYWR5SGFuZGxlcnMgPSBbXTsKICAgICAgdmFyIGluaXRlZCA9IGZhbHNlOwogICAgICB2YXIgYXBwID0gewogICAgICAgIGluaXRlZDogZmFsc2UsCiAgICAgICAgc2V0VGl0bGU6IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICAgICAgICBpZiAodGl0bGUgIT0gYXBwVGl0bGUpIHsKICAgICAgICAgICAgaWYgKGFwcFRpdGxlIGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIGFwcFRpdGxlLmRldGFjaCh1cGRhdGVUaXRsZSk7CiAgICAgICAgICAgIGlmICh0aXRsZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSB7CiAgICAgICAgICAgICAgdGl0bGUuYXR0YWNoKHVwZGF0ZVRpdGxlKTsKICAgICAgICAgICAgICB1cGRhdGVUaXRsZSh0aXRsZS5nZXQoKSk7CiAgICAgICAgICAgIH0gZWxzZSB1cGRhdGVUaXRsZSh0aXRsZSk7CiAgICAgICAgICAgIGFwcFRpdGxlID0gdGl0bGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgdmFyIG5ld0FwcEVsID0gcmVzb2x2ZU5vZGUoZWwpOwogICAgICAgICAgaWYgKGFwcEVsID09IG5ld0FwcEVsKSByZXR1cm47CiAgICAgICAgICBpZiAoYXBwRWwpIHsKICAgICAgICAgICAgcmVwbGFjZU5vZGUoYXBwRWwsIG5ld0FwcEVsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIGFwcEVsID0gbmV3QXBwRWw7CiAgICAgICAgICBpZiAoIWFwcEluamVjdFBvaW50KSBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgdHlwZTogImFwcGVuZCIsCiAgICAgICAgICAgIG5vZGU6IGRvY3VtZW50LmJvZHkKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbm9kZSA9IHJlc29sdmVOb2RlKGFwcEluamVjdFBvaW50Lm5vZGUpOwogICAgICAgICAgaWYgKCFub2RlKSByZXR1cm47CiAgICAgICAgICBpZiAoYXBwSW5qZWN0UG9pbnQudHlwZSA9PSAiYXBwZW5kIikgbm9kZS5hcHBlbmRDaGlsZChhcHBFbCk7IGVsc2UgcmVwbGFjZU5vZGUobm9kZSwgYXBwRWwpOwogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoaW5pdGVkKSBmbi5jYWxsKGNvbnRleHQsIGFwcCk7IGVsc2UgcmVhZHlIYW5kbGVycy5wdXNoKHsKICAgICAgICAgICAgZm46IGZuLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGZvciAodmFyIGtleSBpbiBjb25maWcpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb25maWdba2V5XTsKICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgY2FzZSAidGl0bGUiOgogICAgICAgICAgICBhcHAuc2V0VGl0bGUodmFsdWUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImNvbnRhaW5lciI6CiAgICAgICAgICAgIGFwcEluamVjdFBvaW50ID0gewogICAgICAgICAgICAgIHR5cGU6ICJhcHBlbmQiLAogICAgICAgICAgICAgIG5vZGU6IHZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAicmVwbGFjZSI6CiAgICAgICAgICAgIGFwcEluamVjdFBvaW50ID0gewogICAgICAgICAgICAgIHR5cGU6ICJyZXBsYWNlIiwKICAgICAgICAgICAgICBub2RlOiB2YWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImVsZW1lbnQiOgogICAgICAgICAgICBhcHBFbCA9IHZhbHVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImluaXQiOgogICAgICAgICAgICBhcHBJbml0ID0gdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgPyB2YWx1ZSA6IGFwcEluaXQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gY29uZmlnIHByb3BlcnR5IGAiICsga2V5ICsgImAgZm9yIGFwcCwgdmFsdWU6IiwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5zZXJ0RWwgPSBhcHBFbDsKICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGFwcEluaXQuY2FsbChhcHApOwogICAgICAgIGlmIChpbml0UmVzdWx0KSB7CiAgICAgICAgICBpZiAoaW5pdFJlc3VsdC5lbGVtZW50KSBpbnNlcnRFbCA9IGluaXRSZXN1bHQuZWxlbWVudDsgZWxzZSBpbnNlcnRFbCA9IGluaXRSZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGFwcEVsID0gbnVsbDsKICAgICAgICBhcHAuc2V0RWxlbWVudChpbnNlcnRFbCk7CiAgICAgICAgaW5pdGVkID0gdHJ1ZTsKICAgICAgICBhcHAuaW5pdGVkID0gdHJ1ZTsKICAgICAgICB2YXIgaGFuZGxlcjsKICAgICAgICB3aGlsZSAoaGFuZGxlciA9IHJlYWR5SGFuZGxlcnMuc2hpZnQoKSkgaGFuZGxlci5mbi5jYWxsKGhhbmRsZXIuY29udGV4dCwgYXBwKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBhcHA7CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZUFwcAogICAgfTsKICB9LAogICJxLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgZnVuY3Rpb24gcnVuSW5Db250ZXh0KGNvbnRleHRXaW5kb3csIGNvZGUpIHsKICAgICAgKGNvbnRleHRXaW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihjb2RlKSB7CiAgICAgICAgY29udGV4dFdpbmRvd1siZXZhbCJdLmNhbGwoY29udGV4dFdpbmRvdywgY29kZSk7CiAgICAgIH0pKGNvZGUpOwogICAgfQogICAgdmFyIEZyYW1lRW52ID0gYmFzaXMudWkuTm9kZS5zdWJjbGFzcyh7CiAgICAgIGFwcGx5RW52aXJvbm1lbnQ6IG51bGwsCiAgICAgIGluaXRFbnY6IG51bGwsCiAgICAgIGh0bWw6IG51bGwsCiAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy51aS5Ob2RlLnByb3RvdHlwZS5wb3N0SW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLmRvYy5ib2R5LmFkZCh0aGlzLmVsZW1lbnQpOwogICAgICB9LAogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjMSIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgc3JjOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS5odG1sICYmIG5vZGUuaHRtbCAhPSAiZGVmYXVsdCIpIHJldHVybiBub2RlLmh0bWw7CiAgICAgICAgICByZXR1cm4gYmFzaXMucGF0aC5yZXNvbHZlKGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpLmJhc2VVUkkgfHwgIiIsICJyZXMvX09YY19ZQy1KTllrRDRDeTg5RUJDZy5odG1sIik7CiAgICAgICAgfQogICAgICB9LAogICAgICBhY3Rpb246IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZnJhbWVXaW5kb3cgPSB0aGlzLmVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgIHZhciBpbml0Q29kZSA9ICIiOwogICAgICAgICAgdmFyIGNvZGUgPSBiYXNpcy5yZXNvdXJjZSgiLi8wLmNvZGUiKS5mZXRjaCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBjb2RlID09ICJmdW5jdGlvbiIpIGNvZGUgPSBiYXNpcy51dGlscy5pbmZvLmZuKGNvZGUpLmJvZHk7CiAgICAgICAgICBydW5JbkNvbnRleHQoZnJhbWVXaW5kb3csIGNvZGUpOwogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmluaXRFbnYgPT0gImZ1bmN0aW9uIikgaW5pdENvZGUgPSBiYXNpcy51dGlscy5pbmZvLmZuKHRoaXMuaW5pdEVudikuYm9keTsKICAgICAgICAgIHRoaXMuYXBwbHlFbnZpcm9ubWVudCA9IGZyYW1lV2luZG93Ll9faW5pdFRlc3RFbnZpcm9ubWVudChpbml0Q29kZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICAgIGlmICh0aGlzLnJ1bkFyZ3MpIHsKICAgICAgICAgICAgdGhpcy5ydW4uYXBwbHkodGhpcywgdGhpcy5ydW5BcmdzKTsKICAgICAgICAgICAgdGhpcy5ydW5BcmdzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJ1bjogZnVuY3Rpb24oY29kZSwgY29udGV4dCwgcnVuVGVzdCkgewogICAgICAgIGlmICh0aGlzLmFwcGx5RW52aXJvbm1lbnQpIHJ1blRlc3QuY2FsbChjb250ZXh0LCB0aGlzLmFwcGx5RW52aXJvbm1lbnQoY29kZSkpOyBlbHNlIHRoaXMucnVuQXJncyA9IGFyZ3VtZW50czsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMudWkuTm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYXBwbHlFbnZpcm9ubWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5ydW5BcmdzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IEZyYW1lRW52OwogIH0sCiAgIjAuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgcnVubmVyID0gYmFzaXMucmVxdWlyZSgiLi9jLmpzIik7CiAgICB2YXIgdG9jID0gYmFzaXMucmVxdWlyZSgiLi9yLmpzIik7CiAgICB2YXIgdGVzdERldGFpbHMgPSBiYXNpcy5yZXF1aXJlKCIuL3MuanMiKTsKICAgIHZhciByb290VGVzdFN1aXRlID0gbmV3IGJhc2lzLmRhdGEuT2JqZWN0KHsKICAgICAgZ2V0Q2hpbGROb2Rlc0RhdGFzZXQ6IGZ1bmN0aW9uKCkge30KICAgIH0pOwogICAgZnVuY3Rpb24gZmluZFRlc3QodGVzdCwgZmlsZW5hbWUpIHsKICAgICAgaWYgKHRlc3QuZGF0YS5maWxlbmFtZV8gPT09IGZpbGVuYW1lKSByZXR1cm4gdGVzdDsKICAgICAgaWYgKHRlc3QuY2hpbGROb2RlcykgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IHRlc3QuY2hpbGROb2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgdmFyIHJlcyA9IGZpbmRUZXN0KGNoaWxkLCBmaWxlbmFtZSk7CiAgICAgICAgaWYgKHJlcykgcmV0dXJuIHJlczsKICAgICAgfQogICAgfQogICAgdG9jLmFkZEhhbmRsZXIoewogICAgICBkZWxlZ2F0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlICghY3Vyc29yLmRhdGEuZmlsZW5hbWVfICYmIGN1cnNvci5yb290LnBhcmVudE5vZGUpIGN1cnNvciA9IGN1cnNvci5yb290LnBhcmVudE5vZGU7CiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICIjIiArIChjdXJzb3Iucm9vdC5wYXJlbnROb2RlICYmIGN1cnNvci5kYXRhLmZpbGVuYW1lXyA/IGN1cnNvci5kYXRhLmZpbGVuYW1lXyA6ICIiKTsKICAgICAgfSwKICAgICAgY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbigpIHsKICAgICAgICBydW5uZXIubG9hZFRlc3RzKHRoaXMuY2hpbGROb2Rlcy5zbGljZSgwKSk7CiAgICAgIH0KICAgIH0pOwogICAgdG9jLnNlbGVjdGlvbi5hZGRIYW5kbGVyKHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICB0aGlzLnNldERlbGVnYXRlKHNlbGVjdGlvbi5waWNrKCkpOwogICAgICB9CiAgICB9LCB0ZXN0RGV0YWlscyk7CiAgICB0ZXN0RGV0YWlscy5zZWxlY3Rpb24uYWRkSGFuZGxlcih7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oc2VsZWN0aW9uKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0aW9uLnBpY2soKTsKICAgICAgICBpZiAoc2VsZWN0ZWQpIHRoaXMuc2V0RGVsZWdhdGUoc2VsZWN0ZWQucm9vdCk7CiAgICAgIH0KICAgIH0sIHRvYyk7CiAgICB2YXIgdmlldyA9IG5ldyBiYXNpcy51aS5Ob2RlKHsKICAgICAgdGVtcGxhdGU6IGJhc2lzLnRlbXBsYXRlLmdldCgiIzkiKSwKICAgICAgYWN0aW9uOiB7CiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdG9jLnNldERlbGVnYXRlKHJvb3RUZXN0U3VpdGUpOwogICAgICAgIH0sCiAgICAgICAgcnVuOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJ1bm5lci5ydW4oKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICB0b2M6IHRvYywKICAgICAgICB0ZXN0czogdGVzdERldGFpbHMsCiAgICAgICAgbmFtZTogYmFzaXMuZGF0YS5WYWx1ZS5mcm9tKHJvb3RUZXN0U3VpdGUsICJ1cGRhdGUiLCAiZGF0YS5uYW1lIiksCiAgICAgICAgdGltZTogcnVubmVyLnRpbWUsCiAgICAgICAgdG90YWw6IHJ1bm5lci5jb3VudC50b3RhbCwKICAgICAgICBhc3NlcnQ6IHJ1bm5lci5jb3VudC5hc3NlcnQsCiAgICAgICAgbGVmdDogcnVubmVyLmNvdW50LmxlZnQsCiAgICAgICAgZG9uZTogcnVubmVyLmNvdW50LmRvbmUKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgbG9hZFRlc3RzOiBmdW5jdGlvbihkYXRhLCByZWZlcmVuY2UpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgZGF0YSA9IHsKICAgICAgICAgIHRlc3Q6IGRhdGEKICAgICAgICB9OwogICAgICAgIHZhciByb290VGVzdCA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpLmNyZWF0ZShkYXRhKTsKICAgICAgICB2YXIgbWFya2VyID0gbG9jYXRpb24uaGFzaC5zdWJzdHIoMSk7CiAgICAgICAgdmFyIHRlc3RCeUZpbGVuYW1lOwogICAgICAgIGlmIChtYXJrZXIpIHRlc3RCeUZpbGVuYW1lID0gZmluZFRlc3Qocm9vdFRlc3QsIG1hcmtlcik7CiAgICAgICAgdG9jLnNldERlbGVnYXRlKHRlc3RCeUZpbGVuYW1lIHx8IHJvb3RUZXN0U3VpdGUpOwogICAgICAgIHJvb3RUZXN0U3VpdGUuc2V0RGVsZWdhdGUocm9vdFRlc3QpOwogICAgICB9CiAgICB9OwogICAgaWYgKGJhc2lzLmNvbmZpZy5leHBvcnRzKSB7CiAgICAgIGdsb2JhbC5iYXNpc2pzVGVzdFJ1bm5lciA9IGJhc2lzLm9iamVjdC5leHRlbmQobW9kdWxlLmV4cG9ydHMsIHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbmZpZ1trZXldOwogICAgICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgICAgIGNhc2UgImVsZW1lbnQiOgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh2aWV3LmVsZW1lbnQpOwogICAgICAgICAgICAgICAgfS5iaW5kKHZhbHVlKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJiYXNlVVJJIjoKICAgICAgICAgICAgICAgIGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpLmJhc2VVUkkgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBydW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgcnVubmVyLnJ1bigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kb2MuYm9keS5hZGQodmlldy5lbGVtZW50KTsKICAgICAgfSk7CiAgICB9CiAgfSwKICAiMi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi83LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBIdG1sVGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5odG1sLlRlbXBsYXRlOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIERXTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLk5vZGU7CiAgICB2YXIgRFdQYXJ0aXRpb25Ob2RlID0gYmFzaXMuZG9tLndyYXBwZXIuUGFydGl0aW9uTm9kZTsKICAgIHZhciBEV0dyb3VwaW5nTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZTsKICAgIHZhciBiaW5kaW5nU2VlZCA9IDE7CiAgICB2YXIgdW5rbm93bkV2ZW50QmluZGluZ0NoZWNrID0ge307CiAgICBmdW5jdGlvbiBleHRlbmRCaW5kaW5nKGJpbmRpbmcsIGV4dGVuc2lvbikgewogICAgICBiaW5kaW5nLmJpbmRpbmdJZCA9IGJpbmRpbmdTZWVkKys7CiAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICB2YXIgZGVmID0gbnVsbDsKICAgICAgICB2YXIgdmFsdWUgPSBleHRlbnNpb25ba2V5XTsKICAgICAgICBpZiAoTm9kZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIE5vZGUgfHwgYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZSh2YWx1ZSkpIHsKICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24oa2V5LCBzYXRlbGxpdGUpIHsKICAgICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSB0eXBlb2Ygc2F0ZWxsaXRlID09ICJmdW5jdGlvbiIgPyBzYXRlbGxpdGUgOiBudWxsOwogICAgICAgICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaW5pdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgIHNhdGVsbGl0ZSA9IHJlc291cmNlKCk7CiAgICAgICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBOb2RlID09IGZhbHNlKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0U2F0ZWxsaXRlKGtleSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNhdGVsbGl0ZVtrZXldICE9PSBzYXRlbGxpdGUpIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aS5iaW5kaW5nOiBpbXBsaWNpdCBzYXRlbGxpdGUgYCIgKyBrZXkgKyAiYCBhdHRhY2ggdG8gb3duZXIgZmFpbGVkIik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluaXQpIGluaXQobm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2UgfHwgKG5vZGUuc2F0ZWxsaXRlW2tleV0gPyBub2RlLnNhdGVsbGl0ZVtrZXldLmVsZW1lbnQgOiBudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KGtleSwgdmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBCSU5ESU5HX1BSRVNFVC5wcm9jZXNzKGtleSwgdmFsdWUpOyBlbHNlIGlmICh2YWx1ZS5iaW5kaW5nQnJpZGdlKSB2YWx1ZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBkZWYgPSB7CiAgICAgICAgICAgICAgICBnZXR0ZXI6IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBiYXNpcy5nZXR0ZXIodmFsdWUpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWVbMF0sCiAgICAgICAgICAgICAgICBnZXR0ZXI6IGJhc2lzLmdldHRlcih2YWx1ZVsxXSkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWUuZXZlbnRzLAogICAgICAgICAgICAgICAgZ2V0dGVyOiBiYXNpcy5nZXR0ZXIodmFsdWUuZ2V0dGVyKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmluZGluZ1trZXldID0gZGVmOwogICAgICB9CiAgICB9CiAgICB2YXIgQklORElOR19QUkVTRVQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByZXNldHMgPSB7fTsKICAgICAgdmFyIHByZWZpeFJlZ0V4cCA9IC9eKFthLXpfXVthLXowLTlfXSopOiguKikvaTsKICAgICAgcmV0dXJuIHsKICAgICAgICBhZGQ6IGZ1bmN0aW9uKHByZWZpeCwgZnVuYykgewogICAgICAgICAgaWYgKCFwcmVzZXRzW3ByZWZpeF0pIHsKICAgICAgICAgICAgcHJlc2V0c1twcmVmaXhdID0gZnVuYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJQcmVzZXQgYCIgKyBwcmVmaXggKyAiYCBhbHJlYWR5IGV4aXN0cywgbmV3IGRlZmluaXRpb24gaWdub3JlZCIpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgdmFyIHByZXNldDsKICAgICAgICAgIHZhciBtID0gdmFsdWUubWF0Y2gocHJlZml4UmVnRXhwKTsKICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHByZXNldCA9IHByZXNldHNbbVsxXV07CiAgICAgICAgICAgIHZhbHVlID0gbVsyXSB8fCBrZXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJlc2V0ID8gcHJlc2V0KHZhbHVlKSA6IHZhbHVlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIEJJTkRJTkdfUFJFU0VULmFkZCgiZGF0YSIsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBldmVudHM6ICJ1cGRhdGUiLAogICAgICAgIGdldHRlcjogImRhdGEuIiArIHBhdGgKICAgICAgfTsKICAgIH0pOwogICAgQklORElOR19QUkVTRVQuYWRkKCJzYXRlbGxpdGUiLCBmdW5jdGlvbihzYXRlbGxpdGVOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zYXRlbGxpdGVbc2F0ZWxsaXRlTmFtZV0gPyBub2RlLnNhdGVsbGl0ZVtzYXRlbGxpdGVOYW1lXS5lbGVtZW50IDogbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIHZhciBURU1QTEFURV9CSU5ESU5HID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoewogICAgICBzdGF0ZTogewogICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiB7CiAgICAgICAgZXZlbnRzOiAiY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuY2hpbGROb2Rlc1N0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ291bnQ6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuY2hpbGROb2RlcyA/IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggOiAwOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzQ2hpbGRyZW46IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZS5maXJzdENoaWxkOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1wdHk6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICFub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBleHRlbmRCaW5kaW5nKTsKICAgIHZhciBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSA9IHsKICAgICAgYXR0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURV9BQ1RJT04gPSBDbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoewogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKHRoaXMuaXNEaXNhYmxlZCgpKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuY29udGV4dFNlbGVjdGlvbiAmJiB0aGlzLmNvbnRleHRTZWxlY3Rpb24ubXVsdGlwbGUpIHRoaXMuc2VsZWN0KGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSk7IGVsc2UgdGhpcy5zZWxlY3QoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiA9IHsKICAgICAgIioiOiBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgaWYgKHN3aXRjaGVyICYmIHN3aXRjaGVyLnJ1bGVFdmVudHMgJiYgc3dpdGNoZXIucnVsZUV2ZW50c1tldmVudC50eXBlXSkgdGhpcy5zZXRUZW1wbGF0ZShzd2l0Y2hlci5yZXNvbHZlKHRoaXMpKTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURSA9IG5ldyBIdG1sVGVtcGxhdGUoIjxkaXYvPiIpOwogICAgdmFyIGZyYWdtZW50cyA9IFtdOwogICAgZnVuY3Rpb24gZ2V0RG9jdW1lbnRGcmFnbWVudCgpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50cy5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICB9CiAgICBmdW5jdGlvbiByZWluc2VydFBhcnRpdGlvbk5vZGVzKHBhcnRpdGlvbikgewogICAgICB2YXIgbm9kZXMgPSBwYXJ0aXRpb24ubm9kZXM7CiAgICAgIGlmIChub2RlcykgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDEsIGNoaWxkOyBjaGlsZCA9IG5vZGVzW2ldOyBpLS0pIGNoaWxkLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICB9CiAgICB2YXIgZm9jdXNUaW1lcjsKICAgIHZhciBUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGVtcGxhdGU6IFRFTVBMQVRFLAogICAgICAgIGVtaXRfdGVtcGxhdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgidGVtcGxhdGVDaGFuZ2VkIiksCiAgICAgICAgdGVtcGxhdGVTd2l0Y2hlcl86IG51bGwsCiAgICAgICAgYmluZGluZzogVEVNUExBVEVfQklORElORywKICAgICAgICBhY3Rpb246IFRFTVBMQVRFX0FDVElPTiwKICAgICAgICB0bXBsOiBudWxsLAogICAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgICAgZW1pdF91cGRhdGU6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlVXBkYXRlKHRoaXMudG1wbCwgInVwZGF0ZSIsIGRlbHRhKTsKICAgICAgICAgIHN1cGVyXy5lbWl0X3VwZGF0ZS5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB9LAogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5lbGVtZW50ID0gdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IGdldERvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgIHN1cGVyXy5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgfSwKICAgICAgICBwb3N0SW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzdXBlcl8ucG9zdEluaXQuY2FsbCh0aGlzKTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIG5vZGVEb2N1bWVudEZyYWdtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgICB2YXIgYmluZGluZ0lkID0gdGhpcy5jb25zdHJ1Y3Rvci5iYXNpc0NsYXNzSWRfICsgIl8iICsgdGhpcy5iaW5kaW5nLmJpbmRpbmdJZDsKICAgICAgICAgICAgaWYgKGJpbmRpbmdJZCBpbiB1bmtub3duRXZlbnRCaW5kaW5nQ2hlY2sgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICB1bmtub3duRXZlbnRCaW5kaW5nQ2hlY2tbYmluZGluZ0lkXSA9IHRydWU7CiAgICAgICAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gdGhpcy5iaW5kaW5nKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5iaW5kaW5nW2JpbmROYW1lXSAmJiB0aGlzLmJpbmRpbmdbYmluZE5hbWVdLmV2ZW50czsKICAgICAgICAgICAgICAgIGlmIChldmVudHMpIHsKICAgICAgICAgICAgICAgICAgZXZlbnRzID0gU3RyaW5nKGV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKCJlbWl0XyIgKyBldmVudE5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBiaW5kaW5nIGAiICsgYmluZE5hbWUgKyAiYCBoYXMgdW5rbm93biBldmVudCBgIiArIGV2ZW50TmFtZSArICJgIGZvciAiICsgdGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgIGZyYWdtZW50cy5wdXNoKG5vZGVEb2N1bWVudEZyYWdtZW50KTsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50KTsKICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHRlbXBsYXRlU3luYzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgb2xkRWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgIHZhciB0bXBsID0gdGhpcy50ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZSh0aGlzLCB0aGlzLnRlbXBsYXRlQWN0aW9uLCB0aGlzLnRlbXBsYXRlU3luYywgdGhpcy5iaW5kaW5nLCBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSk7CiAgICAgICAgICB2YXIgbm9DaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIGlmICh0bXBsLmNoaWxkTm9kZXNIZXJlKSB7CiAgICAgICAgICAgIHRtcGwuY2hpbGROb2Rlc0VsZW1lbnQgPSB0bXBsLmNoaWxkTm9kZXNIZXJlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHRtcGwuY2hpbGROb2Rlc0VsZW1lbnQuaW5zZXJ0UG9pbnQgPSB0bXBsLmNoaWxkTm9kZXNIZXJlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy50bXBsID0gdG1wbDsKICAgICAgICAgIHRoaXMuZWxlbWVudCA9IHRtcGwuZWxlbWVudDsKICAgICAgICAgIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSB0bXBsLmNoaWxkTm9kZXNFbGVtZW50IHx8IHRtcGwuZWxlbWVudDsKICAgICAgICAgIG5vQ2hpbGROb2Rlc0VsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50Lm5vZGVUeXBlICE9IDE7CiAgICAgICAgICBpZiAobm9DaGlsZE5vZGVzRWxlbWVudCkgdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgIGlmIChub0NoaWxkTm9kZXNFbGVtZW50KSB0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfID0gdHJ1ZTsgZWxzZSBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICAgIHRoaXMuZ3JvdXBpbmcuc3luY0RvbVJlZnMoKTsKICAgICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChjdXJzb3IuZ3JvdXBpbmcpIGN1cnNvciA9IGN1cnNvci5ncm91cGluZzsKICAgICAgICAgICAgdmFyIHRvcEdyb3VwaW5nID0gY3Vyc29yOwogICAgICAgICAgICBmb3IgKHZhciBncm91cE5vZGUgPSB0b3BHcm91cGluZy5sYXN0Q2hpbGQ7IGdyb3VwTm9kZTsgZ3JvdXBOb2RlID0gZ3JvdXBOb2RlLnByZXZpb3VzU2libGluZykgewogICAgICAgICAgICAgIGlmIChncm91cE5vZGUgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSB0b3BHcm91cGluZy5pbnNlcnRCZWZvcmUoZ3JvdXBOb2RlLCBncm91cE5vZGUubmV4dFNpYmxpbmcpOyBlbHNlIHJlaW5zZXJ0UGFydGl0aW9uTm9kZXMoZ3JvdXBOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWluc2VydFBhcnRpdGlvbk5vZGVzKHRvcEdyb3VwaW5nLm51bGxHcm91cCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBjaGlsZCA9IHRoaXMubGFzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5wcmV2aW91c1NpYmxpbmcpIHRoaXMuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIFBhcnRpdGlvbk5vZGUpIHJlaW5zZXJ0UGFydGl0aW9uTm9kZXModGhpcyk7CiAgICAgICAgICBpZiAodGhpcy5jb250ZW50KSAodG1wbC5jb250ZW50IHx8IHRtcGwuZWxlbWVudCkuYXBwZW5kQ2hpbGQodGhpcy5jb250ZW50Lm5vZGVUeXBlID8gdGhpcy5jb250ZW50IDogZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGhpcy5jb250ZW50KSk7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlVXBkYXRlKHRoaXMudG1wbCk7CiAgICAgICAgICBpZiAob2xkRWxlbWVudCAmJiBvbGRFbGVtZW50ICE9PSB0aGlzLmVsZW1lbnQgJiYgb2xkRWxlbWVudC5ub2RlVHlwZSAhPSAxMSkgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG9sZEVsZW1lbnQgJiYgb2xkRWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmICh0aGlzLm93bmVyICYmIHRoaXMub3duZXIudG1wbCkgdGhpcy5vd25lci50bXBsLnNldChvbGRFbGVtZW50LCB0aGlzLmVsZW1lbnQpOwogICAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQucGFyZW50Tm9kZSAhPT0gcGFyZW50Tm9kZSkgcGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy5lbGVtZW50LCBvbGRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3RlbXBsYXRlQ2hhbmdlZCgpOwogICAgICAgIH0sCiAgICAgICAgc2V0VGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICB2YXIgY3VyU3dpdGNoZXIgPSB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfOwogICAgICAgICAgdmFyIHN3aXRjaGVyOwogICAgICAgICAgaWYgKHRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hlcikgewogICAgICAgICAgICBzd2l0Y2hlciA9IHRlbXBsYXRlOwogICAgICAgICAgICB0ZW1wbGF0ZSA9IHN3aXRjaGVyLnJlc29sdmUodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGVtcGxhdGUgaW5zdGFuY2VvZiBIdG1sVGVtcGxhdGUgPT0gZmFsc2UpIHRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpLk5vZGUjc2V0VGVtcGxhdGU6IHNldCBudWxsIHRvIHRlbXBsYXRlIHBvc3NpYmxlIG9ubHkgb24gbm9kZSBkZXN0cm95Iik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzd2l0Y2hlcikgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gc3dpdGNoZXI7CiAgICAgICAgICAgIGlmICghY3VyU3dpdGNoZXIpIHRoaXMuYWRkSGFuZGxlcihURU1QTEFURV9TV0lUQ0hFUl9IQU5ETEVSLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJTd2l0Y2hlciAmJiBjdXJTd2l0Y2hlci5yZXNvbHZlKHRoaXMpICE9PSB0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMudGVtcGxhdGUgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZVN5bmMoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVwZGF0ZUJpbmQ6IGZ1bmN0aW9uKGJpbmROYW1lKSB7CiAgICAgICAgICB2YXIgYmluZGluZyA9IHRoaXMuYmluZGluZ1tiaW5kTmFtZV07CiAgICAgICAgICB2YXIgZ2V0dGVyID0gYmluZGluZyAmJiBiaW5kaW5nLmdldHRlcjsKICAgICAgICAgIGlmIChnZXR0ZXIgJiYgdGhpcy50bXBsKSB0aGlzLnRtcGwuc2V0KGJpbmROYW1lLCBnZXR0ZXIodGhpcykpOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVBY3Rpb246IGZ1bmN0aW9uKGFjdGlvbk5hbWUsIGV2ZW50KSB7CiAgICAgICAgICB2YXIgYWN0aW9uID0gdGhpcy5hY3Rpb25bYWN0aW9uTmFtZV07CiAgICAgICAgICBpZiAoYWN0aW9uKSBhY3Rpb24uY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgICBpZiAoIWFjdGlvbikgYmFzaXMuZGV2Lndhcm4oInRlbXBsYXRlIGNhbGwgYCIgKyBhY3Rpb25OYW1lICsgImAgYWN0aW9uLCBidXQgaXQgaXNuJ3QgZGVmaW5lZCBpbiBhY3Rpb24gbGlzdCIpOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVVcGRhdGU6IGZ1bmN0aW9uKHRtcGwsIGV2ZW50TmFtZSwgZGVsdGEpIHt9LAogICAgICAgIGZvY3VzOiBmdW5jdGlvbihzZWxlY3QpIHsKICAgICAgICAgIHZhciBmb2N1c0VsZW1lbnQgPSB0aGlzLnRtcGwgPyB0aGlzLnRtcGwuZm9jdXMgfHwgdGhpcy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIGlmIChmb2N1c0VsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGZvY3VzVGltZXIpIGZvY3VzVGltZXIgPSBiYXNpcy5jbGVhckltbWVkaWF0ZShmb2N1c1RpbWVyKTsKICAgICAgICAgICAgZm9jdXNUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9jdXNFbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0KSBmb2N1c0VsZW1lbnQuc2VsZWN0KCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBibHVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c0VsZW1lbnQgPSB0aGlzLnRtcGwgPyB0aGlzLnRtcGwuZm9jdXMgfHwgdGhpcy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIGlmIChmb2N1c0VsZW1lbnQpIHRyeSB7CiAgICAgICAgICAgIGZvY3VzRWxlbWVudC5ibHVyKCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlOwogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICBpZiAodGhpcy50ZW1wbGF0ZVN3aXRjaGVyXykgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlU3dpdGNoZXJfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGVtcGxhdGUuY2xlYXJJbnN0YW5jZSh0aGlzLnRtcGwpOwogICAgICAgICAgc3VwZXJfLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICAgIHRoaXMudG1wbCA9IG51bGw7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgICAgdGhpcy5jaGlsZE5vZGVzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKHBhcmVudE5vZGUgJiYgcGFyZW50Tm9kZS5ub2RlVHlwZSA9PSAxKSBwYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgICB2YXIgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiA9IGZ1bmN0aW9uKHN1cGVyXykgewogICAgICByZXR1cm4gewogICAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XykgewogICAgICAgICAgICBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBUZW1wbGF0ZSBoYXMgbm8gY2hpbGROb2Rlc0VsZW1lbnQgY29udGFpbmVyLCBidXQgaW5zZXJ0QmVmb3JlIG1ldGhvZCBjYWxsZWQ7IHByb2JhYmx5IGl0J3MgYSBidWciKTsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NoaWxkID0gc3VwZXJfLmluc2VydEJlZm9yZS5jYWxsKHRoaXMsIG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmV3Q2hpbGQuZ3JvdXBOb2RlIHx8IHRoaXM7CiAgICAgICAgICB2YXIgY29udGFpbmVyID0gdGFyZ2V0LmNoaWxkTm9kZXNFbGVtZW50IHx8IHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBuZXdDaGlsZC5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBpbnNlcnRQb2ludCA9IG5leHRTaWJsaW5nICYmIG5leHRTaWJsaW5nLmVsZW1lbnQucGFyZW50Tm9kZSA9PSBjb250YWluZXIgPyBuZXh0U2libGluZy5lbGVtZW50IDogbnVsbDsKICAgICAgICAgIHZhciBjaGlsZEVsZW1lbnQgPSBuZXdDaGlsZC5lbGVtZW50OwogICAgICAgICAgdmFyIHJlZk5vZGUgPSBpbnNlcnRQb2ludCB8fCBjb250YWluZXIuaW5zZXJ0UG9pbnQgfHwgbnVsbDsKICAgICAgICAgIGlmIChjaGlsZEVsZW1lbnQucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyIHx8IGNoaWxkRWxlbWVudC5uZXh0U2libGluZyAhPT0gcmVmTm9kZSkgY29udGFpbmVyLmluc2VydEJlZm9yZShjaGlsZEVsZW1lbnQsIHJlZk5vZGUpOwogICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgIH0sCiAgICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgICBzdXBlcl8ucmVtb3ZlQ2hpbGQuY2FsbCh0aGlzLCBvbGRDaGlsZCk7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IG9sZENoaWxkLmVsZW1lbnQ7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG9sZENoaWxkOwogICAgICAgIH0sCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgICBpZiAoYWxpdmUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBub2RlLmVsZW1lbnQ7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1cGVyXy5jbGVhci5jYWxsKHRoaXMsIGFsaXZlKTsKICAgICAgICB9LAogICAgICAgIHNldENoaWxkTm9kZXM6IGZ1bmN0aW9uKGNoaWxkTm9kZXMsIGtlZXBBbGl2ZSkgewogICAgICAgICAgaWYgKHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF8pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF87CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aTogVGVtcGxhdGUgaGFzIG5vIGNoaWxkTm9kZXNFbGVtZW50IGNvbnRhaW5lciwgYnV0IHNldENoaWxkTm9kZXMgbWV0aG9kIGNhbGxlZDsgcHJvYmFibHkgaXQncyBhIGJ1ZyIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuZ3JvdXBpbmcgfHwgdGhpczsKICAgICAgICAgIHZhciBjb250YWluZXIgPSB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb21GcmFnbWVudDsKICAgICAgICAgIHN1cGVyXy5zZXRDaGlsZE5vZGVzLmNhbGwodGhpcywgY2hpbGROb2Rlcywga2VlcEFsaXZlKTsKICAgICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoZG9tRnJhZ21lbnQsIGNvbnRhaW5lci5pbnNlcnRQb2ludCB8fCBudWxsKTsKICAgICAgICAgIHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudCA9IGNvbnRhaW5lcjsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwogICAgdmFyIFBhcnRpdGlvbk5vZGUgPSBDbGFzcyhEV1BhcnRpdGlvbk5vZGUsIFRlbXBsYXRlTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlBhcnRpdGlvbk5vZGUiLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgdGl0bGU6ICJkYXRhOiIKICAgICAgfQogICAgfSk7CiAgICB2YXIgR3JvdXBpbmdOb2RlID0gQ2xhc3MoRFdHcm91cGluZ05vZGUsIENvbnRhaW5lclRlbXBsYXRlTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkdyb3VwaW5nTm9kZSIsCiAgICAgIGNoaWxkQ2xhc3M6IFBhcnRpdGlvbk5vZGUsCiAgICAgIGdyb3VwaW5nQ2xhc3M6IENsYXNzLlNFTEYsCiAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgIGNoaWxkTm9kZXNFbGVtZW50OiBudWxsLAogICAgICBlbWl0X293bmVyQ2hhbmdlZDogZnVuY3Rpb24ob2xkT3duZXIpIHsKICAgICAgICB0aGlzLnN5bmNEb21SZWZzKCk7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmVtaXRfb3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgIERXR3JvdXBpbmdOb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHN5bmNEb21SZWZzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIHZhciBlbGVtZW50ID0gbnVsbDsKICAgICAgICBpZiAob3duZXIpIGVsZW1lbnQgPSBvd25lci50bXBsICYmIG93bmVyLnRtcGwuZ3JvdXBzRWxlbWVudCB8fCBvd25lci5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICBkbyB7CiAgICAgICAgICBjdXJzb3IuZWxlbWVudCA9IGN1cnNvci5jaGlsZE5vZGVzRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgfSB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmdyb3VwaW5nKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBOb2RlID0gQ2xhc3MoRFdOb2RlLCBUZW1wbGF0ZU1peGluLCBDb250YWluZXJUZW1wbGF0ZU1peGluLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ob2RlIiwKICAgICAgYmluZGluZzogewogICAgICAgIHNlbGVjdGVkOiB7CiAgICAgICAgICBldmVudHM6ICJzZWxlY3QgdW5zZWxlY3QiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLnNlbGVjdGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdW5zZWxlY3RlZDogewogICAgICAgICAgZXZlbnRzOiAic2VsZWN0IHVuc2VsZWN0IiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gIW5vZGUuc2VsZWN0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkaXNhYmxlZDogewogICAgICAgICAgZXZlbnRzOiAiZGlzYWJsZSBlbmFibGUiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLmRpc2FibGVkIHx8IG5vZGUuY29udGV4dERpc2FibGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZW5hYmxlZDogewogICAgICAgICAgZXZlbnRzOiAiZGlzYWJsZSBlbmFibGUiLAogICAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIHJldHVybiAhKG5vZGUuZGlzYWJsZWQgfHwgbm9kZS5jb250ZXh0RGlzYWJsZWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogQ2xhc3MuU0VMRiwKICAgICAgY2hpbGRGYWN0b3J5OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuY2hpbGRDbGFzcyhjb25maWcpOwogICAgICB9LAogICAgICBncm91cGluZ0NsYXNzOiBHcm91cGluZ05vZGUKICAgIH0pOwogICAgdmFyIFNoYWRvd05vZGVMaXN0ID0gTm9kZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TaGFkb3dOb2RlTGlzdCIsCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIE5vZGUucHJvdG90eXBlLmVtaXRfb3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSh0aGlzLm93bmVyICYmIHRoaXMub3duZXIuZ2V0Q2hpbGROb2Rlc0RhdGFzZXQoKSk7CiAgICAgIH0sCiAgICAgIGdldENoaWxkTm9kZXNFbGVtZW50OiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgfSwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgb3duZXI6IHsKICAgICAgICAgIHRlbXBsYXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZChjaGlsZC5lbGVtZW50KTsKICAgICAgICAgICAgfSwgdGhpcy5nZXRDaGlsZE5vZGVzRWxlbWVudCh0aGlzLm93bmVyKSB8fCB0aGlzLm93bmVyLmVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogewogICAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TaGFkb3dOb2RlIiwKICAgICAgICBnZXRFbGVtZW50OiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5lbGVtZW50OwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVTeW5jOiBmdW5jdGlvbigpIHsKICAgICAgICAgIE5vZGUucHJvdG90eXBlLnRlbXBsYXRlU3luYy5jYWxsKHRoaXMpOwogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQodGhpcy5kZWxlZ2F0ZSk7CiAgICAgICAgICBpZiAobmV3RWxlbWVudCkgewogICAgICAgICAgICBuZXdFbGVtZW50LmJhc2lzVGVtcGxhdGVJZCA9IHRoaXMuZGVsZWdhdGUuZWxlbWVudC5iYXNpc1RlbXBsYXRlSWQ7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG5ld0VsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBsaXN0ZW46IHsKICAgICAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgICAgIHRlbXBsYXRlQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgICAgdmFyIG9sZEVsZW1lbnRQYXJlbnQgPSBvbGRFbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQodGhpcy5kZWxlZ2F0ZSk7CiAgICAgICAgICAgICAgaWYgKG5ld0VsZW1lbnQpIG5ld0VsZW1lbnQuYmFzaXNUZW1wbGF0ZUlkID0gdGhpcy5kZWxlZ2F0ZS5lbGVtZW50LmJhc2lzVGVtcGxhdGVJZDsKICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBuZXdFbGVtZW50IHx8IHRoaXMudG1wbC5lbGVtZW50OwogICAgICAgICAgICAgIGlmIChvbGRFbGVtZW50UGFyZW50KSBvbGRFbGVtZW50UGFyZW50LnJlcGxhY2VDaGlsZCh0aGlzLmVsZW1lbnQsIG9sZEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBCSU5ESU5HX1BSRVNFVDogQklORElOR19QUkVTRVQsCiAgICAgIE5vZGU6IE5vZGUsCiAgICAgIFBhcnRpdGlvbk5vZGU6IFBhcnRpdGlvbk5vZGUsCiAgICAgIEdyb3VwaW5nTm9kZTogR3JvdXBpbmdOb2RlLAogICAgICBTaGFkb3dOb2RlTGlzdDogU2hhZG93Tm9kZUxpc3QsCiAgICAgIFNoYWRvd05vZGU6IFNoYWRvd05vZGVMaXN0LnByb3RvdHlwZS5jaGlsZENsYXNzCiAgICB9OwogIH0sCiAgImsuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBlc3ByaW1hID0gYmFzaXMucmVxdWlyZSgiLi9sLmpzIik7CiAgICB2YXIgVFJBVkVSU0VfQUJPUlQgPSAxOwogICAgdmFyIFRSQVZFUlNFX1NUT1BfREVFUCA9IDI7CiAgICB2YXIgTk9ERV9CUkFOQ0hFUyA9IHsKICAgICAgQXJyYXlFeHByZXNzaW9uOiBbICJlbGVtZW50cyIgXSwKICAgICAgQXNzaWdubWVudEV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIEJpbmFyeUV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIEJsb2NrU3RhdGVtZW50OiBbICJib2R5IiBdLAogICAgICBCcmVha1N0YXRlbWVudDogWyAibGFiZWwiIF0sCiAgICAgIENhbGxFeHByZXNzaW9uOiBbICJjYWxsZWUiLCAiYXJndW1lbnRzIiBdLAogICAgICBDYXRjaENsYXVzZTogWyAicGFyYW0iLCAiYm9keSIgXSwKICAgICAgQ29uZGl0aW9uYWxFeHByZXNzaW9uOiBbICJ0ZXN0IiwgImNvbnNlcXVlbnQiLCAiYWx0ZXJuYXRlIiBdLAogICAgICBDb250aW51ZVN0YXRlbWVudDogWyAibGFiZWwiIF0sCiAgICAgIERlYnVnZ2VyU3RhdGVtZW50OiBbXSwKICAgICAgRG9XaGlsZVN0YXRlbWVudDogWyAidGVzdCIsICJib2R5IiBdLAogICAgICBFbXB0eVN0YXRlbWVudDogW10sCiAgICAgIEV4cHJlc3Npb25TdGF0ZW1lbnQ6IFsgImV4cHJlc3Npb24iIF0sCiAgICAgIEZvckluU3RhdGVtZW50OiBbICJsZWZ0IiwgInJpZ2h0IiwgImJvZHkiIF0sCiAgICAgIEZvclN0YXRlbWVudDogWyAiaW5pdCIsICJ0ZXN0IiwgInVwZGF0ZSIsICJib2R5IiBdLAogICAgICBGdW5jdGlvbkRlY2xhcmF0aW9uOiBbICJpZCIsICJwYXJhbXMiLCAiYm9keSIgXSwKICAgICAgRnVuY3Rpb25FeHByZXNzaW9uOiBbICJpZCIsICJwYXJhbXMiLCAiZGVmYXVsdHMiLCAiYm9keSIgXSwKICAgICAgSWRlbnRpZmllcjogW10sCiAgICAgIElmU3RhdGVtZW50OiBbICJ0ZXN0IiwgImNvbnNlcXVlbnQiLCAiYWx0ZXJuYXRlIiBdLAogICAgICBMYWJlbGVkU3RhdGVtZW50OiBbICJsYWJlbCIsICJib2R5IiBdLAogICAgICBMaXRlcmFsOiBbXSwKICAgICAgTG9naWNhbEV4cHJlc3Npb246IFsgImxlZnQiLCAicmlnaHQiIF0sCiAgICAgIE1lbWJlckV4cHJlc3Npb246IFsgIm9iamVjdCIsICJwcm9wZXJ0eSIgXSwKICAgICAgTmV3RXhwcmVzc2lvbjogWyAiY2FsbGVlIiwgImFyZ3VtZW50cyIgXSwKICAgICAgT2JqZWN0RXhwcmVzc2lvbjogWyAicHJvcGVydGllcyIgXSwKICAgICAgUHJvZ3JhbTogWyAiYm9keSIgXSwKICAgICAgUHJvcGVydHk6IFsgImtleSIsICJ2YWx1ZSIgXSwKICAgICAgUmV0dXJuU3RhdGVtZW50OiBbICJhcmd1bWVudCIgXSwKICAgICAgU2VxdWVuY2VFeHByZXNzaW9uOiBbICJleHByZXNzaW9ucyIgXSwKICAgICAgU3dpdGNoQ2FzZTogWyAidGVzdCIsICJjb25zZXF1ZW50IiBdLAogICAgICBTd2l0Y2hTdGF0ZW1lbnQ6IFsgImRpc2NyaW1pbmFudCIsICJjYXNlcyIgXSwKICAgICAgVGhpc0V4cHJlc3Npb246IFtdLAogICAgICBUaHJvd1N0YXRlbWVudDogWyAiYXJndW1lbnQiIF0sCiAgICAgIFRyeVN0YXRlbWVudDogWyAiYmxvY2siLCAiaGFuZGxlcnMiLCAiZmluYWxpemVyIiBdLAogICAgICBVbmFyeUV4cHJlc3Npb246IFsgImFyZ3VtZW50IiBdLAogICAgICBVcGRhdGVFeHByZXNzaW9uOiBbICJhcmd1bWVudCIgXSwKICAgICAgVmFyaWFibGVEZWNsYXJhdGlvbjogWyAiZGVjbGFyYXRpb25zIiBdLAogICAgICBWYXJpYWJsZURlY2xhcmF0b3I6IFsgImlkIiwgImluaXQiIF0sCiAgICAgIFdoaWxlU3RhdGVtZW50OiBbICJ0ZXN0IiwgImJvZHkiIF0sCiAgICAgIFdpdGhTdGF0ZW1lbnQ6IFsgIm9iamVjdCIsICJib2R5IiBdCiAgICB9OwogICAgZnVuY3Rpb24gcGFyc2UoY29kZSkgewogICAgICBmdW5jdGlvbiBwb3N0UHJvY2Vzc2luZyhub2RlKSB7CiAgICAgICAgdmFyIGJyYW5jaGVzID0gTk9ERV9CUkFOQ0hFU1tub2RlLnR5cGVdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGJyYW5jaGVzW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGVba2V5XTsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFsdWUuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgcG9zdFByb2Nlc3NpbmcoY2hpbGQpOwogICAgICAgICAgICAgICAgY2hpbGQucm9vdCA9IHJlc3VsdDsKICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgY2hpbGQucGFyZW50Q29sbGVjdGlvbiA9IHZhbHVlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvc3RQcm9jZXNzaW5nKHZhbHVlKTsKICAgICAgICAgICAgICB2YWx1ZS5yb290ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhbHVlLnBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciByZXN1bHQgPSBlc3ByaW1hLnBhcnNlKGNvZGUsIHsKICAgICAgICBsb2M6IHRydWUsCiAgICAgICAgcmFuZ2U6IHRydWUsCiAgICAgICAgY29tbWVudDogdHJ1ZSwKICAgICAgICB0b2tlbnM6IHRydWUKICAgICAgfSk7CiAgICAgIHBvc3RQcm9jZXNzaW5nKHJlc3VsdCk7CiAgICAgIHJlc3VsdC5zb3VyY2UgPSBjb2RlOwogICAgICByZXN1bHQucm9vdCA9IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIHRyYXZlcnNlQXN0KG5vZGUsIHZpc2l0b3IpIHsKICAgICAgdmFyIHJlcyA9IHZpc2l0b3IuY2FsbChudWxsLCBub2RlKTsKICAgICAgaWYgKHJlcykgcmV0dXJuIHJlcyA9PSBUUkFWRVJTRV9BQk9SVCA/IHJlcyA6IGZhbHNlOwogICAgICB2YXIgYnJhbmNoZXMgPSBOT0RFX0JSQU5DSEVTW25vZGUudHlwZV07CiAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGJyYW5jaGVzW2ldOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBub2RlW2tleV07CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjaGlsZDsgY2hpbGQgPSB2YWx1ZVtqXTsgaisrKSBpZiAodHJhdmVyc2VBc3QoY2hpbGQsIHZpc2l0b3IpICYgVFJBVkVSU0VfQUJPUlQpIHJldHVybiBUUkFWRVJTRV9BQk9SVDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZUFzdCh2YWx1ZSwgdmlzaXRvcikgJiBUUkFWRVJTRV9BQk9SVCkgcmV0dXJuIFRSQVZFUlNFX0FCT1JUOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0UmFuZ2VUb2tlbnMoYXN0LCBzdGFydCwgZW5kKSB7CiAgICAgIHZhciBmaXJzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIHByZSwgcHJldiwgdG9rZW47IGkgPCBhc3QudG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9rZW4gPSBhc3QudG9rZW5zW2ldOwogICAgICAgIGlmICh0b2tlbi5yYW5nZVswXSA8IHN0YXJ0KSBjb250aW51ZTsKICAgICAgICBpZiAodG9rZW4ucmFuZ2VbMV0gPiBlbmQpIHsKICAgICAgICAgIHRva2VuID0gcHJldjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoIWZpcnN0KSBmaXJzdCA9IHRva2VuOwogICAgICAgIHByZXYgPSB0b2tlbjsKICAgICAgfQogICAgICByZXR1cm4gWyBmaXJzdCwgdG9rZW4gXTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGVSYW5nZVRva2Vucyhub2RlKSB7CiAgICAgIHJldHVybiBnZXRSYW5nZVRva2Vucyhub2RlLnJvb3QsIG5vZGUucmFuZ2VbMF0sIG5vZGUucmFuZ2VbMV0pOwogICAgfQogICAgZnVuY3Rpb24gdHJhbnNsYXRlQXN0KGFzdCwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgc291cmNlID0gYXN0LnNvdXJjZTsKICAgICAgdmFyIGJ1ZmZlciA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgcHJlLCBwcmV2LCB0b2tlbjsgaSA8IGFzdC50b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0b2tlbiA9IGFzdC50b2tlbnNbaV07CiAgICAgICAgaWYgKHRva2VuLnJhbmdlWzBdIDwgc3RhcnQpIGNvbnRpbnVlOwogICAgICAgIGlmICh0b2tlbi5yYW5nZVsxXSA+IGVuZCkgewogICAgICAgICAgdG9rZW4gPSBwcmV2OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHByZSA9IHNvdXJjZS5zdWJzdHJpbmcocHJldiA/IHByZXYucmFuZ2VbMV0gOiBzdGFydCwgdG9rZW4ucmFuZ2VbMF0pOwogICAgICAgIGlmIChwcmUpIGJ1ZmZlci5wdXNoKHByZSk7CiAgICAgICAgYnVmZmVyLnB1c2godG9rZW4udmFsdWUpOwogICAgICAgIHByZXYgPSB0b2tlbjsKICAgICAgfQogICAgICBidWZmZXIucHVzaChzb3VyY2Uuc3Vic3RyaW5nKHRva2VuID8gdG9rZW4ucmFuZ2VbMV0gOiBzdGFydCwgZW5kKSk7CiAgICAgIHJldHVybiBidWZmZXIuam9pbigiIik7CiAgICB9CiAgICBmdW5jdGlvbiB0cmFuc2xhdGVOb2RlKG5vZGUpIHsKICAgICAgcmV0dXJuIHRyYW5zbGF0ZUFzdChub2RlLnJvb3QsIG5vZGUucmFuZ2VbMF0sIG5vZGUucmFuZ2VbMV0pOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFRSQVZFUlNFX0FCT1JUOiBUUkFWRVJTRV9BQk9SVCwKICAgICAgVFJBVkVSU0VfU1RPUF9ERUVQOiBUUkFWRVJTRV9TVE9QX0RFRVAsCiAgICAgIHBhcnNlOiBwYXJzZSwKICAgICAgdHJhdmVyc2VBc3Q6IHRyYXZlcnNlQXN0LAogICAgICB0cmFuc2xhdGVBc3Q6IHRyYW5zbGF0ZUFzdCwKICAgICAgdHJhbnNsYXRlTm9kZTogdHJhbnNsYXRlTm9kZSwKICAgICAgZ2V0UmFuZ2VUb2tlbnM6IGdldFJhbmdlVG9rZW5zLAogICAgICBnZXROb2RlUmFuZ2VUb2tlbnM6IGdldE5vZGVSYW5nZVRva2VucwogICAgfTsKICB9LAogICJsLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoWyAiZXhwb3J0cyIgXSwgZmFjdG9yeSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgZmFjdG9yeShleHBvcnRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmYWN0b3J5KHJvb3QuZXNwcmltYSA9IHt9KTsKICAgICAgfQogICAgfSkodGhpcywgZnVuY3Rpb24oZXhwb3J0cykgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBUb2tlbiwgVG9rZW5OYW1lLCBTeW50YXgsIFByb3BlcnR5S2luZCwgTWVzc2FnZXMsIFJlZ2V4LCBzb3VyY2UsIHN0cmljdCwgaW5kZXgsIGxpbmVOdW1iZXIsIGxpbmVTdGFydCwgbGVuZ3RoLCBidWZmZXIsIHN0YXRlLCBleHRyYTsKICAgICAgVG9rZW4gPSB7CiAgICAgICAgQm9vbGVhbkxpdGVyYWw6IDEsCiAgICAgICAgRU9GOiAyLAogICAgICAgIElkZW50aWZpZXI6IDMsCiAgICAgICAgS2V5d29yZDogNCwKICAgICAgICBOdWxsTGl0ZXJhbDogNSwKICAgICAgICBOdW1lcmljTGl0ZXJhbDogNiwKICAgICAgICBQdW5jdHVhdG9yOiA3LAogICAgICAgIFN0cmluZ0xpdGVyYWw6IDgKICAgICAgfTsKICAgICAgVG9rZW5OYW1lID0ge307CiAgICAgIFRva2VuTmFtZVtUb2tlbi5Cb29sZWFuTGl0ZXJhbF0gPSAiQm9vbGVhbiI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5FT0ZdID0gIjxlbmQ+IjsKICAgICAgVG9rZW5OYW1lW1Rva2VuLklkZW50aWZpZXJdID0gIklkZW50aWZpZXIiOwogICAgICBUb2tlbk5hbWVbVG9rZW4uS2V5d29yZF0gPSAiS2V5d29yZCI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5OdWxsTGl0ZXJhbF0gPSAiTnVsbCI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5OdW1lcmljTGl0ZXJhbF0gPSAiTnVtZXJpYyI7CiAgICAgIFRva2VuTmFtZVtUb2tlbi5QdW5jdHVhdG9yXSA9ICJQdW5jdHVhdG9yIjsKICAgICAgVG9rZW5OYW1lW1Rva2VuLlN0cmluZ0xpdGVyYWxdID0gIlN0cmluZyI7CiAgICAgIFN5bnRheCA9IHsKICAgICAgICBBc3NpZ25tZW50RXhwcmVzc2lvbjogIkFzc2lnbm1lbnRFeHByZXNzaW9uIiwKICAgICAgICBBcnJheUV4cHJlc3Npb246ICJBcnJheUV4cHJlc3Npb24iLAogICAgICAgIEJsb2NrU3RhdGVtZW50OiAiQmxvY2tTdGF0ZW1lbnQiLAogICAgICAgIEJpbmFyeUV4cHJlc3Npb246ICJCaW5hcnlFeHByZXNzaW9uIiwKICAgICAgICBCcmVha1N0YXRlbWVudDogIkJyZWFrU3RhdGVtZW50IiwKICAgICAgICBDYWxsRXhwcmVzc2lvbjogIkNhbGxFeHByZXNzaW9uIiwKICAgICAgICBDYXRjaENsYXVzZTogIkNhdGNoQ2xhdXNlIiwKICAgICAgICBDb25kaXRpb25hbEV4cHJlc3Npb246ICJDb25kaXRpb25hbEV4cHJlc3Npb24iLAogICAgICAgIENvbnRpbnVlU3RhdGVtZW50OiAiQ29udGludWVTdGF0ZW1lbnQiLAogICAgICAgIERvV2hpbGVTdGF0ZW1lbnQ6ICJEb1doaWxlU3RhdGVtZW50IiwKICAgICAgICBEZWJ1Z2dlclN0YXRlbWVudDogIkRlYnVnZ2VyU3RhdGVtZW50IiwKICAgICAgICBFbXB0eVN0YXRlbWVudDogIkVtcHR5U3RhdGVtZW50IiwKICAgICAgICBFeHByZXNzaW9uU3RhdGVtZW50OiAiRXhwcmVzc2lvblN0YXRlbWVudCIsCiAgICAgICAgRm9yU3RhdGVtZW50OiAiRm9yU3RhdGVtZW50IiwKICAgICAgICBGb3JJblN0YXRlbWVudDogIkZvckluU3RhdGVtZW50IiwKICAgICAgICBGdW5jdGlvbkRlY2xhcmF0aW9uOiAiRnVuY3Rpb25EZWNsYXJhdGlvbiIsCiAgICAgICAgRnVuY3Rpb25FeHByZXNzaW9uOiAiRnVuY3Rpb25FeHByZXNzaW9uIiwKICAgICAgICBJZGVudGlmaWVyOiAiSWRlbnRpZmllciIsCiAgICAgICAgSWZTdGF0ZW1lbnQ6ICJJZlN0YXRlbWVudCIsCiAgICAgICAgTGl0ZXJhbDogIkxpdGVyYWwiLAogICAgICAgIExhYmVsZWRTdGF0ZW1lbnQ6ICJMYWJlbGVkU3RhdGVtZW50IiwKICAgICAgICBMb2dpY2FsRXhwcmVzc2lvbjogIkxvZ2ljYWxFeHByZXNzaW9uIiwKICAgICAgICBNZW1iZXJFeHByZXNzaW9uOiAiTWVtYmVyRXhwcmVzc2lvbiIsCiAgICAgICAgTmV3RXhwcmVzc2lvbjogIk5ld0V4cHJlc3Npb24iLAogICAgICAgIE9iamVjdEV4cHJlc3Npb246ICJPYmplY3RFeHByZXNzaW9uIiwKICAgICAgICBQcm9ncmFtOiAiUHJvZ3JhbSIsCiAgICAgICAgUHJvcGVydHk6ICJQcm9wZXJ0eSIsCiAgICAgICAgUmV0dXJuU3RhdGVtZW50OiAiUmV0dXJuU3RhdGVtZW50IiwKICAgICAgICBTZXF1ZW5jZUV4cHJlc3Npb246ICJTZXF1ZW5jZUV4cHJlc3Npb24iLAogICAgICAgIFN3aXRjaFN0YXRlbWVudDogIlN3aXRjaFN0YXRlbWVudCIsCiAgICAgICAgU3dpdGNoQ2FzZTogIlN3aXRjaENhc2UiLAogICAgICAgIFRoaXNFeHByZXNzaW9uOiAiVGhpc0V4cHJlc3Npb24iLAogICAgICAgIFRocm93U3RhdGVtZW50OiAiVGhyb3dTdGF0ZW1lbnQiLAogICAgICAgIFRyeVN0YXRlbWVudDogIlRyeVN0YXRlbWVudCIsCiAgICAgICAgVW5hcnlFeHByZXNzaW9uOiAiVW5hcnlFeHByZXNzaW9uIiwKICAgICAgICBVcGRhdGVFeHByZXNzaW9uOiAiVXBkYXRlRXhwcmVzc2lvbiIsCiAgICAgICAgVmFyaWFibGVEZWNsYXJhdGlvbjogIlZhcmlhYmxlRGVjbGFyYXRpb24iLAogICAgICAgIFZhcmlhYmxlRGVjbGFyYXRvcjogIlZhcmlhYmxlRGVjbGFyYXRvciIsCiAgICAgICAgV2hpbGVTdGF0ZW1lbnQ6ICJXaGlsZVN0YXRlbWVudCIsCiAgICAgICAgV2l0aFN0YXRlbWVudDogIldpdGhTdGF0ZW1lbnQiCiAgICAgIH07CiAgICAgIFByb3BlcnR5S2luZCA9IHsKICAgICAgICBEYXRhOiAxLAogICAgICAgIEdldDogMiwKICAgICAgICBTZXQ6IDQKICAgICAgfTsKICAgICAgTWVzc2FnZXMgPSB7CiAgICAgICAgVW5leHBlY3RlZFRva2VuOiAiVW5leHBlY3RlZCB0b2tlbiAlMCIsCiAgICAgICAgVW5leHBlY3RlZE51bWJlcjogIlVuZXhwZWN0ZWQgbnVtYmVyIiwKICAgICAgICBVbmV4cGVjdGVkU3RyaW5nOiAiVW5leHBlY3RlZCBzdHJpbmciLAogICAgICAgIFVuZXhwZWN0ZWRJZGVudGlmaWVyOiAiVW5leHBlY3RlZCBpZGVudGlmaWVyIiwKICAgICAgICBVbmV4cGVjdGVkUmVzZXJ2ZWQ6ICJVbmV4cGVjdGVkIHJlc2VydmVkIHdvcmQiLAogICAgICAgIFVuZXhwZWN0ZWRFT1M6ICJVbmV4cGVjdGVkIGVuZCBvZiBpbnB1dCIsCiAgICAgICAgTmV3bGluZUFmdGVyVGhyb3c6ICJJbGxlZ2FsIG5ld2xpbmUgYWZ0ZXIgdGhyb3ciLAogICAgICAgIEludmFsaWRSZWdFeHA6ICJJbnZhbGlkIHJlZ3VsYXIgZXhwcmVzc2lvbiIsCiAgICAgICAgVW50ZXJtaW5hdGVkUmVnRXhwOiAiSW52YWxpZCByZWd1bGFyIGV4cHJlc3Npb246IG1pc3NpbmcgLyIsCiAgICAgICAgSW52YWxpZExIU0luQXNzaWdubWVudDogIkludmFsaWQgbGVmdC1oYW5kIHNpZGUgaW4gYXNzaWdubWVudCIsCiAgICAgICAgSW52YWxpZExIU0luRm9ySW46ICJJbnZhbGlkIGxlZnQtaGFuZCBzaWRlIGluIGZvci1pbiIsCiAgICAgICAgTXVsdGlwbGVEZWZhdWx0c0luU3dpdGNoOiAiTW9yZSB0aGFuIG9uZSBkZWZhdWx0IGNsYXVzZSBpbiBzd2l0Y2ggc3RhdGVtZW50IiwKICAgICAgICBOb0NhdGNoT3JGaW5hbGx5OiAiTWlzc2luZyBjYXRjaCBvciBmaW5hbGx5IGFmdGVyIHRyeSIsCiAgICAgICAgVW5rbm93bkxhYmVsOiAiVW5kZWZpbmVkIGxhYmVsICclMCciLAogICAgICAgIFJlZGVjbGFyYXRpb246ICIlMCAnJTEnIGhhcyBhbHJlYWR5IGJlZW4gZGVjbGFyZWQiLAogICAgICAgIElsbGVnYWxDb250aW51ZTogIklsbGVnYWwgY29udGludWUgc3RhdGVtZW50IiwKICAgICAgICBJbGxlZ2FsQnJlYWs6ICJJbGxlZ2FsIGJyZWFrIHN0YXRlbWVudCIsCiAgICAgICAgSWxsZWdhbFJldHVybjogIklsbGVnYWwgcmV0dXJuIHN0YXRlbWVudCIsCiAgICAgICAgU3RyaWN0TW9kZVdpdGg6ICJTdHJpY3QgbW9kZSBjb2RlIG1heSBub3QgaW5jbHVkZSBhIHdpdGggc3RhdGVtZW50IiwKICAgICAgICBTdHJpY3RDYXRjaFZhcmlhYmxlOiAiQ2F0Y2ggdmFyaWFibGUgbWF5IG5vdCBiZSBldmFsIG9yIGFyZ3VtZW50cyBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0VmFyTmFtZTogIlZhcmlhYmxlIG5hbWUgbWF5IG5vdCBiZSBldmFsIG9yIGFyZ3VtZW50cyBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0UGFyYW1OYW1lOiAiUGFyYW1ldGVyIG5hbWUgZXZhbCBvciBhcmd1bWVudHMgaXMgbm90IGFsbG93ZWQgaW4gc3RyaWN0IG1vZGUiLAogICAgICAgIFN0cmljdFBhcmFtRHVwZTogIlN0cmljdCBtb2RlIGZ1bmN0aW9uIG1heSBub3QgaGF2ZSBkdXBsaWNhdGUgcGFyYW1ldGVyIG5hbWVzIiwKICAgICAgICBTdHJpY3RGdW5jdGlvbk5hbWU6ICJGdW5jdGlvbiBuYW1lIG1heSBub3QgYmUgZXZhbCBvciBhcmd1bWVudHMgaW4gc3RyaWN0IG1vZGUiLAogICAgICAgIFN0cmljdE9jdGFsTGl0ZXJhbDogIk9jdGFsIGxpdGVyYWxzIGFyZSBub3QgYWxsb3dlZCBpbiBzdHJpY3QgbW9kZS4iLAogICAgICAgIFN0cmljdERlbGV0ZTogIkRlbGV0ZSBvZiBhbiB1bnF1YWxpZmllZCBpZGVudGlmaWVyIGluIHN0cmljdCBtb2RlLiIsCiAgICAgICAgU3RyaWN0RHVwbGljYXRlUHJvcGVydHk6ICJEdXBsaWNhdGUgZGF0YSBwcm9wZXJ0eSBpbiBvYmplY3QgbGl0ZXJhbCBub3QgYWxsb3dlZCBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgQWNjZXNzb3JEYXRhUHJvcGVydHk6ICJPYmplY3QgbGl0ZXJhbCBtYXkgbm90IGhhdmUgZGF0YSBhbmQgYWNjZXNzb3IgcHJvcGVydHkgd2l0aCB0aGUgc2FtZSBuYW1lIiwKICAgICAgICBBY2Nlc3NvckdldFNldDogIk9iamVjdCBsaXRlcmFsIG1heSBub3QgaGF2ZSBtdWx0aXBsZSBnZXQvc2V0IGFjY2Vzc29ycyB3aXRoIHRoZSBzYW1lIG5hbWUiLAogICAgICAgIFN0cmljdExIU0Fzc2lnbm1lbnQ6ICJBc3NpZ25tZW50IHRvIGV2YWwgb3IgYXJndW1lbnRzIGlzIG5vdCBhbGxvd2VkIGluIHN0cmljdCBtb2RlIiwKICAgICAgICBTdHJpY3RMSFNQb3N0Zml4OiAiUG9zdGZpeCBpbmNyZW1lbnQvZGVjcmVtZW50IG1heSBub3QgaGF2ZSBldmFsIG9yIGFyZ3VtZW50cyBvcGVyYW5kIGluIHN0cmljdCBtb2RlIiwKICAgICAgICBTdHJpY3RMSFNQcmVmaXg6ICJQcmVmaXggaW5jcmVtZW50L2RlY3JlbWVudCBtYXkgbm90IGhhdmUgZXZhbCBvciBhcmd1bWVudHMgb3BlcmFuZCBpbiBzdHJpY3QgbW9kZSIsCiAgICAgICAgU3RyaWN0UmVzZXJ2ZWRXb3JkOiAiVXNlIG9mIGZ1dHVyZSByZXNlcnZlZCB3b3JkIGluIHN0cmljdCBtb2RlIgogICAgICB9OwogICAgICBSZWdleCA9IHsKICAgICAgICBOb25Bc2NpaUlkZW50aWZpZXJTdGFydDogbmV3IFJlZ0V4cCgiW8KqwrXCusOALcOWw5gtw7bDuC3LgcuGLcuRy6Aty6TLrMuuzbAtzbTNts23zbotzb3Ohs6ILc6KzozOji3Ooc6jLc+1z7ct0oHSii3Up9SxLdWW1ZnVoS3Wh9eQLdeq17At17LYoC3Zitmu2a/ZsS3bk9uV26Xbptuu26/bui3bvNu/3JDcki3cr92NLd6l3rHfii3fqt+037XfuuCggC3goJXgoJrgoKTgoKjgoYAt4KGY4KKg4KKiLeCirOCkhC3gpLngpL3gpZDgpZgt4KWh4KWxLeClt+CluS3gpb/gpoUt4KaM4KaP4KaQ4KaTLeCmqOCmqi3gprDgprLgprYt4Ka54Ka94KeO4Kec4Ked4KefLeCnoeCnsOCnseCohS3gqIrgqI/gqJDgqJMt4Kio4KiqLeCosOCosuCos+CoteCotuCouOCoueCpmS3gqZzgqZ7gqbIt4Km04KqFLeCqjeCqjy3gqpHgqpMt4Kqo4KqqLeCqsOCqsuCqs+CqtS3gqrngqr3gq5Dgq6Dgq6HgrIUt4KyM4KyP4KyQ4KyTLeCsqOCsqi3grLDgrLLgrLPgrLUt4Ky54Ky94K2c4K2d4K2fLeCtoeCtseCug+CuhS3grorgro4t4K6Q4K6SLeCuleCumeCumuCunOCunuCun+Cuo+CupOCuqC3grqrgrq4t4K654K+Q4LCFLeCwjOCwji3gsJDgsJIt4LCo4LCqLeCws+CwtS3gsLngsL3gsZjgsZngsaDgsaHgsoUt4LKM4LKOLeCykOCyki3gsqjgsqot4LKz4LK1LeCyueCyveCznuCzoOCzoeCzseCzsuC0hS3gtIzgtI4t4LSQ4LSSLeC0uuC0veC1juC1oOC1oeC1ui3gtb/gtoUt4LaW4LaaLeC2seC2sy3gtrvgtr3gt4At4LeG4LiBLeC4sOC4suC4s+C5gC3guYbguoHguoLguoTguofguojguorguo3gupQt4LqX4LqZLeC6n+C6oS3guqPguqXguqfguqrguqvguq0t4Lqw4Lqy4Lqz4Lq94LuALeC7hOC7huC7nC3gu5/gvIDgvYAt4L2H4L2JLeC9rOC+iC3gvozhgIAt4YCq4YC/4YGQLeGBleGBmi3hgZ3hgaHhgaXhgabhga4t4YGw4YG1LeGCgeGCjuGCoC3hg4Xhg4fhg43hg5At4YO64YO8LeGJiOGJii3hiY3hiZAt4YmW4YmY4YmaLeGJneGJoC3hiojhioot4YqN4YqQLeGKsOGKsi3hirXhirgt4Yq+4YuA4YuCLeGLheGLiC3hi5bhi5gt4YyQ4YySLeGMleGMmC3hjZrhjoAt4Y6P4Y6gLeGPtOGQgS3hmazhma8t4Zm/4ZqBLeGamuGaoC3hm6rhm64t4Zuw4ZyALeGcjOGcji3hnJHhnKAt4Zyx4Z2ALeGdkeGdoC3hnazhna4t4Z2w4Z6ALeGes+Gfl+GfnOGgoC3hobfhooAt4aKo4aKq4aKwLeGjteGkgC3hpJzhpZAt4aWt4aWwLeGltOGmgC3hpqvhp4Et4aeH4aiALeGoluGooC3hqZThqqfhrIUt4ayz4a2FLeGti+Gugy3hrqDhrq7hrq/hrrot4a+l4bCALeGwo+GxjS3hsY/hsZot4bG94bOpLeGzrOGzri3hs7Hhs7Xhs7bhtIAt4ba/4biALeG8leG8mC3hvJ3hvKAt4b2F4b2ILeG9jeG9kC3hvZfhvZnhvZvhvZ3hvZ8t4b294b6ALeG+tOG+ti3hvrzhvr7hv4It4b+E4b+GLeG/jOG/kC3hv5Phv5Yt4b+b4b+gLeG/rOG/si3hv7Thv7Yt4b+84oGx4oG/4oKQLeKCnOKEguKEh+KEii3ihJPihJXihJkt4oSd4oSk4oSm4oSo4oSqLeKEreKEry3ihLnihLwt4oS/4oWFLeKFieKFjuKFoC3ihojisIAt4rCu4rCwLeKxnuKxoC3is6Tis6st4rOu4rOy4rOz4rSALeK0peK0p+K0reK0sC3itafita/itoAt4raW4ragLeK2puK2qC3itq7itrAt4ra24ra4LeK2vuK3gC3it4bit4gt4reO4reQLeK3luK3mC3it57iuK/jgIUt44CH44ChLeOAqeOAsS3jgLXjgLgt44C844GBLeOCluOCnS3jgp/jgqEt44O644O8LeODv+OEhS3jhK3jhLEt44aO44agLeOGuuOHsC3jh7/jkIAt5La15LiALem/jOqAgC3qkozqk5At6pO96pSALeqYjOqYkC3qmJ/qmKrqmKvqmYAt6pmu6pm/Leqal+qaoC3qm6/qnJct6pyf6pyiLeqeiOqeiy3qno7qnpAt6p6T6p6gLeqequqfuC3qoIHqoIMt6qCF6qCHLeqgiuqgjC3qoKLqoYAt6qGz6qKCLeqis+qjsi3qo7fqo7vqpIot6qSl6qSwLeqlhuqloC3qpbzqpoQt6qay6qeP6qiALeqoqOqpgC3qqYLqqYQt6qmL6qmgLeqptuqpuuqqgC3qqq/qqrHqqrXqqrbqqrkt6qq96quA6quC6qubLeqrneqroC3qq6rqq7It6qu06qyBLeqshuqsiS3qrI7qrJEt6qyW6qygLeqspuqsqC3qrK7qr4At6q+i6rCALe2eo+2esC3tn4btn4st7Z+776SALe+pre+psC3vq5nvrIAt76yG76yTLe+sl++sne+sny3vrKjvrKot76y276y4Le+svO+svu+tgO+tge+tg++thO+thi3vrrHvr5Mt77S977WQLe+2j++2ki3vt4fvt7At77e777mwLe+5tO+5ti3vu7zvvKEt77y6772BLe+9mu+9pi3vvr7vv4It77+H77+KLe+/j++/ki3vv5fvv5ot77+cXSIpLAogICAgICAgIE5vbkFzY2lpSWRlbnRpZmllclBhcnQ6IG5ldyBSZWdFeHAoIlvCqsK1wrrDgC3DlsOYLcO2w7gty4HLhi3LkcugLcuky6zLrsyALc20zbbNt826Lc29zobOiC3Ois6Mzo4tzqHOoy3Ptc+3LdKB0oMt0ofSii3Up9SxLdWW1ZnVoS3Wh9aRLda91r/XgdeC14TXhdeH15At16rXsC3XstiQLdia2KAt2anZri3bk9uVLduc258t26jbqi3bvNu/3JAt3YrdjS3esd+ALd+137rgoIAt4KCt4KGALeChm+CioOCioi3goqzgo6Qt4KO+4KSALeClo+Clpi3gpa/gpbEt4KW34KW5LeClv+CmgS3gpoPgpoUt4KaM4KaP4KaQ4KaTLeCmqOCmqi3gprDgprLgprYt4Ka54Ka8LeCnhOCnh+CniOCniy3gp47gp5fgp5zgp53gp58t4Kej4KemLeCnseCogS3gqIPgqIUt4KiK4KiP4KiQ4KiTLeCoqOCoqi3gqLDgqLLgqLPgqLXgqLbgqLjgqLngqLzgqL4t4KmC4KmH4KmI4KmLLeCpjeCpkeCpmS3gqZzgqZ7gqaYt4Km14KqBLeCqg+CqhS3gqo3gqo8t4KqR4KqTLeCqqOCqqi3gqrDgqrLgqrPgqrUt4Kq54Kq8LeCrheCrhy3gq4ngq4st4KuN4KuQ4KugLeCro+Crpi3gq6/grIEt4KyD4KyFLeCsjOCsj+CskOCsky3grKjgrKot4Kyw4Kyy4Kyz4Ky1LeCsueCsvC3grYTgrYfgrYjgrYst4K2N4K2W4K2X4K2c4K2d4K2fLeCto+Ctpi3gra/grbHgroLgroPgroUt4K6K4K6OLeCukOCuki3grpXgrpngrprgrpzgrp7grp/grqPgrqTgrqgt4K6q4K6uLeCuueCuvi3gr4Lgr4Yt4K+I4K+KLeCvjeCvkOCvl+Cvpi3gr6/gsIEt4LCD4LCFLeCwjOCwji3gsJDgsJIt4LCo4LCqLeCws+CwtS3gsLngsL0t4LGE4LGGLeCxiOCxii3gsY3gsZXgsZbgsZjgsZngsaAt4LGj4LGmLeCxr+CyguCyg+CyhS3gsozgso4t4LKQ4LKSLeCyqOCyqi3gsrPgsrUt4LK54LK8LeCzhOCzhi3gs4jgs4ot4LON4LOV4LOW4LOe4LOgLeCzo+Czpi3gs6/gs7Hgs7LgtILgtIPgtIUt4LSM4LSOLeC0kOC0ki3gtLrgtL0t4LWE4LWGLeC1iOC1ii3gtY7gtZfgtaAt4LWj4LWmLeC1r+C1ui3gtb/gtoLgtoPgtoUt4LaW4LaaLeC2seC2sy3gtrvgtr3gt4At4LeG4LeK4LePLeC3lOC3luC3mC3gt5/gt7Lgt7PguIEt4Li64LmALeC5juC5kC3guZnguoHguoLguoTguofguojguorguo3gupQt4LqX4LqZLeC6n+C6oS3guqPguqXguqfguqrguqvguq0t4Lq54Lq7LeC6veC7gC3gu4Tgu4bgu4gt4LuN4LuQLeC7meC7nC3gu5/gvIDgvJjgvJngvKAt4Lyp4Ly14Ly34Ly54Ly+LeC9h+C9iS3gvazgvbEt4L6E4L6GLeC+l+C+mS3gvrzgv4bhgIAt4YGJ4YGQLeGCneGCoC3hg4Xhg4fhg43hg5At4YO64YO8LeGJiOGJii3hiY3hiZAt4YmW4YmY4YmaLeGJneGJoC3hiojhioot4YqN4YqQLeGKsOGKsi3hirXhirgt4Yq+4YuA4YuCLeGLheGLiC3hi5bhi5gt4YyQ4YySLeGMleGMmC3hjZrhjZ0t4Y2f4Y6ALeGOj+GOoC3hj7ThkIEt4Zms4ZmvLeGZv+GagS3hmprhmqAt4Zuq4ZuuLeGbsOGcgC3hnIzhnI4t4ZyU4ZygLeGctOGdgC3hnZPhnaAt4Z2s4Z2uLeGdsOGdsuGds+GegC3hn5Phn5fhn5zhn53hn6At4Z+p4aCLLeGgjeGgkC3hoJnhoKAt4aG34aKALeGiquGisC3ho7XhpIAt4aSc4aSgLeGkq+GksC3hpLvhpYYt4aWt4aWwLeGltOGmgC3hpqvhprAt4aeJ4aeQLeGnmeGogC3hqJvhqKAt4ame4amgLeGpvOGpvy3hqonhqpAt4aqZ4aqn4ayALeGti+GtkC3hrZnhrast4a2z4a6ALeGvs+GwgC3hsLfhsYAt4bGJ4bGNLeGxveGzkC3hs5Lhs5Qt4bO24bSALeG3puG3vC3hvJXhvJgt4byd4bygLeG9heG9iC3hvY3hvZAt4b2X4b2Z4b2b4b2d4b2fLeG9veG+gC3hvrThvrYt4b684b6+4b+CLeG/hOG/hi3hv4zhv5At4b+T4b+WLeG/m+G/oC3hv6zhv7It4b+04b+2LeG/vOKAjOKAjeKAv+KBgOKBlOKBseKBv+KCkC3igpzig5At4oOc4oOh4oOlLeKDsOKEguKEh+KEii3ihJPihJXihJkt4oSd4oSk4oSm4oSo4oSqLeKEreKEry3ihLnihLwt4oS/4oWFLeKFieKFjuKFoC3ihojisIAt4rCu4rCwLeKxnuKxoC3is6Tis6st4rOz4rSALeK0peK0p+K0reK0sC3itafita/itb8t4raW4ragLeK2puK2qC3itq7itrAt4ra24ra4LeK2vuK3gC3it4bit4gt4reO4reQLeK3luK3mC3it57it6At4re/4riv44CFLeOAh+OAoS3jgK/jgLEt44C144C4LeOAvOOBgS3jgpbjgpnjgprjgp0t44Kf44KhLeODuuODvC3jg7/jhIUt44St44SxLeOGjuOGoC3jhrrjh7At44e/45CALeS2teS4gC3pv4zqgIAt6pKM6pOQLeqTveqUgC3qmIzqmJAt6pir6pmALeqZr+qZtC3qmb3qmb8t6pqX6pqfLeqbseqcly3qnJ/qnKIt6p6I6p6LLeqejuqekC3qnpPqnqAt6p6q6p+4Leqgp+qhgC3qobPqooAt6qOE6qOQLeqjmeqjoC3qo7fqo7vqpIAt6qSt6qSwLeqlk+qloC3qpbzqpoAt6qeA6qePLeqnmeqogC3qqLbqqYAt6qmN6qmQLeqpmeqpoC3qqbbqqbrqqbvqqoAt6quC6qubLeqrneqroC3qq6/qq7It6qu26qyBLeqshuqsiS3qrI7qrJEt6qyW6qygLeqspuqsqC3qrK7qr4At6q+q6q+s6q+t6q+wLeqvueqwgC3tnqPtnrAt7Z+G7Z+LLe2fu++kgC3vqa3vqbAt76uZ76yALe+shu+sky3vrJfvrJ0t76yo76yqLe+stu+suC3vrLzvrL7vrYDvrYHvrYPvrYTvrYYt766x76+TLe+0ve+1kC3vto/vtpIt77eH77ewLe+3u++4gC3vuI/vuKAt77im77iz77i077mNLe+5j++5sC3vubTvubYt77u877yQLe+8me+8oS3vvLrvvL/vvYEt772a772mLe++vu+/gi3vv4fvv4ot77+P77+SLe+/l++/mi3vv5xdIikKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbWVzc2FnZSkgewogICAgICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFTU0VSVDogIiArIG1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzbGljZVNvdXJjZShmcm9tLCB0bykgewogICAgICAgIHJldHVybiBzb3VyY2Uuc2xpY2UoZnJvbSwgdG8pOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgImVzcHJpbWEiWzBdID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHNsaWNlU291cmNlID0gZnVuY3Rpb24gc2xpY2VBcnJheVNvdXJjZShmcm9tLCB0bykgewogICAgICAgICAgcmV0dXJuIHNvdXJjZS5zbGljZShmcm9tLCB0bykuam9pbigiIik7CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0RlY2ltYWxEaWdpdChjaCkgewogICAgICAgIHJldHVybiAiMDEyMzQ1Njc4OSIuaW5kZXhPZihjaCkgPj0gMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0hleERpZ2l0KGNoKSB7CiAgICAgICAgcmV0dXJuICIwMTIzNDU2Nzg5YWJjZGVmQUJDREVGIi5pbmRleE9mKGNoKSA+PSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzT2N0YWxEaWdpdChjaCkgewogICAgICAgIHJldHVybiAiMDEyMzQ1NjciLmluZGV4T2YoY2gpID49IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNXaGl0ZVNwYWNlKGNoKSB7CiAgICAgICAgcmV0dXJuIGNoID09PSAiICIgfHwgY2ggPT09ICIJIiB8fCBjaCA9PT0gIgsiIHx8IGNoID09PSAiXGYiIHx8IGNoID09PSAiwqAiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gNTc2MCAmJiAi4ZqA4aCO4oCA4oCB4oCC4oCD4oCE4oCF4oCG4oCH4oCI4oCJ4oCK4oCv4oGf44CA77u/Ii5pbmRleE9mKGNoKSA+PSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzTGluZVRlcm1pbmF0b3IoY2gpIHsKICAgICAgICByZXR1cm4gY2ggPT09ICJcbiIgfHwgY2ggPT09ICJcciIgfHwgY2ggPT09ICJcdTIwMjgiIHx8IGNoID09PSAiXHUyMDI5IjsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0lkZW50aWZpZXJTdGFydChjaCkgewogICAgICAgIHJldHVybiBjaCA9PT0gIiQiIHx8IGNoID09PSAiXyIgfHwgY2ggPT09ICJcXCIgfHwgY2ggPj0gImEiICYmIGNoIDw9ICJ6IiB8fCBjaCA+PSAiQSIgJiYgY2ggPD0gIloiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gMTI4ICYmIFJlZ2V4Lk5vbkFzY2lpSWRlbnRpZmllclN0YXJ0LnRlc3QoY2gpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzSWRlbnRpZmllclBhcnQoY2gpIHsKICAgICAgICByZXR1cm4gY2ggPT09ICIkIiB8fCBjaCA9PT0gIl8iIHx8IGNoID09PSAiXFwiIHx8IGNoID49ICJhIiAmJiBjaCA8PSAieiIgfHwgY2ggPj0gIkEiICYmIGNoIDw9ICJaIiB8fCBjaCA+PSAiMCIgJiYgY2ggPD0gIjkiIHx8IGNoLmNoYXJDb2RlQXQoMCkgPj0gMTI4ICYmIFJlZ2V4Lk5vbkFzY2lpSWRlbnRpZmllclBhcnQudGVzdChjaCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNGdXR1cmVSZXNlcnZlZFdvcmQoaWQpIHsKICAgICAgICBzd2l0Y2ggKGlkKSB7CiAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICBjYXNlICJlbnVtIjoKICAgICAgICAgIGNhc2UgImV4cG9ydCI6CiAgICAgICAgICBjYXNlICJleHRlbmRzIjoKICAgICAgICAgIGNhc2UgImltcG9ydCI6CiAgICAgICAgICBjYXNlICJzdXBlciI6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNTdHJpY3RNb2RlUmVzZXJ2ZWRXb3JkKGlkKSB7CiAgICAgICAgc3dpdGNoIChpZCkgewogICAgICAgICAgY2FzZSAiaW1wbGVtZW50cyI6CiAgICAgICAgICBjYXNlICJpbnRlcmZhY2UiOgogICAgICAgICAgY2FzZSAicGFja2FnZSI6CiAgICAgICAgICBjYXNlICJwcml2YXRlIjoKICAgICAgICAgIGNhc2UgInByb3RlY3RlZCI6CiAgICAgICAgICBjYXNlICJwdWJsaWMiOgogICAgICAgICAgY2FzZSAic3RhdGljIjoKICAgICAgICAgIGNhc2UgInlpZWxkIjoKICAgICAgICAgIGNhc2UgImxldCI6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNSZXN0cmljdGVkV29yZChpZCkgewogICAgICAgIHJldHVybiBpZCA9PT0gImV2YWwiIHx8IGlkID09PSAiYXJndW1lbnRzIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0tleXdvcmQoaWQpIHsKICAgICAgICB2YXIga2V5d29yZCA9IGZhbHNlOwogICAgICAgIHN3aXRjaCAoaWQubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gImlmIiB8fCBpZCA9PT0gImluIiB8fCBpZCA9PT0gImRvIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gInZhciIgfHwgaWQgPT09ICJmb3IiIHx8IGlkID09PSAibmV3IiB8fCBpZCA9PT0gInRyeSI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBrZXl3b3JkID0gaWQgPT09ICJ0aGlzIiB8fCBpZCA9PT0gImVsc2UiIHx8IGlkID09PSAiY2FzZSIgfHwgaWQgPT09ICJ2b2lkIiB8fCBpZCA9PT0gIndpdGgiOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAid2hpbGUiIHx8IGlkID09PSAiYnJlYWsiIHx8IGlkID09PSAiY2F0Y2giIHx8IGlkID09PSAidGhyb3ciOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAicmV0dXJuIiB8fCBpZCA9PT0gInR5cGVvZiIgfHwgaWQgPT09ICJkZWxldGUiIHx8IGlkID09PSAic3dpdGNoIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGtleXdvcmQgPSBpZCA9PT0gImRlZmF1bHQiIHx8IGlkID09PSAiZmluYWxseSI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBrZXl3b3JkID0gaWQgPT09ICJmdW5jdGlvbiIgfHwgaWQgPT09ICJjb250aW51ZSIgfHwgaWQgPT09ICJkZWJ1Z2dlciI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAga2V5d29yZCA9IGlkID09PSAiaW5zdGFuY2VvZiI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5d29yZCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoaWQpIHsKICAgICAgICAgIGNhc2UgImNvbnN0IjoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICBjYXNlICJ5aWVsZCI6CiAgICAgICAgICBjYXNlICJsZXQiOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmljdCAmJiBpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQoaWQpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzRnV0dXJlUmVzZXJ2ZWRXb3JkKGlkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBza2lwQ29tbWVudCgpIHsKICAgICAgICB2YXIgY2gsIGJsb2NrQ29tbWVudCwgbGluZUNvbW1lbnQ7CiAgICAgICAgYmxvY2tDb21tZW50ID0gZmFsc2U7CiAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChsaW5lQ29tbWVudCkgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgaWYgKGlzTGluZVRlcm1pbmF0b3IoY2gpKSB7CiAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4XSA9PT0gIlxuIikgewogICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGJsb2NrQ29tbWVudCkgewogICAgICAgICAgICBpZiAoaXNMaW5lVGVybWluYXRvcihjaCkpIHsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4ICsgMV0gPT09ICJcbiIpIHsKICAgICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICsrbGluZU51bWJlcjsKICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY2ggPT09ICIqIikgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICAgICAgYmxvY2tDb21tZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXggKyAxXTsKICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIioiKSB7CiAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICBibG9ja0NvbW1lbnQgPSB0cnVlOwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZVNwYWNlKGNoKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBpZiAoY2ggPT09ICJcciIgJiYgc291cmNlW2luZGV4XSA9PT0gIlxuIikgewogICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzY2FuSGV4RXNjYXBlKHByZWZpeCkgewogICAgICAgIHZhciBpLCBsZW4sIGNoLCBjb2RlID0gMDsKICAgICAgICBsZW4gPSBwcmVmaXggPT09ICJ1IiA/IDQgOiAyOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgaWYgKGluZGV4IDwgbGVuZ3RoICYmIGlzSGV4RGlnaXQoc291cmNlW2luZGV4XSkpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGNvZGUgPSBjb2RlICogMTYgKyAiMDEyMzQ1Njc4OWFiY2RlZiIuaW5kZXhPZihjaC50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhbklkZW50aWZpZXIoKSB7CiAgICAgICAgdmFyIGNoLCBzdGFydCwgaWQsIHJlc3RvcmU7CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGlmICghaXNJZGVudGlmaWVyU3RhcnQoY2gpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgaWYgKGNoID09PSAiXFwiKSB7CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gIT09ICJ1IikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgcmVzdG9yZSA9IGluZGV4OwogICAgICAgICAgY2ggPSBzY2FuSGV4RXNjYXBlKCJ1Iik7CiAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgaWYgKGNoID09PSAiXFwiIHx8ICFpc0lkZW50aWZpZXJTdGFydChjaCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgPSBjaDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgaWQgPSAidSI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gc291cmNlW2luZGV4KytdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmICghaXNJZGVudGlmaWVyUGFydChjaCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2ggPT09ICJcXCIpIHsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gIT09ICJ1IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICByZXN0b3JlID0gaW5kZXg7CiAgICAgICAgICAgIGNoID0gc2NhbkhleEVzY2FwZSgidSIpOwogICAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICJcXCIgfHwgIWlzSWRlbnRpZmllclBhcnQoY2gpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkICs9IGNoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgICBpZCArPSAidSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlkICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlkLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uSWRlbnRpZmllciwKICAgICAgICAgICAgdmFsdWU6IGlkLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChpc0tleXdvcmQoaWQpKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5LZXl3b3JkLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGlkID09PSAibnVsbCIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLk51bGxMaXRlcmFsLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGlkID09PSAidHJ1ZSIgfHwgaWQgPT09ICJmYWxzZSIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLkJvb2xlYW5MaXRlcmFsLAogICAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFRva2VuLklkZW50aWZpZXIsCiAgICAgICAgICB2YWx1ZTogaWQsCiAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhblB1bmN0dWF0b3IoKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gaW5kZXgsIGNoMSA9IHNvdXJjZVtpbmRleF0sIGNoMiwgY2gzLCBjaDQ7CiAgICAgICAgaWYgKGNoMSA9PT0gIjsiIHx8IGNoMSA9PT0gInsiIHx8IGNoMSA9PT0gIn0iKSB7CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6IGNoMSwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiLCIgfHwgY2gxID09PSAiKCIgfHwgY2gxID09PSAiKSIpIHsKICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogY2gxLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGNoMiA9IHNvdXJjZVtpbmRleCArIDFdOwogICAgICAgIGlmIChjaDEgPT09ICIuIiAmJiAhaXNEZWNpbWFsRGlnaXQoY2gyKSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6IHNvdXJjZVtpbmRleCsrXSwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjaDMgPSBzb3VyY2VbaW5kZXggKyAyXTsKICAgICAgICBjaDQgPSBzb3VyY2VbaW5kZXggKyAzXTsKICAgICAgICBpZiAoY2gxID09PSAiPiIgJiYgY2gyID09PSAiPiIgJiYgY2gzID09PSAiPiIpIHsKICAgICAgICAgIGlmIChjaDQgPT09ICI9IikgewogICAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgICAgdmFsdWU6ICI+Pj49IiwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaDEgPT09ICI9IiAmJiBjaDIgPT09ICI9IiAmJiBjaDMgPT09ICI9IikgewogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgIHZhbHVlOiAiPT09IiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiISIgJiYgY2gyID09PSAiPSIgJiYgY2gzID09PSAiPSIpIHsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogIiE9PSIsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoMSA9PT0gIj4iICYmIGNoMiA9PT0gIj4iICYmIGNoMyA9PT0gIj4iKSB7CiAgICAgICAgICBpbmRleCArPSAzOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogVG9rZW4uUHVuY3R1YXRvciwKICAgICAgICAgICAgdmFsdWU6ICI+Pj4iLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChjaDEgPT09ICI8IiAmJiBjaDIgPT09ICI8IiAmJiBjaDMgPT09ICI9IikgewogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgIHZhbHVlOiAiPDw9IiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSAiPiIgJiYgY2gyID09PSAiPiIgJiYgY2gzID09PSAiPSIpIHsKICAgICAgICAgIGluZGV4ICs9IDM7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogIj4+PSIsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoMiA9PT0gIj0iKSB7CiAgICAgICAgICBpZiAoIjw+PSErLSolJnxeLyIuaW5kZXhPZihjaDEpID49IDApIHsKICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICAgIHZhbHVlOiBjaDEgKyBjaDIsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY2gxID09PSBjaDIgJiYgIistPD4mfCIuaW5kZXhPZihjaDEpID49IDApIHsKICAgICAgICAgIGlmICgiKy08PiZ8Ii5pbmRleE9mKGNoMikgPj0gMCkgewogICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFRva2VuLlB1bmN0dWF0b3IsCiAgICAgICAgICAgICAgdmFsdWU6IGNoMSArIGNoMiwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgiW108PistKiUmfF4hfj86PS8iLmluZGV4T2YoY2gxKSA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBUb2tlbi5QdW5jdHVhdG9yLAogICAgICAgICAgICB2YWx1ZTogc291cmNlW2luZGV4KytdLAogICAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNjYW5OdW1lcmljTGl0ZXJhbCgpIHsKICAgICAgICB2YXIgbnVtYmVyLCBzdGFydCwgY2g7CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGFzc2VydChpc0RlY2ltYWxEaWdpdChjaCkgfHwgY2ggPT09ICIuIiwgIk51bWVyaWMgbGl0ZXJhbCBtdXN0IHN0YXJ0IHdpdGggYSBkZWNpbWFsIGRpZ2l0IG9yIGEgZGVjaW1hbCBwb2ludCIpOwogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgbnVtYmVyID0gIiI7CiAgICAgICAgaWYgKGNoICE9PSAiLiIpIHsKICAgICAgICAgIG51bWJlciA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChudW1iZXIgPT09ICIwIikgewogICAgICAgICAgICBpZiAoY2ggPT09ICJ4IiB8fCBjaCA9PT0gIlgiKSB7CiAgICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICghaXNIZXhEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBudW1iZXIgKz0gc291cmNlW2luZGV4KytdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobnVtYmVyLmxlbmd0aCA8PSAyKSB7CiAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGlzSWRlbnRpZmllclN0YXJ0KGNoKSkgewogICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiBUb2tlbi5OdW1lcmljTGl0ZXJhbCwKICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJzZUludChudW1iZXIsIDE2KSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgICAgICBsaW5lU3RhcnQ6IGxpbmVTdGFydCwKICAgICAgICAgICAgICAgIHJhbmdlOiBbIHN0YXJ0LCBpbmRleCBdCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc09jdGFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICghaXNPY3RhbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGlzSWRlbnRpZmllclN0YXJ0KGNoKSB8fCBpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogVG9rZW4uTnVtZXJpY0xpdGVyYWwsCiAgICAgICAgICAgICAgICB2YWx1ZTogcGFyc2VJbnQobnVtYmVyLCA4KSwKICAgICAgICAgICAgICAgIG9jdGFsOiB0cnVlLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICAgIGlmICghaXNEZWNpbWFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyICs9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGNoID09PSAiLiIpIHsKICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICBpZiAoIWlzRGVjaW1hbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaCA9PT0gImUiIHx8IGNoID09PSAiRSIpIHsKICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAoY2ggPT09ICIrIiB8fCBjaCA9PT0gIi0iKSB7CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAoaXNEZWNpbWFsRGlnaXQoY2gpKSB7CiAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgICBpZiAoIWlzRGVjaW1hbERpZ2l0KGNoKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlciArPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoID0gImNoYXJhY3RlciAiICsgY2g7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICBjaCA9ICI8ZW5kPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmIChpc0lkZW50aWZpZXJTdGFydChjaCkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogVG9rZW4uTnVtZXJpY0xpdGVyYWwsCiAgICAgICAgICB2YWx1ZTogcGFyc2VGbG9hdChudW1iZXIpLAogICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgIGxpbmVTdGFydDogbGluZVN0YXJ0LAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNjYW5TdHJpbmdMaXRlcmFsKCkgewogICAgICAgIHZhciBzdHIgPSAiIiwgcXVvdGUsIHN0YXJ0LCBjaCwgY29kZSwgdW5lc2NhcGVkLCByZXN0b3JlLCBvY3RhbCA9IGZhbHNlOwogICAgICAgIHF1b3RlID0gc291cmNlW2luZGV4XTsKICAgICAgICBhc3NlcnQocXVvdGUgPT09ICInIiB8fCBxdW90ZSA9PT0gJyInLCAiU3RyaW5nIGxpdGVyYWwgbXVzdCBzdGFydHMgd2l0aCBhIHF1b3RlIik7CiAgICAgICAgc3RhcnQgPSBpbmRleDsKICAgICAgICArK2luZGV4OwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBpZiAoY2ggPT09IHF1b3RlKSB7CiAgICAgICAgICAgIHF1b3RlID0gIiI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIlxcIikgewogICAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleCsrXTsKICAgICAgICAgICAgaWYgKCFpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoY2gpIHsKICAgICAgICAgICAgICAgIGNhc2UgIm4iOgogICAgICAgICAgICAgICAgICBzdHIgKz0gIlxuIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyIjoKICAgICAgICAgICAgICAgICAgc3RyICs9ICJcciI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidCI6CiAgICAgICAgICAgICAgICAgIHN0ciArPSAiCSI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidSI6CiAgICAgICAgICAgICAgICBjYXNlICJ4IjoKICAgICAgICAgICAgICAgICAgcmVzdG9yZSA9IGluZGV4OwogICAgICAgICAgICAgICAgICB1bmVzY2FwZWQgPSBzY2FuSGV4RXNjYXBlKGNoKTsKICAgICAgICAgICAgICAgICAgaWYgKHVuZXNjYXBlZCkgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSB1bmVzY2FwZWQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSByZXN0b3JlOwogICAgICAgICAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImIiOgogICAgICAgICAgICAgICAgICBzdHIgKz0gIlxiIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJmIjoKICAgICAgICAgICAgICAgICAgc3RyICs9ICJcZiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidiI6CiAgICAgICAgICAgICAgICAgIHN0ciArPSAiCyI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgaWYgKGlzT2N0YWxEaWdpdChjaCkpIHsKICAgICAgICAgICAgICAgICAgICBjb2RlID0gIjAxMjM0NTY3Ii5pbmRleE9mKGNoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29kZSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgb2N0YWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBsZW5ndGggJiYgaXNPY3RhbERpZ2l0KHNvdXJjZVtpbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICBvY3RhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZSAqIDggKyAiMDEyMzQ1NjciLmluZGV4T2Yoc291cmNlW2luZGV4KytdKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICgiMDEyMyIuaW5kZXhPZihjaCkgPj0gMCAmJiBpbmRleCA8IGxlbmd0aCAmJiBpc09jdGFsRGlnaXQoc291cmNlW2luZGV4XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUgKiA4ICsgIjAxMjM0NTY3Ii5pbmRleE9mKHNvdXJjZVtpbmRleCsrXSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKytsaW5lTnVtYmVyOwogICAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXhdID09PSAiXG4iKSB7CiAgICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0ciArPSBjaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHF1b3RlICE9PSAiIikgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogVG9rZW4uU3RyaW5nTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiBzdHIsCiAgICAgICAgICBvY3RhbDogb2N0YWwsCiAgICAgICAgICBsaW5lTnVtYmVyOiBsaW5lTnVtYmVyLAogICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICByYW5nZTogWyBzdGFydCwgaW5kZXggXQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2NhblJlZ0V4cCgpIHsKICAgICAgICB2YXIgc3RyLCBjaCwgc3RhcnQsIHBhdHRlcm4sIGZsYWdzLCB2YWx1ZSwgY2xhc3NNYXJrZXIgPSBmYWxzZSwgcmVzdG9yZSwgdGVybWluYXRlZCA9IGZhbHNlOwogICAgICAgIGJ1ZmZlciA9IG51bGw7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBzdGFydCA9IGluZGV4OwogICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICBhc3NlcnQoY2ggPT09ICIvIiwgIlJlZ3VsYXIgZXhwcmVzc2lvbiBsaXRlcmFsIG11c3Qgc3RhcnQgd2l0aCBhIHNsYXNoIik7CiAgICAgICAgc3RyID0gc291cmNlW2luZGV4KytdOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICBzdHIgKz0gY2g7CiAgICAgICAgICBpZiAoY2ggPT09ICJcXCIpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVudGVybWluYXRlZFJlZ0V4cCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RyICs9IGNoOwogICAgICAgICAgfSBlbHNlIGlmIChjbGFzc01hcmtlcikgewogICAgICAgICAgICBpZiAoY2ggPT09ICJdIikgewogICAgICAgICAgICAgIGNsYXNzTWFya2VyID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgdGVybWluYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICJbIikgewogICAgICAgICAgICAgIGNsYXNzTWFya2VyID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVudGVybWluYXRlZFJlZ0V4cCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0ZXJtaW5hdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbnRlcm1pbmF0ZWRSZWdFeHApOwogICAgICAgIH0KICAgICAgICBwYXR0ZXJuID0gc3RyLnN1YnN0cigxLCBzdHIubGVuZ3RoIC0gMik7CiAgICAgICAgZmxhZ3MgPSAiIjsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgIGlmICghaXNJZGVudGlmaWVyUGFydChjaCkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICArK2luZGV4OwogICAgICAgICAgaWYgKGNoID09PSAiXFwiICYmIGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4XTsKICAgICAgICAgICAgaWYgKGNoID09PSAidSIpIHsKICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgIHJlc3RvcmUgPSBpbmRleDsKICAgICAgICAgICAgICBjaCA9IHNjYW5IZXhFc2NhcGUoInUiKTsKICAgICAgICAgICAgICBpZiAoY2gpIHsKICAgICAgICAgICAgICAgIGZsYWdzICs9IGNoOwogICAgICAgICAgICAgICAgc3RyICs9ICJcXHUiOwogICAgICAgICAgICAgICAgZm9yICg7IHJlc3RvcmUgPCBpbmRleDsgKytyZXN0b3JlKSB7CiAgICAgICAgICAgICAgICAgIHN0ciArPSBzb3VyY2VbcmVzdG9yZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmVzdG9yZTsKICAgICAgICAgICAgICAgIGZsYWdzICs9ICJ1IjsKICAgICAgICAgICAgICAgIHN0ciArPSAiXFx1IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyICs9ICJcXCI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZsYWdzICs9IGNoOwogICAgICAgICAgICBzdHIgKz0gY2g7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICB2YWx1ZSA9IG5ldyBSZWdFeHAocGF0dGVybiwgZmxhZ3MpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLkludmFsaWRSZWdFeHApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgbGl0ZXJhbDogc3RyLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGluZGV4IF0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzSWRlbnRpZmllck5hbWUodG9rZW4pIHsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllciB8fCB0b2tlbi50eXBlID09PSBUb2tlbi5LZXl3b3JkIHx8IHRva2VuLnR5cGUgPT09IFRva2VuLkJvb2xlYW5MaXRlcmFsIHx8IHRva2VuLnR5cGUgPT09IFRva2VuLk51bGxMaXRlcmFsOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkdmFuY2UoKSB7CiAgICAgICAgdmFyIGNoLCB0b2tlbjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFRva2VuLkVPRiwKICAgICAgICAgICAgbGluZU51bWJlcjogbGluZU51bWJlciwKICAgICAgICAgICAgbGluZVN0YXJ0OiBsaW5lU3RhcnQsCiAgICAgICAgICAgIHJhbmdlOiBbIGluZGV4LCBpbmRleCBdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB0b2tlbiA9IHNjYW5QdW5jdHVhdG9yKCk7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICB9CiAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgIGlmIChjaCA9PT0gIiciIHx8IGNoID09PSAnIicpIHsKICAgICAgICAgIHJldHVybiBzY2FuU3RyaW5nTGl0ZXJhbCgpOwogICAgICAgIH0KICAgICAgICBpZiAoY2ggPT09ICIuIiB8fCBpc0RlY2ltYWxEaWdpdChjaCkpIHsKICAgICAgICAgIHJldHVybiBzY2FuTnVtZXJpY0xpdGVyYWwoKTsKICAgICAgICB9CiAgICAgICAgdG9rZW4gPSBzY2FuSWRlbnRpZmllcigpOwogICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgfQogICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHRva2VuOwogICAgICAgIGlmIChidWZmZXIpIHsKICAgICAgICAgIGluZGV4ID0gYnVmZmVyLnJhbmdlWzFdOwogICAgICAgICAgbGluZU51bWJlciA9IGJ1ZmZlci5saW5lTnVtYmVyOwogICAgICAgICAgbGluZVN0YXJ0ID0gYnVmZmVyLmxpbmVTdGFydDsKICAgICAgICAgIHRva2VuID0gYnVmZmVyOwogICAgICAgICAgYnVmZmVyID0gbnVsbDsKICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICB9CiAgICAgICAgYnVmZmVyID0gbnVsbDsKICAgICAgICByZXR1cm4gYWR2YW5jZSgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvb2thaGVhZCgpIHsKICAgICAgICB2YXIgcG9zLCBsaW5lLCBzdGFydDsKICAgICAgICBpZiAoYnVmZmVyICE9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgICAgIH0KICAgICAgICBwb3MgPSBpbmRleDsKICAgICAgICBsaW5lID0gbGluZU51bWJlcjsKICAgICAgICBzdGFydCA9IGxpbmVTdGFydDsKICAgICAgICBidWZmZXIgPSBhZHZhbmNlKCk7CiAgICAgICAgaW5kZXggPSBwb3M7CiAgICAgICAgbGluZU51bWJlciA9IGxpbmU7CiAgICAgICAgbGluZVN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwZWVrTGluZVRlcm1pbmF0b3IoKSB7CiAgICAgICAgdmFyIHBvcywgbGluZSwgc3RhcnQsIGZvdW5kOwogICAgICAgIHBvcyA9IGluZGV4OwogICAgICAgIGxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgIHN0YXJ0ID0gbGluZVN0YXJ0OwogICAgICAgIHNraXBDb21tZW50KCk7CiAgICAgICAgZm91bmQgPSBsaW5lTnVtYmVyICE9PSBsaW5lOwogICAgICAgIGluZGV4ID0gcG9zOwogICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lOwogICAgICAgIGxpbmVTdGFydCA9IHN0YXJ0OwogICAgICAgIHJldHVybiBmb3VuZDsKICAgICAgfQogICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKHRva2VuLCBtZXNzYWdlRm9ybWF0KSB7CiAgICAgICAgdmFyIGVycm9yLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwgbXNnID0gbWVzc2FnZUZvcm1hdC5yZXBsYWNlKC8lKFxkKS9nLCBmdW5jdGlvbih3aG9sZSwgaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBhcmdzW2luZGV4XSB8fCAiIjsKICAgICAgICB9KTsKICAgICAgICBpZiAodHlwZW9mIHRva2VuLmxpbmVOdW1iZXIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcigiTGluZSAiICsgdG9rZW4ubGluZU51bWJlciArICI6ICIgKyBtc2cpOwogICAgICAgICAgZXJyb3IuaW5kZXggPSB0b2tlbi5yYW5nZVswXTsKICAgICAgICAgIGVycm9yLmxpbmVOdW1iZXIgPSB0b2tlbi5saW5lTnVtYmVyOwogICAgICAgICAgZXJyb3IuY29sdW1uID0gdG9rZW4ucmFuZ2VbMF0gLSBsaW5lU3RhcnQgKyAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcigiTGluZSAiICsgbGluZU51bWJlciArICI6ICIgKyBtc2cpOwogICAgICAgICAgZXJyb3IuaW5kZXggPSBpbmRleDsKICAgICAgICAgIGVycm9yLmxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyOwogICAgICAgICAgZXJyb3IuY29sdW1uID0gaW5kZXggLSBsaW5lU3RhcnQgKyAxOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yVG9sZXJhbnQoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRocm93RXJyb3IuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoZXh0cmEuZXJyb3JzKSB7CiAgICAgICAgICAgIGV4dHJhLmVycm9ycy5wdXNoKGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdGhyb3dVbmV4cGVjdGVkKHRva2VuKSB7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRikgewogICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZEVPUyk7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5OdW1lcmljTGl0ZXJhbCkgewogICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZE51bWJlcik7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5TdHJpbmdMaXRlcmFsKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkU3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIHRocm93RXJyb3IodG9rZW4sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRJZGVudGlmaWVyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLktleXdvcmQpIHsKICAgICAgICAgIGlmIChpc0Z1dHVyZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZFJlc2VydmVkKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaWN0ICYmIGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvd0Vycm9yKHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sIHRva2VuLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdGhyb3dFcnJvcih0b2tlbiwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCB0b2tlbi52YWx1ZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZXhwZWN0KHZhbHVlKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLlB1bmN0dWF0b3IgfHwgdG9rZW4udmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBleHBlY3RLZXl3b3JkKGtleXdvcmQpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsZXgoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uS2V5d29yZCB8fCB0b2tlbi52YWx1ZSAhPT0ga2V5d29yZCkgewogICAgICAgICAgdGhyb3dVbmV4cGVjdGVkKHRva2VuKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbWF0Y2godmFsdWUpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uUHVuY3R1YXRvciAmJiB0b2tlbi52YWx1ZSA9PT0gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbWF0Y2hLZXl3b3JkKGtleXdvcmQpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICByZXR1cm4gdG9rZW4udHlwZSA9PT0gVG9rZW4uS2V5d29yZCAmJiB0b2tlbi52YWx1ZSA9PT0ga2V5d29yZDsKICAgICAgfQogICAgICBmdW5jdGlvbiBtYXRjaEFzc2lnbigpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKSwgb3AgPSB0b2tlbi52YWx1ZTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uUHVuY3R1YXRvcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3AgPT09ICI9IiB8fCBvcCA9PT0gIio9IiB8fCBvcCA9PT0gIi89IiB8fCBvcCA9PT0gIiU9IiB8fCBvcCA9PT0gIis9IiB8fCBvcCA9PT0gIi09IiB8fCBvcCA9PT0gIjw8PSIgfHwgb3AgPT09ICI+Pj0iIHx8IG9wID09PSAiPj4+PSIgfHwgb3AgPT09ICImPSIgfHwgb3AgPT09ICJePSIgfHwgb3AgPT09ICJ8PSI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29uc3VtZVNlbWljb2xvbigpIHsKICAgICAgICB2YXIgdG9rZW4sIGxpbmU7CiAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gPT09ICI7IikgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgIHNraXBDb21tZW50KCk7CiAgICAgICAgaWYgKGxpbmVOdW1iZXIgIT09IGxpbmUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKCI7IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5FT0YgJiYgIW1hdGNoKCJ9IikpIHsKICAgICAgICAgIHRocm93VW5leHBlY3RlZCh0b2tlbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzTGVmdEhhbmRTaWRlKGV4cHIpIHsKICAgICAgICByZXR1cm4gZXhwci50eXBlID09PSBTeW50YXguSWRlbnRpZmllciB8fCBleHByLnR5cGUgPT09IFN5bnRheC5NZW1iZXJFeHByZXNzaW9uOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlQXJyYXlJbml0aWFsaXNlcigpIHsKICAgICAgICB2YXIgZWxlbWVudHMgPSBbXTsKICAgICAgICBleHBlY3QoIlsiKTsKICAgICAgICB3aGlsZSAoIW1hdGNoKCJdIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiLCIpKSB7CiAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICBlbGVtZW50cy5wdXNoKG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudHMucHVzaChwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCkpOwogICAgICAgICAgICBpZiAoIW1hdGNoKCJdIikpIHsKICAgICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHBlY3QoIl0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkFycmF5RXhwcmVzc2lvbiwKICAgICAgICAgIGVsZW1lbnRzOiBlbGVtZW50cwogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKHBhcmFtLCBmaXJzdCkgewogICAgICAgIHZhciBwcmV2aW91c1N0cmljdCwgYm9keTsKICAgICAgICBwcmV2aW91c1N0cmljdCA9IHN0cmljdDsKICAgICAgICBib2R5ID0gcGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzKCk7CiAgICAgICAgaWYgKGZpcnN0ICYmIHN0cmljdCAmJiBpc1Jlc3RyaWN0ZWRXb3JkKHBhcmFtWzBdLm5hbWUpKSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoZmlyc3QsIE1lc3NhZ2VzLlN0cmljdFBhcmFtTmFtZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25FeHByZXNzaW9uLAogICAgICAgICAgaWQ6IG51bGwsCiAgICAgICAgICBwYXJhbXM6IHBhcmFtLAogICAgICAgICAgZGVmYXVsdHM6IFtdLAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHJlc3Q6IG51bGwsCiAgICAgICAgICBnZW5lcmF0b3I6IGZhbHNlLAogICAgICAgICAgZXhwcmVzc2lvbjogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlT2JqZWN0UHJvcGVydHlLZXkoKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLlN0cmluZ0xpdGVyYWwgfHwgdG9rZW4udHlwZSA9PT0gVG9rZW4uTnVtZXJpY0xpdGVyYWwpIHsKICAgICAgICAgIGlmIChzdHJpY3QgJiYgdG9rZW4ub2N0YWwpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RPY3RhbExpdGVyYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICBuYW1lOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VPYmplY3RQcm9wZXJ0eSgpIHsKICAgICAgICB2YXIgdG9rZW4sIGtleSwgaWQsIHBhcmFtOwogICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIGlkID0gcGFyc2VPYmplY3RQcm9wZXJ0eUtleSgpOwogICAgICAgICAgaWYgKHRva2VuLnZhbHVlID09PSAiZ2V0IiAmJiAhbWF0Y2goIjoiKSkgewogICAgICAgICAgICBrZXkgPSBwYXJzZU9iamVjdFByb3BlcnR5S2V5KCk7CiAgICAgICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguUHJvcGVydHksCiAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgdmFsdWU6IHBhcnNlUHJvcGVydHlGdW5jdGlvbihbXSksCiAgICAgICAgICAgICAga2luZDogImdldCIKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udmFsdWUgPT09ICJzZXQiICYmICFtYXRjaCgiOiIpKSB7CiAgICAgICAgICAgIGtleSA9IHBhcnNlT2JqZWN0UHJvcGVydHlLZXkoKTsKICAgICAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sIHRva2VuLnZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlByb3BlcnR5LAogICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICB2YWx1ZTogcGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKFtdKSwKICAgICAgICAgICAgICAgIGtpbmQ6ICJzZXQiCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJhbSA9IFsgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKSBdOwogICAgICAgICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiBTeW50YXguUHJvcGVydHksCiAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJzZVByb3BlcnR5RnVuY3Rpb24ocGFyYW0sIHRva2VuKSwKICAgICAgICAgICAgICAgIGtpbmQ6ICJzZXQiCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlByb3BlcnR5LAogICAgICAgICAgICAgIGtleTogaWQsCiAgICAgICAgICAgICAgdmFsdWU6IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKSwKICAgICAgICAgICAgICBraW5kOiAiaW5pdCIKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRiB8fCB0b2tlbi50eXBlID09PSBUb2tlbi5QdW5jdHVhdG9yKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXkgPSBwYXJzZU9iamVjdFByb3BlcnR5S2V5KCk7CiAgICAgICAgICBleHBlY3QoIjoiKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Qcm9wZXJ0eSwKICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgIHZhbHVlOiBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCksCiAgICAgICAgICAgIGtpbmQ6ICJpbml0IgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VPYmplY3RJbml0aWFsaXNlcigpIHsKICAgICAgICB2YXIgcHJvcGVydGllcyA9IFtdLCBwcm9wZXJ0eSwgbmFtZSwga2luZCwgbWFwID0ge30sIHRvU3RyaW5nID0gU3RyaW5nOwogICAgICAgIGV4cGVjdCgieyIpOwogICAgICAgIHdoaWxlICghbWF0Y2goIn0iKSkgewogICAgICAgICAgcHJvcGVydHkgPSBwYXJzZU9iamVjdFByb3BlcnR5KCk7CiAgICAgICAgICBpZiAocHJvcGVydHkua2V5LnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgIG5hbWUgPSBwcm9wZXJ0eS5rZXkubmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSB0b1N0cmluZyhwcm9wZXJ0eS5rZXkudmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAga2luZCA9IHByb3BlcnR5LmtpbmQgPT09ICJpbml0IiA/IFByb3BlcnR5S2luZC5EYXRhIDogcHJvcGVydHkua2luZCA9PT0gImdldCIgPyBQcm9wZXJ0eUtpbmQuR2V0IDogUHJvcGVydHlLaW5kLlNldDsKICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobWFwLCBuYW1lKSkgewogICAgICAgICAgICBpZiAobWFwW25hbWVdID09PSBQcm9wZXJ0eUtpbmQuRGF0YSkgewogICAgICAgICAgICAgIGlmIChzdHJpY3QgJiYga2luZCA9PT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0RHVwbGljYXRlUHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2luZCAhPT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuQWNjZXNzb3JEYXRhUHJvcGVydHkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoa2luZCA9PT0gUHJvcGVydHlLaW5kLkRhdGEpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuQWNjZXNzb3JEYXRhUHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwW25hbWVdICYga2luZCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHt9LCBNZXNzYWdlcy5BY2Nlc3NvckdldFNldCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcFtuYW1lXSB8PSBraW5kOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWFwW25hbWVdID0ga2luZDsKICAgICAgICAgIH0KICAgICAgICAgIHByb3BlcnRpZXMucHVzaChwcm9wZXJ0eSk7CiAgICAgICAgICBpZiAoIW1hdGNoKCJ9IikpIHsKICAgICAgICAgICAgZXhwZWN0KCIsIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgifSIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguT2JqZWN0RXhwcmVzc2lvbiwKICAgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlR3JvdXBFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVByaW1hcnlFeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiA9IGxvb2thaGVhZCgpLCB0eXBlID0gdG9rZW4udHlwZTsKICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllcikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICAgIG5hbWU6IGxleCgpLnZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uU3RyaW5nTGl0ZXJhbCB8fCB0eXBlID09PSBUb2tlbi5OdW1lcmljTGl0ZXJhbCkgewogICAgICAgICAgaWYgKHN0cmljdCAmJiB0b2tlbi5vY3RhbCkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQodG9rZW4sIE1lc3NhZ2VzLlN0cmljdE9jdGFsTGl0ZXJhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlTGl0ZXJhbChsZXgoKSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlID09PSBUb2tlbi5LZXl3b3JkKSB7CiAgICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJ0aGlzIikpIHsKICAgICAgICAgICAgbGV4KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LlRoaXNFeHByZXNzaW9uCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIHJldHVybiBwYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uQm9vbGVhbkxpdGVyYWwpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdG9rZW4udmFsdWUgPSB0b2tlbi52YWx1ZSA9PT0gInRydWUiOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gVG9rZW4uTnVsbExpdGVyYWwpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdG9rZW4udmFsdWUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwodG9rZW4pOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goIlsiKSkgewogICAgICAgICAgcmV0dXJuIHBhcnNlQXJyYXlJbml0aWFsaXNlcigpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goInsiKSkgewogICAgICAgICAgcmV0dXJuIHBhcnNlT2JqZWN0SW5pdGlhbGlzZXIoKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoKCIoIikpIHsKICAgICAgICAgIHJldHVybiBwYXJzZUdyb3VwRXhwcmVzc2lvbigpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2goIi8iKSB8fCBtYXRjaCgiLz0iKSkgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUxpdGVyYWwoc2NhblJlZ0V4cCgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRocm93VW5leHBlY3RlZChsZXgoKSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VBcmd1bWVudHMoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBleHBlY3QoIigiKTsKICAgICAgICBpZiAoIW1hdGNoKCIpIikpIHsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICBhcmdzLnB1c2gocGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VOb25Db21wdXRlZFByb3BlcnR5KCkgewogICAgICAgIHZhciB0b2tlbiA9IGxleCgpOwogICAgICAgIGlmICghaXNJZGVudGlmaWVyTmFtZSh0b2tlbikpIHsKICAgICAgICAgIHRocm93VW5leHBlY3RlZCh0b2tlbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguSWRlbnRpZmllciwKICAgICAgICAgIG5hbWU6IHRva2VuLnZhbHVlCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZU5vbkNvbXB1dGVkTWVtYmVyKCkgewogICAgICAgIGV4cGVjdCgiLiIpOwogICAgICAgIHJldHVybiBwYXJzZU5vbkNvbXB1dGVkUHJvcGVydHkoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkgewogICAgICAgIHZhciBleHByOwogICAgICAgIGV4cGVjdCgiWyIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIl0iKTsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZU5ld0V4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHI7CiAgICAgICAgZXhwZWN0S2V5d29yZCgibmV3Iik7CiAgICAgICAgZXhwciA9IHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5OZXdFeHByZXNzaW9uLAogICAgICAgICAgY2FsbGVlOiBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24oKSwKICAgICAgICAgIGFyZ3VtZW50czogW10KICAgICAgICB9OwogICAgICAgIGlmIChtYXRjaCgiKCIpKSB7CiAgICAgICAgICBleHByWyJhcmd1bWVudHMiXSA9IHBhcnNlQXJndW1lbnRzKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTGVmdEhhbmRTaWRlRXhwcmVzc2lvbkFsbG93Q2FsbCgpIHsKICAgICAgICB2YXIgZXhwcjsKICAgICAgICBleHByID0gbWF0Y2hLZXl3b3JkKCJuZXciKSA/IHBhcnNlTmV3RXhwcmVzc2lvbigpIDogcGFyc2VQcmltYXJ5RXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiLiIpIHx8IG1hdGNoKCJbIikgfHwgbWF0Y2goIigiKSkgewogICAgICAgICAgaWYgKG1hdGNoKCIoIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguQ2FsbEV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY2FsbGVlOiBleHByLAogICAgICAgICAgICAgIGFyZ3VtZW50czogcGFyc2VBcmd1bWVudHMoKQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaCgiWyIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgb2JqZWN0OiBleHByLAogICAgICAgICAgICAgIHByb3BlcnR5OiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTGVmdEhhbmRTaWRlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwcjsKICAgICAgICBleHByID0gbWF0Y2hLZXl3b3JkKCJuZXciKSA/IHBhcnNlTmV3RXhwcmVzc2lvbigpIDogcGFyc2VQcmltYXJ5RXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiLiIpIHx8IG1hdGNoKCJbIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiWyIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgb2JqZWN0OiBleHByLAogICAgICAgICAgICAgIHByb3BlcnR5OiBwYXJzZUNvbXB1dGVkTWVtYmVyKCkKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlUG9zdGZpeEV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwoKSwgdG9rZW47CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uUHVuY3R1YXRvcikgewogICAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgICAgfQogICAgICAgIGlmICgobWF0Y2goIisrIikgfHwgbWF0Y2goIi0tIikpICYmICFwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdExIU1Bvc3RmaXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0xlZnRIYW5kU2lkZShleHByKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLkludmFsaWRMSFNJbkFzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlVwZGF0ZUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgYXJndW1lbnQ6IGV4cHIsCiAgICAgICAgICAgIHByZWZpeDogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlVW5hcnlFeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiwgZXhwcjsKICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5QdW5jdHVhdG9yICYmIHRva2VuLnR5cGUgIT09IFRva2VuLktleXdvcmQpIHsKICAgICAgICAgIHJldHVybiBwYXJzZVBvc3RmaXhFeHByZXNzaW9uKCk7CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaCgiKysiKSB8fCBtYXRjaCgiLS0iKSkgewogICAgICAgICAgdG9rZW4gPSBsZXgoKTsKICAgICAgICAgIGV4cHIgPSBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpOwogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdExIU1ByZWZpeCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzTGVmdEhhbmRTaWRlKGV4cHIpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSW52YWxpZExIU0luQXNzaWdubWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguVXBkYXRlRXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IHRva2VuLnZhbHVlLAogICAgICAgICAgICBhcmd1bWVudDogZXhwciwKICAgICAgICAgICAgcHJlZml4OiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaCgiKyIpIHx8IG1hdGNoKCItIikgfHwgbWF0Y2goIn4iKSB8fCBtYXRjaCgiISIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguVW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGFyZ3VtZW50OiBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpLAogICAgICAgICAgICBwcmVmaXg6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiZGVsZXRlIikgfHwgbWF0Y2hLZXl3b3JkKCJ2b2lkIikgfHwgbWF0Y2hLZXl3b3JkKCJ0eXBlb2YiKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlVuYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBhcmd1bWVudDogcGFyc2VVbmFyeUV4cHJlc3Npb24oKSwKICAgICAgICAgICAgcHJlZml4OiB0cnVlCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLm9wZXJhdG9yID09PSAiZGVsZXRlIiAmJiBleHByLmFyZ3VtZW50LnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyKSB7CiAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0RGVsZXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHByOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyc2VQb3N0Zml4RXhwcmVzc2lvbigpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VVbmFyeUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIioiKSB8fCBtYXRjaCgiLyIpIHx8IG1hdGNoKCIlIikpIHsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5CaW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZVVuYXJ5RXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUFkZGl0aXZlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCIrIikgfHwgbWF0Y2goIi0iKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU2hpZnRFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIjw8IikgfHwgbWF0Y2goIj4+IikgfHwgbWF0Y2goIj4+PiIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQmluYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciwgcHJldmlvdXNBbGxvd0luOwogICAgICAgIHByZXZpb3VzQWxsb3dJbiA9IHN0YXRlLmFsbG93SW47CiAgICAgICAgc3RhdGUuYWxsb3dJbiA9IHRydWU7CiAgICAgICAgZXhwciA9IHBhcnNlU2hpZnRFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCI8IikgfHwgbWF0Y2goIj4iKSB8fCBtYXRjaCgiPD0iKSB8fCBtYXRjaCgiPj0iKSB8fCBwcmV2aW91c0FsbG93SW4gJiYgbWF0Y2hLZXl3b3JkKCJpbiIpIHx8IG1hdGNoS2V5d29yZCgiaW5zdGFuY2VvZiIpKSB7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQmluYXJ5RXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6IGxleCgpLnZhbHVlLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VTaGlmdEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgc3RhdGUuYWxsb3dJbiA9IHByZXZpb3VzQWxsb3dJbjsKICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIj09IikgfHwgbWF0Y2goIiE9IikgfHwgbWF0Y2goIj09PSIpIHx8IG1hdGNoKCIhPT0iKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiBsZXgoKS52YWx1ZSwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlRXF1YWxpdHlFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCImIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiAiJiIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpOwogICAgICAgIHdoaWxlIChtYXRjaCgiXiIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5CaW5hcnlFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogIl4iLAogICAgICAgICAgICBsZWZ0OiBleHByLAogICAgICAgICAgICByaWdodDogcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCJ8IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJpbmFyeUV4cHJlc3Npb24sCiAgICAgICAgICAgIG9wZXJhdG9yOiAifCIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIiYmIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkxvZ2ljYWxFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogIiYmIiwKICAgICAgICAgICAgbGVmdDogZXhwciwKICAgICAgICAgICAgcmlnaHQ6IHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbigpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24oKSB7CiAgICAgICAgdmFyIGV4cHIgPSBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCJ8fCIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Mb2dpY2FsRXhwcmVzc2lvbiwKICAgICAgICAgICAgb3BlcmF0b3I6ICJ8fCIsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlQ29uZGl0aW9uYWxFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBleHByLCBwcmV2aW91c0FsbG93SW4sIGNvbnNlcXVlbnQ7CiAgICAgICAgZXhwciA9IHBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbigpOwogICAgICAgIGlmIChtYXRjaCgiPyIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIHByZXZpb3VzQWxsb3dJbiA9IHN0YXRlLmFsbG93SW47CiAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gdHJ1ZTsKICAgICAgICAgIGNvbnNlcXVlbnQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gcHJldmlvdXNBbGxvd0luOwogICAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgICBleHByID0gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQ29uZGl0aW9uYWxFeHByZXNzaW9uLAogICAgICAgICAgICB0ZXN0OiBleHByLAogICAgICAgICAgICBjb25zZXF1ZW50OiBjb25zZXF1ZW50LAogICAgICAgICAgICBhbHRlcm5hdGU6IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgdG9rZW4sIGV4cHI7CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBleHByID0gcGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24oKTsKICAgICAgICBpZiAobWF0Y2hBc3NpZ24oKSkgewogICAgICAgICAgaWYgKCFpc0xlZnRIYW5kU2lkZShleHByKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLkludmFsaWRMSFNJbkFzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cmljdCAmJiBleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIGlzUmVzdHJpY3RlZFdvcmQoZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQodG9rZW4sIE1lc3NhZ2VzLlN0cmljdExIU0Fzc2lnbm1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkFzc2lnbm1lbnRFeHByZXNzaW9uLAogICAgICAgICAgICBvcGVyYXRvcjogbGV4KCkudmFsdWUsCiAgICAgICAgICAgIGxlZnQ6IGV4cHIsCiAgICAgICAgICAgIHJpZ2h0OiBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHByOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRXhwcmVzc2lvbigpIHsKICAgICAgICB2YXIgZXhwciA9IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24oKTsKICAgICAgICBpZiAobWF0Y2goIiwiKSkgewogICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlNlcXVlbmNlRXhwcmVzc2lvbiwKICAgICAgICAgICAgZXhwcmVzc2lvbnM6IFsgZXhwciBdCiAgICAgICAgICB9OwogICAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICghbWF0Y2goIiwiKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICBleHByLmV4cHJlc3Npb25zLnB1c2gocGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbigpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTdGF0ZW1lbnRMaXN0KCkgewogICAgICAgIHZhciBsaXN0ID0gW10sIHN0YXRlbWVudDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGVtZW50ID0gcGFyc2VTb3VyY2VFbGVtZW50KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlbWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBsaXN0LnB1c2goc3RhdGVtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCbG9jaygpIHsKICAgICAgICB2YXIgYmxvY2s7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgYmxvY2sgPSBwYXJzZVN0YXRlbWVudExpc3QoKTsKICAgICAgICBleHBlY3QoIn0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkJsb2NrU3RhdGVtZW50LAogICAgICAgICAgYm9keTogYmxvY2sKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCkgewogICAgICAgIHZhciB0b2tlbiA9IGxleCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlICE9PSBUb2tlbi5JZGVudGlmaWVyKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQodG9rZW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LklkZW50aWZpZXIsCiAgICAgICAgICBuYW1lOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uKGtpbmQpIHsKICAgICAgICB2YXIgaWQgPSBwYXJzZVZhcmlhYmxlSWRlbnRpZmllcigpLCBpbml0ID0gbnVsbDsKICAgICAgICBpZiAoc3RyaWN0ICYmIGlzUmVzdHJpY3RlZFdvcmQoaWQubmFtZSkpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuU3RyaWN0VmFyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGlmIChraW5kID09PSAiY29uc3QiKSB7CiAgICAgICAgICBleHBlY3QoIj0iKTsKICAgICAgICAgIGluaXQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaCgiPSIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICAgIGluaXQgPSBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguVmFyaWFibGVEZWNsYXJhdG9yLAogICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgaW5pdDogaW5pdAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uTGlzdChraW5kKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICBkbyB7CiAgICAgICAgICBsaXN0LnB1c2gocGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uKGtpbmQpKTsKICAgICAgICAgIGlmICghbWF0Y2goIiwiKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGxleCgpOwogICAgICAgIH0gd2hpbGUgKGluZGV4IDwgbGVuZ3RoKTsKICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVZhcmlhYmxlU3RhdGVtZW50KCkgewogICAgICAgIHZhciBkZWNsYXJhdGlvbnM7CiAgICAgICAgZXhwZWN0S2V5d29yZCgidmFyIik7CiAgICAgICAgZGVjbGFyYXRpb25zID0gcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uTGlzdCgpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlZhcmlhYmxlRGVjbGFyYXRpb24sCiAgICAgICAgICBkZWNsYXJhdGlvbnM6IGRlY2xhcmF0aW9ucywKICAgICAgICAgIGtpbmQ6ICJ2YXIiCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbnN0TGV0RGVjbGFyYXRpb24oa2luZCkgewogICAgICAgIHZhciBkZWNsYXJhdGlvbnM7CiAgICAgICAgZXhwZWN0S2V5d29yZChraW5kKTsKICAgICAgICBkZWNsYXJhdGlvbnMgPSBwYXJzZVZhcmlhYmxlRGVjbGFyYXRpb25MaXN0KGtpbmQpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlZhcmlhYmxlRGVjbGFyYXRpb24sCiAgICAgICAgICBkZWNsYXJhdGlvbnM6IGRlY2xhcmF0aW9ucywKICAgICAgICAgIGtpbmQ6IGtpbmQKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRW1wdHlTdGF0ZW1lbnQoKSB7CiAgICAgICAgZXhwZWN0KCI7Iik7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5FbXB0eVN0YXRlbWVudAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VFeHByZXNzaW9uU3RhdGVtZW50KCkgewogICAgICAgIHZhciBleHByID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRXhwcmVzc2lvblN0YXRlbWVudCwKICAgICAgICAgIGV4cHJlc3Npb246IGV4cHIKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlSWZTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIHRlc3QsIGNvbnNlcXVlbnQsIGFsdGVybmF0ZTsKICAgICAgICBleHBlY3RLZXl3b3JkKCJpZiIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIHRlc3QgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICBjb25zZXF1ZW50ID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJlbHNlIikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgYWx0ZXJuYXRlID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5JZlN0YXRlbWVudCwKICAgICAgICAgIHRlc3Q6IHRlc3QsCiAgICAgICAgICBjb25zZXF1ZW50OiBjb25zZXF1ZW50LAogICAgICAgICAgYWx0ZXJuYXRlOiBhbHRlcm5hdGUKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRG9XaGlsZVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgYm9keSwgdGVzdCwgb2xkSW5JdGVyYXRpb247CiAgICAgICAgZXhwZWN0S2V5d29yZCgiZG8iKTsKICAgICAgICBvbGRJbkl0ZXJhdGlvbiA9IHN0YXRlLmluSXRlcmF0aW9uOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gdHJ1ZTsKICAgICAgICBib2R5ID0gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICBzdGF0ZS5pbkl0ZXJhdGlvbiA9IG9sZEluSXRlcmF0aW9uOwogICAgICAgIGV4cGVjdEtleXdvcmQoIndoaWxlIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIGlmIChtYXRjaCgiOyIpKSB7CiAgICAgICAgICBsZXgoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Eb1doaWxlU3RhdGVtZW50LAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHRlc3Q6IHRlc3QKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlV2hpbGVTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIHRlc3QsIGJvZHksIG9sZEluSXRlcmF0aW9uOwogICAgICAgIGV4cGVjdEtleXdvcmQoIndoaWxlIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSB0cnVlOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gb2xkSW5JdGVyYXRpb247CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5XaGlsZVN0YXRlbWVudCwKICAgICAgICAgIHRlc3Q6IHRlc3QsCiAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24oKSB7CiAgICAgICAgdmFyIHRva2VuID0gbGV4KCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5WYXJpYWJsZURlY2xhcmF0aW9uLAogICAgICAgICAgZGVjbGFyYXRpb25zOiBwYXJzZVZhcmlhYmxlRGVjbGFyYXRpb25MaXN0KCksCiAgICAgICAgICBraW5kOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VGb3JTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIGluaXQsIHRlc3QsIHVwZGF0ZSwgbGVmdCwgcmlnaHQsIGJvZHksIG9sZEluSXRlcmF0aW9uOwogICAgICAgIGluaXQgPSB0ZXN0ID0gdXBkYXRlID0gbnVsbDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJmb3IiKTsKICAgICAgICBleHBlY3QoIigiKTsKICAgICAgICBpZiAobWF0Y2goIjsiKSkgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChtYXRjaEtleXdvcmQoInZhciIpIHx8IG1hdGNoS2V5d29yZCgibGV0IikpIHsKICAgICAgICAgICAgc3RhdGUuYWxsb3dJbiA9IGZhbHNlOwogICAgICAgICAgICBpbml0ID0gcGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uKCk7CiAgICAgICAgICAgIHN0YXRlLmFsbG93SW4gPSB0cnVlOwogICAgICAgICAgICBpZiAoaW5pdC5kZWNsYXJhdGlvbnMubGVuZ3RoID09PSAxICYmIG1hdGNoS2V5d29yZCgiaW4iKSkgewogICAgICAgICAgICAgIGxleCgpOwogICAgICAgICAgICAgIGxlZnQgPSBpbml0OwogICAgICAgICAgICAgIHJpZ2h0ID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgaW5pdCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLmFsbG93SW4gPSBmYWxzZTsKICAgICAgICAgICAgaW5pdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICBzdGF0ZS5hbGxvd0luID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiaW4iKSkgewogICAgICAgICAgICAgIGlmICghaXNMZWZ0SGFuZFNpZGUoaW5pdCkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSW52YWxpZExIU0luRm9ySW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsZXgoKTsKICAgICAgICAgICAgICBsZWZ0ID0gaW5pdDsKICAgICAgICAgICAgICByaWdodCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICAgIGluaXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGV4cGVjdCgiOyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICBpZiAoIW1hdGNoKCI7IikpIHsKICAgICAgICAgICAgdGVzdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgICAgfQogICAgICAgICAgZXhwZWN0KCI7Iik7CiAgICAgICAgICBpZiAoIW1hdGNoKCIpIikpIHsKICAgICAgICAgICAgdXBkYXRlID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSB0cnVlOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHN0YXRlLmluSXRlcmF0aW9uID0gb2xkSW5JdGVyYXRpb247CiAgICAgICAgaWYgKHR5cGVvZiBsZWZ0ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkZvclN0YXRlbWVudCwKICAgICAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICAgICAgdGVzdDogdGVzdCwKICAgICAgICAgICAgdXBkYXRlOiB1cGRhdGUsCiAgICAgICAgICAgIGJvZHk6IGJvZHkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRm9ySW5TdGF0ZW1lbnQsCiAgICAgICAgICBsZWZ0OiBsZWZ0LAogICAgICAgICAgcmlnaHQ6IHJpZ2h0LAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIGVhY2g6IGZhbHNlCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNvbnRpbnVlU3RhdGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiwgbGFiZWwgPSBudWxsOwogICAgICAgIGV4cGVjdEtleXdvcmQoImNvbnRpbnVlIik7CiAgICAgICAgaWYgKHNvdXJjZVtpbmRleF0gPT09ICI7IikgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICBpZiAoIXN0YXRlLmluSXRlcmF0aW9uKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxDb250aW51ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQ29udGludWVTdGF0ZW1lbnQsCiAgICAgICAgICAgIGxhYmVsOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAocGVla0xpbmVUZXJtaW5hdG9yKCkpIHsKICAgICAgICAgIGlmICghc3RhdGUuaW5JdGVyYXRpb24pIHsKICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuSWxsZWdhbENvbnRpbnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5Db250aW51ZVN0YXRlbWVudCwKICAgICAgICAgICAgbGFiZWw6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLklkZW50aWZpZXIpIHsKICAgICAgICAgIGxhYmVsID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN0YXRlLmxhYmVsU2V0LCBsYWJlbC5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5Vbmtub3duTGFiZWwsIGxhYmVsLm5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdW1lU2VtaWNvbG9uKCk7CiAgICAgICAgaWYgKGxhYmVsID09PSBudWxsICYmICFzdGF0ZS5pbkl0ZXJhdGlvbikgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuSWxsZWdhbENvbnRpbnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Db250aW51ZVN0YXRlbWVudCwKICAgICAgICAgIGxhYmVsOiBsYWJlbAogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VCcmVha1N0YXRlbWVudCgpIHsKICAgICAgICB2YXIgdG9rZW4sIGxhYmVsID0gbnVsbDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJicmVhayIpOwogICAgICAgIGlmIChzb3VyY2VbaW5kZXhdID09PSAiOyIpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgaWYgKCEoc3RhdGUuaW5JdGVyYXRpb24gfHwgc3RhdGUuaW5Td2l0Y2gpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxCcmVhayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguQnJlYWtTdGF0ZW1lbnQsCiAgICAgICAgICAgIGxhYmVsOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAocGVla0xpbmVUZXJtaW5hdG9yKCkpIHsKICAgICAgICAgIGlmICghKHN0YXRlLmluSXRlcmF0aW9uIHx8IHN0YXRlLmluU3dpdGNoKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5JbGxlZ2FsQnJlYWspOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LkJyZWFrU3RhdGVtZW50LAogICAgICAgICAgICBsYWJlbDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW4uSWRlbnRpZmllcikgewogICAgICAgICAgbGFiZWwgPSBwYXJzZVZhcmlhYmxlSWRlbnRpZmllcigpOwogICAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RhdGUubGFiZWxTZXQsIGxhYmVsLm5hbWUpKSB7CiAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVua25vd25MYWJlbCwgbGFiZWwubmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICBpZiAobGFiZWwgPT09IG51bGwgJiYgIShzdGF0ZS5pbkl0ZXJhdGlvbiB8fCBzdGF0ZS5pblN3aXRjaCkpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLklsbGVnYWxCcmVhayk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguQnJlYWtTdGF0ZW1lbnQsCiAgICAgICAgICBsYWJlbDogbGFiZWwKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlUmV0dXJuU3RhdGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiwgYXJndW1lbnQgPSBudWxsOwogICAgICAgIGV4cGVjdEtleXdvcmQoInJldHVybiIpOwogICAgICAgIGlmICghc3RhdGUuaW5GdW5jdGlvbkJvZHkpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudCh7fSwgTWVzc2FnZXMuSWxsZWdhbFJldHVybik7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2VbaW5kZXhdID09PSAiICIpIHsKICAgICAgICAgIGlmIChpc0lkZW50aWZpZXJTdGFydChzb3VyY2VbaW5kZXggKyAxXSkpIHsKICAgICAgICAgICAgYXJndW1lbnQgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6IFN5bnRheC5SZXR1cm5TdGF0ZW1lbnQsCiAgICAgICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogU3ludGF4LlJldHVyblN0YXRlbWVudCwKICAgICAgICAgICAgYXJndW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmICghbWF0Y2goIjsiKSkgewogICAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICAgIGlmICghbWF0Y2goIn0iKSAmJiB0b2tlbi50eXBlICE9PSBUb2tlbi5FT0YpIHsKICAgICAgICAgICAgYXJndW1lbnQgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3VtZVNlbWljb2xvbigpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguUmV0dXJuU3RhdGVtZW50LAogICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVdpdGhTdGF0ZW1lbnQoKSB7CiAgICAgICAgdmFyIG9iamVjdCwgYm9keTsKICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdE1vZGVXaXRoKTsKICAgICAgICB9CiAgICAgICAgZXhwZWN0S2V5d29yZCgid2l0aCIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIG9iamVjdCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGV4cGVjdCgiKSIpOwogICAgICAgIGJvZHkgPSBwYXJzZVN0YXRlbWVudCgpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguV2l0aFN0YXRlbWVudCwKICAgICAgICAgIG9iamVjdDogb2JqZWN0LAogICAgICAgICAgYm9keTogYm9keQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTd2l0Y2hDYXNlKCkgewogICAgICAgIHZhciB0ZXN0LCBjb25zZXF1ZW50ID0gW10sIHN0YXRlbWVudDsKICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJkZWZhdWx0IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgdGVzdCA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4cGVjdEtleXdvcmQoImNhc2UiKTsKICAgICAgICAgIHRlc3QgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICB9CiAgICAgICAgZXhwZWN0KCI6Iik7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAobWF0Y2goIn0iKSB8fCBtYXRjaEtleXdvcmQoImRlZmF1bHQiKSB8fCBtYXRjaEtleXdvcmQoImNhc2UiKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlbWVudCA9IHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlbWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zZXF1ZW50LnB1c2goc3RhdGVtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Td2l0Y2hDYXNlLAogICAgICAgICAgdGVzdDogdGVzdCwKICAgICAgICAgIGNvbnNlcXVlbnQ6IGNvbnNlcXVlbnQKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU3dpdGNoU3RhdGVtZW50KCkgewogICAgICAgIHZhciBkaXNjcmltaW5hbnQsIGNhc2VzLCBjbGF1c2UsIG9sZEluU3dpdGNoLCBkZWZhdWx0Rm91bmQ7CiAgICAgICAgZXhwZWN0S2V5d29yZCgic3dpdGNoIik7CiAgICAgICAgZXhwZWN0KCIoIik7CiAgICAgICAgZGlzY3JpbWluYW50ID0gcGFyc2VFeHByZXNzaW9uKCk7CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgY2FzZXMgPSBbXTsKICAgICAgICBpZiAobWF0Y2goIn0iKSkgewogICAgICAgICAgbGV4KCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0eXBlOiBTeW50YXguU3dpdGNoU3RhdGVtZW50LAogICAgICAgICAgICBkaXNjcmltaW5hbnQ6IGRpc2NyaW1pbmFudCwKICAgICAgICAgICAgY2FzZXM6IGNhc2VzCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBvbGRJblN3aXRjaCA9IHN0YXRlLmluU3dpdGNoOwogICAgICAgIHN0YXRlLmluU3dpdGNoID0gdHJ1ZTsKICAgICAgICBkZWZhdWx0Rm91bmQgPSBmYWxzZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2xhdXNlID0gcGFyc2VTd2l0Y2hDYXNlKCk7CiAgICAgICAgICBpZiAoY2xhdXNlLnRlc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGRlZmF1bHRGb3VuZCkgewogICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLk11bHRpcGxlRGVmYXVsdHNJblN3aXRjaCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdEZvdW5kID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2VzLnB1c2goY2xhdXNlKTsKICAgICAgICB9CiAgICAgICAgc3RhdGUuaW5Td2l0Y2ggPSBvbGRJblN3aXRjaDsKICAgICAgICBleHBlY3QoIn0iKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlN3aXRjaFN0YXRlbWVudCwKICAgICAgICAgIGRpc2NyaW1pbmFudDogZGlzY3JpbWluYW50LAogICAgICAgICAgY2FzZXM6IGNhc2VzCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVRocm93U3RhdGVtZW50KCkgewogICAgICAgIHZhciBhcmd1bWVudDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJ0aHJvdyIpOwogICAgICAgIGlmIChwZWVrTGluZVRlcm1pbmF0b3IoKSkgewogICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuTmV3bGluZUFmdGVyVGhyb3cpOwogICAgICAgIH0KICAgICAgICBhcmd1bWVudCA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlRocm93U3RhdGVtZW50LAogICAgICAgICAgYXJndW1lbnQ6IGFyZ3VtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUNhdGNoQ2xhdXNlKCkgewogICAgICAgIHZhciBwYXJhbTsKICAgICAgICBleHBlY3RLZXl3b3JkKCJjYXRjaCIpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmIChtYXRjaCgiKSIpKSB7CiAgICAgICAgICB0aHJvd1VuZXhwZWN0ZWQobG9va2FoZWFkKCkpOwogICAgICAgIH0KICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgaWYgKHN0cmljdCAmJiBpc1Jlc3RyaWN0ZWRXb3JkKHBhcmFtLm5hbWUpKSB7CiAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoe30sIE1lc3NhZ2VzLlN0cmljdENhdGNoVmFyaWFibGUpOwogICAgICAgIH0KICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkNhdGNoQ2xhdXNlLAogICAgICAgICAgcGFyYW06IHBhcmFtLAogICAgICAgICAgYm9keTogcGFyc2VCbG9jaygpCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVRyeVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgYmxvY2ssIGhhbmRsZXJzID0gW10sIGZpbmFsaXplciA9IG51bGw7CiAgICAgICAgZXhwZWN0S2V5d29yZCgidHJ5Iik7CiAgICAgICAgYmxvY2sgPSBwYXJzZUJsb2NrKCk7CiAgICAgICAgaWYgKG1hdGNoS2V5d29yZCgiY2F0Y2giKSkgewogICAgICAgICAgaGFuZGxlcnMucHVzaChwYXJzZUNhdGNoQ2xhdXNlKCkpOwogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2hLZXl3b3JkKCJmaW5hbGx5IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgZmluYWxpemVyID0gcGFyc2VCbG9jaygpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFuZGxlcnMubGVuZ3RoID09PSAwICYmICFmaW5hbGl6ZXIpIHsKICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLk5vQ2F0Y2hPckZpbmFsbHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LlRyeVN0YXRlbWVudCwKICAgICAgICAgIGJsb2NrOiBibG9jaywKICAgICAgICAgIGd1YXJkZWRIYW5kbGVyczogW10sCiAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMsCiAgICAgICAgICBmaW5hbGl6ZXI6IGZpbmFsaXplcgogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VEZWJ1Z2dlclN0YXRlbWVudCgpIHsKICAgICAgICBleHBlY3RLZXl3b3JkKCJkZWJ1Z2dlciIpOwogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkRlYnVnZ2VyU3RhdGVtZW50CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVN0YXRlbWVudCgpIHsKICAgICAgICB2YXIgdG9rZW4gPSBsb29rYWhlYWQoKSwgZXhwciwgbGFiZWxlZEJvZHk7CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLkVPRikgewogICAgICAgICAgdGhyb3dVbmV4cGVjdGVkKHRva2VuKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuLlB1bmN0dWF0b3IpIHsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiOyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRW1wdHlTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAieyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlQmxvY2soKTsKICAgICAgICAgICAgY2FzZSAiKCI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRXhwcmVzc2lvblN0YXRlbWVudCgpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW4uS2V5d29yZCkgewogICAgICAgICAgc3dpdGNoICh0b2tlbi52YWx1ZSkgewogICAgICAgICAgICBjYXNlICJicmVhayI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlQnJlYWtTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAiY29udGludWUiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUNvbnRpbnVlU3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgImRlYnVnZ2VyIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VEZWJ1Z2dlclN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJkbyI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRG9XaGlsZVN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJmb3IiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUZvclN0YXRlbWVudCgpOwogICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRnVuY3Rpb25EZWNsYXJhdGlvbigpOwogICAgICAgICAgICBjYXNlICJpZiI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlSWZTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAicmV0dXJuIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VSZXR1cm5TdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAic3dpdGNoIjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VTd2l0Y2hTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAidGhyb3ciOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVRocm93U3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgInRyeSI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVHJ5U3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgInZhciI6CiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVmFyaWFibGVTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgY2FzZSAid2hpbGUiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVdoaWxlU3RhdGVtZW50KCk7CiAgICAgICAgICAgIGNhc2UgIndpdGgiOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZVdpdGhTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwciA9IHBhcnNlRXhwcmVzc2lvbigpOwogICAgICAgIGlmIChleHByLnR5cGUgPT09IFN5bnRheC5JZGVudGlmaWVyICYmIG1hdGNoKCI6IikpIHsKICAgICAgICAgIGxleCgpOwogICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdGF0ZS5sYWJlbFNldCwgZXhwci5uYW1lKSkgewogICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5SZWRlY2xhcmF0aW9uLCAiTGFiZWwiLCBleHByLm5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUubGFiZWxTZXRbZXhwci5uYW1lXSA9IHRydWU7CiAgICAgICAgICBsYWJlbGVkQm9keSA9IHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgICBkZWxldGUgc3RhdGUubGFiZWxTZXRbZXhwci5uYW1lXTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6IFN5bnRheC5MYWJlbGVkU3RhdGVtZW50LAogICAgICAgICAgICBsYWJlbDogZXhwciwKICAgICAgICAgICAgYm9keTogbGFiZWxlZEJvZHkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGNvbnN1bWVTZW1pY29sb24oKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogU3ludGF4LkV4cHJlc3Npb25TdGF0ZW1lbnQsCiAgICAgICAgICBleHByZXNzaW9uOiBleHByCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMoKSB7CiAgICAgICAgdmFyIHNvdXJjZUVsZW1lbnQsIHNvdXJjZUVsZW1lbnRzID0gW10sIHRva2VuLCBkaXJlY3RpdmUsIGZpcnN0UmVzdHJpY3RlZCwgb2xkTGFiZWxTZXQsIG9sZEluSXRlcmF0aW9uLCBvbGRJblN3aXRjaCwgb2xkSW5GdW5jdGlvbkJvZHk7CiAgICAgICAgZXhwZWN0KCJ7Iik7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLlN0cmluZ0xpdGVyYWwpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBzb3VyY2VFbGVtZW50ID0gcGFyc2VTb3VyY2VFbGVtZW50KCk7CiAgICAgICAgICBzb3VyY2VFbGVtZW50cy5wdXNoKHNvdXJjZUVsZW1lbnQpOwogICAgICAgICAgaWYgKHNvdXJjZUVsZW1lbnQuZXhwcmVzc2lvbi50eXBlICE9PSBTeW50YXguTGl0ZXJhbCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGRpcmVjdGl2ZSA9IHNsaWNlU291cmNlKHRva2VuLnJhbmdlWzBdICsgMSwgdG9rZW4ucmFuZ2VbMV0gLSAxKTsKICAgICAgICAgIGlmIChkaXJlY3RpdmUgPT09ICJ1c2Ugc3RyaWN0IikgewogICAgICAgICAgICBzdHJpY3QgPSB0cnVlOwogICAgICAgICAgICBpZiAoZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KGZpcnN0UmVzdHJpY3RlZCwgTWVzc2FnZXMuU3RyaWN0T2N0YWxMaXRlcmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFmaXJzdFJlc3RyaWN0ZWQgJiYgdG9rZW4ub2N0YWwpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvbGRMYWJlbFNldCA9IHN0YXRlLmxhYmVsU2V0OwogICAgICAgIG9sZEluSXRlcmF0aW9uID0gc3RhdGUuaW5JdGVyYXRpb247CiAgICAgICAgb2xkSW5Td2l0Y2ggPSBzdGF0ZS5pblN3aXRjaDsKICAgICAgICBvbGRJbkZ1bmN0aW9uQm9keSA9IHN0YXRlLmluRnVuY3Rpb25Cb2R5OwogICAgICAgIHN0YXRlLmxhYmVsU2V0ID0ge307CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSBmYWxzZTsKICAgICAgICBzdGF0ZS5pblN3aXRjaCA9IGZhbHNlOwogICAgICAgIHN0YXRlLmluRnVuY3Rpb25Cb2R5ID0gdHJ1ZTsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChtYXRjaCgifSIpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgc291cmNlRWxlbWVudCA9IHBhcnNlU291cmNlRWxlbWVudCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VFbGVtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgifSIpOwogICAgICAgIHN0YXRlLmxhYmVsU2V0ID0gb2xkTGFiZWxTZXQ7CiAgICAgICAgc3RhdGUuaW5JdGVyYXRpb24gPSBvbGRJbkl0ZXJhdGlvbjsKICAgICAgICBzdGF0ZS5pblN3aXRjaCA9IG9sZEluU3dpdGNoOwogICAgICAgIHN0YXRlLmluRnVuY3Rpb25Cb2R5ID0gb2xkSW5GdW5jdGlvbkJvZHk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5CbG9ja1N0YXRlbWVudCwKICAgICAgICAgIGJvZHk6IHNvdXJjZUVsZW1lbnRzCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24oKSB7CiAgICAgICAgdmFyIGlkLCBwYXJhbSwgcGFyYW1zID0gW10sIGJvZHksIHRva2VuLCBzdHJpY3RlZCwgZmlyc3RSZXN0cmljdGVkLCBtZXNzYWdlLCBwcmV2aW91c1N0cmljdCwgcGFyYW1TZXQ7CiAgICAgICAgZXhwZWN0S2V5d29yZCgiZnVuY3Rpb24iKTsKICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlkID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICBpZiAoc3RyaWN0KSB7CiAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmICghbWF0Y2goIikiKSkgewogICAgICAgICAgcGFyYW1TZXQgPSB7fTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1OYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtU2V0LCB0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RQYXJhbU5hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1TZXQsIHRva2VuLnZhbHVlKSkgewogICAgICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICAgIHBhcmFtU2V0W3BhcmFtLm5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcHJldmlvdXNTdHJpY3QgPSBzdHJpY3Q7CiAgICAgICAgYm9keSA9IHBhcnNlRnVuY3Rpb25Tb3VyY2VFbGVtZW50cygpOwogICAgICAgIGlmIChzdHJpY3QgJiYgZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKGZpcnN0UmVzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpY3QgJiYgc3RyaWN0ZWQpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudChzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25EZWNsYXJhdGlvbiwKICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgICAgZGVmYXVsdHM6IFtdLAogICAgICAgICAgYm9keTogYm9keSwKICAgICAgICAgIHJlc3Q6IG51bGwsCiAgICAgICAgICBnZW5lcmF0b3I6IGZhbHNlLAogICAgICAgICAgZXhwcmVzc2lvbjogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRnVuY3Rpb25FeHByZXNzaW9uKCkgewogICAgICAgIHZhciB0b2tlbiwgaWQgPSBudWxsLCBzdHJpY3RlZCwgZmlyc3RSZXN0cmljdGVkLCBtZXNzYWdlLCBwYXJhbSwgcGFyYW1zID0gW10sIGJvZHksIHByZXZpb3VzU3RyaWN0LCBwYXJhbVNldDsKICAgICAgICBleHBlY3RLZXl3b3JkKCJmdW5jdGlvbiIpOwogICAgICAgIGlmICghbWF0Y2goIigiKSkgewogICAgICAgICAgdG9rZW4gPSBsb29rYWhlYWQoKTsKICAgICAgICAgIGlkID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgdGhyb3dFcnJvclRvbGVyYW50KHRva2VuLCBNZXNzYWdlcy5TdHJpY3RGdW5jdGlvbk5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0RnVuY3Rpb25OYW1lOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaWN0TW9kZVJlc2VydmVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UmVzZXJ2ZWRXb3JkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGlmICghbWF0Y2goIikiKSkgewogICAgICAgICAgcGFyYW1TZXQgPSB7fTsKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgICAgICBwYXJhbSA9IHBhcnNlVmFyaWFibGVJZGVudGlmaWVyKCk7CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsKICAgICAgICAgICAgICBpZiAoaXNSZXN0cmljdGVkV29yZCh0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1OYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtU2V0LCB0b2tlbi52YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICAgICAgaWYgKGlzUmVzdHJpY3RlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RQYXJhbU5hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N0cmljdE1vZGVSZXNlcnZlZFdvcmQodG9rZW4udmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmaXJzdFJlc3RyaWN0ZWQgPSB0b2tlbjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlcy5TdHJpY3RSZXNlcnZlZFdvcmQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1TZXQsIHRva2VuLnZhbHVlKSkgewogICAgICAgICAgICAgICAgZmlyc3RSZXN0cmljdGVkID0gdG9rZW47CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gTWVzc2FnZXMuU3RyaWN0UGFyYW1EdXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICAgIHBhcmFtU2V0W3BhcmFtLm5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKG1hdGNoKCIpIikpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBlY3QoIiwiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwZWN0KCIpIik7CiAgICAgICAgcHJldmlvdXNTdHJpY3QgPSBzdHJpY3Q7CiAgICAgICAgYm9keSA9IHBhcnNlRnVuY3Rpb25Tb3VyY2VFbGVtZW50cygpOwogICAgICAgIGlmIChzdHJpY3QgJiYgZmlyc3RSZXN0cmljdGVkKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKGZpcnN0UmVzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpY3QgJiYgc3RyaWN0ZWQpIHsKICAgICAgICAgIHRocm93RXJyb3JUb2xlcmFudChzdHJpY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfQogICAgICAgIHN0cmljdCA9IHByZXZpb3VzU3RyaWN0OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguRnVuY3Rpb25FeHByZXNzaW9uLAogICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICBkZWZhdWx0czogW10sCiAgICAgICAgICBib2R5OiBib2R5LAogICAgICAgICAgcmVzdDogbnVsbCwKICAgICAgICAgIGdlbmVyYXRvcjogZmFsc2UsCiAgICAgICAgICBleHByZXNzaW9uOiBmYWxzZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VTb3VyY2VFbGVtZW50KCkgewogICAgICAgIHZhciB0b2tlbiA9IGxvb2thaGVhZCgpOwogICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbi5LZXl3b3JkKSB7CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImNvbnN0IjoKICAgICAgICAgICAgY2FzZSAibGV0IjoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VDb25zdExldERlY2xhcmF0aW9uKHRva2VuLnZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgIHJldHVybiBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24oKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VTdGF0ZW1lbnQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuLkVPRikgewogICAgICAgICAgcmV0dXJuIHBhcnNlU3RhdGVtZW50KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlU291cmNlRWxlbWVudHMoKSB7CiAgICAgICAgdmFyIHNvdXJjZUVsZW1lbnQsIHNvdXJjZUVsZW1lbnRzID0gW10sIHRva2VuLCBkaXJlY3RpdmUsIGZpcnN0UmVzdHJpY3RlZDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHRva2VuID0gbG9va2FoZWFkKCk7CiAgICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uU3RyaW5nTGl0ZXJhbCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnQgPSBwYXJzZVNvdXJjZUVsZW1lbnQoKTsKICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgICBpZiAoc291cmNlRWxlbWVudC5leHByZXNzaW9uLnR5cGUgIT09IFN5bnRheC5MaXRlcmFsKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgZGlyZWN0aXZlID0gc2xpY2VTb3VyY2UodG9rZW4ucmFuZ2VbMF0gKyAxLCB0b2tlbi5yYW5nZVsxXSAtIDEpOwogICAgICAgICAgaWYgKGRpcmVjdGl2ZSA9PT0gInVzZSBzdHJpY3QiKSB7CiAgICAgICAgICAgIHN0cmljdCA9IHRydWU7CiAgICAgICAgICAgIGlmIChmaXJzdFJlc3RyaWN0ZWQpIHsKICAgICAgICAgICAgICB0aHJvd0Vycm9yVG9sZXJhbnQoZmlyc3RSZXN0cmljdGVkLCBNZXNzYWdlcy5TdHJpY3RPY3RhbExpdGVyYWwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWZpcnN0UmVzdHJpY3RlZCAmJiB0b2tlbi5vY3RhbCkgewogICAgICAgICAgICAgIGZpcnN0UmVzdHJpY3RlZCA9IHRva2VuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgc291cmNlRWxlbWVudCA9IHBhcnNlU291cmNlRWxlbWVudCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VFbGVtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHNvdXJjZUVsZW1lbnRzLnB1c2goc291cmNlRWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzb3VyY2VFbGVtZW50czsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVByb2dyYW0oKSB7CiAgICAgICAgdmFyIHByb2dyYW07CiAgICAgICAgc3RyaWN0ID0gZmFsc2U7CiAgICAgICAgcHJvZ3JhbSA9IHsKICAgICAgICAgIHR5cGU6IFN5bnRheC5Qcm9ncmFtLAogICAgICAgICAgYm9keTogcGFyc2VTb3VyY2VFbGVtZW50cygpCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gcHJvZ3JhbTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRDb21tZW50KHR5cGUsIHZhbHVlLCBzdGFydCwgZW5kLCBsb2MpIHsKICAgICAgICBhc3NlcnQodHlwZW9mIHN0YXJ0ID09PSAibnVtYmVyIiwgIkNvbW1lbnQgbXVzdCBoYXZlIHZhbGlkIHBvc2l0aW9uIik7CiAgICAgICAgaWYgKGV4dHJhLmNvbW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGlmIChleHRyYS5jb21tZW50c1tleHRyYS5jb21tZW50cy5sZW5ndGggLSAxXS5yYW5nZVsxXSA+IHN0YXJ0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0cmEuY29tbWVudHMucHVzaCh7CiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgcmFuZ2U6IFsgc3RhcnQsIGVuZCBdLAogICAgICAgICAgbG9jOiBsb2MKICAgICAgICB9KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzY2FuQ29tbWVudCgpIHsKICAgICAgICB2YXIgY29tbWVudCwgY2gsIGxvYywgc3RhcnQsIGJsb2NrQ29tbWVudCwgbGluZUNvbW1lbnQ7CiAgICAgICAgY29tbWVudCA9ICIiOwogICAgICAgIGJsb2NrQ29tbWVudCA9IGZhbHNlOwogICAgICAgIGxpbmVDb21tZW50ID0gZmFsc2U7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBjaCA9IHNvdXJjZVtpbmRleF07CiAgICAgICAgICBpZiAobGluZUNvbW1lbnQpIHsKICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXgrK107CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydCAtIDEKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgYWRkQ29tbWVudCgiTGluZSIsIGNvbW1lbnQsIHN0YXJ0LCBpbmRleCAtIDEsIGxvYyk7CiAgICAgICAgICAgICAgaWYgKGNoID09PSAiXHIiICYmIHNvdXJjZVtpbmRleF0gPT09ICJcbiIpIHsKICAgICAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICsrbGluZU51bWJlcjsKICAgICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBjb21tZW50ID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICBjb21tZW50ICs9IGNoOwogICAgICAgICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgY29sdW1uOiBsZW5ndGggLSBsaW5lU3RhcnQKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGFkZENvbW1lbnQoIkxpbmUiLCBjb21tZW50LCBzdGFydCwgbGVuZ3RoLCBsb2MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1lbnQgKz0gY2g7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tDb21tZW50KSB7CiAgICAgICAgICAgIGlmIChpc0xpbmVUZXJtaW5hdG9yKGNoKSkgewogICAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXggKyAxXSA9PT0gIlxuIikgewogICAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICAgIGNvbW1lbnQgKz0gIlxyXG4iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21tZW50ICs9IGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICArK2xpbmVOdW1iZXI7CiAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgICBsaW5lU3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKHt9LCBNZXNzYWdlcy5VbmV4cGVjdGVkVG9rZW4sICJJTExFR0FMIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4KytdOwogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3Ioe30sIE1lc3NhZ2VzLlVuZXhwZWN0ZWRUb2tlbiwgIklMTEVHQUwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWVudCArPSBjaDsKICAgICAgICAgICAgICBpZiAoY2ggPT09ICIqIikgewogICAgICAgICAgICAgICAgY2ggPSBzb3VyY2VbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKGNoID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgY29tbWVudCA9IGNvbW1lbnQuc3Vic3RyKDAsIGNvbW1lbnQubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrQ29tbWVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICAgICAgICBsb2MuZW5kID0gewogICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBhZGRDb21tZW50KCJCbG9jayIsIGNvbW1lbnQsIHN0YXJ0LCBpbmRleCwgbG9jKTsKICAgICAgICAgICAgICAgICAgY29tbWVudCA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgIGNoID0gc291cmNlW2luZGV4ICsgMV07CiAgICAgICAgICAgIGlmIChjaCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgbG9jID0gewogICAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgIGxpbmVDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBsb2MuZW5kID0gewogICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgbGluZUNvbW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGFkZENvbW1lbnQoIkxpbmUiLCBjb21tZW50LCBzdGFydCwgaW5kZXgsIGxvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiKiIpIHsKICAgICAgICAgICAgICBzdGFydCA9IGluZGV4OwogICAgICAgICAgICAgIGluZGV4ICs9IDI7CiAgICAgICAgICAgICAgYmxvY2tDb21tZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2MgPSB7CiAgICAgICAgICAgICAgICBzdGFydDogewogICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0IC0gMgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcih7fSwgTWVzc2FnZXMuVW5leHBlY3RlZFRva2VuLCAiSUxMRUdBTCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc1doaXRlU3BhY2UoY2gpKSB7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzTGluZVRlcm1pbmF0b3IoY2gpKSB7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGlmIChjaCA9PT0gIlxyIiAmJiBzb3VyY2VbaW5kZXhdID09PSAiXG4iKSB7CiAgICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICArK2xpbmVOdW1iZXI7CiAgICAgICAgICAgIGxpbmVTdGFydCA9IGluZGV4OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZpbHRlckNvbW1lbnRMb2NhdGlvbigpIHsKICAgICAgICB2YXIgaSwgZW50cnksIGNvbW1lbnQsIGNvbW1lbnRzID0gW107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV4dHJhLmNvbW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBlbnRyeSA9IGV4dHJhLmNvbW1lbnRzW2ldOwogICAgICAgICAgY29tbWVudCA9IHsKICAgICAgICAgICAgdHlwZTogZW50cnkudHlwZSwKICAgICAgICAgICAgdmFsdWU6IGVudHJ5LnZhbHVlCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGV4dHJhLnJhbmdlKSB7CiAgICAgICAgICAgIGNvbW1lbnQucmFuZ2UgPSBlbnRyeS5yYW5nZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRyYS5sb2MpIHsKICAgICAgICAgICAgY29tbWVudC5sb2MgPSBlbnRyeS5sb2M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21tZW50cy5wdXNoKGNvbW1lbnQpOwogICAgICAgIH0KICAgICAgICBleHRyYS5jb21tZW50cyA9IGNvbW1lbnRzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbGxlY3RUb2tlbigpIHsKICAgICAgICB2YXIgc3RhcnQsIGxvYywgdG9rZW4sIHJhbmdlLCB2YWx1ZTsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgbG9jID0gewogICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdG9rZW4gPSBleHRyYS5hZHZhbmNlKCk7CiAgICAgICAgbG9jLmVuZCA9IHsKICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICBjb2x1bW46IGluZGV4IC0gbGluZVN0YXJ0CiAgICAgICAgfTsKICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW4uRU9GKSB7CiAgICAgICAgICByYW5nZSA9IFsgdG9rZW4ucmFuZ2VbMF0sIHRva2VuLnJhbmdlWzFdIF07CiAgICAgICAgICB2YWx1ZSA9IHNsaWNlU291cmNlKHRva2VuLnJhbmdlWzBdLCB0b2tlbi5yYW5nZVsxXSk7CiAgICAgICAgICBleHRyYS50b2tlbnMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6IFRva2VuTmFtZVt0b2tlbi50eXBlXSwKICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICByYW5nZTogcmFuZ2UsCiAgICAgICAgICAgIGxvYzogbG9jCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbGxlY3RSZWdleCgpIHsKICAgICAgICB2YXIgcG9zLCBsb2MsIHJlZ2V4LCB0b2tlbjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIHBvcyA9IGluZGV4OwogICAgICAgIGxvYyA9IHsKICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbHVtbjogaW5kZXggLSBsaW5lU3RhcnQKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlZ2V4ID0gZXh0cmEuc2NhblJlZ0V4cCgpOwogICAgICAgIGxvYy5lbmQgPSB7CiAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLAogICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgIH07CiAgICAgICAgaWYgKGV4dHJhLnRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0b2tlbiA9IGV4dHJhLnRva2Vuc1tleHRyYS50b2tlbnMubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAodG9rZW4ucmFuZ2VbMF0gPT09IHBvcyAmJiB0b2tlbi50eXBlID09PSAiUHVuY3R1YXRvciIpIHsKICAgICAgICAgICAgaWYgKHRva2VuLnZhbHVlID09PSAiLyIgfHwgdG9rZW4udmFsdWUgPT09ICIvPSIpIHsKICAgICAgICAgICAgICBleHRyYS50b2tlbnMucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0cmEudG9rZW5zLnB1c2goewogICAgICAgICAgdHlwZTogIlJlZ3VsYXJFeHByZXNzaW9uIiwKICAgICAgICAgIHZhbHVlOiByZWdleC5saXRlcmFsLAogICAgICAgICAgcmFuZ2U6IFsgcG9zLCBpbmRleCBdLAogICAgICAgICAgbG9jOiBsb2MKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVnZXg7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZmlsdGVyVG9rZW5Mb2NhdGlvbigpIHsKICAgICAgICB2YXIgaSwgZW50cnksIHRva2VuLCB0b2tlbnMgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXh0cmEudG9rZW5zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBlbnRyeSA9IGV4dHJhLnRva2Vuc1tpXTsKICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICB0eXBlOiBlbnRyeS50eXBlLAogICAgICAgICAgICB2YWx1ZTogZW50cnkudmFsdWUKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UpIHsKICAgICAgICAgICAgdG9rZW4ucmFuZ2UgPSBlbnRyeS5yYW5nZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRyYS5sb2MpIHsKICAgICAgICAgICAgdG9rZW4ubG9jID0gZW50cnkubG9jOwogICAgICAgICAgfQogICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgIH0KICAgICAgICBleHRyYS50b2tlbnMgPSB0b2tlbnM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlTGl0ZXJhbCh0b2tlbikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiB0b2tlbi52YWx1ZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlUmF3TGl0ZXJhbCh0b2tlbikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiBTeW50YXguTGl0ZXJhbCwKICAgICAgICAgIHZhbHVlOiB0b2tlbi52YWx1ZSwKICAgICAgICAgIHJhdzogc2xpY2VTb3VyY2UodG9rZW4ucmFuZ2VbMF0sIHRva2VuLnJhbmdlWzFdKQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlTG9jYXRpb25NYXJrZXIoKSB7CiAgICAgICAgdmFyIG1hcmtlciA9IHt9OwogICAgICAgIG1hcmtlci5yYW5nZSA9IFsgaW5kZXgsIGluZGV4IF07CiAgICAgICAgbWFya2VyLmxvYyA9IHsKICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbHVtbjogaW5kZXggLSBsaW5lU3RhcnQKICAgICAgICAgIH0sCiAgICAgICAgICBlbmQ6IHsKICAgICAgICAgICAgbGluZTogbGluZU51bWJlciwKICAgICAgICAgICAgY29sdW1uOiBpbmRleCAtIGxpbmVTdGFydAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbWFya2VyLmVuZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5yYW5nZVsxXSA9IGluZGV4OwogICAgICAgICAgdGhpcy5sb2MuZW5kLmxpbmUgPSBsaW5lTnVtYmVyOwogICAgICAgICAgdGhpcy5sb2MuZW5kLmNvbHVtbiA9IGluZGV4IC0gbGluZVN0YXJ0OwogICAgICAgIH07CiAgICAgICAgbWFya2VyLmFwcGx5R3JvdXAgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UpIHsKICAgICAgICAgICAgbm9kZS5ncm91cFJhbmdlID0gWyB0aGlzLnJhbmdlWzBdLCB0aGlzLnJhbmdlWzFdIF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEubG9jKSB7CiAgICAgICAgICAgIG5vZGUuZ3JvdXBMb2MgPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgIGxpbmU6IHRoaXMubG9jLnN0YXJ0LmxpbmUsCiAgICAgICAgICAgICAgICBjb2x1bW46IHRoaXMubG9jLnN0YXJ0LmNvbHVtbgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZW5kOiB7CiAgICAgICAgICAgICAgICBsaW5lOiB0aGlzLmxvYy5lbmQubGluZSwKICAgICAgICAgICAgICAgIGNvbHVtbjogdGhpcy5sb2MuZW5kLmNvbHVtbgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIG1hcmtlci5hcHBseSA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIGlmIChleHRyYS5yYW5nZSkgewogICAgICAgICAgICBub2RlLnJhbmdlID0gWyB0aGlzLnJhbmdlWzBdLCB0aGlzLnJhbmdlWzFdIF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEubG9jKSB7CiAgICAgICAgICAgIG5vZGUubG9jID0gewogICAgICAgICAgICAgIHN0YXJ0OiB7CiAgICAgICAgICAgICAgICBsaW5lOiB0aGlzLmxvYy5zdGFydC5saW5lLAogICAgICAgICAgICAgICAgY29sdW1uOiB0aGlzLmxvYy5zdGFydC5jb2x1bW4KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGVuZDogewogICAgICAgICAgICAgICAgbGluZTogdGhpcy5sb2MuZW5kLmxpbmUsCiAgICAgICAgICAgICAgICBjb2x1bW46IHRoaXMubG9jLmVuZC5jb2x1bW4KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbWFya2VyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRyYWNrR3JvdXBFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBtYXJrZXIsIGV4cHI7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBtYXJrZXIgPSBjcmVhdGVMb2NhdGlvbk1hcmtlcigpOwogICAgICAgIGV4cGVjdCgiKCIpOwogICAgICAgIGV4cHIgPSBwYXJzZUV4cHJlc3Npb24oKTsKICAgICAgICBleHBlY3QoIikiKTsKICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgbWFya2VyLmFwcGx5R3JvdXAoZXhwcik7CiAgICAgICAgcmV0dXJuIGV4cHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uKCkgewogICAgICAgIHZhciBtYXJrZXIsIGV4cHI7CiAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICBtYXJrZXIgPSBjcmVhdGVMb2NhdGlvbk1hcmtlcigpOwogICAgICAgIGV4cHIgPSBtYXRjaEtleXdvcmQoIm5ldyIpID8gcGFyc2VOZXdFeHByZXNzaW9uKCkgOiBwYXJzZVByaW1hcnlFeHByZXNzaW9uKCk7CiAgICAgICAgd2hpbGUgKG1hdGNoKCIuIikgfHwgbWF0Y2goIlsiKSkgewogICAgICAgICAgaWYgKG1hdGNoKCJbIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguTWVtYmVyRXhwcmVzc2lvbiwKICAgICAgICAgICAgICBjb21wdXRlZDogdHJ1ZSwKICAgICAgICAgICAgICBvYmplY3Q6IGV4cHIsCiAgICAgICAgICAgICAgcHJvcGVydHk6IHBhcnNlQ29tcHV0ZWRNZW1iZXIoKQogICAgICAgICAgICB9OwogICAgICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgICAgIG1hcmtlci5hcHBseShleHByKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1hcmtlci5lbmQoKTsKICAgICAgICAgICAgbWFya2VyLmFwcGx5KGV4cHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0cmFja0xlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwoKSB7CiAgICAgICAgdmFyIG1hcmtlciwgZXhwcjsKICAgICAgICBza2lwQ29tbWVudCgpOwogICAgICAgIG1hcmtlciA9IGNyZWF0ZUxvY2F0aW9uTWFya2VyKCk7CiAgICAgICAgZXhwciA9IG1hdGNoS2V5d29yZCgibmV3IikgPyBwYXJzZU5ld0V4cHJlc3Npb24oKSA6IHBhcnNlUHJpbWFyeUV4cHJlc3Npb24oKTsKICAgICAgICB3aGlsZSAobWF0Y2goIi4iKSB8fCBtYXRjaCgiWyIpIHx8IG1hdGNoKCIoIikpIHsKICAgICAgICAgIGlmIChtYXRjaCgiKCIpKSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4LkNhbGxFeHByZXNzaW9uLAogICAgICAgICAgICAgIGNhbGxlZTogZXhwciwKICAgICAgICAgICAgICBhcmd1bWVudHM6IHBhcnNlQXJndW1lbnRzKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbWFya2VyLmVuZCgpOwogICAgICAgICAgICBtYXJrZXIuYXBwbHkoZXhwcik7CiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoKCJbIikpIHsKICAgICAgICAgICAgZXhwciA9IHsKICAgICAgICAgICAgICB0eXBlOiBTeW50YXguTWVtYmVyRXhwcmVzc2lvbiwKICAgICAgICAgICAgICBjb21wdXRlZDogdHJ1ZSwKICAgICAgICAgICAgICBvYmplY3Q6IGV4cHIsCiAgICAgICAgICAgICAgcHJvcGVydHk6IHBhcnNlQ29tcHV0ZWRNZW1iZXIoKQogICAgICAgICAgICB9OwogICAgICAgICAgICBtYXJrZXIuZW5kKCk7CiAgICAgICAgICAgIG1hcmtlci5hcHBseShleHByKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4cHIgPSB7CiAgICAgICAgICAgICAgdHlwZTogU3ludGF4Lk1lbWJlckV4cHJlc3Npb24sCiAgICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIG9iamVjdDogZXhwciwKICAgICAgICAgICAgICBwcm9wZXJ0eTogcGFyc2VOb25Db21wdXRlZE1lbWJlcigpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1hcmtlci5lbmQoKTsKICAgICAgICAgICAgbWFya2VyLmFwcGx5KGV4cHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgfQogICAgICBmdW5jdGlvbiBmaWx0ZXJHcm91cChub2RlKSB7CiAgICAgICAgdmFyIG4sIGksIGVudHJ5OwogICAgICAgIG4gPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KG5vZGUpID09PSAiW29iamVjdCBBcnJheV0iID8gW10gOiB7fTsKICAgICAgICBmb3IgKGkgaW4gbm9kZSkgewogICAgICAgICAgaWYgKG5vZGUuaGFzT3duUHJvcGVydHkoaSkgJiYgaSAhPT0gImdyb3VwUmFuZ2UiICYmIGkgIT09ICJncm91cExvYyIpIHsKICAgICAgICAgICAgZW50cnkgPSBub2RlW2ldOwogICAgICAgICAgICBpZiAoZW50cnkgPT09IG51bGwgfHwgdHlwZW9mIGVudHJ5ICE9PSAib2JqZWN0IiB8fCBlbnRyeSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICAgIG5baV0gPSBlbnRyeTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuW2ldID0gZmlsdGVyR3JvdXAoZW50cnkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHdyYXBUcmFja2luZ0Z1bmN0aW9uKHJhbmdlLCBsb2MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocGFyc2VGdW5jdGlvbikgewogICAgICAgICAgZnVuY3Rpb24gaXNCaW5hcnkobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS50eXBlID09PSBTeW50YXguTG9naWNhbEV4cHJlc3Npb24gfHwgbm9kZS50eXBlID09PSBTeW50YXguQmluYXJ5RXhwcmVzc2lvbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHZpc2l0KG5vZGUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0LCBlbmQ7CiAgICAgICAgICAgIGlmIChpc0JpbmFyeShub2RlLmxlZnQpKSB7CiAgICAgICAgICAgICAgdmlzaXQobm9kZS5sZWZ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCaW5hcnkobm9kZS5yaWdodCkpIHsKICAgICAgICAgICAgICB2aXNpdChub2RlLnJpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmFuZ2UpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5sZWZ0Lmdyb3VwUmFuZ2UgfHwgbm9kZS5yaWdodC5ncm91cFJhbmdlKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IG5vZGUubGVmdC5ncm91cFJhbmdlID8gbm9kZS5sZWZ0Lmdyb3VwUmFuZ2VbMF0gOiBub2RlLmxlZnQucmFuZ2VbMF07CiAgICAgICAgICAgICAgICBlbmQgPSBub2RlLnJpZ2h0Lmdyb3VwUmFuZ2UgPyBub2RlLnJpZ2h0Lmdyb3VwUmFuZ2VbMV0gOiBub2RlLnJpZ2h0LnJhbmdlWzFdOwogICAgICAgICAgICAgICAgbm9kZS5yYW5nZSA9IFsgc3RhcnQsIGVuZCBdOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5vZGUucmFuZ2UgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IG5vZGUubGVmdC5yYW5nZVswXTsKICAgICAgICAgICAgICAgIGVuZCA9IG5vZGUucmlnaHQucmFuZ2VbMV07CiAgICAgICAgICAgICAgICBub2RlLnJhbmdlID0gWyBzdGFydCwgZW5kIF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb2MpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5sZWZ0Lmdyb3VwTG9jIHx8IG5vZGUucmlnaHQuZ3JvdXBMb2MpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbm9kZS5sZWZ0Lmdyb3VwTG9jID8gbm9kZS5sZWZ0Lmdyb3VwTG9jLnN0YXJ0IDogbm9kZS5sZWZ0LmxvYy5zdGFydDsKICAgICAgICAgICAgICAgIGVuZCA9IG5vZGUucmlnaHQuZ3JvdXBMb2MgPyBub2RlLnJpZ2h0Lmdyb3VwTG9jLmVuZCA6IG5vZGUucmlnaHQubG9jLmVuZDsKICAgICAgICAgICAgICAgIG5vZGUubG9jID0gewogICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgICAgICAgIGVuZDogZW5kCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5vZGUubG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgbm9kZS5sb2MgPSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLmxlZnQubG9jLnN0YXJ0LAogICAgICAgICAgICAgICAgICBlbmQ6IG5vZGUucmlnaHQubG9jLmVuZAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG1hcmtlciwgbm9kZTsKICAgICAgICAgICAgc2tpcENvbW1lbnQoKTsKICAgICAgICAgICAgbWFya2VyID0gY3JlYXRlTG9jYXRpb25NYXJrZXIoKTsKICAgICAgICAgICAgbm9kZSA9IHBhcnNlRnVuY3Rpb24uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgbWFya2VyLmVuZCgpOwogICAgICAgICAgICBpZiAocmFuZ2UgJiYgdHlwZW9mIG5vZGUucmFuZ2UgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgbWFya2VyLmFwcGx5KG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb2MgJiYgdHlwZW9mIG5vZGUubG9jID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG1hcmtlci5hcHBseShub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNCaW5hcnkobm9kZSkpIHsKICAgICAgICAgICAgICB2aXNpdChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXRjaCgpIHsKICAgICAgICB2YXIgd3JhcFRyYWNraW5nOwogICAgICAgIGlmIChleHRyYS5jb21tZW50cykgewogICAgICAgICAgZXh0cmEuc2tpcENvbW1lbnQgPSBza2lwQ29tbWVudDsKICAgICAgICAgIHNraXBDb21tZW50ID0gc2NhbkNvbW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChleHRyYS5yYXcpIHsKICAgICAgICAgIGV4dHJhLmNyZWF0ZUxpdGVyYWwgPSBjcmVhdGVMaXRlcmFsOwogICAgICAgICAgY3JlYXRlTGl0ZXJhbCA9IGNyZWF0ZVJhd0xpdGVyYWw7CiAgICAgICAgfQogICAgICAgIGlmIChleHRyYS5yYW5nZSB8fCBleHRyYS5sb2MpIHsKICAgICAgICAgIGV4dHJhLnBhcnNlR3JvdXBFeHByZXNzaW9uID0gcGFyc2VHcm91cEV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwgPSBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGw7CiAgICAgICAgICBwYXJzZUdyb3VwRXhwcmVzc2lvbiA9IHRyYWNrR3JvdXBFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uID0gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uQWxsb3dDYWxsID0gdHJhY2tMZWZ0SGFuZFNpZGVFeHByZXNzaW9uQWxsb3dDYWxsOwogICAgICAgICAgd3JhcFRyYWNraW5nID0gd3JhcFRyYWNraW5nRnVuY3Rpb24oZXh0cmEucmFuZ2UsIGV4dHJhLmxvYyk7CiAgICAgICAgICBleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbiA9IHBhcnNlQWRkaXRpdmVFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VBc3NpZ25tZW50RXhwcmVzc2lvbiA9IHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUJpdHdpc2VBTkRFeHByZXNzaW9uID0gcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbiA9IHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQml0d2lzZVhPUkV4cHJlc3Npb24gPSBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VCbG9jayA9IHBhcnNlQmxvY2s7CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMgPSBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHM7CiAgICAgICAgICBleHRyYS5wYXJzZUNhdGNoQ2xhdXNlID0gcGFyc2VDYXRjaENsYXVzZTsKICAgICAgICAgIGV4dHJhLnBhcnNlQ29tcHV0ZWRNZW1iZXIgPSBwYXJzZUNvbXB1dGVkTWVtYmVyOwogICAgICAgICAgZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24gPSBwYXJzZUNvbmRpdGlvbmFsRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbiA9IHBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlRXF1YWxpdHlFeHByZXNzaW9uID0gcGFyc2VFcXVhbGl0eUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUV4cHJlc3Npb24gPSBwYXJzZUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24gPSBwYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb247CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb24gPSBwYXJzZUZ1bmN0aW9uRGVjbGFyYXRpb247CiAgICAgICAgICBleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbiA9IHBhcnNlRnVuY3Rpb25FeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbiA9IHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24gPSBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZU11bHRpcGxpY2F0aXZlRXhwcmVzc2lvbiA9IHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VOZXdFeHByZXNzaW9uID0gcGFyc2VOZXdFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VOb25Db21wdXRlZFByb3BlcnR5ID0gcGFyc2VOb25Db21wdXRlZFByb3BlcnR5OwogICAgICAgICAgZXh0cmEucGFyc2VPYmplY3RQcm9wZXJ0eSA9IHBhcnNlT2JqZWN0UHJvcGVydHk7CiAgICAgICAgICBleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5ID0gcGFyc2VPYmplY3RQcm9wZXJ0eUtleTsKICAgICAgICAgIGV4dHJhLnBhcnNlUG9zdGZpeEV4cHJlc3Npb24gPSBwYXJzZVBvc3RmaXhFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VQcmltYXJ5RXhwcmVzc2lvbiA9IHBhcnNlUHJpbWFyeUV4cHJlc3Npb247CiAgICAgICAgICBleHRyYS5wYXJzZVByb2dyYW0gPSBwYXJzZVByb2dyYW07CiAgICAgICAgICBleHRyYS5wYXJzZVByb3BlcnR5RnVuY3Rpb24gPSBwYXJzZVByb3BlcnR5RnVuY3Rpb247CiAgICAgICAgICBleHRyYS5wYXJzZVJlbGF0aW9uYWxFeHByZXNzaW9uID0gcGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlU3RhdGVtZW50ID0gcGFyc2VTdGF0ZW1lbnQ7CiAgICAgICAgICBleHRyYS5wYXJzZVNoaWZ0RXhwcmVzc2lvbiA9IHBhcnNlU2hpZnRFeHByZXNzaW9uOwogICAgICAgICAgZXh0cmEucGFyc2VTd2l0Y2hDYXNlID0gcGFyc2VTd2l0Y2hDYXNlOwogICAgICAgICAgZXh0cmEucGFyc2VVbmFyeUV4cHJlc3Npb24gPSBwYXJzZVVuYXJ5RXhwcmVzc2lvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbiA9IHBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbjsKICAgICAgICAgIGV4dHJhLnBhcnNlVmFyaWFibGVJZGVudGlmaWVyID0gcGFyc2VWYXJpYWJsZUlkZW50aWZpZXI7CiAgICAgICAgICBwYXJzZUFkZGl0aXZlRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VBTkRFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlQml0d2lzZU9SRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VCaXR3aXNlWE9SRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlQmxvY2sgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VCbG9jayk7CiAgICAgICAgICBwYXJzZUZ1bmN0aW9uU291cmNlRWxlbWVudHMgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzKTsKICAgICAgICAgIHBhcnNlQ2F0Y2hDbGF1c2UgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VDYXRjaENsYXVzZSk7CiAgICAgICAgICBwYXJzZUNvbXB1dGVkTWVtYmVyID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQ29tcHV0ZWRNZW1iZXIpOwogICAgICAgICAgcGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VDb25zdExldERlY2xhcmF0aW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlQ29uc3RMZXREZWNsYXJhdGlvbik7CiAgICAgICAgICBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUVxdWFsaXR5RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlRm9yVmFyaWFibGVEZWNsYXJhdGlvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUZvclZhcmlhYmxlRGVjbGFyYXRpb24pOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlRnVuY3Rpb25EZWNsYXJhdGlvbik7CiAgICAgICAgICBwYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcocGFyc2VMZWZ0SGFuZFNpZGVFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTG9naWNhbEFOREV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZUxvZ2ljYWxPUkV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VMb2dpY2FsT1JFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlTmV3RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZU5ld0V4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VOb25Db21wdXRlZFByb3BlcnR5ID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlTm9uQ29tcHV0ZWRQcm9wZXJ0eSk7CiAgICAgICAgICBwYXJzZU9iamVjdFByb3BlcnR5ID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlT2JqZWN0UHJvcGVydHkpOwogICAgICAgICAgcGFyc2VPYmplY3RQcm9wZXJ0eUtleSA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5KTsKICAgICAgICAgIHBhcnNlUG9zdGZpeEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VQb3N0Zml4RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVByaW1hcnlFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlUHJpbWFyeUV4cHJlc3Npb24pOwogICAgICAgICAgcGFyc2VQcm9ncmFtID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlUHJvZ3JhbSk7CiAgICAgICAgICBwYXJzZVByb3BlcnR5RnVuY3Rpb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VQcm9wZXJ0eUZ1bmN0aW9uKTsKICAgICAgICAgIHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24gPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VSZWxhdGlvbmFsRXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVN0YXRlbWVudCA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVN0YXRlbWVudCk7CiAgICAgICAgICBwYXJzZVNoaWZ0RXhwcmVzc2lvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVNoaWZ0RXhwcmVzc2lvbik7CiAgICAgICAgICBwYXJzZVN3aXRjaENhc2UgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VTd2l0Y2hDYXNlKTsKICAgICAgICAgIHBhcnNlVW5hcnlFeHByZXNzaW9uID0gd3JhcFRyYWNraW5nKGV4dHJhLnBhcnNlVW5hcnlFeHByZXNzaW9uKTsKICAgICAgICAgIHBhcnNlVmFyaWFibGVEZWNsYXJhdGlvbiA9IHdyYXBUcmFja2luZyhleHRyYS5wYXJzZVZhcmlhYmxlRGVjbGFyYXRpb24pOwogICAgICAgICAgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIgPSB3cmFwVHJhY2tpbmcoZXh0cmEucGFyc2VWYXJpYWJsZUlkZW50aWZpZXIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGV4dHJhLnRva2VucyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGV4dHJhLmFkdmFuY2UgPSBhZHZhbmNlOwogICAgICAgICAgZXh0cmEuc2NhblJlZ0V4cCA9IHNjYW5SZWdFeHA7CiAgICAgICAgICBhZHZhbmNlID0gY29sbGVjdFRva2VuOwogICAgICAgICAgc2NhblJlZ0V4cCA9IGNvbGxlY3RSZWdleDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdW5wYXRjaCgpIHsKICAgICAgICBpZiAodHlwZW9mIGV4dHJhLnNraXBDb21tZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBza2lwQ29tbWVudCA9IGV4dHJhLnNraXBDb21tZW50OwogICAgICAgIH0KICAgICAgICBpZiAoZXh0cmEucmF3KSB7CiAgICAgICAgICBjcmVhdGVMaXRlcmFsID0gZXh0cmEuY3JlYXRlTGl0ZXJhbDsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dHJhLnJhbmdlIHx8IGV4dHJhLmxvYykgewogICAgICAgICAgcGFyc2VBZGRpdGl2ZUV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUFkZGl0aXZlRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlQXNzaWdubWVudEV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUFzc2lnbm1lbnRFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VCaXR3aXNlQU5ERXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlQml0d2lzZUFOREV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUJpdHdpc2VPUkV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUJpdHdpc2VPUkV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUJpdHdpc2VYT1JFeHByZXNzaW9uID0gZXh0cmEucGFyc2VCaXR3aXNlWE9SRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlQmxvY2sgPSBleHRyYS5wYXJzZUJsb2NrOwogICAgICAgICAgcGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzID0gZXh0cmEucGFyc2VGdW5jdGlvblNvdXJjZUVsZW1lbnRzOwogICAgICAgICAgcGFyc2VDYXRjaENsYXVzZSA9IGV4dHJhLnBhcnNlQ2F0Y2hDbGF1c2U7CiAgICAgICAgICBwYXJzZUNvbXB1dGVkTWVtYmVyID0gZXh0cmEucGFyc2VDb21wdXRlZE1lbWJlcjsKICAgICAgICAgIHBhcnNlQ29uZGl0aW9uYWxFeHByZXNzaW9uID0gZXh0cmEucGFyc2VDb25kaXRpb25hbEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUNvbnN0TGV0RGVjbGFyYXRpb24gPSBleHRyYS5wYXJzZUNvbnN0TGV0RGVjbGFyYXRpb247CiAgICAgICAgICBwYXJzZUVxdWFsaXR5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlRXF1YWxpdHlFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VFeHByZXNzaW9uID0gZXh0cmEucGFyc2VFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VGb3JWYXJpYWJsZURlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VGdW5jdGlvbkRlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VGdW5jdGlvbkV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUZ1bmN0aW9uRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlR3JvdXBFeHByZXNzaW9uID0gZXh0cmEucGFyc2VHcm91cEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb24gPSBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGwgPSBleHRyYS5wYXJzZUxlZnRIYW5kU2lkZUV4cHJlc3Npb25BbGxvd0NhbGw7CiAgICAgICAgICBwYXJzZUxvZ2ljYWxBTkRFeHByZXNzaW9uID0gZXh0cmEucGFyc2VMb2dpY2FsQU5ERXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlTG9naWNhbE9SRXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlTXVsdGlwbGljYXRpdmVFeHByZXNzaW9uID0gZXh0cmEucGFyc2VNdWx0aXBsaWNhdGl2ZUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZU5ld0V4cHJlc3Npb24gPSBleHRyYS5wYXJzZU5ld0V4cHJlc3Npb247CiAgICAgICAgICBwYXJzZU5vbkNvbXB1dGVkUHJvcGVydHkgPSBleHRyYS5wYXJzZU5vbkNvbXB1dGVkUHJvcGVydHk7CiAgICAgICAgICBwYXJzZU9iamVjdFByb3BlcnR5ID0gZXh0cmEucGFyc2VPYmplY3RQcm9wZXJ0eTsKICAgICAgICAgIHBhcnNlT2JqZWN0UHJvcGVydHlLZXkgPSBleHRyYS5wYXJzZU9iamVjdFByb3BlcnR5S2V5OwogICAgICAgICAgcGFyc2VQcmltYXJ5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlUHJpbWFyeUV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZVBvc3RmaXhFeHByZXNzaW9uID0gZXh0cmEucGFyc2VQb3N0Zml4RXhwcmVzc2lvbjsKICAgICAgICAgIHBhcnNlUHJvZ3JhbSA9IGV4dHJhLnBhcnNlUHJvZ3JhbTsKICAgICAgICAgIHBhcnNlUHJvcGVydHlGdW5jdGlvbiA9IGV4dHJhLnBhcnNlUHJvcGVydHlGdW5jdGlvbjsKICAgICAgICAgIHBhcnNlUmVsYXRpb25hbEV4cHJlc3Npb24gPSBleHRyYS5wYXJzZVJlbGF0aW9uYWxFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VTdGF0ZW1lbnQgPSBleHRyYS5wYXJzZVN0YXRlbWVudDsKICAgICAgICAgIHBhcnNlU2hpZnRFeHByZXNzaW9uID0gZXh0cmEucGFyc2VTaGlmdEV4cHJlc3Npb247CiAgICAgICAgICBwYXJzZVN3aXRjaENhc2UgPSBleHRyYS5wYXJzZVN3aXRjaENhc2U7CiAgICAgICAgICBwYXJzZVVuYXJ5RXhwcmVzc2lvbiA9IGV4dHJhLnBhcnNlVW5hcnlFeHByZXNzaW9uOwogICAgICAgICAgcGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uID0gZXh0cmEucGFyc2VWYXJpYWJsZURlY2xhcmF0aW9uOwogICAgICAgICAgcGFyc2VWYXJpYWJsZUlkZW50aWZpZXIgPSBleHRyYS5wYXJzZVZhcmlhYmxlSWRlbnRpZmllcjsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBleHRyYS5zY2FuUmVnRXhwID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBhZHZhbmNlID0gZXh0cmEuYWR2YW5jZTsKICAgICAgICAgIHNjYW5SZWdFeHAgPSBleHRyYS5zY2FuUmVnRXhwOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzdHJpbmdUb0FycmF5KHN0cikgewogICAgICAgIHZhciBsZW5ndGggPSBzdHIubGVuZ3RoLCByZXN1bHQgPSBbXSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IHN0ci5jaGFyQXQoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2UoY29kZSwgb3B0aW9ucykgewogICAgICAgIHZhciBwcm9ncmFtLCB0b1N0cmluZzsKICAgICAgICB0b1N0cmluZyA9IFN0cmluZzsKICAgICAgICBpZiAodHlwZW9mIGNvZGUgIT09ICJzdHJpbmciICYmICEoY29kZSBpbnN0YW5jZW9mIFN0cmluZykpIHsKICAgICAgICAgIGNvZGUgPSB0b1N0cmluZyhjb2RlKTsKICAgICAgICB9CiAgICAgICAgc291cmNlID0gY29kZTsKICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgbGluZU51bWJlciA9IHNvdXJjZS5sZW5ndGggPiAwID8gMSA6IDA7CiAgICAgICAgbGluZVN0YXJ0ID0gMDsKICAgICAgICBsZW5ndGggPSBzb3VyY2UubGVuZ3RoOwogICAgICAgIGJ1ZmZlciA9IG51bGw7CiAgICAgICAgc3RhdGUgPSB7CiAgICAgICAgICBhbGxvd0luOiB0cnVlLAogICAgICAgICAgbGFiZWxTZXQ6IHt9LAogICAgICAgICAgaW5GdW5jdGlvbkJvZHk6IGZhbHNlLAogICAgICAgICAgaW5JdGVyYXRpb246IGZhbHNlLAogICAgICAgICAgaW5Td2l0Y2g6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICBleHRyYSA9IHt9OwogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGV4dHJhLnJhbmdlID0gdHlwZW9mIG9wdGlvbnMucmFuZ2UgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnJhbmdlOwogICAgICAgICAgZXh0cmEubG9jID0gdHlwZW9mIG9wdGlvbnMubG9jID09PSAiYm9vbGVhbiIgJiYgb3B0aW9ucy5sb2M7CiAgICAgICAgICBleHRyYS5yYXcgPSB0eXBlb2Ygb3B0aW9ucy5yYXcgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnJhdzsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy50b2tlbnMgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnRva2VucykgewogICAgICAgICAgICBleHRyYS50b2tlbnMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jb21tZW50ID09PSAiYm9vbGVhbiIgJiYgb3B0aW9ucy5jb21tZW50KSB7CiAgICAgICAgICAgIGV4dHJhLmNvbW1lbnRzID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMudG9sZXJhbnQgPT09ICJib29sZWFuIiAmJiBvcHRpb25zLnRvbGVyYW50KSB7CiAgICAgICAgICAgIGV4dHJhLmVycm9ycyA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VbMF0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGlmIChjb2RlIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgICAgICAgc291cmNlID0gY29kZS52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2VbMF0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgc291cmNlID0gc3RyaW5nVG9BcnJheShjb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwYXRjaCgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBwcm9ncmFtID0gcGFyc2VQcm9ncmFtKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGV4dHJhLmNvbW1lbnRzICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBmaWx0ZXJDb21tZW50TG9jYXRpb24oKTsKICAgICAgICAgICAgcHJvZ3JhbS5jb21tZW50cyA9IGV4dHJhLmNvbW1lbnRzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBleHRyYS50b2tlbnMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGZpbHRlclRva2VuTG9jYXRpb24oKTsKICAgICAgICAgICAgcHJvZ3JhbS50b2tlbnMgPSBleHRyYS50b2tlbnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGV4dHJhLmVycm9ycyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcHJvZ3JhbS5lcnJvcnMgPSBleHRyYS5lcnJvcnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXh0cmEucmFuZ2UgfHwgZXh0cmEubG9jKSB7CiAgICAgICAgICAgIHByb2dyYW0uYm9keSA9IGZpbHRlckdyb3VwKHByb2dyYW0uYm9keSk7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdW5wYXRjaCgpOwogICAgICAgICAgZXh0cmEgPSB7fTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW07CiAgICAgIH0KICAgICAgZXhwb3J0cy52ZXJzaW9uID0gIjEuMC40IjsKICAgICAgZXhwb3J0cy5wYXJzZSA9IHBhcnNlOwogICAgICBleHBvcnRzLlN5bnRheCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBuYW1lLCB0eXBlcyA9IHt9OwogICAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdHlwZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0KICAgICAgICBmb3IgKG5hbWUgaW4gU3ludGF4KSB7CiAgICAgICAgICBpZiAoU3ludGF4Lmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIHR5cGVzW25hbWVdID0gU3ludGF4W25hbWVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIE9iamVjdC5mcmVlemUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIE9iamVjdC5mcmVlemUodHlwZXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZXM7CiAgICAgIH0oKTsKICAgIH0pOwogIH0sCiAgInIuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgdmFyIHJ1bm5lciA9IGJhc2lzLnJlcXVpcmUoIi4vYy5qcyIpOwogICAgdmFyIFRlc3RTdWl0ZSA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpLlRlc3RTdWl0ZTsKICAgIHZhciBJdGVtID0gYmFzaXMudWkuTm9kZS5zdWJjbGFzcyh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiMyIiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBuYW1lOiAiZGF0YToiLAogICAgICAgIHByb2dyZXNzOiBbICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gMTAwICogKG5vZGUuc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HID8gbm9kZS5zdGF0ZS5kYXRhIDogMSk7CiAgICAgICAgfSBdLAogICAgICAgIHBlbmRpbmc6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCAmJiAhIW5vZGUuc3RhdGUuZGF0YS5kYXRhLnBlbmRpbmc7CiAgICAgICAgfSBdLAogICAgICAgIHN0YXRlTWVzc2FnZTogWyAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgdmFyIHJlcG9ydCA9IG5vZGUuc3RhdGUuZGF0YTsKICAgICAgICAgIHN3aXRjaCAoU3RyaW5nKG5vZGUuc3RhdGUpKSB7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5SRUFEWToKICAgICAgICAgICAgICBpZiAocmVwb3J0LmRhdGEgJiYgcmVwb3J0LmRhdGEucGVuZGluZykgcmV0dXJuICJQZW5kaW5nIjsKICAgICAgICAgICAgICByZXR1cm4gIk9LIjsKICAgICAgICAgICAgY2FzZSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SOgogICAgICAgICAgICAgIGlmIChyZXBvcnQgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCA9PSBmYWxzZSkgcmV0dXJuICJFcnJvciI7CiAgICAgICAgICAgICAgaWYgKHJlcG9ydC5kYXRhLmV4Y2VwdGlvbikgcmV0dXJuICJFeGNlcHRpb24iOwogICAgICAgICAgICAgIGlmIChyZXBvcnQuZGF0YS5lcnJvciA9PSAiRVJST1JfVElNRU9VVCIpIHJldHVybiAiVGltZW91dCI7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcG9ydC5kYXRhLnRlc3RDb3VudCAtIHJlcG9ydC5kYXRhLnN1Y2Nlc3NDb3VudCArICIgb2YgIiArIHJlcG9ydC5kYXRhLnRlc3RDb3VudCArICIgZmF1bHQiOwogICAgICAgICAgICBjYXNlIGJhc2lzLmRhdGEuU1RBVEUuUFJPQ0VTU0lORzoKICAgICAgICAgICAgICByZXR1cm4gInJ1bm5pbmciOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9IF0KICAgICAgfSwKICAgICAgYWN0aW9uOiB7CiAgICAgICAgcGlja3VwOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAmJiB0aGlzLnJvb3QgaW5zdGFuY2VvZiBUZXN0U3VpdGUpIHRoaXMucGFyZW50Tm9kZS5zZXREZWxlZ2F0ZSh0aGlzLnJvb3QpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgdmlldyA9IG5ldyBiYXNpcy51aS5Ob2RlKHsKICAgICAgZGF0YVNvdXJjZTogYmFzaXMuZGF0YS5WYWx1ZS5mYWN0b3J5KCJyb290Q2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5yb290LmdldENoaWxkTm9kZXNEYXRhc2V0KCk7CiAgICAgIH0pLAogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjMyIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgZmF1bHRUZXN0czogInNhdGVsbGl0ZToiLAogICAgICAgIGxldmVsVXA6ICJzYXRlbGxpdGU6IgogICAgICB9LAogICAgICBzZWxlY3Rpb246IHRydWUsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNlbGVjdGlvbjogewogICAgICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICAgICAgaWYgKCFzZWxlY3Rpb24uaXRlbUNvdW50KSB0aGlzLnNhdGVsbGl0ZS5mYXVsdFRlc3RzLnNlbGVjdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGRDbGFzczogSXRlbQogICAgfSk7CiAgICB2aWV3LnNldFNhdGVsbGl0ZSgiZmF1bHRUZXN0cyIsIG5ldyBJdGVtKHsKICAgICAgY29udGV4dFNlbGVjdGlvbjogdmlldy5zZWxlY3Rpb24sCiAgICAgIGRlbGVnYXRlOiBuZXcgYmFzaXMuZGF0YS5PYmplY3QoewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIG5hbWU6ICJTdW1tYXJ5IgogICAgICAgIH0sCiAgICAgICAgZ2V0Q2hpbGROb2Rlc0RhdGFzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHJ1bm5lci5mYXVsdFRlc3RzOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pKTsKICAgIHZpZXcuc2V0U2F0ZWxsaXRlKCJsZXZlbFVwIiwgewogICAgICBldmVudHM6ICJyb290Q2hhbmdlZCIsCiAgICAgIGV4aXN0c0lmOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5yb290LnBhcmVudE5vZGU7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIHJldHVybiBvd25lci5yb290LnBhcmVudE5vZGU7CiAgICAgIH0sCiAgICAgIGluc3RhbmNlOiBuZXcgSXRlbSh7CiAgICAgICAgYmluZGluZzogewogICAgICAgICAgbmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiLi4iOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYWN0aW9uOiB7CiAgICAgICAgICBzZWxlY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLm93bmVyLnNldERlbGVnYXRlKHRoaXMucm9vdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSk7CiAgICBiYXNpcy5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgaWYgKCF2aWV3LnNlbGVjdGlvbi5pdGVtQ291bnQpIHZpZXcuc2F0ZWxsaXRlLmZhdWx0VGVzdHMuc2VsZWN0KCk7CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gdmlldzsKICB9LAogICIzLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBiYXNpcy5yZXNvdXJjZS5leHRlbnNpb25zWyIubDEwbiJdID0gZnVuY3Rpb24oY29udGVudCwgdXJsKSB7CiAgICAgIHJldHVybiByZXNvbHZlRGljdGlvbmFyeSh1cmwpLnVwZGF0ZShiYXNpcy5yZXNvdXJjZS5leHRlbnNpb25zWyIuanNvbiJdKGNvbnRlbnQsIHVybCkpOwogICAgfTsKICAgIGZ1bmN0aW9uIG93bktleXMob2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSByZXN1bHQucHVzaChrZXkpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgdmFyIHRva2VuSW5kZXggPSBbXTsKICAgIHZhciB0b2tlbkNvbXB1dGVGbiA9IHt9OwogICAgdmFyIHRva2VuQ29tcHV0ZXMgPSB7fTsKICAgIHZhciBDb21wdXRlVG9rZW4gPSBDbGFzcyhiYXNpcy5Ub2tlbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ29tcHV0ZVRva2VuIiwKICAgICAgaW5pdDogZnVuY3Rpb24odmFsdWUsIHRva2VuKSB7CiAgICAgICAgdG9rZW4uY29tcHV0ZVRva2Vuc1t0aGlzLmJhc2lzT2JqZWN0SWRdID0gdGhpczsKICAgICAgICB0aGlzLnRva2VuID0gdG9rZW47CiAgICAgICAgdGhpcy5nZXQgPSB0b2tlbi5jb21wdXRlR2V0TWV0aG9kOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBjb21wdXRlR2V0TWV0aG9kOiBmdW5jdGlvbigpIHt9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IHt9OwogICAgICAgIHZhciB0b2tlbnMgPSB0aGlzLmNvbXB1dGVUb2tlbnM7CiAgICAgICAgdmFyIGdldCA9IHRoaXMudHlwZSA9PSAicGx1cmFsIiA/IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHZhbHVlc1tjdWx0dXJlc1tjdXJyZW50Q3VsdHVyZV0ucGx1cmFsKHRoaXMudmFsdWUpXTsKICAgICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWVzW3RoaXMudmFsdWVdOwogICAgICAgIH07CiAgICAgICAgdGhpcy5jb21wdXRlR2V0TWV0aG9kID0gZ2V0OwogICAgICAgIGlmICh0aGlzLnR5cGUgPT0gInBsdXJhbCIgJiYgQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSB8fCB0aGlzLnR5cGUgPT0gImRlZmF1bHQiICYmIHR5cGVvZiB0aGlzLnZhbHVlID09ICJvYmplY3QiKSB2YWx1ZXMgPSBiYXNpcy5vYmplY3Quc2xpY2UodGhpcy52YWx1ZSwgb3duS2V5cyh0aGlzLnZhbHVlKSk7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VucykgewogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IHRva2Vuc1trZXldOwogICAgICAgICAgdmFyIGN1clZhbHVlID0gY29tcHV0ZVRva2VuLmdldCgpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gZ2V0LmNhbGwoY29tcHV0ZVRva2VuKTsKICAgICAgICAgIGNvbXB1dGVUb2tlbi5nZXQgPSBnZXQ7CiAgICAgICAgICBpZiAoY3VyVmFsdWUgIT09IG5ld1ZhbHVlKSBjb21wdXRlVG9rZW4uYXBwbHkoKTsKICAgICAgICB9CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmFwcGx5LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyLmJhc2lzR2V0dGVySWRfKS5qb2luKCJfIik7CiAgICAgICAgaWYgKHRva2VuQ29tcHV0ZUZuW2VudW1JZF0pIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdOwogICAgICAgIHZhciB0b2tlbiA9IHRoaXM7CiAgICAgICAgdmFyIG9iamVjdFRva2VuTWFwID0ge307CiAgICAgICAgdmFyIHVwZGF0ZVZhbHVlID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB0aGlzLnNldChnZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgfTsKICAgICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgb2JqZWN0VG9rZW5NYXBbb2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSBpZiAoZXZlbnROYW1lICE9ICJkZXN0cm95IikgaGFuZGxlcltldmVudE5hbWVdID0gdXBkYXRlVmFsdWU7CiAgICAgICAgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF0gPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBFbWl0dGVyID09IGZhbHNlKSB0aHJvdyAiYmFzaXMubDEwbi5Ub2tlbiNjb21wdXRlOiBvYmplY3QgbXVzdCBiZSBhbiBpbnN0YW5jZW9mIEVtaXR0ZXIiOwogICAgICAgICAgdmFyIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICB2YXIgY29tcHV0ZVRva2VuID0gb2JqZWN0VG9rZW5NYXBbb2JqZWN0SWRdOwogICAgICAgICAgaWYgKCFjb21wdXRlVG9rZW4pIHsKICAgICAgICAgICAgY29tcHV0ZVRva2VuID0gb2JqZWN0VG9rZW5NYXBbb2JqZWN0SWRdID0gbmV3IENvbXB1dGVUb2tlbihnZXR0ZXIob2JqZWN0KSwgdG9rZW4pOwogICAgICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb21wdXRlVG9rZW4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbXB1dGVUb2tlbjsKICAgICAgICB9OwogICAgICB9LAogICAgICBjb21wdXRlVG9rZW46IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb21wdXRlVG9rZW4odmFsdWUsIHRoaXMpOwogICAgICB9LAogICAgICB0b2tlbjogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGlmICh0aGlzLnR5cGUgPT0gInBsdXJhbCIpIG5hbWUgPSBjdWx0dXJlc1tjdXJyZW50Q3VsdHVyZV0ucGx1cmFsKG5hbWUpOwogICAgICAgIGlmICh0aGlzLmRpY3Rpb25hcnkpIHJldHVybiB0aGlzLmRpY3Rpb25hcnkudG9rZW4odGhpcy5uYW1lICsgIi4iICsgbmFtZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNvbXB1dGVUb2tlbnMpIHRoaXMuY29tcHV0ZVRva2Vuc1trZXldLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSBudWxsOwogICAgICAgIHRoaXMudmFsdWUgPSBudWxsOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcmVzb2x2ZVRva2VuKHBhdGgpIHsKICAgICAgaWYgKHBhdGguY2hhckF0KDApID09ICIjIikgewogICAgICAgIHJldHVybiB0b2tlbkluZGV4W3BhcnNlSW50KHBhdGguc3Vic3RyKDEpLCAzNildOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwYXJ0cyA9IHBhdGgubWF0Y2goL14oLis/KUAoLispJC8pOwogICAgICAgIGlmIChwYXJ0cykgcmV0dXJuIHJlc29sdmVEaWN0aW9uYXJ5KGJhc2lzLnBhdGgucmVzb2x2ZShwYXJ0c1syXSkpLnRva2VuKHBhcnRzWzFdKTsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi50b2tlbiBhY2NlcHRzIHRva2VuIHJlZmVyZW5jZXMgaW4gZm9ybWF0IGB0b2tlbi5wYXRoQHBhdGgvdG8vZGljdC5sMTBuYCBvbmx5Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBkaWN0aW9uYXJpZXMgPSBbXTsKICAgIHZhciBkaWN0aW9uYXJ5QnlVcmwgPSB7fTsKICAgIHZhciBjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIgPSBuZXcgYmFzaXMuVG9rZW47CiAgICBmdW5jdGlvbiB3YWxrVG9rZW5zKGRpY3Rpb25hcnksIGN1bHR1cmUsIHRva2VucywgcGF0aCkgewogICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IGRpY3Rpb25hcnkuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXTsKICAgICAgcGF0aCA9IHBhdGggPyBwYXRoICsgIi4iIDogIiI7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gdG9rZW5zKSBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh0b2tlbnMsIG5hbWUpKSB7CiAgICAgICAgdmFyIHRva2VuTmFtZSA9IHBhdGggKyBuYW1lOwogICAgICAgIHZhciB0b2tlblZhbHVlID0gdG9rZW5zW25hbWVdOwogICAgICAgIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXSA9IHRva2VuVmFsdWU7CiAgICAgICAgaWYgKHRva2VuVmFsdWUgJiYgKHR5cGVvZiB0b2tlblZhbHVlID09ICJvYmplY3QiIHx8IEFycmF5LmlzQXJyYXkodG9rZW5WYWx1ZSkpKSB3YWxrVG9rZW5zKGRpY3Rpb25hcnksIGN1bHR1cmUsIHRva2VuVmFsdWUsIHRva2VuTmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHZhciBEaWN0aW9uYXJ5ID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGljdGlvbmFyeSIsCiAgICAgIHRva2VuczogbnVsbCwKICAgICAgdHlwZXM6IG51bGwsCiAgICAgIGN1bHR1cmVWYWx1ZXM6IG51bGwsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIHJlc291cmNlOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgdGhpcy50b2tlbnMgPSB7fTsKICAgICAgICB0aGlzLnR5cGVzID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgdGhpcy5pbmRleCA9IGRpY3Rpb25hcmllcy5wdXNoKHRoaXMpIC0gMTsKICAgICAgICBpZiAoYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZShjb250ZW50KSkgewogICAgICAgICAgdmFyIHJlc291cmNlID0gY29udGVudDsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTsKICAgICAgICAgIGlmICghZGljdGlvbmFyeUJ5VXJsW3Jlc291cmNlLnVybF0pIHsKICAgICAgICAgICAgZGljdGlvbmFyeUJ5VXJsW3Jlc291cmNlLnVybF0gPSB0aGlzOwogICAgICAgICAgICBjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIuc2V0KHJlc291cmNlLnVybCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNvdXJjZS5mZXRjaCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiVXNlIG9iamVjdCBhcyBjb250ZW50IG9mIGRpY3Rpb25hcnkgaXMgZXhwZXJpbWVudGFsIGFuZCBub3QgcHJvZHVjdGlvbi1yZWFkeSIpOwogICAgICAgICAgdGhpcy51cGRhdGUoY29udGVudCB8fCB7fSk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBpZiAoIWRhdGEpIGRhdGEgPSB7fTsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSB7fTsKICAgICAgICBmb3IgKHZhciBjdWx0dXJlIGluIGRhdGEpIGlmICghL15ffF8kLy50ZXN0KGN1bHR1cmUpKSB7CiAgICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV0gPSB7fTsKICAgICAgICAgIHdhbGtUb2tlbnModGhpcywgY3VsdHVyZSwgZGF0YVtjdWx0dXJlXSk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHlwZXMgPSBkYXRhLl9tZXRhICYmIGRhdGEuX21ldGEudHlwZSB8fCB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy50b2tlbnMpIHRoaXMudG9rZW5zW2tleV0uc2V0VHlwZSh0aGlzLnR5cGVzW2tleV0pOwogICAgICAgIHRoaXMuc3luY1ZhbHVlcygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBzeW5jVmFsdWVzOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciB0b2tlbk5hbWUgaW4gdGhpcy50b2tlbnMpIHRoaXMudG9rZW5zW3Rva2VuTmFtZV0uc2V0KHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICI0LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICBzZW5kZXI6IHRoaXMsCiAgICAgICAgICAgIHR5cGU6IGV2ZW50TmFtZSwKICAgICAgICAgICAgYXJnczogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgInMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBjb3JlVGVzdCA9IGJhc2lzLnJlcXVpcmUoIi4vaC5qcyIpOwogICAgdmFyIGFwcFRlc3QgPSBiYXNpcy5yZXF1aXJlKCIuL20uanMiKTsKICAgIHZhciB2aWV3ID0gbmV3IGFwcFRlc3QuVGVzdFN1aXRlTm9kZSh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM4IiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzb3VyY2VDb2RlOiAic2F0ZWxsaXRlOiIsCiAgICAgICAgdHlwZTogWyAicm9vdENoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS5yb290IGluc3RhbmNlb2YgY29yZVRlc3QuVGVzdFN1aXRlKSByZXR1cm4gInN1aXRlIjsKICAgICAgICAgIGlmIChub2RlLnJvb3QgaW5zdGFuY2VvZiBjb3JlVGVzdC5UZXN0Q2FzZSkgcmV0dXJuICJjYXNlIjsKICAgICAgICAgIHJldHVybiAidW5rbm93biI7CiAgICAgICAgfSBdLAogICAgICAgIGhhc0RlbGVnYXRlOiBbICJkZWxlZ2F0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gISFub2RlLmRlbGVnYXRlOwogICAgICAgIH0gXQogICAgICB9LAogICAgICBzZWxlY3Rpb246IHRydWUsCiAgICAgIHNhdGVsbGl0ZTogewogICAgICAgIHNvdXJjZUNvZGU6IHsKICAgICAgICAgIGluc3RhbmNlT2Y6IGFwcFRlc3QuQ29kZVZpZXcsCiAgICAgICAgICBldmVudHM6ICJyb290Q2hhbmdlZCBzdGF0ZUNoYW5nZWQiLAogICAgICAgICAgZXhpc3RzSWY6IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgICAgICAgIHJldHVybiBvd25lci5yb290IGluc3RhbmNlb2YgY29yZVRlc3QuVGVzdENhc2U7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsZWdhdGU6IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgICAgICAgIHJldHVybiBvd25lci5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SICYmIG93bmVyLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCA/IG93bmVyLnN0YXRlLmRhdGEgOiBvd25lcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmlldy5jb250ZXh0U2VsZWN0aW9uID0gdmlldy5zZWxlY3Rpb247CiAgICB2aWV3LmFkZEhhbmRsZXIoewogICAgICBkZWxlZ2F0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2VsZWN0aW9uLmNsZWFyKCk7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB2aWV3OwogIH0sCiAgIm0uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgaGlnaGxpZ2h0ID0gYmFzaXMucmVxdWlyZSgiLi9uLmpzIik7CiAgICB2YXIgVGVzdENhc2UgPSBiYXNpcy5yZXF1aXJlKCIuL2guanMiKS5UZXN0Q2FzZTsKICAgIHZhciBzdHJEaWZmID0gYmFzaXMucmVxdWlyZSgiLi9vLmpzIik7CiAgICBmdW5jdGlvbiBodG1sRXNjYXBlKHN0cikgewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyYvZywgIiZhbXA7IikucmVwbGFjZSgvPC9nLCAiJmx0OyIpLnJlcGxhY2UoLz4vZywgIiZndDsiKTsKICAgIH0KICAgIHZhciBDb2RlVmlldyA9IGJhc2lzLnVpLk5vZGUuc3ViY2xhc3MoewogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjNCIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgc291cmNlQ29kZTogImNvZGVFbGVtZW50IgogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNvZGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgYmFzaXMudWkuTm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc3luY0NvZGUoKTsKICAgICAgfSwKICAgICAgaGFuZGxlcjogewogICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnN5bmNDb2RlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzeW5jQ29kZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jb2RlRWxlbWVudC5pbm5lckhUTUwgPSBoaWdobGlnaHQodGhpcy5kYXRhLnRlc3RTb3VyY2UsIHsKICAgICAgICAgIGtlZXBGb3JtYXQ6IHRydWUsCiAgICAgICAgICBub0xpbmVOdW1iZXI6IHRydWUKICAgICAgICB9KTsKICAgICAgICB2YXIgbGluZXMgPSB0aGlzLmNvZGVFbGVtZW50LmNoaWxkTm9kZXM7CiAgICAgICAgaWYgKHRoaXMuZGF0YS5leGNlcHRpb24pIHsKICAgICAgICAgIHZhciBzdGFydExpbmUgPSB0aGlzLmRhdGEubGFzdExpbmU7CiAgICAgICAgICBsaW5lc1tzdGFydExpbmUrK10uY2xhc3NOYW1lICs9ICIgZXhjZXB0aW9uLWxpbmUiOwogICAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0TGluZTsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSBsaW5lc1tpXS5jbGFzc05hbWUgKz0gIiBkaXNhYmxlZC1saW5lIjsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGVycm9yTGluZXMgPSB0aGlzLmRhdGEuZXJyb3JMaW5lczsKICAgICAgICBmb3IgKHZhciBsaW5lTnVtIGluIGVycm9yTGluZXMpIHsKICAgICAgICAgIGxpbmVzW2xpbmVOdW1dLmNsYXNzTmFtZSArPSAiIGVycm9yLWxpbmUiOwogICAgICAgICAgbGluZXNbbGluZU51bV0uaW5uZXJIVE1MICs9ICc8ZGl2IGNsYXNzPSJlcnJvci1saW5lLWRldGFpbHMiPicgKyBlcnJvckxpbmVzW2xpbmVOdW1dLm1hcChmdW5jdGlvbihsaW5lRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGRpZmZUeXBlID0gdHlwZW9mIGxpbmVFcnJvci5leHBlY3RlZCA9PSAic3RyaW5nIiAmJiB0eXBlb2YgbGluZUVycm9yLmFjdHVhbCA9PSAic3RyaW5nIiA/ICJkaWZmQ2hhcnMiIDogImRpZmZXb3JkcyI7CiAgICAgICAgICAgIHZhciBkaWZmID0gc3RyRGlmZltkaWZmVHlwZV0obGluZUVycm9yLmV4cGVjdGVkU3RyLCBsaW5lRXJyb3IuYWN0dWFsU3RyKTsKICAgICAgICAgICAgdmFyIGV4cGVjdGVkID0gIiI7CiAgICAgICAgICAgIHZhciBhY3R1YWwgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNodW5rOyBjaHVuayA9IGRpZmZbaV07IGkrKykgewogICAgICAgICAgICAgIGlmIChjaHVuay5yZW1vdmVkKSB7CiAgICAgICAgICAgICAgICBleHBlY3RlZCArPSAnPHNwYW4gY2xhc3M9ImRpZmYtcmVtb3ZlZCI+JyArIGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpICsgIjwvc3Bhbj4iOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjaHVuay5hZGRlZCkgewogICAgICAgICAgICAgICAgYWN0dWFsICs9ICc8c3BhbiBjbGFzcz0iZGlmZi1hZGRlZCI+JyArIGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpICsgIjwvc3Bhbj4iOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4cGVjdGVkICs9IGh0bWxFc2NhcGUoY2h1bmsudmFsdWUpOwogICAgICAgICAgICAgIGFjdHVhbCArPSBodG1sRXNjYXBlKGNodW5rLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9ImVycm9yLWxpbmUtZGV0YWlscy1pdGVtIj4nICsgJzxzcGFuIGNsYXNzPSJudW0iPicgKyAobGluZUVycm9yLm51bSArIDEpICsgIjwvc3Bhbj4iICsgJzxzcGFuIGNsYXNzPSJjYXB0aW9uIj5FeHBlY3RlZDo8L3NwYW4+JyArICc8c3BhbiBjbGFzcz0iZXhwZWN0ZWQiPicgKyBleHBlY3RlZCArICI8L3NwYW4+IiArICc8c3BhbiBjbGFzcz0iY2FwdGlvbiI+QWN0dWFsOjwvc3Bhbj4nICsgJzxzcGFuIGNsYXNzPSJhY3R1YWwiPicgKyBhY3R1YWwgKyAiPC9zcGFuPiIgKyAiPC9kaXY+IjsKICAgICAgICAgIH0pLmpvaW4oIiIpICsgIjwvZGl2PiI7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0Tm9kZSA9IGJhc2lzLnVpLk5vZGUuc3ViY2xhc3MoewogICAgICB0ZW1wbGF0ZTogYmFzaXMudGVtcGxhdGUuZ2V0KCIjNSIpLAogICAgICBiaW5kaW5nOiB7CiAgICAgICAgbmFtZTogImRhdGE6IiwKICAgICAgICBoYXNPd25FbnZpcm9ubWVudDogWyAicm9vdENoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5yb290Lmhhc093bkVudmlyb25tZW50KCk7CiAgICAgICAgfSBdLAogICAgICAgIHRpbWU6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgJiYgbm9kZS5zdGF0ZS5kYXRhLmRhdGEgJiYgbm9kZS5zdGF0ZS5kYXRhLmRhdGEudGltZTsKICAgICAgICB9IF0sCiAgICAgICAgZXJyb3JNZXNzYWdlOiBbICJzdGF0ZUNoYW5nZWQiLCBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZSA9PSBiYXNpcy5kYXRhLlNUQVRFLkVSUk9SICYmIG5vZGUuc3RhdGUuZGF0YSA/IG5vZGUuc3RhdGUuZGF0YS5kYXRhLmVycm9yIDogIiI7CiAgICAgICAgfSBdLAogICAgICAgIHBlbmRpbmc6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlLmRhdGEgaW5zdGFuY2VvZiBiYXNpcy5kYXRhLk9iamVjdCAmJiAhIW5vZGUuc3RhdGUuZGF0YS5kYXRhLnBlbmRpbmc7CiAgICAgICAgfSBdLAogICAgICAgIHN0YXRlRGF0YTogWyAic3RhdGVDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGUgPT0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HID8gKDEwMCAqIG5vZGUuc3RhdGUuZGF0YSB8fCAwKS50b0ZpeGVkKDIpIDogbm9kZS5zdGF0ZS5kYXRhICYmIG5vZGUuc3RhdGUuZGF0YS5kYXRhLmVycm9yIHx8ICIiOwogICAgICAgIH0gXSwKICAgICAgICBzdGF0ZU1lc3NhZ2U6IFsgInN0YXRlQ2hhbmdlZCIsIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgIHZhciByZXBvcnQgPSBub2RlLnN0YXRlLmRhdGE7CiAgICAgICAgICBzd2l0Y2ggKFN0cmluZyhub2RlLnN0YXRlKSkgewogICAgICAgICAgICBjYXNlIGJhc2lzLmRhdGEuU1RBVEUuUkVBRFk6CiAgICAgICAgICAgICAgaWYgKHJlcG9ydCBpbnN0YW5jZW9mIGJhc2lzLmRhdGEuT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBpZiAocmVwb3J0LmRhdGEucGVuZGluZykgcmV0dXJuICJQZW5kaW5nIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuICJPSyI7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5FUlJPUjoKICAgICAgICAgICAgICBpZiAocmVwb3J0IGluc3RhbmNlb2YgYmFzaXMuZGF0YS5PYmplY3QgPT0gZmFsc2UpIHJldHVybiAiRXJyb3IiOwogICAgICAgICAgICAgIGlmIChyZXBvcnQuZGF0YS5leGNlcHRpb24pIHJldHVybiByZXBvcnQuZGF0YS5leGNlcHRpb247CiAgICAgICAgICAgICAgaWYgKHJlcG9ydC5kYXRhLmVycm9yID09ICJFUlJPUl9USU1FT1VUIikgcmV0dXJuICJUaW1lb3V0IjsKICAgICAgICAgICAgICByZXR1cm4gcmVwb3J0LmRhdGEudGVzdENvdW50IC0gcmVwb3J0LmRhdGEuc3VjY2Vzc0NvdW50ICsgIiBvZiAiICsgcmVwb3J0LmRhdGEudGVzdENvdW50ICsgIiBmYXVsdCI7CiAgICAgICAgICAgIGNhc2UgYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOgogICAgICAgICAgICAgIHJldHVybiAicnVubmluZyI7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0gXQogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0U3VpdGVOb2RlID0gVGVzdE5vZGUuc3ViY2xhc3MoewogICAgICBkYXRhU291cmNlOiBiYXNpcy5kYXRhLlZhbHVlLmZhY3RvcnkoInJvb3RDaGFuZ2VkIiwgZnVuY3Rpb24obm9kZSkgewogICAgICAgIHJldHVybiBub2RlLnJvb3QuZ2V0Q2hpbGROb2Rlc0RhdGFzZXQoKTsKICAgICAgfSksCiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM2IiksCiAgICAgIGNoaWxkQ2xhc3M6IFRlc3ROb2RlLAogICAgICBjaGlsZEZhY3Rvcnk6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUucm9vdCBpbnN0YW5jZW9mIFRlc3RDYXNlKSByZXR1cm4gbmV3IFRlc3RDYXNlTm9kZShjb25maWcpOyBlbHNlIHJldHVybiBuZXcgVGVzdFN1aXRlTm9kZShjb25maWcpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUZXN0Q2FzZU5vZGUgPSBUZXN0Tm9kZS5zdWJjbGFzcyh7CiAgICAgIHRlbXBsYXRlOiBiYXNpcy50ZW1wbGF0ZS5nZXQoIiM3IiksCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzb3VyY2U6ICJzYXRlbGxpdGU6IgogICAgICB9LAogICAgICBzYXRlbGxpdGU6IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgICBleGlzdHNJZjogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICAgICAgcmV0dXJuIG93bmVyLnN0YXRlID09IGJhc2lzLmRhdGEuU1RBVEUuRVJST1IgJiYgb3duZXIuc3RhdGUuZGF0YSAmJiBvd25lci5zdGF0ZS5kYXRhLmRhdGEgJiYgb3duZXIuc3RhdGUuZGF0YS5kYXRhLnRlc3RTb3VyY2U7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsZWdhdGU6ICJzdGF0ZS5kYXRhIiwKICAgICAgICAgIGluc3RhbmNlT2Y6IENvZGVWaWV3CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBUZXN0Tm9kZTogVGVzdE5vZGUsCiAgICAgIFRlc3RDYXNlTm9kZTogVGVzdENhc2VOb2RlLAogICAgICBUZXN0U3VpdGVOb2RlOiBUZXN0U3VpdGVOb2RlLAogICAgICBDb2RlVmlldzogQ29kZVZpZXcKICAgIH07CiAgfSwKICAibi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgdmFyIGxlYWQgPSBiYXNpcy5udW1iZXIubGVhZDsKICAgIHZhciByZXBlYXQgPSBiYXNpcy5zdHJpbmcucmVwZWF0OwogICAgdmFyIGtleXdvcmRzID0gImJyZWFrIGNhc2UgY2F0Y2ggY29udGludWUgIiArICJkZWZhdWx0IGRlbGV0ZSBkbyBlbHNlIGZhbHNlICIgKyAiZm9yIGZ1bmN0aW9uIGlmIGluIGluc3RhbmNlb2YgIiArICJuZXcgbnVsbCByZXR1cm4gc3VwZXIgc3dpdGNoICIgKyAidGhpcyB0aHJvdyB0cnVlIHRyeSB0eXBlb2YgdmFyIHdoaWxlIHdpdGgiOwogICAgdmFyIGtleXdvcmRSZWdFeHAgPSBuZXcgUmVnRXhwKCJcXGIoIiArIGtleXdvcmRzLnNwbGl0KCIgIikuam9pbigifCIpICsgIilcXGIiLCAiZyIpOwogICAgZnVuY3Rpb24gcGFyc2UodGV4dCkgewogICAgICBmdW5jdGlvbiBhZGRNYXRjaChraW5kLCBzdGFydCwgZW5kLCBybikgewogICAgICAgIGlmIChsYXN0TWF0Y2hQb3MgIT0gc3RhcnQpIHJlc3VsdC5wdXNoKHRleHQuc3Vic3RyaW5nKGxhc3RNYXRjaFBvcywgc3RhcnQpLnJlcGxhY2Uoa2V5d29yZFJlZ0V4cCwgJzxzcGFuIGNsYXNzPSJ0b2tlbi1rZXl3b3JkIj4kMTwvc3Bhbj4nKSk7CiAgICAgICAgbGFzdE1hdGNoUG9zID0gZW5kICsgMTsKICAgICAgICBpZiAoa2luZCkgcmVzdWx0LnB1c2goJzxzcGFuIGNsYXNzPSJ0b2tlbi0nICsga2luZCArICciPicgKyB0ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kICsgMSkgKyAiPC9zcGFuPiIgKyAocm4gfHwgIiIpKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBzeW0gPSB0ZXh0LnNwbGl0KCIiKTsKICAgICAgdmFyIHN0YXJ0OwogICAgICB2YXIgbGFzdE1hdGNoUG9zID0gMDsKICAgICAgdmFyIHN0clN5bTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzeW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3ltW2ldID09ICInIiB8fCBzeW1baV0gPT0gJyInKSB7CiAgICAgICAgICBzdHJTeW0gPSBzeW1baV07CiAgICAgICAgICBzdGFydCA9IGk7CiAgICAgICAgICB3aGlsZSAoKytpIDwgc3ltLmxlbmd0aCkgewogICAgICAgICAgICBpZiAoc3ltW2ldID09ICJcXCIpIHsKICAgICAgICAgICAgICBpZiAoc3ltW2kgKyAxXSA9PSAiXG4iKSB7CiAgICAgICAgICAgICAgICBhZGRNYXRjaCgic3RyaW5nIiwgc3RhcnQsIGkpOwogICAgICAgICAgICAgICAgc3RhcnQgPSArK2kgKyAxOwogICAgICAgICAgICAgIH0gZWxzZSBpICs9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSBzdHJTeW0pIHsKICAgICAgICAgICAgICBhZGRNYXRjaCgic3RyaW5nIiwgc3RhcnQsIGkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxuIikgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChzeW1baV0gPT0gIi8iKSB7CiAgICAgICAgICBzdGFydCA9IGk7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoc3ltW2ldID09ICIvIikgewogICAgICAgICAgICB3aGlsZSAoKytpIDwgc3ltLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChzeW1baV0gPT0gIlxuIikgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkTWF0Y2goImNvbW1lbnQiLCBzdGFydCwgaSAtIDEpOwogICAgICAgICAgfSBlbHNlIGlmIChzeW1baV0gPT0gIioiKSB7CiAgICAgICAgICAgIHdoaWxlICgrK2kgPCBzeW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSAiKiIgJiYgc3ltW2kgKyAxXSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIGFkZE1hdGNoKCJjb21tZW50Iiwgc3RhcnQsICsraSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN5bVtpXSA9PSAiXG4iKSB7CiAgICAgICAgICAgICAgICBhZGRNYXRjaCgiY29tbWVudCIsIHN0YXJ0LCBpIC0gMSwgIlxuIik7CiAgICAgICAgICAgICAgICBsYXN0TWF0Y2hQb3MgPSBzdGFydCA9IGkgKyAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBhZGRNYXRjaChudWxsLCB0ZXh0Lmxlbmd0aCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBoaWdobGlnaHQodGV4dCwgb3B0aW9ucykgewogICAgICBmdW5jdGlvbiBub3JtYWxpemUodGV4dCkgewogICAgICAgIHRleHQgPSB0ZXh0LnRyaW1SaWdodCgpLnJlcGxhY2UoL1xyXG58XG5ccnxcci9nLCAiXG4iKTsKICAgICAgICBpZiAoIW9wdGlvbnMua2VlcEZvcm1hdCkgdGV4dCA9IHRleHQucmVwbGFjZSgvXig/OlxzKltcbl0rKSs/KFsgXHRdKikvLCAiJDEiKTsKICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cblsgXHRdKy9nLCBmdW5jdGlvbihtKSB7CiAgICAgICAgICByZXR1cm4gbS5yZXBsYWNlKC9cdC9nLCAiICAiKTsKICAgICAgICB9KS5yZXBsYWNlKC9cblsgXHRdK1xuL2csICJcblxuIik7CiAgICAgICAgaWYgKCFvcHRpb25zLmtlZXBGb3JtYXQpIHsKICAgICAgICAgIHZhciBtaW5PZmZzZXQgPSAxZTM7CiAgICAgICAgICB2YXIgbGluZXMgPSB0ZXh0LnNwbGl0KC9cbisvKTsKICAgICAgICAgIHZhciBzdGFydExpbmUgPSBOdW1iZXIodGV4dC5tYXRjaCgvXmZ1bmN0aW9uLykgIT0gbnVsbCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gc3RhcnRMaW5lOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG0gPSBsaW5lc1tpXS5tYXRjaCgvXlxzKi8pOwogICAgICAgICAgICBpZiAobVswXS5sZW5ndGggPCBtaW5PZmZzZXQpIG1pbk9mZnNldCA9IG1bMF0ubGVuZ3RoOwogICAgICAgICAgICBpZiAobWluT2Zmc2V0ID09IDApIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1pbk9mZnNldCA+IDApIHRleHQgPSB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cCgiKF58XFxuKSB7IiArIG1pbk9mZnNldCArICJ9IiwgImciKSwgIiQxIik7CiAgICAgICAgfQogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cCgiKF58XFxuKSggKykiLCAiZyIpLCBmdW5jdGlvbihtLCBhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSArIHJlcGVhdCgiwqAiLCBiLmxlbmd0aCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgIHZhciBodG1sID0gcGFyc2Uobm9ybWFsaXplKHRleHQgfHwgIiIpLnJlcGxhY2UoLzwvZywgIiZsdDsiKSk7CiAgICAgIHZhciBsaW5lcyA9IGh0bWwuam9pbigiIikuc3BsaXQoIlxuIik7CiAgICAgIHZhciBudW1iZXJXaWR0aCA9IFN0cmluZyhsaW5lcy5sZW5ndGgpLmxlbmd0aDsKICAgICAgdmFyIGxpbmVDbGFzcyA9IG9wdGlvbnMubm9MaW5lTnVtYmVyID8gIiIgOiAiIGhhc0xpbmVOdW1iZXIiOwogICAgICB2YXIgcmVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHJlcy5wdXNoKCc8ZGl2IGNsYXNzPSJsaW5lICcgKyAoaSAlIDIgPyAib2RkIiA6ICJldmVuIikgKyBsaW5lQ2xhc3MgKyAnIj4nICsgJzxzcGFuIGNsYXNzPSJsaW5lQ29udGVudCI+JyArICghb3B0aW9ucy5ub0xpbmVOdW1iZXIgPyAnPGlucHV0IGNsYXNzPSJsaW5lTnVtYmVyIiB2YWx1ZT0iJyArIGxlYWQoaSArIDEsIG51bWJlcldpZHRoKSArICciIHR5cGU9Im5vbmUiIHVuc2VsZWN0YWJsZT0ib24iIHJlYWRvbmx5PSJyZWFkb25seSIgdGFiaW5kZXg9Ii0xIiAvPicgKyAnPHNwYW4gY2xhc3M9Im92ZXIiPjwvc3Bhbj4nIDogIiIpICsgKGxpbmVzW2ldICsgIlxyXG4iKSArICI8L3NwYW4+IiArICI8L2Rpdj4iKTsKICAgICAgcmV0dXJuIHJlcy5qb2luKCIiKTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gaGlnaGxpZ2h0OwogIH0sCiAgIm8uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBKc0RpZmYgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gY2xvbmVQYXRoKHBhdGgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbmV3UG9zOiBwYXRoLm5ld1BvcywKICAgICAgICAgIGNvbXBvbmVudHM6IHBhdGguY29tcG9uZW50cy5zbGljZSgwKQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVtb3ZlRW1wdHkoYXJyYXkpIHsKICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGFycmF5W2ldKSB7CiAgICAgICAgICAgIHJldC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgICBmdW5jdGlvbiBlc2NhcGVIVE1MKHMpIHsKICAgICAgICB2YXIgbiA9IHM7CiAgICAgICAgbiA9IG4ucmVwbGFjZSgvJi9nLCAiJmFtcDsiKTsKICAgICAgICBuID0gbi5yZXBsYWNlKC88L2csICImbHQ7Iik7CiAgICAgICAgbiA9IG4ucmVwbGFjZSgvPi9nLCAiJmd0OyIpOwogICAgICAgIG4gPSBuLnJlcGxhY2UoLyIvZywgIiZxdW90OyIpOwogICAgICAgIHJldHVybiBuOwogICAgICB9CiAgICAgIHZhciBEaWZmID0gZnVuY3Rpb24oaWdub3JlV2hpdGVzcGFjZSkgewogICAgICAgIHRoaXMuaWdub3JlV2hpdGVzcGFjZSA9IGlnbm9yZVdoaXRlc3BhY2U7CiAgICAgIH07CiAgICAgIERpZmYucHJvdG90eXBlID0gewogICAgICAgIGRpZmY6IGZ1bmN0aW9uKG9sZFN0cmluZywgbmV3U3RyaW5nKSB7CiAgICAgICAgICBpZiAobmV3U3RyaW5nID09PSBvbGRTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIFsgewogICAgICAgICAgICAgIHZhbHVlOiBuZXdTdHJpbmcKICAgICAgICAgICAgfSBdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFuZXdTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIFsgewogICAgICAgICAgICAgIHZhbHVlOiBvbGRTdHJpbmcsCiAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZQogICAgICAgICAgICB9IF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9sZFN0cmluZykgewogICAgICAgICAgICByZXR1cm4gWyB7CiAgICAgICAgICAgICAgdmFsdWU6IG5ld1N0cmluZywKICAgICAgICAgICAgICBhZGRlZDogdHJ1ZQogICAgICAgICAgICB9IF07CiAgICAgICAgICB9CiAgICAgICAgICBuZXdTdHJpbmcgPSB0aGlzLnRva2VuaXplKG5ld1N0cmluZyk7CiAgICAgICAgICBvbGRTdHJpbmcgPSB0aGlzLnRva2VuaXplKG9sZFN0cmluZyk7CiAgICAgICAgICB2YXIgbmV3TGVuID0gbmV3U3RyaW5nLmxlbmd0aCwgb2xkTGVuID0gb2xkU3RyaW5nLmxlbmd0aDsKICAgICAgICAgIHZhciBtYXhFZGl0TGVuZ3RoID0gbmV3TGVuICsgb2xkTGVuOwogICAgICAgICAgdmFyIGJlc3RQYXRoID0gWyB7CiAgICAgICAgICAgIG5ld1BvczogLTEsCiAgICAgICAgICAgIGNvbXBvbmVudHM6IFtdCiAgICAgICAgICB9IF07CiAgICAgICAgICB2YXIgb2xkUG9zID0gdGhpcy5leHRyYWN0Q29tbW9uKGJlc3RQYXRoWzBdLCBuZXdTdHJpbmcsIG9sZFN0cmluZywgMCk7CiAgICAgICAgICBpZiAoYmVzdFBhdGhbMF0ubmV3UG9zICsgMSA+PSBuZXdMZW4gJiYgb2xkUG9zICsgMSA+PSBvbGRMZW4pIHsKICAgICAgICAgICAgcmV0dXJuIGJlc3RQYXRoWzBdLmNvbXBvbmVudHM7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBlZGl0TGVuZ3RoID0gMTsgZWRpdExlbmd0aCA8PSBtYXhFZGl0TGVuZ3RoOyBlZGl0TGVuZ3RoKyspIHsKICAgICAgICAgICAgZm9yICh2YXIgZGlhZ29uYWxQYXRoID0gLTEgKiBlZGl0TGVuZ3RoOyBkaWFnb25hbFBhdGggPD0gZWRpdExlbmd0aDsgZGlhZ29uYWxQYXRoICs9IDIpIHsKICAgICAgICAgICAgICB2YXIgYmFzZVBhdGg7CiAgICAgICAgICAgICAgdmFyIGFkZFBhdGggPSBiZXN0UGF0aFtkaWFnb25hbFBhdGggLSAxXSwgcmVtb3ZlUGF0aCA9IGJlc3RQYXRoW2RpYWdvbmFsUGF0aCArIDFdOwogICAgICAgICAgICAgIG9sZFBvcyA9IChyZW1vdmVQYXRoID8gcmVtb3ZlUGF0aC5uZXdQb3MgOiAwKSAtIGRpYWdvbmFsUGF0aDsKICAgICAgICAgICAgICBpZiAoYWRkUGF0aCkgewogICAgICAgICAgICAgICAgYmVzdFBhdGhbZGlhZ29uYWxQYXRoIC0gMV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjYW5BZGQgPSBhZGRQYXRoICYmIGFkZFBhdGgubmV3UG9zICsgMSA8IG5ld0xlbjsKICAgICAgICAgICAgICB2YXIgY2FuUmVtb3ZlID0gcmVtb3ZlUGF0aCAmJiAwIDw9IG9sZFBvcyAmJiBvbGRQb3MgPCBvbGRMZW47CiAgICAgICAgICAgICAgaWYgKCFjYW5BZGQgJiYgIWNhblJlbW92ZSkgewogICAgICAgICAgICAgICAgYmVzdFBhdGhbZGlhZ29uYWxQYXRoXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWNhbkFkZCB8fCBjYW5SZW1vdmUgJiYgYWRkUGF0aC5uZXdQb3MgPCByZW1vdmVQYXRoLm5ld1BvcykgewogICAgICAgICAgICAgICAgYmFzZVBhdGggPSBjbG9uZVBhdGgocmVtb3ZlUGF0aCk7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hDb21wb25lbnQoYmFzZVBhdGguY29tcG9uZW50cywgb2xkU3RyaW5nW29sZFBvc10sIHVuZGVmaW5lZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJhc2VQYXRoID0gY2xvbmVQYXRoKGFkZFBhdGgpOwogICAgICAgICAgICAgICAgYmFzZVBhdGgubmV3UG9zKys7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hDb21wb25lbnQoYmFzZVBhdGguY29tcG9uZW50cywgbmV3U3RyaW5nW2Jhc2VQYXRoLm5ld1Bvc10sIHRydWUsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvbGRQb3MgPSB0aGlzLmV4dHJhY3RDb21tb24oYmFzZVBhdGgsIG5ld1N0cmluZywgb2xkU3RyaW5nLCBkaWFnb25hbFBhdGgpOwogICAgICAgICAgICAgIGlmIChiYXNlUGF0aC5uZXdQb3MgKyAxID49IG5ld0xlbiAmJiBvbGRQb3MgKyAxID49IG9sZExlbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGJhc2VQYXRoLmNvbXBvbmVudHM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJlc3RQYXRoW2RpYWdvbmFsUGF0aF0gPSBiYXNlUGF0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHB1c2hDb21wb25lbnQ6IGZ1bmN0aW9uKGNvbXBvbmVudHMsIHZhbHVlLCBhZGRlZCwgcmVtb3ZlZCkgewogICAgICAgICAgdmFyIGxhc3QgPSBjb21wb25lbnRzW2NvbXBvbmVudHMubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAobGFzdCAmJiBsYXN0LmFkZGVkID09PSBhZGRlZCAmJiBsYXN0LnJlbW92ZWQgPT09IHJlbW92ZWQpIHsKICAgICAgICAgICAgY29tcG9uZW50c1tjb21wb25lbnRzLmxlbmd0aCAtIDFdID0gewogICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmpvaW4obGFzdC52YWx1ZSwgdmFsdWUpLAogICAgICAgICAgICAgIGFkZGVkOiBhZGRlZCwKICAgICAgICAgICAgICByZW1vdmVkOiByZW1vdmVkCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb21wb25lbnRzLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBhZGRlZDogYWRkZWQsCiAgICAgICAgICAgICAgcmVtb3ZlZDogcmVtb3ZlZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGV4dHJhY3RDb21tb246IGZ1bmN0aW9uKGJhc2VQYXRoLCBuZXdTdHJpbmcsIG9sZFN0cmluZywgZGlhZ29uYWxQYXRoKSB7CiAgICAgICAgICB2YXIgbmV3TGVuID0gbmV3U3RyaW5nLmxlbmd0aCwgb2xkTGVuID0gb2xkU3RyaW5nLmxlbmd0aCwgbmV3UG9zID0gYmFzZVBhdGgubmV3UG9zLCBvbGRQb3MgPSBuZXdQb3MgLSBkaWFnb25hbFBhdGg7CiAgICAgICAgICB3aGlsZSAobmV3UG9zICsgMSA8IG5ld0xlbiAmJiBvbGRQb3MgKyAxIDwgb2xkTGVuICYmIHRoaXMuZXF1YWxzKG5ld1N0cmluZ1tuZXdQb3MgKyAxXSwgb2xkU3RyaW5nW29sZFBvcyArIDFdKSkgewogICAgICAgICAgICBuZXdQb3MrKzsKICAgICAgICAgICAgb2xkUG9zKys7CiAgICAgICAgICAgIHRoaXMucHVzaENvbXBvbmVudChiYXNlUGF0aC5jb21wb25lbnRzLCBuZXdTdHJpbmdbbmV3UG9zXSwgdW5kZWZpbmVkLCB1bmRlZmluZWQpOwogICAgICAgICAgfQogICAgICAgICAgYmFzZVBhdGgubmV3UG9zID0gbmV3UG9zOwogICAgICAgICAgcmV0dXJuIG9sZFBvczsKICAgICAgICB9LAogICAgICAgIGVxdWFsczogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgIHZhciByZVdoaXRlc3BhY2UgPSAvXFMvOwogICAgICAgICAgaWYgKHRoaXMuaWdub3JlV2hpdGVzcGFjZSAmJiAhcmVXaGl0ZXNwYWNlLnRlc3QobGVmdCkgJiYgIXJlV2hpdGVzcGFjZS50ZXN0KHJpZ2h0KSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGpvaW46IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICByZXR1cm4gbGVmdCArIHJpZ2h0OwogICAgICAgIH0sCiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgQ2hhckRpZmYgPSBuZXcgRGlmZjsKICAgICAgdmFyIFdvcmREaWZmID0gbmV3IERpZmYodHJ1ZSk7CiAgICAgIHZhciBXb3JkV2l0aFNwYWNlRGlmZiA9IG5ldyBEaWZmOwogICAgICBXb3JkRGlmZi50b2tlbml6ZSA9IFdvcmRXaXRoU3BhY2VEaWZmLnRva2VuaXplID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVtb3ZlRW1wdHkodmFsdWUuc3BsaXQoLyhccyt8XGIpLykpOwogICAgICB9OwogICAgICB2YXIgQ3NzRGlmZiA9IG5ldyBEaWZmKHRydWUpOwogICAgICBDc3NEaWZmLnRva2VuaXplID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVtb3ZlRW1wdHkodmFsdWUuc3BsaXQoLyhbe306OyxdfFxzKykvKSk7CiAgICAgIH07CiAgICAgIHZhciBMaW5lRGlmZiA9IG5ldyBEaWZmOwogICAgICBMaW5lRGlmZi50b2tlbml6ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIHJldExpbmVzID0gW10sIGxpbmVzID0gdmFsdWUuc3BsaXQoL14vbSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGxpbmUgPSBsaW5lc1tpXSwgbGFzdExpbmUgPSBsaW5lc1tpIC0gMV07CiAgICAgICAgICBpZiAobGluZSA9PSAiXG4iICYmIGxhc3RMaW5lICYmIGxhc3RMaW5lW2xhc3RMaW5lLmxlbmd0aCAtIDFdID09PSAiXHIiKSB7CiAgICAgICAgICAgIHJldExpbmVzW3JldExpbmVzLmxlbmd0aCAtIDFdICs9ICJcbiI7CiAgICAgICAgICB9IGVsc2UgaWYgKGxpbmUpIHsKICAgICAgICAgICAgcmV0TGluZXMucHVzaChsaW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldExpbmVzOwogICAgICB9OwogICAgICByZXR1cm4gewogICAgICAgIERpZmY6IERpZmYsCiAgICAgICAgZGlmZkNoYXJzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIENoYXJEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZldvcmRzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIFdvcmREaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZldvcmRzV2l0aFNwYWNlOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIFdvcmRXaXRoU3BhY2VEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZkxpbmVzOiBmdW5jdGlvbihvbGRTdHIsIG5ld1N0cikgewogICAgICAgICAgcmV0dXJuIExpbmVEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgZGlmZkNzczogZnVuY3Rpb24ob2xkU3RyLCBuZXdTdHIpIHsKICAgICAgICAgIHJldHVybiBDc3NEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlUGF0Y2g6IGZ1bmN0aW9uKGZpbGVOYW1lLCBvbGRTdHIsIG5ld1N0ciwgb2xkSGVhZGVyLCBuZXdIZWFkZXIpIHsKICAgICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICAgIHJldC5wdXNoKCJJbmRleDogIiArIGZpbGVOYW1lKTsKICAgICAgICAgIHJldC5wdXNoKCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Iik7CiAgICAgICAgICByZXQucHVzaCgiLS0tICIgKyBmaWxlTmFtZSArICh0eXBlb2Ygb2xkSGVhZGVyID09PSAidW5kZWZpbmVkIiA/ICIiIDogIgkiICsgb2xkSGVhZGVyKSk7CiAgICAgICAgICByZXQucHVzaCgiKysrICIgKyBmaWxlTmFtZSArICh0eXBlb2YgbmV3SGVhZGVyID09PSAidW5kZWZpbmVkIiA/ICIiIDogIgkiICsgbmV3SGVhZGVyKSk7CiAgICAgICAgICB2YXIgZGlmZiA9IExpbmVEaWZmLmRpZmYob2xkU3RyLCBuZXdTdHIpOwogICAgICAgICAgaWYgKCFkaWZmW2RpZmYubGVuZ3RoIC0gMV0udmFsdWUpIHsKICAgICAgICAgICAgZGlmZi5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICAgIGRpZmYucHVzaCh7CiAgICAgICAgICAgIHZhbHVlOiAiIiwKICAgICAgICAgICAgbGluZXM6IFtdCiAgICAgICAgICB9KTsKICAgICAgICAgIGZ1bmN0aW9uIGNvbnRleHRMaW5lcyhsaW5lcykgewogICAgICAgICAgICByZXR1cm4gbGluZXMubWFwKGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICIgIiArIGVudHJ5OwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVvZk5MKGN1clJhbmdlLCBpLCBjdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBsYXN0ID0gZGlmZltkaWZmLmxlbmd0aCAtIDJdLCBpc0xhc3QgPSBpID09PSBkaWZmLmxlbmd0aCAtIDIsIGlzTGFzdE9mVHlwZSA9IGkgPT09IGRpZmYubGVuZ3RoIC0gMyAmJiAoY3VycmVudC5hZGRlZCAhPT0gbGFzdC5hZGRlZCB8fCBjdXJyZW50LnJlbW92ZWQgIT09IGxhc3QucmVtb3ZlZCk7CiAgICAgICAgICAgIGlmICghL1xuJC8udGVzdChjdXJyZW50LnZhbHVlKSAmJiAoaXNMYXN0IHx8IGlzTGFzdE9mVHlwZSkpIHsKICAgICAgICAgICAgICBjdXJSYW5nZS5wdXNoKCJcXCBObyBuZXdsaW5lIGF0IGVuZCBvZiBmaWxlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBvbGRSYW5nZVN0YXJ0ID0gMCwgbmV3UmFuZ2VTdGFydCA9IDAsIGN1clJhbmdlID0gW10sIG9sZExpbmUgPSAxLCBuZXdMaW5lID0gMTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlmZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IGRpZmZbaV0sIGxpbmVzID0gY3VycmVudC5saW5lcyB8fCBjdXJyZW50LnZhbHVlLnJlcGxhY2UoL1xuJC8sICIiKS5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgY3VycmVudC5saW5lcyA9IGxpbmVzOwogICAgICAgICAgICBpZiAoY3VycmVudC5hZGRlZCB8fCBjdXJyZW50LnJlbW92ZWQpIHsKICAgICAgICAgICAgICBpZiAoIW9sZFJhbmdlU3RhcnQpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gZGlmZltpIC0gMV07CiAgICAgICAgICAgICAgICBvbGRSYW5nZVN0YXJ0ID0gb2xkTGluZTsKICAgICAgICAgICAgICAgIG5ld1JhbmdlU3RhcnQgPSBuZXdMaW5lOwogICAgICAgICAgICAgICAgaWYgKHByZXYpIHsKICAgICAgICAgICAgICAgICAgY3VyUmFuZ2UgPSBjb250ZXh0TGluZXMocHJldi5saW5lcy5zbGljZSgtNCkpOwogICAgICAgICAgICAgICAgICBvbGRSYW5nZVN0YXJ0IC09IGN1clJhbmdlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgbmV3UmFuZ2VTdGFydCAtPSBjdXJSYW5nZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1clJhbmdlLnB1c2guYXBwbHkoY3VyUmFuZ2UsIGxpbmVzLm1hcChmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuIChjdXJyZW50LmFkZGVkID8gIisiIDogIi0iKSArIGVudHJ5OwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICBlb2ZOTChjdXJSYW5nZSwgaSwgY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuYWRkZWQpIHsKICAgICAgICAgICAgICAgIG5ld0xpbmUgKz0gbGluZXMubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvbGRMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKG9sZFJhbmdlU3RhcnQpIHsKICAgICAgICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGggPD0gOCAmJiBpIDwgZGlmZi5sZW5ndGggLSAyKSB7CiAgICAgICAgICAgICAgICAgIGN1clJhbmdlLnB1c2guYXBwbHkoY3VyUmFuZ2UsIGNvbnRleHRMaW5lcyhsaW5lcykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHRTaXplID0gTWF0aC5taW4obGluZXMubGVuZ3RoLCA0KTsKICAgICAgICAgICAgICAgICAgcmV0LnB1c2goIkBAIC0iICsgb2xkUmFuZ2VTdGFydCArICIsIiArIChvbGRMaW5lIC0gb2xkUmFuZ2VTdGFydCArIGNvbnRleHRTaXplKSArICIgKyIgKyBuZXdSYW5nZVN0YXJ0ICsgIiwiICsgKG5ld0xpbmUgLSBuZXdSYW5nZVN0YXJ0ICsgY29udGV4dFNpemUpICsgIiBAQCIpOwogICAgICAgICAgICAgICAgICByZXQucHVzaC5hcHBseShyZXQsIGN1clJhbmdlKTsKICAgICAgICAgICAgICAgICAgcmV0LnB1c2guYXBwbHkocmV0LCBjb250ZXh0TGluZXMobGluZXMuc2xpY2UoMCwgY29udGV4dFNpemUpKSk7CiAgICAgICAgICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGggPD0gNCkgewogICAgICAgICAgICAgICAgICAgIGVvZk5MKHJldCwgaSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgb2xkUmFuZ2VTdGFydCA9IDA7CiAgICAgICAgICAgICAgICAgIG5ld1JhbmdlU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgICBjdXJSYW5nZSA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvbGRMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgICBuZXdMaW5lICs9IGxpbmVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJldC5qb2luKCJcbiIpICsgIlxuIjsKICAgICAgICB9LAogICAgICAgIGFwcGx5UGF0Y2g6IGZ1bmN0aW9uKG9sZFN0ciwgdW5pRGlmZikgewogICAgICAgICAgdmFyIGRpZmZzdHIgPSB1bmlEaWZmLnNwbGl0KCJcbiIpOwogICAgICAgICAgdmFyIGRpZmYgPSBbXTsKICAgICAgICAgIHZhciByZW1FT0ZOTCA9IGZhbHNlLCBhZGRFT0ZOTCA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIgaSA9IGRpZmZzdHJbMF1bMF0gPT09ICJJIiA/IDQgOiAwOyBpIDwgZGlmZnN0ci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZGlmZnN0cltpXVswXSA9PT0gIkAiKSB7CiAgICAgICAgICAgICAgdmFyIG1laCA9IGRpZmZzdHJbaV0uc3BsaXQoL0BAIC0oXGQrKSwoXGQrKSBcKyhcZCspLChcZCspIEBALyk7CiAgICAgICAgICAgICAgZGlmZi51bnNoaWZ0KHsKICAgICAgICAgICAgICAgIHN0YXJ0OiBtZWhbM10sCiAgICAgICAgICAgICAgICBvbGRsZW5ndGg6IG1laFsyXSwKICAgICAgICAgICAgICAgIG9sZGxpbmVzOiBbXSwKICAgICAgICAgICAgICAgIG5ld2xlbmd0aDogbWVoWzRdLAogICAgICAgICAgICAgICAgbmV3bGluZXM6IFtdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlmZnN0cltpXVswXSA9PT0gIisiKSB7CiAgICAgICAgICAgICAgZGlmZlswXS5uZXdsaW5lcy5wdXNoKGRpZmZzdHJbaV0uc3Vic3RyKDEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkaWZmc3RyW2ldWzBdID09PSAiLSIpIHsKICAgICAgICAgICAgICBkaWZmWzBdLm9sZGxpbmVzLnB1c2goZGlmZnN0cltpXS5zdWJzdHIoMSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRpZmZzdHJbaV1bMF0gPT09ICIgIikgewogICAgICAgICAgICAgIGRpZmZbMF0ubmV3bGluZXMucHVzaChkaWZmc3RyW2ldLnN1YnN0cigxKSk7CiAgICAgICAgICAgICAgZGlmZlswXS5vbGRsaW5lcy5wdXNoKGRpZmZzdHJbaV0uc3Vic3RyKDEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkaWZmc3RyW2ldWzBdID09PSAiXFwiKSB7CiAgICAgICAgICAgICAgaWYgKGRpZmZzdHJbaSAtIDFdWzBdID09PSAiKyIpIHsKICAgICAgICAgICAgICAgIHJlbUVPRk5MID0gdHJ1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpZmZzdHJbaSAtIDFdWzBdID09PSAiLSIpIHsKICAgICAgICAgICAgICAgIGFkZEVPRk5MID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdHIgPSBvbGRTdHIuc3BsaXQoIlxuIik7CiAgICAgICAgICBmb3IgKHZhciBpID0gZGlmZi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICB2YXIgZCA9IGRpZmZbaV07CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZC5vbGRsZW5ndGg7IGorKykgewogICAgICAgICAgICAgIGlmIChzdHJbZC5zdGFydCAtIDEgKyBqXSAhPT0gZC5vbGRsaW5lc1tqXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KHN0ciwgWyBkLnN0YXJ0IC0gMSwgK2Qub2xkbGVuZ3RoIF0uY29uY2F0KGQubmV3bGluZXMpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZW1FT0ZOTCkgewogICAgICAgICAgICB3aGlsZSAoIXN0cltzdHIubGVuZ3RoIC0gMV0pIHsKICAgICAgICAgICAgICBzdHIucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYWRkRU9GTkwpIHsKICAgICAgICAgICAgc3RyLnB1c2goIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0ci5qb2luKCJcbiIpOwogICAgICAgIH0sCiAgICAgICAgY29udmVydENoYW5nZXNUb1hNTDogZnVuY3Rpb24oY2hhbmdlcykgewogICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VzW2ldOwogICAgICAgICAgICBpZiAoY2hhbmdlLmFkZGVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjxpbnM+Iik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnJlbW92ZWQpIHsKICAgICAgICAgICAgICByZXQucHVzaCgiPGRlbD4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXQucHVzaChlc2NhcGVIVE1MKGNoYW5nZS52YWx1ZSkpOwogICAgICAgICAgICBpZiAoY2hhbmdlLmFkZGVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjwvaW5zPiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS5yZW1vdmVkKSB7CiAgICAgICAgICAgICAgcmV0LnB1c2goIjwvZGVsPiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmV0LmpvaW4oIiIpOwogICAgICAgIH0sCiAgICAgICAgY29udmVydENoYW5nZXNUb0RNUDogZnVuY3Rpb24oY2hhbmdlcykgewogICAgICAgICAgdmFyIHJldCA9IFtdLCBjaGFuZ2U7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2hhbmdlID0gY2hhbmdlc1tpXTsKICAgICAgICAgICAgcmV0LnB1c2goWyBjaGFuZ2UuYWRkZWQgPyAxIDogY2hhbmdlLnJlbW92ZWQgPyAtMSA6IDAsIGNoYW5nZS52YWx1ZSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICB9OwogICAgfSgpOwogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gSnNEaWZmOwogICAgfQogIH0sCiAgIjUuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIHZhbHVlcyA9IGJhc2lzLm9iamVjdC52YWx1ZXM7CiAgICB2YXIgJHNlbGYgPSBiYXNpcy5mbi4kc2VsZjsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBldmVudHMgPSBiYXNpcy5ldmVudC5ldmVudHM7CiAgICB2YXIgTlVMTF9PQkpFQ1QgPSB7fTsKICAgIHZhciBFTVBUWV9BUlJBWSA9IFtdOwogICAgdmFyIFNUQVRFX0VYSVNUUyA9IHt9OwogICAgdmFyIFNUQVRFID0gewogICAgICBwcmlvcml0eTogW10sCiAgICAgIHZhbHVlczoge30sCiAgICAgIGFkZDogZnVuY3Rpb24oc3RhdGUsIG9yZGVyKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzdGF0ZTsKICAgICAgICB2YXIgdmFsdWUgPSBzdGF0ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIFNUQVRFW25hbWVdID0gdmFsdWU7CiAgICAgICAgU1RBVEVfRVhJU1RTW3ZhbHVlXSA9IG5hbWU7CiAgICAgICAgdGhpcy52YWx1ZXNbdmFsdWVdID0gbmFtZTsKICAgICAgICBpZiAob3JkZXIpIG9yZGVyID0gdGhpcy5wcmlvcml0eS5pbmRleE9mKG9yZGVyKTsgZWxzZSBvcmRlciA9IC0xOwogICAgICAgIGlmIChvcmRlciA9PSAtMSkgdGhpcy5wcmlvcml0eS5wdXNoKHZhbHVlKTsgZWxzZSB0aGlzLnByaW9yaXR5LnNwbGljZShvcmRlciwgMCwgdmFsdWUpOwogICAgICB9LAogICAgICBnZXRMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdmFsdWVzKFNUQVRFX0VYSVNUUyk7CiAgICAgIH0KICAgIH07CiAgICBTVEFURS5hZGQoIlJFQURZIik7CiAgICBTVEFURS5hZGQoIkRFUFJFQ0FURUQiKTsKICAgIFNUQVRFLmFkZCgiVU5ERUZJTkVEIik7CiAgICBTVEFURS5hZGQoIkVSUk9SIik7CiAgICBTVEFURS5hZGQoIlBST0NFU1NJTkciKTsKICAgIHZhciBzdWJzY3JpcHRpb25Db25maWcgPSB7fTsKICAgIHZhciBzdWJzY3JpcHRpb25TZWVkID0gMTsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSB7CiAgICAgIE5PTkU6IDAsCiAgICAgIEFMTDogMCwKICAgICAgbGluazogZnVuY3Rpb24odHlwZSwgZnJvbSwgdG8pIHsKICAgICAgICB2YXIgc3Vic2NyaWJlcklkID0gdHlwZSArIGZyb20uYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgc3Vic2NyaWJlcnMgPSB0by5zdWJzY3JpYmVyc187CiAgICAgICAgaWYgKCFzdWJzY3JpYmVycykgc3Vic2NyaWJlcnMgPSB0by5zdWJzY3JpYmVyc18gPSB7fTsKICAgICAgICBpZiAoIXN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF0pIHsKICAgICAgICAgIHN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF0gPSBmcm9tOwogICAgICAgICAgdmFyIGNvdW50ID0gdG8uc3Vic2NyaWJlckNvdW50ICs9IDE7CiAgICAgICAgICBpZiAoY291bnQgPT0gMSkgdG8uZW1pdF9zdWJzY3JpYmVyc0NoYW5nZWQoKzEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiQXR0ZW1wdCB0byBhZGQgZHVwbGljYXRlIHN1YnNjcmlwdGlvbiIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdW5saW5rOiBmdW5jdGlvbih0eXBlLCBmcm9tLCB0bykgewogICAgICAgIHZhciBzdWJzY3JpYmVySWQgPSB0eXBlICsgZnJvbS5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXzsKICAgICAgICBpZiAoc3Vic2NyaWJlcnMgJiYgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSkgewogICAgICAgICAgZGVsZXRlIHN1YnNjcmliZXJzW3N1YnNjcmliZXJJZF07CiAgICAgICAgICB2YXIgY291bnQgPSB0by5zdWJzY3JpYmVyQ291bnQgLT0gMTsKICAgICAgICAgIGlmIChjb3VudCA9PSAwKSB7CiAgICAgICAgICAgIHRvLmVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkKC0xKTsKICAgICAgICAgICAgdG8uc3Vic2NyaWJlcnNfID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlRyeWluZyByZW1vdmUgbm9uLWV4aXN0cyBzdWJzY3JpcHRpb24iKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24obmFtZSwgaGFuZGxlciwgYWN0aW9uKSB7CiAgICAgICAgc3Vic2NyaXB0aW9uQ29uZmlnW3N1YnNjcmlwdGlvblNlZWRdID0gewogICAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICAgIGFjdGlvbjogYWN0aW9uCiAgICAgICAgfTsKICAgICAgICBTVUJTQ1JJUFRJT05bbmFtZV0gPSBzdWJzY3JpcHRpb25TZWVkOwogICAgICAgIFNVQlNDUklQVElPTi5BTEwgfD0gc3Vic2NyaXB0aW9uU2VlZDsKICAgICAgICBzdWJzY3JpcHRpb25TZWVkIDw8PSAxOwogICAgICB9LAogICAgICBhZGRQcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHlOYW1lLCBldmVudE5hbWUpIHsKICAgICAgICB2YXIgaGFuZGxlciA9IHt9OwogICAgICAgIGhhbmRsZXJbZXZlbnROYW1lIHx8IHByb3BlcnR5TmFtZSArICJDaGFuZ2VkIl0gPSBmdW5jdGlvbihvYmplY3QsIG9sZFZhbHVlKSB7CiAgICAgICAgICBpZiAob2xkVmFsdWUpIFNVQlNDUklQVElPTi51bmxpbmsocHJvcGVydHlOYW1lLCBvYmplY3QsIG9sZFZhbHVlKTsKICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHlOYW1lXSkgU1VCU0NSSVBUSU9OLmxpbmsocHJvcGVydHlOYW1lLCBvYmplY3QsIG9iamVjdFtwcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9OwogICAgICAgIHRoaXMuYWRkKHByb3BlcnR5TmFtZS50b1VwcGVyQ2FzZSgpLCBoYW5kbGVyLCBmdW5jdGlvbihmbiwgb2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0W3Byb3BlcnR5TmFtZV0pIGZuKHByb3BlcnR5TmFtZSwgb2JqZWN0LCBvYmplY3RbcHJvcGVydHlOYW1lXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgbWFza0NvbmZpZyA9IHt9OwogICAgZnVuY3Rpb24gbWl4RnVuY3Rpb25zKGZuQSwgZm5CKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBmbkEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBmbkIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE1hc2tDb25maWcobWFzaykgewogICAgICB2YXIgY29uZmlnID0gbWFza0NvbmZpZ1ttYXNrXTsKICAgICAgaWYgKCFjb25maWcpIHsKICAgICAgICB2YXIgYWN0aW9ucyA9IFtdOwogICAgICAgIHZhciBoYW5kbGVyID0ge307CiAgICAgICAgdmFyIGlkeCA9IDE7CiAgICAgICAgY29uZmlnID0gbWFza0NvbmZpZ1ttYXNrXSA9IHsKICAgICAgICAgIGFjdGlvbnM6IGFjdGlvbnMsCiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyCiAgICAgICAgfTsKICAgICAgICB3aGlsZSAobWFzaykgewogICAgICAgICAgaWYgKG1hc2sgJiAxKSB7CiAgICAgICAgICAgIHZhciBjZmcgPSBzdWJzY3JpcHRpb25Db25maWdbaWR4XTsKICAgICAgICAgICAgYWN0aW9ucy5wdXNoKGNmZy5hY3Rpb24pOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY2ZnLmhhbmRsZXIpIGhhbmRsZXJba2V5XSA9IGhhbmRsZXJba2V5XSA/IG1peEZ1bmN0aW9ucyhoYW5kbGVyW2tleV0sIGNmZy5oYW5kbGVyW2tleV0pIDogY2ZnLmhhbmRsZXJba2V5XTsKICAgICAgICAgIH0KICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgIG1hc2sgPj49IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjb25maWc7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRTdWIob2JqZWN0LCBtYXNrKSB7CiAgICAgIHZhciBjb25maWcgPSBnZXRNYXNrQ29uZmlnKG1hc2spOwogICAgICBmb3IgKHZhciBpID0gMCwgYWN0aW9uOyBhY3Rpb24gPSBjb25maWcuYWN0aW9uc1tpXTsgaSsrKSBhY3Rpb24oU1VCU0NSSVBUSU9OLmxpbmssIG9iamVjdCk7CiAgICAgIG9iamVjdC5hZGRIYW5kbGVyKGNvbmZpZy5oYW5kbGVyKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbVN1YihvYmplY3QsIG1hc2spIHsKICAgICAgdmFyIGNvbmZpZyA9IGdldE1hc2tDb25maWcobWFzayk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2krK107ICkgYWN0aW9uKFNVQlNDUklQVElPTi51bmxpbmssIG9iamVjdCk7CiAgICAgIG9iamVjdC5yZW1vdmVIYW5kbGVyKGNvbmZpZy5oYW5kbGVyKTsKICAgIH0KICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgiZGVsZWdhdGUiKTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgidGFyZ2V0Iik7CiAgICBTVUJTQ1JJUFRJT04uYWRkUHJvcGVydHkoImRhdGFzZXQiKTsKICAgIHZhciBBYnN0cmFjdERhdGEgPSBDbGFzcyhFbWl0dGVyLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdERhdGEiLAogICAgICBzdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X3N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInN0YXRlQ2hhbmdlZCIsICJvbGRTdGF0ZSIpLAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBlbWl0X2FjdGl2ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJhY3RpdmVDaGFuZ2VkIiksCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uTk9ORSwKICAgICAgc3Vic2NyaWJlckNvdW50OiAwLAogICAgICBzdWJzY3JpYmVyc186IG51bGwsCiAgICAgIGVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3Vic2NyaWJlcnNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHN5bmNFdmVudHM6IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHkoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNTeW5jUmVxdWlyZWQoKSkgdGhpcy5zeW5jQWN0aW9uKCk7CiAgICAgIH0sIHsKICAgICAgICBzdGF0ZUNoYW5nZWQ6IHRydWUsCiAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiB0cnVlCiAgICAgIH0pLAogICAgICBzeW5jQWN0aW9uOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLmFkZEhhbmRsZXIoZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKS5oYW5kbGVyKTsKICAgICAgICB2YXIgc3luY0FjdGlvbiA9IHRoaXMuc3luY0FjdGlvbjsKICAgICAgICBpZiAoc3luY0FjdGlvbikgewogICAgICAgICAgdGhpcy5zeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0U3luY0FjdGlvbihzeW5jQWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN0YXRlOiBmdW5jdGlvbihzdGF0ZSwgZGF0YSkgewogICAgICAgIHZhciBzdGF0ZUNvZGUgPSBTdHJpbmcoc3RhdGUpOwogICAgICAgIGlmICghU1RBVEVfRVhJU1RTW3N0YXRlQ29kZV0pIHRocm93IG5ldyBFcnJvcigiV3Jvbmcgc3RhdGUgdmFsdWUiKTsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgdGhpcy5zdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLnN0YXRlLmRhdGEgPSBkYXRhOwogICAgICAgICAgdGhpcy5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBkZXByZWNhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0YXRlICE9IFNUQVRFLlBST0NFU1NJTkcpIHRoaXMuc2V0U3RhdGUoU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldEFjdGl2ZTogZnVuY3Rpb24oaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9ICEhaXNBY3RpdmU7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlICE9IGlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgdGhpcy5lbWl0X2FjdGl2ZUNoYW5nZWQoKTsKICAgICAgICAgIGlmIChpc0FjdGl2ZSkgYWRkU3ViKHRoaXMsIHRoaXMuc3Vic2NyaWJlVG8pOyBlbHNlIHJlbVN1Yih0aGlzLCB0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIHNldFN1YnNjcmlwdGlvbjogZnVuY3Rpb24oc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIHZhciBjdXJTdWJzY3JpcHRpb25UeXBlID0gdGhpcy5zdWJzY3JpYmVUbzsKICAgICAgICB2YXIgbmV3U3Vic2NyaXB0aW9uVHlwZSA9IHN1YnNjcmlwdGlvblR5cGUgJiBTVUJTQ1JJUFRJT04uQUxMOwogICAgICAgIHZhciBkZWx0YSA9IGN1clN1YnNjcmlwdGlvblR5cGUgXiBuZXdTdWJzY3JpcHRpb25UeXBlOwogICAgICAgIGlmIChkZWx0YSkgewogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUbyA9IG5ld1N1YnNjcmlwdGlvblR5cGU7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgdmFyIGN1ckNvbmZpZyA9IGdldE1hc2tDb25maWcoY3VyU3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIHZhciBuZXdDb25maWcgPSBnZXRNYXNrQ29uZmlnKG5ld1N1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoY3VyQ29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIobmV3Q29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICAgICAgd2hpbGUgKGRlbHRhKSB7CiAgICAgICAgICAgICAgaWYgKGRlbHRhICYgMSkgewogICAgICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICAgICAgaWYgKGN1clN1YnNjcmlwdGlvblR5cGUgJiBpZHgpIGNmZy5hY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgdGhpcyk7IGVsc2UgY2ZnLmFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgdGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgICAgICBkZWx0YSA+Pj0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZXJDb3VudCA+IDAgJiYgKHRoaXMuc3RhdGUgPT0gU1RBVEUuVU5ERUZJTkVEIHx8IHRoaXMuc3RhdGUgPT0gU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICB2YXIgb2xkQWN0aW9uID0gdGhpcy5zeW5jQWN0aW9uOwogICAgICAgIGlmICh0eXBlb2Ygc3luY0FjdGlvbiAhPSAiZnVuY3Rpb24iKSBzeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICB0aGlzLnN5bmNBY3Rpb24gPSBzeW5jQWN0aW9uOwogICAgICAgIGlmIChzeW5jQWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW9sZEFjdGlvbikgdGhpcy5hZGRIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgICBpZiAodGhpcy5pc1N5bmNSZXF1aXJlZCgpKSB0aGlzLnN5bmNBY3Rpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9sZEFjdGlvbikgdGhpcy5yZW1vdmVIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04udW5saW5rLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGF0ZSA9IFNUQVRFLlVOREVGSU5FRDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgY29tcHV0ZUZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIHZhbHVlU2V0dGVycyA9IHt9OwogICAgdmFyIHZhbHVlU3luY1Rva2VuID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5zZXQodGhpcy5mbih2YWx1ZSkpOwogICAgfTsKICAgIHZhciBWQUxVRV9FTU1JVEVSX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHRoaXMudmFsdWUudW5saW5rKG9iamVjdCwgdGhpcy5mbik7CiAgICAgIH0KICAgIH07CiAgICB2YXIgVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHRoaXMuc2V0KG51bGwpOwogICAgICB9CiAgICB9OwogICAgdmFyIFZhbHVlID0gQ2xhc3MoQWJzdHJhY3REYXRhLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5WYWx1ZSIsCiAgICAgIGVtaXRfY2hhbmdlOiBjcmVhdGVFdmVudCgiY2hhbmdlIiwgIm9sZFZhbHVlIikgJiYgZnVuY3Rpb24ob2xkVmFsdWUpIHsKICAgICAgICBldmVudHMuY2hhbmdlLmNhbGwodGhpcywgb2xkVmFsdWUpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBjdXJzb3IuZm4uY2FsbChjdXJzb3IuY29udGV4dCwgdGhpcy52YWx1ZSwgb2xkVmFsdWUpOwogICAgICB9LAogICAgICB2YWx1ZTogbnVsbCwKICAgICAgaW5pdFZhbHVlOiBudWxsLAogICAgICBwcm94eTogbnVsbCwKICAgICAgbG9ja2VkOiBmYWxzZSwKICAgICAgbG9ja2VkVmFsdWVfOiBudWxsLAogICAgICBsaW5rc186IG51bGwsCiAgICAgIHNldE51bGxPbkVtaXR0ZXJEZXN0cm95OiB0cnVlLAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbihob3N0LCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaG9zdC5saW5rKGNvbnRleHQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGhvc3QudW5saW5rKGNvbnRleHQsIGNhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgICAgcmV0dXJuIGhvc3QudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5wcm94eSkgdGhpcy52YWx1ZSA9IHRoaXMucHJveHkodGhpcy52YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kgJiYgdGhpcy52YWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIHRoaXMudmFsdWUuYWRkSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy52YWx1ZTsKICAgICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnByb3h5ID8gdGhpcy5wcm94eSh2YWx1ZSkgOiB2YWx1ZTsKICAgICAgICB2YXIgY2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBvbGRWYWx1ZTsKICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgb2xkVmFsdWUucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIG5ld1ZhbHVlLmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgdGhpcy5lbWl0X2NoYW5nZShvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy5pbml0VmFsdWUpOwogICAgICB9LAogICAgICBsb2NrOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMubG9ja2VkKSB7CiAgICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLmxvY2tlZFZhbHVlXyA9IHRoaXMudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmxvY2tlZCkgewogICAgICAgICAgdmFyIGxvY2tlZFZhbHVlID0gdGhpcy5sb2NrZWRWYWx1ZV87CiAgICAgICAgICB0aGlzLmxvY2tlZFZhbHVlXyA9IG51bGw7CiAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IGxvY2tlZFZhbHVlKSB0aGlzLmVtaXRfY2hhbmdlKGxvY2tlZFZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICBmbiA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBob3N0VmFsdWUgPSB0aGlzOwogICAgICAgIHZhciBoYW5kbGVyID0gYmFzaXMuZXZlbnQuY3JlYXRlSGFuZGxlcihldmVudHMsIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgdGhpcy5zZXQoZm4ob2JqZWN0LCBob3N0VmFsdWUudmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgZ2V0Q29tcHV0ZVRva2VuSWQgPSBoYW5kbGVyLmV2ZW50cy5jb25jYXQoU3RyaW5nKGZuKSwgdGhpcy5iYXNpc09iamVjdElkKS5qb2luKCJfIik7CiAgICAgICAgdmFyIGdldENvbXB1dGVUb2tlbiA9IGNvbXB1dGVGdW5jdGlvbnNbZ2V0Q29tcHV0ZVRva2VuSWRdOwogICAgICAgIGlmICghZ2V0Q29tcHV0ZVRva2VuKSB7CiAgICAgICAgICB2YXIgdG9rZW5NYXAgPSB7fTsKICAgICAgICAgIGhhbmRsZXIuZGVzdHJveSA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgdG9rZW5NYXBbb2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoewogICAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0b2tlbk1hcCkgewogICAgICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtrZXldOwogICAgICAgICAgICAgICAgcGFpci50b2tlbi5zZXQoZm4ocGFpci5vYmplY3QsIHRoaXMudmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0b2tlbk1hcCkgewogICAgICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtrZXldOwogICAgICAgICAgICAgICAgcGFpci5vYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBwYWlyLnRva2VuKTsKICAgICAgICAgICAgICAgIHBhaXIudG9rZW4uZGVzdHJveSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0b2tlbk1hcCA9IG51bGw7CiAgICAgICAgICAgICAgaG9zdFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBnZXRDb21wdXRlVG9rZW4gPSBjb21wdXRlRnVuY3Rpb25zW2dldENvbXB1dGVUb2tlbklkXSA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlciA9PSBmYWxzZSkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRhdGEuVmFsdWUjY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBiYXNpcy5ldmVudC5FbWl0dGVyIik7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZm4ob2JqZWN0LCBob3N0VmFsdWUudmFsdWUpOwogICAgICAgICAgICBpZiAoIXBhaXIpIHsKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBuZXcgYmFzaXMuVG9rZW4odmFsdWUpOwogICAgICAgICAgICAgIG9iamVjdC5hZGRIYW5kbGVyKGhhbmRsZXIsIHRva2VuKTsKICAgICAgICAgICAgICBwYWlyID0gdG9rZW5NYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgICAgdG9rZW46IHRva2VuLAogICAgICAgICAgICAgICAgb2JqZWN0OiBvYmplY3QKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhaXIudG9rZW4uc2V0KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFpci50b2tlbjsKICAgICAgICAgIH07CiAgICAgICAgICBnZXRDb21wdXRlVG9rZW4uZGVmZXJyZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBnZXRDb21wdXRlVG9rZW4ob2JqZWN0KS5kZWZlcnJlZCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldENvbXB1dGVUb2tlbjsKICAgICAgfSwKICAgICAgYXM6IGZ1bmN0aW9uKGZuLCBkZWZlcnJlZCkgewogICAgICAgIGlmICh0aGlzLmxpbmtzXykgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4gJiYgY3Vyc29yLmNvbnRleHQuZm4gPT0gU3RyaW5nKGZuKSkgcmV0dXJuIGRlZmVycmVkID8gY3Vyc29yLmNvbnRleHQuZGVmZXJyZWQoKSA6IGN1cnNvci5jb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgdG9rZW4gPSBuZXcgYmFzaXMuVG9rZW47CiAgICAgICAgdG9rZW4uZm4gPSBmbjsKICAgICAgICB0aGlzLmxpbmsodG9rZW4sIHZhbHVlU3luY1Rva2VuKTsKICAgICAgICByZXR1cm4gZGVmZXJyZWQgPyB0b2tlbi5kZWZlcnJlZCgpIDogdG9rZW47CiAgICAgIH0sCiAgICAgIGRlZmVycmVkOiBmdW5jdGlvbihmbikgewogICAgICAgIHJldHVybiB0aGlzLmFzKGZuLCB0cnVlKTsKICAgICAgfSwKICAgICAgbGluazogZnVuY3Rpb24oY29udGV4dCwgZm4sIG5vQXBwbHkpIHsKICAgICAgICBpZiAodHlwZW9mIGZuICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eSA9IFN0cmluZyhmbik7CiAgICAgICAgICBmbiA9IHZhbHVlU2V0dGVyc1twcm9wZXJ0eV07CiAgICAgICAgICBpZiAoIWZuKSBmbiA9IHZhbHVlU2V0dGVyc1twcm9wZXJ0eV0gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5saW5rc18pIGlmIChjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCAmJiBjdXJzb3IuZm4gPT09IGZuKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIjYXR0YWNoOiBEdXBsaWNhdGUgbGluayBwYWlyIGNvbnRleHQtZm4iKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB0aGlzLmxpbmtzXyA9IHsKICAgICAgICAgIHZhbHVlOiB0aGlzLAogICAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgIGxpbmtzXzogdGhpcy5saW5rc18KICAgICAgICB9OwogICAgICAgIGlmIChjb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY29udGV4dC5hZGRIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgdGhpcy5saW5rc18pOwogICAgICAgIGlmICghbm9BcHBseSkgZm4uY2FsbChjb250ZXh0LCB0aGlzLnZhbHVlKTsKICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgfSwKICAgICAgdW5saW5rOiBmdW5jdGlvbihjb250ZXh0LCBmbikgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHZhciBwcmV2OwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBpZiAoY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQgJiYgKCFmbiB8fCBjdXJzb3IuZm4gPT09IGZuKSkgewogICAgICAgICAgY3Vyc29yLmZuID0gYmFzaXMuZm4uJHVuZGVmOwogICAgICAgICAgcHJldi5saW5rc18gPSBjdXJzb3IubGlua3NfOwogICAgICAgICAgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY3Vyc29yLmNvbnRleHQucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0hBTkRMRVIsIGN1cnNvcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5zZXROdWxsT25FbWl0dGVyRGVzdHJveSAmJiB0aGlzLnZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgdGhpcy52YWx1ZS5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfREVTVFJPWV9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0IGluc3RhbmNlb2YgRW1pdHRlcikgY3Vyc29yLmNvbnRleHQucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0hBTkRMRVIsIGN1cnNvcik7CiAgICAgICAgdGhpcy5wcm94eSA9IG51bGw7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSBudWxsOwogICAgICAgIHRoaXMudmFsdWUgPSBudWxsOwogICAgICAgIHRoaXMubG9ja2VkVmFsdWVfID0gbnVsbDsKICAgICAgICB0aGlzLmxpbmtzXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGNhc3RWYWx1ZU1hcCA9IHt9OwogICAgVmFsdWUuZnJvbSA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICBpZiAob2JqIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgaGFuZGxlciA9IGJhc2lzLmV2ZW50LmNyZWF0ZUhhbmRsZXIoZXZlbnRzLCBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHRoaXMuc2V0KGdldHRlcihvYmplY3QpKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaWQgPSBoYW5kbGVyLmV2ZW50cy5jb25jYXQoU3RyaW5nKGdldHRlciksIG9iai5iYXNpc09iamVjdElkKS5qb2luKCJfIik7CiAgICAgICAgcmVzdWx0ID0gY2FzdFZhbHVlTWFwW2lkXTsKICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlcik7CiAgICAgICAgICByZXN1bHQgPSBjYXN0VmFsdWVNYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgdmFsdWU6IGdldHRlcihvYmopCiAgICAgICAgICB9KTsKICAgICAgICAgIGhhbmRsZXIuZGVzdHJveSA9IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICBkZWxldGUgY2FzdFZhbHVlTWFwW2lkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9OwogICAgICAgICAgb2JqLmFkZEhhbmRsZXIoaGFuZGxlciwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICB2YXIgaWQgPSBvYmouYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgYmluZGluZ0JyaWRnZSA9IG9iai5iaW5kaW5nQnJpZGdlOwogICAgICAgIGlmIChpZCAmJiBiaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICByZXN1bHQgPSBjYXN0VmFsdWVNYXBbaWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gY2FzdFZhbHVlTWFwW2lkXSA9IG5ldyBWYWx1ZSh7CiAgICAgICAgICAgICAgdmFsdWU6IGJpbmRpbmdCcmlkZ2UuZ2V0KG9iaikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJpbmRpbmdCcmlkZ2UuYXR0YWNoKG9iaiwgcmVzdWx0LnNldCwgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFyZXN1bHQpIHRocm93ICJCYWQgb2JqZWN0IHR5cGUiOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIFZhbHVlLmZhY3RvcnkgPSBmdW5jdGlvbihldmVudHMsIGdldHRlcikgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIFZhbHVlLmZyb20ob2JqZWN0LCBldmVudHMsIGdldHRlcik7CiAgICAgIH07CiAgICB9OwogICAgZnVuY3Rpb24gaXNDb25uZWN0ZWQoYSwgYikgewogICAgICB3aGlsZSAoYiAmJiBiICE9PSBhICYmIGIgIT09IGIuZGVsZWdhdGUpIGIgPSBiLmRlbGVnYXRlOwogICAgICByZXR1cm4gYiA9PT0gYTsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5RGVsZWdhdGVDaGFuZ2VzKG9iamVjdCwgb2xkUm9vdCwgb2xkVGFyZ2V0KSB7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IG9iamVjdC5kZWxlZ2F0ZTsKICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgb2JqZWN0LnJvb3QgPSBkZWxlZ2F0ZS5yb290OwogICAgICAgIG9iamVjdC50YXJnZXQgPSBkZWxlZ2F0ZS50YXJnZXQ7CiAgICAgICAgb2JqZWN0LmRhdGEgPSBkZWxlZ2F0ZS5kYXRhOwogICAgICAgIG9iamVjdC5zdGF0ZSA9IGRlbGVnYXRlLnN0YXRlOwogICAgICB9CiAgICAgIGlmIChvYmplY3Qucm9vdCAhPT0gb2xkUm9vdCkgewogICAgICAgIHZhciByb290TGlzdGVuSGFuZGxlciA9IG9iamVjdC5saXN0ZW4ucm9vdDsKICAgICAgICBpZiAocm9vdExpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgIGlmIChvbGRSb290ICYmIG9sZFJvb3QgIT09IG9iamVjdCkgb2xkUm9vdC5yZW1vdmVIYW5kbGVyKHJvb3RMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgICAgaWYgKG9iamVjdC5yb290ICYmIG9iamVjdC5yb290ICE9PSBvYmplY3QpIG9iamVjdC5yb290LmFkZEhhbmRsZXIocm9vdExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgfQogICAgICAgIG9iamVjdC5lbWl0X3Jvb3RDaGFuZ2VkKG9sZFJvb3QpOwogICAgICB9CiAgICAgIGlmIChvYmplY3QudGFyZ2V0ICE9PSBvbGRUYXJnZXQpIHsKICAgICAgICB2YXIgdGFyZ2V0TGlzdGVuSGFuZGxlciA9IG9iamVjdC5saXN0ZW4udGFyZ2V0OwogICAgICAgIGlmICh0YXJnZXRMaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICBpZiAob2xkVGFyZ2V0ICYmIG9sZFRhcmdldCAhPT0gb2JqZWN0KSBvbGRUYXJnZXQucmVtb3ZlSGFuZGxlcih0YXJnZXRMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgICAgaWYgKG9iamVjdC50YXJnZXQgJiYgb2JqZWN0LnRhcmdldCAhPT0gb2JqZWN0KSBvYmplY3QudGFyZ2V0LmFkZEhhbmRsZXIodGFyZ2V0TGlzdGVuSGFuZGxlciwgb2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LmVtaXRfdGFyZ2V0Q2hhbmdlZChvbGRUYXJnZXQpOwogICAgICB9CiAgICAgIHZhciBjdXJzb3IgPSBvYmplY3QuZGVsZWdhdGVzXzsKICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIGFwcGx5RGVsZWdhdGVDaGFuZ2VzKGN1cnNvci5kZWxlZ2F0ZSwgb2xkUm9vdCwgb2xkVGFyZ2V0KTsKICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgfQogICAgfQogICAgdmFyIERhdGFPYmplY3QgPSBDbGFzcyhBYnN0cmFjdERhdGEsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk9iamVjdCIsCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uREVMRUdBVEUgKyBTVUJTQ1JJUFRJT04uVEFSR0VULAogICAgICBkYXRhOiBudWxsLAogICAgICBlbWl0X3VwZGF0ZTogY3JlYXRlRXZlbnQoInVwZGF0ZSIsICJkZWx0YSIpICYmIGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICBldmVudHMudXBkYXRlLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIGN1cnNvci5kZWxlZ2F0ZS5lbWl0X3VwZGF0ZShkZWx0YSk7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVtaXRfc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihvbGRTdGF0ZSkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5lbWl0X3N0YXRlQ2hhbmdlZC5jYWxsKHRoaXMsIG9sZFN0YXRlKTsKICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmRlbGVnYXRlKSB7CiAgICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5zdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlOiBudWxsLAogICAgICBkZWxlZ2F0ZXNfOiBudWxsLAogICAgICBkZWJ1Z19kZWxlZ2F0ZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGN1cnNvci5kZWxlZ2F0ZSk7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZW1pdF9kZWxlZ2F0ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJkZWxlZ2F0ZUNoYW5nZWQiLCAib2xkRGVsZWdhdGUiKSwKICAgICAgdGFyZ2V0OiBudWxsLAogICAgICBlbWl0X3RhcmdldENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJ0YXJnZXRDaGFuZ2VkIiwgIm9sZFRhcmdldCIpLAogICAgICByb290OiBudWxsLAogICAgICBlbWl0X3Jvb3RDaGFuZ2VkOiBjcmVhdGVFdmVudCgicm9vdENoYW5nZWQiLCAib2xkUm9vdCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvb3QgPSB0aGlzOwogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXMuZGVsZWdhdGU7CiAgICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGF0YSA9IGRlbGVnYXRlLmRhdGE7CiAgICAgICAgICB0aGlzLnN0YXRlID0gZGVsZWdhdGUuc3RhdGU7CiAgICAgICAgICB0aGlzLnNldERlbGVnYXRlKGRlbGVnYXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCF0aGlzLmRhdGEpIHRoaXMuZGF0YSA9IHt9OwogICAgICAgICAgaWYgKHRoaXMudGFyZ2V0ICE9PSBudWxsKSB0aGlzLnRhcmdldCA9IHRoaXM7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTeW5jQWN0aW9uOiBmdW5jdGlvbihzeW5jQWN0aW9uKSB7CiAgICAgICAgaWYgKHN5bmNBY3Rpb24gJiYgdGhpcy5kZWxlZ2F0ZSkgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5zeW5jQWN0aW9uICsgIiBpbnN0YW5jZSBoYXMgYSBkZWxlZ2F0ZSBhbmQgc3luY0FjdGlvbiAtIGl0IG1heSBwcm9kdWNlIGNvbmZsaWNzIHdpdGggZGF0YSAmIHN0YXRlIik7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5zZXRTeW5jQWN0aW9uLmNhbGwodGhpcywgc3luY0FjdGlvbik7CiAgICAgIH0sCiAgICAgIHNldERlbGVnYXRlOiBmdW5jdGlvbihuZXdEZWxlZ2F0ZSkgewogICAgICAgIGlmIChuZXdEZWxlZ2F0ZSAmJiBuZXdEZWxlZ2F0ZSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZSAmJiBpc0Nvbm5lY3RlZCh0aGlzLCBuZXdEZWxlZ2F0ZSkpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIk5ldyBkZWxlZ2F0ZSBoYXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gb2JqZWN0LiBEZWxlZ2F0ZSBhc3NpZ25tZW50IGhhcyBiZWVuIGlnbm9yZWQuIiwgdGhpcywgbmV3RGVsZWdhdGUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld0RlbGVnYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUgIT09IG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLnN0YXRlOwogICAgICAgICAgdmFyIG9sZERhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICB2YXIgb2xkRGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwogICAgICAgICAgdmFyIG9sZFRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgICAgdmFyIG9sZFJvb3QgPSB0aGlzLnJvb3Q7CiAgICAgICAgICB2YXIgZGVsdGEgPSB7fTsKICAgICAgICAgIHZhciBkYXRhQ2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRlbGVnYXRlTGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmRlbGVnYXRlOwogICAgICAgICAgaWYgKG9sZERlbGVnYXRlKSB7CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG9sZERlbGVnYXRlLnJlbW92ZUhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgdmFyIGN1cnNvciA9IG9sZERlbGVnYXRlLmRlbGVnYXRlc187CiAgICAgICAgICAgIHZhciBwcmV2ID0gb2xkRGVsZWdhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgICAgICBpZiAoY3Vyc29yLmRlbGVnYXRlID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICBjdXJzb3IuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKHByZXYgPT09IG9sZERlbGVnYXRlKSBvbGREZWxlZ2F0ZS5kZWxlZ2F0ZXNfID0gY3Vyc29yLm5leHQ7IGVsc2UgcHJldi5uZXh0ID0gY3Vyc29yLm5leHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldiA9IGN1cnNvcjsKICAgICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IubmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBuZXdEZWxlZ2F0ZTsKICAgICAgICAgICAgbmV3RGVsZWdhdGUuZGVsZWdhdGVzXyA9IHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcywKICAgICAgICAgICAgICBuZXh0OiBuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZXNfCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdEZWxlZ2F0ZS5kYXRhKSBpZiAoa2V5IGluIG9sZERhdGEgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZGF0YUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgIGRlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9sZERhdGEpIGlmIChvbGREYXRhW2tleV0gIT09IG5ld0RlbGVnYXRlLmRhdGFba2V5XSkgewogICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICBkZWx0YVtrZXldID0gb2xkRGF0YVtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG5ld0RlbGVnYXRlLmFkZEhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2xkRGF0YSkgdGhpcy5kYXRhW2tleV0gPSBvbGREYXRhW2tleV07CiAgICAgICAgICB9CiAgICAgICAgICBhcHBseURlbGVnYXRlQ2hhbmdlcyh0aGlzLCBvbGRSb290LCBvbGRUYXJnZXQpOwogICAgICAgICAgaWYgKGRhdGFDaGFuZ2VkKSB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIGlmIChvbGRTdGF0ZSAhPT0gdGhpcy5zdGF0ZSAmJiAoU3RyaW5nKG9sZFN0YXRlKSAhPSB0aGlzLnN0YXRlIHx8IG9sZFN0YXRlLmRhdGEgIT09IHRoaXMuc3RhdGUuZGF0YSkpIHRoaXMuZW1pdF9zdGF0ZUNoYW5nZWQob2xkU3RhdGUpOwogICAgICAgICAgdGhpcy5lbWl0X2RlbGVnYXRlQ2hhbmdlZChvbGREZWxlZ2F0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBzZXRTdGF0ZTogZnVuY3Rpb24oc3RhdGUsIGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgcmV0dXJuIHRoaXMucm9vdC5zZXRTdGF0ZShzdGF0ZSwgZGF0YSk7IGVsc2UgcmV0dXJuIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuc2V0U3RhdGUuY2FsbCh0aGlzLCBzdGF0ZSwgZGF0YSk7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGlmICh0aGlzLmRlbGVnYXRlKSByZXR1cm4gdGhpcy5yb290LnVwZGF0ZShkYXRhKTsKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgdmFyIGRlbHRhID0ge307CiAgICAgICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBkYXRhKSBpZiAodGhpcy5kYXRhW3Byb3BdICE9PSBkYXRhW3Byb3BdKSB7CiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICBkZWx0YVtwcm9wXSA9IHRoaXMuZGF0YVtwcm9wXTsKICAgICAgICAgICAgdGhpcy5kYXRhW3Byb3BdID0gZGF0YVtwcm9wXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgICAgIHRoaXMuZW1pdF91cGRhdGUoZGVsdGEpOwogICAgICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICB0aGlzLmRlbGVnYXRlc18gPSBudWxsOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGN1cnNvci5kZWxlZ2F0ZS5zZXREZWxlZ2F0ZSgpOwogICAgICAgICAgY3Vyc29yID0gY3Vyc29yLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRlbGVnYXRlKSB0aGlzLnNldERlbGVnYXRlKCk7CiAgICAgICAgdGhpcy5kYXRhID0gTlVMTF9PQkpFQ1Q7CiAgICAgICAgdGhpcy5yb290ID0gbnVsbDsKICAgICAgICB0aGlzLnRhcmdldCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFNsb3QgPSBDbGFzcyhEYXRhT2JqZWN0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TbG90IgogICAgfSk7CiAgICB2YXIgS0VZT0JKRUNUTUFQX01FTUJFUl9IQU5ETEVSID0gewogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBkZWxldGUgdGhpcy5tYXBbdGhpcy5pdGVtSWRdOwogICAgICB9CiAgICB9OwogICAgdmFyIEtleU9iamVjdE1hcCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLktleU9iamVjdE1hcCIsCiAgICAgIGl0ZW1DbGFzczogRGF0YU9iamVjdCwKICAgICAga2V5R2V0dGVyOiAkc2VsZiwKICAgICAgbWFwXzogbnVsbCwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1hcF8gPSB7fTsKICAgICAgICBjbGVhbmVyLmFkZCh0aGlzKTsKICAgICAgfSwKICAgICAgcmVzb2x2ZTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHRoaXMua2V5R2V0dGVyKG9iamVjdCksIG9iamVjdCk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZTogZnVuY3Rpb24oa2V5LCBvYmplY3QpIHsKICAgICAgICB2YXIgaXRlbUNvbmZpZyA9IHt9OwogICAgICAgIGlmIChrZXkgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICBpdGVtQ29uZmlnLmRlbGVnYXRlID0ga2V5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpdGVtQ29uZmlnLmRhdGEgPSB7CiAgICAgICAgICAgIGlkOiBrZXksCiAgICAgICAgICAgIHRpdGxlOiBrZXkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoaXRlbUNvbmZpZyk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBvYmplY3QpIHsKICAgICAgICB2YXIgaXRlbUlkID0ga2V5IGluc3RhbmNlb2YgRGF0YU9iamVjdCA/IGtleS5iYXNpc09iamVjdElkIDoga2V5OwogICAgICAgIHZhciBpdGVtID0gdGhpcy5tYXBfW2l0ZW1JZF07CiAgICAgICAgaWYgKCFpdGVtICYmIG9iamVjdCkgewogICAgICAgICAgaXRlbSA9IHRoaXMubWFwX1tpdGVtSWRdID0gdGhpcy5jcmVhdGUoa2V5LCBvYmplY3QpOwogICAgICAgICAgaXRlbS5hZGRIYW5kbGVyKEtFWU9CSkVDVE1BUF9NRU1CRVJfSEFORExFUiwgewogICAgICAgICAgICBtYXA6IHRoaXMubWFwXywKICAgICAgICAgICAgaXRlbUlkOiBpdGVtSWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYW5lci5yZW1vdmUodGhpcyk7CiAgICAgICAgdmFyIGl0ZW1zID0gdmFsdWVzKHRoaXMubWFwXyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBpdGVtc1tpKytdOyApIGl0ZW0uZGVzdHJveSgpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERhdGFzZXREZWx0YShhLCBiKSB7CiAgICAgIGlmICghYSB8fCAhYS5pdGVtQ291bnQpIHsKICAgICAgICBpZiAoYiAmJiBiLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgIGluc2VydGVkOiBiLmdldEl0ZW1zKCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghYiB8fCAhYi5pdGVtQ291bnQpIHsKICAgICAgICAgIGlmIChhLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgICAgZGVsZXRlZDogYS5nZXRJdGVtcygpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYS5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBhLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGIuaXRlbXNfID09IGZhbHNlKSBkZWxldGVkLnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYi5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBiLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGEuaXRlbXNfID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRhdGFzZXRXcmFwcGVyIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTRVQsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFzZXQ6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICAgICAgdGhpcy5pdGVtQ291bnQgPSBkYXRhc2V0Lml0ZW1Db3VudDsKICAgICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YXNldCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGF0YXNldDogbnVsbCwKICAgICAgZGF0YXNldEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X2RhdGFzZXRDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YXNldENoYW5nZWQiLCAib2xkRGF0YXNldCIpLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogY3JlYXRlRXZlbnQoIml0ZW1zQ2hhbmdlZCIsICJkZWx0YSIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRhdGFzZXQgPSB0aGlzLmRhdGFzZXQ7CiAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgIHRoaXMuZGF0YXNldCA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldERhdGFzZXQoZGF0YXNldCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhc2V0OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgZGF0YXNldCA9IHJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YXNldCwgZGF0YXNldCwgImRhdGFzZXRBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFzZXQgIT09IGRhdGFzZXQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGF0YXNldDsKICAgICAgICAgIHZhciBvbGREYXRhc2V0ID0gdGhpcy5kYXRhc2V0OwogICAgICAgICAgdmFyIGRlbHRhOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFzZXQpIG9sZERhdGFzZXQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKGRhdGFzZXQpIGRhdGFzZXQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXRlbUNvdW50ID0gZGF0YXNldCA/IGRhdGFzZXQuaXRlbUNvdW50IDogMDsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERhdGFzZXREZWx0YShvbGREYXRhc2V0LCBkYXRhc2V0KSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgICAgdGhpcy5lbWl0X2RhdGFzZXRDaGFuZ2VkKG9sZERhdGFzZXQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LmhhcyhvYmplY3QpIDogbnVsbDsKICAgICAgfSwKICAgICAgZ2V0SXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXQgPyB0aGlzLmRhdGFzZXQuZ2V0SXRlbXMoKSA6IFtdOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnBpY2soKSA6IG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnRvcChjb3VudCkgOiBbXTsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0KSByZXR1cm4gdGhpcy5kYXRhc2V0LmZvckVhY2goZm4pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0IHx8IHRoaXMuZGF0YXNldEFkYXB0ZXJfKSB0aGlzLnNldERhdGFzZXQoKTsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3REYXRhc2V0IiwKICAgICAgaXRlbUNvdW50OiAwLAogICAgICBpdGVtc186IG51bGwsCiAgICAgIG1lbWJlcnNfOiBudWxsLAogICAgICBjYWNoZV86IG51bGwsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBjcmVhdGVFdmVudCgiaXRlbXNDaGFuZ2VkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgaXRlbXM7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBvYmplY3Q7CiAgICAgICAgaWYgKGl0ZW1zID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIHdoaWxlIChvYmplY3QgPSBpdGVtc1tpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgdGhpcy5pdGVtc19bb2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXMgPSBkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICB3aGlsZSAob2JqZWN0ID0gaXRlbXNbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuaXRlbUNvdW50ICs9IGluc2VydENvdW50IC0gZGVsZXRlQ291bnQ7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBpbnNlcnRDb3VudCA9PSB0aGlzLml0ZW1Db3VudCA/IGRlbHRhLmluc2VydGVkIDogbnVsbDsKICAgICAgICBldmVudHMuaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1lbWJlcnNfID0ge307CiAgICAgICAgdGhpcy5pdGVtc18gPSB7fTsKICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gISEob2JqZWN0ICYmIHRoaXMuaXRlbXNfW29iamVjdC5iYXNpc09iamVjdElkXSk7CiAgICAgIH0sCiAgICAgIGdldEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuY2FjaGVfKSB0aGlzLmNhY2hlXyA9IHZhbHVlcyh0aGlzLml0ZW1zXyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVfOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiB0aGlzLml0ZW1zXykgcmV0dXJuIHRoaXMuaXRlbXNfW29iamVjdElkXTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAgICAgdG9wOiBmdW5jdGlvbihjb3VudCkgewogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBpZiAoY291bnQpIGZvciAodmFyIG9iamVjdElkIGluIHRoaXMuaXRlbXNfKSBpZiAocmVzdWx0LnB1c2godGhpcy5pdGVtc19bb2JqZWN0SWRdKSA+PSBjb3VudCkgYnJlYWs7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICB2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgZm4oaXRlbXNbaV0pOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7fSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY2FjaGVfID0gRU1QVFlfQVJSQVk7CiAgICAgICAgdGhpcy5pdGVtQ291bnQgPSAwOwogICAgICAgIHRoaXMubWVtYmVyc18gPSBudWxsOwogICAgICAgIHRoaXMuaXRlbXNfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGF0YXNldCIsCiAgICAgIGxpc3RlbjogewogICAgICAgIGl0ZW06IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICB0aGlzLnJlbW92ZShbIG9iamVjdCBdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBpdGVtcyA9IHRoaXMuaXRlbXM7CiAgICAgICAgaWYgKGl0ZW1zKSB7CiAgICAgICAgICB0aGlzLml0ZW1zID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0KGl0ZW1zKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGlmIChpdGVtcyAmJiAhQXJyYXkuaXNBcnJheShpdGVtcykpIGl0ZW1zID0gWyBpdGVtcyBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBpdGVtc1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBpZiAoIW1lbWJlck1hcFtvYmplY3RJZF0pIHsKICAgICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBpbnNlcnRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBkYXRhIHR5cGU6IHZhbHVlIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgYmFzaXMuZGF0YS5PYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGluc2VydGVkLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSA9IHsKICAgICAgICAgICAgaW5zZXJ0ZWQ6IGluc2VydGVkCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKGl0ZW1zKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5pdGVtOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGlmIChpdGVtcyAmJiAhQXJyYXkuaXNBcnJheShpdGVtcykpIGl0ZW1zID0gWyBpdGVtcyBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBpdGVtc1tpXTsKICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2gob2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIldyb25nIGRhdGEgdHlwZTogdmFsdWUgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBiYXNpcy5kYXRhLk9iamVjdCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICBpZiAoIXRoaXMuaXRlbUNvdW50KSByZXR1cm4gdGhpcy5hZGQoaXRlbXMpOwogICAgICAgIGlmICghaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xlYXIoKTsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGV4aXN0cyA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIG9iamVjdDsKICAgICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgZXhpc3RzW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZGF0YSB0eXBlOiB2YWx1ZSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRhdGEuT2JqZWN0Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgaWYgKCFleGlzdHNbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgIG9iamVjdCA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvYmplY3QucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc3luYzogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICB2YXIgZGVsdGEgPSB0aGlzLnNldChpdGVtcykgfHwge307CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBkZWx0YS5kZWxldGVkOwogICAgICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWxldGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBkZWxldGVkW2ldOyBpKyspIG9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIHJldHVybiBkZWx0YS5pbnNlcnRlZDsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkZWxldGVkID0gdGhpcy5nZXRJdGVtcygpOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKGRlbGV0ZWQubGVuZ3RoKSB7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGVkLmxlbmd0aDsgaSsrKSBkZWxldGVkW2ldLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhID0gewogICAgICAgICAgICBkZWxldGVkOiBkZWxldGVkCiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMubWVtYmVyc18gPSB7fTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEYXRhc2V0QWRhcHRlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGZuLCBzb3VyY2UsIGhhbmRsZXIpIHsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgIH07CiAgICBEYXRhc2V0QWRhcHRlci5wcm90b3R5cGUuYWRhcHRlcl8gPSBudWxsOwogICAgRGF0YXNldEFkYXB0ZXIucHJvdG90eXBlLnByb3h5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHRoaXMuc291cmNlKTsKICAgIH07CiAgICB2YXIgREFUQVNFVFdSQVBQRVJfQURBUFRFUl9IQU5ETEVSID0gewogICAgICBkYXRhc2V0Q2hhbmdlZDogZnVuY3Rpb24od3JhcHBlcikgewogICAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHdyYXBwZXIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9BREFQVEVSX0hBTkRMRVIgPSB7CiAgICAgIGNoYW5nZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCB2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIG51bGwpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gcmVzb2x2ZURhdGFzZXQoY29udGV4dCwgZm4sIHNvdXJjZSwgcHJvcGVydHkpIHsKICAgICAgdmFyIG9sZEFkYXB0ZXIgPSBjb250ZXh0W3Byb3BlcnR5XSB8fCBudWxsOwogICAgICB2YXIgbmV3QWRhcHRlciA9IG51bGw7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIpIHNvdXJjZSA9IHNvdXJjZS5jYWxsKGNvbnRleHQsIGNvbnRleHQpOwogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgRGF0YXNldFdyYXBwZXIpIHsKICAgICAgICBuZXdBZGFwdGVyID0gbmV3IERhdGFzZXRBZGFwdGVyKGNvbnRleHQsIGZuLCBzb3VyY2UsIERBVEFTRVRXUkFQUEVSX0FEQVBURVJfSEFORExFUik7CiAgICAgICAgc291cmNlID0gc291cmNlLmRhdGFzZXQ7CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSBzb3VyY2UgPSBWYWx1ZS5mcm9tKHNvdXJjZSk7CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgIG5ld0FkYXB0ZXIgPSBuZXcgRGF0YXNldEFkYXB0ZXIoY29udGV4dCwgZm4sIHNvdXJjZSwgVkFMVUVfQURBUFRFUl9IQU5ETEVSKTsKICAgICAgICBzb3VyY2UgPSByZXNvbHZlRGF0YXNldChuZXdBZGFwdGVyLCBuZXdBZGFwdGVyLnByb3h5LCBzb3VyY2UudmFsdWUsICJhZGFwdGVyXyIpOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBBYnN0cmFjdERhdGFzZXQgPT0gZmFsc2UpIHNvdXJjZSA9IG51bGw7CiAgICAgIGlmIChwcm9wZXJ0eSAmJiBvbGRBZGFwdGVyICE9PSBuZXdBZGFwdGVyKSB7CiAgICAgICAgaWYgKG9sZEFkYXB0ZXIpIHsKICAgICAgICAgIG9sZEFkYXB0ZXIuc291cmNlLnJlbW92ZUhhbmRsZXIob2xkQWRhcHRlci5oYW5kbGVyLCBvbGRBZGFwdGVyKTsKICAgICAgICAgIGlmIChvbGRBZGFwdGVyLmFkYXB0ZXJfKSByZXNvbHZlRGF0YXNldChvbGRBZGFwdGVyLCBudWxsLCBudWxsLCAiYWRhcHRlcl8iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5ld0FkYXB0ZXIpIG5ld0FkYXB0ZXIuc291cmNlLmFkZEhhbmRsZXIobmV3QWRhcHRlci5oYW5kbGVyLCBuZXdBZGFwdGVyKTsKICAgICAgICBjb250ZXh0W3Byb3BlcnR5XSA9IG5ld0FkYXB0ZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0KICAgIERhdGFzZXQuc2V0QWNjdW11bGF0ZVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwcm90byA9IEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGU7CiAgICAgIHZhciByZWFsRXZlbnQgPSBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZDsKICAgICAgdmFyIHNldFN0YXRlQ291bnQgPSAwOwogICAgICB2YXIgdXJnZW50VGltZXI7CiAgICAgIHZhciBldmVudENhY2hlID0ge307CiAgICAgIGZ1bmN0aW9uIGZsdXNoQ2FjaGUoY2FjaGUpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IGNhY2hlLmRhdGFzZXQ7CiAgICAgICAgcmVhbEV2ZW50LmNhbGwoZGF0YXNldCwgY2FjaGUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsdXNoQWxsRGF0YXNldCgpIHsKICAgICAgICB2YXIgZXZlbnRDYWNoZUNvcHkgPSBldmVudENhY2hlOwogICAgICAgIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgICBmb3IgKHZhciBkYXRhc2V0SWQgaW4gZXZlbnRDYWNoZUNvcHkpIGZsdXNoQ2FjaGUoZXZlbnRDYWNoZUNvcHlbZGF0YXNldElkXSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RvcmVEYXRhc2V0RGVsdGEoZGVsdGEpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IHRoaXM7CiAgICAgICAgdmFyIGRhdGFzZXRJZCA9IGRhdGFzZXQuYmFzaXNPYmplY3RJZDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgdmFyIGNhY2hlID0gZXZlbnRDYWNoZVtkYXRhc2V0SWRdOwogICAgICAgIGlmIChpbnNlcnRlZCAmJiBkZWxldGVkKSB7CiAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgZGVsZXRlIGV2ZW50Q2FjaGVbZGF0YXNldElkXTsKICAgICAgICAgICAgZmx1c2hDYWNoZShjYWNoZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZWFsRXZlbnQuY2FsbChkYXRhc2V0LCBkZWx0YSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBtb2RlID0gaW5zZXJ0ZWQgPyAiaW5zZXJ0ZWQiIDogImRlbGV0ZWQiOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgdmFyIGFycmF5ID0gY2FjaGVbbW9kZV07CiAgICAgICAgICBpZiAoIWFycmF5KSBmbHVzaENhY2hlKGNhY2hlKTsgZWxzZSB7CiAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIGluc2VydGVkIHx8IGRlbGV0ZWQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV2ZW50Q2FjaGVbZGF0YXNldElkXSA9IGRlbHRhOwogICAgICAgIGRlbHRhLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVyZ2VudEZsdXNoKCkgewogICAgICAgIHVyZ2VudFRpbWVyID0gbnVsbDsKICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIihkZWJ1ZykgVXJnZW50IGZsdXNoIGRhdGFzZXQgY2hhbmdlcyIpOwogICAgICAgICAgc2V0U3RhdGVDb3VudCA9IDA7CiAgICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0QWNjdW11bGF0ZVN0YXRlT2ZmKCkgewogICAgICAgIHByb3RvLmVtaXRfaXRlbXNDaGFuZ2VkID0gcmVhbEV2ZW50OwogICAgICAgIGZsdXNoQWxsRGF0YXNldCgpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIGlmIChzdGF0ZSkgewogICAgICAgICAgaWYgKHNldFN0YXRlQ291bnQgPT0gMCkgewogICAgICAgICAgICBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZCA9IHN0b3JlRGF0YXNldERlbHRhOwogICAgICAgICAgICBpZiAoIXVyZ2VudFRpbWVyKSB1cmdlbnRUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZSh1cmdlbnRGbHVzaCk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXRTdGF0ZUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNldFN0YXRlQ291bnQgLT0gc2V0U3RhdGVDb3VudCA+IDA7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiB3cmFwRGF0YShkYXRhKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSByZXR1cm4gZGF0YS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBpdGVtCiAgICAgICAgfTsKICAgICAgfSk7IGVsc2UgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwT2JqZWN0KGRhdGEpIHsKICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuY29uc3RydWN0b3IgIT09IE9iamVjdCkgZGF0YSA9IHsKICAgICAgICB2YWx1ZTogZGF0YQogICAgICB9OwogICAgICByZXR1cm4gbmV3IERhdGFPYmplY3QoewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCByZXRPYmplY3QpIHsKICAgICAgdmFyIHdyYXBwZXIgPSByZXRPYmplY3QgPyB3cmFwT2JqZWN0IDogd3JhcERhdGE7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLm1hcCh3cmFwcGVyKSA6IHdyYXBwZXIodmFsdWUpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFNUQVRFOiBTVEFURSwKICAgICAgU1VCU0NSSVBUSU9OOiBTVUJTQ1JJUFRJT04sCiAgICAgIEFic3RyYWN0RGF0YTogQWJzdHJhY3REYXRhLAogICAgICBWYWx1ZTogVmFsdWUsCiAgICAgIE9iamVjdDogRGF0YU9iamVjdCwKICAgICAgU2xvdDogU2xvdCwKICAgICAgS2V5T2JqZWN0TWFwOiBLZXlPYmplY3RNYXAsCiAgICAgIEFic3RyYWN0RGF0YXNldDogQWJzdHJhY3REYXRhc2V0LAogICAgICBEYXRhc2V0OiBEYXRhc2V0LAogICAgICBEYXRhc2V0V3JhcHBlcjogRGF0YXNldFdyYXBwZXIsCiAgICAgIERhdGFzZXRBZGFwdGVyOiBEYXRhc2V0QWRhcHRlciwKICAgICAgaXNDb25uZWN0ZWQ6IGlzQ29ubmVjdGVkLAogICAgICBnZXREYXRhc2V0RGVsdGE6IGdldERhdGFzZXREZWx0YSwKICAgICAgcmVzb2x2ZURhdGFzZXQ6IHJlc29sdmVEYXRhc2V0LAogICAgICB3cmFwRGF0YTogd3JhcERhdGEsCiAgICAgIHdyYXBPYmplY3Q6IHdyYXBPYmplY3QsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheTsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciAkdW5kZWYgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIG51bGxHZXR0ZXIgPSBiYXNpcy5mbi5udWxsR2V0dGVyOwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBDbGFzcy5vbmVGdW5jdGlvblByb3BlcnR5OwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSBiYXNpcy5kYXRhLlNVQlNDUklQVElPTjsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIEFic3RyYWN0RGF0YXNldCA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgdmFyIEVYQ0VQVElPTl9DQU5UX0lOU0VSVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgYmUgaW5zZXJ0ZWQgYXQgc3BlY2lmaWVkIHBvaW50IGluIGhpZXJhcmNoeSI7CiAgICB2YXIgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EID0gbmFtZXNwYWNlICsgIjogTm9kZSB3YXMgbm90IGZvdW5kIjsKICAgIHZhciBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBoYXMgd3JvbmcgY2xhc3MiOwogICAgdmFyIEVYQ0VQVElPTl9OVUxMX0NISUxEID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBpcyBudWxsIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE9wZXJhdGlvbiBpcyBub3QgYWxsb3dlZCBiZWNhdXNlIG5vZGUgaXMgdW5kZXIgZGF0YVNvdXJjZSBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1QgPSBuYW1lc3BhY2UgKyAiOiBPcGVyYXRpb24gaXMgbm90IGFsbG93ZWQgYmVjYXVzZSBub2RlIGlzIHVuZGVyIGRhdGFTb3VyY2UgYWRhcHRlciBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIG93bmVyIGFuZCBwYXJlbnROb2RlIjsKICAgIHZhciBFWENFUFRJT05fTk9fQ0hJTERDTEFTUyA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIGNoaWxkcmVuIGFuZCBkYXRhU291cmNlIGFzIGNoaWxkQ2xhc3MgaXNuJ3Qgc3BlY2lmaWVkIjsKICAgIHZhciBERUxFR0FURSA9IHsKICAgICAgQU5ZOiB0cnVlLAogICAgICBOT05FOiBmYWxzZSwKICAgICAgUEFSRU5UOiAicGFyZW50IiwKICAgICAgT1dORVI6ICJvd25lciIKICAgIH07CiAgICB2YXIgY2hpbGROb2Rlc0RhdGFzZXRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogbm9kZSBjYW4ndCBiZSBkZXN0cm95ZWQgYXMgcmVwcmVzZW50aW5nIGRhdGFTb3VyY2UgaXRlbSwgZGVzdHJveSBkZWxlZ2F0ZSBpdGVtIG9yIHJlbW92ZSBpdCBmcm9tIGRhdGFTb3VyY2UgZmlyc3QiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBvd25lciBhcyBpdCBhdXRvLXNhdGVsbGl0ZSIpOwogICAgfQogICAgZnVuY3Rpb24gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGJlIGRlc3Ryb3llZCBhcyBpdCBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUsIGFuZCBjb3VsZCBiZSBkZXN0cm95ZWQgb24gb3duZXIgZGVzdHJveSIpOwogICAgfQogICAgZnVuY3Rpb24gbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIG5vZGUuc2V0RGVsZWdhdGUgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgIG5vZGUuZGVzdHJveSA9IHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveTsKICAgIH0KICAgIGZ1bmN0aW9uIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIHZhciBwcm90byA9IG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICBub2RlLnNldERlbGVnYXRlID0gcHJvdG8uc2V0RGVsZWdhdGU7CiAgICAgIG5vZGUuZGVzdHJveSA9IHByb3RvLmRlc3Ryb3k7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0aW5nU2VhcmNoKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0QXNjKGEsIGIpIHsKICAgICAgYSA9IGEuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICAgIGIgPSBiLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICByZXR1cm4gKyhhID4gYikgfHwgLShhIDwgYik7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0RGVzYyhhLCBiKSB7CiAgICAgIGEgPSBhLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICBiID0gYi5zb3J0aW5nVmFsdWUgfHwgMDsKICAgICAgcmV0dXJuIC0oYSA+IGIpIHx8ICsoYSA8IGIpOwogICAgfQogICAgZnVuY3Rpb24gc29ydENoaWxkTm9kZXMob2JqKSB7CiAgICAgIHJldHVybiBvYmouY2hpbGROb2Rlcy5zb3J0KG9iai5zb3J0aW5nRGVzYyA/IHNvcnREZXNjIDogc29ydEFzYyk7CiAgICB9CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlLCBnZXR0ZXJfLCBkZXNjKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgZGVzYyA9ICEhZGVzYzsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNvbXBhcmVWYWx1ZTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGNvbXBhcmVWYWx1ZSA9IGdldHRlcl8oYXJyYXlbcG9zXSk7CiAgICAgICAgaWYgKGRlc2MgPyB2YWx1ZSA+IGNvbXBhcmVWYWx1ZSA6IHZhbHVlIDwgY29tcGFyZVZhbHVlKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoZGVzYyA/IHZhbHVlIDwgY29tcGFyZVZhbHVlIDogdmFsdWUgPiBjb21wYXJlVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiB2YWx1ZSA9PSBjb21wYXJlVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNvbXBhcmVWYWx1ZSA8IHZhbHVlIF4gZGVzYyk7CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihyb290LCBvbGRTZWxlY3Rpb24sIG5ld1NlbGVjdGlvbiwgcm9vdFVwZGF0ZSwgaWdub3JlUm9vdFNlbGVjdGlvbikgewogICAgICBpZiAob2xkU2VsZWN0aW9uID09PSBuZXdTZWxlY3Rpb24pIHJldHVybjsKICAgICAgdmFyIG5leHROb2RlOwogICAgICB2YXIgY3Vyc29yID0gcm9vdDsKICAgICAgdmFyIHNlbGVjdGVkID0gW107CiAgICAgIGlmIChyb290VXBkYXRlKSB7CiAgICAgICAgcm9vdC5jb250ZXh0U2VsZWN0aW9uID0gbmV3U2VsZWN0aW9uOwogICAgICAgIGlmIChyb290LnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKHJvb3QpOwogICAgICB9CiAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICBuZXh0Tm9kZSA9ICFjdXJzb3Iuc2VsZWN0aW9uIHx8IGlnbm9yZVJvb3RTZWxlY3Rpb24gJiYgY3Vyc29yID09PSByb290ID8gY3Vyc29yLmZpcnN0Q2hpbGQgOiBudWxsOwogICAgICAgIGlmIChuZXh0Tm9kZSAmJiBuZXh0Tm9kZS5jb250ZXh0U2VsZWN0aW9uICE9PSBvbGRTZWxlY3Rpb24pIHRocm93ICJUcnkgY2hhbmdlIHdyb25nIGNvbnRleHQgc2VsZWN0aW9uIjsKICAgICAgICB3aGlsZSAoIW5leHROb2RlKSB7CiAgICAgICAgICBpZiAoY3Vyc29yID09PSByb290KSB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAob2xkU2VsZWN0aW9uKSBvbGRTZWxlY3Rpb24ucmVtb3ZlKHNlbGVjdGVkKTsKICAgICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9uKSBuZXdTZWxlY3Rpb24uYWRkKHNlbGVjdGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0Tm9kZSA9IGN1cnNvci5uZXh0U2libGluZzsKICAgICAgICAgIGlmICghbmV4dE5vZGUpIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBjdXJzb3IgPSBuZXh0Tm9kZTsKICAgICAgICBpZiAoY3Vyc29yLnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKGN1cnNvcik7CiAgICAgICAgY3Vyc29yLmNvbnRleHRTZWxlY3Rpb24gPSBuZXdTZWxlY3Rpb247CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChub2RlLCBkaXNhYmxlZCkgewogICAgICBpZiAobm9kZS5jb250ZXh0RGlzYWJsZWQgIT0gZGlzYWJsZWQpIHsKICAgICAgICBub2RlLmNvbnRleHREaXNhYmxlZCA9IGRpc2FibGVkOwogICAgICAgIGlmIChub2RlLmRpc2FibGVkKSByZXR1cm47CiAgICAgICAgaWYgKGRpc2FibGVkKSBub2RlLmVtaXRfZGlzYWJsZSgpOyBlbHNlIG5vZGUuZW1pdF9lbmFibGUoKTsKICAgICAgfQogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJvd25lciIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkYXRhU291cmNlIik7CiAgICBmdW5jdGlvbiBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBudWxsOwogICAgICBpZiAodmFsdWUuaXNTYXRlbGxpdGVDb25maWcpIHJldHVybiB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlKSkgdmFsdWUgPSB7CiAgICAgICAgaW5zdGFuY2VPZjogdmFsdWUKICAgICAgfTsKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICB2YXIgaGFuZGxlclJlcXVpcmVkID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAgIGlzU2F0ZWxsaXRlQ29uZmlnOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgaW5zdGFuY2VDbGFzczsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICBjYXNlICJpbnN0YW5jZSI6CiAgICAgICAgICAgIGlmICh2YWx1ZVtrZXldIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSBjb25maWdba2V5XSA9IHZhbHVlW2tleV07IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZWAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiaW5zdGFuY2VPZiI6CiAgICAgICAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlW2tleV0pICYmIHZhbHVlW2tleV0uaXNTdWJjbGFzc09mKEFic3RyYWN0Tm9kZSkpIGluc3RhbmNlQ2xhc3MgPSB2YWx1ZVtrZXldOyBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBgaW5zdGFuY2VPZmAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGEgc3ViY2xhc3Mgb2YgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJleGlzdHNJZiI6CiAgICAgICAgICBjYXNlICJkZWxlZ2F0ZSI6CiAgICAgICAgICBjYXNlICJkYXRhU291cmNlIjoKICAgICAgICAgICAgaGFuZGxlclJlcXVpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnW2tleV0gPSBnZXR0ZXIodmFsdWVba2V5XSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiY29uZmlnIjoKICAgICAgICAgICAgY29uZmlnW2tleV0gPSB2YWx1ZVtrZXldOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFjb25maWcuaW5zdGFuY2UpIGNvbmZpZy5pbnN0YW5jZU9mID0gaW5zdGFuY2VDbGFzcyB8fCBBYnN0cmFjdE5vZGU7IGVsc2UgewogICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZU9mYCBjYW4ndCBiZSBzZXQgd2l0aCBgaW5zdGFuY2VgIHZhbHVlIGluIHNhdGVsbGl0ZSBjb25maWcsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhhbmRsZXJSZXF1aXJlZCkgewogICAgICAgICAgdmFyIGV2ZW50cyA9ICJldmVudHMiIGluIHZhbHVlID8gdmFsdWUuZXZlbnRzIDogInVwZGF0ZSI7CiAgICAgICAgICBpZiAoImhvb2siIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgiZXZlbnRzIiBpbiB2YWx1ZSA9PSBmYWxzZSkgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGhvb2sgcHJvcGVydHkgaW4gc2F0ZWxsaXRlIGNvbmZpZyBpcyBkZXByZWNhdGVkLCB1c2UgZXZlbnRzIHByb3BlcnR5IGluc3RlYWQiKTsKICAgICAgICAgICAgICBldmVudHMgPSBiYXNpcy5vYmplY3Qua2V5cyh2YWx1ZS5ob29rKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBob29rIHByb3BlcnR5IGluIHNhdGVsbGl0ZSBjb25maWcgd2FzIGlnbm9yZWQgKGV2ZW50cyBwcm9wZXJ0eSB1c2VkKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBldmVudHMuam9pbigiICIpOwogICAgICAgICAgaWYgKHR5cGVvZiBldmVudHMgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KC9ccysvKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICBoYW5kbGVyW2V2ZW50TmFtZV0gPSBTQVRFTExJVEVfVVBEQVRFOwogICAgICAgICAgICAgIGNvbmZpZy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gZXh0ZW5kU2F0ZWxsaXRlQ29uZmlnKHJlc3VsdCwgZXh0ZW5kKSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gZXh0ZW5kKSByZXN1bHRbbmFtZV0gPSBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKGV4dGVuZFtuYW1lXSk7CiAgICB9CiAgICBmdW5jdGlvbiBhcHBseVNhdGVsbGl0ZXMobm9kZSwgc2F0ZWxsaXRlcykgewogICAgICBmb3IgKHZhciBuYW1lIGluIHNhdGVsbGl0ZXMpIGlmIChzYXRlbGxpdGVzW25hbWVdICYmIHR5cGVvZiBzYXRlbGxpdGVzW25hbWVdID09ICJvYmplY3QiKSBub2RlLnNldFNhdGVsbGl0ZShuYW1lLCBzYXRlbGxpdGVzW25hbWVdKTsKICAgIH0KICAgIHZhciBOVUxMX1NBVEVMTElURV9DT05GSUcgPSBDbGFzcy5jdXN0b21FeHRlbmRQcm9wZXJ0eSh7fSwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbmQpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGV4dGVuZCkgewogICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kb20ud3JhcHBlci5BYnN0cmFjdE5vZGUjc2F0ZWxsaXRlQ29uZmlnIGlzIGRlcHJlY2F0ZWQgbm93LCB1c2UgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlI3NhdGVsbGl0ZSBpbnN0ZWFkIik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgZXh0ZW5kU2F0ZWxsaXRlQ29uZmlnKHJlc3VsdCwgZXh0ZW5kKTsKICAgIH0pOwogICAgdmFyIE5VTExfU0FURUxMSVRFID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoe30sIGV4dGVuZFNhdGVsbGl0ZUNvbmZpZyk7CiAgICB2YXIgU0FURUxMSVRFX1VQREFURSA9IGZ1bmN0aW9uKG93bmVyKSB7CiAgICAgIHZhciBuYW1lID0gdGhpcy5uYW1lOwogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIHZhciBleGlzdHMgPSAhY29uZmlnLmV4aXN0c0lmIHx8IGNvbmZpZy5leGlzdHNJZihvd25lcik7CiAgICAgIHZhciBzYXRlbGxpdGUgPSBvd25lci5zYXRlbGxpdGVbbmFtZV07CiAgICAgIGlmIChleGlzdHMpIHsKICAgICAgICBpZiAoc2F0ZWxsaXRlKSB7CiAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSBzYXRlbGxpdGUuc2V0RGVsZWdhdGUoY29uZmlnLmRlbGVnYXRlKG93bmVyKSk7CiAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZS5zZXREYXRhU291cmNlKGNvbmZpZy5kYXRhU291cmNlKG93bmVyKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhdGVsbGl0ZSA9IGNvbmZpZy5pbnN0YW5jZTsKICAgICAgICAgIGlmICghc2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIHZhciBzYXRlbGxpdGVDb25maWcgPSAodHlwZW9mIGNvbmZpZy5jb25maWcgPT0gImZ1bmN0aW9uIiA/IGNvbmZpZy5jb25maWcob3duZXIpIDogY29uZmlnLmNvbmZpZykgfHwge307CiAgICAgICAgICAgIHNhdGVsbGl0ZUNvbmZpZy5vd25lciA9IG93bmVyOwogICAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSB7CiAgICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLmF1dG9EZWxlZ2F0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHNhdGVsbGl0ZUNvbmZpZy5kZWxlZ2F0ZSA9IGNvbmZpZy5kZWxlZ2F0ZShvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGVDb25maWcuZGF0YVNvdXJjZSA9IGNvbmZpZy5kYXRhU291cmNlKG93bmVyKTsKICAgICAgICAgICAgc2F0ZWxsaXRlID0gbmV3IGNvbmZpZy5pbnN0YW5jZU9mKHNhdGVsbGl0ZUNvbmZpZyk7CiAgICAgICAgICAgIHNhdGVsbGl0ZS5kZXN0cm95ID0gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveTsKICAgICAgICAgICAgaWYgKG93bmVyLmxpc3RlbiAmJiBvd25lci5saXN0ZW4uc2F0ZWxsaXRlKSBzYXRlbGxpdGUuYWRkSGFuZGxlcihvd25lci5saXN0ZW4gJiYgb3duZXIubGlzdGVuLnNhdGVsbGl0ZSwgb3duZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKGNvbmZpZy5kZWxlZ2F0ZShvd25lcikpOwogICAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZS5zZXREYXRhU291cmNlKGNvbmZpZy5kYXRhU291cmNlKG93bmVyKSk7CiAgICAgICAgICB9CiAgICAgICAgICBvd25lci5zYXRlbGxpdGUuX19hdXRvX19bbmFtZV0uaW5zdGFuY2UgPSBzYXRlbGxpdGU7CiAgICAgICAgICBvd25lci5zZXRTYXRlbGxpdGUobmFtZSwgc2F0ZWxsaXRlLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgaWYgKGNvbmZpZy5pbnN0YW5jZSkgewogICAgICAgICAgICBpZiAoY29uZmlnLmRlbGVnYXRlKSBzYXRlbGxpdGUuc2V0RGVsZWdhdGUoKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZSgpOwogICAgICAgICAgfQogICAgICAgICAgb3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fW25hbWVdLmluc3RhbmNlID0gbnVsbDsKICAgICAgICAgIG93bmVyLnNldFNhdGVsbGl0ZShuYW1lLCBudWxsLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vd25lci5zZXRTYXRlbGxpdGUodGhpcy5uYW1lLCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBBYnN0cmFjdE5vZGUgPSBDbGFzcyhEYXRhT2JqZWN0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdE5vZGUiLAogICAgICBzdWJzY3JpYmVUbzogRGF0YU9iamVjdC5wcm90b3R5cGUuc3Vic2NyaWJlVG8gKyBTVUJTQ1JJUFRJT04uREFUQVNPVVJDRSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0YXRlID09IFNUQVRFLlVOREVGSU5FRCB8fCB0aGlzLnN0YXRlID09IFNUQVRFLkRFUFJFQ0FURUQ7CiAgICAgIH0sCiAgICAgIHN5bmNFdmVudHM6IHsKICAgICAgICBhY3RpdmVDaGFuZ2VkOiBmYWxzZQogICAgICB9LAogICAgICBlbWl0X3VwZGF0ZTogZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5lbWl0X3VwZGF0ZS5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50Tm9kZSkgewogICAgICAgICAgaWYgKHBhcmVudE5vZGUubWF0Y2hGdW5jdGlvbikgdGhpcy5tYXRjaChwYXJlbnROb2RlLm1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcywgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBsaXN0ZW46IHsKICAgICAgICBvd25lcjogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vd25lclNhdGVsbGl0ZU5hbWUpIHRoaXMuc2V0T3duZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGF1dG9EZWxlZ2F0ZTogREVMRUdBVEUuTk9ORSwKICAgICAgbmFtZTogbnVsbCwKICAgICAgY2hpbGROb2RlczogbnVsbCwKICAgICAgZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ6IGNyZWF0ZUV2ZW50KCJjaGlsZE5vZGVzTW9kaWZpZWQiLCAiZGVsdGEiKSAmJiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIGV2ZW50cy5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdmFyIGxpc3RlbiA9IHRoaXMubGlzdGVuLmNoaWxkTm9kZTsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgaWYgKGxpc3RlbikgewogICAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuaW5zZXJ0ZWQpIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBhcnJheVtpXTsgaSsrKSBjaGlsZC5hZGRIYW5kbGVyKGxpc3RlbiwgdGhpcyk7CiAgICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaV07IGkrKykgY2hpbGQucmVtb3ZlSGFuZGxlcihsaXN0ZW4sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiBTVEFURS5VTkRFRklORUQsCiAgICAgIGVtaXRfY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImNoaWxkTm9kZXNTdGF0ZUNoYW5nZWQiLCAib2xkU3RhdGUiKSwKICAgICAgY2hpbGRDbGFzczogQWJzdHJhY3ROb2RlLAogICAgICBkYXRhU291cmNlOiBudWxsLAogICAgICBlbWl0X2RhdGFTb3VyY2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YVNvdXJjZUNoYW5nZWQiLCAib2xkRGF0YVNvdXJjZSIpLAogICAgICBkYXRhU291cmNlQWRhcHRlcl86IG51bGwsCiAgICAgIGRhdGFTb3VyY2VNYXBfOiBudWxsLAogICAgICBkZXN0cm95RGF0YVNvdXJjZU1lbWJlcjogdHJ1ZSwKICAgICAgcGFyZW50Tm9kZTogbnVsbCwKICAgICAgbmV4dFNpYmxpbmc6IG51bGwsCiAgICAgIHByZXZpb3VzU2libGluZzogbnVsbCwKICAgICAgZmlyc3RDaGlsZDogbnVsbCwKICAgICAgbGFzdENoaWxkOiBudWxsLAogICAgICBzb3J0aW5nOiBudWxsR2V0dGVyLAogICAgICBzb3J0aW5nRGVzYzogZmFsc2UsCiAgICAgIGVtaXRfc29ydGluZ0NoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJzb3J0aW5nQ2hhbmdlZCIsICJvbGRTb3J0aW5nIiwgIm9sZFNvcnRpbmdEZXNjIiksCiAgICAgIGdyb3VwaW5nQ2xhc3M6IG51bGwsCiAgICAgIGdyb3VwaW5nOiBudWxsLAogICAgICBlbWl0X2dyb3VwaW5nQ2hhbmdlZDogY3JlYXRlRXZlbnQoImdyb3VwaW5nQ2hhbmdlZCIsICJvbGRHcm91cGluZyIpLAogICAgICBncm91cE5vZGU6IG51bGwsCiAgICAgIGdyb3VwSWQ6IE5hTiwKICAgICAgc2F0ZWxsaXRlQ29uZmlnOiBOVUxMX1NBVEVMTElURV9DT05GSUcsCiAgICAgIHNhdGVsbGl0ZTogTlVMTF9TQVRFTExJVEUsCiAgICAgIG93bmVyU2F0ZWxsaXRlTmFtZTogbnVsbCwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgic2F0ZWxsaXRlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNhdGVsbGl0ZSIpLAogICAgICBvd25lcjogbnVsbCwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJvd25lckNoYW5nZWQiLCAib2xkT3duZXIiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIGlmIChkYXRhU291cmNlKSB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciBncm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0R3JvdXBpbmcoZ3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jaGlsZENsYXNzKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBbXTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZShkYXRhU291cmNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLnNldENoaWxkTm9kZXMoY2hpbGROb2Rlcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzYXRlbGxpdGVzID0gdGhpcy5zYXRlbGxpdGU7CiAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlQ29uZmlnICE9PSBOVUxMX1NBVEVMTElURV9DT05GSUcpIHsKICAgICAgICAgIGlmICh0aGlzLnNhdGVsbGl0ZUNvbmZpZyAhPT0gdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuc2F0ZWxsaXRlQ29uZmlnKSBiYXNpcy5kZXYud2FybigiYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlI3NhdGVsbGl0ZUNvbmZpZyBpcyBkZXByZWNhdGVkIG5vdywgdXNlIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSNzYXRlbGxpdGUgaW5zdGVhZCIpOwogICAgICAgICAgc2F0ZWxsaXRlcyA9IGJhc2lzLm9iamVjdC5tZXJnZShzYXRlbGxpdGVzLCB0aGlzLnNhdGVsbGl0ZUNvbmZpZyk7CiAgICAgICAgfQogICAgICAgIGlmIChzYXRlbGxpdGVzICE9PSBOVUxMX1NBVEVMTElURSkgewogICAgICAgICAgdGhpcy5zYXRlbGxpdGUgPSBOVUxMX1NBVEVMTElURTsKICAgICAgICAgIGFwcGx5U2F0ZWxsaXRlcyh0aGlzLCBzYXRlbGxpdGVzKTsKICAgICAgICB9CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgIHRoaXMub3duZXIgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXRPd25lcihvd25lcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRDaGlsZE5vZGVzU3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCBkYXRhKSB7CiAgICAgICAgdmFyIHN0YXRlQ29kZSA9IFN0cmluZyhzdGF0ZSk7CiAgICAgICAgdmFyIG9sZFN0YXRlID0gdGhpcy5jaGlsZE5vZGVzU3RhdGU7CiAgICAgICAgaWYgKCFTVEFURS52YWx1ZXNbc3RhdGVDb2RlXSkgdGhyb3cgbmV3IEVycm9yKCJXcm9uZyBzdGF0ZSB2YWx1ZSIpOwogICAgICAgIGlmIChvbGRTdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgb2xkU3RhdGUuZGF0YSAhPSBkYXRhKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNTdGF0ZSA9IE9iamVjdChzdGF0ZUNvZGUpOwogICAgICAgICAgdGhpcy5jaGlsZE5vZGVzU3RhdGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQpIHt9LAogICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5ld0NoaWxkLCByZWZDaGlsZCkge30sCiAgICAgIHJlbW92ZUNoaWxkOiBmdW5jdGlvbihvbGRDaGlsZCkge30sCiAgICAgIHJlcGxhY2VDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQsIG9sZENoaWxkKSB7fSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7fSwKICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24obm9kZXMpIHt9LAogICAgICBzZXRHcm91cGluZzogZnVuY3Rpb24oZ3JvdXBpbmcsIGFsaXZlKSB7fSwKICAgICAgc2V0U29ydGluZzogZnVuY3Rpb24oc29ydGluZywgZGVzYykge30sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHt9LAogICAgICBzZXRPd25lcjogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICBpZiAoIW93bmVyIHx8IG93bmVyIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlID09IGZhbHNlKSBvd25lciA9IG51bGw7CiAgICAgICAgaWYgKG93bmVyICYmIHRoaXMucGFyZW50Tm9kZSkgdGhyb3cgRVhDRVBUSU9OX1BBUkVOVE5PREVfT1dORVJfQ09ORkxJQ1Q7CiAgICAgICAgdmFyIG9sZE93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob2xkT3duZXIgIT09IG93bmVyKSB7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLm93bmVyOwogICAgICAgICAgaWYgKG9sZE93bmVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSAmJiBvbGRPd25lci5zYXRlbGxpdGUuX19hdXRvX18gJiYgdGhpcy5vd25lclNhdGVsbGl0ZU5hbWUgaW4gb2xkT3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogYXV0by1zYXRlbGxpdGUgY2FuJ3QgY2hhbmdlIGl0J3Mgb3duZXIiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9sZE93bmVyLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIGlmICh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSkgewogICAgICAgICAgICAgIHRoaXMub3duZXIgPSBudWxsOwogICAgICAgICAgICAgIG9sZE93bmVyLnNldFNhdGVsbGl0ZSh0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvd25lciAmJiBsaXN0ZW5IYW5kbGVyKSBvd25lci5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgdGhpcy5vd25lciA9IG93bmVyOwogICAgICAgICAgdGhpcy5lbWl0X293bmVyQ2hhbmdlZChvbGRPd25lcik7CiAgICAgICAgICBpZiAodGhpcy5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuT1dORVIgfHwgdGhpcy5hdXRvRGVsZWdhdGUgPT09IERFTEVHQVRFLkFOWSkgdGhpcy5zZXREZWxlZ2F0ZShvd25lcik7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTYXRlbGxpdGU6IGZ1bmN0aW9uKG5hbWUsIHNhdGVsbGl0ZSwgYXV0b1NldCkgewogICAgICAgIHZhciBvbGRTYXRlbGxpdGUgPSB0aGlzLnNhdGVsbGl0ZVtuYW1lXSB8fCBudWxsOwogICAgICAgIHZhciBhdXRvID0gdGhpcy5zYXRlbGxpdGUuX19hdXRvX187CiAgICAgICAgdmFyIGF1dG9Db25maWcgPSBhdXRvICYmIGF1dG9bbmFtZV07CiAgICAgICAgdmFyIHByZXNlcnZlQXV0byA9IGF1dG9TZXQgJiYgYXV0b0NvbmZpZzsKICAgICAgICBpZiAocHJlc2VydmVBdXRvKSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBhdXRvQ29uZmlnLmluc3RhbmNlOwogICAgICAgICAgaWYgKGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUpIGRlbGV0ZSBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZS5zZXRPd25lcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2F0ZWxsaXRlID0gcHJvY2Vzc1NhdGVsbGl0ZUNvbmZpZyhzYXRlbGxpdGUpOwogICAgICAgICAgaWYgKHNhdGVsbGl0ZSAmJiBzYXRlbGxpdGUub3duZXIgJiYgYXV0byAmJiBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lICYmIGF1dG9bc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZV0pIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogYXV0by1jcmVhdGUgc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBuYW1lIGluc2lkZSBvd25lciIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXV0b0NvbmZpZykgewogICAgICAgICAgICBkZWxldGUgYXV0b1tuYW1lXTsKICAgICAgICAgICAgaWYgKGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlKSBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZS5yZW1vdmVIYW5kbGVyKEFVVE9fU0FURUxMSVRFX0lOU1RBTkNFX0hBTkRMRVIsIGF1dG9Db25maWcpOwogICAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaGFuZGxlcikgdGhpcy5yZW1vdmVIYW5kbGVyKGF1dG9Db25maWcuY29uZmlnLmhhbmRsZXIsIGF1dG9Db25maWcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2xkU2F0ZWxsaXRlICE9PSBzYXRlbGxpdGUpIHsKICAgICAgICAgIHZhciBzYXRlbGxpdGVMaXN0ZW4gPSB0aGlzLmxpc3Rlbi5zYXRlbGxpdGU7CiAgICAgICAgICB2YXIgZGVzdHJveVNhdGVsbGl0ZTsKICAgICAgICAgIGlmIChvbGRTYXRlbGxpdGUpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2F0ZWxsaXRlW25hbWVdOwogICAgICAgICAgICBvbGRTYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgaWYgKGF1dG9Db25maWcgJiYgb2xkU2F0ZWxsaXRlLmRlc3Ryb3kgPT09IHdhcm5PbkF1dG9TYXRlbGxpdGVEZXN0b3kpIHsKICAgICAgICAgICAgICBkZXN0cm95U2F0ZWxsaXRlID0gb2xkU2F0ZWxsaXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGVMaXN0ZW4pIG9sZFNhdGVsbGl0ZS5yZW1vdmVIYW5kbGVyKHNhdGVsbGl0ZUxpc3RlbiwgdGhpcyk7CiAgICAgICAgICAgICAgb2xkU2F0ZWxsaXRlLnNldE93bmVyKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcmVzZXJ2ZUF1dG8gJiYgIXNhdGVsbGl0ZSAmJiBhdXRvQ29uZmlnLmNvbmZpZy5pbnN0YW5jZSkgYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2Uuc2V0T3duZXIgPSB3YXJuT25BdXRvU2F0ZWxsaXRlT3duZXJDaGFuZ2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBBYnN0cmFjdE5vZGUgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICB2YXIgYXV0b0NvbmZpZyA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0aGlzLAogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGNvbmZpZzogc2F0ZWxsaXRlLAogICAgICAgICAgICAgICAgaW5zdGFuY2U6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUuaGFuZGxlcikgdGhpcy5hZGRIYW5kbGVyKHNhdGVsbGl0ZS5oYW5kbGVyLCBhdXRvQ29uZmlnKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLmluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBzYXRlbGxpdGUuaW5zdGFuY2UuYWRkSGFuZGxlcihBVVRPX1NBVEVMTElURV9JTlNUQU5DRV9IQU5ETEVSLCBhdXRvQ29uZmlnKTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5pbnN0YW5jZS5zZXRPd25lciA9IHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFhdXRvKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zYXRlbGxpdGUgPT09IE5VTExfU0FURUxMSVRFKSB0aGlzLnNhdGVsbGl0ZSA9IHt9OwogICAgICAgICAgICAgICAgYXV0byA9IHRoaXMuc2F0ZWxsaXRlLl9fYXV0b19fID0ge307CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF1dG9bbmFtZV0gPSBhdXRvQ29uZmlnOwogICAgICAgICAgICAgIFNBVEVMTElURV9VUERBVEUuY2FsbChhdXRvQ29uZmlnLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIWF1dG9Db25maWcuaW5zdGFuY2UgJiYgb2xkU2F0ZWxsaXRlKSB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgICAgICAgIGlmIChkZXN0cm95U2F0ZWxsaXRlKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgaWYgKGF1dG9Db25maWcgJiYgYXV0b0NvbmZpZy5jb25maWcuZGVsZWdhdGUpIHsKICAgICAgICAgICAgICAgIHZhciBhdXRvRGVsZWdhdGUgPSBzYXRlbGxpdGUuYXV0b0RlbGVnYXRlOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLnNldE93bmVyKHRoaXMpOwogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZSA9IGF1dG9EZWxlZ2F0ZTsKICAgICAgICAgICAgICB9IGVsc2Ugc2F0ZWxsaXRlLnNldE93bmVyKHRoaXMpOwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUub3duZXIgIT09IHRoaXMpIHJldHVybjsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlTGlzdGVuKSBzYXRlbGxpdGUuYWRkSGFuZGxlcihzYXRlbGxpdGVMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zYXRlbGxpdGVbc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lLCBzYXRlbGxpdGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5zYXRlbGxpdGUgPT0gTlVMTF9TQVRFTExJVEUpIHRoaXMuc2F0ZWxsaXRlID0ge307CiAgICAgICAgICAgIHRoaXMuc2F0ZWxsaXRlW25hbWVdID0gc2F0ZWxsaXRlOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zYXRlbGxpdGVDaGFuZ2VkKG5hbWUsIG9sZFNhdGVsbGl0ZSk7CiAgICAgICAgICBpZiAoZGVzdHJveVNhdGVsbGl0ZSkgewogICAgICAgICAgICBkZWxldGUgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICBkZXN0cm95U2F0ZWxsaXRlLmRlc3Ryb3koKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldENoaWxkTm9kZXNEYXRhc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY2hpbGROb2Rlc0RhdGFzZXRNYXBbdGhpcy5iYXNpc09iamVjdElkXSB8fCBuZXcgQ2hpbGROb2Rlc0RhdGFzZXQoewogICAgICAgICAgc291cmNlTm9kZTogdGhpcwogICAgICAgIH0pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSB8fCB0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgewogICAgICAgICAgdGhpcy5zZXREYXRhU291cmNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHRoaXMuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nLnNldE93bmVyKCk7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3duZXIpIHRoaXMuc2V0T3duZXIoKTsKICAgICAgICB2YXIgc2F0ZWxsaXRlcyA9IHRoaXMuc2F0ZWxsaXRlOwogICAgICAgIGlmIChzYXRlbGxpdGVzICE9PSBOVUxMX1NBVEVMTElURSkgewogICAgICAgICAgdmFyIGF1dG8gPSBzYXRlbGxpdGVzLl9fYXV0b19fOwogICAgICAgICAgZGVsZXRlIHNhdGVsbGl0ZXMuX19hdXRvX187CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGF1dG8pIGlmIChhdXRvW25hbWVdLmNvbmZpZy5pbnN0YW5jZSAmJiAhYXV0b1tuYW1lXS5pbnN0YW5jZSkgYXV0b1tuYW1lXS5jb25maWcuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBzYXRlbGxpdGVzKSB7CiAgICAgICAgICAgIHZhciBzYXRlbGxpdGUgPSBzYXRlbGxpdGVzW25hbWVdOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXIgPSBudWxsOwogICAgICAgICAgICBzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5kZXN0cm95ID09PSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95KSBkZWxldGUgc2F0ZWxsaXRlLmRlc3Ryb3k7CiAgICAgICAgICAgIHNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNhdGVsbGl0ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hpbGROb2RlcyA9IG51bGw7CiAgICAgICAgdGhpcy5wYXJlbnROb2RlID0gbnVsbDsKICAgICAgICB0aGlzLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5maXJzdENoaWxkID0gbnVsbDsKICAgICAgICB0aGlzLmxhc3RDaGlsZCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFBhcnRpdGlvbk5vZGUgPSBDbGFzcyhBYnN0cmFjdE5vZGUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlBhcnRpdGlvbk5vZGUiLAogICAgICBhdXRvRGVzdHJveUlmRW1wdHk6IGZhbHNlLAogICAgICBub2RlczogbnVsbCwKICAgICAgZmlyc3Q6IG51bGwsCiAgICAgIGxhc3Q6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubm9kZXMgPSBbXTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgaW5zZXJ0OiBmdW5jdGlvbihuZXdOb2RlLCByZWZOb2RlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICB2YXIgcG9zID0gcmVmTm9kZSA/IG5vZGVzLmluZGV4T2YocmVmTm9kZSkgOiAtMTsKICAgICAgICBpZiAocG9zID09IC0xKSB7CiAgICAgICAgICBub2Rlcy5wdXNoKG5ld05vZGUpOwogICAgICAgICAgdGhpcy5sYXN0ID0gbmV3Tm9kZTsKICAgICAgICB9IGVsc2Ugbm9kZXMuc3BsaWNlKHBvcywgMCwgbmV3Tm9kZSk7CiAgICAgICAgdGhpcy5maXJzdCA9IG5vZGVzWzBdOwogICAgICAgIG5ld05vZGUuZ3JvdXBOb2RlID0gdGhpczsKICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGluc2VydGVkOiBbIG5ld05vZGUgXQogICAgICAgIH0pOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9sZE5vZGUpIHsKICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLm5vZGVzOwogICAgICAgIGlmIChhcnJheVJlbW92ZShub2Rlcywgb2xkTm9kZSkpIHsKICAgICAgICAgIHRoaXMuZmlyc3QgPSBub2Rlc1swXSB8fCBudWxsOwogICAgICAgICAgdGhpcy5sYXN0ID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKICAgICAgICAgIG9sZE5vZGUuZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICBkZWxldGVkOiBbIG9sZE5vZGUgXQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5maXJzdCAmJiB0aGlzLmF1dG9EZXN0cm95SWZFbXB0eSkgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuZmlyc3QpIHJldHVybjsKICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLm5vZGVzOwogICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGg7IGktLSA+IDA7ICkgbm9kZXNbaV0uZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICB0aGlzLm5vZGVzID0gW107CiAgICAgICAgdGhpcy5maXJzdCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGRlbGV0ZWQ6IG5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuYXV0b0Rlc3Ryb3lJZkVtcHR5KSB0aGlzLmRlc3Ryb3koKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5ub2RlcyA9IG51bGw7CiAgICAgICAgdGhpcy5maXJzdCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRE9NTUlYSU5fREFUQVNPVVJDRV9IQU5ETEVSID0gewogICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFTb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG5ld0RlbHRhID0ge307CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgbmV3RGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgICAgICBpZiAodGhpcy5jaGlsZE5vZGVzLmxlbmd0aCA9PSBkZWx0YS5kZWxldGVkLmxlbmd0aCkgewogICAgICAgICAgICBkZWxldGVkID0gYXJyYXlGcm9tKHRoaXMuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBkZWxldGVkW2ldOyBpKyspIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShjaGlsZCk7CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmRhdGFTb3VyY2U7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2xlYXIodHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IHRtcDsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwXyA9IHt9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWx0YS5kZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgZGVsZWdhdGVJZCA9IGl0ZW0uYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICB2YXIgb2xkQ2hpbGQgPSB0aGlzLmRhdGFTb3VyY2VNYXBfW2RlbGVnYXRlSWRdOwogICAgICAgICAgICAgIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShvbGRDaGlsZCk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZGF0YVNvdXJjZU1hcF9bZGVsZWdhdGVJZF07CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9sZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIG5ld0RlbHRhLmluc2VydGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlQ2hpbGRCeUZhY3RvcnkodGhpcywgewogICAgICAgICAgICAgIGRlbGVnYXRlOiBpdGVtCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsb2NrRGF0YVNvdXJjZUl0ZW1Ob2RlKG5ld0NoaWxkKTsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwX1tpdGVtLmJhc2lzT2JqZWN0SWRdID0gbmV3Q2hpbGQ7CiAgICAgICAgICAgIG5ld0RlbHRhLmluc2VydGVkLnB1c2gobmV3Q2hpbGQpOwogICAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5maXJzdENoaWxkKSB0aGlzLnNldENoaWxkTm9kZXMobmV3RGVsdGEuaW5zZXJ0ZWQpOyBlbHNlIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQobmV3RGVsdGEpOwogICAgICAgIGlmICh0aGlzLmRlc3Ryb3lEYXRhU291cmNlTWVtYmVyICYmIGRlbGV0ZWQubGVuZ3RoKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGRlbGV0ZWRbaV07IGkrKykgaXRlbS5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIHN0YXRlQ2hhbmdlZDogZnVuY3Rpb24oZGF0YVNvdXJjZSkgewogICAgICAgIHRoaXMuc2V0Q2hpbGROb2Rlc1N0YXRlKGRhdGFTb3VyY2Uuc3RhdGUsIGRhdGFTb3VyY2Uuc3RhdGUuZGF0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICBpZiAoIXRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aGlzLnNldERhdGFTb3VyY2UoKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNSVhJTl9EQVRBU09VUkNFX1dSQVBQRVJfSEFORExFUiA9IHsKICAgICAgZGF0YXNldENoYW5nZWQ6IGZ1bmN0aW9uKHdyYXBwZXIpIHsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2Uod3JhcHBlcik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSgpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gZmFzdENoaWxkTm9kZXNPcmRlcihub2RlLCBvcmRlcikgewogICAgICB2YXIgbGFzdEluZGV4ID0gb3JkZXIubGVuZ3RoIC0gMTsKICAgICAgbm9kZS5jaGlsZE5vZGVzID0gb3JkZXI7CiAgICAgIG5vZGUuZmlyc3RDaGlsZCA9IG9yZGVyWzBdIHx8IG51bGw7CiAgICAgIG5vZGUubGFzdENoaWxkID0gb3JkZXJbbGFzdEluZGV4XSB8fCBudWxsOwogICAgICBmb3IgKHZhciBvcmRlck5vZGUsIGkgPSBsYXN0SW5kZXg7IG9yZGVyTm9kZSA9IG9yZGVyW2ldOyBpLS0pIHsKICAgICAgICBvcmRlck5vZGUubmV4dFNpYmxpbmcgPSBvcmRlcltpICsgMV0gfHwgbnVsbDsKICAgICAgICBvcmRlck5vZGUucHJldmlvdXNTaWJsaW5nID0gb3JkZXJbaSAtIDFdIHx8IG51bGw7CiAgICAgICAgbm9kZS5pbnNlcnRCZWZvcmUob3JkZXJOb2RlLCBvcmRlck5vZGUubmV4dFNpYmxpbmcpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBmYXN0Q2hpbGROb2Rlc0dyb3VwT3JkZXIobm9kZSwgb3JkZXIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IG9yZGVyW2ldOyBpKyspIGNoaWxkLmdyb3VwTm9kZS5ub2Rlcy5wdXNoKGNoaWxkKTsKICAgICAgb3JkZXIubGVuZ3RoID0gMDsKICAgICAgZm9yICh2YXIgZ3JvdXAgPSBub2RlLmdyb3VwaW5nLm51bGxHcm91cDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIHsKICAgICAgICB2YXIgbm9kZXMgPSBncm91cC5ub2RlczsKICAgICAgICBncm91cC5maXJzdCA9IG5vZGVzWzBdIHx8IG51bGw7CiAgICAgICAgZ3JvdXAubGFzdCA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgICAgICAgb3JkZXIucHVzaC5hcHBseShvcmRlciwgbm9kZXMpOwogICAgICAgIGdyb3VwLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGluc2VydGVkOiBub2RlcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkQnlGYWN0b3J5KG5vZGUsIGNvbmZpZykgewogICAgICB2YXIgY2hpbGQ7CiAgICAgIGlmICh0eXBlb2Ygbm9kZS5jaGlsZEZhY3RvcnkgPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNoaWxkID0gbm9kZS5jaGlsZEZhY3RvcnkoY29uZmlnKTsKICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBub2RlLmNoaWxkQ2xhc3MpIHJldHVybiBjaGlsZDsKICAgICAgfQogICAgICBpZiAoIWNoaWxkKSB0aHJvdyBFWENFUFRJT05fTlVMTF9DSElMRDsKICAgICAgYmFzaXMuZGV2Lndhcm4oRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUyArICIgKGV4cGVjdGVkICIgKyAobm9kZS5jaGlsZENsYXNzICYmIG5vZGUuY2hpbGRDbGFzcy5jbGFzc05hbWUpICsgIiBidXQgIiArIChjaGlsZCAmJiBjaGlsZC5jb25zdHJ1Y3RvciAmJiBjaGlsZC5jb25zdHJ1Y3Rvci5jbGFzc05hbWUpICsgIikiKTsKICAgICAgdGhyb3cgRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUzsKICAgIH0KICAgIHZhciBEb21NaXhpbiA9IHsKICAgICAgY2hpbGRDbGFzczogQWJzdHJhY3ROb2RlLAogICAgICBjaGlsZEZhY3Rvcnk6IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFTb3VyY2U6IERPTU1JWElOX0RBVEFTT1VSQ0VfSEFORExFUgogICAgICB9LAogICAgICBnZXRDaGlsZDogZnVuY3Rpb24odmFsdWUsIGdldHRlcikgewogICAgICAgIHJldHVybiBiYXNpcy5hcnJheS5zZWFyY2godGhpcy5jaGlsZE5vZGVzLCB2YWx1ZSwgZ2V0dGVyKTsKICAgICAgfSwKICAgICAgZ2V0Q2hpbGRCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRDaGlsZChuYW1lLCAibmFtZSIpOwogICAgICB9LAogICAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24obmV3Q2hpbGQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQpOwogICAgICB9LAogICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5ld0NoaWxkLCByZWZDaGlsZCkgewogICAgICAgIGlmICghdGhpcy5jaGlsZENsYXNzKSB0aHJvdyBFWENFUFRJT05fTk9fQ0hJTERDTEFTUzsKICAgICAgICBpZiAobmV3Q2hpbGQuZmlyc3RDaGlsZCkgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKGN1cnNvciA9PT0gbmV3Q2hpbGQpIHRocm93IEVYQ0VQVElPTl9DQU5UX0lOU0VSVDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQ2hpbGRDbGFzc0luc3RhbmNlID0gbmV3Q2hpbGQgJiYgbmV3Q2hpbGQgaW5zdGFuY2VvZiB0aGlzLmNoaWxkQ2xhc3M7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSkgewogICAgICAgICAgaWYgKCFpc0NoaWxkQ2xhc3NJbnN0YW5jZSB8fCAhbmV3Q2hpbGQuZGVsZWdhdGUgfHwgdGhpcy5kYXRhU291cmNlTWFwX1tuZXdDaGlsZC5kZWxlZ2F0ZS5iYXNpc09iamVjdElkXSAhPT0gbmV3Q2hpbGQpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0NoaWxkQ2xhc3NJbnN0YW5jZSkgbmV3Q2hpbGQgPSBjcmVhdGVDaGlsZEJ5RmFjdG9yeSh0aGlzLCBuZXdDaGlsZCBpbnN0YW5jZW9mIERhdGFPYmplY3QgPyB7CiAgICAgICAgICBkZWxlZ2F0ZTogbmV3Q2hpbGQKICAgICAgICB9IDogbmV3Q2hpbGQpOwogICAgICAgIGlmIChuZXdDaGlsZC5vd25lcikgdGhyb3cgRVhDRVBUSU9OX1BBUkVOVE5PREVfT1dORVJfQ09ORkxJQ1Q7CiAgICAgICAgdmFyIGlzSW5zaWRlID0gbmV3Q2hpbGQucGFyZW50Tm9kZSA9PT0gdGhpczsKICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHRoaXMuY2hpbGROb2RlczsKICAgICAgICB2YXIgZ3JvdXBpbmcgPSB0aGlzLmdyb3VwaW5nOwogICAgICAgIHZhciBncm91cE5vZGVzOwogICAgICAgIHZhciBjdXJyZW50TmV3Q2hpbGRHcm91cCA9IG5ld0NoaWxkLmdyb3VwTm9kZTsKICAgICAgICB2YXIgZ3JvdXAgPSBudWxsOwogICAgICAgIHZhciBzb3J0aW5nID0gdGhpcy5zb3J0aW5nOwogICAgICAgIHZhciBzb3J0aW5nRGVzYzsKICAgICAgICB2YXIgY29ycmVjdFNvcnRQb3MgPSBmYWxzZTsKICAgICAgICB2YXIgbmV3Q2hpbGRWYWx1ZTsKICAgICAgICB2YXIgcG9zID0gLTE7CiAgICAgICAgdmFyIG5leHRTaWJsaW5nOwogICAgICAgIHZhciBwcmV2U2libGluZzsKICAgICAgICBpZiAoaXNJbnNpZGUpIHsKICAgICAgICAgIG5leHRTaWJsaW5nID0gbmV3Q2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgICBwcmV2U2libGluZyA9IG5ld0NoaWxkLnByZXZpb3VzU2libGluZzsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIHsKICAgICAgICAgIHJlZkNoaWxkID0gbnVsbDsKICAgICAgICAgIHNvcnRpbmdEZXNjID0gdGhpcy5zb3J0aW5nRGVzYzsKICAgICAgICAgIG5ld0NoaWxkVmFsdWUgPSBzb3J0aW5nKG5ld0NoaWxkKSB8fCAwOwogICAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZFZhbHVlID09PSBuZXdDaGlsZC5zb3J0aW5nVmFsdWUpIHsKICAgICAgICAgICAgICBjb3JyZWN0U29ydFBvcyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCghbmV4dFNpYmxpbmcgfHwgKHNvcnRpbmdEZXNjID8gbmV4dFNpYmxpbmcuc29ydGluZ1ZhbHVlIDw9IG5ld0NoaWxkVmFsdWUgOiBuZXh0U2libGluZy5zb3J0aW5nVmFsdWUgPj0gbmV3Q2hpbGRWYWx1ZSkpICYmICghcHJldlNpYmxpbmcgfHwgKHNvcnRpbmdEZXNjID8gcHJldlNpYmxpbmcuc29ydGluZ1ZhbHVlID49IG5ld0NoaWxkVmFsdWUgOiBwcmV2U2libGluZy5zb3J0aW5nVmFsdWUgPD0gbmV3Q2hpbGRWYWx1ZSkpKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZC5zb3J0aW5nVmFsdWUgPSBuZXdDaGlsZFZhbHVlOwogICAgICAgICAgICAgICAgY29ycmVjdFNvcnRQb3MgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ3JvdXBpbmcpIHsKICAgICAgICAgIHZhciBjdXJzb3I7CiAgICAgICAgICBncm91cCA9IGdyb3VwaW5nLmdldEdyb3VwTm9kZShuZXdDaGlsZCwgdHJ1ZSk7CiAgICAgICAgICBncm91cE5vZGVzID0gZ3JvdXAubm9kZXM7CiAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgPT09IGdyb3VwKSBpZiAoY29ycmVjdFNvcnRQb3MgfHwgc29ydGluZyA9PT0gbnVsbEdldHRlciAmJiBuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCA9PT0gZ3JvdXAgJiYgY29ycmVjdFNvcnRQb3MpIHsKICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcgJiYgbmV4dFNpYmxpbmcuZ3JvdXBOb2RlID09PSBncm91cCkgcG9zID0gZ3JvdXBOb2Rlcy5pbmRleE9mKG5leHRTaWJsaW5nKTsgZWxzZSBwb3MgPSBncm91cE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoZ3JvdXBOb2RlcywgbmV3Q2hpbGRWYWx1ZSwgc29ydGluZ1NlYXJjaCwgc29ydGluZ0Rlc2MpOwogICAgICAgICAgICAgIG5ld0NoaWxkLnNvcnRpbmdWYWx1ZSA9IG5ld0NoaWxkVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZWZDaGlsZCAmJiByZWZDaGlsZC5ncm91cE5vZGUgPT09IGdyb3VwKSBwb3MgPSBncm91cE5vZGVzLmluZGV4T2YocmVmQ2hpbGQpOyBlbHNlIHBvcyA9IGdyb3VwTm9kZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IGdyb3VwTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJlZkNoaWxkID0gZ3JvdXBOb2Rlc1twb3NdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGdyb3VwLmxhc3QpIHsKICAgICAgICAgICAgICByZWZDaGlsZCA9IGdyb3VwLmxhc3QubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY3Vyc29yID0gZ3JvdXA7CiAgICAgICAgICAgICAgcmVmQ2hpbGQgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubmV4dFNpYmxpbmcpIGlmIChyZWZDaGlsZCA9IGN1cnNvci5maXJzdCkgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdDaGlsZCA9PT0gcmVmQ2hpbGQgfHwgaXNJbnNpZGUgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCAhPT0gZ3JvdXApIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXApIGN1cnJlbnROZXdDaGlsZEdyb3VwLnJlbW92ZShuZXdDaGlsZCk7CiAgICAgICAgICAgICAgZ3JvdXAuaW5zZXJ0KG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcG9zID0gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICAgIGlmIChjb3JyZWN0U29ydFBvcykgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgICAgICBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoY2hpbGROb2RlcywgbmV3Q2hpbGRWYWx1ZSwgc29ydGluZ1NlYXJjaCwgc29ydGluZ0Rlc2MpOwogICAgICAgICAgICByZWZDaGlsZCA9IGNoaWxkTm9kZXNbcG9zXTsKICAgICAgICAgICAgbmV3Q2hpbGQuc29ydGluZ1ZhbHVlID0gbmV3Q2hpbGRWYWx1ZTsKICAgICAgICAgICAgaWYgKG5ld0NoaWxkID09PSByZWZDaGlsZCB8fCBpc0luc2lkZSAmJiBuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZWZDaGlsZCAmJiByZWZDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgICAgIGlmIChuZXh0U2libGluZyA9PT0gcmVmQ2hpbGQpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQgPT09IHJlZkNoaWxkKSB0aHJvdyBFWENFUFRJT05fQ0FOVF9JTlNFUlQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICBpZiAobmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nID0gcHJldlNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB0aGlzLmxhc3RDaGlsZCA9IHByZXZTaWJsaW5nOwogICAgICAgICAgaWYgKHByZXZTaWJsaW5nKSB7CiAgICAgICAgICAgIHByZXZTaWJsaW5nLm5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgdGhpcy5maXJzdENoaWxkID0gbmV4dFNpYmxpbmc7CiAgICAgICAgICBpZiAocG9zID09IC0xKSBhcnJheVJlbW92ZShjaGlsZE5vZGVzLCBuZXdDaGlsZCk7IGVsc2UgewogICAgICAgICAgICB2YXIgb2xkUG9zID0gY2hpbGROb2Rlcy5pbmRleE9mKG5ld0NoaWxkKTsKICAgICAgICAgICAgY2hpbGROb2Rlcy5zcGxpY2Uob2xkUG9zLCAxKTsKICAgICAgICAgICAgcG9zIC09IG9sZFBvcyA8IHBvczsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCkgewogICAgICAgICAgICBjdXJyZW50TmV3Q2hpbGRHcm91cC5yZW1vdmUobmV3Q2hpbGQpOwogICAgICAgICAgICBjdXJyZW50TmV3Q2hpbGRHcm91cCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuZXdDaGlsZC5wYXJlbnROb2RlKSBuZXdDaGlsZC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5ld0NoaWxkKTsKICAgICAgICB9CiAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwICE9IGdyb3VwKSBncm91cC5pbnNlcnQobmV3Q2hpbGQsIHJlZkNoaWxkKTsKICAgICAgICBpZiAocmVmQ2hpbGQpIHsKICAgICAgICAgIGlmIChwb3MgPT0gLTEpIHBvcyA9IGNoaWxkTm9kZXMuaW5kZXhPZihyZWZDaGlsZCk7CiAgICAgICAgICBpZiAocG9zID09IC0xKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgICBuZXdDaGlsZC5uZXh0U2libGluZyA9IHJlZkNoaWxkOwogICAgICAgICAgY2hpbGROb2Rlcy5zcGxpY2UocG9zLCAwLCBuZXdDaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBvcyA9IGNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgICAgY2hpbGROb2Rlcy5wdXNoKG5ld0NoaWxkKTsKICAgICAgICAgIHJlZkNoaWxkID0gewogICAgICAgICAgICBwcmV2aW91c1NpYmxpbmc6IHRoaXMubGFzdENoaWxkCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgbmV3Q2hpbGQucGFyZW50Tm9kZSA9IHRoaXM7CiAgICAgICAgbmV3Q2hpbGQucHJldmlvdXNTaWJsaW5nID0gcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nOwogICAgICAgIGlmIChwb3MgPT0gMCkgdGhpcy5maXJzdENoaWxkID0gbmV3Q2hpbGQ7IGVsc2UgcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nLm5leHRTaWJsaW5nID0gbmV3Q2hpbGQ7CiAgICAgICAgcmVmQ2hpbGQucHJldmlvdXNTaWJsaW5nID0gbmV3Q2hpbGQ7CiAgICAgICAgaWYgKCFpc0luc2lkZSkgewogICAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24obmV3Q2hpbGQsIG5ld0NoaWxkLmNvbnRleHRTZWxlY3Rpb24sIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgdHJ1ZSk7CiAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQobmV3Q2hpbGQsIHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5jb250ZXh0RGlzYWJsZWQpOwogICAgICAgICAgaWYgKChuZXdDaGlsZC51bmRlck1hdGNoXyB8fCB0aGlzLm1hdGNoRnVuY3Rpb24pICYmIG5ld0NoaWxkLm1hdGNoKSBuZXdDaGlsZC5tYXRjaCh0aGlzLm1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgaWYgKG5ld0NoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgbmV3Q2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIG5ld0NoaWxkLnNldERlbGVnYXRlKHRoaXMpOwogICAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UpIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICBpbnNlcnRlZDogWyBuZXdDaGlsZCBdCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChuZXdDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSkgdGhpcy5hZGRIYW5kbGVyKG5ld0NoaWxkLmxpc3Rlbi5wYXJlbnROb2RlLCBuZXdDaGlsZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgaWYgKCFvbGRDaGlsZCB8fCBvbGRDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgaWYgKG9sZENoaWxkIGluc3RhbmNlb2YgdGhpcy5jaGlsZENsYXNzID09IGZhbHNlKSB0aHJvdyBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHsKICAgICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UuaGFzKG9sZENoaWxkLmRlbGVnYXRlKSkgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VfQ09ORkxJQ1Q7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VBREFQVEVSX0NPTkZMSUNUOwogICAgICAgIH0KICAgICAgICB2YXIgcG9zID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2Yob2xkQ2hpbGQpOwogICAgICAgIGlmIChwb3MgPT0gLTEpIHRocm93IEVYQ0VQVElPTl9OT0RFX05PVF9GT1VORDsKICAgICAgICB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKHBvcywgMSk7CiAgICAgICAgb2xkQ2hpbGQucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgaWYgKG9sZENoaWxkLm5leHRTaWJsaW5nKSBvbGRDaGlsZC5uZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmcgPSBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmc7IGVsc2UgdGhpcy5sYXN0Q2hpbGQgPSBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgaWYgKG9sZENoaWxkLnByZXZpb3VzU2libGluZykgb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nLm5leHRTaWJsaW5nID0gb2xkQ2hpbGQubmV4dFNpYmxpbmc7IGVsc2UgdGhpcy5maXJzdENoaWxkID0gb2xkQ2hpbGQubmV4dFNpYmxpbmc7CiAgICAgICAgb2xkQ2hpbGQubmV4dFNpYmxpbmcgPSBudWxsOwogICAgICAgIG9sZENoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgaWYgKG9sZENoaWxkLmxpc3Rlbi5wYXJlbnROb2RlKSB0aGlzLnJlbW92ZUhhbmRsZXIob2xkQ2hpbGQubGlzdGVuLnBhcmVudE5vZGUsIG9sZENoaWxkKTsKICAgICAgICB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihvbGRDaGlsZCwgb2xkQ2hpbGQuY29udGV4dFNlbGVjdGlvbiwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgaWYgKG9sZENoaWxkLmdyb3VwTm9kZSkgb2xkQ2hpbGQuZ3JvdXBOb2RlLnJlbW92ZShvbGRDaGlsZCk7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UpIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgZGVsZXRlZDogWyBvbGRDaGlsZCBdCiAgICAgICAgfSk7CiAgICAgICAgaWYgKG9sZENoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgb2xkQ2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIG9sZENoaWxkLnNldERlbGVnYXRlKCk7CiAgICAgICAgcmV0dXJuIG9sZENoaWxkOwogICAgICB9LAogICAgICByZXBsYWNlQ2hpbGQ6IGZ1bmN0aW9uKG5ld0NoaWxkLCBvbGRDaGlsZCkgewogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VBREFQVEVSX0NPTkZMSUNUOwogICAgICAgIGlmIChvbGRDaGlsZCA9PSBudWxsIHx8IG9sZENoaWxkLnBhcmVudE5vZGUgIT09IHRoaXMpIHRocm93IEVYQ0VQVElPTl9OT0RFX05PVF9GT1VORDsKICAgICAgICB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZCwgb2xkQ2hpbGQpOwogICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUNoaWxkKG9sZENoaWxkKTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLmRhdGFTb3VyY2UuaXRlbUNvdW50KSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICBpZiAoIXRoaXMuZmlyc3RDaGlsZCkgcmV0dXJuOwogICAgICAgIGlmIChhbGl2ZSkgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24odGhpcywgdGhpcy5zZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBudWxsLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgdGhpcy5maXJzdENoaWxkID0gbnVsbDsKICAgICAgICB0aGlzLmxhc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5jaGlsZE5vZGVzID0gW107CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBkZWxldGVkOiBjaGlsZE5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgZm9yICh2YXIgaSA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGNoaWxkTm9kZXNbaV07CiAgICAgICAgICBpZiAoY2hpbGQubGlzdGVuLnBhcmVudE5vZGUpIGNoaWxkLnBhcmVudE5vZGUucmVtb3ZlSGFuZGxlcihjaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSwgY2hpbGQpOwogICAgICAgICAgY2hpbGQucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBjaGlsZC5ncm91cE5vZGUgPSBudWxsOwogICAgICAgICAgaWYgKGFsaXZlKSB7CiAgICAgICAgICAgIGNoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgaWYgKGNoaWxkLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5QQVJFTlQgfHwgY2hpbGQuYXV0b0RlbGVnYXRlID09PSBERUxFR0FURS5BTlkpIGNoaWxkLnNldERlbGVnYXRlKCk7CiAgICAgICAgICB9IGVsc2UgY2hpbGQuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgZm9yICh2YXIgY2hpbGROb2RlcyA9IHRoaXMuZ3JvdXBpbmcuY2hpbGROb2RlcywgaSA9IGNoaWxkTm9kZXMubGVuZ3RoIC0gMSwgZ3JvdXA7IGdyb3VwID0gY2hpbGROb2Rlc1tpXTsgaS0tKSBncm91cC5jbGVhcigpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24obmV3Q2hpbGROb2Rlcywga2VlcEFsaXZlKSB7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UgJiYgIXRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aGlzLmNsZWFyKGtlZXBBbGl2ZSk7CiAgICAgICAgaWYgKG5ld0NoaWxkTm9kZXMpIHsKICAgICAgICAgIGlmICgibGVuZ3RoIiBpbiBuZXdDaGlsZE5vZGVzID09IGZhbHNlKSBuZXdDaGlsZE5vZGVzID0gWyBuZXdDaGlsZE5vZGVzIF07CiAgICAgICAgICBpZiAobmV3Q2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHRtcCA9IHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQgPSAkdW5kZWY7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBuZXdDaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB0aGlzLmluc2VydEJlZm9yZShuZXdDaGlsZE5vZGVzW2ldKTsKICAgICAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCA9IHRtcDsKICAgICAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IHRoaXMuY2hpbGROb2RlcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICBpZiAoIXRoaXMuY2hpbGRDbGFzcykgdGhyb3cgRVhDRVBUSU9OX05PX0NISUxEQ0xBU1M7CiAgICAgICAgZGF0YVNvdXJjZSA9IGJhc2lzLmRhdGEucmVzb2x2ZURhdGFzZXQodGhpcywgdGhpcy5zZXREYXRhU291cmNlLCBkYXRhU291cmNlLCAiZGF0YVNvdXJjZUFkYXB0ZXJfIik7CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAhPT0gZGF0YVNvdXJjZSkgewogICAgICAgICAgdmFyIG9sZERhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2U7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmRhdGFTb3VyY2U7CiAgICAgICAgICBpZiAob2xkRGF0YVNvdXJjZSkgewogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VNYXBfID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9sZERhdGFTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFTb3VyY2UpIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSB0aGlzLmNoaWxkTm9kZXNbaV07IGkrKykgdW5sb2NrRGF0YVNvdXJjZUl0ZW1Ob2RlKGNoaWxkKTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5kYXRhU291cmNlID0gZGF0YVNvdXJjZTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF8gPSB7fTsKICAgICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzU3RhdGUoZGF0YVNvdXJjZS5zdGF0ZSwgZGF0YVNvdXJjZS5zdGF0ZS5kYXRhKTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgICBkYXRhU291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGRhdGFTb3VyY2UuaXRlbUNvdW50ICYmIGxpc3RlbkhhbmRsZXIuaXRlbXNDaGFuZ2VkKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZC5jYWxsKHRoaXMsIGRhdGFTb3VyY2UsIHsKICAgICAgICAgICAgICAgICAgaW5zZXJ0ZWQ6IGRhdGFTb3VyY2UuZ2V0SXRlbXMoKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNldENoaWxkTm9kZXNTdGF0ZShTVEFURS5VTkRFRklORUQpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X2RhdGFTb3VyY2VDaGFuZ2VkKG9sZERhdGFTb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0R3JvdXBpbmc6IGZ1bmN0aW9uKGdyb3VwaW5nLCBhbGl2ZSkgewogICAgICAgIGlmICh0eXBlb2YgZ3JvdXBpbmcgPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZ3JvdXBpbmcgPT0gInN0cmluZyIpIGdyb3VwaW5nID0gewogICAgICAgICAgcnVsZTogZ3JvdXBpbmcKICAgICAgICB9OwogICAgICAgIGlmIChncm91cGluZyBpbnN0YW5jZW9mIEdyb3VwaW5nTm9kZSA9PSBmYWxzZSkgewogICAgICAgICAgZ3JvdXBpbmcgPSBncm91cGluZyAmJiB0eXBlb2YgZ3JvdXBpbmcgPT0gIm9iamVjdCIgPyBuZXcgdGhpcy5ncm91cGluZ0NsYXNzKGdyb3VwaW5nKSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmdyb3VwaW5nICE9PSBncm91cGluZykgewogICAgICAgICAgdmFyIG9sZEdyb3VwaW5nID0gdGhpcy5ncm91cGluZzsKICAgICAgICAgIHZhciBvcmRlcjsKICAgICAgICAgIGlmIChvbGRHcm91cGluZykgewogICAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFncm91cGluZykgewogICAgICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIG9yZGVyID0gc29ydENoaWxkTm9kZXModGhpcyk7IGVsc2Ugb3JkZXIgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgICAgICAgICBvbGRHcm91cGluZy5udWxsR3JvdXAuY2xlYXIoKTsKICAgICAgICAgICAgICAgIHZhciBncm91cHMgPSBvbGRHcm91cGluZy5jaGlsZE5vZGVzLnNsaWNlKDApOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cHMubGVuZ3RoOyBpKyspIGdyb3Vwc1tpXS5jbGVhcigpOwogICAgICAgICAgICAgICAgZmFzdENoaWxkTm9kZXNPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG9sZEdyb3VwaW5nLnNldE93bmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ3JvdXBpbmcpIHsKICAgICAgICAgICAgdGhpcy5ncm91cGluZyA9IGdyb3VwaW5nOwogICAgICAgICAgICBncm91cGluZy5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRpbmcgIT09IG51bGxHZXR0ZXIpIG9yZGVyID0gc29ydENoaWxkTm9kZXModGhpcyk7IGVsc2Ugb3JkZXIgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IG9yZGVyW2ldOyBpKyspIGNoaWxkLmdyb3VwTm9kZSA9IHRoaXMuZ3JvdXBpbmcuZ2V0R3JvdXBOb2RlKGNoaWxkLCB0cnVlKTsKICAgICAgICAgICAgICBvcmRlciA9IGZhc3RDaGlsZE5vZGVzR3JvdXBPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgICAgZmFzdENoaWxkTm9kZXNPcmRlcih0aGlzLCBvcmRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9ncm91cGluZ0NoYW5nZWQob2xkR3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U29ydGluZzogZnVuY3Rpb24oc29ydGluZywgc29ydGluZ0Rlc2MpIHsKICAgICAgICBzb3J0aW5nID0gZ2V0dGVyKHNvcnRpbmcpOwogICAgICAgIHNvcnRpbmdEZXNjID0gISFzb3J0aW5nRGVzYzsKICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBzb3J0aW5nIHx8IHRoaXMuc29ydGluZ0Rlc2MgIT0gISFzb3J0aW5nRGVzYykgewogICAgICAgICAgdmFyIG9sZFNvcnRpbmcgPSB0aGlzLnNvcnRpbmc7CiAgICAgICAgICB2YXIgb2xkU29ydGluZ0Rlc2MgPSB0aGlzLnNvcnRpbmdEZXNjOwogICAgICAgICAgdGhpcy5zb3J0aW5nID0gc29ydGluZzsKICAgICAgICAgIHRoaXMuc29ydGluZ0Rlc2MgPSAhIXNvcnRpbmdEZXNjOwogICAgICAgICAgaWYgKHNvcnRpbmcgIT09IG51bGxHZXR0ZXIgJiYgdGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgIHZhciBvcmRlciA9IFtdOwogICAgICAgICAgICB2YXIgbm9kZXM7CiAgICAgICAgICAgIGZvciAodmFyIG5vZGUgPSB0aGlzLmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSBub2RlLnNvcnRpbmdWYWx1ZSA9IHNvcnRpbmcobm9kZSkgfHwgMDsKICAgICAgICAgICAgaWYgKHRoaXMuZ3JvdXBpbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBncm91cCA9IHRoaXMuZ3JvdXBpbmcubnVsbEdyb3VwOyBncm91cDsgZ3JvdXAgPSBncm91cC5uZXh0U2libGluZykgewogICAgICAgICAgICAgICAgbm9kZXMgPSBncm91cC5ub2RlcyA9IHNvcnRDaGlsZE5vZGVzKHsKICAgICAgICAgICAgICAgICAgY2hpbGROb2RlczogZ3JvdXAubm9kZXMsCiAgICAgICAgICAgICAgICAgIHNvcnRpbmdEZXNjOiB0aGlzLnNvcnRpbmdEZXNjCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdyb3VwLmZpcnN0ID0gbm9kZXNbMF0gfHwgbnVsbDsKICAgICAgICAgICAgICAgIGdyb3VwLmxhc3QgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXSB8fCBudWxsOwogICAgICAgICAgICAgICAgb3JkZXIucHVzaC5hcHBseShvcmRlciwgbm9kZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3NvcnRpbmdDaGFuZ2VkKG9sZFNvcnRpbmcsIG9sZFNvcnRpbmdEZXNjKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldE1hdGNoRnVuY3Rpb246IGZ1bmN0aW9uKG1hdGNoRnVuY3Rpb24pIHsKICAgICAgICBpZiAodGhpcy5tYXRjaEZ1bmN0aW9uICE9IG1hdGNoRnVuY3Rpb24pIHsKICAgICAgICAgIHZhciBvbGRNYXRjaEZ1bmN0aW9uID0gdGhpcy5tYXRjaEZ1bmN0aW9uOwogICAgICAgICAgdGhpcy5tYXRjaEZ1bmN0aW9uID0gbWF0Y2hGdW5jdGlvbjsKICAgICAgICAgIGZvciAodmFyIG5vZGUgPSB0aGlzLmxhc3RDaGlsZDsgbm9kZTsgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSBub2RlLm1hdGNoKG1hdGNoRnVuY3Rpb24pOwogICAgICAgICAgdGhpcy5lbWl0X21hdGNoRnVuY3Rpb25DaGFuZ2VkKG9sZE1hdGNoRnVuY3Rpb24pOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciBOb2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCBEb21NaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTm9kZSIsCiAgICAgIGVtaXRfZW5hYmxlOiBjcmVhdGVFdmVudCgiZW5hYmxlIikgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQoY2hpbGQsIGZhbHNlKTsKICAgICAgICBldmVudHMuZW5hYmxlLmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGVtaXRfZGlzYWJsZTogY3JlYXRlRXZlbnQoImRpc2FibGUiKSAmJiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBjaGlsZCA9IHRoaXMuZmlyc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQubmV4dFNpYmxpbmcpIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChjaGlsZCwgdHJ1ZSk7CiAgICAgICAgZXZlbnRzLmRpc2FibGUuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBmdW5jdGlvbihuYW1lLCBvbGRTYXRlbGxpdGUpIHsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZC5jYWxsKHRoaXMsIG5hbWUsIG9sZFNhdGVsbGl0ZSk7CiAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlW25hbWVdIGluc3RhbmNlb2YgTm9kZSkgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMuc2F0ZWxsaXRlW25hbWVdLCB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkKTsKICAgICAgfSwKICAgICAgZW1pdF9zZWxlY3Q6IGNyZWF0ZUV2ZW50KCJzZWxlY3QiKSwKICAgICAgZW1pdF91bnNlbGVjdDogY3JlYXRlRXZlbnQoInVuc2VsZWN0IiksCiAgICAgIGVtaXRfbWF0Y2g6IGNyZWF0ZUV2ZW50KCJtYXRjaCIpLAogICAgICBlbWl0X3VubWF0Y2g6IGNyZWF0ZUV2ZW50KCJ1bm1hdGNoIiksCiAgICAgIGVtaXRfbWF0Y2hGdW5jdGlvbkNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJtYXRjaEZ1bmN0aW9uQ2hhbmdlZCIsICJvbGRNYXRjaEZ1bmN0aW9uIiksCiAgICAgIHNlbGVjdGFibGU6IHRydWUsCiAgICAgIHNlbGVjdGVkOiBmYWxzZSwKICAgICAgc2VsZWN0aW9uOiBudWxsLAogICAgICBjb250ZXh0U2VsZWN0aW9uOiBudWxsLAogICAgICBtYXRjaEZ1bmN0aW9uOiBudWxsLAogICAgICBtYXRjaGVkOiB0cnVlLAogICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgIGNvbnRleHREaXNhYmxlZDogZmFsc2UsCiAgICAgIGxpc3RlbjogewogICAgICAgIG93bmVyOiB7CiAgICAgICAgICBlbmFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQodGhpcywgZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQodGhpcywgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHsKICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGlvbiBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YXNldCA9PSBmYWxzZSkgdGhpcy5zZWxlY3Rpb24gPSBuZXcgU2VsZWN0aW9uKHRoaXMuc2VsZWN0aW9uKTsKICAgICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zZWxlY3Rpb24pIHRoaXMuc2VsZWN0aW9uLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc2VsZWN0aW9uLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHRoaXMuZW1pdF9kaXNhYmxlKCk7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2VsZWN0KHRydWUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U2VsZWN0aW9uOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gIT09IHNlbGVjdGlvbikgewogICAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24odGhpcywgdGhpcy5zZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBzZWxlY3Rpb24gfHwgdGhpcy5jb250ZXh0U2VsZWN0aW9uLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gJiYgdGhpcy5saXN0ZW4uc2VsZWN0aW9uKSB0aGlzLnNlbGVjdGlvbi5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLnNlbGVjdGlvbiwgdGhpcyk7CiAgICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbjsKICAgICAgICAgIGlmIChzZWxlY3Rpb24gJiYgdGhpcy5saXN0ZW4uc2VsZWN0aW9uKSBzZWxlY3Rpb24uYWRkSGFuZGxlcih0aGlzLmxpc3Rlbi5zZWxlY3Rpb24sIHRoaXMpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZDsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5jb250ZXh0U2VsZWN0aW9uOwogICAgICAgIGlmIChzZWxlY3Rpb24pIHsKICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0YWJsZSkgc2VsZWN0aW9uLnNldChbIHRoaXMgXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc2VsZWN0ZWQpIHNlbGVjdGlvbi5yZW1vdmUoWyB0aGlzIF0pOyBlbHNlIHNlbGVjdGlvbi5hZGQoWyB0aGlzIF0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkICYmIHRoaXMuc2VsZWN0YWJsZSkgewogICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLmVtaXRfc2VsZWN0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkICE9IHNlbGVjdGVkOwogICAgICB9LAogICAgICB1bnNlbGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZDsKICAgICAgICBpZiAoc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB0aGlzLmNvbnRleHRTZWxlY3Rpb247CiAgICAgICAgICBpZiAoc2VsZWN0aW9uKSBzZWxlY3Rpb24ucmVtb3ZlKFsgdGhpcyBdKTsgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbWl0X3Vuc2VsZWN0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkICE9IHNlbGVjdGVkOwogICAgICB9LAogICAgICBzZXRTZWxlY3RlZDogZnVuY3Rpb24oc2VsZWN0ZWQsIG11bHRpcGxlKSB7CiAgICAgICAgcmV0dXJuIHNlbGVjdGVkID8gdGhpcy5zZWxlY3QobXVsdGlwbGUpIDogdGhpcy51bnNlbGVjdCgpOwogICAgICB9LAogICAgICBlbmFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkaXNhYmxlZCA9IHRoaXMuZGlzYWJsZWQ7CiAgICAgICAgaWYgKGRpc2FibGVkKSB7CiAgICAgICAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoIXRoaXMuY29udGV4dERpc2FibGVkKSB0aGlzLmVtaXRfZW5hYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkICE9IGRpc2FibGVkOwogICAgICB9LAogICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGlzYWJsZWQgPSB0aGlzLmRpc2FibGVkOwogICAgICAgIGlmICghZGlzYWJsZWQpIHsKICAgICAgICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgaWYgKCF0aGlzLmNvbnRleHREaXNhYmxlZCkgdGhpcy5lbWl0X2Rpc2FibGUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgIT0gZGlzYWJsZWQ7CiAgICAgIH0sCiAgICAgIHNldERpc2FibGVkOiBmdW5jdGlvbihkaXNhYmxlZCkgewogICAgICAgIHJldHVybiBkaXNhYmxlZCA/IHRoaXMuZGlzYWJsZSgpIDogdGhpcy5lbmFibGUoKTsKICAgICAgfSwKICAgICAgaXNEaXNhYmxlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5jb250ZXh0RGlzYWJsZWQ7CiAgICAgIH0sCiAgICAgIG1hdGNoOiBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgaWYgKHR5cGVvZiBmdW5jICE9ICJmdW5jdGlvbiIpIGZ1bmMgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnVuZGVyTWF0Y2hfICYmICFmdW5jKSB0aGlzLnVuZGVyTWF0Y2hfKHRoaXMsIHRydWUpOwogICAgICAgIHRoaXMudW5kZXJNYXRjaF8gPSBmdW5jOwogICAgICAgIHZhciBtYXRjaGVkID0gIWZ1bmMgfHwgZnVuYyh0aGlzKTsKICAgICAgICBpZiAodGhpcy5tYXRjaGVkICE9IG1hdGNoZWQpIHsKICAgICAgICAgIHRoaXMubWF0Y2hlZCA9IG1hdGNoZWQ7CiAgICAgICAgICBpZiAobWF0Y2hlZCkgdGhpcy5lbWl0X21hdGNoKCk7IGVsc2UgdGhpcy5lbWl0X3VubWF0Y2goKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudW5zZWxlY3QoKTsKICAgICAgICB0aGlzLmNvbnRleHRTZWxlY3Rpb24gPSBudWxsOwogICAgICAgIGlmICh0aGlzLnNlbGVjdGlvbikgdGhpcy5zZXRTZWxlY3Rpb24oKTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgR3JvdXBpbmdOb2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCBEb21NaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuR3JvdXBpbmdOb2RlIiwKICAgICAgZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQ6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgZXZlbnRzLmNoaWxkTm9kZXNNb2RpZmllZC5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICB0aGlzLm51bGxHcm91cC5uZXh0U2libGluZyA9IHRoaXMuZmlyc3RDaGlsZDsKICAgICAgICB2YXIgYXJyYXk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBhcnJheVtpKytdOyApIHsKICAgICAgICAgICAgY2hpbGQuZ3JvdXBJZF8gPSBjaGlsZC5kZWxlZ2F0ZSA/IGNoaWxkLmRlbGVnYXRlLmJhc2lzT2JqZWN0SWQgOiBjaGlsZC5kYXRhLmlkOwogICAgICAgICAgICB0aGlzLm1hcF9bY2hpbGQuZ3JvdXBJZF9dID0gY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlICYmIHRoaXMubnVsbEdyb3VwLmZpcnN0KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gdGhpcy5vd25lcjsKICAgICAgICAgICAgdmFyIG5vZGVzID0gYXJyYXlGcm9tKHRoaXMubnVsbEdyb3VwLm5vZGVzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aDsgaS0tID4gMDsgKSBwYXJlbnROb2RlLmluc2VydEJlZm9yZShub2Rlc1tpXSwgbm9kZXNbaV0ubmV4dFNpYmxpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGZ1bmN0aW9uKG9sZE93bmVyKSB7CiAgICAgICAgaWYgKG9sZE93bmVyICYmIG9sZE93bmVyLmdyb3VwaW5nID09PSB0aGlzKSBvbGRPd25lci5zZXRHcm91cGluZyhudWxsLCB0cnVlKTsKICAgICAgICBpZiAodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLmdyb3VwaW5nICE9PSB0aGlzKSB0aGlzLm93bmVyLnNldEdyb3VwaW5nKHRoaXMpOwogICAgICAgIGV2ZW50cy5vd25lckNoYW5nZWQuY2FsbCh0aGlzLCBvbGRPd25lcik7CiAgICAgICAgaWYgKCF0aGlzLm93bmVyICYmIHRoaXMuYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lcikgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIG1hcF86IG51bGwsCiAgICAgIG51bGxHcm91cDogbnVsbCwKICAgICAgYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lcjogdHJ1ZSwKICAgICAgYXV0b0Rlc3Ryb3lFbXB0eUdyb3VwczogdHJ1ZSwKICAgICAgcnVsZTogbnVsbEdldHRlciwKICAgICAgY2hpbGRDbGFzczogUGFydGl0aW9uTm9kZSwKICAgICAgY2hpbGRGYWN0b3J5OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuY2hpbGRDbGFzcyhjb21wbGV0ZSh7CiAgICAgICAgICBhdXRvRGVzdHJveUlmRW1wdHk6IHRoaXMuZGF0YVNvdXJjZSA/IGZhbHNlIDogdGhpcy5hdXRvRGVzdHJveUVtcHR5R3JvdXBzCiAgICAgICAgfSwgY29uZmlnKSk7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICAgIHRoaXMubnVsbEdyb3VwID0gbmV3IFBhcnRpdGlvbk5vZGU7CiAgICAgICAgaWYgKCJncm91cEdldHRlciIgaW4gdGhpcykgewogICAgICAgICAgdGhpcy5ydWxlID0gZ2V0dGVyKHRoaXMuZ3JvdXBHZXR0ZXIpOwogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZSNncm91cEdldHRlciBpcyBkZXByZWNhdGVkIG5vdywgdXNlIGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZSNydWxlIGluc3RlYWQuIGdyb3VwR2V0dGVyIHZhbHVlIHdhcyBzZXQgdG8gcnVsZSBwcm9wZXJ0eS4iKTsKICAgICAgICB9CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGdldEdyb3VwTm9kZTogZnVuY3Rpb24obm9kZSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHZhciBncm91cFJlZiA9IHRoaXMucnVsZShub2RlKTsKICAgICAgICB2YXIgaXNEZWxlZ2F0ZSA9IGdyb3VwUmVmIGluc3RhbmNlb2YgRGF0YU9iamVjdDsKICAgICAgICB2YXIgZ3JvdXAgPSB0aGlzLm1hcF9baXNEZWxlZ2F0ZSA/IGdyb3VwUmVmLmJhc2lzT2JqZWN0SWQgOiBncm91cFJlZl07CiAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSkgYXV0b2NyZWF0ZSA9IGZhbHNlOwogICAgICAgIGlmICghZ3JvdXAgJiYgYXV0b2NyZWF0ZSkgewogICAgICAgICAgZ3JvdXAgPSB0aGlzLmFwcGVuZENoaWxkKGlzRGVsZWdhdGUgPyBncm91cFJlZiA6IHsKICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgIGlkOiBncm91cFJlZiwKICAgICAgICAgICAgICB0aXRsZTogZ3JvdXBSZWYKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBncm91cCB8fCB0aGlzLm51bGxHcm91cDsKICAgICAgfSwKICAgICAgc2V0RGF0YVNvdXJjZTogZnVuY3Rpb24oZGF0YVNvdXJjZSkgewogICAgICAgIHZhciBjdXJEYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIERvbU1peGluLnNldERhdGFTb3VyY2UuY2FsbCh0aGlzLCBkYXRhU291cmNlKTsKICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvd25lciAmJiB0aGlzLmRhdGFTb3VyY2UgIT09IGN1ckRhdGFTb3VyY2UpIHsKICAgICAgICAgIHZhciBub2RlcyA9IGFycmF5RnJvbShvd25lci5jaGlsZE5vZGVzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgb3duZXIuaW5zZXJ0QmVmb3JlKG5vZGVzW2ldLCBub2Rlc1tpICsgMV0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICBuZXdDaGlsZCA9IERvbU1peGluLmluc2VydEJlZm9yZS5jYWxsKHRoaXMsIG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgdmFyIGZpcnN0Tm9kZSA9IG5ld0NoaWxkLmZpcnN0OwogICAgICAgIGlmIChmaXJzdE5vZGUpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaXJzdE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHZhciBsYXN0Tm9kZSA9IG5ld0NoaWxkLmxhc3Q7CiAgICAgICAgICB2YXIgYmVmb3JlUHJldjsKICAgICAgICAgIHZhciBiZWZvcmVOZXh0OwogICAgICAgICAgdmFyIGFmdGVyUHJldjsKICAgICAgICAgIHZhciBhZnRlck5leHQgPSBudWxsOwogICAgICAgICAgdmFyIGN1cnNvciA9IG5ld0NoaWxkOwogICAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoYWZ0ZXJOZXh0ID0gY3Vyc29yLmZpcnN0KSBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFmdGVyUHJldiA9IGFmdGVyTmV4dCA/IGFmdGVyTmV4dC5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOwogICAgICAgICAgYmVmb3JlUHJldiA9IGZpcnN0Tm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICBiZWZvcmVOZXh0ID0gbGFzdE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICBpZiAoYmVmb3JlTmV4dCAhPT0gYWZ0ZXJOZXh0KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRDaGlsZE5vZGVzID0gcGFyZW50LmNoaWxkTm9kZXM7CiAgICAgICAgICAgIHZhciBub2RlcyA9IG5ld0NoaWxkLm5vZGVzOwogICAgICAgICAgICB2YXIgbm9kZXNDb3VudCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGJlZm9yZVByZXYpIGJlZm9yZVByZXYubmV4dFNpYmxpbmcgPSBiZWZvcmVOZXh0OwogICAgICAgICAgICBpZiAoYmVmb3JlTmV4dCkgYmVmb3JlTmV4dC5wcmV2aW91c1NpYmxpbmcgPSBiZWZvcmVQcmV2OwogICAgICAgICAgICBpZiAoYWZ0ZXJQcmV2KSBhZnRlclByZXYubmV4dFNpYmxpbmcgPSBmaXJzdE5vZGU7CiAgICAgICAgICAgIGlmIChhZnRlck5leHQpIGFmdGVyTmV4dC5wcmV2aW91c1NpYmxpbmcgPSBsYXN0Tm9kZTsKICAgICAgICAgICAgZmlyc3ROb2RlLnByZXZpb3VzU2libGluZyA9IGFmdGVyUHJldjsKICAgICAgICAgICAgbGFzdE5vZGUubmV4dFNpYmxpbmcgPSBhZnRlck5leHQ7CiAgICAgICAgICAgIHZhciBmaXJzdFBvcyA9IHBhcmVudENoaWxkTm9kZXMuaW5kZXhPZihmaXJzdE5vZGUpOwogICAgICAgICAgICB2YXIgYWZ0ZXJOZXh0UG9zID0gYWZ0ZXJOZXh0ID8gcGFyZW50Q2hpbGROb2Rlcy5pbmRleE9mKGFmdGVyTmV4dCkgOiBwYXJlbnRDaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGFmdGVyTmV4dFBvcyA+IGZpcnN0UG9zKSBhZnRlck5leHRQb3MgLT0gbm9kZXNDb3VudDsKICAgICAgICAgICAgcGFyZW50Q2hpbGROb2Rlcy5zcGxpY2UoZmlyc3RQb3MsIG5vZGVzQ291bnQpOwogICAgICAgICAgICBwYXJlbnRDaGlsZE5vZGVzLnNwbGljZS5hcHBseShwYXJlbnRDaGlsZE5vZGVzLCBbIGFmdGVyTmV4dFBvcywgMCBdLmNvbmNhdChub2RlcykpOwogICAgICAgICAgICBpZiAoIWFmdGVyUHJldiB8fCAhYmVmb3JlUHJldikgcGFyZW50LmZpcnN0Q2hpbGQgPSBwYXJlbnRDaGlsZE5vZGVzWzBdOwogICAgICAgICAgICBpZiAoIWFmdGVyTmV4dCB8fCAhYmVmb3JlTmV4dCkgcGFyZW50Lmxhc3RDaGlsZCA9IHBhcmVudENoaWxkTm9kZXNbcGFyZW50Q2hpbGROb2Rlcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgaWYgKGZpcnN0Tm9kZSBpbnN0YW5jZW9mIFBhcnRpdGlvbk5vZGUpIGZvciAodmFyIGkgPSBub2Rlc0NvdW50LCBpbnNlcnRCZWZvcmUgPSBhZnRlck5leHQ7IGktLSA+IDA7ICkgewogICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZXNbaV0sIGluc2VydEJlZm9yZSk7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlID0gbm9kZXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICB9LAogICAgICByZW1vdmVDaGlsZDogZnVuY3Rpb24ob2xkQ2hpbGQpIHsKICAgICAgICBpZiAob2xkQ2hpbGQgPSBEb21NaXhpbi5yZW1vdmVDaGlsZC5jYWxsKHRoaXMsIG9sZENoaWxkKSkgewogICAgICAgICAgZGVsZXRlIHRoaXMubWFwX1tvbGRDaGlsZC5ncm91cElkX107CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbm9kZTsgbm9kZSA9IG9sZENoaWxkLm5vZGVzW2ldOyBpKyspIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvbGRDaGlsZDsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFsaXZlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgdmFyIGdldEdyb3VwTm9kZSA9IHRoaXMuZ2V0R3JvdXBOb2RlOwogICAgICAgIHZhciBudWxsR3JvdXAgPSB0aGlzLm51bGxHcm91cDsKICAgICAgICB0aGlzLmdldEdyb3VwTm9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG51bGxHcm91cDsKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGdyb3VwID0gdGhpcy5maXJzdENoaWxkOyBncm91cDsgZ3JvdXAgPSBncm91cC5uZXh0U2libGluZykgbm9kZXMucHVzaC5hcHBseShub2RlcywgZ3JvdXAubm9kZXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBub2Rlc1tpXTsgaSsrKSBjaGlsZC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZCk7CiAgICAgICAgdGhpcy5nZXRHcm91cE5vZGUgPSBnZXRHcm91cE5vZGU7CiAgICAgICAgRG9tTWl4aW4uY2xlYXIuY2FsbCh0aGlzLCBhbGl2ZSk7CiAgICAgICAgdGhpcy5tYXBfID0ge307CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYXV0b0Rlc3Ryb3lXaXRoTm9Pd25lciA9IGZhbHNlOwogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMubnVsbEdyb3VwLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLm51bGxHcm91cCA9IG51bGw7CiAgICAgICAgdGhpcy5tYXBfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmdyb3VwaW5nQ2xhc3MgPSBHcm91cGluZ05vZGU7CiAgICB2YXIgQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIG5ld0RlbHRhID0ge307CiAgICAgICAgdmFyIG5vZGU7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSB7CiAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICAgICAgd2hpbGUgKG5vZGUgPSBpbnNlcnRlZFtpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgbWVtYmVyTWFwW25vZGUuYmFzaXNPYmplY3RJZF0gPSBub2RlOwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgewogICAgICAgICAgbmV3RGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgICAgICB3aGlsZSAobm9kZSA9IGRlbGV0ZWRbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZW1iZXJNYXBbbm9kZS5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGluc2VydENvdW50IHx8IGRlbGV0ZUNvdW50KSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKG5ld0RlbHRhKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQ2hpbGROb2Rlc0RhdGFzZXQgPSBDbGFzcyhBYnN0cmFjdERhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNoaWxkTm9kZXNEYXRhc2V0IiwKICAgICAgc291cmNlTm9kZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIHNvdXJjZU5vZGUgPSB0aGlzLnNvdXJjZU5vZGU7CiAgICAgICAgY2hpbGROb2Rlc0RhdGFzZXRNYXBbc291cmNlTm9kZS5iYXNpc09iamVjdElkXSA9IHRoaXM7CiAgICAgICAgaWYgKHNvdXJjZU5vZGUuZmlyc3RDaGlsZCkgQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUi5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBzb3VyY2VOb2RlLCB7CiAgICAgICAgICBpbnNlcnRlZDogc291cmNlTm9kZS5jaGlsZE5vZGVzCiAgICAgICAgfSk7CiAgICAgICAgc291cmNlTm9kZS5hZGRIYW5kbGVyKENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIsIHRoaXMpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZU5vZGUucmVtb3ZlSGFuZGxlcihDSElMRE5PREVTREFUQVNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICBkZWxldGUgY2hpbGROb2Rlc0RhdGFzZXRNYXBbdGhpcy5zb3VyY2VOb2RlLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIEFic3RyYWN0RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTZWxlY3Rpb24gPSBDbGFzcyhEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TZWxlY3Rpb24iLAogICAgICBtdWx0aXBsZTogZmFsc2UsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIERhdGFzZXQucHJvdG90eXBlLmVtaXRfaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmICghbm9kZS5zZWxlY3RlZCkgewogICAgICAgICAgICAgIG5vZGUuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIG5vZGUuZW1pdF9zZWxlY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBkZWx0YS5kZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgaWYgKG5vZGUuc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICBub2RlLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgbm9kZS5lbWl0X3Vuc2VsZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFkZDogZnVuY3Rpb24obm9kZXMpIHsKICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIHsKICAgICAgICAgIGlmICh0aGlzLml0ZW1Db3VudCkgcmV0dXJuIHRoaXMuc2V0KG5vZGVzKTsgZWxzZSBub2RlcyA9IFsgbm9kZXNbMF0gXTsKICAgICAgICB9CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAobm9kZS5jb250ZXh0U2VsZWN0aW9uID09IHRoaXMgJiYgbm9kZS5zZWxlY3RhYmxlKSBpdGVtcy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRGF0YXNldC5wcm90b3R5cGUuYWRkLmNhbGwodGhpcywgaXRlbXMpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAobm9kZS5jb250ZXh0U2VsZWN0aW9uID09IHRoaXMgJiYgbm9kZS5zZWxlY3RhYmxlKSBpdGVtcy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIGl0ZW1zLnNwbGljZSgxKTsKICAgICAgICByZXR1cm4gRGF0YXNldC5wcm90b3R5cGUuc2V0LmNhbGwodGhpcywgaXRlbXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUxFR0FURTogREVMRUdBVEUsCiAgICAgIEFic3RyYWN0Tm9kZTogQWJzdHJhY3ROb2RlLAogICAgICBOb2RlOiBOb2RlLAogICAgICBHcm91cGluZ05vZGU6IEdyb3VwaW5nTm9kZSwKICAgICAgUGFydGl0aW9uTm9kZTogUGFydGl0aW9uTm9kZSwKICAgICAgQ2hpbGROb2Rlc0RhdGFzZXQ6IENoaWxkTm9kZXNEYXRhc2V0LAogICAgICBTZWxlY3Rpb246IFNlbGVjdGlvbiwKICAgICAgbnVsbFNlbGVjdGlvbjogbmV3IEFic3RyYWN0RGF0YXNldAogICAgfTsKICB9LAogICI3LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjbGVhbmVyID0gYmFzaXMuY2xlYW5lcjsKICAgIHZhciBwYXRoID0gYmFzaXMucGF0aDsKICAgIHZhciBhcnJheVNlYXJjaCA9IGJhc2lzLmFycmF5LnNlYXJjaDsKICAgIHZhciBhcnJheUFkZCA9IGJhc2lzLmFycmF5LmFkZDsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciB0ZW1wbGF0ZUxpc3QgPSBbXTsKICAgIHZhciB0bXBsRmlsZXNNYXAgPSB7fTsKICAgIHZhciBERUNMQVJBVElPTl9WRVJTSU9OID0gMjsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSAxOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gMjsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9DTEFTUyA9IDQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfU1RZTEUgPSA1OwogICAgdmFyIFRZUEVfQVRUUklCVVRFX0VWRU5UID0gNjsKICAgIHZhciBUWVBFX1RFWFQgPSAzOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IDg7CiAgICB2YXIgVE9LRU5fVFlQRSA9IDA7CiAgICB2YXIgVE9LRU5fQklORElOR1MgPSAxOwogICAgdmFyIFRPS0VOX1JFRlMgPSAyOwogICAgdmFyIEFUVFJfTkFNRSA9IDM7CiAgICB2YXIgQVRUUl9WQUxVRSA9IDQ7CiAgICB2YXIgQVRUUl9FVkVOVF9SWCA9IC9eZXZlbnQtKC4rKSQvOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gewogICAgICA0OiAiY2xhc3MiLAogICAgICA1OiAic3R5bGUiCiAgICB9OwogICAgdmFyIEFUVFJfVFlQRV9CWV9OQU1FID0gewogICAgICAiY2xhc3MiOiBUWVBFX0FUVFJJQlVURV9DTEFTUywKICAgICAgc3R5bGU6IFRZUEVfQVRUUklCVVRFX1NUWUxFCiAgICB9OwogICAgdmFyIEFUVFJfVkFMVUVfSU5ERVggPSB7CiAgICAgIDI6IEFUVFJfVkFMVUUsCiAgICAgIDQ6IEFUVFJfVkFMVUUgLSAxLAogICAgICA1OiBBVFRSX1ZBTFVFIC0gMSwKICAgICAgNjogMgogICAgfTsKICAgIHZhciBFTEVNRU5UX05BTUUgPSAzOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSA0OwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gNTsKICAgIHZhciBURVhUX1ZBTFVFID0gMzsKICAgIHZhciBDT01NRU5UX1ZBTFVFID0gMzsKICAgIHZhciBTWU5UQVhfRVJST1IgPSAiSW52YWxpZCBvciB1bnN1cHBvcnRlZCBzeW50YXgiOwogICAgdmFyIFRFWFQgPSAvKCg/Oi58W1xyXG5dKSo/KShceyg/OmwxMG46KFthLXpBLVpfXVthLXpBLVowLTlfXC1dKig/OlwuW2EtekEtWl9dW2EtekEtWjAtOV9cLV0qKSooPzpcLlx7W2EtekEtWl9dW2EtekEtWjAtOV9cLV0qXH0pPylcfSk/fDwoXC98IS0tKFxzKlx7KT8pP3wkKS9nOwogICAgdmFyIFRBR19OQU1FID0gLyhbYS16X11bYS16MC05XC1fXSopKDp8XHt8XHMqKFwvPz4pPykvaWc7CiAgICB2YXIgQVRUUklCVVRFX05BTUVfT1JfRU5EID0gLyhbYS16X11bYS16MC05X1wtXSopKDp8XHt8PXxccyopfChcLz8+KS9pZzsKICAgIHZhciBDT01NRU5UID0gLygufFtcclxuXSkqPy0tPi9nOwogICAgdmFyIENMT1NFX1RBRyA9IC8oW2Etel9dW2EtejAtOV9cLV0qKD86OlthLXpfXVthLXowLTlfXC1dKik/KT4vaWc7CiAgICB2YXIgUkVGRVJFTkNFID0gLyhbYS16X11bYS16MC05X10qKShcfHxcfVxzKikvaWc7CiAgICB2YXIgQVRUUklCVVRFX1ZBTFVFID0gLyIoKD86KFxcIil8W14iXSkqPykiXHMqL2c7CiAgICB2YXIgQlJFQUtfVEFHX1BBUlNFID0gL14vZzsKICAgIHZhciBUQUdfSUdOT1JFX0NPTlRFTlQgPSB7CiAgICAgIHRleHQ6IC8oKD86LnxbXHJcbl0pKj8pKD86PFwvYjp0ZXh0PnwkKS9nCiAgICB9OwogICAgdmFyIHF1b3RlVW5lc2NhcGUgPSAvXFwiL2c7CiAgICB2YXIgdG9rZW5pemUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgdGFnU3RhY2sgPSBbXTsKICAgICAgdmFyIGxhc3RUYWcgPSB7CiAgICAgICAgY2hpbGRzOiByZXN1bHQKICAgICAgfTsKICAgICAgdmFyIHNvdXJjZVRleHQ7CiAgICAgIHZhciB0b2tlbjsKICAgICAgdmFyIGJ1ZmZlclBvczsKICAgICAgdmFyIHN0YXJ0UG9zOwogICAgICB2YXIgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgdmFyIHRleHRTdGF0ZUVuZFBvcyA9IDA7CiAgICAgIHZhciB0ZXh0RW5kUG9zOwogICAgICB2YXIgc3RhdGUgPSBURVhUOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG07CiAgICAgIHNvdXJjZSA9IHNvdXJjZS50cmltKCk7CiAgICAgIHJlc3VsdC53YXJucyA9IFtdOwogICAgICB3aGlsZSAocG9zIDwgc291cmNlLmxlbmd0aCB8fCBzdGF0ZSAhPSBURVhUKSB7CiAgICAgICAgc3RhdGUubGFzdEluZGV4ID0gcG9zOwogICAgICAgIHN0YXJ0UG9zID0gcG9zOwogICAgICAgIG0gPSBzdGF0ZS5leGVjKHNvdXJjZSk7CiAgICAgICAgaWYgKCFtIHx8IG0uaW5kZXggIT09IHBvcykgewogICAgICAgICAgaWYgKHN0YXRlID09IFJFRkVSRU5DRSAmJiB0b2tlbiAmJiB0b2tlbi50eXBlID09IFRZUEVfQ09NTUVOVCkgewogICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnNlVGFnKSBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICBpZiAodG9rZW4pIGxhc3RUYWcuY2hpbGRzLnBvcCgpOwogICAgICAgICAgaWYgKHRva2VuID0gbGFzdFRhZy5jaGlsZHMucG9wKCkpIHsKICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9URVhUICYmICF0b2tlbi5yZWZzKSB0ZXh0U3RhdGVFbmRQb3MgLT0gImxlbiIgaW4gdG9rZW4gPyB0b2tlbi5sZW4gOiB0b2tlbi52YWx1ZS5sZW5ndGg7IGVsc2UgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJzZVRhZyA9IGZhbHNlOwogICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHBvcyA9IHN0YXRlLmxhc3RJbmRleDsKICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7CiAgICAgICAgICBjYXNlIFRFWFQ6CiAgICAgICAgICAgIHRleHRFbmRQb3MgPSBzdGFydFBvcyArIG1bMV0ubGVuZ3RoOwogICAgICAgICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHRleHRFbmRQb3MpIHsKICAgICAgICAgICAgICBzb3VyY2VUZXh0ID0gdGV4dFN0YXRlRW5kUG9zID09IHN0YXJ0UG9zID8gbVsxXSA6IHNvdXJjZS5zdWJzdHJpbmcodGV4dFN0YXRlRW5kUG9zLCB0ZXh0RW5kUG9zKTsKICAgICAgICAgICAgICB0b2tlbiA9IHNvdXJjZVRleHQucmVwbGFjZSgvXHMqKFxyXG4/fFxuXHI/KVxzKi9nLCAiIik7CiAgICAgICAgICAgICAgaWYgKHRva2VuKSBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIGxlbjogc291cmNlVGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICB2YWx1ZTogdG9rZW4KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZXh0U3RhdGVFbmRQb3MgPSB0ZXh0RW5kUG9zOwogICAgICAgICAgICBpZiAobVszXSkgewogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgcmVmczogWyAibDEwbjoiICsgbVszXSBdLAogICAgICAgICAgICAgICAgdmFsdWU6ICJ7bDEwbjoiICsgbVszXSArICJ9IgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1bMl0gPT0gInsiKSB7CiAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zIC0gMTsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhUCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgc3RhdGUgPSBSRUZFUkVOQ0U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVs0XSkgewogICAgICAgICAgICAgIGlmIChtWzRdID09ICIvIikgewogICAgICAgICAgICAgICAgdG9rZW4gPSBudWxsOwogICAgICAgICAgICAgICAgc3RhdGUgPSBDTE9TRV9UQUc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQ09NTUVOVAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAobVs1XSkgewogICAgICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3MgLSBtWzVdLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBSRUZFUkVOQ0U7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBidWZmZXJQb3MgPSBwb3M7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobVsyXSkgewogICAgICAgICAgICAgIHBhcnNlVGFnID0gdHJ1ZTsKICAgICAgICAgICAgICB0YWdTdGFjay5wdXNoKGxhc3RUYWcpOwogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICBhdHRyczogW10sCiAgICAgICAgICAgICAgICBjaGlsZHM6IFtdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgbGFzdFRhZyA9IHRva2VuOwogICAgICAgICAgICAgIHN0YXRlID0gVEFHX05BTUU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENMT1NFX1RBRzoKICAgICAgICAgICAgaWYgKG1bMV0gIT09IChsYXN0VGFnLnByZWZpeCA/IGxhc3RUYWcucHJlZml4ICsgIjoiIDogIiIpICsgbGFzdFRhZy5uYW1lKSB7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICB2YWx1ZTogIjwvIiArIG1bMF0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVEFHX05BTUU6CiAgICAgICAgICBjYXNlIEFUVFJJQlVURV9OQU1FX09SX0VORDoKICAgICAgICAgICAgaWYgKG1bMl0gPT0gIjoiKSB7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnByZWZpeCkgc3RhdGUgPSBCUkVBS19UQUdfUEFSU0U7IGVsc2UgdG9rZW4ucHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsxXSkgewogICAgICAgICAgICAgIHRva2VuLm5hbWUgPSBtWzFdOwogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfQVRUUklCVVRFKSBsYXN0VGFnLmF0dHJzLnB1c2godG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzJdID09ICJ7IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfRUxFTUVOVCkgc3RhdGUgPSBSRUZFUkVOQ0U7IGVsc2Ugc3RhdGUgPSBCUkVBS19UQUdfUEFSU0U7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bM10pIHsKICAgICAgICAgICAgICBwYXJzZVRhZyA9IGZhbHNlOwogICAgICAgICAgICAgIGlmIChtWzNdID09ICIvPiIpIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsgZWxzZSBpZiAobGFzdFRhZy5wcmVmaXggPT0gImIiICYmIGxhc3RUYWcubmFtZSBpbiBUQUdfSUdOT1JFX0NPTlRFTlQpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gVEFHX0lHTk9SRV9DT05URU5UW2xhc3RUYWcubmFtZV07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzJdID09ICI9IikgewogICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX1ZBTFVFOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ09NTUVOVDoKICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBzb3VyY2Uuc3Vic3RyaW5nKGJ1ZmZlclBvcywgcG9zIC0gMyk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFJFRkVSRU5DRToKICAgICAgICAgICAgaWYgKHRva2VuLnJlZnMpIHRva2VuLnJlZnMucHVzaChtWzFdKTsgZWxzZSB0b2tlbi5yZWZzID0gWyBtWzFdIF07CiAgICAgICAgICAgIGlmIChtWzJdICE9ICJ8IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgcG9zIC09IG1bMl0ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gc291cmNlLnN1YnN0cmluZyhidWZmZXJQb3MsIHBvcyk7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50eXBlID09IFRZUEVfQ09NTUVOVCkgewogICAgICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0FUVFJJQlVURSAmJiBzb3VyY2VbcG9zXSA9PSAiPSIpIHsKICAgICAgICAgICAgICAgIHBvcysrOwogICAgICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfVkFMVUU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRva2VuID0gewogICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX05BTUVfT1JfRU5EOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQVRUUklCVVRFX1ZBTFVFOgogICAgICAgICAgICB0b2tlbi52YWx1ZSA9IG1bMV0ucmVwbGFjZShxdW90ZVVuZXNjYXBlLCAnIicpOwogICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICB9OwogICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRBR19JR05PUkVfQ09OVEVOVC50ZXh0OgogICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgdmFsdWU6IG1bMV0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93ICJQYXJzZXIgYnVnIjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlID09IFRFWFQpIHRleHRTdGF0ZUVuZFBvcyA9IHBvczsKICAgICAgfQogICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHBvcykgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgIHZhbHVlOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgcG9zKQogICAgICB9KTsKICAgICAgaWYgKGxhc3RUYWcubmFtZSkgcmVzdWx0Lndhcm5zLnB1c2goIk5vIGNsb3NlIHRhZyBmb3IgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiIpOwogICAgICBpZiAoIXJlc3VsdC53YXJucy5sZW5ndGgpIGRlbGV0ZSByZXN1bHQud2FybnM7CiAgICAgIHJlc3VsdC50ZW1wbGF0ZVRva2VucyA9IHRydWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgdmFyIHRva2VuVGVtcGxhdGUgPSB7fTsKICAgIHZhciBMMTBuUHJveHlUb2tlbiA9IGJhc2lzLlRva2VuLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkwxMG5Qcm94eVRva2VuIiwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgdGhpcy51cmwgPSB0b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICI6IiArIHRva2VuLm5hbWU7CiAgICAgICAgdGhpcy50b2tlbiA9IHRva2VuOwogICAgICAgIHRoaXMuc2V0KCk7CiAgICAgICAgdG9rZW4uYXR0YWNoKHRoaXMuc2V0LCB0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuVG9rZW4ucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIiA/IHByb2Nlc3NNYXJrdXAodGhpcy50b2tlbi52YWx1ZSwgdGhpcy50b2tlbi5uYW1lICsgIkAiICsgdGhpcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCkgOiAiIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50b2tlbiA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcHJvY2Vzc01hcmt1cCh2YWx1ZSwgaWQpIHsKICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz0iYmFzaXNqcy1tYXJrdXAiIGRhdGEtYmFzaXNqcy1sMTBuPSInICsgaWQgKyAnIj4nICsgU3RyaW5nKHZhbHVlKSArICI8L3NwYW4+IjsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICBpZiAodHlwZW9mIHRva2VuID09ICJzdHJpbmciKSB0b2tlbiA9IGJhc2lzLmwxMG4udG9rZW4odG9rZW4pOwogICAgICBpZiAoIXRva2VuKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIGlkID0gdG9rZW4uYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF07CiAgICAgIGlmICghdGVtcGxhdGUpIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF0gPSBuZXcgVGVtcGxhdGUobmV3IEwxMG5Qcm94eVRva2VuKHRva2VuKSk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIHZhciBtYWtlRGVjbGFyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIElERU5UID0gL15bYS16X11bYS16MC05X1wtXSokL2k7CiAgICAgIHZhciBDTEFTU19BVFRSX1BBUlRTID0gLyhcUyspL2c7CiAgICAgIHZhciBDTEFTU19BVFRSX0JJTkRJTkcgPSAvXihbYS16X11bYS16MC05X1wtXSopP1x7KChhbmltOik/W2Etel9dW2EtejAtOV9cLV0qKVx9JC9pOwogICAgICB2YXIgU1RZTEVfQVRUUl9QQVJUUyA9IC9ccypbXjpdKz9ccyo6KD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyg/Ojt8JCkvZ2k7CiAgICAgIHZhciBTVFlMRV9QUk9QRVJUWSA9IC9ccyooW146XSs/KVxzKjooKD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyk7PyQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfQklORElORyA9IC9ceyhbYS16X11bYS16MC05X10qKVx9L2k7CiAgICAgIHZhciBBVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKnxsMTBuOlthLXpfXVthLXowLTlfXSooPzpcLlthLXpfXVthLXowLTlfXSopKig/OlwuXHtbYS16X11bYS16MC05X10qXH0pPylcfS9pOwogICAgICB2YXIgTkFNRURfQ0hBUkFDVEVSX1JFRiA9IC8mKFthLXpdK3wjWzAtOV0rfCN4WzAtOWEtZl17MSw0fSk7Py9naTsKICAgICAgdmFyIHRva2VuTWFwID0gYmFzaXMuTk9ERV9FTlYgPyBub2RlX3JlcXVpcmUoIi4vdGVtcGxhdGUvaHRtbGVudGl0eS5qc29uIikgOiB7fTsKICAgICAgdmFyIHRva2VuRWxlbWVudCA9ICFiYXNpcy5OT0RFX0VOViA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpIDogbnVsbDsKICAgICAgdmFyIGluY2x1ZGVTdGFjayA9IFtdOwogICAgICBmdW5jdGlvbiBuYW1lKHRva2VuKSB7CiAgICAgICAgcmV0dXJuICh0b2tlbi5wcmVmaXggPyB0b2tlbi5wcmVmaXggKyAiOiIgOiAiIikgKyB0b2tlbi5uYW1lOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5hbWVkQ2hhclJlcGxhY2UobSwgdG9rZW4pIHsKICAgICAgICBpZiAoIXRva2VuTWFwW3Rva2VuXSkgewogICAgICAgICAgaWYgKHRva2VuLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gU3RyaW5nLmZyb21DaGFyQ29kZSh0b2tlbi5jaGFyQXQoMSkgPT0gIngiIHx8IHRva2VuLmNoYXJBdCgxKSA9PSAiWCIgPyBwYXJzZUludCh0b2tlbi5zdWJzdHIoMiksIDE2KSA6IHRva2VuLnN1YnN0cigxKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodG9rZW5FbGVtZW50KSB7CiAgICAgICAgICAgICAgdG9rZW5FbGVtZW50LmlubmVySFRNTCA9IG07CiAgICAgICAgICAgICAgdG9rZW5NYXBbdG9rZW5dID0gdG9rZW5FbGVtZW50LmZpcnN0Q2hpbGQgPyB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgOiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbk1hcFt0b2tlbl0gfHwgbTsKICAgICAgfQogICAgICBmdW5jdGlvbiB1bnRva2VuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoTkFNRURfQ0hBUkFDVEVSX1JFRiwgbmFtZWRDaGFyUmVwbGFjZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVmTGlzdCh0b2tlbikgewogICAgICAgIHZhciBhcnJheSA9IHRva2VuLnJlZnM7CiAgICAgICAgaWYgKCFhcnJheSB8fCAhYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzc0F0dHIobmFtZSwgdmFsdWUpIHsKICAgICAgICBmdW5jdGlvbiBidWlsZEV4cHJlc3Npb24ocGFydHMpIHsKICAgICAgICAgIHZhciBiaW5kTmFtZTsKICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBbXTsKICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIGlmIChqICUgMikgewogICAgICAgICAgICBiaW5kTmFtZSA9IHBhcnRzW2pdOwogICAgICAgICAgICBpZiAoIW1hcFtiaW5kTmFtZV0pIHsKICAgICAgICAgICAgICBtYXBbYmluZE5hbWVdID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgIG5hbWVzLnB1c2goYmluZE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChtYXBbYmluZE5hbWVdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChwYXJ0c1tqXSkgZXhwcmVzc2lvbi5wdXNoKHVudG9rZW4ocGFydHNbal0pKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbIG5hbWVzLCBleHByZXNzaW9uIF07CiAgICAgICAgfQogICAgICAgIHZhciBiaW5kaW5ncyA9IDA7CiAgICAgICAgdmFyIHBhcnRzOwogICAgICAgIHZhciBtOwogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChDTEFTU19BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gW107CiAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChtID0gcGFydC5tYXRjaChDTEFTU19BVFRSX0JJTkRJTkcpKSBiaW5kaW5ncy5wdXNoKFsgbVsxXSB8fCAiIiwgbVsyXSBdKTsgZWxzZSBuZXdWYWx1ZS5wdXNoKHBhcnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsdWUgPSBuZXdWYWx1ZS5qb2luKCIgIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gW107CiAgICAgICAgICAgICAgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgICBpZiAocGFydHMgPSB2YWx1ZS5tYXRjaChTVFlMRV9BVFRSX1BBUlRTKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHBhcnQ7IHBhcnQgPSBwYXJ0c1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtID0gcGFydC5tYXRjaChTVFlMRV9QUk9QRVJUWSk7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBtWzFdOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBtWzJdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlUGFydHMgPSB2YWx1ZS5zcGxpdChTVFlMRV9BVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWVQYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cHIgPSBidWlsZEV4cHJlc3Npb24odmFsdWVQYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgZXhwci5wdXNoKHByb3BlcnR5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChleHByKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHByb3BzLnB1c2gocHJvcGVydHlOYW1lICsgIjogIiArIHVudG9rZW4odmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdCh2YWx1ZSkpIGJhc2lzLmRldi53YXJuKCJCYWQgdmFsdWUgZm9yIHN0eWxlIGF0dHJpYnV0ZSAodmFsdWUgaWdub3JlZCk6IiwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IHByb3BzLmpvaW4oIjsgIik7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB2YWx1ZSArPSAiOyI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcGFydHMgPSB2YWx1ZS5zcGxpdChBVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBiaW5kaW5ncyA9IGJ1aWxkRXhwcmVzc2lvbihwYXJ0cyk7IGVsc2UgdmFsdWUgPSB1bnRva2VuKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGJpbmRpbmdzICYmICFiaW5kaW5ncy5sZW5ndGgpIGJpbmRpbmdzID0gMDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgYmluZGluZzogYmluZGluZ3MsCiAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICB0eXBlOiBBVFRSX1RZUEVfQllfTkFNRVtuYW1lXSB8fCAyCiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhdHRycyh0b2tlbiwgZGVjbFRva2VuLCBvcHRpbWl6ZVNpemUpIHsKICAgICAgICB2YXIgYXR0cnMgPSB0b2tlbi5hdHRyczsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIG07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoYXR0ci5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicmVmIjoKICAgICAgICAgICAgICAgIHZhciByZWZzID0gKGF0dHIudmFsdWUgfHwgIiIpLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZnMubGVuZ3RoOyBqKyspIGFkZFRva2VuUmVmKGRlY2xUb2tlbiwgcmVmc1tqXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtID0gYXR0ci5uYW1lLm1hdGNoKEFUVFJfRVZFTlRfUlgpKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG1bMV0gPT0gYXR0ci52YWx1ZSA/IFsgVFlQRV9BVFRSSUJVVEVfRVZFTlQsIG1bMV0gXSA6IFsgVFlQRV9BVFRSSUJVVEVfRVZFTlQsIG1bMV0sIGF0dHIudmFsdWUgXSk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHIubmFtZSwgYXR0ci52YWx1ZSk7CiAgICAgICAgICB2YXIgaXRlbSA9IFsgcGFyc2VkLnR5cGUsIHBhcnNlZC5iaW5kaW5nLCByZWZMaXN0KGF0dHIpIF07CiAgICAgICAgICBpZiAocGFyc2VkLnR5cGUgPT0gMikgaXRlbS5wdXNoKG5hbWUoYXR0cikpOwogICAgICAgICAgaWYgKHBhcnNlZC52YWx1ZSAmJiAoIW9wdGltaXplU2l6ZSB8fCAhcGFyc2VkLmJpbmRpbmcgfHwgcGFyc2VkLnR5cGUgIT0gMikpIGl0ZW0ucHVzaChwYXJzZWQudmFsdWUpOwogICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0IDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZGRUb2tlblJlZih0b2tlbiwgcmVmTmFtZSkgewogICAgICAgIGlmICghdG9rZW5bVE9LRU5fUkVGU10pIHRva2VuW1RPS0VOX1JFRlNdID0gW107CiAgICAgICAgYXJyYXlBZGQodG9rZW5bVE9LRU5fUkVGU10sIHJlZk5hbWUpOwogICAgICAgIGlmIChyZWZOYW1lICE9ICJlbGVtZW50IikgdG9rZW5bVE9LRU5fQklORElOR1NdID0gdG9rZW5bVE9LRU5fUkVGU10ubGVuZ3RoID09IDEgPyByZWZOYW1lIDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSkgewogICAgICAgIHZhciBpZHggPSB0b2tlbltUT0tFTl9SRUZTXS5pbmRleE9mKHJlZk5hbWUpOwogICAgICAgIGlmIChpZHggIT0gLTEpIHsKICAgICAgICAgIHZhciBpbmRleEJpbmRpbmcgPSB0b2tlbltUT0tFTl9CSU5ESU5HU10gJiYgdHlwZW9mIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9PSAibnVtYmVyIjsKICAgICAgICAgIHRva2VuW1RPS0VOX1JFRlNdLnNwbGljZShpZHgsIDEpOwogICAgICAgICAgaWYgKGluZGV4QmluZGluZykgaWYgKGlkeCA9PSB0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSByZWZOYW1lOwogICAgICAgICAgaWYgKCF0b2tlbltUT0tFTl9SRUZTXS5sZW5ndGgpIHRva2VuW1RPS0VOX1JFRlNdID0gMDsgZWxzZSB7CiAgICAgICAgICAgIGlmIChpbmRleEJpbmRpbmcpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSAtPSBpZHggPCB0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB0b2tlbkF0dHJzKHRva2VuKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgIGlmICh0b2tlbi5hdHRycykgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSB0b2tlbi5hdHRyc1tpXTsgaSsrKSByZXN1bHRbbmFtZShhdHRyKV0gPSBhdHRyLnZhbHVlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWRkVW5pcXVlKGFycmF5LCBpdGVtcykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIGFycmF5QWRkKGFycmF5LCBpdGVtc1tpXSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJvY2Vzcyh0b2tlbnMsIHRlbXBsYXRlLCBvcHRpb25zKSB7CiAgICAgICAgZnVuY3Rpb24gbW9kaWZ5QXR0cih0b2tlbiwgbmFtZSwgYWN0aW9uKSB7CiAgICAgICAgICB2YXIgYXR0cnMgPSB0b2tlbkF0dHJzKHRva2VuKTsKICAgICAgICAgIGlmIChuYW1lKSBhdHRycy5uYW1lID0gbmFtZTsKICAgICAgICAgIGlmICghYXR0cnMubmFtZSkgewogICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJJbnN0cnVjdGlvbiA8YjoiICsgdG9rZW4ubmFtZSArICI+IGhhcyBubyBhdHRyaWJ1dGUgbmFtZSIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIUlERU5ULnRlc3QoYXR0cnMubmFtZSkpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGF0dHJpYnV0ZSBuYW1lIGAiICsgYXR0cnMubmFtZSArICJgIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbmNsdWRlZFRva2VuID0gdG9rZW5SZWZNYXBbYXR0cnMucmVmIHx8ICJlbGVtZW50Il07CiAgICAgICAgICBpZiAoaW5jbHVkZWRUb2tlbikgewogICAgICAgICAgICBpZiAoaW5jbHVkZWRUb2tlbi50b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgICB2YXIgaXRBdHRycyA9IGluY2x1ZGVkVG9rZW4udG9rZW47CiAgICAgICAgICAgICAgdmFyIGlzRXZlbnQgPSBhdHRycy5uYW1lLm1hdGNoKEFUVFJfRVZFTlRfUlgpOwogICAgICAgICAgICAgIHZhciBpdFR5cGUgPSBpc0V2ZW50ID8gVFlQRV9BVFRSSUJVVEVfRVZFTlQgOiBBVFRSX1RZUEVfQllfTkFNRVthdHRycy5uYW1lXSB8fCBUWVBFX0FUVFJJQlVURTsKICAgICAgICAgICAgICB2YXIgdmFsdWVJZHggPSBBVFRSX1ZBTFVFX0lOREVYW2l0VHlwZV0gfHwgQVRUUl9WQUxVRTsKICAgICAgICAgICAgICB2YXIgaXRBdHRyVG9rZW4gPSBpdEF0dHJzICYmIGFycmF5U2VhcmNoKGl0QXR0cnMsIGF0dHJzLm5hbWUsIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIHJldHVybiAiZXZlbnQtIiArIHRva2VuWzFdOwogICAgICAgICAgICAgICAgcmV0dXJuIEFUVFJfTkFNRV9CWV9UWVBFW3Rva2VuW1RPS0VOX1RZUEVdXSB8fCB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICAgIH0sIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgICAgIGlmICghaXRBdHRyVG9rZW4gJiYgYWN0aW9uICE9ICJyZW1vdmUiKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNFdmVudCkgewogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbiA9IFsgaXRUeXBlLCBpc0V2ZW50WzFdIF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbiA9IFsgaXRUeXBlLCAwLCAwLCBpdFR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgPyBhdHRycy5uYW1lIDogIiIgXTsKICAgICAgICAgICAgICAgICAgaWYgKGl0VHlwZSA9PSBUWVBFX0FUVFJJQlVURSkgaXRBdHRyVG9rZW4ucHVzaCgiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWl0QXR0cnMpIHsKICAgICAgICAgICAgICAgICAgaXRBdHRycyA9IFtdOwogICAgICAgICAgICAgICAgICBpbmNsdWRlZFRva2VuLnRva2VuLnB1c2goaXRBdHRycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpdEF0dHJzLnB1c2goaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2xhc3NPclN0eWxlID0gYXR0cnMubmFtZSA9PSAiY2xhc3MiIHx8IGF0dHJzLm5hbWUgPT0gInN0eWxlIjsKICAgICAgICAgICAgICBzd2l0Y2ggKGFjdGlvbikgewogICAgICAgICAgICAgICAgY2FzZSAic2V0IjoKICAgICAgICAgICAgICAgICAgaWYgKGl0QXR0clRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzLnZhbHVlID09IGlzRXZlbnRbMV0pIGl0QXR0clRva2VuLmxlbmd0aCA9IDI7IGVsc2UgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gYXR0cnMudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRycy5uYW1lLCBhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHBhcnNlZC5iaW5kaW5nOwogICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMub3B0aW1pemVTaXplIHx8ICFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gfHwgY2xhc3NPclN0eWxlKSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSBwYXJzZWQudmFsdWUgfHwgIiI7IGVsc2UgaXRBdHRyVG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgICAgICAgIGlmIChjbGFzc09yU3R5bGUpIGlmICghaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdICYmICFpdEF0dHJUb2tlblt2YWx1ZUlkeF0pIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShpdEF0dHJzLCBpdEF0dHJUb2tlbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHByb2Nlc3NBdHRyKGF0dHJzLm5hbWUsIGF0dHJzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlZC5iaW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ckJpbmRpbmdzID0gaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGF0dHJzLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkQmluZGluZ01hcCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG9sZEJpbmRpbmc7IG9sZEJpbmRpbmcgPSBhdHRyQmluZGluZ3NbaV07IGkrKykgb2xkQmluZGluZ01hcFtvbGRCaW5kaW5nWzJdXSA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmV3QmluZGluZzsgbmV3QmluZGluZyA9IHBhcnNlZC5iaW5kaW5nW2ldOyBpKyspIGlmIChuZXdCaW5kaW5nWzJdIGluIG9sZEJpbmRpbmdNYXApIGF0dHJCaW5kaW5nc1tvbGRCaW5kaW5nTWFwW25ld0JpbmRpbmdbMl1dXSA9IG5ld0JpbmRpbmc7IGVsc2UgYXR0ckJpbmRpbmdzLnB1c2gobmV3QmluZGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyQmluZGluZ3MucHVzaC5hcHBseShhdHRyQmluZGluZ3MsIHBhcnNlZC5iaW5kaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWQuYmluZGluZ1swXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlBZGQodGhpcywgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBhdHRyQmluZGluZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJzZWQuYmluZGluZ1sxXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZWQuYmluZGluZ1sxXVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIikgdmFsdWUgPSBhdHRyQmluZGluZ3NbMF0uaW5kZXhPZihwYXJzZWQuYmluZGluZ1swXVt2YWx1ZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyQmluZGluZ3NbMV0ucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHBhcnNlZC5iaW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsYXNzT3JTdHlsZSkgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdWzFdLnVuc2hpZnQoaXRBdHRyVG9rZW5bdmFsdWVJZHhdKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbGFzc09yU3R5bGUgJiYgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdKSBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU11bMV0ucHVzaChhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChwYXJzZWQudmFsdWUpIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IChpdEF0dHJUb2tlblt2YWx1ZUlkeF0gfHwgIiIpICsgKGl0QXR0clRva2VuW3ZhbHVlSWR4XSAmJiAoaXNFdmVudCB8fCBjbGFzc09yU3R5bGUpID8gIiAiIDogIiIpICsgcGFyc2VkLnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoY2xhc3NPclN0eWxlKSBpZiAoIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiAhaXRBdHRyVG9rZW5bdmFsdWVJZHhdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZSI6CiAgICAgICAgICAgICAgICAgIGlmIChpdEF0dHJUb2tlbikgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQXR0cmlidXRlIG1vZGlmaWNhdG9yIGlzIG5vdCByZWZlcmVuY2UgdG8gZWxlbWVudCB0b2tlbiAocmVmZXJlbmNlIG5hbWU6ICIgKyAoYXR0cnMucmVmIHx8ICJlbGVtZW50IikgKyAiKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdG9rZW4sIGl0ZW07IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciByZWZzID0gcmVmTGlzdCh0b2tlbik7CiAgICAgICAgICB2YXIgYmluZGluZ3MgPSByZWZzICYmIHJlZnMubGVuZ3RoID09IDEgPyByZWZzWzBdIDogMDsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgICBpZiAodG9rZW4ucHJlZml4ID09ICJiIikgewogICAgICAgICAgICAgICAgdmFyIGVsQXR0cnMgPSB0b2tlbkF0dHJzKHRva2VuKTsKICAgICAgICAgICAgICAgIHN3aXRjaCAodG9rZW4ubmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJyZXNvdXJjZSI6CiAgICAgICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4ubmFtZSA9PSAicmVzb3VyY2UiKSBiYXNpcy5kZXYud2FybigiPGI6cmVzb3VyY2U+IGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIFVzZSA8YjpzdHlsZT4gaW5zdGVhZC4iICsgKHRlbXBsYXRlLnNvdXJjZVVybCA/ICIgRmlsZTogIiArIHRlbXBsYXRlLnNvdXJjZVVybCA6ICIiKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZWxBdHRycy5zcmMpKSBiYXNpcy5kZXYud2FybigiQmFkIHVzYWdlOiA8YjoiICsgdG9rZW4ubmFtZSArICcgc3JjPSInICsgZWxBdHRycy5zcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLnJlc291cmNlcy5wdXNoKHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgZWxBdHRycy5zcmMpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImwxMG4iOgogICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQpIHRlbXBsYXRlLndhcm5zLnB1c2goIjxiOmwxMG4+IG11c3QgYmUgZGVjbGFyZWQgYmVmb3JlIGFueSBgbDEwbjpgIHRva2VuIChpbnN0cnVjdGlvbiBpZ25vcmVkKSIpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLnNyYykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGVsQXR0cnMuc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIGVsQXR0cnMuc3JjICsgJyIvPi5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kaWN0VVJJID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkksIGVsQXR0cnMuc3JjKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgImRlZmluZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCJuYW1lIiBpbiBlbEF0dHJzICYmICF0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZWxBdHRycy50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2wiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSA9IFsgZWxBdHRyc1siZGVmYXVsdCJdID09ICJ0cnVlIiA/IDEgOiAwIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVudW0iOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBlbEF0dHJzLnZhbHVlcyA/IGVsQXR0cnMudmFsdWVzLnRyaW0oKS5zcGxpdCgiICIpIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyB2YWx1ZXMuaW5kZXhPZihlbEF0dHJzWyJkZWZhdWx0Il0pICsgMSwgdmFsdWVzIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiQmFkIGRlZmluZSB0eXBlIGAiICsgZWxBdHRycy50eXBlICsgImAgZm9yICIgKyBlbEF0dHJzLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB0b2tlbi5jaGlsZHNbMF07CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSBiYXNpcy5vYmplY3QuZXh0ZW5kKHRleHQsIHsKICAgICAgICAgICAgICAgICAgICAgIHJlZnM6IChlbEF0dHJzLnJlZiB8fCAiIikudHJpbSgpLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAibm90cmltIiBpbiBlbEF0dHJzID8gdGV4dC52YWx1ZSA6IHRleHQudmFsdWUucmVwbGFjZSgvXlxzKltcclxuXSt8W1xyXG5dXHMqJC9nLCAiIikKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaW5jbHVkZSI6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlU3JjID0gZWxBdHRycy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlU3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNUZW1wbGF0ZVJlZiA9IC9eI1xkKyQvLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IGlzVGVtcGxhdGVSZWYgPyB0ZW1wbGF0ZVNyYy5zdWJzdHIoMSkgOiB0ZW1wbGF0ZVNyYzsKICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlUmVmKSByZXNvdXJjZSA9IHRlbXBsYXRlTGlzdFt1cmxdOyBlbHNlIGlmICgvXlthLXowLTlcLl0rJC9pLnRlc3QodXJsKSAmJiAhL1wudG1wbCQvLnRlc3QodXJsKSkgcmVzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgodXJsKTsgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdCh1cmwpKSBiYXNpcy5kZXYud2FybignQmFkIHVzYWdlOiA8YjppbmNsdWRlIHNyYz0iJyArIHVybCArICciLz4uXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHBhdGgucmVzb2x2ZSh0ZW1wbGF0ZS5iYXNlVVJJICsgdXJsKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goJzxiOmluY2x1ZGUgc3JjPSInICsgdGVtcGxhdGVTcmMgKyAnIj4gaXMgbm90IHJlc29sdmVkLCBpbnN0cnVjdGlvbiBpZ25vcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCc8YjppbmNsdWRlIHNyYz0iJyArIHRlbXBsYXRlU3JjICsgJyI+IGlzIG5vdCByZXNvbHZlZCwgaW5zdHJ1Y3Rpb24gaWdub3JlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlU3RhY2suaW5kZXhPZihyZXNvdXJjZSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlY2w7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5QWRkKHRlbXBsYXRlLmRlcHMsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZVN0YWNrLnB1c2gocmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZS5zb3VyY2UuYmluZGluZ0JyaWRnZSkgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2Uuc291cmNlLCByZXNvdXJjZS5iYXNlVVJJLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2UsIHJlc291cmNlLnVybCA/IHBhdGguZGlybmFtZShyZXNvdXJjZS51cmwpICsgIi8iIDogIiIsIHRydWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGVTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wucmVzb3VyY2VzICYmICJuby1zdHlsZSIgaW4gZWxBdHRycyA9PSBmYWxzZSkgYWRkVW5pcXVlKHRlbXBsYXRlLnJlc291cmNlcywgZGVjbC5yZXNvdXJjZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbC5kZXBzKSBhZGRVbmlxdWUodGVtcGxhdGUuZGVwcywgZGVjbC5kZXBzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wubDEwbikgYWRkVW5pcXVlKHRlbXBsYXRlLmwxMG4sIGRlY2wubDEwbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlblJlZk1hcCA9IG5vcm1hbGl6ZVJlZnMoZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdHJ1Y3Rpb25zID0gKHRva2VuLmNoaWxkcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnNbImNsYXNzIl0pIGluc3RydWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0VMRU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4OiAiYiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogImFwcGVuZC1jbGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM6IFsgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAidmFsdWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVsQXR0cnNbImNsYXNzIl0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IF0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzLmlkKSBpbnN0cnVjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogImIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJzZXQtYXR0ciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnM6IFsgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAibmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogImlkIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBlbEF0dHJzLmlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBdCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRycy5yZWYpIGlmICh0b2tlblJlZk1hcC5lbGVtZW50KSBlbEF0dHJzLnJlZi50cmltKCkuc3BsaXQoL1xzKy8pLm1hcChmdW5jdGlvbihyZWZOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkVG9rZW5SZWYodG9rZW5SZWZNYXAuZWxlbWVudC50b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgY2hpbGQ7IGNoaWxkID0gaW5zdHJ1Y3Rpb25zW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PSBUWVBFX0VMRU1FTlQgJiYgY2hpbGQucHJlZml4ID09ICJiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJiZWZvcmUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZnRlciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VPclJlbW92ZSA9IGNoaWxkLm5hbWUgPT0gInJlcGxhY2UiIHx8IGNoaWxkLm5hbWUgPT0gInJlbW92ZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyB8fCAhcmVwbGFjZU9yUmVtb3ZlID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gdG9rZW5SZWYub3duZXIuaW5kZXhPZih0b2tlblJlZi50b2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gWyBwb3MgKyAoY2hpbGQubmFtZSA9PSAiYWZ0ZXIiKSwgcmVwbGFjZU9yUmVtb3ZlIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lICE9ICJyZW1vdmUiKSBhcmdzID0gYXJncy5jb25jYXQocHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuUmVmLm93bmVyLnNwbGljZS5hcHBseSh0b2tlblJlZi5vd25lciwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJwcmVwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkcyA9IHByb2Nlc3MoY2hpbGQuY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQubmFtZSA9PSAicHJlcGVuZCIpIHRva2VuLnNwbGljZS5hcHBseSh0b2tlbiwgWyBFTEVNRU5UX0FUVFJTLCAwIF0uY29uY2F0KGNoaWxkcykpOyBlbHNlIHRva2VuLnB1c2guYXBwbHkodG9rZW4sIGNoaWxkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJyZW1vdmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJhcHBlbmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2V0LWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAic2V0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhZGQtcmVmIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzID8gY2hpbGRBdHRycy5yZWYgOiAiZWxlbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuUmVmID0gcmVmICYmIHRva2VuUmVmTWFwW3JlZl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5SZWYgJiYgdG9rZW5SZWYudG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuICYmIGNoaWxkQXR0cnMubmFtZSkgYWRkVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4pIHJlbW92ZVRva2VuUmVmKHRva2VuLCBjaGlsZEF0dHJzLm5hbWUgfHwgY2hpbGRBdHRycy5yZWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVua25vd24gaW5zdHJ1Y3Rpb24gdGFnIDxiOiIgKyBjaGlsZC5uYW1lICsgIj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgZGVjbC50b2tlbnMucHVzaC5hcHBseShkZWNsLnRva2VucywgcHJvY2VzcyhbIGNoaWxkIF0sIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVmTWFwLmVsZW1lbnQpIHJlbW92ZVRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sICJlbGVtZW50Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gaW5jbHVkZVN0YWNrLnNsaWNlKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSB8fCAwKS5jb25jYXQocmVzb3VyY2UpLm1hcChmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJlcyA9IHJlcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIEwxMG5Qcm94eVRva2VuKSByZXR1cm4gIntsMTBuOiIgKyByZXMudG9rZW4ubmFtZSArICJAIiArIHJlcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICJ9IjsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnVybCB8fCAiW2lubGluZSB0ZW1wbGF0ZV0iOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiUmVjdXJzaW9uOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiUmVjdXJzaW9uIGluIHRlbXBsYXRlICIgKyAodGVtcGxhdGUuc291cmNlVXJsIHx8ICJbaW5saW5lIHRlbXBsYXRlXSIpICsgIjogIiwgc3RhY2suam9pbigiIC0+ICIpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMSwgYmluZGluZ3MsIHJlZnMsIG5hbWUodG9rZW4pIF07CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIGF0dHJzKHRva2VuLCBpdGVtLCBvcHRpb25zLm9wdGltaXplU2l6ZSkgfHwgW10pOwogICAgICAgICAgICAgIGl0ZW0ucHVzaC5hcHBseShpdGVtLCBwcm9jZXNzKHRva2VuLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgaWYgKHJlZnMgJiYgcmVmcy5sZW5ndGggPT0gMiAmJiBhcnJheVNlYXJjaChyZWZzLCAiZWxlbWVudCIpKSBiaW5kaW5ncyA9IHJlZnNbKyFyZWZzLmxhc3RTZWFyY2hJbmRleF07CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBhYnNsMTBuKGJpbmRpbmdzLCB0ZW1wbGF0ZS5kaWN0VVJJKTsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGwxMG5CaW5kaW5nLnNwbGl0KC9bOkBce10vKTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHMubGVuZ3RoID09IDMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0c1syXSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHJlZnMsIGJpbmRpbmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVmcy5sZW5ndGggPT0gMCkgcmVmcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSAwOwogICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlID0gdG9rZW4udmFsdWUucmVwbGFjZSgvXH0kLywgIkB1bmRlZmluZWR9Iik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5JZCA9IHBhcnRzLnNsaWNlKDEpLmpvaW4oIkAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihsMTBuSWQpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVGVtcGxhdGUgPSBnZXRMMTBuVGVtcGxhdGUobDEwblRva2VuKTsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5sMTBuUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChsMTBuVGVtcGxhdGUgJiYgbDEwblRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1tpLS1dID0gdG9rZW5pemUoJzxiOmluY2x1ZGUgc3JjPSIjJyArIGwxMG5UZW1wbGF0ZS50ZW1wbGF0ZUlkICsgJyIvPicpWzBdOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGFycmF5QWRkKHRlbXBsYXRlLmwxMG4sIGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbSA9IFsgMywgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICAgIGlmIChvcHRpb25zLm9wdGltaXplU2l6ZSAmJiAhYmluZGluZ3MgJiYgIXJlZnMpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGl0ZW0gPSBbIDgsIGJpbmRpbmdzLCByZWZzIF07CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSkgaWYgKCFyZWZzIHx8IHRva2VuLnZhbHVlICE9ICJ7IiArIHJlZnMuam9pbigifCIpICsgIn0iKSBpdGVtLnB1c2godW50b2tlbih0b2tlbi52YWx1ZSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGl0ZW1baXRlbS5sZW5ndGggLSAxXSA9PT0gMCkgaXRlbS5wb3AoKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWJzbDEwbih2YWx1ZSwgZGljdFVSSSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gInN0cmluZyIpIHJldHVybiB2YWx1ZTsKICAgICAgICB2YXIgcGFydHMgPSB2YWx1ZS5zcGxpdCgiOiIpOwogICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMiAmJiBwYXJ0c1swXSA9PSAibDEwbiIgJiYgcGFydHNbMV0uaW5kZXhPZigiQCIpID09IC0xKSBwYXJ0c1sxXSA9IHBhcnRzWzFdICsgIkAiICsgZGljdFVSSTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbigiOiIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVJlZnModG9rZW5zLCBkaWN0VVJJLCBtYXAsIHN0SWR4KSB7CiAgICAgICAgaWYgKCFtYXApIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSBjb250aW51ZTsKICAgICAgICAgIHZhciByZWZzID0gdG9rZW5bVE9LRU5fUkVGU107CiAgICAgICAgICBpZiAocmVmcykgewogICAgICAgICAgICBmb3IgKHZhciBqID0gcmVmcy5sZW5ndGggLSAxLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tqXTsgai0tKSB7CiAgICAgICAgICAgICAgaWYgKHJlZk5hbWUuaW5kZXhPZigiOiIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICByZW1vdmVUb2tlblJlZih0b2tlbiwgcmVmTmFtZSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hcFtyZWZOYW1lXSkgcmVtb3ZlVG9rZW5SZWYobWFwW3JlZk5hbWVdLnRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdID09IHJlZk5hbWUpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGogKyAxOwogICAgICAgICAgICAgIG1hcFtyZWZOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG93bmVyOiB0b2tlbnMsCiAgICAgICAgICAgICAgICB0b2tlbjogdG9rZW4KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICAgIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IGFic2wxMG4odG9rZW5bVE9LRU5fQklORElOR1NdLCBkaWN0VVJJKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0FUVFJJQlVURToKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSB0b2tlbltUT0tFTl9CSU5ESU5HU11bMF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSBhcnJheVtqXSA9IGFic2wxMG4oYXJyYXlbal0sIGRpY3RVUkkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgbm9ybWFsaXplUmVmcyh0b2tlbiwgZGljdFVSSSwgbWFwLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhcHBseURlZmluZXModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgc3RJZHgpIHsKICAgICAgICB2YXIgdW5wcmVkaWN0YWJsZSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB1bnByZWRpY3RhYmxlICs9IGFwcGx5RGVmaW5lcyh0b2tlbiwgdGVtcGxhdGUsIG9wdGlvbnMsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0NMQVNTIHx8IHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUlkeCA9IEFUVFJfVkFMVUUgLSAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MpOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICB2YXIgbmV3QXR0clZhbHVlID0gKHRva2VuW3ZhbHVlSWR4XSB8fCAiIikudHJpbSgpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmQ7IGJpbmQgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYmluZC5sZW5ndGggPiAyKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRbMV0uc3BsaXQoIjoiKS5wb3AoKTsKICAgICAgICAgICAgICAgIHZhciBiaW5kRGVmID0gdGVtcGxhdGUuZGVmaW5lc1tiaW5kTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoYmluZERlZikgewogICAgICAgICAgICAgICAgICBiaW5kLnB1c2guYXBwbHkoYmluZCwgYmluZERlZik7CiAgICAgICAgICAgICAgICAgIGJpbmREZWYudXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmREZWYubGVuZ3RoID09IDEpIGFycmF5QWRkKG5ld0F0dHJWYWx1ZSwgYmluZFswXSArIGJpbmROYW1lKTsgZWxzZSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kRGVmWzFdW2JpbmREZWZbMF0gLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVucHJlZGljdGFibGUgdmFsdWUgYCIgKyBiaW5kTmFtZSArICJgIGluIGNsYXNzIGJpbmRpbmc6ICIgKyBiaW5kWzBdICsgInsiICsgYmluZFsxXSArICJ9Iik7CiAgICAgICAgICAgICAgICAgIHVucHJlZGljdGFibGUrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG9rZW5bdmFsdWVJZHhdID0gbmV3QXR0clZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5vcHRpbWl6ZVNpemUgJiYgIXRva2VuW3ZhbHVlSWR4XSkgdG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVucHJlZGljdGFibGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1ha2VEZWNsYXJhdGlvbihzb3VyY2UsIGJhc2VVUkksIG9wdGlvbnMsIHNvdXJjZVVybCkgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHZhciB3YXJucyA9IFtdOwogICAgICAgIHZhciBzb3VyY2VfOwogICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICBzb3VyY2VVcmw6IHNvdXJjZVVybCwKICAgICAgICAgIGJhc2VVUkk6IGJhc2VVUkkgfHwgIiIsCiAgICAgICAgICB0b2tlbnM6IG51bGwsCiAgICAgICAgICByZXNvdXJjZXM6IFtdLAogICAgICAgICAgZGVwczogW10sCiAgICAgICAgICBsMTBuOiBbXSwKICAgICAgICAgIGRlZmluZXM6IHt9LAogICAgICAgICAgdW5wcmVkaWN0YWJsZTogdHJ1ZSwKICAgICAgICAgIHdhcm5zOiB3YXJucwogICAgICAgIH07CiAgICAgICAgcmVzdWx0LmRpY3RVUkkgPSBzb3VyY2VVcmwgPyBiYXNpcy5wYXRoLnJlc29sdmUoc291cmNlVXJsKSA6IGJhc2VVUkkgfHwgIiI7CiAgICAgICAgaWYgKHJlc3VsdC5kaWN0VVJJKSB7CiAgICAgICAgICB2YXIgZXh0bmFtZSA9IGJhc2lzLnBhdGguZXh0bmFtZShyZXN1bHQuZGljdFVSSSk7CiAgICAgICAgICBpZiAoZXh0bmFtZSAmJiBleHRuYW1lICE9ICIubDEwbiIpIHJlc3VsdC5kaWN0VVJJID0gcmVzdWx0LmRpY3RVUkkuc3Vic3RyKDAsIHJlc3VsdC5kaWN0VVJJLmxlbmd0aCAtIGV4dG5hbWUubGVuZ3RoKSArICIubDEwbiI7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlLnRlbXBsYXRlVG9rZW5zKSB7CiAgICAgICAgICBzb3VyY2VfID0gc291cmNlOwogICAgICAgICAgc291cmNlID0gdG9rZW5pemUoU3RyaW5nKHNvdXJjZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc291cmNlLndhcm5zKSB3YXJucy5wdXNoLmFwcGx5KHdhcm5zLCBzb3VyY2Uud2FybnMpOwogICAgICAgIH0KICAgICAgICByZXN1bHQudG9rZW5zID0gcHJvY2Vzcyhzb3VyY2UsIHJlc3VsdCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFyZXN1bHQudG9rZW5zKSByZXN1bHQudG9rZW5zID0gWyBbIDMsIDAsIDAsICIiIF0gXTsKICAgICAgICBpZiAoc291cmNlXykgcmVzdWx0LnRva2Vucy5zb3VyY2VfID0gc291cmNlXzsKICAgICAgICBhZGRUb2tlblJlZihyZXN1bHQudG9rZW5zWzBdLCAiZWxlbWVudCIpOwogICAgICAgIG5vcm1hbGl6ZVJlZnMocmVzdWx0LnRva2VucywgcmVzdWx0LmRpY3RVUkkpOwogICAgICAgIHJlc3VsdC51bnByZWRpY3RhYmxlID0gISFhcHBseURlZmluZXMocmVzdWx0LnRva2VucywgcmVzdWx0LCBvcHRpb25zKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcmVzdWx0LmRlZmluZXMpIGlmICghcmVzdWx0LmRlZmluZXNba2V5XS51c2VkKSB3YXJucy5wdXNoKCJVbnVzZWQgZGVmaW5lIGZvciAiICsga2V5KTsKICAgICAgICBkZWxldGUgcmVzdWx0LmRlZmluZXM7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5sMTBuUmVzb2x2ZWQ7CiAgICAgICAgaWYgKCF3YXJucy5sZW5ndGgpIHJlc3VsdC53YXJucyA9IGZhbHNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgdXNhYmxlUmVzb3VyY2VzID0gewogICAgICAiLmNzcyI6IHRydWUKICAgIH07CiAgICBmdW5jdGlvbiBzdGFydFVzZVJlc291cmNlKHVyaSkgewogICAgICBpZiAodXNhYmxlUmVzb3VyY2VzW3BhdGguZXh0bmFtZSh1cmkpXSkgYmFzaXMucmVzb3VyY2UodXJpKSgpLnN0YXJ0VXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBzdG9wVXNlUmVzb3VyY2UodXJpKSB7CiAgICAgIGlmICh1c2FibGVSZXNvdXJjZXNbcGF0aC5leHRuYW1lKHVyaSldKSBiYXNpcy5yZXNvdXJjZSh1cmkpKCkuc3RvcFVzZSgpOwogICAgfQogICAgZnVuY3Rpb24gdGVtcGxhdGVTb3VyY2VVcGRhdGUoKSB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRhY2g7IGF0dGFjaCA9IHRoaXMuYXR0YWNoZXNfW2ldOyBpKyspIGF0dGFjaC5oYW5kbGVyLmNhbGwoYXR0YWNoLmNvbnRleHQpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWNsKGFycmF5KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgaWYgKGFycmF5LnNvdXJjZV8pIHJlc3VsdC5zb3VyY2VfID0gYXJyYXkuc291cmNlXzsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgcmVzdWx0LnB1c2goQXJyYXkuaXNBcnJheShhcnJheVtpXSkgPyBjbG9uZURlY2woYXJyYXlbaV0pIDogYXJyYXlbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVjbEZyb21Tb3VyY2Uoc291cmNlLCBiYXNlVVJJLCBjbG9uZSwgb3B0aW9ucykgewogICAgICB2YXIgcmVzdWx0ID0gc291cmNlOwogICAgICB2YXIgc291cmNlVXJsOwogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQoKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIHsKICAgICAgICBiYXNlVVJJID0gImJhc2VVUkkiIGluIHNvdXJjZSA/IHNvdXJjZS5iYXNlVVJJIDogYmFzZVVSSTsKICAgICAgICBzb3VyY2VVcmwgPSAidXJsIiBpbiBzb3VyY2UgPyBzb3VyY2UudXJsIDogc291cmNlVXJsOwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5nZXQoKTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgICAgaWYgKGNsb25lKSByZXN1bHQgPSBjbG9uZURlY2wocmVzdWx0KTsKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICB0b2tlbnM6IHJlc3VsdAogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gIm9iamVjdCIgfHwgIUFycmF5LmlzQXJyYXkocmVzdWx0LnRva2VucykpIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJzdHJpbmciKSByZXN1bHQgPSBtYWtlRGVjbGFyYXRpb24ocmVzdWx0LCBiYXNlVVJJLCBvcHRpb25zLCBzb3VyY2VVcmwpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gbDEwbkhhbmRsZXIodmFsdWUpIHsKICAgICAgaWYgKHRoaXMudHlwZSAhPSAibWFya3VwIiAmJiB0aGlzLnRva2VuLnR5cGUgPT0gIm1hcmt1cCIpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcy50ZW1wbGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGJ1aWxkVGVtcGxhdGUoKSB7CiAgICAgIHZhciBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UodGhpcy5zb3VyY2UsIHRoaXMuYmFzZVVSSSk7CiAgICAgIHZhciBkZXN0cm95QnVpbGRlciA9IHRoaXMuZGVzdHJveUJ1aWxkZXI7CiAgICAgIHZhciBmdW5jcyA9IHRoaXMuYnVpbGRlcihkZWNsLnRva2VucywgdGhpcyk7CiAgICAgIHZhciBkZXBzID0gdGhpcy5kZXBzXzsKICAgICAgdmFyIGwxMG4gPSB0aGlzLmwxMG5fOwogICAgICBpZiAoZGVwcykgewogICAgICAgIHRoaXMuZGVwc18gPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZXA7IGRlcCA9IGRlcHNbaV07IGkrKykgZGVwLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKGRlcCwgYnVpbGRUZW1wbGF0ZSwgdGhpcyk7CiAgICAgIH0KICAgICAgaWYgKGwxMG4pIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gbDEwbltpXTsgaSsrKSBpdGVtLnRva2VuLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKGl0ZW0udG9rZW4sIGwxMG5IYW5kbGVyLCBpdGVtKTsKICAgICAgaWYgKGRlY2wuZGVwcyAmJiBkZWNsLmRlcHMubGVuZ3RoKSB7CiAgICAgICAgZGVwcyA9IGRlY2wuZGVwczsKICAgICAgICB0aGlzLmRlcHNfID0gZGVwczsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGVwOyBkZXAgPSBkZXBzW2ldOyBpKyspIGRlcC5iaW5kaW5nQnJpZGdlLmF0dGFjaChkZXAsIGJ1aWxkVGVtcGxhdGUsIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChkZWNsLmwxMG4pIHsKICAgICAgICBsMTBuID0gZGVjbC5sMTBuOwogICAgICAgIHRoaXMubDEwbl8gPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBsMTBuW2ldOyBpKyspIHsKICAgICAgICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKGtleSk7CiAgICAgICAgICBsMTBuVG9rZW4uYmluZGluZ0JyaWRnZS5hdHRhY2gobDEwblRva2VuLCBsMTBuSGFuZGxlciwgdGhpcy5sMTBuX1trZXldID0gewogICAgICAgICAgICB0ZW1wbGF0ZTogdGhpcywKICAgICAgICAgICAgdG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICAgICAgdHlwZTogbDEwblRva2VuLnR5cGUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gZnVuY3MuY3JlYXRlSW5zdGFuY2U7CiAgICAgIHRoaXMuY2xlYXJJbnN0YW5jZSA9IGZ1bmNzLmRlc3Ryb3lJbnN0YW5jZTsKICAgICAgdGhpcy5nZXRCaW5kaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5hbWVzOiBmdW5jcy5rZXlzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgdGhpcy5kZXN0cm95QnVpbGRlciA9IGZ1bmNzLmRlc3Ryb3k7CiAgICAgIHRoaXMuaW5zdGFuY2VzXyA9IGZ1bmNzLmluc3RhbmNlc187CiAgICAgIHRoaXMuZGVjbF8gPSBkZWNsOwogICAgICB2YXIgZGVjbFJlc291cmNlcyA9IGRlY2wucmVzb3VyY2VzICYmIGRlY2wucmVzb3VyY2VzLmxlbmd0aCA+IDAgPyBkZWNsLnJlc291cmNlcyA6IG51bGw7CiAgICAgIGlmIChkZWNsUmVzb3VyY2VzKSBmb3IgKHZhciBpID0gMCwgcmVzOyByZXMgPSBkZWNsUmVzb3VyY2VzW2ldOyBpKyspIHN0YXJ0VXNlUmVzb3VyY2UocmVzKTsKICAgICAgaWYgKHRoaXMucmVzb3VyY2VzKSBmb3IgKHZhciBpID0gMCwgcmVzOyByZXMgPSB0aGlzLnJlc291cmNlc1tpXTsgaSsrKSBzdG9wVXNlUmVzb3VyY2UocmVzKTsKICAgICAgdGhpcy5yZXNvdXJjZXMgPSBkZWNsUmVzb3VyY2VzOwogICAgICBpZiAoZGVzdHJveUJ1aWxkZXIpIGRlc3Ryb3lCdWlsZGVyKHRydWUpOwogICAgfQogICAgZnVuY3Rpb24gc291cmNlQnlJZChzb3VyY2VJZCkgewogICAgICB2YXIgaG9zdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNvdXJjZUlkKTsKICAgICAgaWYgKGhvc3QgJiYgaG9zdC50YWdOYW1lID09ICJTQ1JJUFQiKSB7CiAgICAgICAgaWYgKGhvc3QudHlwZSA9PSAidGV4dC9iYXNpcy10ZW1wbGF0ZSIpIHJldHVybiBob3N0LnRleHRDb250ZW50IHx8IGhvc3QudGV4dDsKICAgICAgICBiYXNpcy5kZXYud2FybigiVGVtcGxhdGUgc2NyaXB0IGVsZW1lbnQgd2l0aCB3cm9uZyB0eXBlIiwgaG9zdC50eXBlKTsKICAgICAgICByZXR1cm4gIiI7CiAgICAgIH0KICAgICAgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHNjcmlwdCBlbGVtZW50IHdpdGggaWQgYCIgKyBzb3VyY2VJZCArICJgIG5vdCBmb3VuZCIpOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlU291cmNlQnlJZChzb3VyY2VJZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNvdXJjZUJ5SWQoc291cmNlSWQpOwogICAgICB9OwogICAgfQogICAgdmFyIFRlbXBsYXRlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlKSByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGVTd2l0Y2hDb25maWcpIHJldHVybiBuZXcgVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHNvdXJjZTogIiIsCiAgICAgIGJhc2VVUkk6ICIiLAogICAgICBpbml0OiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBpZiAodGVtcGxhdGVMaXN0Lmxlbmd0aCA9PSA0MDk2KSB0aHJvdyAiVG9vIG1hbnkgdGVtcGxhdGVzIChtYXhpbXVtIDQwOTYpIjsKICAgICAgICB0aGlzLmF0dGFjaGVzXyA9IFtdOwogICAgICAgIHRoaXMuc2V0U291cmNlKHNvdXJjZSB8fCAiIik7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUlkID0gdGVtcGxhdGVMaXN0LnB1c2godGhpcykgLSAxOwogICAgICB9LAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgcmV0dXJuOwogICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnB1c2goewogICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24odGVtcGxhdGUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaXN0ZW5lcjsgbGlzdGVuZXIgPSB0ZW1wbGF0ZS5hdHRhY2hlc19baV07IGkrKykgaWYgKGxpc3RlbmVyLmhhbmRsZXIgPT0gaGFuZGxlciAmJiBsaXN0ZW5lci5jb250ZXh0ID09IGNvbnRleHQpIHsKICAgICAgICAgICAgdGVtcGxhdGUuYXR0YWNoZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHt9CiAgICAgIH0sCiAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5zdGFuY2Uob2JqZWN0LCBhY3Rpb25DYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkge30sCiAgICAgIGdldEJpbmRpbmc6IGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLmdldEJpbmRpbmcoYmluZGluZ3MpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAob2xkU291cmNlICE9IHNvdXJjZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIG0gPSBzb3VyY2UubWF0Y2goL14oW2Etel0rKTovKTsKICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2Uuc3Vic3RyKG1bMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHByZWZpeCkgewogICAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlU291cmNlQnlJZChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInRva2VucyI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnN0cmluZy50b09iamVjdChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBzb3VyY2UuaXNEZWNsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyYXciOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInBhdGgiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSBnZXRTb3VyY2VCeVBhdGgoc291cmNlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLlRlbXBsYXRlLnNldFNvdXJjZTogVW5rbm93biBwcmVmaXggIiArIHByZWZpeCArICIgZm9yIHRlbXBsYXRlIHNvdXJjZSB3YXMgaW5nbm9yZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU291cmNlICYmIG9sZFNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIHZhciB0bXBsTGlzdCA9IG9sZFNvdXJjZS51cmwgJiYgdG1wbEZpbGVzTWFwW29sZFNvdXJjZS51cmxdOwogICAgICAgICAgICBpZiAodG1wbExpc3QpIHsKICAgICAgICAgICAgICBhcnJheVJlbW92ZSh0bXBsTGlzdCwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0bXBsTGlzdC5sZW5ndGgpIGRlbGV0ZSB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gIiI7CiAgICAgICAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZFNvdXJjZSwgdGVtcGxhdGVTb3VyY2VVcGRhdGUsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgICBpZiAoc291cmNlLnVybCkgewogICAgICAgICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGguZGlybmFtZShzb3VyY2UudXJsKSArICIvIjsKICAgICAgICAgICAgICBpZiAoIXRtcGxGaWxlc01hcFtzb3VyY2UudXJsXSkgdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdID0gW107CiAgICAgICAgICAgICAgYXJyYXlBZGQodG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3VyY2UuYmluZGluZ0JyaWRnZS5hdHRhY2goc291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgIHRlbXBsYXRlU291cmNlVXBkYXRlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kZXN0cm95QnVpbGRlcikgdGhpcy5kZXN0cm95QnVpbGRlcigpOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmNyZWF0ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB0aGlzLmdldEJpbmRpbmcgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnN0YW5jZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmRlY2xfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCBjb25maWcpOwogICAgfTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHJ1bGVSZXRfOiBudWxsLAogICAgICB0ZW1wbGF0ZXNfOiBudWxsLAogICAgICB0ZW1wbGF0ZUNsYXNzOiBUZW1wbGF0ZSwKICAgICAgcnVsZUV2ZW50czogbnVsbCwKICAgICAgcnVsZTogU3RyaW5nLAogICAgICBpbml0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICB0aGlzLnJ1bGVSZXRfID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZXNfID0gW107CiAgICAgICAgdGhpcy5ydWxlID0gY29uZmlnLnJ1bGU7CiAgICAgICAgdmFyIGV2ZW50cyA9IGNvbmZpZy5ldmVudHM7CiAgICAgICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnJ1bGVFdmVudHMgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSB0aGlzLnJ1bGVFdmVudHNbZXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGNsZWFuZXIuYWRkKHRoaXMpOwogICAgICB9LAogICAgICByZXNvbHZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICB2YXIgcmV0ID0gdGhpcy5ydWxlKG9iamVjdCk7CiAgICAgICAgdmFyIGlkeCA9IHRoaXMucnVsZVJldF8uaW5kZXhPZihyZXQpOwogICAgICAgIGlmIChpZHggPT0gLTEpIHsKICAgICAgICAgIHRoaXMucnVsZVJldF8ucHVzaChyZXQpOwogICAgICAgICAgaWR4ID0gdGhpcy50ZW1wbGF0ZXNfLnB1c2gobmV3IHRoaXMudGVtcGxhdGVDbGFzcyhyZXQpKSAtIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc19baWR4XTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5ydWxlID0gbnVsbDsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBudWxsOwogICAgICAgIHRoaXMucnVsZVJldF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHN3aXRjaGVyKGV2ZW50cywgcnVsZSkgewogICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgIHZhciBydWxlID0gYXJncy5wb3AoKTsKICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaENvbmZpZyh7CiAgICAgICAgcnVsZTogcnVsZSwKICAgICAgICBldmVudHM6IGFyZ3Muam9pbigiICIpLnRyaW0oKS5zcGxpdCgvXHMrLykKICAgICAgfSk7CiAgICB9CiAgICB2YXIgVGhlbWUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UaGVtZSIsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoCiAgICB9KTsKICAgIHZhciBTb3VyY2VXcmFwcGVyID0gQ2xhc3MoYmFzaXMuVG9rZW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlNvdXJjZVdyYXBwZXIiLAogICAgICBwYXRoOiAiIiwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHZhbHVlLCBwYXRoKSB7CiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsICIiKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UgPyB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZ2V0KHRoaXMudmFsdWUpIDogdGhpcy52YWx1ZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudCA9IGdldFRoZW1lU291cmNlKGN1cnJlbnRUaGVtZU5hbWUsIHRoaXMucGF0aCk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT0gY29udGVudCkgewogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMudmFsdWUgPSBjb250ZW50OwogICAgICAgICAgdGhpcy51cmwgPSBjb250ZW50ICYmIGNvbnRlbnQudXJsIHx8ICIiOwogICAgICAgICAgdGhpcy5iYXNlVVJJID0gKHR5cGVvZiBjb250ZW50ID09ICJvYmplY3QiIHx8IHR5cGVvZiBjb250ZW50ID09ICJmdW5jdGlvbiIpICYmICJiYXNlVVJJIiBpbiBjb250ZW50ID8gY29udGVudC5iYXNlVVJJIDogcGF0aC5kaXJuYW1lKHRoaXMudXJsKSArICIvIjsKICAgICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmF0dGFjaCh0aGlzLnZhbHVlLCBTb3VyY2VXcmFwcGVyLnByb3RvdHlwZS5hcHBseSwgdGhpcyk7CiAgICAgICAgICB0aGlzLmFwcGx5KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVybCA9IG51bGw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gbnVsbDsKICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgdGhpcy5hcHBseSwgdGhpcyk7CiAgICAgICAgYmFzaXMuVG9rZW4ucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBnZXRTb3VyY2VCeVBhdGgoKSB7CiAgICAgIHZhciBwYXRoID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5qb2luKCIuIik7CiAgICAgIHZhciBzb3VyY2UgPSBzb3VyY2VCeVBhdGhbcGF0aF07CiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgc291cmNlID0gbmV3IFNvdXJjZVdyYXBwZXIoIiIsIHBhdGgpOwogICAgICAgIHNvdXJjZUJ5UGF0aFtwYXRoXSA9IHNvdXJjZTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgZnVuY3Rpb24gbm9ybWFsaXplKGxpc3QpIHsKICAgICAgdmFyIHVzZWQgPSB7fTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGlmICghdXNlZFtsaXN0W2ldXSkgewogICAgICAgIHVzZWRbbGlzdFtpXV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKGxpc3RbaV0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRGYWxsYmFjayh0aGVtZU5hbWUsIGxpc3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICByZXN1bHQuc291cmNlID0gbm9ybWFsaXplKGxpc3QpLmpvaW4oIi8iKTsKICAgICAgdmFyIHVzZWQgPSB7CiAgICAgICAgYmFzZTogdHJ1ZQogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbmFtZSA9IGxpc3RbaV0gfHwgImJhc2UiOwogICAgICAgIGlmIChuYW1lID09IHRoZW1lTmFtZSB8fCB1c2VkW25hbWVdKSBjb250aW51ZTsKICAgICAgICB2YXIgdGhlbWUgPSBnZXRUaGVtZShuYW1lKTsKICAgICAgICB1c2VkW25hbWVdID0gdHJ1ZTsKICAgICAgICByZXN1bHQucHVzaChuYW1lKTsKICAgICAgICBsaXN0LnNwbGljZS5hcHBseShsaXN0LCBbIGkgKyAxLCAwIF0uY29uY2F0KHRoZW1lc1tuYW1lXS5mYWxsYmFjaykpOwogICAgICB9CiAgICAgIHJlc3VsdC51bnNoaWZ0KHRoZW1lTmFtZSk7CiAgICAgIGlmICh0aGVtZU5hbWUgIT0gImJhc2UiKSByZXN1bHQucHVzaCgiYmFzZSIpOwogICAgICByZXN1bHQudmFsdWUgPSByZXN1bHQuam9pbigiLyIpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgewogICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1tuYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgZm9yICh2YXIgaSA9IDAsIG1hcDsgbWFwID0gc291cmNlTGlzdFtpXTsgaSsrKSBpZiAobWFwLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gbWFwW3BhdGhdOwogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBmdW5jdGlvbiB0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpIHsKICAgICAgcmV0dXJuIHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjay5pbmRleE9mKHRoZW1lTmFtZSkgIT0gLTE7CiAgICB9CiAgICBmdW5jdGlvbiBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKSB7CiAgICAgIGdldFNvdXJjZUJ5UGF0aChwYXRoKS5zZXQoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWUoY2hhbmdlZCkgewogICAgICBiYXNpcy5kZXYubG9nKCJyZS1hcHBseSB0ZW1wbGF0ZXMiKTsKICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGhlbWUobmFtZSkgewogICAgICBpZiAoIW5hbWUpIG5hbWUgPSAiYmFzZSI7CiAgICAgIGlmICh0aGVtZXNbbmFtZV0pIHJldHVybiB0aGVtZXNbbmFtZV0udGhlbWU7CiAgICAgIGlmICghL14oW2EtejAtOVxfXC1dKykkLy50ZXN0KG5hbWUpKSB0aHJvdyAiQmFkIG5hbWUgZm9yIHRoZW1lIC0gIiArIG5hbWU7CiAgICAgIHZhciBzb3VyY2VzID0ge307CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gWyBzb3VyY2VzIF07CiAgICAgIHZhciB0aGVtZUludGVyZmFjZSA9IG5ldyBUaGVtZTsKICAgICAgdGhlbWVzW25hbWVdID0gewogICAgICAgIHRoZW1lOiB0aGVtZUludGVyZmFjZSwKICAgICAgICBzb3VyY2VzOiBzb3VyY2VzLAogICAgICAgIHNvdXJjZXNMaXN0OiBzb3VyY2VMaXN0LAogICAgICAgIGZhbGxiYWNrOiBbXQogICAgICB9OwogICAgICB2YXIgYWRkU291cmNlID0gZnVuY3Rpb24ocGF0aCwgc291cmNlKSB7CiAgICAgICAgaWYgKHBhdGggaW4gc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgc291cmNlc1twYXRoXSA9IHNvdXJjZTsKICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgfSBlbHNlIGJhc2lzLmRldi53YXJuKCJUZW1wbGF0ZSBwYXRoIGAiICsgcGF0aCArICJgIGlzIGFscmVhZHkgZGVmaW5lZCBmb3IgdGhlbWUgYCIgKyBuYW1lICsgImAgKGRlZmluaXRpb24gaWdub3JlZCkuIik7CiAgICAgICAgcmV0dXJuIGdldFNvdXJjZUJ5UGF0aChwYXRoKTsKICAgICAgfTsKICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGVtZUludGVyZmFjZSwgewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgZmFsbGJhY2s6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhlbWVJbnRlcmZhY2UgIT09IGJhc2VUaGVtZSAmJiBhcmd1bWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV3RmFsbGJhY2sgPSB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiLyIpIDogW107CiAgICAgICAgICAgIHZhciBjaGFuZ2VkID0ge307CiAgICAgICAgICAgIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgbmV3RmFsbGJhY2spOwogICAgICAgICAgICBpZiAodGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZSAhPSBuZXdGYWxsYmFjay5zb3VyY2UpIHsKICAgICAgICAgICAgICB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlID0gbmV3RmFsbGJhY2suc291cmNlOwogICAgICAgICAgICAgIGJhc2lzLmRldi5sb2coImZhbGxiYWNrIGNoYW5nZWQiKTsKICAgICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gdGhlbWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyRmFsbGJhY2sgPSB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgKGN1ckZhbGxiYWNrLnNvdXJjZSB8fCAiIikuc3BsaXQoIi8iKSk7CiAgICAgICAgICAgICAgICBpZiAobmV3RmFsbGJhY2sudmFsdWUgIT0gY3VyRmFsbGJhY2sudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY2hhbmdlZFt0aGVtZU5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbWVzW3RoZW1lTmFtZV0uZmFsbGJhY2sgPSBuZXdGYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZUxpc3QgPSB0aGVtZXNbdGhlbWVOYW1lXS5zb3VyY2VzTGlzdDsKICAgICAgICAgICAgICAgICAgc291cmNlTGlzdC5sZW5ndGggPSBuZXdGYWxsYmFjay5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlTGlzdC5sZW5ndGg7IGkrKykgc291cmNlTGlzdFtpXSA9IHRoZW1lc1tuZXdGYWxsYmFja1tpXV0uc291cmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFjayA9IHRoZW1lc1tjdXJyZW50VGhlbWVOYW1lXS5mYWxsYmFjazsKICAgICAgICAgICAgZm9yICh2YXIgdGhlbWVOYW1lIGluIGNoYW5nZWQpIHsKICAgICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QodGhlbWVOYW1lKSkgewogICAgICAgICAgICAgICAgc3luY0N1cnJlbnRUaGVtZSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNsaWNlKDEpOwogICAgICAgICAgcmVzdWx0LnNvdXJjZSA9IHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAgICAgZGVmaW5lOiBmdW5jdGlvbih3aGF0LCB3aGVyZXdpdGgpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAiZnVuY3Rpb24iKSB3aGF0ID0gd2hhdCgpOwogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hlcmV3aXRoID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHdoYXQ7CiAgICAgICAgICAgICAgdmFyIGRpY3Rpb25hcnkgPSB3aGVyZXdpdGg7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXN1bHRba2V5XSA9IGFkZFNvdXJjZShuYW1lc3BhY2UgKyAiLiIgKyBrZXksIGRpY3Rpb25hcnlba2V5XSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHdoYXQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWRkU291cmNlKHdoYXQsIHdoZXJld2l0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoYXQ7CiAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBkaWN0aW9uYXJ5KSBpZiAoZGljdGlvbmFyeS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgYWRkU291cmNlKHBhdGgsIGRpY3Rpb25hcnlbcGF0aF0pOwogICAgICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZmlyc3QgYXJndW1lbnQgZm9yIGJhc2lzLnRlbXBsYXRlLlRoZW1lI2RlZmluZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobmFtZSAhPSBjdXJyZW50VGhlbWVOYW1lKSB7CiAgICAgICAgICAgIGN1cnJlbnRUaGVtZU5hbWUgPSBuYW1lOwogICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBoYW5kbGVyOyBoYW5kbGVyID0gdGhlbWVDaGFuZ2VIYW5kbGVyc1tpXTsgaSsrKSBoYW5kbGVyLmZuLmNhbGwoaGFuZGxlci5jb250ZXh0LCBuYW1lKTsKICAgICAgICAgICAgYmFzaXMuZGV2LmluZm8oIlRlbXBsYXRlIHRoZW1lIHN3aXRjaGVkIHRvIGAiICsgbmFtZSArICJgIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICAgICAgfSwKICAgICAgICBnZXRTb3VyY2U6IGZ1bmN0aW9uKHBhdGgsIHdpdGhGYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHdpdGhGYWxsYmFjayA/IGdldFRoZW1lU291cmNlKG5hbWUsIHBhdGgpIDogc291cmNlc1twYXRoXTsKICAgICAgICB9LAogICAgICAgIGRyb3A6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgIGlmIChzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGgpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2VzW3BhdGhdOwogICAgICAgICAgICBpZiAodGhlbWVIYXNFZmZlY3QobmFtZSkpIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjayA9IGV4dGVuZEZhbGxiYWNrKG5hbWUsIFtdKTsKICAgICAgc291cmNlTGlzdC5wdXNoKHRoZW1lc1siYmFzZSJdLnNvdXJjZXMpOwogICAgICByZXR1cm4gdGhlbWVJbnRlcmZhY2U7CiAgICB9CiAgICB2YXIgdGhlbWVzID0ge307CiAgICB2YXIgc291cmNlQnlQYXRoID0ge307CiAgICB2YXIgYmFzZVRoZW1lID0gZ2V0VGhlbWUoKTsKICAgIHZhciBjdXJyZW50VGhlbWVOYW1lID0gImJhc2UiOwogICAgdmFyIHRoZW1lQ2hhbmdlSGFuZGxlcnMgPSBbXTsKICAgIGZ1bmN0aW9uIG9uVGhlbWVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgdGhlbWVDaGFuZ2VIYW5kbGVycy5wdXNoKHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudFRoZW1lTmFtZSk7CiAgICB9CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIHBhdGggaW4gc291cmNlQnlQYXRoKSBzb3VyY2VCeVBhdGhbcGF0aF0uZGVzdHJveSgpOwogICAgICAgIHRoZW1lcyA9IG51bGw7CiAgICAgICAgc291cmNlQnlQYXRoID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdGVtcGxhdGU7IHRlbXBsYXRlID0gdGVtcGxhdGVMaXN0W2ldOyBpKyspIHRlbXBsYXRlLmRlc3Ryb3koKTsKICAgICAgICB0ZW1wbGF0ZUxpc3QgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBERUNMQVJBVElPTl9WRVJTSU9OOiBERUNMQVJBVElPTl9WRVJTSU9OLAogICAgICBUWVBFX0VMRU1FTlQ6IFRZUEVfRUxFTUVOVCwKICAgICAgVFlQRV9BVFRSSUJVVEU6IFRZUEVfQVRUUklCVVRFLAogICAgICBUWVBFX0FUVFJJQlVURV9DTEFTUzogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIFRZUEVfQVRUUklCVVRFX1NUWUxFOiBUWVBFX0FUVFJJQlVURV9TVFlMRSwKICAgICAgVFlQRV9BVFRSSUJVVEVfRVZFTlQ6IFRZUEVfQVRUUklCVVRFX0VWRU5ULAogICAgICBUWVBFX1RFWFQ6IFRZUEVfVEVYVCwKICAgICAgVFlQRV9DT01NRU5UOiBUWVBFX0NPTU1FTlQsCiAgICAgIFRPS0VOX1RZUEU6IFRPS0VOX1RZUEUsCiAgICAgIFRPS0VOX0JJTkRJTkdTOiBUT0tFTl9CSU5ESU5HUywKICAgICAgVE9LRU5fUkVGUzogVE9LRU5fUkVGUywKICAgICAgQVRUUl9OQU1FOiBBVFRSX05BTUUsCiAgICAgIEFUVFJfVkFMVUU6IEFUVFJfVkFMVUUsCiAgICAgIEFUVFJfTkFNRV9CWV9UWVBFOiBBVFRSX05BTUVfQllfVFlQRSwKICAgICAgRUxFTUVOVF9OQU1FOiBFTEVNRU5UX05BTUUsCiAgICAgIEVMRU1FTlRfQVRUUlM6IEVMRU1FTlRfQVRUUlMsCiAgICAgIEVMRU1FTlRfQ0hJTERTOiBFTEVNRU5UX0NISUxEUywKICAgICAgVEVYVF9WQUxVRTogVEVYVF9WQUxVRSwKICAgICAgQ09NTUVOVF9WQUxVRTogQ09NTUVOVF9WQUxVRSwKICAgICAgTDEwblByb3h5VG9rZW46IEwxMG5Qcm94eVRva2VuLAogICAgICBUZW1wbGF0ZVN3aXRjaENvbmZpZzogVGVtcGxhdGVTd2l0Y2hDb25maWcsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IFRlbXBsYXRlU3dpdGNoZXIsCiAgICAgIFRlbXBsYXRlOiBUZW1wbGF0ZSwKICAgICAgU291cmNlV3JhcHBlcjogU291cmNlV3JhcHBlciwKICAgICAgc3dpdGNoZXI6IHN3aXRjaGVyLAogICAgICB0b2tlbml6ZTogdG9rZW5pemUsCiAgICAgIGdldERlY2xGcm9tU291cmNlOiBnZXREZWNsRnJvbVNvdXJjZSwKICAgICAgbWFrZURlY2xhcmF0aW9uOiBtYWtlRGVjbGFyYXRpb24sCiAgICAgIGdldEwxMG5UZW1wbGF0ZTogZ2V0TDEwblRlbXBsYXRlLAogICAgICBUaGVtZTogVGhlbWUsCiAgICAgIHRoZW1lOiBnZXRUaGVtZSwKICAgICAgZ2V0VGhlbWVMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXModGhlbWVzKTsKICAgICAgfSwKICAgICAgY3VycmVudFRoZW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLnRoZW1lOwogICAgICB9LAogICAgICBzZXRUaGVtZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiBnZXRUaGVtZShuYW1lKS5hcHBseSgpOwogICAgICB9LAogICAgICBvblRoZW1lQ2hhbmdlOiBvblRoZW1lQ2hhbmdlLAogICAgICBkZWZpbmU6IGJhc2VUaGVtZS5kZWZpbmUsCiAgICAgIGdldDogZ2V0U291cmNlQnlQYXRoLAogICAgICBnZXRQYXRoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGJhc2lzLm9iamVjdC5rZXlzKHNvdXJjZUJ5UGF0aCk7CiAgICAgIH0KICAgIH07CiAgICBnZXRUaGVtZSgiYmFzZSIpLmRlZmluZSh7CiAgICAgICIjMSI6IGJhc2lzLnJlc291cmNlKCIuLzAudG1wbCIpLAogICAgICAiIzIiOiBiYXNpcy5yZXNvdXJjZSgiLi8xLnRtcGwiKSwKICAgICAgIiMzIjogYmFzaXMucmVzb3VyY2UoIi4vMi50bXBsIiksCiAgICAgICIjNCI6IGJhc2lzLnJlc291cmNlKCIuLzMudG1wbCIpLAogICAgICAiIzUiOiBiYXNpcy5yZXNvdXJjZSgiLi80LnRtcGwiKSwKICAgICAgIiM2IjogYmFzaXMucmVzb3VyY2UoIi4vNS50bXBsIiksCiAgICAgICIjNyI6IGJhc2lzLnJlc291cmNlKCIuLzYudG1wbCIpLAogICAgICAiIzgiOiBiYXNpcy5yZXNvdXJjZSgiLi83LnRtcGwiKSwKICAgICAgIiM5IjogYmFzaXMucmVzb3VyY2UoIi4vOC50bXBsIikKICAgIH0pOwogIH0sCiAgIjguanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vOS5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzcuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBkb21FdmVudCA9IGJhc2lzLmRvbS5ldmVudDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIGNhbWVsaXplID0gYmFzaXMuc3RyaW5nLmNhbWVsaXplOwogICAgdmFyIGwxMG5Ub2tlbiA9IGJhc2lzLmwxMG4udG9rZW47CiAgICB2YXIgZ2V0RnVuY3Rpb25zID0gYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4uZ2V0RnVuY3Rpb25zOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoQ29uZmlnID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGVTd2l0Y2hDb25maWc7CiAgICB2YXIgVGVtcGxhdGVTd2l0Y2hlciA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlU3dpdGNoZXI7CiAgICB2YXIgVGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5BVFRSX1ZBTFVFOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIFRFWFRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5URVhUX1ZBTFVFOwogICAgdmFyIENPTU1FTlRfVkFMVUUgPSBiYXNpcy50ZW1wbGF0ZS5DT01NRU5UX1ZBTFVFOwogICAgdmFyIGV2ZW50QXR0ciA9IC9eZXZlbnQtKC4rKSsvOwogICAgdmFyIHRtcGxFdmVudExpc3RlbmVycyA9IHt9OwogICAgdmFyIHRlbXBsYXRlcyA9IHt9OwogICAgdmFyIG5hbWVzcGFjZVVSSSA9IHsKICAgICAgc3ZnOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB9OwogICAgdmFyIGFmdGVyRXZlbnRBY3Rpb24gPSB7fTsKICAgIHZhciBpbnNpZGVFbGVtZW50RXZlbnQgPSB7fTsKICAgIHZhciBNT1VTRV9FTlRFUl9MRUFWRV9TVVBQT1JUID0gIm9ubW91c2VlbnRlciIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgdmFyIENBUFRVUkVfRkFMTEJBQ0sgPSAhZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAmJiAiX19iYXNpc1RlbXBsYXRlIiArIHBhcnNlSW50KDFlOSAqIE1hdGgucmFuZG9tKCkpOwogICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIGdsb2JhbFtDQVBUVVJFX0ZBTExCQUNLXSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZXZlbnQpIHsKICAgICAgZG9tRXZlbnQuZmlyZUV2ZW50KGRvY3VtZW50LCBldmVudE5hbWUpOwogICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgIHZhciBsaXN0ZW5lciA9IHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdOwogICAgICBpZiAobGlzdGVuZXIpIGxpc3RlbmVyKG5ldyBkb21FdmVudC5FdmVudChldmVudCkpOwogICAgfTsKICAgIHZhciBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoImEiKSk7CiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoImEiKSk7CiAgICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKS5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxOwogICAgfSgpOwogICAgdmFyIFNFVF9DTEFTU19BVFRSSUJVVEVfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJjbGFzcyIsICJhIik7CiAgICAgIHJldHVybiAhZWxlbWVudC5jbGFzc05hbWU7CiAgICB9KCk7CiAgICB2YXIgU0VUX1NUWUxFX0FUVFJJQlVURV9CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgInBvc2l0aW9uOmFic29sdXRlIik7CiAgICAgIHJldHVybiBlbGVtZW50LnN0eWxlLnBvc2l0aW9uICE9ICJhYnNvbHV0ZSI7CiAgICB9KCk7CiAgICB2YXIgSVNfU0VUX1NUWUxFX1NBRkUgPSAhIWZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuY29sb3IgPSAieCI7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9KCk7CiAgICBpZiAodHlwZW9mIE5vZGUgIT0gInVuZGVmaW5lZCIgJiYgIU5vZGUucHJvdG90eXBlLmNvbnRhaW5zKSBOb2RlLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHJldHVybiAhISh0aGlzLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGNoaWxkKSAmIDE2KTsKICAgIH07CiAgICB2YXIgbDEwblRlbXBsYXRlcyA9IHt9OwogICAgZnVuY3Rpb24gZ2V0TDEwblRlbXBsYXRlKHRva2VuKSB7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IGJhc2lzLnRlbXBsYXRlLmdldEwxMG5UZW1wbGF0ZSh0b2tlbik7CiAgICAgIHZhciBpZCA9IHRlbXBsYXRlLnRlbXBsYXRlSWQ7CiAgICAgIHZhciBodG1sVGVtcGxhdGUgPSBsMTBuVGVtcGxhdGVzW2lkXTsKICAgICAgaWYgKCFodG1sVGVtcGxhdGUpIGh0bWxUZW1wbGF0ZSA9IGwxMG5UZW1wbGF0ZXNbaWRdID0gbmV3IEh0bWxUZW1wbGF0ZSh0ZW1wbGF0ZS5zb3VyY2UpOwogICAgICByZXR1cm4gaHRtbFRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGF0dHJOYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmIChldmVudC50eXBlID09ICJjbGljayIgJiYgZXZlbnQud2hpY2ggPT0gMykgcmV0dXJuOwogICAgICAgIHZhciBidWJibGUgPSBpbnNpZGVFbGVtZW50RXZlbnRbZXZlbnQudHlwZV0gfHwgZXZlbnQudHlwZSAhPSAibW91c2VlbnRlciIgJiYgZXZlbnQudHlwZSAhPSAibW91c2VsZWF2ZSI7CiAgICAgICAgdmFyIGF0dHJDdXJzb3IgPSBldmVudC5zZW5kZXI7CiAgICAgICAgdmFyIGF0dHI7CiAgICAgICAgd2hpbGUgKGF0dHJDdXJzb3IpIHsKICAgICAgICAgIGF0dHIgPSBhdHRyQ3Vyc29yLmdldEF0dHJpYnV0ZSAmJiBhdHRyQ3Vyc29yLmdldEF0dHJpYnV0ZShhdHRyTmFtZSk7CiAgICAgICAgICBpZiAoIWJ1YmJsZSB8fCB0eXBlb2YgYXR0ciA9PSAic3RyaW5nIikgYnJlYWs7CiAgICAgICAgICBhdHRyQ3Vyc29yID0gYXR0ckN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGF0dHIgPT0gInN0cmluZyIpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSBhdHRyQ3Vyc29yOwogICAgICAgICAgdmFyIGFjdGlvblRhcmdldCA9IGN1cnNvcjsKICAgICAgICAgIHZhciByZWZJZDsKICAgICAgICAgIHZhciB0bXBsUmVmOwogICAgICAgICAgaWYgKGluc2lkZUVsZW1lbnRFdmVudFtldmVudC50eXBlXSkgewogICAgICAgICAgICB2YXIgcmVsVGFyZ2V0ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgaWYgKHJlbFRhcmdldCAmJiAoY3Vyc29yID09PSByZWxUYXJnZXQgfHwgY3Vyc29yLmNvbnRhaW5zKHJlbFRhcmdldCkpKSBjdXJzb3IgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgICByZWZJZCA9IGN1cnNvci5iYXNpc1RlbXBsYXRlSWQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmSWQgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodG1wbFJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bXBsUmVmICYmIHRtcGxSZWYuYWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gYXR0ci50cmltKCkuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICBldmVudC5hY3Rpb25UYXJnZXQgPSBhY3Rpb25UYXJnZXQ7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb25OYW1lOyBhY3Rpb25OYW1lID0gYWN0aW9uc1tpKytdOyApIHRtcGxSZWYuYWN0aW9uLmNhbGwodG1wbFJlZi5jb250ZXh0LCBhY3Rpb25OYW1lLCBldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudC50eXBlIGluIGFmdGVyRXZlbnRBY3Rpb24pIGFmdGVyRXZlbnRBY3Rpb25bZXZlbnQudHlwZV0oZXZlbnQsIGF0dHJDdXJzb3IpOwogICAgICB9OwogICAgfQogICAgdmFyIGJ1aWxkSHRtbCA9IGZ1bmN0aW9uKHRva2VucywgcGFyZW50KSB7CiAgICAgIGZ1bmN0aW9uIGVtdWxhdGVFdmVudChvcmlnRXZlbnROYW1lLCBlbXVsRXZlbnROYW1lKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGVtdWxFdmVudE5hbWUpOwogICAgICAgIGluc2lkZUVsZW1lbnRFdmVudFtvcmlnRXZlbnROYW1lXSA9IHRydWU7CiAgICAgICAgYWZ0ZXJFdmVudEFjdGlvbltlbXVsRXZlbnROYW1lXSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICBldmVudC50eXBlID0gb3JpZ0V2ZW50TmFtZTsKICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgfTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW29yaWdFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQsIGN1cnNvcikgewogICAgICAgICAgY3Vyc29yID0gY3Vyc29yICYmIGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgaWYgKGN1cnNvcikgewogICAgICAgICAgICBldmVudCA9IG5ldyBkb21FdmVudC5FdmVudChldmVudCk7CiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgICBldmVudC5zZW5kZXIgPSBjdXJzb3I7CiAgICAgICAgICAgIHRtcGxFdmVudExpc3RlbmVyc1tvcmlnRXZlbnROYW1lXShldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKSB7CiAgICAgICAgaWYgKCF0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSkgewogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBjcmVhdGVFdmVudEhhbmRsZXIoImV2ZW50LSIgKyBldmVudE5hbWUpOwogICAgICAgICAgaWYgKCFDQVBUVVJFX0ZBTExCQUNLKSB7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlZW50ZXIiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3ZlciIpOwogICAgICAgICAgICBpZiAoIU1PVVNFX0VOVEVSX0xFQVZFX1NVUFBPUlQgJiYgZXZlbnROYW1lID09ICJtb3VzZWxlYXZlIikgcmV0dXJuIGVtdWxhdGVFdmVudChldmVudE5hbWUsICJtb3VzZW91dCIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmFtZXMgPSBkb21FdmVudC5icm93c2VyRXZlbnRzKGV2ZW50TmFtZSksIGJyb3dzZXJFdmVudE5hbWU7IGJyb3dzZXJFdmVudE5hbWUgPSBuYW1lc1tpXTsgaSsrKSBkb21FdmVudC5hZGRHbG9iYWxIYW5kbGVyKGJyb3dzZXJFdmVudE5hbWUsIHRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhY3Rpb25zKSB7CiAgICAgICAgcmVnRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSk7CiAgICAgICAgaWYgKENBUFRVUkVfRkFMTEJBQ0spIHJlc3VsdC5zZXRBdHRyaWJ1dGUoIm9uIiArIGV2ZW50TmFtZSwgQ0FQVFVSRV9GQUxMQkFDSyArICcoIicgKyBldmVudE5hbWUgKyAnIixldmVudCknKTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKCJldmVudC0iICsgZXZlbnROYW1lLCBhY3Rpb25zKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAoU0VUX0NMQVNTX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAiY2xhc3MiKSBuYW1lID0gImNsYXNzTmFtZSI7CiAgICAgICAgaWYgKFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHICYmIG5hbWUgPT0gInN0eWxlIikgcmV0dXJuIHJlc3VsdC5zdHlsZS5jc3NUZXh0ID0gdmFsdWU7CiAgICAgICAgcmVzdWx0LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHBhcmVudCB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGZvciAodmFyIGkgPSBwYXJlbnQgPyA0IDogMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHRva2VuW1RPS0VOX1RZUEVdKSB7CiAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgdmFyIHRhZ05hbWUgPSB0b2tlbltFTEVNRU5UX05BTUVdOwogICAgICAgICAgICB2YXIgcGFydHMgPSB0YWdOYW1lLnNwbGl0KC86Lyk7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gcGFydHMubGVuZ3RoID4gMSA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUklbcGFydHNbMF1dLCB0YWdOYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgICAgICAgICAgIGJ1aWxkSHRtbCh0b2tlbiwgZWxlbWVudCk7CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0b2tlbltBVFRSX05BTUVdOwogICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gdG9rZW5bQVRUUl9WQUxVRV07CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBhdHRyTmFtZS5yZXBsYWNlKC9eZXZlbnQtLywgIiIpOwogICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9IGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgc2V0RXZlbnRBdHRyaWJ1dGUoZXZlbnROYW1lLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhdHRyTmFtZSAhPSAiY2xhc3MiICYmIGF0dHJOYW1lICE9ICJzdHlsZSIgPyAhdG9rZW5bVE9LRU5fQklORElOR1NdIDogYXR0clZhbHVlKSBzZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFIC0gMV07CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0sIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZSh0b2tlblsxXSwgdG9rZW5bMl0gfHwgdG9rZW5bMV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9DT01NRU5UOgogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0b2tlbltDT01NRU5UX1ZBTFVFXSB8fCAodG9rZW5bVE9LRU5fUkVGU10gPyAieyIgKyB0b2tlbltUT0tFTl9SRUZTXS5qb2luKCJ8IikgKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgaWYgKENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcgJiYgaSAmJiB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpKTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRva2VuW1RFWFRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSB8fCAodG9rZW5bVE9LRU5fQklORElOR1NdID8gInsiICsgdG9rZW5bVE9LRU5fQklORElOR1NdICsgIn0iIDogIiIpKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXBhcmVudCAmJiB0b2tlbnMubGVuZ3RoID09IDEpIHJlc3VsdCA9IHJlc3VsdC5maXJzdENoaWxkOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZUJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlSWQgPSByZWZJZCAmIDQwOTU7CiAgICAgIHZhciBvYmplY3QgPSB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0LnRlbXBsYXRlOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIGluc3RhbmNlSWQgPSByZWZJZCA+PiAxMjsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QuaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZU9iamVjdEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5jb250ZXh0OwogICAgfQogICAgZnVuY3Rpb24gcmVzb2x2ZVRtcGxCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZVJlZiA9IHJlc29sdmVJbnN0YW5jZUJ5SWQocmVmSWQpOwogICAgICByZXR1cm4gdGVtcGxhdGVSZWYgJiYgdGVtcGxhdGVSZWYudG1wbDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERlYnVnSW5mb0J5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZyAmJiB0ZW1wbGF0ZVJlZi5kZWJ1ZygpOwogICAgfQogICAgdmFyIGJ1aWxkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIFdISVRFU1BBQ0UgPSAvXHMrLzsKICAgICAgdmFyIFczQ19ET01fTk9ERV9TVVBQT1JURUQgPSB0eXBlb2YgTm9kZSA9PSAiZnVuY3Rpb24iICYmIGRvY3VtZW50IGluc3RhbmNlb2YgTm9kZTsKICAgICAgdmFyIENMQVNTTElTVF9TVVBQT1JURUQgPSBnbG9iYWwuRE9NVG9rZW5MaXN0ICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QgaW5zdGFuY2VvZiBnbG9iYWwuRE9NVG9rZW5MaXN0OwogICAgICB2YXIgYmluZF9ub2RlID0gVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgTm9kZSA/IG5ld1ZhbHVlIDogZG9tUmVmOwogICAgICAgIGlmIChuZXdOb2RlICE9PSBvbGROb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJvYmplY3QiID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG5ld05vZGUgPSBkb21SZWY7CiAgICAgICAgICAgIGlmIChvbGROb2RlICE9PSBuZXdOb2RlKSBvbGROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfZWxlbWVudCA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmICYmIHR5cGVvZiBuZXdWYWx1ZSA9PSAic3RyaW5nIikgZG9tUmVmLmlubmVySFRNTCA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9jb21tZW50ID0gYmluZF9ub2RlOwogICAgICB2YXIgYmluZF90ZXh0Tm9kZSA9IGZ1bmN0aW9uKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpIHsKICAgICAgICB2YXIgbmV3Tm9kZSA9IGJpbmRfbm9kZShkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAobmV3Tm9kZSA9PT0gZG9tUmVmKSBkb21SZWYubm9kZVZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJDbGFzcyA9IENMQVNTTElTVF9TVVBQT1JURUQgPyBmdW5jdGlvbihkb21SZWYsIG9sZENsYXNzLCBuZXdWYWx1ZSwgcHJlZml4LCBhbmltKSB7CiAgICAgICAgdmFyIG5ld0NsYXNzID0gbmV3VmFsdWUgPyBwcmVmaXggKyBuZXdWYWx1ZSA6ICIiOwogICAgICAgIGlmIChuZXdDbGFzcyAhPSBvbGRDbGFzcykgewogICAgICAgICAgaWYgKG9sZENsYXNzKSBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QuYWRkKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LnJlbW92ZShuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gZG9tUmVmLmNsYXNzTmFtZTsKICAgICAgICAgIHZhciBjbGFzc05hbWVJc09iamVjdCA9IHR5cGVvZiBjbGFzc05hbWUgIT0gInN0cmluZyI7CiAgICAgICAgICB2YXIgY2xhc3NMaXN0OwogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBjbGFzc05hbWUgPSBjbGFzc05hbWUuYmFzZVZhbDsKICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTmFtZS5zcGxpdChXSElURVNQQUNFKTsKICAgICAgICAgIGlmIChvbGRDbGFzcykgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgb2xkQ2xhc3MpOwogICAgICAgICAgaWYgKG5ld0NsYXNzKSB7CiAgICAgICAgICAgIGNsYXNzTGlzdC5wdXNoKG5ld0NsYXNzKTsKICAgICAgICAgICAgaWYgKGFuaW0pIHsKICAgICAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgIGJhc2lzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNsYXNzTGlzdCA9IChjbGFzc05hbWVJc09iamVjdCA/IGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA6IGRvbVJlZi5jbGFzc05hbWUpLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgICAgICAgYmFzaXMuYXJyYXkucmVtb3ZlKGNsYXNzTGlzdCwgbmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICAgIGlmIChjbGFzc05hbWVJc09iamVjdCkgZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsgZWxzZSBkb21SZWYuY2xhc3NOYW1lID0gY2xhc3NMaXN0LmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2F0dHJTdHlsZSA9IElTX1NFVF9TVFlMRV9TQUZFID8gZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfSA6IGZ1bmN0aW9uKGRvbVJlZiwgcHJvcGVydHlOYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkb21SZWYuc3R5bGVbY2FtZWxpemUocHJvcGVydHlOYW1lKV0gPSBuZXdWYWx1ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ciA9IGZ1bmN0aW9uKGRvbVJlZiwgYXR0ck5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIGlmIChuZXdWYWx1ZSkgZG9tUmVmLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpOyBlbHNlIGRvbVJlZi5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3VmFsdWU7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF0dGFjaCgpIHsKICAgICAgICB0aGlzLnNldCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlc29sdmVWYWx1ZShiaW5kaW5nTmFtZSwgdmFsdWUsIEF0dGFjaGVzKSB7CiAgICAgICAgdmFyIGJyaWRnZSA9IHZhbHVlICYmIHZhbHVlLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgdmFyIG9sZEF0dGFjaCA9IHRoaXMuYXR0YWNoZXMgJiYgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV07CiAgICAgICAgdmFyIHRtcGwgPSBudWxsOwogICAgICAgIGlmIChicmlkZ2UgfHwgb2xkQXR0YWNoKSB7CiAgICAgICAgICBpZiAoYnJpZGdlKSB7CiAgICAgICAgICAgIGlmICghb2xkQXR0YWNoIHx8IHZhbHVlICE9PSBvbGRBdHRhY2gudmFsdWUpIHsKICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkQXR0YWNoLnRtcGwpIHsKICAgICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PSAibWFya3VwIiAmJiB2YWx1ZSBpbnN0YW5jZW9mIGJhc2lzLmwxMG4uVG9rZW4pIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRoaXMuYmluZGluZ3M7CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0ludGVyZmFjZSA9IHRoaXMuYmluZGluZ0ludGVyZmFjZTsKICAgICAgICAgICAgICAgIHRtcGwgPSB0ZW1wbGF0ZS5jcmVhdGVJbnN0YW5jZShjb250ZXh0LCBudWxsLCBmdW5jdGlvbiBvblJlYnVpbGQoKSB7CiAgICAgICAgICAgICAgICAgIHRtcGwgPSBuZXdBdHRhY2gudG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUF0dGFjaC5jYWxsKG5ld0F0dGFjaCk7CiAgICAgICAgICAgICAgICB9LCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICB0bXBsLmVsZW1lbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmF0dGFjaGVzKSB0aGlzLmF0dGFjaGVzID0gbmV3IEF0dGFjaGVzOwogICAgICAgICAgICAgIHZhciBuZXdBdHRhY2ggPSB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGJpbmRpbmdOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgdG1wbDogdG1wbCwKICAgICAgICAgICAgICAgIHNldDogdGhpcy50bXBsLnNldAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYnJpZGdlLmF0dGFjaCh2YWx1ZSwgdXBkYXRlQXR0YWNoLCBuZXdBdHRhY2gpOwogICAgICAgICAgICB9IGVsc2UgdG1wbCA9IHZhbHVlICYmIHZhbHVlLnR5cGUgPT0gIm1hcmt1cCIgPyBvbGRBdHRhY2gudG1wbCA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bXBsKSByZXR1cm4gdG1wbC5lbGVtZW50OwogICAgICAgICAgICB2YWx1ZSA9IGJyaWRnZS5nZXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG9sZEF0dGFjaCkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgb2xkQXR0YWNoLnRtcGwuZWxlbWVudC50b1N0cmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICBnZXRMMTBuVGVtcGxhdGUob2xkQXR0YWNoLnZhbHVlKS5jbGVhckluc3RhbmNlKG9sZEF0dGFjaC50bXBsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb2xkQXR0YWNoLnZhbHVlLmJpbmRpbmdCcmlkZ2UuZGV0YWNoKG9sZEF0dGFjaC52YWx1ZSwgdXBkYXRlQXR0YWNoLCBvbGRBdHRhY2gpOwogICAgICAgICAgICAgIHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ1VwZGF0ZXIobmFtZXMsIGdldHRlcnMpIHsKICAgICAgICB2YXIgbmFtZTEgPSBuYW1lc1swXTsKICAgICAgICB2YXIgbmFtZTIgPSBuYW1lc1sxXTsKICAgICAgICB2YXIgZ2V0dGVyMSA9IGdldHRlcnNbbmFtZTFdOwogICAgICAgIHZhciBnZXR0ZXIyID0gZ2V0dGVyc1tuYW1lMl07CiAgICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJpbmRpbmdVcGRhdGVyMShvYmplY3QpIHsKICAgICAgICAgICAgICB0aGlzKG5hbWUxLCBnZXR0ZXIxKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIyKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMiwgZ2V0dGVyMihvYmplY3QpKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZhciBnZXR0ZXJzXyA9IG5hbWVzLm1hcChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcnNbbmFtZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXJOKG9iamVjdCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHRoaXMobmFtZXNbaV0sIGdldHRlcnNfW2ldKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpIHsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIGV2ZW50cykgZXZlbnRzW25hbWVdID0gY3JlYXRlQmluZGluZ1VwZGF0ZXIoZXZlbnRzW25hbWVdLCBnZXR0ZXJzKTsKICAgICAgICByZXR1cm4gbmFtZSA/IGV2ZW50cyA6IG51bGw7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ0Z1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgYmluZGluZ0NhY2hlID0ge307CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGdldEJpbmRpbmcoYmluZGluZ3MsIG9iaiwgc2V0LCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICBpZiAoIWJpbmRpbmdzKSByZXR1cm4ge307CiAgICAgICAgICB2YXIgY2FjaGVJZCA9ICJiaW5kaW5nSWQiIGluIGJpbmRpbmdzID8gYmluZGluZ3MuYmluZGluZ0lkIDogbnVsbDsKICAgICAgICAgIGlmICghY2FjaGVJZCkgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlLmdldEJpbmRpbmc6IGJpbmRpbmdzIGhhcyBubyBiaW5kaW5nSWQgcHJvcGVydHksIGNhY2hlIGlzIG5vdCB1c2VkIik7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gYmluZGluZ0NhY2hlW2NhY2hlSWRdOwogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIHZhciBnZXR0ZXJzID0ge307CiAgICAgICAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGJpbmRpbmdOYW1lOyBiaW5kaW5nTmFtZSA9IGtleXNbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbYmluZGluZ05hbWVdOwogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgICAgIGlmIChnZXR0ZXIpIHsKICAgICAgICAgICAgICAgIGdldHRlcnNbYmluZGluZ05hbWVdID0gZ2V0dGVyOwogICAgICAgICAgICAgICAgbmFtZXMucHVzaChiaW5kaW5nTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZy5ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TGlzdCA9IFN0cmluZyhiaW5kaW5nLmV2ZW50cykudHJpbSgpLnNwbGl0KC9ccyt8XHMqLFxzKi8pOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudExpc3Rbal07IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudHNbZXZlbnROYW1lXSkgZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChiaW5kaW5nTmFtZSk7IGVsc2UgZXZlbnRzW2V2ZW50TmFtZV0gPSBbIGJpbmRpbmdOYW1lIF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgIG5hbWVzOiBuYW1lcywKICAgICAgICAgICAgICBzeW5jOiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycyksCiAgICAgICAgICAgICAgaGFuZGxlcjogbWFrZUhhbmRsZXIoZXZlbnRzLCBnZXR0ZXJzKQogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoY2FjaGVJZCkgYmluZGluZ0NhY2hlW2NhY2hlSWRdID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9iaiAmJiBzZXQpIHJlc3VsdC5zeW5jLmNhbGwoc2V0LCBvYmopOwogICAgICAgICAgaWYgKCFiaW5kaW5nSW50ZXJmYWNlKSByZXR1cm47CiAgICAgICAgICBpZiAocmVzdWx0LmhhbmRsZXIpIGJpbmRpbmdJbnRlcmZhY2UuYXR0YWNoKG9iaiwgcmVzdWx0LmhhbmRsZXIsIHNldCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LmhhbmRsZXI7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgdG9vbHMgPSB7CiAgICAgICAgYmluZF90ZXh0Tm9kZTogYmluZF90ZXh0Tm9kZSwKICAgICAgICBiaW5kX25vZGU6IGJpbmRfbm9kZSwKICAgICAgICBiaW5kX2VsZW1lbnQ6IGJpbmRfZWxlbWVudCwKICAgICAgICBiaW5kX2NvbW1lbnQ6IGJpbmRfY29tbWVudCwKICAgICAgICBiaW5kX2F0dHI6IGJpbmRfYXR0ciwKICAgICAgICBiaW5kX2F0dHJDbGFzczogYmluZF9hdHRyQ2xhc3MsCiAgICAgICAgYmluZF9hdHRyU3R5bGU6IGJpbmRfYXR0clN0eWxlLAogICAgICAgIHJlc29sdmU6IHJlc29sdmVWYWx1ZSwKICAgICAgICBsMTBuVG9rZW46IGwxMG5Ub2tlbiwKICAgICAgICBjcmVhdGVCaW5kaW5nRnVuY3Rpb246IGNyZWF0ZUJpbmRpbmdGdW5jdGlvbgogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24odG9rZW5zKSB7CiAgICAgICAgdmFyIGZuID0gZ2V0RnVuY3Rpb25zKHRva2VucywgdHJ1ZSwgdGhpcy5zb3VyY2UudXJsLCB0b2tlbnMuc291cmNlXywgIUNMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgICB2YXIgaW5zdGFuY2VzID0ge307CiAgICAgICAgdmFyIGwxMG5NYXAgPSB7fTsKICAgICAgICB2YXIgbDEwbkxpbmtzID0gW107CiAgICAgICAgdmFyIHNlZWQgPSAwOwogICAgICAgIHZhciBwcm90byA9IGJ1aWxkSHRtbCh0b2tlbnMpOwogICAgICAgIHZhciBpZCA9IHRoaXMudGVtcGxhdGVJZDsKICAgICAgICB0ZW1wbGF0ZXNbaWRdID0gewogICAgICAgICAgdGVtcGxhdGU6IHRoaXMsCiAgICAgICAgICBpbnN0YW5jZXM6IGluc3RhbmNlcwogICAgICAgIH07CiAgICAgICAgaWYgKGZuLmNyZWF0ZUwxMG5TeW5jKSB7CiAgICAgICAgICB2YXIgbDEwblByb3RvU3luYyA9IGZuLmNyZWF0ZUwxMG5TeW5jKHByb3RvLCBsMTBuTWFwLCBiaW5kX2F0dHIsIENMT05FX05PUk1BTElaQVRJT05fVEVYVF9CVUcpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gZm4ubDEwbktleXNbaV07IGkrKykgbDEwblByb3RvU3luYyhrZXksIGwxMG5Ub2tlbihrZXkpLnZhbHVlKTsKICAgICAgICAgIGlmIChmbi5sMTBuS2V5cykgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gZm4ubDEwbktleXNbaV07IGkrKykgewogICAgICAgICAgICB2YXIgbGluayA9IHsKICAgICAgICAgICAgICBwYXRoOiBrZXksCiAgICAgICAgICAgICAgdG9rZW46IGwxMG5Ub2tlbihrZXkpLAogICAgICAgICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBsMTBuUHJvdG9TeW5jKHRoaXMucGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlcykgaW5zdGFuY2VzW2tleV0udG1wbC5zZXQodGhpcy5wYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBsaW5rLnRva2VuLmF0dGFjaChsaW5rLmhhbmRsZXIsIGxpbmspOwogICAgICAgICAgICBsMTBuTGlua3MucHVzaChsaW5rKTsKICAgICAgICAgICAgbGluayA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNyZWF0ZUluc3RhbmNlID0gZm4uY3JlYXRlSW5zdGFuY2UoaWQsIGluc3RhbmNlcywgcHJvdG8sIHRvb2xzLCBsMTBuTWFwLCBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uKG9iaiwgb25BY3Rpb24sIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlSWQgPSBzZWVkKys7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKGluc3RhbmNlSWQsIG9iaiwgb25BY3Rpb24sIG9uUmVidWlsZCwgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICAgICAgICBpbnN0YW5jZXNbaW5zdGFuY2VJZF0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLnRtcGw7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveUluc3RhbmNlOiBmdW5jdGlvbih0bXBsKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkID0gdG1wbC50ZW1wbGF0ZUlkXzsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gaW5zdGFuY2VzW2luc3RhbmNlSWRdOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuaGFuZGxlcikgaW5zdGFuY2UuYmluZGluZ0ludGVyZmFjZS5kZXRhY2goaW5zdGFuY2UuY29udGV4dCwgaW5zdGFuY2UuaGFuZGxlciwgaW5zdGFuY2UudG1wbC5zZXQpOwogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZS5hdHRhY2hlcykgcmVzb2x2ZVZhbHVlLmNhbGwoaW5zdGFuY2UsIGtleSwgbnVsbCk7CiAgICAgICAgICAgICAgZGVsZXRlIGluc3RhbmNlc1tpbnN0YW5jZUlkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGtleXM6IGZuLmtleXMsCiAgICAgICAgICBpbnN0YW5jZXNfOiBpbnN0YW5jZXMsCiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihyZWJ1aWxkKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsaW5rOyBsaW5rID0gbDEwbkxpbmtzW2ldOyBpKyspIGxpbmsudG9rZW4uZGV0YWNoKGxpbmsuaGFuZGxlciwgbGluayk7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZXMpIHsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBpbnN0YW5jZXNba2V5XTsKICAgICAgICAgICAgICBpZiAocmVidWlsZCAmJiBpbnN0YW5jZS5yZWJ1aWxkKSBpbnN0YW5jZS5yZWJ1aWxkLmNhbGwoaW5zdGFuY2UuY29udGV4dCk7CiAgICAgICAgICAgICAgaWYgKCFyZWJ1aWxkIHx8IGtleSBpbiBpbnN0YW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5oYW5kbGVyKSBpbnN0YW5jZS5iaW5kaW5nSW50ZXJmYWNlLmRldGFjaChpbnN0YW5jZS5jb250ZXh0LCBpbnN0YW5jZS5oYW5kbGVyLCBpbnN0YW5jZS50bXBsLnNldCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UuYXR0YWNoZXMpIHJlc29sdmVWYWx1ZS5jYWxsKGtleSwgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZXNbaWRdICYmIHRlbXBsYXRlc1tpZF0uaW5zdGFuY2VzID09PSBpbnN0YW5jZXMpIGRlbGV0ZSB0ZW1wbGF0ZXNbaWRdOwogICAgICAgICAgICBmbiA9IG51bGw7CiAgICAgICAgICAgIHByb3RvID0gbnVsbDsKICAgICAgICAgICAgbDEwbk1hcCA9IG51bGw7CiAgICAgICAgICAgIGwxMG5MaW5rcyA9IG51bGw7CiAgICAgICAgICAgIGwxMG5Qcm90b1N5bmMgPSBudWxsOwogICAgICAgICAgICBpbnN0YW5jZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgSHRtbFRlbXBsYXRlID0gVGVtcGxhdGUuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGUiLAogICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEh0bWxUZW1wbGF0ZSkgcmV0dXJuIHZhbHVlOwogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlU3dpdGNoQ29uZmlnKSByZXR1cm4gbmV3IEh0bWxUZW1wbGF0ZVN3aXRjaGVyKHZhbHVlKTsKICAgICAgICByZXR1cm4gbmV3IEh0bWxUZW1wbGF0ZSh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGJ1aWxkZXI6IGJ1aWxkZXIKICAgIH0pOwogICAgdmFyIEh0bWxUZW1wbGF0ZVN3aXRjaGVyID0gVGVtcGxhdGVTd2l0Y2hlci5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZVN3aXRjaGVyIiwKICAgICAgdGVtcGxhdGVDbGFzczogSHRtbFRlbXBsYXRlCiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBUZW1wbGF0ZTogSHRtbFRlbXBsYXRlLAogICAgICBUZW1wbGF0ZVN3aXRjaGVyOiBIdG1sVGVtcGxhdGVTd2l0Y2hlcgogICAgfTsKICAgIGJhc2lzLnRlbXBsYXRlLmV4dGVuZCh7CiAgICAgIGdldERlYnVnSW5mb0J5SWQ6IGdldERlYnVnSW5mb0J5SWQsCiAgICAgIGJ1aWxkSHRtbDogYnVpbGRIdG1sLAogICAgICByZXNvbHZlVGVtcGxhdGVCeUlkOiByZXNvbHZlVGVtcGxhdGVCeUlkLAogICAgICByZXNvbHZlT2JqZWN0QnlJZDogcmVzb2x2ZU9iamVjdEJ5SWQsCiAgICAgIHJlc29sdmVUbXBsQnlJZDogcmVzb2x2ZVRtcGxCeUlkCiAgICB9KTsKICB9LAogICI5LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyICRudWxsID0gYmFzaXMuZm4uJG51bGw7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBXM0NTVVBQT1JUID0gISFkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyOwogICAgdmFyIEVWRU5UX0hPTERFUiA9ICJfX2Jhc2lzRXZlbnRzIjsKICAgIHZhciBLRVkgPSB7CiAgICAgIEJBQ0tTUEFDRTogOCwKICAgICAgVEFCOiA5LAogICAgICBDVFJMX0VOVEVSOiAxMCwKICAgICAgRU5URVI6IDEzLAogICAgICBTSElGVDogMTYsCiAgICAgIENUUkw6IDE3LAogICAgICBBTFQ6IDE4LAogICAgICBFU0M6IDI3LAogICAgICBFU0NBUEU6IDI3LAogICAgICBTUEFDRTogMzIsCiAgICAgIFBBR0VVUDogMzMsCiAgICAgIFBBR0VET1dOOiAzNCwKICAgICAgRU5EOiAzNSwKICAgICAgSE9NRTogMzYsCiAgICAgIExFRlQ6IDM3LAogICAgICBVUDogMzgsCiAgICAgIFJJR0hUOiAzOSwKICAgICAgRE9XTjogNDAsCiAgICAgIElOU0VSVDogNDUsCiAgICAgIERFTEVURTogNDYsCiAgICAgIEYxOiAxMTIsCiAgICAgIEYyOiAxMTMsCiAgICAgIEYzOiAxMTQsCiAgICAgIEY0OiAxMTUsCiAgICAgIEY1OiAxMTYsCiAgICAgIEY2OiAxMTcsCiAgICAgIEY3OiAxMTgsCiAgICAgIEY4OiAxMTksCiAgICAgIEY5OiAxMjAsCiAgICAgIEYxMDogMTIxLAogICAgICBGMTE6IDEyMiwKICAgICAgRjEyOiAxMjMKICAgIH07CiAgICB2YXIgTU9VU0VfTEVGVCA9IHsKICAgICAgVkFMVUU6IDEsCiAgICAgIEJJVDogMQogICAgfTsKICAgIHZhciBNT1VTRV9NSURETEUgPSB7CiAgICAgIFZBTFVFOiAyLAogICAgICBCSVQ6IDQKICAgIH07CiAgICB2YXIgTU9VU0VfUklHSFQgPSB7CiAgICAgIFZBTFVFOiAzLAogICAgICBCSVQ6IDIKICAgIH07CiAgICB2YXIgQlJPV1NFUl9FVkVOVFMgPSB7CiAgICAgIG1vdXNld2hlZWw6IFsgIm1vdXNld2hlZWwiLCAiRE9NTW91c2VTY3JvbGwiIF0KICAgIH07CiAgICBmdW5jdGlvbiBicm93c2VyRXZlbnRzKGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gQlJPV1NFUl9FVkVOVFNbZXZlbnROYW1lXSB8fCBbIGV2ZW50TmFtZSBdOwogICAgfQogICAgdmFyIEV2ZW50ID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXZlbnQiLAogICAgICBLRVk6IEtFWSwKICAgICAgaW5pdDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBldmVudCA9IHdyYXAoZXZlbnQpOwogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnQpIGlmIChuYW1lICE9ICJyZXR1cm5WYWx1ZSIgJiYgbmFtZSAhPSAia2V5TG9jYXRpb24iICYmIG5hbWUgIT0gImxheWVyWCIgJiYgbmFtZSAhPSAibGF5ZXJZIikgaWYgKHR5cGVvZiBldmVudFtuYW1lXSAhPSAiZnVuY3Rpb24iICYmIG5hbWUgaW4gdGhpcyA9PSBmYWxzZSkgdGhpc1tuYW1lXSA9IGV2ZW50W25hbWVdOwogICAgICAgIGJhc2lzLm9iamVjdC5leHRlbmQodGhpcywgewogICAgICAgICAgZXZlbnRfOiBldmVudCwKICAgICAgICAgIHNlbmRlcjogc2VuZGVyKGV2ZW50KSwKICAgICAgICAgIGtleToga2V5KGV2ZW50KSwKICAgICAgICAgIGNoYXJDb2RlOiBjaGFyQ29kZShldmVudCksCiAgICAgICAgICBtb3VzZUxlZnQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9MRUZUKSwKICAgICAgICAgIG1vdXNlTWlkZGxlOiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTUlERExFKSwKICAgICAgICAgIG1vdXNlUmlnaHQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9SSUdIVCksCiAgICAgICAgICBtb3VzZVg6IG1vdXNlWChldmVudCksCiAgICAgICAgICBtb3VzZVk6IG1vdXNlWShldmVudCksCiAgICAgICAgICB3aGVlbERlbHRhOiB3aGVlbERlbHRhKGV2ZW50KQogICAgICAgIH0pOwogICAgICB9LAogICAgICBzdG9wQnViYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgIGNhbmNlbEJ1YmJsZSh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgZGllOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3BCdWJibGUoKTsKICAgICAgICB0aGlzLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gd3JhcChldmVudCkgewogICAgICByZXR1cm4gZXZlbnQgaW5zdGFuY2VvZiBFdmVudCA/IGV2ZW50LmV2ZW50XyA6IGV2ZW50IHx8IGdsb2JhbC5ldmVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGUocmVmKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcmVmID09ICJzdHJpbmciID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVmKSA6IHJlZjsKICAgIH0KICAgIGZ1bmN0aW9uIHNlbmRlcihldmVudCkgewogICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgIHJldHVybiB0YXJnZXQubm9kZVR5cGUgPT0gMyA/IHRhcmdldC5wYXJlbnROb2RlIDogdGFyZ2V0OwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsQnViYmxlKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyBlbHNlIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBjYW5jZWxEZWZhdWx0KGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsgZWxzZSBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24ga2lsbChldmVudCwgbm9kZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKG5vZGUpIGFkZEhhbmRsZXIobm9kZSwgZXZlbnQsIGtpbGwpOyBlbHNlIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KGV2ZW50KTsKICAgICAgICBjYW5jZWxCdWJibGUoZXZlbnQpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBrZXkoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2ggfHwgMDsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYXJDb2RlKGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZUJ1dHRvbihldmVudCwgYnV0dG9uKSB7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggPT0gIm51bWJlciIpIHJldHVybiBldmVudC53aGljaCA9PSBidXR0b24uVkFMVUU7IGVsc2UgcmV0dXJuICEhKGV2ZW50LmJ1dHRvbiAmIGJ1dHRvbi5CSVQpOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VYKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOyBlbHNlIGlmICgicGFnZVgiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVg7IGVsc2UgcmV0dXJuICJjbGllbnRYIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFggKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCkgOiAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VZKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZOyBlbHNlIGlmICgicGFnZVkiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVk7IGVsc2UgcmV0dXJuICJjbGllbnRZIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFkgKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIDogZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIHdoZWVsRGVsdGEoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgaWYgKCJ3aGVlbERlbHRhIiBpbiBldmVudCkgZGVsdGEgPSBldmVudC53aGVlbERlbHRhOyBlbHNlIGlmIChldmVudC50eXBlID09ICJET01Nb3VzZVNjcm9sbCIpIGRlbHRhID0gLWV2ZW50LmRldGFpbDsKICAgICAgcmV0dXJuIGRlbHRhICYmIGRlbHRhIC8gTWF0aC5hYnMoZGVsdGEpOwogICAgfQogICAgdmFyIGdsb2JhbEhhbmRsZXJzID0ge307CiAgICB2YXIgY2FwdHVyZUhhbmRsZXJzID0ge307CiAgICB2YXIgbm9DYXB0dXJlU2NoZW1lID0gIVczQ1NVUFBPUlQ7CiAgICBmdW5jdGlvbiBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGFycmF5RnJvbShnbG9iYWxIYW5kbGVyc1tldmVudC50eXBlXSk7CiAgICAgIHZhciBjYXB0dXJlSGFuZGxlciA9IGNhcHR1cmVIYW5kbGVyc1tldmVudC50eXBlXTsKICAgICAgdmFyIHdyYXBwZWRFdmVudCA9IG5ldyBFdmVudChldmVudCk7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcikgewogICAgICAgIGNhcHR1cmVIYW5kbGVyLmhhbmRsZXIuY2FsbChjYXB0dXJlSGFuZGxlci50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIGtpbGwoZXZlbnQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gaGFuZGxlcnMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gaGFuZGxlcnNbaV07CiAgICAgICAgICBoYW5kbGVyT2JqZWN0LmhhbmRsZXIuY2FsbChoYW5kbGVyT2JqZWN0LnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjYXB0dXJlRXZlbnQoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcnNbZXZlbnRUeXBlXSkgcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSk7CiAgICAgIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgICAgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0gPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiByZWxlYXNlRXZlbnQoZXZlbnRUeXBlKSB7CiAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXJPYmplY3QuaGFuZGxlciwgaGFuZGxlck9iamVjdC50aGlzT2JqZWN0KTsKICAgICAgICBkZWxldGUgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lKSBhZGRIYW5kbGVyKGRvY3VtZW50LCBldmVudFR5cGUsICRudWxsKTsgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgb2JzZXJ2ZUdsb2JhbEV2ZW50cywgdHJ1ZSk7CiAgICAgICAgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdID0gW107CiAgICAgIH0KICAgICAgaGFuZGxlcnMucHVzaCh7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBoYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGlmICghaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgcmVtb3ZlSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEhhbmRsZXIobm9kZSwgZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICBpZiAoIW5vZGUpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBjYW4ndCBhdHRhY2ggZXZlbnQgbGlzdGVuZXIgdG8gdW5kZWZpbmVkIjsKICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9ICJmdW5jdGlvbiIpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBoYW5kbGVyIGlzIG5vdCBhIGZ1bmN0aW9uIjsKICAgICAgaWYgKCFub2RlW0VWRU5UX0hPTERFUl0pIG5vZGVbRVZFTlRfSE9MREVSXSA9IHt9OwogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IHsKICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgIHRoaXNPYmplY3Q6IHRoaXNPYmplY3QKICAgICAgfTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzKSB7CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdID0gWyBoYW5kbGVyT2JqZWN0IF07CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lICYmIGV2ZW50ICYmIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG9ic2VydmVHbG9iYWxFdmVudHMoZXZlbnQpOwogICAgICAgICAgICAgIGlmIChldmVudC5jYW5jZWxCdWJibGUgPT09IHRydWUpIHJldHVybjsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlID09ICJ1bmRlZmluZWQiKSBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaSsrXTsgKSBpdGVtLmhhbmRsZXIuY2FsbChpdGVtLnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfTsKICAgICAgICBpZiAoVzNDU1VQUE9SVCkgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5hdHRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgICBldmVudFR5cGVIYW5kbGVycy5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVycyhub2RlLCBoYW5kbGVycywgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlcnNbZXZlbnRUeXBlXSwgdGhpc09iamVjdCk7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBldmVudFR5cGVIYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGlmICghZXZlbnRUeXBlSGFuZGxlcnMubGVuZ3RoKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50VHlwZSAhPSAic3RyaW5nIikgewogICAgICAgICAgZm9yIChldmVudFR5cGUgaW4gaGFuZGxlcnMpIGNsZWFySGFuZGxlcnMobm9kZSwgZXZlbnRUeXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgICBpZiAobm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKSBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQsIGZhbHNlKTsgZWxzZSBub2RlLmRldGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmlyZUV2ZW50KG5vZGUsIGV2ZW50VHlwZSwgZXZlbnQpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzICYmIGhhbmRsZXJzW2V2ZW50VHlwZV0pIGhhbmRsZXJzW2V2ZW50VHlwZV0uZmlyZUV2ZW50KGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9uVW5sb2FkKGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgYWRkSGFuZGxlcihnbG9iYWwsICJ1bmxvYWQiLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgIH0KICAgIHZhciB0YWdOYW1lRXZlbnRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEV2ZW50SW5mbyhldmVudE5hbWUsIHRhZ05hbWUpIHsKICAgICAgaWYgKCF0YWdOYW1lKSB0YWdOYW1lID0gImRpdiI7CiAgICAgIHZhciBpZCA9IHRhZ05hbWUgKyAiLSIgKyBldmVudE5hbWU7CiAgICAgIGlmICh0YWdOYW1lRXZlbnRNYXBbaWRdKSByZXR1cm4gdGFnTmFtZUV2ZW50TWFwW2lkXTsgZWxzZSB7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIHZhciBidWJibGUgPSBmYWxzZTsKICAgICAgICBpZiAoIVczQ1NVUFBPUlQpIHsKICAgICAgICAgIHZhciBvbmV2ZW50ID0gIm9uIiArIGV2ZW50TmFtZTsKICAgICAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gaG9zdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpKTsKICAgICAgICAgIGhvc3Rbb25ldmVudF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYnViYmxlID0gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0YXJnZXQuZmlyZUV2ZW50KG9uZXZlbnQpOwogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF0gPSB7CiAgICAgICAgICBzdXBwb3J0ZWQ6IHN1cHBvcnRlZCwKICAgICAgICAgIGJ1YmJsZTogYnViYmxlCiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gd3JhcEV2ZW50RnVuY3Rpb24oZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKICAgICAgICByZXR1cm4gZm4od3JhcChldmVudCksIGFyZyk7CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgVzNDU1VQUE9SVDogVzNDU1VQUE9SVCwKICAgICAgYnJvd3NlckV2ZW50czogYnJvd3NlckV2ZW50cywKICAgICAgZ2V0RXZlbnRJbmZvOiBnZXRFdmVudEluZm8sCiAgICAgIEtFWTogS0VZLAogICAgICBNT1VTRV9MRUZUOiBNT1VTRV9MRUZULAogICAgICBNT1VTRV9SSUdIVDogTU9VU0VfUklHSFQsCiAgICAgIE1PVVNFX01JRERMRTogTU9VU0VfTUlERExFLAogICAgICBFdmVudDogRXZlbnQsCiAgICAgIHNlbmRlcjogd3JhcEV2ZW50RnVuY3Rpb24oc2VuZGVyKSwKICAgICAgY2FuY2VsQnViYmxlOiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxCdWJibGUpLAogICAgICBjYW5jZWxEZWZhdWx0OiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxEZWZhdWx0KSwKICAgICAga2lsbDogd3JhcEV2ZW50RnVuY3Rpb24oa2lsbCksCiAgICAgIGtleTogd3JhcEV2ZW50RnVuY3Rpb24oa2V5KSwKICAgICAgY2hhckNvZGU6IHdyYXBFdmVudEZ1bmN0aW9uKGNoYXJDb2RlKSwKICAgICAgbW91c2VCdXR0b246IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlQnV0dG9uKSwKICAgICAgbW91c2VYOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVgpLAogICAgICBtb3VzZVk6IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlWSksCiAgICAgIHdoZWVsRGVsdGE6IHdyYXBFdmVudEZ1bmN0aW9uKHdoZWVsRGVsdGEpLAogICAgICBhZGRHbG9iYWxIYW5kbGVyOiBhZGRHbG9iYWxIYW5kbGVyLAogICAgICByZW1vdmVHbG9iYWxIYW5kbGVyOiByZW1vdmVHbG9iYWxIYW5kbGVyLAogICAgICBjYXB0dXJlRXZlbnQ6IGNhcHR1cmVFdmVudCwKICAgICAgcmVsZWFzZUV2ZW50OiByZWxlYXNlRXZlbnQsCiAgICAgIGFkZEhhbmRsZXI6IGFkZEhhbmRsZXIsCiAgICAgIGFkZEhhbmRsZXJzOiBhZGRIYW5kbGVycywKICAgICAgcmVtb3ZlSGFuZGxlcjogcmVtb3ZlSGFuZGxlciwKICAgICAgY2xlYXJIYW5kbGVyczogY2xlYXJIYW5kbGVycywKICAgICAgZmlyZUV2ZW50OiBmaXJlRXZlbnQsCiAgICAgIG9uVW5sb2FkOiBvblVubG9hZCwKICAgICAgd3JhcDogd3JhcAogICAgfTsKICB9LAogICJhLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzcuanMiKTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX0FUVFJTOwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9DSElMRFM7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgdG1wbEZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIGlubGluZVNlZWQgPSAxOwogICAgdmFyIGJ1aWxkUGF0aGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBQQVRIX1JFRl9OQU1FID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiLnNwbGl0KCIiKTsKICAgICAgdmFyIHBhdGhMaXN0OwogICAgICB2YXIgcmVmTGlzdDsKICAgICAgdmFyIGJpbmRpbmdMaXN0OwogICAgICB2YXIgbWFya2VkRWxlbWVudExpc3Q7CiAgICAgIHZhciByb290UGF0aDsKICAgICAgZnVuY3Rpb24gcHV0UmVmcyhyZWZzLCBwYXRoSWR4KSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHJlZk5hbWU7IHJlZk5hbWUgPSByZWZzW2ldOyBpKyspIGlmIChyZWZOYW1lLmluZGV4T2YoIjoiKSA9PSAtMSkgcmVmTGlzdC5wdXNoKHJlZk5hbWUgKyAiOiIgKyBwYXRoSWR4KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwdXRQYXRoKHBhdGgpIHsKICAgICAgICB2YXIgbGVuID0gcGF0aExpc3QubGVuZ3RoOwogICAgICAgIHZhciBwYXRoUmVmID0gUEFUSF9SRUZfTkFNRVtsZW5dIHx8ICJyIiArIGxlbjsKICAgICAgICBwYXRoTGlzdC5wdXNoKHBhdGhSZWYgKyAiPSIgKyBwYXRoKTsKICAgICAgICByZXR1cm4gcGF0aFJlZjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwdXRCaW5kaW5nKGJpbmRpbmcpIHsKICAgICAgICBiaW5kaW5nTGlzdC5wdXNoKGJpbmRpbmcpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3NUb2tlbnModG9rZW5zLCBwYXRoLCBub1RleHRCdWcpIHsKICAgICAgICB2YXIgbG9jYWxQYXRoOwogICAgICAgIHZhciByZWZzOwogICAgICAgIHZhciBteVJlZjsKICAgICAgICB2YXIgZXhwbGljaXRSZWY7CiAgICAgICAgdmFyIGJpbmRpbmdzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjcCA9IDAsIGNsb3NlVGV4dCA9IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrLCBjcCsrLCBleHBsaWNpdFJlZiA9IGZhbHNlKSB7CiAgICAgICAgICBpZiAoIWkpIGxvY2FsUGF0aCA9IHBhdGggKyAiLmZpcnN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgaWYgKCF0b2tlbnNbaSArIDFdKSBsb2NhbFBhdGggPSBwYXRoICsgIi5sYXN0Q2hpbGQiOyBlbHNlIHsKICAgICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gdG9rZW5zW2kgLSAxXVtUT0tFTl9UWVBFXSAmJiB0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX1RFWFQpIGNsb3NlVGV4dCsrOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHBhdGggKyAiLmNoaWxkTm9kZXNbIiArIChub1RleHRCdWcgPyBjcCA6IGNwICsgKGNsb3NlVGV4dCA/ICIgKyAiICsgY2xvc2VUZXh0ICsgIiAqIFRFWFRfQlVHIiA6ICIiKSkgKyAiXSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWZzID0gdG9rZW5bVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIHB1dFJlZnMocmVmcywgbG9jYWxQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiB0eXBlb2YgdG9rZW5bVE9LRU5fQklORElOR1NdID09ICJudW1iZXIiKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gPSB0b2tlbltUT0tFTl9SRUZTXVt0b2tlbltUT0tFTl9CSU5ESU5HU10gLSAxXTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHV0QmluZGluZyhbIHRva2VuW1RPS0VOX1RZUEVdLCBsb2NhbFBhdGgsIHRva2VuW1RPS0VOX0JJTkRJTkdTXSBdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0VMRU1FTlQpIHsKICAgICAgICAgICAgbXlSZWYgPSAtMTsKICAgICAgICAgICAgaWYgKHBhdGggPT0gcm9vdFBhdGgpIG1hcmtlZEVsZW1lbnRMaXN0LnB1c2gobG9jYWxQYXRoICsgIi5iYXNpc1RlbXBsYXRlSWQiKTsKICAgICAgICAgICAgaWYgKCFleHBsaWNpdFJlZikgewogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgICBteVJlZiA9IHBhdGhMaXN0Lmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXR0cnMgPSBbXTsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSBFTEVNRU5UX0FUVFJTLCB0OyB0ID0gdG9rZW5bal07IGorKykgaWYgKHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UIHx8IHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9URVhUIHx8IHRbVE9LRU5fVFlQRV0gPT0gVFlQRV9DT01NRU5UKSBjaGlsZHJlbi5wdXNoKHQpOyBlbHNlIGF0dHJzLnB1c2godCk7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBhdHRyOyBhdHRyID0gYXR0cnNbal07IGorKykgewogICAgICAgICAgICAgIGlmIChhdHRyW1RPS0VOX1RZUEVdID09IDYpIGNvbnRpbnVlOwogICAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IEFUVFJfTkFNRV9CWV9UWVBFW2F0dHJbVE9LRU5fVFlQRV1dIHx8IGF0dHJbQVRUUl9OQU1FXTsKICAgICAgICAgICAgICBpZiAocmVmcyA9IGF0dHJbVE9LRU5fUkVGU10pIHsKICAgICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHB1dFJlZnMocmVmcywgcHV0UGF0aChsb2NhbFBhdGggKyAnLmdldEF0dHJpYnV0ZU5vZGUoIicgKyBhdHRyTmFtZSArICciKScpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzID0gYXR0cltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgICAgIGV4cGxpY2l0UmVmID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3Nba107IGsrKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZGluZ1sxXSwgYXR0ck5hbWUsIGJpbmRpbmdbMF0gXS5jb25jYXQoYmluZGluZy5zbGljZSgyKSkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIHByb3BlcnR5OyBwcm9wZXJ0eSA9IGJpbmRpbmdzW2tdOyBrKyspIGZvciAodmFyIG0gPSAwLCBiaW5kTmFtZTsgYmluZE5hbWUgPSBwcm9wZXJ0eVswXVttXTsgbSsrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kTmFtZSwgYXR0ck5hbWUsIHByb3BlcnR5WzBdLCBwcm9wZXJ0eVsxXSwgcHJvcGVydHlbMl0gXSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmROYW1lOyBiaW5kTmFtZSA9IGJpbmRpbmdzWzBdW2tdOyBrKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmROYW1lLCBhdHRyTmFtZSwgYmluZGluZ3NbMF0sIGJpbmRpbmdzWzFdLCB0b2tlbltFTEVNRU5UX05BTUVdIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSBwcm9jZXNzVG9rZW5zKGNoaWxkcmVuLCBsb2NhbFBhdGgsIG5vVGV4dEJ1Zyk7CiAgICAgICAgICAgIGlmICghZXhwbGljaXRSZWYgJiYgbXlSZWYgPT0gcGF0aExpc3QubGVuZ3RoKSBwYXRoTGlzdC5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VucywgcGF0aCwgbm9UZXh0QnVnKSB7CiAgICAgICAgcGF0aExpc3QgPSBbXTsKICAgICAgICByZWZMaXN0ID0gW107CiAgICAgICAgYmluZGluZ0xpc3QgPSBbXTsKICAgICAgICBtYXJrZWRFbGVtZW50TGlzdCA9IFtdOwogICAgICAgIHJvb3RQYXRoID0gcGF0aCB8fCAiXyI7CiAgICAgICAgcHJvY2Vzc1Rva2Vucyh0b2tlbnMsIHJvb3RQYXRoLCBub1RleHRCdWcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXRoOiBwYXRoTGlzdCwKICAgICAgICAgIHJlZjogcmVmTGlzdCwKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdMaXN0LAogICAgICAgICAgbWFya2VkRWxlbWVudExpc3Q6IG1hcmtlZEVsZW1lbnRMaXN0CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBidWlsZEJpbmRpbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBMMTBOX0JJTkRJTkcgPSAvXC5ceyhbYS16QS1aX11bYS16QS1aMC05X1wtXSopXH0vOwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX01BUCA9IHsKICAgICAgICBkaXNhYmxlZDogIioiLAogICAgICAgIGNoZWNrZWQ6IFsgImlucHV0IiBdLAogICAgICAgIHZhbHVlOiBbICJpbnB1dCIsICJ0ZXh0YXJlYSIgXSwKICAgICAgICBtaW5sZW5ndGg6IFsgImlucHV0IiBdLAogICAgICAgIG1heGxlbmd0aDogWyAiaW5wdXQiIF0sCiAgICAgICAgcmVhZG9ubHk6IFsgImlucHV0IiBdLAogICAgICAgIHNlbGVjdGVkOiBbICJvcHRpb24iIF0sCiAgICAgICAgbXVsdGlwbGU6IFsgInNlbGVjdCIgXQogICAgICB9OwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX1NJTkdMRSA9IHsKICAgICAgICBkaXNhYmxlZDogdHJ1ZSwKICAgICAgICBjaGVja2VkOiB0cnVlLAogICAgICAgIHNlbGVjdGVkOiB0cnVlLAogICAgICAgIHJlYWRvbmx5OiB0cnVlLAogICAgICAgIG11bHRpcGxlOiB0cnVlCiAgICAgIH07CiAgICAgIHZhciBiaW5kRnVuY3Rpb25zID0gewogICAgICAgIDE6ICJiaW5kX2VsZW1lbnQiLAogICAgICAgIDM6ICJiaW5kX3RleHROb2RlIiwKICAgICAgICA4OiAiYmluZF9jb21tZW50IgogICAgICB9OwogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIHNwZWNpYWwsIGwxMG4pIHsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBzeW1ib2xzID0gYmluZGluZ1s1XTsKICAgICAgICB2YXIgZGljdGlvbmFyeSA9IGJpbmRpbmdbNF07CiAgICAgICAgdmFyIGV4cHJWYXI7CiAgICAgICAgdmFyIGNvbG9uUG9zOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3ltYm9scy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHR5cGVvZiBzeW1ib2xzW2pdID09ICJzdHJpbmciKSBleHByZXNzaW9uLnB1c2goJyInICsgc3ltYm9sc1tqXS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJyk7IGVsc2UgewogICAgICAgICAgICBleHByVmFyID0gZGljdGlvbmFyeVtzeW1ib2xzW2pdXTsKICAgICAgICAgICAgY29sb25Qb3MgPSBleHByVmFyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKGNvbG9uUG9zID09IC0xKSB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbi5wdXNoKHNwZWNpYWwgPT0gImwxMG4iID8gJyJ7JyArIGV4cHJWYXIgKyAnfSInIDogc3BlY2lhbCA9PSAiYm9vbCIgPyAiKF9fIiArIGV4cHJWYXIgKyAnfHwiIiknIDogIl9fIiArIGV4cHJWYXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGwxMG5QYXRoID0gZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKS5yZXBsYWNlKEwxME5fQklORElORywgZnVuY3Rpb24obSwgbmFtZSkgewogICAgICAgICAgICAgICAgYmluZGluZ05hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChiaW5kaW5nTmFtZSkgZXhwcmVzc2lvbi5wdXNoKGwxMG5bZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKV0pOyBlbHNlIGV4cHJlc3Npb24ucHVzaCgnX19sMTBuWyInICsgbDEwblBhdGggKyAnIl0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZXhwcmVzc2lvbi5sZW5ndGggPT0gMSkgZXhwcmVzc2lvbi5wdXNoKCciIicpOwogICAgICAgIHJldHVybiBleHByZXNzaW9uLmpvaW4oIisiKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oYmluZGluZ3MpIHsKICAgICAgICBmdW5jdGlvbiBwdXRCaW5kQ29kZSh0eXBlKSB7CiAgICAgICAgICB0b29sc1VzZWRbdHlwZV0gPSB0cnVlOwogICAgICAgICAgYmluZENvZGUucHVzaChiaW5kVmFyICsgIj0iICsgdHlwZSArICIoIiArIGJhc2lzLmFycmF5KGFyZ3VtZW50cywgMSkgKyAiKTsiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGJpbmRNYXAgPSB7fTsKICAgICAgICB2YXIgYmluZENvZGU7CiAgICAgICAgdmFyIGJpbmRWYXI7CiAgICAgICAgdmFyIHZhckxpc3QgPSBbXTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHZhck5hbWU7CiAgICAgICAgdmFyIGwxMG5NYXA7CiAgICAgICAgdmFyIGwxMG5Db21wdXRlID0gW107CiAgICAgICAgdmFyIGwxMG5CaW5kaW5ncyA9IHt9OwogICAgICAgIHZhciBsMTBuQmluZFNlZWQgPSAxOwogICAgICAgIHZhciB0b29sc1VzZWQgPSB7CiAgICAgICAgICByZXNvbHZlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbEF0dHI7CiAgICAgICAgdmFyIGRlYnVnTGlzdCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3NbaV07IGkrKykgewogICAgICAgICAgdmFyIGJpbmRUeXBlID0gYmluZGluZ1swXTsKICAgICAgICAgIHZhciBkb21SZWYgPSBiaW5kaW5nWzFdOwogICAgICAgICAgdmFyIGJpbmROYW1lID0gYmluZGluZ1syXTsKICAgICAgICAgIGlmIChbICJnZXQiLCAic2V0IiwgInRlbXBsYXRlSWRfIiBdLmluZGV4T2YoYmluZE5hbWUpICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiaW5kaW5nIG5hbWUgYCIgKyBiaW5kTmFtZSArICJgIGlzIHByb2hpYml0ZWQsIGJpbmRpbmcgaWdub3JlZCIpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lUGFydCA9IGJpbmROYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICB2YXIgYW5pbSA9IG5hbWVQYXJ0WzBdID09ICJhbmltIjsKICAgICAgICAgIGlmIChhbmltKSBiaW5kTmFtZSA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgIGlmIChuYW1lUGFydFswXSA9PSAibDEwbiIgJiYgbmFtZVBhcnRbMV0pIHsKICAgICAgICAgICAgdmFyIGwxMG5GdWxsUGF0aCA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbDEwbk5hbWUgPSBsMTBuRnVsbFBhdGgucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICBsMTBuQmluZGluZyA9IG5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGwxMG5CaW5kaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGwxMG5GdWxsUGF0aCBpbiBsMTBuQmluZGluZ3MgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhck5hbWUgPSAiJGwxMG5fIiArIGwxMG5CaW5kU2VlZCsrOwogICAgICAgICAgICAgICAgbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF0gPSB2YXJOYW1lOwogICAgICAgICAgICAgICAgbDEwbkNvbXB1dGUucHVzaCgnc2V0KCInICsgdmFyTmFtZSArICciLCcgKyB2YXJOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lICsgJz10b29scy5sMTBuVG9rZW4oIicgKyBsMTBuTmFtZSArICciKS5jb21wdXRlVG9rZW4oKScpOwogICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXTsKICAgICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXSA9IFtdOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goIl9fIiArIGwxMG5CaW5kaW5nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2godmFyTmFtZSArICIuc2V0KF9fIiArIGwxMG5CaW5kaW5nICsgIik7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJpbmROYW1lID0gbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF07CiAgICAgICAgICAgICAgYmluZFZhciA9ICJfIiArIGk7CiAgICAgICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdOwogICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIGJpbmRWYXIsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGJpbmRWYXIsICJ2YWx1ZSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9ICciJyArIGJpbmRpbmdbQVRUUl9OQU1FXSArICciJzsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgImF0dHI6IiArIGF0dHJOYW1lLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhcik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCBhdHRyTmFtZSwgYmluZFZhciwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbDEwbk1hcCkgbDEwbk1hcCA9IHt9OwogICAgICAgICAgICBpZiAoIWJpbmRNYXBbbDEwbk5hbWVdKSB7CiAgICAgICAgICAgICAgYmluZE1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuTmFtZV07CiAgICAgICAgICAgIGJpbmRDb2RlLmwxMG4gPSB0cnVlOwogICAgICAgICAgICBpZiAoYmluZFR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGwxMG5GdWxsUGF0aCArICciJywgImRvbToiICsgZG9tUmVmLCAndmFsOl9fbDEwblsiJyArIGwxMG5OYW1lICsgJyJdJywgJ2F0dGFjaG1lbnQ6bDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIiknIF0gKyAifSIpOwogICAgICAgICAgICAgIHRvb2xzVXNlZC5sMTBuVG9rZW4gPSB0cnVlOwogICAgICAgICAgICAgIGwxMG5NYXBbbDEwbk5hbWVdLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAnLm5vZGVWYWx1ZT1fX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScgKyAobDEwbkJpbmRpbmcgPyAiW19fIiArIGwxMG5CaW5kaW5nICsgIl0iIDogIiIpICsgIjsiKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKCJiaW5kX2F0dHIoIiArIFsgZG9tUmVmLCAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIicsICJOYU4iLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSBdICsgIik7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXSA9IFtdOwogICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmluZFR5cGUgIT0gVFlQRV9BVFRSSUJVVEUpIHsKICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIChiaW5kQ29kZS5ub2RlQmluZCA/IHZhck5hbWUgOiBiaW5kVmFyKSwgInVwZGF0ZXM6JCQiICsgYmluZE5hbWUsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgaWYgKCFiaW5kQ29kZS5ub2RlQmluZCkgewogICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICBiaW5kQ29kZS5ub2RlQmluZCA9IGJpbmRWYXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3dpdGNoIChiaW5kVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGRvbVJlZiwgInZhbHVlIT09bnVsbD9TdHJpbmcodmFsdWUpOm51bGwiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAiLm5vZGVWYWx1ZT12YWx1ZTsiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBiaW5kaW5nW0FUVFJfTkFNRV07CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAnYXR0cjoiJyArIGF0dHJOYW1lICsgJyInLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdEV4cHIgPSAiIjsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUV4cHIgPSAidmFsdWUiOwogICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IGJpbmRpbmdbNF07CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0xlbmd0aCA9IGJpbmRpbmcubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPj0gNikgewogICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0xlbmd0aCA9PSA2IHx8IHR5cGVvZiBiaW5kaW5nWzZdID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIic7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s1XSkgZGVmYXVsdEV4cHIgPSBwcmVmaXggKyBiaW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndmFsdWU/IicgKyBiaW5kaW5nWzZdICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s2XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFiaW5kaW5nWzZdLmxlbmd0aCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNykgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigifHwiKSArICc/dmFsdWU6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZGluZ1s2XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd2YWx1ZT09IicgKyB2YWwgKyAnIj8iJyArIHRoaXNbaWR4XSArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdbN10pLmpvaW4oIjoiKSArICc6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s3XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndHlwZW9mIHZhbHVlPT0ic3RyaW5nInx8dHlwZW9mIHZhbHVlPT0ibnVtYmVyIj92YWx1ZToodmFsdWU/IicgKyBiaW5kTmFtZSArICciOiIiKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICc9IicgKyBkZWZhdWx0RXhwciArICciJyk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyQ2xhc3MiLCBkb21SZWYsIGJpbmRWYXIsIHZhbHVlRXhwciwgJyInICsgcHJlZml4ICsgJyInLCBhbmltKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgJz0iIicpOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0clN0eWxlIiwgZG9tUmVmLCAnIicgKyBiaW5kaW5nWzZdICsgJyInLCBiaW5kVmFyLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIGZhbHNlLCBsMTBuQmluZGluZ3MpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0ciA9IFNQRUNJQUxfQVRUUl9NQVBbYXR0ck5hbWVdOwogICAgICAgICAgICAgICAgdmFyTGlzdC5wdXNoKGJpbmRWYXIgKyAiPSIgKyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCAnIicgKyBhdHRyTmFtZSArICciJywgYmluZFZhciwgc3BlY2lhbEF0dHIgJiYgU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJib29sIiwgbDEwbkJpbmRpbmdzKSArICc/IicgKyBhdHRyTmFtZSArICciOiIiJyA6IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxBdHRyICYmIChzcGVjaWFsQXR0ciA9PSAiKiIgfHwgc3BlY2lhbEF0dHIuaW5kZXhPZihiaW5kaW5nWzZdLnRvTG93ZXJDYXNlKCkpICE9IC0xKSkgYmluZENvZGUucHVzaCgiaWYoIiArIGRvbVJlZiArICIuIiArIGF0dHJOYW1lICsgIiE9IiArIGJpbmRWYXIgKyAiKSIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICI9IiArIChTUEVDSUFMX0FUVFJfU0lOR0xFW2F0dHJOYW1lXSA/ICIhISIgKyBiaW5kVmFyIDogYmluZFZhcikgKyAiOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCI7ZnVuY3Rpb24gc2V0KGJpbmROYW1lLHZhbHVlKXsiICsgJ2lmKHR5cGVvZiBiaW5kTmFtZSE9InN0cmluZyIpJyk7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgaWYgKGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgiaWYoYmluZE5hbWU9PT0iICsgYmluZE1hcFtiaW5kTmFtZV0ubm9kZUJpbmQgKyAiKSIgKyAnYmluZE5hbWU9IicgKyBiaW5kTmFtZSArICciOycgKyAiZWxzZSAiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goInJldHVybjsiKTsKICAgICAgICByZXN1bHQucHVzaCgidmFsdWU9cmVzb2x2ZS5jYWxsKGluc3RhbmNlLGJpbmROYW1lLHZhbHVlLEF0dGFjaGVzKTsiICsgInN3aXRjaChiaW5kTmFtZSl7Iik7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgewogICAgICAgICAgaWYgKGJpbmROYW1lLmluZGV4T2YoIkAiKSA9PSAtMSkgdmFyTGlzdC5wdXNoKCIkJCIgKyBiaW5kTmFtZSArICI9MCIpOwogICAgICAgICAgcmVzdWx0LnB1c2goJ2Nhc2UiJyArIGJpbmROYW1lICsgJyI6JyArIChiaW5kTWFwW2JpbmROYW1lXS5sMTBuID8gYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgOiAiaWYoX18iICsgYmluZE5hbWUgKyAiIT09dmFsdWUpIiArICJ7IiArICIkJCIgKyBiaW5kTmFtZSArICIrKzsiICsgIl9fIiArIGJpbmROYW1lICsgIj12YWx1ZTsiICsgYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgKyAifSIpICsgImJyZWFrOyIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgifX0iKTsKICAgICAgICB2YXIgdG9vbHNWYXJMaXN0ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRvb2xzVXNlZCkgdG9vbHNWYXJMaXN0LnB1c2goa2V5ICsgIj10b29scy4iICsga2V5KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVidWdMaXN0OiBkZWJ1Z0xpc3QsCiAgICAgICAgICBrZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kTWFwKS5maWx0ZXIoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkuaW5kZXhPZigiQCIpID09IC0xOwogICAgICAgICAgfSksCiAgICAgICAgICB0b29sczogdG9vbHNWYXJMaXN0LAogICAgICAgICAgdmFyczogdmFyTGlzdCwKICAgICAgICAgIHNldDogcmVzdWx0LmpvaW4oIiIpLAogICAgICAgICAgbDEwbjogbDEwbk1hcCwKICAgICAgICAgIGwxMG5Db21wdXRlOiBsMTBuQ29tcHV0ZQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjb21waWxlRnVuY3Rpb24oYXJncywgYm9keSkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBiYXNpcy5kZXYuZXJyb3IoIkNhbid0IGJ1aWxkIHRlbXBsYXRlIGZ1bmN0aW9uOiAiICsgZSArICJcbiIsICJmdW5jdGlvbigiICsgYXJncyArICIpe1xuIiArIGJvZHkgKyAiXG59Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBnZXRGdW5jdGlvbnMgPSBmdW5jdGlvbih0b2tlbnMsIGRlYnVnLCB1cmksIHNvdXJjZSwgbm9UZXh0QnVnKSB7CiAgICAgIHZhciBmbiA9IHRtcGxGdW5jdGlvbnNbdXJpICYmIGJhc2lzLnBhdGgucmVsYXRpdmUodXJpKV07CiAgICAgIGlmIChmbikgcmV0dXJuIGZuOwogICAgICB2YXIgcGF0aHMgPSBidWlsZFBhdGhlcyh0b2tlbnMsICJfIiwgbm9UZXh0QnVnKTsKICAgICAgdmFyIGJpbmRpbmdzID0gYnVpbGRCaW5kaW5ncyhwYXRocy5iaW5kaW5nKTsKICAgICAgdmFyIG9iamVjdFJlZnMgPSBwYXRocy5tYXJrZWRFbGVtZW50TGlzdC5qb2luKCI9Iik7CiAgICAgIHZhciBjcmVhdGVJbnN0YW5jZTsKICAgICAgdmFyIGZuQm9keTsKICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICBrZXlzOiBiaW5kaW5ncy5rZXlzLAogICAgICAgIGwxMG5LZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kaW5ncy5sMTBuKQogICAgICB9OwogICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PSAxKSBwYXRocy5wYXRoWzBdID0gImE9XyI7CiAgICAgIGlmICghdXJpKSB1cmkgPSBiYXNpcy5wYXRoLmJhc2VVUkkgKyAiaW5saW5lX3RlbXBsYXRlIiArIGlubGluZVNlZWQrKyArICIudG1wbCI7CiAgICAgIGlmIChiaW5kaW5ncy5sMTBuKSB7CiAgICAgICAgdmFyIGNvZGUgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYmluZGluZ3MubDEwbikgY29kZS5wdXNoKCdjYXNlIicgKyBrZXkgKyAnIjonICsgJ2lmKHZhbHVlPT1udWxsKXZhbHVlPSJ7JyArIGtleSArICd9IjsnICsgIl9fbDEwblt0b2tlbl09dmFsdWU7IiArIGJpbmRpbmdzLmwxMG5ba2V5XS5qb2luKCIiKSArICJicmVhazsiKTsKICAgICAgICByZXN1bHQuY3JlYXRlTDEwblN5bmMgPSBjb21waWxlRnVuY3Rpb24oWyAiXyIsICJfX2wxMG4iLCAiYmluZF9hdHRyIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciAiICsgcGF0aHMucGF0aCArICI7IiArICJyZXR1cm4gZnVuY3Rpb24odG9rZW4sIHZhbHVlKXsiICsgInN3aXRjaCh0b2tlbil7IiArIGNvZGUuam9pbigiIikgKyAifSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpICsgIl9sMTBuIik7CiAgICAgIH0KICAgICAgcmVzdWx0LmNyZWF0ZUluc3RhbmNlID0gY29tcGlsZUZ1bmN0aW9uKFsgInRpZCIsICJtYXAiLCAicHJvdG8iLCAidG9vbHMiLCAiX19sMTBuIiwgIlRFWFRfQlVHIiBdLCAoc291cmNlID8gIlxuLy8gIiArIHNvdXJjZS5zcGxpdCgvXHJcbj98XG5ccj8vKS5qb2luKCJcbi8vICIpICsgIlxuXG4iIDogIiIpICsgInZhciBnZXRCaW5kaW5ncz10b29scy5jcmVhdGVCaW5kaW5nRnVuY3Rpb24oWyIgKyBiaW5kaW5ncy5rZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gJyInICsga2V5ICsgJyInOwogICAgICB9KSArICJdKSwiICsgKGJpbmRpbmdzLnRvb2xzLmxlbmd0aCA/IGJpbmRpbmdzLnRvb2xzICsgIiwiIDogIiIpICsgIkF0dGFjaGVzPWZ1bmN0aW9uKCl7fTsiICsgIkF0dGFjaGVzLnByb3RvdHlwZT17IiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBrZXkgKyAiOm51bGwiOwogICAgICB9KSArICJ9OyIgKyAicmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlXyhpZCxvYmosb25BY3Rpb24sb25SZWJ1aWxkLGJpbmRpbmdzLGJpbmRpbmdJbnRlcmZhY2UpeyIgKyAidmFyIF89cHJvdG8uY2xvbmVOb2RlKHRydWUpLCIgKyBwYXRocy5wYXRoLmNvbmNhdChiaW5kaW5ncy52YXJzKSArICIsIiArICJpbnN0YW5jZT17IiArICJjb250ZXh0Om9iaiwiICsgImFjdGlvbjpvbkFjdGlvbiwiICsgInJlYnVpbGQ6b25SZWJ1aWxkLCIgKyAoZGVidWcgPyAiZGVidWc6ZnVuY3Rpb24gZGVidWcoKXtyZXR1cm5bIiArIGJpbmRpbmdzLmRlYnVnTGlzdCArICJdfSwiIDogIiIpICsgImhhbmRsZXI6bnVsbCwiICsgImJpbmRpbmdzOmJpbmRpbmdzLCIgKyAiYmluZGluZ0ludGVyZmFjZTpiaW5kaW5nSW50ZXJmYWNlLCIgKyAiYXR0YWNoZXM6bnVsbCwiICsgInRtcGw6eyIgKyBbIHBhdGhzLnJlZiwgInRlbXBsYXRlSWRfOmlkIiwgInNldDpzZXQiIF0gKyAifSIgKyAifSIgKyAob2JqZWN0UmVmcyA/ICI7aWYob2JqfHxvbkFjdGlvbikiICsgb2JqZWN0UmVmcyArICI9KGlkPDwxMil8dGlkIiA6ICIiKSArIGJpbmRpbmdzLnNldCArICI7aWYoYmluZGluZ3MpaW5zdGFuY2UuaGFuZGxlcj1nZXRCaW5kaW5ncyhiaW5kaW5ncyxvYmosc2V0LGJpbmRpbmdJbnRlcmZhY2UpIiArICI7IiArIGJpbmRpbmdzLmwxMG5Db21wdXRlICsgIjtyZXR1cm4gaW5zdGFuY2UiICsgIn0iICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBiYXNpcy5wYXRoLm9yaWdpbiArIHVyaSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldEZ1bmN0aW9uczogZ2V0RnVuY3Rpb25zCiAgICB9OwogIH0sCiAgImouanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBFbnZDbGFzczsKICAgIGlmIChkb2N1bWVudCkgRW52Q2xhc3MgPSBiYXNpcy5yZXNvdXJjZSgiLi9xLmpzIikuZmV0Y2goKTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGZ1bmN0aW9uKGluaXQsIGh0bWwpIHsKICAgICAgICByZXR1cm4gbmV3IEVudkNsYXNzKHsKICAgICAgICAgIGluaXRFbnY6IGluaXQsCiAgICAgICAgICBodG1sOiBodG1sCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfQp9OwoKKGZ1bmN0aW9uKGdsb2JhbCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgVkVSU0lPTiA9ICIxLjIuMiI7CiAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogIHZhciBPYmplY3RfdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzb3VyY2UpIHsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGNvbXBsZXRlKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgaWYgKGtleSBpbiBkZXN0ID09IGZhbHNlKSBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiBkZXN0OwogIH0KICBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2goa2V5KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKG9iamVjdFtrZXldKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNwbGljZShzb3VyY2UsIGtleXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmICgha2V5cykgcmV0dXJuIGV4dGVuZChyZXN1bHQsIHNvdXJjZSk7CiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107ICkgaWYgKGtleSBpbiBzb3VyY2UpIHsKICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgZGVsZXRlIHNvdXJjZVtrZXldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gbWVyZ2UoKSB7CiAgICByZXR1cm4gYXJyYXlGcm9tKGFyZ3VtZW50cykucmVkdWNlKGV4dGVuZCwge30pOwogIH0KICBmdW5jdGlvbiBpdGVyYXRlKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHJlc3VsdC5wdXNoKGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwga2V5LCBvYmplY3Rba2V5XSkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gJHVuZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGRlZmluZWQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc051bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzTm90TnVsbCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgdmFsdWUgIT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNTYW1lKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHRoaXM7CiAgfQogIGZ1bmN0aW9uICRpc05vdFNhbWUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPT0gdGhpczsKICB9CiAgZnVuY3Rpb24gJHNlbGYodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gJGNvbnN0KHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgfQogIGZ1bmN0aW9uICRmYWxzZSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gJHRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gJG51bGwoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gJHVuZGVmKCkge30KICB2YXIgZ2V0dGVyID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kaWZpY2F0b3JTZWVkID0gMTsKICAgIHZhciBzaW1wbGVQYXRoID0gL15bYS16JF9dW2EteiRfMC05XSooXC5bYS16JF9dW2EteiRfMC05XSopKiQvaTsKICAgIHZhciBnZXR0ZXJNYXAgPSBbXTsKICAgIHZhciBwYXRoQ2FjaGUgPSB7fTsKICAgIHZhciBtb2RDYWNoZSA9IHt9OwogICAgZnVuY3Rpb24gYnVpbGRGdW5jdGlvbihwYXRoKSB7CiAgICAgIGlmIChzaW1wbGVQYXRoLnRlc3QocGF0aCkpIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgICAgICAgdmFyIGZvbyA9IHBhcnRzWzBdOwogICAgICAgIHZhciBiYXIgPSBwYXJ0c1sxXTsKICAgICAgICB2YXIgYmF6ID0gcGFydHNbMl07CiAgICAgICAgdmFyIGZuOwogICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0W2Zvb10gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl1bYmF6XSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIGlmIChvYmplY3QgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2Zvb11bYmFyXVtiYXpdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDMsIGtleTsga2V5ID0gcGFydHNbaV07IGkrKykgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZuID0gRnVuY3Rpb24oInBhcnRzIiwgInJldHVybiAiICsgZm4udG9TdHJpbmcoKS5yZXBsYWNlKC8oZm9vfGJhcnxiYXopL2csIGZ1bmN0aW9uKG0sIHcpIHsKICAgICAgICAgIHJldHVybiAnIicgKyBwYXJ0c1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgICAgfSkucmVwbGFjZSgvXFtcIihbXiJdKylcIlxdL2csICIuJDEiKSkocGFydHMpOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJvYmplY3QiLCAicmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0LiIgKyBwYXRoICsgIiA6IG9iamVjdCIpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHBhdGgsIG1vZGlmaWNhdG9yKSB7CiAgICAgIHZhciBmdW5jOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgZ2V0dGVySWQ7CiAgICAgIGlmICghcGF0aCB8fCBwYXRoID09PSBudWxsR2V0dGVyKSByZXR1cm4gbnVsbEdldHRlcjsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBnZXR0ZXJJZCA9IHBhdGguYmFzaXNHZXR0ZXJJZF87CiAgICAgICAgaWYgKGdldHRlcklkKSB7CiAgICAgICAgICBmdW5jID0gZ2V0dGVyTWFwW01hdGguYWJzKGdldHRlcklkKSAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoKG9iamVjdCk7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBwYXRoLmJhc2lzR2V0dGVySWRfID0gLWdldHRlcklkOwogICAgICAgICAgZnVuYy5iYXNpc0dldHRlcklkXyA9IGdldHRlcklkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmdW5jID0gcGF0aENhY2hlW3BhdGhdOwogICAgICAgIGlmIChmdW5jKSB7CiAgICAgICAgICBnZXR0ZXJJZCA9IGZ1bmMuYmFzaXNHZXR0ZXJJZF87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZ1bmMgPSBidWlsZEZ1bmN0aW9uKHBhdGgpOwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBmdW5jLmJhc2lzR2V0dGVySWRfID0gZ2V0dGVySWQ7CiAgICAgICAgICBwYXRoQ2FjaGVbcGF0aF0gPSBmdW5jOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgbW9kVHlwZSA9IG1vZGlmaWNhdG9yICE9IG51bGwgJiYgdHlwZW9mIG1vZGlmaWNhdG9yOwogICAgICBpZiAoIW1vZFR5cGUpIHJldHVybiBmdW5jOwogICAgICB2YXIgbW9kTGlzdCA9IG1vZENhY2hlW2dldHRlcklkXTsKICAgICAgdmFyIG1vZElkOwogICAgICBpZiAobW9kVHlwZSA9PSAic3RyaW5nIikgbW9kSWQgPSBtb2RUeXBlICsgbW9kaWZpY2F0b3I7IGVsc2UgaWYgKG1vZFR5cGUgPT0gImZ1bmN0aW9uIikgbW9kSWQgPSBtb2RpZmljYXRvci5iYXNpc01vZElkXzsgZWxzZSBpZiAobW9kVHlwZSAhPSAib2JqZWN0IikgewogICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLmdldHRlcjogd3JvbmcgbW9kaWZpY2F0b3IgdHlwZSwgbW9kaWZpY2F0b3Igbm90IHVzZWQsIHBhdGg6ICIsIHBhdGgsICIsIG1vZGlmaWNhdG9yOiIsIG1vZGlmaWNhdG9yKTsKICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgfQogICAgICBpZiAobW9kSWQgJiYgbW9kTGlzdCAmJiBtb2RMaXN0W21vZElkXSkgcmV0dXJuIG1vZExpc3RbbW9kSWRdOwogICAgICBpZiAodHlwZW9mIGZ1bmMuYmFzZSA9PSAiZnVuY3Rpb24iKSBmdW5jID0gZnVuYy5iYXNlOwogICAgICBzd2l0Y2ggKG1vZFR5cGUpIHsKICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmdfZXh0ZW5zaW9ucy5mb3JtYXQobW9kaWZpY2F0b3IsIGZ1bmMob2JqZWN0KSk7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgaWYgKCFtb2RJZCkgewogICAgICAgICAgICBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvclNlZWQrKzsKICAgICAgICAgICAgbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF8gPSBtb2RJZDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3IoZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcltmdW5jKG9iamVjdCldOwogICAgICAgICAgfTsKICAgICAgfQogICAgICByZXN1bHQuYmFzZSA9IGZ1bmMuYmFzZSB8fCBmdW5jOwogICAgICByZXN1bHQuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgaWYgKG1vZElkKSB7CiAgICAgICAgaWYgKCFtb2RMaXN0KSB7CiAgICAgICAgICBtb2RMaXN0ID0ge307CiAgICAgICAgICBtb2RDYWNoZVtnZXR0ZXJJZF0gPSBtb2RMaXN0OwogICAgICAgIH0KICAgICAgICBtb2RMaXN0W21vZElkXSA9IHJlc3VsdDsKICAgICAgICByZXN1bHQubW9kID0gbW9kaWZpY2F0b3I7CiAgICAgICAgcmVzdWx0LmJhc2lzR2V0dGVySWRfID0gZ2V0dGVyTWFwLnB1c2gocmVzdWx0KTsKICAgICAgfSBlbHNlIHt9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0oKTsKICB2YXIgbnVsbEdldHRlciA9IGV4dGVuZChmdW5jdGlvbigpIHt9LCB7CiAgICBfX2V4dGVuZF9fOiBnZXR0ZXIKICB9KTsKICBmdW5jdGlvbiB3cmFwcGVyKGtleSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGxhenlJbml0KGluaXQsIHRoaXNPYmplY3QpIHsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGluaXRlZCsrKSkgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhID0gaW5pdC5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICJ1bmRlZmluZWQiKSBjb25zb2xlTWV0aG9kcy53YXJuKCJsYXp5SW5pdCBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4iICsgaW5pdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KICBmdW5jdGlvbiBsYXp5SW5pdEFuZFJ1bihpbml0LCBydW4sIHRoaXNPYmplY3QpIHsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGluaXRlZCsrKSkgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhID0gaW5pdC5jYWxsKHRoaXNPYmplY3QgfHwgdGhpcyk7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICJ1bmRlZmluZWQiKSBjb25zb2xlTWV0aG9kcy53YXJuKCJsYXp5SW5pdEFuZFJ1biBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4iICsgaW5pdCk7CiAgICAgIH0KICAgICAgcnVuLmFwcGx5KGRhdGEsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CiAgZnVuY3Rpb24gcnVuT25jZShydW4sIHRoaXNPYmplY3QpIHsKICAgIHZhciBmaXJlZCA9IDA7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKGZpcmVkKyspKSByZXR1cm4gcnVuLmFwcGx5KHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQogIHZhciBjb25zb2xlTWV0aG9kcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGxvZzogJHVuZGVmLAogICAgICBpbmZvOiAkdW5kZWYsCiAgICAgIHdhcm46ICR1bmRlZiwKICAgICAgZXJyb3I6ICR1bmRlZgogICAgfTsKICAgIGlmICh0eXBlb2YgY29uc29sZSAhPSAidW5kZWZpbmVkIikgaXRlcmF0ZShtZXRob2RzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgIG1ldGhvZHNbbWV0aG9kTmFtZV0gPSAiYmluZCIgaW4gRnVuY3Rpb24ucHJvdG90eXBlICYmIHR5cGVvZiBjb25zb2xlW21ldGhvZE5hbWVdID09ICJmdW5jdGlvbiIgPyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUpIDogZnVuY3Rpb24oKSB7CiAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVttZXRob2ROYW1lXSwgY29uc29sZSwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIG1ldGhvZHM7CiAgfSgpOwogIHZhciBzZXRJbW1lZGlhdGUgPSBnbG9iYWwuc2V0SW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKICB2YXIgY2xlYXJJbW1lZGlhdGUgPSBnbG9iYWwuY2xlYXJJbW1lZGlhdGUgfHwgZ2xvYmFsLm1zU2V0SW1tZWRpYXRlOwogIGlmIChzZXRJbW1lZGlhdGUpIHNldEltbWVkaWF0ZSA9IHNldEltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CiAgaWYgKGNsZWFySW1tZWRpYXRlKSBjbGVhckltbWVkaWF0ZSA9IGNsZWFySW1tZWRpYXRlLmJpbmQoZ2xvYmFsKTsKICBpZiAoIXNldEltbWVkaWF0ZSkgKGZ1bmN0aW9uKCkgewogICAgdmFyIE1FU1NBR0VfTkFNRSA9ICJiYXNpc2pzLnNldEltbWVkaWF0ZSI7CiAgICB2YXIgcnVuVGFzayA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFza0J5SWQgPSB7fTsKICAgICAgdmFyIHRhc2tJZCA9IDE7CiAgICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRhc2tCeUlkWysrdGFza0lkXSA9IHsKICAgICAgICAgIGZuOiBhcmd1bWVudHNbMF0sCiAgICAgICAgICBhcmdzOiBhcnJheUZyb20oYXJndW1lbnRzLCAxKQogICAgICAgIH07CiAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgIHJldHVybiB0YXNrSWQ7CiAgICAgIH07CiAgICAgIGNsZWFySW1tZWRpYXRlID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oaWQpIHsKICAgICAgICB2YXIgdGFzayA9IHRhc2tCeUlkW2lkXTsKICAgICAgICBpZiAodGFzaykgewogICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICAgIGlmICh0eXBlb2YgdGFzay5mbiA9PSAiZnVuY3Rpb24iKSB0YXNrLmZuLmFwcGx5KHVuZGVmaW5lZCwgdGFzay5hcmdzKTsgZWxzZSB7CiAgICAgICAgICAgIChnbG9iYWwuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgIGdsb2JhbFsiZXZhbCJdLmNhbGwoZ2xvYmFsLCBmbik7CiAgICAgICAgICAgIH0pKFN0cmluZyh0YXNrLmZuKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSgpOwogICAgdmFyIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgIH0sIDApOwogICAgfTsKICAgIGlmIChnbG9iYWwucHJvY2VzcyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgaWYgKGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCkgewogICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IGdsb2JhbC5NZXNzYWdlQ2hhbm5lbDsKICAgICAgICAgIHZhciBzZXRJbW1lZGlhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgIH07CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHNldEltbWVkaWF0ZUhhbmRsZXI7CiAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKCIiKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGdsb2JhbC5wb3N0TWVzc2FnZSAmJiAhZ2xvYmFsLmltcG9ydFNjcmlwdHM7CiAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKSB7CiAgICAgICAgICB2YXIgb2xkT25NZXNzYWdlID0gZ2xvYmFsLm9ubWVzc2FnZTsKICAgICAgICAgIGdsb2JhbC5vbm1lc3NhZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9zdE1lc3NhZ2VTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoIiIsICIqIik7CiAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gb2xkT25NZXNzYWdlOwogICAgICAgIH0KICAgICAgICBpZiAocG9zdE1lc3NhZ2VTdXBwb3J0ZWQpIHsKICAgICAgICAgIHZhciBzZXRJbW1lZGlhdGVIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnNvdXJjZSA9PSBnbG9iYWwpIHsKICAgICAgICAgICAgICB2YXIgdGFza0lkID0gU3RyaW5nKGV2ZW50LmRhdGEpLnNwbGl0KE1FU1NBR0VfTkFNRSlbMV07CiAgICAgICAgICAgICAgaWYgKHRhc2tJZCkgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIHNldEltbWVkaWF0ZUhhbmRsZXIsIHRydWUpOyBlbHNlIGdsb2JhbC5hdHRhY2hFdmVudCgib25tZXNzYWdlIiwgc2V0SW1tZWRpYXRlSGFuZGxlcik7CiAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICAgIGdsb2JhbC5wb3N0TWVzc2FnZShNRVNTQUdFX05BTUUgKyB0YXNrSWQsICIqIik7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY3JlYXRlU2NyaXB0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoZG9jdW1lbnQgJiYgIm9ucmVhZHlzdGF0ZWNoYW5nZSIgaW4gY3JlYXRlU2NyaXB0KCkpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRBZGRUb1F1ZXVlID0gYWRkVG9RdWV1ZTsKICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uIGJlZm9yZUhlYWRSZWFkeSh0YXNrSWQpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50SW50ZXJmYWNlICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZGVmYXVsdEFkZFRvUXVldWU7CiAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNjcmlwdEVsID0gY3JlYXRlU2NyaXB0KCk7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYWRkVG9RdWV1ZSA9PT0gYmVmb3JlSGVhZFJlYWR5KSBkZWZhdWx0QWRkVG9RdWV1ZSh0YXNrSWQpOyBlbHNlIGFkZFRvUXVldWUodGFza0lkKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KSgpOwogIHZhciBOT0RFX0VOViA9IHR5cGVvZiBwcm9jZXNzID09ICJvYmplY3QiICYmIE9iamVjdF90b1N0cmluZy5jYWxsKHByb2Nlc3MpID09ICJbb2JqZWN0IHByb2Nlc3NdIjsKICB2YXIgcGF0aFV0aWxzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgQUJTT0xVVEVfUlggPSAvXihbXlwvXSs6fFwvKS87CiAgICB2YXIgUFJPVE9DT0xfUlggPSAvXlthLXpBLVowLTlcLV0rOlwvPy87CiAgICB2YXIgT1JJR0lOX1JYID0gL14oPzpbYS16QS1aMC05XC1dKzopP1wvXC9bXlwvXStcLz8vOwogICAgdmFyIFNFQVJDSF9IQVNIX1JYID0gL1tcPyNdLiokLzsKICAgIHZhciB1dGlscyA9IHt9OwogICAgdmFyIG9yaWdpbiA9ICIiOwogICAgdmFyIGJhc2VVUkk7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIHBhdGggPSByZXF1aXJlKCJwYXRoIikucmVzb2x2ZSgiLiIpLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgIGJhc2VVUkkgPSBwYXRoLnJlcGxhY2UoL15bXlwvXSovLCAiIik7CiAgICAgIG9yaWdpbiA9IHBhdGgucmVwbGFjZSgvXC8uKi8sICIiKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVUkkgPSBsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSskLywgIiIpOwogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0OwogICAgfQogICAgdXRpbHMgPSB7CiAgICAgIGJhc2VVUkk6IGJhc2VVUkksCiAgICAgIG9yaWdpbjogb3JpZ2luLAogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICBwYXRoID0gKHBhdGggfHwgIiIpLnJlcGxhY2UoUFJPVE9DT0xfUlgsICIvIikucmVwbGFjZShPUklHSU5fUlgsICIvIikucmVwbGFjZShTRUFSQ0hfSEFTSF9SWCwgIiIpOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHBhcnRzW2ldID09ICIuLiIpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxIHx8IHJlc3VsdFswXSkgcmVzdWx0LnBvcCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChwYXJ0c1tpXSB8fCAhaSkgJiYgcGFydHNbaV0gIT0gIi4iKSByZXN1bHQucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQuam9pbigiLyIpIHx8IChwYXRoWzBdID09PSAiLyIgPyAiLyIgOiAiIik7CiAgICAgIH0sCiAgICAgIGRpcm5hbWU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdXRpbHMubm9ybWFsaXplKHBhdGgpOwogICAgICAgIHJldHVybiByZXN1bHQucmVwbGFjZSgvXC8oW15cL10qKSR8XlteXC9dKyQvLCAiIikgfHwgKHJlc3VsdFswXSA9PSAiLyIgPyAiLyIgOiAiLiIpOwogICAgICB9LAogICAgICBleHRuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIGV4dCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cL10oXC5bXlwvXC5dKikkLyk7CiAgICAgICAgcmV0dXJuIGV4dCA/IGV4dFsxXSA6ICIiOwogICAgICB9LAogICAgICBiYXNlbmFtZTogZnVuY3Rpb24ocGF0aCwgZXh0KSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gdXRpbHMubm9ybWFsaXplKHBhdGgpLm1hdGNoKC9bXlxcXC9dKiQvKTsKICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lID8gZmlsZW5hbWVbMF0gOiAiIjsKICAgICAgICBpZiAoZXh0ID09IHV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygwLCBmaWxlbmFtZS5sZW5ndGggLSBleHQubGVuZ3RoKTsKICAgICAgICByZXR1cm4gZmlsZW5hbWU7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcnJheUZyb20oYXJndW1lbnRzKS5yZXZlcnNlKCk7CiAgICAgICAgdmFyIHBhdGggPSBbXTsKICAgICAgICB2YXIgYWJzb2x1dGVGb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGkgPSAwOyAhYWJzb2x1dGVGb3VuZCAmJiBpIDwgYXJncy5sZW5ndGg7IGkrKykgaWYgKHR5cGVvZiBhcmdzW2ldID09ICJzdHJpbmciKSB7CiAgICAgICAgICBwYXRoLnVuc2hpZnQoYXJnc1tpXSk7CiAgICAgICAgICBhYnNvbHV0ZUZvdW5kID0gQUJTT0xVVEVfUlgudGVzdChhcmdzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhYnNvbHV0ZUZvdW5kKSBwYXRoLnVuc2hpZnQoYmFzZVVSSSA9PSAiLyIgPyAiIiA6IGJhc2VVUkkpOwogICAgICAgIHJldHVybiB1dGlscy5ub3JtYWxpemUocGF0aC5qb2luKCIvIikpOwogICAgICB9LAogICAgICByZWxhdGl2ZTogZnVuY3Rpb24oZnJvbSwgdG8pIHsKICAgICAgICBpZiAodHlwZW9mIHRvICE9ICJzdHJpbmciKSB7CiAgICAgICAgICB0byA9IGZyb207CiAgICAgICAgICBmcm9tID0gYmFzZVVSSTsKICAgICAgICB9CiAgICAgICAgZnJvbSA9IHV0aWxzLm5vcm1hbGl6ZShmcm9tKTsKICAgICAgICB0byA9IHV0aWxzLm5vcm1hbGl6ZSh0byk7CiAgICAgICAgaWYgKGZyb21bMF0gPT0gIi8iICYmIHRvWzBdICE9ICIvIikgcmV0dXJuIGZyb207CiAgICAgICAgaWYgKHRvWzBdID09ICIvIiAmJiBmcm9tWzBdICE9ICIvIikgcmV0dXJuIHRvOwogICAgICAgIHZhciBiYXNlID0gZnJvbS5yZXBsYWNlKC9eXC8kLywgIiIpLnNwbGl0KC9cLy8pOwogICAgICAgIHZhciBwYXRoID0gdG8ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIHdoaWxlIChwYXRoW2ldID09IGJhc2VbaV0gJiYgdHlwZW9mIGJhc2VbaV0gPT0gInN0cmluZyIpIGkrKzsKICAgICAgICBmb3IgKHZhciBqID0gYmFzZS5sZW5ndGggLSBpOyBqID4gMDsgai0tKSByZXN1bHQucHVzaCgiLi4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChwYXRoLnNsaWNlKGkpLmZpbHRlcihCb29sZWFuKSkuam9pbigiLyIpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHV0aWxzOwogIH0oKTsKICB2YXIgYmFzaXNGaWxlbmFtZSA9ICIiOwogIHZhciBjb25maWcgPSB7CiAgICBwYXRoOiB7CiAgICAgIGJhc2lzOiAiIiwKICAgICAgYXBwOiAiIiwKICAgICAgY29yZTogIiIsCiAgICAgIGVzcHJpbWE6ICIiLAogICAgICBkaWZmOiAiIgogICAgfSwKICAgIGV4dFByb3RvOiBmYWxzZSwKICAgIGV4cG9ydHM6IHRydWUsCiAgICBhdXRvbG9hZDogIi4vMC5qcyIKICB9OwogIHZhciBDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlU2VlZCA9IHsKICAgICAgaWQ6IDEKICAgIH07CiAgICB2YXIgY2xhc3NTZWVkID0gMTsKICAgIHZhciBjbGFzc2VzID0gW107CiAgICB2YXIgU0VMRiA9IHt9OwogICAgZnVuY3Rpb24gaXNDbGFzcyhvYmplY3QpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT0gImZ1bmN0aW9uIiAmJiAhIW9iamVjdC5iYXNpc0NsYXNzSWRfOwogICAgfQogICAgZnVuY3Rpb24gaXNTdWJjbGFzc09mKHN1cGVyQ2xhc3MpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgJiYgY3Vyc29yICE9PSBzdXBlckNsYXNzKSBjdXJzb3IgPSBjdXJzb3Iuc3VwZXJDbGFzc187CiAgICAgIHJldHVybiBjdXJzb3IgPT09IHN1cGVyQ2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBkZXZfdmVyYm9zZU5hbWVXcmFwKG5hbWUsIGFyZ3MsIGZuKSB7CiAgICAgIHJldHVybiAobmV3IEZ1bmN0aW9uKGtleXMoYXJncyksICdyZXR1cm4geyInICsgbmFtZSArICciOiAnICsgZm4gKyAnXG59WyInICsgbmFtZSArICciXScpKS5hcHBseShudWxsLCB2YWx1ZXMoYXJncykpOwogICAgfQogICAgdmFyIFRPU1RSSU5HX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gewogICAgICAgIHRvU3RyaW5nOiAxCiAgICAgIH0pIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjcmVhdGVDbGFzcyhTdXBlckNsYXNzLCBleHRlbnNpb25zKSB7CiAgICAgIHZhciBjbGFzc0lkID0gY2xhc3NTZWVkKys7CiAgICAgIGlmICh0eXBlb2YgU3VwZXJDbGFzcyAhPSAiZnVuY3Rpb24iKSBTdXBlckNsYXNzID0gQmFzZUNsYXNzOwogICAgICB2YXIgY2xhc3NOYW1lID0gIiI7CiAgICAgIGZvciAodmFyIGkgPSAxLCBleHRlbnNpb247IGV4dGVuc2lvbiA9IGFyZ3VtZW50c1tpXTsgaSsrKSBpZiAodHlwZW9mIGV4dGVuc2lvbiAhPSAiZnVuY3Rpb24iICYmIGV4dGVuc2lvbi5jbGFzc05hbWUpIGNsYXNzTmFtZSA9IGV4dGVuc2lvbi5jbGFzc05hbWU7CiAgICAgIGlmICghY2xhc3NOYW1lKSBjbGFzc05hbWUgPSBTdXBlckNsYXNzLmNsYXNzTmFtZSArICIuX0NsYXNzIiArIGNsYXNzSWQ7CiAgICAgIHZhciBOZXdDbGFzc1Byb3RvID0gZnVuY3Rpb24oKSB7fTsKICAgICAgTmV3Q2xhc3NQcm90byA9IGRldl92ZXJib3NlTmFtZVdyYXAoY2xhc3NOYW1lLCB7fSwgTmV3Q2xhc3NQcm90byk7CiAgICAgIE5ld0NsYXNzUHJvdG8ucHJvdG90eXBlID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CiAgICAgIHZhciBuZXdQcm90byA9IG5ldyBOZXdDbGFzc1Byb3RvOwogICAgICB2YXIgbmV3Q2xhc3NQcm9wcyA9IHsKICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZSwKICAgICAgICBiYXNpc0NsYXNzSWRfOiBjbGFzc0lkLAogICAgICAgIHN1cGVyQ2xhc3NfOiBTdXBlckNsYXNzLAogICAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogISFTdXBlckNsYXNzLmV4dGVuZENvbnN0cnVjdG9yXywKICAgICAgICBpc1N1YmNsYXNzT2Y6IGlzU3ViY2xhc3NPZiwKICAgICAgICBzdWJjbGFzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3MuYXBwbHkobnVsbCwgWyBuZXdDbGFzcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSkpOwogICAgICAgIH0sCiAgICAgICAgZXh0ZW5kOiBleHRlbmRDbGFzcywKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSBTRUxGICYmICh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3ModmFsdWUpKSkgcmV0dXJuIEJhc2VDbGFzcy5jcmVhdGUuY2FsbChudWxsLCBuZXdDbGFzcywgdmFsdWUpOyBlbHNlIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIHByb3RvdHlwZTogbmV3UHJvdG8KICAgICAgfTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspIG5ld0NsYXNzUHJvcHMuZXh0ZW5kKGV4dGVuc2lvbik7CiAgICAgIGlmIChuZXdQcm90by5pbml0ICE9PSBCYXNlQ2xhc3MucHJvdG90eXBlLmluaXQgJiYgIS9eZnVuY3Rpb25bXihdKlwoXCkvLnRlc3QobmV3UHJvdG8uaW5pdCkgJiYgbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8pIGNvbnNvbGVNZXRob2RzLndhcm4oInByb2JhYmx5IHdyb25nIGV4dGVuZENvbnN0cnVjdG9yXyB2YWx1ZSBmb3IgIiArIG5ld0NsYXNzUHJvcHMuY2xhc3NOYW1lKTsKICAgICAgdmFyIG5ld0NsYXNzID0gbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8gPyBmdW5jdGlvbihleHRlbmQpIHsKICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKICAgICAgICB2YXIgcHJvcDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5kKSB7CiAgICAgICAgICBwcm9wID0gdGhpc1trZXldOwogICAgICAgICAgdGhpc1trZXldID0gcHJvcCAmJiBwcm9wLl9fZXh0ZW5kX18gPyBwcm9wLl9fZXh0ZW5kX18oZXh0ZW5kW2tleV0pIDogZXh0ZW5kW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdCgpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgfTsKICAgICAgbmV3Q2xhc3MgPSBkZXZfdmVyYm9zZU5hbWVXcmFwKGNsYXNzTmFtZSwgewogICAgICAgIGluc3RhbmNlU2VlZDogaW5zdGFuY2VTZWVkCiAgICAgIH0sIG5ld0NsYXNzKTsKICAgICAgbmV3UHJvdG8uY29uc3RydWN0b3IgPSBuZXdDbGFzczsKICAgICAgZm9yICh2YXIga2V5IGluIG5ld1Byb3RvKSBpZiAobmV3UHJvdG9ba2V5XSA9PT0gU0VMRikgbmV3UHJvdG9ba2V5XSA9IG5ld0NsYXNzOwogICAgICBleHRlbmQobmV3Q2xhc3MsIG5ld0NsYXNzUHJvcHMpOwogICAgICBjbGFzc2VzLnB1c2gobmV3Q2xhc3MpOwogICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRDbGFzcyhzb3VyY2UpIHsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3Moc291cmNlKSkgc291cmNlID0gc291cmNlKHRoaXMuc3VwZXJDbGFzc18ucHJvdG90eXBlKTsKICAgICAgaWYgKHNvdXJjZS5wcm90b3R5cGUpIHNvdXJjZSA9IHNvdXJjZS5wcm90b3R5cGU7CiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB2YXIgcHJvdG9WYWx1ZSA9IHByb3RvW2tleV07CiAgICAgICAgaWYgKGtleSA9PSAiY2xhc3NOYW1lIiB8fCBrZXkgPT0gImV4dGVuZENvbnN0cnVjdG9yXyIpIHRoaXNba2V5XSA9IHZhbHVlOyBlbHNlIHsKICAgICAgICAgIGlmIChwcm90b1ZhbHVlICYmIHByb3RvVmFsdWUuX19leHRlbmRfXykgcHJvdG9ba2V5XSA9IHByb3RvVmFsdWUuX19leHRlbmRfXyh2YWx1ZSk7IGVsc2UgewogICAgICAgICAgICBwcm90b1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChUT1NUUklOR19CVUcgJiYgc291cmNlW2tleSA9ICJ0b1N0cmluZyJdICE9PSBPYmplY3RfdG9TdHJpbmcpIHByb3RvW2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB2YXIgQmFzZUNsYXNzID0gZXh0ZW5kKGNyZWF0ZUNsYXNzLCB7CiAgICAgIGNsYXNzTmFtZTogImJhc2lzLkNsYXNzIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiBmYWxzZSwKICAgICAgcHJvdG90eXBlOiB7CiAgICAgICAgYmFzaXNPYmplY3RJZDogMCwKICAgICAgICBjb25zdHJ1Y3RvcjogbnVsbCwKICAgICAgICBpbml0OiBmdW5jdGlvbigpIHt9LAogICAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHt9LAogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAiW29iamVjdCAiICsgKHRoaXMuY29uc3RydWN0b3IgfHwgdGhpcykuY2xhc3NOYW1lICsgIl0iOwogICAgICAgIH0sCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3ApKSB0aGlzW3Byb3BdID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVzdHJveSA9ICR1bmRlZjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGN1c3RvbUV4dGVuZFByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uLCBmbiwgZGV2TmFtZSkgewogICAgICByZXR1cm4gewogICAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICAgICAgaWYgKCFleHRlbnNpb24pIHJldHVybiBleHRlbnNpb247CiAgICAgICAgICBpZiAoZXh0ZW5zaW9uICYmIGV4dGVuc2lvbi5fX2V4dGVuZF9fKSByZXR1cm4gZXh0ZW5zaW9uOwogICAgICAgICAgdmFyIEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICAgICAgICAgQmFzZSA9IGRldl92ZXJib3NlTmFtZVdyYXAoZGV2TmFtZSB8fCAiY3VzdG9tRXh0ZW5kUHJvcGVydHkiLCB7fSwgQmFzZSk7CiAgICAgICAgICBCYXNlLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEJhc2U7CiAgICAgICAgICBmbihyZXN1bHQsIGV4dGVuc2lvbik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfS5fX2V4dGVuZF9fKGV4dGVuc2lvbiB8fCB7fSk7CiAgICB9OwogICAgdmFyIGV4dGVuc2libGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBleHRlbmQsICJleHRlbnNpYmxlUHJvcGVydHkiKTsKICAgIH07CiAgICB2YXIgbmVzdGVkRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgcmV0dXJuIGN1c3RvbUV4dGVuZFByb3BlcnR5KGV4dGVuc2lvbiwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbnNpb24pIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5zaW9uKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSByZXN1bHRba2V5XTsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUgJiYgdmFsdWUuX19leHRlbmRfXyA/IHZhbHVlLl9fZXh0ZW5kX18oZXh0ZW5zaW9uW2tleV0pIDogZXh0ZW5zaWJsZVByb3BlcnR5KGV4dGVuc2lvbltrZXldKTsKICAgICAgICB9CiAgICAgIH0sICJuZXN0ZWRFeHRlbmRQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBvbmVGdW5jdGlvblByb3BlcnR5ID0gZnVuY3Rpb24oZm4sIGtleXMpIHsKICAgICAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKGtleXMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlCiAgICAgICAgfTsKICAgICAgICBpZiAoa2V5cykgewogICAgICAgICAgaWYgKGtleXMuX19leHRlbmRfXykgcmV0dXJuIGtleXM7CiAgICAgICAgICB2YXIgQ2xzID0gZGV2X3ZlcmJvc2VOYW1lV3JhcCgib25lRnVuY3Rpb25Qcm9wZXJ0eSIsIHt9LCBmdW5jdGlvbigpIHt9KTsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDbHM7CiAgICAgICAgICByZXN1bHQuX19leHRlbmRfXyA9IGNyZWF0ZTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSBpZiAoa2V5c1trZXldKSByZXN1bHRba2V5XSA9IGZuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlKGtleXMgfHwge30pOwogICAgfTsKICAgIHJldHVybiBleHRlbmQoQmFzZUNsYXNzLCB7CiAgICAgIGFsbF86IGNsYXNzZXMsCiAgICAgIFNFTEY6IFNFTEYsCiAgICAgIGNyZWF0ZTogY3JlYXRlQ2xhc3MsCiAgICAgIGlzQ2xhc3M6IGlzQ2xhc3MsCiAgICAgIGN1c3RvbUV4dGVuZFByb3BlcnR5OiBjdXN0b21FeHRlbmRQcm9wZXJ0eSwKICAgICAgZXh0ZW5zaWJsZVByb3BlcnR5OiBleHRlbnNpYmxlUHJvcGVydHksCiAgICAgIG5lc3RlZEV4dGVuZFByb3BlcnR5OiBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSwKICAgICAgb25lRnVuY3Rpb25Qcm9wZXJ0eTogb25lRnVuY3Rpb25Qcm9wZXJ0eQogICAgfSk7CiAgfSgpOwogIHZhciBUb2tlbiA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLlRva2VuIiwKICAgIHZhbHVlOiBudWxsLAogICAgaGFuZGxlcjogbnVsbCwKICAgIGRlZmVycmVkVG9rZW46IG51bGwsCiAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmRldGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgIHJldHVybiBob3N0LmdldCgpOwogICAgICB9CiAgICB9LAogICAgaW5pdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgfQogICAgfSwKICAgIGF0dGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2F0dGFjaDogZHVwbGljYXRlIGZuICYgY29udGV4dCBwYWlyIik7CiAgICAgIHRoaXMuaGFuZGxlciA9IHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgfTsKICAgIH0sCiAgICBkZXRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB2YXIgcHJldjsKICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBpZiAoY3Vyc29yLmZuID09PSBmbiAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgIGN1cnNvci5mbiA9ICR1bmRlZjsKICAgICAgICBwcmV2LmhhbmRsZXIgPSBjdXJzb3IuaGFuZGxlcjsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuVG9rZW4jZGV0YWNoOiBmbiAmIGNvbnRleHQgcGFpciBub3QgZm91bmQsIG5vdGhpbmcgd2FzIHJlbW92ZWQiKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGN1cnNvci5mbi5jYWxsKGN1cnNvci5jb250ZXh0LCB2YWx1ZSk7CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW47CiAgICAgIGlmICghdG9rZW4pIHsKICAgICAgICB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbiA9IG5ldyBEZWZlcnJlZFRva2VuKHRoaXMudmFsdWUpOwogICAgICAgIHRoaXMuYXR0YWNoKHRva2VuLnNldCwgdG9rZW4pOwogICAgICB9CiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuZGVmZXJyZWRUb2tlbikgewogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbi5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuID0gbnVsbDsKICAgICAgfQogICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5hdHRhY2ggPSAkdW5kZWY7CiAgICAgIHRoaXMuZGV0YWNoID0gJHVuZGVmOwogICAgfQogIH0pOwogIHZhciBhd2FpdFRvQXBwbHkgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbnMgPSB7fTsKICAgIHZhciB0aW1lcjsKICAgIGZ1bmN0aW9uIGFwcGx5VG9rZW5zKCkgewogICAgICB2YXIgbGlzdCA9IHRva2VuczsKICAgICAgdG9rZW5zID0ge307CiAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgZm9yICh2YXIga2V5IGluIGxpc3QpIGxpc3Rba2V5XS5hcHBseSgpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgIGlmICh0b2tlbi5iYXNpc09iamVjdElkIGluIHRva2VucykgcmV0dXJuOwogICAgICB0b2tlbnNbdG9rZW4uYmFzaXNPYmplY3RJZF0gPSB0b2tlbjsKICAgICAgaWYgKCF0aW1lcikgc2V0SW1tZWRpYXRlKGFwcGx5VG9rZW5zKTsKICAgIH07CiAgfSgpOwogIHZhciBEZWZlcnJlZFRva2VuID0gVG9rZW4uc3ViY2xhc3MoewogICAgY2xhc3NOYW1lOiAiYmFzaXMuRGVmZXJyZWRUb2tlbiIsCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBhd2FpdFRvQXBwbHkodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICBkZWZlcnJlZDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIHZhciByZXNvdXJjZXMgPSB7fTsKICB2YXIgcmVzb3VyY2VDb250ZW50Q2FjaGUgPSB7fTsKICB2YXIgcmVzb3VyY2VQYXRjaCA9IHt9OwogIHZhciByZXNvdXJjZVJlc29sdmluZ1N0YWNrID0gW107CiAgdmFyIHJlcXVpcmVzOwogIChmdW5jdGlvbigpIHsKICAgIHZhciBtYXAgPSB0eXBlb2YgX19yZXNvdXJjZXNfXyAhPSAidW5kZWZpbmVkIiA/IF9fcmVzb3VyY2VzX18gOiBudWxsOwogICAgaWYgKG1hcCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKSByZXNvdXJjZUNvbnRlbnRDYWNoZVtwYXRoVXRpbHMucmVzb2x2ZShrZXkpXSA9IG1hcFtrZXldOwogICAgICBfX3Jlc291cmNlc19fID0gbnVsbDsKICAgIH0KICB9KSgpOwogIGZ1bmN0aW9uIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKSB7CiAgICB2YXIgcGF0Y2hlcyA9IHJlc291cmNlUGF0Y2hbcmVzb3VyY2UudXJsXTsKICAgIGlmIChwYXRjaGVzKSBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc29sZU1ldGhvZHMuaW5mbygiQXBwbHkgcGF0Y2ggZm9yICIgKyByZXNvdXJjZS51cmwpOwogICAgICBwYXRjaGVzW2ldKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogICAgfQogIH0KICB2YXIgZ2V0UmVzb3VyY2VDb250ZW50ID0gZnVuY3Rpb24odXJsLCBpZ25vcmVDYWNoZSkgewogICAgaWYgKGlnbm9yZUNhY2hlIHx8ICFyZXNvdXJjZUNvbnRlbnRDYWNoZS5oYXNPd25Qcm9wZXJ0eSh1cmwpKSB7CiAgICAgIHZhciByZXNvdXJjZUNvbnRlbnQgPSAiIjsKICAgICAgaWYgKCFOT0RFX0VOVikgewogICAgICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICAgICAgcmVxLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIChuZXcgRGF0ZSgwKSkudG9HTVRTdHJpbmcoKSk7CiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoIlgtQmFzaXMtUmVzb3VyY2UiLCAxKTsKICAgICAgICByZXEuc2VuZCgiIik7CiAgICAgICAgaWYgKHJlcS5zdGF0dXMgPj0gMjAwICYmIHJlcS5zdGF0dXMgPCA0MDApIHJlc291cmNlQ29udGVudCA9IHJlcS5yZXNwb25zZVRleHQ7IGVsc2UgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsICsgIiAoc3RhdHVzIGNvZGUgIiArIHJlcS5zdGF0dXMgKyAiKSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcmVxdWlyZSgiZnMiKS5yZWFkRmlsZVN5bmModXJsLCAidXRmLTgiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMucmVzb3VyY2U6IFVuYWJsZSB0byBsb2FkICIgKyB1cmwsIGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdID0gcmVzb3VyY2VDb250ZW50OwogICAgfQogICAgcmV0dXJuIHJlc291cmNlQ29udGVudENhY2hlW3VybF07CiAgfTsKICB2YXIgZ2V0UmVzb3VyY2UgPSBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZSgnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwogICAgaWYgKCFyZXNvdXJjZXNbcmVzb3VyY2VVcmxdKSB7CiAgICAgIHZhciBjb250ZW50V3JhcHBlciA9IGdldFJlc291cmNlLmV4dGVuc2lvbnNbcGF0aFV0aWxzLmV4dG5hbWUocmVzb3VyY2VVcmwpXTsKICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CiAgICAgIHZhciB3cmFwcGVkID0gZmFsc2U7CiAgICAgIHZhciBjb250ZW50OwogICAgICB2YXIgd3JhcHBlZENvbnRlbnQ7CiAgICAgIHZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHVybENvbnRlbnQgPSBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpOwogICAgICAgIHZhciBpZHggPSByZXNvdXJjZVJlc29sdmluZ1N0YWNrLmluZGV4T2YocmVzb3VyY2VVcmwpOwogICAgICAgIGlmIChpZHggIT0gLTEpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLnJlc291cmNlIHJlY3Vyc2lvbjoiLCByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnNsaWNlKGlkeCkuY29uY2F0KHJlc291cmNlVXJsKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlLCBwYXRoVXRpbHMpLmpvaW4oIiAtPiAiKSk7CiAgICAgICAgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wdXNoKHJlc291cmNlVXJsKTsKICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgIGlmICghd3JhcHBlZCkgewogICAgICAgICAgICB3cmFwcGVkID0gdHJ1ZTsKICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKHVybENvbnRlbnQsIHJlc291cmNlVXJsKTsKICAgICAgICAgICAgd3JhcHBlZENvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250ZW50ID0gdXJsQ29udGVudDsKICAgICAgICB9CiAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgIHJlc291cmNlUmVzb2x2aW5nU3RhY2sucG9wKCk7CiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICAgIH07CiAgICAgIGV4dGVuZChyZXNvdXJjZSwgZXh0ZW5kKG5ldyBUb2tlbiwgewogICAgICAgIHVybDogcmVzb3VyY2VVcmwsCiAgICAgICAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlKCk7CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltiYXNpcy5yZXNvdXJjZSAiICsgcmVzb3VyY2VVcmwgKyAiXSI7CiAgICAgICAgfSwKICAgICAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9LAogICAgICAgIGhhc0NoYW5nZXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdICE9PSB3cmFwcGVkQ29udGVudCA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihuZXdDb250ZW50KSB7CiAgICAgICAgICBuZXdDb250ZW50ID0gU3RyaW5nKG5ld0NvbnRlbnQpOwogICAgICAgICAgaWYgKCFyZXNvbHZlZCB8fCBuZXdDb250ZW50ICE9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSkgewogICAgICAgICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gPSBuZXdDb250ZW50OwogICAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgICAgICBpZiAod3JhcHBlZCAmJiAhY29udGVudFdyYXBwZXIucGVybWFuZW50KSB7CiAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIobmV3Q29udGVudCwgcmVzb3VyY2VVcmwpOwogICAgICAgICAgICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG9sZENvbnRlbnQgPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF07CiAgICAgICAgICB2YXIgbmV3Q29udGVudCA9IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCwgdHJ1ZSk7CiAgICAgICAgICBpZiAobmV3Q29udGVudCAhPSBvbGRDb250ZW50KSB7CiAgICAgICAgICAgIHJlc29sdmVkID0gZmFsc2U7CiAgICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShuZXdDb250ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICByZXR1cm4gc291cmNlID8gZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsKSA6IHJlc291cmNlKCk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgICBmbi5jYWxsKGNvbnRleHQsIHJlc291cmNlKCkpOwogICAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIgJiYgY29udGVudFdyYXBwZXIucGVybWFuZW50KSByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXNvdXJjZS5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICAgIH0KICAgICAgfSkpOwogICAgICByZXNvdXJjZXNbcmVzb3VyY2VVcmxdID0gcmVzb3VyY2U7CiAgICB9CiAgICByZXR1cm4gcmVzb3VyY2VzW3Jlc291cmNlVXJsXTsKICB9OwogIGV4dGVuZChnZXRSZXNvdXJjZSwgewogICAgaXNSZXNvdXJjZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gcmVzb3VyY2VzW3ZhbHVlLnVybF0gPT09IHZhbHVlIDogZmFsc2U7CiAgICB9LAogICAgaXNSZXNvbHZlZDogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KHJlc291cmNlVXJsKTsKICAgICAgcmV0dXJuIHJlc291cmNlID8gcmVzb3VyY2UuaXNSZXNvbHZlZCgpIDogZmFsc2U7CiAgICB9LAogICAgZXhpc3RzOiBmdW5jdGlvbihyZXNvdXJjZVVybCkgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlLmV4aXN0cygnIiArIHJlc291cmNlVXJsICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIHJlc291cmNlcy5oYXNPd25Qcm9wZXJ0eShwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCkpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZS5nZXQoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwogICAgICBpZiAoIWdldFJlc291cmNlLmV4aXN0cyhyZXNvdXJjZVVybCkpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gZ2V0UmVzb3VyY2UocmVzb3VyY2VVcmwpOwogICAgfSwKICAgIGdldEZpbGVzOiBmdW5jdGlvbihjYWNoZSkgewogICAgICByZXR1cm4ga2V5cyhjYWNoZSA/IHJlc291cmNlQ29udGVudENhY2hlIDogcmVzb3VyY2VzKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlKTsKICAgIH0sCiAgICBleHRlbnNpb25zOiB7CiAgICAgICIuanMiOiBleHRlbmQoZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXTsKICAgICAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGltcGxpY2l0TmFtZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgIG5hbWVzcGFjZSA9IHBhdGhVdGlscy5kaXJuYW1lKGZpbGVuYW1lKSArICIvIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKTsKICAgICAgICAgIGZvciAodmFyIG5zIGluIGNvbmZpZy5wYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gY29uZmlnLnBhdGhbbnNdICsgbnMgKyAiLyI7CiAgICAgICAgICAgIGlmIChmaWxlbmFtZS5zdWJzdHIoMCwgcGF0aC5sZW5ndGgpID09IHBhdGgpIHsKICAgICAgICAgICAgICBpbXBsaWNpdE5hbWVzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZS5zdWJzdHIoY29uZmlnLnBhdGhbbnNdLmxlbmd0aCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZS5yZXBsYWNlKC9cLi9nLCAiXyIpLnJlcGxhY2UoL15cLy9nLCAiIikucmVwbGFjZSgvXC8vZywgIi4iKTsKICAgICAgICAgIGlmIChpbXBsaWNpdE5hbWVzcGFjZSkgbmFtZXNwYWNlID0gImltcGxpY2l0LiIgKyBuYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIGlmIChyZXF1aXJlcykgQXJyYXlfZXh0ZW5zaW9ucy5hZGQocmVxdWlyZXMsIG5hbWVzcGFjZSk7CiAgICAgICAgaWYgKCFuYW1lc3BhY2VzW25hbWVzcGFjZV0pIHsKICAgICAgICAgIHZhciBucyA9IGdldE5hbWVzcGFjZShuYW1lc3BhY2UpOwogICAgICAgICAgdmFyIHNhdmVkUmVxdWlyZXMgPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gW107CiAgICAgICAgICBucy5leHBvcnRzID0gcnVuU2NyaXB0SW5Db250ZXh0KHsKICAgICAgICAgICAgcGF0aDogbnMucGF0aCwKICAgICAgICAgICAgZXhwb3J0czogbnMuZXhwb3J0cwogICAgICAgICAgfSwgZmlsZW5hbWUsIGNvbnRlbnQpLmV4cG9ydHM7CiAgICAgICAgICBpZiAobnMuZXhwb3J0cyAmJiBucy5leHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5zLCBucy5leHBvcnRzKTsKICAgICAgICAgIG5zLmZpbGVuYW1lXyA9IGZpbGVuYW1lOwogICAgICAgICAgbnMuc291cmNlXyA9IGNvbnRlbnQ7CiAgICAgICAgICBucy5yZXF1aXJlc18gPSByZXF1aXJlczsKICAgICAgICAgIHJlcXVpcmVzID0gc2F2ZWRSZXF1aXJlczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5hbWVzcGFjZXNbbmFtZXNwYWNlXS5leHBvcnRzOwogICAgICB9LCB7CiAgICAgICAgcGVybWFuZW50OiB0cnVlCiAgICAgIH0pLAogICAgICAiLmNzcyI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIHZhciByZXNvdXJjZSA9IENzc1Jlc291cmNlLnJlc291cmNlc1t1cmxdOwogICAgICAgIGlmICghcmVzb3VyY2UpIHJlc291cmNlID0gbmV3IENzc1Jlc291cmNlKHVybCk7IGVsc2UgcmVzb3VyY2UudXBkYXRlQ3NzVGV4dChjb250ZW50KTsKICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgIH0sCiAgICAgICIuanNvbiI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PSAib2JqZWN0IikgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgY29udGVudCA9IFN0cmluZyhjb250ZW50KTsKICAgICAgICAgIHJlc3VsdCA9IGJhc2lzLmpzb24ucGFyc2UoY29udGVudCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2U6IENhbid0IHBhcnNlIEpTT04gZnJvbSAiICsgdXJsLCB7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKHNvdXJjZVVSTCwgYXJncywgYm9keSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihhcmdzLCBib2R5ICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICJsaW5lIiBpbiBlID09IGZhbHNlICYmICJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIHsKICAgICAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBmdW5jdGlvbiBvbmVycm9yKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQuZmlsZW5hbWUgPT0gcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCkgewogICAgICAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBvbmVycm9yKTsKICAgICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoIkNvbXBpbGF0aW9uIGVycm9yIGF0ICIgKyBldmVudC5maWxlbmFtZSArICI6IiArIGV2ZW50LmxpbmVubyArICI6ICIgKyBlKTsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IHNvdXJjZVVSTDsKICAgICAgICBzY3JpcHQuYXN5bmMgPSBmYWxzZTsKICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgc291cmNlVVJMICsgKCJsaW5lIiBpbiBlID8gIjoiICsgKGUubGluZSAtIDEpIDogIiIpICsgIjogIiArIGUpOwogICAgfQogIH0KICB2YXIgcnVuU2NyaXB0SW5Db250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCwgc291cmNlVVJMLCBzb3VyY2VDb2RlKSB7CiAgICB2YXIgYmFzZVVSTCA9IHBhdGhVdGlscy5kaXJuYW1lKHNvdXJjZVVSTCkgKyAiLyI7CiAgICB2YXIgY29tcGlsZWRTb3VyY2VDb2RlID0gc291cmNlQ29kZTsKICAgIGlmICghY29udGV4dC5leHBvcnRzKSBjb250ZXh0LmV4cG9ydHMgPSB7fTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlICE9ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZSA9IGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIFsgImV4cG9ydHMiLCAibW9kdWxlIiwgImJhc2lzIiwgImdsb2JhbCIsICJfX2ZpbGVuYW1lIiwgIl9fZGlybmFtZSIsICJyZXNvdXJjZSIsICJyZXF1aXJlIiBdLCAnInVzZSBzdHJpY3QiO1xuJyArIHNvdXJjZUNvZGUpOwogICAgaWYgKHR5cGVvZiBjb21waWxlZFNvdXJjZUNvZGUgPT0gImZ1bmN0aW9uIikgY29tcGlsZWRTb3VyY2VDb2RlLmNhbGwoY29udGV4dC5leHBvcnRzLCBjb250ZXh0LmV4cG9ydHMsIGNvbnRleHQsIGJhc2lzLCBnbG9iYWwsIHNvdXJjZVVSTCwgYmFzZVVSTCwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZWxhdGl2ZVBhdGgpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IHJlc291cmNlKCciICsgcmVsYXRpdmVQYXRoICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHBhdGhVdGlscy5yZXNvbHZlKGJhc2VVUkwsIHJlbGF0aXZlUGF0aCkpOwogICAgfSwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoLCBiYXNlKSB7CiAgICAgIHJldHVybiByZXF1aXJlTmFtZXNwYWNlKHJlbGF0aXZlUGF0aCwgYmFzZSB8fCBiYXNlVVJMKTsKICAgIH0pOwogICAgcmV0dXJuIGNvbnRleHQ7CiAgfTsKICB2YXIgbmFtZXNwYWNlcyA9IHt9OwogIHZhciBuYW1lc3BhY2UyZmlsZW5hbWUgPSB7fTsKICB2YXIgZmlsZW5hbWUybmFtZXNwYWNlID0ge307CiAgdmFyIG5zUm9vdFBhdGggPSBzbGljZShjb25maWcucGF0aCk7CiAgKGZ1bmN0aW9uKG1hcCkgewogICAgdmFyIG1hcCA9IHR5cGVvZiBfX25hbWVzcGFjZV9tYXBfXyAhPSAidW5kZWZpbmVkIiA/IF9fbmFtZXNwYWNlX21hcF9fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGtleSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IG1hcFtrZXldOwogICAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV0gPSBmaWxlbmFtZTsKICAgICAgfQogICAgfQogIH0pKCk7CiAgdmFyIE5hbWVzcGFjZSA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLk5hbWVzcGFjZSIsCiAgICBpbml0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZXhwb3J0cyA9IHsKICAgICAgICBwYXRoOiB0aGlzLm5hbWUKICAgICAgfTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAiW2Jhc2lzLm5hbWVzcGFjZSAiICsgdGhpcy5wYXRoICsgIl0iOwogICAgfSwKICAgIGV4dGVuZDogZnVuY3Rpb24obmFtZXMpIHsKICAgICAgZXh0ZW5kKHRoaXMuZXhwb3J0cywgbmFtZXMpOwogICAgICByZXR1cm4gY29tcGxldGUodGhpcywgbmFtZXMpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHJlc29sdmVOU0ZpbGVuYW1lKG5hbWVzcGFjZSkgewogICAgdmFyIG5hbWVzcGFjZVJvb3QgPSBuYW1lc3BhY2Uuc3BsaXQoIi4iKVswXTsKICAgIHZhciBmaWxlbmFtZSA9IG5hbWVzcGFjZS5yZXBsYWNlKC9cLi9nLCAiLyIpICsgIi5qcyI7CiAgICBpZiAobmFtZXNwYWNlIGluIG5hbWVzcGFjZTJmaWxlbmFtZSA9PSBmYWxzZSkgewogICAgICBpZiAobmFtZXNwYWNlUm9vdCBpbiBuc1Jvb3RQYXRoID09IGZhbHNlKSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdID0gcGF0aFV0aWxzLmJhc2VVUkk7CiAgICAgIGlmIChuYW1lc3BhY2VSb290ID09IG5hbWVzcGFjZSkgZmlsZW5hbWUybmFtZXNwYWNlW25zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gKyBmaWxlbmFtZV0gPSBuYW1lc3BhY2VSb290OwogICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gKyBmaWxlbmFtZTsKICAgIH0KICAgIHJldHVybiBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXTsKICB9CiAgZnVuY3Rpb24gZ2V0Um9vdE5hbWVzcGFjZShuYW1lKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXTsKICAgIGlmICghbmFtZXNwYWNlKSB7CiAgICAgIG5hbWVzcGFjZSA9IG5hbWVzcGFjZXNbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5hbWUpOwogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc18gPSB7fTsKICAgICAgbmFtZXNwYWNlLm5hbWVzcGFjZXNfW25hbWVdID0gbmFtZXNwYWNlOwogICAgICBpZiAoIWNvbmZpZy5ub0NvbmZsaWN0KSBnbG9iYWxbbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CiAgICByZXR1cm4gbmFtZXNwYWNlOwogIH0KICBmdW5jdGlvbiBnZXROYW1lc3BhY2UocGF0aCkgewogICAgcGF0aCA9IHBhdGguc3BsaXQoIi4iKTsKICAgIHZhciByb290TnMgPSBnZXRSb290TmFtZXNwYWNlKHBhdGhbMF0pOwogICAgdmFyIGN1cnNvciA9IHJvb3ROczsKICAgIGZvciAodmFyIGkgPSAxLCBuYW1lOyBuYW1lID0gcGF0aFtpXTsgaSsrKSB7CiAgICAgIGlmICghY3Vyc29yW25hbWVdKSB7CiAgICAgICAgdmFyIG5zcGF0aCA9IHBhdGguc2xpY2UoMCwgaSArIDEpLmpvaW4oIi4iKTsKICAgICAgICBjdXJzb3JbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5zcGF0aCk7CiAgICAgICAgcm9vdE5zLm5hbWVzcGFjZXNfW25zcGF0aF0gPSBjdXJzb3JbbmFtZV07CiAgICAgIH0KICAgICAgY3Vyc29yID0gY3Vyc29yW25hbWVdOwogICAgfQogICAgbmFtZXNwYWNlc1twYXRoLmpvaW4oIi4iKV0gPSBjdXJzb3I7CiAgICByZXR1cm4gY3Vyc29yOwogIH0KICB2YXIgcmVxdWlyZU5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKE5PREVfRU5WKSB7CiAgICAgIHZhciBtb2R1bGVQcm90byA9IG1vZHVsZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpIHx8IHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSA9PSAiLmpzIikgewogICAgICAgICAgdmFyIF9jb21waWxlID0gbW9kdWxlUHJvdG8uX2NvbXBpbGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0TmFtZXNwYWNlKGZpbGVuYW1lKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNpcyA9IGJhc2lzOwogICAgICAgICAgICBjb250ZW50ID0gInZhciBub2RlX3JlcXVpcmUgPSByZXF1aXJlO1xuIiArICJ2YXIgYmFzaXMgPSBtb2R1bGUuYmFzaXM7XG4iICsgJ3ZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKXsgcmV0dXJuIGJhc2lzLnJlc291cmNlKF9fZGlybmFtZSArICIvIiArIGZpbGVuYW1lKSB9O1xuJyArICJ2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBiYXNlVVJJKXsgcmV0dXJuIGJhc2lzLnJlcXVpcmUoZmlsZW5hbWUsIGJhc2VVUkkgfHwgX19kaXJuYW1lKSB9O1xuIiArIGNvbnRlbnQ7CiAgICAgICAgICAgIF9jb21waWxlLmNhbGwoZXh0ZW5kKHRoaXMsIG5hbWVzcGFjZSksIGNvbnRlbnQsIGZpbGVuYW1lKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXhwb3J0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIi8iKSk7CiAgICAgICAgICBuYW1lc3BhY2UuZXhwb3J0cyA9IGV4cG9ydHM7CiAgICAgICAgICBpZiAoZXhwb3J0cyAmJiBleHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIGNvbXBsZXRlKG5hbWVzcGFjZSwgZXhwb3J0cyk7CiAgICAgICAgICBtb2R1bGVQcm90by5fY29tcGlsZSA9IF9jb21waWxlOwogICAgICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSkgewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogcmVxdWlyZSgnIiArIGZpbGVuYW1lICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2UoZmlsZW5hbWUpLmZldGNoKCk7CiAgICAgIH07CiAgICB9CiAgfSgpOwogIGZ1bmN0aW9uIHBhdGNoKGZpbGVuYW1lLCBwYXRjaEZuKSB7CiAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gIi5qcyIpIHsKICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZmlsZW5hbWUpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IGJhc2lzLnBhdGNoKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgIH0KICAgIGlmICghcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0pIHJlc291cmNlUGF0Y2hbZmlsZW5hbWVdID0gWyBwYXRjaEZuIF07IGVsc2UgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0ucHVzaChwYXRjaEZuKTsKICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChmaWxlbmFtZSk7CiAgICBpZiAocmVzb3VyY2UgJiYgcmVzb3VyY2UuaXNSZXNvbHZlZCgpKSBwYXRjaEZuKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogIH0KICBmdW5jdGlvbiBleHRlbmRQcm90byhjbHMsIGV4dGVuc2lvbnMpIHsKICAgIGlmIChjb25maWcuZXh0UHJvdG8pIGZvciAodmFyIGtleSBpbiBleHRlbnNpb25zKSBjbHMucHJvdG90eXBlW2tleV0gPSBmdW5jdGlvbihtZXRob2QsIGNsc05hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjb25maWcuZXh0UHJvdG8gPT0gIndhcm4iKSBjb25zb2xlTWV0aG9kcy53YXJuKGNsc05hbWUgKyAiIyIgKyBtZXRob2QgKyAiIGlzIG5vdCBhIHN0YW5kYXJkIG1ldGhvZCBhbmQgd2lsbCBiZSByZW1vdmVkIHNvb247IHVzZSBiYXNpcy4iICsgY2xzTmFtZS50b0xvd2VyQ2FzZSgpICsgIi4iICsgbWV0aG9kICsgIiBpbnN0ZWFkIik7CiAgICAgICAgdmFyIGFyZ3MgPSBbIHRoaXMgXTsKICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBleHRlbnNpb25zW21ldGhvZF0uYXBwbHkoZXh0ZW5zaW9ucywgYXJncyk7CiAgICAgIH07CiAgICB9KGtleSwgY2xzLm5hbWUgfHwgY2xzLnRvU3RyaW5nKCkubWF0Y2goL15ccypmdW5jdGlvblxzKihcdyopXHMqXCgvKVsxXSk7CiAgfQogIGNvbXBsZXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgYmluZDogZnVuY3Rpb24odGhpc09iamVjdCkgewogICAgICB2YXIgZm4gPSB0aGlzOwogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBwYXJhbXMubGVuZ3RoID8gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNPYmplY3QsIHBhcmFtcy5jb25jYXQuYXBwbHkocGFyYW1zLCBhcmd1bWVudHMpKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0pOwogIGNvbXBsZXRlKEFycmF5LCB7CiAgICBpc0FycmF5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gT2JqZWN0X3RvU3RyaW5nLmNhbGwodmFsdWUpID09PSAiW29iamVjdCBBcnJheV0iOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIGFycmF5RnJvbShvYmplY3QsIG9mZnNldCkgewogICAgaWYgKG9iamVjdCAhPSBudWxsKSB7CiAgICAgIHZhciBsZW4gPSBvYmplY3QubGVuZ3RoOwogICAgICBpZiAodHlwZW9mIGxlbiA9PSAidW5kZWZpbmVkIiB8fCBPYmplY3RfdG9TdHJpbmcuY2FsbChvYmplY3QpID09ICJbb2JqZWN0IEZ1bmN0aW9uXSIpIHJldHVybiBbIG9iamVjdCBdOwogICAgICBpZiAoIW9mZnNldCkgb2Zmc2V0ID0gMDsKICAgICAgaWYgKGxlbiAtIG9mZnNldCA+IDApIHsKICAgICAgICBmb3IgKHZhciByZXN1bHQgPSBbXSwgayA9IDAsIGkgPSBvZmZzZXQ7IGkgPCBsZW47ICkgcmVzdWx0W2srK10gPSBvYmplY3RbaSsrXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW107CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUFycmF5KGxlbmd0aCwgZmlsbFZhbHVlLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICB2YXIgaXNGdW5jID0gdHlwZW9mIGZpbGxWYWx1ZSA9PSAiZnVuY3Rpb24iOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgcmVzdWx0W2ldID0gaXNGdW5jID8gZmlsbFZhbHVlLmNhbGwodGhpc09iamVjdCwgaSwgcmVzdWx0KSA6IGZpbGxWYWx1ZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGNvbXBsZXRlKEFycmF5LnByb3RvdHlwZSwgewogICAgaW5kZXhPZjogZnVuY3Rpb24oc2VhcmNoRWxlbWVudCwgb2Zmc2V0KSB7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApIHx8IDA7CiAgICAgIGlmIChvZmZzZXQgPCAwKSByZXR1cm4gLTE7CiAgICAgIGZvciAoOyBvZmZzZXQgPCB0aGlzLmxlbmd0aDsgb2Zmc2V0KyspIGlmICh0aGlzW29mZnNldF0gPT09IHNlYXJjaEVsZW1lbnQpIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBsYXN0SW5kZXhPZjogZnVuY3Rpb24oc2VhcmNoRWxlbWVudCwgb2Zmc2V0KSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCk7CiAgICAgIGlmIChpc05hTihvZmZzZXQpIHx8IG9mZnNldCA+PSBsZW4pIG9mZnNldCA9IGxlbiAtIDE7IGVsc2Ugb2Zmc2V0ID0gKG9mZnNldCArIGxlbikgJSBsZW47CiAgICAgIGZvciAoOyBvZmZzZXQgPj0gMDsgb2Zmc2V0LS0pIGlmICh0aGlzW29mZnNldF0gPT09IHNlYXJjaEVsZW1lbnQpIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBmb3JFYWNoOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgIH0sCiAgICBldmVyeTogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgIWNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgc29tZTogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMgJiYgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0LnB1c2godGhpc1tpXSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAogICAgbWFwOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSByZXN1bHRbaV0gPSBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIHJlZHVjZTogZnVuY3Rpb24oY2FsbGJhY2ssIGluaXRpYWxWYWx1ZSkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIHZhciBhcmdzTGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgaWYgKGxlbiA9PSAwICYmIGFyZ3NMZW4gPT0gMSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgdmFyIGluaXRlZCA9IDA7CiAgICAgIGlmIChhcmdzTGVuID4gMSkgewogICAgICAgIHJlc3VsdCA9IGluaXRpYWxWYWx1ZTsKICAgICAgICBpbml0ZWQgPSAxOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIGlmIChpbml0ZWQrKykgcmVzdWx0ID0gY2FsbGJhY2suY2FsbChudWxsLCByZXN1bHQsIHRoaXNbaV0sIGksIHRoaXMpOyBlbHNlIHJlc3VsdCA9IHRoaXNbaV07CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfSk7CiAgdmFyIEFycmF5X2V4dGVuc2lvbnMgPSB7CiAgICBmbGF0dGVuOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY29uY2F0LmFwcGx5KFtdLCB0aGlzXyk7CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIEFycmF5X2V4dGVuc2lvbnMuZmxhdHRlbihjcmVhdGVBcnJheShwYXJzZUludChjb3VudCwgMTApIHx8IDAsIHRoaXNfKSk7CiAgICB9LAogICAgc2VhcmNoOiBmdW5jdGlvbih0aGlzXywgdmFsdWUsIGdldHRlcl8sIG9mZnNldCkgewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKICAgICAgZm9yICh2YXIgaW5kZXggPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwLCBsZW4gPSB0aGlzXy5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKSBpZiAoZ2V0dGVyXyh0aGlzX1tpbmRleF0pID09PSB2YWx1ZSkgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGluZGV4XTsKICAgIH0sCiAgICBsYXN0U2VhcmNoOiBmdW5jdGlvbih0aGlzXywgdmFsdWUsIGdldHRlcl8sIG9mZnNldCkgewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKICAgICAgdmFyIGxlbiA9IHRoaXNfLmxlbmd0aDsKICAgICAgdmFyIGluZGV4ID0gaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPT0gbnVsbCA/IGxlbiA6IHBhcnNlSW50KG9mZnNldCwgMTApOwogICAgICBmb3IgKHZhciBpID0gaW5kZXggPiBsZW4gPyBsZW4gOiBpbmRleDsgaS0tID4gMDsgKSBpZiAoZ2V0dGVyXyh0aGlzX1tpXSkgPT09IHZhbHVlKSByZXR1cm4gdGhpc19bdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gaV07CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpID09IC0xICYmICEhdGhpc18ucHVzaCh2YWx1ZSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgdmFyIGluZGV4ID0gdGhpc18uaW5kZXhPZih2YWx1ZSk7CiAgICAgIHJldHVybiBpbmRleCAhPSAtMSAmJiAhIXRoaXNfLnNwbGljZShpbmRleCwgMSk7CiAgICB9LAogICAgaGFzOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpICE9IC0xOwogICAgfSwKICAgIHNvcnRBc09iamVjdDogZnVuY3Rpb24odGhpc18sIGdldHRlcl8sIGNvbXBhcmF0b3IsIGRlc2MpIHsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfKTsKICAgICAgZGVzYyA9IGRlc2MgPyAtMSA6IDE7CiAgICAgIHJldHVybiB0aGlzXy5tYXAoZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgaTogaW5kZXgsCiAgICAgICAgICB2OiBnZXR0ZXJfKGl0ZW0pCiAgICAgICAgfTsKICAgICAgfSkuc29ydChjb21wYXJhdG9yIHx8IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gZGVzYyAqIChhLnYgPiBiLnYgfHwgLShhLnYgPCBiLnYpIHx8IChhLmkgPiBiLmkgPyAxIDogLTEpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gdGhpc19baXRlbS5pXTsKICAgICAgfSwgdGhpc18pOwogICAgfQogIH07CiAgZXh0ZW5kUHJvdG8oQXJyYXksIEFycmF5X2V4dGVuc2lvbnMpOwogIGlmICghWyAxLCAyIF0uc3BsaWNlKDEpLmxlbmd0aCkgewogICAgdmFyIG5hdGl2ZUFycmF5U3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDIpIHBhcmFtc1sxXSA9IHRoaXMubGVuZ3RoOwogICAgICByZXR1cm4gbmF0aXZlQXJyYXlTcGxpY2UuYXBwbHkodGhpcywgcGFyYW1zKTsKICAgIH07CiAgfQogIHZhciBFU0NBUEVfRk9SX1JFR0VYUCA9IC8oW1wvXFxcKFwpXFtcXVw/XHtcfVx8XCpcK1wtXC5cXlwkXSkvZzsKICB2YXIgRk9STUFUX1JFR0VYUCA9IC9ceyhbYS16XGRfXSspKD86OihbXC4wXSkoXGQrKXw6KFw/KSk/XH0vZ2k7CiAgZnVuY3Rpb24gaXNFbXB0eVN0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgU3RyaW5nKHZhbHVlKSA9PSAiIjsKICB9CiAgZnVuY3Rpb24gaXNOb3RFbXB0eVN0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgU3RyaW5nKHZhbHVlKSAhPSAiIjsKICB9CiAgY29tcGxldGUoU3RyaW5nLCB7CiAgICB0b0xvd2VyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICB0b1VwcGVyQ2FzZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltKCk7CiAgICB9LAogICAgdHJpbUxlZnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1MZWZ0KCk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICBjb21wbGV0ZShTdHJpbmcucHJvdG90eXBlLCB7CiAgICB0cmltTGVmdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcGxhY2UoL15ccysvLCAiIik7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sICIiKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudHJpbUxlZnQoKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKICB2YXIgU3RyaW5nX2V4dGVuc2lvbnMgPSB7CiAgICB0b09iamVjdDogZnVuY3Rpb24odGhpc18sIHJldGhyb3cpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuIDAsIiArIHRoaXNfKSkoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChyZXRocm93KSB0aHJvdyBlOwogICAgICB9CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIChuZXcgQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSArIDEgfHwgMCkpLmpvaW4odGhpc18pOwogICAgfSwKICAgIHF3OiBmdW5jdGlvbih0aGlzXykgewogICAgICB2YXIgdHJpbW1lZCA9IHRoaXNfLnRyaW0oKTsKICAgICAgcmV0dXJuIHRyaW1tZWQgPyB0cmltbWVkLnNwbGl0KC9ccysvKSA6IFtdOwogICAgfSwKICAgIGZvclJlZ0V4cDogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRVNDQVBFX0ZPUl9SRUdFWFAsICJcXCQxIik7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgZmlyc3QpIHsKICAgICAgdmFyIGRhdGEgPSBhcnJheUZyb20oYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKHR5cGVvZiBmaXJzdCA9PSAib2JqZWN0IikgZXh0ZW5kKGRhdGEsIGZpcnN0KTsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRk9STUFUX1JFR0VYUCwgZnVuY3Rpb24obSwga2V5LCBudW1Gb3JtYXQsIG51bSwgbm9OdWxsKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga2V5IGluIGRhdGEgPyBkYXRhW2tleV0gOiBub051bGwgPyAiIiA6IG07CiAgICAgICAgaWYgKG51bUZvcm1hdCAmJiAhaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICByZXR1cm4gbnVtRm9ybWF0ID09ICIuIiA/IHZhbHVlLnRvRml4ZWQobnVtKSA6IE51bWJlcl9leHRlbnNpb25zLmxlYWQodmFsdWUsIG51bSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSk7CiAgICB9LAogICAgY2FwaXRhbGl6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGhpc18uc3Vic3RyKDEpLnRvTG93ZXJDYXNlKCk7CiAgICB9LAogICAgY2FtZWxpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC8tKC4pL2csIGZ1bmN0aW9uKG0sIGNocikgewogICAgICAgIHJldHVybiBjaHIudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAogICAgZGFzaGVyaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obSkgewogICAgICAgIHJldHVybiAiLSIgKyBtLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfQogIH07CiAgZXh0ZW5kUHJvdG8oU3RyaW5nLCBTdHJpbmdfZXh0ZW5zaW9ucyk7CiAgaWYgKCJ8fHwiLnNwbGl0KC9cfC8pLmxlbmd0aCArICJ8fHwiLnNwbGl0KC8oXHwpLykubGVuZ3RoICE9IDExKSB7CiAgICB2YXIgbmF0aXZlU3RyaW5nU3BsaXQgPSBTdHJpbmcucHJvdG90eXBlLnNwbGl0OwogICAgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCA9IGZ1bmN0aW9uKHBhdHRlcm4sIGNvdW50KSB7CiAgICAgIGlmICghcGF0dGVybiB8fCBwYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwID09IGZhbHNlIHx8IHBhdHRlcm4uc291cmNlID09ICIiKSByZXR1cm4gbmF0aXZlU3RyaW5nU3BsaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG1hdGNoOwogICAgICBpZiAoIXBhdHRlcm4uZ2xvYmFsKSBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnNvdXJjZSwgL1wvKFttaV0qKSQvLmV4ZWMocGF0dGVybilbMV0gKyAiZyIpOwogICAgICB3aGlsZSAobWF0Y2ggPSBwYXR0ZXJuLmV4ZWModGhpcykpIHsKICAgICAgICBtYXRjaFswXSA9IHRoaXMuc3Vic3RyaW5nKHBvcywgbWF0Y2guaW5kZXgpOwogICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgbWF0Y2gpOwogICAgICAgIHBvcyA9IHBhdHRlcm4ubGFzdEluZGV4OwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3Vic3RyKHBvcykpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CiAgaWYgKCIxMiIuc3Vic3RyKC0xKSAhPSAiMiIpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTdWJzdHIgPSBTdHJpbmcucHJvdG90eXBlLnN1YnN0cjsKICAgIFN0cmluZy5wcm90b3R5cGUuc3Vic3RyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbmF0aXZlU3RyaW5nU3Vic3RyLmNhbGwodGhpcywgc3RhcnQgPCAwID8gTWF0aC5tYXgoMCwgdGhpcy5sZW5ndGggKyBzdGFydCkgOiBzdGFydCwgZW5kKTsKICAgIH07CiAgfQogIHZhciBOdW1iZXJfZXh0ZW5zaW9ucyA9IHsKICAgIGZpdDogZnVuY3Rpb24odGhpc18sIG1pbiwgbWF4KSB7CiAgICAgIGlmICghaXNOYU4obWluKSAmJiB0aGlzXyA8IG1pbikgcmV0dXJuIE51bWJlcihtaW4pOwogICAgICBpZiAoIWlzTmFOKG1heCkgJiYgdGhpc18gPiBtYXgpIHJldHVybiBOdW1iZXIobWF4KTsKICAgICAgcmV0dXJuIHRoaXNfOwogICAgfSwKICAgIGxlYWQ6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIGxlYWRDaGFyKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiAobGVuIC09IG51bWJlci5sZW5ndGggLSAxKSA+IDEgPyAobmV3IEFycmF5KGxlbikpLmpvaW4obGVhZENoYXIgfHwgMCkgKyBudW1iZXIgOiBudW1iZXI7CiAgICAgIH0pOwogICAgfSwKICAgIGdyb3VwOiBmdW5jdGlvbih0aGlzXywgbGVuLCBzcGxpdHRlcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyLnJlcGxhY2UoL1xkL2csIGZ1bmN0aW9uKG0sIHBvcykgewogICAgICAgICAgcmV0dXJuICFwb3MgKyAobnVtYmVyLmxlbmd0aCAtIHBvcykgJSAobGVuIHx8IDMpID8gbSA6IChzcGxpdHRlciB8fCAiICIpICsgbTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgcHJlYywgZ3MsIHByZWZpeCwgcG9zdGZpeCwgY29tbWEpIHsKICAgICAgdmFyIHJlcyA9IHRoaXNfLnRvRml4ZWQocHJlYyk7CiAgICAgIGlmIChncyB8fCBjb21tYSkgcmVzID0gcmVzLnJlcGxhY2UoLyhcZCspKFwuPykvLCBmdW5jdGlvbihtLCBudW1iZXIsIGMpIHsKICAgICAgICByZXR1cm4gKGdzID8gYmFzaXMubnVtYmVyLmdyb3VwKE51bWJlcihudW1iZXIpLCAzLCBncykgOiBudW1iZXIpICsgKGMgPyBjb21tYSB8fCBjIDogIiIpOwogICAgICB9KTsKICAgICAgaWYgKHByZWZpeCkgcmVzID0gcmVzLnJlcGxhY2UoL14tPy8sICIkJiIgKyAocHJlZml4IHx8ICIiKSk7CiAgICAgIHJldHVybiByZXMgKyAocG9zdGZpeCB8fCAiIik7CiAgICB9CiAgfTsKICBleHRlbmRQcm90byhOdW1iZXIsIE51bWJlcl9leHRlbnNpb25zKTsKICBjb21wbGV0ZShEYXRlLCB7CiAgICBub3c6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gTnVtYmVyKG5ldyBEYXRlKTsKICAgIH0KICB9KTsKICB2YXIgcmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIGlzUmVhZHkoKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgJiYgISFkb2N1bWVudC5ib2R5OwogICAgfQogICAgdmFyIGZpcmVkID0gIWRvY3VtZW50IHx8IGlzUmVhZHkoKTsKICAgIHZhciBkZWZlcnJlZEhhbmRsZXI7CiAgICBmdW5jdGlvbiBydW5SZWFkeUhhbmRsZXIoaGFuZGxlcikgewogICAgICBoYW5kbGVyLmNhbGxiYWNrLmNhbGwoaGFuZGxlci5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVIYW5kbGVycygpIHsKICAgICAgaWYgKGlzUmVhZHkoKSkgaWYgKCEoZmlyZWQrKykpIHdoaWxlIChkZWZlcnJlZEhhbmRsZXIpIHsKICAgICAgICBydW5SZWFkeUhhbmRsZXIoZGVmZXJyZWRIYW5kbGVyKTsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSBkZWZlcnJlZEhhbmRsZXIubmV4dDsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICBmaXJlSGFuZGxlcnMoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghZmlyZWQpIHsKICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmaXJlSGFuZGxlcnMsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZmlyZUhhbmRsZXJzKTsKICAgICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZ2xvYmFsLmZyYW1lRWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwpIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGRlZmVycmVkSGFuZGxlciA9IHsKICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBuZXh0OiBkZWZlcnJlZEhhbmRsZXIKICAgICAgICB9OwogICAgICB9IGVsc2UgcnVuUmVhZHlIYW5kbGVyKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgIH07CiAgfSgpOwogIHZhciBkb2N1bWVudEludGVyZmFjZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRpbWVyOwogICAgdmFyIHJlZmVyZW5jZSA9IHt9OwogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaGVhZDogW10sCiAgICAgIGJvZHk6IFtdCiAgICB9OwogICAgZnVuY3Rpb24gZ2V0UGFyZW50KG5hbWUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICFyZWZlcmVuY2VbbmFtZV0pIHsKICAgICAgICByZWZlcmVuY2VbbmFtZV0gPSBkb2N1bWVudFtuYW1lXSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKVswXTsKICAgICAgICBpZiAocmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNiOyBjYiA9IGl0ZW1zW2ldOyBpKyspIGNiWzBdLmNhbGwoY2JbMV0sIHJlZmVyZW5jZVtuYW1lXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZWZlcmVuY2VbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiBhZGQoKSB7CiAgICAgIHZhciBuYW1lID0gdGhpc1swXTsKICAgICAgdmFyIG5vZGUgPSB0aGlzWzFdOwogICAgICB2YXIgcmVmID0gdGhpc1syXTsKICAgICAgcmVtb3ZlKG5vZGUpOwogICAgICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KG5hbWUpOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgaWYgKHJlZiA9PT0gdHJ1ZSkgcmVmID0gcGFyZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgaWYgKCFyZWYgfHwgcmVmLnBhcmVudE5vZGUgIT09IHBhcmVudCkgcmVmID0gbnVsbDsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZik7CiAgICAgIH0gZWxzZSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGFkZCwgWyBuYW1lLCBub2RlLCByZWYgXSBdKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRvY1JlYWR5KG5hbWUsIGZuLCBjb250ZXh0KSB7CiAgICAgIGlmIChjYWxsYmFja3NbbmFtZV0pIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFsgZm4sIGNvbnRleHQgXSk7IGVsc2UgZm4uY2FsbChjb250ZXh0LCByZWZlcmVuY2VbbmFtZV0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKG5vZGUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGNhbGxiYWNrcykgewogICAgICAgIHZhciBlbnRyeSA9IEFycmF5X2V4dGVuc2lvbnMuc2VhcmNoKGNhbGxiYWNrc1trZXldLCBub2RlLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICByZXR1cm4gaXRlbVsxXSAmJiBpdGVtWzFdWzFdOwogICAgICAgIH0pOwogICAgICAgIGlmIChlbnRyeSkgQXJyYXlfZXh0ZW5zaW9ucy5yZW1vdmUoY2FsbGJhY2tzW2tleV0sIGVudHJ5KTsKICAgICAgfQogICAgICBpZiAobm9kZSAmJiBub2RlLnBhcmVudE5vZGUgJiYgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoZWNrUGFyZW50cygpIHsKICAgICAgaWYgKHRpbWVyICYmIGdldFBhcmVudCgiaGVhZCIpICYmIGdldFBhcmVudCgiYm9keSIpKSB0aW1lciA9IGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgaWYgKGRvY3VtZW50ICYmICghZ2V0UGFyZW50KCJoZWFkIikgfHwgIWdldFBhcmVudCgiYm9keSIpKSkgewogICAgICB0aW1lciA9IHNldEludGVydmFsKGNoZWNrUGFyZW50cywgNSk7CiAgICAgIHJlYWR5KGNoZWNrUGFyZW50cyk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBoZWFkOiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiaGVhZCIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJoZWFkIiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYm9keTogewogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgZG9jUmVhZHkoImJvZHkiLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZikgewogICAgICAgICAgYWRkLmNhbGwoWyAiYm9keSIsIG5vZGUsIHJlZiBdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogcmVtb3ZlCiAgICB9OwogIH0oKTsKICB2YXIgY2xlYW5lciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG9iamVjdHMgPSBbXTsKICAgIGZ1bmN0aW9uIGRlc3Ryb3kobG9nKSB7CiAgICAgIHZhciBsb2dEZXN0cm95ID0gbG9nICYmIHR5cGVvZiBsb2cgPT0gImJvb2xlYW4iOwogICAgICByZXN1bHQuZ2xvYmFsRGVzdHJveSA9IHRydWU7CiAgICAgIHJlc3VsdC5hZGQgPSAkdW5kZWY7CiAgICAgIHJlc3VsdC5yZW1vdmUgPSAkdW5kZWY7CiAgICAgIHZhciBvYmplY3Q7CiAgICAgIHdoaWxlIChvYmplY3QgPSBvYmplY3RzLnBvcCgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZGVzdHJveSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobG9nRGVzdHJveSkgY29uc29sZU1ldGhvZHMubG9nKCJkZXN0cm95IiwgIlsiICsgU3RyaW5nKG9iamVjdC5jbGFzc05hbWUpICsgIl0iLCBvYmplY3QpOwogICAgICAgICAgICBvYmplY3QuZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKFN0cmluZyhvYmplY3QpLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIG9iamVjdFtwcm9wXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG9iamVjdHMubGVuZ3RoID0gMDsKICAgIH0KICAgIGlmICgiYXR0YWNoRXZlbnQiIGluIGdsb2JhbCkgZ2xvYmFsLmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlc3Ryb3kpOyBlbHNlIGlmICgiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZ2xvYmFsKSBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigidW5sb2FkIiwgZGVzdHJveSwgZmFsc2UpOyBlbHNlIHJldHVybiB7CiAgICAgIGFkZDogJHVuZGVmLAogICAgICByZW1vdmU6ICR1bmRlZgogICAgfTsKICAgIHZhciByZXN1bHQgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCAhPSBudWxsKSBvYmplY3RzLnB1c2gob2JqZWN0KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBBcnJheV9leHRlbnNpb25zLnJlbW92ZShvYmplY3RzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgcmVzdWx0LmRlc3Ryb3lfID0gZGVzdHJveTsKICAgIHJlc3VsdC5vYmplY3RzXyA9IG9iamVjdHM7CiAgICByZXR1cm4gcmVzdWx0OwogIH0oKTsKICB2YXIgQ3NzUmVzb3VyY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjc3NSZXNvdXJjZXMgPSB7fTsKICAgIHZhciBjbGVhbnVwRG9tID0gdHJ1ZTsKICAgIHZhciBTVFlMRV9BUFBFTkRfQlVHR1kgPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIikuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KCk7CiAgICBjbGVhbmVyLmFkZCh7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFudXBEb20gPSBmYWxzZTsKICAgICAgICBmb3IgKHZhciB1cmwgaW4gY3NzUmVzb3VyY2VzKSBjc3NSZXNvdXJjZXNbdXJsXS5kZXN0cm95KCk7CiAgICAgICAgY3NzUmVzb3VyY2VzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgYmFzZUVsID0gZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgZnVuY3Rpb24gc2V0QmFzZShiYXNlVVJJKSB7CiAgICAgIGJhc2VFbC5zZXRBdHRyaWJ1dGUoImhyZWYiLCBiYXNlVVJJKTsKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoYmFzZUVsLCB0cnVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc3RvcmVCYXNlKCkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgbG9jYXRpb24uaHJlZik7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShiYXNlRWwpOwogICAgfQogICAgZnVuY3Rpb24gaW5qZWN0U3R5bGVUb0hlYWQoKSB7CiAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgaWYgKCF0aGlzLmVsZW1lbnQpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgIGlmICghU1RZTEVfQVBQRU5EX0JVR0dZKSB0aGlzLnRleHROb2RlID0gdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgic3JjIiwgcGF0aFV0aWxzLnJlbGF0aXZlKHRoaXMudXJsKSk7CiAgICAgIH0KICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQodGhpcy5lbGVtZW50KTsKICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICByZXN0b3JlQmFzZSgpOwogICAgfQogICAgdmFyIENzc1Jlc291cmNlID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6ICJiYXNpcy5Dc3NSZXNvdXJjZSIsCiAgICAgIGluVXNlOiAwLAogICAgICB1cmw6ICIiLAogICAgICBiYXNlVVJJOiAiIiwKICAgICAgY3NzVGV4dDogIiIsCiAgICAgIHJlc291cmNlOiBudWxsLAogICAgICBlbGVtZW50OiBudWxsLAogICAgICB0ZXh0Tm9kZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdGhpcy51cmwgPSBwYXRoVXRpbHMucmVzb2x2ZSh1cmwpOwogICAgICAgIHRoaXMuYmFzZVVSSSA9IHBhdGhVdGlscy5kaXJuYW1lKHVybCkgKyAiLyI7CiAgICAgICAgY3NzUmVzb3VyY2VzW3VybF0gPSB0aGlzOwogICAgICB9LAogICAgICB1cGRhdGVDc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICAgICAgaWYgKHRoaXMuY3NzVGV4dCAhPSBjc3NUZXh0KSB7CiAgICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgaWYgKHRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KSB7CiAgICAgICAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICAgICAgICByZXN0b3JlQmFzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgc3luY0Nzc1RleHQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRleHROb2RlKSB7CiAgICAgICAgICB0aGlzLnRleHROb2RlLm5vZGVWYWx1ZSA9IHRoaXMuY3NzVGV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuY3NzVGV4dDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN0YXJ0VXNlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuaW5Vc2UpIHsKICAgICAgICAgIGlmICghdGhpcy5yZXNvdXJjZSkgewogICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBnZXRSZXNvdXJjZSh0aGlzLnVybCk7CiAgICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTsKICAgICAgICAgICAgdGhpcy5jc3NUZXh0ID0gcmVzb3VyY2UuZ2V0KHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShpbmplY3RTdHlsZVRvSGVhZCwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5Vc2UgKz0gMTsKICAgICAgfSwKICAgICAgc3RvcFVzZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaW5Vc2UpIHsKICAgICAgICAgIHRoaXMuaW5Vc2UgLT0gMTsKICAgICAgICAgIGlmICghdGhpcy5pblVzZSAmJiB0aGlzLmVsZW1lbnQpIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZSh0aGlzLmVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuZWxlbWVudCAmJiBjbGVhbnVwRG9tKSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMudGV4dE5vZGUgPSBudWxsOwogICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIHRoaXMuY3NzVGV4dCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgQ3NzUmVzb3VyY2UucmVzb3VyY2VzID0gY3NzUmVzb3VyY2VzOwogICAgcmV0dXJuIENzc1Jlc291cmNlOwogIH0oKTsKICB2YXIgYmFzaXMgPSBnZXROYW1lc3BhY2UoImJhc2lzIikuZXh0ZW5kKHsKICAgIGZpbGVuYW1lXzogYmFzaXNGaWxlbmFtZSwKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBOT0RFX0VOVjogTk9ERV9FTlYsCiAgICBjb25maWc6IGNvbmZpZywKICAgIHBsYXRmb3JtRmVhdHVyZToge30sCiAgICByZXNvbHZlTlNGaWxlbmFtZTogcmVzb2x2ZU5TRmlsZW5hbWUsCiAgICBwYXRjaDogcGF0Y2gsCiAgICBuYW1lc3BhY2U6IGdldE5hbWVzcGFjZSwKICAgIHJlcXVpcmU6IHJlcXVpcmVOYW1lc3BhY2UsCiAgICByZXNvdXJjZTogZ2V0UmVzb3VyY2UsCiAgICBhc3NldDogZnVuY3Rpb24odXJsKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9LAogICAgc2V0SW1tZWRpYXRlOiBzZXRJbW1lZGlhdGUsCiAgICBjbGVhckltbWVkaWF0ZTogY2xlYXJJbW1lZGlhdGUsCiAgICBuZXh0VGljazogZnVuY3Rpb24oKSB7CiAgICAgIHNldEltbWVkaWF0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSwKICAgIENsYXNzOiBDbGFzcywKICAgIFRva2VuOiBUb2tlbiwKICAgIERlZmVycmVkVG9rZW46IERlZmVycmVkVG9rZW4sCiAgICBnZXR0ZXI6IGdldHRlciwKICAgIHJlYWR5OiByZWFkeSwKICAgIGNsZWFuZXI6IGNsZWFuZXIsCiAgICBjb25zb2xlOiBjb25zb2xlTWV0aG9kcywKICAgIHBhdGg6IHBhdGhVdGlscywKICAgIGRvYzogZG9jdW1lbnRJbnRlcmZhY2UsCiAgICBvYmplY3Q6IHsKICAgICAgZXh0ZW5kOiBleHRlbmQsCiAgICAgIGNvbXBsZXRlOiBjb21wbGV0ZSwKICAgICAga2V5czoga2V5cywKICAgICAgdmFsdWVzOiB2YWx1ZXMsCiAgICAgIHNsaWNlOiBzbGljZSwKICAgICAgc3BsaWNlOiBzcGxpY2UsCiAgICAgIG1lcmdlOiBtZXJnZSwKICAgICAgaXRlcmF0ZTogaXRlcmF0ZQogICAgfSwKICAgIGZuOiB7CiAgICAgICR1bmRlZmluZWQ6ICR1bmRlZmluZWQsCiAgICAgICRkZWZpbmVkOiAkZGVmaW5lZCwKICAgICAgJGlzTnVsbDogJGlzTnVsbCwKICAgICAgJGlzTm90TnVsbDogJGlzTm90TnVsbCwKICAgICAgJGlzU2FtZTogJGlzU2FtZSwKICAgICAgJGlzTm90U2FtZTogJGlzTm90U2FtZSwKICAgICAgJHNlbGY6ICRzZWxmLAogICAgICAkY29uc3Q6ICRjb25zdCwKICAgICAgJGZhbHNlOiAkZmFsc2UsCiAgICAgICR0cnVlOiAkdHJ1ZSwKICAgICAgJG51bGw6ICRudWxsLAogICAgICAkdW5kZWY6ICR1bmRlZiwKICAgICAgZ2V0dGVyOiBnZXR0ZXIsCiAgICAgIG51bGxHZXR0ZXI6IG51bGxHZXR0ZXIsCiAgICAgIHdyYXBwZXI6IHdyYXBwZXIsCiAgICAgIGxhenlJbml0OiBsYXp5SW5pdCwKICAgICAgbGF6eUluaXRBbmRSdW46IGxhenlJbml0QW5kUnVuLAogICAgICBydW5PbmNlOiBydW5PbmNlCiAgICB9LAogICAgYXJyYXk6IGV4dGVuZChhcnJheUZyb20sIG1lcmdlKEFycmF5X2V4dGVuc2lvbnMsIHsKICAgICAgZnJvbTogYXJyYXlGcm9tLAogICAgICBjcmVhdGU6IGNyZWF0ZUFycmF5CiAgICB9KSksCiAgICBzdHJpbmc6IG1lcmdlKFN0cmluZ19leHRlbnNpb25zLCB7CiAgICAgIGlzRW1wdHk6IGlzRW1wdHlTdHJpbmcsCiAgICAgIGlzTm90RW1wdHk6IGlzTm90RW1wdHlTdHJpbmcKICAgIH0pLAogICAgbnVtYmVyOiBOdW1iZXJfZXh0ZW5zaW9ucywKICAgIGJvb2w6IHsKICAgICAgaW52ZXJ0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICBqc29uOiB7CiAgICAgIHBhcnNlOiB0eXBlb2YgSlNPTiAhPSAidW5kZWZpbmVkIiA/IEpTT04ucGFyc2UgOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nX2V4dGVuc2lvbnMudG9PYmplY3Qoc3RyLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIGdldE5hbWVzcGFjZSgiYmFzaXMuZGV2IikuZXh0ZW5kKGNvbnNvbGVNZXRob2RzKTsKICBpZiAoY29uZmlnLmF1dG9sb2FkKSByZXF1aXJlTmFtZXNwYWNlKGNvbmZpZy5hdXRvbG9hZCk7Cn0pKHRoaXMpOwp9KS5jYWxsKHRoaXMpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:10:58 GMT",
                    "Content-Length": "551383",
                    "Date": "Thu, 06 Nov 2014 12:11:04 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}