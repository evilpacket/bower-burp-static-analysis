{
    "url": "http://localhost:9999/theshock/atomjs/Tests/lib/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.search</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var testName = decodeURIComponent(location.search.slice(1));</li><li>banner.innerHTML = '&lt;a href=\"' + mainPageLocation + '\"&gt;' + banner.innerHTML + '&lt;/a&gt; &amp;#8250; &lt;a href=\"\"&gt;' + testName + '&lt;/a&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/theshock/atomjs/Tests/lib/qunit.js",
                "path": "/theshock/atomjs/Tests/lib/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC90aGVzaG9jay9hdG9tanMvVGVzdHMvbGliL3F1bml0LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzc3OTENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTM6NDg6MzYgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEzOjQ4OjMyIEdNVA0KDQovKg0KICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yaw0KICoNCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vUVVuaXQNCiAqDQogKiBDb3B5cmlnaHQgKGMpIDIwMTEgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyDQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkNCiAqIG9yIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4NCiAqLw0KDQooZnVuY3Rpb24od2luZG93KSB7DQoNCnZhciBkZWZpbmVkID0gew0KCXNldFRpbWVvdXQ6IHR5cGVvZiB3aW5kb3cuc2V0VGltZW91dCAhPT0gInVuZGVmaW5lZCIsDQoJc2Vzc2lvblN0b3JhZ2U6IChmdW5jdGlvbigpIHsNCgkJdHJ5IHsNCgkJCXJldHVybiAhIXNlc3Npb25TdG9yYWdlLmdldEl0ZW07DQoJCX0gY2F0Y2goZSl7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCiAgfSkoKQ0KfQ0KDQp2YXIgdGVzdElkID0gMDsNCg0KdmFyIFRlc3QgPSBmdW5jdGlvbihuYW1lLCB0ZXN0TmFtZSwgZXhwZWN0ZWQsIHRlc3RFbnZpcm9ubWVudEFyZywgYXN5bmMsIGNhbGxiYWNrKSB7DQoJdGhpcy5uYW1lID0gbmFtZTsNCgl0aGlzLnRlc3ROYW1lID0gdGVzdE5hbWU7DQoJdGhpcy5leHBlY3RlZCA9IGV4cGVjdGVkOw0KCXRoaXMudGVzdEVudmlyb25tZW50QXJnID0gdGVzdEVudmlyb25tZW50QXJnOw0KCXRoaXMuYXN5bmMgPSBhc3luYzsNCgl0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7DQoJdGhpcy5hc3NlcnRpb25zID0gW107DQp9Ow0KVGVzdC5wcm90b3R5cGUgPSB7DQoJaW5pdDogZnVuY3Rpb24oKSB7DQoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOw0KCQlpZiAodGVzdHMpIHsNCgkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7DQoJCQkJYi5pbm5lckhUTUwgPSAiUnVubmluZyAiICsgdGhpcy5uYW1lOw0KCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOw0KCQkJCWxpLmlkID0gdGhpcy5pZCA9ICJ0ZXN0LW91dHB1dCIgKyB0ZXN0SWQrKzsNCgkJCXRlc3RzLmFwcGVuZENoaWxkKCBsaSApOw0KCQl9DQoJfSwNCglzZXR1cDogZnVuY3Rpb24oKSB7DQoJCWlmICh0aGlzLm1vZHVsZSAhPSBjb25maWcucHJldmlvdXNNb2R1bGUpIHsNCgkJCWlmICggdGhpcy5wcmV2aW91c01vZHVsZSApIHsNCgkJCQlRVW5pdC5tb2R1bGVEb25lKCB0aGlzLm1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOw0KCQkJfQ0KCQkJY29uZmlnLnByZXZpb3VzTW9kdWxlID0gdGhpcy5tb2R1bGU7DQoJCQljb25maWcubW9kdWxlU3RhdHMgPSB7IGFsbDogMCwgYmFkOiAwIH07DQoJCQlRVW5pdC5tb2R1bGVTdGFydCggdGhpcy5tb2R1bGUsIHRoaXMubW9kdWxlVGVzdEVudmlyb25tZW50ICk7DQoJCX0NCg0KCQljb25maWcuY3VycmVudCA9IHRoaXM7DQoJCXRoaXMudGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsNCgkJCXNldHVwOiBmdW5jdGlvbigpIHt9LA0KCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkge30NCgkJfSwgdGhpcy5tb2R1bGVUZXN0RW52aXJvbm1lbnQpOw0KCQlpZiAodGhpcy50ZXN0RW52aXJvbm1lbnRBcmcpIHsNCgkJCWV4dGVuZCh0aGlzLnRlc3RFbnZpcm9ubWVudCwgdGhpcy50ZXN0RW52aXJvbm1lbnRBcmcpOw0KCQl9DQoNCgkJUVVuaXQudGVzdFN0YXJ0KCB0aGlzLnRlc3ROYW1lLCB0aGlzLnRlc3RFbnZpcm9ubWVudCApOw0KDQoJCS8vIGFsbG93IHV0aWxpdHkgZnVuY3Rpb25zIHRvIGFjY2VzcyB0aGUgY3VycmVudCB0ZXN0IGVudmlyb25tZW50DQoJCS8vIFRPRE8gd2h5Pz8NCgkJUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0aGlzLnRlc3RFbnZpcm9ubWVudDsNCg0KCQl0cnkgew0KCQkJaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsNCgkJCQlzYXZlR2xvYmFsKCk7DQoJCQl9DQoNCgkJCXRoaXMudGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOw0KCQl9IGNhdGNoKGUpIHsNCgkJCS8vIFRPRE8gdXNlIHRlc3ROYW1lIGluc3RlYWQgb2YgbmFtZSBmb3Igbm8tbWFya3VwIG1lc3NhZ2U/DQoJCQlRVW5pdC5vayggZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIHRoaXMubmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsNCgkJfQ0KCX0sDQoJcnVuOiBmdW5jdGlvbigpIHsNCgkJaWYgKCB0aGlzLmFzeW5jICkgew0KCQkJUVVuaXQuc3RvcCgpOw0KCQl9DQoNCgkJdHJ5IHsNCgkJCXRoaXMuY2FsbGJhY2suY2FsbCh0aGlzLnRlc3RFbnZpcm9ubWVudCk7DQoJCX0gY2F0Y2goZSkgew0KCQkJLy8gVE9ETyB1c2UgdGVzdE5hbWUgaW5zdGVhZCBvZiBuYW1lIGZvciBuby1tYXJrdXAgbWVzc2FnZT8NCgkJCWZhaWwoIlRlc3QgIiArIHRoaXMubmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCB0aGlzLmNhbGxiYWNrKTsNCgkJCVFVbml0Lm9rKCBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArICh0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiOiAiICsgZS5tZXNzYWdlICsgIiAtICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZSkpOw0KCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkNCgkJCXNhdmVHbG9iYWwoKTsNCg0KCQkJLy8gUmVzdGFydCB0aGUgdGVzdHMgaWYgdGhleSdyZSBibG9ja2luZw0KCQkJaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7DQoJCQkJc3RhcnQoKTsNCgkJCX0NCgkJfQ0KCX0sDQoJdGVhcmRvd246IGZ1bmN0aW9uKCkgew0KCQl0cnkgew0KCQkJY2hlY2tQb2xsdXRpb24oKTsNCgkJCXRoaXMudGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOw0KCQl9IGNhdGNoKGUpIHsNCgkJCS8vIFRPRE8gdXNlIHRlc3ROYW1lIGluc3RlYWQgb2YgbmFtZSBmb3Igbm8tbWFya3VwIG1lc3NhZ2U/DQoJCQlRVW5pdC5vayggZmFsc2UsICJUZWFyZG93biBmYWlsZWQgb24gIiArIHRoaXMubmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsNCgkJfQ0KCX0sDQoJZmluaXNoOiBmdW5jdGlvbigpIHsNCgkJaWYgKCB0aGlzLmV4cGVjdGVkICYmIHRoaXMuZXhwZWN0ZWQgIT0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aCApIHsNCgkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyB0aGlzLmV4cGVjdGVkICsgIiBhc3NlcnRpb25zLCBidXQgIiArIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOw0KCQl9DQoNCgkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwLA0KCQkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsNCg0KCQljb25maWcuc3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7DQoJCWNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKz0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsNCg0KCQlpZiAoIHRlc3RzICkgew0KCQkJdmFyIG9sICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7DQoNCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsNCgkJCQl2YXIgYXNzZXJ0aW9uID0gdGhpcy5hc3NlcnRpb25zW2ldOw0KDQoJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCgkJCQlsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOw0KCQkJCWxpLmlubmVySFRNTCA9ICc8cHJlPicgKyAoYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgKGFzc2VydGlvbi5yZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIikpICsgJzwvcHJlPic7DQoJCQkJb2wuYXBwZW5kQ2hpbGQoIGxpICk7DQoNCgkJCQlpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7DQoJCQkJCWdvb2QrKzsNCgkJCQl9IGVsc2Ugew0KCQkJCQliYWQrKzsNCgkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOw0KCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBzdG9yZSByZXN1bHQgd2hlbiBwb3NzaWJsZQ0KCQkJZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCJxdW5pdC0iICsgdGhpcy50ZXN0TmFtZSwgYmFkKTsNCg0KCQkJaWYgKGJhZCA9PSAwKSB7DQoJCQkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCgkJCX0NCg0KCQkJdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsNCgkJCWIuaW5uZXJIVE1MID0gdGhpcy5uYW1lICsgIiA8YiBjbGFzcz0nY291bnRzJz4oPGIgY2xhc3M9J2ZhaWxlZCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzc2VkJz4iICsgZ29vZCArICI8L2I+LCAiICsgdGhpcy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiI7DQoNCgkJCWFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgew0KCQkJCXZhciBuZXh0ID0gYi5uZXh0U2libGluZywgZGlzcGxheSA9IG5leHQuc3R5bGUuZGlzcGxheTsNCgkJCQluZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOw0KCQkJfSk7DQoNCgkJCWFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKGUpIHsNCgkJCQl2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7DQoJCQkJaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAic3BhbiIgfHwgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImIiICkgew0KCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsNCgkJCQl9DQoJCQkJaWYgKCB3aW5kb3cubG9jYXRpb24gJiYgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgew0KCQkJCQl3aW5kb3cubG9jYXRpb24uc2VhcmNoID0gIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KGdldFRleHQoW3RhcmdldF0pLnJlcGxhY2UoL1woLitcKSQvLCAiIikucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpKTsNCgkJCQl9DQoJCQl9KTsNCg0KCQkJdmFyIGxpID0gaWQodGhpcy5pZCk7DQoJCQlsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7DQoJCQlsaS5zdHlsZS5kaXNwbGF5ID0gcmVzdWx0RGlzcGxheVN0eWxlKCFiYWQpOw0KCQkJbGkucmVtb3ZlQ2hpbGQoIGxpLmZpcnN0Q2hpbGQgKTsNCgkJCWxpLmFwcGVuZENoaWxkKCBiICk7DQoJCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsNCg0KCQkJaWYgKCBiYWQgKSB7DQoJCQkJdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7DQoJCQkJaWYgKCB0b29sYmFyICkgew0KCQkJCQl0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KCQkJCQlpZCgicXVuaXQtZmlsdGVyLXBhc3MiKS5kaXNhYmxlZCA9IG51bGw7DQoJCQkJfQ0KCQkJfQ0KDQoJCX0gZWxzZSB7DQoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7DQoJCQkJaWYgKCAhdGhpcy5hc3NlcnRpb25zW2ldLnJlc3VsdCApIHsNCgkJCQkJYmFkKys7DQoJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsNCgkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXRyeSB7DQoJCQlRVW5pdC5yZXNldCgpOw0KCQl9IGNhdGNoKGUpIHsNCgkJCS8vIFRPRE8gdXNlIHRlc3ROYW1lIGluc3RlYWQgb2YgbmFtZSBmb3Igbm8tbWFya3VwIG1lc3NhZ2U/DQoJCQlmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIHRoaXMubmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIFFVbml0LnJlc2V0KTsNCgkJfQ0KDQoJCVFVbml0LnRlc3REb25lKCB0aGlzLnRlc3ROYW1lLCBiYWQsIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKTsNCgl9LA0KDQoJcXVldWU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGVzdCA9IHRoaXM7DQoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgew0KCQkJdGVzdC5pbml0KCk7DQoJCX0pOw0KCQlmdW5jdGlvbiBydW4oKSB7DQoJCQkvLyBlYWNoIG9mIHRoZXNlIGNhbiBieSBhc3luYw0KCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7DQoJCQkJdGVzdC5zZXR1cCgpOw0KCQkJfSk7DQoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCQl0ZXN0LnJ1bigpOw0KCQkJfSk7DQoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCQl0ZXN0LnRlYXJkb3duKCk7DQoJCQl9KTsNCgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgew0KCQkJCXRlc3QuZmluaXNoKCk7DQoJCQl9KTsNCgkJfQ0KCQkvLyBkZWZlciB3aGVuIHByZXZpb3VzIHRlc3QgcnVuIHBhc3NlZCwgaWYgc3RvcmFnZSBpcyBhdmFpbGFibGUNCgkJdmFyIGJhZCA9IGRlZmluZWQuc2Vzc2lvblN0b3JhZ2UgJiYgK3Nlc3Npb25TdG9yYWdlLmdldEl0ZW0oInF1bml0LSIgKyB0aGlzLnRlc3ROYW1lKTsNCgkJaWYgKGJhZCkgew0KCQkJcnVuKCk7DQoJCX0gZWxzZSB7DQoJCQlzeW5jaHJvbml6ZShydW4pOw0KCQl9Ow0KCX0NCg0KfQ0KDQp2YXIgUVVuaXQgPSB7DQoNCgkvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMNCgltb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgew0KCQljb25maWcucHJldmlvdXNNb2R1bGUgPSBjb25maWcuY3VycmVudE1vZHVsZTsNCgkJY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOw0KCQljb25maWcuY3VycmVudE1vZHVsZVRlc3RFbnZpcm9tZW50ID0gdGVzdEVudmlyb25tZW50Ow0KCX0sDQoNCglhc3luY1Rlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2spIHsNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgew0KCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsNCgkJCWV4cGVjdGVkID0gMDsNCgkJfQ0KDQoJCVFVbml0LnRlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSk7DQoJfSwNCg0KCXRlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIGFzeW5jKSB7DQoJCXZhciBuYW1lID0gJzxzcGFuIGNsYXNzPSJ0ZXN0LW5hbWUiPicgKyB0ZXN0TmFtZSArICc8L3NwYW4+JywgdGVzdEVudmlyb25tZW50QXJnOw0KDQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsNCgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IG51bGw7DQoJCX0NCgkJLy8gaXMgMm5kIGFyZ3VtZW50IGEgdGVzdEVudmlyb25tZW50Pw0KCQlpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsNCgkJCXRlc3RFbnZpcm9ubWVudEFyZyA9ICBleHBlY3RlZDsNCgkJCWV4cGVjdGVkID0gbnVsbDsNCgkJfQ0KDQoJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7DQoJCQluYW1lID0gJzxzcGFuIGNsYXNzPSJtb2R1bGUtbmFtZSI+JyArIGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjwvc3Bhbj46ICIgKyBuYW1lOw0KCQl9DQoNCgkJaWYgKCAhdmFsaWRUZXN0KGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjogIiArIHRlc3ROYW1lKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXZhciB0ZXN0ID0gbmV3IFRlc3QobmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjayk7DQoJCXRlc3QucHJldmlvdXNNb2R1bGUgPSBjb25maWcucHJldmlvdXNNb2R1bGU7DQoJCXRlc3QubW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7DQoJCXRlc3QubW9kdWxlVGVzdEVudmlyb25tZW50ID0gY29uZmlnLmN1cnJlbnRNb2R1bGVUZXN0RW52aXJvbWVudDsNCgkJdGVzdC5xdWV1ZSgpOw0KCX0sDQoNCgkvKioNCgkgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guDQoJICovDQoJZXhwZWN0OiBmdW5jdGlvbihhc3NlcnRzKSB7DQoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkID0gYXNzZXJ0czsNCgl9LA0KDQoJLyoqDQoJICogQXNzZXJ0cyB0cnVlLg0KCSAqIEBleGFtcGxlIG9rKCAiYXNkZmFzZGYiLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnMiICk7DQoJICovDQoJb2s6IGZ1bmN0aW9uKGEsIG1zZykgew0KCQlhID0gISFhOw0KCQl2YXIgZGV0YWlscyA9IHsNCgkJCXJlc3VsdDogYSwNCgkJCW1lc3NhZ2U6IG1zZw0KCQl9Ow0KCQltc2cgPSBlc2NhcGVIdG1sKG1zZyk7DQoJCVFVbml0LmxvZyhhLCBtc2csIGRldGFpbHMpOw0KCQljb25maWcuY3VycmVudC5hc3NlcnRpb25zLnB1c2goew0KCQkJcmVzdWx0OiBhLA0KCQkJbWVzc2FnZTogbXNnDQoJCX0pOw0KCX0sDQoNCgkvKioNCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4NCgkgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuDQoJICoNCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkNCgkgKg0KCSAqIEBleGFtcGxlIGVxdWFsKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOw0KCSAqDQoJICogQHBhcmFtIE9iamVjdCBhY3R1YWwNCgkgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkDQoJICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkNCgkgKi8NCgllcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlRVW5pdC5wdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCg0KCW5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCVFVbml0LnB1c2goZXhwZWN0ZWQgIT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJZGVlcEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCVFVbml0LnB1c2goUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglub3REZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJUVVuaXQucHVzaCghUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglzdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlRVW5pdC5wdXNoKGV4cGVjdGVkID09PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglub3RTdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlRVW5pdC5wdXNoKGV4cGVjdGVkICE9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglyYWlzZXM6IGZ1bmN0aW9uKGJsb2NrLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQl2YXIgYWN0dWFsLCBvayA9IGZhbHNlOw0KDQoJCWlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnKSB7DQoJCQltZXNzYWdlID0gZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IG51bGw7DQoJCX0NCg0KCQl0cnkgew0KCQkJYmxvY2soKTsNCgkJfSBjYXRjaCAoZSkgew0KCQkJYWN0dWFsID0gZTsNCgkJfQ0KDQoJCWlmIChhY3R1YWwpIHsNCgkJCS8vIHdlIGRvbid0IHdhbnQgdG8gdmFsaWRhdGUgdGhyb3duIGVycm9yDQoJCQlpZiAoIWV4cGVjdGVkKSB7DQoJCQkJb2sgPSB0cnVlOw0KCQkJLy8gZXhwZWN0ZWQgaXMgYSByZWdleHANCgkJCX0gZWxzZSBpZiAoUVVuaXQub2JqZWN0VHlwZShleHBlY3RlZCkgPT09ICJyZWdleHAiKSB7DQoJCQkJb2sgPSBleHBlY3RlZC50ZXN0KGFjdHVhbCk7DQoJCQkvLyBleHBlY3RlZCBpcyBhIGNvbnN0cnVjdG9yDQoJCQl9IGVsc2UgaWYgKGFjdHVhbCBpbnN0YW5jZW9mIGV4cGVjdGVkKSB7DQoJCQkJb2sgPSB0cnVlOw0KCQkJLy8gZXhwZWN0ZWQgaXMgYSB2YWxpZGF0aW9uIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgdHJ1ZSBpcyB2YWxpZGF0aW9uIHBhc3NlZA0KCQkJfSBlbHNlIGlmIChleHBlY3RlZC5jYWxsKHt9LCBhY3R1YWwpID09PSB0cnVlKSB7DQoJCQkJb2sgPSB0cnVlOw0KCQkJfQ0KCQl9DQoNCgkJUVVuaXQub2sob2ssIG1lc3NhZ2UpOw0KCX0sDQoNCglzdGFydDogZnVuY3Rpb24oKSB7DQoJCWNvbmZpZy5zZW1hcGhvcmUtLTsNCgkJaWYgKGNvbmZpZy5zZW1hcGhvcmUgPiAwKSB7DQoJCQkvLyBkb24ndCBzdGFydCB1bnRpbCBlcXVhbCBudW1iZXIgb2Ygc3RvcC1jYWxscw0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmIChjb25maWcuc2VtYXBob3JlIDwgMCkgew0KCQkJLy8gaWdub3JlIGlmIHN0YXJ0IGlzIGNhbGxlZCBtb3JlIG9mdGVuIHRoZW4gc3RvcA0KCQkJY29uZmlnLnNlbWFwaG9yZSA9IDA7DQoJCX0NCgkJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcw0KCQlpZiAoIGRlZmluZWQuc2V0VGltZW91dCApIHsNCgkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KCQkJCWlmICggY29uZmlnLnRpbWVvdXQgKSB7DQoJCQkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7DQoJCQkJfQ0KDQoJCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoJCQkJcHJvY2VzcygpOw0KCQkJfSwgMTMpOw0KCQl9IGVsc2Ugew0KCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoJCQlwcm9jZXNzKCk7DQoJCX0NCgl9LA0KDQoJc3RvcDogZnVuY3Rpb24odGltZW91dCkgew0KCQljb25maWcuc2VtYXBob3JlKys7DQoJCWNvbmZpZy5ibG9ja2luZyA9IHRydWU7DQoNCgkJaWYgKCB0aW1lb3V0ICYmIGRlZmluZWQuc2V0VGltZW91dCApIHsNCgkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7DQoJCQljb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOw0KCQkJCVFVbml0LnN0YXJ0KCk7DQoJCQl9LCB0aW1lb3V0KTsNCgkJfQ0KCX0NCg0KfTsNCg0KLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGRlcHJlY2F0ZWQNClFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOw0KUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsNCg0KLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUNCnZhciBjb25maWcgPSB7DQoJLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bg0KCXF1ZXVlOiBbXSwNCg0KCS8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5DQoJYmxvY2tpbmc6IHRydWUNCn07DQoNCi8vIExvYWQgcGFyYW1hdGVycw0KKGZ1bmN0aW9uKCkgew0KCXZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDogIiIsIHByb3RvY29sOiAiZmlsZToiIH0sDQoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOw0KDQoJZm9yICggdmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrICkgew0KCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOw0KCQlpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vZ2xvYmFscyIgKSB7DQoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7DQoJCQlpLS07DQoJCQljb25maWcubm9nbG9iYWxzID0gdHJ1ZTsNCgkJfSBlbHNlIGlmICggR0VUUGFyYW1zW2ldLnNlYXJjaCgnPScpID4gLTEgKSB7DQoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7DQoJCQlpLS07DQoJCX0NCgl9DQoNCgkvLyByZXN0cmljdCBtb2R1bGVzL3Rlc3RzIGJ5IGdldCBwYXJhbWV0ZXJzDQoJY29uZmlnLmZpbHRlcnMgPSBHRVRQYXJhbXM7DQoNCgkvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90DQoJUVVuaXQuaXNMb2NhbCA9ICEhKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKTsNCn0pKCk7DQoNCi8vIEV4cG9zZSB0aGUgQVBJIGFzIGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycNCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMNCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsNCglleHRlbmQod2luZG93LCBRVW5pdCk7DQoJd2luZG93LlFVbml0ID0gUVVuaXQ7DQp9IGVsc2Ugew0KCWV4dGVuZChleHBvcnRzLCBRVW5pdCk7DQoJZXhwb3J0cy5RVW5pdCA9IFFVbml0Ow0KfQ0KDQovLyBkZWZpbmUgdGhlc2UgYWZ0ZXIgZXhwb3NpbmcgZ2xvYmFscyB0byBrZWVwIHRoZW0gaW4gdGhlc2UgUVVuaXQgbmFtZXNwYWNlIG9ubHkNCmV4dGVuZChRVW5pdCwgew0KCWNvbmZpZzogY29uZmlnLA0KDQoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiBvcHRpb25zDQoJaW5pdDogZnVuY3Rpb24oKSB7DQoJCWV4dGVuZChjb25maWcsIHsNCgkJCXN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sDQoJCQltb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LA0KCQkJc3RhcnRlZDogK25ldyBEYXRlLA0KCQkJdXBkYXRlUmF0ZTogMTAwMCwNCgkJCWJsb2NraW5nOiBmYWxzZSwNCgkJCWF1dG9zdGFydDogdHJ1ZSwNCgkJCWF1dG9ydW46IGZhbHNlLA0KCQkJZmlsdGVyczogW10sDQoJCQlxdWV1ZTogW10sDQoJCQlzZW1hcGhvcmU6IDANCgkJfSk7DQoNCgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksDQoJCQliYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksDQoJCQlyZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOw0KDQoJCWlmICggdGVzdHMgKSB7DQoJCQl0ZXN0cy5pbm5lckhUTUwgPSAiIjsNCgkJfQ0KDQoJCWlmICggYmFubmVyICkgew0KCQkJYmFubmVyLmNsYXNzTmFtZSA9ICIiOw0KCQl9DQoNCgkJaWYgKCByZXN1bHQgKSB7DQoJCQlyZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmVzdWx0ICk7DQoJCX0NCgl9LA0KDQoJLyoqDQoJICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uDQoJICoNCgkgKiBJZiBqUXVlcnkgaXMgYXZhaWxhYmxlLCB1c2VzIGpRdWVyeSdzIGh0bWwoKSwgb3RoZXJ3aXNlIGp1c3QgaW5uZXJIVE1MLg0KCSAqLw0KCXJlc2V0OiBmdW5jdGlvbigpIHsNCgkJaWYgKCB3aW5kb3cualF1ZXJ5ICkgew0KCQkJalF1ZXJ5KCAiI21haW4sICNxdW5pdC1maXh0dXJlIiApLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7DQoJCX0gZWxzZSB7DQoJCQl2YXIgbWFpbiA9IGlkKCAnbWFpbicgKSB8fCBpZCggJ3F1bml0LWZpeHR1cmUnICk7DQoJCQlpZiAoIG1haW4gKSB7DQoJCQkJbWFpbi5pbm5lckhUTUwgPSBjb25maWcuZml4dHVyZTsNCgkJCX0NCgkJfQ0KCX0sDQoNCgkvKioNCgkgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuDQoJICoNCgkgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsNCgkgKg0KCSAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0NCgkgKiBAcGFyYW0gU3RyaW5nIHR5cGUNCgkgKi8NCgl0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsNCgkJaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudCApIHsNCgkJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7DQoJCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsDQoJCQkJMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOw0KCQkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOw0KDQoJCX0gZWxzZSBpZiAoIGVsZW0uZmlyZUV2ZW50ICkgew0KCQkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsNCgkJfQ0KCX0sDQoNCgkvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nDQoJaXM6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7DQoJCXJldHVybiBRVW5pdC5vYmplY3RUeXBlKCBvYmogKSA9PSB0eXBlOw0KCX0sDQoNCglvYmplY3RUeXBlOiBmdW5jdGlvbiggb2JqICkgew0KCQlpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsNCgkJCQlyZXR1cm4gInVuZGVmaW5lZCI7DQoNCgkJLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QNCgkJfQ0KCQlpZiAob2JqID09PSBudWxsKSB7DQoJCQkJcmV0dXJuICJudWxsIjsNCgkJfQ0KDQoJCXZhciB0eXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBvYmogKQ0KCQkJLm1hdGNoKC9eXFtvYmplY3RccyguKilcXSQvKVsxXSB8fCAnJzsNCg0KCQlzd2l0Y2ggKHR5cGUpIHsNCgkJCQljYXNlICdOdW1iZXInOg0KCQkJCQkJaWYgKGlzTmFOKG9iaikpIHsNCgkJCQkJCQkJcmV0dXJuICJuYW4iOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkJcmV0dXJuICJudW1iZXIiOw0KCQkJCQkJfQ0KCQkJCWNhc2UgJ1N0cmluZyc6DQoJCQkJY2FzZSAnQm9vbGVhbic6DQoJCQkJY2FzZSAnQXJyYXknOg0KCQkJCWNhc2UgJ0RhdGUnOg0KCQkJCWNhc2UgJ1JlZ0V4cCc6DQoJCQkJY2FzZSAnRnVuY3Rpb24nOg0KCQkJCQkJcmV0dXJuIHR5cGUudG9Mb3dlckNhc2UoKTsNCgkJfQ0KCQlpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIpIHsNCgkJCQlyZXR1cm4gIm9iamVjdCI7DQoJCX0NCgkJcmV0dXJuIHVuZGVmaW5lZDsNCgl9LA0KDQoJcHVzaDogZnVuY3Rpb24ocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCXZhciBkZXRhaWxzID0gew0KCQkJcmVzdWx0OiByZXN1bHQsDQoJCQltZXNzYWdlOiBtZXNzYWdlLA0KCQkJYWN0dWFsOiBhY3R1YWwsDQoJCQlleHBlY3RlZDogZXhwZWN0ZWQNCgkJfTsNCg0KCQltZXNzYWdlID0gZXNjYXBlSHRtbChtZXNzYWdlKSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOw0KCQltZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJ0ZXN0LW1lc3NhZ2UiPicgKyBtZXNzYWdlICsgIjwvc3Bhbj4iOw0KCQlleHBlY3RlZCA9IGVzY2FwZUh0bWwoUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSk7DQoJCWFjdHVhbCA9IGVzY2FwZUh0bWwoUVVuaXQuanNEdW1wLnBhcnNlKGFjdHVhbCkpOw0KCQl2YXIgb3V0cHV0ID0gbWVzc2FnZSArICc8dGFibGU+PHRyIGNsYXNzPSJ0ZXN0LWV4cGVjdGVkIj48dGg+RXhwZWN0ZWQ6IDwvdGg+PHRkPjxwcmU+JyArIGV4cGVjdGVkICsgJzwvcHJlPjwvdGQ+PC90cj4nOw0KCQlpZiAoYWN0dWFsICE9IGV4cGVjdGVkKSB7DQoJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1hY3R1YWwiPjx0aD5SZXN1bHQ6IDwvdGg+PHRkPjxwcmU+JyArIGFjdHVhbCArICc8L3ByZT48L3RkPjwvdHI+JzsNCgkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LWRpZmYiPjx0aD5EaWZmOiA8L3RoPjx0ZD48cHJlPicgKyBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpICsnPC9wcmU+PC90ZD48L3RyPic7DQoJCX0NCgkJaWYgKCFyZXN1bHQpIHsNCgkJCXZhciBzb3VyY2UgPSBzb3VyY2VGcm9tU3RhY2t0cmFjZSgpOw0KCQkJaWYgKHNvdXJjZSkgew0KCQkJCWRldGFpbHMuc291cmNlID0gc291cmNlOw0KCQkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LXNvdXJjZSI+PHRoPlNvdXJjZTogPC90aD48dGQ+PHByZT4nICsgc291cmNlICsnPC9wcmU+PC90ZD48L3RyPic7DQoJCQl9DQoJCX0NCgkJb3V0cHV0ICs9ICI8L3RhYmxlPiI7DQoNCgkJUVVuaXQubG9nKHJlc3VsdCwgbWVzc2FnZSwgZGV0YWlscyk7DQoNCgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsNCgkJCXJlc3VsdDogISFyZXN1bHQsDQoJCQltZXNzYWdlOiBvdXRwdXQNCgkJfSk7DQoJfSwNCg0KCS8vIExvZ2dpbmcgY2FsbGJhY2tzDQoJYmVnaW46IGZ1bmN0aW9uKCkge30sDQoJZG9uZTogZnVuY3Rpb24oZmFpbHVyZXMsIHRvdGFsKSB7fSwNCglsb2c6IGZ1bmN0aW9uKHJlc3VsdCwgbWVzc2FnZSkge30sDQoJdGVzdFN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LA0KCXRlc3REb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9LA0KCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LA0KCW1vZHVsZURvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30NCn0pOw0KDQppZiAoIHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsNCgljb25maWcuYXV0b3J1biA9IHRydWU7DQp9DQoNCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsNCglRVW5pdC5iZWdpbigpOw0KDQoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQ0KCXZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7DQoJUVVuaXQuaW5pdCgpOw0KCWV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7DQoNCgljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsNCg0KCXZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7DQoJaWYgKCB1c2VyQWdlbnQgKSB7DQoJCXVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50Ow0KCX0NCgl2YXIgYmFubmVyID0gaWQoInF1bml0LWhlYWRlciIpOw0KCWlmICggYmFubmVyICkgew0KCQl2YXIgcGFyYW1zSW5kZXggPSBsb2NhdGlvbi5ocmVmLmxhc3RJbmRleE9mKGxvY2F0aW9uLnNlYXJjaCk7DQoJCWlmICggcGFyYW1zSW5kZXggPiAtMSApIHsNCgkJCXZhciBtYWluUGFnZUxvY2F0aW9uID0gbG9jYXRpb24uaHJlZi5zbGljZSgwLCBwYXJhbXNJbmRleCk7DQoJCQlpZiAoIG1haW5QYWdlTG9jYXRpb24gPT0gbG9jYXRpb24uaHJlZiApIHsNCgkJCQliYW5uZXIuaW5uZXJIVE1MID0gJzxhIGhyZWY9IiI+ICcgKyBiYW5uZXIuaW5uZXJIVE1MICsgJzwvYT4gJzsNCgkJCX0gZWxzZSB7DQoJCQkJdmFyIHRlc3ROYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKSk7DQoJCQkJYmFubmVyLmlubmVySFRNTCA9ICc8YSBocmVmPSInICsgbWFpblBhZ2VMb2NhdGlvbiArICciPicgKyBiYW5uZXIuaW5uZXJIVE1MICsgJzwvYT4gJiM4MjUwOyA8YSBocmVmPSIiPicgKyB0ZXN0TmFtZSArICc8L2E+JzsNCgkJCX0NCgkJfQ0KCX0NCg0KCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOw0KCWlmICggdG9vbGJhciApIHsNCgkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KDQoJCXZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOw0KCQlmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7DQoJCWZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7DQoJCWZpbHRlci5kaXNhYmxlZCA9IHRydWU7DQoJCWFkZEV2ZW50KCBmaWx0ZXIsICJjbGljayIsIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7DQoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsNCgkJCQlpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJwYXNzIikgPiAtMSApIHsNCgkJCQkJbGlbaV0uc3R5bGUuZGlzcGxheSA9IGZpbHRlci5jaGVja2VkID8gIm5vbmUiIDogIiI7DQoJCQkJfQ0KCQkJfQ0KCQl9KTsNCgkJdG9vbGJhci5hcHBlbmRDaGlsZCggZmlsdGVyICk7DQoNCgkJdmFyIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsNCgkJbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCAicXVuaXQtZmlsdGVyLXBhc3MiKTsNCgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgcGFzc2VkIHRlc3RzIjsNCgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsNCgl9DQoNCgl2YXIgbWFpbiA9IGlkKCdtYWluJykgfHwgaWQoJ3F1bml0LWZpeHR1cmUnKTsNCglpZiAoIG1haW4gKSB7DQoJCWNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7DQoJfQ0KDQoJaWYgKGNvbmZpZy5hdXRvc3RhcnQpIHsNCgkJUVVuaXQuc3RhcnQoKTsNCgl9DQp9KTsNCg0KZnVuY3Rpb24gZG9uZSgpIHsNCgljb25maWcuYXV0b3J1biA9IHRydWU7DQoNCgkvLyBMb2cgdGhlIGxhc3QgbW9kdWxlIHJlc3VsdHMNCglpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgew0KCQlRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOw0KCX0NCg0KCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksDQoJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksDQoJCWh0bWwgPSBbJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLA0KCQkrbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLA0KCQknPHNwYW4gY2xhc3M9InBhc3NlZCI+JywgY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJ0b3RhbCI+JywgY29uZmlnLnN0YXRzLmFsbCwgJzwvc3Bhbj4gcGFzc2VkLCA8c3BhbiBjbGFzcz0iZmFpbGVkIj4nLCBjb25maWcuc3RhdHMuYmFkLCc8L3NwYW4+IGZhaWxlZC4nXS5qb2luKCcnKTsNCg0KCWlmICggYmFubmVyICkgew0KCQliYW5uZXIuY2xhc3NOYW1lID0gKGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIpOw0KCX0NCg0KCWlmICggdGVzdHMgKSB7DQoJCXZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOw0KDQoJCWlmICggIXJlc3VsdCApIHsNCgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsNCgkJCXJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsNCgkJCXJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsNCgkJCXRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7DQoJCX0NCg0KCQlyZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsNCgl9DQoNCglRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7DQp9DQoNCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsNCgl2YXIgaSA9IGNvbmZpZy5maWx0ZXJzLmxlbmd0aCwNCgkJcnVuID0gZmFsc2U7DQoNCglpZiAoICFpICkgew0KCQlyZXR1cm4gdHJ1ZTsNCgl9DQoNCgl3aGlsZSAoIGktLSApIHsNCgkJdmFyIGZpbHRlciA9IGNvbmZpZy5maWx0ZXJzW2ldLA0KCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7DQoNCgkJaWYgKCBub3QgKSB7DQoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7DQoJCX0NCg0KCQlpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsNCgkJCXJldHVybiAhbm90Ow0KCQl9DQoNCgkJaWYgKCBub3QgKSB7DQoJCQlydW4gPSB0cnVlOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIHJ1bjsNCn0NCg0KLy8gc28gZmFyIHN1cHBvcnRzIG9ubHkgRmlyZWZveCwgQ2hyb21lIGFuZCBPcGVyYSAoYnVnZ3kpDQovLyBjb3VsZCBiZSBleHRlbmRlZCBpbiB0aGUgZnV0dXJlIHRvIHVzZSBzb21ldGhpbmcgbGlrZSBodHRwczovL2dpdGh1Yi5jb20vY3Nub3Zlci9UcmFjZUtpdA0KZnVuY3Rpb24gc291cmNlRnJvbVN0YWNrdHJhY2UoKSB7DQoJdHJ5IHsNCgkJdGhyb3cgbmV3IEVycm9yKCk7DQoJfSBjYXRjaCAoIGUgKSB7DQoJCWlmIChlLnN0YWNrdHJhY2UpIHsNCgkJCS8vIE9wZXJhDQoJCQlyZXR1cm4gZS5zdGFja3RyYWNlLnNwbGl0KCJcbiIpWzZdOw0KCQl9IGVsc2UgaWYgKGUuc3RhY2spIHsNCgkJCS8vIEZpcmVmb3gsIENocm9tZQ0KCQkJcmV0dXJuIGUuc3RhY2suc3BsaXQoIlxuIilbNF07DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIHJlc3VsdERpc3BsYXlTdHlsZShwYXNzZWQpIHsNCglyZXR1cm4gcGFzc2VkICYmIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpICYmIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmNoZWNrZWQgPyAnbm9uZScgOiAnJzsNCn0NCg0KZnVuY3Rpb24gZXNjYXBlSHRtbChzKSB7DQoJaWYgKCFzKSB7DQoJCXJldHVybiAiIjsNCgl9DQoJcyA9IHMgKyAiIjsNCglyZXR1cm4gcy5yZXBsYWNlKC9bXCYiPD5cXF0vZywgZnVuY3Rpb24ocykgew0KCQlzd2l0Y2gocykgew0KCQkJY2FzZSAiJiI6IHJldHVybiAiJmFtcDsiOw0KCQkJY2FzZSAiXFwiOiByZXR1cm4gIlxcXFwiOw0KCQkJY2FzZSAnIic6IHJldHVybiAnXCInOw0KCQkJY2FzZSAiPCI6IHJldHVybiAiJmx0OyI7DQoJCQljYXNlICI+IjogcmV0dXJuICImZ3Q7IjsNCgkJCWRlZmF1bHQ6IHJldHVybiBzOw0KCQl9DQoJfSk7DQp9DQoNCmZ1bmN0aW9uIHN5bmNocm9uaXplKCBjYWxsYmFjayApIHsNCgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsNCg0KCWlmICggY29uZmlnLmF1dG9ydW4gJiYgIWNvbmZpZy5ibG9ja2luZyApIHsNCgkJcHJvY2VzcygpOw0KCX0NCn0NCg0KZnVuY3Rpb24gcHJvY2VzcygpIHsNCgl2YXIgc3RhcnQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOw0KDQoJd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7DQoJCWlmICggY29uZmlnLnVwZGF0ZVJhdGUgPD0gMCB8fCAoKChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSBzdGFydCkgPCBjb25maWcudXBkYXRlUmF0ZSkgKSB7DQoJCQljb25maWcucXVldWUuc2hpZnQoKSgpOw0KCQl9IGVsc2Ugew0KCQkJd2luZG93LnNldFRpbWVvdXQoIHByb2Nlc3MsIDEzICk7DQoJCQlicmVhazsNCgkJfQ0KCX0NCiAgaWYgKCFjb25maWcuYmxvY2tpbmcgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsNCiAgICBkb25lKCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gc2F2ZUdsb2JhbCgpIHsNCgljb25maWcucG9sbHV0aW9uID0gW107DQoNCglpZiAoIGNvbmZpZy5ub2dsb2JhbHMgKSB7DQoJCWZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgew0KCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsNCgkJfQ0KCX0NCn0NCg0KZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7DQoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247DQoJc2F2ZUdsb2JhbCgpOw0KDQoJdmFyIG5ld0dsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsNCglpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsNCgkJb2soIGZhbHNlLCAiSW50cm9kdWNlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBuZXdHbG9iYWxzLmpvaW4oIiwgIikgKTsNCgkJY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQrKzsNCgl9DQoNCgl2YXIgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKCBjb25maWcucG9sbHV0aW9uLCBvbGQgKTsNCglpZiAoIGRlbGV0ZWRHbG9iYWxzLmxlbmd0aCA+IDAgKSB7DQoJCW9rKCBmYWxzZSwgIkRlbGV0ZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGVsZXRlZEdsb2JhbHMuam9pbigiLCAiKSApOw0KCQljb25maWcuY3VycmVudC5leHBlY3RlZCsrOw0KCX0NCn0NCg0KLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYg0KZnVuY3Rpb24gZGlmZiggYSwgYiApIHsNCgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOw0KCWZvciAoIHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKyApIHsNCgkJZm9yICggdmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKyApIHsNCgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgew0KCQkJCXJlc3VsdC5zcGxpY2UoaSwgMSk7DQoJCQkJaS0tOw0KCQkJCWJyZWFrOw0KCQkJfQ0KCQl9DQoJfQ0KCXJldHVybiByZXN1bHQ7DQp9DQoNCmZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgew0KCWlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgew0KCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOw0KCQljb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7DQoJCWNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsNCg0KCX0gZWxzZSBpZiAoIHdpbmRvdy5vcGVyYSAmJiBvcGVyYS5wb3N0RXJyb3IgKSB7DQoJCW9wZXJhLnBvc3RFcnJvcihtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrLnRvU3RyaW5nKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7DQoJZm9yICggdmFyIHByb3AgaW4gYiApIHsNCgkJYVtwcm9wXSA9IGJbcHJvcF07DQoJfQ0KDQoJcmV0dXJuIGE7DQp9DQoNCmZ1bmN0aW9uIGFkZEV2ZW50KGVsZW0sIHR5cGUsIGZuKSB7DQoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7DQoJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZm4sIGZhbHNlICk7DQoJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsNCgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7DQoJfSBlbHNlIHsNCgkJZm4oKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIGlkKG5hbWUpIHsNCglyZXR1cm4gISEodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgJiYNCgkJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG5hbWUgKTsNCn0NCg0KLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4NCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2DQovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYNCi8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMOpIDxwcmF0aGVAZ21haWwuY29tPg0KUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24NCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucw0KICAgIHZhciBwYXJlbnRzID0gW107IC8vIHN0YWNrIHRvIGF2b2lkaW5nIGxvb3BzIGZyb20gY2lyY3VsYXIgcmVmZXJlbmNpbmcNCg0KICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuDQogICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsNCiAgICAgICAgdmFyIHByb3AgPSBRVW5pdC5vYmplY3RUeXBlKG8pOw0KICAgICAgICBpZiAocHJvcCkgew0KICAgICAgICAgICAgaWYgKFFVbml0Lm9iamVjdFR5cGUoY2FsbGJhY2tzW3Byb3BdKSA9PT0gImZ1bmN0aW9uIikgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXTsgLy8gb3IgdW5kZWZpbmVkDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQoNCiAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbA0KICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7DQogICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsNCiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uDQogICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7DQogICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LA0KICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksDQogICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksDQoNCiAgICAgICAgICAgICJuYW4iOiBmdW5jdGlvbiAoYikgew0KICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKGIpID09PSAicmVnZXhwIiAmJg0KICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZg0KICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4NCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYNCiAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApDQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwNCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkNCiAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOw0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJg0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOw0KICAgICAgICAgICAgICAgIHZhciBsZW47DQoNCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUNCiAgICAgICAgICAgICAgICBpZiAoICEgKFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJhcnJheSIpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsNCiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXINCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMNCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7DQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7DQogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvL2RvbnQgcmV3YWxrIGFycmF5DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOw0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgIm9iamVjdCI6IGZ1bmN0aW9uIChiLCBhKSB7DQogICAgICAgICAgICAgICAgdmFyIGksIGosIGxvb3A7DQogICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQNCiAgICAgICAgICAgICAgICB2YXIgYVByb3BlcnRpZXMgPSBbXSwgYlByb3BlcnRpZXMgPSBbXTsgLy8gY29sbGVjdGlvbiBvZiBzdHJpbmdzDQoNCiAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZg0KICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3Rvcikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcw0KICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsNCiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzDQogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOw0KDQogICAgICAgICAgICAgICAgZm9yIChpIGluIGEpIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5IGFuZCBnbyBkZWVwDQogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOyAvL2Rvbid0IGdvIGRvd24gdGhlIHNhbWUgcGF0aCB0d2ljZQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQ0KICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7DQoNCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYikgew0KICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lDQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgIH0oKTsNCg0KICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cw0KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOw0KICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsNCiAgICAgICAgICAgIGlmIChhID09PSBiKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNhdGNoIHRoZSBtb3N0IHlvdSBjYW4NCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgUVVuaXQub2JqZWN0VHlwZShhKSAhPT0gUVVuaXQub2JqZWN0VHlwZShiKSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRDYWxsYmFja3MoYSwgY2FsbGJhY2tzLCBbYiwgYV0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gd2l0aCAoMS4ubikgYXJndW1lbnRzDQogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGlubmVyRXF1aXY7DQoNCn0oKTsNCg0KLyoqDQogKiBqc0R1bXANCiAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQ0KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkNCiAqIERhdGU6IDUvMTUvMjAwOA0KICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuDQogKiBAdmVyc2lvbiAxLjAuMA0KICogQGF1dGhvciBBcmllbCBGbGVzbGVyDQogKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9DQogKi8NClFVbml0LmpzRHVtcCA9IChmdW5jdGlvbigpIHsNCglmdW5jdGlvbiBxdW90ZSggc3RyICkgew0KCQlyZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7DQoJfTsNCglmdW5jdGlvbiBsaXRlcmFsKCBvICkgew0KCQlyZXR1cm4gbyArICcnOw0KCX07DQoJZnVuY3Rpb24gam9pbiggcHJlLCBhcnIsIHBvc3QgKSB7DQoJCXZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLA0KCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwNCgkJCWlubmVyID0ganNEdW1wLmluZGVudCgxKTsNCgkJaWYgKCBhcnIuam9pbiApDQoJCQlhcnIgPSBhcnIuam9pbiggJywnICsgcyArIGlubmVyICk7DQoJCWlmICggIWFyciApDQoJCQlyZXR1cm4gcHJlICsgcG9zdDsNCgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOw0KCX07DQoJZnVuY3Rpb24gYXJyYXkoIGFyciApIHsNCgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsNCgkJdGhpcy51cCgpOw0KCQl3aGlsZSAoIGktLSApDQoJCQlyZXRbaV0gPSB0aGlzLnBhcnNlKCBhcnJbaV0gKTsNCgkJdGhpcy5kb3duKCk7DQoJCXJldHVybiBqb2luKCAnWycsIHJldCwgJ10nICk7DQoJfTsNCg0KCXZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsNCg0KCXZhciBqc0R1bXAgPSB7DQoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlDQoJCQl2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsNCgkJCXR5cGUgPSB0eXBlb2YgcGFyc2VyOw0KDQoJCQlyZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwoIHRoaXMsIG9iaiApIDoNCgkJCQkgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoNCgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7DQoJCX0sDQoJCXR5cGVPZjpmdW5jdGlvbiggb2JqICkgew0KCQkJdmFyIHR5cGU7DQoJCQlpZiAoIG9iaiA9PT0gbnVsbCApIHsNCgkJCQl0eXBlID0gIm51bGwiOw0KCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgew0KCQkJCXR5cGUgPSAidW5kZWZpbmVkIjsNCgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG9iaikpIHsNCgkJCQl0eXBlID0gInJlZ2V4cCI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJEYXRlIiwgb2JqKSkgew0KCQkJCXR5cGUgPSAiZGF0ZSI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsNCgkJCQl0eXBlID0gImZ1bmN0aW9uIjsNCgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iai5zZXRJbnRlcnZhbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvYmouZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgPT09ICJ1bmRlZmluZWQiKSB7DQoJCQkJdHlwZSA9ICJ3aW5kb3ciOw0KCQkJfSBlbHNlIGlmIChvYmoubm9kZVR5cGUgPT09IDkpIHsNCgkJCQl0eXBlID0gImRvY3VtZW50IjsNCgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7DQoJCQkJdHlwZSA9ICJub2RlIjsNCgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIG9iai5sZW5ndGggPj0gMCkgew0KCQkJCXR5cGUgPSAiYXJyYXkiOw0KCQkJfSBlbHNlIHsNCgkJCQl0eXBlID0gdHlwZW9mIG9iajsNCgkJCX0NCgkJCXJldHVybiB0eXBlOw0KCQl9LA0KCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsNCgkJfSwNCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZw0KCQkJaWYgKCAhdGhpcy5tdWx0aWxpbmUgKQ0KCQkJCXJldHVybiAnJzsNCgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7DQoJCQlpZiAoIHRoaXMuSFRNTCApDQoJCQkJY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csJyAgICcpLnJlcGxhY2UoLyAvZywnJm5ic3A7Jyk7DQoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7DQoJCX0sDQoJCXVwOmZ1bmN0aW9uKCBhICkgew0KCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsNCgkJfSwNCgkJZG93bjpmdW5jdGlvbiggYSApIHsNCgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7DQoJCX0sDQoJCXNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgew0KCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOw0KCQl9LA0KCQkvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0NCgkJcXVvdGU6cXVvdGUsDQoJCWxpdGVyYWw6bGl0ZXJhbCwNCgkJam9pbjpqb2luLA0KCQkvLw0KCQlfZGVwdGhfOiAxLA0KCQkvLyBUaGlzIGlzIHRoZSBsaXN0IG9mIHBhcnNlcnMsIHRvIG1vZGlmeSB0aGVtLCB1c2UganNEdW1wLnNldFBhcnNlcg0KCQlwYXJzZXJzOnsNCgkJCXdpbmRvdzogJ1tXaW5kb3ddJywNCgkJCWRvY3VtZW50OiAnW0RvY3VtZW50XScsDQoJCQllcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4NCgkJCXVua25vd246ICdbVW5rbm93bl0nLA0KCQkJJ251bGwnOidudWxsJywNCgkJCXVuZGVmaW5lZDondW5kZWZpbmVkJywNCgkJCSdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICkgew0KCQkJCXZhciByZXQgPSAnZnVuY3Rpb24nLA0KCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUNCgkJCQlpZiAoIG5hbWUgKQ0KCQkJCQlyZXQgKz0gJyAnICsgbmFtZTsNCgkJCQlyZXQgKz0gJygnOw0KDQoJCQkJcmV0ID0gWyByZXQsIFFVbml0LmpzRHVtcC5wYXJzZSggZm4sICdmdW5jdGlvbkFyZ3MnICksICcpeyddLmpvaW4oJycpOw0KCQkJCXJldHVybiBqb2luKCByZXQsIFFVbml0LmpzRHVtcC5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOw0KCQkJfSwNCgkJCWFycmF5OiBhcnJheSwNCgkJCW5vZGVsaXN0OiBhcnJheSwNCgkJCWFyZ3VtZW50czogYXJyYXksDQoJCQlvYmplY3Q6ZnVuY3Rpb24oIG1hcCApIHsNCgkJCQl2YXIgcmV0ID0gWyBdOw0KCQkJCVFVbml0LmpzRHVtcC51cCgpOw0KCQkJCWZvciAoIHZhciBrZXkgaW4gbWFwICkNCgkJCQkJcmV0LnB1c2goIFFVbml0LmpzRHVtcC5wYXJzZShrZXksJ2tleScpICsgJzogJyArIFFVbml0LmpzRHVtcC5wYXJzZShtYXBba2V5XSkgKTsNCgkJCQlRVW5pdC5qc0R1bXAuZG93bigpOw0KCQkJCXJldHVybiBqb2luKCAneycsIHJldCwgJ30nICk7DQoJCQl9LA0KCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsNCgkJCQl2YXIgb3BlbiA9IFFVbml0LmpzRHVtcC5IVE1MID8gJyZsdDsnIDogJzwnLA0KCQkJCQljbG9zZSA9IFFVbml0LmpzRHVtcC5IVE1MID8gJyZndDsnIDogJz4nOw0KDQoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwNCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsNCg0KCQkJCWZvciAoIHZhciBhIGluIFFVbml0LmpzRHVtcC5ET01BdHRycyApIHsNCgkJCQkJdmFyIHZhbCA9IG5vZGVbUVVuaXQuanNEdW1wLkRPTUF0dHJzW2FdXTsNCgkJCQkJaWYgKCB2YWwgKQ0KCQkJCQkJcmV0ICs9ICcgJyArIGEgKyAnPScgKyBRVW5pdC5qc0R1bXAucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsNCgkJCQl9DQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOw0KCQkJfSwNCgkJCWZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24NCgkJCQl2YXIgbCA9IGZuLmxlbmd0aDsNCgkJCQlpZiAoICFsICkgcmV0dXJuICcnOw0KDQoJCQkJdmFyIGFyZ3MgPSBBcnJheShsKTsNCgkJCQl3aGlsZSAoIGwtLSApDQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnDQoJCQkJcmV0dXJuICcgJyArIGFyZ3Muam9pbignLCAnKSArICcgJzsNCgkJCX0sDQoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwDQoJCQlmdW5jdGlvbkNvZGU6J1tjb2RlXScsIC8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgY29udGVudCBvZiB0aGUgZnVuY3Rpb24NCgkJCWF0dHJpYnV0ZTpxdW90ZSwgLy9ub2RlIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgYW4gaHRtbCBhdHRyaWJ1dGUgdmFsdWUNCgkJCXN0cmluZzpxdW90ZSwNCgkJCWRhdGU6cXVvdGUsDQoJCQlyZWdleHA6bGl0ZXJhbCwgLy9yZWdleA0KCQkJbnVtYmVyOmxpdGVyYWwsDQoJCQknYm9vbGVhbic6bGl0ZXJhbA0KCQl9LA0KCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUNCgkJCWlkOidpZCcsDQoJCQluYW1lOiduYW1lJywNCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScNCgkJfSwNCgkJSFRNTDpmYWxzZSwvL2lmIHRydWUsIGVudGl0aWVzIGFyZSBlc2NhcGVkICggPCwgPiwgXHQsIHNwYWNlIGFuZCBcbiApDQoJCWluZGVudENoYXI6JyAgJywvL2luZGVudGF0aW9uIHVuaXQNCgkJbXVsdGlsaW5lOnRydWUgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuDQoJfTsNCg0KCXJldHVybiBqc0R1bXA7DQp9KSgpOw0KDQovLyBmcm9tIFNpenpsZS5qcw0KZnVuY3Rpb24gZ2V0VGV4dCggZWxlbXMgKSB7DQoJdmFyIHJldCA9ICIiLCBlbGVtOw0KDQoJZm9yICggdmFyIGkgPSAwOyBlbGVtc1tpXTsgaSsrICkgew0KCQllbGVtID0gZWxlbXNbaV07DQoNCgkJLy8gR2V0IHRoZSB0ZXh0IGZyb20gdGV4dCBub2RlcyBhbmQgQ0RBVEEgbm9kZXMNCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDQgKSB7DQoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7DQoNCgkJLy8gVHJhdmVyc2UgZXZlcnl0aGluZyBlbHNlLCBleGNlcHQgY29tbWVudCBub2Rlcw0KCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgew0KCQkJcmV0ICs9IGdldFRleHQoIGVsZW0uY2hpbGROb2RlcyApOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIHJldDsNCn07DQoNCi8qDQogKiBKYXZhc2NyaXB0IERpZmYgQWxnb3JpdGhtDQogKiAgQnkgSm9obiBSZXNpZyAoaHR0cDovL2Vqb2huLm9yZy8pDQogKiAgTW9kaWZpZWQgYnkgQ2h1IEFsYW4gInNwcml0ZSINCiAqDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKg0KICogTW9yZSBJbmZvOg0KICogIGh0dHA6Ly9lam9obi5vcmcvcHJvamVjdHMvamF2YXNjcmlwdC1kaWZmLWFsZ29yaXRobS8NCiAqDQogKiBVc2FnZTogUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKQ0KICoNCiAqIFFVbml0LmRpZmYoInRoZSBxdWljayBicm93biBmb3gganVtcGVkIG92ZXIiLCAidGhlIHF1aWNrIGZveCBqdW1wcyBvdmVyIikgPT0gInRoZSAgcXVpY2sgPGRlbD5icm93biA8L2RlbD4gZm94IDxkZWw+anVtcGVkIDwvZGVsPjxpbnM+anVtcHMgPC9pbnM+IG92ZXIiDQogKi8NClFVbml0LmRpZmYgPSAoZnVuY3Rpb24oKSB7DQoJZnVuY3Rpb24gZGlmZihvLCBuKXsNCgkJdmFyIG5zID0gbmV3IE9iamVjdCgpOw0KCQl2YXIgb3MgPSBuZXcgT2JqZWN0KCk7DQoNCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBuLmxlbmd0aDsgaSsrKSB7DQoJCQlpZiAobnNbbltpXV0gPT0gbnVsbCkNCgkJCQluc1tuW2ldXSA9IHsNCgkJCQkJcm93czogbmV3IEFycmF5KCksDQoJCQkJCW86IG51bGwNCgkJCQl9Ow0KCQkJbnNbbltpXV0ucm93cy5wdXNoKGkpOw0KCQl9DQoNCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7DQoJCQlpZiAob3Nbb1tpXV0gPT0gbnVsbCkNCgkJCQlvc1tvW2ldXSA9IHsNCgkJCQkJcm93czogbmV3IEFycmF5KCksDQoJCQkJCW46IG51bGwNCgkJCQl9Ow0KCQkJb3Nbb1tpXV0ucm93cy5wdXNoKGkpOw0KCQl9DQoNCgkJZm9yICh2YXIgaSBpbiBucykgew0KCQkJaWYgKG5zW2ldLnJvd3MubGVuZ3RoID09IDEgJiYgdHlwZW9mKG9zW2ldKSAhPSAidW5kZWZpbmVkIiAmJiBvc1tpXS5yb3dzLmxlbmd0aCA9PSAxKSB7DQoJCQkJbltuc1tpXS5yb3dzWzBdXSA9IHsNCgkJCQkJdGV4dDogbltuc1tpXS5yb3dzWzBdXSwNCgkJCQkJcm93OiBvc1tpXS5yb3dzWzBdDQoJCQkJfTsNCgkJCQlvW29zW2ldLnJvd3NbMF1dID0gew0KCQkJCQl0ZXh0OiBvW29zW2ldLnJvd3NbMF1dLA0KCQkJCQlyb3c6IG5zW2ldLnJvd3NbMF0NCgkJCQl9Ow0KCQkJfQ0KCQl9DQoNCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBuLmxlbmd0aCAtIDE7IGkrKykgew0KCQkJaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSArIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyArIDEgPCBvLmxlbmd0aCAmJiBvW25baV0ucm93ICsgMV0udGV4dCA9PSBudWxsICYmDQoJCQluW2kgKyAxXSA9PSBvW25baV0ucm93ICsgMV0pIHsNCgkJCQluW2kgKyAxXSA9IHsNCgkJCQkJdGV4dDogbltpICsgMV0sDQoJCQkJCXJvdzogbltpXS5yb3cgKyAxDQoJCQkJfTsNCgkJCQlvW25baV0ucm93ICsgMV0gPSB7DQoJCQkJCXRleHQ6IG9bbltpXS5yb3cgKyAxXSwNCgkJCQkJcm93OiBpICsgMQ0KCQkJCX07DQoJCQl9DQoJCX0NCg0KCQlmb3IgKHZhciBpID0gbi5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7DQoJCQlpZiAobltpXS50ZXh0ICE9IG51bGwgJiYgbltpIC0gMV0udGV4dCA9PSBudWxsICYmIG5baV0ucm93ID4gMCAmJiBvW25baV0ucm93IC0gMV0udGV4dCA9PSBudWxsICYmDQoJCQluW2kgLSAxXSA9PSBvW25baV0ucm93IC0gMV0pIHsNCgkJCQluW2kgLSAxXSA9IHsNCgkJCQkJdGV4dDogbltpIC0gMV0sDQoJCQkJCXJvdzogbltpXS5yb3cgLSAxDQoJCQkJfTsNCgkJCQlvW25baV0ucm93IC0gMV0gPSB7DQoJCQkJCXRleHQ6IG9bbltpXS5yb3cgLSAxXSwNCgkJCQkJcm93OiBpIC0gMQ0KCQkJCX07DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gew0KCQkJbzogbywNCgkJCW46IG4NCgkJfTsNCgl9DQoNCglyZXR1cm4gZnVuY3Rpb24obywgbil7DQoJCW8gPSBvLnJlcGxhY2UoL1xzKyQvLCAnJyk7DQoJCW4gPSBuLnJlcGxhY2UoL1xzKyQvLCAnJyk7DQoJCXZhciBvdXQgPSBkaWZmKG8gPT0gIiIgPyBbXSA6IG8uc3BsaXQoL1xzKy8pLCBuID09ICIiID8gW10gOiBuLnNwbGl0KC9ccysvKSk7DQoNCgkJdmFyIHN0ciA9ICIiOw0KDQoJCXZhciBvU3BhY2UgPSBvLm1hdGNoKC9ccysvZyk7DQoJCWlmIChvU3BhY2UgPT0gbnVsbCkgew0KCQkJb1NwYWNlID0gWyIgIl07DQoJCX0NCgkJZWxzZSB7DQoJCQlvU3BhY2UucHVzaCgiICIpOw0KCQl9DQoJCXZhciBuU3BhY2UgPSBuLm1hdGNoKC9ccysvZyk7DQoJCWlmIChuU3BhY2UgPT0gbnVsbCkgew0KCQkJblNwYWNlID0gWyIgIl07DQoJCX0NCgkJZWxzZSB7DQoJCQluU3BhY2UucHVzaCgiICIpOw0KCQl9DQoNCgkJaWYgKG91dC5uLmxlbmd0aCA9PSAwKSB7DQoJCQlmb3IgKHZhciBpID0gMDsgaSA8IG91dC5vLmxlbmd0aDsgaSsrKSB7DQoJCQkJc3RyICs9ICc8ZGVsPicgKyBvdXQub1tpXSArIG9TcGFjZVtpXSArICI8L2RlbD4iOw0KCQkJfQ0KCQl9DQoJCWVsc2Ugew0KCQkJaWYgKG91dC5uWzBdLnRleHQgPT0gbnVsbCkgew0KCQkJCWZvciAobiA9IDA7IG4gPCBvdXQuby5sZW5ndGggJiYgb3V0Lm9bbl0udGV4dCA9PSBudWxsOyBuKyspIHsNCgkJCQkJc3RyICs9ICc8ZGVsPicgKyBvdXQub1tuXSArIG9TcGFjZVtuXSArICI8L2RlbD4iOw0KCQkJCX0NCgkJCX0NCg0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQubi5sZW5ndGg7IGkrKykgew0KCQkJCWlmIChvdXQubltpXS50ZXh0ID09IG51bGwpIHsNCgkJCQkJc3RyICs9ICc8aW5zPicgKyBvdXQubltpXSArIG5TcGFjZVtpXSArICI8L2lucz4iOw0KCQkJCX0NCgkJCQllbHNlIHsNCgkJCQkJdmFyIHByZSA9ICIiOw0KDQoJCQkJCWZvciAobiA9IG91dC5uW2ldLnJvdyArIDE7IG4gPCBvdXQuby5sZW5ndGggJiYgb3V0Lm9bbl0udGV4dCA9PSBudWxsOyBuKyspIHsNCgkJCQkJCXByZSArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsNCgkJCQkJfQ0KCQkJCQlzdHIgKz0gIiAiICsgb3V0Lm5baV0udGV4dCArIG5TcGFjZVtpXSArIHByZTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gc3RyOw0KCX07DQp9KSgpOw0KDQp9KSh0aGlzKTs=",
                "body": "LyoNCiAqIFFVbml0IC0gQSBKYXZhU2NyaXB0IFVuaXQgVGVzdGluZyBGcmFtZXdvcmsNCiAqDQogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0DQogKg0KICogQ29weXJpZ2h0IChjKSAyMDExIEpvaG4gUmVzaWcsIErDtnJuIFphZWZmZXJlcg0KICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpDQogKiBvciBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuDQogKi8NCg0KKGZ1bmN0aW9uKHdpbmRvdykgew0KDQp2YXIgZGVmaW5lZCA9IHsNCglzZXRUaW1lb3V0OiB0eXBlb2Ygd2luZG93LnNldFRpbWVvdXQgIT09ICJ1bmRlZmluZWQiLA0KCXNlc3Npb25TdG9yYWdlOiAoZnVuY3Rpb24oKSB7DQoJCXRyeSB7DQoJCQlyZXR1cm4gISFzZXNzaW9uU3RvcmFnZS5nZXRJdGVtOw0KCQl9IGNhdGNoKGUpew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQogIH0pKCkNCn0NCg0KdmFyIHRlc3RJZCA9IDA7DQoNCnZhciBUZXN0ID0gZnVuY3Rpb24obmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjaykgew0KCXRoaXMubmFtZSA9IG5hbWU7DQoJdGhpcy50ZXN0TmFtZSA9IHRlc3ROYW1lOw0KCXRoaXMuZXhwZWN0ZWQgPSBleHBlY3RlZDsNCgl0aGlzLnRlc3RFbnZpcm9ubWVudEFyZyA9IHRlc3RFbnZpcm9ubWVudEFyZzsNCgl0aGlzLmFzeW5jID0gYXN5bmM7DQoJdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOw0KCXRoaXMuYXNzZXJ0aW9ucyA9IFtdOw0KfTsNClRlc3QucHJvdG90eXBlID0gew0KCWluaXQ6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsNCgkJaWYgKHRlc3RzKSB7DQoJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOw0KCQkJCWIuaW5uZXJIVE1MID0gIlJ1bm5pbmcgIiArIHRoaXMubmFtZTsNCgkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7DQoJCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsNCgkJCQlsaS5pZCA9IHRoaXMuaWQgPSAidGVzdC1vdXRwdXQiICsgdGVzdElkKys7DQoJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsNCgkJfQ0KCX0sDQoJc2V0dXA6IGZ1bmN0aW9uKCkgew0KCQlpZiAodGhpcy5tb2R1bGUgIT0gY29uZmlnLnByZXZpb3VzTW9kdWxlKSB7DQoJCQlpZiAoIHRoaXMucHJldmlvdXNNb2R1bGUgKSB7DQoJCQkJUVVuaXQubW9kdWxlRG9uZSggdGhpcy5tb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsNCgkJCX0NCgkJCWNvbmZpZy5wcmV2aW91c01vZHVsZSA9IHRoaXMubW9kdWxlOw0KCQkJY29uZmlnLm1vZHVsZVN0YXRzID0geyBhbGw6IDAsIGJhZDogMCB9Ow0KCQkJUVVuaXQubW9kdWxlU3RhcnQoIHRoaXMubW9kdWxlLCB0aGlzLm1vZHVsZVRlc3RFbnZpcm9ubWVudCApOw0KCQl9DQoNCgkJY29uZmlnLmN1cnJlbnQgPSB0aGlzOw0KCQl0aGlzLnRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7DQoJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwNCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9DQoJCX0sIHRoaXMubW9kdWxlVGVzdEVudmlyb25tZW50KTsNCgkJaWYgKHRoaXMudGVzdEVudmlyb25tZW50QXJnKSB7DQoJCQlleHRlbmQodGhpcy50ZXN0RW52aXJvbm1lbnQsIHRoaXMudGVzdEVudmlyb25tZW50QXJnKTsNCgkJfQ0KDQoJCVFVbml0LnRlc3RTdGFydCggdGhpcy50ZXN0TmFtZSwgdGhpcy50ZXN0RW52aXJvbm1lbnQgKTsNCg0KCQkvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudA0KCQkvLyBUT0RPIHdoeT8/DQoJCVFVbml0LmN1cnJlbnRfdGVzdEVudmlyb25tZW50ID0gdGhpcy50ZXN0RW52aXJvbm1lbnQ7DQoNCgkJdHJ5IHsNCgkJCWlmICggIWNvbmZpZy5wb2xsdXRpb24gKSB7DQoJCQkJc2F2ZUdsb2JhbCgpOw0KCQkJfQ0KDQoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsNCgkJfSBjYXRjaChlKSB7DQoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPw0KCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyB0aGlzLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7DQoJCX0NCgl9LA0KCXJ1bjogZnVuY3Rpb24oKSB7DQoJCWlmICggdGhpcy5hc3luYyApIHsNCgkJCVFVbml0LnN0b3AoKTsNCgkJfQ0KDQoJCXRyeSB7DQoJCQl0aGlzLmNhbGxiYWNrLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOw0KCQl9IGNhdGNoKGUpIHsNCgkJCS8vIFRPRE8gdXNlIHRlc3ROYW1lIGluc3RlYWQgb2YgbmFtZSBmb3Igbm8tbWFya3VwIG1lc3NhZ2U/DQoJCQlmYWlsKCJUZXN0ICIgKyB0aGlzLm5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIiwgZSwgdGhpcy5jYWxsYmFjayk7DQoJCQlRVW5pdC5vayggZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAodGhpcy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSArICIgLSAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGUpKTsNCgkJCS8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5DQoJCQlzYXZlR2xvYmFsKCk7DQoNCgkJCS8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcNCgkJCWlmICggY29uZmlnLmJsb2NraW5nICkgew0KCQkJCXN0YXJ0KCk7DQoJCQl9DQoJCX0NCgl9LA0KCXRlYXJkb3duOiBmdW5jdGlvbigpIHsNCgkJdHJ5IHsNCgkJCWNoZWNrUG9sbHV0aW9uKCk7DQoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsNCgkJfSBjYXRjaChlKSB7DQoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPw0KCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyB0aGlzLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7DQoJCX0NCgl9LA0KCWZpbmlzaDogZnVuY3Rpb24oKSB7DQoJCWlmICggdGhpcy5leHBlY3RlZCAmJiB0aGlzLmV4cGVjdGVkICE9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKSB7DQoJCQlRVW5pdC5vayggZmFsc2UsICJFeHBlY3RlZCAiICsgdGhpcy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsNCgkJfQ0KDQoJCXZhciBnb29kID0gMCwgYmFkID0gMCwNCgkJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7DQoNCgkJY29uZmlnLnN0YXRzLmFsbCArPSB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOw0KCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7DQoNCgkJaWYgKCB0ZXN0cyApIHsNCgkJCXZhciBvbCAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvbCIpOw0KDQoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7DQoJCQkJdmFyIGFzc2VydGlvbiA9IHRoaXMuYXNzZXJ0aW9uc1tpXTsNCg0KCQkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7DQoJCQkJbGkuY2xhc3NOYW1lID0gYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIjsNCgkJCQlsaS5pbm5lckhUTUwgPSAnPHByZT4nICsgKGFzc2VydGlvbi5tZXNzYWdlIHx8IChhc3NlcnRpb24ucmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpKSArICc8L3ByZT4nOw0KCQkJCW9sLmFwcGVuZENoaWxkKCBsaSApOw0KDQoJCQkJaWYgKCBhc3NlcnRpb24ucmVzdWx0ICkgew0KCQkJCQlnb29kKys7DQoJCQkJfSBlbHNlIHsNCgkJCQkJYmFkKys7DQoJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsNCgkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gc3RvcmUgcmVzdWx0IHdoZW4gcG9zc2libGUNCgkJCWRlZmluZWQuc2Vzc2lvblN0b3JhZ2UgJiYgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgicXVuaXQtIiArIHRoaXMudGVzdE5hbWUsIGJhZCk7DQoNCgkJCWlmIChiYWQgPT0gMCkgew0KCQkJCW9sLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQoJCQl9DQoNCgkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7DQoJCQliLmlubmVySFRNTCA9IHRoaXMubmFtZSArICIgPGIgY2xhc3M9J2NvdW50cyc+KDxiIGNsYXNzPSdmYWlsZWQnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3NlZCc+IiArIGdvb2QgKyAiPC9iPiwgIiArIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOw0KDQoJCQlhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgbmV4dCA9IGIubmV4dFNpYmxpbmcsIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7DQoJCQkJbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsNCgkJCX0pOw0KDQoJCQlhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7DQoJCQkJdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50Ow0KCQkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInNwYW4iIHx8IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJiIiApIHsNCgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7DQoJCQkJfQ0KCQkJCWlmICggd2luZG93LmxvY2F0aW9uICYmIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic3Ryb25nIiApIHsNCgkJCQkJd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9ICI/IiArIGVuY29kZVVSSUNvbXBvbmVudChnZXRUZXh0KFt0YXJnZXRdKS5yZXBsYWNlKC9cKC4rXCkkLywgIiIpLnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKSk7DQoJCQkJfQ0KCQkJfSk7DQoNCgkJCXZhciBsaSA9IGlkKHRoaXMuaWQpOw0KCQkJbGkuY2xhc3NOYW1lID0gYmFkID8gImZhaWwiIDogInBhc3MiOw0KCQkJbGkuc3R5bGUuZGlzcGxheSA9IHJlc3VsdERpc3BsYXlTdHlsZSghYmFkKTsNCgkJCWxpLnJlbW92ZUNoaWxkKCBsaS5maXJzdENoaWxkICk7DQoJCQlsaS5hcHBlbmRDaGlsZCggYiApOw0KCQkJbGkuYXBwZW5kQ2hpbGQoIG9sICk7DQoNCgkJCWlmICggYmFkICkgew0KCQkJCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOw0KCQkJCWlmICggdG9vbGJhciApIHsNCgkJCQkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCgkJCQkJaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOw0KCQkJCX0NCgkJCX0NCg0KCQl9IGVsc2Ugew0KCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgew0KCQkJCWlmICggIXRoaXMuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7DQoJCQkJCWJhZCsrOw0KCQkJCQljb25maWcuc3RhdHMuYmFkKys7DQoJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQl0cnkgew0KCQkJUVVuaXQucmVzZXQoKTsNCgkJfSBjYXRjaChlKSB7DQoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPw0KCQkJZmFpbCgicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyB0aGlzLm5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCBRVW5pdC5yZXNldCk7DQoJCX0NCg0KCQlRVW5pdC50ZXN0RG9uZSggdGhpcy50ZXN0TmFtZSwgYmFkLCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICk7DQoJfSwNCg0KCXF1ZXVlOiBmdW5jdGlvbigpIHsNCgkJdmFyIHRlc3QgPSB0aGlzOw0KCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCXRlc3QuaW5pdCgpOw0KCQl9KTsNCgkJZnVuY3Rpb24gcnVuKCkgew0KCQkJLy8gZWFjaCBvZiB0aGVzZSBjYW4gYnkgYXN5bmMNCgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgew0KCQkJCXRlc3Quc2V0dXAoKTsNCgkJCX0pOw0KCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7DQoJCQkJdGVzdC5ydW4oKTsNCgkJCX0pOw0KCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7DQoJCQkJdGVzdC50ZWFyZG93bigpOw0KCQkJfSk7DQoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCQl0ZXN0LmZpbmlzaCgpOw0KCQkJfSk7DQoJCX0NCgkJLy8gZGVmZXIgd2hlbiBwcmV2aW91cyB0ZXN0IHJ1biBwYXNzZWQsIGlmIHN0b3JhZ2UgaXMgYXZhaWxhYmxlDQoJCXZhciBiYWQgPSBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmICtzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJxdW5pdC0iICsgdGhpcy50ZXN0TmFtZSk7DQoJCWlmIChiYWQpIHsNCgkJCXJ1bigpOw0KCQl9IGVsc2Ugew0KCQkJc3luY2hyb25pemUocnVuKTsNCgkJfTsNCgl9DQoNCn0NCg0KdmFyIFFVbml0ID0gew0KDQoJLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzDQoJbW9kdWxlOiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHsNCgkJY29uZmlnLnByZXZpb3VzTW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7DQoJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsNCgkJY29uZmlnLmN1cnJlbnRNb2R1bGVUZXN0RW52aXJvbWVudCA9IHRlc3RFbnZpcm9ubWVudDsNCgl9LA0KDQoJYXN5bmNUZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7DQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsNCgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IDA7DQoJCX0NCg0KCQlRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOw0KCX0sDQoNCgl0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgew0KCQl2YXIgbmFtZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1uYW1lIj4nICsgdGVzdE5hbWUgKyAnPC9zcGFuPicsIHRlc3RFbnZpcm9ubWVudEFyZzsNCg0KCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7DQoJCQljYWxsYmFjayA9IGV4cGVjdGVkOw0KCQkJZXhwZWN0ZWQgPSBudWxsOw0KCQl9DQoJCS8vIGlzIDJuZCBhcmd1bWVudCBhIHRlc3RFbnZpcm9ubWVudD8NCgkJaWYgKCBleHBlY3RlZCAmJiB0eXBlb2YgZXhwZWN0ZWQgPT09ICdvYmplY3QnKSB7DQoJCQl0ZXN0RW52aXJvbm1lbnRBcmcgPSAgZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IG51bGw7DQoJCX0NCg0KCQlpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgew0KCQkJbmFtZSA9ICc8c3BhbiBjbGFzcz0ibW9kdWxlLW5hbWUiPicgKyBjb25maWcuY3VycmVudE1vZHVsZSArICI8L3NwYW4+OiAiICsgbmFtZTsNCgkJfQ0KDQoJCWlmICggIXZhbGlkVGVzdChjb25maWcuY3VycmVudE1vZHVsZSArICI6ICIgKyB0ZXN0TmFtZSkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgdGVzdCA9IG5ldyBUZXN0KG5hbWUsIHRlc3ROYW1lLCBleHBlY3RlZCwgdGVzdEVudmlyb25tZW50QXJnLCBhc3luYywgY2FsbGJhY2spOw0KCQl0ZXN0LnByZXZpb3VzTW9kdWxlID0gY29uZmlnLnByZXZpb3VzTW9kdWxlOw0KCQl0ZXN0Lm1vZHVsZSA9IGNvbmZpZy5jdXJyZW50TW9kdWxlOw0KCQl0ZXN0Lm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IGNvbmZpZy5jdXJyZW50TW9kdWxlVGVzdEVudmlyb21lbnQ7DQoJCXRlc3QucXVldWUoKTsNCgl9LA0KDQoJLyoqDQoJICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLg0KCSAqLw0KCWV4cGVjdDogZnVuY3Rpb24oYXNzZXJ0cykgew0KCQljb25maWcuY3VycmVudC5leHBlY3RlZCA9IGFzc2VydHM7DQoJfSwNCg0KCS8qKg0KCSAqIEFzc2VydHMgdHJ1ZS4NCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOw0KCSAqLw0KCW9rOiBmdW5jdGlvbihhLCBtc2cpIHsNCgkJYSA9ICEhYTsNCgkJdmFyIGRldGFpbHMgPSB7DQoJCQlyZXN1bHQ6IGEsDQoJCQltZXNzYWdlOiBtc2cNCgkJfTsNCgkJbXNnID0gZXNjYXBlSHRtbChtc2cpOw0KCQlRVW5pdC5sb2coYSwgbXNnLCBkZXRhaWxzKTsNCgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsNCgkJCXJlc3VsdDogYSwNCgkJCW1lc3NhZ2U6IG1zZw0KCQl9KTsNCgl9LA0KDQoJLyoqDQoJICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuDQoJICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLg0KCSAqDQoJICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApDQoJICoNCgkgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsNCgkgKg0KCSAqIEBwYXJhbSBPYmplY3QgYWN0dWFsDQoJICogQHBhcmFtIE9iamVjdCBleHBlY3RlZA0KCSAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpDQoJICovDQoJZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJUVVuaXQucHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglub3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlRVW5pdC5wdXNoKGV4cGVjdGVkICE9IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCg0KCWRlZXBFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlRVW5pdC5wdXNoKFFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJbm90RGVlcEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCVFVbml0LnB1c2goIVFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJc3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJUVVuaXQucHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJUVVuaXQucHVzaChleHBlY3RlZCAhPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJcmFpc2VzOiBmdW5jdGlvbihibG9jaywgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJdmFyIGFjdHVhbCwgb2sgPSBmYWxzZTsNCg0KCQlpZiAodHlwZW9mIGV4cGVjdGVkID09PSAnc3RyaW5nJykgew0KCQkJbWVzc2FnZSA9IGV4cGVjdGVkOw0KCQkJZXhwZWN0ZWQgPSBudWxsOw0KCQl9DQoNCgkJdHJ5IHsNCgkJCWJsb2NrKCk7DQoJCX0gY2F0Y2ggKGUpIHsNCgkJCWFjdHVhbCA9IGU7DQoJCX0NCg0KCQlpZiAoYWN0dWFsKSB7DQoJCQkvLyB3ZSBkb24ndCB3YW50IHRvIHZhbGlkYXRlIHRocm93biBlcnJvcg0KCQkJaWYgKCFleHBlY3RlZCkgew0KCQkJCW9rID0gdHJ1ZTsNCgkJCS8vIGV4cGVjdGVkIGlzIGEgcmVnZXhwDQoJCQl9IGVsc2UgaWYgKFFVbml0Lm9iamVjdFR5cGUoZXhwZWN0ZWQpID09PSAicmVnZXhwIikgew0KCQkJCW9rID0gZXhwZWN0ZWQudGVzdChhY3R1YWwpOw0KCQkJLy8gZXhwZWN0ZWQgaXMgYSBjb25zdHJ1Y3Rvcg0KCQkJfSBlbHNlIGlmIChhY3R1YWwgaW5zdGFuY2VvZiBleHBlY3RlZCkgew0KCQkJCW9rID0gdHJ1ZTsNCgkJCS8vIGV4cGVjdGVkIGlzIGEgdmFsaWRhdGlvbiBmdW5jdGlvbiB3aGljaCByZXR1cm5zIHRydWUgaXMgdmFsaWRhdGlvbiBwYXNzZWQNCgkJCX0gZWxzZSBpZiAoZXhwZWN0ZWQuY2FsbCh7fSwgYWN0dWFsKSA9PT0gdHJ1ZSkgew0KCQkJCW9rID0gdHJ1ZTsNCgkJCX0NCgkJfQ0KDQoJCVFVbml0Lm9rKG9rLCBtZXNzYWdlKTsNCgl9LA0KDQoJc3RhcnQ6IGZ1bmN0aW9uKCkgew0KCQljb25maWcuc2VtYXBob3JlLS07DQoJCWlmIChjb25maWcuc2VtYXBob3JlID4gMCkgew0KCQkJLy8gZG9uJ3Qgc3RhcnQgdW50aWwgZXF1YWwgbnVtYmVyIG9mIHN0b3AtY2FsbHMNCgkJCXJldHVybjsNCgkJfQ0KCQlpZiAoY29uZmlnLnNlbWFwaG9yZSA8IDApIHsNCgkJCS8vIGlnbm9yZSBpZiBzdGFydCBpcyBjYWxsZWQgbW9yZSBvZnRlbiB0aGVuIHN0b3ANCgkJCWNvbmZpZy5zZW1hcGhvcmUgPSAwOw0KCQl9DQoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MNCgkJaWYgKCBkZWZpbmVkLnNldFRpbWVvdXQgKSB7DQoJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCgkJCQlpZiAoIGNvbmZpZy50aW1lb3V0ICkgew0KCQkJCQljbGVhclRpbWVvdXQoY29uZmlnLnRpbWVvdXQpOw0KCQkJCX0NCg0KCQkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOw0KCQkJCXByb2Nlc3MoKTsNCgkJCX0sIDEzKTsNCgkJfSBlbHNlIHsNCgkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOw0KCQkJcHJvY2VzcygpOw0KCQl9DQoJfSwNCg0KCXN0b3A6IGZ1bmN0aW9uKHRpbWVvdXQpIHsNCgkJY29uZmlnLnNlbWFwaG9yZSsrOw0KCQljb25maWcuYmxvY2tpbmcgPSB0cnVlOw0KDQoJCWlmICggdGltZW91dCAmJiBkZWZpbmVkLnNldFRpbWVvdXQgKSB7DQoJCQljbGVhclRpbWVvdXQoY29uZmlnLnRpbWVvdXQpOw0KCQkJY29uZmlnLnRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsNCgkJCQlRVW5pdC5vayggZmFsc2UsICJUZXN0IHRpbWVkIG91dCIgKTsNCgkJCQlRVW5pdC5zdGFydCgpOw0KCQkJfSwgdGltZW91dCk7DQoJCX0NCgl9DQoNCn07DQoNCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkDQpRVW5pdC5lcXVhbHMgPSBRVW5pdC5lcXVhbDsNClFVbml0LnNhbWUgPSBRVW5pdC5kZWVwRXF1YWw7DQoNCi8vIE1haW50YWluIGludGVybmFsIHN0YXRlDQp2YXIgY29uZmlnID0gew0KCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4NCglxdWV1ZTogW10sDQoNCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQ0KCWJsb2NraW5nOiB0cnVlDQp9Ow0KDQovLyBMb2FkIHBhcmFtYXRlcnMNCihmdW5jdGlvbigpIHsNCgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LA0KCQlHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsNCg0KCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsNCgkJR0VUUGFyYW1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KCBHRVRQYXJhbXNbaV0gKTsNCgkJaWYgKCBHRVRQYXJhbXNbaV0gPT09ICJub2dsb2JhbHMiICkgew0KCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOw0KCQkJaS0tOw0KCQkJY29uZmlnLm5vZ2xvYmFscyA9IHRydWU7DQoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xICkgew0KCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOw0KCQkJaS0tOw0KCQl9DQoJfQ0KDQoJLy8gcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycw0KCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOw0KDQoJLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdA0KCVFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7DQp9KSgpOw0KDQovLyBFeHBvc2UgdGhlIEFQSSBhcyBnbG9iYWwgdmFyaWFibGVzLCB1bmxlc3MgYW4gJ2V4cG9ydHMnDQovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTDQppZiAoIHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gInVuZGVmaW5lZCIgKSB7DQoJZXh0ZW5kKHdpbmRvdywgUVVuaXQpOw0KCXdpbmRvdy5RVW5pdCA9IFFVbml0Ow0KfSBlbHNlIHsNCglleHRlbmQoZXhwb3J0cywgUVVuaXQpOw0KCWV4cG9ydHMuUVVuaXQgPSBRVW5pdDsNCn0NCg0KLy8gZGVmaW5lIHRoZXNlIGFmdGVyIGV4cG9zaW5nIGdsb2JhbHMgdG8ga2VlcCB0aGVtIGluIHRoZXNlIFFVbml0IG5hbWVzcGFjZSBvbmx5DQpleHRlbmQoUVVuaXQsIHsNCgljb25maWc6IGNvbmZpZywNCg0KCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucw0KCWluaXQ6IGZ1bmN0aW9uKCkgew0KCQlleHRlbmQoY29uZmlnLCB7DQoJCQlzdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LA0KCQkJbW9kdWxlU3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwNCgkJCXN0YXJ0ZWQ6ICtuZXcgRGF0ZSwNCgkJCXVwZGF0ZVJhdGU6IDEwMDAsDQoJCQlibG9ja2luZzogZmFsc2UsDQoJCQlhdXRvc3RhcnQ6IHRydWUsDQoJCQlhdXRvcnVuOiBmYWxzZSwNCgkJCWZpbHRlcnM6IFtdLA0KCQkJcXVldWU6IFtdLA0KCQkJc2VtYXBob3JlOiAwDQoJCX0pOw0KDQoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLA0KCQkJYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLA0KCQkJcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsNCg0KCQlpZiAoIHRlc3RzICkgew0KCQkJdGVzdHMuaW5uZXJIVE1MID0gIiI7DQoJCX0NCg0KCQlpZiAoIGJhbm5lciApIHsNCgkJCWJhbm5lci5jbGFzc05hbWUgPSAiIjsNCgkJfQ0KDQoJCWlmICggcmVzdWx0ICkgew0KCQkJcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHJlc3VsdCApOw0KCQl9DQoJfSwNCg0KCS8qKg0KCSAqIFJlc2V0cyB0aGUgdGVzdCBzZXR1cC4gVXNlZnVsIGZvciB0ZXN0cyB0aGF0IG1vZGlmeSB0aGUgRE9NLg0KCSAqDQoJICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgdXNlcyBqUXVlcnkncyBodG1sKCksIG90aGVyd2lzZSBqdXN0IGlubmVySFRNTC4NCgkgKi8NCglyZXNldDogZnVuY3Rpb24oKSB7DQoJCWlmICggd2luZG93LmpRdWVyeSApIHsNCgkJCWpRdWVyeSggIiNtYWluLCAjcXVuaXQtZml4dHVyZSIgKS5odG1sKCBjb25maWcuZml4dHVyZSApOw0KCQl9IGVsc2Ugew0KCQkJdmFyIG1haW4gPSBpZCggJ21haW4nICkgfHwgaWQoICdxdW5pdC1maXh0dXJlJyApOw0KCQkJaWYgKCBtYWluICkgew0KCQkJCW1haW4uaW5uZXJIVE1MID0gY29uZmlnLmZpeHR1cmU7DQoJCQl9DQoJCX0NCgl9LA0KDQoJLyoqDQoJICogVHJpZ2dlciBhbiBldmVudCBvbiBhbiBlbGVtZW50Lg0KCSAqDQoJICogQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7DQoJICoNCgkgKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtDQoJICogQHBhcmFtIFN0cmluZyB0eXBlDQoJICovDQoJdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZXZlbnQgKSB7DQoJCWlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnQgKSB7DQoJCQlldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOw0KCQkJZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LA0KCQkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsNCgkJCWVsZW0uZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsNCg0KCQl9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsNCgkJCWVsZW0uZmlyZUV2ZW50KCJvbiIrdHlwZSk7DQoJCX0NCgl9LA0KDQoJLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZw0KCWlzOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgew0KCQlyZXR1cm4gUVVuaXQub2JqZWN0VHlwZSggb2JqICkgPT0gdHlwZTsNCgl9LA0KDQoJb2JqZWN0VHlwZTogZnVuY3Rpb24oIG9iaiApIHsNCgkJaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7DQoJCQkJcmV0dXJuICJ1bmRlZmluZWQiOw0KDQoJCS8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0DQoJCX0NCgkJaWYgKG9iaiA9PT0gbnVsbCkgew0KCQkJCXJldHVybiAibnVsbCI7DQoJCX0NCg0KCQl2YXIgdHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCggb2JqICkNCgkJCS5tYXRjaCgvXlxbb2JqZWN0XHMoLiopXF0kLylbMV0gfHwgJyc7DQoNCgkJc3dpdGNoICh0eXBlKSB7DQoJCQkJY2FzZSAnTnVtYmVyJzoNCgkJCQkJCWlmIChpc05hTihvYmopKSB7DQoJCQkJCQkJCXJldHVybiAibmFuIjsNCgkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJCXJldHVybiAibnVtYmVyIjsNCgkJCQkJCX0NCgkJCQljYXNlICdTdHJpbmcnOg0KCQkJCWNhc2UgJ0Jvb2xlYW4nOg0KCQkJCWNhc2UgJ0FycmF5JzoNCgkJCQljYXNlICdEYXRlJzoNCgkJCQljYXNlICdSZWdFeHAnOg0KCQkJCWNhc2UgJ0Z1bmN0aW9uJzoNCgkJCQkJCXJldHVybiB0eXBlLnRvTG93ZXJDYXNlKCk7DQoJCX0NCgkJaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7DQoJCQkJcmV0dXJuICJvYmplY3QiOw0KCQl9DQoJCXJldHVybiB1bmRlZmluZWQ7DQoJfSwNCg0KCXB1c2g6IGZ1bmN0aW9uKHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQl2YXIgZGV0YWlscyA9IHsNCgkJCXJlc3VsdDogcmVzdWx0LA0KCQkJbWVzc2FnZTogbWVzc2FnZSwNCgkJCWFjdHVhbDogYWN0dWFsLA0KCQkJZXhwZWN0ZWQ6IGV4cGVjdGVkDQoJCX07DQoNCgkJbWVzc2FnZSA9IGVzY2FwZUh0bWwobWVzc2FnZSkgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsNCgkJbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1tZXNzYWdlIj4nICsgbWVzc2FnZSArICI8L3NwYW4+IjsNCgkJZXhwZWN0ZWQgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkpOw0KCQlhY3R1YWwgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpKTsNCgkJdmFyIG91dHB1dCA9IG1lc3NhZ2UgKyAnPHRhYmxlPjx0ciBjbGFzcz0idGVzdC1leHBlY3RlZCI+PHRoPkV4cGVjdGVkOiA8L3RoPjx0ZD48cHJlPicgKyBleHBlY3RlZCArICc8L3ByZT48L3RkPjwvdHI+JzsNCgkJaWYgKGFjdHVhbCAhPSBleHBlY3RlZCkgew0KCQkJb3V0cHV0ICs9ICc8dHIgY2xhc3M9InRlc3QtYWN0dWFsIj48dGg+UmVzdWx0OiA8L3RoPjx0ZD48cHJlPicgKyBhY3R1YWwgKyAnPC9wcmU+PC90ZD48L3RyPic7DQoJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1kaWZmIj48dGg+RGlmZjogPC90aD48dGQ+PHByZT4nICsgUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKSArJzwvcHJlPjwvdGQ+PC90cj4nOw0KCQl9DQoJCWlmICghcmVzdWx0KSB7DQoJCQl2YXIgc291cmNlID0gc291cmNlRnJvbVN0YWNrdHJhY2UoKTsNCgkJCWlmIChzb3VyY2UpIHsNCgkJCQlkZXRhaWxzLnNvdXJjZSA9IHNvdXJjZTsNCgkJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1zb3VyY2UiPjx0aD5Tb3VyY2U6IDwvdGg+PHRkPjxwcmU+JyArIHNvdXJjZSArJzwvcHJlPjwvdGQ+PC90cj4nOw0KCQkJfQ0KCQl9DQoJCW91dHB1dCArPSAiPC90YWJsZT4iOw0KDQoJCVFVbml0LmxvZyhyZXN1bHQsIG1lc3NhZ2UsIGRldGFpbHMpOw0KDQoJCWNvbmZpZy5jdXJyZW50LmFzc2VydGlvbnMucHVzaCh7DQoJCQlyZXN1bHQ6ICEhcmVzdWx0LA0KCQkJbWVzc2FnZTogb3V0cHV0DQoJCX0pOw0KCX0sDQoNCgkvLyBMb2dnaW5nIGNhbGxiYWNrcw0KCWJlZ2luOiBmdW5jdGlvbigpIHt9LA0KCWRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCkge30sDQoJbG9nOiBmdW5jdGlvbihyZXN1bHQsIG1lc3NhZ2UpIHt9LA0KCXRlc3RTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwNCgl0ZXN0RG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fSwNCgltb2R1bGVTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwNCgltb2R1bGVEb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9DQp9KTsNCg0KaWYgKCB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7DQoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOw0KfQ0KDQphZGRFdmVudCh3aW5kb3csICJsb2FkIiwgZnVuY3Rpb24oKSB7DQoJUVVuaXQuYmVnaW4oKTsNCg0KCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUNCgl2YXIgb2xkY29uZmlnID0gZXh0ZW5kKHt9LCBjb25maWcpOw0KCVFVbml0LmluaXQoKTsNCglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOw0KDQoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoNCgl2YXIgdXNlckFnZW50ID0gaWQoInF1bml0LXVzZXJBZ2VudCIpOw0KCWlmICggdXNlckFnZW50ICkgew0KCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsNCgl9DQoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1oZWFkZXIiKTsNCglpZiAoIGJhbm5lciApIHsNCgkJdmFyIHBhcmFtc0luZGV4ID0gbG9jYXRpb24uaHJlZi5sYXN0SW5kZXhPZihsb2NhdGlvbi5zZWFyY2gpOw0KCQlpZiAoIHBhcmFtc0luZGV4ID4gLTEgKSB7DQoJCQl2YXIgbWFpblBhZ2VMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYuc2xpY2UoMCwgcGFyYW1zSW5kZXgpOw0KCQkJaWYgKCBtYWluUGFnZUxvY2F0aW9uID09IGxvY2F0aW9uLmhyZWYgKSB7DQoJCQkJYmFubmVyLmlubmVySFRNTCA9ICc8YSBocmVmPSIiPiAnICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICc7DQoJCQl9IGVsc2Ugew0KCQkJCXZhciB0ZXN0TmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkpOw0KCQkJCWJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iJyArIG1haW5QYWdlTG9jYXRpb24gKyAnIj4nICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICYjODI1MDsgPGEgaHJlZj0iIj4nICsgdGVzdE5hbWUgKyAnPC9hPic7DQoJCQl9DQoJCX0NCgl9DQoNCgl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsNCglpZiAoIHRvb2xiYXIgKSB7DQoJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCg0KCQl2YXIgZmlsdGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsNCgkJZmlsdGVyLnR5cGUgPSAiY2hlY2tib3giOw0KCQlmaWx0ZXIuaWQgPSAicXVuaXQtZmlsdGVyLXBhc3MiOw0KCQlmaWx0ZXIuZGlzYWJsZWQgPSB0cnVlOw0KCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOw0KCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7DQoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigicGFzcyIpID4gLTEgKSB7DQoJCQkJCWxpW2ldLnN0eWxlLmRpc3BsYXkgPSBmaWx0ZXIuY2hlY2tlZCA/ICJub25lIiA6ICIiOw0KCQkJCX0NCgkJCX0NCgkJfSk7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOw0KDQoJCXZhciBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7DQoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7DQoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7DQoJfQ0KDQoJdmFyIG1haW4gPSBpZCgnbWFpbicpIHx8IGlkKCdxdW5pdC1maXh0dXJlJyk7DQoJaWYgKCBtYWluICkgew0KCQljb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOw0KCX0NCg0KCWlmIChjb25maWcuYXV0b3N0YXJ0KSB7DQoJCVFVbml0LnN0YXJ0KCk7DQoJfQ0KfSk7DQoNCmZ1bmN0aW9uIGRvbmUoKSB7DQoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOw0KDQoJLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzDQoJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsNCgkJUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsNCgl9DQoNCgl2YXIgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLA0KCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLA0KCQlodG1sID0gWydUZXN0cyBjb21wbGV0ZWQgaW4gJywNCgkJK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywNCgkJJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwnPC9zcGFuPiBmYWlsZWQuJ10uam9pbignJyk7DQoNCglpZiAoIGJhbm5lciApIHsNCgkJYmFubmVyLmNsYXNzTmFtZSA9IChjb25maWcuc3RhdHMuYmFkID8gInF1bml0LWZhaWwiIDogInF1bml0LXBhc3MiKTsNCgl9DQoNCglpZiAoIHRlc3RzICkgew0KCQl2YXIgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsNCg0KCQlpZiAoICFyZXN1bHQgKSB7DQoJCQlyZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7DQoJCQlyZXN1bHQuaWQgPSAicXVuaXQtdGVzdHJlc3VsdCI7DQoJCQlyZXN1bHQuY2xhc3NOYW1lID0gInJlc3VsdCI7DQoJCQl0ZXN0cy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggcmVzdWx0LCB0ZXN0cy5uZXh0U2libGluZyApOw0KCQl9DQoNCgkJcmVzdWx0LmlubmVySFRNTCA9IGh0bWw7DQoJfQ0KDQoJUVVuaXQuZG9uZSggY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCApOw0KfQ0KDQpmdW5jdGlvbiB2YWxpZFRlc3QoIG5hbWUgKSB7DQoJdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsDQoJCXJ1biA9IGZhbHNlOw0KDQoJaWYgKCAhaSApIHsNCgkJcmV0dXJuIHRydWU7DQoJfQ0KDQoJd2hpbGUgKCBpLS0gKSB7DQoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwNCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOw0KDQoJCWlmICggbm90ICkgew0KCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOw0KCQl9DQoNCgkJaWYgKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPT0gLTEgKSB7DQoJCQlyZXR1cm4gIW5vdDsNCgkJfQ0KDQoJCWlmICggbm90ICkgew0KCQkJcnVuID0gdHJ1ZTsNCgkJfQ0KCX0NCg0KCXJldHVybiBydW47DQp9DQoNCi8vIHNvIGZhciBzdXBwb3J0cyBvbmx5IEZpcmVmb3gsIENocm9tZSBhbmQgT3BlcmEgKGJ1Z2d5KQ0KLy8gY291bGQgYmUgZXh0ZW5kZWQgaW4gdGhlIGZ1dHVyZSB0byB1c2Ugc29tZXRoaW5nIGxpa2UgaHR0cHM6Ly9naXRodWIuY29tL2Nzbm92ZXIvVHJhY2VLaXQNCmZ1bmN0aW9uIHNvdXJjZUZyb21TdGFja3RyYWNlKCkgew0KCXRyeSB7DQoJCXRocm93IG5ldyBFcnJvcigpOw0KCX0gY2F0Y2ggKCBlICkgew0KCQlpZiAoZS5zdGFja3RyYWNlKSB7DQoJCQkvLyBPcGVyYQ0KCQkJcmV0dXJuIGUuc3RhY2t0cmFjZS5zcGxpdCgiXG4iKVs2XTsNCgkJfSBlbHNlIGlmIChlLnN0YWNrKSB7DQoJCQkvLyBGaXJlZm94LCBDaHJvbWUNCgkJCXJldHVybiBlLnN0YWNrLnNwbGl0KCJcbiIpWzRdOw0KCQl9DQoJfQ0KfQ0KDQpmdW5jdGlvbiByZXN1bHREaXNwbGF5U3R5bGUocGFzc2VkKSB7DQoJcmV0dXJuIHBhc3NlZCAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKSAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKS5jaGVja2VkID8gJ25vbmUnIDogJyc7DQp9DQoNCmZ1bmN0aW9uIGVzY2FwZUh0bWwocykgew0KCWlmICghcykgew0KCQlyZXR1cm4gIiI7DQoJfQ0KCXMgPSBzICsgIiI7DQoJcmV0dXJuIHMucmVwbGFjZSgvW1wmIjw+XFxdL2csIGZ1bmN0aW9uKHMpIHsNCgkJc3dpdGNoKHMpIHsNCgkJCWNhc2UgIiYiOiByZXR1cm4gIiZhbXA7IjsNCgkJCWNhc2UgIlxcIjogcmV0dXJuICJcXFxcIjsNCgkJCWNhc2UgJyInOiByZXR1cm4gJ1wiJzsNCgkJCWNhc2UgIjwiOiByZXR1cm4gIiZsdDsiOw0KCQkJY2FzZSAiPiI6IHJldHVybiAiJmd0OyI7DQoJCQlkZWZhdWx0OiByZXR1cm4gczsNCgkJfQ0KCX0pOw0KfQ0KDQpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7DQoJY29uZmlnLnF1ZXVlLnB1c2goIGNhbGxiYWNrICk7DQoNCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7DQoJCXByb2Nlc3MoKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIHByb2Nlc3MoKSB7DQoJdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsNCg0KCXdoaWxlICggY29uZmlnLnF1ZXVlLmxlbmd0aCAmJiAhY29uZmlnLmJsb2NraW5nICkgew0KCQlpZiAoIGNvbmZpZy51cGRhdGVSYXRlIDw9IDAgfHwgKCgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQpIDwgY29uZmlnLnVwZGF0ZVJhdGUpICkgew0KCQkJY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsNCgkJfSBlbHNlIHsNCgkJCXdpbmRvdy5zZXRUaW1lb3V0KCBwcm9jZXNzLCAxMyApOw0KCQkJYnJlYWs7DQoJCX0NCgl9DQogIGlmICghY29uZmlnLmJsb2NraW5nICYmICFjb25maWcucXVldWUubGVuZ3RoKSB7DQogICAgZG9uZSgpOw0KICB9DQp9DQoNCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7DQoJY29uZmlnLnBvbGx1dGlvbiA9IFtdOw0KDQoJaWYgKCBjb25maWcubm9nbG9iYWxzICkgew0KCQlmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsNCgkJCWNvbmZpZy5wb2xsdXRpb24ucHVzaCgga2V5ICk7DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICkgew0KCXZhciBvbGQgPSBjb25maWcucG9sbHV0aW9uOw0KCXNhdmVHbG9iYWwoKTsNCg0KCXZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7DQoJaWYgKCBuZXdHbG9iYWxzLmxlbmd0aCA+IDAgKSB7DQoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7DQoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkKys7DQoJfQ0KDQoJdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7DQoJaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgew0KCQlvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsNCgkJY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQrKzsNCgl9DQp9DQoNCi8vIHJldHVybnMgYSBuZXcgQXJyYXkgd2l0aCB0aGUgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBidXQgbm90IGluIGINCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7DQoJdmFyIHJlc3VsdCA9IGEuc2xpY2UoKTsNCglmb3IgKCB2YXIgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKysgKSB7DQoJCWZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7DQoJCQlpZiAoIHJlc3VsdFtpXSA9PT0gYltqXSApIHsNCgkJCQlyZXN1bHQuc3BsaWNlKGksIDEpOw0KCQkJCWktLTsNCgkJCQlicmVhazsNCgkJCX0NCgkJfQ0KCX0NCglyZXR1cm4gcmVzdWx0Ow0KfQ0KDQpmdW5jdGlvbiBmYWlsKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2spIHsNCglpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsNCgkJY29uc29sZS5lcnJvcihtZXNzYWdlKTsNCgkJY29uc29sZS5lcnJvcihleGNlcHRpb24pOw0KCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7DQoNCgl9IGVsc2UgaWYgKCB3aW5kb3cub3BlcmEgJiYgb3BlcmEucG9zdEVycm9yICkgew0KCQlvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7DQoJfQ0KfQ0KDQpmdW5jdGlvbiBleHRlbmQoYSwgYikgew0KCWZvciAoIHZhciBwcm9wIGluIGIgKSB7DQoJCWFbcHJvcF0gPSBiW3Byb3BdOw0KCX0NCg0KCXJldHVybiBhOw0KfQ0KDQpmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgew0KCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgew0KCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOw0KCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7DQoJCWVsZW0uYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBmbiApOw0KCX0gZWxzZSB7DQoJCWZuKCk7DQoJfQ0KfQ0KDQpmdW5jdGlvbiBpZChuYW1lKSB7DQoJcmV0dXJuICEhKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpICYmDQoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7DQp9DQoNCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuDQovLyBEaXNjdXNzaW9ucyBhbmQgcmVmZXJlbmNlOiBodHRwOi8vcGhpbHJhdGhlLmNvbS9hcnRpY2xlcy9lcXVpdg0KLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2DQovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4NClFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgew0KDQogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uDQogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMNCiAgICB2YXIgcGFyZW50cyA9IFtdOyAvLyBzdGFjayB0byBhdm9pZGluZyBsb29wcyBmcm9tIGNpcmN1bGFyIHJlZmVyZW5jaW5nDQoNCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLg0KICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7DQogICAgICAgIHZhciBwcm9wID0gUVVuaXQub2JqZWN0VHlwZShvKTsNCiAgICAgICAgaWYgKHByb3ApIHsNCiAgICAgICAgICAgIGlmIChRVW5pdC5vYmplY3RUeXBlKGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICAvLyBmb3Igc3RyaW5nLCBib29sZWFuLCBudW1iZXIgYW5kIG51bGwNCiAgICAgICAgZnVuY3Rpb24gdXNlU3RyaWN0RXF1YWxpdHkoYiwgYSkgew0KICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7DQogICAgICAgICAgICAgICAgLy8gdG8gY2F0Y2ggc2hvcnQgYW5ub3RhaW9uIFZTICduZXcnIGFubm90YXRpb24gb2YgYSBkZWNsYXJhdGlvbg0KICAgICAgICAgICAgICAgIC8vIGUuZy4gdmFyIGkgPSAxOw0KICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOw0KICAgICAgICAgICAgICAgIHJldHVybiBhID09IGI7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICJzdHJpbmciOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksDQogICAgICAgICAgICAibnVtYmVyIjogdXNlU3RyaWN0RXF1YWxpdHksDQogICAgICAgICAgICAibnVsbCI6IHVzZVN0cmljdEVxdWFsaXR5LA0KICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LA0KDQogICAgICAgICAgICAibmFuIjogZnVuY3Rpb24gKGIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAicmVnZXhwIjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gInJlZ2V4cCIgJiYNCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYNCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uDQogICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmDQogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQ0KICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsDQogICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5DQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsNCiAgICAgICAgICAgICAgICB2YXIgbGVuOw0KDQogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlDQogICAgICAgICAgICAgICAgaWYgKCAhIChRVW5pdC5vYmplY3RUeXBlKGIpID09PSAiYXJyYXkiKSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7DQogICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyDQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzDQogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOw0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgew0KICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7Ly9kb250IHJld2FsayBhcnJheQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOw0KICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0DQogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncw0KDQogICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YNCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMNCiAgICAgICAgICAgICAgICBjYWxsZXJzLnB1c2goYS5jb25zdHJ1Y3Rvcik7DQogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcw0KICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsNCg0KICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcA0KICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsgLy9kb24ndCBnbyBkb3duIHRoZSBzYW1lIHBhdGggdHdpY2UNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzDQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgY2FsbGVycy5wb3AoKTsgLy8gdW5zdGFjaywgd2UgYXJlIGRvbmUNCiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOw0KDQogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsNCiAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQ0KICAgICAgICAgICAgICAgIHJldHVybiBlcSAmJiBpbm5lckVxdWl2KGFQcm9wZXJ0aWVzLnNvcnQoKSwgYlByb3BlcnRpZXMuc29ydCgpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICB9KCk7DQoNCiAgICBpbm5lckVxdWl2ID0gZnVuY3Rpb24gKCkgeyAvLyBjYW4gdGFrZSBtdWx0aXBsZSBhcmd1bWVudHMNCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsNCiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgew0KICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGVuZCB0cmFuc2l0aW9uDQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7DQogICAgICAgICAgICBpZiAoYSA9PT0gYikgew0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuDQogICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IFFVbml0Lm9iamVjdFR5cGUoYSkgIT09IFFVbml0Lm9iamVjdFR5cGUoYikpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cw0KICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7DQogICAgfTsNCg0KICAgIHJldHVybiBpbm5lckVxdWl2Ow0KDQp9KCk7DQoNCi8qKg0KICoganNEdW1wDQogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20NCiAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApDQogKiBEYXRlOiA1LzE1LzIwMDgNCiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0Lg0KICogQHZlcnNpb24gMS4wLjANCiAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcg0KICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQ0KICovDQpRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7DQoJZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsNCgkJcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOw0KCX07DQoJZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsNCgkJcmV0dXJuIG8gKyAnJzsNCgl9Ow0KCWZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgew0KCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwNCgkJCWJhc2UgPSBqc0R1bXAuaW5kZW50KCksDQoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7DQoJCWlmICggYXJyLmpvaW4gKQ0KCQkJYXJyID0gYXJyLmpvaW4oICcsJyArIHMgKyBpbm5lciApOw0KCQlpZiAoICFhcnIgKQ0KCQkJcmV0dXJuIHByZSArIHBvc3Q7DQoJCXJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsNCgl9Ow0KCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7DQoJCXZhciBpID0gYXJyLmxlbmd0aCwJcmV0ID0gQXJyYXkoaSk7DQoJCXRoaXMudXAoKTsNCgkJd2hpbGUgKCBpLS0gKQ0KCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7DQoJCXRoaXMuZG93bigpOw0KCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOw0KCX07DQoNCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87DQoNCgl2YXIganNEdW1wID0gew0KCQlwYXJzZTpmdW5jdGlvbiggb2JqLCB0eXBlICkgeyAvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQ0KCQkJdmFyCXBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07DQoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsNCg0KCQkJcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6DQoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6DQoJCQkJICAgdGhpcy5wYXJzZXJzLmVycm9yOw0KCQl9LA0KCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApIHsNCgkJCXZhciB0eXBlOw0KCQkJaWYgKCBvYmogPT09IG51bGwgKSB7DQoJCQkJdHlwZSA9ICJudWxsIjsNCgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsNCgkJCQl0eXBlID0gInVuZGVmaW5lZCI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7DQoJCQkJdHlwZSA9ICJyZWdleHAiOw0KCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG9iaikpIHsNCgkJCQl0eXBlID0gImRhdGUiOw0KCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRnVuY3Rpb24iLCBvYmopKSB7DQoJCQkJdHlwZSA9ICJmdW5jdGlvbiI7DQoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmouc2V0SW50ZXJ2YWwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2JqLmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygb2JqLm5vZGVUeXBlID09PSAidW5kZWZpbmVkIikgew0KCQkJCXR5cGUgPSAid2luZG93IjsNCgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlID09PSA5KSB7DQoJCQkJdHlwZSA9ICJkb2N1bWVudCI7DQoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSkgew0KCQkJCXR5cGUgPSAibm9kZSI7DQoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAibnVtYmVyIiAmJiBvYmoubGVuZ3RoID49IDApIHsNCgkJCQl0eXBlID0gImFycmF5IjsNCgkJCX0gZWxzZSB7DQoJCQkJdHlwZSA9IHR5cGVvZiBvYmo7DQoJCQl9DQoJCQlyZXR1cm4gdHlwZTsNCgkJfSwNCgkJc2VwYXJhdG9yOmZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuIHRoaXMubXVsdGlsaW5lID8JdGhpcy5IVE1MID8gJzxiciAvPicgOiAnXG4nIDogdGhpcy5IVE1MID8gJyZuYnNwOycgOiAnICc7DQoJCX0sDQoJCWluZGVudDpmdW5jdGlvbiggZXh0cmEgKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcNCgkJCWlmICggIXRoaXMubXVsdGlsaW5lICkNCgkJCQlyZXR1cm4gJyc7DQoJCQl2YXIgY2hyID0gdGhpcy5pbmRlbnRDaGFyOw0KCQkJaWYgKCB0aGlzLkhUTUwgKQ0KCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOw0KCQkJcmV0dXJuIEFycmF5KCB0aGlzLl9kZXB0aF8gKyAoZXh0cmF8fDApICkuam9pbihjaHIpOw0KCQl9LA0KCQl1cDpmdW5jdGlvbiggYSApIHsNCgkJCXRoaXMuX2RlcHRoXyArPSBhIHx8IDE7DQoJCX0sDQoJCWRvd246ZnVuY3Rpb24oIGEgKSB7DQoJCQl0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOw0KCQl9LA0KCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsNCgkJCXRoaXMucGFyc2Vyc1tuYW1lXSA9IHBhcnNlcjsNCgkJfSwNCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtDQoJCXF1b3RlOnF1b3RlLA0KCQlsaXRlcmFsOmxpdGVyYWwsDQoJCWpvaW46am9pbiwNCgkJLy8NCgkJX2RlcHRoXzogMSwNCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXINCgkJcGFyc2Vyczp7DQoJCQl3aW5kb3c6ICdbV2luZG93XScsDQoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLA0KCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuDQoJCQl1bmtub3duOiAnW1Vua25vd25dJywNCgkJCSdudWxsJzonbnVsbCcsDQoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsDQoJCQknZnVuY3Rpb24nOmZ1bmN0aW9uKCBmbiApIHsNCgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywNCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFDQoJCQkJaWYgKCBuYW1lICkNCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7DQoJCQkJcmV0ICs9ICcoJzsNCg0KCQkJCXJldCA9IFsgcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsNCgkJCQlyZXR1cm4gam9pbiggcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsNCgkJCX0sDQoJCQlhcnJheTogYXJyYXksDQoJCQlub2RlbGlzdDogYXJyYXksDQoJCQlhcmd1bWVudHM6IGFycmF5LA0KCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7DQoJCQkJdmFyIHJldCA9IFsgXTsNCgkJCQlRVW5pdC5qc0R1bXAudXAoKTsNCgkJCQlmb3IgKCB2YXIga2V5IGluIG1hcCApDQoJCQkJCXJldC5wdXNoKCBRVW5pdC5qc0R1bXAucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyBRVW5pdC5qc0R1bXAucGFyc2UobWFwW2tleV0pICk7DQoJCQkJUVVuaXQuanNEdW1wLmRvd24oKTsNCgkJCQlyZXR1cm4gam9pbiggJ3snLCByZXQsICd9JyApOw0KCQkJfSwNCgkJCW5vZGU6ZnVuY3Rpb24oIG5vZGUgKSB7DQoJCQkJdmFyIG9wZW4gPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmbHQ7JyA6ICc8JywNCgkJCQkJY2xvc2UgPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsNCg0KCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksDQoJCQkJCXJldCA9IG9wZW4gKyB0YWc7DQoNCgkJCQlmb3IgKCB2YXIgYSBpbiBRVW5pdC5qc0R1bXAuRE9NQXR0cnMgKSB7DQoJCQkJCXZhciB2YWwgPSBub2RlW1FVbml0LmpzRHVtcC5ET01BdHRyc1thXV07DQoJCQkJCWlmICggdmFsICkNCgkJCQkJCXJldCArPSAnICcgKyBhICsgJz0nICsgUVVuaXQuanNEdW1wLnBhcnNlKCB2YWwsICdhdHRyaWJ1dGUnICk7DQoJCQkJfQ0KCQkJCXJldHVybiByZXQgKyBjbG9zZSArIG9wZW4gKyAnLycgKyB0YWcgKyBjbG9zZTsNCgkJCX0sDQoJCQlmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24oIGZuICkgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uDQoJCQkJdmFyIGwgPSBmbi5sZW5ndGg7DQoJCQkJaWYgKCAhbCApIHJldHVybiAnJzsNCg0KCQkJCXZhciBhcmdzID0gQXJyYXkobCk7DQoJCQkJd2hpbGUgKCBsLS0gKQ0KCQkJCQlhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJw0KCQkJCXJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7DQoJCQl9LA0KCQkJa2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcA0KCQkJZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uDQoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlDQoJCQlzdHJpbmc6cXVvdGUsDQoJCQlkYXRlOnF1b3RlLA0KCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgNCgkJCW51bWJlcjpsaXRlcmFsLA0KCQkJJ2Jvb2xlYW4nOmxpdGVyYWwNCgkJfSwNCgkJRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lDQoJCQlpZDonaWQnLA0KCQkJbmFtZTonbmFtZScsDQoJCQknY2xhc3MnOidjbGFzc05hbWUnDQoJCX0sDQoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQ0KCQlpbmRlbnRDaGFyOicgICcsLy9pbmRlbnRhdGlvbiB1bml0DQoJCW11bHRpbGluZTp0cnVlIC8vaWYgdHJ1ZSwgaXRlbXMgaW4gYSBjb2xsZWN0aW9uLCBhcmUgc2VwYXJhdGVkIGJ5IGEgXG4sIGVsc2UganVzdCBhIHNwYWNlLg0KCX07DQoNCglyZXR1cm4ganNEdW1wOw0KfSkoKTsNCg0KLy8gZnJvbSBTaXp6bGUuanMNCmZ1bmN0aW9uIGdldFRleHQoIGVsZW1zICkgew0KCXZhciByZXQgPSAiIiwgZWxlbTsNCg0KCWZvciAoIHZhciBpID0gMDsgZWxlbXNbaV07IGkrKyApIHsNCgkJZWxlbSA9IGVsZW1zW2ldOw0KDQoJCS8vIEdldCB0aGUgdGV4dCBmcm9tIHRleHQgbm9kZXMgYW5kIENEQVRBIG5vZGVzDQoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgew0KCQkJcmV0ICs9IGVsZW0ubm9kZVZhbHVlOw0KDQoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMNCgkJfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSAhPT0gOCApIHsNCgkJCXJldCArPSBnZXRUZXh0KCBlbGVtLmNoaWxkTm9kZXMgKTsNCgkJfQ0KCX0NCg0KCXJldHVybiByZXQ7DQp9Ow0KDQovKg0KICogSmF2YXNjcmlwdCBEaWZmIEFsZ29yaXRobQ0KICogIEJ5IEpvaG4gUmVzaWcgKGh0dHA6Ly9lam9obi5vcmcvKQ0KICogIE1vZGlmaWVkIGJ5IENodSBBbGFuICJzcHJpdGUiDQogKg0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICoNCiAqIE1vcmUgSW5mbzoNCiAqICBodHRwOi8vZWpvaG4ub3JnL3Byb2plY3RzL2phdmFzY3JpcHQtZGlmZi1hbGdvcml0aG0vDQogKg0KICogVXNhZ2U6IFFVbml0LmRpZmYoZXhwZWN0ZWQsIGFjdHVhbCkNCiAqDQogKiBRVW5pdC5kaWZmKCJ0aGUgcXVpY2sgYnJvd24gZm94IGp1bXBlZCBvdmVyIiwgInRoZSBxdWljayBmb3gganVtcHMgb3ZlciIpID09ICJ0aGUgIHF1aWNrIDxkZWw+YnJvd24gPC9kZWw+IGZveCA8ZGVsPmp1bXBlZCA8L2RlbD48aW5zPmp1bXBzIDwvaW5zPiBvdmVyIg0KICovDQpRVW5pdC5kaWZmID0gKGZ1bmN0aW9uKCkgew0KCWZ1bmN0aW9uIGRpZmYobywgbil7DQoJCXZhciBucyA9IG5ldyBPYmplY3QoKTsNCgkJdmFyIG9zID0gbmV3IE9iamVjdCgpOw0KDQoJCWZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgew0KCQkJaWYgKG5zW25baV1dID09IG51bGwpDQoJCQkJbnNbbltpXV0gPSB7DQoJCQkJCXJvd3M6IG5ldyBBcnJheSgpLA0KCQkJCQlvOiBudWxsDQoJCQkJfTsNCgkJCW5zW25baV1dLnJvd3MucHVzaChpKTsNCgkJfQ0KDQoJCWZvciAodmFyIGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgew0KCQkJaWYgKG9zW29baV1dID09IG51bGwpDQoJCQkJb3Nbb1tpXV0gPSB7DQoJCQkJCXJvd3M6IG5ldyBBcnJheSgpLA0KCQkJCQluOiBudWxsDQoJCQkJfTsNCgkJCW9zW29baV1dLnJvd3MucHVzaChpKTsNCgkJfQ0KDQoJCWZvciAodmFyIGkgaW4gbnMpIHsNCgkJCWlmIChuc1tpXS5yb3dzLmxlbmd0aCA9PSAxICYmIHR5cGVvZihvc1tpXSkgIT0gInVuZGVmaW5lZCIgJiYgb3NbaV0ucm93cy5sZW5ndGggPT0gMSkgew0KCQkJCW5bbnNbaV0ucm93c1swXV0gPSB7DQoJCQkJCXRleHQ6IG5bbnNbaV0ucm93c1swXV0sDQoJCQkJCXJvdzogb3NbaV0ucm93c1swXQ0KCQkJCX07DQoJCQkJb1tvc1tpXS5yb3dzWzBdXSA9IHsNCgkJCQkJdGV4dDogb1tvc1tpXS5yb3dzWzBdXSwNCgkJCQkJcm93OiBuc1tpXS5yb3dzWzBdDQoJCQkJfTsNCgkJCX0NCgkJfQ0KDQoJCWZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGggLSAxOyBpKyspIHsNCgkJCWlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgKyAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgKyAxIDwgby5sZW5ndGggJiYgb1tuW2ldLnJvdyArIDFdLnRleHQgPT0gbnVsbCAmJg0KCQkJbltpICsgMV0gPT0gb1tuW2ldLnJvdyArIDFdKSB7DQoJCQkJbltpICsgMV0gPSB7DQoJCQkJCXRleHQ6IG5baSArIDFdLA0KCQkJCQlyb3c6IG5baV0ucm93ICsgMQ0KCQkJCX07DQoJCQkJb1tuW2ldLnJvdyArIDFdID0gew0KCQkJCQl0ZXh0OiBvW25baV0ucm93ICsgMV0sDQoJCQkJCXJvdzogaSArIDENCgkJCQl9Ow0KCQkJfQ0KCQl9DQoNCgkJZm9yICh2YXIgaSA9IG4ubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSkgew0KCQkJaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSAtIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyA+IDAgJiYgb1tuW2ldLnJvdyAtIDFdLnRleHQgPT0gbnVsbCAmJg0KCQkJbltpIC0gMV0gPT0gb1tuW2ldLnJvdyAtIDFdKSB7DQoJCQkJbltpIC0gMV0gPSB7DQoJCQkJCXRleHQ6IG5baSAtIDFdLA0KCQkJCQlyb3c6IG5baV0ucm93IC0gMQ0KCQkJCX07DQoJCQkJb1tuW2ldLnJvdyAtIDFdID0gew0KCQkJCQl0ZXh0OiBvW25baV0ucm93IC0gMV0sDQoJCQkJCXJvdzogaSAtIDENCgkJCQl9Ow0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHsNCgkJCW86IG8sDQoJCQluOiBuDQoJCX07DQoJfQ0KDQoJcmV0dXJuIGZ1bmN0aW9uKG8sIG4pew0KCQlvID0gby5yZXBsYWNlKC9ccyskLywgJycpOw0KCQluID0gbi5yZXBsYWNlKC9ccyskLywgJycpOw0KCQl2YXIgb3V0ID0gZGlmZihvID09ICIiID8gW10gOiBvLnNwbGl0KC9ccysvKSwgbiA9PSAiIiA/IFtdIDogbi5zcGxpdCgvXHMrLykpOw0KDQoJCXZhciBzdHIgPSAiIjsNCg0KCQl2YXIgb1NwYWNlID0gby5tYXRjaCgvXHMrL2cpOw0KCQlpZiAob1NwYWNlID09IG51bGwpIHsNCgkJCW9TcGFjZSA9IFsiICJdOw0KCQl9DQoJCWVsc2Ugew0KCQkJb1NwYWNlLnB1c2goIiAiKTsNCgkJfQ0KCQl2YXIgblNwYWNlID0gbi5tYXRjaCgvXHMrL2cpOw0KCQlpZiAoblNwYWNlID09IG51bGwpIHsNCgkJCW5TcGFjZSA9IFsiICJdOw0KCQl9DQoJCWVsc2Ugew0KCQkJblNwYWNlLnB1c2goIiAiKTsNCgkJfQ0KDQoJCWlmIChvdXQubi5sZW5ndGggPT0gMCkgew0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQuby5sZW5ndGg7IGkrKykgew0KCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9baV0gKyBvU3BhY2VbaV0gKyAiPC9kZWw+IjsNCgkJCX0NCgkJfQ0KCQllbHNlIHsNCgkJCWlmIChvdXQublswXS50ZXh0ID09IG51bGwpIHsNCgkJCQlmb3IgKG4gPSAwOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7DQoJCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsNCgkJCQl9DQoJCQl9DQoNCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3V0Lm4ubGVuZ3RoOyBpKyspIHsNCgkJCQlpZiAob3V0Lm5baV0udGV4dCA9PSBudWxsKSB7DQoJCQkJCXN0ciArPSAnPGlucz4nICsgb3V0Lm5baV0gKyBuU3BhY2VbaV0gKyAiPC9pbnM+IjsNCgkJCQl9DQoJCQkJZWxzZSB7DQoJCQkJCXZhciBwcmUgPSAiIjsNCg0KCQkJCQlmb3IgKG4gPSBvdXQubltpXS5yb3cgKyAxOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7DQoJCQkJCQlwcmUgKz0gJzxkZWw+JyArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7DQoJCQkJCX0NCgkJCQkJc3RyICs9ICIgIiArIG91dC5uW2ldLnRleHQgKyBuU3BhY2VbaV0gKyBwcmU7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIHN0cjsNCgl9Ow0KfSkoKTsNCg0KfSkodGhpcyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 13:48:32 GMT",
                    "Content-Length": "37791",
                    "Date": "Thu, 06 Nov 2014 13:48:36 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}