{
    "url": "http://localhost:9999/node-inspector/node-inspector/front-end/CSSStyleModel.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location</b> and written to <b>the 'add()' function of JQuery</b> via the following statement:<ul><li>this._locations.add(location);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/node-inspector/node-inspector/front-end/CSSStyleModel.js",
                "path": "/node-inspector/node-inspector/front-end/CSSStyleModel.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ub2RlLWluc3BlY3Rvci9ub2RlLWluc3BlY3Rvci9mcm9udC1lbmQvQ1NTU3R5bGVNb2RlbC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTM0MDUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTk6MzU6MTYgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE5OjM1OjE1IEdNVA0KDQovKgogKiBDb3B5cmlnaHQgKEMpIDIwMTAgR29vZ2xlIEluYy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICoKICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUKICogbWV0OgogKgogKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAogKiBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUKICogY29weXJpZ2h0IG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lcgogKiBpbiB0aGUgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlCiAqIGRpc3RyaWJ1dGlvbi4KICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBHb29nbGUgSW5jLiBub3IgdGhlIG5hbWVzIG9mIGl0cwogKiBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzIGRlcml2ZWQgZnJvbQogKiB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgogKgogKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTCiAqICJBUyBJUyIgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UCiAqIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUgogKiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIENPUFlSSUdIVAogKiBPV05FUiBPUiBDT05UUklCVVRPUlMgQkUgTElBQkxFIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwKICogU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgKElOQ0xVRElORywgQlVUIE5PVAogKiBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwKICogREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkQgT04gQU5ZCiAqIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlQKICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFCiAqIE9GIFRISVMgU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuCiAqLwoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAZXh0ZW5kcyB7V2ViSW5zcGVjdG9yLk9iamVjdH0KICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuV29ya3NwYWNlfSB3b3Jrc3BhY2UKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsID0gZnVuY3Rpb24od29ya3NwYWNlKQp7CiAgICB0aGlzLl93b3Jrc3BhY2UgPSB3b3Jrc3BhY2U7CiAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlID0gW107CiAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuRE9NQWdlbnQuRXZlbnRzLlVuZG9SZWRvUmVxdWVzdGVkLCB0aGlzLl91bmRvUmVkb1JlcXVlc3RlZCwgdGhpcyk7CiAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuRE9NQWdlbnQuRXZlbnRzLlVuZG9SZWRvQ29tcGxldGVkLCB0aGlzLl91bmRvUmVkb0NvbXBsZXRlZCwgdGhpcyk7CiAgICBXZWJJbnNwZWN0b3IucmVzb3VyY2VUcmVlTW9kZWwuYWRkRXZlbnRMaXN0ZW5lcihXZWJJbnNwZWN0b3IuUmVzb3VyY2VUcmVlTW9kZWwuRXZlbnRUeXBlcy5NYWluRnJhbWVDcmVhdGVkT3JOYXZpZ2F0ZWQsIHRoaXMuX21haW5GcmFtZUNyZWF0ZWRPck5hdmlnYXRlZCwgdGhpcyk7CiAgICB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9ucyA9IHt9OwogICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkRPTUFnZW50LkV2ZW50cy5Eb2N1bWVudFVwZGF0ZWQsIHRoaXMuX3Jlc2V0TmFtZWRGbG93Q29sbGVjdGlvbnMsIHRoaXMpOwogICAgSW5zcGVjdG9yQmFja2VuZC5yZWdpc3RlckNTU0Rpc3BhdGNoZXIobmV3IFdlYkluc3BlY3Rvci5DU1NEaXNwYXRjaGVyKHRoaXMpKTsKICAgIENTU0FnZW50LmVuYWJsZSgpOwogICAgdGhpcy5fcmVzZXRTdHlsZVNoZWV0cygpOwp9CgovKioKICogQHBhcmFtIHtBcnJheS48Q1NTQWdlbnQuQ1NTUnVsZT59IHJ1bGVBcnJheQogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwucGFyc2VSdWxlQXJyYXlQYXlsb2FkID0gZnVuY3Rpb24ocnVsZUFycmF5KQp7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ1bGVBcnJheS5sZW5ndGg7ICsraSkKICAgICAgICByZXN1bHQucHVzaChXZWJJbnNwZWN0b3IuQ1NTUnVsZS5wYXJzZVBheWxvYWQocnVsZUFycmF5W2ldKSk7CiAgICByZXR1cm4gcmVzdWx0Owp9CiAgICAKLyoqCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LlJ1bGVNYXRjaD59IG1hdGNoQXJyYXkKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLnBhcnNlUnVsZU1hdGNoQXJyYXlQYXlsb2FkID0gZnVuY3Rpb24obWF0Y2hBcnJheSkKewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYXRjaEFycmF5Lmxlbmd0aDsgKytpKQogICAgICAgIHJlc3VsdC5wdXNoKFdlYkluc3BlY3Rvci5DU1NSdWxlLnBhcnNlUGF5bG9hZChtYXRjaEFycmF5W2ldLnJ1bGUsIG1hdGNoQXJyYXlbaV0ubWF0Y2hpbmdTZWxlY3RvcnMpKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCldlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cyA9IHsKICAgIFN0eWxlU2hlZXRBZGRlZDogIlN0eWxlU2hlZXRBZGRlZCIsCiAgICBTdHlsZVNoZWV0Q2hhbmdlZDogIlN0eWxlU2hlZXRDaGFuZ2VkIiwKICAgIFN0eWxlU2hlZXRSZW1vdmVkOiAiU3R5bGVTaGVldFJlbW92ZWQiLAogICAgTWVkaWFRdWVyeVJlc3VsdENoYW5nZWQ6ICJNZWRpYVF1ZXJ5UmVzdWx0Q2hhbmdlZCIsCiAgICBOYW1lZEZsb3dDcmVhdGVkOiAiTmFtZWRGbG93Q3JlYXRlZCIsCiAgICBOYW1lZEZsb3dSZW1vdmVkOiAiTmFtZWRGbG93UmVtb3ZlZCIsCiAgICBSZWdpb25MYXlvdXRVcGRhdGVkOiAiUmVnaW9uTGF5b3V0VXBkYXRlZCIsCiAgICBSZWdpb25PdmVyc2V0Q2hhbmdlZDogIlJlZ2lvbk92ZXJzZXRDaGFuZ2VkIgp9CgpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5NZWRpYVR5cGVzID0gWyJhbGwiLCAiYnJhaWxsZSIsICJlbWJvc3NlZCIsICJoYW5kaGVsZCIsICJwcmludCIsICJwcm9qZWN0aW9uIiwgInNjcmVlbiIsICJzcGVlY2giLCAidHR5IiwgInR2Il07CgpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5wcm90b3R5cGUgPSB7CiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZFBzZXVkbwogICAgICogQHBhcmFtIHtib29sZWFufSBuZWVkSW5oZXJpdGVkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD8qKX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIGdldE1hdGNoZWRTdHlsZXNBc3luYzogZnVuY3Rpb24obm9kZUlkLCBuZWVkUHNldWRvLCBuZWVkSW5oZXJpdGVkLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbig/Kil9IHVzZXJDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7P1Byb3RvY29sLkVycm9yfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LlJ1bGVNYXRjaD49fSBtYXRjaGVkUGF5bG9hZAogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LlBzZXVkb0lkTWF0Y2hlcz49fSBwc2V1ZG9QYXlsb2FkCiAgICAgICAgICogQHBhcmFtIHtBcnJheS48Q1NTQWdlbnQuSW5oZXJpdGVkU3R5bGVFbnRyeT49fSBpbmhlcml0ZWRQYXlsb2FkCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2sodXNlckNhbGxiYWNrLCBlcnJvciwgbWF0Y2hlZFBheWxvYWQsIHBzZXVkb1BheWxvYWQsIGluaGVyaXRlZFBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgICAgIGlmIChtYXRjaGVkUGF5bG9hZCkKICAgICAgICAgICAgICAgIHJlc3VsdC5tYXRjaGVkQ1NTUnVsZXMgPSBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5wYXJzZVJ1bGVNYXRjaEFycmF5UGF5bG9hZChtYXRjaGVkUGF5bG9hZCk7CgogICAgICAgICAgICBpZiAocHNldWRvUGF5bG9hZCkgewogICAgICAgICAgICAgICAgcmVzdWx0LnBzZXVkb0VsZW1lbnRzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBzZXVkb1BheWxvYWQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnlQYXlsb2FkID0gcHNldWRvUGF5bG9hZFtpXTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHNldWRvRWxlbWVudHMucHVzaCh7IHBzZXVkb0lkOiBlbnRyeVBheWxvYWQucHNldWRvSWQsIHJ1bGVzOiBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5wYXJzZVJ1bGVNYXRjaEFycmF5UGF5bG9hZChlbnRyeVBheWxvYWQubWF0Y2hlcykgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbmhlcml0ZWRQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICByZXN1bHQuaW5oZXJpdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluaGVyaXRlZFBheWxvYWQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnlQYXlsb2FkID0gaW5oZXJpdGVkUGF5bG9hZFtpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnkgPSB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnlQYXlsb2FkLmlubGluZVN0eWxlKQogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5pbmxpbmVTdHlsZSA9IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChlbnRyeVBheWxvYWQuaW5saW5lU3R5bGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeVBheWxvYWQubWF0Y2hlZENTU1J1bGVzKQogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5tYXRjaGVkQ1NTUnVsZXMgPSBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5wYXJzZVJ1bGVNYXRjaEFycmF5UGF5bG9hZChlbnRyeVBheWxvYWQubWF0Y2hlZENTU1J1bGVzKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuaW5oZXJpdGVkLnB1c2goZW50cnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKHJlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBDU1NBZ2VudC5nZXRNYXRjaGVkU3R5bGVzRm9yTm9kZShub2RlSWQsIG5lZWRQc2V1ZG8sIG5lZWRJbmhlcml0ZWQsIGNhbGxiYWNrLmJpbmQobnVsbCwgdXNlckNhbGxiYWNrKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24pfSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgZ2V0Q29tcHV0ZWRTdHlsZUFzeW5jOiBmdW5jdGlvbihub2RlSWQsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbil9IHVzZXJDYWxsYmFjawogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHVzZXJDYWxsYmFjaywgZXJyb3IsIGNvbXB1dGVkUGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChlcnJvciB8fCAhY29tcHV0ZWRQYXlsb2FkKQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2soV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucGFyc2VDb21wdXRlZFN0eWxlUGF5bG9hZChjb21wdXRlZFBheWxvYWQpKTsKICAgICAgICB9CgogICAgICAgIENTU0FnZW50LmdldENvbXB1dGVkU3R5bGVGb3JOb2RlKG5vZGVJZCwgY2FsbGJhY2suYmluZChudWxsLCB1c2VyQ2FsbGJhY2spKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbm9kZUlkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9TdHJpbmcsID9BcnJheS48Q1NTQWdlbnQuUGxhdGZvcm1Gb250VXNhZ2U+KX0gY2FsbGJhY2sKICAgICAqLwogICAgZ2V0UGxhdGZvcm1Gb250c0Zvck5vZGU6IGZ1bmN0aW9uKG5vZGVJZCwgY2FsbGJhY2spCiAgICB7CiAgICAgICAgZnVuY3Rpb24gcGxhdGZvcm1Gb250c0NhbGxiYWNrKGVycm9yLCBjc3NGYW1pbHlOYW1lLCBmb250cykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChlcnJvcikKICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bGwpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBjYWxsYmFjayhjc3NGYW1pbHlOYW1lLCBmb250cyk7CiAgICAgICAgfQogICAgICAgIENTU0FnZW50LmdldFBsYXRmb3JtRm9udHNGb3JOb2RlKG5vZGVJZCwgcGxhdGZvcm1Gb250c0NhbGxiYWNrKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0RPTUFnZW50Lk5vZGVJZH0gbm9kZUlkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbiwgP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIGdldElubGluZVN0eWxlc0FzeW5jOiBmdW5jdGlvbihub2RlSWQsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbiwgP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKX0gdXNlckNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHs/UHJvdG9jb2wuRXJyb3J9IGVycm9yCiAgICAgICAgICogQHBhcmFtIHs/Q1NTQWdlbnQuQ1NTU3R5bGU9fSBpbmxpbmVQYXlsb2FkCiAgICAgICAgICogQHBhcmFtIHs/Q1NTQWdlbnQuQ1NTU3R5bGU9fSBhdHRyaWJ1dGVzU3R5bGVQYXlsb2FkCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2sodXNlckNhbGxiYWNrLCBlcnJvciwgaW5saW5lUGF5bG9hZCwgYXR0cmlidXRlc1N0eWxlUGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChlcnJvciB8fCAhaW5saW5lUGF5bG9hZCkKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsLCBudWxsKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChpbmxpbmVQYXlsb2FkKSwgYXR0cmlidXRlc1N0eWxlUGF5bG9hZCA/IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChhdHRyaWJ1dGVzU3R5bGVQYXlsb2FkKSA6IG51bGwpOwogICAgICAgIH0KCiAgICAgICAgQ1NTQWdlbnQuZ2V0SW5saW5lU3R5bGVzRm9yTm9kZShub2RlSWQsIGNhbGxiYWNrLmJpbmQobnVsbCwgdXNlckNhbGxiYWNrKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICogQHBhcmFtIHs/QXJyYXkuPHN0cmluZz58dW5kZWZpbmVkfSBmb3JjZWRQc2V1ZG9DbGFzc2VzCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgZm9yY2VQc2V1ZG9TdGF0ZTogZnVuY3Rpb24obm9kZUlkLCBmb3JjZWRQc2V1ZG9DbGFzc2VzLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgQ1NTQWdlbnQuZm9yY2VQc2V1ZG9TdGF0ZShub2RlSWQsIGZvcmNlZFBzZXVkb0NsYXNzZXMgfHwgW10sIHVzZXJDYWxsYmFjayk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IGRvY3VtZW50Tm9kZUlkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuTmFtZWRGbG93Q29sbGVjdGlvbil9IHVzZXJDYWxsYmFjawogICAgICovCiAgICBnZXROYW1lZEZsb3dDb2xsZWN0aW9uQXN5bmM6IGZ1bmN0aW9uKGRvY3VtZW50Tm9kZUlkLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tkb2N1bWVudE5vZGVJZF07CiAgICAgICAgaWYgKG5hbWVkRmxvd0NvbGxlY3Rpb24pIHsKICAgICAgICAgICAgdXNlckNhbGxiYWNrKG5hbWVkRmxvd0NvbGxlY3Rpb24pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuTmFtZWRGbG93Q29sbGVjdGlvbil9IHVzZXJDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7P1Byb3RvY29sLkVycm9yfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7P0FycmF5LjxDU1NBZ2VudC5OYW1lZEZsb3c+fSBuYW1lZEZsb3dQYXlsb2FkCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2sodXNlckNhbGxiYWNrLCBlcnJvciwgbmFtZWRGbG93UGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChlcnJvciB8fCAhbmFtZWRGbG93UGF5bG9hZCkKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZWRGbG93Q29sbGVjdGlvbiA9IG5ldyBXZWJJbnNwZWN0b3IuTmFtZWRGbG93Q29sbGVjdGlvbihuYW1lZEZsb3dQYXlsb2FkKTsKICAgICAgICAgICAgICAgIHRoaXMuX25hbWVkRmxvd0NvbGxlY3Rpb25zW2RvY3VtZW50Tm9kZUlkXSA9IG5hbWVkRmxvd0NvbGxlY3Rpb247CiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobmFtZWRGbG93Q29sbGVjdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIENTU0FnZW50LmdldE5hbWVkRmxvd0NvbGxlY3Rpb24oZG9jdW1lbnROb2RlSWQsIGNhbGxiYWNrLmJpbmQodGhpcywgdXNlckNhbGxiYWNrKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IGRvY3VtZW50Tm9kZUlkCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmxvd05hbWUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5OYW1lZEZsb3cpfSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgZ2V0Rmxvd0J5TmFtZUFzeW5jOiBmdW5jdGlvbihkb2N1bWVudE5vZGVJZCwgZmxvd05hbWUsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICB2YXIgbmFtZWRGbG93Q29sbGVjdGlvbiA9IHRoaXMuX25hbWVkRmxvd0NvbGxlY3Rpb25zW2RvY3VtZW50Tm9kZUlkXTsKICAgICAgICBpZiAobmFtZWRGbG93Q29sbGVjdGlvbikgewogICAgICAgICAgICB1c2VyQ2FsbGJhY2sobmFtZWRGbG93Q29sbGVjdGlvbi5mbG93QnlOYW1lKGZsb3dOYW1lKSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5OYW1lZEZsb3cpfSB1c2VyQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gez9XZWJJbnNwZWN0b3IuTmFtZWRGbG93Q29sbGVjdGlvbn0gbmFtZWRGbG93Q29sbGVjdGlvbgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHVzZXJDYWxsYmFjaywgbmFtZWRGbG93Q29sbGVjdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIGlmICghbmFtZWRGbG93Q29sbGVjdGlvbikKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG5hbWVkRmxvd0NvbGxlY3Rpb24uZmxvd0J5TmFtZShmbG93TmFtZSkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5nZXROYW1lZEZsb3dDb2xsZWN0aW9uQXN5bmMoZG9jdW1lbnROb2RlSWQsIGNhbGxiYWNrLmJpbmQodGhpcywgdXNlckNhbGxiYWNrKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5DU1NSdWxlSWR9IHJ1bGVJZAogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1NlbGVjdG9yCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZhaWx1cmVDYWxsYmFjawogICAgICovCiAgICBzZXRSdWxlU2VsZWN0b3I6IGZ1bmN0aW9uKHJ1bGVJZCwgbm9kZUlkLCBuZXdTZWxlY3Rvciwgc3VjY2Vzc0NhbGxiYWNrLCBmYWlsdXJlQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLkNTU1J1bGUsIGJvb2xlYW4pfSBzdWNjZXNzQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0ge0NTU0FnZW50LkNTU1J1bGV9IHJ1bGVQYXlsb2FkCiAgICAgICAgICogQHBhcmFtIHs/QXJyYXkuPERPTUFnZW50Lk5vZGVJZD59IHNlbGVjdGVkTm9kZUlkcwogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNoZWNrQWZmZWN0c0NhbGxiYWNrKG5vZGVJZCwgc3VjY2Vzc0NhbGxiYWNrLCBydWxlUGF5bG9hZCwgc2VsZWN0ZWROb2RlSWRzKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzZWxlY3RlZE5vZGVJZHMpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHZhciBkb2VzQWZmZWN0U2VsZWN0ZWROb2RlID0gKHNlbGVjdGVkTm9kZUlkcy5pbmRleE9mKG5vZGVJZCkgPj0gMCk7CiAgICAgICAgICAgIHZhciBydWxlID0gV2ViSW5zcGVjdG9yLkNTU1J1bGUucGFyc2VQYXlsb2FkKHJ1bGVQYXlsb2FkKTsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKHJ1bGUsIGRvZXNBZmZlY3RTZWxlY3RlZE5vZGUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLkNTU1J1bGUsIGJvb2xlYW4pfSBzdWNjZXNzQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZhaWx1cmVDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7P1Byb3RvY29sLkVycm9yfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdTZWxlY3RvcgogICAgICAgICAqIEBwYXJhbSB7P0NTU0FnZW50LkNTU1J1bGV9IHJ1bGVQYXlsb2FkCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2sobm9kZUlkLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaywgbmV3U2VsZWN0b3IsIGVycm9yLCBydWxlUGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmIChlcnJvcikKICAgICAgICAgICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5tYXJrVW5kb2FibGVTdGF0ZSgpOwogICAgICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnRJZCA9IHRoaXMuX293bmVyRG9jdW1lbnRJZChub2RlSWQpOwogICAgICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnRJZCkKICAgICAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQucXVlcnlTZWxlY3RvckFsbChvd25lckRvY3VtZW50SWQsIG5ld1NlbGVjdG9yLCBjaGVja0FmZmVjdHNDYWxsYmFjay5iaW5kKHRoaXMsIG5vZGVJZCwgc3VjY2Vzc0NhbGxiYWNrLCBydWxlUGF5bG9hZCkpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnB1c2godHJ1ZSk7CiAgICAgICAgQ1NTQWdlbnQuc2V0UnVsZVNlbGVjdG9yKHJ1bGVJZCwgbmV3U2VsZWN0b3IsIGNhbGxiYWNrLmJpbmQodGhpcywgbm9kZUlkLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaywgbmV3U2VsZWN0b3IpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0RPTUFnZW50Lk5vZGVJZH0gbm9kZUlkCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLkNTU1J1bGUsIGJvb2xlYW4pfSBzdWNjZXNzQ2FsbGJhY2sKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZmFpbHVyZUNhbGxiYWNrCiAgICAgKi8KICAgIGFkZFJ1bGU6IGZ1bmN0aW9uKG5vZGVJZCwgc2VsZWN0b3IsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKQogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtDU1NBZ2VudC5DU1NSdWxlfSBydWxlUGF5bG9hZAogICAgICAgICAqIEBwYXJhbSB7P0FycmF5LjxET01BZ2VudC5Ob2RlSWQ+fSBzZWxlY3RlZE5vZGVJZHMKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjaGVja0FmZmVjdHNDYWxsYmFjayhub2RlSWQsIHN1Y2Nlc3NDYWxsYmFjaywgcnVsZVBheWxvYWQsIHNlbGVjdGVkTm9kZUlkcykKICAgICAgICB7CiAgICAgICAgICAgIGlmICghc2VsZWN0ZWROb2RlSWRzKQogICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIGRvZXNBZmZlY3RTZWxlY3RlZE5vZGUgPSAoc2VsZWN0ZWROb2RlSWRzLmluZGV4T2Yobm9kZUlkKSA+PSAwKTsKICAgICAgICAgICAgdmFyIHJ1bGUgPSBXZWJJbnNwZWN0b3IuQ1NTUnVsZS5wYXJzZVBheWxvYWQocnVsZVBheWxvYWQpOwogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2socnVsZSwgZG9lc0FmZmVjdFNlbGVjdGVkTm9kZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmYWlsdXJlQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IKICAgICAgICAgKiBAcGFyYW0gez9Qcm90b2NvbC5FcnJvcn0gZXJyb3IKICAgICAgICAgKiBAcGFyYW0gez9DU1NBZ2VudC5DU1NSdWxlfSBydWxlUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrLCBzZWxlY3RvciwgZXJyb3IsIHJ1bGVQYXlsb2FkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wb3AoKTsKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICAvLyBJbnZhbGlkIHN5bnRheCBmb3IgYSBzZWxlY3RvcgogICAgICAgICAgICAgICAgZmFpbHVyZUNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQubWFya1VuZG9hYmxlU3RhdGUoKTsKICAgICAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50SWQgPSB0aGlzLl9vd25lckRvY3VtZW50SWQobm9kZUlkKTsKICAgICAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50SWQpCiAgICAgICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50LnF1ZXJ5U2VsZWN0b3JBbGwob3duZXJEb2N1bWVudElkLCBzZWxlY3RvciwgY2hlY2tBZmZlY3RzQ2FsbGJhY2suYmluZCh0aGlzLCBub2RlSWQsIHN1Y2Nlc3NDYWxsYmFjaywgcnVsZVBheWxvYWQpKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKHRydWUpOwogICAgICAgIENTU0FnZW50LmFkZFJ1bGUobm9kZUlkLCBzZWxlY3RvciwgY2FsbGJhY2suYmluZCh0aGlzLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaywgc2VsZWN0b3IpKTsKICAgIH0sCgogICAgbWVkaWFRdWVyeVJlc3VsdENoYW5nZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMuTWVkaWFRdWVyeVJlc3VsdENoYW5nZWQpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7IUNTU0FnZW50LlN0eWxlU2hlZXRJZH0gaWQKICAgICAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyfQogICAgICovCiAgICBzdHlsZVNoZWV0SGVhZGVyRm9ySWQ6IGZ1bmN0aW9uKGlkKQogICAgewogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlcltpZF07CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7QXJyYXkuPFdlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyPn0KICAgICAqLwogICAgc3R5bGVTaGVldEhlYWRlcnM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlcik7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICovCiAgICBfb3duZXJEb2N1bWVudElkOiBmdW5jdGlvbihub2RlSWQpCiAgICB7CiAgICAgICAgdmFyIG5vZGUgPSBXZWJJbnNwZWN0b3IuZG9tQWdlbnQubm9kZUZvcklkKG5vZGVJZCk7CiAgICAgICAgaWYgKCFub2RlKQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gbm9kZS5vd25lckRvY3VtZW50ID8gbm9kZS5vd25lckRvY3VtZW50LmlkIDogbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gc3R5bGVTaGVldElkCiAgICAgKi8KICAgIF9maXJlU3R5bGVTaGVldENoYW5nZWQ6IGZ1bmN0aW9uKHN0eWxlU2hlZXRJZCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUubGVuZ3RoKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIHZhciBtYWpvckNoYW5nZSA9IHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGVbdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5sZW5ndGggLSAxXTsKCiAgICAgICAgaWYgKCFtYWpvckNoYW5nZSB8fCAhc3R5bGVTaGVldElkIHx8ICF0aGlzLmhhc0V2ZW50TGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5TdHlsZVNoZWV0Q2hhbmdlZCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLlN0eWxlU2hlZXRDaGFuZ2VkLCB7IHN0eWxlU2hlZXRJZDogc3R5bGVTaGVldElkLCBtYWpvckNoYW5nZTogbWFqb3JDaGFuZ2UgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHshQ1NTQWdlbnQuQ1NTU3R5bGVTaGVldEhlYWRlcn0gaGVhZGVyCiAgICAgKi8KICAgIF9zdHlsZVNoZWV0QWRkZWQ6IGZ1bmN0aW9uKGhlYWRlcikKICAgIHsKICAgICAgICBjb25zb2xlLmFzc2VydCghdGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXJbaGVhZGVyLnN0eWxlU2hlZXRJZF0pOwogICAgICAgIHZhciBzdHlsZVNoZWV0SGVhZGVyID0gbmV3IFdlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyKGhlYWRlcik7CiAgICAgICAgdGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXJbaGVhZGVyLnN0eWxlU2hlZXRJZF0gPSBzdHlsZVNoZWV0SGVhZGVyOwogICAgICAgIHZhciB1cmwgPSBzdHlsZVNoZWV0SGVhZGVyLnJlc291cmNlVVJMKCk7CiAgICAgICAgaWYgKCF0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMW3VybF0pCiAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXSA9IHt9OwogICAgICAgIHZhciBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzID0gdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFt1cmxdOwogICAgICAgIHZhciBzdHlsZVNoZWV0SWRzID0gZnJhbWVJZFRvU3R5bGVTaGVldElkc1tzdHlsZVNoZWV0SGVhZGVyLmZyYW1lSWRdOwogICAgICAgIGlmICghc3R5bGVTaGVldElkcykgewogICAgICAgICAgICBzdHlsZVNoZWV0SWRzID0gW107CiAgICAgICAgICAgIGZyYW1lSWRUb1N0eWxlU2hlZXRJZHNbc3R5bGVTaGVldEhlYWRlci5mcmFtZUlkXSA9IHN0eWxlU2hlZXRJZHM7CiAgICAgICAgfQogICAgICAgIHN0eWxlU2hlZXRJZHMucHVzaChzdHlsZVNoZWV0SGVhZGVyLmlkKTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMuU3R5bGVTaGVldEFkZGVkLCBzdHlsZVNoZWV0SGVhZGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0geyFDU1NBZ2VudC5TdHlsZVNoZWV0SWR9IGlkCiAgICAgKi8KICAgIF9zdHlsZVNoZWV0UmVtb3ZlZDogZnVuY3Rpb24oaWQpCiAgICB7CiAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuX3N0eWxlU2hlZXRJZFRvSGVhZGVyW2lkXTsKICAgICAgICBjb25zb2xlLmFzc2VydChoZWFkZXIpOwogICAgICAgIGRlbGV0ZSB0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlcltpZF07CiAgICAgICAgdmFyIHVybCA9IGhlYWRlci5yZXNvdXJjZVVSTCgpOwogICAgICAgIHZhciBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzID0gdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFt1cmxdOwogICAgICAgIGZyYW1lSWRUb1N0eWxlU2hlZXRJZHNbaGVhZGVyLmZyYW1lSWRdLnJlbW92ZShpZCk7CiAgICAgICAgaWYgKCFmcmFtZUlkVG9TdHlsZVNoZWV0SWRzW2hlYWRlci5mcmFtZUlkXS5sZW5ndGgpIHsKICAgICAgICAgICAgZGVsZXRlIGZyYW1lSWRUb1N0eWxlU2hlZXRJZHNbaGVhZGVyLmZyYW1lSWRdOwogICAgICAgICAgICBpZiAoIU9iamVjdC5rZXlzKHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXSkubGVuZ3RoKQogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLlN0eWxlU2hlZXRSZW1vdmVkLCBoZWFkZXIpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwKICAgICAqIEByZXR1cm4ge0FycmF5LjxDU1NBZ2VudC5TdHlsZVNoZWV0SWQ+fQogICAgICovCiAgICBzdHlsZVNoZWV0SWRzRm9yVVJMOiBmdW5jdGlvbih1cmwpCiAgICB7CiAgICAgICAgdmFyIGZyYW1lSWRUb1N0eWxlU2hlZXRJZHMgPSB0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMW3VybF07CiAgICAgICAgaWYgKCFmcmFtZUlkVG9TdHlsZVNoZWV0SWRzKQogICAgICAgICAgICByZXR1cm4gW107CgogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3IgKHZhciBmcmFtZUlkIGluIGZyYW1lSWRUb1N0eWxlU2hlZXRJZHMpCiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoZnJhbWVJZFRvU3R5bGVTaGVldElkc1tmcmFtZUlkXSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsCiAgICAgKiBAcmV0dXJuIHtPYmplY3QuPFBhZ2VBZ2VudC5GcmFtZUlkLCBBcnJheS48Q1NTQWdlbnQuU3R5bGVTaGVldElkPj59CiAgICAgKi8KICAgIHN0eWxlU2hlZXRJZHNCeUZyYW1lSWRGb3JVUkw6IGZ1bmN0aW9uKHVybCkKICAgIHsKICAgICAgICB2YXIgc3R5bGVTaGVldElkc0ZvckZyYW1lID0gdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFt1cmxdOwogICAgICAgIGlmICghc3R5bGVTaGVldElkc0ZvckZyYW1lKQogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgcmV0dXJuIHN0eWxlU2hlZXRJZHNGb3JGcmFtZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gbmFtZWRGbG93UGF5bG9hZAogICAgICovCiAgICBfbmFtZWRGbG93Q3JlYXRlZDogZnVuY3Rpb24obmFtZWRGbG93UGF5bG9hZCkKICAgIHsKICAgICAgICB2YXIgbmFtZWRGbG93ID0gV2ViSW5zcGVjdG9yLk5hbWVkRmxvdy5wYXJzZVBheWxvYWQobmFtZWRGbG93UGF5bG9hZCk7CiAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tuYW1lZEZsb3cuZG9jdW1lbnROb2RlSWRdOwoKICAgICAgICBpZiAoIW5hbWVkRmxvd0NvbGxlY3Rpb24pCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgbmFtZWRGbG93Q29sbGVjdGlvbi5fYXBwZW5kTmFtZWRGbG93KG5hbWVkRmxvdyk7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLk5hbWVkRmxvd0NyZWF0ZWQsIG5hbWVkRmxvdyk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IGRvY3VtZW50Tm9kZUlkCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmxvd05hbWUKICAgICAqLwogICAgX25hbWVkRmxvd1JlbW92ZWQ6IGZ1bmN0aW9uKGRvY3VtZW50Tm9kZUlkLCBmbG93TmFtZSkKICAgIHsKICAgICAgICB2YXIgbmFtZWRGbG93Q29sbGVjdGlvbiA9IHRoaXMuX25hbWVkRmxvd0NvbGxlY3Rpb25zW2RvY3VtZW50Tm9kZUlkXTsKCiAgICAgICAgaWYgKCFuYW1lZEZsb3dDb2xsZWN0aW9uKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIG5hbWVkRmxvd0NvbGxlY3Rpb24uX3JlbW92ZU5hbWVkRmxvdyhmbG93TmFtZSk7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLk5hbWVkRmxvd1JlbW92ZWQsIHsgZG9jdW1lbnROb2RlSWQ6IGRvY3VtZW50Tm9kZUlkLCBmbG93TmFtZTogZmxvd05hbWUgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5OYW1lZEZsb3d9IG5hbWVkRmxvd1BheWxvYWQKICAgICAqLwogICAgX3JlZ2lvbkxheW91dFVwZGF0ZWQ6IGZ1bmN0aW9uKG5hbWVkRmxvd1BheWxvYWQpCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvdyA9IFdlYkluc3BlY3Rvci5OYW1lZEZsb3cucGFyc2VQYXlsb2FkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgICAgIHZhciBuYW1lZEZsb3dDb2xsZWN0aW9uID0gdGhpcy5fbmFtZWRGbG93Q29sbGVjdGlvbnNbbmFtZWRGbG93LmRvY3VtZW50Tm9kZUlkXTsKCiAgICAgICAgaWYgKCFuYW1lZEZsb3dDb2xsZWN0aW9uKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIG5hbWVkRmxvd0NvbGxlY3Rpb24uX2FwcGVuZE5hbWVkRmxvdyhuYW1lZEZsb3cpOwogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5SZWdpb25MYXlvdXRVcGRhdGVkLCBuYW1lZEZsb3cpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuTmFtZWRGbG93fSBuYW1lZEZsb3dQYXlsb2FkCiAgICAgKi8KICAgIF9yZWdpb25PdmVyc2V0Q2hhbmdlZDogZnVuY3Rpb24obmFtZWRGbG93UGF5bG9hZCkKICAgIHsKICAgICAgICB2YXIgbmFtZWRGbG93ID0gV2ViSW5zcGVjdG9yLk5hbWVkRmxvdy5wYXJzZVBheWxvYWQobmFtZWRGbG93UGF5bG9hZCk7CiAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tuYW1lZEZsb3cuZG9jdW1lbnROb2RlSWRdOwoKICAgICAgICAgaWYgKCFuYW1lZEZsb3dDb2xsZWN0aW9uKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIG5hbWVkRmxvd0NvbGxlY3Rpb24uX2FwcGVuZE5hbWVkRmxvdyhuYW1lZEZsb3cpOwogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5SZWdpb25PdmVyc2V0Q2hhbmdlZCwgbmFtZWRGbG93KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gc3R5bGVTaGVldElkCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VGV4dAogICAgICogQHBhcmFtIHtib29sZWFufSBtYWpvckNoYW5nZQogICAgICogQHBhcmFtIHtmdW5jdGlvbig/c3RyaW5nKX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIHNldFN0eWxlU2hlZXRUZXh0OiBmdW5jdGlvbihzdHlsZVNoZWV0SWQsIG5ld1RleHQsIG1ham9yQ2hhbmdlLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soZXJyb3IpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAoIWVycm9yICYmIG1ham9yQ2hhbmdlKQogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm1hcmtVbmRvYWJsZVN0YXRlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWVycm9yICYmIHVzZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhlcnJvcik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaChtYWpvckNoYW5nZSk7CiAgICAgICAgQ1NTQWdlbnQuc2V0U3R5bGVTaGVldFRleHQoc3R5bGVTaGVldElkLCBuZXdUZXh0LCBjYWxsYmFjay5iaW5kKHRoaXMpKTsKICAgIH0sCgogICAgX3VuZG9SZWRvUmVxdWVzdGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKHRydWUpOwogICAgfSwKCiAgICBfdW5kb1JlZG9Db21wbGV0ZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgfSwKCiAgICBfbWFpbkZyYW1lQ3JlYXRlZE9yTmF2aWdhdGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fcmVzZXRTdHlsZVNoZWV0cygpOwogICAgfSwKCiAgICBfcmVzZXRTdHlsZVNoZWV0czogZnVuY3Rpb24oKQogICAgewogICAgICAgIC8qKiBAdHlwZSB7IU9iamVjdC48c3RyaW5nLCAhT2JqZWN0LjxQYWdlQWdlbnQuRnJhbWVJZCwgIUFycmF5LjwhQ1NTQWdlbnQuU3R5bGVTaGVldElkPj4+fSAqLwogICAgICAgIHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkwgPSB7fTsKICAgICAgICAvKiogQHR5cGUgeyFPYmplY3QuPENTU0FnZW50LlN0eWxlU2hlZXRJZCwgIVdlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyPn0gKi8KICAgICAgICB0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlciA9IHt9OwogICAgfSwKCiAgICBfcmVzZXROYW1lZEZsb3dDb2xsZWN0aW9uczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX25hbWVkRmxvd0NvbGxlY3Rpb25zID0ge307CiAgICB9LAoKICAgIHVwZGF0ZUxvY2F0aW9uczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBoZWFkZXJzID0gT2JqZWN0LnZhbHVlcyh0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlcik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoZWFkZXJzLmxlbmd0aDsgKytpKQogICAgICAgICAgICBoZWFkZXJzW2ldLnVwZGF0ZUxvY2F0aW9ucygpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuU3R5bGVTaGVldElkfSBzdHlsZVNoZWV0SWQKICAgICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLkNTU0xvY2F0aW9ufSByYXdMb2NhdGlvbgogICAgICogQHBhcmFtIHtmdW5jdGlvbihXZWJJbnNwZWN0b3IuVUlMb2NhdGlvbik6KGJvb2xlYW58dW5kZWZpbmVkKX0gdXBkYXRlRGVsZWdhdGUKICAgICAqIEByZXR1cm4gez9XZWJJbnNwZWN0b3IuTGl2ZUxvY2F0aW9ufQogICAgICovCiAgICBjcmVhdGVMaXZlTG9jYXRpb246IGZ1bmN0aW9uKHN0eWxlU2hlZXRJZCwgcmF3TG9jYXRpb24sIHVwZGF0ZURlbGVnYXRlKQogICAgewogICAgICAgIGlmICghcmF3TG9jYXRpb24pCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLnN0eWxlU2hlZXRIZWFkZXJGb3JJZChzdHlsZVNoZWV0SWQpOwogICAgICAgIGlmICghaGVhZGVyKQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gaGVhZGVyLmNyZWF0ZUxpdmVMb2NhdGlvbihyYXdMb2NhdGlvbiwgdXBkYXRlRGVsZWdhdGUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLkNTU0xvY2F0aW9ufSByYXdMb2NhdGlvbgogICAgICogQHJldHVybiB7P1dlYkluc3BlY3Rvci5VSUxvY2F0aW9ufQogICAgICovCiAgICByYXdMb2NhdGlvblRvVUlMb2NhdGlvbjogZnVuY3Rpb24ocmF3TG9jYXRpb24pCiAgICB7CiAgICAgICAgdmFyIGZyYW1lSWRUb1NoZWV0SWRzID0gdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFtyYXdMb2NhdGlvbi51cmxdOwogICAgICAgIGlmICghZnJhbWVJZFRvU2hlZXRJZHMpCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIHZhciBzdHlsZVNoZWV0SWRzID0gW107CiAgICAgICAgZm9yICh2YXIgZnJhbWVJZCBpbiBmcmFtZUlkVG9TaGVldElkcykKICAgICAgICAgICAgc3R5bGVTaGVldElkcyA9IHN0eWxlU2hlZXRJZHMuY29uY2F0KGZyYW1lSWRUb1NoZWV0SWRzW2ZyYW1lSWRdKTsKICAgICAgICB2YXIgdWlMb2NhdGlvbjsKICAgICAgICBmb3IgKHZhciBpID0gMDsgIXVpTG9jYXRpb24gJiYgaSA8IHN0eWxlU2hlZXRJZHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuc3R5bGVTaGVldEhlYWRlckZvcklkKHN0eWxlU2hlZXRJZHNbaV0pOwogICAgICAgICAgICBjb25zb2xlLmFzc2VydChoZWFkZXIpOwogICAgICAgICAgICB1aUxvY2F0aW9uID0gaGVhZGVyLnJhd0xvY2F0aW9uVG9VSUxvY2F0aW9uKHJhd0xvY2F0aW9uLmxpbmVOdW1iZXIsIHJhd0xvY2F0aW9uLmNvbHVtbk51bWJlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1aUxvY2F0aW9uIHx8IG51bGw7CiAgICB9LAoKICAgIF9fcHJvdG9fXzogV2ViSW5zcGVjdG9yLk9iamVjdC5wcm90b3R5cGUKfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAZXh0ZW5kcyB7V2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbn0KICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb259IHJhd0xvY2F0aW9uCiAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLlVJTG9jYXRpb24pOihib29sZWFufHVuZGVmaW5lZCl9IHVwZGF0ZURlbGVnYXRlCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5MaXZlTG9jYXRpb24gPSBmdW5jdGlvbihyYXdMb2NhdGlvbiwgdXBkYXRlRGVsZWdhdGUsIGhlYWRlcikKewogICAgV2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbi5jYWxsKHRoaXMsIHJhd0xvY2F0aW9uLCB1cGRhdGVEZWxlZ2F0ZSk7CiAgICB0aGlzLl9oZWFkZXIgPSBoZWFkZXI7Cn0KCldlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkxpdmVMb2NhdGlvbi5wcm90b3R5cGUgPSB7CiAgICAvKioKICAgICAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5VSUxvY2F0aW9ufQogICAgICovCiAgICB1aUxvY2F0aW9uOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGNzc0xvY2F0aW9uID0gLyoqIEB0eXBlIFdlYkluc3BlY3Rvci5DU1NMb2NhdGlvbiAqLyAodGhpcy5yYXdMb2NhdGlvbigpKTsKICAgICAgICByZXR1cm4gdGhpcy5faGVhZGVyLnJhd0xvY2F0aW9uVG9VSUxvY2F0aW9uKGNzc0xvY2F0aW9uLmxpbmVOdW1iZXIsIGNzc0xvY2F0aW9uLmNvbHVtbk51bWJlcik7CiAgICB9LAoKICAgIGRpc3Bvc2U6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBXZWJJbnNwZWN0b3IuTGl2ZUxvY2F0aW9uLnByb3RvdHlwZS5kaXNwb3NlLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5faGVhZGVyLl9yZW1vdmVMb2NhdGlvbih0aGlzKTsKICAgIH0sCgogICAgX19wcm90b19fOiBXZWJJbnNwZWN0b3IuTGl2ZUxvY2F0aW9uLnByb3RvdHlwZQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBpbXBsZW1lbnRzIHtXZWJJbnNwZWN0b3IuUmF3TG9jYXRpb259CiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwKICogQHBhcmFtIHtudW1iZXJ9IGxpbmVOdW1iZXIKICogQHBhcmFtIHtudW1iZXI9fSBjb2x1bW5OdW1iZXIKICovCldlYkluc3BlY3Rvci5DU1NMb2NhdGlvbiA9IGZ1bmN0aW9uKHVybCwgbGluZU51bWJlciwgY29sdW1uTnVtYmVyKQp7CiAgICB0aGlzLnVybCA9IHVybDsKICAgIHRoaXMubGluZU51bWJlciA9IGxpbmVOdW1iZXI7CiAgICB0aGlzLmNvbHVtbk51bWJlciA9IGNvbHVtbk51bWJlciB8fCAwOwp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGV9IHBheWxvYWQKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdGhpcy5pZCA9IHBheWxvYWQuc3R5bGVJZDsKICAgIHRoaXMud2lkdGggPSBwYXlsb2FkLndpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBwYXlsb2FkLmhlaWdodDsKICAgIHRoaXMucmFuZ2UgPSBwYXlsb2FkLnJhbmdlOwogICAgdGhpcy5fc2hvcnRoYW5kVmFsdWVzID0gV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24uYnVpbGRTaG9ydGhhbmRWYWx1ZU1hcChwYXlsb2FkLnNob3J0aGFuZEVudHJpZXMpOwogICAgdGhpcy5fbGl2ZVByb3BlcnR5TWFwID0ge307IC8vIExJVkUgcHJvcGVydGllcyAoc291cmNlLWJhc2VkIG9yIHN0eWxlLWJhc2VkKSA6IHsgbmFtZSAtPiBDU1NQcm9wZXJ0eSB9CiAgICB0aGlzLl9hbGxQcm9wZXJ0aWVzID0gW107IC8vIEFMTCBwcm9wZXJ0aWVzOiBbIENTU1Byb3BlcnR5IF0KICAgIHRoaXMuX19kaXNhYmxlZFByb3BlcnRpZXMgPSB7fTsgLy8gRElTQUJMRUQgcHJvcGVydGllczogeyBpbmRleCAtPiBDU1NQcm9wZXJ0eSB9CiAgICB2YXIgcGF5bG9hZFByb3BlcnR5Q291bnQgPSBwYXlsb2FkLmNzc1Byb3BlcnRpZXMubGVuZ3RoOwoKICAgIHZhciBwcm9wZXJ0eUluZGV4ID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF5bG9hZFByb3BlcnR5Q291bnQ7ICsraSkgewogICAgICAgIHZhciBwcm9wZXJ0eSA9IFdlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eS5wYXJzZVBheWxvYWQodGhpcywgaSwgcGF5bG9hZC5jc3NQcm9wZXJ0aWVzW2ldKTsKICAgICAgICB0aGlzLl9hbGxQcm9wZXJ0aWVzLnB1c2gocHJvcGVydHkpOwogICAgICAgIGlmIChwcm9wZXJ0eS5kaXNhYmxlZCkKICAgICAgICAgICAgdGhpcy5fX2Rpc2FibGVkUHJvcGVydGllc1tpXSA9IHByb3BlcnR5OwogICAgICAgIGlmICghcHJvcGVydHkuYWN0aXZlICYmICFwcm9wZXJ0eS5zdHlsZUJhc2VkKQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB2YXIgbmFtZSA9IHByb3BlcnR5Lm5hbWU7CiAgICAgICAgdGhpc1twcm9wZXJ0eUluZGV4XSA9IG5hbWU7CiAgICAgICAgdGhpcy5fbGl2ZVByb3BlcnR5TWFwW25hbWVdID0gcHJvcGVydHk7CiAgICAgICAgKytwcm9wZXJ0eUluZGV4OwogICAgfQogICAgdGhpcy5sZW5ndGggPSBwcm9wZXJ0eUluZGV4OwogICAgaWYgKCJjc3NUZXh0IiBpbiBwYXlsb2FkKQogICAgICAgIHRoaXMuY3NzVGV4dCA9IHBheWxvYWQuY3NzVGV4dDsKfQoKLyoqCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LlNob3J0aGFuZEVudHJ5Pn0gc2hvcnRoYW5kRW50cmllcwogKiBAcmV0dXJuIHtPYmplY3R9CiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5idWlsZFNob3J0aGFuZFZhbHVlTWFwID0gZnVuY3Rpb24oc2hvcnRoYW5kRW50cmllcykKewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaG9ydGhhbmRFbnRyaWVzLmxlbmd0aDsgKytpKQogICAgICAgIHJlc3VsdFtzaG9ydGhhbmRFbnRyaWVzW2ldLm5hbWVdID0gc2hvcnRoYW5kRW50cmllc1tpXS52YWx1ZTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8qKgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlfSBwYXlsb2FkCiAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9ufQogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucGFyc2VQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgcmV0dXJuIG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbihwYXlsb2FkKTsKfQoKLyoqCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LkNTU0NvbXB1dGVkU3R5bGVQcm9wZXJ0eT59IHBheWxvYWQKICogQHJldHVybiB7V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb259CiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZUNvbXB1dGVkU3R5bGVQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdmFyIG5ld1BheWxvYWQgPSAvKiogQHR5cGUge0NTU0FnZW50LkNTU1N0eWxlfSAqLyAoeyBjc3NQcm9wZXJ0aWVzOiBbXSwgc2hvcnRoYW5kRW50cmllczogW10sIHdpZHRoOiAiIiwgaGVpZ2h0OiAiIiB9KTsKICAgIGlmIChwYXlsb2FkKQogICAgICAgIG5ld1BheWxvYWQuY3NzUHJvcGVydGllcyA9IHBheWxvYWQ7CgogICAgcmV0dXJuIG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbihuZXdQYXlsb2FkKTsKfQoKV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucHJvdG90eXBlID0gewogICAgZ2V0IGFsbFByb3BlcnRpZXMoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLl9hbGxQcm9wZXJ0aWVzOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICAgKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuQ1NTUHJvcGVydHl8dW5kZWZpbmVkfQogICAgICovCiAgICBnZXRMaXZlUHJvcGVydHk6IGZ1bmN0aW9uKG5hbWUpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2xpdmVQcm9wZXJ0eU1hcFtuYW1lXTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICBnZXRQcm9wZXJ0eVZhbHVlOiBmdW5jdGlvbihuYW1lKQogICAgewogICAgICAgIHZhciBwcm9wZXJ0eSA9IHRoaXMuX2xpdmVQcm9wZXJ0eU1hcFtuYW1lXTsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPyBwcm9wZXJ0eS52YWx1ZSA6ICIiOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgKi8KICAgIGdldFByb3BlcnR5UHJpb3JpdHk6IGZ1bmN0aW9uKG5hbWUpCiAgICB7CiAgICAgICAgdmFyIHByb3BlcnR5ID0gdGhpcy5fbGl2ZVByb3BlcnR5TWFwW25hbWVdOwogICAgICAgIHJldHVybiBwcm9wZXJ0eSA/IHByb3BlcnR5LnByaW9yaXR5IDogIiI7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAgKi8KICAgIGlzUHJvcGVydHlJbXBsaWNpdDogZnVuY3Rpb24obmFtZSkKICAgIHsKICAgICAgICB2YXIgcHJvcGVydHkgPSB0aGlzLl9saXZlUHJvcGVydHlNYXBbbmFtZV07CiAgICAgICAgcmV0dXJuIHByb3BlcnR5ID8gcHJvcGVydHkuaW1wbGljaXQgOiAiIjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHJldHVybiB7QXJyYXkuPFdlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eT59CiAgICAgKi8KICAgIGxvbmdoYW5kUHJvcGVydGllczogZnVuY3Rpb24obmFtZSkKICAgIHsKICAgICAgICB2YXIgbG9uZ2hhbmRzID0gV2ViSW5zcGVjdG9yLkNTU01ldGFkYXRhLmNzc1Byb3BlcnRpZXNNZXRhaW5mby5sb25naGFuZHMobmFtZSk7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBsb25naGFuZHMgJiYgaSA8IGxvbmdoYW5kcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB2YXIgcHJvcGVydHkgPSB0aGlzLl9saXZlUHJvcGVydHlNYXBbbG9uZ2hhbmRzW2ldXTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5KQogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocHJvcGVydHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzaG9ydGhhbmRQcm9wZXJ0eQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICBzaG9ydGhhbmRWYWx1ZTogZnVuY3Rpb24oc2hvcnRoYW5kUHJvcGVydHkpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Nob3J0aGFuZFZhbHVlc1tzaG9ydGhhbmRQcm9wZXJ0eV07CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICAgKiBAcmV0dXJuIHs/V2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5fQogICAgICovCiAgICBwcm9wZXJ0eUF0OiBmdW5jdGlvbihpbmRleCkKICAgIHsKICAgICAgICByZXR1cm4gKGluZGV4IDwgdGhpcy5hbGxQcm9wZXJ0aWVzLmxlbmd0aCkgPyB0aGlzLmFsbFByb3BlcnRpZXNbaW5kZXhdIDogbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAgKi8KICAgIHBhc3RMYXN0U291cmNlUHJvcGVydHlJbmRleDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmFsbFByb3BlcnRpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gdGhpcy5hbGxQcm9wZXJ0aWVzW2ldOwogICAgICAgICAgICBpZiAocHJvcGVydHkuYWN0aXZlIHx8IHByb3BlcnR5LmRpc2FibGVkKQogICAgICAgICAgICAgICAgcmV0dXJuIGkgKyAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcj19IGluZGV4CiAgICAgKi8KICAgIG5ld0JsYW5rUHJvcGVydHk6IGZ1bmN0aW9uKGluZGV4KQogICAgewogICAgICAgIGluZGV4ID0gKHR5cGVvZiBpbmRleCA9PT0gInVuZGVmaW5lZCIpID8gdGhpcy5wYXN0TGFzdFNvdXJjZVByb3BlcnR5SW5kZXgoKSA6IGluZGV4OwogICAgICAgIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5KHRoaXMsIGluZGV4LCAiIiwgIiIsICIiLCAiYWN0aXZlIiwgdHJ1ZSwgZmFsc2UsICIiKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKT19IHVzZXJDYWxsYmFjawogICAgICovCiAgICBpbnNlcnRQcm9wZXJ0eUF0OiBmdW5jdGlvbihpbmRleCwgbmFtZSwgdmFsdWUsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGVycm9yCiAgICAgICAgICogQHBhcmFtIHtDU1NBZ2VudC5DU1NTdHlsZX0gcGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yLCBwYXlsb2FkKQogICAgICAgIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAoIXVzZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7CiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChwYXlsb2FkKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoaXMuaWQpCiAgICAgICAgICAgIHRocm93ICJObyBzdHlsZSBpZCI7CgogICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKHRydWUpOwogICAgICAgIENTU0FnZW50LnNldFByb3BlcnR5VGV4dCh0aGlzLmlkLCBpbmRleCwgbmFtZSArICI6ICIgKyB2YWx1ZSArICI7IiwgZmFsc2UsIGNhbGxiYWNrLmJpbmQodGhpcykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKT19IHVzZXJDYWxsYmFjawogICAgICovCiAgICBhcHBlbmRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSwgdmFsdWUsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICB0aGlzLmluc2VydFByb3BlcnR5QXQodGhpcy5hbGxQcm9wZXJ0aWVzLmxlbmd0aCwgbmFtZSwgdmFsdWUsIHVzZXJDYWxsYmFjayk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKT19IHVzZXJDYWxsYmFjawogICAgICovCiAgICBzZXRUZXh0OiBmdW5jdGlvbih0ZXh0LCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGV9IHBheWxvYWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhlcnJvciwgcGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wb3AoKTsKICAgICAgICAgICAgaWYgKCF1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQocGF5bG9hZCkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLmlkKQogICAgICAgICAgICB0aHJvdyAiTm8gc3R5bGUgaWQiOwoKICAgICAgICBpZiAodHlwZW9mIHRoaXMuY3NzVGV4dCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaCh0cnVlKTsKICAgICAgICBDU1NBZ2VudC5zZXRTdHlsZVRleHQodGhpcy5pZCwgdGV4dCwgY2FsbGJhY2spOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTUnVsZX0gcGF5bG9hZAogKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+PX0gbWF0Y2hpbmdTZWxlY3RvcnMKICovCldlYkluc3BlY3Rvci5DU1NSdWxlID0gZnVuY3Rpb24ocGF5bG9hZCwgbWF0Y2hpbmdTZWxlY3RvcnMpCnsKICAgIHRoaXMuaWQgPSBwYXlsb2FkLnJ1bGVJZDsKICAgIGlmIChtYXRjaGluZ1NlbGVjdG9ycykKICAgICAgICB0aGlzLm1hdGNoaW5nU2VsZWN0b3JzID0gbWF0Y2hpbmdTZWxlY3RvcnM7CiAgICB0aGlzLnNlbGVjdG9ycyA9IHBheWxvYWQuc2VsZWN0b3JMaXN0LnNlbGVjdG9yczsKICAgIHRoaXMuc2VsZWN0b3JUZXh0ID0gdGhpcy5zZWxlY3RvcnMuam9pbigiLCAiKTsKICAgIHRoaXMuc2VsZWN0b3JSYW5nZSA9IHBheWxvYWQuc2VsZWN0b3JMaXN0LnJhbmdlOwogICAgdGhpcy5zb3VyY2VVUkwgPSBwYXlsb2FkLnNvdXJjZVVSTDsKICAgIHRoaXMub3JpZ2luID0gcGF5bG9hZC5vcmlnaW47CiAgICB0aGlzLnN0eWxlID0gV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucGFyc2VQYXlsb2FkKHBheWxvYWQuc3R5bGUpOwogICAgdGhpcy5zdHlsZS5wYXJlbnRSdWxlID0gdGhpczsKICAgIGlmIChwYXlsb2FkLm1lZGlhKQogICAgICAgIHRoaXMubWVkaWEgPSBXZWJJbnNwZWN0b3IuQ1NTTWVkaWEucGFyc2VNZWRpYUFycmF5UGF5bG9hZChwYXlsb2FkLm1lZGlhKTsKICAgIHRoaXMuX3NldFJhd0xvY2F0aW9uQW5kRnJhbWVJZCgpOwp9CgovKioKICogQHBhcmFtIHtDU1NBZ2VudC5DU1NSdWxlfSBwYXlsb2FkCiAqIEBwYXJhbSB7QXJyYXkuPG51bWJlcj49fSBtYXRjaGluZ0luZGljZXMKICogQHJldHVybiB7V2ViSW5zcGVjdG9yLkNTU1J1bGV9CiAqLwpXZWJJbnNwZWN0b3IuQ1NTUnVsZS5wYXJzZVBheWxvYWQgPSBmdW5jdGlvbihwYXlsb2FkLCBtYXRjaGluZ0luZGljZXMpCnsKICAgIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yLkNTU1J1bGUocGF5bG9hZCwgbWF0Y2hpbmdJbmRpY2VzKTsKfQoKV2ViSW5zcGVjdG9yLkNTU1J1bGUucHJvdG90eXBlID0gewogICAgX3NldFJhd0xvY2F0aW9uQW5kRnJhbWVJZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5pZCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIHZhciBzdHlsZVNoZWV0SGVhZGVyID0gV2ViSW5zcGVjdG9yLmNzc01vZGVsLnN0eWxlU2hlZXRIZWFkZXJGb3JJZCh0aGlzLmlkLnN0eWxlU2hlZXRJZCk7CiAgICAgICAgdGhpcy5mcmFtZUlkID0gc3R5bGVTaGVldEhlYWRlci5mcmFtZUlkOwogICAgICAgIHZhciB1cmwgPSBzdHlsZVNoZWV0SGVhZGVyLnJlc291cmNlVVJMKCk7CiAgICAgICAgaWYgKCF1cmwpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB0aGlzLnJhd0xvY2F0aW9uID0gbmV3IFdlYkluc3BlY3Rvci5DU1NMb2NhdGlvbih1cmwsIHRoaXMubGluZU51bWJlckluU291cmNlKCksIHRoaXMuY29sdW1uTnVtYmVySW5Tb3VyY2UoKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICByZXNvdXJjZVVSTDogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5pZCkKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIHZhciBzdHlsZVNoZWV0SGVhZGVyID0gV2ViSW5zcGVjdG9yLmNzc01vZGVsLnN0eWxlU2hlZXRIZWFkZXJGb3JJZCh0aGlzLmlkLnN0eWxlU2hlZXRJZCk7CiAgICAgICAgcmV0dXJuIHN0eWxlU2hlZXRIZWFkZXIucmVzb3VyY2VVUkwoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAgKi8KICAgIGxpbmVOdW1iZXJJblNvdXJjZTogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5zZWxlY3RvclJhbmdlKQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB2YXIgc3R5bGVTaGVldEhlYWRlciA9IFdlYkluc3BlY3Rvci5jc3NNb2RlbC5zdHlsZVNoZWV0SGVhZGVyRm9ySWQodGhpcy5pZC5zdHlsZVNoZWV0SWQpOwogICAgICAgIHJldHVybiBzdHlsZVNoZWV0SGVhZGVyLmxpbmVOdW1iZXJJblNvdXJjZSh0aGlzLnNlbGVjdG9yUmFuZ2Uuc3RhcnRMaW5lKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ8dW5kZWZpbmVkfQogICAgICovCiAgICBjb2x1bW5OdW1iZXJJblNvdXJjZTogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5zZWxlY3RvclJhbmdlKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHZhciBzdHlsZVNoZWV0SGVhZGVyID0gV2ViSW5zcGVjdG9yLmNzc01vZGVsLnN0eWxlU2hlZXRIZWFkZXJGb3JJZCh0aGlzLmlkLnN0eWxlU2hlZXRJZCk7CiAgICAgICAgY29uc29sZS5hc3NlcnQoc3R5bGVTaGVldEhlYWRlcik7CiAgICAgICAgcmV0dXJuIHN0eWxlU2hlZXRIZWFkZXIuY29sdW1uTnVtYmVySW5Tb3VyY2UodGhpcy5zZWxlY3RvclJhbmdlLnN0YXJ0TGluZSwgdGhpcy5zZWxlY3RvclJhbmdlLnN0YXJ0Q29sdW1uKTsKICAgIH0sCgogICAgZ2V0IGlzVXNlckFnZW50KCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5vcmlnaW4gPT09ICJ1c2VyLWFnZW50IjsKICAgIH0sCgogICAgZ2V0IGlzVXNlcigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luID09PSAidXNlciI7CiAgICB9LAoKICAgIGdldCBpc1ZpYUluc3BlY3RvcigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luID09PSAiaW5zcGVjdG9yIjsKICAgIH0sCgogICAgZ2V0IGlzUmVndWxhcigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luID09PSAicmVndWxhciI7CiAgICB9Cn0KCi8qKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHs/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb259IG93bmVyU3R5bGUKICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZQogKiBAcGFyYW0gez9zdHJpbmd9IHByaW9yaXR5CiAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0dXMKICogQHBhcmFtIHtib29sZWFufSBwYXJzZWRPawogKiBAcGFyYW0ge2Jvb2xlYW59IGltcGxpY2l0CiAqIEBwYXJhbSB7P3N0cmluZz19IHRleHQKICogQHBhcmFtIHtDU1NBZ2VudC5Tb3VyY2VSYW5nZT19IHJhbmdlCiAqLwpXZWJJbnNwZWN0b3IuQ1NTUHJvcGVydHkgPSBmdW5jdGlvbihvd25lclN0eWxlLCBpbmRleCwgbmFtZSwgdmFsdWUsIHByaW9yaXR5LCBzdGF0dXMsIHBhcnNlZE9rLCBpbXBsaWNpdCwgdGV4dCwgcmFuZ2UpCnsKICAgIHRoaXMub3duZXJTdHlsZSA9IG93bmVyU3R5bGU7CiAgICB0aGlzLmluZGV4ID0gaW5kZXg7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgdGhpcy5wcmlvcml0eSA9IHByaW9yaXR5OwogICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICB0aGlzLnBhcnNlZE9rID0gcGFyc2VkT2s7CiAgICB0aGlzLmltcGxpY2l0ID0gaW1wbGljaXQ7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy5yYW5nZSA9IHJhbmdlOwp9CgovKioKICogQHBhcmFtIHs/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb259IG93bmVyU3R5bGUKICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTUHJvcGVydHl9IHBheWxvYWQKICogQHJldHVybiB7V2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5fQogKi8KV2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5LnBhcnNlUGF5bG9hZCA9IGZ1bmN0aW9uKG93bmVyU3R5bGUsIGluZGV4LCBwYXlsb2FkKQp7CiAgICAvLyBUaGUgZm9sbG93aW5nIGRlZmF1bHQgZmllbGQgdmFsdWVzIGFyZSB1c2VkIGluIHRoZSBwYXlsb2FkOgogICAgLy8gcHJpb3JpdHk6ICIiCiAgICAvLyBwYXJzZWRPazogdHJ1ZQogICAgLy8gaW1wbGljaXQ6IGZhbHNlCiAgICAvLyBzdGF0dXM6ICJzdHlsZSIKICAgIHZhciByZXN1bHQgPSBuZXcgV2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5KAogICAgICAgIG93bmVyU3R5bGUsIGluZGV4LCBwYXlsb2FkLm5hbWUsIHBheWxvYWQudmFsdWUsIHBheWxvYWQucHJpb3JpdHkgfHwgIiIsIHBheWxvYWQuc3RhdHVzIHx8ICJzdHlsZSIsICgicGFyc2VkT2siIGluIHBheWxvYWQpID8gISFwYXlsb2FkLnBhcnNlZE9rIDogdHJ1ZSwgISFwYXlsb2FkLmltcGxpY2l0LCBwYXlsb2FkLnRleHQsIHBheWxvYWQucmFuZ2UpOwogICAgcmV0dXJuIHJlc3VsdDsKfQoKV2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5LnByb3RvdHlwZSA9IHsKICAgIGdldCBwcm9wZXJ0eVRleHQoKQogICAgewogICAgICAgIGlmICh0aGlzLnRleHQgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGV4dDsKCiAgICAgICAgaWYgKHRoaXMubmFtZSA9PT0gIiIpCiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lICsgIjogIiArIHRoaXMudmFsdWUgKyAodGhpcy5wcmlvcml0eSA/ICIgISIgKyB0aGlzLnByaW9yaXR5IDogIiIpICsgIjsiOwogICAgfSwKCiAgICBnZXQgaXNMaXZlKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmUgfHwgdGhpcy5zdHlsZUJhc2VkOwogICAgfSwKCiAgICBnZXQgYWN0aXZlKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09ICJhY3RpdmUiOwogICAgfSwKCiAgICBnZXQgc3R5bGVCYXNlZCgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHVzID09PSAic3R5bGUiOwogICAgfSwKCiAgICBnZXQgaW5hY3RpdmUoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gImluYWN0aXZlIjsKICAgIH0sCgogICAgZ2V0IGRpc2FibGVkKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09ICJkaXNhYmxlZCI7CiAgICB9LAoKICAgIC8qKgogICAgICogUmVwbGFjZXMgInByb3BlcnR5TmFtZTogcHJvcGVydHlWYWx1ZSBbIWltcG9ydGFudF07IiBpbiB0aGUgc3R5bGVzaGVldCBieSBhbiBhcmJpdHJhcnkgcHJvcGVydHlUZXh0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eVRleHQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbWFqb3JDaGFuZ2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcndyaXRlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbik9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgc2V0VGV4dDogZnVuY3Rpb24ocHJvcGVydHlUZXh0LCBtYWpvckNoYW5nZSwgb3ZlcndyaXRlLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb259IHN0eWxlCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZW5hYmxlZENhbGxiYWNrKHN0eWxlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVzZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhzdHlsZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGVycm9yCiAgICAgICAgICogQHBhcmFtIHs/Q1NTQWdlbnQuQ1NTU3R5bGV9IHN0eWxlUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yLCBzdHlsZVBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmICghZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChtYWpvckNoYW5nZSkKICAgICAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQubWFya1VuZG9hYmxlU3RhdGUoKTsKICAgICAgICAgICAgICAgIHRoaXMudGV4dCA9IHByb3BlcnR5VGV4dDsKICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChzdHlsZVBheWxvYWQpOwogICAgICAgICAgICAgICAgdmFyIG5ld1Byb3BlcnR5ID0gc3R5bGUuYWxsUHJvcGVydGllc1t0aGlzLmluZGV4XTsKCiAgICAgICAgICAgICAgICBpZiAobmV3UHJvcGVydHkgJiYgdGhpcy5kaXNhYmxlZCAmJiAhcHJvcGVydHlUZXh0Lm1hdGNoKC9eXHMqJC8pKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3UHJvcGVydHkuc2V0RGlzYWJsZWQoZmFsc2UsIGVuYWJsZWRDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKHN0eWxlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoaXMub3duZXJTdHlsZSkKICAgICAgICAgICAgdGhyb3cgIk5vIG93bmVyU3R5bGUgZm9yIHByb3BlcnR5IjsKCiAgICAgICAgaWYgKCF0aGlzLm93bmVyU3R5bGUuaWQpCiAgICAgICAgICAgIHRocm93ICJObyBvd25lciBzdHlsZSBpZCI7CgogICAgICAgIC8vIEFuIGluZGV4IHBhc3QgYWxsIHRoZSBwcm9wZXJ0aWVzIGFkZHMgYSBuZXcgcHJvcGVydHkgdG8gdGhlIHN0eWxlLgogICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKG1ham9yQ2hhbmdlKTsKICAgICAgICBDU1NBZ2VudC5zZXRQcm9wZXJ0eVRleHQodGhpcy5vd25lclN0eWxlLmlkLCB0aGlzLmluZGV4LCBwcm9wZXJ0eVRleHQsIG92ZXJ3cml0ZSwgY2FsbGJhY2suYmluZCh0aGlzKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1ZhbHVlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG1ham9yQ2hhbmdlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG92ZXJ3cml0ZQogICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24pPX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIHNldFZhbHVlOiBmdW5jdGlvbihuZXdWYWx1ZSwgbWFqb3JDaGFuZ2UsIG92ZXJ3cml0ZSwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIHZhciB0ZXh0ID0gdGhpcy5uYW1lICsgIjogIiArIG5ld1ZhbHVlICsgKHRoaXMucHJpb3JpdHkgPyAiICEiICsgdGhpcy5wcmlvcml0eSA6ICIiKSArICI7IgogICAgICAgIHRoaXMuc2V0VGV4dCh0ZXh0LCBtYWpvckNoYW5nZSwgb3ZlcndyaXRlLCB1c2VyQ2FsbGJhY2spOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZGlzYWJsZWQKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKT19IHVzZXJDYWxsYmFjawogICAgICovCiAgICBzZXREaXNhYmxlZDogZnVuY3Rpb24oZGlzYWJsZWQsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAoIXRoaXMub3duZXJTdHlsZSAmJiB1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICBpZiAoZGlzYWJsZWQgPT09IHRoaXMuZGlzYWJsZWQgJiYgdXNlckNhbGxiYWNrKQogICAgICAgICAgICB1c2VyQ2FsbGJhY2sodGhpcy5vd25lclN0eWxlKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGV9IHN0eWxlUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yLCBzdHlsZVBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKHVzZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm1hcmtVbmRvYWJsZVN0YXRlKCk7CiAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChzdHlsZVBheWxvYWQpOwogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKHN0eWxlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm93bmVyU3R5bGUuaWQpCiAgICAgICAgICAgIHRocm93ICJObyBvd25lciBzdHlsZSBpZCI7CgogICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKGZhbHNlKTsKICAgICAgICBDU1NBZ2VudC50b2dnbGVQcm9wZXJ0eSh0aGlzLm93bmVyU3R5bGUuaWQsIHRoaXMuaW5kZXgsIGRpc2FibGVkLCBjYWxsYmFjay5iaW5kKHRoaXMpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvck5hbWUKICAgICAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5VSUxvY2F0aW9ufQogICAgICovCiAgICB1aUxvY2F0aW9uOiBmdW5jdGlvbihmb3JOYW1lKQogICAgewogICAgICAgIGlmICghdGhpcy5yYW5nZSB8fCAhdGhpcy5vd25lclN0eWxlIHx8ICF0aGlzLm93bmVyU3R5bGUucGFyZW50UnVsZSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgIHZhciB1cmwgPSB0aGlzLm93bmVyU3R5bGUucGFyZW50UnVsZS5yZXNvdXJjZVVSTCgpOwogICAgICAgIGlmICghdXJsKQogICAgICAgICAgICByZXR1cm4gbnVsbDsKCiAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5yYW5nZTsKICAgICAgICB2YXIgbGluZSA9IGZvck5hbWUgPyByYW5nZS5zdGFydExpbmUgOiByYW5nZS5lbmRMaW5lOwogICAgICAgIC8vIEVuZCBvZiByYW5nZSBpcyBleGNsdXNpdmUsIHNvIHN1YnRyYWN0IDEgZnJvbSB0aGUgZW5kIG9mZnNldC4KICAgICAgICB2YXIgY29sdW1uID0gZm9yTmFtZSA/IHJhbmdlLnN0YXJ0Q29sdW1uIDogcmFuZ2UuZW5kQ29sdW1uIC0gKHRoaXMudGV4dCAmJiB0aGlzLnRleHQuZW5kc1dpdGgoIjsiKSA/IDIgOiAxKTsKICAgICAgICB2YXIgcmF3TG9jYXRpb24gPSBuZXcgV2ViSW5zcGVjdG9yLkNTU0xvY2F0aW9uKHVybCwgbGluZSwgY29sdW1uKTsKICAgICAgICByZXR1cm4gV2ViSW5zcGVjdG9yLmNzc01vZGVsLnJhd0xvY2F0aW9uVG9VSUxvY2F0aW9uKHJhd0xvY2F0aW9uKTsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU01lZGlhfSBwYXlsb2FkCiAqLwpXZWJJbnNwZWN0b3IuQ1NTTWVkaWEgPSBmdW5jdGlvbihwYXlsb2FkKQp7CiAgICB0aGlzLnRleHQgPSBwYXlsb2FkLnRleHQ7CiAgICB0aGlzLnNvdXJjZSA9IHBheWxvYWQuc291cmNlOwogICAgdGhpcy5zb3VyY2VVUkwgPSBwYXlsb2FkLnNvdXJjZVVSTCB8fCAiIjsKICAgIHRoaXMucmFuZ2UgPSBwYXlsb2FkLnJhbmdlOwogICAgdGhpcy5wYXJlbnRTdHlsZVNoZWV0SWQgPSBwYXlsb2FkLnBhcmVudFN0eWxlU2hlZXRJZDsKfQoKV2ViSW5zcGVjdG9yLkNTU01lZGlhLlNvdXJjZSA9IHsKICAgIExJTktFRF9TSEVFVDogImxpbmtlZFNoZWV0IiwKICAgIElOTElORV9TSEVFVDogImlubGluZVNoZWV0IiwKICAgIE1FRElBX1JVTEU6ICJtZWRpYVJ1bGUiLAogICAgSU1QT1JUX1JVTEU6ICJpbXBvcnRSdWxlIgp9OwoKLyoqCiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTTWVkaWF9IHBheWxvYWQKICogQHJldHVybiB7V2ViSW5zcGVjdG9yLkNTU01lZGlhfQogKi8KV2ViSW5zcGVjdG9yLkNTU01lZGlhLnBhcnNlUGF5bG9hZCA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yLkNTU01lZGlhKHBheWxvYWQpOwp9CgovKioKICogQHBhcmFtIHtBcnJheS48Q1NTQWdlbnQuQ1NTTWVkaWE+fSBwYXlsb2FkCiAqIEByZXR1cm4ge0FycmF5LjxXZWJJbnNwZWN0b3IuQ1NTTWVkaWE+fQogKi8KV2ViSW5zcGVjdG9yLkNTU01lZGlhLnBhcnNlTWVkaWFBcnJheVBheWxvYWQgPSBmdW5jdGlvbihwYXlsb2FkKQp7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBheWxvYWQubGVuZ3RoOyArK2kpCiAgICAgICAgcmVzdWx0LnB1c2goV2ViSW5zcGVjdG9yLkNTU01lZGlhLnBhcnNlUGF5bG9hZChwYXlsb2FkW2ldKSk7CiAgICByZXR1cm4gcmVzdWx0Owp9CgpXZWJJbnNwZWN0b3IuQ1NTTWVkaWEucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ8dW5kZWZpbmVkfQogICAgICovCiAgICBsaW5lTnVtYmVySW5Tb3VyY2U6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMucmFuZ2UpCiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuaGVhZGVyKCk7CiAgICAgICAgaWYgKCFoZWFkZXIpCiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIGhlYWRlci5saW5lTnVtYmVySW5Tb3VyY2UodGhpcy5yYW5nZS5zdGFydExpbmUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4ge251bWJlcnx1bmRlZmluZWR9CiAgICAgKi8KICAgIGNvbHVtbk51bWJlckluU291cmNlOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLnJhbmdlKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLmhlYWRlcigpOwogICAgICAgIGlmICghaGVhZGVyKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHJldHVybiBoZWFkZXIuY29sdW1uTnVtYmVySW5Tb3VyY2UodGhpcy5yYW5nZS5zdGFydExpbmUsIHRoaXMucmFuZ2Uuc3RhcnRDb2x1bW4pOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4gez9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlcn0KICAgICAqLwogICAgaGVhZGVyOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50U3R5bGVTaGVldElkID8gV2ViSW5zcGVjdG9yLmNzc01vZGVsLnN0eWxlU2hlZXRIZWFkZXJGb3JJZCh0aGlzLnBhcmVudFN0eWxlU2hlZXRJZCkgOiBudWxsOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBpbXBsZW1lbnRzIHtXZWJJbnNwZWN0b3IuQ29udGVudFByb3ZpZGVyfQogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlU2hlZXRIZWFkZXJ9IHBheWxvYWQKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdGhpcy5pZCA9IHBheWxvYWQuc3R5bGVTaGVldElkOwogICAgdGhpcy5mcmFtZUlkID0gcGF5bG9hZC5mcmFtZUlkOwogICAgdGhpcy5zb3VyY2VVUkwgPSBwYXlsb2FkLnNvdXJjZVVSTDsKICAgIHRoaXMuaGFzU291cmNlVVJMID0gISFwYXlsb2FkLmhhc1NvdXJjZVVSTDsKICAgIHRoaXMuc291cmNlTWFwVVJMID0gcGF5bG9hZC5zb3VyY2VNYXBVUkw7CiAgICB0aGlzLm9yaWdpbiA9IHBheWxvYWQub3JpZ2luOwogICAgdGhpcy50aXRsZSA9IHBheWxvYWQudGl0bGU7CiAgICB0aGlzLmRpc2FibGVkID0gcGF5bG9hZC5kaXNhYmxlZDsKICAgIHRoaXMuaXNJbmxpbmUgPSBwYXlsb2FkLmlzSW5saW5lOwogICAgdGhpcy5zdGFydExpbmUgPSBwYXlsb2FkLnN0YXJ0TGluZTsKICAgIHRoaXMuc3RhcnRDb2x1bW4gPSBwYXlsb2FkLnN0YXJ0Q29sdW1uOwogICAgLyoqIEB0eXBlIHshU2V0LjwhV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuTGl2ZUxvY2F0aW9uPn0gKi8KICAgIHRoaXMuX2xvY2F0aW9ucyA9IG5ldyBTZXQoKTsKICAgIC8qKiBAdHlwZSB7IUFycmF5LjwhV2ViSW5zcGVjdG9yLlNvdXJjZU1hcHBpbmc+fSAqLwogICAgdGhpcy5fc291cmNlTWFwcGluZ3MgPSBbXTsKfQoKV2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXRIZWFkZXIucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgKi8KICAgIHJlc291cmNlVVJMOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luID09PSAiaW5zcGVjdG9yIiA/IHRoaXMuX3ZpYUluc3BlY3RvclJlc291cmNlVVJMKCkgOiB0aGlzLnNvdXJjZVVSTDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5DU1NMb2NhdGlvbn0gcmF3TG9jYXRpb24KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLlVJTG9jYXRpb24pOihib29sZWFufHVuZGVmaW5lZCl9IHVwZGF0ZURlbGVnYXRlCiAgICAgKiBAcmV0dXJuIHs/V2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbn0KICAgICAqLwogICAgY3JlYXRlTGl2ZUxvY2F0aW9uOiBmdW5jdGlvbihyYXdMb2NhdGlvbiwgdXBkYXRlRGVsZWdhdGUpCiAgICB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gbmV3IFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkxpdmVMb2NhdGlvbihyYXdMb2NhdGlvbiwgdXBkYXRlRGVsZWdhdGUsIHRoaXMpOwogICAgICAgIHRoaXMuX2xvY2F0aW9ucy5hZGQobG9jYXRpb24pOwogICAgICAgIGxvY2F0aW9uLnVwZGF0ZSgpOwogICAgICAgIHJldHVybiBsb2NhdGlvbjsKICAgIH0sCgogICAgdXBkYXRlTG9jYXRpb25zOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5fbG9jYXRpb25zLml0ZW1zKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgaXRlbXNbaV0udXBkYXRlKCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHshV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuTGl2ZUxvY2F0aW9ufSBsb2NhdGlvbgogICAgICovCiAgICBfcmVtb3ZlTG9jYXRpb246IGZ1bmN0aW9uKGxvY2F0aW9uKQogICAgewogICAgICAgIHRoaXMuX2xvY2F0aW9ucy5yZW1vdmUobG9jYXRpb24pOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lTnVtYmVyCiAgICAgKiBAcGFyYW0ge251bWJlcj19IGNvbHVtbk51bWJlcgogICAgICogQHJldHVybiB7P1dlYkluc3BlY3Rvci5VSUxvY2F0aW9ufQogICAgICovCiAgICByYXdMb2NhdGlvblRvVUlMb2NhdGlvbjogZnVuY3Rpb24obGluZU51bWJlciwgY29sdW1uTnVtYmVyKQogICAgewogICAgICAgIHZhciB1aUxvY2F0aW9uOwogICAgICAgIHZhciByYXdMb2NhdGlvbiA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb24odGhpcy5yZXNvdXJjZVVSTCgpLCBsaW5lTnVtYmVyLCBjb2x1bW5OdW1iZXIgfHwgMCk7CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3NvdXJjZU1hcHBpbmdzLmxlbmd0aCAtIDE7ICF1aUxvY2F0aW9uICYmIGkgPj0gMDsgLS1pKQogICAgICAgICAgICB1aUxvY2F0aW9uID0gdGhpcy5fc291cmNlTWFwcGluZ3NbaV0ucmF3TG9jYXRpb25Ub1VJTG9jYXRpb24ocmF3TG9jYXRpb24pOwogICAgICAgIHJldHVybiB1aUxvY2F0aW9uIHx8IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHshV2ViSW5zcGVjdG9yLlNvdXJjZU1hcHBpbmd9IHNvdXJjZU1hcHBpbmcKICAgICAqLwogICAgcHVzaFNvdXJjZU1hcHBpbmc6IGZ1bmN0aW9uKHNvdXJjZU1hcHBpbmcpCiAgICB7CiAgICAgICAgdGhpcy5fc291cmNlTWFwcGluZ3MucHVzaChzb3VyY2VNYXBwaW5nKTsKICAgICAgICB0aGlzLnVwZGF0ZUxvY2F0aW9ucygpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAqLwogICAgX2tleTogZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiB0aGlzLmZyYW1lSWQgKyAiOiIgKyB0aGlzLnJlc291cmNlVVJMKCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICBfdmlhSW5zcGVjdG9yUmVzb3VyY2VVUkw6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgZnJhbWUgPSBXZWJJbnNwZWN0b3IucmVzb3VyY2VUcmVlTW9kZWwuZnJhbWVGb3JJZCh0aGlzLmZyYW1lSWQpOwogICAgICAgIGNvbnNvbGUuYXNzZXJ0KGZyYW1lKTsKICAgICAgICB2YXIgcGFyc2VkVVJMID0gbmV3IFdlYkluc3BlY3Rvci5QYXJzZWRVUkwoZnJhbWUudXJsKTsKICAgICAgICB2YXIgZmFrZVVSTCA9ICJpbnNwZWN0b3I6Ly8iICsgcGFyc2VkVVJMLmhvc3QgKyBwYXJzZWRVUkwuZm9sZGVyUGF0aENvbXBvbmVudHM7CiAgICAgICAgaWYgKCFmYWtlVVJMLmVuZHNXaXRoKCIvIikpCiAgICAgICAgICAgIGZha2VVUkwgKz0gIi8iOwogICAgICAgIGZha2VVUkwgKz0gImluc3BlY3Rvci1zdHlsZXNoZWV0IjsKICAgICAgICByZXR1cm4gZmFrZVVSTDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGluZU51bWJlckluU3R5bGVTaGVldAogICAgICogQHJldHVybiB7bnVtYmVyfQogICAgICovCiAgICBsaW5lTnVtYmVySW5Tb3VyY2U6IGZ1bmN0aW9uKGxpbmVOdW1iZXJJblN0eWxlU2hlZXQpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRMaW5lICsgbGluZU51bWJlckluU3R5bGVTaGVldDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGluZU51bWJlckluU3R5bGVTaGVldAogICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbHVtbk51bWJlckluU3R5bGVTaGVldAogICAgICogQHJldHVybiB7bnVtYmVyfHVuZGVmaW5lZH0KICAgICAqLwogICAgY29sdW1uTnVtYmVySW5Tb3VyY2U6IGZ1bmN0aW9uKGxpbmVOdW1iZXJJblN0eWxlU2hlZXQsIGNvbHVtbk51bWJlckluU3R5bGVTaGVldCkKICAgIHsKICAgICAgICByZXR1cm4gKGxpbmVOdW1iZXJJblN0eWxlU2hlZXQgPyAwIDogdGhpcy5zdGFydENvbHVtbikgKyBjb2x1bW5OdW1iZXJJblN0eWxlU2hlZXQ7CiAgICB9LAoKICAgIC8qKgogICAgICogQG92ZXJyaWRlCiAgICAgKi8KICAgIGNvbnRlbnRVUkw6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXNvdXJjZVVSTCgpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBvdmVycmlkZQogICAgICovCiAgICBjb250ZW50VHlwZTogZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiBXZWJJbnNwZWN0b3IucmVzb3VyY2VUeXBlcy5TdHlsZXNoZWV0OwogICAgfSwKCiAgICAvKioKICAgICAqIEBvdmVycmlkZQogICAgICovCiAgICByZXF1ZXN0Q29udGVudDogZnVuY3Rpb24oY2FsbGJhY2spCiAgICB7CiAgICAgICAgQ1NTQWdlbnQuZ2V0U3R5bGVTaGVldFRleHQodGhpcy5pZCwgdGV4dENhbGxiYWNrLmJpbmQodGhpcykpOwoKICAgICAgICBmdW5jdGlvbiB0ZXh0Q2FsbGJhY2soZXJyb3IsIHRleHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5sb2coIkZhaWxlZCB0byBnZXQgdGV4dCBmb3Igc3R5bGVzaGVldCAiICsgdGhpcy5pZCArICI6ICIgKyBlcnJvcik7CiAgICAgICAgICAgICAgICB0ZXh0ID0gIiI7CiAgICAgICAgICAgICAgICAvLyBGYWxsIHRocm91Z2guCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2sodGV4dCwgZmFsc2UsICJ0ZXh0L2NzcyIpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAb3ZlcnJpZGUKICAgICAqLwogICAgc2VhcmNoSW5Db250ZW50OiBmdW5jdGlvbihxdWVyeSwgY2FzZVNlbnNpdGl2ZSwgaXNSZWdleCwgY2FsbGJhY2spCiAgICB7CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVNlYXJjaChjb250ZW50KQogICAgICAgIHsKICAgICAgICAgICAgY2FsbGJhY2soV2ViSW5zcGVjdG9yLkNvbnRlbnRQcm92aWRlci5wZXJmb3JtU2VhcmNoSW5Db250ZW50KGNvbnRlbnQsIHF1ZXJ5LCBjYXNlU2Vuc2l0aXZlLCBpc1JlZ2V4KSk7CiAgICAgICAgfQoKICAgICAgICAvLyBzZWFyY2hJbkNvbnRlbnQgc2hvdWxkIGNhbGwgYmFjayBsYXRlci4KICAgICAgICB0aGlzLnJlcXVlc3RDb250ZW50KHBlcmZvcm1TZWFyY2gpOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGVTaGVldEJvZHl9IHBheWxvYWQKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0ID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdGhpcy5pZCA9IHBheWxvYWQuc3R5bGVTaGVldElkOwogICAgdGhpcy5ydWxlcyA9IFtdOwogICAgdGhpcy5zdHlsZXMgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF5bG9hZC5ydWxlcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBydWxlID0gV2ViSW5zcGVjdG9yLkNTU1J1bGUucGFyc2VQYXlsb2FkKHBheWxvYWQucnVsZXNbaV0pOwogICAgICAgIHRoaXMucnVsZXMucHVzaChydWxlKTsKICAgICAgICBpZiAocnVsZS5zdHlsZSkKICAgICAgICAgICAgdGhpcy5zdHlsZXNbcnVsZS5zdHlsZS5pZF0gPSBydWxlLnN0eWxlOwogICAgfQogICAgaWYgKCJ0ZXh0IiBpbiBwYXlsb2FkKQogICAgICAgIHRoaXMuX3RleHQgPSBwYXlsb2FkLnRleHQ7Cn0KCi8qKgogKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gc3R5bGVTaGVldElkCiAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0KX0gdXNlckNhbGxiYWNrCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldC5jcmVhdGVGb3JJZCA9IGZ1bmN0aW9uKHN0eWxlU2hlZXRJZCwgdXNlckNhbGxiYWNrKQp7CiAgICAvKioKICAgICAqIEBwYXJhbSB7P3N0cmluZ30gZXJyb3IKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGVTaGVldEJvZHl9IHN0eWxlU2hlZXRQYXlsb2FkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yLCBzdHlsZVNoZWV0UGF5bG9hZCkKICAgIHsKICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHVzZXJDYWxsYmFjayhuZXcgV2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXQoc3R5bGVTaGVldFBheWxvYWQpKTsKICAgIH0KICAgIENTU0FnZW50LmdldFN0eWxlU2hlZXQoc3R5bGVTaGVldElkLCBjYWxsYmFjay5iaW5kKHRoaXMpKTsKfQoKV2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXQucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8dW5kZWZpbmVkfQogICAgICovCiAgICBnZXRUZXh0OiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RleHQ7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1RleHQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbWFqb3JDaGFuZ2UKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP3N0cmluZyk9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgc2V0VGV4dDogZnVuY3Rpb24obmV3VGV4dCwgbWFqb3JDaGFuZ2UsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGVycm9yCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soZXJyb3IpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWVycm9yKQogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm1hcmtVbmRvYWJsZVN0YXRlKCk7CgogICAgICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2soZXJyb3IpOwogICAgICAgIH0KCiAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnB1c2gobWFqb3JDaGFuZ2UpOwogICAgICAgIENTU0FnZW50LnNldFN0eWxlU2hlZXRUZXh0KHRoaXMuaWQsIG5ld1RleHQsIGNhbGxiYWNrLmJpbmQodGhpcykpOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBpbXBsZW1lbnRzIHtDU1NBZ2VudC5EaXNwYXRjaGVyfQogKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsfSBjc3NNb2RlbAogKi8KV2ViSW5zcGVjdG9yLkNTU0Rpc3BhdGNoZXIgPSBmdW5jdGlvbihjc3NNb2RlbCkKewogICAgdGhpcy5fY3NzTW9kZWwgPSBjc3NNb2RlbDsKfQoKV2ViSW5zcGVjdG9yLkNTU0Rpc3BhdGNoZXIucHJvdG90eXBlID0gewogICAgbWVkaWFRdWVyeVJlc3VsdENoYW5nZWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl9jc3NNb2RlbC5tZWRpYVF1ZXJ5UmVzdWx0Q2hhbmdlZCgpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuU3R5bGVTaGVldElkfSBzdHlsZVNoZWV0SWQKICAgICAqLwogICAgc3R5bGVTaGVldENoYW5nZWQ6IGZ1bmN0aW9uKHN0eWxlU2hlZXRJZCkKICAgIHsKICAgICAgICB0aGlzLl9jc3NNb2RlbC5fZmlyZVN0eWxlU2hlZXRDaGFuZ2VkKHN0eWxlU2hlZXRJZCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5DU1NTdHlsZVNoZWV0SGVhZGVyfSBoZWFkZXIKICAgICAqLwogICAgc3R5bGVTaGVldEFkZGVkOiBmdW5jdGlvbihoZWFkZXIpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX3N0eWxlU2hlZXRBZGRlZChoZWFkZXIpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuU3R5bGVTaGVldElkfSBpZAogICAgICovCiAgICBzdHlsZVNoZWV0UmVtb3ZlZDogZnVuY3Rpb24oaWQpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX3N0eWxlU2hlZXRSZW1vdmVkKGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gbmFtZWRGbG93UGF5bG9hZAogICAgICovCiAgICBuYW1lZEZsb3dDcmVhdGVkOiBmdW5jdGlvbihuYW1lZEZsb3dQYXlsb2FkKQogICAgewogICAgICAgIHRoaXMuX2Nzc01vZGVsLl9uYW1lZEZsb3dDcmVhdGVkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBkb2N1bWVudE5vZGVJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IGZsb3dOYW1lCiAgICAgKi8KICAgIG5hbWVkRmxvd1JlbW92ZWQ6IGZ1bmN0aW9uKGRvY3VtZW50Tm9kZUlkLCBmbG93TmFtZSkKICAgIHsKICAgICAgICB0aGlzLl9jc3NNb2RlbC5fbmFtZWRGbG93UmVtb3ZlZChkb2N1bWVudE5vZGVJZCwgZmxvd05hbWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuTmFtZWRGbG93fSBuYW1lZEZsb3dQYXlsb2FkCiAgICAgKi8KICAgIHJlZ2lvbkxheW91dFVwZGF0ZWQ6IGZ1bmN0aW9uKG5hbWVkRmxvd1BheWxvYWQpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX3JlZ2lvbkxheW91dFVwZGF0ZWQobmFtZWRGbG93UGF5bG9hZCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5OYW1lZEZsb3d9IG5hbWVkRmxvd1BheWxvYWQKICAgICAqLwogICAgcmVnaW9uT3ZlcnNldENoYW5nZWQ6IGZ1bmN0aW9uKG5hbWVkRmxvd1BheWxvYWQpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX3JlZ2lvbk92ZXJzZXRDaGFuZ2VkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7Q1NTQWdlbnQuTmFtZWRGbG93fSBwYXlsb2FkCiAqLwpXZWJJbnNwZWN0b3IuTmFtZWRGbG93ID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdGhpcy5kb2N1bWVudE5vZGVJZCA9IHBheWxvYWQuZG9jdW1lbnROb2RlSWQ7CiAgICB0aGlzLm5hbWUgPSBwYXlsb2FkLm5hbWU7CiAgICB0aGlzLm92ZXJzZXQgPSBwYXlsb2FkLm92ZXJzZXQ7CiAgICB0aGlzLmNvbnRlbnQgPSBwYXlsb2FkLmNvbnRlbnQ7CiAgICB0aGlzLnJlZ2lvbnMgPSBwYXlsb2FkLnJlZ2lvbnM7Cn0KCi8qKgogKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gcGF5bG9hZAogKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuTmFtZWRGbG93fQogKi8KV2ViSW5zcGVjdG9yLk5hbWVkRmxvdy5wYXJzZVBheWxvYWQgPSBmdW5jdGlvbihwYXlsb2FkKQp7CiAgICByZXR1cm4gbmV3IFdlYkluc3BlY3Rvci5OYW1lZEZsb3cocGF5bG9hZCk7Cn0KCi8qKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtBcnJheS48Q1NTQWdlbnQuTmFtZWRGbG93Pn0gcGF5bG9hZAogKi8KV2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb24gPSBmdW5jdGlvbihwYXlsb2FkKQp7CiAgICAvKiogQHR5cGUge09iamVjdC48c3RyaW5nLCBXZWJJbnNwZWN0b3IuTmFtZWRGbG93Pn0gKi8KICAgIHRoaXMubmFtZWRGbG93TWFwID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXlsb2FkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIG5hbWVkRmxvdyA9IFdlYkluc3BlY3Rvci5OYW1lZEZsb3cucGFyc2VQYXlsb2FkKHBheWxvYWRbaV0pOwogICAgICAgIHRoaXMubmFtZWRGbG93TWFwW25hbWVkRmxvdy5uYW1lXSA9IG5hbWVkRmxvdzsKICAgIH0KfQoKV2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb24ucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5OYW1lZEZsb3d9IG5hbWVkRmxvdwogICAgICovCiAgICBfYXBwZW5kTmFtZWRGbG93OiBmdW5jdGlvbihuYW1lZEZsb3cpCiAgICB7CiAgICAgICAgdGhpcy5uYW1lZEZsb3dNYXBbbmFtZWRGbG93Lm5hbWVdID0gbmFtZWRGbG93OwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmbG93TmFtZQogICAgICovCiAgICBfcmVtb3ZlTmFtZWRGbG93OiBmdW5jdGlvbihmbG93TmFtZSkKICAgIHsKICAgICAgICBkZWxldGUgdGhpcy5uYW1lZEZsb3dNYXBbZmxvd05hbWVdOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmbG93TmFtZQogICAgICogQHJldHVybiB7V2ViSW5zcGVjdG9yLk5hbWVkRmxvd30KICAgICAqLwogICAgZmxvd0J5TmFtZTogZnVuY3Rpb24oZmxvd05hbWUpCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvdyA9IHRoaXMubmFtZWRGbG93TWFwW2Zsb3dOYW1lXTsKCiAgICAgICAgaWYgKCFuYW1lZEZsb3cpCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIHJldHVybiBuYW1lZEZsb3c7CiAgICB9Cn0KLyoqCiAqIEB0eXBlIHtXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbH0KICovCldlYkluc3BlY3Rvci5jc3NNb2RlbCA9IG51bGw7Cg==",
                "body": "LyoKICogQ29weXJpZ2h0IChDKSAyMDEwIEdvb2dsZSBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqCiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dAogKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlCiAqIG1ldDoKICoKICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQKICogbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLgogKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlCiAqIGNvcHlyaWdodCBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIKICogaW4gdGhlIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZQogKiBkaXN0cmlidXRpb24uCiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgR29vZ2xlIEluYy4gbm9yIHRoZSBuYW1lcyBvZiBpdHMKICogY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cyBkZXJpdmVkIGZyb20KICogdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KICoKICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUwogKiAiQVMgSVMiIEFORCBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVAogKiBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRCBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IKICogQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQKICogT1dORVIgT1IgQ09OVFJJQlVUT1JTIEJFIExJQUJMRSBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsCiAqIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNMVURJTkcsIEJVVCBOT1QKICogTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsgTE9TUyBPRiBVU0UsCiAqIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWQogKiBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUCiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRQogKiBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgogKi8KCi8qKgogKiBAY29uc3RydWN0b3IKICogQGV4dGVuZHMge1dlYkluc3BlY3Rvci5PYmplY3R9CiAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLldvcmtzcGFjZX0gd29ya3NwYWNlCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbCA9IGZ1bmN0aW9uKHdvcmtzcGFjZSkKewogICAgdGhpcy5fd29ya3NwYWNlID0gd29ya3NwYWNlOwogICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZSA9IFtdOwogICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkRPTUFnZW50LkV2ZW50cy5VbmRvUmVkb1JlcXVlc3RlZCwgdGhpcy5fdW5kb1JlZG9SZXF1ZXN0ZWQsIHRoaXMpOwogICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50LmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLkRPTUFnZW50LkV2ZW50cy5VbmRvUmVkb0NvbXBsZXRlZCwgdGhpcy5fdW5kb1JlZG9Db21wbGV0ZWQsIHRoaXMpOwogICAgV2ViSW5zcGVjdG9yLnJlc291cmNlVHJlZU1vZGVsLmFkZEV2ZW50TGlzdGVuZXIoV2ViSW5zcGVjdG9yLlJlc291cmNlVHJlZU1vZGVsLkV2ZW50VHlwZXMuTWFpbkZyYW1lQ3JlYXRlZE9yTmF2aWdhdGVkLCB0aGlzLl9tYWluRnJhbWVDcmVhdGVkT3JOYXZpZ2F0ZWQsIHRoaXMpOwogICAgdGhpcy5fbmFtZWRGbG93Q29sbGVjdGlvbnMgPSB7fTsKICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5hZGRFdmVudExpc3RlbmVyKFdlYkluc3BlY3Rvci5ET01BZ2VudC5FdmVudHMuRG9jdW1lbnRVcGRhdGVkLCB0aGlzLl9yZXNldE5hbWVkRmxvd0NvbGxlY3Rpb25zLCB0aGlzKTsKICAgIEluc3BlY3RvckJhY2tlbmQucmVnaXN0ZXJDU1NEaXNwYXRjaGVyKG5ldyBXZWJJbnNwZWN0b3IuQ1NTRGlzcGF0Y2hlcih0aGlzKSk7CiAgICBDU1NBZ2VudC5lbmFibGUoKTsKICAgIHRoaXMuX3Jlc2V0U3R5bGVTaGVldHMoKTsKfQoKLyoqCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LkNTU1J1bGU+fSBydWxlQXJyYXkKICovCldlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLnBhcnNlUnVsZUFycmF5UGF5bG9hZCA9IGZ1bmN0aW9uKHJ1bGVBcnJheSkKewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBydWxlQXJyYXkubGVuZ3RoOyArK2kpCiAgICAgICAgcmVzdWx0LnB1c2goV2ViSW5zcGVjdG9yLkNTU1J1bGUucGFyc2VQYXlsb2FkKHJ1bGVBcnJheVtpXSkpOwogICAgcmV0dXJuIHJlc3VsdDsKfQogICAgCi8qKgogKiBAcGFyYW0ge0FycmF5LjxDU1NBZ2VudC5SdWxlTWF0Y2g+fSBtYXRjaEFycmF5CiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5wYXJzZVJ1bGVNYXRjaEFycmF5UGF5bG9hZCA9IGZ1bmN0aW9uKG1hdGNoQXJyYXkpCnsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWF0Y2hBcnJheS5sZW5ndGg7ICsraSkKICAgICAgICByZXN1bHQucHVzaChXZWJJbnNwZWN0b3IuQ1NTUnVsZS5wYXJzZVBheWxvYWQobWF0Y2hBcnJheVtpXS5ydWxlLCBtYXRjaEFycmF5W2ldLm1hdGNoaW5nU2VsZWN0b3JzKSk7CiAgICByZXR1cm4gcmVzdWx0Owp9CgpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMgPSB7CiAgICBTdHlsZVNoZWV0QWRkZWQ6ICJTdHlsZVNoZWV0QWRkZWQiLAogICAgU3R5bGVTaGVldENoYW5nZWQ6ICJTdHlsZVNoZWV0Q2hhbmdlZCIsCiAgICBTdHlsZVNoZWV0UmVtb3ZlZDogIlN0eWxlU2hlZXRSZW1vdmVkIiwKICAgIE1lZGlhUXVlcnlSZXN1bHRDaGFuZ2VkOiAiTWVkaWFRdWVyeVJlc3VsdENoYW5nZWQiLAogICAgTmFtZWRGbG93Q3JlYXRlZDogIk5hbWVkRmxvd0NyZWF0ZWQiLAogICAgTmFtZWRGbG93UmVtb3ZlZDogIk5hbWVkRmxvd1JlbW92ZWQiLAogICAgUmVnaW9uTGF5b3V0VXBkYXRlZDogIlJlZ2lvbkxheW91dFVwZGF0ZWQiLAogICAgUmVnaW9uT3ZlcnNldENoYW5nZWQ6ICJSZWdpb25PdmVyc2V0Q2hhbmdlZCIKfQoKV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuTWVkaWFUeXBlcyA9IFsiYWxsIiwgImJyYWlsbGUiLCAiZW1ib3NzZWQiLCAiaGFuZGhlbGQiLCAicHJpbnQiLCAicHJvamVjdGlvbiIsICJzY3JlZW4iLCAic3BlZWNoIiwgInR0eSIsICJ0diJdOwoKV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcGFyYW0ge0RPTUFnZW50Lk5vZGVJZH0gbm9kZUlkCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG5lZWRQc2V1ZG8KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZEluaGVyaXRlZAogICAgICogQHBhcmFtIHtmdW5jdGlvbig/Kil9IHVzZXJDYWxsYmFjawogICAgICovCiAgICBnZXRNYXRjaGVkU3R5bGVzQXN5bmM6IGZ1bmN0aW9uKG5vZGVJZCwgbmVlZFBzZXVkbywgbmVlZEluaGVyaXRlZCwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oPyopfSB1c2VyQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gez9Qcm90b2NvbC5FcnJvcn0gZXJyb3IKICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxDU1NBZ2VudC5SdWxlTWF0Y2g+PX0gbWF0Y2hlZFBheWxvYWQKICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxDU1NBZ2VudC5Qc2V1ZG9JZE1hdGNoZXM+PX0gcHNldWRvUGF5bG9hZAogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LkluaGVyaXRlZFN0eWxlRW50cnk+PX0gaW5oZXJpdGVkUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHVzZXJDYWxsYmFjaywgZXJyb3IsIG1hdGNoZWRQYXlsb2FkLCBwc2V1ZG9QYXlsb2FkLCBpbmhlcml0ZWRQYXlsb2FkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBpZiAobWF0Y2hlZFBheWxvYWQpCiAgICAgICAgICAgICAgICByZXN1bHQubWF0Y2hlZENTU1J1bGVzID0gV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwucGFyc2VSdWxlTWF0Y2hBcnJheVBheWxvYWQobWF0Y2hlZFBheWxvYWQpOwoKICAgICAgICAgICAgaWYgKHBzZXVkb1BheWxvYWQpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wc2V1ZG9FbGVtZW50cyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwc2V1ZG9QYXlsb2FkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5UGF5bG9hZCA9IHBzZXVkb1BheWxvYWRbaV07CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnBzZXVkb0VsZW1lbnRzLnB1c2goeyBwc2V1ZG9JZDogZW50cnlQYXlsb2FkLnBzZXVkb0lkLCBydWxlczogV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwucGFyc2VSdWxlTWF0Y2hBcnJheVBheWxvYWQoZW50cnlQYXlsb2FkLm1hdGNoZXMpIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW5oZXJpdGVkUGF5bG9hZCkgewogICAgICAgICAgICAgICAgcmVzdWx0LmluaGVyaXRlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmhlcml0ZWRQYXlsb2FkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5UGF5bG9hZCA9IGluaGVyaXRlZFBheWxvYWRbaV07CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0ge307CiAgICAgICAgICAgICAgICAgICAgaWYgKGVudHJ5UGF5bG9hZC5pbmxpbmVTdHlsZSkKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkuaW5saW5lU3R5bGUgPSBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQoZW50cnlQYXlsb2FkLmlubGluZVN0eWxlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnlQYXlsb2FkLm1hdGNoZWRDU1NSdWxlcykKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkubWF0Y2hlZENTU1J1bGVzID0gV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwucGFyc2VSdWxlTWF0Y2hBcnJheVBheWxvYWQoZW50cnlQYXlsb2FkLm1hdGNoZWRDU1NSdWxlcyk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmluaGVyaXRlZC5wdXNoKGVudHJ5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHVzZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhyZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgQ1NTQWdlbnQuZ2V0TWF0Y2hlZFN0eWxlc0Zvck5vZGUobm9kZUlkLCBuZWVkUHNldWRvLCBuZWVkSW5oZXJpdGVkLCBjYWxsYmFjay5iaW5kKG51bGwsIHVzZXJDYWxsYmFjaykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIGdldENvbXB1dGVkU3R5bGVBc3luYzogZnVuY3Rpb24obm9kZUlkLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24pfSB1c2VyQ2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayh1c2VyQ2FsbGJhY2ssIGVycm9yLCBjb21wdXRlZFBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IgfHwgIWNvbXB1dGVkUGF5bG9hZCkKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlQ29tcHV0ZWRTdHlsZVBheWxvYWQoY29tcHV0ZWRQYXlsb2FkKSk7CiAgICAgICAgfQoKICAgICAgICBDU1NBZ2VudC5nZXRDb21wdXRlZFN0eWxlRm9yTm9kZShub2RlSWQsIGNhbGxiYWNrLmJpbmQobnVsbCwgdXNlckNhbGxiYWNrKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJ9IG5vZGVJZAogICAgICogQHBhcmFtIHtmdW5jdGlvbig/U3RyaW5nLCA/QXJyYXkuPENTU0FnZW50LlBsYXRmb3JtRm9udFVzYWdlPil9IGNhbGxiYWNrCiAgICAgKi8KICAgIGdldFBsYXRmb3JtRm9udHNGb3JOb2RlOiBmdW5jdGlvbihub2RlSWQsIGNhbGxiYWNrKQogICAgewogICAgICAgIGZ1bmN0aW9uIHBsYXRmb3JtRm9udHNDYWxsYmFjayhlcnJvciwgY3NzRmFtaWx5TmFtZSwgZm9udHMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgY2FsbGJhY2soY3NzRmFtaWx5TmFtZSwgZm9udHMpOwogICAgICAgIH0KICAgICAgICBDU1NBZ2VudC5nZXRQbGF0Zm9ybUZvbnRzRm9yTm9kZShub2RlSWQsIHBsYXRmb3JtRm9udHNDYWxsYmFjayk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24sID9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbil9IHVzZXJDYWxsYmFjawogICAgICovCiAgICBnZXRJbmxpbmVTdHlsZXNBc3luYzogZnVuY3Rpb24obm9kZUlkLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24sID9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbil9IHVzZXJDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7P1Byb3RvY29sLkVycm9yfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7P0NTU0FnZW50LkNTU1N0eWxlPX0gaW5saW5lUGF5bG9hZAogICAgICAgICAqIEBwYXJhbSB7P0NTU0FnZW50LkNTU1N0eWxlPX0gYXR0cmlidXRlc1N0eWxlUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHVzZXJDYWxsYmFjaywgZXJyb3IsIGlubGluZVBheWxvYWQsIGF0dHJpYnV0ZXNTdHlsZVBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IgfHwgIWlubGluZVBheWxvYWQpCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCwgbnVsbCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQoaW5saW5lUGF5bG9hZCksIGF0dHJpYnV0ZXNTdHlsZVBheWxvYWQgPyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQoYXR0cmlidXRlc1N0eWxlUGF5bG9hZCkgOiBudWxsKTsKICAgICAgICB9CgogICAgICAgIENTU0FnZW50LmdldElubGluZVN0eWxlc0Zvck5vZGUobm9kZUlkLCBjYWxsYmFjay5iaW5kKG51bGwsIHVzZXJDYWxsYmFjaykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAqIEBwYXJhbSB7P0FycmF5LjxzdHJpbmc+fHVuZGVmaW5lZH0gZm9yY2VkUHNldWRvQ2xhc3NlcwogICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIGZvcmNlUHNldWRvU3RhdGU6IGZ1bmN0aW9uKG5vZGVJZCwgZm9yY2VkUHNldWRvQ2xhc3NlcywgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIENTU0FnZW50LmZvcmNlUHNldWRvU3RhdGUobm9kZUlkLCBmb3JjZWRQc2V1ZG9DbGFzc2VzIHx8IFtdLCB1c2VyQ2FsbGJhY2spOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBkb2N1bWVudE5vZGVJZAogICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb24pfSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgZ2V0TmFtZWRGbG93Q29sbGVjdGlvbkFzeW5jOiBmdW5jdGlvbihkb2N1bWVudE5vZGVJZCwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIHZhciBuYW1lZEZsb3dDb2xsZWN0aW9uID0gdGhpcy5fbmFtZWRGbG93Q29sbGVjdGlvbnNbZG9jdW1lbnROb2RlSWRdOwogICAgICAgIGlmIChuYW1lZEZsb3dDb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIHVzZXJDYWxsYmFjayhuYW1lZEZsb3dDb2xsZWN0aW9uKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb24pfSB1c2VyQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gez9Qcm90b2NvbC5FcnJvcn0gZXJyb3IKICAgICAgICAgKiBAcGFyYW0gez9BcnJheS48Q1NTQWdlbnQuTmFtZWRGbG93Pn0gbmFtZWRGbG93UGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKHVzZXJDYWxsYmFjaywgZXJyb3IsIG5hbWVkRmxvd1BheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZXJyb3IgfHwgIW5hbWVkRmxvd1BheWxvYWQpCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSBuZXcgV2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb24obmFtZWRGbG93UGF5bG9hZCk7CiAgICAgICAgICAgICAgICB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tkb2N1bWVudE5vZGVJZF0gPSBuYW1lZEZsb3dDb2xsZWN0aW9uOwogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG5hbWVkRmxvd0NvbGxlY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBDU1NBZ2VudC5nZXROYW1lZEZsb3dDb2xsZWN0aW9uKGRvY3VtZW50Tm9kZUlkLCBjYWxsYmFjay5iaW5kKHRoaXMsIHVzZXJDYWxsYmFjaykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBkb2N1bWVudE5vZGVJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IGZsb3dOYW1lCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuTmFtZWRGbG93KX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIGdldEZsb3dCeU5hbWVBc3luYzogZnVuY3Rpb24oZG9jdW1lbnROb2RlSWQsIGZsb3dOYW1lLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tkb2N1bWVudE5vZGVJZF07CiAgICAgICAgaWYgKG5hbWVkRmxvd0NvbGxlY3Rpb24pIHsKICAgICAgICAgICAgdXNlckNhbGxiYWNrKG5hbWVkRmxvd0NvbGxlY3Rpb24uZmxvd0J5TmFtZShmbG93TmFtZSkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuTmFtZWRGbG93KX0gdXNlckNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHs/V2ViSW5zcGVjdG9yLk5hbWVkRmxvd0NvbGxlY3Rpb259IG5hbWVkRmxvd0NvbGxlY3Rpb24KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayh1c2VyQ2FsbGJhY2ssIG5hbWVkRmxvd0NvbGxlY3Rpb24pCiAgICAgICAgewogICAgICAgICAgICBpZiAoIW5hbWVkRmxvd0NvbGxlY3Rpb24pCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhuYW1lZEZsb3dDb2xsZWN0aW9uLmZsb3dCeU5hbWUoZmxvd05hbWUpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZ2V0TmFtZWRGbG93Q29sbGVjdGlvbkFzeW5jKGRvY3VtZW50Tm9kZUlkLCBjYWxsYmFjay5iaW5kKHRoaXMsIHVzZXJDYWxsYmFjaykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTUnVsZUlkfSBydWxlSWQKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdTZWxlY3RvcgogICAgICogQHBhcmFtIHtmdW5jdGlvbihXZWJJbnNwZWN0b3IuQ1NTUnVsZSwgYm9vbGVhbil9IHN1Y2Nlc3NDYWxsYmFjawogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmYWlsdXJlQ2FsbGJhY2sKICAgICAqLwogICAgc2V0UnVsZVNlbGVjdG9yOiBmdW5jdGlvbihydWxlSWQsIG5vZGVJZCwgbmV3U2VsZWN0b3IsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKQogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtDU1NBZ2VudC5DU1NSdWxlfSBydWxlUGF5bG9hZAogICAgICAgICAqIEBwYXJhbSB7P0FycmF5LjxET01BZ2VudC5Ob2RlSWQ+fSBzZWxlY3RlZE5vZGVJZHMKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjaGVja0FmZmVjdHNDYWxsYmFjayhub2RlSWQsIHN1Y2Nlc3NDYWxsYmFjaywgcnVsZVBheWxvYWQsIHNlbGVjdGVkTm9kZUlkcykKICAgICAgICB7CiAgICAgICAgICAgIGlmICghc2VsZWN0ZWROb2RlSWRzKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB2YXIgZG9lc0FmZmVjdFNlbGVjdGVkTm9kZSA9IChzZWxlY3RlZE5vZGVJZHMuaW5kZXhPZihub2RlSWQpID49IDApOwogICAgICAgICAgICB2YXIgcnVsZSA9IFdlYkluc3BlY3Rvci5DU1NSdWxlLnBhcnNlUGF5bG9hZChydWxlUGF5bG9hZCk7CiAgICAgICAgICAgIHN1Y2Nlc3NDYWxsYmFjayhydWxlLCBkb2VzQWZmZWN0U2VsZWN0ZWROb2RlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmYWlsdXJlQ2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gez9Qcm90b2NvbC5FcnJvcn0gZXJyb3IKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3U2VsZWN0b3IKICAgICAgICAgKiBAcGFyYW0gez9DU1NBZ2VudC5DU1NSdWxlfSBydWxlUGF5bG9hZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKG5vZGVJZCwgc3VjY2Vzc0NhbGxiYWNrLCBmYWlsdXJlQ2FsbGJhY2ssIG5ld1NlbGVjdG9yLCBlcnJvciwgcnVsZVBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IuZG9tQWdlbnQubWFya1VuZG9hYmxlU3RhdGUoKTsKICAgICAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50SWQgPSB0aGlzLl9vd25lckRvY3VtZW50SWQobm9kZUlkKTsKICAgICAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50SWQpCiAgICAgICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50LnF1ZXJ5U2VsZWN0b3JBbGwob3duZXJEb2N1bWVudElkLCBuZXdTZWxlY3RvciwgY2hlY2tBZmZlY3RzQ2FsbGJhY2suYmluZCh0aGlzLCBub2RlSWQsIHN1Y2Nlc3NDYWxsYmFjaywgcnVsZVBheWxvYWQpKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKHRydWUpOwogICAgICAgIENTU0FnZW50LnNldFJ1bGVTZWxlY3RvcihydWxlSWQsIG5ld1NlbGVjdG9yLCBjYWxsYmFjay5iaW5kKHRoaXMsIG5vZGVJZCwgc3VjY2Vzc0NhbGxiYWNrLCBmYWlsdXJlQ2FsbGJhY2ssIG5ld1NlbGVjdG9yKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtET01BZ2VudC5Ob2RlSWR9IG5vZGVJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5DU1NSdWxlLCBib29sZWFuKX0gc3VjY2Vzc0NhbGxiYWNrCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZhaWx1cmVDYWxsYmFjawogICAgICovCiAgICBhZGRSdWxlOiBmdW5jdGlvbihub2RlSWQsIHNlbGVjdG9yLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykKICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ge0RPTUFnZW50Lk5vZGVJZH0gbm9kZUlkCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihXZWJJbnNwZWN0b3IuQ1NTUnVsZSwgYm9vbGVhbil9IHN1Y2Nlc3NDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTUnVsZX0gcnVsZVBheWxvYWQKICAgICAgICAgKiBAcGFyYW0gez9BcnJheS48RE9NQWdlbnQuTm9kZUlkPn0gc2VsZWN0ZWROb2RlSWRzCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2hlY2tBZmZlY3RzQ2FsbGJhY2sobm9kZUlkLCBzdWNjZXNzQ2FsbGJhY2ssIHJ1bGVQYXlsb2FkLCBzZWxlY3RlZE5vZGVJZHMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXNlbGVjdGVkTm9kZUlkcykKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIHZhciBkb2VzQWZmZWN0U2VsZWN0ZWROb2RlID0gKHNlbGVjdGVkTm9kZUlkcy5pbmRleE9mKG5vZGVJZCkgPj0gMCk7CiAgICAgICAgICAgIHZhciBydWxlID0gV2ViSW5zcGVjdG9yLkNTU1J1bGUucGFyc2VQYXlsb2FkKHJ1bGVQYXlsb2FkKTsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKHJ1bGUsIGRvZXNBZmZlY3RTZWxlY3RlZE5vZGUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihXZWJJbnNwZWN0b3IuQ1NTUnVsZSwgYm9vbGVhbil9IHN1Y2Nlc3NDYWxsYmFjawogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZmFpbHVyZUNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yCiAgICAgICAgICogQHBhcmFtIHs/UHJvdG9jb2wuRXJyb3J9IGVycm9yCiAgICAgICAgICogQHBhcmFtIHs/Q1NTQWdlbnQuQ1NTUnVsZX0gcnVsZVBheWxvYWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaywgc2VsZWN0b3IsIGVycm9yLCBydWxlUGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgLy8gSW52YWxpZCBzeW50YXggZm9yIGEgc2VsZWN0b3IKICAgICAgICAgICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm1hcmtVbmRvYWJsZVN0YXRlKCk7CiAgICAgICAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudElkID0gdGhpcy5fb3duZXJEb2N1bWVudElkKG5vZGVJZCk7CiAgICAgICAgICAgICAgICBpZiAob3duZXJEb2N1bWVudElkKQogICAgICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5xdWVyeVNlbGVjdG9yQWxsKG93bmVyRG9jdW1lbnRJZCwgc2VsZWN0b3IsIGNoZWNrQWZmZWN0c0NhbGxiYWNrLmJpbmQodGhpcywgbm9kZUlkLCBzdWNjZXNzQ2FsbGJhY2ssIHJ1bGVQYXlsb2FkKSk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZUNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaCh0cnVlKTsKICAgICAgICBDU1NBZ2VudC5hZGRSdWxlKG5vZGVJZCwgc2VsZWN0b3IsIGNhbGxiYWNrLmJpbmQodGhpcywgc3VjY2Vzc0NhbGxiYWNrLCBmYWlsdXJlQ2FsbGJhY2ssIHNlbGVjdG9yKSk7CiAgICB9LAoKICAgIG1lZGlhUXVlcnlSZXN1bHRDaGFuZ2VkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLk1lZGlhUXVlcnlSZXN1bHRDaGFuZ2VkKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0geyFDU1NBZ2VudC5TdHlsZVNoZWV0SWR9IGlkCiAgICAgKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlcn0KICAgICAqLwogICAgc3R5bGVTaGVldEhlYWRlckZvcklkOiBmdW5jdGlvbihpZCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXJbaWRdOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4ge0FycmF5LjxXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlcj59CiAgICAgKi8KICAgIHN0eWxlU2hlZXRIZWFkZXJzOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXIpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBub2RlSWQKICAgICAqLwogICAgX293bmVyRG9jdW1lbnRJZDogZnVuY3Rpb24obm9kZUlkKQogICAgewogICAgICAgIHZhciBub2RlID0gV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm5vZGVGb3JJZChub2RlSWQpOwogICAgICAgIGlmICghbm9kZSkKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIG5vZGUub3duZXJEb2N1bWVudCA/IG5vZGUub3duZXJEb2N1bWVudC5pZCA6IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5TdHlsZVNoZWV0SWR9IHN0eWxlU2hlZXRJZAogICAgICovCiAgICBfZmlyZVN0eWxlU2hlZXRDaGFuZ2VkOiBmdW5jdGlvbihzdHlsZVNoZWV0SWQpCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLmxlbmd0aCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB2YXIgbWFqb3JDaGFuZ2UgPSB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlW3RoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUubGVuZ3RoIC0gMV07CgogICAgICAgIGlmICghbWFqb3JDaGFuZ2UgfHwgIXN0eWxlU2hlZXRJZCB8fCAhdGhpcy5oYXNFdmVudExpc3RlbmVycyhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMuU3R5bGVTaGVldENoYW5nZWQpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5TdHlsZVNoZWV0Q2hhbmdlZCwgeyBzdHlsZVNoZWV0SWQ6IHN0eWxlU2hlZXRJZCwgbWFqb3JDaGFuZ2U6IG1ham9yQ2hhbmdlIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7IUNTU0FnZW50LkNTU1N0eWxlU2hlZXRIZWFkZXJ9IGhlYWRlcgogICAgICovCiAgICBfc3R5bGVTaGVldEFkZGVkOiBmdW5jdGlvbihoZWFkZXIpCiAgICB7CiAgICAgICAgY29uc29sZS5hc3NlcnQoIXRoaXMuX3N0eWxlU2hlZXRJZFRvSGVhZGVyW2hlYWRlci5zdHlsZVNoZWV0SWRdKTsKICAgICAgICB2YXIgc3R5bGVTaGVldEhlYWRlciA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlcihoZWFkZXIpOwogICAgICAgIHRoaXMuX3N0eWxlU2hlZXRJZFRvSGVhZGVyW2hlYWRlci5zdHlsZVNoZWV0SWRdID0gc3R5bGVTaGVldEhlYWRlcjsKICAgICAgICB2YXIgdXJsID0gc3R5bGVTaGVldEhlYWRlci5yZXNvdXJjZVVSTCgpOwogICAgICAgIGlmICghdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFt1cmxdKQogICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMW3VybF0gPSB7fTsKICAgICAgICB2YXIgZnJhbWVJZFRvU3R5bGVTaGVldElkcyA9IHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXTsKICAgICAgICB2YXIgc3R5bGVTaGVldElkcyA9IGZyYW1lSWRUb1N0eWxlU2hlZXRJZHNbc3R5bGVTaGVldEhlYWRlci5mcmFtZUlkXTsKICAgICAgICBpZiAoIXN0eWxlU2hlZXRJZHMpIHsKICAgICAgICAgICAgc3R5bGVTaGVldElkcyA9IFtdOwogICAgICAgICAgICBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzW3N0eWxlU2hlZXRIZWFkZXIuZnJhbWVJZF0gPSBzdHlsZVNoZWV0SWRzOwogICAgICAgIH0KICAgICAgICBzdHlsZVNoZWV0SWRzLnB1c2goc3R5bGVTaGVldEhlYWRlci5pZCk7CiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50VG9MaXN0ZW5lcnMoV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuRXZlbnRzLlN0eWxlU2hlZXRBZGRlZCwgc3R5bGVTaGVldEhlYWRlcik7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHshQ1NTQWdlbnQuU3R5bGVTaGVldElkfSBpZAogICAgICovCiAgICBfc3R5bGVTaGVldFJlbW92ZWQ6IGZ1bmN0aW9uKGlkKQogICAgewogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLl9zdHlsZVNoZWV0SWRUb0hlYWRlcltpZF07CiAgICAgICAgY29uc29sZS5hc3NlcnQoaGVhZGVyKTsKICAgICAgICBkZWxldGUgdGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXJbaWRdOwogICAgICAgIHZhciB1cmwgPSBoZWFkZXIucmVzb3VyY2VVUkwoKTsKICAgICAgICB2YXIgZnJhbWVJZFRvU3R5bGVTaGVldElkcyA9IHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXTsKICAgICAgICBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzW2hlYWRlci5mcmFtZUlkXS5yZW1vdmUoaWQpOwogICAgICAgIGlmICghZnJhbWVJZFRvU3R5bGVTaGVldElkc1toZWFkZXIuZnJhbWVJZF0ubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlbGV0ZSBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzW2hlYWRlci5mcmFtZUlkXTsKICAgICAgICAgICAgaWYgKCFPYmplY3Qua2V5cyh0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMW3VybF0pLmxlbmd0aCkKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMW3VybF07CiAgICAgICAgfQogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5TdHlsZVNoZWV0UmVtb3ZlZCwgaGVhZGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsCiAgICAgKiBAcmV0dXJuIHtBcnJheS48Q1NTQWdlbnQuU3R5bGVTaGVldElkPn0KICAgICAqLwogICAgc3R5bGVTaGVldElkc0ZvclVSTDogZnVuY3Rpb24odXJsKQogICAgewogICAgICAgIHZhciBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzID0gdGhpcy5fc3R5bGVTaGVldElkc0ZvclVSTFt1cmxdOwogICAgICAgIGlmICghZnJhbWVJZFRvU3R5bGVTaGVldElkcykKICAgICAgICAgICAgcmV0dXJuIFtdOwoKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgZm9yICh2YXIgZnJhbWVJZCBpbiBmcmFtZUlkVG9TdHlsZVNoZWV0SWRzKQogICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGZyYW1lSWRUb1N0eWxlU2hlZXRJZHNbZnJhbWVJZF0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybAogICAgICogQHJldHVybiB7T2JqZWN0LjxQYWdlQWdlbnQuRnJhbWVJZCwgQXJyYXkuPENTU0FnZW50LlN0eWxlU2hlZXRJZD4+fQogICAgICovCiAgICBzdHlsZVNoZWV0SWRzQnlGcmFtZUlkRm9yVVJMOiBmdW5jdGlvbih1cmwpCiAgICB7CiAgICAgICAgdmFyIHN0eWxlU2hlZXRJZHNGb3JGcmFtZSA9IHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbdXJsXTsKICAgICAgICBpZiAoIXN0eWxlU2hlZXRJZHNGb3JGcmFtZSkKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIHJldHVybiBzdHlsZVNoZWV0SWRzRm9yRnJhbWU7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5OYW1lZEZsb3d9IG5hbWVkRmxvd1BheWxvYWQKICAgICAqLwogICAgX25hbWVkRmxvd0NyZWF0ZWQ6IGZ1bmN0aW9uKG5hbWVkRmxvd1BheWxvYWQpCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvdyA9IFdlYkluc3BlY3Rvci5OYW1lZEZsb3cucGFyc2VQYXlsb2FkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgICAgIHZhciBuYW1lZEZsb3dDb2xsZWN0aW9uID0gdGhpcy5fbmFtZWRGbG93Q29sbGVjdGlvbnNbbmFtZWRGbG93LmRvY3VtZW50Tm9kZUlkXTsKCiAgICAgICAgaWYgKCFuYW1lZEZsb3dDb2xsZWN0aW9uKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIG5hbWVkRmxvd0NvbGxlY3Rpb24uX2FwcGVuZE5hbWVkRmxvdyhuYW1lZEZsb3cpOwogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5OYW1lZEZsb3dDcmVhdGVkLCBuYW1lZEZsb3cpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7RE9NQWdlbnQuTm9kZUlkfSBkb2N1bWVudE5vZGVJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IGZsb3dOYW1lCiAgICAgKi8KICAgIF9uYW1lZEZsb3dSZW1vdmVkOiBmdW5jdGlvbihkb2N1bWVudE5vZGVJZCwgZmxvd05hbWUpCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvd0NvbGxlY3Rpb24gPSB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9uc1tkb2N1bWVudE5vZGVJZF07CgogICAgICAgIGlmICghbmFtZWRGbG93Q29sbGVjdGlvbikKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBuYW1lZEZsb3dDb2xsZWN0aW9uLl9yZW1vdmVOYW1lZEZsb3coZmxvd05hbWUpOwogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudFRvTGlzdGVuZXJzKFdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkV2ZW50cy5OYW1lZEZsb3dSZW1vdmVkLCB7IGRvY3VtZW50Tm9kZUlkOiBkb2N1bWVudE5vZGVJZCwgZmxvd05hbWU6IGZsb3dOYW1lIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuTmFtZWRGbG93fSBuYW1lZEZsb3dQYXlsb2FkCiAgICAgKi8KICAgIF9yZWdpb25MYXlvdXRVcGRhdGVkOiBmdW5jdGlvbihuYW1lZEZsb3dQYXlsb2FkKQogICAgewogICAgICAgIHZhciBuYW1lZEZsb3cgPSBXZWJJbnNwZWN0b3IuTmFtZWRGbG93LnBhcnNlUGF5bG9hZChuYW1lZEZsb3dQYXlsb2FkKTsKICAgICAgICB2YXIgbmFtZWRGbG93Q29sbGVjdGlvbiA9IHRoaXMuX25hbWVkRmxvd0NvbGxlY3Rpb25zW25hbWVkRmxvdy5kb2N1bWVudE5vZGVJZF07CgogICAgICAgIGlmICghbmFtZWRGbG93Q29sbGVjdGlvbikKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBuYW1lZEZsb3dDb2xsZWN0aW9uLl9hcHBlbmROYW1lZEZsb3cobmFtZWRGbG93KTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMuUmVnaW9uTGF5b3V0VXBkYXRlZCwgbmFtZWRGbG93KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gbmFtZWRGbG93UGF5bG9hZAogICAgICovCiAgICBfcmVnaW9uT3ZlcnNldENoYW5nZWQ6IGZ1bmN0aW9uKG5hbWVkRmxvd1BheWxvYWQpCiAgICB7CiAgICAgICAgdmFyIG5hbWVkRmxvdyA9IFdlYkluc3BlY3Rvci5OYW1lZEZsb3cucGFyc2VQYXlsb2FkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgICAgIHZhciBuYW1lZEZsb3dDb2xsZWN0aW9uID0gdGhpcy5fbmFtZWRGbG93Q29sbGVjdGlvbnNbbmFtZWRGbG93LmRvY3VtZW50Tm9kZUlkXTsKCiAgICAgICAgIGlmICghbmFtZWRGbG93Q29sbGVjdGlvbikKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBuYW1lZEZsb3dDb2xsZWN0aW9uLl9hcHBlbmROYW1lZEZsb3cobmFtZWRGbG93KTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnRUb0xpc3RlbmVycyhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5FdmVudHMuUmVnaW9uT3ZlcnNldENoYW5nZWQsIG5hbWVkRmxvdyk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5TdHlsZVNoZWV0SWR9IHN0eWxlU2hlZXRJZAogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1RleHQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbWFqb3JDaGFuZ2UKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP3N0cmluZyl9IHVzZXJDYWxsYmFjawogICAgICovCiAgICBzZXRTdHlsZVNoZWV0VGV4dDogZnVuY3Rpb24oc3R5bGVTaGVldElkLCBuZXdUZXh0LCBtYWpvckNoYW5nZSwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wb3AoKTsKICAgICAgICAgICAgaWYgKCFlcnJvciAmJiBtYWpvckNoYW5nZSkKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5tYXJrVW5kb2FibGVTdGF0ZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFlcnJvciAmJiB1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2soZXJyb3IpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnB1c2gobWFqb3JDaGFuZ2UpOwogICAgICAgIENTU0FnZW50LnNldFN0eWxlU2hlZXRUZXh0KHN0eWxlU2hlZXRJZCwgbmV3VGV4dCwgY2FsbGJhY2suYmluZCh0aGlzKSk7CiAgICB9LAoKICAgIF91bmRvUmVkb1JlcXVlc3RlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaCh0cnVlKTsKICAgIH0sCgogICAgX3VuZG9SZWRvQ29tcGxldGVkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wb3AoKTsKICAgIH0sCgogICAgX21haW5GcmFtZUNyZWF0ZWRPck5hdmlnYXRlZDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHRoaXMuX3Jlc2V0U3R5bGVTaGVldHMoKTsKICAgIH0sCgogICAgX3Jlc2V0U3R5bGVTaGVldHM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICAvKiogQHR5cGUgeyFPYmplY3QuPHN0cmluZywgIU9iamVjdC48UGFnZUFnZW50LkZyYW1lSWQsICFBcnJheS48IUNTU0FnZW50LlN0eWxlU2hlZXRJZD4+Pn0gKi8KICAgICAgICB0aGlzLl9zdHlsZVNoZWV0SWRzRm9yVVJMID0ge307CiAgICAgICAgLyoqIEB0eXBlIHshT2JqZWN0LjxDU1NBZ2VudC5TdHlsZVNoZWV0SWQsICFXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlcj59ICovCiAgICAgICAgdGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXIgPSB7fTsKICAgIH0sCgogICAgX3Jlc2V0TmFtZWRGbG93Q29sbGVjdGlvbnM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB0aGlzLl9uYW1lZEZsb3dDb2xsZWN0aW9ucyA9IHt9OwogICAgfSwKCiAgICB1cGRhdGVMb2NhdGlvbnM6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgaGVhZGVycyA9IE9iamVjdC52YWx1ZXModGhpcy5fc3R5bGVTaGVldElkVG9IZWFkZXIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGVhZGVycy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgaGVhZGVyc1tpXS51cGRhdGVMb2NhdGlvbnMoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gc3R5bGVTaGVldElkCiAgICAgKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5DU1NMb2NhdGlvbn0gcmF3TG9jYXRpb24KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oV2ViSW5zcGVjdG9yLlVJTG9jYXRpb24pOihib29sZWFufHVuZGVmaW5lZCl9IHVwZGF0ZURlbGVnYXRlCiAgICAgKiBAcmV0dXJuIHs/V2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbn0KICAgICAqLwogICAgY3JlYXRlTGl2ZUxvY2F0aW9uOiBmdW5jdGlvbihzdHlsZVNoZWV0SWQsIHJhd0xvY2F0aW9uLCB1cGRhdGVEZWxlZ2F0ZSkKICAgIHsKICAgICAgICBpZiAoIXJhd0xvY2F0aW9uKQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB2YXIgaGVhZGVyID0gdGhpcy5zdHlsZVNoZWV0SGVhZGVyRm9ySWQoc3R5bGVTaGVldElkKTsKICAgICAgICBpZiAoIWhlYWRlcikKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIGhlYWRlci5jcmVhdGVMaXZlTG9jYXRpb24ocmF3TG9jYXRpb24sIHVwZGF0ZURlbGVnYXRlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge1dlYkluc3BlY3Rvci5DU1NMb2NhdGlvbn0gcmF3TG9jYXRpb24KICAgICAqIEByZXR1cm4gez9XZWJJbnNwZWN0b3IuVUlMb2NhdGlvbn0KICAgICAqLwogICAgcmF3TG9jYXRpb25Ub1VJTG9jYXRpb246IGZ1bmN0aW9uKHJhd0xvY2F0aW9uKQogICAgewogICAgICAgIHZhciBmcmFtZUlkVG9TaGVldElkcyA9IHRoaXMuX3N0eWxlU2hlZXRJZHNGb3JVUkxbcmF3TG9jYXRpb24udXJsXTsKICAgICAgICBpZiAoIWZyYW1lSWRUb1NoZWV0SWRzKQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB2YXIgc3R5bGVTaGVldElkcyA9IFtdOwogICAgICAgIGZvciAodmFyIGZyYW1lSWQgaW4gZnJhbWVJZFRvU2hlZXRJZHMpCiAgICAgICAgICAgIHN0eWxlU2hlZXRJZHMgPSBzdHlsZVNoZWV0SWRzLmNvbmNhdChmcmFtZUlkVG9TaGVldElkc1tmcmFtZUlkXSk7CiAgICAgICAgdmFyIHVpTG9jYXRpb247CiAgICAgICAgZm9yICh2YXIgaSA9IDA7ICF1aUxvY2F0aW9uICYmIGkgPCBzdHlsZVNoZWV0SWRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLnN0eWxlU2hlZXRIZWFkZXJGb3JJZChzdHlsZVNoZWV0SWRzW2ldKTsKICAgICAgICAgICAgY29uc29sZS5hc3NlcnQoaGVhZGVyKTsKICAgICAgICAgICAgdWlMb2NhdGlvbiA9IGhlYWRlci5yYXdMb2NhdGlvblRvVUlMb2NhdGlvbihyYXdMb2NhdGlvbi5saW5lTnVtYmVyLCByYXdMb2NhdGlvbi5jb2x1bW5OdW1iZXIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdWlMb2NhdGlvbiB8fCBudWxsOwogICAgfSwKCiAgICBfX3Byb3RvX186IFdlYkluc3BlY3Rvci5PYmplY3QucHJvdG90eXBlCn0KCi8qKgogKiBAY29uc3RydWN0b3IKICogQGV4dGVuZHMge1dlYkluc3BlY3Rvci5MaXZlTG9jYXRpb259CiAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yLkNTU0xvY2F0aW9ufSByYXdMb2NhdGlvbgogKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5VSUxvY2F0aW9uKTooYm9vbGVhbnx1bmRlZmluZWQpfSB1cGRhdGVEZWxlZ2F0ZQogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWwuTGl2ZUxvY2F0aW9uID0gZnVuY3Rpb24ocmF3TG9jYXRpb24sIHVwZGF0ZURlbGVnYXRlLCBoZWFkZXIpCnsKICAgIFdlYkluc3BlY3Rvci5MaXZlTG9jYXRpb24uY2FsbCh0aGlzLCByYXdMb2NhdGlvbiwgdXBkYXRlRGVsZWdhdGUpOwogICAgdGhpcy5faGVhZGVyID0gaGVhZGVyOwp9CgpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5MaXZlTG9jYXRpb24ucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuVUlMb2NhdGlvbn0KICAgICAqLwogICAgdWlMb2NhdGlvbjogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBjc3NMb2NhdGlvbiA9IC8qKiBAdHlwZSBXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb24gKi8gKHRoaXMucmF3TG9jYXRpb24oKSk7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hlYWRlci5yYXdMb2NhdGlvblRvVUlMb2NhdGlvbihjc3NMb2NhdGlvbi5saW5lTnVtYmVyLCBjc3NMb2NhdGlvbi5jb2x1bW5OdW1iZXIpOwogICAgfSwKCiAgICBkaXNwb3NlOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgV2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbi5wcm90b3R5cGUuZGlzcG9zZS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuX2hlYWRlci5fcmVtb3ZlTG9jYXRpb24odGhpcyk7CiAgICB9LAoKICAgIF9fcHJvdG9fXzogV2ViSW5zcGVjdG9yLkxpdmVMb2NhdGlvbi5wcm90b3R5cGUKfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAaW1wbGVtZW50cyB7V2ViSW5zcGVjdG9yLlJhd0xvY2F0aW9ufQogKiBAcGFyYW0ge3N0cmluZ30gdXJsCiAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lTnVtYmVyCiAqIEBwYXJhbSB7bnVtYmVyPX0gY29sdW1uTnVtYmVyCiAqLwpXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb24gPSBmdW5jdGlvbih1cmwsIGxpbmVOdW1iZXIsIGNvbHVtbk51bWJlcikKewogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyOwogICAgdGhpcy5jb2x1bW5OdW1iZXIgPSBjb2x1bW5OdW1iZXIgfHwgMDsKfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlfSBwYXlsb2FkCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbiA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHRoaXMuaWQgPSBwYXlsb2FkLnN0eWxlSWQ7CiAgICB0aGlzLndpZHRoID0gcGF5bG9hZC53aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gcGF5bG9hZC5oZWlnaHQ7CiAgICB0aGlzLnJhbmdlID0gcGF5bG9hZC5yYW5nZTsKICAgIHRoaXMuX3Nob3J0aGFuZFZhbHVlcyA9IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLmJ1aWxkU2hvcnRoYW5kVmFsdWVNYXAocGF5bG9hZC5zaG9ydGhhbmRFbnRyaWVzKTsKICAgIHRoaXMuX2xpdmVQcm9wZXJ0eU1hcCA9IHt9OyAvLyBMSVZFIHByb3BlcnRpZXMgKHNvdXJjZS1iYXNlZCBvciBzdHlsZS1iYXNlZCkgOiB7IG5hbWUgLT4gQ1NTUHJvcGVydHkgfQogICAgdGhpcy5fYWxsUHJvcGVydGllcyA9IFtdOyAvLyBBTEwgcHJvcGVydGllczogWyBDU1NQcm9wZXJ0eSBdCiAgICB0aGlzLl9fZGlzYWJsZWRQcm9wZXJ0aWVzID0ge307IC8vIERJU0FCTEVEIHByb3BlcnRpZXM6IHsgaW5kZXggLT4gQ1NTUHJvcGVydHkgfQogICAgdmFyIHBheWxvYWRQcm9wZXJ0eUNvdW50ID0gcGF5bG9hZC5jc3NQcm9wZXJ0aWVzLmxlbmd0aDsKCiAgICB2YXIgcHJvcGVydHlJbmRleCA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBheWxvYWRQcm9wZXJ0eUNvdW50OyArK2kpIHsKICAgICAgICB2YXIgcHJvcGVydHkgPSBXZWJJbnNwZWN0b3IuQ1NTUHJvcGVydHkucGFyc2VQYXlsb2FkKHRoaXMsIGksIHBheWxvYWQuY3NzUHJvcGVydGllc1tpXSk7CiAgICAgICAgdGhpcy5fYWxsUHJvcGVydGllcy5wdXNoKHByb3BlcnR5KTsKICAgICAgICBpZiAocHJvcGVydHkuZGlzYWJsZWQpCiAgICAgICAgICAgIHRoaXMuX19kaXNhYmxlZFByb3BlcnRpZXNbaV0gPSBwcm9wZXJ0eTsKICAgICAgICBpZiAoIXByb3BlcnR5LmFjdGl2ZSAmJiAhcHJvcGVydHkuc3R5bGVCYXNlZCkKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgdmFyIG5hbWUgPSBwcm9wZXJ0eS5uYW1lOwogICAgICAgIHRoaXNbcHJvcGVydHlJbmRleF0gPSBuYW1lOwogICAgICAgIHRoaXMuX2xpdmVQcm9wZXJ0eU1hcFtuYW1lXSA9IHByb3BlcnR5OwogICAgICAgICsrcHJvcGVydHlJbmRleDsKICAgIH0KICAgIHRoaXMubGVuZ3RoID0gcHJvcGVydHlJbmRleDsKICAgIGlmICgiY3NzVGV4dCIgaW4gcGF5bG9hZCkKICAgICAgICB0aGlzLmNzc1RleHQgPSBwYXlsb2FkLmNzc1RleHQ7Cn0KCi8qKgogKiBAcGFyYW0ge0FycmF5LjxDU1NBZ2VudC5TaG9ydGhhbmRFbnRyeT59IHNob3J0aGFuZEVudHJpZXMKICogQHJldHVybiB7T2JqZWN0fQogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24uYnVpbGRTaG9ydGhhbmRWYWx1ZU1hcCA9IGZ1bmN0aW9uKHNob3J0aGFuZEVudHJpZXMpCnsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hvcnRoYW5kRW50cmllcy5sZW5ndGg7ICsraSkKICAgICAgICByZXN1bHRbc2hvcnRoYW5kRW50cmllc1tpXS5uYW1lXSA9IHNob3J0aGFuZEVudHJpZXNbaV0udmFsdWU7CiAgICByZXR1cm4gcmVzdWx0Owp9CgovKioKICogQHBhcmFtIHtDU1NBZ2VudC5DU1NTdHlsZX0gcGF5bG9hZAogKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbn0KICovCldlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZCA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ocGF5bG9hZCk7Cn0KCi8qKgogKiBAcGFyYW0ge0FycmF5LjxDU1NBZ2VudC5DU1NDb21wdXRlZFN0eWxlUHJvcGVydHk+fSBwYXlsb2FkCiAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9ufQogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucGFyc2VDb21wdXRlZFN0eWxlUGF5bG9hZCA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHZhciBuZXdQYXlsb2FkID0gLyoqIEB0eXBlIHtDU1NBZ2VudC5DU1NTdHlsZX0gKi8gKHsgY3NzUHJvcGVydGllczogW10sIHNob3J0aGFuZEVudHJpZXM6IFtdLCB3aWR0aDogIiIsIGhlaWdodDogIiIgfSk7CiAgICBpZiAocGF5bG9hZCkKICAgICAgICBuZXdQYXlsb2FkLmNzc1Byb3BlcnRpZXMgPSBwYXlsb2FkOwoKICAgIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24obmV3UGF5bG9hZCk7Cn0KCldlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnByb3RvdHlwZSA9IHsKICAgIGdldCBhbGxQcm9wZXJ0aWVzKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5fYWxsUHJvcGVydGllczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHJldHVybiB7V2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5fHVuZGVmaW5lZH0KICAgICAqLwogICAgZ2V0TGl2ZVByb3BlcnR5OiBmdW5jdGlvbihuYW1lKQogICAgewogICAgICAgIHJldHVybiB0aGlzLl9saXZlUHJvcGVydHlNYXBbbmFtZV07CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAqLwogICAgZ2V0UHJvcGVydHlWYWx1ZTogZnVuY3Rpb24obmFtZSkKICAgIHsKICAgICAgICB2YXIgcHJvcGVydHkgPSB0aGlzLl9saXZlUHJvcGVydHlNYXBbbmFtZV07CiAgICAgICAgcmV0dXJuIHByb3BlcnR5ID8gcHJvcGVydHkudmFsdWUgOiAiIjsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICBnZXRQcm9wZXJ0eVByaW9yaXR5OiBmdW5jdGlvbihuYW1lKQogICAgewogICAgICAgIHZhciBwcm9wZXJ0eSA9IHRoaXMuX2xpdmVQcm9wZXJ0eU1hcFtuYW1lXTsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPyBwcm9wZXJ0eS5wcmlvcml0eSA6ICIiOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgICovCiAgICBpc1Byb3BlcnR5SW1wbGljaXQ6IGZ1bmN0aW9uKG5hbWUpCiAgICB7CiAgICAgICAgdmFyIHByb3BlcnR5ID0gdGhpcy5fbGl2ZVByb3BlcnR5TWFwW25hbWVdOwogICAgICAgIHJldHVybiBwcm9wZXJ0eSA/IHByb3BlcnR5LmltcGxpY2l0IDogIiI7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgICAqIEByZXR1cm4ge0FycmF5LjxXZWJJbnNwZWN0b3IuQ1NTUHJvcGVydHk+fQogICAgICovCiAgICBsb25naGFuZFByb3BlcnRpZXM6IGZ1bmN0aW9uKG5hbWUpCiAgICB7CiAgICAgICAgdmFyIGxvbmdoYW5kcyA9IFdlYkluc3BlY3Rvci5DU1NNZXRhZGF0YS5jc3NQcm9wZXJ0aWVzTWV0YWluZm8ubG9uZ2hhbmRzKG5hbWUpOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgbG9uZ2hhbmRzICYmIGkgPCBsb25naGFuZHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gdGhpcy5fbGl2ZVByb3BlcnR5TWFwW2xvbmdoYW5kc1tpXV07CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eSkKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHByb3BlcnR5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2hvcnRoYW5kUHJvcGVydHkKICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAqLwogICAgc2hvcnRoYW5kVmFsdWU6IGZ1bmN0aW9uKHNob3J0aGFuZFByb3BlcnR5KQogICAgewogICAgICAgIHJldHVybiB0aGlzLl9zaG9ydGhhbmRWYWx1ZXNbc2hvcnRoYW5kUHJvcGVydHldOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogICAgICogQHJldHVybiB7P1dlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eX0KICAgICAqLwogICAgcHJvcGVydHlBdDogZnVuY3Rpb24oaW5kZXgpCiAgICB7CiAgICAgICAgcmV0dXJuIChpbmRleCA8IHRoaXMuYWxsUHJvcGVydGllcy5sZW5ndGgpID8gdGhpcy5hbGxQcm9wZXJ0aWVzW2luZGV4XSA6IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7bnVtYmVyfQogICAgICovCiAgICBwYXN0TGFzdFNvdXJjZVByb3BlcnR5SW5kZXg6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5hbGxQcm9wZXJ0aWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eSA9IHRoaXMuYWxsUHJvcGVydGllc1tpXTsKICAgICAgICAgICAgaWYgKHByb3BlcnR5LmFjdGl2ZSB8fCBwcm9wZXJ0eS5kaXNhYmxlZCkKICAgICAgICAgICAgICAgIHJldHVybiBpICsgMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXI9fSBpbmRleAogICAgICovCiAgICBuZXdCbGFua1Byb3BlcnR5OiBmdW5jdGlvbihpbmRleCkKICAgIHsKICAgICAgICBpbmRleCA9ICh0eXBlb2YgaW5kZXggPT09ICJ1bmRlZmluZWQiKSA/IHRoaXMucGFzdExhc3RTb3VyY2VQcm9wZXJ0eUluZGV4KCkgOiBpbmRleDsKICAgICAgICByZXR1cm4gbmV3IFdlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eSh0aGlzLCBpbmRleCwgIiIsICIiLCAiIiwgImFjdGl2ZSIsIHRydWUsIGZhbHNlLCAiIik7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbik9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgaW5zZXJ0UHJvcGVydHlBdDogZnVuY3Rpb24oaW5kZXgsIG5hbWUsIHZhbHVlLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGV9IHBheWxvYWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhlcnJvciwgcGF5bG9hZCkKICAgICAgICB7CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wb3AoKTsKICAgICAgICAgICAgaWYgKCF1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQocGF5bG9hZCkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLmlkKQogICAgICAgICAgICB0aHJvdyAiTm8gc3R5bGUgaWQiOwoKICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaCh0cnVlKTsKICAgICAgICBDU1NBZ2VudC5zZXRQcm9wZXJ0eVRleHQodGhpcy5pZCwgaW5kZXgsIG5hbWUgKyAiOiAiICsgdmFsdWUgKyAiOyIsIGZhbHNlLCBjYWxsYmFjay5iaW5kKHRoaXMpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbik9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgYXBwZW5kUHJvcGVydHk6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgdGhpcy5pbnNlcnRQcm9wZXJ0eUF0KHRoaXMuYWxsUHJvcGVydGllcy5sZW5ndGgsIG5hbWUsIHZhbHVlLCB1c2VyQ2FsbGJhY2spOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0CiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbik9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgc2V0VGV4dDogZnVuY3Rpb24odGV4dCwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gZXJyb3IKICAgICAgICAgKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlfSBwYXlsb2FkCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soZXJyb3IsIHBheWxvYWQpCiAgICAgICAgewogICAgICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucG9wKCk7CiAgICAgICAgICAgIGlmICghdXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTsKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2soV2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24ucGFyc2VQYXlsb2FkKHBheWxvYWQpKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5pZCkKICAgICAgICAgICAgdGhyb3cgIk5vIHN0eWxlIGlkIjsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNzc1RleHQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnB1c2godHJ1ZSk7CiAgICAgICAgQ1NTQWdlbnQuc2V0U3R5bGVUZXh0KHRoaXMuaWQsIHRleHQsIGNhbGxiYWNrKTsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1J1bGV9IHBheWxvYWQKICogQHBhcmFtIHtBcnJheS48bnVtYmVyPj19IG1hdGNoaW5nU2VsZWN0b3JzCiAqLwpXZWJJbnNwZWN0b3IuQ1NTUnVsZSA9IGZ1bmN0aW9uKHBheWxvYWQsIG1hdGNoaW5nU2VsZWN0b3JzKQp7CiAgICB0aGlzLmlkID0gcGF5bG9hZC5ydWxlSWQ7CiAgICBpZiAobWF0Y2hpbmdTZWxlY3RvcnMpCiAgICAgICAgdGhpcy5tYXRjaGluZ1NlbGVjdG9ycyA9IG1hdGNoaW5nU2VsZWN0b3JzOwogICAgdGhpcy5zZWxlY3RvcnMgPSBwYXlsb2FkLnNlbGVjdG9yTGlzdC5zZWxlY3RvcnM7CiAgICB0aGlzLnNlbGVjdG9yVGV4dCA9IHRoaXMuc2VsZWN0b3JzLmpvaW4oIiwgIik7CiAgICB0aGlzLnNlbGVjdG9yUmFuZ2UgPSBwYXlsb2FkLnNlbGVjdG9yTGlzdC5yYW5nZTsKICAgIHRoaXMuc291cmNlVVJMID0gcGF5bG9hZC5zb3VyY2VVUkw7CiAgICB0aGlzLm9yaWdpbiA9IHBheWxvYWQub3JpZ2luOwogICAgdGhpcy5zdHlsZSA9IFdlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uLnBhcnNlUGF5bG9hZChwYXlsb2FkLnN0eWxlKTsKICAgIHRoaXMuc3R5bGUucGFyZW50UnVsZSA9IHRoaXM7CiAgICBpZiAocGF5bG9hZC5tZWRpYSkKICAgICAgICB0aGlzLm1lZGlhID0gV2ViSW5zcGVjdG9yLkNTU01lZGlhLnBhcnNlTWVkaWFBcnJheVBheWxvYWQocGF5bG9hZC5tZWRpYSk7CiAgICB0aGlzLl9zZXRSYXdMb2NhdGlvbkFuZEZyYW1lSWQoKTsKfQoKLyoqCiAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTUnVsZX0gcGF5bG9hZAogKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+PX0gbWF0Y2hpbmdJbmRpY2VzCiAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NSdWxlfQogKi8KV2ViSW5zcGVjdG9yLkNTU1J1bGUucGFyc2VQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCwgbWF0Y2hpbmdJbmRpY2VzKQp7CiAgICByZXR1cm4gbmV3IFdlYkluc3BlY3Rvci5DU1NSdWxlKHBheWxvYWQsIG1hdGNoaW5nSW5kaWNlcyk7Cn0KCldlYkluc3BlY3Rvci5DU1NSdWxlLnByb3RvdHlwZSA9IHsKICAgIF9zZXRSYXdMb2NhdGlvbkFuZEZyYW1lSWQ6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuaWQpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB2YXIgc3R5bGVTaGVldEhlYWRlciA9IFdlYkluc3BlY3Rvci5jc3NNb2RlbC5zdHlsZVNoZWV0SGVhZGVyRm9ySWQodGhpcy5pZC5zdHlsZVNoZWV0SWQpOwogICAgICAgIHRoaXMuZnJhbWVJZCA9IHN0eWxlU2hlZXRIZWFkZXIuZnJhbWVJZDsKICAgICAgICB2YXIgdXJsID0gc3R5bGVTaGVldEhlYWRlci5yZXNvdXJjZVVSTCgpOwogICAgICAgIGlmICghdXJsKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgdGhpcy5yYXdMb2NhdGlvbiA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb24odXJsLCB0aGlzLmxpbmVOdW1iZXJJblNvdXJjZSgpLCB0aGlzLmNvbHVtbk51bWJlckluU291cmNlKCkpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAqLwogICAgcmVzb3VyY2VVUkw6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuaWQpCiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB2YXIgc3R5bGVTaGVldEhlYWRlciA9IFdlYkluc3BlY3Rvci5jc3NNb2RlbC5zdHlsZVNoZWV0SGVhZGVyRm9ySWQodGhpcy5pZC5zdHlsZVNoZWV0SWQpOwogICAgICAgIHJldHVybiBzdHlsZVNoZWV0SGVhZGVyLnJlc291cmNlVVJMKCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7bnVtYmVyfQogICAgICovCiAgICBsaW5lTnVtYmVySW5Tb3VyY2U6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuc2VsZWN0b3JSYW5nZSkKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgdmFyIHN0eWxlU2hlZXRIZWFkZXIgPSBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuc3R5bGVTaGVldEhlYWRlckZvcklkKHRoaXMuaWQuc3R5bGVTaGVldElkKTsKICAgICAgICByZXR1cm4gc3R5bGVTaGVldEhlYWRlci5saW5lTnVtYmVySW5Tb3VyY2UodGhpcy5zZWxlY3RvclJhbmdlLnN0YXJ0TGluZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiB7bnVtYmVyfHVuZGVmaW5lZH0KICAgICAqLwogICAgY29sdW1uTnVtYmVySW5Tb3VyY2U6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuc2VsZWN0b3JSYW5nZSkKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB2YXIgc3R5bGVTaGVldEhlYWRlciA9IFdlYkluc3BlY3Rvci5jc3NNb2RlbC5zdHlsZVNoZWV0SGVhZGVyRm9ySWQodGhpcy5pZC5zdHlsZVNoZWV0SWQpOwogICAgICAgIGNvbnNvbGUuYXNzZXJ0KHN0eWxlU2hlZXRIZWFkZXIpOwogICAgICAgIHJldHVybiBzdHlsZVNoZWV0SGVhZGVyLmNvbHVtbk51bWJlckluU291cmNlKHRoaXMuc2VsZWN0b3JSYW5nZS5zdGFydExpbmUsIHRoaXMuc2VsZWN0b3JSYW5nZS5zdGFydENvbHVtbik7CiAgICB9LAoKICAgIGdldCBpc1VzZXJBZ2VudCgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luID09PSAidXNlci1hZ2VudCI7CiAgICB9LAoKICAgIGdldCBpc1VzZXIoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLm9yaWdpbiA9PT0gInVzZXIiOwogICAgfSwKCiAgICBnZXQgaXNWaWFJbnNwZWN0b3IoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLm9yaWdpbiA9PT0gImluc3BlY3RvciI7CiAgICB9LAoKICAgIGdldCBpc1JlZ3VsYXIoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLm9yaWdpbiA9PT0gInJlZ3VsYXIiOwogICAgfQp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7P1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9ufSBvd25lclN0eWxlCiAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUKICogQHBhcmFtIHs/c3RyaW5nfSBwcmlvcml0eQogKiBAcGFyYW0ge3N0cmluZ30gc3RhdHVzCiAqIEBwYXJhbSB7Ym9vbGVhbn0gcGFyc2VkT2sKICogQHBhcmFtIHtib29sZWFufSBpbXBsaWNpdAogKiBAcGFyYW0gez9zdHJpbmc9fSB0ZXh0CiAqIEBwYXJhbSB7Q1NTQWdlbnQuU291cmNlUmFuZ2U9fSByYW5nZQogKi8KV2ViSW5zcGVjdG9yLkNTU1Byb3BlcnR5ID0gZnVuY3Rpb24ob3duZXJTdHlsZSwgaW5kZXgsIG5hbWUsIHZhbHVlLCBwcmlvcml0eSwgc3RhdHVzLCBwYXJzZWRPaywgaW1wbGljaXQsIHRleHQsIHJhbmdlKQp7CiAgICB0aGlzLm93bmVyU3R5bGUgPSBvd25lclN0eWxlOwogICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIHRoaXMucHJpb3JpdHkgPSBwcmlvcml0eTsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5wYXJzZWRPayA9IHBhcnNlZE9rOwogICAgdGhpcy5pbXBsaWNpdCA9IGltcGxpY2l0OwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMucmFuZ2UgPSByYW5nZTsKfQoKLyoqCiAqIEBwYXJhbSB7P1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9ufSBvd25lclN0eWxlCiAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1Byb3BlcnR5fSBwYXlsb2FkCiAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eX0KICovCldlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eS5wYXJzZVBheWxvYWQgPSBmdW5jdGlvbihvd25lclN0eWxlLCBpbmRleCwgcGF5bG9hZCkKewogICAgLy8gVGhlIGZvbGxvd2luZyBkZWZhdWx0IGZpZWxkIHZhbHVlcyBhcmUgdXNlZCBpbiB0aGUgcGF5bG9hZDoKICAgIC8vIHByaW9yaXR5OiAiIgogICAgLy8gcGFyc2VkT2s6IHRydWUKICAgIC8vIGltcGxpY2l0OiBmYWxzZQogICAgLy8gc3RhdHVzOiAic3R5bGUiCiAgICB2YXIgcmVzdWx0ID0gbmV3IFdlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eSgKICAgICAgICBvd25lclN0eWxlLCBpbmRleCwgcGF5bG9hZC5uYW1lLCBwYXlsb2FkLnZhbHVlLCBwYXlsb2FkLnByaW9yaXR5IHx8ICIiLCBwYXlsb2FkLnN0YXR1cyB8fCAic3R5bGUiLCAoInBhcnNlZE9rIiBpbiBwYXlsb2FkKSA/ICEhcGF5bG9hZC5wYXJzZWRPayA6IHRydWUsICEhcGF5bG9hZC5pbXBsaWNpdCwgcGF5bG9hZC50ZXh0LCBwYXlsb2FkLnJhbmdlKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCldlYkluc3BlY3Rvci5DU1NQcm9wZXJ0eS5wcm90b3R5cGUgPSB7CiAgICBnZXQgcHJvcGVydHlUZXh0KCkKICAgIHsKICAgICAgICBpZiAodGhpcy50ZXh0ICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHJldHVybiB0aGlzLnRleHQ7CgogICAgICAgIGlmICh0aGlzLm5hbWUgPT09ICIiKQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgcmV0dXJuIHRoaXMubmFtZSArICI6ICIgKyB0aGlzLnZhbHVlICsgKHRoaXMucHJpb3JpdHkgPyAiICEiICsgdGhpcy5wcmlvcml0eSA6ICIiKSArICI7IjsKICAgIH0sCgogICAgZ2V0IGlzTGl2ZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlIHx8IHRoaXMuc3R5bGVCYXNlZDsKICAgIH0sCgogICAgZ2V0IGFjdGl2ZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHVzID09PSAiYWN0aXZlIjsKICAgIH0sCgogICAgZ2V0IHN0eWxlQmFzZWQoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gInN0eWxlIjsKICAgIH0sCgogICAgZ2V0IGluYWN0aXZlKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09ICJpbmFjdGl2ZSI7CiAgICB9LAoKICAgIGdldCBkaXNhYmxlZCgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHVzID09PSAiZGlzYWJsZWQiOwogICAgfSwKCiAgICAvKioKICAgICAqIFJlcGxhY2VzICJwcm9wZXJ0eU5hbWU6IHByb3BlcnR5VmFsdWUgWyFpbXBvcnRhbnRdOyIgaW4gdGhlIHN0eWxlc2hlZXQgYnkgYW4gYXJiaXRyYXJ5IHByb3BlcnR5VGV4dC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHlUZXh0CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG1ham9yQ2hhbmdlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG92ZXJ3cml0ZQogICAgICogQHBhcmFtIHtmdW5jdGlvbig/V2ViSW5zcGVjdG9yLkNTU1N0eWxlRGVjbGFyYXRpb24pPX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIHNldFRleHQ6IGZ1bmN0aW9uKHByb3BlcnR5VGV4dCwgbWFqb3JDaGFuZ2UsIG92ZXJ3cml0ZSwgdXNlckNhbGxiYWNrKQogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7P1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9ufSBzdHlsZQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGVuYWJsZWRDYWxsYmFjayhzdHlsZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICB1c2VyQ2FsbGJhY2soc3R5bGUpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7P0NTU0FnZW50LkNTU1N0eWxlfSBzdHlsZVBheWxvYWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhlcnJvciwgc3R5bGVQYXlsb2FkKQogICAgICAgIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAoIWVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAobWFqb3JDaGFuZ2UpCiAgICAgICAgICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmRvbUFnZW50Lm1hcmtVbmRvYWJsZVN0YXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRleHQgPSBwcm9wZXJ0eVRleHQ7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGUgPSBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQoc3R5bGVQYXlsb2FkKTsKICAgICAgICAgICAgICAgIHZhciBuZXdQcm9wZXJ0eSA9IHN0eWxlLmFsbFByb3BlcnRpZXNbdGhpcy5pbmRleF07CgogICAgICAgICAgICAgICAgaWYgKG5ld1Byb3BlcnR5ICYmIHRoaXMuZGlzYWJsZWQgJiYgIXByb3BlcnR5VGV4dC5tYXRjaCgvXlxzKiQvKSkgewogICAgICAgICAgICAgICAgICAgIG5ld1Byb3BlcnR5LnNldERpc2FibGVkKGZhbHNlLCBlbmFibGVkQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhzdHlsZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm93bmVyU3R5bGUpCiAgICAgICAgICAgIHRocm93ICJObyBvd25lclN0eWxlIGZvciBwcm9wZXJ0eSI7CgogICAgICAgIGlmICghdGhpcy5vd25lclN0eWxlLmlkKQogICAgICAgICAgICB0aHJvdyAiTm8gb3duZXIgc3R5bGUgaWQiOwoKICAgICAgICAvLyBBbiBpbmRleCBwYXN0IGFsbCB0aGUgcHJvcGVydGllcyBhZGRzIGEgbmV3IHByb3BlcnR5IHRvIHRoZSBzdHlsZS4KICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaChtYWpvckNoYW5nZSk7CiAgICAgICAgQ1NTQWdlbnQuc2V0UHJvcGVydHlUZXh0KHRoaXMub3duZXJTdHlsZS5pZCwgdGhpcy5pbmRleCwgcHJvcGVydHlUZXh0LCBvdmVyd3JpdGUsIGNhbGxiYWNrLmJpbmQodGhpcykpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdWYWx1ZQogICAgICogQHBhcmFtIHtib29sZWFufSBtYWpvckNoYW5nZQogICAgICogQHBhcmFtIHtib29sZWFufSBvdmVyd3JpdGUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oP1dlYkluc3BlY3Rvci5DU1NTdHlsZURlY2xhcmF0aW9uKT19IHVzZXJDYWxsYmFjawogICAgICovCiAgICBzZXRWYWx1ZTogZnVuY3Rpb24obmV3VmFsdWUsIG1ham9yQ2hhbmdlLCBvdmVyd3JpdGUsIHVzZXJDYWxsYmFjaykKICAgIHsKICAgICAgICB2YXIgdGV4dCA9IHRoaXMubmFtZSArICI6ICIgKyBuZXdWYWx1ZSArICh0aGlzLnByaW9yaXR5ID8gIiAhIiArIHRoaXMucHJpb3JpdHkgOiAiIikgKyAiOyIKICAgICAgICB0aGlzLnNldFRleHQodGV4dCwgbWFqb3JDaGFuZ2UsIG92ZXJ3cml0ZSwgdXNlckNhbGxiYWNrKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRpc2FibGVkCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbik9fSB1c2VyQ2FsbGJhY2sKICAgICAqLwogICAgc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKGRpc2FibGVkLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLm93bmVyU3R5bGUgJiYgdXNlckNhbGxiYWNrKQogICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgaWYgKGRpc2FibGVkID09PSB0aGlzLmRpc2FibGVkICYmIHVzZXJDYWxsYmFjaykKICAgICAgICAgICAgdXNlckNhbGxiYWNrKHRoaXMub3duZXJTdHlsZSk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gZXJyb3IKICAgICAgICAgKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlfSBzdHlsZVBheWxvYWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhlcnJvciwgc3R5bGVQYXlsb2FkKQogICAgICAgIHsKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmICh1c2VyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5tYXJrVW5kb2FibGVTdGF0ZSgpOwogICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGUgPSBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVEZWNsYXJhdGlvbi5wYXJzZVBheWxvYWQoc3R5bGVQYXlsb2FkKTsKICAgICAgICAgICAgICAgIHVzZXJDYWxsYmFjayhzdHlsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5vd25lclN0eWxlLmlkKQogICAgICAgICAgICB0aHJvdyAiTm8gb3duZXIgc3R5bGUgaWQiOwoKICAgICAgICBXZWJJbnNwZWN0b3IuY3NzTW9kZWwuX3BlbmRpbmdDb21tYW5kc01ham9yU3RhdGUucHVzaChmYWxzZSk7CiAgICAgICAgQ1NTQWdlbnQudG9nZ2xlUHJvcGVydHkodGhpcy5vd25lclN0eWxlLmlkLCB0aGlzLmluZGV4LCBkaXNhYmxlZCwgY2FsbGJhY2suYmluZCh0aGlzKSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtib29sZWFufSBmb3JOYW1lCiAgICAgKiBAcmV0dXJuIHtXZWJJbnNwZWN0b3IuVUlMb2NhdGlvbn0KICAgICAqLwogICAgdWlMb2NhdGlvbjogZnVuY3Rpb24oZm9yTmFtZSkKICAgIHsKICAgICAgICBpZiAoIXRoaXMucmFuZ2UgfHwgIXRoaXMub3duZXJTdHlsZSB8fCAhdGhpcy5vd25lclN0eWxlLnBhcmVudFJ1bGUpCiAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICB2YXIgdXJsID0gdGhpcy5vd25lclN0eWxlLnBhcmVudFJ1bGUucmVzb3VyY2VVUkwoKTsKICAgICAgICBpZiAoIXVybCkKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgIHZhciByYW5nZSA9IHRoaXMucmFuZ2U7CiAgICAgICAgdmFyIGxpbmUgPSBmb3JOYW1lID8gcmFuZ2Uuc3RhcnRMaW5lIDogcmFuZ2UuZW5kTGluZTsKICAgICAgICAvLyBFbmQgb2YgcmFuZ2UgaXMgZXhjbHVzaXZlLCBzbyBzdWJ0cmFjdCAxIGZyb20gdGhlIGVuZCBvZmZzZXQuCiAgICAgICAgdmFyIGNvbHVtbiA9IGZvck5hbWUgPyByYW5nZS5zdGFydENvbHVtbiA6IHJhbmdlLmVuZENvbHVtbiAtICh0aGlzLnRleHQgJiYgdGhpcy50ZXh0LmVuZHNXaXRoKCI7IikgPyAyIDogMSk7CiAgICAgICAgdmFyIHJhd0xvY2F0aW9uID0gbmV3IFdlYkluc3BlY3Rvci5DU1NMb2NhdGlvbih1cmwsIGxpbmUsIGNvbHVtbik7CiAgICAgICAgcmV0dXJuIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5yYXdMb2NhdGlvblRvVUlMb2NhdGlvbihyYXdMb2NhdGlvbik7CiAgICB9Cn0KCi8qKgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtDU1NBZ2VudC5DU1NNZWRpYX0gcGF5bG9hZAogKi8KV2ViSW5zcGVjdG9yLkNTU01lZGlhID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdGhpcy50ZXh0ID0gcGF5bG9hZC50ZXh0OwogICAgdGhpcy5zb3VyY2UgPSBwYXlsb2FkLnNvdXJjZTsKICAgIHRoaXMuc291cmNlVVJMID0gcGF5bG9hZC5zb3VyY2VVUkwgfHwgIiI7CiAgICB0aGlzLnJhbmdlID0gcGF5bG9hZC5yYW5nZTsKICAgIHRoaXMucGFyZW50U3R5bGVTaGVldElkID0gcGF5bG9hZC5wYXJlbnRTdHlsZVNoZWV0SWQ7Cn0KCldlYkluc3BlY3Rvci5DU1NNZWRpYS5Tb3VyY2UgPSB7CiAgICBMSU5LRURfU0hFRVQ6ICJsaW5rZWRTaGVldCIsCiAgICBJTkxJTkVfU0hFRVQ6ICJpbmxpbmVTaGVldCIsCiAgICBNRURJQV9SVUxFOiAibWVkaWFSdWxlIiwKICAgIElNUE9SVF9SVUxFOiAiaW1wb3J0UnVsZSIKfTsKCi8qKgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU01lZGlhfSBwYXlsb2FkCiAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5DU1NNZWRpYX0KICovCldlYkluc3BlY3Rvci5DU1NNZWRpYS5wYXJzZVBheWxvYWQgPSBmdW5jdGlvbihwYXlsb2FkKQp7CiAgICByZXR1cm4gbmV3IFdlYkluc3BlY3Rvci5DU1NNZWRpYShwYXlsb2FkKTsKfQoKLyoqCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50LkNTU01lZGlhPn0gcGF5bG9hZAogKiBAcmV0dXJuIHtBcnJheS48V2ViSW5zcGVjdG9yLkNTU01lZGlhPn0KICovCldlYkluc3BlY3Rvci5DU1NNZWRpYS5wYXJzZU1lZGlhQXJyYXlQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXlsb2FkLmxlbmd0aDsgKytpKQogICAgICAgIHJlc3VsdC5wdXNoKFdlYkluc3BlY3Rvci5DU1NNZWRpYS5wYXJzZVBheWxvYWQocGF5bG9hZFtpXSkpOwogICAgcmV0dXJuIHJlc3VsdDsKfQoKV2ViSW5zcGVjdG9yLkNTU01lZGlhLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHJldHVybiB7bnVtYmVyfHVuZGVmaW5lZH0KICAgICAqLwogICAgbGluZU51bWJlckluU291cmNlOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLnJhbmdlKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLmhlYWRlcigpOwogICAgICAgIGlmICghaGVhZGVyKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHJldHVybiBoZWFkZXIubGluZU51bWJlckluU291cmNlKHRoaXMucmFuZ2Uuc3RhcnRMaW5lKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ8dW5kZWZpbmVkfQogICAgICovCiAgICBjb2x1bW5OdW1iZXJJblNvdXJjZTogZnVuY3Rpb24oKQogICAgewogICAgICAgIGlmICghdGhpcy5yYW5nZSkKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB2YXIgaGVhZGVyID0gdGhpcy5oZWFkZXIoKTsKICAgICAgICBpZiAoIWhlYWRlcikKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gaGVhZGVyLmNvbHVtbk51bWJlckluU291cmNlKHRoaXMucmFuZ2Uuc3RhcnRMaW5lLCB0aGlzLnJhbmdlLnN0YXJ0Q29sdW1uKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHs/V2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXRIZWFkZXJ9CiAgICAgKi8KICAgIGhlYWRlcjogZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiB0aGlzLnBhcmVudFN0eWxlU2hlZXRJZCA/IFdlYkluc3BlY3Rvci5jc3NNb2RlbC5zdHlsZVNoZWV0SGVhZGVyRm9ySWQodGhpcy5wYXJlbnRTdHlsZVNoZWV0SWQpIDogbnVsbDsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAaW1wbGVtZW50cyB7V2ViSW5zcGVjdG9yLkNvbnRlbnRQcm92aWRlcn0KICogQHBhcmFtIHtDU1NBZ2VudC5DU1NTdHlsZVNoZWV0SGVhZGVyfSBwYXlsb2FkCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldEhlYWRlciA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHRoaXMuaWQgPSBwYXlsb2FkLnN0eWxlU2hlZXRJZDsKICAgIHRoaXMuZnJhbWVJZCA9IHBheWxvYWQuZnJhbWVJZDsKICAgIHRoaXMuc291cmNlVVJMID0gcGF5bG9hZC5zb3VyY2VVUkw7CiAgICB0aGlzLmhhc1NvdXJjZVVSTCA9ICEhcGF5bG9hZC5oYXNTb3VyY2VVUkw7CiAgICB0aGlzLnNvdXJjZU1hcFVSTCA9IHBheWxvYWQuc291cmNlTWFwVVJMOwogICAgdGhpcy5vcmlnaW4gPSBwYXlsb2FkLm9yaWdpbjsKICAgIHRoaXMudGl0bGUgPSBwYXlsb2FkLnRpdGxlOwogICAgdGhpcy5kaXNhYmxlZCA9IHBheWxvYWQuZGlzYWJsZWQ7CiAgICB0aGlzLmlzSW5saW5lID0gcGF5bG9hZC5pc0lubGluZTsKICAgIHRoaXMuc3RhcnRMaW5lID0gcGF5bG9hZC5zdGFydExpbmU7CiAgICB0aGlzLnN0YXJ0Q29sdW1uID0gcGF5bG9hZC5zdGFydENvbHVtbjsKICAgIC8qKiBAdHlwZSB7IVNldC48IVdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkxpdmVMb2NhdGlvbj59ICovCiAgICB0aGlzLl9sb2NhdGlvbnMgPSBuZXcgU2V0KCk7CiAgICAvKiogQHR5cGUgeyFBcnJheS48IVdlYkluc3BlY3Rvci5Tb3VyY2VNYXBwaW5nPn0gKi8KICAgIHRoaXMuX3NvdXJjZU1hcHBpbmdzID0gW107Cn0KCldlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0SGVhZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICByZXNvdXJjZVVSTDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiB0aGlzLm9yaWdpbiA9PT0gImluc3BlY3RvciIgPyB0aGlzLl92aWFJbnNwZWN0b3JSZXNvdXJjZVVSTCgpIDogdGhpcy5zb3VyY2VVUkw7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuQ1NTTG9jYXRpb259IHJhd0xvY2F0aW9uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFdlYkluc3BlY3Rvci5VSUxvY2F0aW9uKTooYm9vbGVhbnx1bmRlZmluZWQpfSB1cGRhdGVEZWxlZ2F0ZQogICAgICogQHJldHVybiB7P1dlYkluc3BlY3Rvci5MaXZlTG9jYXRpb259CiAgICAgKi8KICAgIGNyZWF0ZUxpdmVMb2NhdGlvbjogZnVuY3Rpb24ocmF3TG9jYXRpb24sIHVwZGF0ZURlbGVnYXRlKQogICAgewogICAgICAgIHZhciBsb2NhdGlvbiA9IG5ldyBXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbC5MaXZlTG9jYXRpb24ocmF3TG9jYXRpb24sIHVwZGF0ZURlbGVnYXRlLCB0aGlzKTsKICAgICAgICB0aGlzLl9sb2NhdGlvbnMuYWRkKGxvY2F0aW9uKTsKICAgICAgICBsb2NhdGlvbi51cGRhdGUoKTsKICAgICAgICByZXR1cm4gbG9jYXRpb247CiAgICB9LAoKICAgIHVwZGF0ZUxvY2F0aW9uczogZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBpdGVtcyA9IHRoaXMuX2xvY2F0aW9ucy5pdGVtcygpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyArK2kpCiAgICAgICAgICAgIGl0ZW1zW2ldLnVwZGF0ZSgpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7IVdlYkluc3BlY3Rvci5DU1NTdHlsZU1vZGVsLkxpdmVMb2NhdGlvbn0gbG9jYXRpb24KICAgICAqLwogICAgX3JlbW92ZUxvY2F0aW9uOiBmdW5jdGlvbihsb2NhdGlvbikKICAgIHsKICAgICAgICB0aGlzLl9sb2NhdGlvbnMucmVtb3ZlKGxvY2F0aW9uKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGluZU51bWJlcgogICAgICogQHBhcmFtIHtudW1iZXI9fSBjb2x1bW5OdW1iZXIKICAgICAqIEByZXR1cm4gez9XZWJJbnNwZWN0b3IuVUlMb2NhdGlvbn0KICAgICAqLwogICAgcmF3TG9jYXRpb25Ub1VJTG9jYXRpb246IGZ1bmN0aW9uKGxpbmVOdW1iZXIsIGNvbHVtbk51bWJlcikKICAgIHsKICAgICAgICB2YXIgdWlMb2NhdGlvbjsKICAgICAgICB2YXIgcmF3TG9jYXRpb24gPSBuZXcgV2ViSW5zcGVjdG9yLkNTU0xvY2F0aW9uKHRoaXMucmVzb3VyY2VVUkwoKSwgbGluZU51bWJlciwgY29sdW1uTnVtYmVyIHx8IDApOwogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9zb3VyY2VNYXBwaW5ncy5sZW5ndGggLSAxOyAhdWlMb2NhdGlvbiAmJiBpID49IDA7IC0taSkKICAgICAgICAgICAgdWlMb2NhdGlvbiA9IHRoaXMuX3NvdXJjZU1hcHBpbmdzW2ldLnJhd0xvY2F0aW9uVG9VSUxvY2F0aW9uKHJhd0xvY2F0aW9uKTsKICAgICAgICByZXR1cm4gdWlMb2NhdGlvbiB8fCBudWxsOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7IVdlYkluc3BlY3Rvci5Tb3VyY2VNYXBwaW5nfSBzb3VyY2VNYXBwaW5nCiAgICAgKi8KICAgIHB1c2hTb3VyY2VNYXBwaW5nOiBmdW5jdGlvbihzb3VyY2VNYXBwaW5nKQogICAgewogICAgICAgIHRoaXMuX3NvdXJjZU1hcHBpbmdzLnB1c2goc291cmNlTWFwcGluZyk7CiAgICAgICAgdGhpcy51cGRhdGVMb2NhdGlvbnMoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgKi8KICAgIF9rZXk6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5mcmFtZUlkICsgIjoiICsgdGhpcy5yZXNvdXJjZVVSTCgpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAqLwogICAgX3ZpYUluc3BlY3RvclJlc291cmNlVVJMOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGZyYW1lID0gV2ViSW5zcGVjdG9yLnJlc291cmNlVHJlZU1vZGVsLmZyYW1lRm9ySWQodGhpcy5mcmFtZUlkKTsKICAgICAgICBjb25zb2xlLmFzc2VydChmcmFtZSk7CiAgICAgICAgdmFyIHBhcnNlZFVSTCA9IG5ldyBXZWJJbnNwZWN0b3IuUGFyc2VkVVJMKGZyYW1lLnVybCk7CiAgICAgICAgdmFyIGZha2VVUkwgPSAiaW5zcGVjdG9yOi8vIiArIHBhcnNlZFVSTC5ob3N0ICsgcGFyc2VkVVJMLmZvbGRlclBhdGhDb21wb25lbnRzOwogICAgICAgIGlmICghZmFrZVVSTC5lbmRzV2l0aCgiLyIpKQogICAgICAgICAgICBmYWtlVVJMICs9ICIvIjsKICAgICAgICBmYWtlVVJMICs9ICJpbnNwZWN0b3Itc3R5bGVzaGVldCI7CiAgICAgICAgcmV0dXJuIGZha2VVUkw7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbmVOdW1iZXJJblN0eWxlU2hlZXQKICAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICAqLwogICAgbGluZU51bWJlckluU291cmNlOiBmdW5jdGlvbihsaW5lTnVtYmVySW5TdHlsZVNoZWV0KQogICAgewogICAgICAgIHJldHVybiB0aGlzLnN0YXJ0TGluZSArIGxpbmVOdW1iZXJJblN0eWxlU2hlZXQ7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbmVOdW1iZXJJblN0eWxlU2hlZXQKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2x1bW5OdW1iZXJJblN0eWxlU2hlZXQKICAgICAqIEByZXR1cm4ge251bWJlcnx1bmRlZmluZWR9CiAgICAgKi8KICAgIGNvbHVtbk51bWJlckluU291cmNlOiBmdW5jdGlvbihsaW5lTnVtYmVySW5TdHlsZVNoZWV0LCBjb2x1bW5OdW1iZXJJblN0eWxlU2hlZXQpCiAgICB7CiAgICAgICAgcmV0dXJuIChsaW5lTnVtYmVySW5TdHlsZVNoZWV0ID8gMCA6IHRoaXMuc3RhcnRDb2x1bW4pICsgY29sdW1uTnVtYmVySW5TdHlsZVNoZWV0OwogICAgfSwKCiAgICAvKioKICAgICAqIEBvdmVycmlkZQogICAgICovCiAgICBjb250ZW50VVJMOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVzb3VyY2VVUkwoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAb3ZlcnJpZGUKICAgICAqLwogICAgY29udGVudFR5cGU6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICByZXR1cm4gV2ViSW5zcGVjdG9yLnJlc291cmNlVHlwZXMuU3R5bGVzaGVldDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAb3ZlcnJpZGUKICAgICAqLwogICAgcmVxdWVzdENvbnRlbnQ6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgewogICAgICAgIENTU0FnZW50LmdldFN0eWxlU2hlZXRUZXh0KHRoaXMuaWQsIHRleHRDYWxsYmFjay5iaW5kKHRoaXMpKTsKCiAgICAgICAgZnVuY3Rpb24gdGV4dENhbGxiYWNrKGVycm9yLCB0ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICBXZWJJbnNwZWN0b3IubG9nKCJGYWlsZWQgdG8gZ2V0IHRleHQgZm9yIHN0eWxlc2hlZXQgIiArIHRoaXMuaWQgKyAiOiAiICsgZXJyb3IpOwogICAgICAgICAgICAgICAgdGV4dCA9ICIiOwogICAgICAgICAgICAgICAgLy8gRmFsbCB0aHJvdWdoLgogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKHRleHQsIGZhbHNlLCAidGV4dC9jc3MiKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQG92ZXJyaWRlCiAgICAgKi8KICAgIHNlYXJjaEluQ29udGVudDogZnVuY3Rpb24ocXVlcnksIGNhc2VTZW5zaXRpdmUsIGlzUmVnZXgsIGNhbGxiYWNrKQogICAgewogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1TZWFyY2goY29udGVudCkKICAgICAgICB7CiAgICAgICAgICAgIGNhbGxiYWNrKFdlYkluc3BlY3Rvci5Db250ZW50UHJvdmlkZXIucGVyZm9ybVNlYXJjaEluQ29udGVudChjb250ZW50LCBxdWVyeSwgY2FzZVNlbnNpdGl2ZSwgaXNSZWdleCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2VhcmNoSW5Db250ZW50IHNob3VsZCBjYWxsIGJhY2sgbGF0ZXIuCiAgICAgICAgdGhpcy5yZXF1ZXN0Q29udGVudChwZXJmb3JtU2VhcmNoKTsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlU2hlZXRCb2R5fSBwYXlsb2FkCiAqLwpXZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldCA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHRoaXMuaWQgPSBwYXlsb2FkLnN0eWxlU2hlZXRJZDsKICAgIHRoaXMucnVsZXMgPSBbXTsKICAgIHRoaXMuc3R5bGVzID0ge307CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBheWxvYWQucnVsZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcnVsZSA9IFdlYkluc3BlY3Rvci5DU1NSdWxlLnBhcnNlUGF5bG9hZChwYXlsb2FkLnJ1bGVzW2ldKTsKICAgICAgICB0aGlzLnJ1bGVzLnB1c2gocnVsZSk7CiAgICAgICAgaWYgKHJ1bGUuc3R5bGUpCiAgICAgICAgICAgIHRoaXMuc3R5bGVzW3J1bGUuc3R5bGUuaWRdID0gcnVsZS5zdHlsZTsKICAgIH0KICAgIGlmICgidGV4dCIgaW4gcGF5bG9hZCkKICAgICAgICB0aGlzLl90ZXh0ID0gcGF5bG9hZC50ZXh0Owp9CgovKioKICogQHBhcmFtIHtDU1NBZ2VudC5TdHlsZVNoZWV0SWR9IHN0eWxlU2hlZXRJZAogKiBAcGFyYW0ge2Z1bmN0aW9uKD9XZWJJbnNwZWN0b3IuQ1NTU3R5bGVTaGVldCl9IHVzZXJDYWxsYmFjawogKi8KV2ViSW5zcGVjdG9yLkNTU1N0eWxlU2hlZXQuY3JlYXRlRm9ySWQgPSBmdW5jdGlvbihzdHlsZVNoZWV0SWQsIHVzZXJDYWxsYmFjaykKewogICAgLyoqCiAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGVycm9yCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LkNTU1N0eWxlU2hlZXRCb2R5fSBzdHlsZVNoZWV0UGF5bG9hZAogICAgICovCiAgICBmdW5jdGlvbiBjYWxsYmFjayhlcnJvciwgc3R5bGVTaGVldFBheWxvYWQpCiAgICB7CiAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgICB1c2VyQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB1c2VyQ2FsbGJhY2sobmV3IFdlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0KHN0eWxlU2hlZXRQYXlsb2FkKSk7CiAgICB9CiAgICBDU1NBZ2VudC5nZXRTdHlsZVNoZWV0KHN0eWxlU2hlZXRJZCwgY2FsbGJhY2suYmluZCh0aGlzKSk7Cn0KCldlYkluc3BlY3Rvci5DU1NTdHlsZVNoZWV0LnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHJldHVybiB7c3RyaW5nfHVuZGVmaW5lZH0KICAgICAqLwogICAgZ2V0VGV4dDogZnVuY3Rpb24oKQogICAgewogICAgICAgIHJldHVybiB0aGlzLl90ZXh0OwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdUZXh0CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG1ham9yQ2hhbmdlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKD9zdHJpbmcpPX0gdXNlckNhbGxiYWNrCiAgICAgKi8KICAgIHNldFRleHQ6IGZ1bmN0aW9uKG5ld1RleHQsIG1ham9yQ2hhbmdlLCB1c2VyQ2FsbGJhY2spCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBlcnJvcgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGVycm9yKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFlcnJvcikKICAgICAgICAgICAgICAgIFdlYkluc3BlY3Rvci5kb21BZ2VudC5tYXJrVW5kb2FibGVTdGF0ZSgpOwoKICAgICAgICAgICAgV2ViSW5zcGVjdG9yLmNzc01vZGVsLl9wZW5kaW5nQ29tbWFuZHNNYWpvclN0YXRlLnBvcCgpOwogICAgICAgICAgICBpZiAodXNlckNhbGxiYWNrKQogICAgICAgICAgICAgICAgdXNlckNhbGxiYWNrKGVycm9yKTsKICAgICAgICB9CgogICAgICAgIFdlYkluc3BlY3Rvci5jc3NNb2RlbC5fcGVuZGluZ0NvbW1hbmRzTWFqb3JTdGF0ZS5wdXNoKG1ham9yQ2hhbmdlKTsKICAgICAgICBDU1NBZ2VudC5zZXRTdHlsZVNoZWV0VGV4dCh0aGlzLmlkLCBuZXdUZXh0LCBjYWxsYmFjay5iaW5kKHRoaXMpKTsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAaW1wbGVtZW50cyB7Q1NTQWdlbnQuRGlzcGF0Y2hlcn0KICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuQ1NTU3R5bGVNb2RlbH0gY3NzTW9kZWwKICovCldlYkluc3BlY3Rvci5DU1NEaXNwYXRjaGVyID0gZnVuY3Rpb24oY3NzTW9kZWwpCnsKICAgIHRoaXMuX2Nzc01vZGVsID0gY3NzTW9kZWw7Cn0KCldlYkluc3BlY3Rvci5DU1NEaXNwYXRjaGVyLnByb3RvdHlwZSA9IHsKICAgIG1lZGlhUXVlcnlSZXN1bHRDaGFuZ2VkOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwubWVkaWFRdWVyeVJlc3VsdENoYW5nZWQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gc3R5bGVTaGVldElkCiAgICAgKi8KICAgIHN0eWxlU2hlZXRDaGFuZ2VkOiBmdW5jdGlvbihzdHlsZVNoZWV0SWQpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX2ZpcmVTdHlsZVNoZWV0Q2hhbmdlZChzdHlsZVNoZWV0SWQpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuQ1NTU3R5bGVTaGVldEhlYWRlcn0gaGVhZGVyCiAgICAgKi8KICAgIHN0eWxlU2hlZXRBZGRlZDogZnVuY3Rpb24oaGVhZGVyKQogICAgewogICAgICAgIHRoaXMuX2Nzc01vZGVsLl9zdHlsZVNoZWV0QWRkZWQoaGVhZGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50LlN0eWxlU2hlZXRJZH0gaWQKICAgICAqLwogICAgc3R5bGVTaGVldFJlbW92ZWQ6IGZ1bmN0aW9uKGlkKQogICAgewogICAgICAgIHRoaXMuX2Nzc01vZGVsLl9zdHlsZVNoZWV0UmVtb3ZlZChpZCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIHtDU1NBZ2VudC5OYW1lZEZsb3d9IG5hbWVkRmxvd1BheWxvYWQKICAgICAqLwogICAgbmFtZWRGbG93Q3JlYXRlZDogZnVuY3Rpb24obmFtZWRGbG93UGF5bG9hZCkKICAgIHsKICAgICAgICB0aGlzLl9jc3NNb2RlbC5fbmFtZWRGbG93Q3JlYXRlZChuYW1lZEZsb3dQYXlsb2FkKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0RPTUFnZW50Lk5vZGVJZH0gZG9jdW1lbnROb2RlSWQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmbG93TmFtZQogICAgICovCiAgICBuYW1lZEZsb3dSZW1vdmVkOiBmdW5jdGlvbihkb2N1bWVudE5vZGVJZCwgZmxvd05hbWUpCiAgICB7CiAgICAgICAgdGhpcy5fY3NzTW9kZWwuX25hbWVkRmxvd1JlbW92ZWQoZG9jdW1lbnROb2RlSWQsIGZsb3dOYW1lKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gbmFtZWRGbG93UGF5bG9hZAogICAgICovCiAgICByZWdpb25MYXlvdXRVcGRhdGVkOiBmdW5jdGlvbihuYW1lZEZsb3dQYXlsb2FkKQogICAgewogICAgICAgIHRoaXMuX2Nzc01vZGVsLl9yZWdpb25MYXlvdXRVcGRhdGVkKG5hbWVkRmxvd1BheWxvYWQpOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Q1NTQWdlbnQuTmFtZWRGbG93fSBuYW1lZEZsb3dQYXlsb2FkCiAgICAgKi8KICAgIHJlZ2lvbk92ZXJzZXRDaGFuZ2VkOiBmdW5jdGlvbihuYW1lZEZsb3dQYXlsb2FkKQogICAgewogICAgICAgIHRoaXMuX2Nzc01vZGVsLl9yZWdpb25PdmVyc2V0Q2hhbmdlZChuYW1lZEZsb3dQYXlsb2FkKTsKICAgIH0KfQoKLyoqCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0NTU0FnZW50Lk5hbWVkRmxvd30gcGF5bG9hZAogKi8KV2ViSW5zcGVjdG9yLk5hbWVkRmxvdyA9IGZ1bmN0aW9uKHBheWxvYWQpCnsKICAgIHRoaXMuZG9jdW1lbnROb2RlSWQgPSBwYXlsb2FkLmRvY3VtZW50Tm9kZUlkOwogICAgdGhpcy5uYW1lID0gcGF5bG9hZC5uYW1lOwogICAgdGhpcy5vdmVyc2V0ID0gcGF5bG9hZC5vdmVyc2V0OwogICAgdGhpcy5jb250ZW50ID0gcGF5bG9hZC5jb250ZW50OwogICAgdGhpcy5yZWdpb25zID0gcGF5bG9hZC5yZWdpb25zOwp9CgovKioKICogQHBhcmFtIHtDU1NBZ2VudC5OYW1lZEZsb3d9IHBheWxvYWQKICogQHJldHVybiB7V2ViSW5zcGVjdG9yLk5hbWVkRmxvd30KICovCldlYkluc3BlY3Rvci5OYW1lZEZsb3cucGFyc2VQYXlsb2FkID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgcmV0dXJuIG5ldyBXZWJJbnNwZWN0b3IuTmFtZWRGbG93KHBheWxvYWQpOwp9CgovKioKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7QXJyYXkuPENTU0FnZW50Lk5hbWVkRmxvdz59IHBheWxvYWQKICovCldlYkluc3BlY3Rvci5OYW1lZEZsb3dDb2xsZWN0aW9uID0gZnVuY3Rpb24ocGF5bG9hZCkKewogICAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgV2ViSW5zcGVjdG9yLk5hbWVkRmxvdz59ICovCiAgICB0aGlzLm5hbWVkRmxvd01hcCA9IHt9OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF5bG9hZC5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBuYW1lZEZsb3cgPSBXZWJJbnNwZWN0b3IuTmFtZWRGbG93LnBhcnNlUGF5bG9hZChwYXlsb2FkW2ldKTsKICAgICAgICB0aGlzLm5hbWVkRmxvd01hcFtuYW1lZEZsb3cubmFtZV0gPSBuYW1lZEZsb3c7CiAgICB9Cn0KCldlYkluc3BlY3Rvci5OYW1lZEZsb3dDb2xsZWN0aW9uLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogQHBhcmFtIHtXZWJJbnNwZWN0b3IuTmFtZWRGbG93fSBuYW1lZEZsb3cKICAgICAqLwogICAgX2FwcGVuZE5hbWVkRmxvdzogZnVuY3Rpb24obmFtZWRGbG93KQogICAgewogICAgICAgIHRoaXMubmFtZWRGbG93TWFwW25hbWVkRmxvdy5uYW1lXSA9IG5hbWVkRmxvdzsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmxvd05hbWUKICAgICAqLwogICAgX3JlbW92ZU5hbWVkRmxvdzogZnVuY3Rpb24oZmxvd05hbWUpCiAgICB7CiAgICAgICAgZGVsZXRlIHRoaXMubmFtZWRGbG93TWFwW2Zsb3dOYW1lXTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmxvd05hbWUKICAgICAqIEByZXR1cm4ge1dlYkluc3BlY3Rvci5OYW1lZEZsb3d9CiAgICAgKi8KICAgIGZsb3dCeU5hbWU6IGZ1bmN0aW9uKGZsb3dOYW1lKQogICAgewogICAgICAgIHZhciBuYW1lZEZsb3cgPSB0aGlzLm5hbWVkRmxvd01hcFtmbG93TmFtZV07CgogICAgICAgIGlmICghbmFtZWRGbG93KQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gbmFtZWRGbG93OwogICAgfQp9Ci8qKgogKiBAdHlwZSB7V2ViSW5zcGVjdG9yLkNTU1N0eWxlTW9kZWx9CiAqLwpXZWJJbnNwZWN0b3IuY3NzTW9kZWwgPSBudWxsOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:35:15 GMT",
                    "Content-Length": "53405",
                    "Date": "Fri, 07 Nov 2014 19:35:16 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}