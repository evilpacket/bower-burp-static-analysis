{
    "url": "http://localhost:9999/lhorie/mithril/archive/v0.1.20/mithril.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>element.href = window.location.pathname + modes[m.route.mode] + element.pathname</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/lhorie/mithril/archive/v0.1.20/mithril.js",
                "path": "/lhorie/mithril/archive/v0.1.20/mithril.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9saG9yaWUvbWl0aHJpbC9hcmNoaXZlL3YwLjEuMjAvbWl0aHJpbC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjY5NjENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTY6MTI6MDcgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE2OjEyOjA1IEdNVA0KDQpNaXRocmlsID0gbSA9IG5ldyBmdW5jdGlvbiBhcHAod2luZG93LCB1bmRlZmluZWQpIHsKCXZhciB0eXBlID0ge30udG9TdHJpbmcKCXZhciBwYXJzZXIgPSAvKD86KF58I3xcLikoW14jXC5cW1xdXSspKXwoXFsuKz9cXSkvZywgYXR0clBhcnNlciA9IC9cWyguKz8pKD86PSgifCd8KSguKj8pXDIpP1xdLwoJCglmdW5jdGlvbiBtKCkgewoJCXZhciBhcmdzID0gYXJndW1lbnRzCgkJdmFyIGhhc0F0dHJzID0gYXJnc1sxXSAhPT0gdW5kZWZpbmVkICYmIHR5cGUuY2FsbChhcmdzWzFdKSA9PSAiW29iamVjdCBPYmplY3RdIiAmJiAhKCJ0YWciIGluIGFyZ3NbMV0pICYmICEoInN1YnRyZWUiIGluIGFyZ3NbMV0pCgkJdmFyIGF0dHJzID0gaGFzQXR0cnMgPyBhcmdzWzFdIDoge30KCQl2YXIgY2xhc3NBdHRyTmFtZSA9ICJjbGFzcyIgaW4gYXR0cnMgPyAiY2xhc3MiIDogImNsYXNzTmFtZSIKCQl2YXIgY2VsbCA9IHt0YWc6ICJkaXYiLCBhdHRyczoge319CgkJdmFyIG1hdGNoLCBjbGFzc2VzID0gW10KCQl3aGlsZSAobWF0Y2ggPSBwYXJzZXIuZXhlYyhhcmdzWzBdKSkgewoJCQlpZiAobWF0Y2hbMV0gPT0gIiIpIGNlbGwudGFnID0gbWF0Y2hbMl0KCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIiMiKSBjZWxsLmF0dHJzLmlkID0gbWF0Y2hbMl0KCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIi4iKSBjbGFzc2VzLnB1c2gobWF0Y2hbMl0pCgkJCWVsc2UgaWYgKG1hdGNoWzNdWzBdID09ICJbIikgewoJCQkJdmFyIHBhaXIgPSBhdHRyUGFyc2VyLmV4ZWMobWF0Y2hbM10pCgkJCQljZWxsLmF0dHJzW3BhaXJbMV1dID0gcGFpclszXSB8fCAocGFpclsyXSA/ICIiIDp0cnVlKQoJCQl9CgkJfQoJCWlmIChjbGFzc2VzLmxlbmd0aCA+IDApIGNlbGwuYXR0cnNbY2xhc3NBdHRyTmFtZV0gPSBjbGFzc2VzLmpvaW4oIiAiKQoJCQoJCWNlbGwuY2hpbGRyZW4gPSBoYXNBdHRycyA/IGFyZ3NbMl0gOiBhcmdzWzFdCgkJCgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gYXR0cnMpIHsKCQkJaWYgKGF0dHJOYW1lID09IGNsYXNzQXR0ck5hbWUpIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gKGNlbGwuYXR0cnNbYXR0ck5hbWVdIHx8ICIiKSArICIgIiArIGF0dHJzW2F0dHJOYW1lXQoJCQllbHNlIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gYXR0cnNbYXR0ck5hbWVdCgkJfQoJCXJldHVybiBjZWxsCgl9CglmdW5jdGlvbiBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIHBhcmVudENhY2hlLCBwYXJlbnRJbmRleCwgZGF0YSwgY2FjaGVkLCBzaG91bGRSZWF0dGFjaCwgaW5kZXgsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpIHsKCQkvL2BidWlsZGAgaXMgYSByZWN1cnNpdmUgZnVuY3Rpb24gdGhhdCBtYW5hZ2VzIGNyZWF0aW9uL2RpZmZpbmcvcmVtb3ZhbCBvZiBET00gZWxlbWVudHMgYmFzZWQgb24gY29tcGFyaXNvbiBiZXR3ZWVuIGBkYXRhYCBhbmQgYGNhY2hlZGAKCgkJLy9gcGFyZW50RWxlbWVudGAgaXMgYSBET00gZWxlbWVudCB1c2VkIGZvciBXM0MgRE9NIEFQSSBjYWxscwoJCS8vYHBhcmVudFRhZ2AgaXMgb25seSB1c2VkIGZvciBoYW5kbGluZyBhIGNvcm5lciBjYXNlIGZvciB0ZXh0YXJlYSB2YWx1ZXMKCQkvL2BwYXJlbnRDYWNoZWAgaXMgdXNlZCB0byByZW1vdmUgbm9kZXMgaW4gc29tZSBtdWx0aS1ub2RlIGNhc2VzCgkJLy9gcGFyZW50SW5kZXhgIGFuZCBgaW5kZXhgIGFyZSB1c2VkIHRvIGZpZ3VyZSBvdXQgdGhlIG9mZnNldCBvZiBub2Rlcy4gVGhleSdyZSBhcnRpZmFjdHMgZnJvbSBiZWZvcmUgYXJyYXlzIHN0YXJ0ZWQgYmVpbmcgZmxhdHRlbmVkIGFuZCBhcmUgbGlrZWx5IHJlZmFjdG9yYWJsZQoJCS8vYGRhdGFgIGFuZCBgY2FjaGVkYCBhcmUsIHJlc3BlY3RpdmVseSwgdGhlIG5ldyBhbmQgb2xkIG5vZGVzIGJlaW5nIGRpZmZlZAoJCS8vYHNob3VsZFJlYXR0YWNoYCBpcyBhIGZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGEgcGFyZW50IG5vZGUgd2FzIHJlY3JlYXRlZCAoaWYgc28sIGFuZCBpZiB0aGlzIG5vZGUgaXMgcmV1c2VkLCB0aGVuIHRoaXMgbm9kZSBtdXN0IHJlYXR0YWNoIGl0c2VsZiB0byB0aGUgbmV3IHBhcmVudCkKCQkvL2BlZGl0YWJsZWAgaXMgYSBmbGFnIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgYW4gYW5jZXN0b3IgaXMgY29udGVudGVkaXRhYmxlCgkJLy9gbmFtZXNwYWNlYCBpbmRpY2F0ZXMgdGhlIGNsb3Nlc3QgSFRNTCBuYW1lc3BhY2UgYXMgaXQgY2FzY2FkZXMgZG93biBmcm9tIGFuIGFuY2VzdG9yCgkJLy9gY29uZmlnc2AgaXMgYSBsaXN0IG9mIGNvbmZpZyBmdW5jdGlvbnMgdG8gcnVuIGFmdGVyIHRoZSB0b3Btb3N0IGBidWlsZGAgY2FsbCBmaW5pc2hlcyBydW5uaW5nCgkJCgkJLy90aGVyZSdzIGxvZ2ljIHRoYXQgcmVsaWVzIG9uIHRoZSBhc3N1bXB0aW9uIHRoYXQgbnVsbCBhbmQgdW5kZWZpbmVkIGRhdGEgYXJlIGVxdWl2YWxlbnQgdG8gZW1wdHkgc3RyaW5ncwoJCS8vLSB0aGlzIHByZXZlbnRzIGxpZmVjeWNsZSBzdXJwcmlzZXMgZnJvbSBwcm9jZWR1cmFsIGhlbHBlcnMgdGhhdCBtaXggaW1wbGljaXQgYW5kIGV4cGxpY2l0IHJldHVybiBzdGF0ZW1lbnRzCgkJLy8tIGl0IHNpbXBsaWZpZXMgZGlmZmluZyBjb2RlCgkJaWYgKGRhdGEgPT09IHVuZGVmaW5lZCB8fCBkYXRhID09PSBudWxsKSBkYXRhID0gIiIKCQlpZiAoZGF0YS5zdWJ0cmVlID09PSAicmV0YWluIikgcmV0dXJuIGNhY2hlZAoKCQl2YXIgY2FjaGVkVHlwZSA9IHR5cGUuY2FsbChjYWNoZWQpLCBkYXRhVHlwZSA9IHR5cGUuY2FsbChkYXRhKQoJCWlmIChjYWNoZWQgPT09IHVuZGVmaW5lZCB8fCBjYWNoZWQgPT09IG51bGwgfHwgY2FjaGVkVHlwZSAhPSBkYXRhVHlwZSkgewoJCQlpZiAoY2FjaGVkICE9PSBudWxsICYmIGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CgkJCQlpZiAocGFyZW50Q2FjaGUgJiYgcGFyZW50Q2FjaGUubm9kZXMpIHsKCQkJCQl2YXIgb2Zmc2V0ID0gaW5kZXggLSBwYXJlbnRJbmRleAoJCQkJCXZhciBlbmQgPSBvZmZzZXQgKyAoZGF0YVR5cGUgPT0gIltvYmplY3QgQXJyYXldIiA/IGRhdGEgOiBjYWNoZWQubm9kZXMpLmxlbmd0aAoJCQkJCWNsZWFyKHBhcmVudENhY2hlLm5vZGVzLnNsaWNlKG9mZnNldCwgZW5kKSwgcGFyZW50Q2FjaGUuc2xpY2Uob2Zmc2V0LCBlbmQpKQoJCQkJfQoJCQkJZWxzZSBpZiAoY2FjaGVkLm5vZGVzKSBjbGVhcihjYWNoZWQubm9kZXMsIGNhY2hlZCkKCQkJfQoJCQljYWNoZWQgPSBuZXcgZGF0YS5jb25zdHJ1Y3RvcgoJCQljYWNoZWQubm9kZXMgPSBbXQoJCX0KCgkJaWYgKGRhdGFUeXBlID09ICJbb2JqZWN0IEFycmF5XSIpIHsKCQkJZGF0YSA9IGZsYXR0ZW4oZGF0YSkKCQkJdmFyIG5vZGVzID0gW10sIGludGFjdCA9IGNhY2hlZC5sZW5ndGggPT09IGRhdGEubGVuZ3RoLCBzdWJBcnJheUNvdW50ID0gMAoJCQkKCQkJLy9rZXkgYWxnb3JpdGhtOiBzb3J0IGVsZW1lbnRzIHdpdGhvdXQgcmVjcmVhdGluZyB0aGVtIGlmIGtleXMgYXJlIHByZXNlbnQKCQkJLy8xKSBjcmVhdGUgYSBtYXAgb2YgYWxsIGV4aXN0aW5nIGtleXMsIGFuZCBtYXJrIGFsbCBmb3IgZGVsZXRpb24KCQkJLy8yKSBhZGQgbmV3IGtleXMgdG8gbWFwIGFuZCBtYXJrIHRoZW0gZm9yIGFkZGl0aW9uCgkJCS8vMykgaWYga2V5IGV4aXN0cyBpbiBuZXcgbGlzdCwgY2hhbmdlIGFjdGlvbiBmcm9tIGRlbGV0aW9uIHRvIGEgbW92ZQoJCQkvLzQpIGZvciBlYWNoIGtleSwgaGFuZGxlIGl0cyBjb3JyZXNwb25kaW5nIGFjdGlvbiBhcyBtYXJrZWQgaW4gcHJldmlvdXMgc3RlcHMKCQkJLy81KSBjb3B5IHVua2V5ZWQgaXRlbXMgaW50byB0aGVpciByZXNwZWN0aXZlIGdhcHMKCQkJdmFyIERFTEVUSU9OID0gMSwgSU5TRVJUSU9OID0gMiAsIE1PVkUgPSAzCgkJCXZhciBleGlzdGluZyA9IHt9LCB1bmtleWVkID0gW10sIHNob3VsZE1haW50YWluSWRlbnRpdGllcyA9IGZhbHNlCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgY2FjaGVkLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAoY2FjaGVkW2ldICYmIGNhY2hlZFtpXS5hdHRycyAmJiBjYWNoZWRbaV0uYXR0cnMua2V5ICE9PSB1bmRlZmluZWQpIHsKCQkJCQlzaG91bGRNYWludGFpbklkZW50aXRpZXMgPSB0cnVlCgkJCQkJZXhpc3RpbmdbY2FjaGVkW2ldLmF0dHJzLmtleV0gPSB7YWN0aW9uOiBERUxFVElPTiwgaW5kZXg6IGl9CgkJCQl9CgkJCX0KCQkJaWYgKHNob3VsZE1haW50YWluSWRlbnRpdGllcykgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkJaWYgKGRhdGFbaV0gJiYgZGF0YVtpXS5hdHRycykgewoJCQkJCQlpZiAoZGF0YVtpXS5hdHRycy5rZXkgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJdmFyIGtleSA9IGRhdGFbaV0uYXR0cnMua2V5CgkJCQkJCQlpZiAoIWV4aXN0aW5nW2tleV0pIGV4aXN0aW5nW2tleV0gPSB7YWN0aW9uOiBJTlNFUlRJT04sIGluZGV4OiBpfQoJCQkJCQkJZWxzZSBleGlzdGluZ1trZXldID0ge2FjdGlvbjogTU9WRSwgaW5kZXg6IGksIGZyb206IGV4aXN0aW5nW2tleV0uaW5kZXgsIGVsZW1lbnQ6IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tleGlzdGluZ1trZXldLmluZGV4XX0KCQkJCQkJfQoJCQkJCQllbHNlIHVua2V5ZWQucHVzaCh7aW5kZXg6IGksIGVsZW1lbnQ6IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpXX0pCgkJCQkJfQoJCQkJfQoJCQkJdmFyIGFjdGlvbnMgPSBPYmplY3Qua2V5cyhleGlzdGluZykubWFwKGZ1bmN0aW9uKGtleSkge3JldHVybiBleGlzdGluZ1trZXldfSkKCQkJCXZhciBjaGFuZ2VzID0gYWN0aW9ucy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtyZXR1cm4gYS5hY3Rpb24gLSBiLmFjdGlvbiB8fCBhLmluZGV4IC0gYi5pbmRleH0pCgkJCQl2YXIgbmV3Q2FjaGVkID0gY2FjaGVkLnNsaWNlKCkKCQkJCQoJCQkJZm9yICh2YXIgaSA9IDAsIGNoYW5nZTsgY2hhbmdlID0gY2hhbmdlc1tpXTsgaSsrKSB7CgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gREVMRVRJT04pIHsKCQkJCQkJY2xlYXIoY2FjaGVkW2NoYW5nZS5pbmRleF0ubm9kZXMsIGNhY2hlZFtjaGFuZ2UuaW5kZXhdKQoJCQkJCQluZXdDYWNoZWQuc3BsaWNlKGNoYW5nZS5pbmRleCwgMSkKCQkJCQl9CgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gSU5TRVJUSU9OKSB7CgkJCQkJCXZhciBkdW1teSA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCQkJCQlkdW1teS5rZXkgPSBkYXRhW2NoYW5nZS5pbmRleF0uYXR0cnMua2V5CgkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGR1bW15LCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSkKCQkJCQkJbmV3Q2FjaGVkLnNwbGljZShjaGFuZ2UuaW5kZXgsIDAsIHthdHRyczoge2tleTogZGF0YVtjaGFuZ2UuaW5kZXhdLmF0dHJzLmtleX0sIG5vZGVzOiBbZHVtbXldfSkKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gTU9WRSkgewoJCQkJCQlpZiAocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0gIT09IGNoYW5nZS5lbGVtZW50ICYmIGNoYW5nZS5lbGVtZW50ICE9PSBudWxsKSB7CgkJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjaGFuZ2UuZWxlbWVudCwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJCX0KCQkJCQkJbmV3Q2FjaGVkW2NoYW5nZS5pbmRleF0gPSBjYWNoZWRbY2hhbmdlLmZyb21dCgkJCQkJfQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCB1bmtleWVkLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIGNoYW5nZSA9IHVua2V5ZWRbaV0KCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjaGFuZ2UuZWxlbWVudCwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJbmV3Q2FjaGVkW2NoYW5nZS5pbmRleF0gPSBjYWNoZWRbY2hhbmdlLmluZGV4XQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3Q2FjaGVkCgkJCQljYWNoZWQubm9kZXMgPSBbXQoJCQkJZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpXTsgaSsrKSBjYWNoZWQubm9kZXMucHVzaChjaGlsZCkKCQkJfQoJCQkvL2VuZCBrZXkgYWxnb3JpdGhtCgkJCQoJCQlmb3IgKHZhciBpID0gMCwgY2FjaGVDb3VudCA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgaXRlbSA9IGJ1aWxkKHBhcmVudEVsZW1lbnQsIHBhcmVudFRhZywgY2FjaGVkLCBpbmRleCwgZGF0YVtpXSwgY2FjaGVkW2NhY2hlQ291bnRdLCBzaG91bGRSZWF0dGFjaCwgaW5kZXggKyBzdWJBcnJheUNvdW50IHx8IHN1YkFycmF5Q291bnQsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpCgkJCQlpZiAoaXRlbSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZQoJCQkJaWYgKCFpdGVtLm5vZGVzLmludGFjdCkgaW50YWN0ID0gZmFsc2UKCQkJCXZhciBpc0FycmF5ID0gdHlwZS5jYWxsKGl0ZW0pID09ICJbb2JqZWN0IEFycmF5XSIKCQkJCXN1YkFycmF5Q291bnQgKz0gaXNBcnJheSA/IGl0ZW0ubGVuZ3RoIDogMQoJCQkJY2FjaGVkW2NhY2hlQ291bnQrK10gPSBpdGVtCgkJCX0KCQkJaWYgKCFpbnRhY3QpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChjYWNoZWRbaV0gIT09IHVuZGVmaW5lZCkgbm9kZXMgPSBub2Rlcy5jb25jYXQoY2FjaGVkW2ldLm5vZGVzKQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBjYWNoZWQubm9kZXNbaV07IGkrKykgewoJCQkJCWlmIChub2RlLnBhcmVudE5vZGUgIT09IG51bGwgJiYgbm9kZXMuaW5kZXhPZihub2RlKSA8IDApIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IGNhY2hlZC5ub2Rlcy5sZW5ndGgsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CgkJCQkJaWYgKG5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChub2RlKQoJCQkJfQoJCQkJaWYgKGRhdGEubGVuZ3RoIDwgY2FjaGVkLmxlbmd0aCkgY2FjaGVkLmxlbmd0aCA9IGRhdGEubGVuZ3RoCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJCQoJCX0KCQllbHNlIGlmIChkYXRhICE9PSB1bmRlZmluZWQgJiYgZGF0YVR5cGUgPT0gIltvYmplY3QgT2JqZWN0XSIpIHsKCQkJLy9pZiBhbiBlbGVtZW50IGlzIGRpZmZlcmVudCBlbm91Z2ggZnJvbSB0aGUgb25lIGluIGNhY2hlLCByZWNyZWF0ZSBpdAoJCQlpZiAoZGF0YS50YWcgIT0gY2FjaGVkLnRhZyB8fCBPYmplY3Qua2V5cyhkYXRhLmF0dHJzKS5qb2luKCkgIT0gT2JqZWN0LmtleXMoY2FjaGVkLmF0dHJzKS5qb2luKCkgfHwgZGF0YS5hdHRycy5pZCAhPSBjYWNoZWQuYXR0cnMuaWQpIHsKCQkJCWNsZWFyKGNhY2hlZC5ub2RlcykKCQkJCWlmIChjYWNoZWQuY29uZmlnQ29udGV4dCAmJiB0eXBlb2YgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQgPT0gImZ1bmN0aW9uIikgY2FjaGVkLmNvbmZpZ0NvbnRleHQub251bmxvYWQoKQoJCQl9CgkJCWlmICh0eXBlb2YgZGF0YS50YWcgIT0gInN0cmluZyIpIHJldHVybgoKCQkJdmFyIG5vZGUsIGlzTmV3ID0gY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMAoJCQlpZiAoZGF0YS5hdHRycy54bWxucykgbmFtZXNwYWNlID0gZGF0YS5hdHRycy54bWxucwoJCQllbHNlIGlmIChkYXRhLnRhZyA9PT0gInN2ZyIpIG5hbWVzcGFjZSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKCQkJZWxzZSBpZiAoZGF0YS50YWcgPT09ICJtYXRoIikgbmFtZXNwYWNlID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwiCgkJCWlmIChpc05ldykgewoJCQkJbm9kZSA9IG5hbWVzcGFjZSA9PT0gdW5kZWZpbmVkID8gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZGF0YS50YWcpIDogd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIGRhdGEudGFnKQoJCQkJY2FjaGVkID0gewoJCQkJCXRhZzogZGF0YS50YWcsCgkJCQkJLy9wcm9jZXNzIGNoaWxkcmVuIGJlZm9yZSBhdHRycyBzbyB0aGF0IHNlbGVjdC52YWx1ZSB3b3JrcyBjb3JyZWN0bHkKCQkJCQljaGlsZHJlbjogZGF0YS5jaGlsZHJlbiAhPT0gdW5kZWZpbmVkID8gYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIHRydWUsIDAsIGRhdGEuYXR0cnMuY29udGVudGVkaXRhYmxlID8gbm9kZSA6IGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpIDogW10sCgkJCQkJYXR0cnM6IHNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIHt9LCBuYW1lc3BhY2UpLAoJCQkJCW5vZGVzOiBbbm9kZV0KCQkJCX0KCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQllbHNlIHsKCQkJCW5vZGUgPSBjYWNoZWQubm9kZXNbMF0KCQkJCXNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIGNhY2hlZC5hdHRycywgbmFtZXNwYWNlKQoJCQkJY2FjaGVkLmNoaWxkcmVuID0gZGF0YS5jaGlsZHJlbiAhPT0gdW5kZWZpbmVkID8gYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIGZhbHNlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKSA6IFtdCgkJCQljYWNoZWQubm9kZXMuaW50YWN0ID0gdHJ1ZQoJCQkJaWYgKHNob3VsZFJlYXR0YWNoID09PSB0cnVlICYmIG5vZGUgIT09IG51bGwpIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQkvL3NjaGVkdWxlIGNvbmZpZ3MgdG8gYmUgY2FsbGVkLiBUaGV5IGFyZSBjYWxsZWQgYWZ0ZXIgYGJ1aWxkYCBmaW5pc2hlcyBydW5uaW5nCgkJCWlmICh0eXBlb2YgZGF0YS5hdHRyc1siY29uZmlnIl0gPT09ICJmdW5jdGlvbiIpIHsKCQkJCWNvbmZpZ3MucHVzaChkYXRhLmF0dHJzWyJjb25maWciXS5iaW5kKHdpbmRvdywgbm9kZSwgIWlzTmV3LCBjYWNoZWQuY29uZmlnQ29udGV4dCA9IGNhY2hlZC5jb25maWdDb250ZXh0IHx8IHt9LCBjYWNoZWQpKQoJCQl9CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBkYXRhVHlwZSAhPSAiZnVuY3Rpb24iKSB7CgkJCS8vaGFuZGxlIHRleHQgbm9kZXMKCQkJdmFyIG5vZGVzCgkJCWlmIChjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwKSB7CgkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCX0KCQkJCWVsc2UgewoJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2Rlc1swXSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQkJfQoJCQkJY2FjaGVkID0gInN0cmluZyBudW1iZXIgYm9vbGVhbiIuaW5kZXhPZih0eXBlb2YgZGF0YSkgPiAtMSA/IG5ldyBkYXRhLmNvbnN0cnVjdG9yKGRhdGEpIDogZGF0YQoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQllbHNlIGlmIChjYWNoZWQudmFsdWVPZigpICE9PSBkYXRhLnZhbHVlT2YoKSB8fCBzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSkgewoJCQkJbm9kZXMgPSBjYWNoZWQubm9kZXMKCQkJCWlmICghZWRpdGFibGUgfHwgZWRpdGFibGUgIT09IHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgkJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQkJY2xlYXIobm9kZXMsIGNhY2hlZCkKCQkJCQkJbm9kZXMgPSBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJLy9jb3JuZXIgY2FzZTogcmVwbGFjaW5nIHRoZSBub2RlVmFsdWUgb2YgYSB0ZXh0IG5vZGUgdGhhdCBpcyBhIGNoaWxkIG9mIGEgdGV4dGFyZWEvY29udGVudGVkaXRhYmxlIGRvZXNuJ3Qgd29yawoJCQkJCQlpZiAocGFyZW50VGFnID09PSAidGV4dGFyZWEiKSBwYXJlbnRFbGVtZW50LnZhbHVlID0gZGF0YQoJCQkJCQllbHNlIGlmIChlZGl0YWJsZSkgZWRpdGFibGUuaW5uZXJIVE1MID0gZGF0YQoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChub2Rlc1swXS5ub2RlVHlwZSA9PSAxIHx8IG5vZGVzLmxlbmd0aCA+IDEpIHsgLy93YXMgYSB0cnVzdGVkIHN0cmluZwoJCQkJCQkJCWNsZWFyKGNhY2hlZC5ub2RlcywgY2FjaGVkKQoJCQkJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQkJCX0KCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGVzWzBdLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCQkJCQlub2Rlc1swXS5ub2RlVmFsdWUgPSBkYXRhCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljYWNoZWQgPSBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKQoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQllbHNlIGNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJfQoKCQlyZXR1cm4gY2FjaGVkCgl9CglmdW5jdGlvbiBzZXRBdHRyaWJ1dGVzKG5vZGUsIHRhZywgZGF0YUF0dHJzLCBjYWNoZWRBdHRycywgbmFtZXNwYWNlKSB7CgkJdmFyIGdyb3VwcyA9IHt9CgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gZGF0YUF0dHJzKSB7CgkJCXZhciBkYXRhQXR0ciA9IGRhdGFBdHRyc1thdHRyTmFtZV0KCQkJdmFyIGNhY2hlZEF0dHIgPSBjYWNoZWRBdHRyc1thdHRyTmFtZV0KCQkJaWYgKCEoYXR0ck5hbWUgaW4gY2FjaGVkQXR0cnMpIHx8IChjYWNoZWRBdHRyICE9PSBkYXRhQXR0cikgfHwgbm9kZSA9PT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCWNhY2hlZEF0dHJzW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQlpZiAoYXR0ck5hbWUgPT09ICJjb25maWciKSBjb250aW51ZQoJCQkJZWxzZSBpZiAodHlwZW9mIGRhdGFBdHRyID09ICJmdW5jdGlvbiIgJiYgYXR0ck5hbWUuaW5kZXhPZigib24iKSA9PSAwKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBhdXRvcmVkcmF3KGRhdGFBdHRyLCBub2RlKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJzdHlsZSIgJiYgdHlwZW9mIGRhdGFBdHRyID09ICJvYmplY3QiKSB7CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBkYXRhQXR0cikgewoJCQkJCQlpZiAoY2FjaGVkQXR0ciA9PT0gdW5kZWZpbmVkIHx8IGNhY2hlZEF0dHJbcnVsZV0gIT09IGRhdGFBdHRyW3J1bGVdKSBub2RlLnN0eWxlW3J1bGVdID0gZGF0YUF0dHJbcnVsZV0KCQkJCQl9CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBjYWNoZWRBdHRyKSB7CgkJCQkJCWlmICghKHJ1bGUgaW4gZGF0YUF0dHIpKSBub2RlLnN0eWxlW3J1bGVdID0gIiIKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChuYW1lc3BhY2UgIT09IHVuZGVmaW5lZCkgewoJCQkJCWlmIChhdHRyTmFtZSA9PT0gImhyZWYiKSBub2RlLnNldEF0dHJpYnV0ZU5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwgImhyZWYiLCBkYXRhQXR0cikKCQkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gImNsYXNzTmFtZSIpIG5vZGUuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGRhdGFBdHRyKQoJCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJ2YWx1ZSIgJiYgdGFnID09PSAiaW5wdXQiKSB7CgkJCQkJaWYgKG5vZGUudmFsdWUgIT09IGRhdGFBdHRyKSBub2RlLnZhbHVlID0gZGF0YUF0dHIKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lIGluIG5vZGUgJiYgIShhdHRyTmFtZSA9PSAibGlzdCIgfHwgYXR0ck5hbWUgPT0gInN0eWxlIikpIHsKCQkJCQlub2RlW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQl9CgkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJfQoJCX0KCQlyZXR1cm4gY2FjaGVkQXR0cnMKCX0KCWZ1bmN0aW9uIGNsZWFyKG5vZGVzLCBjYWNoZWQpIHsKCQlmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpLS0pIHsKCQkJaWYgKG5vZGVzW2ldICYmIG5vZGVzW2ldLnBhcmVudE5vZGUpIHsKCQkJCW5vZGVzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZXNbaV0pCgkJCQljYWNoZWQgPSBbXS5jb25jYXQoY2FjaGVkKQoJCQkJaWYgKGNhY2hlZFtpXSkgdW5sb2FkKGNhY2hlZFtpXSkKCQkJfQoJCX0KCQlpZiAobm9kZXMubGVuZ3RoICE9IDApIG5vZGVzLmxlbmd0aCA9IDAKCX0KCWZ1bmN0aW9uIHVubG9hZChjYWNoZWQpIHsKCQlpZiAoY2FjaGVkLmNvbmZpZ0NvbnRleHQgJiYgdHlwZW9mIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkID09ICJmdW5jdGlvbiIpIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkKCkKCQlpZiAoY2FjaGVkLmNoaWxkcmVuKSB7CgkJCWlmICh0eXBlLmNhbGwoY2FjaGVkLmNoaWxkcmVuKSA9PSAiW29iamVjdCBBcnJheV0iKSBmb3IgKHZhciBpID0gMDsgaSA8IGNhY2hlZC5jaGlsZHJlbi5sZW5ndGg7IGkrKykgdW5sb2FkKGNhY2hlZC5jaGlsZHJlbltpXSkKCQkJZWxzZSBpZiAoY2FjaGVkLmNoaWxkcmVuLnRhZykgdW5sb2FkKGNhY2hlZC5jaGlsZHJlbikKCQl9Cgl9CglmdW5jdGlvbiBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKSB7CgkJdmFyIG5leHRTaWJsaW5nID0gcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XQoJCWlmIChuZXh0U2libGluZykgewoJCQl2YXIgaXNFbGVtZW50ID0gbmV4dFNpYmxpbmcubm9kZVR5cGUgIT0gMQoJCQl2YXIgcGxhY2Vob2xkZXIgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpCgkJCWlmIChpc0VsZW1lbnQpIHsKCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBuZXh0U2libGluZykKCQkJCXBsYWNlaG9sZGVyLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCQkJcGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChwbGFjZWhvbGRlcikKCQkJfQoJCQllbHNlIG5leHRTaWJsaW5nLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCX0KCQllbHNlIHBhcmVudEVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmVlbmQiLCBkYXRhKQoJCXZhciBub2RlcyA9IFtdCgkJd2hpbGUgKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gIT09IG5leHRTaWJsaW5nKSB7CgkJCW5vZGVzLnB1c2gocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSkKCQkJaW5kZXgrKwoJCX0KCQlyZXR1cm4gbm9kZXMKCX0KCWZ1bmN0aW9uIGZsYXR0ZW4oZGF0YSkgewoJCXZhciBmbGF0dGVuZWQgPSBbXQoJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQl2YXIgaXRlbSA9IGRhdGFbaV0KCQkJaWYgKHR5cGUuY2FsbChpdGVtKSA9PSAiW29iamVjdCBBcnJheV0iKSBmbGF0dGVuZWQucHVzaC5hcHBseShmbGF0dGVuZWQsIGZsYXR0ZW4oaXRlbSkpCgkJCWVsc2UgZmxhdHRlbmVkLnB1c2goaXRlbSkKCQl9CgkJcmV0dXJuIGZsYXR0ZW5lZAoJfQoJZnVuY3Rpb24gYXV0b3JlZHJhdyhjYWxsYmFjaywgb2JqZWN0LCBncm91cCkgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCWUgPSBlIHx8IGV2ZW50CgkJCW0ucmVkcmF3LnN0cmF0ZWd5KCJkaWZmIikKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJdHJ5IHtyZXR1cm4gY2FsbGJhY2suY2FsbChvYmplY3QsIGUpfQoJCQlmaW5hbGx5IHsKCQkJCWlmICghbGFzdFJlZHJhd0lkKSBsYXN0UmVkcmF3SWQgPSAtMTsKCQkJCW0uZW5kQ29tcHV0YXRpb24oKQoJCQl9CgkJfQoJfQoKCXZhciBodG1sCgl2YXIgZG9jdW1lbnROb2RlID0gewoJCWluc2VydEFkamFjZW50SFRNTDogZnVuY3Rpb24oXywgZGF0YSkgewoJCQl3aW5kb3cuZG9jdW1lbnQud3JpdGUoZGF0YSkKCQkJd2luZG93LmRvY3VtZW50LmNsb3NlKCkKCQl9LAoJCWFwcGVuZENoaWxkOiBmdW5jdGlvbihub2RlKSB7CgkJCWlmIChodG1sID09PSB1bmRlZmluZWQpIGh0bWwgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaHRtbCIpCgkJCWlmIChub2RlLm5vZGVOYW1lID09ICJIVE1MIikgaHRtbCA9IG5vZGUKCQkJZWxzZSBodG1sLmFwcGVuZENoaWxkKG5vZGUpCgkJCWlmICh3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgIT09IGh0bWwpIHsKCQkJCXdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQoaHRtbCwgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkKCQkJfQoJCQllbHNlIHdpbmRvdy5kb2N1bWVudC5hcHBlbmRDaGlsZChodG1sKQoJCX0sCgkJaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihub2RlKSB7CgkJCXRoaXMuYXBwZW5kQ2hpbGQobm9kZSkKCQl9LAoJCWNoaWxkTm9kZXM6IFtdCgl9Cgl2YXIgbm9kZUNhY2hlID0gW10sIGNlbGxDYWNoZSA9IHt9CgltLnJlbmRlciA9IGZ1bmN0aW9uKHJvb3QsIGNlbGwsIGZvcmNlUmVjcmVhdGlvbikgewoJCXZhciBjb25maWdzID0gW10KCQlpZiAoIXJvb3QpIHRocm93IG5ldyBFcnJvcigiUGxlYXNlIGVuc3VyZSB0aGUgRE9NIGVsZW1lbnQgZXhpc3RzIGJlZm9yZSByZW5kZXJpbmcgYSB0ZW1wbGF0ZSBpbnRvIGl0LiIpCgkJdmFyIGlkID0gZ2V0Q2VsbENhY2hlS2V5KHJvb3QpCgkJdmFyIG5vZGUgPSByb290ID09IHdpbmRvdy5kb2N1bWVudCB8fCByb290ID09IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudE5vZGUgOiByb290CgkJaWYgKGNlbGxDYWNoZVtpZF0gPT09IHVuZGVmaW5lZCkgY2xlYXIobm9kZS5jaGlsZE5vZGVzKQoJCWlmIChmb3JjZVJlY3JlYXRpb24gPT09IHRydWUpIHJlc2V0KHJvb3QpCgkJY2VsbENhY2hlW2lkXSA9IGJ1aWxkKG5vZGUsIG51bGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjZWxsLCBjZWxsQ2FjaGVbaWRdLCBmYWxzZSwgMCwgbnVsbCwgdW5kZWZpbmVkLCBjb25maWdzKQoJCWZvciAodmFyIGkgPSAwOyBpIDwgY29uZmlncy5sZW5ndGg7IGkrKykgY29uZmlnc1tpXSgpCgl9CglmdW5jdGlvbiBnZXRDZWxsQ2FjaGVLZXkoZWxlbWVudCkgewoJCXZhciBpbmRleCA9IG5vZGVDYWNoZS5pbmRleE9mKGVsZW1lbnQpCgkJcmV0dXJuIGluZGV4IDwgMCA/IG5vZGVDYWNoZS5wdXNoKGVsZW1lbnQpIC0gMSA6IGluZGV4Cgl9CgoJbS50cnVzdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJdmFsdWUgPSBuZXcgU3RyaW5nKHZhbHVlKQoJCXZhbHVlLiR0cnVzdGVkID0gdHJ1ZQoJCXJldHVybiB2YWx1ZQoJfQoKCW0ucHJvcCA9IGZ1bmN0aW9uKHN0b3JlKSB7CgkJdmFyIHByb3AgPSBmdW5jdGlvbigpIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHN0b3JlID0gYXJndW1lbnRzWzBdCgkJCXJldHVybiBzdG9yZQoJCX0KCQlwcm9wLnRvSlNPTiA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc3RvcmUKCQl9CgkJcmV0dXJuIHByb3AKCX0KCQoJdmFyIHJvb3RzID0gW10sIG1vZHVsZXMgPSBbXSwgY29udHJvbGxlcnMgPSBbXSwgbGFzdFJlZHJhd0lkID0gMCwgY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbCwgcHJldmVudGVkID0gZmFsc2UKCW0ubW9kdWxlID0gZnVuY3Rpb24ocm9vdCwgbW9kdWxlKSB7CgkJdmFyIGluZGV4ID0gcm9vdHMuaW5kZXhPZihyb290KQoJCWlmIChpbmRleCA8IDApIGluZGV4ID0gcm9vdHMubGVuZ3RoCgkJdmFyIGlzUHJldmVudGVkID0gZmFsc2UKCQlpZiAoY29udHJvbGxlcnNbaW5kZXhdICYmIHR5cGVvZiBjb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgZXZlbnQgPSB7CgkJCQlwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7aXNQcmV2ZW50ZWQgPSB0cnVlfQoJCQl9CgkJCWNvbnRyb2xsZXJzW2luZGV4XS5vbnVubG9hZChldmVudCkKCQl9CgkJaWYgKCFpc1ByZXZlbnRlZCkgewoJCQltLnJlZHJhdy5zdHJhdGVneSgiYWxsIikKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJcm9vdHNbaW5kZXhdID0gcm9vdAoJCQltb2R1bGVzW2luZGV4XSA9IG1vZHVsZQoJCQljb250cm9sbGVyc1tpbmRleF0gPSBuZXcgbW9kdWxlLmNvbnRyb2xsZXIKCQkJbS5lbmRDb21wdXRhdGlvbigpCgkJfQoJfQoJbS5yZWRyYXcgPSBmdW5jdGlvbigpIHsKCQl2YXIgY2FuY2VsID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5jbGVhclRpbWVvdXQKCQl2YXIgZGVmZXIgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5zZXRUaW1lb3V0CgkJaWYgKGxhc3RSZWRyYXdJZCkgewoJCQljYW5jZWwobGFzdFJlZHJhd0lkKQoJCQlsYXN0UmVkcmF3SWQgPSBkZWZlcihyZWRyYXcsIDApCgkJfQoJCWVsc2UgewoJCQlyZWRyYXcoKQoJCQlsYXN0UmVkcmF3SWQgPSBkZWZlcihmdW5jdGlvbigpIHtsYXN0UmVkcmF3SWQgPSBudWxsfSwgMCkKCQl9Cgl9CgltLnJlZHJhdy5zdHJhdGVneSA9IG0ucHJvcCgpCglmdW5jdGlvbiByZWRyYXcoKSB7CgkJdmFyIG1vZGUgPSBtLnJlZHJhdy5zdHJhdGVneSgpCgkJZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewoJCQlpZiAoY29udHJvbGxlcnNbaV0gJiYgbW9kZSAhPSAibm9uZSIpIG0ucmVuZGVyKHJvb3RzW2ldLCBtb2R1bGVzW2ldLnZpZXcoY29udHJvbGxlcnNbaV0pLCBtb2RlID09ICJhbGwiKQoJCX0KCQlpZiAoY29tcHV0ZVBvc3RSZWRyYXdIb29rKSB7CgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vaygpCgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwKCQl9CgkJbGFzdFJlZHJhd0lkID0gbnVsbAoJCW0ucmVkcmF3LnN0cmF0ZWd5KCJkaWZmIikKCX0KCgl2YXIgcGVuZGluZ1JlcXVlc3RzID0gMAoJbS5zdGFydENvbXB1dGF0aW9uID0gZnVuY3Rpb24oKSB7cGVuZGluZ1JlcXVlc3RzKyt9CgltLmVuZENvbXB1dGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJcGVuZGluZ1JlcXVlc3RzID0gTWF0aC5tYXgocGVuZGluZ1JlcXVlc3RzIC0gMSwgMCkKCQlpZiAocGVuZGluZ1JlcXVlc3RzID09IDApIG0ucmVkcmF3KCkKCX0KCgltLndpdGhBdHRyID0gZnVuY3Rpb24ocHJvcCwgd2l0aEF0dHJDYWxsYmFjaykgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCWUgPSBlIHx8IGV2ZW50CgkJCXZhciBjdXJyZW50VGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0IHx8IHRoaXMKCQkJd2l0aEF0dHJDYWxsYmFjayhwcm9wIGluIGN1cnJlbnRUYXJnZXQgPyBjdXJyZW50VGFyZ2V0W3Byb3BdIDogY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUocHJvcCkpCgkJfQoJfQoKCS8vcm91dGluZwoJdmFyIG1vZGVzID0ge3BhdGhuYW1lOiAiIiwgaGFzaDogIiMiLCBzZWFyY2g6ICI/In0KCXZhciByZWRpcmVjdCA9IGZ1bmN0aW9uKCkge30sIHJvdXRlUGFyYW1zID0ge30sIGN1cnJlbnRSb3V0ZQoJbS5yb3V0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gY3VycmVudFJvdXRlCgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMyAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJzdHJpbmciKSB7CgkJCXZhciByb290ID0gYXJndW1lbnRzWzBdLCBkZWZhdWx0Um91dGUgPSBhcmd1bWVudHNbMV0sIHJvdXRlciA9IGFyZ3VtZW50c1syXQoJCQlyZWRpcmVjdCA9IGZ1bmN0aW9uKHNvdXJjZSkgewoJCQkJdmFyIHBhdGggPSBjdXJyZW50Um91dGUgPSBub3JtYWxpemVSb3V0ZShzb3VyY2UpCgkJCQlpZiAoIXJvdXRlQnlWYWx1ZShyb290LCByb3V0ZXIsIHBhdGgpKSB7CgkJCQkJbS5yb3V0ZShkZWZhdWx0Um91dGUsIHRydWUpCgkJCQl9CgkJCX0KCQkJdmFyIGxpc3RlbmVyID0gbS5yb3V0ZS5tb2RlID09ICJoYXNoIiA/ICJvbmhhc2hjaGFuZ2UiIDogIm9ucG9wc3RhdGUiCgkJCXdpbmRvd1tsaXN0ZW5lcl0gPSBmdW5jdGlvbigpIHsKCQkJCWlmIChjdXJyZW50Um91dGUgIT0gbm9ybWFsaXplUm91dGUod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pKSB7CgkJCQkJcmVkaXJlY3Qod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pCgkJCQl9CgkJCX0KCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gc2V0U2Nyb2xsCgkJCXdpbmRvd1tsaXN0ZW5lcl0oKQoJCX0KCQllbHNlIGlmIChhcmd1bWVudHNbMF0uYWRkRXZlbnRMaXN0ZW5lcikgewoJCQl2YXIgZWxlbWVudCA9IGFyZ3VtZW50c1swXQoJCQl2YXIgaXNJbml0aWFsaXplZCA9IGFyZ3VtZW50c1sxXQoJCQlpZiAoZWxlbWVudC5ocmVmLmluZGV4T2YobW9kZXNbbS5yb3V0ZS5tb2RlXSkgPCAwKSB7CgkJCQllbGVtZW50LmhyZWYgPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgZWxlbWVudC5wYXRobmFtZQoJCQl9CgkJCWlmICghaXNJbml0aWFsaXplZCkgewoJCQkJZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09ICJzdHJpbmciKSB7CgkJCWN1cnJlbnRSb3V0ZSA9IGFyZ3VtZW50c1swXQoJCQl2YXIgcXVlcnlzdHJpbmcgPSB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJvYmplY3QiID8gYnVpbGRRdWVyeVN0cmluZyhhcmd1bWVudHNbMV0pIDogbnVsbAoJCQlpZiAocXVlcnlzdHJpbmcpIGN1cnJlbnRSb3V0ZSArPSAoY3VycmVudFJvdXRlLmluZGV4T2YoIj8iKSA9PT0gLTEgPyAiPyIgOiAiJiIpICsgcXVlcnlzdHJpbmcKCgkJCXZhciBzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID0gKGFyZ3VtZW50cy5sZW5ndGggPT0gMyA/IGFyZ3VtZW50c1syXSA6IGFyZ3VtZW50c1sxXSkgPT09IHRydWUKCQkJCgkJCWlmICh3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUpIHsKCQkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5oaXN0b3J5W3Nob3VsZFJlcGxhY2VIaXN0b3J5RW50cnkgPyAicmVwbGFjZVN0YXRlIiA6ICJwdXNoU3RhdGUiXShudWxsLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCQkJc2V0U2Nyb2xsKCkKCQkJCX0KCQkJCXJlZGlyZWN0KG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCX0KCQkJZWxzZSB3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSA9IGN1cnJlbnRSb3V0ZQoJCX0KCX0KCW0ucm91dGUucGFyYW0gPSBmdW5jdGlvbihrZXkpIHtyZXR1cm4gcm91dGVQYXJhbXNba2V5XX0KCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCglmdW5jdGlvbiBub3JtYWxpemVSb3V0ZShyb3V0ZSkge3JldHVybiByb3V0ZS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCl9CglmdW5jdGlvbiByb3V0ZUJ5VmFsdWUocm9vdCwgcm91dGVyLCBwYXRoKSB7CgkJcm91dGVQYXJhbXMgPSB7fQoKCQl2YXIgcXVlcnlTdGFydCA9IHBhdGguaW5kZXhPZigiPyIpCgkJaWYgKHF1ZXJ5U3RhcnQgIT09IC0xKSB7CgkJCXJvdXRlUGFyYW1zID0gcGFyc2VRdWVyeVN0cmluZyhwYXRoLnN1YnN0cihxdWVyeVN0YXJ0ICsgMSwgcGF0aC5sZW5ndGgpKQoJCQlwYXRoID0gcGF0aC5zdWJzdHIoMCwgcXVlcnlTdGFydCkKCQl9CgoJCWZvciAodmFyIHJvdXRlIGluIHJvdXRlcikgewoJCQlpZiAocm91dGUgPT0gcGF0aCkgewoJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCXJldHVybiB0cnVlCgkJCX0KCgkJCXZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cCgiXiIgKyByb3V0ZS5yZXBsYWNlKC86W15cL10rP1wuezN9L2csICIoLio/KSIpLnJlcGxhY2UoLzpbXlwvXSsvZywgIihbXlxcL10rKSIpICsgIlwvPyQiKQoKCQkJaWYgKG1hdGNoZXIudGVzdChwYXRoKSkgewoJCQkJcGF0aC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBrZXlzID0gcm91dGUubWF0Y2goLzpbXlwvXSsvZykgfHwgW10KCQkJCQl2YXIgdmFsdWVzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEsIC0yKQoJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgcm91dGVQYXJhbXNba2V5c1tpXS5yZXBsYWNlKC86fFwuL2csICIiKV0gPSBkZWNvZGVTcGFjZSh2YWx1ZXNbaV0pCgkJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCX0pCgkJCQlyZXR1cm4gdHJ1ZQoJCQl9CgkJfQoJfQoJZnVuY3Rpb24gcm91dGVVbm9idHJ1c2l2ZShlKSB7CgkJZSA9IGUgfHwgZXZlbnQKCQlpZiAoZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBlLndoaWNoID09IDIpIHJldHVybgoJCWUucHJldmVudERlZmF1bHQoKQoJCW0ucm91dGUoZS5jdXJyZW50VGFyZ2V0W20ucm91dGUubW9kZV0uc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpKQoJfQoJZnVuY3Rpb24gc2V0U2Nyb2xsKCkgewoJCWlmIChtLnJvdXRlLm1vZGUgIT0gImhhc2giICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoKSB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoCgkJZWxzZSB3aW5kb3cuc2Nyb2xsVG8oMCwgMCkKCX0KCWZ1bmN0aW9uIGJ1aWxkUXVlcnlTdHJpbmcob2JqZWN0LCBwcmVmaXgpIHsKCQl2YXIgc3RyID0gW10KCQlmb3IodmFyIHByb3AgaW4gb2JqZWN0KSB7CgkJCXZhciBrZXkgPSBwcmVmaXggPyBwcmVmaXggKyAiWyIgKyBwcm9wICsgIl0iIDogcHJvcCwgdmFsdWUgPSBvYmplY3RbcHJvcF0KCQkJc3RyLnB1c2godHlwZW9mIHZhbHVlID09ICJvYmplY3QiID8gYnVpbGRRdWVyeVN0cmluZyh2YWx1ZSwga2V5KSA6IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSkKCQl9CgkJcmV0dXJuIHN0ci5qb2luKCImIikKCX0KCWZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcoc3RyKSB7CgkJdmFyIHBhaXJzID0gc3RyLnNwbGl0KCImIiksIHBhcmFtcyA9IHt9CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwYWlycy5sZW5ndGg7IGkrKykgewoJCQl2YXIgcGFpciA9IHBhaXJzW2ldLnNwbGl0KCI9IikKCQkJcGFyYW1zW2RlY29kZVNwYWNlKHBhaXJbMF0pXSA9IHBhaXJbMV0gPyBkZWNvZGVTcGFjZShwYWlyWzFdKSA6IChwYWlyLmxlbmd0aCA9PT0gMSA/IHRydWUgOiAiIikKCQl9CgkJcmV0dXJuIHBhcmFtcwoJfQoJZnVuY3Rpb24gZGVjb2RlU3BhY2Uoc3RyaW5nKSB7CgkJcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzdHJpbmcucmVwbGFjZSgvXCsvZywgIiAiKSkKCX0KCWZ1bmN0aW9uIHJlc2V0KHJvb3QpIHsKCQl2YXIgY2FjaGVLZXkgPSBnZXRDZWxsQ2FjaGVLZXkocm9vdCkKCQljbGVhcihyb290LmNoaWxkTm9kZXMsIGNlbGxDYWNoZVtjYWNoZUtleV0pCgkJY2VsbENhY2hlW2NhY2hlS2V5XSA9IHVuZGVmaW5lZAoJfQoKCXZhciBub25lID0ge30KCW0uZGVmZXJyZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmVzb2x2ZXJzID0gW10sIHJlamVjdGVycyA9IFtdLCByZXNvbHZlZCA9IG5vbmUsIHJlamVjdGVkID0gbm9uZSwgcHJvbWlzZSA9IG0ucHJvcCgpCgkJdmFyIG9iamVjdCA9IHsKCQkJcmVzb2x2ZTogZnVuY3Rpb24odmFsdWUpIHsKCQkJCWlmIChyZXNvbHZlZCA9PT0gbm9uZSkgcHJvbWlzZShyZXNvbHZlZCA9IHZhbHVlKQoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlcnMubGVuZ3RoOyBpKyspIHJlc29sdmVyc1tpXSh2YWx1ZSkKCQkJCXJlc29sdmVycy5sZW5ndGggPSByZWplY3RlcnMubGVuZ3RoID0gMAoJCQl9LAoJCQlyZWplY3Q6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlpZiAocmVqZWN0ZWQgPT09IG5vbmUpIHJlamVjdGVkID0gdmFsdWUKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVqZWN0ZXJzLmxlbmd0aDsgaSsrKSByZWplY3RlcnNbaV0odmFsdWUpCgkJCQlyZXNvbHZlcnMubGVuZ3RoID0gcmVqZWN0ZXJzLmxlbmd0aCA9IDAKCQkJfSwKCQkJcHJvbWlzZTogcHJvbWlzZQoJCX0KCQlvYmplY3QucHJvbWlzZS5yZXNvbHZlcnMgPSByZXNvbHZlcnMKCQlvYmplY3QucHJvbWlzZS50aGVuID0gZnVuY3Rpb24oc3VjY2VzcywgZXJyb3IpIHsKCQkJdmFyIG5leHQgPSBtLmRlZmVycmVkKCkKCQkJaWYgKCFzdWNjZXNzKSBzdWNjZXNzID0gaWRlbnRpdHkKCQkJaWYgKCFlcnJvcikgZXJyb3IgPSBpZGVudGl0eQoJCQlmdW5jdGlvbiBjYWxsYmFjayhtZXRob2QsIGNhbGxiYWNrKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgcmVzdWx0ID0gY2FsbGJhY2sodmFsdWUpCgkJCQkJCWlmIChyZXN1bHQgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09ICJmdW5jdGlvbiIpIHJlc3VsdC50aGVuKG5leHRbbWV0aG9kXSwgZXJyb3IpCgkJCQkJCWVsc2UgbmV4dFttZXRob2RdKHJlc3VsdCAhPT0gdW5kZWZpbmVkID8gcmVzdWx0IDogdmFsdWUpCgkJCQkJfQoJCQkJCWNhdGNoIChlKSB7CgkJCQkJCWlmICh0eXBlLmNhbGwoZSkgPT0gIltvYmplY3QgRXJyb3JdIiAmJiBlLmNvbnN0cnVjdG9yICE9PSBFcnJvcikgdGhyb3cgZQoJCQkJCQllbHNlIG5leHQucmVqZWN0KGUpCgkJCQkJfQoJCQkJfQoJCQl9CgkJCWlmIChyZXNvbHZlZCAhPT0gbm9uZSkgY2FsbGJhY2soInJlc29sdmUiLCBzdWNjZXNzKShyZXNvbHZlZCkKCQkJZWxzZSBpZiAocmVqZWN0ZWQgIT09IG5vbmUpIGNhbGxiYWNrKCJyZWplY3QiLCBlcnJvcikocmVqZWN0ZWQpCgkJCWVsc2UgewoJCQkJcmVzb2x2ZXJzLnB1c2goY2FsbGJhY2soInJlc29sdmUiLCBzdWNjZXNzKSkKCQkJCXJlamVjdGVycy5wdXNoKGNhbGxiYWNrKCJyZWplY3QiLCBlcnJvcikpCgkJCX0KCQkJcmV0dXJuIG5leHQucHJvbWlzZQoJCX0KCQlyZXR1cm4gb2JqZWN0Cgl9CgltLnN5bmMgPSBmdW5jdGlvbihhcmdzKSB7CgkJdmFyIG1ldGhvZCA9ICJyZXNvbHZlIgoJCWZ1bmN0aW9uIHN5bmNocm9uaXplcihwb3MsIHJlc29sdmVkKSB7CgkJCXJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJcmVzdWx0c1twb3NdID0gdmFsdWUKCQkJCWlmICghcmVzb2x2ZWQpIG1ldGhvZCA9ICJyZWplY3QiCgkJCQlpZiAoLS1vdXRzdGFuZGluZyA9PSAwKSB7CgkJCQkJZGVmZXJyZWQucHJvbWlzZShyZXN1bHRzKQoJCQkJCWRlZmVycmVkW21ldGhvZF0ocmVzdWx0cykKCQkJCX0KCQkJCXJldHVybiB2YWx1ZQoJCQl9CgkJfQoKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQl2YXIgb3V0c3RhbmRpbmcgPSBhcmdzLmxlbmd0aAoJCXZhciByZXN1bHRzID0gbmV3IEFycmF5KG91dHN0YW5kaW5nKQoJCWlmIChhcmdzLmxlbmd0aCA+IDApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCQlhcmdzW2ldLnRoZW4oc3luY2hyb25pemVyKGksIHRydWUpLCBzeW5jaHJvbml6ZXIoaSwgZmFsc2UpKQoJCQl9CgkJfQoJCWVsc2UgZGVmZXJyZWQucmVzb2x2ZSgpCgkJCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCWZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7cmV0dXJuIHZhbHVlfQoKCWZ1bmN0aW9uIGFqYXgob3B0aW9ucykgewoJCXZhciB4aHIgPSBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0CgkJeGhyLm9wZW4ob3B0aW9ucy5tZXRob2QsIG9wdGlvbnMudXJsLCB0cnVlLCBvcHRpb25zLnVzZXIsIG9wdGlvbnMucGFzc3dvcmQpCgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKCQkJCWlmICh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSBvcHRpb25zLm9ubG9hZCh7dHlwZTogImxvYWQiLCB0YXJnZXQ6IHhocn0pCgkJCQllbHNlIG9wdGlvbnMub25lcnJvcih7dHlwZTogImVycm9yIiwgdGFyZ2V0OiB4aHJ9KQoJCQl9CgkJfQoJCWlmIChvcHRpb25zLnNlcmlhbGl6ZSA9PSBKU09OLnN0cmluZ2lmeSAmJiBvcHRpb25zLm1ldGhvZCAhPSAiR0VUIikgewoJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiKTsKCQl9CgkJaWYgKHR5cGVvZiBvcHRpb25zLmNvbmZpZyA9PSAiZnVuY3Rpb24iKSB7CgkJCXZhciBtYXliZVhociA9IG9wdGlvbnMuY29uZmlnKHhociwgb3B0aW9ucykKCQkJaWYgKG1heWJlWGhyICE9PSB1bmRlZmluZWQpIHhociA9IG1heWJlWGhyCgkJfQoJCXhoci5zZW5kKG9wdGlvbnMubWV0aG9kID09ICJHRVQiID8gIiIgOiBvcHRpb25zLmRhdGEpCgkJcmV0dXJuIHhocgoJfQoJZnVuY3Rpb24gYmluZERhdGEoeGhyT3B0aW9ucywgZGF0YSwgc2VyaWFsaXplKSB7CgkJaWYgKGRhdGEgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMCkgewoJCQlpZiAoeGhyT3B0aW9ucy5tZXRob2QgPT0gIkdFVCIpIHsKCQkJCXhock9wdGlvbnMudXJsID0geGhyT3B0aW9ucy51cmwgKyAoeGhyT3B0aW9ucy51cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyBidWlsZFF1ZXJ5U3RyaW5nKGRhdGEpCgkJCX0KCQkJZWxzZSB4aHJPcHRpb25zLmRhdGEgPSBzZXJpYWxpemUoZGF0YSkKCQl9CgkJcmV0dXJuIHhock9wdGlvbnMKCX0KCWZ1bmN0aW9uIHBhcmFtZXRlcml6ZVVybCh1cmwsIGRhdGEpIHsKCQl2YXIgdG9rZW5zID0gdXJsLm1hdGNoKC86W2Etel1cdysvZ2kpCgkJaWYgKHRva2VucyAmJiBkYXRhKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIga2V5ID0gdG9rZW5zW2ldLnNsaWNlKDEpCgkJCQl1cmwgPSB1cmwucmVwbGFjZSh0b2tlbnNbaV0sIGRhdGFba2V5XSkKCQkJCWRlbGV0ZSBkYXRhW2tleV0KCQkJfQoJCX0KCQlyZXR1cm4gdXJsCgl9CgoJbS5yZXF1ZXN0ID0gZnVuY3Rpb24oeGhyT3B0aW9ucykgewoJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uc3RhcnRDb21wdXRhdGlvbigpCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIHNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplID0geGhyT3B0aW9ucy5zZXJpYWxpemUgfHwgSlNPTi5zdHJpbmdpZnkKCQl2YXIgZGVzZXJpYWxpemUgPSB4aHJPcHRpb25zLmRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSB8fCBKU09OLnBhcnNlCgkJdmFyIGV4dHJhY3QgPSB4aHJPcHRpb25zLmV4dHJhY3QgfHwgZnVuY3Rpb24oeGhyKSB7CgkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0Lmxlbmd0aCA9PT0gMCAmJiBkZXNlcmlhbGl6ZSA9PT0gSlNPTi5wYXJzZSA/IG51bGwgOiB4aHIucmVzcG9uc2VUZXh0CgkJfQoJCXhock9wdGlvbnMudXJsID0gcGFyYW1ldGVyaXplVXJsKHhock9wdGlvbnMudXJsLCB4aHJPcHRpb25zLmRhdGEpCgkJeGhyT3B0aW9ucyA9IGJpbmREYXRhKHhock9wdGlvbnMsIHhock9wdGlvbnMuZGF0YSwgc2VyaWFsaXplKQoJCXhock9wdGlvbnMub25sb2FkID0geGhyT3B0aW9ucy5vbmVycm9yID0gZnVuY3Rpb24oZSkgewoJCQl0cnkgewoJCQkJZSA9IGUgfHwgZXZlbnQKCQkJCXZhciB1bndyYXAgPSAoZS50eXBlID09ICJsb2FkIiA/IHhock9wdGlvbnMudW53cmFwU3VjY2VzcyA6IHhock9wdGlvbnMudW53cmFwRXJyb3IpIHx8IGlkZW50aXR5CgkJCQl2YXIgcmVzcG9uc2UgPSB1bndyYXAoZGVzZXJpYWxpemUoZXh0cmFjdChlLnRhcmdldCwgeGhyT3B0aW9ucykpKQoJCQkJaWYgKGUudHlwZSA9PSAibG9hZCIpIHsKCQkJCQlpZiAodHlwZS5jYWxsKHJlc3BvbnNlKSA9PSAiW29iamVjdCBBcnJheV0iICYmIHhock9wdGlvbnMudHlwZSkgewoJCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNlLmxlbmd0aDsgaSsrKSByZXNwb25zZVtpXSA9IG5ldyB4aHJPcHRpb25zLnR5cGUocmVzcG9uc2VbaV0pCgkJCQkJfQoJCQkJCWVsc2UgaWYgKHhock9wdGlvbnMudHlwZSkgcmVzcG9uc2UgPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlKQoJCQkJfQoJCQkJZGVmZXJyZWRbZS50eXBlID09ICJsb2FkIiA/ICJyZXNvbHZlIiA6ICJyZWplY3QiXShyZXNwb25zZSkKCQkJfQoJCQljYXRjaCAoZSkgewoJCQkJaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikgdGhyb3cgbmV3IFN5bnRheEVycm9yKCJDb3VsZCBub3QgcGFyc2UgSFRUUCByZXNwb25zZS4gU2VlIGh0dHA6Ly9saG9yaWUuZ2l0aHViLmlvL21pdGhyaWwvbWl0aHJpbC5yZXF1ZXN0Lmh0bWwjdXNpbmctdmFyaWFibGUtZGF0YS1mb3JtYXRzIikKCQkJCWVsc2UgaWYgKHR5cGUuY2FsbChlKSA9PSAiW29iamVjdCBFcnJvcl0iICYmIGUuY29uc3RydWN0b3IgIT09IEVycm9yKSB0aHJvdyBlCgkJCQllbHNlIGRlZmVycmVkLnJlamVjdChlKQoJCQl9CgkJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uZW5kQ29tcHV0YXRpb24oKQoJCX0KCQlhamF4KHhock9wdGlvbnMpCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCgkvL3Rlc3RpbmcgQVBJCgltLmRlcHMgPSBmdW5jdGlvbihtb2NrKSB7cmV0dXJuIHdpbmRvdyA9IG1vY2t9CgkvL2ZvciBpbnRlcm5hbCB0ZXN0aW5nIG9ubHksIGRvIG5vdCB1c2UgYG0uZGVwcy5mYWN0b3J5YAoJbS5kZXBzLmZhY3RvcnkgPSBhcHAKCglyZXR1cm4gbQp9KHR5cGVvZiB3aW5kb3cgIT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKCmlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZSAhPT0gbnVsbCkgbW9kdWxlLmV4cG9ydHMgPSBtCmlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKGZ1bmN0aW9uKCkge3JldHVybiBtfSkKCjs7Owo=",
                "body": "TWl0aHJpbCA9IG0gPSBuZXcgZnVuY3Rpb24gYXBwKHdpbmRvdywgdW5kZWZpbmVkKSB7Cgl2YXIgdHlwZSA9IHt9LnRvU3RyaW5nCgl2YXIgcGFyc2VyID0gLyg/OihefCN8XC4pKFteI1wuXFtcXV0rKSl8KFxbLis/XF0pL2csIGF0dHJQYXJzZXIgPSAvXFsoLis/KSg/Oj0oInwnfCkoLio/KVwyKT9cXS8KCQoJZnVuY3Rpb24gbSgpIHsKCQl2YXIgYXJncyA9IGFyZ3VtZW50cwoJCXZhciBoYXNBdHRycyA9IGFyZ3NbMV0gIT09IHVuZGVmaW5lZCAmJiB0eXBlLmNhbGwoYXJnc1sxXSkgPT0gIltvYmplY3QgT2JqZWN0XSIgJiYgISgidGFnIiBpbiBhcmdzWzFdKSAmJiAhKCJzdWJ0cmVlIiBpbiBhcmdzWzFdKQoJCXZhciBhdHRycyA9IGhhc0F0dHJzID8gYXJnc1sxXSA6IHt9CgkJdmFyIGNsYXNzQXR0ck5hbWUgPSAiY2xhc3MiIGluIGF0dHJzID8gImNsYXNzIiA6ICJjbGFzc05hbWUiCgkJdmFyIGNlbGwgPSB7dGFnOiAiZGl2IiwgYXR0cnM6IHt9fQoJCXZhciBtYXRjaCwgY2xhc3NlcyA9IFtdCgkJd2hpbGUgKG1hdGNoID0gcGFyc2VyLmV4ZWMoYXJnc1swXSkpIHsKCQkJaWYgKG1hdGNoWzFdID09ICIiKSBjZWxsLnRhZyA9IG1hdGNoWzJdCgkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIjIikgY2VsbC5hdHRycy5pZCA9IG1hdGNoWzJdCgkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIuIikgY2xhc3Nlcy5wdXNoKG1hdGNoWzJdKQoJCQllbHNlIGlmIChtYXRjaFszXVswXSA9PSAiWyIpIHsKCQkJCXZhciBwYWlyID0gYXR0clBhcnNlci5leGVjKG1hdGNoWzNdKQoJCQkJY2VsbC5hdHRyc1twYWlyWzFdXSA9IHBhaXJbM10gfHwgKHBhaXJbMl0gPyAiIiA6dHJ1ZSkKCQkJfQoJCX0KCQlpZiAoY2xhc3Nlcy5sZW5ndGggPiAwKSBjZWxsLmF0dHJzW2NsYXNzQXR0ck5hbWVdID0gY2xhc3Nlcy5qb2luKCIgIikKCQkKCQljZWxsLmNoaWxkcmVuID0gaGFzQXR0cnMgPyBhcmdzWzJdIDogYXJnc1sxXQoJCQoJCWZvciAodmFyIGF0dHJOYW1lIGluIGF0dHJzKSB7CgkJCWlmIChhdHRyTmFtZSA9PSBjbGFzc0F0dHJOYW1lKSBjZWxsLmF0dHJzW2F0dHJOYW1lXSA9IChjZWxsLmF0dHJzW2F0dHJOYW1lXSB8fCAiIikgKyAiICIgKyBhdHRyc1thdHRyTmFtZV0KCQkJZWxzZSBjZWxsLmF0dHJzW2F0dHJOYW1lXSA9IGF0dHJzW2F0dHJOYW1lXQoJCX0KCQlyZXR1cm4gY2VsbAoJfQoJZnVuY3Rpb24gYnVpbGQocGFyZW50RWxlbWVudCwgcGFyZW50VGFnLCBwYXJlbnRDYWNoZSwgcGFyZW50SW5kZXgsIGRhdGEsIGNhY2hlZCwgc2hvdWxkUmVhdHRhY2gsIGluZGV4LCBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKSB7CgkJLy9gYnVpbGRgIGlzIGEgcmVjdXJzaXZlIGZ1bmN0aW9uIHRoYXQgbWFuYWdlcyBjcmVhdGlvbi9kaWZmaW5nL3JlbW92YWwgb2YgRE9NIGVsZW1lbnRzIGJhc2VkIG9uIGNvbXBhcmlzb24gYmV0d2VlbiBgZGF0YWAgYW5kIGBjYWNoZWRgCgoJCS8vYHBhcmVudEVsZW1lbnRgIGlzIGEgRE9NIGVsZW1lbnQgdXNlZCBmb3IgVzNDIERPTSBBUEkgY2FsbHMKCQkvL2BwYXJlbnRUYWdgIGlzIG9ubHkgdXNlZCBmb3IgaGFuZGxpbmcgYSBjb3JuZXIgY2FzZSBmb3IgdGV4dGFyZWEgdmFsdWVzCgkJLy9gcGFyZW50Q2FjaGVgIGlzIHVzZWQgdG8gcmVtb3ZlIG5vZGVzIGluIHNvbWUgbXVsdGktbm9kZSBjYXNlcwoJCS8vYHBhcmVudEluZGV4YCBhbmQgYGluZGV4YCBhcmUgdXNlZCB0byBmaWd1cmUgb3V0IHRoZSBvZmZzZXQgb2Ygbm9kZXMuIFRoZXkncmUgYXJ0aWZhY3RzIGZyb20gYmVmb3JlIGFycmF5cyBzdGFydGVkIGJlaW5nIGZsYXR0ZW5lZCBhbmQgYXJlIGxpa2VseSByZWZhY3RvcmFibGUKCQkvL2BkYXRhYCBhbmQgYGNhY2hlZGAgYXJlLCByZXNwZWN0aXZlbHksIHRoZSBuZXcgYW5kIG9sZCBub2RlcyBiZWluZyBkaWZmZWQKCQkvL2BzaG91bGRSZWF0dGFjaGAgaXMgYSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBhIHBhcmVudCBub2RlIHdhcyByZWNyZWF0ZWQgKGlmIHNvLCBhbmQgaWYgdGhpcyBub2RlIGlzIHJldXNlZCwgdGhlbiB0aGlzIG5vZGUgbXVzdCByZWF0dGFjaCBpdHNlbGYgdG8gdGhlIG5ldyBwYXJlbnQpCgkJLy9gZWRpdGFibGVgIGlzIGEgZmxhZyB0aGF0IGluZGljYXRlcyB3aGV0aGVyIGFuIGFuY2VzdG9yIGlzIGNvbnRlbnRlZGl0YWJsZQoJCS8vYG5hbWVzcGFjZWAgaW5kaWNhdGVzIHRoZSBjbG9zZXN0IEhUTUwgbmFtZXNwYWNlIGFzIGl0IGNhc2NhZGVzIGRvd24gZnJvbSBhbiBhbmNlc3RvcgoJCS8vYGNvbmZpZ3NgIGlzIGEgbGlzdCBvZiBjb25maWcgZnVuY3Rpb25zIHRvIHJ1biBhZnRlciB0aGUgdG9wbW9zdCBgYnVpbGRgIGNhbGwgZmluaXNoZXMgcnVubmluZwoJCQoJCS8vdGhlcmUncyBsb2dpYyB0aGF0IHJlbGllcyBvbiB0aGUgYXNzdW1wdGlvbiB0aGF0IG51bGwgYW5kIHVuZGVmaW5lZCBkYXRhIGFyZSBlcXVpdmFsZW50IHRvIGVtcHR5IHN0cmluZ3MKCQkvLy0gdGhpcyBwcmV2ZW50cyBsaWZlY3ljbGUgc3VycHJpc2VzIGZyb20gcHJvY2VkdXJhbCBoZWxwZXJzIHRoYXQgbWl4IGltcGxpY2l0IGFuZCBleHBsaWNpdCByZXR1cm4gc3RhdGVtZW50cwoJCS8vLSBpdCBzaW1wbGlmaWVzIGRpZmZpbmcgY29kZQoJCWlmIChkYXRhID09PSB1bmRlZmluZWQgfHwgZGF0YSA9PT0gbnVsbCkgZGF0YSA9ICIiCgkJaWYgKGRhdGEuc3VidHJlZSA9PT0gInJldGFpbiIpIHJldHVybiBjYWNoZWQKCgkJdmFyIGNhY2hlZFR5cGUgPSB0eXBlLmNhbGwoY2FjaGVkKSwgZGF0YVR5cGUgPSB0eXBlLmNhbGwoZGF0YSkKCQlpZiAoY2FjaGVkID09PSB1bmRlZmluZWQgfHwgY2FjaGVkID09PSBudWxsIHx8IGNhY2hlZFR5cGUgIT0gZGF0YVR5cGUpIHsKCQkJaWYgKGNhY2hlZCAhPT0gbnVsbCAmJiBjYWNoZWQgIT09IHVuZGVmaW5lZCkgewoJCQkJaWYgKHBhcmVudENhY2hlICYmIHBhcmVudENhY2hlLm5vZGVzKSB7CgkJCQkJdmFyIG9mZnNldCA9IGluZGV4IC0gcGFyZW50SW5kZXgKCQkJCQl2YXIgZW5kID0gb2Zmc2V0ICsgKGRhdGFUeXBlID09ICJbb2JqZWN0IEFycmF5XSIgPyBkYXRhIDogY2FjaGVkLm5vZGVzKS5sZW5ndGgKCQkJCQljbGVhcihwYXJlbnRDYWNoZS5ub2Rlcy5zbGljZShvZmZzZXQsIGVuZCksIHBhcmVudENhY2hlLnNsaWNlKG9mZnNldCwgZW5kKSkKCQkJCX0KCQkJCWVsc2UgaWYgKGNhY2hlZC5ub2RlcykgY2xlYXIoY2FjaGVkLm5vZGVzLCBjYWNoZWQpCgkJCX0KCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IKCQkJY2FjaGVkLm5vZGVzID0gW10KCQl9CgoJCWlmIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iKSB7CgkJCWRhdGEgPSBmbGF0dGVuKGRhdGEpCgkJCXZhciBub2RlcyA9IFtdLCBpbnRhY3QgPSBjYWNoZWQubGVuZ3RoID09PSBkYXRhLmxlbmd0aCwgc3ViQXJyYXlDb3VudCA9IDAKCQkJCgkJCS8va2V5IGFsZ29yaXRobTogc29ydCBlbGVtZW50cyB3aXRob3V0IHJlY3JlYXRpbmcgdGhlbSBpZiBrZXlzIGFyZSBwcmVzZW50CgkJCS8vMSkgY3JlYXRlIGEgbWFwIG9mIGFsbCBleGlzdGluZyBrZXlzLCBhbmQgbWFyayBhbGwgZm9yIGRlbGV0aW9uCgkJCS8vMikgYWRkIG5ldyBrZXlzIHRvIG1hcCBhbmQgbWFyayB0aGVtIGZvciBhZGRpdGlvbgoJCQkvLzMpIGlmIGtleSBleGlzdHMgaW4gbmV3IGxpc3QsIGNoYW5nZSBhY3Rpb24gZnJvbSBkZWxldGlvbiB0byBhIG1vdmUKCQkJLy80KSBmb3IgZWFjaCBrZXksIGhhbmRsZSBpdHMgY29ycmVzcG9uZGluZyBhY3Rpb24gYXMgbWFya2VkIGluIHByZXZpb3VzIHN0ZXBzCgkJCS8vNSkgY29weSB1bmtleWVkIGl0ZW1zIGludG8gdGhlaXIgcmVzcGVjdGl2ZSBnYXBzCgkJCXZhciBERUxFVElPTiA9IDEsIElOU0VSVElPTiA9IDIgLCBNT1ZFID0gMwoJCQl2YXIgZXhpc3RpbmcgPSB7fSwgdW5rZXllZCA9IFtdLCBzaG91bGRNYWludGFpbklkZW50aXRpZXMgPSBmYWxzZQoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNhY2hlZC5sZW5ndGg7IGkrKykgewoJCQkJaWYgKGNhY2hlZFtpXSAmJiBjYWNoZWRbaV0uYXR0cnMgJiYgY2FjaGVkW2ldLmF0dHJzLmtleSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJc2hvdWxkTWFpbnRhaW5JZGVudGl0aWVzID0gdHJ1ZQoJCQkJCWV4aXN0aW5nW2NhY2hlZFtpXS5hdHRycy5rZXldID0ge2FjdGlvbjogREVMRVRJT04sIGluZGV4OiBpfQoJCQkJfQoJCQl9CgkJCWlmIChzaG91bGRNYWludGFpbklkZW50aXRpZXMpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChkYXRhW2ldICYmIGRhdGFbaV0uYXR0cnMpIHsKCQkJCQkJaWYgKGRhdGFbaV0uYXR0cnMua2V5ICE9PSB1bmRlZmluZWQpIHsKCQkJCQkJCXZhciBrZXkgPSBkYXRhW2ldLmF0dHJzLmtleQoJCQkJCQkJaWYgKCFleGlzdGluZ1trZXldKSBleGlzdGluZ1trZXldID0ge2FjdGlvbjogSU5TRVJUSU9OLCBpbmRleDogaX0KCQkJCQkJCWVsc2UgZXhpc3Rpbmdba2V5XSA9IHthY3Rpb246IE1PVkUsIGluZGV4OiBpLCBmcm9tOiBleGlzdGluZ1trZXldLmluZGV4LCBlbGVtZW50OiBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbZXhpc3Rpbmdba2V5XS5pbmRleF19CgkJCQkJCX0KCQkJCQkJZWxzZSB1bmtleWVkLnB1c2goe2luZGV4OiBpLCBlbGVtZW50OiBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaV19KQoJCQkJCX0KCQkJCX0KCQkJCXZhciBhY3Rpb25zID0gT2JqZWN0LmtleXMoZXhpc3RpbmcpLm1hcChmdW5jdGlvbihrZXkpIHtyZXR1cm4gZXhpc3Rpbmdba2V5XX0pCgkJCQl2YXIgY2hhbmdlcyA9IGFjdGlvbnMuc29ydChmdW5jdGlvbihhLCBiKSB7cmV0dXJuIGEuYWN0aW9uIC0gYi5hY3Rpb24gfHwgYS5pbmRleCAtIGIuaW5kZXh9KQoJCQkJdmFyIG5ld0NhY2hlZCA9IGNhY2hlZC5zbGljZSgpCgkJCQkKCQkJCWZvciAodmFyIGkgPSAwLCBjaGFuZ2U7IGNoYW5nZSA9IGNoYW5nZXNbaV07IGkrKykgewoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IERFTEVUSU9OKSB7CgkJCQkJCWNsZWFyKGNhY2hlZFtjaGFuZ2UuaW5kZXhdLm5vZGVzLCBjYWNoZWRbY2hhbmdlLmluZGV4XSkKCQkJCQkJbmV3Q2FjaGVkLnNwbGljZShjaGFuZ2UuaW5kZXgsIDEpCgkJCQkJfQoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IElOU0VSVElPTikgewoJCQkJCQl2YXIgZHVtbXkgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQkJCQkJZHVtbXkua2V5ID0gZGF0YVtjaGFuZ2UuaW5kZXhdLmF0dHJzLmtleQoJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShkdW1teSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJCW5ld0NhY2hlZC5zcGxpY2UoY2hhbmdlLmluZGV4LCAwLCB7YXR0cnM6IHtrZXk6IGRhdGFbY2hhbmdlLmluZGV4XS5hdHRycy5rZXl9LCBub2RlczogW2R1bW15XX0pCgkJCQkJfQoJCQkJCQoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IE1PVkUpIHsKCQkJCQkJaWYgKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tjaGFuZ2UuaW5kZXhdICE9PSBjaGFuZ2UuZWxlbWVudCAmJiBjaGFuZ2UuZWxlbWVudCAhPT0gbnVsbCkgewoJCQkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoY2hhbmdlLmVsZW1lbnQsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tjaGFuZ2UuaW5kZXhdKQoJCQkJCQl9CgkJCQkJCW5ld0NhY2hlZFtjaGFuZ2UuaW5kZXhdID0gY2FjaGVkW2NoYW5nZS5mcm9tXQoJCQkJCX0KCQkJCX0KCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgdW5rZXllZC5sZW5ndGg7IGkrKykgewoJCQkJCXZhciBjaGFuZ2UgPSB1bmtleWVkW2ldCgkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoY2hhbmdlLmVsZW1lbnQsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tjaGFuZ2UuaW5kZXhdKQoJCQkJCW5ld0NhY2hlZFtjaGFuZ2UuaW5kZXhdID0gY2FjaGVkW2NoYW5nZS5pbmRleF0KCQkJCX0KCQkJCWNhY2hlZCA9IG5ld0NhY2hlZAoJCQkJY2FjaGVkLm5vZGVzID0gW10KCQkJCWZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaV07IGkrKykgY2FjaGVkLm5vZGVzLnB1c2goY2hpbGQpCgkJCX0KCQkJLy9lbmQga2V5IGFsZ29yaXRobQoJCQkKCQkJZm9yICh2YXIgaSA9IDAsIGNhY2hlQ291bnQgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGl0ZW0gPSBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIGNhY2hlZCwgaW5kZXgsIGRhdGFbaV0sIGNhY2hlZFtjYWNoZUNvdW50XSwgc2hvdWxkUmVhdHRhY2gsIGluZGV4ICsgc3ViQXJyYXlDb3VudCB8fCBzdWJBcnJheUNvdW50LCBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKQoJCQkJaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCQkJCWlmICghaXRlbS5ub2Rlcy5pbnRhY3QpIGludGFjdCA9IGZhbHNlCgkJCQl2YXIgaXNBcnJheSA9IHR5cGUuY2FsbChpdGVtKSA9PSAiW29iamVjdCBBcnJheV0iCgkJCQlzdWJBcnJheUNvdW50ICs9IGlzQXJyYXkgPyBpdGVtLmxlbmd0aCA6IDEKCQkJCWNhY2hlZFtjYWNoZUNvdW50KytdID0gaXRlbQoJCQl9CgkJCWlmICghaW50YWN0KSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKCQkJCQlpZiAoY2FjaGVkW2ldICE9PSB1bmRlZmluZWQpIG5vZGVzID0gbm9kZXMuY29uY2F0KGNhY2hlZFtpXS5ub2RlcykKCQkJCX0KCQkJCWZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gY2FjaGVkLm5vZGVzW2ldOyBpKyspIHsKCQkJCQlpZiAobm9kZS5wYXJlbnROb2RlICE9PSBudWxsICYmIG5vZGVzLmluZGV4T2Yobm9kZSkgPCAwKSBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSkKCQkJCX0KCQkJCWZvciAodmFyIGkgPSBjYWNoZWQubm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewoJCQkJCWlmIChub2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQobm9kZSkKCQkJCX0KCQkJCWlmIChkYXRhLmxlbmd0aCA8IGNhY2hlZC5sZW5ndGgpIGNhY2hlZC5sZW5ndGggPSBkYXRhLmxlbmd0aAoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQkKCQl9CgkJZWxzZSBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkICYmIGRhdGFUeXBlID09ICJbb2JqZWN0IE9iamVjdF0iKSB7CgkJCS8vaWYgYW4gZWxlbWVudCBpcyBkaWZmZXJlbnQgZW5vdWdoIGZyb20gdGhlIG9uZSBpbiBjYWNoZSwgcmVjcmVhdGUgaXQKCQkJaWYgKGRhdGEudGFnICE9IGNhY2hlZC50YWcgfHwgT2JqZWN0LmtleXMoZGF0YS5hdHRycykuam9pbigpICE9IE9iamVjdC5rZXlzKGNhY2hlZC5hdHRycykuam9pbigpIHx8IGRhdGEuYXR0cnMuaWQgIT0gY2FjaGVkLmF0dHJzLmlkKSB7CgkJCQljbGVhcihjYWNoZWQubm9kZXMpCgkJCQlpZiAoY2FjaGVkLmNvbmZpZ0NvbnRleHQgJiYgdHlwZW9mIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkID09ICJmdW5jdGlvbiIpIGNhY2hlZC5jb25maWdDb250ZXh0Lm9udW5sb2FkKCkKCQkJfQoJCQlpZiAodHlwZW9mIGRhdGEudGFnICE9ICJzdHJpbmciKSByZXR1cm4KCgkJCXZhciBub2RlLCBpc05ldyA9IGNhY2hlZC5ub2Rlcy5sZW5ndGggPT09IDAKCQkJaWYgKGRhdGEuYXR0cnMueG1sbnMpIG5hbWVzcGFjZSA9IGRhdGEuYXR0cnMueG1sbnMKCQkJZWxzZSBpZiAoZGF0YS50YWcgPT09ICJzdmciKSBuYW1lc3BhY2UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCgkJCWVsc2UgaWYgKGRhdGEudGFnID09PSAibWF0aCIpIG5hbWVzcGFjZSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIgoJCQlpZiAoaXNOZXcpIHsKCQkJCW5vZGUgPSBuYW1lc3BhY2UgPT09IHVuZGVmaW5lZCA/IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KGRhdGEudGFnKSA6IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCBkYXRhLnRhZykKCQkJCWNhY2hlZCA9IHsKCQkJCQl0YWc6IGRhdGEudGFnLAoJCQkJCS8vcHJvY2VzcyBjaGlsZHJlbiBiZWZvcmUgYXR0cnMgc28gdGhhdCBzZWxlY3QudmFsdWUgd29ya3MgY29ycmVjdGx5CgkJCQkJY2hpbGRyZW46IGRhdGEuY2hpbGRyZW4gIT09IHVuZGVmaW5lZCA/IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCB0cnVlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKSA6IFtdLAoJCQkJCWF0dHJzOiBzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCB7fSwgbmFtZXNwYWNlKSwKCQkJCQlub2RlczogW25vZGVdCgkJCQl9CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJZWxzZSB7CgkJCQlub2RlID0gY2FjaGVkLm5vZGVzWzBdCgkJCQlzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCBjYWNoZWQuYXR0cnMsIG5hbWVzcGFjZSkKCQkJCWNhY2hlZC5jaGlsZHJlbiA9IGRhdGEuY2hpbGRyZW4gIT09IHVuZGVmaW5lZCA/IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCBmYWxzZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSwgY29uZmlncykgOiBbXQoJCQkJY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQkJCWlmIChzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSAmJiBub2RlICE9PSBudWxsKSBwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJLy9zY2hlZHVsZSBjb25maWdzIHRvIGJlIGNhbGxlZC4gVGhleSBhcmUgY2FsbGVkIGFmdGVyIGBidWlsZGAgZmluaXNoZXMgcnVubmluZwoJCQlpZiAodHlwZW9mIGRhdGEuYXR0cnNbImNvbmZpZyJdID09PSAiZnVuY3Rpb24iKSB7CgkJCQljb25maWdzLnB1c2goZGF0YS5hdHRyc1siY29uZmlnIl0uYmluZCh3aW5kb3csIG5vZGUsICFpc05ldywgY2FjaGVkLmNvbmZpZ0NvbnRleHQgPSBjYWNoZWQuY29uZmlnQ29udGV4dCB8fCB7fSwgY2FjaGVkKSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgZGF0YVR5cGUgIT0gImZ1bmN0aW9uIikgewoJCQkvL2hhbmRsZSB0ZXh0IG5vZGVzCgkJCXZhciBub2RlcwoJCQlpZiAoY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMCkgewoJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQlub2RlcyA9IGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpCgkJCQl9CgkJCQllbHNlIHsKCQkJCQlub2RlcyA9IFt3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSldCgkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZXNbMF0sIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCX0KCQkJCWNhY2hlZCA9ICJzdHJpbmcgbnVtYmVyIGJvb2xlYW4iLmluZGV4T2YodHlwZW9mIGRhdGEpID4gLTEgPyBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKSA6IGRhdGEKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQkJZWxzZSBpZiAoY2FjaGVkLnZhbHVlT2YoKSAhPT0gZGF0YS52YWx1ZU9mKCkgfHwgc2hvdWxkUmVhdHRhY2ggPT09IHRydWUpIHsKCQkJCW5vZGVzID0gY2FjaGVkLm5vZGVzCgkJCQlpZiAoIWVkaXRhYmxlIHx8IGVkaXRhYmxlICE9PSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewoJCQkJCWlmIChkYXRhLiR0cnVzdGVkKSB7CgkJCQkJCWNsZWFyKG5vZGVzLCBjYWNoZWQpCgkJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCS8vY29ybmVyIGNhc2U6IHJlcGxhY2luZyB0aGUgbm9kZVZhbHVlIG9mIGEgdGV4dCBub2RlIHRoYXQgaXMgYSBjaGlsZCBvZiBhIHRleHRhcmVhL2NvbnRlbnRlZGl0YWJsZSBkb2Vzbid0IHdvcmsKCQkJCQkJaWYgKHBhcmVudFRhZyA9PT0gInRleHRhcmVhIikgcGFyZW50RWxlbWVudC52YWx1ZSA9IGRhdGEKCQkJCQkJZWxzZSBpZiAoZWRpdGFibGUpIGVkaXRhYmxlLmlubmVySFRNTCA9IGRhdGEKCQkJCQkJZWxzZSB7CgkJCQkJCQlpZiAobm9kZXNbMF0ubm9kZVR5cGUgPT0gMSB8fCBub2Rlcy5sZW5ndGggPiAxKSB7IC8vd2FzIGEgdHJ1c3RlZCBzdHJpbmcKCQkJCQkJCQljbGVhcihjYWNoZWQubm9kZXMsIGNhY2hlZCkKCQkJCQkJCQlub2RlcyA9IFt3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSldCgkJCQkJCQl9CgkJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2Rlc1swXSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQkJCQkJbm9kZXNbMF0ubm9kZVZhbHVlID0gZGF0YQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IoZGF0YSkKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQkJZWxzZSBjYWNoZWQubm9kZXMuaW50YWN0ID0gdHJ1ZQoJCX0KCgkJcmV0dXJuIGNhY2hlZAoJfQoJZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhub2RlLCB0YWcsIGRhdGFBdHRycywgY2FjaGVkQXR0cnMsIG5hbWVzcGFjZSkgewoJCXZhciBncm91cHMgPSB7fQoJCWZvciAodmFyIGF0dHJOYW1lIGluIGRhdGFBdHRycykgewoJCQl2YXIgZGF0YUF0dHIgPSBkYXRhQXR0cnNbYXR0ck5hbWVdCgkJCXZhciBjYWNoZWRBdHRyID0gY2FjaGVkQXR0cnNbYXR0ck5hbWVdCgkJCWlmICghKGF0dHJOYW1lIGluIGNhY2hlZEF0dHJzKSB8fCAoY2FjaGVkQXR0ciAhPT0gZGF0YUF0dHIpIHx8IG5vZGUgPT09IHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgkJCQljYWNoZWRBdHRyc1thdHRyTmFtZV0gPSBkYXRhQXR0cgoJCQkJaWYgKGF0dHJOYW1lID09PSAiY29uZmlnIikgY29udGludWUKCQkJCWVsc2UgaWYgKHR5cGVvZiBkYXRhQXR0ciA9PSAiZnVuY3Rpb24iICYmIGF0dHJOYW1lLmluZGV4T2YoIm9uIikgPT0gMCkgewoJCQkJCW5vZGVbYXR0ck5hbWVdID0gYXV0b3JlZHJhdyhkYXRhQXR0ciwgbm9kZSkKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAic3R5bGUiICYmIHR5cGVvZiBkYXRhQXR0ciA9PSAib2JqZWN0IikgewoJCQkJCWZvciAodmFyIHJ1bGUgaW4gZGF0YUF0dHIpIHsKCQkJCQkJaWYgKGNhY2hlZEF0dHIgPT09IHVuZGVmaW5lZCB8fCBjYWNoZWRBdHRyW3J1bGVdICE9PSBkYXRhQXR0cltydWxlXSkgbm9kZS5zdHlsZVtydWxlXSA9IGRhdGFBdHRyW3J1bGVdCgkJCQkJfQoJCQkJCWZvciAodmFyIHJ1bGUgaW4gY2FjaGVkQXR0cikgewoJCQkJCQlpZiAoIShydWxlIGluIGRhdGFBdHRyKSkgbm9kZS5zdHlsZVtydWxlXSA9ICIiCgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAobmFtZXNwYWNlICE9PSB1bmRlZmluZWQpIHsKCQkJCQlpZiAoYXR0ck5hbWUgPT09ICJocmVmIikgbm9kZS5zZXRBdHRyaWJ1dGVOUygiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsICJocmVmIiwgZGF0YUF0dHIpCgkJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJjbGFzc05hbWUiKSBub2RlLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCBkYXRhQXR0cikKCQkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAidmFsdWUiICYmIHRhZyA9PT0gImlucHV0IikgewoJCQkJCWlmIChub2RlLnZhbHVlICE9PSBkYXRhQXR0cikgbm9kZS52YWx1ZSA9IGRhdGFBdHRyCgkJCQl9CgkJCQllbHNlIGlmIChhdHRyTmFtZSBpbiBub2RlICYmICEoYXR0ck5hbWUgPT0gImxpc3QiIHx8IGF0dHJOYW1lID09ICJzdHlsZSIpKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBkYXRhQXR0cgoJCQkJfQoJCQkJZWxzZSBub2RlLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgZGF0YUF0dHIpCgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlZEF0dHJzCgl9CglmdW5jdGlvbiBjbGVhcihub2RlcywgY2FjaGVkKSB7CgkJZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDE7IGkgPiAtMTsgaS0tKSB7CgkJCWlmIChub2Rlc1tpXSAmJiBub2Rlc1tpXS5wYXJlbnROb2RlKSB7CgkJCQlub2Rlc1tpXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGVzW2ldKQoJCQkJY2FjaGVkID0gW10uY29uY2F0KGNhY2hlZCkKCQkJCWlmIChjYWNoZWRbaV0pIHVubG9hZChjYWNoZWRbaV0pCgkJCX0KCQl9CgkJaWYgKG5vZGVzLmxlbmd0aCAhPSAwKSBub2Rlcy5sZW5ndGggPSAwCgl9CglmdW5jdGlvbiB1bmxvYWQoY2FjaGVkKSB7CgkJaWYgKGNhY2hlZC5jb25maWdDb250ZXh0ICYmIHR5cGVvZiBjYWNoZWQuY29uZmlnQ29udGV4dC5vbnVubG9hZCA9PSAiZnVuY3Rpb24iKSBjYWNoZWQuY29uZmlnQ29udGV4dC5vbnVubG9hZCgpCgkJaWYgKGNhY2hlZC5jaGlsZHJlbikgewoJCQlpZiAodHlwZS5jYWxsKGNhY2hlZC5jaGlsZHJlbikgPT0gIltvYmplY3QgQXJyYXldIikgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWNoZWQuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHVubG9hZChjYWNoZWQuY2hpbGRyZW5baV0pCgkJCWVsc2UgaWYgKGNhY2hlZC5jaGlsZHJlbi50YWcpIHVubG9hZChjYWNoZWQuY2hpbGRyZW4pCgkJfQoJfQoJZnVuY3Rpb24gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkgewoJCXZhciBuZXh0U2libGluZyA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0KCQlpZiAobmV4dFNpYmxpbmcpIHsKCQkJdmFyIGlzRWxlbWVudCA9IG5leHRTaWJsaW5nLm5vZGVUeXBlICE9IDEKCQkJdmFyIHBsYWNlaG9sZGVyID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKQoJCQlpZiAoaXNFbGVtZW50KSB7CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgbmV4dFNpYmxpbmcpCgkJCQlwbGFjZWhvbGRlci5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIiwgZGF0YSkKCQkJCXBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQocGxhY2Vob2xkZXIpCgkJCX0KCQkJZWxzZSBuZXh0U2libGluZy5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIiwgZGF0YSkKCQl9CgkJZWxzZSBwYXJlbnRFbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlZW5kIiwgZGF0YSkKCQl2YXIgbm9kZXMgPSBbXQoJCXdoaWxlIChwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdICE9PSBuZXh0U2libGluZykgewoJCQlub2Rlcy5wdXNoKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0pCgkJCWluZGV4KysKCQl9CgkJcmV0dXJuIG5vZGVzCgl9CglmdW5jdGlvbiBmbGF0dGVuKGRhdGEpIHsKCQl2YXIgZmxhdHRlbmVkID0gW10KCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGl0ZW0gPSBkYXRhW2ldCgkJCWlmICh0eXBlLmNhbGwoaXRlbSkgPT0gIltvYmplY3QgQXJyYXldIikgZmxhdHRlbmVkLnB1c2guYXBwbHkoZmxhdHRlbmVkLCBmbGF0dGVuKGl0ZW0pKQoJCQllbHNlIGZsYXR0ZW5lZC5wdXNoKGl0ZW0pCgkJfQoJCXJldHVybiBmbGF0dGVuZWQKCX0KCWZ1bmN0aW9uIGF1dG9yZWRyYXcoY2FsbGJhY2ssIG9iamVjdCwgZ3JvdXApIHsKCQlyZXR1cm4gZnVuY3Rpb24oZSkgewoJCQllID0gZSB8fCBldmVudAoJCQltLnJlZHJhdy5zdHJhdGVneSgiZGlmZiIpCgkJCW0uc3RhcnRDb21wdXRhdGlvbigpCgkJCXRyeSB7cmV0dXJuIGNhbGxiYWNrLmNhbGwob2JqZWN0LCBlKX0KCQkJZmluYWxseSB7CgkJCQlpZiAoIWxhc3RSZWRyYXdJZCkgbGFzdFJlZHJhd0lkID0gLTE7CgkJCQltLmVuZENvbXB1dGF0aW9uKCkKCQkJfQoJCX0KCX0KCgl2YXIgaHRtbAoJdmFyIGRvY3VtZW50Tm9kZSA9IHsKCQlpbnNlcnRBZGphY2VudEhUTUw6IGZ1bmN0aW9uKF8sIGRhdGEpIHsKCQkJd2luZG93LmRvY3VtZW50LndyaXRlKGRhdGEpCgkJCXdpbmRvdy5kb2N1bWVudC5jbG9zZSgpCgkJfSwKCQlhcHBlbmRDaGlsZDogZnVuY3Rpb24obm9kZSkgewoJCQlpZiAoaHRtbCA9PT0gdW5kZWZpbmVkKSBodG1sID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImh0bWwiKQoJCQlpZiAobm9kZS5ub2RlTmFtZSA9PSAiSFRNTCIpIGh0bWwgPSBub2RlCgkJCWVsc2UgaHRtbC5hcHBlbmRDaGlsZChub2RlKQoJCQlpZiAod2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICE9PSBodG1sKSB7CgkJCQl3aW5kb3cuZG9jdW1lbnQucmVwbGFjZUNoaWxkKGh0bWwsIHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpCgkJCX0KCQkJZWxzZSB3aW5kb3cuZG9jdW1lbnQuYXBwZW5kQ2hpbGQoaHRtbCkKCQl9LAoJCWluc2VydEJlZm9yZTogZnVuY3Rpb24obm9kZSkgewoJCQl0aGlzLmFwcGVuZENoaWxkKG5vZGUpCgkJfSwKCQljaGlsZE5vZGVzOiBbXQoJfQoJdmFyIG5vZGVDYWNoZSA9IFtdLCBjZWxsQ2FjaGUgPSB7fQoJbS5yZW5kZXIgPSBmdW5jdGlvbihyb290LCBjZWxsLCBmb3JjZVJlY3JlYXRpb24pIHsKCQl2YXIgY29uZmlncyA9IFtdCgkJaWYgKCFyb290KSB0aHJvdyBuZXcgRXJyb3IoIlBsZWFzZSBlbnN1cmUgdGhlIERPTSBlbGVtZW50IGV4aXN0cyBiZWZvcmUgcmVuZGVyaW5nIGEgdGVtcGxhdGUgaW50byBpdC4iKQoJCXZhciBpZCA9IGdldENlbGxDYWNoZUtleShyb290KQoJCXZhciBub2RlID0gcm9vdCA9PSB3aW5kb3cuZG9jdW1lbnQgfHwgcm9vdCA9PSB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnROb2RlIDogcm9vdAoJCWlmIChjZWxsQ2FjaGVbaWRdID09PSB1bmRlZmluZWQpIGNsZWFyKG5vZGUuY2hpbGROb2RlcykKCQlpZiAoZm9yY2VSZWNyZWF0aW9uID09PSB0cnVlKSByZXNldChyb290KQoJCWNlbGxDYWNoZVtpZF0gPSBidWlsZChub2RlLCBudWxsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY2VsbCwgY2VsbENhY2hlW2lkXSwgZmFsc2UsIDAsIG51bGwsIHVuZGVmaW5lZCwgY29uZmlncykKCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbmZpZ3MubGVuZ3RoOyBpKyspIGNvbmZpZ3NbaV0oKQoJfQoJZnVuY3Rpb24gZ2V0Q2VsbENhY2hlS2V5KGVsZW1lbnQpIHsKCQl2YXIgaW5kZXggPSBub2RlQ2FjaGUuaW5kZXhPZihlbGVtZW50KQoJCXJldHVybiBpbmRleCA8IDAgPyBub2RlQ2FjaGUucHVzaChlbGVtZW50KSAtIDEgOiBpbmRleAoJfQoKCW0udHJ1c3QgPSBmdW5jdGlvbih2YWx1ZSkgewoJCXZhbHVlID0gbmV3IFN0cmluZyh2YWx1ZSkKCQl2YWx1ZS4kdHJ1c3RlZCA9IHRydWUKCQlyZXR1cm4gdmFsdWUKCX0KCgltLnByb3AgPSBmdW5jdGlvbihzdG9yZSkgewoJCXZhciBwcm9wID0gZnVuY3Rpb24oKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSBzdG9yZSA9IGFyZ3VtZW50c1swXQoJCQlyZXR1cm4gc3RvcmUKCQl9CgkJcHJvcC50b0pTT04gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHN0b3JlCgkJfQoJCXJldHVybiBwcm9wCgl9CgkKCXZhciByb290cyA9IFtdLCBtb2R1bGVzID0gW10sIGNvbnRyb2xsZXJzID0gW10sIGxhc3RSZWRyYXdJZCA9IDAsIGNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwsIHByZXZlbnRlZCA9IGZhbHNlCgltLm1vZHVsZSA9IGZ1bmN0aW9uKHJvb3QsIG1vZHVsZSkgewoJCXZhciBpbmRleCA9IHJvb3RzLmluZGV4T2Yocm9vdCkKCQlpZiAoaW5kZXggPCAwKSBpbmRleCA9IHJvb3RzLmxlbmd0aAoJCXZhciBpc1ByZXZlbnRlZCA9IGZhbHNlCgkJaWYgKGNvbnRyb2xsZXJzW2luZGV4XSAmJiB0eXBlb2YgY29udHJvbGxlcnNbaW5kZXhdLm9udW5sb2FkID09ICJmdW5jdGlvbiIpIHsKCQkJdmFyIGV2ZW50ID0gewoJCQkJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkge2lzUHJldmVudGVkID0gdHJ1ZX0KCQkJfQoJCQljb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQoZXZlbnQpCgkJfQoJCWlmICghaXNQcmV2ZW50ZWQpIHsKCQkJbS5yZWRyYXcuc3RyYXRlZ3koImFsbCIpCgkJCW0uc3RhcnRDb21wdXRhdGlvbigpCgkJCXJvb3RzW2luZGV4XSA9IHJvb3QKCQkJbW9kdWxlc1tpbmRleF0gPSBtb2R1bGUKCQkJY29udHJvbGxlcnNbaW5kZXhdID0gbmV3IG1vZHVsZS5jb250cm9sbGVyCgkJCW0uZW5kQ29tcHV0YXRpb24oKQoJCX0KCX0KCW0ucmVkcmF3ID0gZnVuY3Rpb24oKSB7CgkJdmFyIGNhbmNlbCA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cuY2xlYXJUaW1lb3V0CgkJdmFyIGRlZmVyID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cuc2V0VGltZW91dAoJCWlmIChsYXN0UmVkcmF3SWQpIHsKCQkJY2FuY2VsKGxhc3RSZWRyYXdJZCkKCQkJbGFzdFJlZHJhd0lkID0gZGVmZXIocmVkcmF3LCAwKQoJCX0KCQllbHNlIHsKCQkJcmVkcmF3KCkKCQkJbGFzdFJlZHJhd0lkID0gZGVmZXIoZnVuY3Rpb24oKSB7bGFzdFJlZHJhd0lkID0gbnVsbH0sIDApCgkJfQoJfQoJbS5yZWRyYXcuc3RyYXRlZ3kgPSBtLnByb3AoKQoJZnVuY3Rpb24gcmVkcmF3KCkgewoJCXZhciBtb2RlID0gbS5yZWRyYXcuc3RyYXRlZ3koKQoJCWZvciAodmFyIGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKGNvbnRyb2xsZXJzW2ldICYmIG1vZGUgIT0gIm5vbmUiKSBtLnJlbmRlcihyb290c1tpXSwgbW9kdWxlc1tpXS52aWV3KGNvbnRyb2xsZXJzW2ldKSwgbW9kZSA9PSAiYWxsIikKCQl9CgkJaWYgKGNvbXB1dGVQb3N0UmVkcmF3SG9vaykgewoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2soKQoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBudWxsCgkJfQoJCWxhc3RSZWRyYXdJZCA9IG51bGwKCQltLnJlZHJhdy5zdHJhdGVneSgiZGlmZiIpCgl9CgoJdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IDAKCW0uc3RhcnRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkge3BlbmRpbmdSZXF1ZXN0cysrfQoJbS5lbmRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXBlbmRpbmdSZXF1ZXN0cyA9IE1hdGgubWF4KHBlbmRpbmdSZXF1ZXN0cyAtIDEsIDApCgkJaWYgKHBlbmRpbmdSZXF1ZXN0cyA9PSAwKSBtLnJlZHJhdygpCgl9CgoJbS53aXRoQXR0ciA9IGZ1bmN0aW9uKHByb3AsIHdpdGhBdHRyQ2FsbGJhY2spIHsKCQlyZXR1cm4gZnVuY3Rpb24oZSkgewoJCQllID0gZSB8fCBldmVudAoJCQl2YXIgY3VycmVudFRhcmdldCA9IGUuY3VycmVudFRhcmdldCB8fCB0aGlzCgkJCXdpdGhBdHRyQ2FsbGJhY2socHJvcCBpbiBjdXJyZW50VGFyZ2V0ID8gY3VycmVudFRhcmdldFtwcm9wXSA6IGN1cnJlbnRUYXJnZXQuZ2V0QXR0cmlidXRlKHByb3ApKQoJCX0KCX0KCgkvL3JvdXRpbmcKCXZhciBtb2RlcyA9IHtwYXRobmFtZTogIiIsIGhhc2g6ICIjIiwgc2VhcmNoOiAiPyJ9Cgl2YXIgcmVkaXJlY3QgPSBmdW5jdGlvbigpIHt9LCByb3V0ZVBhcmFtcyA9IHt9LCBjdXJyZW50Um91dGUKCW0ucm91dGUgPSBmdW5jdGlvbigpIHsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGN1cnJlbnRSb3V0ZQoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PSAic3RyaW5nIikgewoJCQl2YXIgcm9vdCA9IGFyZ3VtZW50c1swXSwgZGVmYXVsdFJvdXRlID0gYXJndW1lbnRzWzFdLCByb3V0ZXIgPSBhcmd1bWVudHNbMl0KCQkJcmVkaXJlY3QgPSBmdW5jdGlvbihzb3VyY2UpIHsKCQkJCXZhciBwYXRoID0gY3VycmVudFJvdXRlID0gbm9ybWFsaXplUm91dGUoc291cmNlKQoJCQkJaWYgKCFyb3V0ZUJ5VmFsdWUocm9vdCwgcm91dGVyLCBwYXRoKSkgewoJCQkJCW0ucm91dGUoZGVmYXVsdFJvdXRlLCB0cnVlKQoJCQkJfQoJCQl9CgkJCXZhciBsaXN0ZW5lciA9IG0ucm91dGUubW9kZSA9PSAiaGFzaCIgPyAib25oYXNoY2hhbmdlIiA6ICJvbnBvcHN0YXRlIgoJCQl3aW5kb3dbbGlzdGVuZXJdID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoY3VycmVudFJvdXRlICE9IG5vcm1hbGl6ZVJvdXRlKHdpbmRvdy5sb2NhdGlvblttLnJvdXRlLm1vZGVdKSkgewoJCQkJCXJlZGlyZWN0KHdpbmRvdy5sb2NhdGlvblttLnJvdXRlLm1vZGVdKQoJCQkJfQoJCQl9CgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IHNldFNjcm9sbAoJCQl3aW5kb3dbbGlzdGVuZXJdKCkKCQl9CgkJZWxzZSBpZiAoYXJndW1lbnRzWzBdLmFkZEV2ZW50TGlzdGVuZXIpIHsKCQkJdmFyIGVsZW1lbnQgPSBhcmd1bWVudHNbMF0KCQkJdmFyIGlzSW5pdGlhbGl6ZWQgPSBhcmd1bWVudHNbMV0KCQkJaWYgKGVsZW1lbnQuaHJlZi5pbmRleE9mKG1vZGVzW20ucm91dGUubW9kZV0pIDwgMCkgewoJCQkJZWxlbWVudC5ocmVmID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgbW9kZXNbbS5yb3V0ZS5tb2RlXSArIGVsZW1lbnQucGF0aG5hbWUKCQkJfQoJCQlpZiAoIWlzSW5pdGlhbGl6ZWQpIHsKCQkJCWVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCByb3V0ZVVub2J0cnVzaXZlKQoJCQkJZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCX0KCQl9CgkJZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PSAic3RyaW5nIikgewoJCQljdXJyZW50Um91dGUgPSBhcmd1bWVudHNbMF0KCQkJdmFyIHF1ZXJ5c3RyaW5nID0gdHlwZW9mIGFyZ3VtZW50c1sxXSA9PSAib2JqZWN0IiA/IGJ1aWxkUXVlcnlTdHJpbmcoYXJndW1lbnRzWzFdKSA6IG51bGwKCQkJaWYgKHF1ZXJ5c3RyaW5nKSBjdXJyZW50Um91dGUgKz0gKGN1cnJlbnRSb3V0ZS5pbmRleE9mKCI/IikgPT09IC0xID8gIj8iIDogIiYiKSArIHF1ZXJ5c3RyaW5nCgoJCQl2YXIgc2hvdWxkUmVwbGFjZUhpc3RvcnlFbnRyeSA9IChhcmd1bWVudHMubGVuZ3RoID09IDMgPyBhcmd1bWVudHNbMl0gOiBhcmd1bWVudHNbMV0pID09PSB0cnVlCgkJCQoJCQlpZiAod2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKSB7CgkJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuaGlzdG9yeVtzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID8gInJlcGxhY2VTdGF0ZSIgOiAicHVzaFN0YXRlIl0obnVsbCwgd2luZG93LmRvY3VtZW50LnRpdGxlLCBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQkJCXNldFNjcm9sbCgpCgkJCQl9CgkJCQlyZWRpcmVjdChtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQl9CgkJCWVsc2Ugd2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0gPSBjdXJyZW50Um91dGUKCQl9Cgl9CgltLnJvdXRlLnBhcmFtID0gZnVuY3Rpb24oa2V5KSB7cmV0dXJuIHJvdXRlUGFyYW1zW2tleV19CgltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJZnVuY3Rpb24gbm9ybWFsaXplUm91dGUocm91dGUpIHtyZXR1cm4gcm91dGUuc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpfQoJZnVuY3Rpb24gcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkgewoJCXJvdXRlUGFyYW1zID0ge30KCgkJdmFyIHF1ZXJ5U3RhcnQgPSBwYXRoLmluZGV4T2YoIj8iKQoJCWlmIChxdWVyeVN0YXJ0ICE9PSAtMSkgewoJCQlyb3V0ZVBhcmFtcyA9IHBhcnNlUXVlcnlTdHJpbmcocGF0aC5zdWJzdHIocXVlcnlTdGFydCArIDEsIHBhdGgubGVuZ3RoKSkKCQkJcGF0aCA9IHBhdGguc3Vic3RyKDAsIHF1ZXJ5U3RhcnQpCgkJfQoKCQlmb3IgKHZhciByb3V0ZSBpbiByb3V0ZXIpIHsKCQkJaWYgKHJvdXRlID09IHBhdGgpIHsKCQkJCW0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgkJCQlyZXR1cm4gdHJ1ZQoJCQl9CgoJCQl2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoIl4iICsgcm91dGUucmVwbGFjZSgvOlteXC9dKz9cLnszfS9nLCAiKC4qPykiKS5yZXBsYWNlKC86W15cL10rL2csICIoW15cXC9dKykiKSArICJcLz8kIikKCgkJCWlmIChtYXRjaGVyLnRlc3QocGF0aCkpIHsKCQkJCXBhdGgucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbigpIHsKCQkJCQl2YXIga2V5cyA9IHJvdXRlLm1hdGNoKC86W15cL10rL2cpIHx8IFtdCgkJCQkJdmFyIHZhbHVlcyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxLCAtMikKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHJvdXRlUGFyYW1zW2tleXNbaV0ucmVwbGFjZSgvOnxcLi9nLCAiIildID0gZGVjb2RlU3BhY2UodmFsdWVzW2ldKQoJCQkJCW0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgkJCQl9KQoJCQkJcmV0dXJuIHRydWUKCQkJfQoJCX0KCX0KCWZ1bmN0aW9uIHJvdXRlVW5vYnRydXNpdmUoZSkgewoJCWUgPSBlIHx8IGV2ZW50CgkJaWYgKGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS53aGljaCA9PSAyKSByZXR1cm4KCQllLnByZXZlbnREZWZhdWx0KCkKCQltLnJvdXRlKGUuY3VycmVudFRhcmdldFttLnJvdXRlLm1vZGVdLnNsaWNlKG1vZGVzW20ucm91dGUubW9kZV0ubGVuZ3RoKSkKCX0KCWZ1bmN0aW9uIHNldFNjcm9sbCgpIHsKCQlpZiAobS5yb3V0ZS5tb2RlICE9ICJoYXNoIiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCkgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaAoJCWVsc2Ugd2luZG93LnNjcm9sbFRvKDAsIDApCgl9CglmdW5jdGlvbiBidWlsZFF1ZXJ5U3RyaW5nKG9iamVjdCwgcHJlZml4KSB7CgkJdmFyIHN0ciA9IFtdCgkJZm9yKHZhciBwcm9wIGluIG9iamVjdCkgewoJCQl2YXIga2V5ID0gcHJlZml4ID8gcHJlZml4ICsgIlsiICsgcHJvcCArICJdIiA6IHByb3AsIHZhbHVlID0gb2JqZWN0W3Byb3BdCgkJCXN0ci5wdXNoKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiA/IGJ1aWxkUXVlcnlTdHJpbmcodmFsdWUsIGtleSkgOiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpCgkJfQoJCXJldHVybiBzdHIuam9pbigiJiIpCgl9CglmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHN0cikgewoJCXZhciBwYWlycyA9IHN0ci5zcGxpdCgiJiIpLCBwYXJhbXMgPSB7fQoJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFpcnMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIHBhaXIgPSBwYWlyc1tpXS5zcGxpdCgiPSIpCgkJCXBhcmFtc1tkZWNvZGVTcGFjZShwYWlyWzBdKV0gPSBwYWlyWzFdID8gZGVjb2RlU3BhY2UocGFpclsxXSkgOiAocGFpci5sZW5ndGggPT09IDEgPyB0cnVlIDogIiIpCgkJfQoJCXJldHVybiBwYXJhbXMKCX0KCWZ1bmN0aW9uIGRlY29kZVNwYWNlKHN0cmluZykgewoJCXJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyaW5nLnJlcGxhY2UoL1wrL2csICIgIikpCgl9CglmdW5jdGlvbiByZXNldChyb290KSB7CgkJdmFyIGNhY2hlS2V5ID0gZ2V0Q2VsbENhY2hlS2V5KHJvb3QpCgkJY2xlYXIocm9vdC5jaGlsZE5vZGVzLCBjZWxsQ2FjaGVbY2FjaGVLZXldKQoJCWNlbGxDYWNoZVtjYWNoZUtleV0gPSB1bmRlZmluZWQKCX0KCgl2YXIgbm9uZSA9IHt9CgltLmRlZmVycmVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJlc29sdmVycyA9IFtdLCByZWplY3RlcnMgPSBbXSwgcmVzb2x2ZWQgPSBub25lLCByZWplY3RlZCA9IG5vbmUsIHByb21pc2UgPSBtLnByb3AoKQoJCXZhciBvYmplY3QgPSB7CgkJCXJlc29sdmU6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlpZiAocmVzb2x2ZWQgPT09IG5vbmUpIHByb21pc2UocmVzb2x2ZWQgPSB2YWx1ZSkKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZXJzLmxlbmd0aDsgaSsrKSByZXNvbHZlcnNbaV0odmFsdWUpCgkJCQlyZXNvbHZlcnMubGVuZ3RoID0gcmVqZWN0ZXJzLmxlbmd0aCA9IDAKCQkJfSwKCQkJcmVqZWN0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJaWYgKHJlamVjdGVkID09PSBub25lKSByZWplY3RlZCA9IHZhbHVlCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlamVjdGVycy5sZW5ndGg7IGkrKykgcmVqZWN0ZXJzW2ldKHZhbHVlKQoJCQkJcmVzb2x2ZXJzLmxlbmd0aCA9IHJlamVjdGVycy5sZW5ndGggPSAwCgkJCX0sCgkJCXByb21pc2U6IHByb21pc2UKCQl9CgkJb2JqZWN0LnByb21pc2UucmVzb2x2ZXJzID0gcmVzb2x2ZXJzCgkJb2JqZWN0LnByb21pc2UudGhlbiA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CgkJCXZhciBuZXh0ID0gbS5kZWZlcnJlZCgpCgkJCWlmICghc3VjY2Vzcykgc3VjY2VzcyA9IGlkZW50aXR5CgkJCWlmICghZXJyb3IpIGVycm9yID0gaWRlbnRpdHkKCQkJZnVuY3Rpb24gY2FsbGJhY2sobWV0aG9kLCBjYWxsYmFjaykgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlKQoJCQkJCQlpZiAocmVzdWx0ICYmIHR5cGVvZiByZXN1bHQudGhlbiA9PSAiZnVuY3Rpb24iKSByZXN1bHQudGhlbihuZXh0W21ldGhvZF0sIGVycm9yKQoJCQkJCQllbHNlIG5leHRbbWV0aG9kXShyZXN1bHQgIT09IHVuZGVmaW5lZCA/IHJlc3VsdCA6IHZhbHVlKQoJCQkJCX0KCQkJCQljYXRjaCAoZSkgewoJCQkJCQlpZiAodHlwZS5jYWxsKGUpID09ICJbb2JqZWN0IEVycm9yXSIgJiYgZS5jb25zdHJ1Y3RvciAhPT0gRXJyb3IpIHRocm93IGUKCQkJCQkJZWxzZSBuZXh0LnJlamVjdChlKQoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpZiAocmVzb2x2ZWQgIT09IG5vbmUpIGNhbGxiYWNrKCJyZXNvbHZlIiwgc3VjY2VzcykocmVzb2x2ZWQpCgkJCWVsc2UgaWYgKHJlamVjdGVkICE9PSBub25lKSBjYWxsYmFjaygicmVqZWN0IiwgZXJyb3IpKHJlamVjdGVkKQoJCQllbHNlIHsKCQkJCXJlc29sdmVycy5wdXNoKGNhbGxiYWNrKCJyZXNvbHZlIiwgc3VjY2VzcykpCgkJCQlyZWplY3RlcnMucHVzaChjYWxsYmFjaygicmVqZWN0IiwgZXJyb3IpKQoJCQl9CgkJCXJldHVybiBuZXh0LnByb21pc2UKCQl9CgkJcmV0dXJuIG9iamVjdAoJfQoJbS5zeW5jID0gZnVuY3Rpb24oYXJncykgewoJCXZhciBtZXRob2QgPSAicmVzb2x2ZSIKCQlmdW5jdGlvbiBzeW5jaHJvbml6ZXIocG9zLCByZXNvbHZlZCkgewoJCQlyZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCQkJCXJlc3VsdHNbcG9zXSA9IHZhbHVlCgkJCQlpZiAoIXJlc29sdmVkKSBtZXRob2QgPSAicmVqZWN0IgoJCQkJaWYgKC0tb3V0c3RhbmRpbmcgPT0gMCkgewoJCQkJCWRlZmVycmVkLnByb21pc2UocmVzdWx0cykKCQkJCQlkZWZlcnJlZFttZXRob2RdKHJlc3VsdHMpCgkJCQl9CgkJCQlyZXR1cm4gdmFsdWUKCQkJfQoJCX0KCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIG91dHN0YW5kaW5nID0gYXJncy5sZW5ndGgKCQl2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShvdXRzdGFuZGluZykKCQlpZiAoYXJncy5sZW5ndGggPiAwKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewoJCQkJYXJnc1tpXS50aGVuKHN5bmNocm9uaXplcihpLCB0cnVlKSwgc3luY2hyb25pemVyKGksIGZhbHNlKSkKCQkJfQoJCX0KCQllbHNlIGRlZmVycmVkLnJlc29sdmUoKQoJCQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CglmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkge3JldHVybiB2YWx1ZX0KCglmdW5jdGlvbiBhamF4KG9wdGlvbnMpIHsKCQl2YXIgeGhyID0gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdAoJCXhoci5vcGVuKG9wdGlvbnMubWV0aG9kLCBvcHRpb25zLnVybCwgdHJ1ZSwgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7CgkJCQlpZiAoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgb3B0aW9ucy5vbmxvYWQoe3R5cGU6ICJsb2FkIiwgdGFyZ2V0OiB4aHJ9KQoJCQkJZWxzZSBvcHRpb25zLm9uZXJyb3Ioe3R5cGU6ICJlcnJvciIsIHRhcmdldDogeGhyfSkKCQkJfQoJCX0KCQlpZiAob3B0aW9ucy5zZXJpYWxpemUgPT0gSlNPTi5zdHJpbmdpZnkgJiYgb3B0aW9ucy5tZXRob2QgIT0gIkdFVCIpIHsKCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04Iik7CgkJfQoJCWlmICh0eXBlb2Ygb3B0aW9ucy5jb25maWcgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgbWF5YmVYaHIgPSBvcHRpb25zLmNvbmZpZyh4aHIsIG9wdGlvbnMpCgkJCWlmIChtYXliZVhociAhPT0gdW5kZWZpbmVkKSB4aHIgPSBtYXliZVhocgoJCX0KCQl4aHIuc2VuZChvcHRpb25zLm1ldGhvZCA9PSAiR0VUIiA/ICIiIDogb3B0aW9ucy5kYXRhKQoJCXJldHVybiB4aHIKCX0KCWZ1bmN0aW9uIGJpbmREYXRhKHhock9wdGlvbnMsIGRhdGEsIHNlcmlhbGl6ZSkgewoJCWlmIChkYXRhICYmIE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCA+IDApIHsKCQkJaWYgKHhock9wdGlvbnMubWV0aG9kID09ICJHRVQiKSB7CgkJCQl4aHJPcHRpb25zLnVybCA9IHhock9wdGlvbnMudXJsICsgKHhock9wdGlvbnMudXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgYnVpbGRRdWVyeVN0cmluZyhkYXRhKQoJCQl9CgkJCWVsc2UgeGhyT3B0aW9ucy5kYXRhID0gc2VyaWFsaXplKGRhdGEpCgkJfQoJCXJldHVybiB4aHJPcHRpb25zCgl9CglmdW5jdGlvbiBwYXJhbWV0ZXJpemVVcmwodXJsLCBkYXRhKSB7CgkJdmFyIHRva2VucyA9IHVybC5tYXRjaCgvOlthLXpdXHcrL2dpKQoJCWlmICh0b2tlbnMgJiYgZGF0YSkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGtleSA9IHRva2Vuc1tpXS5zbGljZSgxKQoJCQkJdXJsID0gdXJsLnJlcGxhY2UodG9rZW5zW2ldLCBkYXRhW2tleV0pCgkJCQlkZWxldGUgZGF0YVtrZXldCgkJCX0KCQl9CgkJcmV0dXJuIHVybAoJfQoKCW0ucmVxdWVzdCA9IGZ1bmN0aW9uKHhock9wdGlvbnMpIHsKCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLnN0YXJ0Q29tcHV0YXRpb24oKQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCXZhciBzZXJpYWxpemUgPSB4aHJPcHRpb25zLnNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplIHx8IEpTT04uc3RyaW5naWZ5CgkJdmFyIGRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSA9IHhock9wdGlvbnMuZGVzZXJpYWxpemUgfHwgSlNPTi5wYXJzZQoJCXZhciBleHRyYWN0ID0geGhyT3B0aW9ucy5leHRyYWN0IHx8IGZ1bmN0aW9uKHhocikgewoJCQlyZXR1cm4geGhyLnJlc3BvbnNlVGV4dC5sZW5ndGggPT09IDAgJiYgZGVzZXJpYWxpemUgPT09IEpTT04ucGFyc2UgPyBudWxsIDogeGhyLnJlc3BvbnNlVGV4dAoJCX0KCQl4aHJPcHRpb25zLnVybCA9IHBhcmFtZXRlcml6ZVVybCh4aHJPcHRpb25zLnVybCwgeGhyT3B0aW9ucy5kYXRhKQoJCXhock9wdGlvbnMgPSBiaW5kRGF0YSh4aHJPcHRpb25zLCB4aHJPcHRpb25zLmRhdGEsIHNlcmlhbGl6ZSkKCQl4aHJPcHRpb25zLm9ubG9hZCA9IHhock9wdGlvbnMub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKCQkJdHJ5IHsKCQkJCWUgPSBlIHx8IGV2ZW50CgkJCQl2YXIgdW53cmFwID0gKGUudHlwZSA9PSAibG9hZCIgPyB4aHJPcHRpb25zLnVud3JhcFN1Y2Nlc3MgOiB4aHJPcHRpb25zLnVud3JhcEVycm9yKSB8fCBpZGVudGl0eQoJCQkJdmFyIHJlc3BvbnNlID0gdW53cmFwKGRlc2VyaWFsaXplKGV4dHJhY3QoZS50YXJnZXQsIHhock9wdGlvbnMpKSkKCQkJCWlmIChlLnR5cGUgPT0gImxvYWQiKSB7CgkJCQkJaWYgKHR5cGUuY2FsbChyZXNwb25zZSkgPT0gIltvYmplY3QgQXJyYXldIiAmJiB4aHJPcHRpb25zLnR5cGUpIHsKCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgcmVzcG9uc2VbaV0gPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlW2ldKQoJCQkJCX0KCQkJCQllbHNlIGlmICh4aHJPcHRpb25zLnR5cGUpIHJlc3BvbnNlID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZSkKCQkJCX0KCQkJCWRlZmVycmVkW2UudHlwZSA9PSAibG9hZCIgPyAicmVzb2x2ZSIgOiAicmVqZWN0Il0ocmVzcG9uc2UpCgkJCX0KCQkJY2F0Y2ggKGUpIHsKCQkJCWlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHRocm93IG5ldyBTeW50YXhFcnJvcigiQ291bGQgbm90IHBhcnNlIEhUVFAgcmVzcG9uc2UuIFNlZSBodHRwOi8vbGhvcmllLmdpdGh1Yi5pby9taXRocmlsL21pdGhyaWwucmVxdWVzdC5odG1sI3VzaW5nLXZhcmlhYmxlLWRhdGEtZm9ybWF0cyIpCgkJCQllbHNlIGlmICh0eXBlLmNhbGwoZSkgPT0gIltvYmplY3QgRXJyb3JdIiAmJiBlLmNvbnN0cnVjdG9yICE9PSBFcnJvcikgdGhyb3cgZQoJCQkJZWxzZSBkZWZlcnJlZC5yZWplY3QoZSkKCQkJfQoJCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLmVuZENvbXB1dGF0aW9uKCkKCQl9CgkJYWpheCh4aHJPcHRpb25zKQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CgoJLy90ZXN0aW5nIEFQSQoJbS5kZXBzID0gZnVuY3Rpb24obW9jaykge3JldHVybiB3aW5kb3cgPSBtb2NrfQoJLy9mb3IgaW50ZXJuYWwgdGVzdGluZyBvbmx5LCBkbyBub3QgdXNlIGBtLmRlcHMuZmFjdG9yeWAKCW0uZGVwcy5mYWN0b3J5ID0gYXBwCgoJcmV0dXJuIG0KfSh0eXBlb2Ygd2luZG93ICE9ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCgppZiAodHlwZW9mIG1vZHVsZSAhPSAidW5kZWZpbmVkIiAmJiBtb2R1bGUgIT09IG51bGwpIG1vZHVsZS5leHBvcnRzID0gbQppZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIGRlZmluZShmdW5jdGlvbigpIHtyZXR1cm4gbX0pCgo7OzsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:12:05 GMT",
                    "Content-Length": "26961",
                    "Date": "Fri, 07 Nov 2014 16:12:07 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}