{
    "url": "http://localhost:9999/peachananr/onepage-scroll/Demo/jquery.onepage-scroll.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.hash</b> and written to <b>history.pushState()</b> via the following statements:<ul><li>init_index =  window.location.hash.replace(\"#\", \"\")</li><li>var href = window.location.href.substr(0,window.location.href.indexOf('#')) + \"#\" + (init_index);</li><li>history.pushState( {}, document.title, href );</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/peachananr/onepage-scroll/Demo/jquery.onepage-scroll.js",
                "path": "/peachananr/onepage-scroll/Demo/jquery.onepage-scroll.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9wZWFjaGFuYW5yL29uZXBhZ2Utc2Nyb2xsL0RlbW8vanF1ZXJ5Lm9uZXBhZ2Utc2Nyb2xsLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTU2NTcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6MjE6MTcgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjIxOjE3IEdNVA0KDQovKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBqcXVlcnktb25lcGFnZS1zY3JvbGwuanMgdjEuMy4xCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIENvcHlyaWdodCAyMDEzIFBldGUgUm9qd29uZ3N1cml5YS4KICogaHR0cDovL3d3dy50aGVwZXRlZGVzaWduLmNvbQogKgogKiBDcmVhdGUgYW4gQXBwbGUtbGlrZSB3ZWJzaXRlIHRoYXQgbGV0IHVzZXIgc2Nyb2xsCiAqIG9uZSBwYWdlIGF0IGEgdGltZQogKgogKiBDcmVkaXQ6IEVpa2UgU2VuZCBmb3IgdGhlIGF3ZXNvbWUgc3dpcGUgZXZlbnQKICogaHR0cHM6Ly9naXRodWIuY29tL3BlYWNoYW5hbnIvb25lcGFnZS1zY3JvbGwKICoKICogTGljZW5zZTogR1BMIHYzCiAqCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KCiFmdW5jdGlvbigkKXsKCiAgdmFyIGRlZmF1bHRzID0gewogICAgc2VjdGlvbkNvbnRhaW5lcjogInNlY3Rpb24iLAogICAgZWFzaW5nOiAiZWFzZSIsCiAgICBhbmltYXRpb25UaW1lOiAxMDAwLAogICAgcGFnaW5hdGlvbjogdHJ1ZSwKICAgIHVwZGF0ZVVSTDogZmFsc2UsCiAgICBrZXlib2FyZDogdHJ1ZSwKICAgIGJlZm9yZU1vdmU6IG51bGwsCiAgICBhZnRlck1vdmU6IG51bGwsCiAgICBsb29wOiB0cnVlLAogICAgcmVzcG9uc2l2ZUZhbGxiYWNrOiBmYWxzZSwKICAgIGRpcmVjdGlvbiA6ICd2ZXJ0aWNhbCcKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgLyogIENyZWRpdDogRWlrZSBTZW5kIGZvciB0aGUgYXdlc29tZSBzd2lwZSBldmVudCAqLwogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgJC5mbi5zd2lwZUV2ZW50cyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgc3RhcnRYLAogICAgICAgICAgICBzdGFydFksCiAgICAgICAgICAgICR0aGlzID0gJCh0aGlzKTsKCiAgICAgICAgJHRoaXMuYmluZCgndG91Y2hzdGFydCcsIHRvdWNoc3RhcnQpOwoKICAgICAgICBmdW5jdGlvbiB0b3VjaHN0YXJ0KGV2ZW50KSB7CiAgICAgICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlczsKICAgICAgICAgIGlmICh0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHN0YXJ0WCA9IHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgICAgIHN0YXJ0WSA9IHRvdWNoZXNbMF0ucGFnZVk7CiAgICAgICAgICAgICR0aGlzLmJpbmQoJ3RvdWNobW92ZScsIHRvdWNobW92ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0b3VjaG1vdmUoZXZlbnQpIHsKICAgICAgICAgIHZhciB0b3VjaGVzID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzOwogICAgICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIGRlbHRhWCA9IHN0YXJ0WCAtIHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgICAgIHZhciBkZWx0YVkgPSBzdGFydFkgLSB0b3VjaGVzWzBdLnBhZ2VZOwoKICAgICAgICAgICAgaWYgKGRlbHRhWCA+PSA1MCkgewogICAgICAgICAgICAgICR0aGlzLnRyaWdnZXIoInN3aXBlTGVmdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWx0YVggPD0gLTUwKSB7CiAgICAgICAgICAgICAgJHRoaXMudHJpZ2dlcigic3dpcGVSaWdodCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWx0YVkgPj0gNTApIHsKICAgICAgICAgICAgICAkdGhpcy50cmlnZ2VyKCJzd2lwZVVwIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlbHRhWSA8PSAtNTApIHsKICAgICAgICAgICAgICAkdGhpcy50cmlnZ2VyKCJzd2lwZURvd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGVsdGFYKSA+PSA1MCB8fCBNYXRoLmFicyhkZWx0YVkpID49IDUwKSB7CiAgICAgICAgICAgICAgJHRoaXMudW5iaW5kKCd0b3VjaG1vdmUnLCB0b3VjaG1vdmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgfSk7CiAgICB9OwoKCiAgJC5mbi5vbmVwYWdlX3Njcm9sbCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIGRlZmF1bHRzLCBvcHRpb25zKSwKICAgICAgICBlbCA9ICQodGhpcyksCiAgICAgICAgc2VjdGlvbnMgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIpCiAgICAgICAgdG90YWwgPSBzZWN0aW9ucy5sZW5ndGgsCiAgICAgICAgc3RhdHVzID0gIm9mZiIsCiAgICAgICAgdG9wUG9zID0gMCwKICAgICAgICBsZWZ0UG9zID0gMCwKICAgICAgICBsYXN0QW5pbWF0aW9uID0gMCwKICAgICAgICBxdWlldFBlcmlvZCA9IDUwMCwKICAgICAgICBwYWdpbmF0aW9uTGlzdCA9ICIiOwoKICAgICQuZm4udHJhbnNmb3JtUGFnZSA9IGZ1bmN0aW9uKHNldHRpbmdzLCBwb3MsIGluZGV4KSB7CiAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuYmVmb3JlTW92ZSA9PSAnZnVuY3Rpb24nKSBzZXR0aW5ncy5iZWZvcmVNb3ZlKGluZGV4KTsKCiAgICAgIC8vIEp1c3QgYSBzaW1wbGUgZWRpdCB0aGF0IG1ha2VzIHVzZSBvZiBtb2Rlcm5penIgdG8gZGV0ZWN0IGFuIElFOCBicm93c2VyIGFuZCBjaGFuZ2VzIHRoZSB0cmFuc2Zvcm0gbWV0aG9kIGludG8KICAgICAgLy8gYW4gdG9wIGFuaW1hdGUgc28gSUU4IHVzZXJzIGNhbiBhbHNvIHVzZSB0aGlzIHNjcmlwdC4KICAgICAgaWYoJCgnaHRtbCcpLmhhc0NsYXNzKCdpZTgnKSl7CiAgICAgICAgaWYgKHNldHRpbmdzLmRpcmVjdGlvbiA9PSAnaG9yaXpvbnRhbCcpIHsKICAgICAgICAgIHZhciB0b3Bwb3MgPSAoZWwud2lkdGgoKS8xMDApKnBvczsKICAgICAgICAgICQodGhpcykuYW5pbWF0ZSh7bGVmdDogdG9wcG9zKydweCd9LHNldHRpbmdzLmFuaW1hdGlvblRpbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdG9wcG9zID0gKGVsLmhlaWdodCgpLzEwMCkqcG9zOwogICAgICAgICAgJCh0aGlzKS5hbmltYXRlKHt0b3A6IHRvcHBvcysncHgnfSxzZXR0aW5ncy5hbmltYXRpb25UaW1lKTsKICAgICAgICB9CiAgICAgIH0gZWxzZXsKICAgICAgICAkKHRoaXMpLmNzcyh7CiAgICAgICAgICAiLXdlYmtpdC10cmFuc2Zvcm0iOiAoIHNldHRpbmdzLmRpcmVjdGlvbiA9PSAnaG9yaXpvbnRhbCcgKSA/ICJ0cmFuc2xhdGUzZCgiICsgcG9zICsgIiUsIDAsIDApIiA6ICJ0cmFuc2xhdGUzZCgwLCAiICsgcG9zICsgIiUsIDApIiwKICAgICAgICAgIi13ZWJraXQtdHJhbnNpdGlvbiI6ICJhbGwgIiArIHNldHRpbmdzLmFuaW1hdGlvblRpbWUgKyAibXMgIiArIHNldHRpbmdzLmVhc2luZywKICAgICAgICAgIi1tb3otdHJhbnNmb3JtIjogKCBzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnICkgPyAidHJhbnNsYXRlM2QoIiArIHBvcyArICIlLCAwLCAwKSIgOiAidHJhbnNsYXRlM2QoMCwgIiArIHBvcyArICIlLCAwKSIsCiAgICAgICAgICItbW96LXRyYW5zaXRpb24iOiAiYWxsICIgKyBzZXR0aW5ncy5hbmltYXRpb25UaW1lICsgIm1zICIgKyBzZXR0aW5ncy5lYXNpbmcsCiAgICAgICAgICItbXMtdHJhbnNmb3JtIjogKCBzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnICkgPyAidHJhbnNsYXRlM2QoIiArIHBvcyArICIlLCAwLCAwKSIgOiAidHJhbnNsYXRlM2QoMCwgIiArIHBvcyArICIlLCAwKSIsCiAgICAgICAgICItbXMtdHJhbnNpdGlvbiI6ICJhbGwgIiArIHNldHRpbmdzLmFuaW1hdGlvblRpbWUgKyAibXMgIiArIHNldHRpbmdzLmVhc2luZywKICAgICAgICAgInRyYW5zZm9ybSI6ICggc2V0dGluZ3MuZGlyZWN0aW9uID09ICdob3Jpem9udGFsJyApID8gInRyYW5zbGF0ZTNkKCIgKyBwb3MgKyAiJSwgMCwgMCkiIDogInRyYW5zbGF0ZTNkKDAsICIgKyBwb3MgKyAiJSwgMCkiLAogICAgICAgICAidHJhbnNpdGlvbiI6ICJhbGwgIiArIHNldHRpbmdzLmFuaW1hdGlvblRpbWUgKyAibXMgIiArIHNldHRpbmdzLmVhc2luZwogICAgICAgIH0pOwogICAgICB9CiAgICAgICQodGhpcykub25lKCd3ZWJraXRUcmFuc2l0aW9uRW5kIG90cmFuc2l0aW9uZW5kIG9UcmFuc2l0aW9uRW5kIG1zVHJhbnNpdGlvbkVuZCB0cmFuc2l0aW9uZW5kJywgZnVuY3Rpb24oZSkgewogICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuYWZ0ZXJNb3ZlID09ICdmdW5jdGlvbicpIHNldHRpbmdzLmFmdGVyTW92ZShpbmRleCk7CiAgICAgIH0pOwogICAgfQoKICAgICQuZm4ubW92ZURvd24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsID0gJCh0aGlzKQogICAgICBpbmRleCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArIi5hY3RpdmUiKS5kYXRhKCJpbmRleCIpOwogICAgICBjdXJyZW50ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PSciICsgaW5kZXggKyAiJ10iKTsKICAgICAgbmV4dCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nIiArIChpbmRleCArIDEpICsgIiddIik7CiAgICAgIGlmKG5leHQubGVuZ3RoIDwgMSkgewogICAgICAgIGlmIChzZXR0aW5ncy5sb29wID09IHRydWUpIHsKICAgICAgICAgIHBvcyA9IDA7CiAgICAgICAgICBuZXh0ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PScxJ10iKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgfWVsc2UgewogICAgICAgIHBvcyA9IChpbmRleCAqIDEwMCkgKiAtMTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHNldHRpbmdzLmJlZm9yZU1vdmUgPT0gJ2Z1bmN0aW9uJykgc2V0dGluZ3MuYmVmb3JlTW92ZSggbmV4dC5kYXRhKCJpbmRleCIpKTsKICAgICAgY3VycmVudC5yZW1vdmVDbGFzcygiYWN0aXZlIikKICAgICAgbmV4dC5hZGRDbGFzcygiYWN0aXZlIik7CiAgICAgIGlmKHNldHRpbmdzLnBhZ2luYXRpb24gPT0gdHJ1ZSkgewogICAgICAgICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JyIgKyBpbmRleCArICInXSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsKICAgICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgbmV4dC5kYXRhKCJpbmRleCIpICsgIiddIikuYWRkQ2xhc3MoImFjdGl2ZSIpOwogICAgICB9CgogICAgICAkKCJib2R5IilbMF0uY2xhc3NOYW1lID0gJCgiYm9keSIpWzBdLmNsYXNzTmFtZS5yZXBsYWNlKC9cYnZpZXdpbmctcGFnZS1cZC4qP1xiL2csICcnKTsKICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtIituZXh0LmRhdGEoImluZGV4IikpCgogICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUgJiYgc2V0dGluZ3MudXBkYXRlVVJMID09IHRydWUpIHsKICAgICAgICB2YXIgaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnN1YnN0cigwLHdpbmRvdy5sb2NhdGlvbi5ocmVmLmluZGV4T2YoJyMnKSkgKyAiIyIgKyAoaW5kZXggKyAxKTsKICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZSgge30sIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CiAgICAgIH0KICAgICAgZWwudHJhbnNmb3JtUGFnZShzZXR0aW5ncywgcG9zLCBuZXh0LmRhdGEoImluZGV4IikpOwogICAgfQoKICAgICQuZm4ubW92ZVVwID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgaW5kZXggPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyIuYWN0aXZlIikuZGF0YSgiaW5kZXgiKTsKICAgICAgY3VycmVudCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nIiArIGluZGV4ICsgIiddIik7CiAgICAgIG5leHQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIgKyAoaW5kZXggLSAxKSArICInXSIpOwoKICAgICAgaWYobmV4dC5sZW5ndGggPCAxKSB7CiAgICAgICAgaWYgKHNldHRpbmdzLmxvb3AgPT0gdHJ1ZSkgewogICAgICAgICAgcG9zID0gKCh0b3RhbCAtIDEpICogMTAwKSAqIC0xOwogICAgICAgICAgbmV4dCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nIit0b3RhbCsiJ10iKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgIH1lbHNlIHsKICAgICAgICBwb3MgPSAoKG5leHQuZGF0YSgiaW5kZXgiKSAtIDEpICogMTAwKSAqIC0xOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuYmVmb3JlTW92ZSA9PSAnZnVuY3Rpb24nKSBzZXR0aW5ncy5iZWZvcmVNb3ZlKG5leHQuZGF0YSgiaW5kZXgiKSk7CiAgICAgIGN1cnJlbnQucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpCiAgICAgIG5leHQuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgIGlmKHNldHRpbmdzLnBhZ2luYXRpb24gPT0gdHJ1ZSkgewogICAgICAgICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JyIgKyBpbmRleCArICInXSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsKICAgICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgbmV4dC5kYXRhKCJpbmRleCIpICsgIiddIikuYWRkQ2xhc3MoImFjdGl2ZSIpOwogICAgICB9CiAgICAgICQoImJvZHkiKVswXS5jbGFzc05hbWUgPSAkKCJib2R5IilbMF0uY2xhc3NOYW1lLnJlcGxhY2UoL1xidmlld2luZy1wYWdlLVxkLio/XGIvZywgJycpOwogICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInZpZXdpbmctcGFnZS0iK25leHQuZGF0YSgiaW5kZXgiKSkKCiAgICAgIGlmIChoaXN0b3J5LnJlcGxhY2VTdGF0ZSAmJiBzZXR0aW5ncy51cGRhdGVVUkwgPT0gdHJ1ZSkgewogICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsd2luZG93LmxvY2F0aW9uLmhyZWYuaW5kZXhPZignIycpKSArICIjIiArIChpbmRleCAtIDEpOwogICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKCB7fSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKICAgICAgfQogICAgICBlbC50cmFuc2Zvcm1QYWdlKHNldHRpbmdzLCBwb3MsIG5leHQuZGF0YSgiaW5kZXgiKSk7CiAgICB9CgogICAgJC5mbi5tb3ZlVG8gPSBmdW5jdGlvbihwYWdlX2luZGV4KSB7CiAgICAgIGN1cnJlbnQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiLmFjdGl2ZSIpCiAgICAgIG5leHQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIgKyAocGFnZV9pbmRleCkgKyAiJ10iKTsKICAgICAgaWYobmV4dC5sZW5ndGggPiAwKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5iZWZvcmVNb3ZlID09ICdmdW5jdGlvbicpIHNldHRpbmdzLmJlZm9yZU1vdmUobmV4dC5kYXRhKCJpbmRleCIpKTsKICAgICAgICBjdXJyZW50LnJlbW92ZUNsYXNzKCJhY3RpdmUiKQogICAgICAgIG5leHQuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgICAgJCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiBsaSBhIiArICIuYWN0aXZlIikucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpOwogICAgICAgICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JyIgKyAocGFnZV9pbmRleCkgKyAiJ10iKS5hZGRDbGFzcygiYWN0aXZlIik7CiAgICAgICAgJCgiYm9keSIpWzBdLmNsYXNzTmFtZSA9ICQoImJvZHkiKVswXS5jbGFzc05hbWUucmVwbGFjZSgvXGJ2aWV3aW5nLXBhZ2UtXGQuKj9cYi9nLCAnJyk7CiAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtIituZXh0LmRhdGEoImluZGV4IikpCgogICAgICAgIHBvcyA9ICgocGFnZV9pbmRleCAtIDEpICogMTAwKSAqIC0xOwoKICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUgJiYgc2V0dGluZ3MudXBkYXRlVVJMID09IHRydWUpIHsKICAgICAgICAgICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zdWJzdHIoMCx3aW5kb3cubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJykpICsgIiMiICsgKHBhZ2VfaW5kZXggLSAxKTsKICAgICAgICAgICAgaGlzdG9yeS5wdXNoU3RhdGUoIHt9LCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwogICAgICAgIH0KICAgICAgICBlbC50cmFuc2Zvcm1QYWdlKHNldHRpbmdzLCBwb3MsIHBhZ2VfaW5kZXgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVzcG9uc2l2ZSgpIHsKICAgICAgLy9zdGFydCBtb2RpZmljYXRpb24KICAgICAgdmFyIHZhbEZvclRlc3QgPSBmYWxzZTsKICAgICAgdmFyIHR5cGVPZlJGID0gdHlwZW9mIHNldHRpbmdzLnJlc3BvbnNpdmVGYWxsYmFjawoKICAgICAgaWYodHlwZU9mUkYgPT0gIm51bWJlciIpewogICAgICAgIHZhbEZvclRlc3QgPSAkKHdpbmRvdykud2lkdGgoKSA8IHNldHRpbmdzLnJlc3BvbnNpdmVGYWxsYmFjazsKICAgICAgfQogICAgICBpZih0eXBlT2ZSRiA9PSAiYm9vbGVhbiIpewogICAgICAgIHZhbEZvclRlc3QgPSBzZXR0aW5ncy5yZXNwb25zaXZlRmFsbGJhY2s7CiAgICAgIH0KICAgICAgaWYodHlwZU9mUkYgPT0gImZ1bmN0aW9uIil7CiAgICAgICAgdmFsRnVuY3Rpb24gPSBzZXR0aW5ncy5yZXNwb25zaXZlRmFsbGJhY2soKTsKICAgICAgICB2YWxGb3JUZXN0ID0gdmFsRnVuY3Rpb247CiAgICAgICAgdHlwZU9GdiA9IHR5cGVvZiB2YWxGb3JUZXN0OwogICAgICAgIGlmKHR5cGVPRnYgPT0gIm51bWJlciIpewogICAgICAgICAgdmFsRm9yVGVzdCA9ICQod2luZG93KS53aWR0aCgpIDwgdmFsRnVuY3Rpb247CiAgICAgICAgfQogICAgICB9CgogICAgICAvL2VuZCBtb2RpZmljYXRpb24KICAgICAgaWYgKHZhbEZvclRlc3QpIHsKICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIik7CiAgICAgICAgJChkb2N1bWVudCkudW5iaW5kKCdtb3VzZXdoZWVsIERPTU1vdXNlU2Nyb2xsIE1vek1vdXNlUGl4ZWxTY3JvbGwnKTsKICAgICAgICBlbC5zd2lwZUV2ZW50cygpLnVuYmluZCgic3dpcGVEb3duIHN3aXBlVXAiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZigkKCJib2R5IikuaGFzQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIikpIHsKICAgICAgICAgICQoImJvZHkiKS5yZW1vdmVDbGFzcygiZGlzYWJsZWQtb25lcGFnZS1zY3JvbGwiKTsKICAgICAgICAgICQoImh0bWwsIGJvZHksIC53cmFwcGVyIikuYW5pbWF0ZSh7IHNjcm9sbFRvcDogMCB9LCAiZmFzdCIpOwogICAgICAgIH0KCgogICAgICAgIGVsLnN3aXBlRXZlbnRzKCkuYmluZCgic3dpcGVEb3duIiwgIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgIGlmICghJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZWwubW92ZVVwKCk7CiAgICAgICAgfSkuYmluZCgic3dpcGVVcCIsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgIGlmICghJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZWwubW92ZURvd24oKTsKICAgICAgICB9KTsKCiAgICAgICAgJChkb2N1bWVudCkuYmluZCgnbW91c2V3aGVlbCBET01Nb3VzZVNjcm9sbCBNb3pNb3VzZVBpeGVsU2Nyb2xsJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB2YXIgZGVsdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGEgfHwgLWV2ZW50Lm9yaWdpbmFsRXZlbnQuZGV0YWlsOwogICAgICAgICAgaW5pdF9zY3JvbGwoZXZlbnQsIGRlbHRhKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiBpbml0X3Njcm9sbChldmVudCwgZGVsdGEpIHsKICAgICAgICBkZWx0YU9mSW50ZXJlc3QgPSBkZWx0YTsKICAgICAgICB2YXIgdGltZU5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIC8vIENhbmNlbCBzY3JvbGwgaWYgY3VycmVudGx5IGFuaW1hdGluZyBvciB3aXRoaW4gcXVpZXQgcGVyaW9kCiAgICAgICAgaWYodGltZU5vdyAtIGxhc3RBbmltYXRpb24gPCBxdWlldFBlcmlvZCArIHNldHRpbmdzLmFuaW1hdGlvblRpbWUpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRlbHRhT2ZJbnRlcmVzdCA8IDApIHsKICAgICAgICAgIGVsLm1vdmVEb3duKCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWwubW92ZVVwKCkKICAgICAgICB9CiAgICAgICAgbGFzdEFuaW1hdGlvbiA9IHRpbWVOb3c7CiAgICB9CgogICAgLy8gUHJlcGFyZSBldmVyeXRoaW5nIGJlZm9yZSBiaW5kaW5nIHdoZWVsIHNjcm9sbAoKICAgIGVsLmFkZENsYXNzKCJvbmVwYWdlLXdyYXBwZXIiKS5jc3MoInBvc2l0aW9uIiwicmVsYXRpdmUiKTsKICAgICQuZWFjaCggc2VjdGlvbnMsIGZ1bmN0aW9uKGkpIHsKICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgIHRvcDogdG9wUG9zICsgIiUiCiAgICAgIH0pLmFkZENsYXNzKCJzZWN0aW9uIikuYXR0cigiZGF0YS1pbmRleCIsIGkrMSk7CgoKICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgIGxlZnQ6ICggc2V0dGluZ3MuZGlyZWN0aW9uID09ICdob3Jpem9udGFsJyApCiAgICAgICAgICA/IGxlZnRQb3MgKyAiJSIKICAgICAgICAgIDogMCwKICAgICAgICB0b3A6ICggc2V0dGluZ3MuZGlyZWN0aW9uID09ICd2ZXJ0aWNhbCcgfHwgc2V0dGluZ3MuZGlyZWN0aW9uICE9ICdob3Jpem9udGFsJyApCiAgICAgICAgICA/IHRvcFBvcyArICIlIgogICAgICAgICAgOiAwCiAgICAgIH0pOwoKICAgICAgaWYgKHNldHRpbmdzLmRpcmVjdGlvbiA9PSAnaG9yaXpvbnRhbCcpCiAgICAgICAgbGVmdFBvcyA9IGxlZnRQb3MgKyAxMDA7CiAgICAgIGVsc2UKICAgICAgICB0b3BQb3MgPSB0b3BQb3MgKyAxMDA7CgoKICAgICAgaWYoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSB7CiAgICAgICAgcGFnaW5hdGlvbkxpc3QgKz0gIjxsaT48YSBkYXRhLWluZGV4PSciKyhpKzEpKyInIGhyZWY9JyMiICsgKGkrMSkgKyAiJz48L2E+PC9saT4iCiAgICAgIH0KICAgIH0pOwoKICAgIGVsLnN3aXBlRXZlbnRzKCkuYmluZCgic3dpcGVEb3duIiwgIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaWYgKCEkKCJib2R5IikuaGFzQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIikpIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGVsLm1vdmVVcCgpOwogICAgfSkuYmluZCgic3dpcGVVcCIsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaWYgKCEkKCJib2R5IikuaGFzQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIikpIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGVsLm1vdmVEb3duKCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgUGFnaW5hdGlvbiBhbmQgRGlzcGxheSBUaGVtCiAgICBpZiAoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSB7CiAgICAgIGlmICgkKCd1bC5vbmVwYWdlLXBhZ2luYXRpb24nKS5sZW5ndGggPCAxKSAkKCI8dWwgY2xhc3M9J29uZXBhZ2UtcGFnaW5hdGlvbic+PC91bD4iKS5wcmVwZW5kVG8oImJvZHkiKTsKCiAgICAgIGlmKCBzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnICkgewogICAgICAgIHBvc0xlZnQgPSAoZWwuZmluZCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiIpLndpZHRoKCkgLyAyKSAqIC0xOwogICAgICAgIGVsLmZpbmQoIi5vbmVwYWdlLXBhZ2luYXRpb24iKS5jc3MoIm1hcmdpbi1sZWZ0IiwgcG9zTGVmdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcG9zVG9wID0gKGVsLmZpbmQoIi5vbmVwYWdlLXBhZ2luYXRpb24iKS5oZWlnaHQoKSAvIDIpICogLTE7CiAgICAgICAgZWwuZmluZCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiIpLmNzcygibWFyZ2luLXRvcCIsIHBvc1RvcCk7CiAgICAgIH0KICAgICAgJCgndWwub25lcGFnZS1wYWdpbmF0aW9uJykuaHRtbChwYWdpbmF0aW9uTGlzdCk7CiAgICB9CgogICAgaWYod2luZG93LmxvY2F0aW9uLmhhc2ggIT0gIiIgJiYgd2luZG93LmxvY2F0aW9uLmhhc2ggIT0gIiMxIikgewogICAgICBpbml0X2luZGV4ID0gIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoIiMiLCAiIikKCiAgICAgIGlmIChwYXJzZUludChpbml0X2luZGV4KSA8PSB0b3RhbCAmJiBwYXJzZUludChpbml0X2luZGV4KSA+IDApIHsKICAgICAgICAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIgKyBpbml0X2luZGV4ICsgIiddIikuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtIisgaW5pdF9pbmRleCkKICAgICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JyIgKyBpbml0X2luZGV4ICsgIiddIikuYWRkQ2xhc3MoImFjdGl2ZSIpOwoKICAgICAgICBuZXh0ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PSciICsgKGluaXRfaW5kZXgpICsgIiddIik7CiAgICAgICAgaWYobmV4dCkgewogICAgICAgICAgbmV4dC5hZGRDbGFzcygiYWN0aXZlIikKICAgICAgICAgIGlmKHNldHRpbmdzLnBhZ2luYXRpb24gPT0gdHJ1ZSkgJCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiBsaSBhIiArICJbZGF0YS1pbmRleD0nIiArIChpbml0X2luZGV4KSArICInXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKICAgICAgICAgICQoImJvZHkiKVswXS5jbGFzc05hbWUgPSAkKCJib2R5IilbMF0uY2xhc3NOYW1lLnJlcGxhY2UoL1xidmlld2luZy1wYWdlLVxkLio/XGIvZywgJycpOwogICAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtIituZXh0LmRhdGEoImluZGV4IikpCiAgICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUgJiYgc2V0dGluZ3MudXBkYXRlVVJMID09IHRydWUpIHsKICAgICAgICAgICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zdWJzdHIoMCx3aW5kb3cubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJykpICsgIiMiICsgKGluaXRfaW5kZXgpOwogICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZSgge30sIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBvcyA9ICgoaW5pdF9pbmRleCAtIDEpICogMTAwKSAqIC0xOwogICAgICAgIGVsLnRyYW5zZm9ybVBhZ2Uoc2V0dGluZ3MsIHBvcywgaW5pdF9pbmRleCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PScxJ10iKS5hZGRDbGFzcygiYWN0aXZlIikKICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInZpZXdpbmctcGFnZS0xIikKICAgICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JzEnXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKICAgICAgfQogICAgfWVsc2V7CiAgICAgICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nMSddIikuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgICQoImJvZHkiKS5hZGRDbGFzcygidmlld2luZy1wYWdlLTEiKQogICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JzEnXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKICAgIH0KCiAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpICB7CiAgICAgICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIpLmNsaWNrKGZ1bmN0aW9uICgpewogICAgICAgIHZhciBwYWdlX2luZGV4ID0gJCh0aGlzKS5kYXRhKCJpbmRleCIpOwogICAgICAgIGVsLm1vdmVUbyhwYWdlX2luZGV4KTsKICAgICAgfSk7CiAgICB9CgoKICAgICQoZG9jdW1lbnQpLmJpbmQoJ21vdXNld2hlZWwgRE9NTW91c2VTY3JvbGwgTW96TW91c2VQaXhlbFNjcm9sbCcsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHZhciBkZWx0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQud2hlZWxEZWx0YSB8fCAtZXZlbnQub3JpZ2luYWxFdmVudC5kZXRhaWw7CiAgICAgIGlmKCEkKCJib2R5IikuaGFzQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIikpIGluaXRfc2Nyb2xsKGV2ZW50LCBkZWx0YSk7CiAgICB9KTsKCgogICAgaWYoc2V0dGluZ3MucmVzcG9uc2l2ZUZhbGxiYWNrICE9IGZhbHNlKSB7CiAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24oKSB7CiAgICAgICAgcmVzcG9uc2l2ZSgpOwogICAgICB9KTsKCiAgICAgIHJlc3BvbnNpdmUoKTsKICAgIH0KCiAgICBpZihzZXR0aW5ncy5rZXlib2FyZCA9PSB0cnVlKSB7CiAgICAgICQoZG9jdW1lbnQpLmtleWRvd24oZnVuY3Rpb24oZSkgewogICAgICAgIHZhciB0YWcgPSBlLnRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmICghJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSB7CiAgICAgICAgICBzd2l0Y2goZS53aGljaCkgewogICAgICAgICAgICBjYXNlIDM4OgogICAgICAgICAgICAgIGlmICh0YWcgIT0gJ2lucHV0JyAmJiB0YWcgIT0gJ3RleHRhcmVhJykgZWwubW92ZVVwKCkKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNDA6CiAgICAgICAgICAgICAgaWYgKHRhZyAhPSAnaW5wdXQnICYmIHRhZyAhPSAndGV4dGFyZWEnKSBlbC5tb3ZlRG93bigpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDMyOiAvL3NwYWNlYmFyCiAgICAgICAgICAgICAgaWYgKHRhZyAhPSAnaW5wdXQnICYmIHRhZyAhPSAndGV4dGFyZWEnKSBlbC5tb3ZlRG93bigpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDMzOiAvL3BhZ2VnIHVwCiAgICAgICAgICAgICAgaWYgKHRhZyAhPSAnaW5wdXQnICYmIHRhZyAhPSAndGV4dGFyZWEnKSBlbC5tb3ZlVXAoKQogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzNDogLy9wYWdlIGR3bgogICAgICAgICAgICAgIGlmICh0YWcgIT0gJ2lucHV0JyAmJiB0YWcgIT0gJ3RleHRhcmVhJykgZWwubW92ZURvd24oKQogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzNjogLy9ob21lCiAgICAgICAgICAgICAgZWwubW92ZVRvKDEpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzNTogLy9lbmQKICAgICAgICAgICAgICBlbC5tb3ZlVG8odG90YWwpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KCgp9KHdpbmRvdy5qUXVlcnkpOwo=",
                "body": "LyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICoganF1ZXJ5LW9uZXBhZ2Utc2Nyb2xsLmpzIHYxLjMuMQogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogKiBDb3B5cmlnaHQgMjAxMyBQZXRlIFJvandvbmdzdXJpeWEuCiAqIGh0dHA6Ly93d3cudGhlcGV0ZWRlc2lnbi5jb20KICoKICogQ3JlYXRlIGFuIEFwcGxlLWxpa2Ugd2Vic2l0ZSB0aGF0IGxldCB1c2VyIHNjcm9sbAogKiBvbmUgcGFnZSBhdCBhIHRpbWUKICoKICogQ3JlZGl0OiBFaWtlIFNlbmQgZm9yIHRoZSBhd2Vzb21lIHN3aXBlIGV2ZW50CiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9wZWFjaGFuYW5yL29uZXBhZ2Utc2Nyb2xsCiAqCiAqIExpY2Vuc2U6IEdQTCB2MwogKgogKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCgohZnVuY3Rpb24oJCl7CgogIHZhciBkZWZhdWx0cyA9IHsKICAgIHNlY3Rpb25Db250YWluZXI6ICJzZWN0aW9uIiwKICAgIGVhc2luZzogImVhc2UiLAogICAgYW5pbWF0aW9uVGltZTogMTAwMCwKICAgIHBhZ2luYXRpb246IHRydWUsCiAgICB1cGRhdGVVUkw6IGZhbHNlLAogICAga2V5Ym9hcmQ6IHRydWUsCiAgICBiZWZvcmVNb3ZlOiBudWxsLAogICAgYWZ0ZXJNb3ZlOiBudWxsLAogICAgbG9vcDogdHJ1ZSwKICAgIHJlc3BvbnNpdmVGYWxsYmFjazogZmFsc2UsCiAgICBkaXJlY3Rpb24gOiAndmVydGljYWwnCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIC8qICBDcmVkaXQ6IEVpa2UgU2VuZCBmb3IgdGhlIGF3ZXNvbWUgc3dpcGUgZXZlbnQgKi8KICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICQuZm4uc3dpcGVFdmVudHMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHN0YXJ0WCwKICAgICAgICAgICAgc3RhcnRZLAogICAgICAgICAgICAkdGhpcyA9ICQodGhpcyk7CgogICAgICAgICR0aGlzLmJpbmQoJ3RvdWNoc3RhcnQnLCB0b3VjaHN0YXJ0KTsKCiAgICAgICAgZnVuY3Rpb24gdG91Y2hzdGFydChldmVudCkgewogICAgICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXM7CiAgICAgICAgICBpZiAodG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICBzdGFydFggPSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgICBzdGFydFkgPSB0b3VjaGVzWzBdLnBhZ2VZOwogICAgICAgICAgICAkdGhpcy5iaW5kKCd0b3VjaG1vdmUnLCB0b3VjaG1vdmUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdG91Y2htb3ZlKGV2ZW50KSB7CiAgICAgICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlczsKICAgICAgICAgIGlmICh0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBkZWx0YVggPSBzdGFydFggLSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgICB2YXIgZGVsdGFZID0gc3RhcnRZIC0gdG91Y2hlc1swXS5wYWdlWTsKCiAgICAgICAgICAgIGlmIChkZWx0YVggPj0gNTApIHsKICAgICAgICAgICAgICAkdGhpcy50cmlnZ2VyKCJzd2lwZUxlZnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVsdGFYIDw9IC01MCkgewogICAgICAgICAgICAgICR0aGlzLnRyaWdnZXIoInN3aXBlUmlnaHQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVsdGFZID49IDUwKSB7CiAgICAgICAgICAgICAgJHRoaXMudHJpZ2dlcigic3dpcGVVcCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWx0YVkgPD0gLTUwKSB7CiAgICAgICAgICAgICAgJHRoaXMudHJpZ2dlcigic3dpcGVEb3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRlbHRhWCkgPj0gNTAgfHwgTWF0aC5hYnMoZGVsdGFZKSA+PSA1MCkgewogICAgICAgICAgICAgICR0aGlzLnVuYmluZCgndG91Y2htb3ZlJywgdG91Y2htb3ZlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIH0pOwogICAgfTsKCgogICQuZm4ub25lcGFnZV9zY3JvbGwgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgb3B0aW9ucyksCiAgICAgICAgZWwgPSAkKHRoaXMpLAogICAgICAgIHNlY3Rpb25zID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyKQogICAgICAgIHRvdGFsID0gc2VjdGlvbnMubGVuZ3RoLAogICAgICAgIHN0YXR1cyA9ICJvZmYiLAogICAgICAgIHRvcFBvcyA9IDAsCiAgICAgICAgbGVmdFBvcyA9IDAsCiAgICAgICAgbGFzdEFuaW1hdGlvbiA9IDAsCiAgICAgICAgcXVpZXRQZXJpb2QgPSA1MDAsCiAgICAgICAgcGFnaW5hdGlvbkxpc3QgPSAiIjsKCiAgICAkLmZuLnRyYW5zZm9ybVBhZ2UgPSBmdW5jdGlvbihzZXR0aW5ncywgcG9zLCBpbmRleCkgewogICAgICBpZiAodHlwZW9mIHNldHRpbmdzLmJlZm9yZU1vdmUgPT0gJ2Z1bmN0aW9uJykgc2V0dGluZ3MuYmVmb3JlTW92ZShpbmRleCk7CgogICAgICAvLyBKdXN0IGEgc2ltcGxlIGVkaXQgdGhhdCBtYWtlcyB1c2Ugb2YgbW9kZXJuaXpyIHRvIGRldGVjdCBhbiBJRTggYnJvd3NlciBhbmQgY2hhbmdlcyB0aGUgdHJhbnNmb3JtIG1ldGhvZCBpbnRvCiAgICAgIC8vIGFuIHRvcCBhbmltYXRlIHNvIElFOCB1c2VycyBjYW4gYWxzbyB1c2UgdGhpcyBzY3JpcHQuCiAgICAgIGlmKCQoJ2h0bWwnKS5oYXNDbGFzcygnaWU4JykpewogICAgICAgIGlmIChzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnKSB7CiAgICAgICAgICB2YXIgdG9wcG9zID0gKGVsLndpZHRoKCkvMTAwKSpwb3M7CiAgICAgICAgICAkKHRoaXMpLmFuaW1hdGUoe2xlZnQ6IHRvcHBvcysncHgnfSxzZXR0aW5ncy5hbmltYXRpb25UaW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHRvcHBvcyA9IChlbC5oZWlnaHQoKS8xMDApKnBvczsKICAgICAgICAgICQodGhpcykuYW5pbWF0ZSh7dG9wOiB0b3Bwb3MrJ3B4J30sc2V0dGluZ3MuYW5pbWF0aW9uVGltZSk7CiAgICAgICAgfQogICAgICB9IGVsc2V7CiAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgIi13ZWJraXQtdHJhbnNmb3JtIjogKCBzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnICkgPyAidHJhbnNsYXRlM2QoIiArIHBvcyArICIlLCAwLCAwKSIgOiAidHJhbnNsYXRlM2QoMCwgIiArIHBvcyArICIlLCAwKSIsCiAgICAgICAgICItd2Via2l0LXRyYW5zaXRpb24iOiAiYWxsICIgKyBzZXR0aW5ncy5hbmltYXRpb25UaW1lICsgIm1zICIgKyBzZXR0aW5ncy5lYXNpbmcsCiAgICAgICAgICItbW96LXRyYW5zZm9ybSI6ICggc2V0dGluZ3MuZGlyZWN0aW9uID09ICdob3Jpem9udGFsJyApID8gInRyYW5zbGF0ZTNkKCIgKyBwb3MgKyAiJSwgMCwgMCkiIDogInRyYW5zbGF0ZTNkKDAsICIgKyBwb3MgKyAiJSwgMCkiLAogICAgICAgICAiLW1vei10cmFuc2l0aW9uIjogImFsbCAiICsgc2V0dGluZ3MuYW5pbWF0aW9uVGltZSArICJtcyAiICsgc2V0dGluZ3MuZWFzaW5nLAogICAgICAgICAiLW1zLXRyYW5zZm9ybSI6ICggc2V0dGluZ3MuZGlyZWN0aW9uID09ICdob3Jpem9udGFsJyApID8gInRyYW5zbGF0ZTNkKCIgKyBwb3MgKyAiJSwgMCwgMCkiIDogInRyYW5zbGF0ZTNkKDAsICIgKyBwb3MgKyAiJSwgMCkiLAogICAgICAgICAiLW1zLXRyYW5zaXRpb24iOiAiYWxsICIgKyBzZXR0aW5ncy5hbmltYXRpb25UaW1lICsgIm1zICIgKyBzZXR0aW5ncy5lYXNpbmcsCiAgICAgICAgICJ0cmFuc2Zvcm0iOiAoIHNldHRpbmdzLmRpcmVjdGlvbiA9PSAnaG9yaXpvbnRhbCcgKSA/ICJ0cmFuc2xhdGUzZCgiICsgcG9zICsgIiUsIDAsIDApIiA6ICJ0cmFuc2xhdGUzZCgwLCAiICsgcG9zICsgIiUsIDApIiwKICAgICAgICAgInRyYW5zaXRpb24iOiAiYWxsICIgKyBzZXR0aW5ncy5hbmltYXRpb25UaW1lICsgIm1zICIgKyBzZXR0aW5ncy5lYXNpbmcKICAgICAgICB9KTsKICAgICAgfQogICAgICAkKHRoaXMpLm9uZSgnd2Via2l0VHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCBvVHJhbnNpdGlvbkVuZCBtc1RyYW5zaXRpb25FbmQgdHJhbnNpdGlvbmVuZCcsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLmFmdGVyTW92ZSA9PSAnZnVuY3Rpb24nKSBzZXR0aW5ncy5hZnRlck1vdmUoaW5kZXgpOwogICAgICB9KTsKICAgIH0KCiAgICAkLmZuLm1vdmVEb3duID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgaW5kZXggPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyIuYWN0aXZlIikuZGF0YSgiaW5kZXgiKTsKICAgICAgY3VycmVudCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nIiArIGluZGV4ICsgIiddIik7CiAgICAgIG5leHQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIgKyAoaW5kZXggKyAxKSArICInXSIpOwogICAgICBpZihuZXh0Lmxlbmd0aCA8IDEpIHsKICAgICAgICBpZiAoc2V0dGluZ3MubG9vcCA9PSB0cnVlKSB7CiAgICAgICAgICBwb3MgPSAwOwogICAgICAgICAgbmV4dCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nMSddIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgIH1lbHNlIHsKICAgICAgICBwb3MgPSAoaW5kZXggKiAxMDApICogLTE7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5iZWZvcmVNb3ZlID09ICdmdW5jdGlvbicpIHNldHRpbmdzLmJlZm9yZU1vdmUoIG5leHQuZGF0YSgiaW5kZXgiKSk7CiAgICAgIGN1cnJlbnQucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpCiAgICAgIG5leHQuYWRkQ2xhc3MoImFjdGl2ZSIpOwogICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpIHsKICAgICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgaW5kZXggKyAiJ10iKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7CiAgICAgICAgJCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiBsaSBhIiArICJbZGF0YS1pbmRleD0nIiArIG5leHQuZGF0YSgiaW5kZXgiKSArICInXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKICAgICAgfQoKICAgICAgJCgiYm9keSIpWzBdLmNsYXNzTmFtZSA9ICQoImJvZHkiKVswXS5jbGFzc05hbWUucmVwbGFjZSgvXGJ2aWV3aW5nLXBhZ2UtXGQuKj9cYi9nLCAnJyk7CiAgICAgICQoImJvZHkiKS5hZGRDbGFzcygidmlld2luZy1wYWdlLSIrbmV4dC5kYXRhKCJpbmRleCIpKQoKICAgICAgaWYgKGhpc3RvcnkucmVwbGFjZVN0YXRlICYmIHNldHRpbmdzLnVwZGF0ZVVSTCA9PSB0cnVlKSB7CiAgICAgICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zdWJzdHIoMCx3aW5kb3cubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJykpICsgIiMiICsgKGluZGV4ICsgMSk7CiAgICAgICAgaGlzdG9yeS5wdXNoU3RhdGUoIHt9LCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwogICAgICB9CiAgICAgIGVsLnRyYW5zZm9ybVBhZ2Uoc2V0dGluZ3MsIHBvcywgbmV4dC5kYXRhKCJpbmRleCIpKTsKICAgIH0KCiAgICAkLmZuLm1vdmVVcCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWwgPSAkKHRoaXMpCiAgICAgIGluZGV4ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsiLmFjdGl2ZSIpLmRhdGEoImluZGV4Iik7CiAgICAgIGN1cnJlbnQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIgKyBpbmRleCArICInXSIpOwogICAgICBuZXh0ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PSciICsgKGluZGV4IC0gMSkgKyAiJ10iKTsKCiAgICAgIGlmKG5leHQubGVuZ3RoIDwgMSkgewogICAgICAgIGlmIChzZXR0aW5ncy5sb29wID09IHRydWUpIHsKICAgICAgICAgIHBvcyA9ICgodG90YWwgLSAxKSAqIDEwMCkgKiAtMTsKICAgICAgICAgIG5leHQgPSAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JyIrdG90YWwrIiddIik7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICB9ZWxzZSB7CiAgICAgICAgcG9zID0gKChuZXh0LmRhdGEoImluZGV4IikgLSAxKSAqIDEwMCkgKiAtMTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHNldHRpbmdzLmJlZm9yZU1vdmUgPT0gJ2Z1bmN0aW9uJykgc2V0dGluZ3MuYmVmb3JlTW92ZShuZXh0LmRhdGEoImluZGV4IikpOwogICAgICBjdXJyZW50LnJlbW92ZUNsYXNzKCJhY3RpdmUiKQogICAgICBuZXh0LmFkZENsYXNzKCJhY3RpdmUiKQogICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpIHsKICAgICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgaW5kZXggKyAiJ10iKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7CiAgICAgICAgJCgiLm9uZXBhZ2UtcGFnaW5hdGlvbiBsaSBhIiArICJbZGF0YS1pbmRleD0nIiArIG5leHQuZGF0YSgiaW5kZXgiKSArICInXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKICAgICAgfQogICAgICAkKCJib2R5IilbMF0uY2xhc3NOYW1lID0gJCgiYm9keSIpWzBdLmNsYXNzTmFtZS5yZXBsYWNlKC9cYnZpZXdpbmctcGFnZS1cZC4qP1xiL2csICcnKTsKICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtIituZXh0LmRhdGEoImluZGV4IikpCgogICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUgJiYgc2V0dGluZ3MudXBkYXRlVVJMID09IHRydWUpIHsKICAgICAgICB2YXIgaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnN1YnN0cigwLHdpbmRvdy5sb2NhdGlvbi5ocmVmLmluZGV4T2YoJyMnKSkgKyAiIyIgKyAoaW5kZXggLSAxKTsKICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZSgge30sIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CiAgICAgIH0KICAgICAgZWwudHJhbnNmb3JtUGFnZShzZXR0aW5ncywgcG9zLCBuZXh0LmRhdGEoImluZGV4IikpOwogICAgfQoKICAgICQuZm4ubW92ZVRvID0gZnVuY3Rpb24ocGFnZV9pbmRleCkgewogICAgICBjdXJyZW50ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIi5hY3RpdmUiKQogICAgICBuZXh0ID0gJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PSciICsgKHBhZ2VfaW5kZXgpICsgIiddIik7CiAgICAgIGlmKG5leHQubGVuZ3RoID4gMCkgewogICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuYmVmb3JlTW92ZSA9PSAnZnVuY3Rpb24nKSBzZXR0aW5ncy5iZWZvcmVNb3ZlKG5leHQuZGF0YSgiaW5kZXgiKSk7CiAgICAgICAgY3VycmVudC5yZW1vdmVDbGFzcygiYWN0aXZlIikKICAgICAgICBuZXh0LmFkZENsYXNzKCJhY3RpdmUiKQogICAgICAgICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiLmFjdGl2ZSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsKICAgICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgKHBhZ2VfaW5kZXgpICsgIiddIikuYWRkQ2xhc3MoImFjdGl2ZSIpOwogICAgICAgICQoImJvZHkiKVswXS5jbGFzc05hbWUgPSAkKCJib2R5IilbMF0uY2xhc3NOYW1lLnJlcGxhY2UoL1xidmlld2luZy1wYWdlLVxkLio/XGIvZywgJycpOwogICAgICAgICQoImJvZHkiKS5hZGRDbGFzcygidmlld2luZy1wYWdlLSIrbmV4dC5kYXRhKCJpbmRleCIpKQoKICAgICAgICBwb3MgPSAoKHBhZ2VfaW5kZXggLSAxKSAqIDEwMCkgKiAtMTsKCiAgICAgICAgaWYgKGhpc3RvcnkucmVwbGFjZVN0YXRlICYmIHNldHRpbmdzLnVwZGF0ZVVSTCA9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsd2luZG93LmxvY2F0aW9uLmhyZWYuaW5kZXhPZignIycpKSArICIjIiArIChwYWdlX2luZGV4IC0gMSk7CiAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKCB7fSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKICAgICAgICB9CiAgICAgICAgZWwudHJhbnNmb3JtUGFnZShzZXR0aW5ncywgcG9zLCBwYWdlX2luZGV4KTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlc3BvbnNpdmUoKSB7CiAgICAgIC8vc3RhcnQgbW9kaWZpY2F0aW9uCiAgICAgIHZhciB2YWxGb3JUZXN0ID0gZmFsc2U7CiAgICAgIHZhciB0eXBlT2ZSRiA9IHR5cGVvZiBzZXR0aW5ncy5yZXNwb25zaXZlRmFsbGJhY2sKCiAgICAgIGlmKHR5cGVPZlJGID09ICJudW1iZXIiKXsKICAgICAgICB2YWxGb3JUZXN0ID0gJCh3aW5kb3cpLndpZHRoKCkgPCBzZXR0aW5ncy5yZXNwb25zaXZlRmFsbGJhY2s7CiAgICAgIH0KICAgICAgaWYodHlwZU9mUkYgPT0gImJvb2xlYW4iKXsKICAgICAgICB2YWxGb3JUZXN0ID0gc2V0dGluZ3MucmVzcG9uc2l2ZUZhbGxiYWNrOwogICAgICB9CiAgICAgIGlmKHR5cGVPZlJGID09ICJmdW5jdGlvbiIpewogICAgICAgIHZhbEZ1bmN0aW9uID0gc2V0dGluZ3MucmVzcG9uc2l2ZUZhbGxiYWNrKCk7CiAgICAgICAgdmFsRm9yVGVzdCA9IHZhbEZ1bmN0aW9uOwogICAgICAgIHR5cGVPRnYgPSB0eXBlb2YgdmFsRm9yVGVzdDsKICAgICAgICBpZih0eXBlT0Z2ID09ICJudW1iZXIiKXsKICAgICAgICAgIHZhbEZvclRlc3QgPSAkKHdpbmRvdykud2lkdGgoKSA8IHZhbEZ1bmN0aW9uOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy9lbmQgbW9kaWZpY2F0aW9uCiAgICAgIGlmICh2YWxGb3JUZXN0KSB7CiAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpOwogICAgICAgICQoZG9jdW1lbnQpLnVuYmluZCgnbW91c2V3aGVlbCBET01Nb3VzZVNjcm9sbCBNb3pNb3VzZVBpeGVsU2Nyb2xsJyk7CiAgICAgICAgZWwuc3dpcGVFdmVudHMoKS51bmJpbmQoInN3aXBlRG93biBzd2lwZVVwIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYoJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSB7CiAgICAgICAgICAkKCJib2R5IikucmVtb3ZlQ2xhc3MoImRpc2FibGVkLW9uZXBhZ2Utc2Nyb2xsIik7CiAgICAgICAgICAkKCJodG1sLCBib2R5LCAud3JhcHBlciIpLmFuaW1hdGUoeyBzY3JvbGxUb3A6IDAgfSwgImZhc3QiKTsKICAgICAgICB9CgoKICAgICAgICBlbC5zd2lwZUV2ZW50cygpLmJpbmQoInN3aXBlRG93biIsICBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICBpZiAoISQoImJvZHkiKS5oYXNDbGFzcygiZGlzYWJsZWQtb25lcGFnZS1zY3JvbGwiKSkgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGVsLm1vdmVVcCgpOwogICAgICAgIH0pLmJpbmQoInN3aXBlVXAiLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICBpZiAoISQoImJvZHkiKS5oYXNDbGFzcygiZGlzYWJsZWQtb25lcGFnZS1zY3JvbGwiKSkgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGVsLm1vdmVEb3duKCk7CiAgICAgICAgfSk7CgogICAgICAgICQoZG9jdW1lbnQpLmJpbmQoJ21vdXNld2hlZWwgRE9NTW91c2VTY3JvbGwgTW96TW91c2VQaXhlbFNjcm9sbCcsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgdmFyIGRlbHRhID0gZXZlbnQub3JpZ2luYWxFdmVudC53aGVlbERlbHRhIHx8IC1ldmVudC5vcmlnaW5hbEV2ZW50LmRldGFpbDsKICAgICAgICAgIGluaXRfc2Nyb2xsKGV2ZW50LCBkZWx0YSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gaW5pdF9zY3JvbGwoZXZlbnQsIGRlbHRhKSB7CiAgICAgICAgZGVsdGFPZkludGVyZXN0ID0gZGVsdGE7CiAgICAgICAgdmFyIHRpbWVOb3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAvLyBDYW5jZWwgc2Nyb2xsIGlmIGN1cnJlbnRseSBhbmltYXRpbmcgb3Igd2l0aGluIHF1aWV0IHBlcmlvZAogICAgICAgIGlmKHRpbWVOb3cgLSBsYXN0QW5pbWF0aW9uIDwgcXVpZXRQZXJpb2QgKyBzZXR0aW5ncy5hbmltYXRpb25UaW1lKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChkZWx0YU9mSW50ZXJlc3QgPCAwKSB7CiAgICAgICAgICBlbC5tb3ZlRG93bigpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsLm1vdmVVcCgpCiAgICAgICAgfQogICAgICAgIGxhc3RBbmltYXRpb24gPSB0aW1lTm93OwogICAgfQoKICAgIC8vIFByZXBhcmUgZXZlcnl0aGluZyBiZWZvcmUgYmluZGluZyB3aGVlbCBzY3JvbGwKCiAgICBlbC5hZGRDbGFzcygib25lcGFnZS13cmFwcGVyIikuY3NzKCJwb3NpdGlvbiIsInJlbGF0aXZlIik7CiAgICAkLmVhY2goIHNlY3Rpb25zLCBmdW5jdGlvbihpKSB7CiAgICAgICQodGhpcykuY3NzKHsKICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICB0b3A6IHRvcFBvcyArICIlIgogICAgICB9KS5hZGRDbGFzcygic2VjdGlvbiIpLmF0dHIoImRhdGEtaW5kZXgiLCBpKzEpOwoKCiAgICAgICQodGhpcykuY3NzKHsKICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICBsZWZ0OiAoIHNldHRpbmdzLmRpcmVjdGlvbiA9PSAnaG9yaXpvbnRhbCcgKQogICAgICAgICAgPyBsZWZ0UG9zICsgIiUiCiAgICAgICAgICA6IDAsCiAgICAgICAgdG9wOiAoIHNldHRpbmdzLmRpcmVjdGlvbiA9PSAndmVydGljYWwnIHx8IHNldHRpbmdzLmRpcmVjdGlvbiAhPSAnaG9yaXpvbnRhbCcgKQogICAgICAgICAgPyB0b3BQb3MgKyAiJSIKICAgICAgICAgIDogMAogICAgICB9KTsKCiAgICAgIGlmIChzZXR0aW5ncy5kaXJlY3Rpb24gPT0gJ2hvcml6b250YWwnKQogICAgICAgIGxlZnRQb3MgPSBsZWZ0UG9zICsgMTAwOwogICAgICBlbHNlCiAgICAgICAgdG9wUG9zID0gdG9wUG9zICsgMTAwOwoKCiAgICAgIGlmKHNldHRpbmdzLnBhZ2luYXRpb24gPT0gdHJ1ZSkgewogICAgICAgIHBhZ2luYXRpb25MaXN0ICs9ICI8bGk+PGEgZGF0YS1pbmRleD0nIisoaSsxKSsiJyBocmVmPScjIiArIChpKzEpICsgIic+PC9hPjwvbGk+IgogICAgICB9CiAgICB9KTsKCiAgICBlbC5zd2lwZUV2ZW50cygpLmJpbmQoInN3aXBlRG93biIsICBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICghJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBlbC5tb3ZlVXAoKTsKICAgIH0pLmJpbmQoInN3aXBlVXAiLCBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICghJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBlbC5tb3ZlRG93bigpOwogICAgfSk7CgogICAgLy8gQ3JlYXRlIFBhZ2luYXRpb24gYW5kIERpc3BsYXkgVGhlbQogICAgaWYgKHNldHRpbmdzLnBhZ2luYXRpb24gPT0gdHJ1ZSkgewogICAgICBpZiAoJCgndWwub25lcGFnZS1wYWdpbmF0aW9uJykubGVuZ3RoIDwgMSkgJCgiPHVsIGNsYXNzPSdvbmVwYWdlLXBhZ2luYXRpb24nPjwvdWw+IikucHJlcGVuZFRvKCJib2R5Iik7CgogICAgICBpZiggc2V0dGluZ3MuZGlyZWN0aW9uID09ICdob3Jpem9udGFsJyApIHsKICAgICAgICBwb3NMZWZ0ID0gKGVsLmZpbmQoIi5vbmVwYWdlLXBhZ2luYXRpb24iKS53aWR0aCgpIC8gMikgKiAtMTsKICAgICAgICBlbC5maW5kKCIub25lcGFnZS1wYWdpbmF0aW9uIikuY3NzKCJtYXJnaW4tbGVmdCIsIHBvc0xlZnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHBvc1RvcCA9IChlbC5maW5kKCIub25lcGFnZS1wYWdpbmF0aW9uIikuaGVpZ2h0KCkgLyAyKSAqIC0xOwogICAgICAgIGVsLmZpbmQoIi5vbmVwYWdlLXBhZ2luYXRpb24iKS5jc3MoIm1hcmdpbi10b3AiLCBwb3NUb3ApOwogICAgICB9CiAgICAgICQoJ3VsLm9uZXBhZ2UtcGFnaW5hdGlvbicpLmh0bWwocGFnaW5hdGlvbkxpc3QpOwogICAgfQoKICAgIGlmKHdpbmRvdy5sb2NhdGlvbi5oYXNoICE9ICIiICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoICE9ICIjMSIpIHsKICAgICAgaW5pdF9pbmRleCA9ICB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCIjIiwgIiIpCgogICAgICBpZiAocGFyc2VJbnQoaW5pdF9pbmRleCkgPD0gdG90YWwgJiYgcGFyc2VJbnQoaW5pdF9pbmRleCkgPiAwKSB7CiAgICAgICAgJChzZXR0aW5ncy5zZWN0aW9uQ29udGFpbmVyICsgIltkYXRhLWluZGV4PSciICsgaW5pdF9pbmRleCArICInXSIpLmFkZENsYXNzKCJhY3RpdmUiKQogICAgICAgICQoImJvZHkiKS5hZGRDbGFzcygidmlld2luZy1wYWdlLSIrIGluaXRfaW5kZXgpCiAgICAgICAgaWYoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PSciICsgaW5pdF9pbmRleCArICInXSIpLmFkZENsYXNzKCJhY3RpdmUiKTsKCiAgICAgICAgbmV4dCA9ICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nIiArIChpbml0X2luZGV4KSArICInXSIpOwogICAgICAgIGlmKG5leHQpIHsKICAgICAgICAgIG5leHQuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgICAgICBpZihzZXR0aW5ncy5wYWdpbmF0aW9uID09IHRydWUpICQoIi5vbmVwYWdlLXBhZ2luYXRpb24gbGkgYSIgKyAiW2RhdGEtaW5kZXg9JyIgKyAoaW5pdF9pbmRleCkgKyAiJ10iKS5hZGRDbGFzcygiYWN0aXZlIik7CiAgICAgICAgICAkKCJib2R5IilbMF0uY2xhc3NOYW1lID0gJCgiYm9keSIpWzBdLmNsYXNzTmFtZS5yZXBsYWNlKC9cYnZpZXdpbmctcGFnZS1cZC4qP1xiL2csICcnKTsKICAgICAgICAgICQoImJvZHkiKS5hZGRDbGFzcygidmlld2luZy1wYWdlLSIrbmV4dC5kYXRhKCJpbmRleCIpKQogICAgICAgICAgaWYgKGhpc3RvcnkucmVwbGFjZVN0YXRlICYmIHNldHRpbmdzLnVwZGF0ZVVSTCA9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsd2luZG93LmxvY2F0aW9uLmhyZWYuaW5kZXhPZignIycpKSArICIjIiArIChpbml0X2luZGV4KTsKICAgICAgICAgICAgaGlzdG9yeS5wdXNoU3RhdGUoIHt9LCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwb3MgPSAoKGluaXRfaW5kZXggLSAxKSAqIDEwMCkgKiAtMTsKICAgICAgICBlbC50cmFuc2Zvcm1QYWdlKHNldHRpbmdzLCBwb3MsIGluaXRfaW5kZXgpOwogICAgICB9IGVsc2UgewogICAgICAgICQoc2V0dGluZ3Muc2VjdGlvbkNvbnRhaW5lciArICJbZGF0YS1pbmRleD0nMSddIikuYWRkQ2xhc3MoImFjdGl2ZSIpCiAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJ2aWV3aW5nLXBhZ2UtMSIpCiAgICAgICAgaWYoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PScxJ10iKS5hZGRDbGFzcygiYWN0aXZlIik7CiAgICAgIH0KICAgIH1lbHNlewogICAgICAkKHNldHRpbmdzLnNlY3Rpb25Db250YWluZXIgKyAiW2RhdGEtaW5kZXg9JzEnXSIpLmFkZENsYXNzKCJhY3RpdmUiKQogICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInZpZXdpbmctcGFnZS0xIikKICAgICAgaWYoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiICsgIltkYXRhLWluZGV4PScxJ10iKS5hZGRDbGFzcygiYWN0aXZlIik7CiAgICB9CgogICAgaWYoc2V0dGluZ3MucGFnaW5hdGlvbiA9PSB0cnVlKSAgewogICAgICAkKCIub25lcGFnZS1wYWdpbmF0aW9uIGxpIGEiKS5jbGljayhmdW5jdGlvbiAoKXsKICAgICAgICB2YXIgcGFnZV9pbmRleCA9ICQodGhpcykuZGF0YSgiaW5kZXgiKTsKICAgICAgICBlbC5tb3ZlVG8ocGFnZV9pbmRleCk7CiAgICAgIH0pOwogICAgfQoKCiAgICAkKGRvY3VtZW50KS5iaW5kKCdtb3VzZXdoZWVsIERPTU1vdXNlU2Nyb2xsIE1vek1vdXNlUGl4ZWxTY3JvbGwnLCBmdW5jdGlvbihldmVudCkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB2YXIgZGVsdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGEgfHwgLWV2ZW50Lm9yaWdpbmFsRXZlbnQuZGV0YWlsOwogICAgICBpZighJCgiYm9keSIpLmhhc0NsYXNzKCJkaXNhYmxlZC1vbmVwYWdlLXNjcm9sbCIpKSBpbml0X3Njcm9sbChldmVudCwgZGVsdGEpOwogICAgfSk7CgoKICAgIGlmKHNldHRpbmdzLnJlc3BvbnNpdmVGYWxsYmFjayAhPSBmYWxzZSkgewogICAgICAkKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uKCkgewogICAgICAgIHJlc3BvbnNpdmUoKTsKICAgICAgfSk7CgogICAgICByZXNwb25zaXZlKCk7CiAgICB9CgogICAgaWYoc2V0dGluZ3Mua2V5Ym9hcmQgPT0gdHJ1ZSkgewogICAgICAkKGRvY3VtZW50KS5rZXlkb3duKGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgdGFnID0gZS50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICBpZiAoISQoImJvZHkiKS5oYXNDbGFzcygiZGlzYWJsZWQtb25lcGFnZS1zY3JvbGwiKSkgewogICAgICAgICAgc3dpdGNoKGUud2hpY2gpIHsKICAgICAgICAgICAgY2FzZSAzODoKICAgICAgICAgICAgICBpZiAodGFnICE9ICdpbnB1dCcgJiYgdGFnICE9ICd0ZXh0YXJlYScpIGVsLm1vdmVVcCgpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQwOgogICAgICAgICAgICAgIGlmICh0YWcgIT0gJ2lucHV0JyAmJiB0YWcgIT0gJ3RleHRhcmVhJykgZWwubW92ZURvd24oKQogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzMjogLy9zcGFjZWJhcgogICAgICAgICAgICAgIGlmICh0YWcgIT0gJ2lucHV0JyAmJiB0YWcgIT0gJ3RleHRhcmVhJykgZWwubW92ZURvd24oKQogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzMzogLy9wYWdlZyB1cAogICAgICAgICAgICAgIGlmICh0YWcgIT0gJ2lucHV0JyAmJiB0YWcgIT0gJ3RleHRhcmVhJykgZWwubW92ZVVwKCkKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMzQ6IC8vcGFnZSBkd24KICAgICAgICAgICAgICBpZiAodGFnICE9ICdpbnB1dCcgJiYgdGFnICE9ICd0ZXh0YXJlYScpIGVsLm1vdmVEb3duKCkKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMzY6IC8vaG9tZQogICAgICAgICAgICAgIGVsLm1vdmVUbygxKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMzU6IC8vZW5kCiAgICAgICAgICAgICAgZWwubW92ZVRvKHRvdGFsKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgoKfSh3aW5kb3cualF1ZXJ5KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:21:17 GMT",
                    "Content-Length": "15657",
                    "Date": "Fri, 07 Nov 2014 21:21:17 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}