{
    "url": "http://localhost:9999/shahariaazam/theme-asset/assets/scripts/core/app.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.hash</b> and written to <b>$()</b> via the following statements:<ul><li>var tabid = location.hash.substr(1);</li><li>$('a[href=\"#...' + tabid+ '\"]' ) </li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/shahariaazam/theme-asset/assets/scripts/core/app.js",
                "path": "/shahariaazam/theme-asset/assets/scripts/core/app.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zaGFoYXJpYWF6YW0vdGhlbWUtYXNzZXQvYXNzZXRzL3NjcmlwdHMvY29yZS9hcHAuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDkzNjENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6MzA6MTcgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjMwOjE2IEdNVA0KDQovKioKQ29yZSBzY3JpcHQgdG8gaGFuZGxlIHRoZSBlbnRpcmUgdGhlbWUgYW5kIGNvcmUgZnVuY3Rpb25zCioqLwp2YXIgQXBwID0gZnVuY3Rpb24gKCkgewoKICAgIC8vIElFIG1vZGUKICAgIHZhciBpc1JUTCA9IGZhbHNlOwogICAgdmFyIGlzSUU4ID0gZmFsc2U7CiAgICB2YXIgaXNJRTkgPSBmYWxzZTsKICAgIHZhciBpc0lFMTAgPSBmYWxzZTsKCiAgICB2YXIgc2lkZWJhcldpZHRoID0gMjI1OwogICAgdmFyIHNpZGViYXJDb2xsYXBzZWRXaWR0aCA9IDM1OwoKICAgIHZhciByZXNwb25zaXZlSGFuZGxlcnMgPSBbXTsKCiAgICAvLyB0aGVtZSBsYXlvdXQgY29sb3Igc2V0CiAgICB2YXIgbGF5b3V0Q29sb3JDb2RlcyA9IHsKICAgICAgICAnYmx1ZSc6ICcjNGI4ZGY4JywKICAgICAgICAncmVkJzogJyNlMDIyMjInLAogICAgICAgICdncmVlbic6ICcjMzVhYTQ3JywKICAgICAgICAncHVycGxlJzogJyM4NTJiOTknLAogICAgICAgICdncmV5JzogJyM1NTU1NTUnLAogICAgICAgICdsaWdodC1ncmV5JzogJyNmYWZhZmEnLAogICAgICAgICd5ZWxsb3cnOiAnI2ZmYjg0OCcKICAgIH07CgogICAgLy8gVG8gZ2V0IHRoZSBjb3JyZWN0IHZpZXdwb3J0IHdpZHRoIGJhc2VkIG9uICBodHRwOi8vYW5keWxhbmd0b24uY28udWsvYXJ0aWNsZXMvamF2YXNjcmlwdC9nZXQtdmlld3BvcnQtc2l6ZS1qYXZhc2NyaXB0LwogICAgdmFyIF9nZXRWaWV3UG9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IHdpbmRvdywgYSA9ICdpbm5lcic7CiAgICAgICAgaWYgKCEoJ2lubmVyV2lkdGgnIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgYSA9ICdjbGllbnQnOwogICAgICAgICAgICBlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8IGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdpZHRoOiBlW2EgKyAnV2lkdGgnXSwKICAgICAgICAgICAgaGVpZ2h0OiBlW2EgKyAnSGVpZ2h0J10KICAgICAgICB9CiAgICB9CgogICAgLy8gaW5pdGlhbGl6ZXMgbWFpbiBzZXR0aW5ncwogICAgdmFyIGhhbmRsZUluaXQgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICgkKCdib2R5JykuY3NzKCdkaXJlY3Rpb24nKSA9PT0gJ3J0bCcpIHsKICAgICAgICAgICAgaXNSVEwgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaXNJRTggPSAhISBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9NU0lFIDguMC8pOwogICAgICAgIGlzSUU5ID0gISEgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvTVNJRSA5LjAvKTsKICAgICAgICBpc0lFMTAgPSAhISBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9NU0lFIDEwLjAvKTsKCiAgICAgICAgaWYgKGlzSUUxMCkgewogICAgICAgICAgICBqUXVlcnkoJ2h0bWwnKS5hZGRDbGFzcygnaWUxMCcpOyAvLyBkZXRlY3QgSUUxMCB2ZXJzaW9uCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChpc0lFMTAgfHwgaXNJRTkgfHwgaXNJRTgpIHsKICAgICAgICAgICAgalF1ZXJ5KCdodG1sJykuYWRkQ2xhc3MoJ2llJyk7IC8vIGRldGVjdCBJRTEwIHZlcnNpb24KICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICBWaXJ0dWFsIGtleWJvYXJkczoKICAgICAgICAgIEFsc28sIG5vdGUgdGhhdCBpZiB5b3UncmUgdXNpbmcgaW5wdXRzIGluIHlvdXIgbW9kYWwg4oCTIGlPUyBoYXMgYSByZW5kZXJpbmcgYnVnIHdoaWNoIGRvZXNuJ3QgCiAgICAgICAgICB1cGRhdGUgdGhlIHBvc2l0aW9uIG9mIGZpeGVkIGVsZW1lbnRzIHdoZW4gdGhlIHZpcnR1YWwga2V5Ym9hcmQgaXMgdHJpZ2dlcmVkICAKICAgICAgICAqLwogICAgICAgIHZhciBkZXZpY2VBZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoZGV2aWNlQWdlbnQubWF0Y2goLyhpcGhvbmV8aXBvZHxpcGFkKS8pKSB7CiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdmb2N1cycsICdpbnB1dCwgdGV4dGFyZWEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKCcucGFnZS1oZWFkZXInKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAkKCcucGFnZS1mb290ZXInKS5oaWRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkKGRvY3VtZW50KS5vbignYmx1cicsICdpbnB1dCwgdGV4dGFyZWEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKCcucGFnZS1oZWFkZXInKS5zaG93KCk7CiAgICAgICAgICAgICAgICAkKCcucGFnZS1mb290ZXInKS5zaG93KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgaGFuZGxlU2lkZWJhclN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIHJlbW92ZSBzaWRlYmFyIHRvZ2dsZXIgaWYgd2luZG93IHdpZHRoIHNtYWxsZXIgdGhhbiA5OTIoZm9yIHRhYmxldCBhbmQgcGhvbmUgbW9kZSkKICAgICAgICB2YXIgdmlld3BvcnQgPSBfZ2V0Vmlld1BvcnQoKTsKICAgICAgICBpZiAodmlld3BvcnQud2lkdGggPCA5OTIpIHsKICAgICAgICAgICAgJCgnYm9keScpLnJlbW92ZUNsYXNzKCJwYWdlLXNpZGViYXItY2xvc2VkIik7CiAgICAgICAgfQogICAgfQoKICAgIC8vIHJ1bnMgY2FsbGJhY2sgZnVuY3Rpb25zIHNldCBieSBBcHAuYWRkUmVzcG9uc2l2ZUhhbmRsZXIoKS4KICAgIHZhciBydW5SZXNwb25zaXZlSGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gcmVpbml0aWFsaXplIG90aGVyIHN1YnNjcmliZWQgZWxlbWVudHMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNpdmVIYW5kbGVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZWFjaCA9IHJlc3BvbnNpdmVIYW5kbGVyc1tpXTsKICAgICAgICAgICAgZWFjaC5jYWxsKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIHJlaW5pdGlhbGl6ZSB0aGUgbGF5cG90IG9uIHdpbmRvdyByZXNpemUKICAgIHZhciBoYW5kbGVSZXNwb25zaXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVNpZGViYXJTdGF0ZSgpOwogICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7CiAgICAgICAgaGFuZGxlRml4ZWRTaWRlYmFyKCk7CiAgICAgICAgcnVuUmVzcG9uc2l2ZUhhbmRsZXJzKCk7CiAgICB9CgogICAgLy8gaW5pdGlhbGl6ZSB0aGUgbGF5b3V0IG9uIHBhZ2UgbG9hZAogICAgdmFyIGhhbmRsZVJlc3BvbnNpdmVPbkluaXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaGFuZGxlU2lkZWJhclN0YXRlKCk7CiAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgIH0KCiAgICAvLyBoYW5kbGUgdGhlIGxheW91dCByZWluaXRpYWxpemF0aW9uIG9uIHdpbmRvdyByZXNpemUKICAgIHZhciBoYW5kbGVSZXNwb25zaXZlT25SZXNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlc2l6ZTsKICAgICAgICBpZiAoaXNJRTgpIHsKICAgICAgICAgICAgdmFyIGN1cnJoZWlnaHQ7CiAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJoZWlnaHQgPT0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy9xdWl0ZSBldmVudCBzaW5jZSBvbmx5IGJvZHkgcmVzaXplZCBub3Qgd2luZG93LgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlc2l6ZSkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXNpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzaXplID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlUmVzcG9uc2l2ZSgpOwogICAgICAgICAgICAgICAgfSwgNTApOyAvLyB3YWl0IDUwbXMgdW50aWwgd2luZG93IHJlc2l6ZSBmaW5pc2hlcy4gICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdXJyaGVpZ2h0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsgLy8gc3RvcmUgbGFzdCBib2R5IGNsaWVudCBoZWlnaHQKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzaXplKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNpemUgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVSZXNwb25zaXZlKCk7CiAgICAgICAgICAgICAgICB9LCA1MCk7IC8vIHdhaXQgNTBtcyB1bnRpbCB3aW5kb3cgcmVzaXplIGZpbmlzaGVzLgogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgLy8qIEJFR0lOOkNPUkUgSEFORExFUlMgKi8vCiAgICAvLyB0aGlzIGZ1bmN0aW9uIGhhbmRsZXMgcmVzcG9uc2l2ZSBsYXlvdXQgb24gc2NyZWVuIHNpemUgcmVzaXplIG9yIG1vYmlsZSBkZXZpY2Ugcm90YXRlLgoKICAgIC8vIFNldCBwcm9wZXIgaGVpZ2h0IGZvciBzaWRlYmFyIGFuZCBjb250ZW50LiBUaGUgY29udGVudCBhbmQgc2lkZWJhciBoZWlnaHQgbXVzdCBiZSBzeW5jZWQgYWx3YXlzLgogICAgdmFyIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjb250ZW50ID0gJCgnLnBhZ2UtY29udGVudCcpOwogICAgICAgIHZhciBzaWRlYmFyID0gJCgnLnBhZ2Utc2lkZWJhcicpOwogICAgICAgIHZhciBib2R5ID0gJCgnYm9keScpOwogICAgICAgIHZhciBoZWlnaHQ7CgogICAgICAgIGlmIChib2R5Lmhhc0NsYXNzKCJwYWdlLWZvb3Rlci1maXhlZCIpID09PSB0cnVlICYmIGJvZHkuaGFzQ2xhc3MoInBhZ2Utc2lkZWJhci1maXhlZCIpID09PSBmYWxzZSkgewogICAgICAgICAgICB2YXIgYXZhaWxhYmxlX2hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKSAtICQoJy5mb290ZXInKS5vdXRlckhlaWdodCgpIC0gJCgnLmhlYWRlcicpLm91dGVySGVpZ2h0KCk7CiAgICAgICAgICAgIGlmIChjb250ZW50LmhlaWdodCgpIDwgYXZhaWxhYmxlX2hlaWdodCkgewogICAgICAgICAgICAgICAgY29udGVudC5hdHRyKCdzdHlsZScsICdtaW4taGVpZ2h0OicgKyBhdmFpbGFibGVfaGVpZ2h0ICsgJ3B4ICFpbXBvcnRhbnQnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSkgewogICAgICAgICAgICAgICAgaGVpZ2h0ID0gX2NhbGN1bGF0ZUZpeGVkU2lkZWJhclZpZXdwb3J0SGVpZ2h0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSBzaWRlYmFyLmhlaWdodCgpICsgMjA7CiAgICAgICAgICAgICAgICB2YXIgaGVhZGVySGVpZ2h0ID0gJCgnLmhlYWRlcicpLm91dGVySGVpZ2h0KCk7CiAgICAgICAgICAgICAgICB2YXIgZm9vdGVySGVpZ2h0ID0gJCgnLmZvb3RlcicpLm91dGVySGVpZ2h0KCk7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCQod2luZG93KS53aWR0aCgpID4gMTAyNCAmJiAoaGVpZ2h0ICsgaGVhZGVySGVpZ2h0ICsgZm9vdGVySGVpZ2h0KSAgPCAkKHdpbmRvdykuaGVpZ2h0KCkpIHsKICAgICAgICAgICAgICAgICAgICBoZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCkgLSBoZWFkZXJIZWlnaHQgLSBmb290ZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGhlaWdodCA+PSBjb250ZW50LmhlaWdodCgpKSB7CiAgICAgICAgICAgICAgICBjb250ZW50LmF0dHIoJ3N0eWxlJywgJ21pbi1oZWlnaHQ6JyArIGhlaWdodCArICdweCAhaW1wb3J0YW50Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gSGFuZGxlIHNpZGViYXIgbWVudQogICAgdmFyIGhhbmRsZVNpZGViYXJNZW51ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSgnLnBhZ2Utc2lkZWJhcicpLm9uKCdjbGljaycsICdsaSA+IGEnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoJCh0aGlzKS5uZXh0KCkuaGFzQ2xhc3MoJ3N1Yi1tZW51JykgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGlmICgkKCcuYnRuLW5hdmJhcicpLmhhc0NsYXNzKCdjb2xsYXBzZWQnKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICQoJy5idG4tbmF2YmFyJykuY2xpY2soKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCQodGhpcykubmV4dCgpLmhhc0NsYXNzKCdzdWItbWVudSBhbHdheXMtb3BlbicpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYXJlbnQgPSAkKHRoaXMpLnBhcmVudCgpLnBhcmVudCgpOwogICAgICAgICAgICB2YXIgdGhlID0gJCh0aGlzKTsKICAgICAgICAgICAgdmFyIG1lbnUgPSAkKCcucGFnZS1zaWRlYmFyLW1lbnUnKTsKICAgICAgICAgICAgdmFyIHN1YiA9IGpRdWVyeSh0aGlzKS5uZXh0KCk7CgogICAgICAgICAgICB2YXIgYXV0b1Njcm9sbCA9IG1lbnUuZGF0YSgiYXV0by1zY3JvbGwiKSA/IG1lbnUuZGF0YSgiYXV0by1zY3JvbGwiKSA6IHRydWU7CiAgICAgICAgICAgIHZhciBzbGlkZVNwZWVkID0gbWVudS5kYXRhKCJzbGlkZS1zcGVlZCIpID8gcGFyc2VJbnQobWVudS5kYXRhKCJzbGlkZS1zcGVlZCIpKSA6IDIwMDsKCiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbignbGkub3BlbicpLmNoaWxkcmVuKCdhJykuY2hpbGRyZW4oJy5hcnJvdycpLnJlbW92ZUNsYXNzKCdvcGVuJyk7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbignbGkub3BlbicpLmNoaWxkcmVuKCcuc3ViLW1lbnU6bm90KC5hbHdheXMtb3BlbiknKS5zbGlkZVVwKDIwMCk7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbignbGkub3BlbicpLnJlbW92ZUNsYXNzKCdvcGVuJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgc2xpZGVPZmZlc2V0ID0gLTIwMDsKCiAgICAgICAgICAgIGlmIChzdWIuaXMoIjp2aXNpYmxlIikpIHsKICAgICAgICAgICAgICAgIGpRdWVyeSgnLmFycm93JywgalF1ZXJ5KHRoaXMpKS5yZW1vdmVDbGFzcygib3BlbiIpOwogICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCJvcGVuIik7CiAgICAgICAgICAgICAgICBzdWIuc2xpZGVVcChzbGlkZVNwZWVkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGwgPT0gdHJ1ZSAmJiAkKCdib2R5JykuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1jbG9zZWQnKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudS5zbGltU2Nyb2xsKHsnc2Nyb2xsVG8nOiAodGhlLnBvc2l0aW9uKCkpLnRvcH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXBwLnNjcm9sbFRvKHRoZSwgc2xpZGVPZmZlc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqUXVlcnkoJy5hcnJvdycsIGpRdWVyeSh0aGlzKSkuYWRkQ2xhc3MoIm9wZW4iKTsKICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5wYXJlbnQoKS5hZGRDbGFzcygib3BlbiIpOwogICAgICAgICAgICAgICAgc3ViLnNsaWRlRG93bihzbGlkZVNwZWVkLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGwgPT0gdHJ1ZSAmJiAkKCdib2R5JykuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1jbG9zZWQnKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudS5zbGltU2Nyb2xsKHsnc2Nyb2xsVG8nOiAodGhlLnBvc2l0aW9uKCkpLnRvcH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXBwLnNjcm9sbFRvKHRoZSwgc2xpZGVPZmZlc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxlIGFqYXggbGlua3Mgd2l0aGluIHNpZGViYXIgbWVudQogICAgICAgIGpRdWVyeSgnLnBhZ2Utc2lkZWJhcicpLm9uKCdjbGljaycsICcgbGkgPiBhLmFqYXhpZnknLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIEFwcC5zY3JvbGxUb3AoKTsKCiAgICAgICAgICAgIHZhciB1cmwgPSAkKHRoaXMpLmF0dHIoImhyZWYiKTsKICAgICAgICAgICAgdmFyIG1lbnVDb250YWluZXIgPSBqUXVlcnkoJy5wYWdlLXNpZGViYXIgdWwnKTsKICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gJCgnLnBhZ2UtY29udGVudCcpOwogICAgICAgICAgICB2YXIgcGFnZUNvbnRlbnRCb2R5ID0gJCgnLnBhZ2UtY29udGVudCAucGFnZS1jb250ZW50LWJvZHknKTsKCiAgICAgICAgICAgIG1lbnVDb250YWluZXIuY2hpbGRyZW4oJ2xpLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgbWVudUNvbnRhaW5lci5jaGlsZHJlbignYXJyb3cub3BlbicpLnJlbW92ZUNsYXNzKCdvcGVuJyk7CgogICAgICAgICAgICAkKHRoaXMpLnBhcmVudHMoJ2xpJykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICQodGhpcykuY2hpbGRyZW4oJ2EgPiBzcGFuLmFycm93JykuYWRkQ2xhc3MoJ29wZW4nKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICQodGhpcykucGFyZW50cygnbGknKS5hZGRDbGFzcygnYWN0aXZlJyk7CgogICAgICAgICAgICBBcHAuc3RhcnRQYWdlTG9hZGluZygpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCQod2luZG93KS53aWR0aCgpIDw9IDk5MSAmJiAkKCcucGFnZS1zaWRlYmFyJykuaGFzQ2xhc3MoImluIikpIHsKICAgICAgICAgICAgICAgICQoJy5uYXZiYXItdG9nZ2xlJykuY2xpY2soKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICAgICAgICAgIEFwcC5zdG9wUGFnZUxvYWRpbmcoKTsKICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudEJvZHkuaHRtbChyZXMpOwogICAgICAgICAgICAgICAgICAgIEFwcC5maXhDb250ZW50SGVpZ2h0KCk7IC8vIGZpeCBjb250ZW50IGhlaWdodAogICAgICAgICAgICAgICAgICAgIEFwcC5pbml0QWpheCgpOyAvLyBpbml0aWFsaXplIGNvcmUgc3R1ZmYKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHhociwgYWpheE9wdGlvbnMsIHRocm93bkVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnRCb2R5Lmh0bWwoJzxoND5Db3VsZCBub3QgbG9hZCB0aGUgcmVxdWVzdGVkIGNvbnRlbnQuPC9oND4nKTsKICAgICAgICAgICAgICAgICAgICBBcHAuc3RvcFBhZ2VMb2FkaW5nKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBoYW5kbGUgYWpheCBsaW5rIHdpdGhpbiBtYWluIGNvbnRlbnQKICAgICAgICBqUXVlcnkoJy5wYWdlLWNvbnRlbnQnKS5vbignY2xpY2snLCAnLmFqYXhpZnknLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIEFwcC5zY3JvbGxUb3AoKTsKCiAgICAgICAgICAgIHZhciB1cmwgPSAkKHRoaXMpLmF0dHIoImhyZWYiKTsKICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gJCgnLnBhZ2UtY29udGVudCcpOwogICAgICAgICAgICB2YXIgcGFnZUNvbnRlbnRCb2R5ID0gJCgnLnBhZ2UtY29udGVudCAucGFnZS1jb250ZW50LWJvZHknKTsKCiAgICAgICAgICAgIEFwcC5zdGFydFBhZ2VMb2FkaW5nKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoJCh3aW5kb3cpLndpZHRoKCkgPD0gOTkxICYmICQoJy5wYWdlLXNpZGViYXInKS5oYXNDbGFzcygiaW4iKSkgewogICAgICAgICAgICAgICAgJCgnLm5hdmJhci10b2dnbGUnKS5jbGljaygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAiaHRtbCIsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgQXBwLnN0b3BQYWdlTG9hZGluZygpOwogICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50Qm9keS5odG1sKHJlcyk7CiAgICAgICAgICAgICAgICAgICAgQXBwLmZpeENvbnRlbnRIZWlnaHQoKTsgLy8gZml4IGNvbnRlbnQgaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgQXBwLmluaXRBamF4KCk7IC8vIGluaXRpYWxpemUgY29yZSBzdHVmZgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiAoeGhyLCBhamF4T3B0aW9ucywgdGhyb3duRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudEJvZHkuaHRtbCgnPGg0PkNvdWxkIG5vdCBsb2FkIHRoZSByZXF1ZXN0ZWQgY29udGVudC48L2g0PicpOwogICAgICAgICAgICAgICAgICAgIEFwcC5zdG9wUGFnZUxvYWRpbmcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNhbGN1bGF0ZSBzaWRlYmFyIGhlaWdodCBmb3IgZml4ZWQgc2lkZWJhciBsYXlvdXQuCiAgICB2YXIgX2NhbGN1bGF0ZUZpeGVkU2lkZWJhclZpZXdwb3J0SGVpZ2h0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzaWRlYmFySGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpIC0gJCgnLmhlYWRlcicpLmhlaWdodCgpICsgMTsKICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCJwYWdlLWZvb3Rlci1maXhlZCIpKSB7CiAgICAgICAgICAgIHNpZGViYXJIZWlnaHQgPSBzaWRlYmFySGVpZ2h0IC0gJCgnLmZvb3RlcicpLm91dGVySGVpZ2h0KCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2lkZWJhckhlaWdodDsKICAgIH0KCiAgICAvLyBIYW5kbGVzIGZpeGVkIHNpZGViYXIKICAgIHZhciBoYW5kbGVGaXhlZFNpZGViYXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG1lbnUgPSAkKCcucGFnZS1zaWRlYmFyLW1lbnUnKTsKCiAgICAgICAgaWYgKG1lbnUucGFyZW50KCcuc2xpbVNjcm9sbERpdicpLnNpemUoKSA9PT0gMSkgeyAvLyBkZXN0cm95IGV4aXN0aW5nIGluc3RhbmNlIGJlZm9yZSB1cGRhdGluZyB0aGUgaGVpZ2h0CiAgICAgICAgICAgIG1lbnUuc2xpbVNjcm9sbCh7CiAgICAgICAgICAgICAgICBkZXN0cm95OiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBtZW51LnJlbW92ZUF0dHIoJ3N0eWxlJyk7CiAgICAgICAgICAgICQoJy5wYWdlLXNpZGViYXInKS5yZW1vdmVBdHRyKCdzdHlsZScpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCQoJy5wYWdlLXNpZGViYXItZml4ZWQnKS5zaXplKCkgPT09IDApIHsKICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZpZXdwb3J0ID0gX2dldFZpZXdQb3J0KCk7CiAgICAgICAgaWYgKHZpZXdwb3J0LndpZHRoID49IDk5MikgewogICAgICAgICAgICB2YXIgc2lkZWJhckhlaWdodCA9IF9jYWxjdWxhdGVGaXhlZFNpZGViYXJWaWV3cG9ydEhlaWdodCgpOwoKICAgICAgICAgICAgbWVudS5zbGltU2Nyb2xsKHsKICAgICAgICAgICAgICAgIHNpemU6ICc3cHgnLAogICAgICAgICAgICAgICAgY29sb3I6ICcjYTFiMmJkJywKICAgICAgICAgICAgICAgIG9wYWNpdHk6IC4zLAogICAgICAgICAgICAgICAgcG9zaXRpb246IGlzUlRMID8gJ2xlZnQnIDogJ3JpZ2h0JywKICAgICAgICAgICAgICAgIGhlaWdodDogc2lkZWJhckhlaWdodCwKICAgICAgICAgICAgICAgIGFsbG93UGFnZVNjcm9sbDogZmFsc2UsCiAgICAgICAgICAgICAgICBkaXNhYmxlRmFkZU91dDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEhhbmRsZXMgdGhlIHNpZGViYXIgbWVudSBob3ZlciBlZmZlY3QgZm9yIGZpeGVkIHNpZGViYXIuCiAgICB2YXIgaGFuZGxlRml4ZWRTaWRlYmFySG92ZXJhYmxlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICgkKCdib2R5JykuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1maXhlZCcpID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAkKCcucGFnZS1zaWRlYmFyJykub2ZmKCdtb3VzZWVudGVyJykub24oJ21vdXNlZW50ZXInLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBib2R5ID0gJCgnYm9keScpOwoKICAgICAgICAgICAgaWYgKChib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItY2xvc2VkJykgPT09IGZhbHNlIHx8IGJvZHkuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1maXhlZCcpID09PSBmYWxzZSkgfHwgJCh0aGlzKS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJykpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYm9keS5yZW1vdmVDbGFzcygncGFnZS1zaWRlYmFyLWNsb3NlZCcpLmFkZENsYXNzKCdwYWdlLXNpZGViYXItaG92ZXItb24nKTsKCiAgICAgICAgICAgIGlmIChib2R5Lmhhc0NsYXNzKCJwYWdlLXNpZGViYXItcmV2ZXJzZWQiKSkgewogICAgICAgICAgICAgICAgJCh0aGlzKS53aWR0aChzaWRlYmFyV2lkdGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJyk7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmFuaW1hdGUoewogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBzaWRlYmFyV2lkdGgKICAgICAgICAgICAgICAgIH0sIDQwMCwgJycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdwYWdlLXNpZGViYXItaG92ZXJpbmcnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgICQoJy5wYWdlLXNpZGViYXInKS5vZmYoJ21vdXNlbGVhdmUnKS5vbignbW91c2VsZWF2ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGJvZHkgPSAkKCdib2R5Jyk7CgogICAgICAgICAgICBpZiAoKGJvZHkuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3Zlci1vbicpID09PSBmYWxzZSB8fCBib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSA9PT0gZmFsc2UpIHx8ICQodGhpcykuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChib2R5Lmhhc0NsYXNzKCJwYWdlLXNpZGViYXItcmV2ZXJzZWQiKSkgewogICAgICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdwYWdlLXNpZGViYXItY2xvc2VkJykucmVtb3ZlQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3Zlci1vbicpOwogICAgICAgICAgICAgICAgJCh0aGlzKS53aWR0aChzaWRlYmFyQ29sbGFwc2VkV2lkdGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJyk7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmFuaW1hdGUoewogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBzaWRlYmFyQ29sbGFwc2VkV2lkdGgKICAgICAgICAgICAgICAgIH0sIDQwMCwgJycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3BhZ2Utc2lkZWJhci1jbG9zZWQnKS5yZW1vdmVDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyLW9uJyk7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZXMgc2lkZWJhciB0b2dnbGVyIHRvIGNsb3NlL2hpZGUgdGhlIHNpZGViYXIuCiAgICB2YXIgaGFuZGxlU2lkZWJhclRvZ2dsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZpZXdwb3J0ID0gX2dldFZpZXdQb3J0KCk7CiAgICAgICAgaWYgKCQuY29va2llICYmICQuY29va2llKCdzaWRlYmFyX2Nsb3NlZCcpID09PSAnMScgJiYgdmlld3BvcnQud2lkdGggPj0gOTkyKSB7CiAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygncGFnZS1zaWRlYmFyLWNsb3NlZCcpOwogICAgICAgIH0KCiAgICAgICAgLy8gaGFuZGxlIHNpZGViYXIgc2hvdy9oaWRlCiAgICAgICAgJCgnLnBhZ2Utc2lkZWJhciwgLmhlYWRlcicpLm9uKCdjbGljaycsICcuc2lkZWJhci10b2dnbGVyJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgdmFyIGJvZHkgPSAkKCdib2R5Jyk7CiAgICAgICAgICAgIHZhciBzaWRlYmFyID0gJCgnLnBhZ2Utc2lkZWJhcicpOwoKICAgICAgICAgICAgaWYgKChib2R5Lmhhc0NsYXNzKCJwYWdlLXNpZGViYXItaG92ZXItb24iKSAmJiBib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSkgfHwgc2lkZWJhci5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJykpIHsKICAgICAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3Zlci1vbicpOwogICAgICAgICAgICAgICAgc2lkZWJhci5jc3MoJ3dpZHRoJywgJycpLmhpZGUoKS5zaG93KCk7CiAgICAgICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOyAvL2ZpeCBjb250ZW50ICYgc2lkZWJhciBoZWlnaHQKICAgICAgICAgICAgICAgIGlmICgkLmNvb2tpZSkgewogICAgICAgICAgICAgICAgICAgICQuY29va2llKCdzaWRlYmFyX2Nsb3NlZCcsICcwJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgcnVuUmVzcG9uc2l2ZUhhbmRsZXJzKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQoIi5zaWRlYmFyLXNlYXJjaCIsIHNpZGViYXIpLnJlbW92ZUNsYXNzKCJvcGVuIik7CgogICAgICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygicGFnZS1zaWRlYmFyLWNsb3NlZCIpKSB7CiAgICAgICAgICAgICAgICBib2R5LnJlbW92ZUNsYXNzKCJwYWdlLXNpZGViYXItY2xvc2VkIik7CiAgICAgICAgICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykpIHsKICAgICAgICAgICAgICAgICAgICBzaWRlYmFyLmNzcygnd2lkdGgnLCAnJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoJC5jb29raWUpIHsKICAgICAgICAgICAgICAgICAgICAkLmNvb2tpZSgnc2lkZWJhcl9jbG9zZWQnLCAnMCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm9keS5hZGRDbGFzcygicGFnZS1zaWRlYmFyLWNsb3NlZCIpOwogICAgICAgICAgICAgICAgaWYgKCQuY29va2llKSB7CiAgICAgICAgICAgICAgICAgICAgJC5jb29raWUoJ3NpZGViYXJfY2xvc2VkJywgJzEnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOyAvL2ZpeCBjb250ZW50ICYgc2lkZWJhciBoZWlnaHQKICAgICAgICAgICAgcnVuUmVzcG9uc2l2ZUhhbmRsZXJzKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsZSB0aGUgc2VhcmNoIGJhciBjbG9zZQogICAgICAgICQoJy5wYWdlLXNpZGViYXInKS5vbignY2xpY2snLCAnLnNpZGViYXItc2VhcmNoIC5yZW1vdmUnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICQoJy5zaWRlYmFyLXNlYXJjaCcpLnJlbW92ZUNsYXNzKCJvcGVuIik7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsZSB0aGUgc2VhcmNoIHF1ZXJ5IHN1Ym1pdCBvbiBlbnRlciBwcmVzcwogICAgICAgICQoJy5wYWdlLXNpZGViYXIgLnNpZGViYXItc2VhcmNoJykub24oJ2tleXByZXNzJywgJ2lucHV0LmZvcm0tY29udHJvbCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGlmIChlLndoaWNoID09IDEzKSB7CiAgICAgICAgICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2gnKS5zdWJtaXQoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy88LS0tLSBBZGQgdGhpcyBsaW5lCiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxlIHRoZSBzZWFyY2ggc3VibWl0KGZvciBzaWRlYmFyIHNlYXJjaCBhbmQgcmVzcG9uc2l2ZSBtb2RlIG9mIHRoZSBoZWFkZXIgc2VhcmNoKQogICAgICAgICQoJy5zaWRlYmFyLXNlYXJjaCAuc3VibWl0Jykub24oJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCJwYWdlLXNpZGViYXItY2xvc2VkIikpIHsKICAgICAgICAgICAgICAgIGlmICgkKCcuc2lkZWJhci1zZWFyY2gnKS5oYXNDbGFzcygnb3BlbicpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wYWdlLXNpZGViYXItZml4ZWQnKS5zaXplKCkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnLnBhZ2Utc2lkZWJhciAuc2lkZWJhci10b2dnbGVyJykuY2xpY2soKTsgLy90cmlnZ2VyIHNpZGViYXIgdG9nZ2xlIGJ1dHRvbgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2gnKS5hZGRDbGFzcygib3BlbiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2gnKS5zdWJtaXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQoJy5zaWRlYmFyLXNlYXJjaCcpLnN1Ym1pdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhlYWRlciBzZWFyY2ggYm94OgoKICAgICAgICAvLyBoYW5kbGUgdGhlIHNlYXJjaCBxdWVyeSBzdWJtaXQgb24gZW50ZXIgcHJlc3MKICAgICAgICAkKCcuaGVhZGVyIC5zZWFyY2gtZm9ybScpLm9uKCdrZXlwcmVzcycsICdpbnB1dC5mb3JtLWNvbnRyb2wnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoZS53aGljaCA9PSAxMykgewogICAgICAgICAgICAgICAgJCgnLnNpZGViYXItc2VhcmNoJykuc3VibWl0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vPC0tLS0gQWRkIHRoaXMgbGluZQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vaGFuZGxlIGhlYWRlciBzZWFyY2ggYnV0dG9uIGNsaWNrCiAgICAgICAgJCgnLmhlYWRlciAuc2VhcmNoLWZvcm0gLnN1Ym1pdCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgJCgnLmhlYWRlciAuc2VhcmNoLWZvcm0nKS5zdWJtaXQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHRoZSBob3Jpem9udGFsIG1lbnUKICAgIHZhciBoYW5kbGVIb3Jpem9udGFsTWVudSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvL2hhbmRsZSBob3IgbWVudSBzZWFyY2ggZm9ybSB0b2dnbGVyIGNsaWNrCiAgICAgICAgJCgnLmhlYWRlcicpLm9uKCdjbGljaycsICcuaG9yLW1lbnUgLmhvci1tZW51LXNlYXJjaC1mb3JtLXRvZ2dsZXInLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygnb2ZmJykpIHsKICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ29mZicpOwogICAgICAgICAgICAgICAgJCgnLmhlYWRlciAuaG9yLW1lbnUgLnNlYXJjaC1mb3JtJykuaGlkZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnb2ZmJyk7CiAgICAgICAgICAgICAgICAkKCcuaGVhZGVyIC5ob3ItbWVudSAuc2VhcmNoLWZvcm0nKS5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0pOwoKICAgICAgICAvL2hhbmRsZSB0YWIgY2xpY2sKICAgICAgICAkKCcuaGVhZGVyJykub24oJ2NsaWNrJywgJy5ob3ItbWVudSBhW2RhdGEtdG9nZ2xlPSJ0YWIiXScsIGZ1bmN0aW9uIChlKSB7ICAgICAKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2YXIgbmF2ID0gJCgiLmhvci1tZW51IC5uYXYiKTsKICAgICAgICAgICAgdmFyIGFjdGl2ZV9saW5rID0gbmF2LmZpbmQoJ2xpLmN1cnJlbnQnKTsKICAgICAgICAgICAgJCgnbGkuYWN0aXZlJywgYWN0aXZlX2xpbmspLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsKICAgICAgICAgICAgJCgnLnNlbGVjdGVkJywgYWN0aXZlX2xpbmspLnJlbW92ZSgpOwogICAgICAgICAgICB2YXIgbmV3X2xpbmsgPSAkKHRoaXMpLnBhcmVudHMoJ2xpJykubGFzdCgpOwogICAgICAgICAgICBuZXdfbGluay5hZGRDbGFzcygiY3VycmVudCIpOwogICAgICAgICAgICBuZXdfbGluay5maW5kKCJhOmZpcnN0IikuYXBwZW5kKCc8c3BhbiBjbGFzcz0ic2VsZWN0ZWQiPjwvc3Bhbj4nKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9oYW5kbGUgaG9yIG1lbnUgc2VhcmNoIGJ1dHRvbiBjbGljawogICAgICAgICQoJy5oZWFkZXInKS5vbignY2xpY2snLCAnLmhvci1tZW51IC5zZWFyY2gtZm9ybSAuYnRuJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgJCgnLmZvcm0tc2VhcmNoJykuc3VibWl0KCk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9oYW5kbGUgaG9yIG1lbnUgc2VhcmNoIGZvcm0gb24gZW50ZXIgcHJlc3MKICAgICAgICAkKCcuaGVhZGVyJykub24oJ2tleXByZXNzJywgJy5ob3ItbWVudSAuc2VhcmNoLWZvcm0gaW5wdXQnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoZS53aGljaCA9PSAxMykgewogICAgICAgICAgICAgICAgJCgnLmZvcm0tc2VhcmNoJykuc3VibWl0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHRoZSBnbyB0byB0b3AgYnV0dG9uIGF0IHRoZSBmb290ZXIKICAgIHZhciBoYW5kbGVHb1RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvKiBzZXQgdmFyaWFibGVzIGxvY2FsbHkgZm9yIGluY3JlYXNlZCBwZXJmb3JtYW5jZSAqLwogICAgICAgIGpRdWVyeSgnLmZvb3RlcicpLm9uKCdjbGljaycsICcuZ28tdG9wJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgQXBwLnNjcm9sbFRvKCk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHBvcnRsZXQgdG9vbHMgJiBhY3Rpb25zCiAgICB2YXIgaGFuZGxlUG9ydGxldFRvb2xzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSgnYm9keScpLm9uKCdjbGljaycsICcucG9ydGxldCA+IC5wb3J0bGV0LXRpdGxlID4gLnRvb2xzID4gYS5yZW1vdmUnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5jbG9zZXN0KCIucG9ydGxldCIpLnJlbW92ZSgpOwogICAgICAgIH0pOwoKICAgICAgICBqUXVlcnkoJ2JvZHknKS5vbignY2xpY2snLCAnLnBvcnRsZXQgPiAucG9ydGxldC10aXRsZSA+IC50b29scyA+IGEucmVsb2FkJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2YXIgZWwgPSBqUXVlcnkodGhpcykuY2xvc2VzdCgiLnBvcnRsZXQiKS5jaGlsZHJlbigiLnBvcnRsZXQtYm9keSIpOwogICAgICAgICAgICB2YXIgdXJsID0galF1ZXJ5KHRoaXMpLmF0dHIoImRhdGEtdXJsIik7CiAgICAgICAgICAgIHZhciBlcnJvciA9ICQodGhpcykuYXR0cigiZGF0YS1lcnJvci1kaXNwbGF5Iik7CiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIEFwcC5ibG9ja1VJKHt0YXJnZXQ6IGVsLCBpY29uT25seTogdHJ1ZX0pOwogICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXMpIAogICAgICAgICAgICAgICAgICAgIHsgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgQXBwLnVuYmxvY2tVSShlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmh0bWwocmVzKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbih4aHIsIGFqYXhPcHRpb25zLCB0aHJvd25FcnJvcikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFwcC51bmJsb2NrVUkoZWwpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXNnID0gJ0Vycm9yIG9uIHJlbG9hZGluZyB0aGUgY29udGVudC4gUGxlYXNlIGNoZWNrIHlvdXIgY29ubmVjdGlvbiBhbmQgdHJ5IGFnYWluLic7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvciA9PSAidG9hc3RyIiAmJiB0b2FzdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcihtc2cpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yID09ICJub3RpZmljOCIgJiYgJC5ub3RpZmljOCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5ub3RpZmljOCgnemluZGV4JywgMTE1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5ub3RpZmljOChtc2csIHt0aGVtZTogJ3J1YnknLCBsaWZlOiAzMDAwfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGVydChtc2cpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBmb3IgZGVtbyBwdXJwb3NlCiAgICAgICAgICAgICAgICBBcHAuYmxvY2tVSSh7dGFyZ2V0OiBlbCwgaWNvbk9ubHk6IHRydWV9KTsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBBcHAudW5ibG9ja1VJKGVsKTsKICAgICAgICAgICAgICAgIH0sIDEwMDApOwogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgfSk7CgogICAgICAgIC8vIGxvYWQgYWpheCBkYXRhIG9uIHBhZ2UgaW5pdAogICAgICAgICQoJy5wb3J0bGV0IC5wb3J0bGV0LXRpdGxlIGEucmVsb2FkW2RhdGEtbG9hZD0idHJ1ZSJdJykuY2xpY2soKTsKCiAgICAgICAgalF1ZXJ5KCdib2R5Jykub24oJ2NsaWNrJywgJy5wb3J0bGV0ID4gLnBvcnRsZXQtdGl0bGUgPiAudG9vbHMgPiAuY29sbGFwc2UsIC5wb3J0bGV0IC5wb3J0bGV0LXRpdGxlID4gLnRvb2xzID4gLmV4cGFuZCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdmFyIGVsID0galF1ZXJ5KHRoaXMpLmNsb3Nlc3QoIi5wb3J0bGV0IikuY2hpbGRyZW4oIi5wb3J0bGV0LWJvZHkiKTsKICAgICAgICAgICAgaWYgKGpRdWVyeSh0aGlzKS5oYXNDbGFzcygiY29sbGFwc2UiKSkgewogICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlbW92ZUNsYXNzKCJjb2xsYXBzZSIpLmFkZENsYXNzKCJleHBhbmQiKTsKICAgICAgICAgICAgICAgIGVsLnNsaWRlVXAoMjAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcygiZXhwYW5kIikuYWRkQ2xhc3MoImNvbGxhcHNlIik7CiAgICAgICAgICAgICAgICBlbC5zbGlkZURvd24oMjAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZXMgY3VzdG9tIGNoZWNrYm94ZXMgJiByYWRpb3MgdXNpbmcgalF1ZXJ5IFVuaWZvcm0gcGx1Z2luCiAgICB2YXIgaGFuZGxlVW5pZm9ybSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWpRdWVyeSgpLnVuaWZvcm0pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgdGVzdCA9ICQoImlucHV0W3R5cGU9Y2hlY2tib3hdOm5vdCgudG9nZ2xlLCAubWFrZS1zd2l0Y2gpLCBpbnB1dFt0eXBlPXJhZGlvXTpub3QoLnRvZ2dsZSwgLnN0YXIsIC5tYWtlLXN3aXRjaCkiKTsKICAgICAgICBpZiAodGVzdC5zaXplKCkgPiAwKSB7CiAgICAgICAgICAgIHRlc3QuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5wYXJlbnRzKCIuY2hlY2tlciIpLnNpemUoKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS51bmlmb3JtKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgaGFuZGxlQm9vdHN0cmFwU3dpdGNoID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghalF1ZXJ5KCkuYm9vdHN0cmFwU3dpdGNoKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgJCgnLm1ha2Utc3dpdGNoJykuYm9vdHN0cmFwU3dpdGNoKCk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBCb290c3RyYXAgQWNjb3JkaW9ucy4KICAgIHZhciBoYW5kbGVBY2NvcmRpb25zID0gZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSgnYm9keScpLm9uKCdzaG93bi5icy5jb2xsYXBzZScsICcuYWNjb3JkaW9uLnNjcm9sbGFibGUnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBBcHAuc2Nyb2xsVG8oJChlLnRhcmdldCkpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZXMgQm9vdHN0cmFwIFRhYnMuCiAgICB2YXIgaGFuZGxlVGFicyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBmaXggY29udGVudCBoZWlnaHQgb24gdGFiIGNsaWNrCiAgICAgICAgJCgnYm9keScpLm9uKCdzaG93bi5icy50YWInLCAnLm5hdi5uYXYtdGFicycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9hY3RpdmF0ZSB0YWIgaWYgdGFiIGlkIHByb3ZpZGVkIGluIHRoZSBVUkwKICAgICAgICBpZiAobG9jYXRpb24uaGFzaCkgewogICAgICAgICAgICB2YXIgdGFiaWQgPSBsb2NhdGlvbi5oYXNoLnN1YnN0cigxKTsKICAgICAgICAgICAgJCgnYVtocmVmPSIjJyArIHRhYmlkICsgJyJdJykucGFyZW50cygnLnRhYi1wYW5lOmhpZGRlbicpLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHZhciB0YWJpZCA9ICQodGhpcykuYXR0cigiaWQiKTsKICAgICAgICAgICAgICAgICQoJ2FbaHJlZj0iIycgKyB0YWJpZCArICciXScpLmNsaWNrKCk7ICAgIAogICAgICAgICAgICB9KTsgICAgICAgICAgICAKICAgICAgICAgICAgJCgnYVtocmVmPSIjJyArIHRhYmlkICsgJyJdJykuY2xpY2soKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gSGFuZGxlcyBCb290c3RyYXAgTW9kYWxzLgogICAgdmFyIGhhbmRsZU1vZGFscyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBmaXggc3RhY2thYmxlIG1vZGFsIGlzc3VlOiB3aGVuIDIgb3IgbW9yZSBtb2RhbHMgb3BlbmVkLCBjbG9zaW5nIG9uZSBvZiBtb2RhbCB3aWxsIHJlbW92ZSAubW9kYWwtb3BlbiBjbGFzcy4gCiAgICAgICAgJCgnYm9keScpLm9uKCdoaWRlLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgIGlmICgkKCcubW9kYWw6dmlzaWJsZScpLnNpemUoKSA+IDEgJiYgJCgnaHRtbCcpLmhhc0NsYXNzKCdtb2RhbC1vcGVuJykgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAkKCdodG1sJykuYWRkQ2xhc3MoJ21vZGFsLW9wZW4nKTsKICAgICAgICAgICB9IGVsc2UgaWYgKCQoJy5tb2RhbDp2aXNpYmxlJykuc2l6ZSgpIDw9IDEpIHsKICAgICAgICAgICAgICAkKCdodG1sJykucmVtb3ZlQ2xhc3MoJ21vZGFsLW9wZW4nKTsKICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICQoJ2JvZHknKS5vbignc2hvdy5icy5tb2RhbCcsICcubW9kYWwnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCJtb2RhbC1zY3JvbGwiKSkgewogICAgICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCJtb2RhbC1vcGVuLW5vc2Nyb2xsIik7CiAgICAgICAgICAgIH0gCiAgICAgICAgfSk7CgogICAgICAgICQoJ2JvZHknKS5vbignaGlkZS5icy5tb2RhbCcsICcubW9kYWwnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygibW9kYWwtb3Blbi1ub3Njcm9sbCIpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZXMgQm9vdHN0cmFwIFRvb2x0aXBzLgogICAgdmFyIGhhbmRsZVRvb2x0aXBzID0gZnVuY3Rpb24gKCkgewogICAgICAgalF1ZXJ5KCcudG9vbHRpcHMnKS50b29sdGlwKCk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBCb290c3RyYXAgRHJvcGRvd25zCiAgICB2YXIgaGFuZGxlRHJvcGRvd25zID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8qCiAgICAgICAgICBIb2xkIGRyb3Bkb3duIG9uIGNsaWNrICAKICAgICAgICAqLwogICAgICAgICQoJ2JvZHknKS5vbignY2xpY2snLCAnLmRyb3Bkb3duLW1lbnUuaG9sZC1vbi1jbGljaycsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlIEhvd2VyIERyb3Bkb3ducwogICAgdmFyIGhhbmRsZURyb3Bkb3duSG92ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgnW2RhdGEtaG92ZXI9ImRyb3Bkb3duIl0nKS5kcm9wZG93bkhvdmVyKCk7CiAgICB9CgogICAgdmFyIGhhbmRsZUFsZXJ0cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCdib2R5Jykub24oJ2NsaWNrJywgJ1tkYXRhLWNsb3NlPSJhbGVydCJdJywgZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICQodGhpcykucGFyZW50KCcuYWxlcnQnKS5oaWRlKCk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIEJvb3RzdHJhcCBQb3BvdmVycwoKICAgIC8vIGxhc3QgcG9wZXAgcG9wb3ZlcgogICAgdmFyIGxhc3RQb3BlZFBvcG92ZXI7CgogICAgdmFyIGhhbmRsZVBvcG92ZXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSgnLnBvcG92ZXJzJykucG9wb3ZlcigpOwoKICAgICAgICAvLyBjbG9zZSBsYXN0IHBvcGVkIHBvcG92ZXIKCiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrLmJzLnBvcG92ZXIuZGF0YS1hcGknLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAobGFzdFBvcGVkUG9wb3ZlcikgewogICAgICAgICAgICAgICAgbGFzdFBvcGVkUG9wb3Zlci5wb3BvdmVyKCdoaWRlJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHNjcm9sbGFibGUgY29udGVudHMgdXNpbmcgalF1ZXJ5IFNsaW1TY3JvbGwgcGx1Z2luLgogICAgdmFyIGhhbmRsZVNjcm9sbGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCcuc2Nyb2xsZXInKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGhlaWdodDsKICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cigiZGF0YS1oZWlnaHQiKSkgewogICAgICAgICAgICAgICAgaGVpZ2h0ID0gJCh0aGlzKS5hdHRyKCJkYXRhLWhlaWdodCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVpZ2h0ID0gJCh0aGlzKS5jc3MoJ2hlaWdodCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICQodGhpcykuc2xpbVNjcm9sbCh7CiAgICAgICAgICAgICAgICBhbGxvd1BhZ2VTY3JvbGw6IHRydWUsIC8vIGFsbG93IHBhZ2Ugc2Nyb2xsIHdoZW4gdGhlIGVsZW1lbnQgc2Nyb2xsIGlzIGVuZGVkCiAgICAgICAgICAgICAgICBzaXplOiAnN3B4JywKICAgICAgICAgICAgICAgIGNvbG9yOiAoJCh0aGlzKS5hdHRyKCJkYXRhLWhhbmRsZS1jb2xvciIpICA/ICQodGhpcykuYXR0cigiZGF0YS1oYW5kbGUtY29sb3IiKSA6ICcjYmJiJyksCiAgICAgICAgICAgICAgICByYWlsQ29sb3I6ICgkKHRoaXMpLmF0dHIoImRhdGEtcmFpbC1jb2xvciIpICA/ICQodGhpcykuYXR0cigiZGF0YS1yYWlsLWNvbG9yIikgOiAnI2VhZWFlYScpLAogICAgICAgICAgICAgICAgcG9zaXRpb246IGlzUlRMID8gJ2xlZnQnIDogJ3JpZ2h0JywKICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0LAogICAgICAgICAgICAgICAgYWx3YXlzVmlzaWJsZTogKCQodGhpcykuYXR0cigiZGF0YS1hbHdheXMtdmlzaWJsZSIpID09ICIxIiA/IHRydWUgOiBmYWxzZSksCiAgICAgICAgICAgICAgICByYWlsVmlzaWJsZTogKCQodGhpcykuYXR0cigiZGF0YS1yYWlsLXZpc2libGUiKSA9PSAiMSIgPyB0cnVlIDogZmFsc2UpLAogICAgICAgICAgICAgICAgZGlzYWJsZUZhZGVPdXQ6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBJbWFnZSBQcmV2aWV3IHVzaW5nIGpRdWVyeSBGYW5jeWJveCBwbHVnaW4KICAgIHZhciBoYW5kbGVGYW5jeWJveCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWpRdWVyeS5mYW5jeWJveCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoalF1ZXJ5KCIuZmFuY3lib3gtYnV0dG9uIikuc2l6ZSgpID4gMCkgewogICAgICAgICAgICBqUXVlcnkoIi5mYW5jeWJveC1idXR0b24iKS5mYW5jeWJveCh7CiAgICAgICAgICAgICAgICBncm91cEF0dHI6ICdkYXRhLXJlbCcsCiAgICAgICAgICAgICAgICBwcmV2RWZmZWN0OiAnbm9uZScsCiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0OiAnbm9uZScsCiAgICAgICAgICAgICAgICBjbG9zZUJ0bjogdHJ1ZSwKICAgICAgICAgICAgICAgIGhlbHBlcnM6IHsKICAgICAgICAgICAgICAgICAgICB0aXRsZTogewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW5zaWRlJwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEZpeCBpbnB1dCBwbGFjZWhvbGRlciBpc3N1ZSBmb3IgSUU4IGFuZCBJRTkKICAgIHZhciBoYW5kbGVGaXhJbnB1dFBsYWNlaG9sZGVyRm9ySUUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy9maXggaHRtbDUgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGZvciBpZTcgJiBpZTgKICAgICAgICBpZiAoaXNJRTggfHwgaXNJRTkpIHsgLy8gaWU4ICYgaWU5CiAgICAgICAgICAgIC8vIHRoaXMgaXMgaHRtbDUgcGxhY2Vob2xkZXIgZml4IGZvciBpbnB1dHMsIGlucHV0cyB3aXRoIHBsYWNlaG9sZGVyLW5vLWZpeCBjbGFzcyB3aWxsIGJlIHNraXBwZWQoZS5nOiB3ZSBuZWVkIHRoaXMgZm9yIHBhc3N3b3JkIGZpZWxkcykKICAgICAgICAgICAgalF1ZXJ5KCdpbnB1dFtwbGFjZWhvbGRlcl06bm90KC5wbGFjZWhvbGRlci1uby1maXgpLCB0ZXh0YXJlYVtwbGFjZWhvbGRlcl06bm90KC5wbGFjZWhvbGRlci1uby1maXgpJykuZWFjaChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0galF1ZXJ5KHRoaXMpOwoKICAgICAgICAgICAgICAgIGlmIChpbnB1dC52YWwoKSA9PSAnJyAmJiBpbnB1dC5hdHRyKCJwbGFjZWhvbGRlciIpICE9ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQuYWRkQ2xhc3MoInBsYWNlaG9sZGVyIikudmFsKGlucHV0LmF0dHIoJ3BsYWNlaG9sZGVyJykpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlucHV0LmZvY3VzKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQudmFsKCkgPT0gaW5wdXQuYXR0cigncGxhY2Vob2xkZXInKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWwoJycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlucHV0LmJsdXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC52YWwoKSA9PSAnJyB8fCBpbnB1dC52YWwoKSA9PSBpbnB1dC5hdHRyKCdwbGFjZWhvbGRlcicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChpbnB1dC5hdHRyKCdwbGFjZWhvbGRlcicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEhhbmRsZSBmdWxsIHNjcmVlbiBtb2RlIHRvZ2dsZQogICAgdmFyIGhhbmRsZUZ1bGxTY3JlZW5Nb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gbW96ZnVsbHNjcmVlbmVycm9yIGV2ZW50IGhhbmRsZXIKICAgICAgIAogICAgICAgIC8vIHRvZ2dsZSBmdWxsIHNjcmVlbgogICAgICAgIGZ1bmN0aW9uIHRvZ2dsZUZ1bGxTY3JlZW4oKSB7CiAgICAgICAgICBpZiAoIWRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50ICYmICAgIC8vIGFsdGVybmF0aXZlIHN0YW5kYXJkIG1ldGhvZAogICAgICAgICAgICAgICFkb2N1bWVudC5tb3pGdWxsU2NyZWVuRWxlbWVudCAmJiAhZG9jdW1lbnQud2Via2l0RnVsbHNjcmVlbkVsZW1lbnQpIHsgIC8vIGN1cnJlbnQgd29ya2luZyBtZXRob2RzCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5jYW5jZWxGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICBkb2N1bWVudC5tb3pDYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQud2Via2l0Q2FuY2VsRnVsbFNjcmVlbikgewogICAgICAgICAgICAgIGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJCgnI3RyaWdnZXJfZnVsbHNjcmVlbicpLmNsaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0b2dnbGVGdWxsU2NyZWVuKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlIFNlbGVjdDIgRHJvcGRvd25zCiAgICB2YXIgaGFuZGxlU2VsZWN0MiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChqUXVlcnkoKS5zZWxlY3QyKSB7CiAgICAgICAgICAgICQoJy5zZWxlY3QybWUnKS5zZWxlY3QyKHsKICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiU2VsZWN0IiwKICAgICAgICAgICAgICAgIGFsbG93Q2xlYXI6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEhhbmRsZSBUaGVtZSBTZXR0aW5ncwogICAgdmFyIGhhbmRsZVRoZW1lID0gZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgcGFuZWwgPSAkKCcudGhlbWUtcGFuZWwnKTsKCiAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygncGFnZS1ib3hlZCcpID09IGZhbHNlKSB7CiAgICAgICAgICAgICQoJy5sYXlvdXQtb3B0aW9uJywgcGFuZWwpLnZhbCgiZmx1aWQiKTsKICAgICAgICB9CgogICAgICAgICQoJy5zaWRlYmFyLW9wdGlvbicsIHBhbmVsKS52YWwoImRlZmF1bHQiKTsKICAgICAgICAkKCcuaGVhZGVyLW9wdGlvbicsIHBhbmVsKS52YWwoImZpeGVkIik7CiAgICAgICAgJCgnLmZvb3Rlci1vcHRpb24nLCBwYW5lbCkudmFsKCJkZWZhdWx0Iik7CiAgICAgICAgaWYgKCAkKCcuc2lkZWJhci1wb3Mtb3B0aW9uJykuYXR0cigiZGlzYWJsZWQiKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgJCgnLnNpZGViYXItcG9zLW9wdGlvbicsIHBhbmVsKS52YWwoQXBwLmlzUlRMKCkgPyAncmlnaHQnIDogJ2xlZnQnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy9oYW5kbGUgdGhlbWUgbGF5b3V0CiAgICAgICAgdmFyIHJlc2V0TGF5b3V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAkKCJib2R5IikuCiAgICAgICAgICAgIHJlbW92ZUNsYXNzKCJwYWdlLWJveGVkIikuCiAgICAgICAgICAgIHJlbW92ZUNsYXNzKCJwYWdlLWZvb3Rlci1maXhlZCIpLgogICAgICAgICAgICByZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLWZpeGVkIikuCiAgICAgICAgICAgIHJlbW92ZUNsYXNzKCJwYWdlLWhlYWRlci1maXhlZCIpLgogICAgICAgICAgICByZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLXJldmVyc2VkIik7CgogICAgICAgICAgICAkKCcuaGVhZGVyID4gLmhlYWRlci1pbm5lcicpLnJlbW92ZUNsYXNzKCJjb250YWluZXIiKTsKCiAgICAgICAgICAgIGlmICgkKCcucGFnZS1jb250YWluZXInKS5wYXJlbnQoIi5jb250YWluZXIiKS5zaXplKCkgPT09IDEpIHsKICAgICAgICAgICAgICAgICQoJy5wYWdlLWNvbnRhaW5lcicpLmluc2VydEFmdGVyKCdib2R5ID4gLmNsZWFyZml4Jyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgkKCcuZm9vdGVyID4gLmNvbnRhaW5lcicpLnNpemUoKSA9PT0gMSkgewogICAgICAgICAgICAgICAgJCgnLmZvb3RlcicpLmh0bWwoJCgnLmZvb3RlciA+IC5jb250YWluZXInKS5odG1sKCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCQoJy5mb290ZXInKS5wYXJlbnQoIi5jb250YWluZXIiKS5zaXplKCkgPT09IDEpIHsKICAgICAgICAgICAgICAgICQoJy5mb290ZXInKS5pbnNlcnRBZnRlcignLnBhZ2UtY29udGFpbmVyJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQoJ2JvZHkgPiAuY29udGFpbmVyJykucmVtb3ZlKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGFzdFNlbGVjdGVkTGF5b3V0ID0gJyc7CgogICAgICAgIHZhciBzZXRMYXlvdXQgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICB2YXIgbGF5b3V0T3B0aW9uID0gJCgnLmxheW91dC1vcHRpb24nLCBwYW5lbCkudmFsKCk7CiAgICAgICAgICAgIHZhciBzaWRlYmFyT3B0aW9uID0gJCgnLnNpZGViYXItb3B0aW9uJywgcGFuZWwpLnZhbCgpOwogICAgICAgICAgICB2YXIgaGVhZGVyT3B0aW9uID0gJCgnLmhlYWRlci1vcHRpb24nLCBwYW5lbCkudmFsKCk7CiAgICAgICAgICAgIHZhciBmb290ZXJPcHRpb24gPSAkKCcuZm9vdGVyLW9wdGlvbicsIHBhbmVsKS52YWwoKTsKICAgICAgICAgICAgdmFyIHNpZGViYXJQb3NPcHRpb24gPSAkKCcuc2lkZWJhci1wb3Mtb3B0aW9uJywgcGFuZWwpLnZhbCgpOwoKICAgICAgICAgICAgaWYgKHNpZGViYXJPcHRpb24gPT0gImZpeGVkIiAmJiBoZWFkZXJPcHRpb24gPT0gImRlZmF1bHQiKSB7CiAgICAgICAgICAgICAgICBhbGVydCgnRGVmYXVsdCBIZWFkZXIgd2l0aCBGaXhlZCBTaWRlYmFyIG9wdGlvbiBpcyBub3Qgc3VwcG9ydGVkLiBQcm9jZWVkIHdpdGggRml4ZWQgSGVhZGVyIHdpdGggRml4ZWQgU2lkZWJhci4nKTsKICAgICAgICAgICAgICAgICQoJy5oZWFkZXItb3B0aW9uJywgcGFuZWwpLnZhbCgiZml4ZWQiKTsKICAgICAgICAgICAgICAgICQoJy5zaWRlYmFyLW9wdGlvbicsIHBhbmVsKS52YWwoImZpeGVkIik7CiAgICAgICAgICAgICAgICBzaWRlYmFyT3B0aW9uID0gJ2ZpeGVkJzsKICAgICAgICAgICAgICAgIGhlYWRlck9wdGlvbiA9ICdmaXhlZCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc2V0TGF5b3V0KCk7IC8vIHJlc2V0IGxheW91dCB0byBkZWZhdWx0IHN0YXRlCgogICAgICAgICAgICBpZiAobGF5b3V0T3B0aW9uID09PSAiYm94ZWQiKSB7CiAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2UtYm94ZWQiKTsKCiAgICAgICAgICAgICAgICAvLyBzZXQgaGVhZGVyCiAgICAgICAgICAgICAgICAkKCcuaGVhZGVyID4gLmhlYWRlci1pbm5lcicpLmFkZENsYXNzKCJjb250YWluZXIiKTsKICAgICAgICAgICAgICAgIHZhciBjb250ID0gJCgnYm9keSA+IC5jbGVhcmZpeCcpLmFmdGVyKCc8ZGl2IGNsYXNzPSJjb250YWluZXIiPjwvZGl2PicpOwoKICAgICAgICAgICAgICAgIC8vIHNldCBjb250ZW50CiAgICAgICAgICAgICAgICAkKCcucGFnZS1jb250YWluZXInKS5hcHBlbmRUbygnYm9keSA+IC5jb250YWluZXInKTsKCiAgICAgICAgICAgICAgICAvLyBzZXQgZm9vdGVyCiAgICAgICAgICAgICAgICBpZiAoZm9vdGVyT3B0aW9uID09PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLmZvb3RlcicpLmh0bWwoJzxkaXYgY2xhc3M9ImNvbnRhaW5lciI+JyArICQoJy5mb290ZXInKS5odG1sKCkgKyAnPC9kaXY+Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoJy5mb290ZXInKS5hcHBlbmRUbygnYm9keSA+IC5jb250YWluZXInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxhc3RTZWxlY3RlZExheW91dCAhPSBsYXlvdXRPcHRpb24pIHsKICAgICAgICAgICAgICAgIC8vbGF5b3V0IGNoYW5nZWQsIHJ1biByZXNwb25zaXZlIGhhbmRsZXI6CiAgICAgICAgICAgICAgICBydW5SZXNwb25zaXZlSGFuZGxlcnMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0U2VsZWN0ZWRMYXlvdXQgPSBsYXlvdXRPcHRpb247CgogICAgICAgICAgICAvL2hlYWRlcgogICAgICAgICAgICBpZiAoaGVhZGVyT3B0aW9uID09PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2UtaGVhZGVyLWZpeGVkIik7CiAgICAgICAgICAgICAgICAkKCIuaGVhZGVyIikucmVtb3ZlQ2xhc3MoIm5hdmJhci1zdGF0aWMtdG9wIikuYWRkQ2xhc3MoIm5hdmJhci1maXhlZC10b3AiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQoImJvZHkiKS5yZW1vdmVDbGFzcygicGFnZS1oZWFkZXItZml4ZWQiKTsKICAgICAgICAgICAgICAgICQoIi5oZWFkZXIiKS5yZW1vdmVDbGFzcygibmF2YmFyLWZpeGVkLXRvcCIpLmFkZENsYXNzKCJuYXZiYXItc3RhdGljLXRvcCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3NpZGViYXIKICAgICAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygncGFnZS1mdWxsLXdpZHRoJykgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2lkZWJhck9wdGlvbiA9PT0gJ2ZpeGVkJykgewogICAgICAgICAgICAgICAgICAgICQoImJvZHkiKS5hZGRDbGFzcygicGFnZS1zaWRlYmFyLWZpeGVkIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoImJvZHkiKS5yZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLWZpeGVkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vZm9vdGVyIAogICAgICAgICAgICBpZiAoZm9vdGVyT3B0aW9uID09PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2UtZm9vdGVyLWZpeGVkIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKCJib2R5IikucmVtb3ZlQ2xhc3MoInBhZ2UtZm9vdGVyLWZpeGVkIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vc2lkZWJhciBwb3NpdGlvbgogICAgICAgICAgICBpZiAoQXBwLmlzUlRMKCkpIHsKICAgICAgICAgICAgICAgIGlmIChzaWRlYmFyUG9zT3B0aW9uID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2Utc2lkZWJhci1yZXZlcnNlZCIpOwogICAgICAgICAgICAgICAgICAgICQoJyNmcm9udGVuZC1saW5rJykudG9vbHRpcCgnZGVzdHJveScpLnRvb2x0aXAoe3BsYWNlbWVudDogJ3JpZ2h0J30pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCJib2R5IikucmVtb3ZlQ2xhc3MoInBhZ2Utc2lkZWJhci1yZXZlcnNlZCIpOwogICAgICAgICAgICAgICAgICAgICQoJyNmcm9udGVuZC1saW5rJykudG9vbHRpcCgnZGVzdHJveScpLnRvb2x0aXAoe3BsYWNlbWVudDogJ2xlZnQnfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoc2lkZWJhclBvc09wdGlvbiA9PT0gJ3JpZ2h0JykgewogICAgICAgICAgICAgICAgICAgICQoImJvZHkiKS5hZGRDbGFzcygicGFnZS1zaWRlYmFyLXJldmVyc2VkIik7CiAgICAgICAgICAgICAgICAgICAgJCgnI2Zyb250ZW5kLWxpbmsnKS50b29sdGlwKCdkZXN0cm95JykudG9vbHRpcCh7cGxhY2VtZW50OiAnbGVmdCd9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgiYm9keSIpLnJlbW92ZUNsYXNzKCJwYWdlLXNpZGViYXItcmV2ZXJzZWQiKTsKICAgICAgICAgICAgICAgICAgICAkKCcjZnJvbnRlbmQtbGluaycpLnRvb2x0aXAoJ2Rlc3Ryb3knKS50b29sdGlwKHtwbGFjZW1lbnQ6ICdyaWdodCd9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsgLy8gZml4IGNvbnRlbnQgaGVpZ2h0ICAgICAgICAgICAgCiAgICAgICAgICAgIGhhbmRsZUZpeGVkU2lkZWJhcigpOyAvLyByZWluaXRpYWxpemUgZml4ZWQgc2lkZWJhcgogICAgICAgICAgICBoYW5kbGVGaXhlZFNpZGViYXJIb3ZlcmFibGUoKTsgLy8gcmVpbml0aWFsaXplIGZpeGVkIHNpZGViYXIgaG92ZXIgZWZmZWN0CiAgICAgICAgfQoKICAgICAgICAvLyBoYW5kbGUgdGhlbWUgY29sb3JzCiAgICAgICAgdmFyIHNldENvbG9yID0gZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgICAgIHZhciBjb2xvcl8gPSAoQXBwLmlzUlRMKCkgPyBjb2xvciArICctcnRsJyA6IGNvbG9yKTsKICAgICAgICAgICAgJCgnI3N0eWxlX2NvbG9yJykuYXR0cigiaHJlZiIsICJhc3NldHMvY3NzL3RoZW1lcy8iICsgY29sb3JfICsgIi5jc3MiKTsKICAgICAgICAgICAgaWYgKCQuY29va2llKSB7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJC5jb29raWUoJ3N0eWxlX2NvbG9yJywgY29sb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAkKCcudG9nZ2xlcicsIHBhbmVsKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICQoJy50b2dnbGVyJykuaGlkZSgpOwogICAgICAgICAgICAkKCcudG9nZ2xlci1jbG9zZScpLnNob3coKTsKICAgICAgICAgICAgJCgnLnRoZW1lLXBhbmVsID4gLnRoZW1lLW9wdGlvbnMnKS5zaG93KCk7CiAgICAgICAgfSk7CgogICAgICAgICQoJy50b2dnbGVyLWNsb3NlJywgcGFuZWwpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgJCgnLnRvZ2dsZXInKS5zaG93KCk7CiAgICAgICAgICAgICQoJy50b2dnbGVyLWNsb3NlJykuaGlkZSgpOwogICAgICAgICAgICAkKCcudGhlbWUtcGFuZWwgPiAudGhlbWUtb3B0aW9ucycpLmhpZGUoKTsKICAgICAgICB9KTsKCiAgICAgICAgJCgnLnRoZW1lLWNvbG9ycyA+IHVsID4gbGknLCBwYW5lbCkuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY29sb3IgPSAkKHRoaXMpLmF0dHIoImRhdGEtc3R5bGUiKTsKICAgICAgICAgICAgc2V0Q29sb3IoY29sb3IpOwogICAgICAgICAgICAkKCd1bCA+IGxpJywgcGFuZWwpLnJlbW92ZUNsYXNzKCJjdXJyZW50Iik7CiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImN1cnJlbnQiKTsKICAgICAgICB9KTsKCiAgICAgICAgJCgnLmxheW91dC1vcHRpb24sIC5oZWFkZXItb3B0aW9uLCAuc2lkZWJhci1vcHRpb24sIC5mb290ZXItb3B0aW9uLCAuc2lkZWJhci1wb3Mtb3B0aW9uJywgcGFuZWwpLmNoYW5nZShzZXRMYXlvdXQpOwoKICAgICAgICBpZiAoJC5jb29raWUgJiYgJC5jb29raWUoJ3N0eWxlX2NvbG9yJykpIHsKICAgICAgICAgICAgc2V0Q29sb3IoJC5jb29raWUoJ3N0eWxlX2NvbG9yJykpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyogRU5EOkNPUkUgSEFORExFUlMgKi8vCgogICAgcmV0dXJuIHsKCiAgICAgICAgLy9tYWluIGZ1bmN0aW9uIHRvIGluaXRpYXRlIHRoZSB0aGVtZQogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIC8vSU1QT1JUQU5UISEhOiBEbyBub3QgbW9kaWZ5IHRoZSBjb3JlIGhhbmRsZXJzIGNhbGwgb3JkZXIuCgogICAgICAgICAgICAvL2NvcmUgaGFuZGxlcnMKICAgICAgICAgICAgaGFuZGxlSW5pdCgpOyAvLyBpbml0aWFsaXplIGNvcmUgdmFyaWFibGVzCiAgICAgICAgICAgIGhhbmRsZVJlc3BvbnNpdmVPblJlc2l6ZSgpOyAvLyBzZXQgYW5kIGhhbmRsZSByZXNwb25zaXZlICAgIAogICAgICAgICAgICBoYW5kbGVVbmlmb3JtKCk7IC8vIGhhbmZsZSBjdXN0b20gcmFkaW8gJiBjaGVja2JveGVzCiAgICAgICAgICAgIGhhbmRsZUJvb3RzdHJhcFN3aXRjaCgpOyAvLyBoYW5kbGUgYm9vdHN0cmFwIHN3aXRjaCBwbHVnaW4KICAgICAgICAgICAgaGFuZGxlU2Nyb2xsZXJzKCk7IC8vIGhhbmRsZXMgc2xpbSBzY3JvbGxpbmcgY29udGVudHMgCiAgICAgICAgICAgIGhhbmRsZVJlc3BvbnNpdmVPbkluaXQoKTsgLy8gaGFuZGxlciByZXNwb25zaXZlIGVsZW1lbnRzIG9uIHBhZ2UgbG9hZAoKICAgICAgICAgICAgLy9sYXlvdXQgaGFuZGxlcnMKICAgICAgICAgICAgaGFuZGxlRml4ZWRTaWRlYmFyKCk7IC8vIGhhbmRsZXMgZml4ZWQgc2lkZWJhciBtZW51CiAgICAgICAgICAgIGhhbmRsZUZpeGVkU2lkZWJhckhvdmVyYWJsZSgpOyAvLyBoYW5kbGVzIGZpeGVkIHNpZGViYXIgb24gaG92ZXIgZWZmZWN0IAogICAgICAgICAgICBoYW5kbGVTaWRlYmFyTWVudSgpOyAvLyBoYW5kbGVzIG1haW4gbWVudQogICAgICAgICAgICBoYW5kbGVIb3Jpem9udGFsTWVudSgpOyAvLyBoYW5kbGVzIGhvcml6b250YWwgbWVudQogICAgICAgICAgICBoYW5kbGVTaWRlYmFyVG9nZ2xlcigpOyAvLyBoYW5kbGVzIHNpZGViYXIgaGlkZS9zaG93ICAgICAgICAgICAgCiAgICAgICAgICAgIGhhbmRsZUZpeElucHV0UGxhY2Vob2xkZXJGb3JJRSgpOyAvLyBmaXhlcy9lbmFibGVzIGh0bWw1IHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgSUU5LCBJRTgKICAgICAgICAgICAgaGFuZGxlR29Ub3AoKTsgLy9oYW5kbGVzIHNjcm9sbCB0byB0b3AgZnVuY3Rpb25hbGl0eSBpbiB0aGUgZm9vdGVyCiAgICAgICAgICAgIGhhbmRsZVRoZW1lKCk7IC8vIGhhbmRsZXMgc3R5bGUgY3VzdG9tZXIgdG9vbAoKICAgICAgICAgICAgLy91aSBjb21wb25lbnQgaGFuZGxlcnMKICAgICAgICAgICAgaGFuZGxlRmFuY3lib3goKSAvLyBoYW5kbGUgZmFuY3kgYm94CiAgICAgICAgICAgIGhhbmRsZVNlbGVjdDIoKTsgLy8gaGFuZGxlIGN1c3RvbSBTZWxlY3QyIGRyb3Bkb3ducwogICAgICAgICAgICBoYW5kbGVQb3J0bGV0VG9vbHMoKTsgLy8gaGFuZGxlcyBwb3J0bGV0IGFjdGlvbiBiYXIgZnVuY3Rpb25hbGl0eShyZWZyZXNoLCBjb25maWd1cmUsIHRvZ2dsZSwgcmVtb3ZlKQogICAgICAgICAgICBoYW5kbGVBbGVydHMoKTsgLy9oYW5kbGUgY2xvc2FibGVkIGFsZXJ0cwogICAgICAgICAgICBoYW5kbGVEcm9wZG93bnMoKTsgLy8gaGFuZGxlIGRyb3Bkb3ducwogICAgICAgICAgICBoYW5kbGVUYWJzKCk7IC8vIGhhbmRsZSB0YWJzCiAgICAgICAgICAgIGhhbmRsZVRvb2x0aXBzKCk7IC8vIGhhbmRsZSBib290c3RyYXAgdG9vbHRpcHMKICAgICAgICAgICAgaGFuZGxlUG9wb3ZlcnMoKTsgLy8gaGFuZGxlcyBib290c3RyYXAgcG9wb3ZlcnMKICAgICAgICAgICAgaGFuZGxlQWNjb3JkaW9ucygpOyAvL2hhbmRsZXMgYWNjb3JkaW9ucyAKICAgICAgICAgICAgaGFuZGxlTW9kYWxzKCk7IC8vIGhhbmRsZSBtb2RhbHMKICAgICAgICAgICAgaGFuZGxlRnVsbFNjcmVlbk1vZGUoKTsgLy8gaGFuZGxlcyBmdWxsIHNjcmVlbgogICAgICAgIH0sCgogICAgICAgIC8vbWFpbiBmdW5jdGlvbiB0byBpbml0aWF0ZSBjb3JlIGphdmFzY3JpcHQgYWZ0ZXIgYWpheCBjb21wbGV0ZQogICAgICAgIGluaXRBamF4OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGhhbmRsZVNjcm9sbGVycygpOyAvLyBoYW5kbGVzIHNsaW0gc2Nyb2xsaW5nIGNvbnRlbnRzIAogICAgICAgICAgICBoYW5kbGVTZWxlY3QyKCk7IC8vIGhhbmRsZSBjdXN0b20gU2VsZWN0MiBkcm9wZG93bnMKICAgICAgICAgICAgaGFuZGxlRHJvcGRvd25zKCk7IC8vIGhhbmRsZSBkcm9wZG93bnMKICAgICAgICAgICAgaGFuZGxlVG9vbHRpcHMoKTsgLy8gaGFuZGxlIGJvb3RzdHJhcCB0b29sdGlwcwogICAgICAgICAgICBoYW5kbGVQb3BvdmVycygpOyAvLyBoYW5kbGVzIGJvb3RzdHJhcCBwb3BvdmVycwogICAgICAgICAgICBoYW5kbGVBY2NvcmRpb25zKCk7IC8vaGFuZGxlcyBhY2NvcmRpb25zIAogICAgICAgICAgICBoYW5kbGVVbmlmb3JtKCk7IC8vIGhhbmZsZSBjdXN0b20gcmFkaW8gJiBjaGVja2JveGVzICAgICAKICAgICAgICAgICAgaGFuZGxlQm9vdHN0cmFwU3dpdGNoKCk7IC8vIGhhbmRsZSBib290c3RyYXAgc3dpdGNoIHBsdWdpbgogICAgICAgICAgICBoYW5kbGVEcm9wZG93bkhvdmVyKCkgLy8gaGFuZGxlcyBkcm9wZG93biBob3ZlciAgICAgICAKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBmdW5jdGlvbiB0byBmaXggdGhlIHNpZGViYXIgYW5kIGNvbnRlbnQgaGVpZ2h0IGFjY29yZGluZ2x5CiAgICAgICAgZml4Q29udGVudEhlaWdodDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOwogICAgICAgIH0sCgogICAgICAgIC8vcHVibGljIGZ1bmN0aW9uIHRvIHJlbWVtYmVyIGxhc3Qgb3BlbmVkIHBvcG92ZXIgdGhhdCBuZWVkcyB0byBiZSBjbG9zZWQgb24gY2xpY2sKICAgICAgICBzZXRMYXN0UG9wZWRQb3BvdmVyOiBmdW5jdGlvbiAoZWwpIHsKICAgICAgICAgICAgbGFzdFBvcGVkUG9wb3ZlciA9IGVsOwogICAgICAgIH0sCgogICAgICAgIC8vcHVibGljIGZ1bmN0aW9uIHRvIGFkZCBjYWxsYmFjayBhIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgY2FsbGVkIG9uIHdpbmRvdyByZXNpemUKICAgICAgICBhZGRSZXNwb25zaXZlSGFuZGxlcjogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgICAgICAgcmVzcG9uc2l2ZUhhbmRsZXJzLnB1c2goZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gdXNlZnVsIGZ1bmN0aW9uIHRvIG1ha2UgZXF1YWwgaGVpZ2h0IGZvciBjb250YWN0cyBzdGFuZCBzaWRlIGJ5IHNpZGUKICAgICAgICBzZXRFcXVhbEhlaWdodDogZnVuY3Rpb24gKGVscykgewogICAgICAgICAgICB2YXIgdGFsbGVzdEVsID0gMDsKICAgICAgICAgICAgZWxzID0galF1ZXJ5KGVscyk7CiAgICAgICAgICAgIGVscy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SGVpZ2h0ID0gJCh0aGlzKS5oZWlnaHQoKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SGVpZ2h0ID4gdGFsbGVzdEVsKSB7CiAgICAgICAgICAgICAgICAgICAgdGFsbGVzdENvbHVtbiA9IGN1cnJlbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlbHMuaGVpZ2h0KHRhbGxlc3RFbCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gd3JhcHBlciBmdW5jdGlvbiB0byBzY3JvbGwoZm9jdXMpIHRvIGFuIGVsZW1lbnQKICAgICAgICBzY3JvbGxUbzogZnVuY3Rpb24gKGVsLCBvZmZlc2V0KSB7CiAgICAgICAgICAgIHZhciBwb3MgPSAoZWwgJiYgZWwuc2l6ZSgpID4gMCkgPyBlbC5vZmZzZXQoKS50b3AgOiAwOwoKICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLWhlYWRlci1maXhlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zIC0gJCgnLmhlYWRlcicpLmhlaWdodCgpOyAKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICAgICAgICAgIHBvcyA9IHBvcyArIChvZmZlc2V0ID8gb2ZmZXNldCA6IC0xICogZWwuaGVpZ2h0KCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBqUXVlcnkoJ2h0bWwsYm9keScpLmFuaW1hdGUoewogICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiBwb3MKICAgICAgICAgICAgfSwgJ3Nsb3cnKTsKICAgICAgICB9LAoKICAgICAgICAvLyBmdW5jdGlvbiB0byBzY3JvbGwgdG8gdGhlIHRvcAogICAgICAgIHNjcm9sbFRvcDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBBcHAuc2Nyb2xsVG8oKTsKICAgICAgICB9LAoKICAgICAgICAvLyB3cmFwcGVyIGZ1bmN0aW9uIHRvICBibG9jayBlbGVtZW50KGluZGljYXRlIGxvYWRpbmcpCiAgICAgICAgYmxvY2tVSTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHZhciBodG1sID0gJyc7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmljb25Pbmx5KSB7CiAgICAgICAgICAgICAgICBodG1sID0gJzxkaXYgY2xhc3M9ImxvYWRpbmctbWVzc2FnZSAnICsgKG9wdGlvbnMuYm94ZWQgPyAnbG9hZGluZy1tZXNzYWdlLWJveGVkJyA6ICcnKSsnIj48aW1nIHN0eWxlPSIiIHNyYz0iLi9hc3NldHMvaW1nL2xvYWRpbmctc3Bpbm5lci1ncmV5LmdpZiIgYWxpZ249IiI+PC9kaXY+JzsKICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnRleHRPbmx5KSB7CiAgICAgICAgICAgICAgICBodG1sID0gJzxkaXYgY2xhc3M9ImxvYWRpbmctbWVzc2FnZSAnICsgKG9wdGlvbnMuYm94ZWQgPyAnbG9hZGluZy1tZXNzYWdlLWJveGVkJyA6ICcnKSsnIj48c3Bhbj4mbmJzcDsmbmJzcDsnICsgKG9wdGlvbnMubWVzc2FnZSA/IG9wdGlvbnMubWVzc2FnZSA6ICdMT0FESU5HLi4uJykgKyAnPC9zcGFuPjwvZGl2Pic7CiAgICAgICAgICAgIH0gZWxzZSB7ICAgIAogICAgICAgICAgICAgICAgaHRtbCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nLW1lc3NhZ2UgJyArIChvcHRpb25zLmJveGVkID8gJ2xvYWRpbmctbWVzc2FnZS1ib3hlZCcgOiAnJykrJyI+PGltZyBzdHlsZT0iIiBzcmM9Ii4vYXNzZXRzL2ltZy9sb2FkaW5nLXNwaW5uZXItZ3JleS5naWYiIGFsaWduPSIiPjxzcGFuPiZuYnNwOyZuYnNwOycgKyAob3B0aW9ucy5tZXNzYWdlID8gb3B0aW9ucy5tZXNzYWdlIDogJ0xPQURJTkcuLi4nKSArICc8L3NwYW4+PC9kaXY+JzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMudGFyZ2V0KSB7IC8vIGVsZW1lbnQgYmxvY2tpbmcKICAgICAgICAgICAgICAgIHZhciBlbCA9IGpRdWVyeShvcHRpb25zLnRhcmdldCk7CiAgICAgICAgICAgICAgICBpZiAoZWwuaGVpZ2h0KCkgPD0gKCQod2luZG93KS5oZWlnaHQoKSkpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNlbnJlclkgPSB0cnVlOwogICAgICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWwuYmxvY2soewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGh0bWwsCiAgICAgICAgICAgICAgICAgICAgYmFzZVo6IG9wdGlvbnMuekluZGV4ID8gb3B0aW9ucy56SW5kZXggOiAxMDAwLAogICAgICAgICAgICAgICAgICAgIGNlbnRlclk6IG9wdGlvbnMuY2VucmVyWSAhPSB1bmRlZmluZWQgPyBvcHRpb25zLmNlbnJlclkgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjc3M6IHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAnMTAlJywKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAnMCcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICcwJywKICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAnbm9uZScKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG92ZXJsYXlDU1M6IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBvcHRpb25zLm92ZXJsYXlDb2xvciA/IG9wdGlvbnMub3ZlcmxheUNvbG9yIDogJyMwMDAnLAogICAgICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiBvcHRpb25zLmJveGVkID8gMC4wNSA6IDAuMSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogJ3dhaXQnCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7IC8vIHBhZ2UgYmxvY2tpbmcKICAgICAgICAgICAgICAgICQuYmxvY2tVSSh7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogaHRtbCwKICAgICAgICAgICAgICAgICAgICBiYXNlWjogb3B0aW9ucy56SW5kZXggPyBvcHRpb25zLnpJbmRleCA6IDEwMDAsCiAgICAgICAgICAgICAgICAgICAgY3NzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogJzAnLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ25vbmUnCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvdmVybGF5Q1NTOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogb3B0aW9ucy5vdmVybGF5Q29sb3IgPyBvcHRpb25zLm92ZXJsYXlDb2xvciA6ICcjMDAwJywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogb3B0aW9ucy5ib3hlZCA/IDAuMDUgOiAwLjEsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogJ3dhaXQnCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICB9LAoKICAgICAgICAvLyB3cmFwcGVyIGZ1bmN0aW9uIHRvICB1bi1ibG9jayBlbGVtZW50KGZpbmlzaCBsb2FkaW5nKQogICAgICAgIHVuYmxvY2tVSTogZnVuY3Rpb24gKHRhcmdldCkgewogICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBqUXVlcnkodGFyZ2V0KS51bmJsb2NrKHsKICAgICAgICAgICAgICAgICAgICBvblVuYmxvY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRhcmdldCkuY3NzKCdwb3NpdGlvbicsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRhcmdldCkuY3NzKCd6b29tJywgJycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJC51bmJsb2NrVUkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHN0YXJ0UGFnZUxvYWRpbmc6IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgJCgnLnBhZ2UtbG9hZGluZycpLnJlbW92ZSgpOwogICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPSJwYWdlLWxvYWRpbmciPjxpbWcgc3JjPSJhc3NldHMvaW1nL2xvYWRpbmctc3Bpbm5lci1ncmV5LmdpZiIvPiZuYnNwOyZuYnNwOzxzcGFuPicgKyAobWVzc2FnZSA/IG1lc3NhZ2UgOiAnTG9hZGluZy4uLicpICsgJzwvc3Bhbj48L2Rpdj4nKTsKICAgICAgICB9LAoKICAgICAgICBzdG9wUGFnZUxvYWRpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkKCcucGFnZS1sb2FkaW5nJykucmVtb3ZlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gaW5pdGlhbGl6ZXMgdW5pZm9ybSBlbGVtZW50cwogICAgICAgIGluaXRVbmlmb3JtOiBmdW5jdGlvbiAoZWxzKSB7CiAgICAgICAgICAgIGlmIChlbHMpIHsKICAgICAgICAgICAgICAgIGpRdWVyeShlbHMpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLnBhcmVudHMoIi5jaGVja2VyIikuc2l6ZSgpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudW5pZm9ybSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGFuZGxlVW5pZm9ybSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy93cmFwcGVyIGZ1bmN0aW9uIHRvIHVwZGF0ZS9zeW5jIGpxdWVyeSB1bmlmb3JtIGNoZWNrYm94ICYgcmFkaW9zCiAgICAgICAgdXBkYXRlVW5pZm9ybTogZnVuY3Rpb24gKGVscykgewogICAgICAgICAgICAkLnVuaWZvcm0udXBkYXRlKGVscyk7IC8vIHVwZGF0ZSB0aGUgdW5pZm9ybSBjaGVja2JveCAmIHJhZGlvcyBVSSBhZnRlciB0aGUgYWN0dWFsIGlucHV0IGNvbnRyb2wgc3RhdGUgY2hhbmdlZAogICAgICAgIH0sCgogICAgICAgIC8vcHVibGljIGZ1bmN0aW9uIHRvIGluaXRpYWxpemUgdGhlIGZhbmN5Ym94IHBsdWdpbgogICAgICAgIGluaXRGYW5jeWJveDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBoYW5kbGVGYW5jeWJveCgpOwogICAgICAgIH0sCgogICAgICAgIC8vcHVibGljIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgYWN0dWFsIGlucHV0IHZhbHVlKHVzZWQgaW4gSUU5IGFuZCBJRTggZHVlIHRvIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBub3Qgc3VwcG9ydGVkKQogICAgICAgIGdldEFjdHVhbFZhbDogZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICAgIHZhciBlbCA9IGpRdWVyeShlbCk7CiAgICAgICAgICAgIGlmIChlbC52YWwoKSA9PT0gZWwuYXR0cigicGxhY2Vob2xkZXIiKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbC52YWwoKTsKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBmdW5jdGlvbiB0byBnZXQgYSBwYXJlbWV0ZXIgYnkgbmFtZSBmcm9tIFVSTAogICAgICAgIGdldFVSTFBhcmFtZXRlcjogZnVuY3Rpb24gKHBhcmFtTmFtZSkgewogICAgICAgICAgICB2YXIgc2VhcmNoU3RyaW5nID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSksCiAgICAgICAgICAgICAgICBpLCB2YWwsIHBhcmFtcyA9IHNlYXJjaFN0cmluZy5zcGxpdCgiJiIpOwoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFsID0gcGFyYW1zW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgICAgICAgICBpZiAodmFsWzBdID09IHBhcmFtTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmVzY2FwZSh2YWxbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8vIGNoZWNrIGZvciBkZXZpY2UgdG91Y2ggc3VwcG9ydAogICAgICAgIGlzVG91Y2hEZXZpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJUb3VjaEV2ZW50Iik7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZ2V0VW5pcXVlSUQ6IGZ1bmN0aW9uKHByZWZpeCkgewogICAgICAgICAgICByZXR1cm4gJ3ByZWZpeF8nICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG5ldyBEYXRlKCkpLmdldFRpbWUoKSk7CiAgICAgICAgfSwKCiAgICAgICAgYWxlcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCiAgICAgICAgICAgIG9wdGlvbnMgPSAkLmV4dGVuZCh0cnVlLCB7CiAgICAgICAgICAgICAgICBjb250YWluZXI6ICIiLCAvLyBhbGVydHMgcGFyZW50IGNvbnRhaW5lcihieSBkZWZhdWx0IHBsYWNlZCBhZnRlciB0aGUgcGFnZSBicmVhZGNydW1icykKICAgICAgICAgICAgICAgIHBsYWNlOiAiYXBwZW5kIiwgLy8gYXBwZW5kIG9yIHByZXBlbnQgaW4gY29udGFpbmVyIAogICAgICAgICAgICAgICAgdHlwZTogJ3N1Y2Nlc3MnLCAgLy8gYWxlcnQncyB0eXBlCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAiIiwgIC8vIGFsZXJ0J3MgbWVzc2FnZQogICAgICAgICAgICAgICAgY2xvc2U6IHRydWUsIC8vIG1ha2UgYWxlcnQgY2xvc2FibGUKICAgICAgICAgICAgICAgIHJlc2V0OiB0cnVlLCAvLyBjbG9zZSBhbGwgcHJldmlvdXNlIGFsZXJ0cyBmaXJzdAogICAgICAgICAgICAgICAgZm9jdXM6IHRydWUsIC8vIGF1dG8gc2Nyb2xsIHRvIHRoZSBhbGVydCBhZnRlciBzaG93bgogICAgICAgICAgICAgICAgY2xvc2VJblNlY29uZHM6IDAsIC8vIGF1dG8gY2xvc2UgYWZ0ZXIgZGVmaW5lZCBzZWNvbmRzCiAgICAgICAgICAgICAgICBpY29uOiAiIiAvLyBwdXQgaWNvbiBiZWZvcmUgdGhlIG1lc3NhZ2UKICAgICAgICAgICAgfSwgb3B0aW9ucyk7CgogICAgICAgICAgICB2YXIgaWQgPSBBcHAuZ2V0VW5pcXVlSUQoImFwcF9hbGVydCIpOwoKICAgICAgICAgICAgdmFyIGh0bWwgPSAnPGRpdiBpZD0iJytpZCsnIiBjbGFzcz0iYXBwLWFsZXJ0cyBhbGVydCBhbGVydC0nK29wdGlvbnMudHlwZSsnIGZhZGUgaW4iPicgKyAob3B0aW9ucy5jbG9zZSA/ICc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNsb3NlIiBkYXRhLWRpc21pc3M9ImFsZXJ0IiBhcmlhLWhpZGRlbj0idHJ1ZSI+PC9idXR0b24+JyA6ICcnICkgKyAob3B0aW9ucy5pY29uICE9ICIiID8gJzxpIGNsYXNzPSJmYS1sZyBmYSBmYS0nK29wdGlvbnMuaWNvbiArICciPjwvaT4gICcgOiAnJykgKyBvcHRpb25zLm1lc3NhZ2UrJzwvZGl2PicKCiAgICAgICAgICAgIGlmIChvcHRpb25zLnJlc2V0KSB7MAogICAgICAgICAgICAgICAgJCgnLmFwcC1hbGVydHMnKS5yZW1vdmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgJCgnLnBhZ2UtYnJlYWRjcnVtYicpLmFmdGVyKGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucGxhY2UgPT0gImFwcGVuZCIpIHsKICAgICAgICAgICAgICAgICAgICAkKG9wdGlvbnMuY29udGFpbmVyKS5hcHBlbmQoaHRtbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQob3B0aW9ucy5jb250YWluZXIpLnByZXBlbmQoaHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLmZvY3VzKSB7CiAgICAgICAgICAgICAgICBBcHAuc2Nyb2xsVG8oJCgnIycgKyBpZCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5jbG9zZUluU2Vjb25kcyA+IDApIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGlkKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuY2xvc2VJblNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGNoZWNrIElFOCBtb2RlCiAgICAgICAgaXNJRTg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzSUU4OwogICAgICAgIH0sCgogICAgICAgIC8vIGNoZWNrIElFOSBtb2RlCiAgICAgICAgaXNJRTk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzSUU5OwogICAgICAgIH0sCgogICAgICAgIC8vY2hlY2sgUlRMIG1vZGUKICAgICAgICBpc1JUTDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gaXNSVEw7CiAgICAgICAgfSwKCiAgICAgICAgLy8gZ2V0IGxheW91dCBjb2xvciBjb2RlIGJ5IGNvbG9yIG5hbWUKICAgICAgICBnZXRMYXlvdXRDb2xvckNvZGU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIGlmIChsYXlvdXRDb2xvckNvZGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGF5b3V0Q29sb3JDb2Rlc1tuYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9OwoKfSgpOw==",
                "body": "LyoqCkNvcmUgc2NyaXB0IHRvIGhhbmRsZSB0aGUgZW50aXJlIHRoZW1lIGFuZCBjb3JlIGZ1bmN0aW9ucwoqKi8KdmFyIEFwcCA9IGZ1bmN0aW9uICgpIHsKCiAgICAvLyBJRSBtb2RlCiAgICB2YXIgaXNSVEwgPSBmYWxzZTsKICAgIHZhciBpc0lFOCA9IGZhbHNlOwogICAgdmFyIGlzSUU5ID0gZmFsc2U7CiAgICB2YXIgaXNJRTEwID0gZmFsc2U7CgogICAgdmFyIHNpZGViYXJXaWR0aCA9IDIyNTsKICAgIHZhciBzaWRlYmFyQ29sbGFwc2VkV2lkdGggPSAzNTsKCiAgICB2YXIgcmVzcG9uc2l2ZUhhbmRsZXJzID0gW107CgogICAgLy8gdGhlbWUgbGF5b3V0IGNvbG9yIHNldAogICAgdmFyIGxheW91dENvbG9yQ29kZXMgPSB7CiAgICAgICAgJ2JsdWUnOiAnIzRiOGRmOCcsCiAgICAgICAgJ3JlZCc6ICcjZTAyMjIyJywKICAgICAgICAnZ3JlZW4nOiAnIzM1YWE0NycsCiAgICAgICAgJ3B1cnBsZSc6ICcjODUyYjk5JywKICAgICAgICAnZ3JleSc6ICcjNTU1NTU1JywKICAgICAgICAnbGlnaHQtZ3JleSc6ICcjZmFmYWZhJywKICAgICAgICAneWVsbG93JzogJyNmZmI4NDgnCiAgICB9OwoKICAgIC8vIFRvIGdldCB0aGUgY29ycmVjdCB2aWV3cG9ydCB3aWR0aCBiYXNlZCBvbiAgaHR0cDovL2FuZHlsYW5ndG9uLmNvLnVrL2FydGljbGVzL2phdmFzY3JpcHQvZ2V0LXZpZXdwb3J0LXNpemUtamF2YXNjcmlwdC8KICAgIHZhciBfZ2V0Vmlld1BvcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGUgPSB3aW5kb3csIGEgPSAnaW5uZXInOwogICAgICAgIGlmICghKCdpbm5lcldpZHRoJyBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGEgPSAnY2xpZW50JzsKICAgICAgICAgICAgZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgICB3aWR0aDogZVthICsgJ1dpZHRoJ10sCiAgICAgICAgICAgIGhlaWdodDogZVthICsgJ0hlaWdodCddCiAgICAgICAgfQogICAgfQoKICAgIC8vIGluaXRpYWxpemVzIG1haW4gc2V0dGluZ3MKICAgIHZhciBoYW5kbGVJbml0ID0gZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoJCgnYm9keScpLmNzcygnZGlyZWN0aW9uJykgPT09ICdydGwnKSB7CiAgICAgICAgICAgIGlzUlRMID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlzSUU4ID0gISEgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvTVNJRSA4LjAvKTsKICAgICAgICBpc0lFOSA9ICEhIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL01TSUUgOS4wLyk7CiAgICAgICAgaXNJRTEwID0gISEgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvTVNJRSAxMC4wLyk7CgogICAgICAgIGlmIChpc0lFMTApIHsKICAgICAgICAgICAgalF1ZXJ5KCdodG1sJykuYWRkQ2xhc3MoJ2llMTAnKTsgLy8gZGV0ZWN0IElFMTAgdmVyc2lvbgogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoaXNJRTEwIHx8IGlzSUU5IHx8IGlzSUU4KSB7CiAgICAgICAgICAgIGpRdWVyeSgnaHRtbCcpLmFkZENsYXNzKCdpZScpOyAvLyBkZXRlY3QgSUUxMCB2ZXJzaW9uCiAgICAgICAgfQoKICAgICAgICAvKgogICAgICAgICAgVmlydHVhbCBrZXlib2FyZHM6CiAgICAgICAgICBBbHNvLCBub3RlIHRoYXQgaWYgeW91J3JlIHVzaW5nIGlucHV0cyBpbiB5b3VyIG1vZGFsIOKAkyBpT1MgaGFzIGEgcmVuZGVyaW5nIGJ1ZyB3aGljaCBkb2Vzbid0IAogICAgICAgICAgdXBkYXRlIHRoZSBwb3NpdGlvbiBvZiBmaXhlZCBlbGVtZW50cyB3aGVuIHRoZSB2aXJ0dWFsIGtleWJvYXJkIGlzIHRyaWdnZXJlZCAgCiAgICAgICAgKi8KICAgICAgICB2YXIgZGV2aWNlQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGRldmljZUFnZW50Lm1hdGNoKC8oaXBob25lfGlwb2R8aXBhZCkvKSkgewogICAgICAgICAgICAkKGRvY3VtZW50KS5vbignZm9jdXMnLCAnaW5wdXQsIHRleHRhcmVhJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgJCgnLnBhZ2UtaGVhZGVyJykuaGlkZSgpOwogICAgICAgICAgICAgICAgJCgnLnBhZ2UtZm9vdGVyJykuaGlkZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ2JsdXInLCAnaW5wdXQsIHRleHRhcmVhJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgJCgnLnBhZ2UtaGVhZGVyJykuc2hvdygpOwogICAgICAgICAgICAgICAgJCgnLnBhZ2UtZm9vdGVyJykuc2hvdygpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIGhhbmRsZVNpZGViYXJTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyByZW1vdmUgc2lkZWJhciB0b2dnbGVyIGlmIHdpbmRvdyB3aWR0aCBzbWFsbGVyIHRoYW4gOTkyKGZvciB0YWJsZXQgYW5kIHBob25lIG1vZGUpCiAgICAgICAgdmFyIHZpZXdwb3J0ID0gX2dldFZpZXdQb3J0KCk7CiAgICAgICAgaWYgKHZpZXdwb3J0LndpZHRoIDwgOTkyKSB7CiAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLWNsb3NlZCIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBydW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBzZXQgYnkgQXBwLmFkZFJlc3BvbnNpdmVIYW5kbGVyKCkuCiAgICB2YXIgcnVuUmVzcG9uc2l2ZUhhbmRsZXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIHJlaW5pdGlhbGl6ZSBvdGhlciBzdWJzY3JpYmVkIGVsZW1lbnRzCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zaXZlSGFuZGxlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGVhY2ggPSByZXNwb25zaXZlSGFuZGxlcnNbaV07CiAgICAgICAgICAgIGVhY2guY2FsbCgpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyByZWluaXRpYWxpemUgdGhlIGxheXBvdCBvbiB3aW5kb3cgcmVzaXplCiAgICB2YXIgaGFuZGxlUmVzcG9uc2l2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBoYW5kbGVTaWRlYmFyU3RhdGUoKTsKICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOwogICAgICAgIGhhbmRsZUZpeGVkU2lkZWJhcigpOwogICAgICAgIHJ1blJlc3BvbnNpdmVIYW5kbGVycygpOwogICAgfQoKICAgIC8vIGluaXRpYWxpemUgdGhlIGxheW91dCBvbiBwYWdlIGxvYWQKICAgIHZhciBoYW5kbGVSZXNwb25zaXZlT25Jbml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVNpZGViYXJTdGF0ZSgpOwogICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7CiAgICB9CgogICAgLy8gaGFuZGxlIHRoZSBsYXlvdXQgcmVpbml0aWFsaXphdGlvbiBvbiB3aW5kb3cgcmVzaXplCiAgICB2YXIgaGFuZGxlUmVzcG9uc2l2ZU9uUmVzaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXNpemU7CiAgICAgICAgaWYgKGlzSUU4KSB7CiAgICAgICAgICAgIHZhciBjdXJyaGVpZ2h0OwogICAgICAgICAgICAkKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyaGVpZ2h0ID09IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vcXVpdGUgZXZlbnQgc2luY2Ugb25seSBib2R5IHJlc2l6ZWQgbm90IHdpbmRvdy4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChyZXNpemUpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmVzaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2l6ZSA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZVJlc3BvbnNpdmUoKTsKICAgICAgICAgICAgICAgIH0sIDUwKTsgLy8gd2FpdCA1MG1zIHVudGlsIHdpbmRvdyByZXNpemUgZmluaXNoZXMuICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY3VycmhlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7IC8vIHN0b3JlIGxhc3QgYm9keSBjbGllbnQgaGVpZ2h0CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHJlc2l6ZSkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXNpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzaXplID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlUmVzcG9uc2l2ZSgpOwogICAgICAgICAgICAgICAgfSwgNTApOyAvLyB3YWl0IDUwbXMgdW50aWwgd2luZG93IHJlc2l6ZSBmaW5pc2hlcy4KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vKiBCRUdJTjpDT1JFIEhBTkRMRVJTICovLwogICAgLy8gdGhpcyBmdW5jdGlvbiBoYW5kbGVzIHJlc3BvbnNpdmUgbGF5b3V0IG9uIHNjcmVlbiBzaXplIHJlc2l6ZSBvciBtb2JpbGUgZGV2aWNlIHJvdGF0ZS4KCiAgICAvLyBTZXQgcHJvcGVyIGhlaWdodCBmb3Igc2lkZWJhciBhbmQgY29udGVudC4gVGhlIGNvbnRlbnQgYW5kIHNpZGViYXIgaGVpZ2h0IG11c3QgYmUgc3luY2VkIGFsd2F5cy4KICAgIHZhciBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY29udGVudCA9ICQoJy5wYWdlLWNvbnRlbnQnKTsKICAgICAgICB2YXIgc2lkZWJhciA9ICQoJy5wYWdlLXNpZGViYXInKTsKICAgICAgICB2YXIgYm9keSA9ICQoJ2JvZHknKTsKICAgICAgICB2YXIgaGVpZ2h0OwoKICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygicGFnZS1mb290ZXItZml4ZWQiKSA9PT0gdHJ1ZSAmJiBib2R5Lmhhc0NsYXNzKCJwYWdlLXNpZGViYXItZml4ZWQiKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgdmFyIGF2YWlsYWJsZV9oZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCkgLSAkKCcuZm9vdGVyJykub3V0ZXJIZWlnaHQoKSAtICQoJy5oZWFkZXInKS5vdXRlckhlaWdodCgpOwogICAgICAgICAgICBpZiAoY29udGVudC5oZWlnaHQoKSA8IGF2YWlsYWJsZV9oZWlnaHQpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQuYXR0cignc3R5bGUnLCAnbWluLWhlaWdodDonICsgYXZhaWxhYmxlX2hlaWdodCArICdweCAhaW1wb3J0YW50Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykpIHsKICAgICAgICAgICAgICAgIGhlaWdodCA9IF9jYWxjdWxhdGVGaXhlZFNpZGViYXJWaWV3cG9ydEhlaWdodCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVpZ2h0ID0gc2lkZWJhci5oZWlnaHQoKSArIDIwOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckhlaWdodCA9ICQoJy5oZWFkZXInKS5vdXRlckhlaWdodCgpOwogICAgICAgICAgICAgICAgdmFyIGZvb3RlckhlaWdodCA9ICQoJy5mb290ZXInKS5vdXRlckhlaWdodCgpOyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA+IDEwMjQgJiYgKGhlaWdodCArIGhlYWRlckhlaWdodCArIGZvb3RlckhlaWdodCkgIDwgJCh3aW5kb3cpLmhlaWdodCgpKSB7CiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpIC0gaGVhZGVySGVpZ2h0IC0gZm9vdGVySGVpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChoZWlnaHQgPj0gY29udGVudC5oZWlnaHQoKSkgewogICAgICAgICAgICAgICAgY29udGVudC5hdHRyKCdzdHlsZScsICdtaW4taGVpZ2h0OicgKyBoZWlnaHQgKyAncHggIWltcG9ydGFudCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIEhhbmRsZSBzaWRlYmFyIG1lbnUKICAgIHZhciBoYW5kbGVTaWRlYmFyTWVudSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkoJy5wYWdlLXNpZGViYXInKS5vbignY2xpY2snLCAnbGkgPiBhJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKCQodGhpcykubmV4dCgpLmhhc0NsYXNzKCdzdWItbWVudScpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgnLmJ0bi1uYXZiYXInKS5oYXNDbGFzcygnY29sbGFwc2VkJykgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAkKCcuYnRuLW5hdmJhcicpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgkKHRoaXMpLm5leHQoKS5oYXNDbGFzcygnc3ViLW1lbnUgYWx3YXlzLW9wZW4nKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcGFyZW50ID0gJCh0aGlzKS5wYXJlbnQoKS5wYXJlbnQoKTsKICAgICAgICAgICAgdmFyIHRoZSA9ICQodGhpcyk7CiAgICAgICAgICAgIHZhciBtZW51ID0gJCgnLnBhZ2Utc2lkZWJhci1tZW51Jyk7CiAgICAgICAgICAgIHZhciBzdWIgPSBqUXVlcnkodGhpcykubmV4dCgpOwoKICAgICAgICAgICAgdmFyIGF1dG9TY3JvbGwgPSBtZW51LmRhdGEoImF1dG8tc2Nyb2xsIikgPyBtZW51LmRhdGEoImF1dG8tc2Nyb2xsIikgOiB0cnVlOwogICAgICAgICAgICB2YXIgc2xpZGVTcGVlZCA9IG1lbnUuZGF0YSgic2xpZGUtc3BlZWQiKSA/IHBhcnNlSW50KG1lbnUuZGF0YSgic2xpZGUtc3BlZWQiKSkgOiAyMDA7CgogICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4oJ2xpLm9wZW4nKS5jaGlsZHJlbignYScpLmNoaWxkcmVuKCcuYXJyb3cnKS5yZW1vdmVDbGFzcygnb3BlbicpOwogICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4oJ2xpLm9wZW4nKS5jaGlsZHJlbignLnN1Yi1tZW51Om5vdCguYWx3YXlzLW9wZW4pJykuc2xpZGVVcCgyMDApOwogICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4oJ2xpLm9wZW4nKS5yZW1vdmVDbGFzcygnb3BlbicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHNsaWRlT2ZmZXNldCA9IC0yMDA7CgogICAgICAgICAgICBpZiAoc3ViLmlzKCI6dmlzaWJsZSIpKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkoJy5hcnJvdycsIGpRdWVyeSh0aGlzKSkucmVtb3ZlQ2xhc3MoIm9wZW4iKTsKICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygib3BlbiIpOwogICAgICAgICAgICAgICAgc3ViLnNsaWRlVXAoc2xpZGVTcGVlZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdXRvU2Nyb2xsID09IHRydWUgJiYgJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItY2xvc2VkJykgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbnUuc2xpbVNjcm9sbCh7J3Njcm9sbFRvJzogKHRoZS5wb3NpdGlvbigpKS50b3B9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFwcC5zY3JvbGxUbyh0aGUsIHNsaWRlT2ZmZXNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5KCcuYXJyb3cnLCBqUXVlcnkodGhpcykpLmFkZENsYXNzKCJvcGVuIik7CiAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykucGFyZW50KCkuYWRkQ2xhc3MoIm9wZW4iKTsKICAgICAgICAgICAgICAgIHN1Yi5zbGlkZURvd24oc2xpZGVTcGVlZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdXRvU2Nyb2xsID09IHRydWUgJiYgJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItY2xvc2VkJykgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbnUuc2xpbVNjcm9sbCh7J3Njcm9sbFRvJzogKHRoZS5wb3NpdGlvbigpKS50b3B9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFwcC5zY3JvbGxUbyh0aGUsIHNsaWRlT2ZmZXNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsZSBhamF4IGxpbmtzIHdpdGhpbiBzaWRlYmFyIG1lbnUKICAgICAgICBqUXVlcnkoJy5wYWdlLXNpZGViYXInKS5vbignY2xpY2snLCAnIGxpID4gYS5hamF4aWZ5JywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBBcHAuc2Nyb2xsVG9wKCk7CgogICAgICAgICAgICB2YXIgdXJsID0gJCh0aGlzKS5hdHRyKCJocmVmIik7CiAgICAgICAgICAgIHZhciBtZW51Q29udGFpbmVyID0galF1ZXJ5KCcucGFnZS1zaWRlYmFyIHVsJyk7CiAgICAgICAgICAgIHZhciBwYWdlQ29udGVudCA9ICQoJy5wYWdlLWNvbnRlbnQnKTsKICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50Qm9keSA9ICQoJy5wYWdlLWNvbnRlbnQgLnBhZ2UtY29udGVudC1ib2R5Jyk7CgogICAgICAgICAgICBtZW51Q29udGFpbmVyLmNoaWxkcmVuKCdsaS5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgIG1lbnVDb250YWluZXIuY2hpbGRyZW4oJ2Fycm93Lm9wZW4nKS5yZW1vdmVDbGFzcygnb3BlbicpOwoKICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCdsaScpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmNoaWxkcmVuKCdhID4gc3Bhbi5hcnJvdycpLmFkZENsYXNzKCdvcGVuJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkKHRoaXMpLnBhcmVudHMoJ2xpJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOwoKICAgICAgICAgICAgQXBwLnN0YXJ0UGFnZUxvYWRpbmcoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA8PSA5OTEgJiYgJCgnLnBhZ2Utc2lkZWJhcicpLmhhc0NsYXNzKCJpbiIpKSB7CiAgICAgICAgICAgICAgICAkKCcubmF2YmFyLXRvZ2dsZScpLmNsaWNrKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgICAgICAgICAgICBBcHAuc3RvcFBhZ2VMb2FkaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnRCb2R5Lmh0bWwocmVzKTsKICAgICAgICAgICAgICAgICAgICBBcHAuZml4Q29udGVudEhlaWdodCgpOyAvLyBmaXggY29udGVudCBoZWlnaHQKICAgICAgICAgICAgICAgICAgICBBcHAuaW5pdEFqYXgoKTsgLy8gaW5pdGlhbGl6ZSBjb3JlIHN0dWZmCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uICh4aHIsIGFqYXhPcHRpb25zLCB0aHJvd25FcnJvcikgewogICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50Qm9keS5odG1sKCc8aDQ+Q291bGQgbm90IGxvYWQgdGhlIHJlcXVlc3RlZCBjb250ZW50LjwvaDQ+Jyk7CiAgICAgICAgICAgICAgICAgICAgQXBwLnN0b3BQYWdlTG9hZGluZygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxlIGFqYXggbGluayB3aXRoaW4gbWFpbiBjb250ZW50CiAgICAgICAgalF1ZXJ5KCcucGFnZS1jb250ZW50Jykub24oJ2NsaWNrJywgJy5hamF4aWZ5JywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBBcHAuc2Nyb2xsVG9wKCk7CgogICAgICAgICAgICB2YXIgdXJsID0gJCh0aGlzKS5hdHRyKCJocmVmIik7CiAgICAgICAgICAgIHZhciBwYWdlQ29udGVudCA9ICQoJy5wYWdlLWNvbnRlbnQnKTsKICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50Qm9keSA9ICQoJy5wYWdlLWNvbnRlbnQgLnBhZ2UtY29udGVudC1ib2R5Jyk7CgogICAgICAgICAgICBBcHAuc3RhcnRQYWdlTG9hZGluZygpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCQod2luZG93KS53aWR0aCgpIDw9IDk5MSAmJiAkKCcucGFnZS1zaWRlYmFyJykuaGFzQ2xhc3MoImluIikpIHsKICAgICAgICAgICAgICAgICQoJy5uYXZiYXItdG9nZ2xlJykuY2xpY2soKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICAgICAgICAgIEFwcC5zdG9wUGFnZUxvYWRpbmcoKTsKICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudEJvZHkuaHRtbChyZXMpOwogICAgICAgICAgICAgICAgICAgIEFwcC5maXhDb250ZW50SGVpZ2h0KCk7IC8vIGZpeCBjb250ZW50IGhlaWdodAogICAgICAgICAgICAgICAgICAgIEFwcC5pbml0QWpheCgpOyAvLyBpbml0aWFsaXplIGNvcmUgc3R1ZmYKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHhociwgYWpheE9wdGlvbnMsIHRocm93bkVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnRCb2R5Lmh0bWwoJzxoND5Db3VsZCBub3QgbG9hZCB0aGUgcmVxdWVzdGVkIGNvbnRlbnQuPC9oND4nKTsKICAgICAgICAgICAgICAgICAgICBBcHAuc3RvcFBhZ2VMb2FkaW5nKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjYWxjdWxhdGUgc2lkZWJhciBoZWlnaHQgZm9yIGZpeGVkIHNpZGViYXIgbGF5b3V0LgogICAgdmFyIF9jYWxjdWxhdGVGaXhlZFNpZGViYXJWaWV3cG9ydEhlaWdodCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc2lkZWJhckhlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKSAtICQoJy5oZWFkZXInKS5oZWlnaHQoKSArIDE7CiAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygicGFnZS1mb290ZXItZml4ZWQiKSkgewogICAgICAgICAgICBzaWRlYmFySGVpZ2h0ID0gc2lkZWJhckhlaWdodCAtICQoJy5mb290ZXInKS5vdXRlckhlaWdodCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNpZGViYXJIZWlnaHQ7CiAgICB9CgogICAgLy8gSGFuZGxlcyBmaXhlZCBzaWRlYmFyCiAgICB2YXIgaGFuZGxlRml4ZWRTaWRlYmFyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBtZW51ID0gJCgnLnBhZ2Utc2lkZWJhci1tZW51Jyk7CgogICAgICAgIGlmIChtZW51LnBhcmVudCgnLnNsaW1TY3JvbGxEaXYnKS5zaXplKCkgPT09IDEpIHsgLy8gZGVzdHJveSBleGlzdGluZyBpbnN0YW5jZSBiZWZvcmUgdXBkYXRpbmcgdGhlIGhlaWdodAogICAgICAgICAgICBtZW51LnNsaW1TY3JvbGwoewogICAgICAgICAgICAgICAgZGVzdHJveTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbWVudS5yZW1vdmVBdHRyKCdzdHlsZScpOwogICAgICAgICAgICAkKCcucGFnZS1zaWRlYmFyJykucmVtb3ZlQXR0cignc3R5bGUnKTsKICAgICAgICB9CgogICAgICAgIGlmICgkKCcucGFnZS1zaWRlYmFyLWZpeGVkJykuc2l6ZSgpID09PSAwKSB7CiAgICAgICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB2aWV3cG9ydCA9IF9nZXRWaWV3UG9ydCgpOwogICAgICAgIGlmICh2aWV3cG9ydC53aWR0aCA+PSA5OTIpIHsKICAgICAgICAgICAgdmFyIHNpZGViYXJIZWlnaHQgPSBfY2FsY3VsYXRlRml4ZWRTaWRlYmFyVmlld3BvcnRIZWlnaHQoKTsKCiAgICAgICAgICAgIG1lbnUuc2xpbVNjcm9sbCh7CiAgICAgICAgICAgICAgICBzaXplOiAnN3B4JywKICAgICAgICAgICAgICAgIGNvbG9yOiAnI2ExYjJiZCcsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAuMywKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBpc1JUTCA/ICdsZWZ0JyA6ICdyaWdodCcsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHNpZGViYXJIZWlnaHQsCiAgICAgICAgICAgICAgICBhbGxvd1BhZ2VTY3JvbGw6IGZhbHNlLAogICAgICAgICAgICAgICAgZGlzYWJsZUZhZGVPdXQ6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBoYW5kbGVTaWRlYmFyQW5kQ29udGVudEhlaWdodCgpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBIYW5kbGVzIHRoZSBzaWRlYmFyIG1lbnUgaG92ZXIgZWZmZWN0IGZvciBmaXhlZCBzaWRlYmFyLgogICAgdmFyIGhhbmRsZUZpeGVkU2lkZWJhckhvdmVyYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgJCgnLnBhZ2Utc2lkZWJhcicpLm9mZignbW91c2VlbnRlcicpLm9uKCdtb3VzZWVudGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYm9keSA9ICQoJ2JvZHknKTsKCiAgICAgICAgICAgIGlmICgoYm9keS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWNsb3NlZCcpID09PSBmYWxzZSB8fCBib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItZml4ZWQnKSA9PT0gZmFsc2UpIHx8ICQodGhpcykuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2xhc3MoJ3BhZ2Utc2lkZWJhci1jbG9zZWQnKS5hZGRDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyLW9uJyk7CgogICAgICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygicGFnZS1zaWRlYmFyLXJldmVyc2VkIikpIHsKICAgICAgICAgICAgICAgICQodGhpcykud2lkdGgoc2lkZWJhcldpZHRoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpOwogICAgICAgICAgICAgICAgJCh0aGlzKS5hbmltYXRlKHsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogc2lkZWJhcldpZHRoCiAgICAgICAgICAgICAgICB9LCA0MDAsICcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygncGFnZS1zaWRlYmFyLWhvdmVyaW5nJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAkKCcucGFnZS1zaWRlYmFyJykub2ZmKCdtb3VzZWxlYXZlJykub24oJ21vdXNlbGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBib2R5ID0gJCgnYm9keScpOwoKICAgICAgICAgICAgaWYgKChib2R5Lmhhc0NsYXNzKCdwYWdlLXNpZGViYXItaG92ZXItb24nKSA9PT0gZmFsc2UgfHwgYm9keS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykgPT09IGZhbHNlKSB8fCAkKHRoaXMpLmhhc0NsYXNzKCdwYWdlLXNpZGViYXItaG92ZXJpbmcnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYm9keS5oYXNDbGFzcygicGFnZS1zaWRlYmFyLXJldmVyc2VkIikpIHsKICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygncGFnZS1zaWRlYmFyLWNsb3NlZCcpLnJlbW92ZUNsYXNzKCdwYWdlLXNpZGViYXItaG92ZXItb24nKTsKICAgICAgICAgICAgICAgICQodGhpcykud2lkdGgoc2lkZWJhckNvbGxhcHNlZFdpZHRoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpOwogICAgICAgICAgICAgICAgJCh0aGlzKS5hbmltYXRlKHsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogc2lkZWJhckNvbGxhcHNlZFdpZHRoCiAgICAgICAgICAgICAgICB9LCA0MDAsICcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdwYWdlLXNpZGViYXItY2xvc2VkJykucmVtb3ZlQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3Zlci1vbicpOwogICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHNpZGViYXIgdG9nZ2xlciB0byBjbG9zZS9oaWRlIHRoZSBzaWRlYmFyLgogICAgdmFyIGhhbmRsZVNpZGViYXJUb2dnbGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB2aWV3cG9ydCA9IF9nZXRWaWV3UG9ydCgpOwogICAgICAgIGlmICgkLmNvb2tpZSAmJiAkLmNvb2tpZSgnc2lkZWJhcl9jbG9zZWQnKSA9PT0gJzEnICYmIHZpZXdwb3J0LndpZHRoID49IDk5MikgewogICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3BhZ2Utc2lkZWJhci1jbG9zZWQnKTsKICAgICAgICB9CgogICAgICAgIC8vIGhhbmRsZSBzaWRlYmFyIHNob3cvaGlkZQogICAgICAgICQoJy5wYWdlLXNpZGViYXIsIC5oZWFkZXInKS5vbignY2xpY2snLCAnLnNpZGViYXItdG9nZ2xlcicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHZhciBib2R5ID0gJCgnYm9keScpOwogICAgICAgICAgICB2YXIgc2lkZWJhciA9ICQoJy5wYWdlLXNpZGViYXInKTsKCiAgICAgICAgICAgIGlmICgoYm9keS5oYXNDbGFzcygicGFnZS1zaWRlYmFyLWhvdmVyLW9uIikgJiYgYm9keS5oYXNDbGFzcygncGFnZS1zaWRlYmFyLWZpeGVkJykpIHx8IHNpZGViYXIuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1ob3ZlcmluZycpKSB7CiAgICAgICAgICAgICAgICBib2R5LnJlbW92ZUNsYXNzKCdwYWdlLXNpZGViYXItaG92ZXItb24nKTsKICAgICAgICAgICAgICAgIHNpZGViYXIuY3NzKCd3aWR0aCcsICcnKS5oaWRlKCkuc2hvdygpOwogICAgICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsgLy9maXggY29udGVudCAmIHNpZGViYXIgaGVpZ2h0CiAgICAgICAgICAgICAgICBpZiAoJC5jb29raWUpIHsKICAgICAgICAgICAgICAgICAgICAkLmNvb2tpZSgnc2lkZWJhcl9jbG9zZWQnLCAnMCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHJ1blJlc3BvbnNpdmVIYW5kbGVycygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkKCIuc2lkZWJhci1zZWFyY2giLCBzaWRlYmFyKS5yZW1vdmVDbGFzcygib3BlbiIpOwoKICAgICAgICAgICAgaWYgKGJvZHkuaGFzQ2xhc3MoInBhZ2Utc2lkZWJhci1jbG9zZWQiKSkgewogICAgICAgICAgICAgICAgYm9keS5yZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLWNsb3NlZCIpOwogICAgICAgICAgICAgICAgaWYgKGJvZHkuaGFzQ2xhc3MoJ3BhZ2Utc2lkZWJhci1maXhlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgc2lkZWJhci5jc3MoJ3dpZHRoJywgJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCQuY29va2llKSB7CiAgICAgICAgICAgICAgICAgICAgJC5jb29raWUoJ3NpZGViYXJfY2xvc2VkJywgJzAnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvZHkuYWRkQ2xhc3MoInBhZ2Utc2lkZWJhci1jbG9zZWQiKTsKICAgICAgICAgICAgICAgIGlmICgkLmNvb2tpZSkgewogICAgICAgICAgICAgICAgICAgICQuY29va2llKCdzaWRlYmFyX2Nsb3NlZCcsICcxJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsgLy9maXggY29udGVudCAmIHNpZGViYXIgaGVpZ2h0CiAgICAgICAgICAgIHJ1blJlc3BvbnNpdmVIYW5kbGVycygpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBoYW5kbGUgdGhlIHNlYXJjaCBiYXIgY2xvc2UKICAgICAgICAkKCcucGFnZS1zaWRlYmFyJykub24oJ2NsaWNrJywgJy5zaWRlYmFyLXNlYXJjaCAucmVtb3ZlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2gnKS5yZW1vdmVDbGFzcygib3BlbiIpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBoYW5kbGUgdGhlIHNlYXJjaCBxdWVyeSBzdWJtaXQgb24gZW50ZXIgcHJlc3MKICAgICAgICAkKCcucGFnZS1zaWRlYmFyIC5zaWRlYmFyLXNlYXJjaCcpLm9uKCdrZXlwcmVzcycsICdpbnB1dC5mb3JtLWNvbnRyb2wnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoZS53aGljaCA9PSAxMykgewogICAgICAgICAgICAgICAgJCgnLnNpZGViYXItc2VhcmNoJykuc3VibWl0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vPC0tLS0gQWRkIHRoaXMgbGluZQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsZSB0aGUgc2VhcmNoIHN1Ym1pdChmb3Igc2lkZWJhciBzZWFyY2ggYW5kIHJlc3BvbnNpdmUgbW9kZSBvZiB0aGUgaGVhZGVyIHNlYXJjaCkKICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2ggLnN1Ym1pdCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygicGFnZS1zaWRlYmFyLWNsb3NlZCIpKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgnLnNpZGViYXItc2VhcmNoJykuaGFzQ2xhc3MoJ29wZW4nKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkKCcucGFnZS1zaWRlYmFyLWZpeGVkJykuc2l6ZSgpID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5wYWdlLXNpZGViYXIgLnNpZGViYXItdG9nZ2xlcicpLmNsaWNrKCk7IC8vdHJpZ2dlciBzaWRlYmFyIHRvZ2dsZSBidXR0b24KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJCgnLnNpZGViYXItc2VhcmNoJykuYWRkQ2xhc3MoIm9wZW4iKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLnNpZGViYXItc2VhcmNoJykuc3VibWl0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKCcuc2lkZWJhci1zZWFyY2gnKS5zdWJtaXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBoZWFkZXIgc2VhcmNoIGJveDoKCiAgICAgICAgLy8gaGFuZGxlIHRoZSBzZWFyY2ggcXVlcnkgc3VibWl0IG9uIGVudGVyIHByZXNzCiAgICAgICAgJCgnLmhlYWRlciAuc2VhcmNoLWZvcm0nKS5vbigna2V5cHJlc3MnLCAnaW5wdXQuZm9ybS1jb250cm9sJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gMTMpIHsKICAgICAgICAgICAgICAgICQoJy5zaWRlYmFyLXNlYXJjaCcpLnN1Ym1pdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLzwtLS0tIEFkZCB0aGlzIGxpbmUKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvL2hhbmRsZSBoZWFkZXIgc2VhcmNoIGJ1dHRvbiBjbGljawogICAgICAgICQoJy5oZWFkZXIgLnNlYXJjaC1mb3JtIC5zdWJtaXQnKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICQoJy5oZWFkZXIgLnNlYXJjaC1mb3JtJykuc3VibWl0KCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyB0aGUgaG9yaXpvbnRhbCBtZW51CiAgICB2YXIgaGFuZGxlSG9yaXpvbnRhbE1lbnUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy9oYW5kbGUgaG9yIG1lbnUgc2VhcmNoIGZvcm0gdG9nZ2xlciBjbGljawogICAgICAgICQoJy5oZWFkZXInKS5vbignY2xpY2snLCAnLmhvci1tZW51IC5ob3ItbWVudS1zZWFyY2gtZm9ybS10b2dnbGVyJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKCQodGhpcykuaGFzQ2xhc3MoJ29mZicpKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdvZmYnKTsKICAgICAgICAgICAgICAgICQoJy5oZWFkZXIgLmhvci1tZW51IC5zZWFyY2gtZm9ybScpLmhpZGUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ29mZicpOwogICAgICAgICAgICAgICAgJCgnLmhlYWRlciAuaG9yLW1lbnUgLnNlYXJjaC1mb3JtJykuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy9oYW5kbGUgdGFiIGNsaWNrCiAgICAgICAgJCgnLmhlYWRlcicpLm9uKCdjbGljaycsICcuaG9yLW1lbnUgYVtkYXRhLXRvZ2dsZT0idGFiIl0nLCBmdW5jdGlvbiAoZSkgeyAgICAgCiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdmFyIG5hdiA9ICQoIi5ob3ItbWVudSAubmF2Iik7CiAgICAgICAgICAgIHZhciBhY3RpdmVfbGluayA9IG5hdi5maW5kKCdsaS5jdXJyZW50Jyk7CiAgICAgICAgICAgICQoJ2xpLmFjdGl2ZScsIGFjdGl2ZV9saW5rKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7CiAgICAgICAgICAgICQoJy5zZWxlY3RlZCcsIGFjdGl2ZV9saW5rKS5yZW1vdmUoKTsKICAgICAgICAgICAgdmFyIG5ld19saW5rID0gJCh0aGlzKS5wYXJlbnRzKCdsaScpLmxhc3QoKTsKICAgICAgICAgICAgbmV3X2xpbmsuYWRkQ2xhc3MoImN1cnJlbnQiKTsKICAgICAgICAgICAgbmV3X2xpbmsuZmluZCgiYTpmaXJzdCIpLmFwcGVuZCgnPHNwYW4gY2xhc3M9InNlbGVjdGVkIj48L3NwYW4+Jyk7CiAgICAgICAgfSk7CgogICAgICAgIC8vaGFuZGxlIGhvciBtZW51IHNlYXJjaCBidXR0b24gY2xpY2sKICAgICAgICAkKCcuaGVhZGVyJykub24oJ2NsaWNrJywgJy5ob3ItbWVudSAuc2VhcmNoLWZvcm0gLmJ0bicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICQoJy5mb3JtLXNlYXJjaCcpLnN1Ym1pdCgpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vaGFuZGxlIGhvciBtZW51IHNlYXJjaCBmb3JtIG9uIGVudGVyIHByZXNzCiAgICAgICAgJCgnLmhlYWRlcicpLm9uKCdrZXlwcmVzcycsICcuaG9yLW1lbnUgLnNlYXJjaC1mb3JtIGlucHV0JywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gMTMpIHsKICAgICAgICAgICAgICAgICQoJy5mb3JtLXNlYXJjaCcpLnN1Ym1pdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyB0aGUgZ28gdG8gdG9wIGJ1dHRvbiBhdCB0aGUgZm9vdGVyCiAgICB2YXIgaGFuZGxlR29Ub3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLyogc2V0IHZhcmlhYmxlcyBsb2NhbGx5IGZvciBpbmNyZWFzZWQgcGVyZm9ybWFuY2UgKi8KICAgICAgICBqUXVlcnkoJy5mb290ZXInKS5vbignY2xpY2snLCAnLmdvLXRvcCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIEFwcC5zY3JvbGxUbygpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBwb3J0bGV0IHRvb2xzICYgYWN0aW9ucwogICAgdmFyIGhhbmRsZVBvcnRsZXRUb29scyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkoJ2JvZHknKS5vbignY2xpY2snLCAnLnBvcnRsZXQgPiAucG9ydGxldC10aXRsZSA+IC50b29scyA+IGEucmVtb3ZlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBqUXVlcnkodGhpcykuY2xvc2VzdCgiLnBvcnRsZXQiKS5yZW1vdmUoKTsKICAgICAgICB9KTsKCiAgICAgICAgalF1ZXJ5KCdib2R5Jykub24oJ2NsaWNrJywgJy5wb3J0bGV0ID4gLnBvcnRsZXQtdGl0bGUgPiAudG9vbHMgPiBhLnJlbG9hZCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdmFyIGVsID0galF1ZXJ5KHRoaXMpLmNsb3Nlc3QoIi5wb3J0bGV0IikuY2hpbGRyZW4oIi5wb3J0bGV0LWJvZHkiKTsKICAgICAgICAgICAgdmFyIHVybCA9IGpRdWVyeSh0aGlzKS5hdHRyKCJkYXRhLXVybCIpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSAkKHRoaXMpLmF0dHIoImRhdGEtZXJyb3ItZGlzcGxheSIpOwogICAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgICAgICBBcHAuYmxvY2tVSSh7dGFyZ2V0OiBlbCwgaWNvbk9ubHk6IHRydWV9KTsKICAgICAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAiaHRtbCIsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzKSAKICAgICAgICAgICAgICAgICAgICB7ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIEFwcC51bmJsb2NrVUkoZWwpOwogICAgICAgICAgICAgICAgICAgICAgICBlbC5odG1sKHJlcyk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oeGhyLCBhamF4T3B0aW9ucywgdGhyb3duRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBBcHAudW5ibG9ja1VJKGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1zZyA9ICdFcnJvciBvbiByZWxvYWRpbmcgdGhlIGNvbnRlbnQuIFBsZWFzZSBjaGVjayB5b3VyIGNvbm5lY3Rpb24gYW5kIHRyeSBhZ2Fpbi4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IgPT0gInRvYXN0ciIgJiYgdG9hc3RyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IobXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciA9PSAibm90aWZpYzgiICYmICQubm90aWZpYzgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQubm90aWZpYzgoJ3ppbmRleCcsIDExNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQubm90aWZpYzgobXNnLCB7dGhlbWU6ICdydWJ5JywgbGlmZTogMzAwMH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQobXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZm9yIGRlbW8gcHVycG9zZQogICAgICAgICAgICAgICAgQXBwLmJsb2NrVUkoe3RhcmdldDogZWwsIGljb25Pbmx5OiB0cnVlfSk7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgQXBwLnVuYmxvY2tVSShlbCk7CiAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgIH0pOwoKICAgICAgICAvLyBsb2FkIGFqYXggZGF0YSBvbiBwYWdlIGluaXQKICAgICAgICAkKCcucG9ydGxldCAucG9ydGxldC10aXRsZSBhLnJlbG9hZFtkYXRhLWxvYWQ9InRydWUiXScpLmNsaWNrKCk7CgogICAgICAgIGpRdWVyeSgnYm9keScpLm9uKCdjbGljaycsICcucG9ydGxldCA+IC5wb3J0bGV0LXRpdGxlID4gLnRvb2xzID4gLmNvbGxhcHNlLCAucG9ydGxldCAucG9ydGxldC10aXRsZSA+IC50b29scyA+IC5leHBhbmQnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHZhciBlbCA9IGpRdWVyeSh0aGlzKS5jbG9zZXN0KCIucG9ydGxldCIpLmNoaWxkcmVuKCIucG9ydGxldC1ib2R5Iik7CiAgICAgICAgICAgIGlmIChqUXVlcnkodGhpcykuaGFzQ2xhc3MoImNvbGxhcHNlIikpIHsKICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcygiY29sbGFwc2UiKS5hZGRDbGFzcygiZXhwYW5kIik7CiAgICAgICAgICAgICAgICBlbC5zbGlkZVVwKDIwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykucmVtb3ZlQ2xhc3MoImV4cGFuZCIpLmFkZENsYXNzKCJjb2xsYXBzZSIpOwogICAgICAgICAgICAgICAgZWwuc2xpZGVEb3duKDIwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIGN1c3RvbSBjaGVja2JveGVzICYgcmFkaW9zIHVzaW5nIGpRdWVyeSBVbmlmb3JtIHBsdWdpbgogICAgdmFyIGhhbmRsZVVuaWZvcm0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFqUXVlcnkoKS51bmlmb3JtKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHRlc3QgPSAkKCJpbnB1dFt0eXBlPWNoZWNrYm94XTpub3QoLnRvZ2dsZSwgLm1ha2Utc3dpdGNoKSwgaW5wdXRbdHlwZT1yYWRpb106bm90KC50b2dnbGUsIC5zdGFyLCAubWFrZS1zd2l0Y2gpIik7CiAgICAgICAgaWYgKHRlc3Quc2l6ZSgpID4gMCkgewogICAgICAgICAgICB0ZXN0LmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCQodGhpcykucGFyZW50cygiLmNoZWNrZXIiKS5zaXplKCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICQodGhpcykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICQodGhpcykudW5pZm9ybSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIGhhbmRsZUJvb3RzdHJhcFN3aXRjaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWpRdWVyeSgpLmJvb3RzdHJhcFN3aXRjaCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgICQoJy5tYWtlLXN3aXRjaCcpLmJvb3RzdHJhcFN3aXRjaCgpOwogICAgfQoKICAgIC8vIEhhbmRsZXMgQm9vdHN0cmFwIEFjY29yZGlvbnMuCiAgICB2YXIgaGFuZGxlQWNjb3JkaW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkoJ2JvZHknKS5vbignc2hvd24uYnMuY29sbGFwc2UnLCAnLmFjY29yZGlvbi5zY3JvbGxhYmxlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgQXBwLnNjcm9sbFRvKCQoZS50YXJnZXQpKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIEJvb3RzdHJhcCBUYWJzLgogICAgdmFyIGhhbmRsZVRhYnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZml4IGNvbnRlbnQgaGVpZ2h0IG9uIHRhYiBjbGljawogICAgICAgICQoJ2JvZHknKS5vbignc2hvd24uYnMudGFiJywgJy5uYXYubmF2LXRhYnMnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vYWN0aXZhdGUgdGFiIGlmIHRhYiBpZCBwcm92aWRlZCBpbiB0aGUgVVJMCiAgICAgICAgaWYgKGxvY2F0aW9uLmhhc2gpIHsKICAgICAgICAgICAgdmFyIHRhYmlkID0gbG9jYXRpb24uaGFzaC5zdWJzdHIoMSk7CiAgICAgICAgICAgICQoJ2FbaHJlZj0iIycgKyB0YWJpZCArICciXScpLnBhcmVudHMoJy50YWItcGFuZTpoaWRkZW4nKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgdGFiaWQgPSAkKHRoaXMpLmF0dHIoImlkIik7CiAgICAgICAgICAgICAgICAkKCdhW2hyZWY9IiMnICsgdGFiaWQgKyAnIl0nKS5jbGljaygpOyAgICAKICAgICAgICAgICAgfSk7ICAgICAgICAgICAgCiAgICAgICAgICAgICQoJ2FbaHJlZj0iIycgKyB0YWJpZCArICciXScpLmNsaWNrKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEhhbmRsZXMgQm9vdHN0cmFwIE1vZGFscy4KICAgIHZhciBoYW5kbGVNb2RhbHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZml4IHN0YWNrYWJsZSBtb2RhbCBpc3N1ZTogd2hlbiAyIG9yIG1vcmUgbW9kYWxzIG9wZW5lZCwgY2xvc2luZyBvbmUgb2YgbW9kYWwgd2lsbCByZW1vdmUgLm1vZGFsLW9wZW4gY2xhc3MuIAogICAgICAgICQoJ2JvZHknKS5vbignaGlkZS5icy5tb2RhbCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICBpZiAoJCgnLm1vZGFsOnZpc2libGUnKS5zaXplKCkgPiAxICYmICQoJ2h0bWwnKS5oYXNDbGFzcygnbW9kYWwtb3BlbicpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgJCgnaHRtbCcpLmFkZENsYXNzKCdtb2RhbC1vcGVuJyk7CiAgICAgICAgICAgfSBlbHNlIGlmICgkKCcubW9kYWw6dmlzaWJsZScpLnNpemUoKSA8PSAxKSB7CiAgICAgICAgICAgICAgJCgnaHRtbCcpLnJlbW92ZUNsYXNzKCdtb2RhbC1vcGVuJyk7CiAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAkKCdib2R5Jykub24oJ3Nob3cuYnMubW9kYWwnLCAnLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygibW9kYWwtc2Nyb2xsIikpIHsKICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygibW9kYWwtb3Blbi1ub3Njcm9sbCIpOwogICAgICAgICAgICB9IAogICAgICAgIH0pOwoKICAgICAgICAkKCdib2R5Jykub24oJ2hpZGUuYnMubW9kYWwnLCAnLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAkKCdib2R5JykucmVtb3ZlQ2xhc3MoIm1vZGFsLW9wZW4tbm9zY3JvbGwiKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIEJvb3RzdHJhcCBUb29sdGlwcy4KICAgIHZhciBoYW5kbGVUb29sdGlwcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgIGpRdWVyeSgnLnRvb2x0aXBzJykudG9vbHRpcCgpOwogICAgfQoKICAgIC8vIEhhbmRsZXMgQm9vdHN0cmFwIERyb3Bkb3ducwogICAgdmFyIGhhbmRsZURyb3Bkb3ducyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvKgogICAgICAgICAgSG9sZCBkcm9wZG93biBvbiBjbGljayAgCiAgICAgICAgKi8KICAgICAgICAkKCdib2R5Jykub24oJ2NsaWNrJywgJy5kcm9wZG93bi1tZW51LmhvbGQtb24tY2xpY2snLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZSBIb3dlciBEcm9wZG93bnMKICAgIHZhciBoYW5kbGVEcm9wZG93bkhvdmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICQoJ1tkYXRhLWhvdmVyPSJkcm9wZG93biJdJykuZHJvcGRvd25Ib3ZlcigpOwogICAgfQoKICAgIHZhciBoYW5kbGVBbGVydHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgnYm9keScpLm9uKCdjbGljaycsICdbZGF0YS1jbG9zZT0iYWxlcnQiXScsIGZ1bmN0aW9uKGUpewogICAgICAgICAgICAkKHRoaXMpLnBhcmVudCgnLmFsZXJ0JykuaGlkZSgpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBCb290c3RyYXAgUG9wb3ZlcnMKCiAgICAvLyBsYXN0IHBvcGVwIHBvcG92ZXIKICAgIHZhciBsYXN0UG9wZWRQb3BvdmVyOwoKICAgIHZhciBoYW5kbGVQb3BvdmVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkoJy5wb3BvdmVycycpLnBvcG92ZXIoKTsKCiAgICAgICAgLy8gY2xvc2UgbGFzdCBwb3BlZCBwb3BvdmVyCgogICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljay5icy5wb3BvdmVyLmRhdGEtYXBpJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKGxhc3RQb3BlZFBvcG92ZXIpIHsKICAgICAgICAgICAgICAgIGxhc3RQb3BlZFBvcG92ZXIucG9wb3ZlcignaGlkZScpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSGFuZGxlcyBzY3JvbGxhYmxlIGNvbnRlbnRzIHVzaW5nIGpRdWVyeSBTbGltU2Nyb2xsIHBsdWdpbi4KICAgIHZhciBoYW5kbGVTY3JvbGxlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgnLnNjcm9sbGVyJykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBoZWlnaHQ7CiAgICAgICAgICAgIGlmICgkKHRoaXMpLmF0dHIoImRhdGEtaGVpZ2h0IikpIHsKICAgICAgICAgICAgICAgIGhlaWdodCA9ICQodGhpcykuYXR0cigiZGF0YS1oZWlnaHQiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlaWdodCA9ICQodGhpcykuY3NzKCdoZWlnaHQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkKHRoaXMpLnNsaW1TY3JvbGwoewogICAgICAgICAgICAgICAgYWxsb3dQYWdlU2Nyb2xsOiB0cnVlLCAvLyBhbGxvdyBwYWdlIHNjcm9sbCB3aGVuIHRoZSBlbGVtZW50IHNjcm9sbCBpcyBlbmRlZAogICAgICAgICAgICAgICAgc2l6ZTogJzdweCcsCiAgICAgICAgICAgICAgICBjb2xvcjogKCQodGhpcykuYXR0cigiZGF0YS1oYW5kbGUtY29sb3IiKSAgPyAkKHRoaXMpLmF0dHIoImRhdGEtaGFuZGxlLWNvbG9yIikgOiAnI2JiYicpLAogICAgICAgICAgICAgICAgcmFpbENvbG9yOiAoJCh0aGlzKS5hdHRyKCJkYXRhLXJhaWwtY29sb3IiKSAgPyAkKHRoaXMpLmF0dHIoImRhdGEtcmFpbC1jb2xvciIpIDogJyNlYWVhZWEnKSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBpc1JUTCA/ICdsZWZ0JyA6ICdyaWdodCcsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCwKICAgICAgICAgICAgICAgIGFsd2F5c1Zpc2libGU6ICgkKHRoaXMpLmF0dHIoImRhdGEtYWx3YXlzLXZpc2libGUiKSA9PSAiMSIgPyB0cnVlIDogZmFsc2UpLAogICAgICAgICAgICAgICAgcmFpbFZpc2libGU6ICgkKHRoaXMpLmF0dHIoImRhdGEtcmFpbC12aXNpYmxlIikgPT0gIjEiID8gdHJ1ZSA6IGZhbHNlKSwKICAgICAgICAgICAgICAgIGRpc2FibGVGYWRlT3V0OiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZXMgSW1hZ2UgUHJldmlldyB1c2luZyBqUXVlcnkgRmFuY3lib3ggcGx1Z2luCiAgICB2YXIgaGFuZGxlRmFuY3lib3ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFqUXVlcnkuZmFuY3lib3gpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGpRdWVyeSgiLmZhbmN5Ym94LWJ1dHRvbiIpLnNpemUoKSA+IDApIHsKICAgICAgICAgICAgalF1ZXJ5KCIuZmFuY3lib3gtYnV0dG9uIikuZmFuY3lib3goewogICAgICAgICAgICAgICAgZ3JvdXBBdHRyOiAnZGF0YS1yZWwnLAogICAgICAgICAgICAgICAgcHJldkVmZmVjdDogJ25vbmUnLAogICAgICAgICAgICAgICAgbmV4dEVmZmVjdDogJ25vbmUnLAogICAgICAgICAgICAgICAgY2xvc2VCdG46IHRydWUsCiAgICAgICAgICAgICAgICBoZWxwZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2luc2lkZScKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBGaXggaW5wdXQgcGxhY2Vob2xkZXIgaXNzdWUgZm9yIElFOCBhbmQgSUU5CiAgICB2YXIgaGFuZGxlRml4SW5wdXRQbGFjZWhvbGRlckZvcklFID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vZml4IGh0bWw1IHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgaWU3ICYgaWU4CiAgICAgICAgaWYgKGlzSUU4IHx8IGlzSUU5KSB7IC8vIGllOCAmIGllOQogICAgICAgICAgICAvLyB0aGlzIGlzIGh0bWw1IHBsYWNlaG9sZGVyIGZpeCBmb3IgaW5wdXRzLCBpbnB1dHMgd2l0aCBwbGFjZWhvbGRlci1uby1maXggY2xhc3Mgd2lsbCBiZSBza2lwcGVkKGUuZzogd2UgbmVlZCB0aGlzIGZvciBwYXNzd29yZCBmaWVsZHMpCiAgICAgICAgICAgIGpRdWVyeSgnaW5wdXRbcGxhY2Vob2xkZXJdOm5vdCgucGxhY2Vob2xkZXItbm8tZml4KSwgdGV4dGFyZWFbcGxhY2Vob2xkZXJdOm5vdCgucGxhY2Vob2xkZXItbm8tZml4KScpLmVhY2goZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGpRdWVyeSh0aGlzKTsKCiAgICAgICAgICAgICAgICBpZiAoaW5wdXQudmFsKCkgPT0gJycgJiYgaW5wdXQuYXR0cigicGxhY2Vob2xkZXIiKSAhPSAnJykgewogICAgICAgICAgICAgICAgICAgIGlucHV0LmFkZENsYXNzKCJwbGFjZWhvbGRlciIpLnZhbChpbnB1dC5hdHRyKCdwbGFjZWhvbGRlcicpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpbnB1dC5mb2N1cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LnZhbCgpID09IGlucHV0LmF0dHIoJ3BsYWNlaG9sZGVyJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpbnB1dC5ibHVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQudmFsKCkgPT0gJycgfHwgaW5wdXQudmFsKCkgPT0gaW5wdXQuYXR0cigncGxhY2Vob2xkZXInKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWwoaW5wdXQuYXR0cigncGxhY2Vob2xkZXInKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBIYW5kbGUgZnVsbCBzY3JlZW4gbW9kZSB0b2dnbGUKICAgIHZhciBoYW5kbGVGdWxsU2NyZWVuTW9kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIG1vemZ1bGxzY3JlZW5lcnJvciBldmVudCBoYW5kbGVyCiAgICAgICAKICAgICAgICAvLyB0b2dnbGUgZnVsbCBzY3JlZW4KICAgICAgICBmdW5jdGlvbiB0b2dnbGVGdWxsU2NyZWVuKCkgewogICAgICAgICAgaWYgKCFkb2N1bWVudC5mdWxsc2NyZWVuRWxlbWVudCAmJiAgICAvLyBhbHRlcm5hdGl2ZSBzdGFuZGFyZCBtZXRob2QKICAgICAgICAgICAgICAhZG9jdW1lbnQubW96RnVsbFNjcmVlbkVsZW1lbnQgJiYgIWRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbGVtZW50KSB7ICAvLyBjdXJyZW50IHdvcmtpbmcgbWV0aG9kcwogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnJlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnJlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm1velJlcXVlc3RGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm1velJlcXVlc3RGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKEVsZW1lbnQuQUxMT1dfS0VZQk9BUkRfSU5QVVQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbikgewogICAgICAgICAgICAgIGRvY3VtZW50LmNhbmNlbEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5tb3pDYW5jZWxGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICBkb2N1bWVudC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICQoJyN0cmlnZ2VyX2Z1bGxzY3JlZW4nKS5jbGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgdG9nZ2xlRnVsbFNjcmVlbigpOwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEhhbmRsZSBTZWxlY3QyIERyb3Bkb3ducwogICAgdmFyIGhhbmRsZVNlbGVjdDIgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoalF1ZXJ5KCkuc2VsZWN0MikgewogICAgICAgICAgICAkKCcuc2VsZWN0Mm1lJykuc2VsZWN0Mih7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogIlNlbGVjdCIsCiAgICAgICAgICAgICAgICBhbGxvd0NsZWFyOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBIYW5kbGUgVGhlbWUgU2V0dGluZ3MKICAgIHZhciBoYW5kbGVUaGVtZSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHBhbmVsID0gJCgnLnRoZW1lLXBhbmVsJyk7CgogICAgICAgIGlmICgkKCdib2R5JykuaGFzQ2xhc3MoJ3BhZ2UtYm94ZWQnKSA9PSBmYWxzZSkgewogICAgICAgICAgICAkKCcubGF5b3V0LW9wdGlvbicsIHBhbmVsKS52YWwoImZsdWlkIik7CiAgICAgICAgfQoKICAgICAgICAkKCcuc2lkZWJhci1vcHRpb24nLCBwYW5lbCkudmFsKCJkZWZhdWx0Iik7CiAgICAgICAgJCgnLmhlYWRlci1vcHRpb24nLCBwYW5lbCkudmFsKCJmaXhlZCIpOwogICAgICAgICQoJy5mb290ZXItb3B0aW9uJywgcGFuZWwpLnZhbCgiZGVmYXVsdCIpOwogICAgICAgIGlmICggJCgnLnNpZGViYXItcG9zLW9wdGlvbicpLmF0dHIoImRpc2FibGVkIikgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICQoJy5zaWRlYmFyLXBvcy1vcHRpb24nLCBwYW5lbCkudmFsKEFwcC5pc1JUTCgpID8gJ3JpZ2h0JyA6ICdsZWZ0Jyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vaGFuZGxlIHRoZW1lIGxheW91dAogICAgICAgIHZhciByZXNldExheW91dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgJCgiYm9keSIpLgogICAgICAgICAgICByZW1vdmVDbGFzcygicGFnZS1ib3hlZCIpLgogICAgICAgICAgICByZW1vdmVDbGFzcygicGFnZS1mb290ZXItZml4ZWQiKS4KICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoInBhZ2Utc2lkZWJhci1maXhlZCIpLgogICAgICAgICAgICByZW1vdmVDbGFzcygicGFnZS1oZWFkZXItZml4ZWQiKS4KICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoInBhZ2Utc2lkZWJhci1yZXZlcnNlZCIpOwoKICAgICAgICAgICAgJCgnLmhlYWRlciA+IC5oZWFkZXItaW5uZXInKS5yZW1vdmVDbGFzcygiY29udGFpbmVyIik7CgogICAgICAgICAgICBpZiAoJCgnLnBhZ2UtY29udGFpbmVyJykucGFyZW50KCIuY29udGFpbmVyIikuc2l6ZSgpID09PSAxKSB7CiAgICAgICAgICAgICAgICAkKCcucGFnZS1jb250YWluZXInKS5pbnNlcnRBZnRlcignYm9keSA+IC5jbGVhcmZpeCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJCgnLmZvb3RlciA+IC5jb250YWluZXInKS5zaXplKCkgPT09IDEpIHsKICAgICAgICAgICAgICAgICQoJy5mb290ZXInKS5odG1sKCQoJy5mb290ZXIgPiAuY29udGFpbmVyJykuaHRtbCgpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgkKCcuZm9vdGVyJykucGFyZW50KCIuY29udGFpbmVyIikuc2l6ZSgpID09PSAxKSB7CiAgICAgICAgICAgICAgICAkKCcuZm9vdGVyJykuaW5zZXJ0QWZ0ZXIoJy5wYWdlLWNvbnRhaW5lcicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkKCdib2R5ID4gLmNvbnRhaW5lcicpLnJlbW92ZSgpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxhc3RTZWxlY3RlZExheW91dCA9ICcnOwoKICAgICAgICB2YXIgc2V0TGF5b3V0ID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgdmFyIGxheW91dE9wdGlvbiA9ICQoJy5sYXlvdXQtb3B0aW9uJywgcGFuZWwpLnZhbCgpOwogICAgICAgICAgICB2YXIgc2lkZWJhck9wdGlvbiA9ICQoJy5zaWRlYmFyLW9wdGlvbicsIHBhbmVsKS52YWwoKTsKICAgICAgICAgICAgdmFyIGhlYWRlck9wdGlvbiA9ICQoJy5oZWFkZXItb3B0aW9uJywgcGFuZWwpLnZhbCgpOwogICAgICAgICAgICB2YXIgZm9vdGVyT3B0aW9uID0gJCgnLmZvb3Rlci1vcHRpb24nLCBwYW5lbCkudmFsKCk7CiAgICAgICAgICAgIHZhciBzaWRlYmFyUG9zT3B0aW9uID0gJCgnLnNpZGViYXItcG9zLW9wdGlvbicsIHBhbmVsKS52YWwoKTsKCiAgICAgICAgICAgIGlmIChzaWRlYmFyT3B0aW9uID09ICJmaXhlZCIgJiYgaGVhZGVyT3B0aW9uID09ICJkZWZhdWx0IikgewogICAgICAgICAgICAgICAgYWxlcnQoJ0RlZmF1bHQgSGVhZGVyIHdpdGggRml4ZWQgU2lkZWJhciBvcHRpb24gaXMgbm90IHN1cHBvcnRlZC4gUHJvY2VlZCB3aXRoIEZpeGVkIEhlYWRlciB3aXRoIEZpeGVkIFNpZGViYXIuJyk7CiAgICAgICAgICAgICAgICAkKCcuaGVhZGVyLW9wdGlvbicsIHBhbmVsKS52YWwoImZpeGVkIik7CiAgICAgICAgICAgICAgICAkKCcuc2lkZWJhci1vcHRpb24nLCBwYW5lbCkudmFsKCJmaXhlZCIpOwogICAgICAgICAgICAgICAgc2lkZWJhck9wdGlvbiA9ICdmaXhlZCc7CiAgICAgICAgICAgICAgICBoZWFkZXJPcHRpb24gPSAnZml4ZWQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNldExheW91dCgpOyAvLyByZXNldCBsYXlvdXQgdG8gZGVmYXVsdCBzdGF0ZQoKICAgICAgICAgICAgaWYgKGxheW91dE9wdGlvbiA9PT0gImJveGVkIikgewogICAgICAgICAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJwYWdlLWJveGVkIik7CgogICAgICAgICAgICAgICAgLy8gc2V0IGhlYWRlcgogICAgICAgICAgICAgICAgJCgnLmhlYWRlciA+IC5oZWFkZXItaW5uZXInKS5hZGRDbGFzcygiY29udGFpbmVyIik7CiAgICAgICAgICAgICAgICB2YXIgY29udCA9ICQoJ2JvZHkgPiAuY2xlYXJmaXgnKS5hZnRlcignPGRpdiBjbGFzcz0iY29udGFpbmVyIj48L2Rpdj4nKTsKCiAgICAgICAgICAgICAgICAvLyBzZXQgY29udGVudAogICAgICAgICAgICAgICAgJCgnLnBhZ2UtY29udGFpbmVyJykuYXBwZW5kVG8oJ2JvZHkgPiAuY29udGFpbmVyJyk7CgogICAgICAgICAgICAgICAgLy8gc2V0IGZvb3RlcgogICAgICAgICAgICAgICAgaWYgKGZvb3Rlck9wdGlvbiA9PT0gJ2ZpeGVkJykgewogICAgICAgICAgICAgICAgICAgICQoJy5mb290ZXInKS5odG1sKCc8ZGl2IGNsYXNzPSJjb250YWluZXIiPicgKyAkKCcuZm9vdGVyJykuaHRtbCgpICsgJzwvZGl2PicpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCcuZm9vdGVyJykuYXBwZW5kVG8oJ2JvZHkgPiAuY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsYXN0U2VsZWN0ZWRMYXlvdXQgIT0gbGF5b3V0T3B0aW9uKSB7CiAgICAgICAgICAgICAgICAvL2xheW91dCBjaGFuZ2VkLCBydW4gcmVzcG9uc2l2ZSBoYW5kbGVyOgogICAgICAgICAgICAgICAgcnVuUmVzcG9uc2l2ZUhhbmRsZXJzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdFNlbGVjdGVkTGF5b3V0ID0gbGF5b3V0T3B0aW9uOwoKICAgICAgICAgICAgLy9oZWFkZXIKICAgICAgICAgICAgaWYgKGhlYWRlck9wdGlvbiA9PT0gJ2ZpeGVkJykgewogICAgICAgICAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJwYWdlLWhlYWRlci1maXhlZCIpOwogICAgICAgICAgICAgICAgJCgiLmhlYWRlciIpLnJlbW92ZUNsYXNzKCJuYXZiYXItc3RhdGljLXRvcCIpLmFkZENsYXNzKCJuYXZiYXItZml4ZWQtdG9wIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKCJib2R5IikucmVtb3ZlQ2xhc3MoInBhZ2UtaGVhZGVyLWZpeGVkIik7CiAgICAgICAgICAgICAgICAkKCIuaGVhZGVyIikucmVtb3ZlQ2xhc3MoIm5hdmJhci1maXhlZC10b3AiKS5hZGRDbGFzcygibmF2YmFyLXN0YXRpYy10b3AiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9zaWRlYmFyCiAgICAgICAgICAgIGlmICgkKCdib2R5JykuaGFzQ2xhc3MoJ3BhZ2UtZnVsbC13aWR0aCcpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgaWYgKHNpZGViYXJPcHRpb24gPT09ICdmaXhlZCcpIHsKICAgICAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2Utc2lkZWJhci1maXhlZCIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCJib2R5IikucmVtb3ZlQ2xhc3MoInBhZ2Utc2lkZWJhci1maXhlZCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2Zvb3RlciAKICAgICAgICAgICAgaWYgKGZvb3Rlck9wdGlvbiA9PT0gJ2ZpeGVkJykgewogICAgICAgICAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJwYWdlLWZvb3Rlci1maXhlZCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCgiYm9keSIpLnJlbW92ZUNsYXNzKCJwYWdlLWZvb3Rlci1maXhlZCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3NpZGViYXIgcG9zaXRpb24KICAgICAgICAgICAgaWYgKEFwcC5pc1JUTCgpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2lkZWJhclBvc09wdGlvbiA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgICAgICAgICAgJCgiYm9keSIpLmFkZENsYXNzKCJwYWdlLXNpZGViYXItcmV2ZXJzZWQiKTsKICAgICAgICAgICAgICAgICAgICAkKCcjZnJvbnRlbmQtbGluaycpLnRvb2x0aXAoJ2Rlc3Ryb3knKS50b29sdGlwKHtwbGFjZW1lbnQ6ICdyaWdodCd9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgiYm9keSIpLnJlbW92ZUNsYXNzKCJwYWdlLXNpZGViYXItcmV2ZXJzZWQiKTsKICAgICAgICAgICAgICAgICAgICAkKCcjZnJvbnRlbmQtbGluaycpLnRvb2x0aXAoJ2Rlc3Ryb3knKS50b29sdGlwKHtwbGFjZW1lbnQ6ICdsZWZ0J30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHNpZGViYXJQb3NPcHRpb24gPT09ICdyaWdodCcpIHsKICAgICAgICAgICAgICAgICAgICAkKCJib2R5IikuYWRkQ2xhc3MoInBhZ2Utc2lkZWJhci1yZXZlcnNlZCIpOwogICAgICAgICAgICAgICAgICAgICQoJyNmcm9udGVuZC1saW5rJykudG9vbHRpcCgnZGVzdHJveScpLnRvb2x0aXAoe3BsYWNlbWVudDogJ2xlZnQnfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoImJvZHkiKS5yZW1vdmVDbGFzcygicGFnZS1zaWRlYmFyLXJldmVyc2VkIik7CiAgICAgICAgICAgICAgICAgICAgJCgnI2Zyb250ZW5kLWxpbmsnKS50b29sdGlwKCdkZXN0cm95JykudG9vbHRpcCh7cGxhY2VtZW50OiAncmlnaHQnfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGhhbmRsZVNpZGViYXJBbmRDb250ZW50SGVpZ2h0KCk7IC8vIGZpeCBjb250ZW50IGhlaWdodCAgICAgICAgICAgIAogICAgICAgICAgICBoYW5kbGVGaXhlZFNpZGViYXIoKTsgLy8gcmVpbml0aWFsaXplIGZpeGVkIHNpZGViYXIKICAgICAgICAgICAgaGFuZGxlRml4ZWRTaWRlYmFySG92ZXJhYmxlKCk7IC8vIHJlaW5pdGlhbGl6ZSBmaXhlZCBzaWRlYmFyIGhvdmVyIGVmZmVjdAogICAgICAgIH0KCiAgICAgICAgLy8gaGFuZGxlIHRoZW1lIGNvbG9ycwogICAgICAgIHZhciBzZXRDb2xvciA9IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgICAgICB2YXIgY29sb3JfID0gKEFwcC5pc1JUTCgpID8gY29sb3IgKyAnLXJ0bCcgOiBjb2xvcik7CiAgICAgICAgICAgICQoJyNzdHlsZV9jb2xvcicpLmF0dHIoImhyZWYiLCAiYXNzZXRzL2Nzcy90aGVtZXMvIiArIGNvbG9yXyArICIuY3NzIik7CiAgICAgICAgICAgIGlmICgkLmNvb2tpZSkgeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICQuY29va2llKCdzdHlsZV9jb2xvcicsIGNvbG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJCgnLnRvZ2dsZXInLCBwYW5lbCkuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAkKCcudG9nZ2xlcicpLmhpZGUoKTsKICAgICAgICAgICAgJCgnLnRvZ2dsZXItY2xvc2UnKS5zaG93KCk7CiAgICAgICAgICAgICQoJy50aGVtZS1wYW5lbCA+IC50aGVtZS1vcHRpb25zJykuc2hvdygpOwogICAgICAgIH0pOwoKICAgICAgICAkKCcudG9nZ2xlci1jbG9zZScsIHBhbmVsKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICQoJy50b2dnbGVyJykuc2hvdygpOwogICAgICAgICAgICAkKCcudG9nZ2xlci1jbG9zZScpLmhpZGUoKTsKICAgICAgICAgICAgJCgnLnRoZW1lLXBhbmVsID4gLnRoZW1lLW9wdGlvbnMnKS5oaWRlKCk7CiAgICAgICAgfSk7CgogICAgICAgICQoJy50aGVtZS1jb2xvcnMgPiB1bCA+IGxpJywgcGFuZWwpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNvbG9yID0gJCh0aGlzKS5hdHRyKCJkYXRhLXN0eWxlIik7CiAgICAgICAgICAgIHNldENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgJCgndWwgPiBsaScsIHBhbmVsKS5yZW1vdmVDbGFzcygiY3VycmVudCIpOwogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJjdXJyZW50Iik7CiAgICAgICAgfSk7CgogICAgICAgICQoJy5sYXlvdXQtb3B0aW9uLCAuaGVhZGVyLW9wdGlvbiwgLnNpZGViYXItb3B0aW9uLCAuZm9vdGVyLW9wdGlvbiwgLnNpZGViYXItcG9zLW9wdGlvbicsIHBhbmVsKS5jaGFuZ2Uoc2V0TGF5b3V0KTsKCiAgICAgICAgaWYgKCQuY29va2llICYmICQuY29va2llKCdzdHlsZV9jb2xvcicpKSB7CiAgICAgICAgICAgIHNldENvbG9yKCQuY29va2llKCdzdHlsZV9jb2xvcicpKTsKICAgICAgICB9CiAgICB9CgogICAgLy8qIEVORDpDT1JFIEhBTkRMRVJTICovLwoKICAgIHJldHVybiB7CgogICAgICAgIC8vbWFpbiBmdW5jdGlvbiB0byBpbml0aWF0ZSB0aGUgdGhlbWUKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAvL0lNUE9SVEFOVCEhITogRG8gbm90IG1vZGlmeSB0aGUgY29yZSBoYW5kbGVycyBjYWxsIG9yZGVyLgoKICAgICAgICAgICAgLy9jb3JlIGhhbmRsZXJzCiAgICAgICAgICAgIGhhbmRsZUluaXQoKTsgLy8gaW5pdGlhbGl6ZSBjb3JlIHZhcmlhYmxlcwogICAgICAgICAgICBoYW5kbGVSZXNwb25zaXZlT25SZXNpemUoKTsgLy8gc2V0IGFuZCBoYW5kbGUgcmVzcG9uc2l2ZSAgICAKICAgICAgICAgICAgaGFuZGxlVW5pZm9ybSgpOyAvLyBoYW5mbGUgY3VzdG9tIHJhZGlvICYgY2hlY2tib3hlcwogICAgICAgICAgICBoYW5kbGVCb290c3RyYXBTd2l0Y2goKTsgLy8gaGFuZGxlIGJvb3RzdHJhcCBzd2l0Y2ggcGx1Z2luCiAgICAgICAgICAgIGhhbmRsZVNjcm9sbGVycygpOyAvLyBoYW5kbGVzIHNsaW0gc2Nyb2xsaW5nIGNvbnRlbnRzIAogICAgICAgICAgICBoYW5kbGVSZXNwb25zaXZlT25Jbml0KCk7IC8vIGhhbmRsZXIgcmVzcG9uc2l2ZSBlbGVtZW50cyBvbiBwYWdlIGxvYWQKCiAgICAgICAgICAgIC8vbGF5b3V0IGhhbmRsZXJzCiAgICAgICAgICAgIGhhbmRsZUZpeGVkU2lkZWJhcigpOyAvLyBoYW5kbGVzIGZpeGVkIHNpZGViYXIgbWVudQogICAgICAgICAgICBoYW5kbGVGaXhlZFNpZGViYXJIb3ZlcmFibGUoKTsgLy8gaGFuZGxlcyBmaXhlZCBzaWRlYmFyIG9uIGhvdmVyIGVmZmVjdCAKICAgICAgICAgICAgaGFuZGxlU2lkZWJhck1lbnUoKTsgLy8gaGFuZGxlcyBtYWluIG1lbnUKICAgICAgICAgICAgaGFuZGxlSG9yaXpvbnRhbE1lbnUoKTsgLy8gaGFuZGxlcyBob3Jpem9udGFsIG1lbnUKICAgICAgICAgICAgaGFuZGxlU2lkZWJhclRvZ2dsZXIoKTsgLy8gaGFuZGxlcyBzaWRlYmFyIGhpZGUvc2hvdyAgICAgICAgICAgIAogICAgICAgICAgICBoYW5kbGVGaXhJbnB1dFBsYWNlaG9sZGVyRm9ySUUoKTsgLy8gZml4ZXMvZW5hYmxlcyBodG1sNSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgZm9yIElFOSwgSUU4CiAgICAgICAgICAgIGhhbmRsZUdvVG9wKCk7IC8vaGFuZGxlcyBzY3JvbGwgdG8gdG9wIGZ1bmN0aW9uYWxpdHkgaW4gdGhlIGZvb3RlcgogICAgICAgICAgICBoYW5kbGVUaGVtZSgpOyAvLyBoYW5kbGVzIHN0eWxlIGN1c3RvbWVyIHRvb2wKCiAgICAgICAgICAgIC8vdWkgY29tcG9uZW50IGhhbmRsZXJzCiAgICAgICAgICAgIGhhbmRsZUZhbmN5Ym94KCkgLy8gaGFuZGxlIGZhbmN5IGJveAogICAgICAgICAgICBoYW5kbGVTZWxlY3QyKCk7IC8vIGhhbmRsZSBjdXN0b20gU2VsZWN0MiBkcm9wZG93bnMKICAgICAgICAgICAgaGFuZGxlUG9ydGxldFRvb2xzKCk7IC8vIGhhbmRsZXMgcG9ydGxldCBhY3Rpb24gYmFyIGZ1bmN0aW9uYWxpdHkocmVmcmVzaCwgY29uZmlndXJlLCB0b2dnbGUsIHJlbW92ZSkKICAgICAgICAgICAgaGFuZGxlQWxlcnRzKCk7IC8vaGFuZGxlIGNsb3NhYmxlZCBhbGVydHMKICAgICAgICAgICAgaGFuZGxlRHJvcGRvd25zKCk7IC8vIGhhbmRsZSBkcm9wZG93bnMKICAgICAgICAgICAgaGFuZGxlVGFicygpOyAvLyBoYW5kbGUgdGFicwogICAgICAgICAgICBoYW5kbGVUb29sdGlwcygpOyAvLyBoYW5kbGUgYm9vdHN0cmFwIHRvb2x0aXBzCiAgICAgICAgICAgIGhhbmRsZVBvcG92ZXJzKCk7IC8vIGhhbmRsZXMgYm9vdHN0cmFwIHBvcG92ZXJzCiAgICAgICAgICAgIGhhbmRsZUFjY29yZGlvbnMoKTsgLy9oYW5kbGVzIGFjY29yZGlvbnMgCiAgICAgICAgICAgIGhhbmRsZU1vZGFscygpOyAvLyBoYW5kbGUgbW9kYWxzCiAgICAgICAgICAgIGhhbmRsZUZ1bGxTY3JlZW5Nb2RlKCk7IC8vIGhhbmRsZXMgZnVsbCBzY3JlZW4KICAgICAgICB9LAoKICAgICAgICAvL21haW4gZnVuY3Rpb24gdG8gaW5pdGlhdGUgY29yZSBqYXZhc2NyaXB0IGFmdGVyIGFqYXggY29tcGxldGUKICAgICAgICBpbml0QWpheDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBoYW5kbGVTY3JvbGxlcnMoKTsgLy8gaGFuZGxlcyBzbGltIHNjcm9sbGluZyBjb250ZW50cyAKICAgICAgICAgICAgaGFuZGxlU2VsZWN0MigpOyAvLyBoYW5kbGUgY3VzdG9tIFNlbGVjdDIgZHJvcGRvd25zCiAgICAgICAgICAgIGhhbmRsZURyb3Bkb3ducygpOyAvLyBoYW5kbGUgZHJvcGRvd25zCiAgICAgICAgICAgIGhhbmRsZVRvb2x0aXBzKCk7IC8vIGhhbmRsZSBib290c3RyYXAgdG9vbHRpcHMKICAgICAgICAgICAgaGFuZGxlUG9wb3ZlcnMoKTsgLy8gaGFuZGxlcyBib290c3RyYXAgcG9wb3ZlcnMKICAgICAgICAgICAgaGFuZGxlQWNjb3JkaW9ucygpOyAvL2hhbmRsZXMgYWNjb3JkaW9ucyAKICAgICAgICAgICAgaGFuZGxlVW5pZm9ybSgpOyAvLyBoYW5mbGUgY3VzdG9tIHJhZGlvICYgY2hlY2tib3hlcyAgICAgCiAgICAgICAgICAgIGhhbmRsZUJvb3RzdHJhcFN3aXRjaCgpOyAvLyBoYW5kbGUgYm9vdHN0cmFwIHN3aXRjaCBwbHVnaW4KICAgICAgICAgICAgaGFuZGxlRHJvcGRvd25Ib3ZlcigpIC8vIGhhbmRsZXMgZHJvcGRvd24gaG92ZXIgICAgICAgCiAgICAgICAgfSwKCiAgICAgICAgLy9wdWJsaWMgZnVuY3Rpb24gdG8gZml4IHRoZSBzaWRlYmFyIGFuZCBjb250ZW50IGhlaWdodCBhY2NvcmRpbmdseQogICAgICAgIGZpeENvbnRlbnRIZWlnaHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaGFuZGxlU2lkZWJhckFuZENvbnRlbnRIZWlnaHQoKTsKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBmdW5jdGlvbiB0byByZW1lbWJlciBsYXN0IG9wZW5lZCBwb3BvdmVyIHRoYXQgbmVlZHMgdG8gYmUgY2xvc2VkIG9uIGNsaWNrCiAgICAgICAgc2V0TGFzdFBvcGVkUG9wb3ZlcjogZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICAgIGxhc3RQb3BlZFBvcG92ZXIgPSBlbDsKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBmdW5jdGlvbiB0byBhZGQgY2FsbGJhY2sgYSBmdW5jdGlvbiB3aGljaCB3aWxsIGJlIGNhbGxlZCBvbiB3aW5kb3cgcmVzaXplCiAgICAgICAgYWRkUmVzcG9uc2l2ZUhhbmRsZXI6IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgICAgIHJlc3BvbnNpdmVIYW5kbGVycy5wdXNoKGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8vIHVzZWZ1bCBmdW5jdGlvbiB0byBtYWtlIGVxdWFsIGhlaWdodCBmb3IgY29udGFjdHMgc3RhbmQgc2lkZSBieSBzaWRlCiAgICAgICAgc2V0RXF1YWxIZWlnaHQ6IGZ1bmN0aW9uIChlbHMpIHsKICAgICAgICAgICAgdmFyIHRhbGxlc3RFbCA9IDA7CiAgICAgICAgICAgIGVscyA9IGpRdWVyeShlbHMpOwogICAgICAgICAgICBlbHMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEhlaWdodCA9ICQodGhpcykuaGVpZ2h0KCk7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEhlaWdodCA+IHRhbGxlc3RFbCkgewogICAgICAgICAgICAgICAgICAgIHRhbGxlc3RDb2x1bW4gPSBjdXJyZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWxzLmhlaWdodCh0YWxsZXN0RWwpOwogICAgICAgIH0sCgogICAgICAgIC8vIHdyYXBwZXIgZnVuY3Rpb24gdG8gc2Nyb2xsKGZvY3VzKSB0byBhbiBlbGVtZW50CiAgICAgICAgc2Nyb2xsVG86IGZ1bmN0aW9uIChlbCwgb2ZmZXNldCkgewogICAgICAgICAgICB2YXIgcG9zID0gKGVsICYmIGVsLnNpemUoKSA+IDApID8gZWwub2Zmc2V0KCkudG9wIDogMDsKCiAgICAgICAgICAgIGlmIChlbCkgewogICAgICAgICAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygncGFnZS1oZWFkZXItZml4ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvcyAtICQoJy5oZWFkZXInKS5oZWlnaHQoKTsgCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwb3MgPSBwb3MgKyAob2ZmZXNldCA/IG9mZmVzZXQgOiAtMSAqIGVsLmhlaWdodCgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgalF1ZXJ5KCdodG1sLGJvZHknKS5hbmltYXRlKHsKICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogcG9zCiAgICAgICAgICAgIH0sICdzbG93Jyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gZnVuY3Rpb24gdG8gc2Nyb2xsIHRvIHRoZSB0b3AKICAgICAgICBzY3JvbGxUb3A6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgQXBwLnNjcm9sbFRvKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gd3JhcHBlciBmdW5jdGlvbiB0byAgYmxvY2sgZWxlbWVudChpbmRpY2F0ZSBsb2FkaW5nKQogICAgICAgIGJsb2NrVUk6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMpOwogICAgICAgICAgICB2YXIgaHRtbCA9ICcnOwogICAgICAgICAgICBpZiAob3B0aW9ucy5pY29uT25seSkgewogICAgICAgICAgICAgICAgaHRtbCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nLW1lc3NhZ2UgJyArIChvcHRpb25zLmJveGVkID8gJ2xvYWRpbmctbWVzc2FnZS1ib3hlZCcgOiAnJykrJyI+PGltZyBzdHlsZT0iIiBzcmM9Ii4vYXNzZXRzL2ltZy9sb2FkaW5nLXNwaW5uZXItZ3JleS5naWYiIGFsaWduPSIiPjwvZGl2Pic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy50ZXh0T25seSkgewogICAgICAgICAgICAgICAgaHRtbCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nLW1lc3NhZ2UgJyArIChvcHRpb25zLmJveGVkID8gJ2xvYWRpbmctbWVzc2FnZS1ib3hlZCcgOiAnJykrJyI+PHNwYW4+Jm5ic3A7Jm5ic3A7JyArIChvcHRpb25zLm1lc3NhZ2UgPyBvcHRpb25zLm1lc3NhZ2UgOiAnTE9BRElORy4uLicpICsgJzwvc3Bhbj48L2Rpdj4nOwogICAgICAgICAgICB9IGVsc2UgeyAgICAKICAgICAgICAgICAgICAgIGh0bWwgPSAnPGRpdiBjbGFzcz0ibG9hZGluZy1tZXNzYWdlICcgKyAob3B0aW9ucy5ib3hlZCA/ICdsb2FkaW5nLW1lc3NhZ2UtYm94ZWQnIDogJycpKyciPjxpbWcgc3R5bGU9IiIgc3JjPSIuL2Fzc2V0cy9pbWcvbG9hZGluZy1zcGlubmVyLWdyZXkuZ2lmIiBhbGlnbj0iIj48c3Bhbj4mbmJzcDsmbmJzcDsnICsgKG9wdGlvbnMubWVzc2FnZSA/IG9wdGlvbnMubWVzc2FnZSA6ICdMT0FESU5HLi4uJykgKyAnPC9zcGFuPjwvZGl2Pic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLnRhcmdldCkgeyAvLyBlbGVtZW50IGJsb2NraW5nCiAgICAgICAgICAgICAgICB2YXIgZWwgPSBqUXVlcnkob3B0aW9ucy50YXJnZXQpOwogICAgICAgICAgICAgICAgaWYgKGVsLmhlaWdodCgpIDw9ICgkKHdpbmRvdykuaGVpZ2h0KCkpKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jZW5yZXJZID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsLmJsb2NrKHsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBodG1sLAogICAgICAgICAgICAgICAgICAgIGJhc2VaOiBvcHRpb25zLnpJbmRleCA/IG9wdGlvbnMuekluZGV4IDogMTAwMCwKICAgICAgICAgICAgICAgICAgICBjZW50ZXJZOiBvcHRpb25zLmNlbnJlclkgIT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jZW5yZXJZIDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY3NzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogJzEwJScsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogJzAnLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ25vbmUnCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvdmVybGF5Q1NTOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogb3B0aW9ucy5vdmVybGF5Q29sb3IgPyBvcHRpb25zLm92ZXJsYXlDb2xvciA6ICcjMDAwJywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogb3B0aW9ucy5ib3hlZCA/IDAuMDUgOiAwLjEsIAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICd3YWl0JwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgeyAvLyBwYWdlIGJsb2NraW5nCiAgICAgICAgICAgICAgICAkLmJsb2NrVUkoewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGh0bWwsCiAgICAgICAgICAgICAgICAgICAgYmFzZVo6IG9wdGlvbnMuekluZGV4ID8gb3B0aW9ucy56SW5kZXggOiAxMDAwLAogICAgICAgICAgICAgICAgICAgIGNzczogewogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICcwJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogJzAnLAogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdub25lJwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheUNTUzogewogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG9wdGlvbnMub3ZlcmxheUNvbG9yID8gb3B0aW9ucy5vdmVybGF5Q29sb3IgOiAnIzAwMCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IG9wdGlvbnMuYm94ZWQgPyAwLjA1IDogMC4xLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICd3YWl0JwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgfSwKCiAgICAgICAgLy8gd3JhcHBlciBmdW5jdGlvbiB0byAgdW4tYmxvY2sgZWxlbWVudChmaW5pc2ggbG9hZGluZykKICAgICAgICB1bmJsb2NrVUk6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICAgICAgalF1ZXJ5KHRhcmdldCkudW5ibG9jayh7CiAgICAgICAgICAgICAgICAgICAgb25VbmJsb2NrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0YXJnZXQpLmNzcygncG9zaXRpb24nLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0YXJnZXQpLmNzcygnem9vbScsICcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQudW5ibG9ja1VJKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzdGFydFBhZ2VMb2FkaW5nOiBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgICQoJy5wYWdlLWxvYWRpbmcnKS5yZW1vdmUoKTsKICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZCgnPGRpdiBjbGFzcz0icGFnZS1sb2FkaW5nIj48aW1nIHNyYz0iYXNzZXRzL2ltZy9sb2FkaW5nLXNwaW5uZXItZ3JleS5naWYiLz4mbmJzcDsmbmJzcDs8c3Bhbj4nICsgKG1lc3NhZ2UgPyBtZXNzYWdlIDogJ0xvYWRpbmcuLi4nKSArICc8L3NwYW4+PC9kaXY+Jyk7CiAgICAgICAgfSwKCiAgICAgICAgc3RvcFBhZ2VMb2FkaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJCgnLnBhZ2UtbG9hZGluZycpLnJlbW92ZSgpOwogICAgICAgIH0sCgogICAgICAgIC8vIGluaXRpYWxpemVzIHVuaWZvcm0gZWxlbWVudHMKICAgICAgICBpbml0VW5pZm9ybTogZnVuY3Rpb24gKGVscykgewogICAgICAgICAgICBpZiAoZWxzKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkoZWxzKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5wYXJlbnRzKCIuY2hlY2tlciIpLnNpemUoKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnVuaWZvcm0oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhhbmRsZVVuaWZvcm0oKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vd3JhcHBlciBmdW5jdGlvbiB0byB1cGRhdGUvc3luYyBqcXVlcnkgdW5pZm9ybSBjaGVja2JveCAmIHJhZGlvcwogICAgICAgIHVwZGF0ZVVuaWZvcm06IGZ1bmN0aW9uIChlbHMpIHsKICAgICAgICAgICAgJC51bmlmb3JtLnVwZGF0ZShlbHMpOyAvLyB1cGRhdGUgdGhlIHVuaWZvcm0gY2hlY2tib3ggJiByYWRpb3MgVUkgYWZ0ZXIgdGhlIGFjdHVhbCBpbnB1dCBjb250cm9sIHN0YXRlIGNoYW5nZWQKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBmdW5jdGlvbiB0byBpbml0aWFsaXplIHRoZSBmYW5jeWJveCBwbHVnaW4KICAgICAgICBpbml0RmFuY3lib3g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaGFuZGxlRmFuY3lib3goKTsKICAgICAgICB9LAoKICAgICAgICAvL3B1YmxpYyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGFjdHVhbCBpbnB1dCB2YWx1ZSh1c2VkIGluIElFOSBhbmQgSUU4IGR1ZSB0byBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgbm90IHN1cHBvcnRlZCkKICAgICAgICBnZXRBY3R1YWxWYWw6IGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBqUXVlcnkoZWwpOwogICAgICAgICAgICBpZiAoZWwudmFsKCkgPT09IGVsLmF0dHIoInBsYWNlaG9sZGVyIikpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWwudmFsKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy9wdWJsaWMgZnVuY3Rpb24gdG8gZ2V0IGEgcGFyZW1ldGVyIGJ5IG5hbWUgZnJvbSBVUkwKICAgICAgICBnZXRVUkxQYXJhbWV0ZXI6IGZ1bmN0aW9uIChwYXJhbU5hbWUpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaFN0cmluZyA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpLAogICAgICAgICAgICAgICAgaSwgdmFsLCBwYXJhbXMgPSBzZWFyY2hTdHJpbmcuc3BsaXQoIiYiKTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhbCA9IHBhcmFtc1tpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgaWYgKHZhbFswXSA9PSBwYXJhbU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5lc2NhcGUodmFsWzFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvLyBjaGVjayBmb3IgZGV2aWNlIHRvdWNoIHN1cHBvcnQKICAgICAgICBpc1RvdWNoRGV2aWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFdmVudCgiVG91Y2hFdmVudCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGdldFVuaXF1ZUlEOiBmdW5jdGlvbihwcmVmaXgpIHsKICAgICAgICAgICAgcmV0dXJuICdwcmVmaXhfJyArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkpOwogICAgICAgIH0sCgogICAgICAgIGFsZXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CgogICAgICAgICAgICBvcHRpb25zID0gJC5leHRlbmQodHJ1ZSwgewogICAgICAgICAgICAgICAgY29udGFpbmVyOiAiIiwgLy8gYWxlcnRzIHBhcmVudCBjb250YWluZXIoYnkgZGVmYXVsdCBwbGFjZWQgYWZ0ZXIgdGhlIHBhZ2UgYnJlYWRjcnVtYnMpCiAgICAgICAgICAgICAgICBwbGFjZTogImFwcGVuZCIsIC8vIGFwcGVuZCBvciBwcmVwZW50IGluIGNvbnRhaW5lciAKICAgICAgICAgICAgICAgIHR5cGU6ICdzdWNjZXNzJywgIC8vIGFsZXJ0J3MgdHlwZQogICAgICAgICAgICAgICAgbWVzc2FnZTogIiIsICAvLyBhbGVydCdzIG1lc3NhZ2UKICAgICAgICAgICAgICAgIGNsb3NlOiB0cnVlLCAvLyBtYWtlIGFsZXJ0IGNsb3NhYmxlCiAgICAgICAgICAgICAgICByZXNldDogdHJ1ZSwgLy8gY2xvc2UgYWxsIHByZXZpb3VzZSBhbGVydHMgZmlyc3QKICAgICAgICAgICAgICAgIGZvY3VzOiB0cnVlLCAvLyBhdXRvIHNjcm9sbCB0byB0aGUgYWxlcnQgYWZ0ZXIgc2hvd24KICAgICAgICAgICAgICAgIGNsb3NlSW5TZWNvbmRzOiAwLCAvLyBhdXRvIGNsb3NlIGFmdGVyIGRlZmluZWQgc2Vjb25kcwogICAgICAgICAgICAgICAgaWNvbjogIiIgLy8gcHV0IGljb24gYmVmb3JlIHRoZSBtZXNzYWdlCiAgICAgICAgICAgIH0sIG9wdGlvbnMpOwoKICAgICAgICAgICAgdmFyIGlkID0gQXBwLmdldFVuaXF1ZUlEKCJhcHBfYWxlcnQiKTsKCiAgICAgICAgICAgIHZhciBodG1sID0gJzxkaXYgaWQ9IicraWQrJyIgY2xhc3M9ImFwcC1hbGVydHMgYWxlcnQgYWxlcnQtJytvcHRpb25zLnR5cGUrJyBmYWRlIGluIj4nICsgKG9wdGlvbnMuY2xvc2UgPyAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJjbG9zZSIgZGF0YS1kaXNtaXNzPSJhbGVydCIgYXJpYS1oaWRkZW49InRydWUiPjwvYnV0dG9uPicgOiAnJyApICsgKG9wdGlvbnMuaWNvbiAhPSAiIiA/ICc8aSBjbGFzcz0iZmEtbGcgZmEgZmEtJytvcHRpb25zLmljb24gKyAnIj48L2k+ICAnIDogJycpICsgb3B0aW9ucy5tZXNzYWdlKyc8L2Rpdj4nCgogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXNldCkgezAKICAgICAgICAgICAgICAgICQoJy5hcHAtYWxlcnRzJykucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgICQoJy5wYWdlLWJyZWFkY3J1bWInKS5hZnRlcihodG1sKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnBsYWNlID09ICJhcHBlbmQiKSB7CiAgICAgICAgICAgICAgICAgICAgJChvcHRpb25zLmNvbnRhaW5lcikuYXBwZW5kKGh0bWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKG9wdGlvbnMuY29udGFpbmVyKS5wcmVwZW5kKGh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5mb2N1cykgewogICAgICAgICAgICAgICAgQXBwLnNjcm9sbFRvKCQoJyMnICsgaWQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2xvc2VJblNlY29uZHMgPiAwKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBpZCkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLmNsb3NlSW5TZWNvbmRzICogMTAwMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBjaGVjayBJRTggbW9kZQogICAgICAgIGlzSUU4OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBpc0lFODsKICAgICAgICB9LAoKICAgICAgICAvLyBjaGVjayBJRTkgbW9kZQogICAgICAgIGlzSUU5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBpc0lFOTsKICAgICAgICB9LAoKICAgICAgICAvL2NoZWNrIFJUTCBtb2RlCiAgICAgICAgaXNSVEw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzUlRMOwogICAgICAgIH0sCgogICAgICAgIC8vIGdldCBsYXlvdXQgY29sb3IgY29kZSBieSBjb2xvciBuYW1lCiAgICAgICAgZ2V0TGF5b3V0Q29sb3JDb2RlOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICBpZiAobGF5b3V0Q29sb3JDb2Rlc1tuYW1lXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxheW91dENvbG9yQ29kZXNbbmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfTsKCn0oKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:30:16 GMT",
                    "Content-Length": "49361",
                    "Date": "Sat, 08 Nov 2014 04:30:17 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}