{
    "url": "http://localhost:9999/rpflorence/snack/builds/snack-qwery.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname</li><li>url = url.substr(0, trimPosition)</li><li>xhr.open(method.toUpperCase(), url, open.async, options.user, options.password)</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/rpflorence/snack/builds/snack-qwery.js",
                "path": "/rpflorence/snack/builds/snack-qwery.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ycGZsb3JlbmNlL3NuYWNrL2J1aWxkcy9zbmFjay1xd2VyeS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjUzNjgNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6NTY6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjU2OjM5IEdNVA0KDQovKiEKICAqIHNuYWNrLmpzIChjKSBSeWFuIEZsb3JlbmNlCiAgKiBodHRwczovL2dpdGh1Yi5jb20vcnBmbG9yZW5jZS9zbmFjawogICogTUlUIExpY2Vuc2UKICAqIEluc3BpcmF0aW9uIGFuZCBjb2RlIGFkYXB0ZWQgZnJvbQogICogIE1vb1Rvb2xzICAgICAgKGMpIFZhbGVyaW8gUHJvaWV0dGkgICBNSVQgbGljZW5zZQogICogIGpRdWVyeSAgICAgICAgKGMpIEpvaG4gUmVzaWcgICAgICAgICBEdWFsIGxpY2Vuc2UgTUlUIG9yIEdQTCBWZXJzaW9uIDIKICAqICBjb250ZW50TG9hZGVkIChjKSBEaWVnbyBQZXJpbmkgICAgICAgTUlUIExpY2Vuc2UKICAqICBaZXB0by5qcyAgICAgIChjKSBUaG9tYXMgRnVjaHMgICAgICAgTUlUIExpY2Vuc2UKKi8KCmlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSAhPSAnZnVuY3Rpb24nKXsKICAvLyBFUzUgT2JlamVjdC5jcmVhdGUKICBPYmplY3QuY3JlYXRlID0gZnVuY3Rpb24gKG8pewogICAgZnVuY3Rpb24gRigpIHt9CiAgICBGLnByb3RvdHlwZSA9IG8KICAgIHJldHVybiBuZXcgRgogIH0KfQoKIWZ1bmN0aW9uKHdpbmRvdyl7CiAgdmFyIHNuYWNrID0gd2luZG93LnNuYWNrID0ge30KICAgICwgZ3VpZCA9IDAKICAgICwgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nCiAgICAsIGluZGV4T2YgPSBbXS5pbmRleE9mCiAgICAsIHB1c2ggPSBbXS5wdXNoCgogIHNuYWNrLmV4dGVuZCA9IGZ1bmN0aW9uICgpewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkKICAgICAgcmV0dXJuIHNuYWNrLmV4dGVuZChzbmFjaywgYXJndW1lbnRzWzBdKQoKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHNbMF0KCiAgICBmb3IgKHZhciBrZXksIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgZm9yIChrZXkgaW4gYXJndW1lbnRzW2ldKQogICAgICAgIHRhcmdldFtrZXldID0gYXJndW1lbnRzW2ldW2tleV0KCiAgICByZXR1cm4gdGFyZ2V0CiAgfQoKICBzbmFjay5leHRlbmQoewogICAgdjogJzEuMi4zJywKCiAgICBiaW5kOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKXsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgcHVuY2g6IGZ1bmN0aW9uIChvYmosIG1ldGhvZCwgZm4sIGF1dG8pewogICAgICB2YXIgb2xkID0gb2JqW21ldGhvZF0KICAgICAgb2JqW21ldGhvZF0gPSBhdXRvID8gZnVuY3Rpb24gKCl7CiAgICAgICAgb2xkLmFwcGx5KG9iaiwgYXJndW1lbnRzKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgfSA6IGZ1bmN0aW9uICgpewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApCiAgICAgICAgYXJncy51bnNoaWZ0KHNuYWNrLmJpbmQob2xkLCBvYmopKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgY3JlYXRlOiBmdW5jdGlvbiAocHJvdG8sIGV4dCl7CiAgICAgIHZhciBvYmogPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICBpZiAoIWV4dCkKICAgICAgICByZXR1cm4gb2JqCgogICAgICBmb3IgKHZhciBpIGluIGV4dCkgewogICAgICAgIGlmICghZXh0Lmhhc093blByb3BlcnR5KGkpKQogICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgKCFwcm90b1tpXSB8fCB0eXBlb2YgZXh0W2ldICE9ICdmdW5jdGlvbicpewogICAgICAgICAgb2JqW2ldID0gZXh0W2ldCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgc25hY2sucHVuY2gob2JqLCBpLCBleHRbaV0pCiAgICAgIH0KCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgaWQ6IGZ1bmN0aW9uICgpewogICAgICByZXR1cm4gKytndWlkCiAgICB9LAoKICAgIGVhY2g6IGZ1bmN0aW9uIChvYmosIGZuLCBjb250ZXh0KXsKICAgICAgaWYgKG9iai5sZW5ndGggPT09IHZvaWQrMCl7IC8vIGxvb3NlIGNoZWNrIGZvciBvYmplY3QsIHdlIHdhbnQgYXJyYXktbGlrZSBvYmplY3RzIHRvIGJlIHRyZWF0ZWQgYXMgYXJyYXlzCiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikKICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgZm4uY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIHJldHVybiBvYmoKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKQogICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgcGFyc2VKU09OOiBmdW5jdGlvbihqc29uKSB7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBqUXVlcnkKICAgICAgaWYgKHR5cGVvZiBqc29uICE9ICdzdHJpbmcnKQogICAgICAgIHJldHVybgoKICAgICAganNvbiA9IGpzb24ucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQoKICAgICAgdmFyIGlzVmFsaWQgPSAvXltcXSw6e31cc10qJC8udGVzdChqc29uLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgIkAiKQogICAgICAgIC5yZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgIl0iKQogICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICIiKSkKCiAgICAgIGlmICghaXNWYWxpZCkKICAgICAgICB0aHJvdyAiSW52YWxpZCBKU09OIgogICAgICAKICAgICAgdmFyIEpTT04gPSB3aW5kb3cuSlNPTiAvLyBzYXZlcyBhIGNvdXBsZSBieXRlcwogICAgICByZXR1cm4gSlNPTiAmJiBKU09OLnBhcnNlID8gSlNPTi5wYXJzZShqc29uKSA6IChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvbikpKCkKICAgIH0sCgogICAgaXNBcnJheTogZnVuY3Rpb24gKG9iail7CiAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gIltvYmplY3QgQXJyYXldIgogICAgfSwKCiAgICBpbmRleE9mOiBpbmRleE9mID8gZnVuY3Rpb24oaXRlbSwgYXJyYXkpewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoYXJyYXksIGl0ZW0pCiAgICAgIH0gOiBmdW5jdGlvbiAoaXRlbSwgYXJyYXkpewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICByZXR1cm4gaQoKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgfSkKfSh3aW5kb3cpOwohZnVuY3Rpb24gKHNuYWNrLCBkb2N1bWVudCl7CiAgdmFyIHByb3RvID0ge30KICAgICwgcXVlcnkKCiAgc25hY2sud3JhcCA9IGZ1bmN0aW9uIChub2RlcywgY29udGV4dCl7CiAgICAvLyBwYXNzZWQgaW4gYSBDU1Mgc2VsZWN0b3IKICAgIGlmICh0eXBlb2Ygbm9kZXMgPT0gJ3N0cmluZycpCiAgICAgIG5vZGVzID0gcXVlcnkobm9kZXMsIGNvbnRleHQpCgogICAgLy8gcGFzc2VkIGluIHNpbmdsZSBub2RlCiAgICBpZiAoIW5vZGVzLmxlbmd0aCkKICAgICAgbm9kZXMgPSBbbm9kZXNdCgogICAgdmFyIHdyYXBwZXIgPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICAsIGkgPSAwCiAgICAgICwgbCA9IG5vZGVzLmxlbmd0aAoKICAgIGZvciAoOyBpIDwgbDsgaSsrKQogICAgICB3cmFwcGVyW2ldID0gbm9kZXNbaV0KCiAgICB3cmFwcGVyLmxlbmd0aCA9IGwKICAgIHdyYXBwZXIuaWQgPSBzbmFjay5pZCgpCiAgICByZXR1cm4gd3JhcHBlcgogIH0KCiAgc25hY2suZXh0ZW5kKHNuYWNrLndyYXAsIHsKICAgIGRlZmluZTogZnVuY3Rpb24obmFtZSwgZm4pewogICAgICBpZiAodHlwZW9mIG5hbWUgIT0gJ3N0cmluZycpewogICAgICAgIGZvciAodmFyIGkgaW4gbmFtZSkKICAgICAgICAgIHNuYWNrLndyYXAuZGVmaW5lKGksIG5hbWVbaV0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgcHJvdG9bbmFtZV0gPSBmbgogICAgfSwKCiAgICBkZWZpbmVFbmdpbmU6IGZ1bmN0aW9uIChmbil7CiAgICAgIHF1ZXJ5ID0gZm4KICAgIH0KICB9KQoKICAvLyBRU0EgZGVmYXVsdCBzZWxlY3RvciBlbmdpbmUsIHN1cHBvcnRzIHJlYWwgYnJvd3NlcnMgYW5kIElFOCsKICBzbmFjay53cmFwLmRlZmluZUVuZ2luZShmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpewogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09ICdzdHJpbmcnKQogICAgICBjb250ZXh0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihjb250ZXh0KQoKICAgIHJldHVybiAoY29udGV4dCB8fCBkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikKICB9KQp9KHNuYWNrLCBkb2N1bWVudCkKIWZ1bmN0aW9uIChzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgdmFyIGFkZCAgICAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdhZGRFdmVudExpc3RlbmVyJyA6ICdhdHRhY2hFdmVudCcKICAgICwgcmVtb3ZlICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJ3JlbW92ZUV2ZW50TGlzdGVuZXInIDogJ2RldGFjaEV2ZW50JwogICAgLCBwcmVmaXggICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnJyA6ICdvbicKICAgICwgcmVhZHkgICAgICAgICAgPSBmYWxzZQogICAgLCB0b3AgICAgICAgICAgICA9IHRydWUKICAgICwgcm9vdCAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQKICAgICwgcmVhZHlIYW5kbGVycyAgPSBbXQoKICBzbmFjay5leHRlbmQoewogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpCiAgICAgIGVsc2UKICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlCiAgICB9LAoKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZQogICAgfQogIH0pCgogIHNuYWNrLmxpc3RlbmVyID0gZnVuY3Rpb24gKHBhcmFtcywgaGFuZGxlcil7CiAgICBpZiAocGFyYW1zLmRlbGVnYXRlKXsKICAgICAgcGFyYW1zLmNhcHR1cmUgPSB0cnVlCiAgICAgIF9oYW5kbGVyID0gaGFuZGxlcgogICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQKICAgICAgICAgICwgbm9kZXMgPSB0eXBlb2YgcGFyYW1zLmRlbGVnYXRlID09ICdzdHJpbmcnCiAgICAgICAgICAgID8gc25hY2sud3JhcChwYXJhbXMuZGVsZWdhdGUsIHBhcmFtcy5ub2RlKQogICAgICAgICAgICA6IHBhcmFtcy5kZWxlZ2F0ZShwYXJhbXMubm9kZSkKCiAgICAgICAgd2hpbGUgKHRhcmdldCAmJiBzbmFjay5pbmRleE9mKHRhcmdldCwgbm9kZXMpID09IC0xICkKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlCgogICAgICAgIGlmICh0YXJnZXQgJiYgISh0YXJnZXQgPT09IHRoaXMpICYmICEodGFyZ2V0ID09PSBkb2N1bWVudCkpCiAgICAgICAgICBfaGFuZGxlci5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCkKICAgICAgfQogICAgfQoKICAgIGlmIChwYXJhbXMuY29udGV4dCkKICAgICAgaGFuZGxlciA9IHNuYWNrLmJpbmQoaGFuZGxlciwgcGFyYW1zLmNvbnRleHQpCgogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbYWRkXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbcmVtb3ZlXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGZpcmU6IGZ1bmN0aW9uICgpewogICAgICAgIGhhbmRsZXIuYXBwbHkocGFyYW1zLm5vZGUsIGFyZ3VtZW50cykKICAgICAgfQogICAgfQoKICAgIG1ldGhvZHMuYXR0YWNoKCkKCiAgICByZXR1cm4gbWV0aG9kcwogIH0KCgoKCiAgc25hY2sucmVhZHkgPSBmdW5jdGlvbiAoaGFuZGxlcil7CiAgICBpZiAocmVhZHkpewogICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICByZXR1cm4KICAgIH0KICAgIHJlYWR5SGFuZGxlcnMucHVzaChoYW5kbGVyKQogIH0KCiAgLy8gYWRhcHRlZCBmcm9tIGNvbnRlbnRsb2FkZWQKICBmdW5jdGlvbiBpbml0KGUpIHsKICAgIGlmIChlLnR5cGUgPT0gJ3JlYWR5c3RhdGVjaGFuZ2UnICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgIT0gJ2NvbXBsZXRlJykKICAgICAgcmV0dXJuCgogICAgKGUudHlwZSA9PSAnbG9hZCcgPyB3aW5kb3cgOiBkb2N1bWVudClbcmVtb3ZlXShwcmVmaXggKyBlLnR5cGUsIGluaXQsIGZhbHNlKQoKICAgIGlmICghcmVhZHkgJiYgKHJlYWR5ID0gdHJ1ZSkpCiAgICAgIHNuYWNrLmVhY2gocmVhZHlIYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIpewogICAgICAgIGhhbmRsZXIuYXBwbHkoZG9jdW1lbnQpCiAgICAgIH0pCiAgfQoKICBmdW5jdGlvbiBwb2xsKCkgewogICAgdHJ5IHsKICAgICAgcm9vdC5kb1Njcm9sbCgnbGVmdCcpCiAgICB9IGNhdGNoKGUpIHsgCiAgICAgIHNldFRpbWVvdXQocG9sbCwgNTApCiAgICAgIHJldHVybgogICAgfQogICAgaW5pdCgncG9sbCcpCiAgfQoKICBpZiAoZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QgJiYgcm9vdC5kb1Njcm9sbCkgewogICAgdHJ5IHsKICAgICAgdG9wID0gIXdpbmRvdy5mcmFtZUVsZW1lbnQKICAgIH0gY2F0Y2goZSkge30KICAgIGlmICh0b3ApCiAgICAgIHBvbGwoKTsKICB9CgogIGRvY3VtZW50W2FkZF0ocHJlZml4ICsgJ0RPTUNvbnRlbnRMb2FkZWQnLCBpbml0LCBmYWxzZSkKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdyZWFkeXN0YXRlY2hhbmdlJywgaW5pdCwgZmFsc2UpCiAgd2luZG93W2FkZF0ocHJlZml4ICsgJ2xvYWQnLCBpbml0LCBmYWxzZSkKfShzbmFjaywgd2luZG93LCBkb2N1bWVudCk7CiFmdW5jdGlvbiAoc25hY2spewogIHNuYWNrLnB1Ymxpc2hlciA9IGZ1bmN0aW9uIChvYmopewogICAgdmFyIGNoYW5uZWxzID0ge30KICAgIG9iaiA9IG9iaiB8fCB7fQoKICAgIHNuYWNrLmV4dGVuZChvYmosIHsKICAgICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2hhbm5lbCwgaGFuZGxlciwgY29udGV4dCl7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IHsKICAgICAgICAgIGZuOiBoYW5kbGVyLAogICAgICAgICAgY3R4dDogKGNvbnRleHQgfHwge30pCiAgICAgICAgfQoKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0gPSBbXQoKICAgICAgICB2YXIgcHVibGlrID0gewogICAgICAgICAgYXR0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0ucHVzaChzdWJzY3JpcHRpb24pCiAgICAgICAgICB9LAogICAgICAgICAgZGV0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0uc3BsaWNlKHNuYWNrLmluZGV4T2YoaGFuZGxlciwgY2hhbm5lbHNbY2hhbm5lbF0pLCAxKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdWJsaWsuYXR0YWNoKCkKICAgICAgICByZXR1cm4gcHVibGlrCiAgICAgIH0sCgogICAgICBwdWJsaXNoOiBmdW5jdGlvbiAoY2hhbm5lbCwgYXJnc0FycmF5KXsKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgcmV0dXJuIGZhbHNlCgogICAgICAgIHNuYWNrLmVhY2goY2hhbm5lbHNbY2hhbm5lbF0sIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pewogICAgICAgICAgc3Vic2NyaXB0aW9uLmZuLmFwcGx5KHN1YnNjcmlwdGlvbi5jdHh0LCBhcmdzQXJyYXkgfHwgW10pCiAgICAgICAgfSkKCiAgICAgICAgcmV0dXJuIGNoYW5uZWxzW2NoYW5uZWxdLmxlbmd0aAogICAgICB9CiAgICB9KQoKICAgIHJldHVybiBvYmoKICB9CgogIHNuYWNrLnB1Ymxpc2hlcihzbmFjaykKfShzbmFjayk7CiFmdW5jdGlvbihzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgc25hY2suSlNPTlAgPSBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBaZXB0bwogICAgdmFyIGpzb25wU3RyaW5nID0gJ2pzb25wJyArIHNuYWNrLmlkKCkKICAgICAgLCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKQogICAgICAsIHJ1bm5pbmcgPSBmYWxzZQoKICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgZGVsZXRlIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXQogICAgICAgIGNhbGxiYWNrKGRhdGEpCiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmRhdGEgPT0gJ29iamVjdCcpCiAgICAgICAgcGFyYW1zLmRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHBhcmFtcy5kYXRhKQoKICAgIHZhciBwdWJsaWsgPSB7CiAgICAgIHNlbmQ6IGZ1bmN0aW9uICgpewogICAgICAgIHJ1bm5pbmcgPSB0cnVlCiAgICAgICAgc2NyaXB0LnNyYyA9IHBhcmFtcy51cmwgKyAnPycgKyBwYXJhbXMua2V5ICsgJz1zbmFjay5KU09OUC4nICsganNvbnBTdHJpbmcgKyAnJicgKyBwYXJhbXMuZGF0YQogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KQogICAgICB9LAoKICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nICYmIHNjcmlwdC5wYXJlbnROb2RlICYmIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCkKICAgICAgICBydW5uaW5nID0gZmFsc2UKICAgICAgICBzbmFjay5KU09OUFtqc29ucFN0cmluZ10gPSBmdW5jdGlvbiAoKXsKICAgICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLm5vdyAhPT0gZmFsc2UpCiAgICAgIHB1Ymxpay5zZW5kKCkKCiAgICByZXR1cm4gcHVibGlrCiAgfQoKICBzbmFjay50b1F1ZXJ5U3RyaW5nID0gZnVuY3Rpb24ob2JqZWN0LCBiYXNlKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgdmFyIHF1ZXJ5U3RyaW5nID0gW10KCiAgICBzbmFjay5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgIGlmIChiYXNlKQogICAgICAgIGtleSA9IGJhc2UgKyAnWycgKyBrZXkgKyAnXScKCiAgICAgIHZhciByZXN1bHQKCiAgICAgIGlmIChzbmFjay5pc0FycmF5KHZhbHVlKSl7CiAgICAgICAgdmFyIHFzID0ge30KICAgICAgICBzbmFjay5lYWNoKHZhbHVlLCBmdW5jdGlvbih2YWwsIGkpewogICAgICAgICAgcXNbaV0gPSB2YWwKICAgICAgICB9KQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcocXMsIGtleSkKICAgICAgfQogICAgICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpCiAgICAgICAgcmVzdWx0ID0gc25hY2sudG9RdWVyeVN0cmluZyh2YWx1ZSwga2V5KQogICAgICBlbHNlCiAgICAgICAgcmVzdWx0ID0ga2V5ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKQoKICAgICAgaWYgKHZhbHVlICE9PSBudWxsKQogICAgICAgIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KQogICAgfSkKCiAgICByZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpCiAgfQoKICB2YXIgeGhyT2JqZWN0ID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfQoKICAgIHZhciBNU1hNTDIgPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7CiAgICB9CgogICAgdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwogICAgfQoKICAgIHRyeSB7CiAgICAgIFhNTEhUVFAoKQogICAgICByZXR1cm4gWE1MSFRUUAogICAgfSBjYXRjaCAoZSl7CiAgICAgIHRyeSB7CiAgICAgICAgTVNYTUwyKCkKICAgICAgICByZXR1cm4gTVNYTUwyCiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgIE1TWE1MKCkKICAgICAgICByZXR1cm4gTVNYTUwKICAgICAgfQogICAgfQogIH0pKCk7CgogIGZ1bmN0aW9uIGVtcHR5KCl7fQoKICBzbmFjay5yZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdGlvbnMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIHNuYWNrLnJlcXVlc3QpKQogICAgICByZXR1cm4gbmV3IHNuYWNrLnJlcXVlc3Qob3B0aW9ucywgY2FsbGJhY2spCgogICAgdmFyIHNlbGYgPSB0aGlzCiAgICBzZWxmLm9wdGlvbnMgPSBzbmFjay5leHRlbmQoe30sIHNlbGYub3B0aW9ucywgb3B0aW9ucykKICAgIHNlbGYuY2FsbGJhY2sgPSBjYWxsYmFjawogICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0CiAgICBzZWxmLmhlYWRlcnMgPSBzZWxmLm9wdGlvbnMuaGVhZGVycwogICAgaWYgKHNlbGYub3B0aW9ucy5ub3cgIT09IGZhbHNlKQogICAgICBzZWxmLnNlbmQoKQogIH0KCiAgc25hY2sucmVxdWVzdC5wcm90b3R5cGUgPSB7CgogICAgb3B0aW9uczogey8qCiAgICAgIHVzZXI6ICcnLAogICAgICBwYXNzd29yZDogJycsKi8KICAgICAgZXhjZXB0aW9uOiBlbXB0eSwKICAgICAgdXJsOiAnJywKICAgICAgZGF0YTogJycsCiAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgIG5vdzogdHJ1ZSwKICAgICAgaGVhZGVyczogewogICAgICAgICdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKICAgICAgICAnQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCiAgICAgIH0sCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBlbXVsYXRpb246IHRydWUsCiAgICAgIHVybEVuY29kZWQ6IHRydWUsCiAgICAgIGVuY29kaW5nOiAndXRmLTgnCiAgICB9LAoKICAgIG9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwogICAgICAgICwgeGhyID0gc2VsZi54aHIKCiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICFzZWxmLnJ1bm5pbmcpIHJldHVybgogICAgICBzZWxmLnJ1bm5pbmcgPSBmYWxzZQogICAgICBzZWxmLnN0YXR1cyA9IDAKCiAgICAgIHRyeXsKICAgICAgICB2YXIgc3RhdHVzID0geGhyLnN0YXR1cwogICAgICAgIHNlbGYuc3RhdHVzID0gKHN0YXR1cyA9PSAxMjIzKSA/IDIwNCA6IHN0YXR1cwogICAgICB9IGNhdGNoKGUpIHt9CgogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgogICAgICB2YXIgYXJncyA9IHNlbGYuc3RhdHVzID49IDIwMCAmJiBzZWxmLnN0YXR1cyA8IDMwMAogICAgICAgID8gW2ZhbHNlLCBzZWxmLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHNlbGYueGhyLnJlc3BvbnNlWE1MXQogICAgICAgIDogW3NlbGYuc3RhdHVzXQoKICAgICAgc2VsZi5jYWxsYmFjay5hcHBseShzZWxmLCBhcmdzKQogICAgfSwKICAKICAgIHNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpCiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KICAgIH0sCiAgCiAgICBzZW5kOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIG9wdGlvbnMgPSBzZWxmLm9wdGlvbnMKCiAgICAgIGlmIChzZWxmLnJ1bm5pbmcpIHJldHVybiBzZWxmOwoKICAgICAgc2VsZi5ydW5uaW5nID0gdHJ1ZTsKCiAgICAgIHZhciBkYXRhID0gb3B0aW9ucy5kYXRhIHx8ICcnCiAgICAgICAgLCB1cmwgPSBTdHJpbmcob3B0aW9ucy51cmwpCiAgICAgICAgLCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b0xvd2VyQ2FzZSgpCgogICAgICBpZiAodHlwZW9mIGRhdGEgIT0gJ3N0cmluZycpCiAgICAgICAgZGF0YSA9IHNuYWNrLnRvUXVlcnlTdHJpbmcoZGF0YSkKCiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGlvbiAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydnZXQnLCAncG9zdCddKSA8IDApewogICAgICAgIHZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZAogICAgICAgIGRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2QKICAgICAgICBtZXRob2QgPSAncG9zdCcKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMudXJsRW5jb2RlZCAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydwb3N0JywgJ3B1dCddKSA+IC0xKXsKICAgICAgICB2YXIgZW5jb2RpbmcgPSAob3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyBvcHRpb25zLmVuY29kaW5nIDogJycKICAgICAgICBzZWxmLmhlYWRlcnNbJ0NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgKyBlbmNvZGluZwogICAgICB9CgogICAgICBpZiAoIXVybCkKICAgICAgICB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZQoKICAgICAgdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpCiAgICAgIGlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkKICAgICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbikKCiAgICAgIGlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CiAgICAgICAgdXJsICs9ICh1cmwuaW5kZXhPZignPycpID4gLTEgPyAnJicgOiAnPycpICsgZGF0YQogICAgICAgIGRhdGEgPSBudWxsCiAgICAgIH0KCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgoKICAgICAgeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgb3Blbi5hc3luYywgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQogICAgICBpZiAob3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWUKICAgIAogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gc25hY2suYmluZChzZWxmLm9uU3RhdGVDaGFuZ2UsIHNlbGYpCgogICAgICBmb3IgKHZhciBpIGluIHNlbGYuaGVhZGVycyl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIHNlbGYuaGVhZGVyc1tpXSkKICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIG9wdGlvbnMuZXhjZXB0aW9uLmFwcGx5KHNlbGYsIFtpLCBzZWxmLmhlYWRlcnNbaV1dKQogICAgICAgIH0KICAgICAgfQoKICAgICAgeGhyLnNlbmQoZGF0YSkKICAgICAgaWYgKCFvcHRpb25zLmFzeW5jKSBzZWxmLm9uU3RhdGVDaGFuZ2UoKQogICAgCiAgICAgIHJldHVybiBzZWxmCiAgICB9LAoKICAgIGNhbmNlbDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCgogICAgICBpZiAoIXNlbGYucnVubmluZykKICAgICAgICByZXR1cm4gc2VsZgoKICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgogICAgICB4aHIuYWJvcnQoKQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5CgogICAgICBzZWxmLnhociA9IG5ldyB4aHJPYmplY3QoKQogICAgICByZXR1cm4gc2VsZgogICAgfQogIH0KfShzbmFjaywgd2luZG93LCBkb2N1bWVudCkKIWZ1bmN0aW9uKHNuYWNrLCBkb2N1bWVudCl7CiAgc25hY2sud3JhcC5kZWZpbmUoewogICAgZGF0YTogZnVuY3Rpb24gKCl7CiAgICAgIC8vIEFQSSBpbnNwaXJlZCBieSBqUXVlcnkKICAgICAgdmFyIHN0b3JhZ2UgPSB7fQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChrZXksIHZhbHVlKXsKICAgICAgICB2YXIgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0KCiAgICAgICAgaWYgKCFkYXRhKQogICAgICAgICAgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0gPSB7fQoKICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQrMSkKICAgICAgICAgIHJldHVybiBkYXRhW2tleV0KCiAgICAgICAgcmV0dXJuIGRhdGFba2V5XSA9IHZhbHVlCiAgICAgIH0gIAogICAgfSgpLAoKICAgIGVhY2g6IGZ1bmN0aW9uIChmbiwgY29udGV4dCl7CiAgICAgIHJldHVybiBzbmFjay5lYWNoKHRoaXMsIGZuLCBjb250ZXh0KQogICAgfSwKICAKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NOYW1lKXsKICAgICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGVsZW1lbnQpewogICAgICAgIGlmIChjbGVhbihlbGVtZW50LmNsYXNzTmFtZSkuaW5kZXhPZihjbGFzc05hbWUpID4gLTEpCiAgICAgICAgICByZXR1cm4KICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsZWFuKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgY2xhc3NOYW1lKQogICAgICB9KQogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgnKF58XFxzKScgKyBjbGFzc05hbWUgKyAnKD86XFxzfCQpJyksICckMScpCiAgICAgIH0pCiAgICB9LAoKICAgIGF0dGFjaDogZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVyLCAvKiBpbnRlcm5hbCAqLyBkZWxlZ2F0aW9uKXsKICAgICAgdmFyIHNwbGl0ID0gZXZlbnQuc3BsaXQoJy4nKQogICAgICAgICwgbGlzdGVuZXJzID0gW10KCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmRhdGEoc3BsaXRbMV0pIHx8IFtdCgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdmFyIHBhcmFtcyA9IHsKICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICBldmVudDogc3BsaXRbMF0KICAgICAgICB9CgogICAgICAgIGlmIChkZWxlZ2F0aW9uKQogICAgICAgICAgcGFyYW1zLmRlbGVnYXRlID0gZGVsZWdhdGlvbgoKICAgICAgICBsaXN0ZW5lcnMucHVzaChzbmFjay5saXN0ZW5lcihwYXJhbXMsIGhhbmRsZXIpKQogICAgICB9KQoKICAgICAgaWYgKHNwbGl0WzFdKQogICAgICAgIHRoaXMuZGF0YShzcGxpdFsxXSwgbGlzdGVuZXJzKQoKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZGV0YWNoOiBmdW5jdGlvbiAobmFtZXNwYWNlKXsKICAgICAgbGlzdGVuZXJNZXRob2QodGhpcywgJ2RldGFjaCcsIG5hbWVzcGFjZSwgbnVsbCwgdHJ1ZSkKICAgICAgdGhpcy5kYXRhKG5hbWVzcGFjZSwgbnVsbCkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZmlyZTogZnVuY3Rpb24gKG5hbWVzcGFjZSwgYXJncyl7CiAgICAgIHJldHVybiBsaXN0ZW5lck1ldGhvZCh0aGlzLCAnZmlyZScsIG5hbWVzcGFjZSwgYXJncykKICAgIH0sCgogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChldmVudCwgZGVsZWdhdGlvbiwgaGFuZGxlcil7CiAgICAgIHJldHVybiB0aGlzLmF0dGFjaChldmVudCwgaGFuZGxlciwgZGVsZWdhdGlvbikKICAgIH0KICB9KQoKICBmdW5jdGlvbiBjbGVhbihzdHIpewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgfQoKICBmdW5jdGlvbiBsaXN0ZW5lck1ldGhvZCh3cmFwcGVyLCBtZXRob2QsIG5hbWVzcGFjZSwgYXJncyl7CiAgICB2YXIgZGF0YSA9IHdyYXBwZXIuZGF0YShuYW1lc3BhY2UpCgogICAgaWYgKGRhdGEpCiAgICAgIHNuYWNrLmVhY2goZGF0YSwgZnVuY3Rpb24gKGxpc3RlbmVyKXsKICAgICAgICBsaXN0ZW5lclttZXRob2RdLmFwcGx5KHdyYXBwZXIsIGFyZ3MpCiAgICAgIH0pCgogICAgcmV0dXJuIHdyYXBwZXIKICB9Cn0oc25hY2ssIGRvY3VtZW50KTsKLyohCiAgKiBRd2VyeSAtIEEgQmxhemluZyBGYXN0IHF1ZXJ5IHNlbGVjdG9yIGVuZ2luZQogICogaHR0cHM6Ly9naXRodWIuY29tL2RlZC9xd2VyeQogICogY29weXJpZ2h0IER1c3RpbiBEaWF6ICYgSmFjb2IgVGhvcm50b24gMjAxMQogICogTUlUIExpY2Vuc2UKICAqLwoKIWZ1bmN0aW9uIChjb250ZXh0LCBkb2MpIHsKCiAgdmFyIGMsIGksIGosIGssIGwsIG0sIG8sIHAsIHIsIHYsCiAgICAgIGVsLCBub2RlLCBsZW4sIGZvdW5kLCBjbGFzc2VzLCBpdGVtLCBpdGVtcywgdG9rZW4sCiAgICAgIGlkID0gLyMoW1x3XC1dKykvLAogICAgICBjbGFzID0gL1wuW1x3XC1dKy9nLAogICAgICBpZE9ubHkgPSAvXiMoW1x3XC1dKyQpLywKICAgICAgY2xhc3NPbmx5ID0gL15cLihbXHdcLV0rKSQvLAogICAgICB0YWdPbmx5ID0gL14oW1x3XC1dKykkLywKICAgICAgdGFnQW5kT3JDbGFzcyA9IC9eKFtcd10rKT9cLihbXHdcLV0rKSQvLAogICAgICBodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudCwKICAgICAgbm9ybWFsaXpyID0gL1xzKihbXHNcK1x+Pl0pXHMqL2csCiAgICAgIHRva2VuaXpyID0gLyhbXHNcPlwrXH5dKSg/IVtcc1x3XC1cL1w/XCZcPVw6XC5cKFwpXCEsQCMlPD5ce1x9XCRcKlxeJyJdKlxdKS8sCiAgICAgIHNwZWNpYWxDaGFycyA9IC8oWy4qKz9cXj0hOiR7fSgpfFxbXF1cL1xcXSkvZywKICAgICAgc2ltcGxlID0gL14oW2EtejAtOV0rKT8oPzooW1wuXCNdK1tcd1wtXC4jXSspPykvLAogICAgICBhdHRyID0gL1xbKFtcd1wtXSspKD86KFtcfFxeXCRcKlx+XT9cPSlbJyJdPyhbIFx3XC1cL1w/XCZcPVw6XC5cKFwpXCEsQCMlPD5ce1x9XCRcKlxeXSspWyInXT8pP1xdLywKICAgICAgY2h1bmtlciA9IG5ldyBSZWdFeHAoc2ltcGxlLnNvdXJjZSArICcoJyArIGF0dHIuc291cmNlICsgJyk/JyksCiAgICAgIHdhbGtlciA9IHsKICAgICcgJzogZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZSAhPT0gaHRtbCAmJiBub2RlLnBhcmVudE5vZGUKICAgIH0sCiAgICAnPic6IGZ1bmN0aW9uIChub2RlLCBjb250ZXN0YW50KSB7CiAgICAgIHJldHVybiBub2RlICYmIG5vZGUucGFyZW50Tm9kZSA9PSBjb250ZXN0YW50LnBhcmVudE5vZGUgJiYgbm9kZS5wYXJlbnROb2RlOwogICAgfSwKICAgICd+JzogZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICB9LAogICAgJysnOiBmdW5jdGlvbiAobm9kZSwgY29udGVzdGFudCwgcDEsIHAyKSB7CiAgICAgIGlmICghbm9kZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBwMSA9IHByZXZpb3VzKG5vZGUpOwogICAgICBwMiA9IHByZXZpb3VzKGNvbnRlc3RhbnQpOwogICAgICByZXR1cm4gcDEgJiYgcDIgJiYgcDEgPT0gcDIgJiYgcDE7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gY2FjaGUoKSB7CiAgICB0aGlzLmMgPSB7fTsKICB9CiAgY2FjaGUucHJvdG90eXBlID0gewogICAgZzogZnVuY3Rpb24gKGspIHsKICAgICAgcmV0dXJuIHRoaXMuY1trXSB8fCB1bmRlZmluZWQ7CiAgICB9LAogICAgczogZnVuY3Rpb24gKGssIHYpIHsKICAgICAgdGhpcy5jW2tdID0gdjsKICAgICAgcmV0dXJuIHY7CiAgICB9CiAgfTsKCiAgdmFyIGNsYXNzQ2FjaGUgPSBuZXcgY2FjaGUoKSwKICAgICAgY2xlYW5DYWNoZSA9IG5ldyBjYWNoZSgpLAogICAgICBhdHRyQ2FjaGUgPSBuZXcgY2FjaGUoKSwKICAgICAgdG9rZW5DYWNoZSA9IG5ldyBjYWNoZSgpOwoKICBmdW5jdGlvbiBhcnJheShhcikgewogICAgciA9IFtdOwogICAgZm9yIChpID0gMCwgbGVuID0gYXIubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgcltpXSA9IGFyW2ldOwogICAgfQogICAgcmV0dXJuIHI7CiAgfQoKICBmdW5jdGlvbiBwcmV2aW91cyhuKSB7CiAgICB3aGlsZSAobiA9IG4ucHJldmlvdXNTaWJsaW5nKSB7CiAgICAgIGlmIChuLm5vZGVUeXBlID09IDEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG4KICB9CgogIGZ1bmN0aW9uIHEocXVlcnkpIHsKICAgIHJldHVybiBxdWVyeS5tYXRjaChjaHVua2VyKTsKICB9CgogIGZ1bmN0aW9uIGludGVycHJldCh3aG9sZSwgdGFnLCBpZHNBbmRDbGFzc2VzLCB3aG9sZUF0dHJpYnV0ZSwgYXR0cmlidXRlLCBxdWFsaWZpZXIsIHZhbHVlKSB7CiAgICB2YXIgbSwgYywgazsKICAgIGlmICh0YWcgJiYgdGhpcy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09IHRhZykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoaWRzQW5kQ2xhc3NlcyAmJiAobSA9IGlkc0FuZENsYXNzZXMubWF0Y2goaWQpKSAmJiBtWzFdICE9PSB0aGlzLmlkKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChpZHNBbmRDbGFzc2VzICYmIChjbGFzc2VzID0gaWRzQW5kQ2xhc3Nlcy5tYXRjaChjbGFzKSkpIHsKICAgICAgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspIHsKICAgICAgICBjID0gY2xhc3Nlc1tpXS5zbGljZSgxKTsKICAgICAgICBpZiAoIShjbGFzc0NhY2hlLmcoYykgfHwgY2xhc3NDYWNoZS5zKGMsIG5ldyBSZWdFeHAoJyhefFxccyspJyArIGMgKyAnKFxccyt8JCknKSkpLnRlc3QodGhpcy5jbGFzc05hbWUpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAod2hvbGVBdHRyaWJ1dGUgJiYgIXZhbHVlKSB7CiAgICAgIG8gPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAoayBpbiBvKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvLCBrKSAmJiAob1trXS5uYW1lIHx8IGspID09IGF0dHJpYnV0ZSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAod2hvbGVBdHRyaWJ1dGUgJiYgIWNoZWNrQXR0cihxdWFsaWZpZXIsIHRoaXMuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkgfHwgJycsIHZhbHVlKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CgogIGZ1bmN0aW9uIGNsZWFuKHMpIHsKICAgIHJldHVybiBjbGVhbkNhY2hlLmcocykgfHwgY2xlYW5DYWNoZS5zKHMsIHMucmVwbGFjZShzcGVjaWFsQ2hhcnMsICdcXCQxJykpOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tBdHRyKHF1YWxpZnksIGFjdHVhbCwgdmFsKSB7CiAgICBzd2l0Y2ggKHF1YWxpZnkpIHsKICAgIGNhc2UgJz0nOgogICAgICByZXR1cm4gYWN0dWFsID09IHZhbDsKICAgIGNhc2UgJ149JzoKICAgICAgcmV0dXJuIGFjdHVhbC5tYXRjaChhdHRyQ2FjaGUuZygnXj0nICsgdmFsKSB8fCBhdHRyQ2FjaGUucygnXj0nICsgdmFsLCBuZXcgUmVnRXhwKCdeJyArIGNsZWFuKHZhbCkpKSk7CiAgICBjYXNlICckPSc6CiAgICAgIHJldHVybiBhY3R1YWwubWF0Y2goYXR0ckNhY2hlLmcoJyQ9JyArIHZhbCkgfHwgYXR0ckNhY2hlLnMoJyQ9JyArIHZhbCwgbmV3IFJlZ0V4cChjbGVhbih2YWwpICsgJyQnKSkpOwogICAgY2FzZSAnKj0nOgogICAgICByZXR1cm4gYWN0dWFsLm1hdGNoKGF0dHJDYWNoZS5nKHZhbCkgfHwgYXR0ckNhY2hlLnModmFsLCBuZXcgUmVnRXhwKGNsZWFuKHZhbCkpKSk7CiAgICBjYXNlICd+PSc6CiAgICAgIHJldHVybiBhY3R1YWwubWF0Y2goYXR0ckNhY2hlLmcoJ349JyArIHZhbCkgfHwgYXR0ckNhY2hlLnMoJ349JyArIHZhbCwgbmV3IFJlZ0V4cCgnKD86XnxcXHMrKScgKyBjbGVhbih2YWwpICsgJyg/Olxccyt8JCknKSkpOwogICAgY2FzZSAnfD0nOgogICAgICByZXR1cm4gYWN0dWFsLm1hdGNoKGF0dHJDYWNoZS5nKCd8PScgKyB2YWwpIHx8IGF0dHJDYWNoZS5zKCd8PScgKyB2YWwsIG5ldyBSZWdFeHAoJ14nICsgY2xlYW4odmFsKSArICcoLXwkKScpKSk7CiAgICB9CiAgICByZXR1cm4gMDsKICB9CgogIGZ1bmN0aW9uIF9xd2VyeShzZWxlY3RvcikgewogICAgdmFyIHIgPSBbXSwgcmV0ID0gW10sIGksIGogPSAwLCBrLCBsLCBtLCBwLCB0b2tlbiwgdGFnLCBlbHMsIHJvb3QsIGludHIsIGl0ZW0sCiAgICAgICAgdG9rZW5zID0gdG9rZW5DYWNoZS5nKHNlbGVjdG9yKSB8fCB0b2tlbkNhY2hlLnMoc2VsZWN0b3IsIHNlbGVjdG9yLnNwbGl0KHRva2VuaXpyKSk7CiAgICB0b2tlbnMgPSB0b2tlbnMuc2xpY2UoMCk7IC8vIHRoaXMgbWFrZXMgYSBjb3B5IG9mIHRoZSBhcnJheSBzbyB0aGUgY2FjaGVkIG9yaWdpbmFsIGlzIG5vdCBlZmZlY3RlZAoKICAgIGlmICghdG9rZW5zLmxlbmd0aCkgewogICAgICByZXR1cm4gcjsKICAgIH0KCiAgICB0b2tlbiA9IHRva2Vucy5wb3AoKTsKICAgIHJvb3QgPSB0b2tlbnMubGVuZ3RoICYmIChtID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAyXS5tYXRjaChpZE9ubHkpKSA/IGRvYy5nZXRFbGVtZW50QnlJZChtWzFdKSA6IGRvYzsKICAgIGlmICghcm9vdCkgewogICAgICByZXR1cm4gcjsKICAgIH0KICAgIGludHIgPSBxKHRva2VuKTsKICAgIGVscyA9IC9eWyt+XSQvLnRlc3QodG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXSkgPyBmdW5jdGlvbiAocikgewogICAgICAgIHIgPSBbXQogICAgICAgIHdoaWxlIChyb290ID0gcm9vdC5uZXh0U2libGluZykgewogICAgICAgICAgcm9vdC5ub2RlVHlwZSA9PSAxICYmIChpbnRyWzFdID8gaW50clsxXSA9PSByb290LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA6IDEpICYmIHIucHVzaChyb290KQogICAgICAgIH0KICAgICAgICByZXR1cm4gcgogICAgICB9KCkgOgogICAgICByb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKGludHJbMV0gfHwgJyonKTsKICAgIGZvciAoaSA9IDAsIGwgPSBlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmIChpdGVtID0gaW50ZXJwcmV0LmFwcGx5KGVsc1tpXSwgaW50cikpIHsKICAgICAgICByW2orK10gPSBpdGVtOwogICAgICB9CiAgICB9CgogICAgaWYgKCF0b2tlbnMubGVuZ3RoKSB7CiAgICAgIHJldHVybiByOwogICAgfQoKICAgIC8vIGxvb3AgdGhyb3VnaCBhbGwgZGVzY2VuZGVudCB0b2tlbnMKICAgIGZvciAoaiA9IDAsIGwgPSByLmxlbmd0aCwgayA9IDA7IGogPCBsOyBqKyspIHsKICAgICAgcCA9IHJbal07CiAgICAgIC8vIGxvb3AgdGhyb3VnaCBlYWNoIHRva2VuIGJhY2t3YXJkcyBjcmF3bGluZyB1cCB0cmVlCiAgICAgIGZvciAoaSA9IHRva2Vucy5sZW5ndGggLSAyOyBpID49IDA7aSA9IGkgLSAyKSB7CiAgICAgICAgLy8gbG9vcCB0aHJvdWdoIHBhcmVudCBub2RlcwogICAgICAgIHdoaWxlIChwID0gd2Fsa2VyW3Rva2Vuc1tpICsgMV1dKHAsIHJbal0pKSB7CiAgICAgICAgICBpZiAoZm91bmQgPSBpbnRlcnByZXQuYXBwbHkocCwgcSh0b2tlbnNbaV0pKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZm91bmQgJiYgKHJldFtrKytdID0gcltqXSk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgZnVuY3Rpb24gYm9pbGVyUGxhdGUoc2VsZWN0b3IsIF9yb290LCBmbikgewogICAgdmFyIHJvb3QgPSAodHlwZW9mIF9yb290ID09ICdzdHJpbmcnKSA/IGZuKF9yb290KVswXSA6IChfcm9vdCB8fCBkb2MpOwogICAgaWYgKHNlbGVjdG9yID09PSB3aW5kb3cgfHwgaXNOb2RlKHNlbGVjdG9yKSkgewogICAgICByZXR1cm4gIV9yb290IHx8IChzZWxlY3RvciAhPT0gd2luZG93ICYmIGlzTm9kZShyb290KSAmJiBpc0FuY2VzdG9yKHNlbGVjdG9yLCByb290KSkgPyBbc2VsZWN0b3JdIDogW107CiAgICB9CiAgICBpZiAoc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAnb2JqZWN0JyAmJiBpc0Zpbml0ZShzZWxlY3Rvci5sZW5ndGgpKSB7CiAgICAgIHJldHVybiBhcnJheShzZWxlY3Rvcik7CiAgICB9CiAgICBpZiAobSA9IHNlbGVjdG9yLm1hdGNoKGlkT25seSkpIHsKICAgICAgcmV0dXJuIChlbCA9IGRvYy5nZXRFbGVtZW50QnlJZChtWzFdKSkgPyBbZWxdIDogW107CiAgICB9CiAgICBpZiAobSA9IHNlbGVjdG9yLm1hdGNoKHRhZ09ubHkpKSB7CiAgICAgIHJldHVybiBhcnJheShyb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKG1bMV0pKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGlzTm9kZShlbCkgewogICAgcmV0dXJuIChlbCAmJiBlbC5ub2RlVHlwZSAmJiAoZWwubm9kZVR5cGUgPT0gMSB8fCBlbC5ub2RlVHlwZSA9PSA5KSk7CiAgfQoKICBmdW5jdGlvbiB1bmlxKGFyKSB7CiAgICB2YXIgYSA9IFtdLCBpLCBqOwogICAgbGFiZWw6CiAgICBmb3IgKGkgPSAwOyBpIDwgYXIubGVuZ3RoOyBpKyspIHsKICAgICAgZm9yIChqID0gMDsgaiA8IGEubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZiAoYVtqXSA9PSBhcltpXSkgewogICAgICAgICAgY29udGludWUgbGFiZWw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFbYS5sZW5ndGhdID0gYXJbaV07CiAgICB9CiAgICByZXR1cm4gYTsKICB9CgogIGZ1bmN0aW9uIHF3ZXJ5KHNlbGVjdG9yLCBfcm9vdCkgewogICAgdmFyIHJvb3QgPSAodHlwZW9mIF9yb290ID09ICdzdHJpbmcnKSA/IHF3ZXJ5KF9yb290KVswXSA6IChfcm9vdCB8fCBkb2MpOwogICAgaWYgKCFyb290IHx8ICFzZWxlY3RvcikgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAobSA9IGJvaWxlclBsYXRlKHNlbGVjdG9yLCBfcm9vdCwgcXdlcnkpKSB7CiAgICAgIHJldHVybiBtOwogICAgfQogICAgcmV0dXJuIHNlbGVjdChzZWxlY3Rvciwgcm9vdCk7CiAgfQoKICB2YXIgaXNBbmNlc3RvciA9ICdjb21wYXJlRG9jdW1lbnRQb3NpdGlvbicgaW4gaHRtbCA/CiAgICBmdW5jdGlvbiAoZWxlbWVudCwgY29udGFpbmVyKSB7CiAgICAgIHJldHVybiAoY29udGFpbmVyLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGVsZW1lbnQpICYgMTYpID09IDE2OwogICAgfSA6ICdjb250YWlucycgaW4gaHRtbCA/CiAgICBmdW5jdGlvbiAoZWxlbWVudCwgY29udGFpbmVyKSB7CiAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lciA9PSBkb2MgfHwgY29udGFpbmVyID09IHdpbmRvdyA/IGh0bWwgOiBjb250YWluZXI7CiAgICAgIHJldHVybiBjb250YWluZXIgIT09IGVsZW1lbnQgJiYgY29udGFpbmVyLmNvbnRhaW5zKGVsZW1lbnQpOwogICAgfSA6CiAgICBmdW5jdGlvbiAoZWxlbWVudCwgY29udGFpbmVyKSB7CiAgICAgIHdoaWxlIChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgaWYgKGVsZW1lbnQgPT09IGNvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfSwKCiAgc2VsZWN0ID0gKGRvYy5xdWVyeVNlbGVjdG9yICYmIGRvYy5xdWVyeVNlbGVjdG9yQWxsKSA/CiAgICBmdW5jdGlvbiAoc2VsZWN0b3IsIHJvb3QpIHsKICAgICAgaWYgKGRvYy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIChtID0gc2VsZWN0b3IubWF0Y2goY2xhc3NPbmx5KSkpIHsKICAgICAgICByZXR1cm4gYXJyYXkoKHJvb3QpLmdldEVsZW1lbnRzQnlDbGFzc05hbWUobVsxXSkpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheSgocm9vdCkucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpOwogICAgfSA6CiAgICBmdW5jdGlvbiAoc2VsZWN0b3IsIHJvb3QpIHsKICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKG5vcm1hbGl6ciwgJyQxJyk7CiAgICAgIHZhciByZXN1bHQgPSBbXSwgY29sbGVjdGlvbiwgY29sbGVjdGlvbnMgPSBbXSwgaTsKICAgICAgaWYgKG0gPSBzZWxlY3Rvci5tYXRjaCh0YWdBbmRPckNsYXNzKSkgewogICAgICAgIGl0ZW1zID0gcm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZShtWzFdIHx8ICcqJyk7CiAgICAgICAgciA9IGNsYXNzQ2FjaGUuZyhtWzJdKSB8fCBjbGFzc0NhY2hlLnMobVsyXSwgbmV3IFJlZ0V4cCgnKF58XFxzKyknICsgbVsyXSArICcoXFxzK3wkKScpKTsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXRlbXMubGVuZ3RoLCBqID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgICAgci50ZXN0KGl0ZW1zW2ldLmNsYXNzTmFtZSkgJiYgKHJlc3VsdFtqKytdID0gaXRlbXNbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGZvciAoaSA9IDAsIGl0ZW1zID0gc2VsZWN0b3Iuc3BsaXQoJywnKSwgbCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGNvbGxlY3Rpb25zW2ldID0gX3F3ZXJ5KGl0ZW1zW2ldKTsKICAgICAgfQogICAgICBmb3IgKGkgPSAwLCBsID0gY29sbGVjdGlvbnMubGVuZ3RoOyBpIDwgbCAmJiAoY29sbGVjdGlvbiA9IGNvbGxlY3Rpb25zW2ldKTsgaSsrKSB7CiAgICAgICAgdmFyIHJldCA9IGNvbGxlY3Rpb247CiAgICAgICAgaWYgKHJvb3QgIT09IGRvYykgewogICAgICAgICAgcmV0ID0gW107CiAgICAgICAgICBmb3IgKGogPSAwLCBtID0gY29sbGVjdGlvbi5sZW5ndGg7IGogPCBtICYmIChlbGVtZW50ID0gY29sbGVjdGlvbltqXSk7IGorKykgewogICAgICAgICAgICAvLyBtYWtlIHN1cmUgZWxlbWVudCBpcyBhIGRlc2NlbmRlbnQgb2Ygcm9vdAogICAgICAgICAgICBpc0FuY2VzdG9yKGVsZW1lbnQsIHJvb3QpICYmIHJldC5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHJldCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHVuaXEocmVzdWx0KTsKICAgIH07CgogIHF3ZXJ5LnVuaXEgPSB1bmlxOwogIHZhciBvbGRRd2VyeSA9IGNvbnRleHQucXdlcnk7CiAgcXdlcnkubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbnRleHQucXdlcnkgPSBvbGRRd2VyeTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgY29udGV4dFsncXdlcnknXSA9IHF3ZXJ5OwoKfSh0aGlzLCBkb2N1bWVudCk7c25hY2sucXdlcnkgPSBxd2VyeS5ub0NvbmZsaWN0KCkKc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICByZXR1cm4gc25hY2sucXdlcnkoc2VsZWN0b3IsIGNvbnRleHQpOwp9KQo=",
                "body": "LyohCiAgKiBzbmFjay5qcyAoYykgUnlhbiBGbG9yZW5jZQogICogaHR0cHM6Ly9naXRodWIuY29tL3JwZmxvcmVuY2Uvc25hY2sKICAqIE1JVCBMaWNlbnNlCiAgKiBJbnNwaXJhdGlvbiBhbmQgY29kZSBhZGFwdGVkIGZyb20KICAqICBNb29Ub29scyAgICAgIChjKSBWYWxlcmlvIFByb2lldHRpICAgTUlUIGxpY2Vuc2UKICAqICBqUXVlcnkgICAgICAgIChjKSBKb2huIFJlc2lnICAgICAgICAgRHVhbCBsaWNlbnNlIE1JVCBvciBHUEwgVmVyc2lvbiAyCiAgKiAgY29udGVudExvYWRlZCAoYykgRGllZ28gUGVyaW5pICAgICAgIE1JVCBMaWNlbnNlCiAgKiAgWmVwdG8uanMgICAgICAoYykgVGhvbWFzIEZ1Y2hzICAgICAgIE1JVCBMaWNlbnNlCiovCgppZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgIT0gJ2Z1bmN0aW9uJyl7CiAgLy8gRVM1IE9iZWplY3QuY3JlYXRlCiAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKXsKICAgIGZ1bmN0aW9uIEYoKSB7fQogICAgRi5wcm90b3R5cGUgPSBvCiAgICByZXR1cm4gbmV3IEYKICB9Cn0KCiFmdW5jdGlvbih3aW5kb3cpewogIHZhciBzbmFjayA9IHdpbmRvdy5zbmFjayA9IHt9CiAgICAsIGd1aWQgPSAwCiAgICAsIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZwogICAgLCBpbmRleE9mID0gW10uaW5kZXhPZgogICAgLCBwdXNoID0gW10ucHVzaAoKICBzbmFjay5leHRlbmQgPSBmdW5jdGlvbiAoKXsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpCiAgICAgIHJldHVybiBzbmFjay5leHRlbmQoc25hY2ssIGFyZ3VtZW50c1swXSkKCiAgICB2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdCgogICAgZm9yICh2YXIga2V5LCBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgIGZvciAoa2V5IGluIGFyZ3VtZW50c1tpXSkKICAgICAgICB0YXJnZXRba2V5XSA9IGFyZ3VtZW50c1tpXVtrZXldCgogICAgcmV0dXJuIHRhcmdldAogIH0KCiAgc25hY2suZXh0ZW5kKHsKICAgIHY6ICcxLjIuMycsCgogICAgYmluZDogZnVuY3Rpb24gKGZuLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCl7CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIHB1bmNoOiBmdW5jdGlvbiAob2JqLCBtZXRob2QsIGZuLCBhdXRvKXsKICAgICAgdmFyIG9sZCA9IG9ialttZXRob2RdCiAgICAgIG9ialttZXRob2RdID0gYXV0byA/IGZ1bmN0aW9uICgpewogICAgICAgIG9sZC5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmd1bWVudHMpCiAgICAgIH0gOiBmdW5jdGlvbiAoKXsKICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKQogICAgICAgIGFyZ3MudW5zaGlmdChzbmFjay5iaW5kKG9sZCwgb2JqKSkKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIGNyZWF0ZTogZnVuY3Rpb24gKHByb3RvLCBleHQpewogICAgICB2YXIgb2JqID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgaWYgKCFleHQpCiAgICAgICAgcmV0dXJuIG9iagoKICAgICAgZm9yICh2YXIgaSBpbiBleHQpIHsKICAgICAgICBpZiAoIWV4dC5oYXNPd25Qcm9wZXJ0eShpKSkKICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmICghcHJvdG9baV0gfHwgdHlwZW9mIGV4dFtpXSAhPSAnZnVuY3Rpb24nKXsKICAgICAgICAgIG9ialtpXSA9IGV4dFtpXQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIHNuYWNrLnB1bmNoKG9iaiwgaSwgZXh0W2ldKQogICAgICB9CgogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIGlkOiBmdW5jdGlvbiAoKXsKICAgICAgcmV0dXJuICsrZ3VpZAogICAgfSwKCiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBmbiwgY29udGV4dCl7CiAgICAgIGlmIChvYmoubGVuZ3RoID09PSB2b2lkKzApeyAvLyBsb29zZSBjaGVjayBmb3Igb2JqZWN0LCB3ZSB3YW50IGFycmF5LWxpa2Ugb2JqZWN0cyB0byBiZSB0cmVhdGVkIGFzIGFycmF5cwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSwgb2JqKTsKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb2JqLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBmbi5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKQogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIHBhcnNlSlNPTjogZnVuY3Rpb24oanNvbikgewogICAgICAvLyBhZGFwdGVkIGZyb20galF1ZXJ5CiAgICAgIGlmICh0eXBlb2YganNvbiAhPSAnc3RyaW5nJykKICAgICAgICByZXR1cm4KCiAgICAgIGpzb24gPSBqc29uLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKCiAgICAgIHZhciBpc1ZhbGlkID0gL15bXF0sOnt9XHNdKiQvLnRlc3QoanNvbi5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICJAIikKICAgICAgICAucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICJdIikKICAgICAgICAucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAiIikpCgogICAgICBpZiAoIWlzVmFsaWQpCiAgICAgICAgdGhyb3cgIkludmFsaWQgSlNPTiIKICAgICAgCiAgICAgIHZhciBKU09OID0gd2luZG93LkpTT04gLy8gc2F2ZXMgYSBjb3VwbGUgYnl0ZXMKICAgICAgcmV0dXJuIEpTT04gJiYgSlNPTi5wYXJzZSA/IEpTT04ucGFyc2UoanNvbikgOiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb24pKSgpCiAgICB9LAoKICAgIGlzQXJyYXk6IGZ1bmN0aW9uIChvYmopewogICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgQXJyYXkgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICJbb2JqZWN0IEFycmF5XSIKICAgIH0sCgogICAgaW5kZXhPZjogaW5kZXhPZiA/IGZ1bmN0aW9uKGl0ZW0sIGFycmF5KXsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKQogICAgICB9IDogZnVuY3Rpb24gKGl0ZW0sIGFycmF5KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgICAgcmV0dXJuIGkKCiAgICAgIHJldHVybiAtMQogICAgfQogIH0pCn0od2luZG93KTsKIWZ1bmN0aW9uIChzbmFjaywgZG9jdW1lbnQpewogIHZhciBwcm90byA9IHt9CiAgICAsIHF1ZXJ5CgogIHNuYWNrLndyYXAgPSBmdW5jdGlvbiAobm9kZXMsIGNvbnRleHQpewogICAgLy8gcGFzc2VkIGluIGEgQ1NTIHNlbGVjdG9yCiAgICBpZiAodHlwZW9mIG5vZGVzID09ICdzdHJpbmcnKQogICAgICBub2RlcyA9IHF1ZXJ5KG5vZGVzLCBjb250ZXh0KQoKICAgIC8vIHBhc3NlZCBpbiBzaW5nbGUgbm9kZQogICAgaWYgKCFub2Rlcy5sZW5ndGgpCiAgICAgIG5vZGVzID0gW25vZGVzXQoKICAgIHZhciB3cmFwcGVyID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgLCBpID0gMAogICAgICAsIGwgPSBub2Rlcy5sZW5ndGgKCiAgICBmb3IgKDsgaSA8IGw7IGkrKykKICAgICAgd3JhcHBlcltpXSA9IG5vZGVzW2ldCgogICAgd3JhcHBlci5sZW5ndGggPSBsCiAgICB3cmFwcGVyLmlkID0gc25hY2suaWQoKQogICAgcmV0dXJuIHdyYXBwZXIKICB9CgogIHNuYWNrLmV4dGVuZChzbmFjay53cmFwLCB7CiAgICBkZWZpbmU6IGZ1bmN0aW9uKG5hbWUsIGZuKXsKICAgICAgaWYgKHR5cGVvZiBuYW1lICE9ICdzdHJpbmcnKXsKICAgICAgICBmb3IgKHZhciBpIGluIG5hbWUpCiAgICAgICAgICBzbmFjay53cmFwLmRlZmluZShpLCBuYW1lW2ldKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHByb3RvW25hbWVdID0gZm4KICAgIH0sCgogICAgZGVmaW5lRW5naW5lOiBmdW5jdGlvbiAoZm4pewogICAgICBxdWVyeSA9IGZuCiAgICB9CiAgfSkKCiAgLy8gUVNBIGRlZmF1bHQgc2VsZWN0b3IgZW5naW5lLCBzdXBwb3J0cyByZWFsIGJyb3dzZXJzIGFuZCBJRTgrCiAgc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICAgIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykKICAgICAgY29udGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGV4dCkKCiAgICByZXR1cm4gKGNvbnRleHQgfHwgZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpCiAgfSkKfShzbmFjaywgZG9jdW1lbnQpCiFmdW5jdGlvbiAoc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHZhciBhZGQgICAgICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnYWRkRXZlbnRMaXN0ZW5lcicgOiAnYXR0YWNoRXZlbnQnCiAgICAsIHJlbW92ZSAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdkZXRhY2hFdmVudCcKICAgICwgcHJlZml4ICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJycgOiAnb24nCiAgICAsIHJlYWR5ICAgICAgICAgID0gZmFsc2UKICAgICwgdG9wICAgICAgICAgICAgPSB0cnVlCiAgICAsIHJvb3QgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50CiAgICAsIHJlYWR5SGFuZGxlcnMgID0gW10KCiAgc25hY2suZXh0ZW5kKHsKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZQogICAgfSwKCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgZWxzZQogICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2UKICAgIH0KICB9KQoKICBzbmFjay5saXN0ZW5lciA9IGZ1bmN0aW9uIChwYXJhbXMsIGhhbmRsZXIpewogICAgaWYgKHBhcmFtcy5kZWxlZ2F0ZSl7CiAgICAgIHBhcmFtcy5jYXB0dXJlID0gdHJ1ZQogICAgICBfaGFuZGxlciA9IGhhbmRsZXIKICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCl7CiAgICAgICAgLy8gYWRhcHRlZCBmcm9tIFplcHRvCiAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50CiAgICAgICAgICAsIG5vZGVzID0gdHlwZW9mIHBhcmFtcy5kZWxlZ2F0ZSA9PSAnc3RyaW5nJwogICAgICAgICAgICA/IHNuYWNrLndyYXAocGFyYW1zLmRlbGVnYXRlLCBwYXJhbXMubm9kZSkKICAgICAgICAgICAgOiBwYXJhbXMuZGVsZWdhdGUocGFyYW1zLm5vZGUpCgogICAgICAgIHdoaWxlICh0YXJnZXQgJiYgc25hY2suaW5kZXhPZih0YXJnZXQsIG5vZGVzKSA9PSAtMSApCiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZQoKICAgICAgICBpZiAodGFyZ2V0ICYmICEodGFyZ2V0ID09PSB0aGlzKSAmJiAhKHRhcmdldCA9PT0gZG9jdW1lbnQpKQogICAgICAgICAgX2hhbmRsZXIuY2FsbCh0YXJnZXQsIGV2ZW50LCB0YXJnZXQpCiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLmNvbnRleHQpCiAgICAgIGhhbmRsZXIgPSBzbmFjay5iaW5kKGhhbmRsZXIsIHBhcmFtcy5jb250ZXh0KQoKICAgIHZhciBtZXRob2RzID0gewogICAgICBhdHRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW2FkZF0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBkZXRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW3JlbW92ZV0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBmaXJlOiBmdW5jdGlvbiAoKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KHBhcmFtcy5ub2RlLCBhcmd1bWVudHMpCiAgICAgIH0KICAgIH0KCiAgICBtZXRob2RzLmF0dGFjaCgpCgogICAgcmV0dXJuIG1ldGhvZHMKICB9CgoKCgogIHNuYWNrLnJlYWR5ID0gZnVuY3Rpb24gKGhhbmRsZXIpewogICAgaWYgKHJlYWR5KXsKICAgICAgaGFuZGxlci5hcHBseShkb2N1bWVudCkKICAgICAgcmV0dXJuCiAgICB9CiAgICByZWFkeUhhbmRsZXJzLnB1c2goaGFuZGxlcikKICB9CgogIC8vIGFkYXB0ZWQgZnJvbSBjb250ZW50bG9hZGVkCiAgZnVuY3Rpb24gaW5pdChlKSB7CiAgICBpZiAoZS50eXBlID09ICdyZWFkeXN0YXRlY2hhbmdlJyAmJiBkb2N1bWVudC5yZWFkeVN0YXRlICE9ICdjb21wbGV0ZScpCiAgICAgIHJldHVybgoKICAgIChlLnR5cGUgPT0gJ2xvYWQnID8gd2luZG93IDogZG9jdW1lbnQpW3JlbW92ZV0ocHJlZml4ICsgZS50eXBlLCBpbml0LCBmYWxzZSkKCiAgICBpZiAoIXJlYWR5ICYmIChyZWFkeSA9IHRydWUpKQogICAgICBzbmFjay5lYWNoKHJlYWR5SGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICB9KQogIH0KCiAgZnVuY3Rpb24gcG9sbCgpIHsKICAgIHRyeSB7CiAgICAgIHJvb3QuZG9TY3JvbGwoJ2xlZnQnKQogICAgfSBjYXRjaChlKSB7IAogICAgICBzZXRUaW1lb3V0KHBvbGwsIDUwKQogICAgICByZXR1cm4KICAgIH0KICAgIGluaXQoJ3BvbGwnKQogIH0KCiAgaWYgKGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0ICYmIHJvb3QuZG9TY3JvbGwpIHsKICAgIHRyeSB7CiAgICAgIHRvcCA9ICF3aW5kb3cuZnJhbWVFbGVtZW50CiAgICB9IGNhdGNoKGUpIHt9CiAgICBpZiAodG9wKQogICAgICBwb2xsKCk7CiAgfQoKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdET01Db250ZW50TG9hZGVkJywgaW5pdCwgZmFsc2UpCiAgZG9jdW1lbnRbYWRkXShwcmVmaXggKyAncmVhZHlzdGF0ZWNoYW5nZScsIGluaXQsIGZhbHNlKQogIHdpbmRvd1thZGRdKHByZWZpeCArICdsb2FkJywgaW5pdCwgZmFsc2UpCn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpOwohZnVuY3Rpb24gKHNuYWNrKXsKICBzbmFjay5wdWJsaXNoZXIgPSBmdW5jdGlvbiAob2JqKXsKICAgIHZhciBjaGFubmVscyA9IHt9CiAgICBvYmogPSBvYmogfHwge30KCiAgICBzbmFjay5leHRlbmQob2JqLCB7CiAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGNoYW5uZWwsIGhhbmRsZXIsIGNvbnRleHQpewogICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSB7CiAgICAgICAgICBmbjogaGFuZGxlciwKICAgICAgICAgIGN0eHQ6IChjb250ZXh0IHx8IHt9KQogICAgICAgIH0KCiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdID0gW10KCiAgICAgICAgdmFyIHB1YmxpayA9IHsKICAgICAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnB1c2goc3Vic2NyaXB0aW9uKQogICAgICAgICAgfSwKICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnNwbGljZShzbmFjay5pbmRleE9mKGhhbmRsZXIsIGNoYW5uZWxzW2NoYW5uZWxdKSwgMSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcHVibGlrLmF0dGFjaCgpCiAgICAgICAgcmV0dXJuIHB1YmxpawogICAgICB9LAoKICAgICAgcHVibGlzaDogZnVuY3Rpb24gKGNoYW5uZWwsIGFyZ3NBcnJheSl7CiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIHJldHVybiBmYWxzZQoKICAgICAgICBzbmFjay5lYWNoKGNoYW5uZWxzW2NoYW5uZWxdLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKXsKICAgICAgICAgIHN1YnNjcmlwdGlvbi5mbi5hcHBseShzdWJzY3JpcHRpb24uY3R4dCwgYXJnc0FycmF5IHx8IFtdKQogICAgICAgIH0pCgogICAgICAgIHJldHVybiBjaGFubmVsc1tjaGFubmVsXS5sZW5ndGgKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gb2JqCiAgfQoKICBzbmFjay5wdWJsaXNoZXIoc25hY2spCn0oc25hY2spOwohZnVuY3Rpb24oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHNuYWNrLkpTT05QID0gZnVuY3Rpb24ocGFyYW1zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgIHZhciBqc29ucFN0cmluZyA9ICdqc29ucCcgKyBzbmFjay5pZCgpCiAgICAgICwgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JykKICAgICAgLCBydW5uaW5nID0gZmFsc2UKCiAgICAgIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXSA9IGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHJ1bm5pbmcgPSBmYWxzZQogICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICBjYWxsYmFjayhkYXRhKQogICAgICB9CgogICAgICBpZiAodHlwZW9mIHBhcmFtcy5kYXRhID09ICdvYmplY3QnKQogICAgICAgIHBhcmFtcy5kYXRhID0gc25hY2sudG9RdWVyeVN0cmluZyhwYXJhbXMuZGF0YSkKCiAgICB2YXIgcHVibGlrID0gewogICAgICBzZW5kOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nID0gdHJ1ZQogICAgICAgIHNjcmlwdC5zcmMgPSBwYXJhbXMudXJsICsgJz8nICsgcGFyYW1zLmtleSArICc9c25hY2suSlNPTlAuJyArIGpzb25wU3RyaW5nICsgJyYnICsgcGFyYW1zLmRhdGEKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdCkKICAgICAgfSwKCiAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCl7CiAgICAgICAgcnVubmluZyAmJiBzY3JpcHQucGFyZW50Tm9kZSAmJiBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpCiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24gKCl7CiAgICAgICAgICBkZWxldGUgc25hY2suSlNPTlBbanNvbnBTdHJpbmddCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHBhcmFtcy5ub3cgIT09IGZhbHNlKQogICAgICBwdWJsaWsuc2VuZCgpCgogICAgcmV0dXJuIHB1YmxpawogIH0KCiAgc25hY2sudG9RdWVyeVN0cmluZyA9IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBxdWVyeVN0cmluZyA9IFtdCgogICAgc25hY2suZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICBpZiAoYmFzZSkKICAgICAgICBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nCgogICAgICB2YXIgcmVzdWx0CgogICAgICBpZiAoc25hY2suaXNBcnJheSh2YWx1ZSkpewogICAgICAgIHZhciBxcyA9IHt9CiAgICAgICAgc25hY2suZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsLCBpKXsKICAgICAgICAgIHFzW2ldID0gdmFsCiAgICAgICAgfSkKICAgICAgICByZXN1bHQgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHFzLCBrZXkpCiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSkKICAgICAgZWxzZQogICAgICAgIHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkKCiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkKICAgICAgICBxdWVyeVN0cmluZy5wdXNoKHJlc3VsdCkKICAgIH0pCgogICAgcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKQogIH0KCiAgdmFyIHhock9iamVjdCA9IChmdW5jdGlvbigpewogICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICB2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIH0KCiAgICB2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTDIuWE1MSFRUUCcpOwogICAgfQoKICAgIHZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKICAgIH0KCiAgICB0cnkgewogICAgICBYTUxIVFRQKCkKICAgICAgcmV0dXJuIFhNTEhUVFAKICAgIH0gY2F0Y2ggKGUpewogICAgICB0cnkgewogICAgICAgIE1TWE1MMigpCiAgICAgICAgcmV0dXJuIE1TWE1MMgogICAgICB9IGNhdGNoIChlKXsKICAgICAgICBNU1hNTCgpCiAgICAgICAgcmV0dXJuIE1TWE1MCiAgICAgIH0KICAgIH0KICB9KSgpOwoKICBmdW5jdGlvbiBlbXB0eSgpe30KCiAgc25hY2sucmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRpb25zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBzbmFjay5yZXF1ZXN0KSkKICAgICAgcmV0dXJuIG5ldyBzbmFjay5yZXF1ZXN0KG9wdGlvbnMsIGNhbGxiYWNrKQoKICAgIHZhciBzZWxmID0gdGhpcwogICAgc2VsZi5vcHRpb25zID0gc25hY2suZXh0ZW5kKHt9LCBzZWxmLm9wdGlvbnMsIG9wdGlvbnMpCiAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2sKICAgIHNlbGYueGhyID0gbmV3IHhock9iamVjdAogICAgc2VsZi5oZWFkZXJzID0gc2VsZi5vcHRpb25zLmhlYWRlcnMKICAgIGlmIChzZWxmLm9wdGlvbnMubm93ICE9PSBmYWxzZSkKICAgICAgc2VsZi5zZW5kKCkKICB9CgogIHNuYWNrLnJlcXVlc3QucHJvdG90eXBlID0gewoKICAgIG9wdGlvbnM6IHsvKgogICAgICB1c2VyOiAnJywKICAgICAgcGFzc3dvcmQ6ICcnLCovCiAgICAgIGV4Y2VwdGlvbjogZW1wdHksCiAgICAgIHVybDogJycsCiAgICAgIGRhdGE6ICcnLAogICAgICBtZXRob2Q6ICdnZXQnLAogICAgICBub3c6IHRydWUsCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCcsCiAgICAgICAgJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwogICAgICB9LAogICAgICBhc3luYzogdHJ1ZSwKICAgICAgZW11bGF0aW9uOiB0cnVlLAogICAgICB1cmxFbmNvZGVkOiB0cnVlLAogICAgICBlbmNvZGluZzogJ3V0Zi04JwogICAgfSwKCiAgICBvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIHhociA9IHNlbGYueGhyCgogICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgIT0gNCB8fCAhc2VsZi5ydW5uaW5nKSByZXR1cm4KICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKICAgICAgc2VsZi5zdGF0dXMgPSAwCgogICAgICB0cnl7CiAgICAgICAgdmFyIHN0YXR1cyA9IHhoci5zdGF0dXMKICAgICAgICBzZWxmLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXMKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoKICAgICAgdmFyIGFyZ3MgPSBzZWxmLnN0YXR1cyA+PSAyMDAgJiYgc2VsZi5zdGF0dXMgPCAzMDAKICAgICAgICA/IFtmYWxzZSwgc2VsZi54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCBzZWxmLnhoci5yZXNwb25zZVhNTF0KICAgICAgICA6IFtzZWxmLnN0YXR1c10KCiAgICAgIHNlbGYuY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJncykKICAgIH0sCiAgCiAgICBzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKICAgICAgdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewogICAgICB0cnkgewogICAgICAgIHJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKQogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CiAgICB9LAogIAogICAgc2VuZDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCiAgICAgICAgLCBvcHRpb25zID0gc2VsZi5vcHRpb25zCgogICAgICBpZiAoc2VsZi5ydW5uaW5nKSByZXR1cm4gc2VsZjsKCiAgICAgIHNlbGYucnVubmluZyA9IHRydWU7CgogICAgICB2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCAnJwogICAgICAgICwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKQogICAgICAgICwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKQoKICAgICAgaWYgKHR5cGVvZiBkYXRhICE9ICdzdHJpbmcnKQogICAgICAgIGRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKGRhdGEpCgogICAgICBpZiAob3B0aW9ucy5lbXVsYXRpb24gJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsnZ2V0JywgJ3Bvc3QnXSkgPCAwKXsKICAgICAgICB2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2QKICAgICAgICBkYXRhID0gKGRhdGEpID8gX21ldGhvZCArICcmJyArIGRhdGEgOiBfbWV0aG9kCiAgICAgICAgbWV0aG9kID0gJ3Bvc3QnCiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnVybEVuY29kZWQgJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsncG9zdCcsICdwdXQnXSkgPiAtMSl7CiAgICAgICAgdmFyIGVuY29kaW5nID0gKG9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgb3B0aW9ucy5lbmNvZGluZyA6ICcnCiAgICAgICAgc2VsZi5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2RpbmcKICAgICAgfQoKICAgICAgaWYgKCF1cmwpCiAgICAgICAgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWUKCiAgICAgIHZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKQogICAgICBpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpCiAgICAgICAgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pCgogICAgICBpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewogICAgICAgIHVybCArPSAodXJsLmluZGV4T2YoJz8nKSA+IC0xID8gJyYnIDogJz8nKSArIGRhdGEKICAgICAgICBkYXRhID0gbnVsbAogICAgICB9CgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKCiAgICAgIHhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIG9wZW4uYXN5bmMsIG9wdGlvbnMudXNlciwgb3B0aW9ucy5wYXNzd29yZCkKICAgICAgaWYgKG9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlCiAgICAKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHNuYWNrLmJpbmQoc2VsZi5vblN0YXRlQ2hhbmdlLCBzZWxmKQoKICAgICAgZm9yICh2YXIgaSBpbiBzZWxmLmhlYWRlcnMpewogICAgICAgIHRyeSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihpLCBzZWxmLmhlYWRlcnNbaV0pCiAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICBvcHRpb25zLmV4Y2VwdGlvbi5hcHBseShzZWxmLCBbaSwgc2VsZi5oZWFkZXJzW2ldXSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHhoci5zZW5kKGRhdGEpCiAgICAgIGlmICghb3B0aW9ucy5hc3luYykgc2VsZi5vblN0YXRlQ2hhbmdlKCkKICAgIAogICAgICByZXR1cm4gc2VsZgogICAgfSwKCiAgICBjYW5jZWw6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwoKICAgICAgaWYgKCFzZWxmLnJ1bm5pbmcpCiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICAgIHNlbGYucnVubmluZyA9IGZhbHNlCgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKICAgICAgeGhyLmFib3J0KCkKCiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQoKICAgICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0KCkKICAgICAgcmV0dXJuIHNlbGYKICAgIH0KICB9Cn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpCiFmdW5jdGlvbihzbmFjaywgZG9jdW1lbnQpewogIHNuYWNrLndyYXAuZGVmaW5lKHsKICAgIGRhdGE6IGZ1bmN0aW9uICgpewogICAgICAvLyBBUEkgaW5zcGlyZWQgYnkgalF1ZXJ5CiAgICAgIHZhciBzdG9yYWdlID0ge30KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSl7CiAgICAgICAgdmFyIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdCgogICAgICAgIGlmICghZGF0YSkKICAgICAgICAgIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdID0ge30KCiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkKzEpCiAgICAgICAgICByZXR1cm4gZGF0YVtrZXldCgogICAgICAgIHJldHVybiBkYXRhW2tleV0gPSB2YWx1ZQogICAgICB9ICAKICAgIH0oKSwKCiAgICBlYWNoOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpewogICAgICByZXR1cm4gc25hY2suZWFjaCh0aGlzLCBmbiwgY29udGV4dCkKICAgIH0sCiAgCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBpZiAoY2xlYW4oZWxlbWVudC5jbGFzc05hbWUpLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbGVhbihlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkKICAgICAgfSkKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpewogICAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKQogICAgICB9KQogICAgfSwKCiAgICBhdHRhY2g6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlciwgLyogaW50ZXJuYWwgKi8gZGVsZWdhdGlvbil7CiAgICAgIHZhciBzcGxpdCA9IGV2ZW50LnNwbGl0KCcuJykKICAgICAgICAsIGxpc3RlbmVycyA9IFtdCgogICAgICBpZiAoc3BsaXRbMV0pCiAgICAgICAgbGlzdGVuZXJzID0gdGhpcy5kYXRhKHNwbGl0WzFdKSB8fCBbXQoKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBwYXJhbXMgPSB7CiAgICAgICAgICBub2RlOiBub2RlLAogICAgICAgICAgZXZlbnQ6IHNwbGl0WzBdCiAgICAgICAgfQoKICAgICAgICBpZiAoZGVsZWdhdGlvbikKICAgICAgICAgIHBhcmFtcy5kZWxlZ2F0ZSA9IGRlbGVnYXRpb24KCiAgICAgICAgbGlzdGVuZXJzLnB1c2goc25hY2subGlzdGVuZXIocGFyYW1zLCBoYW5kbGVyKSkKICAgICAgfSkKCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICB0aGlzLmRhdGEoc3BsaXRbMV0sIGxpc3RlbmVycykKCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGRldGFjaDogZnVuY3Rpb24gKG5hbWVzcGFjZSl7CiAgICAgIGxpc3RlbmVyTWV0aG9kKHRoaXMsICdkZXRhY2gnLCBuYW1lc3BhY2UsIG51bGwsIHRydWUpCiAgICAgIHRoaXMuZGF0YShuYW1lc3BhY2UsIG51bGwpCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGZpcmU6IGZ1bmN0aW9uIChuYW1lc3BhY2UsIGFyZ3MpewogICAgICByZXR1cm4gbGlzdGVuZXJNZXRob2QodGhpcywgJ2ZpcmUnLCBuYW1lc3BhY2UsIGFyZ3MpCiAgICB9LAoKICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoZXZlbnQsIGRlbGVnYXRpb24sIGhhbmRsZXIpewogICAgICByZXR1cm4gdGhpcy5hdHRhY2goZXZlbnQsIGhhbmRsZXIsIGRlbGVnYXRpb24pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gY2xlYW4oc3RyKXsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KCiAgZnVuY3Rpb24gbGlzdGVuZXJNZXRob2Qod3JhcHBlciwgbWV0aG9kLCBuYW1lc3BhY2UsIGFyZ3MpewogICAgdmFyIGRhdGEgPSB3cmFwcGVyLmRhdGEobmFtZXNwYWNlKQoKICAgIGlmIChkYXRhKQogICAgICBzbmFjay5lYWNoKGRhdGEsIGZ1bmN0aW9uIChsaXN0ZW5lcil7CiAgICAgICAgbGlzdGVuZXJbbWV0aG9kXS5hcHBseSh3cmFwcGVyLCBhcmdzKQogICAgICB9KQoKICAgIHJldHVybiB3cmFwcGVyCiAgfQp9KHNuYWNrLCBkb2N1bWVudCk7Ci8qIQogICogUXdlcnkgLSBBIEJsYXppbmcgRmFzdCBxdWVyeSBzZWxlY3RvciBlbmdpbmUKICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9kZWQvcXdlcnkKICAqIGNvcHlyaWdodCBEdXN0aW4gRGlheiAmIEphY29iIFRob3JudG9uIDIwMTEKICAqIE1JVCBMaWNlbnNlCiAgKi8KCiFmdW5jdGlvbiAoY29udGV4dCwgZG9jKSB7CgogIHZhciBjLCBpLCBqLCBrLCBsLCBtLCBvLCBwLCByLCB2LAogICAgICBlbCwgbm9kZSwgbGVuLCBmb3VuZCwgY2xhc3NlcywgaXRlbSwgaXRlbXMsIHRva2VuLAogICAgICBpZCA9IC8jKFtcd1wtXSspLywKICAgICAgY2xhcyA9IC9cLltcd1wtXSsvZywKICAgICAgaWRPbmx5ID0gL14jKFtcd1wtXSskKS8sCiAgICAgIGNsYXNzT25seSA9IC9eXC4oW1x3XC1dKykkLywKICAgICAgdGFnT25seSA9IC9eKFtcd1wtXSspJC8sCiAgICAgIHRhZ0FuZE9yQ2xhc3MgPSAvXihbXHddKyk/XC4oW1x3XC1dKykkLywKICAgICAgaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgIG5vcm1hbGl6ciA9IC9ccyooW1xzXCtcfj5dKVxzKi9nLAogICAgICB0b2tlbml6ciA9IC8oW1xzXD5cK1x+XSkoPyFbXHNcd1wtXC9cP1wmXD1cOlwuXChcKVwhLEAjJTw+XHtcfVwkXCpcXiciXSpcXSkvLAogICAgICBzcGVjaWFsQ2hhcnMgPSAvKFsuKis/XF49IToke30oKXxcW1xdXC9cXF0pL2csCiAgICAgIHNpbXBsZSA9IC9eKFthLXowLTldKyk/KD86KFtcLlwjXStbXHdcLVwuI10rKT8pLywKICAgICAgYXR0ciA9IC9cWyhbXHdcLV0rKSg/OihbXHxcXlwkXCpcfl0/XD0pWyciXT8oWyBcd1wtXC9cP1wmXD1cOlwuXChcKVwhLEAjJTw+XHtcfVwkXCpcXl0rKVsiJ10/KT9cXS8sCiAgICAgIGNodW5rZXIgPSBuZXcgUmVnRXhwKHNpbXBsZS5zb3VyY2UgKyAnKCcgKyBhdHRyLnNvdXJjZSArICcpPycpLAogICAgICB3YWxrZXIgPSB7CiAgICAnICc6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHJldHVybiBub2RlICYmIG5vZGUgIT09IGh0bWwgJiYgbm9kZS5wYXJlbnROb2RlCiAgICB9LAogICAgJz4nOiBmdW5jdGlvbiAobm9kZSwgY29udGVzdGFudCkgewogICAgICByZXR1cm4gbm9kZSAmJiBub2RlLnBhcmVudE5vZGUgPT0gY29udGVzdGFudC5wYXJlbnROb2RlICYmIG5vZGUucGFyZW50Tm9kZTsKICAgIH0sCiAgICAnfic6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHJldHVybiBub2RlICYmIG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgfSwKICAgICcrJzogZnVuY3Rpb24gKG5vZGUsIGNvbnRlc3RhbnQsIHAxLCBwMikgewogICAgICBpZiAoIW5vZGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcDEgPSBwcmV2aW91cyhub2RlKTsKICAgICAgcDIgPSBwcmV2aW91cyhjb250ZXN0YW50KTsKICAgICAgcmV0dXJuIHAxICYmIHAyICYmIHAxID09IHAyICYmIHAxOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGNhY2hlKCkgewogICAgdGhpcy5jID0ge307CiAgfQogIGNhY2hlLnByb3RvdHlwZSA9IHsKICAgIGc6IGZ1bmN0aW9uIChrKSB7CiAgICAgIHJldHVybiB0aGlzLmNba10gfHwgdW5kZWZpbmVkOwogICAgfSwKICAgIHM6IGZ1bmN0aW9uIChrLCB2KSB7CiAgICAgIHRoaXMuY1trXSA9IHY7CiAgICAgIHJldHVybiB2OwogICAgfQogIH07CgogIHZhciBjbGFzc0NhY2hlID0gbmV3IGNhY2hlKCksCiAgICAgIGNsZWFuQ2FjaGUgPSBuZXcgY2FjaGUoKSwKICAgICAgYXR0ckNhY2hlID0gbmV3IGNhY2hlKCksCiAgICAgIHRva2VuQ2FjaGUgPSBuZXcgY2FjaGUoKTsKCiAgZnVuY3Rpb24gYXJyYXkoYXIpIHsKICAgIHIgPSBbXTsKICAgIGZvciAoaSA9IDAsIGxlbiA9IGFyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHJbaV0gPSBhcltpXTsKICAgIH0KICAgIHJldHVybiByOwogIH0KCiAgZnVuY3Rpb24gcHJldmlvdXMobikgewogICAgd2hpbGUgKG4gPSBuLnByZXZpb3VzU2libGluZykgewogICAgICBpZiAobi5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuCiAgfQoKICBmdW5jdGlvbiBxKHF1ZXJ5KSB7CiAgICByZXR1cm4gcXVlcnkubWF0Y2goY2h1bmtlcik7CiAgfQoKICBmdW5jdGlvbiBpbnRlcnByZXQod2hvbGUsIHRhZywgaWRzQW5kQ2xhc3Nlcywgd2hvbGVBdHRyaWJ1dGUsIGF0dHJpYnV0ZSwgcXVhbGlmaWVyLCB2YWx1ZSkgewogICAgdmFyIG0sIGMsIGs7CiAgICBpZiAodGFnICYmIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSB0YWcpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGlkc0FuZENsYXNzZXMgJiYgKG0gPSBpZHNBbmRDbGFzc2VzLm1hdGNoKGlkKSkgJiYgbVsxXSAhPT0gdGhpcy5pZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoaWRzQW5kQ2xhc3NlcyAmJiAoY2xhc3NlcyA9IGlkc0FuZENsYXNzZXMubWF0Y2goY2xhcykpKSB7CiAgICAgIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgYyA9IGNsYXNzZXNbaV0uc2xpY2UoMSk7CiAgICAgICAgaWYgKCEoY2xhc3NDYWNoZS5nKGMpIHx8IGNsYXNzQ2FjaGUucyhjLCBuZXcgUmVnRXhwKCcoXnxcXHMrKScgKyBjICsgJyhcXHMrfCQpJykpKS50ZXN0KHRoaXMuY2xhc3NOYW1lKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHdob2xlQXR0cmlidXRlICYmICF2YWx1ZSkgewogICAgICBvID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKGsgaW4gbykgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobywgaykgJiYgKG9ba10ubmFtZSB8fCBrKSA9PSBhdHRyaWJ1dGUpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHdob2xlQXR0cmlidXRlICYmICFjaGVja0F0dHIocXVhbGlmaWVyLCB0aGlzLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpIHx8ICcnLCB2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBjbGVhbihzKSB7CiAgICByZXR1cm4gY2xlYW5DYWNoZS5nKHMpIHx8IGNsZWFuQ2FjaGUucyhzLCBzLnJlcGxhY2Uoc3BlY2lhbENoYXJzLCAnXFwkMScpKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrQXR0cihxdWFsaWZ5LCBhY3R1YWwsIHZhbCkgewogICAgc3dpdGNoIChxdWFsaWZ5KSB7CiAgICBjYXNlICc9JzoKICAgICAgcmV0dXJuIGFjdHVhbCA9PSB2YWw7CiAgICBjYXNlICdePSc6CiAgICAgIHJldHVybiBhY3R1YWwubWF0Y2goYXR0ckNhY2hlLmcoJ149JyArIHZhbCkgfHwgYXR0ckNhY2hlLnMoJ149JyArIHZhbCwgbmV3IFJlZ0V4cCgnXicgKyBjbGVhbih2YWwpKSkpOwogICAgY2FzZSAnJD0nOgogICAgICByZXR1cm4gYWN0dWFsLm1hdGNoKGF0dHJDYWNoZS5nKCckPScgKyB2YWwpIHx8IGF0dHJDYWNoZS5zKCckPScgKyB2YWwsIG5ldyBSZWdFeHAoY2xlYW4odmFsKSArICckJykpKTsKICAgIGNhc2UgJyo9JzoKICAgICAgcmV0dXJuIGFjdHVhbC5tYXRjaChhdHRyQ2FjaGUuZyh2YWwpIHx8IGF0dHJDYWNoZS5zKHZhbCwgbmV3IFJlZ0V4cChjbGVhbih2YWwpKSkpOwogICAgY2FzZSAnfj0nOgogICAgICByZXR1cm4gYWN0dWFsLm1hdGNoKGF0dHJDYWNoZS5nKCd+PScgKyB2YWwpIHx8IGF0dHJDYWNoZS5zKCd+PScgKyB2YWwsIG5ldyBSZWdFeHAoJyg/Ol58XFxzKyknICsgY2xlYW4odmFsKSArICcoPzpcXHMrfCQpJykpKTsKICAgIGNhc2UgJ3w9JzoKICAgICAgcmV0dXJuIGFjdHVhbC5tYXRjaChhdHRyQ2FjaGUuZygnfD0nICsgdmFsKSB8fCBhdHRyQ2FjaGUucygnfD0nICsgdmFsLCBuZXcgUmVnRXhwKCdeJyArIGNsZWFuKHZhbCkgKyAnKC18JCknKSkpOwogICAgfQogICAgcmV0dXJuIDA7CiAgfQoKICBmdW5jdGlvbiBfcXdlcnkoc2VsZWN0b3IpIHsKICAgIHZhciByID0gW10sIHJldCA9IFtdLCBpLCBqID0gMCwgaywgbCwgbSwgcCwgdG9rZW4sIHRhZywgZWxzLCByb290LCBpbnRyLCBpdGVtLAogICAgICAgIHRva2VucyA9IHRva2VuQ2FjaGUuZyhzZWxlY3RvcikgfHwgdG9rZW5DYWNoZS5zKHNlbGVjdG9yLCBzZWxlY3Rvci5zcGxpdCh0b2tlbml6cikpOwogICAgdG9rZW5zID0gdG9rZW5zLnNsaWNlKDApOyAvLyB0aGlzIG1ha2VzIGEgY29weSBvZiB0aGUgYXJyYXkgc28gdGhlIGNhY2hlZCBvcmlnaW5hbCBpcyBub3QgZWZmZWN0ZWQKCiAgICBpZiAoIXRva2Vucy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHI7CiAgICB9CgogICAgdG9rZW4gPSB0b2tlbnMucG9wKCk7CiAgICByb290ID0gdG9rZW5zLmxlbmd0aCAmJiAobSA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMl0ubWF0Y2goaWRPbmx5KSkgPyBkb2MuZ2V0RWxlbWVudEJ5SWQobVsxXSkgOiBkb2M7CiAgICBpZiAoIXJvb3QpIHsKICAgICAgcmV0dXJuIHI7CiAgICB9CiAgICBpbnRyID0gcSh0b2tlbik7CiAgICBlbHMgPSAvXlsrfl0kLy50ZXN0KHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0pID8gZnVuY3Rpb24gKHIpIHsKICAgICAgICByID0gW10KICAgICAgICB3aGlsZSAocm9vdCA9IHJvb3QubmV4dFNpYmxpbmcpIHsKICAgICAgICAgIHJvb3Qubm9kZVR5cGUgPT0gMSAmJiAoaW50clsxXSA/IGludHJbMV0gPT0gcm9vdC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgOiAxKSAmJiByLnB1c2gocm9vdCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHIKICAgICAgfSgpIDoKICAgICAgcm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZShpbnRyWzFdIHx8ICcqJyk7CiAgICBmb3IgKGkgPSAwLCBsID0gZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBpZiAoaXRlbSA9IGludGVycHJldC5hcHBseShlbHNbaV0sIGludHIpKSB7CiAgICAgICAgcltqKytdID0gaXRlbTsKICAgICAgfQogICAgfQoKICAgIGlmICghdG9rZW5zLmxlbmd0aCkgewogICAgICByZXR1cm4gcjsKICAgIH0KCiAgICAvLyBsb29wIHRocm91Z2ggYWxsIGRlc2NlbmRlbnQgdG9rZW5zCiAgICBmb3IgKGogPSAwLCBsID0gci5sZW5ndGgsIGsgPSAwOyBqIDwgbDsgaisrKSB7CiAgICAgIHAgPSByW2pdOwogICAgICAvLyBsb29wIHRocm91Z2ggZWFjaCB0b2tlbiBiYWNrd2FyZHMgY3Jhd2xpbmcgdXAgdHJlZQogICAgICBmb3IgKGkgPSB0b2tlbnMubGVuZ3RoIC0gMjsgaSA+PSAwO2kgPSBpIC0gMikgewogICAgICAgIC8vIGxvb3AgdGhyb3VnaCBwYXJlbnQgbm9kZXMKICAgICAgICB3aGlsZSAocCA9IHdhbGtlclt0b2tlbnNbaSArIDFdXShwLCByW2pdKSkgewogICAgICAgICAgaWYgKGZvdW5kID0gaW50ZXJwcmV0LmFwcGx5KHAsIHEodG9rZW5zW2ldKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvdW5kICYmIChyZXRbaysrXSA9IHJbal0pOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CgogIGZ1bmN0aW9uIGJvaWxlclBsYXRlKHNlbGVjdG9yLCBfcm9vdCwgZm4pIHsKICAgIHZhciByb290ID0gKHR5cGVvZiBfcm9vdCA9PSAnc3RyaW5nJykgPyBmbihfcm9vdClbMF0gOiAoX3Jvb3QgfHwgZG9jKTsKICAgIGlmIChzZWxlY3RvciA9PT0gd2luZG93IHx8IGlzTm9kZShzZWxlY3RvcikpIHsKICAgICAgcmV0dXJuICFfcm9vdCB8fCAoc2VsZWN0b3IgIT09IHdpbmRvdyAmJiBpc05vZGUocm9vdCkgJiYgaXNBbmNlc3RvcihzZWxlY3Rvciwgcm9vdCkpID8gW3NlbGVjdG9yXSA6IFtdOwogICAgfQogICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gJ29iamVjdCcgJiYgaXNGaW5pdGUoc2VsZWN0b3IubGVuZ3RoKSkgewogICAgICByZXR1cm4gYXJyYXkoc2VsZWN0b3IpOwogICAgfQogICAgaWYgKG0gPSBzZWxlY3Rvci5tYXRjaChpZE9ubHkpKSB7CiAgICAgIHJldHVybiAoZWwgPSBkb2MuZ2V0RWxlbWVudEJ5SWQobVsxXSkpID8gW2VsXSA6IFtdOwogICAgfQogICAgaWYgKG0gPSBzZWxlY3Rvci5tYXRjaCh0YWdPbmx5KSkgewogICAgICByZXR1cm4gYXJyYXkocm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZShtWzFdKSk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc05vZGUoZWwpIHsKICAgIHJldHVybiAoZWwgJiYgZWwubm9kZVR5cGUgJiYgKGVsLm5vZGVUeXBlID09IDEgfHwgZWwubm9kZVR5cGUgPT0gOSkpOwogIH0KCiAgZnVuY3Rpb24gdW5pcShhcikgewogICAgdmFyIGEgPSBbXSwgaSwgajsKICAgIGxhYmVsOgogICAgZm9yIChpID0gMDsgaSA8IGFyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCBhLmxlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKGFbal0gPT0gYXJbaV0pIHsKICAgICAgICAgIGNvbnRpbnVlIGxhYmVsOwogICAgICAgIH0KICAgICAgfQogICAgICBhW2EubGVuZ3RoXSA9IGFyW2ldOwogICAgfQogICAgcmV0dXJuIGE7CiAgfQoKICBmdW5jdGlvbiBxd2VyeShzZWxlY3RvciwgX3Jvb3QpIHsKICAgIHZhciByb290ID0gKHR5cGVvZiBfcm9vdCA9PSAnc3RyaW5nJykgPyBxd2VyeShfcm9vdClbMF0gOiAoX3Jvb3QgfHwgZG9jKTsKICAgIGlmICghcm9vdCB8fCAhc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgaWYgKG0gPSBib2lsZXJQbGF0ZShzZWxlY3RvciwgX3Jvb3QsIHF3ZXJ5KSkgewogICAgICByZXR1cm4gbTsKICAgIH0KICAgIHJldHVybiBzZWxlY3Qoc2VsZWN0b3IsIHJvb3QpOwogIH0KCiAgdmFyIGlzQW5jZXN0b3IgPSAnY29tcGFyZURvY3VtZW50UG9zaXRpb24nIGluIGh0bWwgPwogICAgZnVuY3Rpb24gKGVsZW1lbnQsIGNvbnRhaW5lcikgewogICAgICByZXR1cm4gKGNvbnRhaW5lci5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihlbGVtZW50KSAmIDE2KSA9PSAxNjsKICAgIH0gOiAnY29udGFpbnMnIGluIGh0bWwgPwogICAgZnVuY3Rpb24gKGVsZW1lbnQsIGNvbnRhaW5lcikgewogICAgICBjb250YWluZXIgPSBjb250YWluZXIgPT0gZG9jIHx8IGNvbnRhaW5lciA9PSB3aW5kb3cgPyBodG1sIDogY29udGFpbmVyOwogICAgICByZXR1cm4gY29udGFpbmVyICE9PSBlbGVtZW50ICYmIGNvbnRhaW5lci5jb250YWlucyhlbGVtZW50KTsKICAgIH0gOgogICAgZnVuY3Rpb24gKGVsZW1lbnQsIGNvbnRhaW5lcikgewogICAgICB3aGlsZSAoZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSkgewogICAgICAgIGlmIChlbGVtZW50ID09PSBjb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0sCgogIHNlbGVjdCA9IChkb2MucXVlcnlTZWxlY3RvciAmJiBkb2MucXVlcnlTZWxlY3RvckFsbCkgPwogICAgZnVuY3Rpb24gKHNlbGVjdG9yLCByb290KSB7CiAgICAgIGlmIChkb2MuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAobSA9IHNlbGVjdG9yLm1hdGNoKGNsYXNzT25seSkpKSB7CiAgICAgICAgcmV0dXJuIGFycmF5KChyb290KS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG1bMV0pKTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXkoKHJvb3QpLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKTsKICAgIH0gOgogICAgZnVuY3Rpb24gKHNlbGVjdG9yLCByb290KSB7CiAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZShub3JtYWxpenIsICckMScpOwogICAgICB2YXIgcmVzdWx0ID0gW10sIGNvbGxlY3Rpb24sIGNvbGxlY3Rpb25zID0gW10sIGk7CiAgICAgIGlmIChtID0gc2VsZWN0b3IubWF0Y2godGFnQW5kT3JDbGFzcykpIHsKICAgICAgICBpdGVtcyA9IHJvb3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUobVsxXSB8fCAnKicpOwogICAgICAgIHIgPSBjbGFzc0NhY2hlLmcobVsyXSkgfHwgY2xhc3NDYWNoZS5zKG1bMl0sIG5ldyBSZWdFeHAoJyhefFxccyspJyArIG1bMl0gKyAnKFxccyt8JCknKSk7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IGl0ZW1zLmxlbmd0aCwgaiA9IDA7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHIudGVzdChpdGVtc1tpXS5jbGFzc05hbWUpICYmIChyZXN1bHRbaisrXSA9IGl0ZW1zW2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBmb3IgKGkgPSAwLCBpdGVtcyA9IHNlbGVjdG9yLnNwbGl0KCcsJyksIGwgPSBpdGVtcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBjb2xsZWN0aW9uc1tpXSA9IF9xd2VyeShpdGVtc1tpXSk7CiAgICAgIH0KICAgICAgZm9yIChpID0gMCwgbCA9IGNvbGxlY3Rpb25zLmxlbmd0aDsgaSA8IGwgJiYgKGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uc1tpXSk7IGkrKykgewogICAgICAgIHZhciByZXQgPSBjb2xsZWN0aW9uOwogICAgICAgIGlmIChyb290ICE9PSBkb2MpIHsKICAgICAgICAgIHJldCA9IFtdOwogICAgICAgICAgZm9yIChqID0gMCwgbSA9IGNvbGxlY3Rpb24ubGVuZ3RoOyBqIDwgbSAmJiAoZWxlbWVudCA9IGNvbGxlY3Rpb25bal0pOyBqKyspIHsKICAgICAgICAgICAgLy8gbWFrZSBzdXJlIGVsZW1lbnQgaXMgYSBkZXNjZW5kZW50IG9mIHJvb3QKICAgICAgICAgICAgaXNBbmNlc3RvcihlbGVtZW50LCByb290KSAmJiByZXQucHVzaChlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChyZXQpOwogICAgICB9CiAgICAgIHJldHVybiB1bmlxKHJlc3VsdCk7CiAgICB9OwoKICBxd2VyeS51bmlxID0gdW5pcTsKICB2YXIgb2xkUXdlcnkgPSBjb250ZXh0LnF3ZXJ5OwogIHF3ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICBjb250ZXh0LnF3ZXJ5ID0gb2xkUXdlcnk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIGNvbnRleHRbJ3F3ZXJ5J10gPSBxd2VyeTsKCn0odGhpcywgZG9jdW1lbnQpO3NuYWNrLnF3ZXJ5ID0gcXdlcnkubm9Db25mbGljdCgpCnNuYWNrLndyYXAuZGVmaW5lRW5naW5lKGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCl7CiAgcmV0dXJuIHNuYWNrLnF3ZXJ5KHNlbGVjdG9yLCBjb250ZXh0KTsKfSkK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Length": "25368",
                    "Date": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}