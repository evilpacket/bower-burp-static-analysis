{
    "url": "http://localhost:9999/nickradford/Smart-Table/smart-table-module/lib/angular/angular-scenario.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/nickradford/Smart-Table/smart-table-module/lib/angular/angular-scenario.js",
                "path": "/nickradford/Smart-Table/smart-table-module/lib/angular/angular-scenario.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uaWNrcmFkZm9yZC9TbWFydC1UYWJsZS9zbWFydC10YWJsZS1tb2R1bGUvbGliL2FuZ3VsYXIvYW5ndWxhci1zY2VuYXJpby5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTAyOTA4MQ0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAxOTo0ODowMCBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMTk6NDc6NTkgR01UDQoNCi8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYxLjcuMgogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTEsIEpvaG4gUmVzaWcKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqIENvcHlyaWdodCAyMDExLCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQsIEJTRCwgYW5kIEdQTCBMaWNlbnNlcy4KICoKICogRGF0ZTogV2VkIE1hciAyMSAxMjo0NjozNCAyMDEyIC0wNzAwCiAqLwooZnVuY3Rpb24gKHdpbmRvdywgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgovLyBVc2UgdGhlIGNvcnJlY3QgZG9jdW1lbnQgYWNjb3JkaW5nbHkgd2l0aCB3aW5kb3cgYXJndW1lbnQgKHNhbmRib3gpCiAgICB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgICAgbmF2aWdhdG9yID0gd2luZG93Lm5hdmlnYXRvciwKICAgICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgIHZhciBqUXVlcnkgPSAoZnVuY3Rpb24gKCkgewoKLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKICAgICAgICB2YXIgalF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnkpOwogICAgICAgICAgICB9LAoKICAgICAgICAvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgICAgICAgICAgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgogICAgICAgIC8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICAgICAgICAgIF8kID0gd2luZG93LiQsCgogICAgICAgIC8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQogICAgICAgICAgICByb290alF1ZXJ5LAoKICAgICAgICAvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncyBvciBJRCBzdHJpbmdzCiAgICAgICAgLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQogICAgICAgICAgICBxdWlja0V4cHIgPSAvXig/OlteIzxdKig8W1x3XFddKz4pW14+XSokfCMoW1x3XC1dKikkKS8sCgogICAgICAgIC8vIENoZWNrIGlmIGEgc3RyaW5nIGhhcyBhIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlciBpbiBpdAogICAgICAgICAgICBybm90d2hpdGUgPSAvXFMvLAoKICAgICAgICAvLyBVc2VkIGZvciB0cmltbWluZyB3aGl0ZXNwYWNlCiAgICAgICAgICAgIHRyaW1MZWZ0ID0gL15ccysvLAogICAgICAgICAgICB0cmltUmlnaHQgPSAvXHMrJC8sCgogICAgICAgIC8vIE1hdGNoIGEgc3RhbmRhbG9uZSB0YWcKICAgICAgICAgICAgcnNpbmdsZVRhZyA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPik/JC8sCgogICAgICAgIC8vIEpTT04gUmVnRXhwCiAgICAgICAgICAgIHJ2YWxpZGNoYXJzID0gL15bXF0sOnt9XHNdKiQvLAogICAgICAgICAgICBydmFsaWRlc2NhcGUgPSAvXFwoPzpbIlxcXC9iZm5ydF18dVswLTlhLWZBLUZdezR9KS9nLAogICAgICAgICAgICBydmFsaWR0b2tlbnMgPSAvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csCiAgICAgICAgICAgIHJ2YWxpZGJyYWNlcyA9IC8oPzpefDp8LCkoPzpccypcWykrL2csCgogICAgICAgIC8vIFVzZXJhZ2VudCBSZWdFeHAKICAgICAgICAgICAgcndlYmtpdCA9IC8od2Via2l0KVsgXC9dKFtcdy5dKykvLAogICAgICAgICAgICByb3BlcmEgPSAvKG9wZXJhKSg/Oi4qdmVyc2lvbik/WyBcL10oW1x3Ll0rKS8sCiAgICAgICAgICAgIHJtc2llID0gLyhtc2llKSAoW1x3Ll0rKS8sCiAgICAgICAgICAgIHJtb3ppbGxhID0gLyhtb3ppbGxhKSg/Oi4qPyBydjooW1x3Ll0rKSk/LywKCiAgICAgICAgLy8gTWF0Y2hlcyBkYXNoZWQgc3RyaW5nIGZvciBjYW1lbGl6aW5nCiAgICAgICAgICAgIHJkYXNoQWxwaGEgPSAvLShbYS16XXxbMC05XSkvaWcsCiAgICAgICAgICAgIHJtc1ByZWZpeCA9IC9eLW1zLS8sCgogICAgICAgIC8vIFVzZWQgYnkgalF1ZXJ5LmNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKICAgICAgICAgICAgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuICggbGV0dGVyICsgIiIgKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAvLyBLZWVwIGEgVXNlckFnZW50IHN0cmluZyBmb3IgdXNlIHdpdGggalF1ZXJ5LmJyb3dzZXIKICAgICAgICAgICAgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCiAgICAgICAgLy8gRm9yIG1hdGNoaW5nIHRoZSBlbmdpbmUgYW5kIHZlcnNpb24gb2YgdGhlIGJyb3dzZXIKICAgICAgICAgICAgYnJvd3Nlck1hdGNoLAoKICAgICAgICAvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKICAgICAgICAgICAgcmVhZHlMaXN0LAoKICAgICAgICAvLyBUaGUgcmVhZHkgZXZlbnQgaGFuZGxlcgogICAgICAgICAgICBET01Db250ZW50TG9hZGVkLAoKICAgICAgICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHNvbWUgY29yZSBtZXRob2RzCiAgICAgICAgICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICAgICAgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICAgICAgcHVzaCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLAogICAgICAgICAgICBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICAgICAgdHJpbSA9IFN0cmluZy5wcm90b3R5cGUudHJpbSwKICAgICAgICAgICAgaW5kZXhPZiA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mLAoKICAgICAgICAvLyBbW0NsYXNzXV0gLT4gdHlwZSBwYWlycwogICAgICAgICAgICBjbGFzczJ0eXBlID0ge307CgogICAgICAgIGpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIGNvbnN0cnVjdG9yOiBqUXVlcnksCiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoLCBlbGVtLCByZXQsIGRvYzsKCiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgJCgiIiksICQobnVsbCksIG9yICQodW5kZWZpbmVkKQogICAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEhhbmRsZSAkKERPTUVsZW1lbnQpCiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3Iubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRoZSBib2R5IGVsZW1lbnQgb25seSBleGlzdHMgb25jZSwgb3B0aW1pemUgZmluZGluZyBpdAogICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yID09PSAiYm9keSIgJiYgIWNvbnRleHQgJiYgZG9jdW1lbnQuYm9keSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXNbMF0gPSBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBcmUgd2UgZGVhbGluZyB3aXRoIEhUTUwgc3RyaW5nIG9yIGFuIElEPwogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5jaGFyQXQoMCkgPT09ICI8IiAmJiBzZWxlY3Rvci5jaGFyQXQoc2VsZWN0b3IubGVuZ3RoIC0gMSkgPT09ICI+IiAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBxdWlja0V4cHIuZXhlYyhzZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBWZXJpZnkgYSBtYXRjaCwgYW5kIHRoYXQgbm8gY29udGV4dCB3YXMgc3BlY2lmaWVkIGZvciAjaWQKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvYyA9ICggY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBhIHNpbmdsZSBzdHJpbmcgaXMgcGFzc2VkIGluIGFuZCBpdCdzIGEgc2luZ2xlIHRhZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBkbyBhIGNyZWF0ZUVsZW1lbnQgYW5kIHNraXAgdGhlIHJlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJzaW5nbGVUYWcuZXhlYyhzZWxlY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNQbGFpbk9iamVjdChjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IFsgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChyZXRbMV0pIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5mbi5hdHRyLmNhbGwoc2VsZWN0b3IsIGNvbnRleHQsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IFsgZG9jLmNyZWF0ZUVsZW1lbnQocmV0WzFdKSBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KFsgbWF0Y2hbMV0gXSwgWyBkb2MgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSAoIHJldC5jYWNoZWFibGUgPyBqUXVlcnkuY2xvbmUocmV0LmZyYWdtZW50KSA6IHJldC5mcmFnbWVudCApLmNoaWxkTm9kZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZSh0aGlzLCBzZWxlY3Rvcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSEFORExFOiAkKCIjaWQiKQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoWzJdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFIGFuZCBPcGVyYSByZXR1cm4gaXRlbXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5pZCAhPT0gbWF0Y2hbMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvb3RqUXVlcnkuZmluZChzZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbMF0gPSBlbGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKHNlbGVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICAvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcihjb250ZXh0KS5maW5kKHNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEhBTkRMRTogJChmdW5jdGlvbikKICAgICAgICAgICAgICAgICAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oc2VsZWN0b3IpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5zZWxlY3RvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yLnNlbGVjdG9yOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoc2VsZWN0b3IsIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgogICAgICAgICAgICBzZWxlY3RvcjogIiIsCgogICAgICAgICAgICAvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCiAgICAgICAgICAgIGpxdWVyeTogIjEuNy4yIiwKCiAgICAgICAgICAgIC8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAogICAgICAgICAgICBsZW5ndGg6IDAsCgogICAgICAgICAgICAvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAogICAgICAgICAgICBzaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b0FycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLCAwKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKICAgICAgICAgICAgLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAobnVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVtID09IG51bGwgPwoKICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CiAgICAgICAgICAgICAgICAgICAgdGhpcy50b0FycmF5KCkgOgoKICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4ganVzdCB0aGUgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgKCBudW0gPCAwID8gdGhpc1sgdGhpcy5sZW5ndGggKyBudW0gXSA6IHRoaXNbIG51bSBdICk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCiAgICAgICAgICAgIC8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQogICAgICAgICAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIChlbGVtcywgbmFtZSwgc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgIC8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5jb25zdHJ1Y3RvcigpOwoKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShlbGVtcykpIHsKICAgICAgICAgICAgICAgICAgICBwdXNoLmFwcGx5KHJldCwgZWxlbXMpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHJldCwgZWxlbXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFkZCB0aGUgb2xkIG9iamVjdCBvbnRvIHRoZSBzdGFjayAoYXMgYSByZWZlcmVuY2UpCiAgICAgICAgICAgICAgICByZXQucHJldk9iamVjdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgogICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJmaW5kIikgewogICAgICAgICAgICAgICAgICAgIHJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgKyAoIHRoaXMuc2VsZWN0b3IgPyAiICIgOiAiIiApICsgc2VsZWN0b3I7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICByZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgIi4iICsgbmFtZSArICIoIiArIHNlbGVjdG9yICsgIikiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAgICAgICAgICAgLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKICAgICAgICAgICAgLy8gb25seSB1c2VkIGludGVybmFsbHkuKQogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZWFjaCh0aGlzLCBjYWxsYmFjaywgYXJncyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWFkeTogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggdGhlIGxpc3RlbmVycwogICAgICAgICAgICAgICAgalF1ZXJ5LmJpbmRSZWFkeSgpOwoKICAgICAgICAgICAgICAgIC8vIEFkZCB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgICAgIHJlYWR5TGlzdC5hZGQoZm4pOwoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZXE6IGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICBpID0gK2k7CiAgICAgICAgICAgICAgICByZXR1cm4gaSA9PT0gLTEgPwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpY2UoaSkgOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpY2UoaSwgaSArIDEpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmlyc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVxKDApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbGFzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2xpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICAgICJzbGljZSIsIHNsaWNlLmNhbGwoYXJndW1lbnRzKS5qb2luKCIsIikpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbWFwOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoZWxlbSwgaSwgZWxlbSk7CiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KICAgICAgICAgICAgLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCiAgICAgICAgICAgIHB1c2g6IHB1c2gsCiAgICAgICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgICAgIHNwbGljZTogW10uc3BsaWNlCiAgICAgICAgfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KICAgICAgICBqUXVlcnkuZm4uaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgogICAgICAgIGpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCiAgICAgICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICAgICAgICBkZWVwID0gZmFsc2U7CgogICAgICAgICAgICAvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgIGRlZXAgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CiAgICAgICAgICAgICAgICAvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CiAgICAgICAgICAgICAgICBpID0gMjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgICAgICAgICBpZiAobGVuZ3RoID09PSBpKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0aGlzOwogICAgICAgICAgICAgICAgLS1pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIC8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKICAgICAgICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBzcmMgPSB0YXJnZXRbIG5hbWUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29weSA9IG9wdGlvbnNbIG5hbWUgXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gY29weSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb3B5SXNBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlJc0FycmF5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbIG5hbWUgXSA9IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfTsKCiAgICAgICAgalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgICAgIG5vQ29uZmxpY3Q6IGZ1bmN0aW9uIChkZWVwKSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LiQgPT09IGpRdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRlZXAgJiYgd2luZG93LmpRdWVyeSA9PT0galF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCiAgICAgICAgICAgIGlzUmVhZHk6IGZhbHNlLAoKICAgICAgICAgICAgLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQogICAgICAgICAgICAvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSAjNjc4MQogICAgICAgICAgICByZWFkeVdhaXQ6IDEsCgogICAgICAgICAgICAvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKICAgICAgICAgICAgaG9sZFJlYWR5OiBmdW5jdGlvbiAoaG9sZCkgewogICAgICAgICAgICAgICAgaWYgKGhvbGQpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVhZHlXYWl0Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZWFkeSh0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgICAgICAgICAgcmVhZHk6IGZ1bmN0aW9uICh3YWl0KSB7CiAgICAgICAgICAgICAgICAvLyBFaXRoZXIgYSByZWxlYXNlZCBob2xkIG9yIGFuIERPTXJlYWR5L2xvYWQgZXZlbnQgYW5kIG5vdCB5ZXQgcmVhZHkKICAgICAgICAgICAgICAgIGlmICgod2FpdCA9PT0gdHJ1ZSAmJiAhLS1qUXVlcnkucmVhZHlXYWl0KSB8fCAod2FpdCAhPT0gdHJ1ZSAmJiAhalF1ZXJ5LmlzUmVhZHkpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgogICAgICAgICAgICAgICAgICAgIGlmICghZG9jdW1lbnQuYm9keSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChqUXVlcnkucmVhZHksIDEpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQogICAgICAgICAgICAgICAgICAgIGlmICh3YWl0ICE9PSB0cnVlICYmIC0talF1ZXJ5LnJlYWR5V2FpdCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQogICAgICAgICAgICAgICAgICAgIHJlYWR5TGlzdC5maXJlV2l0aChkb2N1bWVudCwgWyBqUXVlcnkgXSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwogICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuZm4udHJpZ2dlcikgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJpbmRSZWFkeTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHJlYWR5TGlzdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZWFkeUxpc3QgPSBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpOwoKICAgICAgICAgICAgICAgIC8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZQogICAgICAgICAgICAgICAgLy8gYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoalF1ZXJ5LnJlYWR5LCAxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNb3ppbGxhLCBPcGVyYSBhbmQgd2Via2l0IG5pZ2h0bGllcyBjdXJyZW50bHkgc3VwcG9ydCB0aGlzIGV2ZW50CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgalF1ZXJ5LnJlYWR5LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIC8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCiAgICAgICAgICAgICAgICAgICAgLy8gbWF5YmUgbGF0ZSBidXQgc2FmZSBhbHNvIGZvciBpZnJhbWVzCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQpOwoKICAgICAgICAgICAgICAgICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgalF1ZXJ5LnJlYWR5KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSUUgYW5kIG5vdCBhIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQogICAgICAgICAgICAgICAgICAgIHZhciB0b3BsZXZlbCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0b3BsZXZlbCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsICYmIHRvcGxldmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgogICAgICAgICAgICAvLyBTaW5jZSB2ZXJzaW9uIDEuMywgRE9NIG1ldGhvZHMgYW5kIGZ1bmN0aW9ucyBsaWtlIGFsZXJ0CiAgICAgICAgICAgIC8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCiAgICAgICAgICAgIGlzRnVuY3Rpb246IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNBcnJheTogQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImFycmF5IjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlzV2luZG93OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09IG9iai53aW5kb3c7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc051bWVyaWM6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiAhaXNOYU4ocGFyc2VGbG9hdChvYmopKSAmJiBpc0Zpbml0ZShvYmopOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdHlwZTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiA9PSBudWxsID8KICAgICAgICAgICAgICAgICAgICBTdHJpbmcob2JqKSA6CiAgICAgICAgICAgICAgICAgICAgY2xhc3MydHlwZVsgdG9TdHJpbmcuY2FsbChvYmopIF0gfHwgIm9iamVjdCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc1BsYWluT2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICAvLyBNdXN0IGJlIGFuIE9iamVjdC4KICAgICAgICAgICAgICAgIC8vIEJlY2F1c2Ugb2YgSUUsIHdlIGFsc28gaGF2ZSB0byBjaGVjayB0aGUgcHJlc2VuY2Ugb2YgdGhlIGNvbnN0cnVjdG9yIHByb3BlcnR5LgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKICAgICAgICAgICAgICAgIGlmICghb2JqIHx8IGpRdWVyeS50eXBlKG9iaikgIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBqUXVlcnkuaXNXaW5kb3cob2JqKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIC8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKICAgICAgICAgICAgICAgICAgICBpZiAob2JqLmNvbnN0cnVjdG9yICYmICFoYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmICFoYXNPd24uY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSUU4LDkgV2lsbCB0aHJvdyBleGNlcHRpb25zIG9uIGNlcnRhaW4gaG9zdCBvYmplY3RzICM5ODk3CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAogICAgICAgICAgICAgICAgLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgogICAgICAgICAgICAgICAgdmFyIGtleTsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd24uY2FsbChvYmosIGtleSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc0VtcHR5T2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIG9iaikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcGFyc2VKU09OOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiB8fCAhZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2UgaXMgcmVtb3ZlZCAoSUUgY2FuJ3QgaGFuZGxlIGl0KQogICAgICAgICAgICAgICAgZGF0YSA9IGpRdWVyeS50cmltKGRhdGEpOwoKICAgICAgICAgICAgICAgIC8vIEF0dGVtcHQgdG8gcGFyc2UgdXNpbmcgdGhlIG5hdGl2ZSBKU09OIHBhcnNlciBmaXJzdAogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5KU09OLnBhcnNlKGRhdGEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgaW5jb21pbmcgZGF0YSBpcyBhY3R1YWwgSlNPTgogICAgICAgICAgICAgICAgLy8gTG9naWMgYm9ycm93ZWQgZnJvbSBodHRwOi8vanNvbi5vcmcvanNvbjIuanMKICAgICAgICAgICAgICAgIGlmIChydmFsaWRjaGFycy50ZXN0KGRhdGEucmVwbGFjZShydmFsaWRlc2NhcGUsICJAIikKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZShydmFsaWR0b2tlbnMsICJdIikKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZShydmFsaWRicmFjZXMsICIiKSkpIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICggbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGRhdGEpICkoKTsKCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqUXVlcnkuZXJyb3IoIkludmFsaWQgSlNPTjogIiArIGRhdGEpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwogICAgICAgICAgICBwYXJzZVhNTDogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgfHwgIWRhdGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB4bWwsIHRtcDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsgLy8gU3RhbmRhcmQKICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB4bWwgPSB0bXAucGFyc2VGcm9tU3RyaW5nKGRhdGEsICJ0ZXh0L3htbCIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIElFCiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5hc3luYyA9ICJmYWxzZSI7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5sb2FkWE1MKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB4bWwgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmVycm9yKCJJbnZhbGlkIFhNTDogIiArIGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHhtbDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG5vb3A6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CiAgICAgICAgICAgIC8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAogICAgICAgICAgICAvLyBodHRwOi8vd2VibG9ncy5qYXZhLm5ldC9ibG9nL2RyaXNjb2xsL2FyY2hpdmUvMjAwOS8wOS8wOC9ldmFsLWphdmFzY3JpcHQtZ2xvYmFsLWNvbnRleHQKICAgICAgICAgICAgZ2xvYmFsRXZhbDogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIHJub3R3aGl0ZS50ZXN0KGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2UgdXNlIGV4ZWNTY3JpcHQgb24gSW50ZXJuZXQgRXhwbG9yZXIKICAgICAgICAgICAgICAgICAgICAvLyBXZSB1c2UgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgY29udGV4dCBpcyB3aW5kb3cKICAgICAgICAgICAgICAgICAgICAvLyByYXRoZXIgdGhhbiBqUXVlcnkgaW4gRmlyZWZveAogICAgICAgICAgICAgICAgICAgICggd2luZG93LmV4ZWNTY3JpcHQgfHwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93WyAiZXZhbCIgXS5jYWxsKHdpbmRvdywgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfSApKGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwogICAgICAgICAgICAvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpCiAgICAgICAgICAgIGNhbWVsQ2FzZTogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKHJtc1ByZWZpeCwgIm1zLSIpLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBub2RlTmFtZTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gbmFtZS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbiAob2JqZWN0LCBjYWxsYmFjaywgYXJncykgewogICAgICAgICAgICAgICAgdmFyIG5hbWUsIGkgPSAwLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IG9iamVjdC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaXNPYmogPSBsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBqUXVlcnkuaXNGdW5jdGlvbihvYmplY3QpOwoKICAgICAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5hcHBseShvYmplY3RbIG5hbWUgXSwgYXJncykgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5hcHBseShvYmplY3RbIGkrKyBdLCBhcmdzKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9iamVjdFsgbmFtZSBdLCBuYW1lLCBvYmplY3RbIG5hbWUgXSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9iamVjdFsgaSBdLCBpLCBvYmplY3RbIGkrKyBdKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gVXNlIG5hdGl2ZSBTdHJpbmcudHJpbSBmdW5jdGlvbiB3aGVyZXZlciBwb3NzaWJsZQogICAgICAgICAgICB0cmltOiB0cmltID8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/CiAgICAgICAgICAgICAgICAgICAgICAgICIiIDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJpbS5jYWxsKHRleHQpOwogICAgICAgICAgICAgICAgfSA6CgogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHVzZSBvdXIgb3duIHRyaW1taW5nIGZ1bmN0aW9uYWxpdHkKICAgICAgICAgICAgICAgIGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/CiAgICAgICAgICAgICAgICAgICAgICAgICIiIDoKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dC50b1N0cmluZygpLnJlcGxhY2UodHJpbUxlZnQsICIiKS5yZXBsYWNlKHRyaW1SaWdodCwgIiIpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgICAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbiAoYXJyYXksIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgIHZhciByZXQgPSByZXN1bHRzIHx8IFtdOwoKICAgICAgICAgICAgICAgIGlmIChhcnJheSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHdpbmRvdywgc3RyaW5ncyAoYW5kIGZ1bmN0aW9ucykgYWxzbyBoYXZlICdsZW5ndGgnCiAgICAgICAgICAgICAgICAgICAgLy8gVHdlYWtlZCBsb2dpYyBzbGlnaHRseSB0byBoYW5kbGUgQmxhY2tiZXJyeSA0LjcgUmVnRXhwIGlzc3VlcyAjNjkzMAogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0galF1ZXJ5LnR5cGUoYXJyYXkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09IG51bGwgfHwgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlID09PSAicmVnZXhwIiB8fCBqUXVlcnkuaXNXaW5kb3coYXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1c2guY2FsbChyZXQsIGFycmF5KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkubWVyZ2UocmV0LCBhcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbkFycmF5OiBmdW5jdGlvbiAoZWxlbSwgYXJyYXksIGkpIHsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2YpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChhcnJheSwgZWxlbSwgaSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaSA9IGkgPyBpIDwgMCA/IE1hdGgubWF4KDAsIGxlbiArIGkpIDogaSA6IDA7CgogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2tpcCBhY2Nlc3NpbmcgaW4gc3BhcnNlIGFycmF5cwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSBpbiBhcnJheSAmJiBhcnJheVsgaSBdID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBtZXJnZTogZnVuY3Rpb24gKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gZmlyc3QubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGogPSAwOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc2Vjb25kW2pdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZmlyc3QubGVuZ3RoID0gaTsKCiAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBncmVwOiBmdW5jdGlvbiAoZWxlbXMsIGNhbGxiYWNrLCBpbnYpIHsKICAgICAgICAgICAgICAgIHZhciByZXQgPSBbXSwgcmV0VmFsOwogICAgICAgICAgICAgICAgaW52ID0gISFpbnY7CgogICAgICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwogICAgICAgICAgICAgICAgLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9ICEhY2FsbGJhY2soZWxlbXNbIGkgXSwgaSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGludiAhPT0gcmV0VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGVsZW1zWyBpIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICAgICAgICAgIG1hcDogZnVuY3Rpb24gKGVsZW1zLCBjYWxsYmFjaywgYXJnKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUsIGtleSwgcmV0ID0gW10sCiAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gZWxlbXMubGVuZ3RoLAogICAgICAgICAgICAgICAgLy8ganF1ZXJ5IG9iamVjdHMgYXJlIHRyZWF0ZWQgYXMgYXJyYXlzCiAgICAgICAgICAgICAgICAgICAgaXNBcnJheSA9IGVsZW1zIGluc3RhbmNlb2YgalF1ZXJ5IHx8IGxlbmd0aCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmICggKCBsZW5ndGggPiAwICYmIGVsZW1zWyAwIF0gJiYgZWxlbXNbIGxlbmd0aCAtIDEgXSApIHx8IGxlbmd0aCA9PT0gMCB8fCBqUXVlcnkuaXNBcnJheShlbGVtcykgKTsKCiAgICAgICAgICAgICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1zWyBpIF0sIGksIGFyZyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0WyByZXQubGVuZ3RoIF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gZWxlbXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1sga2V5IF0sIGtleSwgYXJnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgICAgICAgICAgIHJldHVybiByZXQuY29uY2F0LmFwcGx5KFtdLCByZXQpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCiAgICAgICAgICAgIGd1aWQ6IDEsCgogICAgICAgICAgICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAgICAgICAgICAgLy8gYXJndW1lbnRzLgogICAgICAgICAgICBwcm94eTogZnVuY3Rpb24gKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IGZuWyBjb250ZXh0IF07CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGZuOwogICAgICAgICAgICAgICAgICAgIGZuID0gdG1wOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCiAgICAgICAgICAgICAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwKICAgICAgICAgICAgICAgICAgICBwcm94eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkCiAgICAgICAgICAgICAgICBwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgcHJveHkuZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoKICAgICAgICAgICAgICAgIHJldHVybiBwcm94eTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIE11dGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgdG8gYSBjb2xsZWN0aW9uCiAgICAgICAgICAgIC8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgogICAgICAgICAgICBhY2Nlc3M6IGZ1bmN0aW9uIChlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHBhc3MpIHsKICAgICAgICAgICAgICAgIHZhciBleGVjLAogICAgICAgICAgICAgICAgICAgIGJ1bGsgPSBrZXkgPT0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgogICAgICAgICAgICAgICAgLy8gU2V0cyBtYW55IHZhbHVlcwogICAgICAgICAgICAgICAgaWYgKGtleSAmJiB0eXBlb2Yga2V5ID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSBpbiBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmFjY2VzcyhlbGVtcywgZm4sIGksIGtleVtpXSwgMSwgZW1wdHlHZXQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hhaW5hYmxlID0gMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU2V0cyBvbmUgdmFsdWUKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsbHksIGZ1bmN0aW9uIHZhbHVlcyBnZXQgZXhlY3V0ZWQgaWYgZXhlYyBpcyB0cnVlCiAgICAgICAgICAgICAgICAgICAgZXhlYyA9IHBhc3MgPT09IHVuZGVmaW5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChidWxrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1bGsgb3BlcmF0aW9ucyBvbmx5IGl0ZXJhdGUgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGVjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjID0gZm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uIChlbGVtLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4ZWMuY2FsbChqUXVlcnkoZWxlbSksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHRoZXkgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbXMsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKGVsZW1zW2ldLCBrZXksIGV4ZWMgPyB2YWx1ZS5jYWxsKGVsZW1zW2ldLCBpLCBmbihlbGVtc1tpXSwga2V5KSkgOiB2YWx1ZSwgcGFzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNoYWluYWJsZSA9IDE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNoYWluYWJsZSA/CiAgICAgICAgICAgICAgICAgICAgZWxlbXMgOgoKICAgICAgICAgICAgICAgICAgICAvLyBHZXRzCiAgICAgICAgICAgICAgICAgICAgYnVsayA/CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbXMpIDoKICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID8gZm4oZWxlbXNbMF0sIGtleSkgOiBlbXB0eUdldDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG5vdzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFVzZSBvZiBqUXVlcnkuYnJvd3NlciBpcyBmcm93bmVkIHVwb24uCiAgICAgICAgICAgIC8vIE1vcmUgZGV0YWlsczogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9VdGlsaXRpZXMvalF1ZXJ5LmJyb3dzZXIKICAgICAgICAgICAgdWFNYXRjaDogZnVuY3Rpb24gKHVhKSB7CiAgICAgICAgICAgICAgICB1YSA9IHVhLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gcndlYmtpdC5leGVjKHVhKSB8fAogICAgICAgICAgICAgICAgICAgIHJvcGVyYS5leGVjKHVhKSB8fAogICAgICAgICAgICAgICAgICAgIHJtc2llLmV4ZWModWEpIHx8CiAgICAgICAgICAgICAgICAgICAgdWEuaW5kZXhPZigiY29tcGF0aWJsZSIpIDwgMCAmJiBybW96aWxsYS5leGVjKHVhKSB8fAogICAgICAgICAgICAgICAgICAgIFtdOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IGJyb3dzZXI6IG1hdGNoWzFdIHx8ICIiLCB2ZXJzaW9uOiBtYXRjaFsyXSB8fCAiMCIgfTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHN1YjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24galF1ZXJ5U3ViKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBqUXVlcnlTdWIuZm4uaW5pdChzZWxlY3RvciwgY29udGV4dCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgalF1ZXJ5LmV4dGVuZCh0cnVlLCBqUXVlcnlTdWIsIHRoaXMpOwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLnN1cGVyY2xhc3MgPSB0aGlzOwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLmZuID0galF1ZXJ5U3ViLnByb3RvdHlwZSA9IHRoaXMoKTsKICAgICAgICAgICAgICAgIGpRdWVyeVN1Yi5mbi5jb25zdHJ1Y3RvciA9IGpRdWVyeVN1YjsKICAgICAgICAgICAgICAgIGpRdWVyeVN1Yi5zdWIgPSB0aGlzLnN1YjsKICAgICAgICAgICAgICAgIGpRdWVyeVN1Yi5mbi5pbml0ID0gZnVuY3Rpb24gaW5pdChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0ICYmIGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgJiYgIShjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5U3ViKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0galF1ZXJ5U3ViKGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5mbi5pbml0LmNhbGwodGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnlTdWIpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGpRdWVyeVN1Yi5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeVN1Yi5mbjsKICAgICAgICAgICAgICAgIHZhciByb290alF1ZXJ5U3ViID0galF1ZXJ5U3ViKGRvY3VtZW50KTsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnlTdWI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBicm93c2VyOiB7fQogICAgICAgIH0pOwoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCiAgICAgICAgalF1ZXJ5LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAgICAgICAgIGNsYXNzMnR5cGVbICJbb2JqZWN0ICIgKyBuYW1lICsgIl0iIF0gPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CgogICAgICAgIGJyb3dzZXJNYXRjaCA9IGpRdWVyeS51YU1hdGNoKHVzZXJBZ2VudCk7CiAgICAgICAgaWYgKGJyb3dzZXJNYXRjaC5icm93c2VyKSB7CiAgICAgICAgICAgIGpRdWVyeS5icm93c2VyWyBicm93c2VyTWF0Y2guYnJvd3NlciBdID0gdHJ1ZTsKICAgICAgICAgICAgalF1ZXJ5LmJyb3dzZXIudmVyc2lvbiA9IGJyb3dzZXJNYXRjaC52ZXJzaW9uOwogICAgICAgIH0KCi8vIERlcHJlY2F0ZWQsIHVzZSBqUXVlcnkuYnJvd3Nlci53ZWJraXQgaW5zdGVhZAogICAgICAgIGlmIChqUXVlcnkuYnJvd3Nlci53ZWJraXQpIHsKICAgICAgICAgICAgalF1ZXJ5LmJyb3dzZXIuc2FmYXJpID0gdHJ1ZTsKICAgICAgICB9CgovLyBJRSBkb2Vzbid0IG1hdGNoIG5vbi1icmVha2luZyBzcGFjZXMgd2l0aCBccwogICAgICAgIGlmIChybm90d2hpdGUudGVzdCgiXHhBMCIpKSB7CiAgICAgICAgICAgIHRyaW1MZWZ0ID0gL15bXHNceEEwXSsvOwogICAgICAgICAgICB0cmltUmlnaHQgPSAvW1xzXHhBMF0rJC87CiAgICAgICAgfQoKLy8gQWxsIGpRdWVyeSBvYmplY3RzIHNob3VsZCBwb2ludCBiYWNrIHRvIHRoZXNlCiAgICAgICAgcm9vdGpRdWVyeSA9IGpRdWVyeShkb2N1bWVudCk7CgovLyBDbGVhbnVwIGZ1bmN0aW9ucyBmb3IgdGhlIGRvY3VtZW50IHJlYWR5IG1ldGhvZAogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIERPTUNvbnRlbnRMb2FkZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICAgICAgICAgIH07CgogICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgRE9NQ29udGVudExvYWRlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBib2R5IGV4aXN0cywgYXQgbGVhc3QsIGluIGNhc2UgSUUgZ2V0cyBhIGxpdHRsZSBvdmVyemVhbG91cyAodGlja2V0ICM1NDQzKS4KICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZGV0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIERPTUNvbnRlbnRMb2FkZWQpOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZWFkeSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KCi8vIFRoZSBET00gcmVhZHkgY2hlY2sgZm9yIEludGVybmV0IEV4cGxvcmVyCiAgICAgICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc1JlYWR5KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAvLyBJZiBJRSBpcyB1c2VkLCB1c2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQogICAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGRvU2Nyb2xsQ2hlY2ssIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKICAgICAgICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4galF1ZXJ5OwoKICAgIH0pKCk7CgoKLy8gU3RyaW5nIHRvIE9iamVjdCBmbGFncyBmb3JtYXQgY2FjaGUKICAgIHZhciBmbGFnc0NhY2hlID0ge307CgovLyBDb252ZXJ0IFN0cmluZy1mb3JtYXR0ZWQgZmxhZ3MgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCiAgICBmdW5jdGlvbiBjcmVhdGVGbGFncyhmbGFncykgewogICAgICAgIHZhciBvYmplY3QgPSBmbGFnc0NhY2hlWyBmbGFncyBdID0ge30sCiAgICAgICAgICAgIGksIGxlbmd0aDsKICAgICAgICBmbGFncyA9IGZsYWdzLnNwbGl0KC9ccysvKTsKICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBmbGFncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBvYmplY3RbIGZsYWdzW2ldIF0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qCiAgICAgKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgICAqCiAgICAgKglmbGFnczoJYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgZmxhZ3MgdGhhdCB3aWxsIGNoYW5nZSBob3cKICAgICAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcwogICAgICoKICAgICAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAgICAgKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogICAgICoKICAgICAqIFBvc3NpYmxlIGZsYWdzOgogICAgICoKICAgICAqCW9uY2U6CQkJd2lsbCBlbnN1cmUgdGhlIGNhbGxiYWNrIGxpc3QgY2FuIG9ubHkgYmUgZmlyZWQgb25jZSAobGlrZSBhIERlZmVycmVkKQogICAgICoKICAgICAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAgICAgKgkJCQkJYWZ0ZXIgdGhlIGxpc3QgaGFzIGJlZW4gZmlyZWQgcmlnaHQgYXdheSB3aXRoIHRoZSBsYXRlc3QgIm1lbW9yaXplZCIKICAgICAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICAgICAqCiAgICAgKgl1bmlxdWU6CQkJd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAgICAgKgogICAgICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogICAgICoKICAgICAqLwogICAgalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChmbGFncykgewoKICAgICAgICAvLyBDb252ZXJ0IGZsYWdzIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkCiAgICAgICAgLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQogICAgICAgIGZsYWdzID0gZmxhZ3MgPyAoIGZsYWdzQ2FjaGVbIGZsYWdzIF0gfHwgY3JlYXRlRmxhZ3MoZmxhZ3MpICkgOiB7fTsKCiAgICAgICAgdmFyIC8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CiAgICAgICAgICAgIGxpc3QgPSBbXSwKICAgICAgICAvLyBTdGFjayBvZiBmaXJlIGNhbGxzIGZvciByZXBlYXRhYmxlIGxpc3RzCiAgICAgICAgICAgIHN0YWNrID0gW10sCiAgICAgICAgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQogICAgICAgICAgICBtZW1vcnksCiAgICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgICAgICAgICAgZmlyZWQsCiAgICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgICAgICAgICBmaXJpbmcsCiAgICAgICAgLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCiAgICAgICAgICAgIGZpcmluZ1N0YXJ0LAogICAgICAgIC8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwogICAgICAgICAgICBmaXJpbmdMZW5ndGgsCiAgICAgICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKICAgICAgICAgICAgZmlyaW5nSW5kZXgsCiAgICAgICAgLy8gQWRkIG9uZSBvciBzZXZlcmFsIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgICAgICBhZGQgPSBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICAgICAgdmFyIGksCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGVsZW0sCiAgICAgICAgICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgICAgICAgICBhY3R1YWw7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGFyZ3NbIGkgXTsKICAgICAgICAgICAgICAgICAgICB0eXBlID0galF1ZXJ5LnR5cGUoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJhcnJheSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zcGVjdCByZWN1cnNpdmVseQogICAgICAgICAgICAgICAgICAgICAgICBhZGQoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFkZCBpZiBub3QgaW4gdW5pcXVlIG1vZGUgYW5kIGNhbGxiYWNrIGlzIG5vdCBpbgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYWdzLnVuaXF1ZSB8fCAhc2VsZi5oYXMoZWxlbSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAvLyBGaXJlIGNhbGxiYWNrcwogICAgICAgICAgICBmaXJlID0gZnVuY3Rpb24gKGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICAgICAgbWVtb3J5ID0gIWZsYWdzLm1lbW9yeSB8fCBbIGNvbnRleHQsIGFyZ3MgXTsKICAgICAgICAgICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZpcmluZyA9IHRydWU7CiAgICAgICAgICAgICAgICBmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CiAgICAgICAgICAgICAgICBmaXJpbmdTdGFydCA9IDA7CiAgICAgICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAoOyBsaXN0ICYmIGZpcmluZ0luZGV4IDwgZmlyaW5nTGVuZ3RoOyBmaXJpbmdJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RbIGZpcmluZ0luZGV4IF0uYXBwbHkoY29udGV4dCwgYXJncykgPT09IGZhbHNlICYmIGZsYWdzLnN0b3BPbkZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbW9yeSA9IHRydWU7IC8vIE1hcmsgYXMgaGFsdGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZpcmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYWdzLm9uY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrICYmIHN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtb3J5ID0gc3RhY2suc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmlyZVdpdGgobWVtb3J5WyAwIF0sIG1lbW9yeVsgMSBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVtb3J5ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKICAgICAgICAgICAgc2VsZiA9IHsKICAgICAgICAgICAgICAgIC8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKICAgICAgICAgICAgICAgIGFkZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgZmlyaW5nIGJhdGNoPwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXksIHVubGVzcyBwcmV2aW91cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmlyaW5nIHdhcyBoYWx0ZWQgKHN0b3BPbkZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1lbW9yeSAmJiBtZW1vcnkgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmluZ1N0YXJ0ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZShtZW1vcnlbIDAgXSwgbWVtb3J5WyAxIF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhIGNhbGxiYWNrIGZyb20gdGhlIGxpc3QKICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnTGVuZ3RoID0gYXJncy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBhcmdJbmRleCA8IGFyZ0xlbmd0aDsgYXJnSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3NbIGFyZ0luZGV4IF0gPT09IGxpc3RbIGkgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nSW5kZXggYW5kIGZpcmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA8PSBmaXJpbmdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJpbmdMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA8PSBmaXJpbmdJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJpbmdJbmRleC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaS0tLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBzb21lIHVuaWNpdHkgcHJvcGVydHkgdGhlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBvbmx5IG5lZWQgdG8gZG8gdGhpcyBvbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFncy51bmlxdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIENvbnRyb2wgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdAogICAgICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuID09PSBsaXN0WyBpIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAogICAgICAgICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gSGF2ZSB0aGUgbGlzdCBkbyBub3RoaW5nIGFueW1vcmUKICAgICAgICAgICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gc3RhY2sgPSBtZW1vcnkgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gSXMgaXQgZGlzYWJsZWQ/CiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhbGlzdDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCiAgICAgICAgICAgICAgICBsb2NrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtZW1vcnkgfHwgbWVtb3J5ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBJcyBpdCBsb2NrZWQ/CiAgICAgICAgICAgICAgICBsb2NrZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIXN0YWNrOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICAgICAgICAgIGZpcmVXaXRoOiBmdW5jdGlvbiAoY29udGV4dCwgYXJncykgewogICAgICAgICAgICAgICAgICAgIGlmIChzdGFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYWdzLm9uY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKFsgY29udGV4dCwgYXJncyBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghKCBmbGFncy5vbmNlICYmIG1lbW9yeSApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJlKGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCiAgICAgICAgICAgICAgICBmaXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maXJlV2l0aCh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQogICAgICAgICAgICAgICAgZmlyZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gISFmaXJlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwoKCiAgICB2YXIgLy8gU3RhdGljIHJlZmVyZW5jZSB0byBzbGljZQogICAgICAgIHNsaWNlRGVmZXJyZWQgPSBbXS5zbGljZTsKCiAgICBqUXVlcnkuZXh0ZW5kKHsKCiAgICAgICAgRGVmZXJyZWQ6IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgICAgIHZhciBkb25lTGlzdCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgICAgICAgICBmYWlsTGlzdCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgICAgICAgICBwcm9ncmVzc0xpc3QgPSBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSwKICAgICAgICAgICAgICAgIHN0YXRlID0gInBlbmRpbmciLAogICAgICAgICAgICAgICAgbGlzdHMgPSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZTogZG9uZUxpc3QsCiAgICAgICAgICAgICAgICAgICAgcmVqZWN0OiBmYWlsTGlzdCwKICAgICAgICAgICAgICAgICAgICBub3RpZnk6IHByb2dyZXNzTGlzdAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByb21pc2UgPSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZTogZG9uZUxpc3QuYWRkLAogICAgICAgICAgICAgICAgICAgIGZhaWw6IGZhaWxMaXN0LmFkZCwKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogcHJvZ3Jlc3NMaXN0LmFkZCwKCiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8vIERlcHJlY2F0ZWQKICAgICAgICAgICAgICAgICAgICBpc1Jlc29sdmVkOiBkb25lTGlzdC5maXJlZCwKICAgICAgICAgICAgICAgICAgICBpc1JlamVjdGVkOiBmYWlsTGlzdC5maXJlZCwKCiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGRvbmVDYWxsYmFja3MsIGZhaWxDYWxsYmFja3MsIHByb2dyZXNzQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLmRvbmUoZG9uZUNhbGxiYWNrcykuZmFpbChmYWlsQ2FsbGJhY2tzKS5wcm9ncmVzcyhwcm9ncmVzc0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgYWx3YXlzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLmRvbmUuYXBwbHkoZGVmZXJyZWQsIGFyZ3VtZW50cykuZmFpbC5hcHBseShkZWZlcnJlZCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwaXBlOiBmdW5jdGlvbiAoZm5Eb25lLCBmbkZhaWwsIGZuUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiAobmV3RGVmZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lOiBbIGZuRG9uZSwgInJlc29sdmUiIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbDogWyBmbkZhaWwsICJyZWplY3QiIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IFsgZm5Qcm9ncmVzcywgIm5vdGlmeSIgXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGhhbmRsZXIsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBkYXRhWyAwIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IGRhdGFbIDEgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGZuKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZFsgaGFuZGxlciBdKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybmVkID0gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCAmJiBqUXVlcnkuaXNGdW5jdGlvbihyZXR1cm5lZC5wcm9taXNlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybmVkLnByb21pc2UoKS50aGVuKG5ld0RlZmVyLnJlc29sdmUsIG5ld0RlZmVyLnJlamVjdCwgbmV3RGVmZXIubm90aWZ5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXJbIGFjdGlvbiArICJXaXRoIiBdKHRoaXMgPT09IGRlZmVycmVkID8gbmV3RGVmZXIgOiB0aGlzLCBbIHJldHVybmVkIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZFsgaGFuZGxlciBdKG5ld0RlZmVyWyBhY3Rpb24gXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLnByb21pc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IHByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvbWlzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ialsga2V5IF0gPSBwcm9taXNlWyBrZXkgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZWZlcnJlZCA9IHByb21pc2UucHJvbWlzZSh7fSksCiAgICAgICAgICAgICAgICBrZXk7CgogICAgICAgICAgICBmb3IgKGtleSBpbiBsaXN0cykgewogICAgICAgICAgICAgICAgZGVmZXJyZWRbIGtleSBdID0gbGlzdHNbIGtleSBdLmZpcmU7CiAgICAgICAgICAgICAgICBkZWZlcnJlZFsga2V5ICsgIldpdGgiIF0gPSBsaXN0c1sga2V5IF0uZmlyZVdpdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhhbmRsZSBzdGF0ZQogICAgICAgICAgICBkZWZlcnJlZC5kb25lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gInJlc29sdmVkIjsKICAgICAgICAgICAgfSwgZmFpbExpc3QuZGlzYWJsZSwgcHJvZ3Jlc3NMaXN0LmxvY2spLmZhaWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gInJlamVjdGVkIjsKICAgICAgICAgICAgICAgIH0sIGRvbmVMaXN0LmRpc2FibGUsIHByb2dyZXNzTGlzdC5sb2NrKTsKCiAgICAgICAgICAgIC8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKICAgICAgICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICAgICAgICAgIGZ1bmMuY2FsbChkZWZlcnJlZCwgZGVmZXJyZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBbGwgZG9uZSEKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgICAgIH0sCgogICAgICAgIC8vIERlZmVycmVkIGhlbHBlcgogICAgICAgIHdoZW46IGZ1bmN0aW9uIChmaXJzdFBhcmFtKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2VEZWZlcnJlZC5jYWxsKGFyZ3VtZW50cywgMCksCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoLAogICAgICAgICAgICAgICAgcFZhbHVlcyA9IG5ldyBBcnJheShsZW5ndGgpLAogICAgICAgICAgICAgICAgY291bnQgPSBsZW5ndGgsCiAgICAgICAgICAgICAgICBwQ291bnQgPSBsZW5ndGgsCiAgICAgICAgICAgICAgICBkZWZlcnJlZCA9IGxlbmd0aCA8PSAxICYmIGZpcnN0UGFyYW0gJiYgalF1ZXJ5LmlzRnVuY3Rpb24oZmlyc3RQYXJhbS5wcm9taXNlKSA/CiAgICAgICAgICAgICAgICAgICAgZmlyc3RQYXJhbSA6CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSgpOwoKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmMoaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gc2xpY2VEZWZlcnJlZC5jYWxsKGFyZ3VtZW50cywgMCkgOiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoISggLS1jb3VudCApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGRlZmVycmVkLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBwcm9ncmVzc0Z1bmMoaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHBWYWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gc2xpY2VEZWZlcnJlZC5jYWxsKGFyZ3VtZW50cywgMCkgOiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKHByb21pc2UsIHBWYWx1ZXMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnc1sgaSBdICYmIGFyZ3NbIGkgXS5wcm9taXNlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGFyZ3NbIGkgXS5wcm9taXNlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhcmdzWyBpIF0ucHJvbWlzZSgpLnRoZW4ocmVzb2x2ZUZ1bmMoaSksIGRlZmVycmVkLnJlamVjdCwgcHJvZ3Jlc3NGdW5jKGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAtLWNvdW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghY291bnQpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChkZWZlcnJlZCwgYXJncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVmZXJyZWQgIT09IGZpcnN0UGFyYW0pIHsKICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGRlZmVycmVkLCBsZW5ndGggPyBbIGZpcnN0UGFyYW0gXSA6IFtdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9CiAgICB9KTsKCgogICAgalF1ZXJ5LnN1cHBvcnQgPSAoZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgc3VwcG9ydCwKICAgICAgICAgICAgYWxsLAogICAgICAgICAgICBhLAogICAgICAgICAgICBzZWxlY3QsCiAgICAgICAgICAgIG9wdCwKICAgICAgICAgICAgaW5wdXQsCiAgICAgICAgICAgIGZyYWdtZW50LAogICAgICAgICAgICB0ZHMsCiAgICAgICAgICAgIGV2ZW50cywKICAgICAgICAgICAgZXZlbnROYW1lLAogICAgICAgICAgICBpLAogICAgICAgICAgICBpc1N1cHBvcnRlZCwKICAgICAgICAgICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgLy8gUHJlbGltaW5hcnkgdGVzdHMKICAgICAgICBkaXYuc2V0QXR0cmlidXRlKCJjbGFzc05hbWUiLCAidCIpOwogICAgICAgIGRpdi5pbm5lckhUTUwgPSAiICAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJyBzdHlsZT0ndG9wOjFweDtmbG9hdDpsZWZ0O29wYWNpdHk6LjU1Oyc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoKICAgICAgICBhbGwgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKTsKICAgICAgICBhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIilbIDAgXTsKCiAgICAgICAgLy8gQ2FuJ3QgZ2V0IGJhc2ljIHRlc3Qgc3VwcG9ydAogICAgICAgIGlmICghYWxsIHx8ICFhbGwubGVuZ3RoIHx8ICFhKSB7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9CgogICAgICAgIC8vIEZpcnN0IGJhdGNoIG9mIHN1cHBvcnRzIHRlc3RzCiAgICAgICAgc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0Iik7CiAgICAgICAgb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpKTsKICAgICAgICBpbnB1dCA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVsgMCBdOwoKICAgICAgICBzdXBwb3J0ID0gewogICAgICAgICAgICAvLyBJRSBzdHJpcHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gLmlubmVySFRNTCBpcyB1c2VkCiAgICAgICAgICAgIGxlYWRpbmdXaGl0ZXNwYWNlOiAoIGRpdi5maXJzdENoaWxkLm5vZGVUeXBlID09PSAzICksCgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0Ym9keSBlbGVtZW50cyBhcmVuJ3QgYXV0b21hdGljYWxseSBpbnNlcnRlZAogICAgICAgICAgICAvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzCiAgICAgICAgICAgIHRib2R5OiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpLmxlbmd0aCwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGxpbmsgZWxlbWVudHMgZ2V0IHNlcmlhbGl6ZWQgY29ycmVjdGx5IGJ5IGlubmVySFRNTAogICAgICAgICAgICAvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCiAgICAgICAgICAgIGh0bWxTZXJpYWxpemU6ICEhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaW5rIikubGVuZ3RoLAoKICAgICAgICAgICAgLy8gR2V0IHRoZSBzdHlsZSBpbmZvcm1hdGlvbiBmcm9tIGdldEF0dHJpYnV0ZQogICAgICAgICAgICAvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWFkKQogICAgICAgICAgICBzdHlsZTogL3RvcC8udGVzdChhLmdldEF0dHJpYnV0ZSgic3R5bGUiKSksCgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBVUkxzIGFyZW4ndCBtYW5pcHVsYXRlZAogICAgICAgICAgICAvLyAoSUUgbm9ybWFsaXplcyBpdCBieSBkZWZhdWx0KQogICAgICAgICAgICBocmVmTm9ybWFsaXplZDogKCBhLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiL2EiICksCgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzCiAgICAgICAgICAgIC8vIChJRSB1c2VzIGZpbHRlciBpbnN0ZWFkKQogICAgICAgICAgICAvLyBVc2UgYSByZWdleCB0byB3b3JrIGFyb3VuZCBhIFdlYktpdCBpc3N1ZS4gU2VlICM1MTQ1CiAgICAgICAgICAgIG9wYWNpdHk6IC9eMC41NS8udGVzdChhLnN0eWxlLm9wYWNpdHkpLAoKICAgICAgICAgICAgLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQogICAgICAgICAgICAvLyAoSUUgdXNlcyBzdHlsZUZsb2F0IGluc3RlYWQgb2YgY3NzRmxvYXQpCiAgICAgICAgICAgIGNzc0Zsb2F0OiAhIWEuc3R5bGUuY3NzRmxvYXQsCgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBpZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgZm9yIGEgY2hlY2tib3gKICAgICAgICAgICAgLy8gdGhhdCBpdCBkZWZhdWx0cyB0byAib24iLgogICAgICAgICAgICAvLyAoV2ViS2l0IGRlZmF1bHRzIHRvICIiIGluc3RlYWQpCiAgICAgICAgICAgIGNoZWNrT246ICggaW5wdXQudmFsdWUgPT09ICJvbiIgKSwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGEgc2VsZWN0ZWQtYnktZGVmYXVsdCBvcHRpb24gaGFzIGEgd29ya2luZyBzZWxlY3RlZCBwcm9wZXJ0eS4KICAgICAgICAgICAgLy8gKFdlYktpdCBkZWZhdWx0cyB0byBmYWxzZSBpbnN0ZWFkIG9mIHRydWUsIElFIHRvbywgaWYgaXQncyBpbiBhbiBvcHRncm91cCkKICAgICAgICAgICAgb3B0U2VsZWN0ZWQ6IG9wdC5zZWxlY3RlZCwKCiAgICAgICAgICAgIC8vIFRlc3Qgc2V0QXR0cmlidXRlIG9uIGNhbWVsQ2FzZSBjbGFzcy4gSWYgaXQgd29ya3MsIHdlIG5lZWQgYXR0ckZpeGVzIHdoZW4gZG9pbmcgZ2V0L3NldEF0dHJpYnV0ZSAoaWU2LzcpCiAgICAgICAgICAgIGdldFNldEF0dHJpYnV0ZTogZGl2LmNsYXNzTmFtZSAhPT0gInQiLAoKICAgICAgICAgICAgLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0oIzY3NDMpCiAgICAgICAgICAgIGVuY3R5cGU6ICEhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLmVuY3R5cGUsCgogICAgICAgICAgICAvLyBNYWtlcyBzdXJlIGNsb25pbmcgYW4gaHRtbDUgZWxlbWVudCBkb2VzIG5vdCBjYXVzZSBwcm9ibGVtcwogICAgICAgICAgICAvLyBXaGVyZSBvdXRlckhUTUwgaXMgdW5kZWZpbmVkLCB0aGlzIHN0aWxsIHdvcmtzCiAgICAgICAgICAgIGh0bWw1Q2xvbmU6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm5hdiIpLmNsb25lTm9kZSh0cnVlKS5vdXRlckhUTUwgIT09ICI8Om5hdj48LzpuYXY+IiwKCiAgICAgICAgICAgIC8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgogICAgICAgICAgICBzdWJtaXRCdWJibGVzOiB0cnVlLAogICAgICAgICAgICBjaGFuZ2VCdWJibGVzOiB0cnVlLAogICAgICAgICAgICBmb2N1c2luQnViYmxlczogZmFsc2UsCiAgICAgICAgICAgIGRlbGV0ZUV4cGFuZG86IHRydWUsCiAgICAgICAgICAgIG5vQ2xvbmVFdmVudDogdHJ1ZSwKICAgICAgICAgICAgaW5saW5lQmxvY2tOZWVkc0xheW91dDogZmFsc2UsCiAgICAgICAgICAgIHNocmlua1dyYXBCbG9ja3M6IGZhbHNlLAogICAgICAgICAgICByZWxpYWJsZU1hcmdpblJpZ2h0OiB0cnVlLAogICAgICAgICAgICBwaXhlbE1hcmdpbjogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIGpRdWVyeS5ib3hNb2RlbCBERVBSRUNBVEVEIGluIDEuMywgdXNlIGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsIGluc3RlYWQKICAgICAgICBqUXVlcnkuYm94TW9kZWwgPSBzdXBwb3J0LmJveE1vZGVsID0gKGRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICJDU1MxQ29tcGF0Iik7CgogICAgICAgIC8vIE1ha2Ugc3VyZSBjaGVja2VkIHN0YXR1cyBpcyBwcm9wZXJseSBjbG9uZWQKICAgICAgICBpbnB1dC5jaGVja2VkID0gdHJ1ZTsKICAgICAgICBzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gaW5wdXQuY2xvbmVOb2RlKHRydWUpLmNoZWNrZWQ7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKICAgICAgICAvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCiAgICAgICAgc2VsZWN0LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICBzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCiAgICAgICAgLy8gVGVzdCB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkZWxldGUgYW4gZXhwYW5kbyBmcm9tIGFuIGVsZW1lbnQKICAgICAgICAvLyBGYWlscyBpbiBJbnRlcm5ldCBFeHBsb3JlcgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGRlbGV0ZSBkaXYudGVzdDsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFkaXYuYWRkRXZlbnRMaXN0ZW5lciAmJiBkaXYuYXR0YWNoRXZlbnQgJiYgZGl2LmZpcmVFdmVudCkgewogICAgICAgICAgICBkaXYuYXR0YWNoRXZlbnQoIm9uY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBDbG9uaW5nIGEgbm9kZSBzaG91bGRuJ3QgY29weSBvdmVyIGFueQogICAgICAgICAgICAgICAgLy8gYm91bmQgZXZlbnQgaGFuZGxlcnMgKElFIGRvZXMgdGhpcykKICAgICAgICAgICAgICAgIHN1cHBvcnQubm9DbG9uZUV2ZW50ID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkaXYuY2xvbmVOb2RlKHRydWUpLmZpcmVFdmVudCgib25jbGljayIpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2hlY2sgaWYgYSByYWRpbyBtYWludGFpbnMgaXRzIHZhbHVlCiAgICAgICAgLy8gYWZ0ZXIgYmVpbmcgYXBwZW5kZWQgdG8gdGhlIERPTQogICAgICAgIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICBpbnB1dC52YWx1ZSA9ICJ0IjsKICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAicmFkaW8iKTsKICAgICAgICBzdXBwb3J0LnJhZGlvVmFsdWUgPSBpbnB1dC52YWx1ZSA9PT0gInQiOwoKICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCAiY2hlY2tlZCIpOwoKICAgICAgICAvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAidCIpOwoKICAgICAgICBkaXYuYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRpdi5sYXN0Q2hpbGQpOwoKICAgICAgICAvLyBXZWJLaXQgZG9lc24ndCBjbG9uZSBjaGVja2VkIHN0YXRlIGNvcnJlY3RseSBpbiBmcmFnbWVudHMKICAgICAgICBzdXBwb3J0LmNoZWNrQ2xvbmUgPSBmcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSkuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5jaGVja2VkOwoKICAgICAgICAvLyBDaGVjayBpZiBhIGRpc2Nvbm5lY3RlZCBjaGVja2JveCB3aWxsIHJldGFpbiBpdHMgY2hlY2tlZAogICAgICAgIC8vIHZhbHVlIG9mIHRydWUgYWZ0ZXIgYXBwZW5kZWQgdG8gdGhlIERPTSAoSUU2LzcpCiAgICAgICAgc3VwcG9ydC5hcHBlbmRDaGVja2VkID0gaW5wdXQuY2hlY2tlZDsKCiAgICAgICAgZnJhZ21lbnQucmVtb3ZlQ2hpbGQoaW5wdXQpOwogICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRpdik7CgogICAgICAgIC8vIFRlY2huaXF1ZSBmcm9tIEp1cml5IFpheXRzZXYKICAgICAgICAvLyBodHRwOi8vcGVyZmVjdGlvbmtpbGxzLmNvbS9kZXRlY3RpbmctZXZlbnQtc3VwcG9ydC13aXRob3V0LWJyb3dzZXItc25pZmZpbmcvCiAgICAgICAgLy8gV2Ugb25seSBjYXJlIGFib3V0IHRoZSBjYXNlIHdoZXJlIG5vbi1zdGFuZGFyZCBldmVudCBzeXN0ZW1zCiAgICAgICAgLy8gYXJlIHVzZWQsIG5hbWVseSBpbiBJRS4gU2hvcnQtY2lyY3VpdGluZyBoZXJlIGhlbHBzIHVzIHRvCiAgICAgICAgLy8gYXZvaWQgYW4gZXZhbCBjYWxsIChpbiBzZXRBdHRyaWJ1dGUpIHdoaWNoIGNhbiBjYXVzZSBDU1AKICAgICAgICAvLyB0byBnbyBoYXl3aXJlLiBTZWU6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUAogICAgICAgIGlmIChkaXYuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgZm9yIChpIGluIHsKICAgICAgICAgICAgICAgIHN1Ym1pdDogMSwKICAgICAgICAgICAgICAgIGNoYW5nZTogMSwKICAgICAgICAgICAgICAgIGZvY3VzaW46IDEKICAgICAgICAgICAgfSkgewogICAgICAgICAgICAgICAgZXZlbnROYW1lID0gIm9uIiArIGk7CiAgICAgICAgICAgICAgICBpc1N1cHBvcnRlZCA9ICggZXZlbnROYW1lIGluIGRpdiApOwogICAgICAgICAgICAgICAgaWYgKCFpc1N1cHBvcnRlZCkgewogICAgICAgICAgICAgICAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoZXZlbnROYW1lLCAicmV0dXJuOyIpOwogICAgICAgICAgICAgICAgICAgIGlzU3VwcG9ydGVkID0gKCB0eXBlb2YgZGl2WyBldmVudE5hbWUgXSA9PT0gImZ1bmN0aW9uIiApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3VwcG9ydFsgaSArICJCdWJibGVzIiBdID0gaXNTdXBwb3J0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZyYWdtZW50LnJlbW92ZUNoaWxkKGRpdik7CgogICAgICAgIC8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKICAgICAgICBmcmFnbWVudCA9IHNlbGVjdCA9IG9wdCA9IGRpdiA9IGlucHV0ID0gbnVsbDsKCiAgICAgICAgLy8gUnVuIHRlc3RzIHRoYXQgbmVlZCBhIGJvZHkgYXQgZG9jIHJlYWR5CiAgICAgICAgalF1ZXJ5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lciwgb3V0ZXIsIGlubmVyLCB0YWJsZSwgdGQsIG9mZnNldFN1cHBvcnQsCiAgICAgICAgICAgICAgICBtYXJnaW5EaXYsIGNvbk1hcmdpblRvcCwgc3R5bGUsIGh0bWwsIHBvc2l0aW9uVG9wTGVmdFdpZHRoSGVpZ2h0LAogICAgICAgICAgICAgICAgcGFkZGluZ01hcmdpbkJvcmRlclZpc2liaWxpdHksIHBhZGRpbmdNYXJnaW5Cb3JkZXIsCiAgICAgICAgICAgICAgICBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCiAgICAgICAgICAgIGlmICghYm9keSkgewogICAgICAgICAgICAgICAgLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uTWFyZ2luVG9wID0gMTsKICAgICAgICAgICAgcGFkZGluZ01hcmdpbkJvcmRlciA9ICJwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOiI7CiAgICAgICAgICAgIHBvc2l0aW9uVG9wTGVmdFdpZHRoSGVpZ2h0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6MDt3aWR0aDoxcHg7aGVpZ2h0OjFweDsiOwogICAgICAgICAgICBwYWRkaW5nTWFyZ2luQm9yZGVyVmlzaWJpbGl0eSA9IHBhZGRpbmdNYXJnaW5Cb3JkZXIgKyAiMDt2aXNpYmlsaXR5OmhpZGRlbjsiOwogICAgICAgICAgICBzdHlsZSA9ICJzdHlsZT0nIiArIHBvc2l0aW9uVG9wTGVmdFdpZHRoSGVpZ2h0ICsgcGFkZGluZ01hcmdpbkJvcmRlciArICI1cHggc29saWQgIzAwMDsiOwogICAgICAgICAgICBodG1sID0gIjxkaXYgIiArIHN0eWxlICsgImRpc3BsYXk6YmxvY2s7Jz48ZGl2IHN0eWxlPSciICsgcGFkZGluZ01hcmdpbkJvcmRlciArICIwO2Rpc3BsYXk6YmxvY2s7b3ZlcmZsb3c6aGlkZGVuOyc+PC9kaXY+PC9kaXY+IiArCiAgICAgICAgICAgICAgICAiPHRhYmxlICIgKyBzdHlsZSArICInIGNlbGxwYWRkaW5nPScwJyBjZWxsc3BhY2luZz0nMCc+IiArCiAgICAgICAgICAgICAgICAiPHRyPjx0ZD48L3RkPjwvdHI+PC90YWJsZT4iOwoKICAgICAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gcGFkZGluZ01hcmdpbkJvcmRlclZpc2liaWxpdHkgKyAid2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjpzdGF0aWM7dG9wOjA7bWFyZ2luLXRvcDoiICsgY29uTWFyZ2luVG9wICsgInB4IjsKICAgICAgICAgICAgYm9keS5pbnNlcnRCZWZvcmUoY29udGFpbmVyLCBib2R5LmZpcnN0Q2hpbGQpOwoKICAgICAgICAgICAgLy8gQ29uc3RydWN0IHRoZSB0ZXN0IGVsZW1lbnQKICAgICAgICAgICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkaXYpOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQgd2hlbiB0aGV5IGFyZSBzZXQKICAgICAgICAgICAgLy8gdG8gZGlzcGxheTpub25lIGFuZCB0aGVyZSBhcmUgc3RpbGwgb3RoZXIgdmlzaWJsZSB0YWJsZSBjZWxscyBpbiBhCiAgICAgICAgICAgIC8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgogICAgICAgICAgICAvLyBkZXRlcm1pbmluZyBpZiBhbiBlbGVtZW50IGhhcyBiZWVuIGhpZGRlbiBkaXJlY3RseSB1c2luZwogICAgICAgICAgICAvLyBkaXNwbGF5Om5vbmUgKGl0IGlzIHN0aWxsIHNhZmUgdG8gdXNlIG9mZnNldHMgaWYgYSBwYXJlbnQgZWxlbWVudCBpcwogICAgICAgICAgICAvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCiAgICAgICAgICAgIC8vIChvbmx5IElFIDggZmFpbHMgdGhpcyB0ZXN0KQogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjx0YWJsZT48dHI+PHRkIHN0eWxlPSciICsgcGFkZGluZ01hcmdpbkJvcmRlciArICIwO2Rpc3BsYXk6bm9uZSc+PC90ZD48dGQ+dDwvdGQ+PC90cj48L3RhYmxlPiI7CiAgICAgICAgICAgIHRkcyA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGQiKTsKICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOwoKICAgICAgICAgICAgdGRzWyAwIF0uc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgICAgICB0ZHNbIDEgXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZW1wdHkgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQKICAgICAgICAgICAgLy8gKElFIDw9IDggZmFpbCB0aGlzIHRlc3QpCiAgICAgICAgICAgIHN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIGRpdiB3aXRoIGV4cGxpY2l0IHdpZHRoIGFuZCBubyBtYXJnaW4tcmlnaHQgaW5jb3JyZWN0bHkKICAgICAgICAgICAgLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiBGb3IgbW9yZQogICAgICAgICAgICAvLyBpbmZvIHNlZSBidWcgIzMzMzMKICAgICAgICAgICAgLy8gRmFpbHMgaW4gV2ViS2l0IGJlZm9yZSBGZWIgMjAxMSBuaWdodGxpZXMKICAgICAgICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgICAgICAgIGlmICh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICAgICAgbWFyZ2luRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CiAgICAgICAgICAgICAgICBtYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSAiMCI7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUud2lkdGggPSAiMnB4IjsKICAgICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChtYXJnaW5EaXYpOwogICAgICAgICAgICAgICAgc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KICAgICAgICAgICAgICAgICAgICAoIHBhcnNlSW50KCggd2luZG93LmdldENvbXB1dGVkU3R5bGUobWFyZ2luRGl2LCBudWxsKSB8fCB7IG1hcmdpblJpZ2h0OiAwIH0gKS5tYXJnaW5SaWdodCwgMTApIHx8IDAgKSA9PT0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBkaXYuc3R5bGUuem9vbSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIG5hdGl2ZWx5IGJsb2NrLWxldmVsIGVsZW1lbnRzIGFjdCBsaWtlIGlubGluZS1ibG9jawogICAgICAgICAgICAgICAgLy8gZWxlbWVudHMgd2hlbiBzZXR0aW5nIHRoZWlyIGRpc3BsYXkgdG8gJ2lubGluZScgYW5kIGdpdmluZwogICAgICAgICAgICAgICAgLy8gdGhlbSBsYXlvdXQKICAgICAgICAgICAgICAgIC8vIChJRSA8IDggZG9lcyB0aGlzKQogICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLndpZHRoID0gZGl2LnN0eWxlLnBhZGRpbmcgPSAiMXB4IjsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5ib3JkZXIgPSAwOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLnpvb20gPSAxOwogICAgICAgICAgICAgICAgc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0ID0gKCBkaXYub2Zmc2V0V2lkdGggPT09IDMgKTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBlbGVtZW50cyB3aXRoIGxheW91dCBzaHJpbmstd3JhcCB0aGVpciBjaGlsZHJlbgogICAgICAgICAgICAgICAgLy8gKElFIDYgZG9lcyB0aGlzKQogICAgICAgICAgICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLm92ZXJmbG93ID0gInZpc2libGUiOwogICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSd3aWR0aDo1cHg7Jz48L2Rpdj4iOwogICAgICAgICAgICAgICAgc3VwcG9ydC5zaHJpbmtXcmFwQmxvY2tzID0gKCBkaXYub2Zmc2V0V2lkdGggIT09IDMgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGl2LnN0eWxlLmNzc1RleHQgPSBwb3NpdGlvblRvcExlZnRXaWR0aEhlaWdodCArIHBhZGRpbmdNYXJnaW5Cb3JkZXJWaXNpYmlsaXR5OwogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAgICAgICAgIG91dGVyID0gZGl2LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlubmVyID0gb3V0ZXIuZmlyc3RDaGlsZDsKICAgICAgICAgICAgdGQgPSBvdXRlci5uZXh0U2libGluZy5maXJzdENoaWxkLmZpcnN0Q2hpbGQ7CgogICAgICAgICAgICBvZmZzZXRTdXBwb3J0ID0gewogICAgICAgICAgICAgICAgZG9lc05vdEFkZEJvcmRlcjogKCBpbm5lci5vZmZzZXRUb3AgIT09IDUgKSwKICAgICAgICAgICAgICAgIGRvZXNBZGRCb3JkZXJGb3JUYWJsZUFuZENlbGxzOiAoIHRkLm9mZnNldFRvcCA9PT0gNSApCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpbm5lci5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgICAgICAgICAgIGlubmVyLnN0eWxlLnRvcCA9ICIyMHB4IjsKCiAgICAgICAgICAgIC8vIHNhZmFyaSBzdWJ0cmFjdHMgcGFyZW50IGJvcmRlciB3aWR0aCBoZXJlIHdoaWNoIGlzIDVweAogICAgICAgICAgICBvZmZzZXRTdXBwb3J0LmZpeGVkUG9zaXRpb24gPSAoIGlubmVyLm9mZnNldFRvcCA9PT0gMjAgfHwgaW5uZXIub2Zmc2V0VG9wID09PSAxNSApOwogICAgICAgICAgICBpbm5lci5zdHlsZS5wb3NpdGlvbiA9IGlubmVyLnN0eWxlLnRvcCA9ICIiOwoKICAgICAgICAgICAgb3V0ZXIuc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgICAgICAgICAgb3V0ZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoKICAgICAgICAgICAgb2Zmc2V0U3VwcG9ydC5zdWJ0cmFjdHNCb3JkZXJGb3JPdmVyZmxvd05vdFZpc2libGUgPSAoIGlubmVyLm9mZnNldFRvcCA9PT0gLTUgKTsKICAgICAgICAgICAgb2Zmc2V0U3VwcG9ydC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCA9ICggYm9keS5vZmZzZXRUb3AgIT09IGNvbk1hcmdpblRvcCApOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUubWFyZ2luVG9wID0gIjElIjsKICAgICAgICAgICAgICAgIHN1cHBvcnQucGl4ZWxNYXJnaW4gPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRpdiwgbnVsbCkgfHwgeyBtYXJnaW5Ub3A6IDAgfSApLm1hcmdpblRvcCAhPT0gIjElIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250YWluZXIuc3R5bGUuem9vbSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS56b29tID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwogICAgICAgICAgICBtYXJnaW5EaXYgPSBkaXYgPSBjb250YWluZXIgPSBudWxsOwoKICAgICAgICAgICAgalF1ZXJ5LmV4dGVuZChzdXBwb3J0LCBvZmZzZXRTdXBwb3J0KTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHN1cHBvcnQ7CiAgICB9KSgpOwoKCiAgICB2YXIgcmJyYWNlID0gL14oPzpcey4qXH18XFsuKlxdKSQvLAogICAgICAgIHJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwoKICAgIGpRdWVyeS5leHRlbmQoewogICAgICAgIGNhY2hlOiB7fSwKCiAgICAgICAgLy8gUGxlYXNlIHVzZSB3aXRoIGNhdXRpb24KICAgICAgICB1dWlkOiAwLAoKICAgICAgICAvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKICAgICAgICAvLyBOb24tZGlnaXRzIHJlbW92ZWQgdG8gbWF0Y2ggcmlubGluZWpRdWVyeQogICAgICAgIGV4cGFuZG86ICJqUXVlcnkiICsgKCBqUXVlcnkuZm4uanF1ZXJ5ICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoL1xEL2csICIiKSwKCiAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBlbGVtZW50cyB0aHJvdyB1bmNhdGNoYWJsZSBleGNlcHRpb25zIGlmIHlvdQogICAgICAgIC8vIGF0dGVtcHQgdG8gYWRkIGV4cGFuZG8gcHJvcGVydGllcyB0byB0aGVtLgogICAgICAgIG5vRGF0YTogewogICAgICAgICAgICAiZW1iZWQiOiB0cnVlLAogICAgICAgICAgICAvLyBCYW4gYWxsIG9iamVjdHMgZXhjZXB0IGZvciBGbGFzaCAod2hpY2ggaGFuZGxlIGV4cGFuZG9zKQogICAgICAgICAgICAib2JqZWN0IjogImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIsCiAgICAgICAgICAgICJhcHBsZXQiOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgaGFzRGF0YTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgZWxlbSA9IGVsZW0ubm9kZVR5cGUgPyBqUXVlcnkuY2FjaGVbIGVsZW1balF1ZXJ5LmV4cGFuZG9dIF0gOiBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwogICAgICAgICAgICByZXR1cm4gISFlbGVtICYmICFpc0VtcHR5RGF0YU9iamVjdChlbGVtKTsKICAgICAgICB9LAoKICAgICAgICBkYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSwgcHZ0IC8qIEludGVybmFsIFVzZSBPbmx5ICovKSB7CiAgICAgICAgICAgIGlmICghalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHByaXZhdGVDYWNoZSwgdGhpc0NhY2hlLCByZXQsCiAgICAgICAgICAgICAgICBpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAogICAgICAgICAgICAgICAgZ2V0QnlOYW1lID0gdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciLAoKICAgICAgICAgICAgLy8gV2UgaGF2ZSB0byBoYW5kbGUgRE9NIG5vZGVzIGFuZCBKUyBvYmplY3RzIGRpZmZlcmVudGx5IGJlY2F1c2UgSUU2LTcKICAgICAgICAgICAgLy8gY2FuJ3QgR0Mgb2JqZWN0IHJlZmVyZW5jZXMgcHJvcGVybHkgYWNyb3NzIHRoZSBET00tSlMgYm91bmRhcnkKICAgICAgICAgICAgICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgICAgICAgICAvLyBPbmx5IERPTSBub2RlcyBuZWVkIHRoZSBnbG9iYWwgalF1ZXJ5IGNhY2hlOyBKUyBvYmplY3QgZGF0YSBpcwogICAgICAgICAgICAvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgb2JqZWN0IHNvIEdDIGNhbiBvY2N1ciBhdXRvbWF0aWNhbGx5CiAgICAgICAgICAgICAgICBjYWNoZSA9IGlzTm9kZSA/IGpRdWVyeS5jYWNoZSA6IGVsZW0sCgogICAgICAgICAgICAvLyBPbmx5IGRlZmluaW5nIGFuIElEIGZvciBKUyBvYmplY3RzIGlmIGl0cyBjYWNoZSBhbHJlYWR5IGV4aXN0cyBhbGxvd3MKICAgICAgICAgICAgLy8gdGhlIGNvZGUgdG8gc2hvcnRjdXQgb24gdGhlIHNhbWUgcGF0aCBhcyBhIERPTSBub2RlIHdpdGggbm8gY2FjaGUKICAgICAgICAgICAgICAgIGlkID0gaXNOb2RlID8gZWxlbVsgaW50ZXJuYWxLZXkgXSA6IGVsZW1bIGludGVybmFsS2V5IF0gJiYgaW50ZXJuYWxLZXksCiAgICAgICAgICAgICAgICBpc0V2ZW50cyA9IG5hbWUgPT09ICJldmVudHMiOwoKICAgICAgICAgICAgLy8gQXZvaWQgZG9pbmcgYW55IG1vcmUgd29yayB0aGFuIHdlIG5lZWQgdG8gd2hlbiB0cnlpbmcgdG8gZ2V0IGRhdGEgb24gYW4KICAgICAgICAgICAgLy8gb2JqZWN0IHRoYXQgaGFzIG5vIGRhdGEgYXQgYWxsCiAgICAgICAgICAgIGlmICgoIWlkIHx8ICFjYWNoZVtpZF0gfHwgKCFpc0V2ZW50cyAmJiAhcHZ0ICYmICFjYWNoZVtpZF0uZGF0YSkpICYmIGdldEJ5TmFtZSAmJiBkYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFpZCkgewogICAgICAgICAgICAgICAgLy8gT25seSBET00gbm9kZXMgbmVlZCBhIG5ldyB1bmlxdWUgSUQgZm9yIGVhY2ggZWxlbWVudCBzaW5jZSB0aGVpciBkYXRhCiAgICAgICAgICAgICAgICAvLyBlbmRzIHVwIGluIHRoZSBnbG9iYWwgY2FjaGUKICAgICAgICAgICAgICAgIGlmIChpc05vZGUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtWyBpbnRlcm5hbEtleSBdID0gaWQgPSArK2pRdWVyeS51dWlkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZCA9IGludGVybmFsS2V5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWNhY2hlWyBpZCBdKSB7CiAgICAgICAgICAgICAgICBjYWNoZVsgaWQgXSA9IHt9OwoKICAgICAgICAgICAgICAgIC8vIEF2b2lkcyBleHBvc2luZyBqUXVlcnkgbWV0YWRhdGEgb24gcGxhaW4gSlMgb2JqZWN0cyB3aGVuIHRoZSBvYmplY3QKICAgICAgICAgICAgICAgIC8vIGlzIHNlcmlhbGl6ZWQgdXNpbmcgSlNPTi5zdHJpbmdpZnkKICAgICAgICAgICAgICAgIGlmICghaXNOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FjaGVbIGlkIF0udG9KU09OID0galF1ZXJ5Lm5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFuIG9iamVjdCBjYW4gYmUgcGFzc2VkIHRvIGpRdWVyeS5kYXRhIGluc3RlYWQgb2YgYSBrZXkvdmFsdWUgcGFpcjsgdGhpcyBnZXRzCiAgICAgICAgICAgIC8vIHNoYWxsb3cgY29waWVkIG92ZXIgb250byB0aGUgZXhpc3RpbmcgY2FjaGUKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IiB8fCB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWYgKHB2dCkgewogICAgICAgICAgICAgICAgICAgIGNhY2hlWyBpZCBdID0galF1ZXJ5LmV4dGVuZChjYWNoZVsgaWQgXSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNhY2hlWyBpZCBdLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKGNhY2hlWyBpZCBdLmRhdGEsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBwcml2YXRlQ2FjaGUgPSB0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsKCiAgICAgICAgICAgIC8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQogICAgICAgICAgICAvLyBjYWNoZSBpbiBvcmRlciB0byBhdm9pZCBrZXkgY29sbGlzaW9ucyBiZXR3ZWVuIGludGVybmFsIGRhdGEgYW5kIHVzZXItZGVmaW5lZAogICAgICAgICAgICAvLyBkYXRhLgogICAgICAgICAgICBpZiAoIXB2dCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzQ2FjaGUuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoaXNDYWNoZS5kYXRhID0ge307CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpc0NhY2hlID0gdGhpc0NhY2hlLmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZShuYW1lKSBdID0gZGF0YTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXNlcnMgc2hvdWxkIG5vdCBhdHRlbXB0IHRvIGluc3BlY3QgdGhlIGludGVybmFsIGV2ZW50cyBvYmplY3QgdXNpbmcgalF1ZXJ5LmRhdGEsCiAgICAgICAgICAgIC8vIGl0IGlzIHVuZG9jdW1lbnRlZCBhbmQgc3ViamVjdCB0byBjaGFuZ2UuIEJ1dCBkb2VzIGFueW9uZSBsaXN0ZW4/IE5vLgogICAgICAgICAgICBpZiAoaXNFdmVudHMgJiYgIXRoaXNDYWNoZVsgbmFtZSBdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJpdmF0ZUNhY2hlLmV2ZW50czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGJvdGggY29udmVydGVkLXRvLWNhbWVsIGFuZCBub24tY29udmVydGVkIGRhdGEgcHJvcGVydHkgbmFtZXMKICAgICAgICAgICAgLy8gSWYgYSBkYXRhIHByb3BlcnR5IHdhcyBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGdldEJ5TmFtZSkgewoKICAgICAgICAgICAgICAgIC8vIEZpcnN0IFRyeSB0byBmaW5kIGFzLWlzIHByb3BlcnR5IGRhdGEKICAgICAgICAgICAgICAgIHJldCA9IHRoaXNDYWNoZVsgbmFtZSBdOwoKICAgICAgICAgICAgICAgIC8vIFRlc3QgZm9yIG51bGx8dW5kZWZpbmVkIHByb3BlcnR5IGRhdGEKICAgICAgICAgICAgICAgIGlmIChyZXQgPT0gbnVsbCkgewoKICAgICAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmluZCB0aGUgY2FtZWxDYXNlZCBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZShuYW1lKSBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0ID0gdGhpc0NhY2hlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8pIHsKICAgICAgICAgICAgaWYgKCFqUXVlcnkuYWNjZXB0RGF0YShlbGVtKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdGhpc0NhY2hlLCBpLCBsLAoKICAgICAgICAgICAgLy8gUmVmZXJlbmNlIHRvIGludGVybmFsIGRhdGEgY2FjaGUga2V5CiAgICAgICAgICAgICAgICBpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAoKICAgICAgICAgICAgICAgIGlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgogICAgICAgICAgICAvLyBTZWUgalF1ZXJ5LmRhdGEgZm9yIG1vcmUgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgIGNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCiAgICAgICAgICAgIC8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgaWQgPSBpc05vZGUgPyBlbGVtWyBpbnRlcm5hbEtleSBdIDogaW50ZXJuYWxLZXk7CgogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbHJlYWR5IG5vIGNhY2hlIGVudHJ5IGZvciB0aGlzIG9iamVjdCwgdGhlcmUgaXMgbm8KICAgICAgICAgICAgLy8gcHVycG9zZSBpbiBjb250aW51aW5nCiAgICAgICAgICAgIGlmICghY2FjaGVbIGlkIF0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKCiAgICAgICAgICAgICAgICB0aGlzQ2FjaGUgPSBwdnQgPyBjYWNoZVsgaWQgXSA6IGNhY2hlWyBpZCBdLmRhdGE7CgogICAgICAgICAgICAgICAgaWYgKHRoaXNDYWNoZSkgewoKICAgICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgbmFtZXMgZm9yIGRhdGEga2V5cwogICAgICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5LmlzQXJyYXkobmFtZSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lIGluIHRoaXNDYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IFsgbmFtZSBdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNwbGl0IHRoZSBjYW1lbCBjYXNlZCB2ZXJzaW9uIGJ5IHNwYWNlcyB1bmxlc3MgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSBpbiB0aGlzQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gWyBuYW1lIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBkYXRhIGxlZnQgaW4gdGhlIGNhY2hlLCB3ZSB3YW50IHRvIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGxldCB0aGUgY2FjaGUgb2JqZWN0IGl0c2VsZiBnZXQgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoIHB2dCA/IGlzRW1wdHlEYXRhT2JqZWN0IDogalF1ZXJ5LmlzRW1wdHlPYmplY3QgKSh0aGlzQ2FjaGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICAgICAgICBpZiAoIXB2dCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlWyBpZCBdLmRhdGE7CgogICAgICAgICAgICAgICAgLy8gRG9uJ3QgZGVzdHJveSB0aGUgcGFyZW50IGNhY2hlIHVubGVzcyB0aGUgaW50ZXJuYWwgZGF0YSBvYmplY3QKICAgICAgICAgICAgICAgIC8vIGhhZCBiZWVuIHRoZSBvbmx5IHRoaW5nIGxlZnQgaW4gaXQKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eURhdGFPYmplY3QoY2FjaGVbIGlkIF0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCcm93c2VycyB0aGF0IGZhaWwgZXhwYW5kbyBkZWxldGlvbiBhbHNvIHJlZnVzZSB0byBkZWxldGUgZXhwYW5kb3Mgb24KICAgICAgICAgICAgLy8gdGhlIHdpbmRvdywgYnV0IGl0IHdpbGwgYWxsb3cgaXQgb24gYWxsIG90aGVyIEpTIG9iamVjdHM7IG90aGVyIGJyb3dzZXJzCiAgICAgICAgICAgIC8vIGRvbid0IGNhcmUKICAgICAgICAgICAgLy8gRW5zdXJlIHRoYXQgYGNhY2hlYCBpcyBub3QgYSB3aW5kb3cgb2JqZWN0ICMxMDA4MAogICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbyB8fCAhY2FjaGUuc2V0SW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVsgaWQgXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNhY2hlWyBpZCBdID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gV2UgZGVzdHJveWVkIHRoZSBjYWNoZSBhbmQgbmVlZCB0byBlbGltaW5hdGUgdGhlIGV4cGFuZG8gb24gdGhlIG5vZGUgdG8gYXZvaWQKICAgICAgICAgICAgLy8gZmFsc2UgbG9va3VwcyBpbiB0aGUgY2FjaGUgZm9yIGVudHJpZXMgdGhhdCBubyBsb25nZXIgZXhpc3QKICAgICAgICAgICAgaWYgKGlzTm9kZSkgewogICAgICAgICAgICAgICAgLy8gSUUgZG9lcyBub3QgYWxsb3cgdXMgdG8gZGVsZXRlIGV4cGFuZG8gcHJvcGVydGllcyBmcm9tIG5vZGVzLAogICAgICAgICAgICAgICAgLy8gbm9yIGRvZXMgaXQgaGF2ZSBhIHJlbW92ZUF0dHJpYnV0ZSBmdW5jdGlvbiBvbiBEb2N1bWVudCBub2RlczsKICAgICAgICAgICAgICAgIC8vIHdlIG11c3QgaGFuZGxlIGFsbCBvZiB0aGVzZSBjYXNlcwogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG8pIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbVsgaW50ZXJuYWxLZXkgXTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbS5yZW1vdmVBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShpbnRlcm5hbEtleSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVsZW1bIGludGVybmFsS2V5IF0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgICAgIF9kYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmRhdGEoZWxlbSwgbmFtZSwgZGF0YSwgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQSBtZXRob2QgZm9yIGRldGVybWluaW5nIGlmIGEgRE9NIG5vZGUgY2FuIGhhbmRsZSB0aGUgZGF0YSBleHBhbmRvCiAgICAgICAgYWNjZXB0RGF0YTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGpRdWVyeS5ub0RhdGFbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhKG1hdGNoID09PSB0cnVlIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzc2lkIikgIT09IG1hdGNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfSk7CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgZGF0YTogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhcnRzLCBwYXJ0LCBhdHRyLCBuYW1lLCBsLAogICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwoKICAgICAgICAgICAgLy8gR2V0cyBhbGwgdmFsdWVzCiAgICAgICAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGpRdWVyeS5kYXRhKGVsZW0pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhalF1ZXJ5Ll9kYXRhKGVsZW0sICJwYXJzZWRBdHRycyIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIgPSBlbGVtLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobCA9IGF0dHIubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gYXR0cltpXS5uYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoImRhdGEtIikgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShuYW1lLnN1YnN0cmluZyg1KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFBdHRyKGVsZW0sIG5hbWUsIGRhdGFbIG5hbWUgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sICJwYXJzZWRBdHRycyIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZGF0YSh0aGlzLCBrZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBhcnRzID0ga2V5LnNwbGl0KCIuIiwgMik7CiAgICAgICAgICAgIHBhcnRzWzFdID0gcGFydHNbMV0gPyAiLiIgKyBwYXJ0c1sxXSA6ICIiOwogICAgICAgICAgICBwYXJ0ID0gcGFydHNbMV0gKyAiISI7CgogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLnRyaWdnZXJIYW5kbGVyKCJnZXREYXRhIiArIHBhcnQsIFsgcGFydHNbMF0gXSk7CgogICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmZXRjaCBhbnkgaW50ZXJuYWxseSBzdG9yZWQgZGF0YSBmaXJzdAogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0galF1ZXJ5LmRhdGEoZWxlbSwga2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGFBdHRyKGVsZW0sIGtleSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkICYmIHBhcnRzWzFdID8KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhKHBhcnRzWzBdKSA6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcGFydHNbMV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgogICAgICAgICAgICAgICAgICAgIHNlbGYudHJpZ2dlckhhbmRsZXIoInNldERhdGEiICsgcGFydCwgcGFydHMpOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kYXRhKHRoaXMsIGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIHNlbGYudHJpZ2dlckhhbmRsZXIoImNoYW5nZURhdGEiICsgcGFydCwgcGFydHMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YSh0aGlzLCBrZXkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgICAgICAvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CiAgICAgICAgLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCiAgICAgICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CgogICAgICAgICAgICB2YXIgbmFtZSA9ICJkYXRhLSIgKyBrZXkucmVwbGFjZShybXVsdGlEYXNoLCAiLSQxIikudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgIGRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmlzTnVtZXJpYyhkYXRhKSA/ICtkYXRhIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmJyYWNlLnRlc3QoZGF0YSkgPyBqUXVlcnkucGFyc2VKU09OKGRhdGEpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIHNldCB0aGUgZGF0YSBzbyBpdCBpc24ndCBjaGFuZ2VkIGxhdGVyCiAgICAgICAgICAgICAgICBqUXVlcnkuZGF0YShlbGVtLCBrZXksIGRhdGEpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhOwogICAgfQoKLy8gY2hlY2tzIGEgY2FjaGUgb2JqZWN0IGZvciBlbXB0aW5lc3MKICAgIGZ1bmN0aW9uIGlzRW1wdHlEYXRhT2JqZWN0KG9iaikgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4gb2JqKSB7CgogICAgICAgICAgICAvLyBpZiB0aGUgcHVibGljIGRhdGEgb2JqZWN0IGlzIGVtcHR5LCB0aGUgcHJpdmF0ZSBpcyBzdGlsbCBlbXB0eQogICAgICAgICAgICBpZiAobmFtZSA9PT0gImRhdGEiICYmIGpRdWVyeS5pc0VtcHR5T2JqZWN0KG9ialtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuYW1lICE9PSAidG9KU09OIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCgogICAgZnVuY3Rpb24gaGFuZGxlUXVldWVNYXJrRGVmZXIoZWxlbSwgdHlwZSwgc3JjKSB7CiAgICAgICAgdmFyIGRlZmVyRGF0YUtleSA9IHR5cGUgKyAiZGVmZXIiLAogICAgICAgICAgICBxdWV1ZURhdGFLZXkgPSB0eXBlICsgInF1ZXVlIiwKICAgICAgICAgICAgbWFya0RhdGFLZXkgPSB0eXBlICsgIm1hcmsiLAogICAgICAgICAgICBkZWZlciA9IGpRdWVyeS5fZGF0YShlbGVtLCBkZWZlckRhdGFLZXkpOwogICAgICAgIGlmIChkZWZlciAmJgogICAgICAgICAgICAoIHNyYyA9PT0gInF1ZXVlIiB8fCAhalF1ZXJ5Ll9kYXRhKGVsZW0sIHF1ZXVlRGF0YUtleSkgKSAmJgogICAgICAgICAgICAoIHNyYyA9PT0gIm1hcmsiIHx8ICFqUXVlcnkuX2RhdGEoZWxlbSwgbWFya0RhdGFLZXkpICkpIHsKICAgICAgICAgICAgLy8gR2l2ZSByb29tIGZvciBoYXJkLWNvZGVkIGNhbGxiYWNrcyB0byBmaXJlIGZpcnN0CiAgICAgICAgICAgIC8vIGFuZCBldmVudHVhbGx5IG1hcmsvcXVldWUgc29tZXRoaW5nIGVsc2Ugb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5fZGF0YShlbGVtLCBxdWV1ZURhdGFLZXkpICYmICFqUXVlcnkuX2RhdGEoZWxlbSwgbWFya0RhdGFLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoZWxlbSwgZGVmZXJEYXRhS2V5LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBkZWZlci5maXJlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgIH0KCiAgICBqUXVlcnkuZXh0ZW5kKHsKCiAgICAgICAgX21hcms6IGZ1bmN0aW9uIChlbGVtLCB0eXBlKSB7CiAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJtYXJrIjsKICAgICAgICAgICAgICAgIGpRdWVyeS5fZGF0YShlbGVtLCB0eXBlLCAoalF1ZXJ5Ll9kYXRhKGVsZW0sIHR5cGUpIHx8IDApICsgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfdW5tYXJrOiBmdW5jdGlvbiAoZm9yY2UsIGVsZW0sIHR5cGUpIHsKICAgICAgICAgICAgaWYgKGZvcmNlICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gZWxlbTsKICAgICAgICAgICAgICAgIGVsZW0gPSBmb3JjZTsKICAgICAgICAgICAgICAgIGZvcmNlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdHlwZSArICJtYXJrIiwKICAgICAgICAgICAgICAgICAgICBjb3VudCA9IGZvcmNlID8gMCA6ICggKGpRdWVyeS5fZGF0YShlbGVtLCBrZXkpIHx8IDEpIC0gMSApOwogICAgICAgICAgICAgICAgaWYgKGNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sIGtleSwgY291bnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCBrZXksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZVF1ZXVlTWFya0RlZmVyKGVsZW0sIHR5cGUsICJtYXJrIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGRhdGEpIHsKICAgICAgICAgICAgdmFyIHE7CiAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7CiAgICAgICAgICAgICAgICBxID0galF1ZXJ5Ll9kYXRhKGVsZW0sIHR5cGUpOwoKICAgICAgICAgICAgICAgIC8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFxIHx8IGpRdWVyeS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHEgPSBqUXVlcnkuX2RhdGEoZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcS5wdXNoKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBxIHx8IFtdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZGVxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUpIHsKICAgICAgICAgICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICAgICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZShlbGVtLCB0eXBlKSwKICAgICAgICAgICAgICAgIGZuID0gcXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgIGhvb2tzID0ge307CgogICAgICAgICAgICAvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsCiAgICAgICAgICAgIGlmIChmbiA9PT0gImlucHJvZ3Jlc3MiKSB7CiAgICAgICAgICAgICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZwogICAgICAgICAgICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS51bnNoaWZ0KCJpbnByb2dyZXNzIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sIHR5cGUgKyAiLnJ1biIsIGhvb2tzKTsKICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKGVsZW0sIHR5cGUpOwogICAgICAgICAgICAgICAgfSwgaG9va3MpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoZWxlbSwgdHlwZSArICJxdWV1ZSAiICsgdHlwZSArICIucnVuIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBoYW5kbGVRdWV1ZU1hcmtEZWZlcihlbGVtLCB0eXBlLCAicXVldWUiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIHF1ZXVlOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICAgICAgICB2YXIgc2V0dGVyID0gMjsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGRhdGEgPSB0eXBlOwogICAgICAgICAgICAgICAgdHlwZSA9ICJmeCI7CiAgICAgICAgICAgICAgICBzZXR0ZXItLTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCBzZXR0ZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkucXVldWUodGhpc1swXSwgdHlwZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBkYXRhID09PSB1bmRlZmluZWQgPwogICAgICAgICAgICAgICAgdGhpcyA6CiAgICAgICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBkYXRhKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIikgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGRlcXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgogICAgICAgIC8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KICAgICAgICBkZWxheTogZnVuY3Rpb24gKHRpbWUsIHR5cGUpIHsKICAgICAgICAgICAgdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKICAgICAgICAgICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUsIGZ1bmN0aW9uIChuZXh0LCBob29rcykgewogICAgICAgICAgICAgICAgdmFyIHRpbWVvdXQgPSBzZXRUaW1lb3V0KG5leHQsIHRpbWUpOwogICAgICAgICAgICAgICAgaG9va3Muc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGNsZWFyUXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUgfHwgImZ4IiwgW10pOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQogICAgICAgIC8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQogICAgICAgIHByb21pc2U6IGZ1bmN0aW9uICh0eXBlLCBvYmplY3QpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHR5cGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKICAgICAgICAgICAgdmFyIGRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgICAgICAgICBlbGVtZW50cyA9IHRoaXMsCiAgICAgICAgICAgICAgICBpID0gZWxlbWVudHMubGVuZ3RoLAogICAgICAgICAgICAgICAgY291bnQgPSAxLAogICAgICAgICAgICAgICAgZGVmZXJEYXRhS2V5ID0gdHlwZSArICJkZWZlciIsCiAgICAgICAgICAgICAgICBxdWV1ZURhdGFLZXkgPSB0eXBlICsgInF1ZXVlIiwKICAgICAgICAgICAgICAgIG1hcmtEYXRhS2V5ID0gdHlwZSArICJtYXJrIiwKICAgICAgICAgICAgICAgIHRtcDsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlc29sdmUoKSB7CiAgICAgICAgICAgICAgICBpZiAoISggLS1jb3VudCApKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZVdpdGgoZWxlbWVudHMsIFsgZWxlbWVudHMgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmICgoIHRtcCA9IGpRdWVyeS5kYXRhKGVsZW1lbnRzWyBpIF0sIGRlZmVyRGF0YUtleSwgdW5kZWZpbmVkLCB0cnVlKSB8fAogICAgICAgICAgICAgICAgICAgICggalF1ZXJ5LmRhdGEoZWxlbWVudHNbIGkgXSwgcXVldWVEYXRhS2V5LCB1bmRlZmluZWQsIHRydWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kYXRhKGVsZW1lbnRzWyBpIF0sIG1hcmtEYXRhS2V5LCB1bmRlZmluZWQsIHRydWUpICkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRhdGEoZWxlbWVudHNbIGkgXSwgZGVmZXJEYXRhS2V5LCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCB0cnVlKSApKSB7CiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgICAgICB0bXAuYWRkKHJlc29sdmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqZWN0KTsKICAgICAgICB9CiAgICB9KTsKCgogICAgdmFyIHJjbGFzcyA9IC9bXG5cdFxyXS9nLAogICAgICAgIHJzcGFjZSA9IC9ccysvLAogICAgICAgIHJyZXR1cm4gPSAvXHIvZywKICAgICAgICBydHlwZSA9IC9eKD86YnV0dG9ufGlucHV0KSQvaSwKICAgICAgICByZm9jdXNhYmxlID0gL14oPzpidXR0b258aW5wdXR8b2JqZWN0fHNlbGVjdHx0ZXh0YXJlYSkkL2ksCiAgICAgICAgcmNsaWNrYWJsZSA9IC9eYSg/OnJlYSk/JC9pLAogICAgICAgIHJib29sZWFuID0gL14oPzphdXRvZm9jdXN8YXV0b3BsYXl8YXN5bmN8Y2hlY2tlZHxjb250cm9sc3xkZWZlcnxkaXNhYmxlZHxoaWRkZW58bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZHxzZWxlY3RlZCkkL2ksCiAgICAgICAgZ2V0U2V0QXR0cmlidXRlID0galF1ZXJ5LnN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlLAogICAgICAgIG5vZGVIb29rLCBib29sSG9vaywgZml4U3BlY2lmaWVkOwoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIGF0dHI6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKHRoaXMsIG5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwcm9wOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3ModGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyB0cnkvY2F0Y2ggaGFuZGxlcyBjYXNlcyB3aGVyZSBJRSBiYWxrcyAoc3VjaCBhcyByZW1vdmluZyBhIHByb3BlcnR5IG9uIHdpbmRvdykKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzWyBuYW1lIF07CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZXMsIGksIGwsIGVsZW0sCiAgICAgICAgICAgICAgICBzZXRDbGFzcywgYywgY2w7CgogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLmFkZENsYXNzKHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KHJzcGFjZSk7CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtLmNsYXNzTmFtZSAmJiBjbGFzc05hbWVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRDbGFzcyA9ICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoYyA9IDAsIGNsID0gY2xhc3NOYW1lcy5sZW5ndGg7IGMgPCBjbDsgYysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF+c2V0Q2xhc3MuaW5kZXhPZigiICIgKyBjbGFzc05hbWVzWyBjIF0gKyAiICIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldENsYXNzICs9IGNsYXNzTmFtZXNbIGMgXSArICIgIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKHNldENsYXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICB2YXIgY2xhc3NOYW1lcywgaSwgbCwgZWxlbSwgY2xhc3NOYW1lLCBjLCBjbDsKCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykucmVtb3ZlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lcyA9ICggdmFsdWUgfHwgIiIgKS5zcGxpdChyc3BhY2UpOwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGVsZW0gPSB0aGlzWyBpIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxICYmIGVsZW0uY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoYyA9IDAsIGNsID0gY2xhc3NOYW1lcy5sZW5ndGg7IGMgPCBjbDsgYysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UoIiAiICsgY2xhc3NOYW1lc1sgYyBdICsgIiAiLCAiICIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSBqUXVlcnkudHJpbShjbGFzc05hbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uY2xhc3NOYW1lID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAodmFsdWUsIHN0YXRlVmFsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlLAogICAgICAgICAgICAgICAgaXNCb29sID0gdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiI7CgogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLnRvZ2dsZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKICAgICAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZiA9IGpRdWVyeSh0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KHJzcGFjZSk7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlICgoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBlcmF0ZWQgbGlzdAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IGlzQm9vbCA/IHN0YXRlIDogIXNlbGYuaGFzQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZlsgc3RhdGUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gdG9nZ2xlIHdob2xlIGNsYXNzTmFtZQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEodGhpcywgIl9fY2xhc3NOYW1lX18iKSB8fCAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gIiAiICsgc2VsZWN0b3IgKyAiICIsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZihjbGFzc05hbWUpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIHZhbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLAogICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbMF07CgogICAgICAgICAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sICJ2YWx1ZSIpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXQgPSBlbGVtLnZhbHVlOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHJldCA9PT0gInN0cmluZyIgPwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCiAgICAgICAgICAgICAgICAgICAgICAgIHJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgogICAgICAgICAgICAgICAgICAgICAgICByZXQgPT0gbnVsbCA/ICIiIDogcmV0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpLCB2YWw7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYudmFsKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwogICAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9ICIiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChqUXVlcnkuaXNBcnJheSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1sgdGhpcy50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCiAgICAgICAgICAgICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICAgICAgICAgICAgaWYgKCFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQodGhpcywgdmFsLCAidmFsdWUiKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgogICAgalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgdmFsSG9va3M6IHsKICAgICAgICAgICAgb3B0aW9uOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYXR0cmlidXRlcy52YWx1ZSBpcyB1bmRlZmluZWQgaW4gQmxhY2tiZXJyeSA0LjcgYnV0CiAgICAgICAgICAgICAgICAgICAgLy8gdXNlcyAudmFsdWUuIFNlZSAjNjkzMgogICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBlbGVtLmF0dHJpYnV0ZXMudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICF2YWwgfHwgdmFsLnNwZWNpZmllZCA/IGVsZW0udmFsdWUgOiBlbGVtLnRleHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlbGVjdDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgaSwgbWF4LCBvcHRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSI7CgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGhpbmcgd2FzIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKICAgICAgICAgICAgICAgICAgICBpID0gb25lID8gaW5kZXggOiAwOwogICAgICAgICAgICAgICAgICAgIG1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgcmV0dXJuIG9wdGlvbnMgdGhhdCBhcmUgZGlzYWJsZWQgb3IgaW4gYSBkaXNhYmxlZCBvcHRncm91cAogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkICYmIChqUXVlcnkuc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09PSBudWxsKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiKSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGpRdWVyeShvcHRpb24pLnZhbCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEZpeGVzIEJ1ZyAjMjU1MSAtLSBzZWxlY3QudmFsKCkgYnJva2VuIGluIElFIGFmdGVyIGZvcm0ucmVzZXQoKQogICAgICAgICAgICAgICAgICAgIGlmIChvbmUgJiYgIXZhbHVlcy5sZW5ndGggJiYgb3B0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeShvcHRpb25zWyBpbmRleCBdKS52YWwoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkodmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICBqUXVlcnkoZWxlbSkuZmluZCgib3B0aW9uIikuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheShqUXVlcnkodGhpcykudmFsKCksIHZhbHVlcykgPj0gMDsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc2VsZWN0ZWRJbmRleCA9IC0xOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYXR0ckZuOiB7CiAgICAgICAgICAgIHZhbDogdHJ1ZSwKICAgICAgICAgICAgY3NzOiB0cnVlLAogICAgICAgICAgICBodG1sOiB0cnVlLAogICAgICAgICAgICB0ZXh0OiB0cnVlLAogICAgICAgICAgICBkYXRhOiB0cnVlLAogICAgICAgICAgICB3aWR0aDogdHJ1ZSwKICAgICAgICAgICAgaGVpZ2h0OiB0cnVlLAogICAgICAgICAgICBvZmZzZXQ6IHRydWUKICAgICAgICB9LAoKICAgICAgICBhdHRyOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUsIHBhc3MpIHsKICAgICAgICAgICAgdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKICAgICAgICAgICAgICAgIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgICAgICAgICAgIC8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKICAgICAgICAgICAgaWYgKCFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwYXNzICYmIG5hbWUgaW4galF1ZXJ5LmF0dHJGbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeShlbGVtKVsgbmFtZSBdKHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQKICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkucHJvcChlbGVtLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoZWxlbSk7CgogICAgICAgICAgICAvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCiAgICAgICAgICAgIC8vIEdyYWIgbmVjZXNzYXJ5IGhvb2sgaWYgb25lIGlzIGRlZmluZWQKICAgICAgICAgICAgaWYgKG5vdHhtbCkgewogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIGhvb2tzID0galF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdIHx8ICggcmJvb2xlYW4udGVzdChuYW1lKSA/IGJvb2xIb29rIDogbm9kZUhvb2sgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgbmFtZSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgIiIgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiBub3R4bWwgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpOwoKICAgICAgICAgICAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0ID09PSBudWxsID8KICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQgOgogICAgICAgICAgICAgICAgICAgIHJldDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcHJvcE5hbWUsIGF0dHJOYW1lcywgbmFtZSwgbCwgaXNCb29sLAogICAgICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgICBpZiAodmFsdWUgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgYXR0ck5hbWVzID0gdmFsdWUudG9Mb3dlckNhc2UoKS5zcGxpdChyc3BhY2UpOwogICAgICAgICAgICAgICAgbCA9IGF0dHJOYW1lcy5sZW5ndGg7CgogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuYW1lID0gYXR0ck5hbWVzWyBpIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICBpc0Jvb2wgPSByYm9vbGVhbi50ZXN0KG5hbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VlICM5Njk5IGZvciBleHBsYW5hdGlvbiBvZiB0aGlzIGFwcHJvYWNoIChzZXR0aW5nIGZpcnN0LCB0aGVuIHJlbW92YWwpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvIG5vdCBkbyB0aGlzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMgKHNlZSAjMTA4NzApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNCb29sKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuYXR0cihlbGVtLCBuYW1lLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoZ2V0U2V0QXR0cmlidXRlID8gbmFtZSA6IHByb3BOYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCBjb3JyZXNwb25kaW5nIHByb3BlcnR5IHRvIGZhbHNlIGZvciBib29sZWFuIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQm9vbCAmJiBwcm9wTmFtZSBpbiBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhdHRySG9va3M6IHsKICAgICAgICAgICAgdHlwZTogewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBjYW4ndCBhbGxvdyB0aGUgdHlwZSBwcm9wZXJ0eSB0byBiZSBjaGFuZ2VkIChzaW5jZSBpdCBjYXVzZXMgcHJvYmxlbXMgaW4gSUUpCiAgICAgICAgICAgICAgICAgICAgaWYgKHJ0eXBlLnRlc3QoZWxlbS5ub2RlTmFtZSkgJiYgZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lcnJvcigidHlwZSBwcm9wZXJ0eSBjYW4ndCBiZSBjaGFuZ2VkIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghalF1ZXJ5LnN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImlucHV0IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0dGluZyB0aGUgdHlwZSBvbiBhIHJhZGlvIGJ1dHRvbiBhZnRlciB0aGUgdmFsdWUgcmVzZXRzIHRoZSB2YWx1ZSBpbiBJRTYtOQogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB2YWx1ZSB0byBpdCdzIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGZvciBlbGVtZW50IGNyZWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBlbGVtLnZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgidHlwZSIsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBVc2UgdGhlIHZhbHVlIHByb3BlcnR5IGZvciBiYWNrIGNvbXBhdAogICAgICAgICAgICAvLyBVc2UgdGhlIG5vZGVIb29rIGZvciBidXR0b24gZWxlbWVudHMgaW4gSUU2LzcgKCMxOTU0KQogICAgICAgICAgICB2YWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlSG9vayAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImJ1dHRvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlSG9vay5nZXQoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lIGluIGVsZW0gPwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnZhbHVlIDoKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlSG9vayAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImJ1dHRvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlSG9vay5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBEb2VzIG5vdCByZXR1cm4gc28gdGhhdCBzZXRBdHRyaWJ1dGUgaXMgYWxzbyB1c2VkCiAgICAgICAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcHJvcEZpeDogewogICAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICAgICJmb3IiOiAiaHRtbEZvciIsCiAgICAgICAgICAgICJjbGFzcyI6ICJjbGFzc05hbWUiLAogICAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgICAgY29sc3BhbjogImNvbFNwYW4iLAogICAgICAgICAgICB1c2VtYXA6ICJ1c2VNYXAiLAogICAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgICAgY29udGVudGVkaXRhYmxlOiAiY29udGVudEVkaXRhYmxlIgogICAgICAgIH0sCgogICAgICAgIHByb3A6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcmV0LCBob29rcywgbm90eG1sLAogICAgICAgICAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgICAgICAgLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICAgICAgICBpZiAoIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKTsKCiAgICAgICAgICAgIGlmIChub3R4bWwpIHsKICAgICAgICAgICAgICAgIC8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKICAgICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7CiAgICAgICAgICAgICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCBlbGVtWyBuYW1lIF0gPSB2YWx1ZSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbVsgbmFtZSBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcHJvcEhvb2tzOiB7CiAgICAgICAgICAgIHRhYkluZGV4OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAogICAgICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCiAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoInRhYmluZGV4Iik7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkID8KICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQoYXR0cmlidXRlTm9kZS52YWx1ZSwgMTApIDoKICAgICAgICAgICAgICAgICAgICAgICAgcmZvY3VzYWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpIHx8IHJjbGlja2FibGUudGVzdChlbGVtLm5vZGVOYW1lKSAmJiBlbGVtLmhyZWYgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgMCA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCi8vIEFkZCB0aGUgdGFiSW5kZXggcHJvcEhvb2sgdG8gYXR0ckhvb2tzIGZvciBiYWNrLWNvbXBhdCAoZGlmZmVyZW50IGNhc2UgaXMgaW50ZW50aW9uYWwpCiAgICBqUXVlcnkuYXR0ckhvb2tzLnRhYmluZGV4ID0galF1ZXJ5LnByb3BIb29rcy50YWJJbmRleDsKCi8vIEhvb2sgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogICAgYm9vbEhvb2sgPSB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAgICAgICAvLyBBbGlnbiBib29sZWFuIGF0dHJpYnV0ZXMgd2l0aCBjb3JyZXNwb25kaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgLy8gRmFsbCBiYWNrIHRvIGF0dHJpYnV0ZSBwcmVzZW5jZSB3aGVyZSBzb21lIGJvb2xlYW5zIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgICAgICAgIHZhciBhdHRyTm9kZSwKICAgICAgICAgICAgICAgIHByb3BlcnR5ID0galF1ZXJ5LnByb3AoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eSA9PT0gdHJ1ZSB8fCB0eXBlb2YgcHJvcGVydHkgIT09ICJib29sZWFuIiAmJiAoIGF0dHJOb2RlID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpICkgJiYgYXR0ck5vZGUubm9kZVZhbHVlICE9PSBmYWxzZSA/CiAgICAgICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCkgOgogICAgICAgICAgICAgICAgdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYm9vbGVhbiBhdHRyaWJ1dGVzIHdoZW4gc2V0IHRvIGZhbHNlCiAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHZhbHVlIGlzIHRydWUgc2luY2Ugd2Uga25vdyBhdCB0aGlzIHBvaW50IGl0J3MgdHlwZSBib29sZWFuIGFuZCBub3QgZmFsc2UKICAgICAgICAgICAgICAgIC8vIFNldCBib29sZWFuIGF0dHJpYnV0ZXMgdG8gdGhlIHNhbWUgbmFtZSBhbmQgc2V0IHRoZSBET00gcHJvcGVydHkKICAgICAgICAgICAgICAgIHByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICAgICAgaWYgKHByb3BOYW1lIGluIGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHNldCB0aGUgSURMIHNwZWNpZmljYWxseSBpZiBpdCBhbHJlYWR5IGV4aXN0cyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGVsZW1bIHByb3BOYW1lIF0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgICAgfQogICAgfTsKCi8vIElFNi83IGRvIG5vdCBzdXBwb3J0IGdldHRpbmcvc2V0dGluZyBzb21lIGF0dHJpYnV0ZXMgd2l0aCBnZXQvc2V0QXR0cmlidXRlCiAgICBpZiAoIWdldFNldEF0dHJpYnV0ZSkgewoKICAgICAgICBmaXhTcGVjaWZpZWQgPSB7CiAgICAgICAgICAgIG5hbWU6IHRydWUsCiAgICAgICAgICAgIGlkOiB0cnVlLAogICAgICAgICAgICBjb29yZHM6IHRydWUKICAgICAgICB9OwoKICAgICAgICAvLyBVc2UgdGhpcyBmb3IgYW55IGF0dHJpYnV0ZSBpbiBJRTYvNwogICAgICAgIC8vIFRoaXMgZml4ZXMgYWxtb3N0IGV2ZXJ5IElFNi83IGlzc3VlCiAgICAgICAgbm9kZUhvb2sgPSBqUXVlcnkudmFsSG9va3MuYnV0dG9uID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmV0OwogICAgICAgICAgICAgICAgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJldCAmJiAoIGZpeFNwZWNpZmllZFsgbmFtZSBdID8gcmV0Lm5vZGVWYWx1ZSAhPT0gIiIgOiByZXQuc3BlY2lmaWVkICkgPwogICAgICAgICAgICAgICAgICAgIHJldC5ub2RlVmFsdWUgOgogICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZXhpc3Rpbmcgb3IgY3JlYXRlIGEgbmV3IGF0dHJpYnV0ZSBub2RlCiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCFyZXQpIHsKICAgICAgICAgICAgICAgICAgICByZXQgPSBkb2N1bWVudC5jcmVhdGVBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGVOb2RlKHJldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gKCByZXQubm9kZVZhbHVlID0gdmFsdWUgKyAiIiApOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gQXBwbHkgdGhlIG5vZGVIb29rIHRvIHRhYmluZGV4CiAgICAgICAgalF1ZXJ5LmF0dHJIb29rcy50YWJpbmRleC5zZXQgPSBub2RlSG9vay5zZXQ7CgogICAgICAgIC8vIFNldCB3aWR0aCBhbmQgaGVpZ2h0IHRvIGF1dG8gaW5zdGVhZCBvZiAwIG9uIGVtcHR5IHN0cmluZyggQnVnICM4MTUwICkKICAgICAgICAvLyBUaGlzIGlzIGZvciByZW1vdmFscwogICAgICAgIGpRdWVyeS5lYWNoKFsgIndpZHRoIiwgImhlaWdodCIgXSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgICAgICAgICAgalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV4dGVuZChqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCAiYXV0byIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gU2V0IGNvbnRlbnRlZGl0YWJsZSB0byBmYWxzZSBvbiByZW1vdmFscygjMTA0MjkpCiAgICAgICAgLy8gU2V0dGluZyB0byBlbXB0eSBzdHJpbmcgdGhyb3dzIGFuIGVycm9yIGFzIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBqUXVlcnkuYXR0ckhvb2tzLmNvbnRlbnRlZGl0YWJsZSA9IHsKICAgICAgICAgICAgZ2V0OiBub2RlSG9vay5nZXQsCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiZmFsc2UiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZUhvb2suc2V0KGVsZW0sIHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgoKLy8gU29tZSBhdHRyaWJ1dGVzIHJlcXVpcmUgYSBzcGVjaWFsIGNhbGwgb24gSUUKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQpIHsKICAgICAgICBqUXVlcnkuZWFjaChbICJocmVmIiwgInNyYyIsICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAgICAgICAgIGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuc3R5bGUpIHsKICAgICAgICBqUXVlcnkuYXR0ckhvb2tzLnN0eWxlID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdW5kZWZpbmVkIGluIHRoZSBjYXNlIG9mIGVtcHR5IHN0cmluZwogICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRvIGxvd2VyY2FzZSBzaW5jZSBJRSB1cHBlcmNhc2VzIGNzcyBwcm9wZXJ0eSBuYW1lcwogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uc3R5bGUuY3NzVGV4dC50b0xvd2VyQ2FzZSgpIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoIGVsZW0uc3R5bGUuY3NzVGV4dCA9ICIiICsgdmFsdWUgKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgovLyBTYWZhcmkgbWlzLXJlcG9ydHMgdGhlIGRlZmF1bHQgc2VsZWN0ZWQgcHJvcGVydHkgb2YgYW4gb3B0aW9uCi8vIEFjY2Vzc2luZyB0aGUgcGFyZW50J3Mgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eSBmaXhlcyBpdAogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5vcHRTZWxlY3RlZCkgewogICAgICAgIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSBqUXVlcnkuZXh0ZW5kKGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnNlbGVjdGVkSW5kZXg7CgogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgovLyBJRTYvNyBjYWxsIGVuY3R5cGUgZW5jb2RpbmcKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuZW5jdHlwZSkgewogICAgICAgIGpRdWVyeS5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciOwogICAgfQoKLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuY2hlY2tPbikgewogICAgICAgIGpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBpbiBXZWJraXQgIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID09PSBudWxsID8gIm9uIiA6IGVsZW0udmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICB9CiAgICBqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0galF1ZXJ5LmV4dGVuZChqUXVlcnkudmFsSG9va3NbIHRoaXMgXSwgewogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUpID49IDAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CgoKICAgIHZhciByZm9ybUVsZW1zID0gL14oPzp0ZXh0YXJlYXxpbnB1dHxzZWxlY3QpJC9pLAogICAgICAgIHJ0eXBlbmFtZXNwYWNlID0gL14oW15cLl0qKT8oPzpcLiguKykpPyQvLAogICAgICAgIHJob3ZlckhhY2sgPSAvKD86Xnxccylob3ZlcihcLlxTKyk/XGIvLAogICAgICAgIHJrZXlFdmVudCA9IC9ea2V5LywKICAgICAgICBybW91c2VFdmVudCA9IC9eKD86bW91c2V8Y29udGV4dG1lbnUpfGNsaWNrLywKICAgICAgICByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKICAgICAgICBycXVpY2tJcyA9IC9eKFx3KikoPzojKFtcd1wtXSspKT8oPzpcLihbXHdcLV0rKSk/JC8sCiAgICAgICAgcXVpY2tQYXJzZSA9IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgcXVpY2sgPSBycXVpY2tJcy5leGVjKHNlbGVjdG9yKTsKICAgICAgICAgICAgaWYgKHF1aWNrKSB7CiAgICAgICAgICAgICAgICAvLyAgIDAgIDEgICAgMiAgIDMKICAgICAgICAgICAgICAgIC8vIFsgXywgdGFnLCBpZCwgY2xhc3MgXQogICAgICAgICAgICAgICAgcXVpY2tbMV0gPSAoIHF1aWNrWzFdIHx8ICIiICkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIHF1aWNrWzNdID0gcXVpY2tbM10gJiYgbmV3IFJlZ0V4cCgiKD86XnxcXHMpIiArIHF1aWNrWzNdICsgIig/Olxcc3wkKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWljazsKICAgICAgICB9LAogICAgICAgIHF1aWNrSXMgPSBmdW5jdGlvbiAoZWxlbSwgbSkgewogICAgICAgICAgICB2YXIgYXR0cnMgPSBlbGVtLmF0dHJpYnV0ZXMgfHwge307CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAoIW1bMV0gfHwgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBtWzFdKSAmJgogICAgICAgICAgICAgICAgICAgICghbVsyXSB8fCAoYXR0cnMuaWQgfHwge30pLnZhbHVlID09PSBtWzJdKSAmJgogICAgICAgICAgICAgICAgICAgICghbVszXSB8fCBtWzNdLnRlc3QoKGF0dHJzWyAiY2xhc3MiIF0gfHwge30pLnZhbHVlKSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgfSwKICAgICAgICBob3ZlckhhY2sgPSBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZXZlbnQuc3BlY2lhbC5ob3ZlciA/IGV2ZW50cyA6IGV2ZW50cy5yZXBsYWNlKHJob3ZlckhhY2ssICJtb3VzZWVudGVyJDEgbW91c2VsZWF2ZSQxIik7CiAgICAgICAgfTsKCiAgICAvKgogICAgICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogICAgICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICAgICAqLwogICAgalF1ZXJ5LmV2ZW50ID0gewoKICAgICAgICBhZGQ6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBlbGVtRGF0YSwgZXZlbnRIYW5kbGUsIGV2ZW50cywKICAgICAgICAgICAgICAgIHQsIHRucywgdHlwZSwgbmFtZXNwYWNlcywgaGFuZGxlT2JqLAogICAgICAgICAgICAgICAgaGFuZGxlT2JqSW4sIHF1aWNrLCBoYW5kbGVycywgc3BlY2lhbDsKCiAgICAgICAgICAgIC8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYWxsb3cgcGxhaW4gb2JqZWN0cyB0aG8pCiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIXR5cGVzIHx8ICFoYW5kbGVyIHx8ICEoZWxlbURhdGEgPSBqUXVlcnkuX2RhdGEoZWxlbSkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgogICAgICAgICAgICBpZiAoaGFuZGxlci5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlT2JqSW4uaGFuZGxlcjsKICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgogICAgICAgICAgICBpZiAoIWhhbmRsZXIuZ3VpZCkgewogICAgICAgICAgICAgICAgaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdAogICAgICAgICAgICBldmVudHMgPSBlbGVtRGF0YS5ldmVudHM7CiAgICAgICAgICAgIGlmICghZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBlbGVtRGF0YS5ldmVudHMgPSBldmVudHMgPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZTsKICAgICAgICAgICAgaWYgKCFldmVudEhhbmRsZSkgewogICAgICAgICAgICAgICAgZWxlbURhdGEuaGFuZGxlID0gZXZlbnRIYW5kbGUgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIERpc2NhcmQgdGhlIHNlY29uZCBldmVudCBvZiBhIGpRdWVyeS5ldmVudC50cmlnZ2VyKCkgYW5kCiAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAogICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiAoIWUgfHwgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlKSA/CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseShldmVudEhhbmRsZS5lbGVtLCBhcmd1bWVudHMpIDoKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmbiB0byBwcmV2ZW50IGEgbWVtb3J5IGxlYWsgd2l0aCBJRSBub24tbmF0aXZlIGV2ZW50cwogICAgICAgICAgICAgICAgZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKICAgICAgICAgICAgLy8galF1ZXJ5KC4uLikuYmluZCgibW91c2VvdmVyIG1vdXNlb3V0IiwgZm4pOwogICAgICAgICAgICB0eXBlcyA9IGpRdWVyeS50cmltKGhvdmVySGFjayh0eXBlcykpLnNwbGl0KCIgIik7CiAgICAgICAgICAgIGZvciAodCA9IDA7IHQgPCB0eXBlcy5sZW5ndGg7IHQrKykgewoKICAgICAgICAgICAgICAgIHRucyA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgICAgICAgICAgdHlwZSA9IHRuc1sxXTsKICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMgPSAoIHRuc1syXSB8fCAiIiApLnNwbGl0KCIuIikuc29ydCgpOwoKICAgICAgICAgICAgICAgIC8vIElmIGV2ZW50IGNoYW5nZXMgaXRzIHR5cGUsIHVzZSB0aGUgc3BlY2lhbCBldmVudCBoYW5kbGVycyBmb3IgdGhlIGNoYW5nZWQgdHlwZQogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgogICAgICAgICAgICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgICAgICAgICAgICB0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CgogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgogICAgICAgICAgICAgICAgLy8gaGFuZGxlT2JqIGlzIHBhc3NlZCB0byBhbGwgZXZlbnQgaGFuZGxlcnMKICAgICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewogICAgICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ1R5cGU6IHRuc1sxXSwKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICAgICAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yOiBzZWxlY3RvciwKICAgICAgICAgICAgICAgICAgICBxdWljazogc2VsZWN0b3IgJiYgcXVpY2tQYXJzZShzZWxlY3RvciksCiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oIi4iKQogICAgICAgICAgICAgICAgfSwgaGFuZGxlT2JqSW4pOwoKICAgICAgICAgICAgICAgIC8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CiAgICAgICAgICAgICAgICBoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdOwogICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVycykgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgLy8gT25seSB1c2UgYWRkRXZlbnRMaXN0ZW5lci9hdHRhY2hFdmVudCBpZiB0aGUgc3BlY2lhbCBldmVudHMgaGFuZGxlciByZXR1cm5zIGZhbHNlCiAgICAgICAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbChlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEJpbmQgdGhlIGdsb2JhbCBldmVudCBoYW5kbGVyIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBldmVudEhhbmRsZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCJvbiIgKyB0eXBlLCBldmVudEhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWwuYWRkKSB7CiAgICAgICAgICAgICAgICAgICAgc3BlY2lhbC5hZGQuY2FsbChlbGVtLCBoYW5kbGVPYmopOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKICAgICAgICAgICAgZWxlbSA9IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgZ2xvYmFsOiB7fSwKCiAgICAgICAgLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHNlbGVjdG9yLCBtYXBwZWRUeXBlcykgewoKICAgICAgICAgICAgdmFyIGVsZW1EYXRhID0galF1ZXJ5Lmhhc0RhdGEoZWxlbSkgJiYgalF1ZXJ5Ll9kYXRhKGVsZW0pLAogICAgICAgICAgICAgICAgdCwgdG5zLCB0eXBlLCBvcmlnVHlwZSwgbmFtZXNwYWNlcywgb3JpZ0NvdW50LAogICAgICAgICAgICAgICAgaiwgZXZlbnRzLCBzcGVjaWFsLCBoYW5kbGUsIGV2ZW50VHlwZSwgaGFuZGxlT2JqOwoKICAgICAgICAgICAgaWYgKCFlbGVtRGF0YSB8fCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAogICAgICAgICAgICB0eXBlcyA9IGpRdWVyeS50cmltKGhvdmVySGFjayh0eXBlcyB8fCAiIikpLnNwbGl0KCIgIik7CiAgICAgICAgICAgIGZvciAodCA9IDA7IHQgPCB0eXBlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgICAgICAgdG5zID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgICAgICAgICB0eXBlID0gb3JpZ1R5cGUgPSB0bnNbMV07CiAgICAgICAgICAgICAgICBuYW1lc3BhY2VzID0gdG5zWzJdOwoKICAgICAgICAgICAgICAgIC8vIFVuYmluZCBhbGwgZXZlbnRzIChvbiB0aGlzIG5hbWVzcGFjZSwgaWYgcHJvdmlkZWQpIGZvciB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUgKyB0eXBlc1sgdCBdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgICAgICAgICAgICAgdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwogICAgICAgICAgICAgICAgZXZlbnRUeXBlID0gZXZlbnRzWyB0eXBlIF0gfHwgW107CiAgICAgICAgICAgICAgICBvcmlnQ291bnQgPSBldmVudFR5cGUubGVuZ3RoOwogICAgICAgICAgICAgICAgbmFtZXNwYWNlcyA9IG5hbWVzcGFjZXMgPyBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuc3BsaXQoIi4iKS5zb3J0KCkuam9pbigiXFwuKD86LipcXC4pPyIpICsgIihcXC58JCkiKSA6IG51bGw7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwogICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGV2ZW50VHlwZS5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGV2ZW50VHlwZVsgaiBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCAhaGFuZGxlciB8fCBoYW5kbGVyLmd1aWQgPT09IGhhbmRsZU9iai5ndWlkICkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCAhbmFtZXNwYWNlcyB8fCBuYW1lc3BhY2VzLnRlc3QoaGFuZGxlT2JqLm5hbWVzcGFjZSkgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VHlwZS5zcGxpY2Uoai0tLCAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGVPYmouc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VHlwZS5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpYWwucmVtb3ZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAogICAgICAgICAgICAgICAgLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCiAgICAgICAgICAgICAgICBpZiAoZXZlbnRUeXBlLmxlbmd0aCA9PT0gMCAmJiBvcmlnQ291bnQgIT09IGV2ZW50VHlwZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKGVsZW0sIG5hbWVzcGFjZXMpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbIHR5cGUgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBleHBhbmRvIGlmIGl0J3Mgbm8gbG9uZ2VyIHVzZWQKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0VtcHR5T2JqZWN0KGV2ZW50cykpIHsKICAgICAgICAgICAgICAgIGhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZTsKICAgICAgICAgICAgICAgIGlmIChoYW5kbGUpIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGUuZWxlbSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gcmVtb3ZlRGF0YSBhbHNvIGNoZWNrcyBmb3IgZW1wdGluZXNzIGFuZCBjbGVhcnMgdGhlIGV4cGFuZG8gaWYgZW1wdHkKICAgICAgICAgICAgICAgIC8vIHNvIHVzZSBpdCBpbnN0ZWFkIG9mIGRlbGV0ZQogICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoZWxlbSwgWyAiZXZlbnRzIiwgImhhbmRsZSIgXSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBFdmVudHMgdGhhdCBhcmUgc2FmZSB0byBzaG9ydC1jaXJjdWl0IGlmIG5vIGhhbmRsZXJzIGFyZSBhdHRhY2hlZC4KICAgICAgICAvLyBOYXRpdmUgRE9NIGV2ZW50cyBzaG91bGQgbm90IGJlIGFkZGVkLCB0aGV5IG1heSBoYXZlIGlubGluZSBoYW5kbGVycy4KICAgICAgICBjdXN0b21FdmVudDogewogICAgICAgICAgICAiZ2V0RGF0YSI6IHRydWUsCiAgICAgICAgICAgICJzZXREYXRhIjogdHJ1ZSwKICAgICAgICAgICAgImNoYW5nZURhdGEiOiB0cnVlCiAgICAgICAgfSwKCiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMpIHsKICAgICAgICAgICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgICAgICAgaWYgKGVsZW0gJiYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRXZlbnQgb2JqZWN0IG9yIGV2ZW50IHR5cGUKICAgICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8IGV2ZW50LAogICAgICAgICAgICAgICAgbmFtZXNwYWNlcyA9IFtdLAogICAgICAgICAgICAgICAgY2FjaGUsIGV4Y2x1c2l2ZSwgaSwgY3VyLCBvbGQsIG9udHlwZSwgc3BlY2lhbCwgaGFuZGxlLCBldmVudFBhdGgsIGJ1YmJsZVR5cGU7CgogICAgICAgICAgICAvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKICAgICAgICAgICAgaWYgKHJmb2N1c01vcnBoLnRlc3QodHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlLmluZGV4T2YoIiEiKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBFeGNsdXNpdmUgZXZlbnRzIHRyaWdnZXIgb25seSBmb3IgdGhlIGV4YWN0IGV2ZW50IChubyBuYW1lc3BhY2VzKQogICAgICAgICAgICAgICAgdHlwZSA9IHR5cGUuc2xpY2UoMCwgLTEpOwogICAgICAgICAgICAgICAgZXhjbHVzaXZlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUuaW5kZXhPZigiLiIpID49IDApIHsKICAgICAgICAgICAgICAgIC8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CiAgICAgICAgICAgICAgICB0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwogICAgICAgICAgICAgICAgbmFtZXNwYWNlcy5zb3J0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgoIWVsZW0gfHwgalF1ZXJ5LmV2ZW50LmN1c3RvbUV2ZW50WyB0eXBlIF0pICYmICFqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0pIHsKICAgICAgICAgICAgICAgIC8vIE5vIGpRdWVyeSBoYW5kbGVycyBmb3IgdGhpcyBldmVudCB0eXBlLCBhbmQgaXQgY2FuJ3QgaGF2ZSBpbmxpbmUgaGFuZGxlcnMKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIEV2ZW50LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKICAgICAgICAgICAgZXZlbnQgPSB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiID8KICAgICAgICAgICAgICAgIC8vIGpRdWVyeS5FdmVudCBvYmplY3QKICAgICAgICAgICAgICAgIGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8gZXZlbnQgOgogICAgICAgICAgICAgICAgICAgIC8vIE9iamVjdCBsaXRlcmFsCiAgICAgICAgICAgICAgICAgICAgbmV3IGpRdWVyeS5FdmVudCh0eXBlLCBldmVudCkgOgogICAgICAgICAgICAgICAgLy8gSnVzdCB0aGUgZXZlbnQgdHlwZSAoc3RyaW5nKQogICAgICAgICAgICAgICAgbmV3IGpRdWVyeS5FdmVudCh0eXBlKTsKCiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwogICAgICAgICAgICBldmVudC5pc1RyaWdnZXIgPSB0cnVlOwogICAgICAgICAgICBldmVudC5leGNsdXNpdmUgPSBleGNsdXNpdmU7CiAgICAgICAgICAgIGV2ZW50Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuam9pbigiLiIpOwogICAgICAgICAgICBldmVudC5uYW1lc3BhY2VfcmUgPSBldmVudC5uYW1lc3BhY2UgPyBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuam9pbigiXFwuKD86LipcXC4pPyIpICsgIihcXC58JCkiKSA6IG51bGw7CiAgICAgICAgICAgIG9udHlwZSA9IHR5cGUuaW5kZXhPZigiOiIpIDwgMCA/ICJvbiIgKyB0eXBlIDogIiI7CgogICAgICAgICAgICAvLyBIYW5kbGUgYSBnbG9iYWwgdHJpZ2dlcgogICAgICAgICAgICBpZiAoIWVsZW0pIHsKCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBTdG9wIHRhdW50aW5nIHRoZSBkYXRhIGNhY2hlOyByZW1vdmUgZ2xvYmFsIGV2ZW50cyBhbmQgYWx3YXlzIGF0dGFjaCB0byBkb2N1bWVudAogICAgICAgICAgICAgICAgY2FjaGUgPSBqUXVlcnkuY2FjaGU7CiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbIGkgXS5ldmVudHMgJiYgY2FjaGVbIGkgXS5ldmVudHNbIHR5cGUgXSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcihldmVudCwgZGF0YSwgY2FjaGVbIGkgXS5oYW5kbGUuZWxlbSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKICAgICAgICAgICAgZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gZWxlbTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICAgICAgICBkYXRhID0gZGF0YSAhPSBudWxsID8galF1ZXJ5Lm1ha2VBcnJheShkYXRhKSA6IFtdOwogICAgICAgICAgICBkYXRhLnVuc2hpZnQoZXZlbnQpOwoKICAgICAgICAgICAgLy8gQWxsb3cgc3BlY2lhbCBldmVudHMgdG8gZHJhdyBvdXRzaWRlIHRoZSBsaW5lcwogICAgICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKICAgICAgICAgICAgaWYgKHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoZWxlbSwgZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQogICAgICAgICAgICAvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQogICAgICAgICAgICBldmVudFBhdGggPSBbCiAgICAgICAgICAgICAgICBbIGVsZW0sIHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZSBdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKCiAgICAgICAgICAgICAgICBidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKICAgICAgICAgICAgICAgIGN1ciA9IHJmb2N1c01vcnBoLnRlc3QoYnViYmxlVHlwZSArIHR5cGUpID8gZWxlbSA6IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIG9sZCA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKFsgY3VyLCBidWJibGVUeXBlIF0pOwogICAgICAgICAgICAgICAgICAgIG9sZCA9IGN1cjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKICAgICAgICAgICAgICAgIGlmIChvbGQgJiYgb2xkID09PSBlbGVtLm93bmVyRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBldmVudFBhdGgucHVzaChbIG9sZC5kZWZhdWx0VmlldyB8fCBvbGQucGFyZW50V2luZG93IHx8IHdpbmRvdywgYnViYmxlVHlwZSBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRQYXRoLmxlbmd0aCAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTsgaSsrKSB7CgogICAgICAgICAgICAgICAgY3VyID0gZXZlbnRQYXRoW2ldWzBdOwogICAgICAgICAgICAgICAgZXZlbnQudHlwZSA9IGV2ZW50UGF0aFtpXVsxXTsKCiAgICAgICAgICAgICAgICBoYW5kbGUgPSAoIGpRdWVyeS5fZGF0YShjdXIsICJldmVudHMiKSB8fCB7fSApWyBldmVudC50eXBlIF0gJiYgalF1ZXJ5Ll9kYXRhKGN1ciwgImhhbmRsZSIpOwogICAgICAgICAgICAgICAgaWYgKGhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZS5hcHBseShjdXIsIGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHRoaXMgaXMgYSBiYXJlIEpTIGZ1bmN0aW9uIGFuZCBub3QgYSBqUXVlcnkgaGFuZGxlcgogICAgICAgICAgICAgICAgaGFuZGxlID0gb250eXBlICYmIGN1clsgb250eXBlIF07CiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlICYmIGpRdWVyeS5hY2NlcHREYXRhKGN1cikgJiYgaGFuZGxlLmFwcGx5KGN1ciwgZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBldmVudC50eXBlID0gdHlwZTsKCiAgICAgICAgICAgIC8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKICAgICAgICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CgogICAgICAgICAgICAgICAgaWYgKCghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KGVsZW0ub3duZXJEb2N1bWVudCwgZGF0YSkgPT09IGZhbHNlKSAmJiAhKHR5cGUgPT09ICJjbGljayIgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJhIikpICYmIGpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBuYW1lIGFzIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAvLyBDYW4ndCB1c2UgYW4gLmlzRnVuY3Rpb24oKSBjaGVjayBoZXJlIGJlY2F1c2UgSUU2LzcgZmFpbHMgdGhhdCB0ZXN0LgogICAgICAgICAgICAgICAgICAgIC8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkKICAgICAgICAgICAgICAgICAgICAvLyBJRTw5IGRpZXMgb24gZm9jdXMvYmx1ciB0byBoaWRkZW4gZWxlbWVudCAoIzE0ODYpCiAgICAgICAgICAgICAgICAgICAgaWYgKG9udHlwZSAmJiBlbGVtWyB0eXBlIF0gJiYgKCh0eXBlICE9PSAiZm9jdXMiICYmIHR5cGUgIT09ICJibHVyIikgfHwgZXZlbnQudGFyZ2V0Lm9mZnNldFdpZHRoICE9PSAwKSAmJiAhalF1ZXJ5LmlzV2luZG93KGVsZW0pKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgIG9sZCA9IGVsZW1bIG9udHlwZSBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgb250eXBlIF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgdHlwZSBdKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBvbnR5cGUgXSA9IG9sZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICBkaXNwYXRjaDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgICAgICAvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKICAgICAgICAgICAgZXZlbnQgPSBqUXVlcnkuZXZlbnQuZml4KGV2ZW50IHx8IHdpbmRvdy5ldmVudCk7CgogICAgICAgICAgICB2YXIgaGFuZGxlcnMgPSAoIChqUXVlcnkuX2RhdGEodGhpcywgImV2ZW50cyIpIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSksCiAgICAgICAgICAgICAgICBkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKICAgICAgICAgICAgICAgIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCksCiAgICAgICAgICAgICAgICBydW5fYWxsID0gIWV2ZW50LmV4Y2x1c2l2ZSAmJiAhZXZlbnQubmFtZXNwYWNlLAogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge30sCiAgICAgICAgICAgICAgICBoYW5kbGVyUXVldWUgPSBbXSwKICAgICAgICAgICAgICAgIGksIGosIGN1ciwganFjdXIsIHJldCwgc2VsTWF0Y2gsIG1hdGNoZWQsIG1hdGNoZXMsIGhhbmRsZU9iaiwgc2VsLCByZWxhdGVkOwoKICAgICAgICAgICAgLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKICAgICAgICAgICAgYXJnc1swXSA9IGV2ZW50OwogICAgICAgICAgICBldmVudC5kZWxlZ2F0ZVRhcmdldCA9IHRoaXM7CgogICAgICAgICAgICAvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkCiAgICAgICAgICAgIGlmIChzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCh0aGlzLCBldmVudCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERldGVybWluZSBoYW5kbGVycyB0aGF0IHNob3VsZCBydW4gaWYgdGhlcmUgYXJlIGRlbGVnYXRlZCBldmVudHMKICAgICAgICAgICAgLy8gQXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpCiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUNvdW50ICYmICEoZXZlbnQuYnV0dG9uICYmIGV2ZW50LnR5cGUgPT09ICJjbGljayIpKSB7CgogICAgICAgICAgICAgICAgLy8gUHJlZ2VuZXJhdGUgYSBzaW5nbGUgalF1ZXJ5IG9iamVjdCBmb3IgcmV1c2Ugd2l0aCAuaXMoKQogICAgICAgICAgICAgICAganFjdXIgPSBqUXVlcnkodGhpcyk7CiAgICAgICAgICAgICAgICBqcWN1ci5jb250ZXh0ID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXM7CgogICAgICAgICAgICAgICAgZm9yIChjdXIgPSBldmVudC50YXJnZXQ7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHByb2Nlc3MgZXZlbnRzIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUpCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxNYXRjaCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGpxY3VyWzBdID0gY3VyOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1sgaSBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxNYXRjaFsgc2VsIF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbE1hdGNoWyBzZWwgXSA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqLnF1aWNrID8gcXVpY2tJcyhjdXIsIGhhbmRsZU9iai5xdWljaykgOiBqcWN1ci5pcyhzZWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsTWF0Y2hbIHNlbCBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGhhbmRsZU9iaik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgbWF0Y2hlczogbWF0Y2hlcyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwogICAgICAgICAgICBpZiAoaGFuZGxlcnMubGVuZ3RoID4gZGVsZWdhdGVDb3VudCkgewogICAgICAgICAgICAgICAgaGFuZGxlclF1ZXVlLnB1c2goeyBlbGVtOiB0aGlzLCBtYXRjaGVzOiBoYW5kbGVycy5zbGljZShkZWxlZ2F0ZUNvdW50KSB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhhbmRsZXJRdWV1ZS5sZW5ndGggJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCk7IGkrKykgewogICAgICAgICAgICAgICAgbWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVsgaSBdOwogICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IG1hdGNoZWQuZWxlbTsKCiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbWF0Y2hlZC5tYXRjaGVzLmxlbmd0aCAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqID0gbWF0Y2hlZC5tYXRjaGVzWyBqIF07CgogICAgICAgICAgICAgICAgICAgIC8vIFRyaWdnZXJlZCBldmVudCBtdXN0IGVpdGhlciAxKSBiZSBub24tZXhjbHVzaXZlIGFuZCBoYXZlIG5vIG5hbWVzcGFjZSwgb3IKICAgICAgICAgICAgICAgICAgICAvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KICAgICAgICAgICAgICAgICAgICBpZiAocnVuX2FsbCB8fCAoIWV2ZW50Lm5hbWVzcGFjZSAmJiAhaGFuZGxlT2JqLm5hbWVzcGFjZSkgfHwgZXZlbnQubmFtZXNwYWNlX3JlICYmIGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBseShtYXRjaGVkLmVsZW0sIGFyZ3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5yZXN1bHQgPSByZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhbGwgdGhlIHBvc3REaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUKICAgICAgICAgICAgaWYgKHNwZWNpYWwucG9zdERpc3BhdGNoKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICAvLyBJbmNsdWRlcyBzb21lIGV2ZW50IHByb3BzIHNoYXJlZCBieSBLZXlFdmVudCBhbmQgTW91c2VFdmVudAogICAgICAgIC8vICoqKiBhdHRyQ2hhbmdlIGF0dHJOYW1lIHJlbGF0ZWROb2RlIHNyY0VsZW1lbnQgIGFyZSBub3Qgbm9ybWFsaXplZCwgbm9uLVczQywgZGVwcmVjYXRlZCwgd2lsbCBiZSByZW1vdmVkIGluIDEuOCAqKioKICAgICAgICBwcm9wczogImF0dHJDaGFuZ2UgYXR0ck5hbWUgcmVsYXRlZE5vZGUgc3JjRWxlbWVudCBhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCgogICAgICAgIGZpeEhvb2tzOiB7fSwKCiAgICAgICAga2V5SG9va3M6IHsKICAgICAgICAgICAgcHJvcHM6ICJjaGFyIGNoYXJDb2RlIGtleSBrZXlDb2RlIi5zcGxpdCgiICIpLAogICAgICAgICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChldmVudCwgb3JpZ2luYWwpIHsKCiAgICAgICAgICAgICAgICAvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKICAgICAgICAgICAgICAgIGlmIChldmVudC53aGljaCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG1vdXNlSG9va3M6IHsKICAgICAgICAgICAgcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCiAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKGV2ZW50LCBvcmlnaW5hbCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50RG9jLCBkb2MsIGJvZHksCiAgICAgICAgICAgICAgICAgICAgYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uLAogICAgICAgICAgICAgICAgICAgIGZyb21FbGVtZW50ID0gb3JpZ2luYWwuZnJvbUVsZW1lbnQ7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnREb2MgPSBldmVudC50YXJnZXQub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgICAgICAgICAgICBkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgYm9keSA9IGV2ZW50RG9jLmJvZHk7CgogICAgICAgICAgICAgICAgICAgIGV2ZW50LnBhZ2VYID0gb3JpZ2luYWwuY2xpZW50WCArICggZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDAgKSAtICggZG9jICYmIGRvYy5jbGllbnRMZWZ0IHx8IGJvZHkgJiYgYm9keS5jbGllbnRMZWZ0IHx8IDAgKTsKICAgICAgICAgICAgICAgICAgICBldmVudC5wYWdlWSA9IG9yaWdpbmFsLmNsaWVudFkgKyAoIGRvYyAmJiBkb2Muc2Nyb2xsVG9wIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCB8fCBib2R5ICYmIGJvZHkuY2xpZW50VG9wIHx8IDAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICBpZiAoIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IG9yaWdpbmFsLnRvRWxlbWVudCA6IGZyb21FbGVtZW50OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKICAgICAgICAgICAgICAgIC8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CiAgICAgICAgICAgICAgICBpZiAoIWV2ZW50LndoaWNoICYmIGJ1dHRvbiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQud2hpY2ggPSAoIGJ1dHRvbiAmIDEgPyAxIDogKCBidXR0b24gJiAyID8gMyA6ICggYnV0dG9uICYgNCA/IDIgOiAwICkgKSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGZpeDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBjb3B5IG9mIHRoZSBldmVudCBvYmplY3QgYW5kIG5vcm1hbGl6ZSBzb21lIHByb3BlcnRpZXMKICAgICAgICAgICAgdmFyIGksIHByb3AsCiAgICAgICAgICAgICAgICBvcmlnaW5hbEV2ZW50ID0gZXZlbnQsCiAgICAgICAgICAgICAgICBmaXhIb29rID0galF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBldmVudC50eXBlIF0gfHwge30sCiAgICAgICAgICAgICAgICBjb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KGZpeEhvb2sucHJvcHMpIDogdGhpcy5wcm9wczsKCiAgICAgICAgICAgIGV2ZW50ID0galF1ZXJ5LkV2ZW50KG9yaWdpbmFsRXZlbnQpOwoKICAgICAgICAgICAgZm9yIChpID0gY29weS5sZW5ndGg7IGk7KSB7CiAgICAgICAgICAgICAgICBwcm9wID0gY29weVsgLS1pIF07CiAgICAgICAgICAgICAgICBldmVudFsgcHJvcCBdID0gb3JpZ2luYWxFdmVudFsgcHJvcCBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaXggdGFyZ2V0IHByb3BlcnR5LCBpZiBuZWNlc3NhcnkgKCMxOTI1LCBJRSA2LzcvOCAmIFNhZmFyaTIpCiAgICAgICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBvcmlnaW5hbEV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCBTYWZhcmkpCiAgICAgICAgICAgIGlmIChldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGb3IgbW91c2Uva2V5IGV2ZW50czsgYWRkIG1ldGFLZXkgaWYgaXQncyBub3QgdGhlcmUgKCMzMzY4LCBJRTYvNy84KQogICAgICAgICAgICBpZiAoZXZlbnQubWV0YUtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBldmVudC5tZXRhS2V5ID0gZXZlbnQuY3RybEtleTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZpeEhvb2suZmlsdGVyID8gZml4SG9vay5maWx0ZXIoZXZlbnQsIG9yaWdpbmFsRXZlbnQpIDogZXZlbnQ7CiAgICAgICAgfSwKCiAgICAgICAgc3BlY2lhbDogewogICAgICAgICAgICByZWFkeTogewogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSByZWFkeSBldmVudCBpcyBzZXR1cAogICAgICAgICAgICAgICAgc2V0dXA6IGpRdWVyeS5iaW5kUmVhZHkKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGxvYWQ6IHsKICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKICAgICAgICAgICAgICAgIG5vQnViYmxlOiB0cnVlCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmb2N1czogewogICAgICAgICAgICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNpbiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYmx1cjogewogICAgICAgICAgICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBiZWZvcmV1bmxvYWQ6IHsKICAgICAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbiAoZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBvbmx5IHdhbnQgdG8gZG8gdGhpcyBzcGVjaWFsIGNhc2Ugb24gd2luZG93cwogICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNXaW5kb3codGhpcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbmJlZm9yZXVubG9hZCA9IGV2ZW50SGFuZGxlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uIChuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9uYmVmb3JldW5sb2FkID09PSBldmVudEhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uYmVmb3JldW5sb2FkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzaW11bGF0ZTogZnVuY3Rpb24gKHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUpIHsKICAgICAgICAgICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lLgogICAgICAgICAgICAvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKICAgICAgICAgICAgLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCiAgICAgICAgICAgIHZhciBlID0galF1ZXJ5LmV4dGVuZCgKICAgICAgICAgICAgICAgIG5ldyBqUXVlcnkuRXZlbnQoKSwKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgeyB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgICAgIGlzU2ltdWxhdGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQ6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChidWJibGUpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGUsIG51bGwsIGVsZW0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmNhbGwoZWxlbSwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGUuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKLy8gU29tZSBwbHVnaW5zIGFyZSB1c2luZywgYnV0IGl0J3MgdW5kb2N1bWVudGVkL2RlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZC4KLy8gVGhlIDEuNyBzcGVjaWFsIGV2ZW50IGludGVyZmFjZSBzaG91bGQgcHJvdmlkZSBhbGwgdGhlIGhvb2tzIG5lZWRlZCBub3cuCiAgICBqUXVlcnkuZXZlbnQuaGFuZGxlID0galF1ZXJ5LmV2ZW50LmRpc3BhdGNoOwoKICAgIGpRdWVyeS5yZW1vdmVFdmVudCA9IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIgPwogICAgICAgIGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGhhbmRsZSkgewogICAgICAgICAgICBpZiAoZWxlbS5kZXRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgZWxlbS5kZXRhY2hFdmVudCgib24iICsgdHlwZSwgaGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24gKHNyYywgcHJvcHMpIHsKICAgICAgICAvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IGpRdWVyeS5FdmVudChzcmMsIHByb3BzKTsKICAgICAgICB9CgogICAgICAgIC8vIEV2ZW50IG9iamVjdAogICAgICAgIGlmIChzcmMgJiYgc3JjLnR5cGUpIHsKICAgICAgICAgICAgdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwogICAgICAgICAgICB0aGlzLnR5cGUgPSBzcmMudHlwZTsKCiAgICAgICAgICAgIC8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCiAgICAgICAgICAgIC8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgogICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9ICggc3JjLmRlZmF1bHRQcmV2ZW50ZWQgfHwgc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSB8fAogICAgICAgICAgICAgICAgc3JjLmdldFByZXZlbnREZWZhdWx0ICYmIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCgpICkgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7CgogICAgICAgICAgICAvLyBFdmVudCB0eXBlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy50eXBlID0gc3JjOwogICAgICAgIH0KCiAgICAgICAgLy8gUHV0IGV4cGxpY2l0bHkgcHJvdmlkZWQgcHJvcGVydGllcyBvbnRvIHRoZSBldmVudCBvYmplY3QKICAgICAgICBpZiAocHJvcHMpIHsKICAgICAgICAgICAgalF1ZXJ5LmV4dGVuZCh0aGlzLCBwcm9wcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQogICAgICAgIHRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKICAgICAgICAvLyBNYXJrIGl0IGFzIGZpeGVkCiAgICAgICAgdGhpc1sgalF1ZXJ5LmV4cGFuZG8gXSA9IHRydWU7CiAgICB9OwoKICAgIGZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDMvV0QtRE9NLUxldmVsLTMtRXZlbnRzLTIwMDMwMzMxL2VjbWEtc2NyaXB0LWJpbmRpbmcuaHRtbAogICAgalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CgogICAgICAgICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgICAgICAgaWYgKCFlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGlmIHByZXZlbnREZWZhdWx0IGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICAgICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHNldCB0aGUgcmV0dXJuVmFsdWUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIGZhbHNlIChJRSkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGUucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKICAgICAgICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgIGlmICghZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGlmIHN0b3BQcm9wYWdhdGlvbiBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAogICAgICAgICAgICBpZiAoZS5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHNldCB0aGUgY2FuY2VsQnViYmxlIHByb3BlcnR5IG9mIHRoZSBvcmlnaW5hbCBldmVudCB0byB0cnVlIChJRSkKICAgICAgICAgICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgIH0sCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgICAgICAgICB0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIH0sCiAgICAgICAgaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKICAgICAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICAgICAgaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlCiAgICB9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzCiAgICBqUXVlcnkuZWFjaCh7CiAgICAgICAgbW91c2VlbnRlcjogIm1vdXNlb3ZlciIsCiAgICAgICAgbW91c2VsZWF2ZTogIm1vdXNlb3V0IgogICAgfSwgZnVuY3Rpb24gKG9yaWcsIGZpeCkgewogICAgICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsWyBvcmlnIF0gPSB7CiAgICAgICAgICAgIGRlbGVnYXRlVHlwZTogZml4LAogICAgICAgICAgICBiaW5kVHlwZTogZml4LAoKICAgICAgICAgICAgaGFuZGxlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LAogICAgICAgICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iaiwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IGhhbmRsZU9iai5zZWxlY3RvciwKICAgICAgICAgICAgICAgICAgICByZXQ7CgogICAgICAgICAgICAgICAgLy8gRm9yIG1vdXNlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAgICAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICAgICAgICAgIGlmICghcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwogICAgICAgICAgICAgICAgICAgIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQudHlwZSA9IGZpeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSk7CgovLyBJRSBzdWJtaXQgZGVsZWdhdGlvbgogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5zdWJtaXRCdWJibGVzKSB7CgogICAgICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgbmVlZCB0aGlzIGZvciBkZWxlZ2F0ZWQgZm9ybSBzdWJtaXQgZXZlbnRzCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTGF6eS1hZGQgYSBzdWJtaXQgaGFuZGxlciB3aGVuIGEgZGVzY2VuZGFudCBmb3JtIG1heSBwb3RlbnRpYWxseSBiZSBzdWJtaXR0ZWQKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQodGhpcywgImNsaWNrLl9zdWJtaXQga2V5cHJlc3MuX3N1Ym1pdCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm9kZSBuYW1lIGNoZWNrIGF2b2lkcyBhIFZNTC1yZWxhdGVkIGNyYXNoIGluIElFICgjOTgwNykKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IGUudGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtID0galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJpbnB1dCIpIHx8IGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiYnV0dG9uIikgPyBlbGVtLmZvcm0gOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm0gJiYgIWZvcm0uX3N1Ym1pdF9hdHRhY2hlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKGZvcm0sICJzdWJtaXQuX3N1Ym1pdCIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuX3N1Ym1pdF9idWJibGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS5fc3VibWl0X2F0dGFjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIHJldHVybiB1bmRlZmluZWQgc2luY2Ugd2UgZG9uJ3QgbmVlZCBhbiBldmVudCBsaXN0ZW5lcgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcG9zdERpc3BhdGNoOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIC8vIElmIGZvcm0gd2FzIHN1Ym1pdHRlZCBieSB0aGUgdXNlciwgYnViYmxlIHRoZSBldmVudCB1cCB0aGUgdHJlZQogICAgICAgICAgICAgICAgaWYgKGV2ZW50Ll9zdWJtaXRfYnViYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50Ll9zdWJtaXRfYnViYmxlOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzVHJpZ2dlcikgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuc2ltdWxhdGUoInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IG5lZWQgdGhpcyBmb3IgZGVsZWdhdGVkIGZvcm0gc3VibWl0IGV2ZW50cwogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5ub2RlTmFtZSh0aGlzLCAiZm9ybSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBkZWxlZ2F0ZWQgaGFuZGxlcnM7IGNsZWFuRGF0YSBldmVudHVhbGx5IHJlYXBzIHN1Ym1pdCBoYW5kbGVycyBhdHRhY2hlZCBhYm92ZQogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSh0aGlzLCAiLl9zdWJtaXQiKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgovLyBJRSBjaGFuZ2UgZGVsZWdhdGlvbiBhbmQgY2hlY2tib3gvcmFkaW8gZml4CiAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LmNoYW5nZUJ1YmJsZXMpIHsKCiAgICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWwuY2hhbmdlID0gewoKICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICBpZiAocmZvcm1FbGVtcy50ZXN0KHRoaXMubm9kZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSUUgZG9lc24ndCBmaXJlIGNoYW5nZSBvbiBhIGNoZWNrL3JhZGlvIHVudGlsIGJsdXI7IHRyaWdnZXIgaXQgb24gY2xpY2sKICAgICAgICAgICAgICAgICAgICAvLyBhZnRlciBhIHByb3BlcnR5Y2hhbmdlLiBFYXQgdGhlIGJsdXItY2hhbmdlIGluIHNwZWNpYWwuY2hhbmdlLmhhbmRsZS4KICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiB8fCB0aGlzLnR5cGUgPT09ICJyYWRpbyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCAicHJvcGVydHljaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50Lm9yaWdpbmFsRXZlbnQucHJvcGVydHlOYW1lID09PSAiY2hlY2tlZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9qdXN0X2NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCAiY2xpY2suX2NoYW5nZSIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2p1c3RfY2hhbmdlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fanVzdF9jaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCJjaGFuZ2UiLCB0aGlzLCBldmVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBEZWxlZ2F0ZWQgZXZlbnQ7IGxhenktYWRkIGEgY2hhbmdlIGhhbmRsZXIgb24gZGVzY2VuZGFudCBpbnB1dHMKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQodGhpcywgImJlZm9yZWFjdGl2YXRlLl9jaGFuZ2UiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZS50YXJnZXQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChyZm9ybUVsZW1zLnRlc3QoZWxlbS5ub2RlTmFtZSkgJiYgIWVsZW0uX2NoYW5nZV9hdHRhY2hlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNTaW11bGF0ZWQgJiYgIWV2ZW50LmlzVHJpZ2dlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSgiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLl9jaGFuZ2VfYXR0YWNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaGFuZGxlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKICAgICAgICAgICAgICAgIC8vIFN3YWxsb3cgbmF0aXZlIGNoYW5nZSBldmVudHMgZnJvbSBjaGVja2JveC9yYWRpbywgd2UgYWxyZWFkeSB0cmlnZ2VyZWQgdGhlbSBhYm92ZQogICAgICAgICAgICAgICAgaWYgKHRoaXMgIT09IGVsZW0gfHwgZXZlbnQuaXNTaW11bGF0ZWQgfHwgZXZlbnQuaXNUcmlnZ2VyIHx8IChlbGVtLnR5cGUgIT09ICJyYWRpbyIgJiYgZWxlbS50eXBlICE9PSAiY2hlY2tib3giKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudC5oYW5kbGVPYmouaGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUodGhpcywgIi5fY2hhbmdlIik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHJmb3JtRWxlbXMudGVzdCh0aGlzLm5vZGVOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgovLyBDcmVhdGUgImJ1YmJsaW5nIiBmb2N1cyBhbmQgYmx1ciBldmVudHMKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMpIHsKICAgICAgICBqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24gKG9yaWcsIGZpeCkgewoKICAgICAgICAgICAgLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAogICAgICAgICAgICB2YXIgYXR0YWNoZXMgPSAwLAogICAgICAgICAgICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZShmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeChldmVudCksIHRydWUpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKICAgICAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dGFjaGVzKysgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihvcmlnLCBoYW5kbGVyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoLS1hdHRhY2hlcyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9KTsKICAgIH0KCiAgICBqUXVlcnkuZm4uZXh0ZW5kKHsKCiAgICAgICAgb246IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAvKklOVEVSTkFMKi8gb25lKSB7CiAgICAgICAgICAgIHZhciBvcmlnRm4sIHR5cGU7CgogICAgICAgICAgICAvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIikgeyAvLyAmJiBzZWxlY3RvciAhPSBudWxsCiAgICAgICAgICAgICAgICAgICAgLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh0eXBlIGluIHR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbih0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vICggdHlwZXMsIGZuICkKICAgICAgICAgICAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgICAgICAgICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQogICAgICAgICAgICAgICAgICAgIGZuID0gZGF0YTsKICAgICAgICAgICAgICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyAoIHR5cGVzLCBkYXRhLCBmbiApCiAgICAgICAgICAgICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBzZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm4gPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBmbiA9IHJldHVybkZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFmbikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvbmUgPT09IDEpIHsKICAgICAgICAgICAgICAgIG9yaWdGbiA9IGZuOwogICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KICAgICAgICAgICAgICAgICAgICBqUXVlcnkoKS5vZmYoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBvcmlnRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICAgICAgICAgICAgZm4uZ3VpZCA9IG9yaWdGbi5ndWlkIHx8ICggb3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIG9uZTogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSk7CiAgICAgICAgfSwKICAgICAgICBvZmY6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGZuKSB7CiAgICAgICAgICAgIGlmICh0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmopIHsKICAgICAgICAgICAgICAgIC8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKICAgICAgICAgICAgICAgIHZhciBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgICAgICAgICAgICBqUXVlcnkodHlwZXMuZGVsZWdhdGVUYXJnZXQpLm9mZigKICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmoubmFtZXNwYWNlID8gaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6IGhhbmRsZU9iai5vcmlnVHlwZSwKICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmouc2VsZWN0b3IsCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKICAgICAgICAgICAgICAgIGZvciAodmFyIHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9mZih0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgLy8gKCB0eXBlcyBbLCBmbl0gKQogICAgICAgICAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBiaW5kOiBmdW5jdGlvbiAodHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBudWxsLCBkYXRhLCBmbik7CiAgICAgICAgfSwKICAgICAgICB1bmJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub2ZmKHR5cGVzLCBudWxsLCBmbik7CiAgICAgICAgfSwKCiAgICAgICAgbGl2ZTogZnVuY3Rpb24gKHR5cGVzLCBkYXRhLCBmbikgewogICAgICAgICAgICBqUXVlcnkodGhpcy5jb250ZXh0KS5vbih0eXBlcywgdGhpcy5zZWxlY3RvciwgZGF0YSwgZm4pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGRpZTogZnVuY3Rpb24gKHR5cGVzLCBmbikgewogICAgICAgICAgICBqUXVlcnkodGhpcy5jb250ZXh0KS5vZmYodHlwZXMsIHRoaXMuc2VsZWN0b3IgfHwgIioqIiwgZm4pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBkZWxlZ2F0ZTogZnVuY3Rpb24gKHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbik7CiAgICAgICAgfSwKICAgICAgICB1bmRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBmbikgewogICAgICAgICAgICAvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCiAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09IDEgPyB0aGlzLm9mZihzZWxlY3RvciwgIioqIikgOiB0aGlzLm9mZih0eXBlcywgc2VsZWN0b3IsIGZuKTsKICAgICAgICB9LAoKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIHRoaXMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICAgICAgICBpZiAodGhpc1swXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIHRoaXNbMF0sIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlOiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgLy8gU2F2ZSByZWZlcmVuY2UgdG8gYXJndW1lbnRzIGZvciBhY2Nlc3MgaW4gY2xvc3VyZQogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICAgIGd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKyssCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIHRvZ2dsZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBGaWd1cmUgb3V0IHdoaWNoIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFRvZ2dsZSA9ICggalF1ZXJ5Ll9kYXRhKHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQpIHx8IDAgKSAlIGk7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQsIGxhc3RUb2dnbGUgKyAxKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgY2xpY2tzIHN0b3AKICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBhbmQgZXhlY3V0ZSB0aGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJnc1sgbGFzdFRvZ2dsZSBdLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gbGluayBhbGwgdGhlIGZ1bmN0aW9ucywgc28gYW55IG9mIHRoZW0gY2FuIHVuYmluZCB0aGlzIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgdG9nZ2xlci5ndWlkID0gZ3VpZDsKICAgICAgICAgICAgd2hpbGUgKGkgPCBhcmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYXJnc1sgaSsrIF0uZ3VpZCA9IGd1aWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsaWNrKHRvZ2dsZXIpOwogICAgICAgIH0sCgogICAgICAgIGhvdmVyOiBmdW5jdGlvbiAoZm5PdmVyLCBmbk91dCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGZuT3ZlcikubW91c2VsZWF2ZShmbk91dCB8fCBmbk92ZXIpOwogICAgICAgIH0KICAgIH0pOwoKICAgIGpRdWVyeS5lYWNoKCgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgIiArCiAgICAgICAgIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwogICAgICAgICJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKCiAgICAgICAgLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKICAgICAgICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uIChkYXRhLCBmbikgewogICAgICAgICAgICBpZiAoZm4gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgICAgICAgZGF0YSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CiAgICAgICAgICAgICAgICB0aGlzLm9uKG5hbWUsIG51bGwsIGRhdGEsIGZuKSA6CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIobmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGpRdWVyeS5hdHRyRm4pIHsKICAgICAgICAgICAgalF1ZXJ5LmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChya2V5RXZlbnQudGVzdChuYW1lKSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQuZml4SG9va3NbIG5hbWUgXSA9IGpRdWVyeS5ldmVudC5rZXlIb29rczsKICAgICAgICB9CgogICAgICAgIGlmIChybW91c2VFdmVudC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50Lm1vdXNlSG9va3M7CiAgICAgICAgfQogICAgfSk7CgoKICAgIC8qIQogICAgICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUKICAgICAqICBDb3B5cmlnaHQgMjAxMSwgVGhlIERvam8gRm91bmRhdGlvbgogICAgICogIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQsIEJTRCwgYW5kIEdQTCBMaWNlbnNlcy4KICAgICAqICBNb3JlIGluZm9ybWF0aW9uOiBodHRwOi8vc2l6emxlanMuY29tLwogICAgICovCiAgICAoZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgY2h1bmtlciA9IC8oKD86XCgoPzpcKFteKCldK1wpfFteKCldKykrXCl8XFsoPzpcW1teXFtcXV0qXF18WyciXVteJyJdKlsnIl18W15cW1xdJyJdKykrXF18XFwufFteID4rfiwoXFtcXF0rKSt8Wz4rfl0pKFxzKixccyopPygoPzoufFxyfFxuKSopL2csCiAgICAgICAgICAgIGV4cGFuZG8gPSAic2l6Y2FjaGUiICsgKE1hdGgucmFuZG9tKCkgKyAnJykucmVwbGFjZSgnLicsICcnKSwKICAgICAgICAgICAgZG9uZSA9IDAsCiAgICAgICAgICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICAgICAgaGFzRHVwbGljYXRlID0gZmFsc2UsCiAgICAgICAgICAgIGJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlLAogICAgICAgICAgICByQmFja3NsYXNoID0gL1xcL2csCiAgICAgICAgICAgIHJSZXR1cm4gPSAvXHJcbi9nLAogICAgICAgICAgICByTm9uV29yZCA9IC9cVy87CgovLyBIZXJlIHdlIGNoZWNrIGlmIHRoZSBKYXZhU2NyaXB0IGVuZ2luZSBpcyB1c2luZyBzb21lIHNvcnQgb2YKLy8gb3B0aW1pemF0aW9uIHdoZXJlIGl0IGRvZXMgbm90IGFsd2F5cyBjYWxsIG91ciBjb21wYXJpc2lvbgovLyBmdW5jdGlvbi4gSWYgdGhhdCBpcyB0aGUgY2FzZSwgZGlzY2FyZCB0aGUgaGFzRHVwbGljYXRlIHZhbHVlLgovLyAgIFRodXMgZmFyIHRoYXQgaW5jbHVkZXMgR29vZ2xlIENocm9tZS4KICAgICAgICBbMCwgMF0uc29ydChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGJhc2VIYXNEdXBsaWNhdGUgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBTaXp6bGUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKICAgICAgICAgICAgdmFyIG9yaWdDb250ZXh0ID0gY29udGV4dDsKCiAgICAgICAgICAgIGlmIChjb250ZXh0Lm5vZGVUeXBlICE9PSAxICYmIGNvbnRleHQubm9kZVR5cGUgIT09IDkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG0sIHNldCwgY2hlY2tTZXQsIGV4dHJhLCByZXQsIGN1ciwgcG9wLCBpLAogICAgICAgICAgICAgICAgcHJ1bmUgPSB0cnVlLAogICAgICAgICAgICAgICAgY29udGV4dFhNTCA9IFNpenpsZS5pc1hNTChjb250ZXh0KSwKICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICBzb0ZhciA9IHNlbGVjdG9yOwoKICAgICAgICAgICAgLy8gUmVzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaHVua2VyIHJlZ2V4cCAoc3RhcnQgZnJvbSBoZWFkKQogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBjaHVua2VyLmV4ZWMoIiIpOwogICAgICAgICAgICAgICAgbSA9IGNodW5rZXIuZXhlYyhzb0Zhcik7CgogICAgICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICAgICAgICBzb0ZhciA9IG1bM107CgogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2gobVsxXSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtWzJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhID0gbVszXTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlIChtKTsKCiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxICYmIG9yaWdQT1MuZXhlYyhzZWxlY3RvcikpIHsKCiAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID09PSAyICYmIEV4cHIucmVsYXRpdmVbIHBhcnRzWzBdIF0pIHsKICAgICAgICAgICAgICAgICAgICBzZXQgPSBwb3NQcm9jZXNzKHBhcnRzWzBdICsgcGFydHNbMV0sIGNvbnRleHQsIHNlZWQpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0ID0gRXhwci5yZWxhdGl2ZVsgcGFydHNbMF0gXSA/CiAgICAgICAgICAgICAgICAgICAgICAgIFsgY29udGV4dCBdIDoKICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlKHBhcnRzLnNoaWZ0KCksIGNvbnRleHQpOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gcGFydHMuc2hpZnQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlWyBzZWxlY3RvciBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciArPSBwYXJ0cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBzZXQgPSBwb3NQcm9jZXNzKHNlbGVjdG9yLCBzZXQsIHNlZWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAogICAgICAgICAgICAgICAgLy8gKGJ1dCBub3QgaWYgaXQnbGwgYmUgZmFzdGVyIGlmIHRoZSBpbm5lciBzZWxlY3RvciBpcyBhbiBJRCkKICAgICAgICAgICAgICAgIGlmICghc2VlZCAmJiBwYXJ0cy5sZW5ndGggPiAxICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgIWNvbnRleHRYTUwgJiYKICAgICAgICAgICAgICAgICAgICBFeHByLm1hdGNoLklELnRlc3QocGFydHNbMF0pICYmICFFeHByLm1hdGNoLklELnRlc3QocGFydHNbcGFydHMubGVuZ3RoIC0gMV0pKSB7CgogICAgICAgICAgICAgICAgICAgIHJldCA9IFNpenpsZS5maW5kKHBhcnRzLnNoaWZ0KCksIGNvbnRleHQsIGNvbnRleHRYTUwpOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSByZXQuZXhwciA/CiAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5maWx0ZXIocmV0LmV4cHIsIHJldC5zZXQpWzBdIDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnNldFswXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHJldCA9IHNlZWQgPwogICAgICAgICAgICAgICAgICAgIHsgZXhwcjogcGFydHMucG9wKCksIHNldDogbWFrZUFycmF5KHNlZWQpIH0gOgogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZmluZChwYXJ0cy5wb3AoKSwgcGFydHMubGVuZ3RoID09PSAxICYmIChwYXJ0c1swXSA9PT0gIn4iIHx8IHBhcnRzWzBdID09PSAiKyIpICYmIGNvbnRleHQucGFyZW50Tm9kZSA/IGNvbnRleHQucGFyZW50Tm9kZSA6IGNvbnRleHQsIGNvbnRleHRYTUwpOwoKICAgICAgICAgICAgICAgICAgICBzZXQgPSByZXQuZXhwciA/CiAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5maWx0ZXIocmV0LmV4cHIsIHJldC5zZXQpIDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnNldDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXQgPSBtYWtlQXJyYXkoc2V0KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJ1bmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VyID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcCA9IGN1cjsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghRXhwci5yZWxhdGl2ZVsgY3VyIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3AgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wID0gY29udGV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgRXhwci5yZWxhdGl2ZVsgY3VyIF0oY2hlY2tTZXQsIHBvcCwgY29udGV4dFhNTCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXQgPSBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWNoZWNrU2V0KSB7CiAgICAgICAgICAgICAgICBjaGVja1NldCA9IHNldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFjaGVja1NldCkgewogICAgICAgICAgICAgICAgU2l6emxlLmVycm9yKGN1ciB8fCBzZWxlY3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0b1N0cmluZy5jYWxsKGNoZWNrU2V0KSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgICAgICAgICAgICAgaWYgKCFwcnVuZSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaC5hcHBseShyZXN1bHRzLCBjaGVja1NldCk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrU2V0W2ldICYmIChjaGVja1NldFtpXSA9PT0gdHJ1ZSB8fCBjaGVja1NldFtpXS5ub2RlVHlwZSA9PT0gMSAmJiBTaXp6bGUuY29udGFpbnMoY29udGV4dCwgY2hlY2tTZXRbaV0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHNldFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrU2V0W2ldICYmIGNoZWNrU2V0W2ldLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goc2V0W2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYWtlQXJyYXkoY2hlY2tTZXQsIHJlc3VsdHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZXh0cmEpIHsKICAgICAgICAgICAgICAgIFNpenpsZShleHRyYSwgb3JpZ0NvbnRleHQsIHJlc3VsdHMsIHNlZWQpOwogICAgICAgICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQocmVzdWx0cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH07CgogICAgICAgIFNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24gKHJlc3VsdHMpIHsKICAgICAgICAgICAgaWYgKHNvcnRPcmRlcikgewogICAgICAgICAgICAgICAgaGFzRHVwbGljYXRlID0gYmFzZUhhc0R1cGxpY2F0ZTsKICAgICAgICAgICAgICAgIHJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwoKICAgICAgICAgICAgICAgIGlmIChoYXNEdXBsaWNhdGUpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHJlc3VsdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHNbaV0gPT09IHJlc3VsdHNbIGkgLSAxIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMuc3BsaWNlKGktLSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH07CgogICAgICAgIFNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24gKGV4cHIsIHNldCkgewogICAgICAgICAgICByZXR1cm4gU2l6emxlKGV4cHIsIG51bGwsIG51bGwsIHNldCk7CiAgICAgICAgfTsKCiAgICAgICAgU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uIChub2RlLCBleHByKSB7CiAgICAgICAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgW25vZGVdKS5sZW5ndGggPiAwOwogICAgICAgIH07CgogICAgICAgIFNpenpsZS5maW5kID0gZnVuY3Rpb24gKGV4cHIsIGNvbnRleHQsIGlzWE1MKSB7CiAgICAgICAgICAgIHZhciBzZXQsIGksIGxlbiwgbWF0Y2gsIHR5cGUsIGxlZnQ7CgogICAgICAgICAgICBpZiAoIWV4cHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gRXhwci5vcmRlci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgdHlwZSA9IEV4cHIub3JkZXJbaV07CgogICAgICAgICAgICAgICAgaWYgKChtYXRjaCA9IEV4cHIubGVmdE1hdGNoWyB0eXBlIF0uZXhlYyhleHByKSkpIHsKICAgICAgICAgICAgICAgICAgICBsZWZ0ID0gbWF0Y2hbMV07CiAgICAgICAgICAgICAgICAgICAgbWF0Y2guc3BsaWNlKDEsIDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAobGVmdC5zdWJzdHIobGVmdC5sZW5ndGggLSAxKSAhPT0gIlxcIikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFsxXSA9IChtYXRjaFsxXSB8fCAiIikucmVwbGFjZShyQmFja3NsYXNoLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldCA9IEV4cHIuZmluZFsgdHlwZSBdKG1hdGNoLCBjb250ZXh0LCBpc1hNTCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UoRXhwci5tYXRjaFsgdHlwZSBdLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFzZXQpIHsKICAgICAgICAgICAgICAgIHNldCA9IHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIiA/CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIDoKICAgICAgICAgICAgICAgICAgICBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsgc2V0OiBzZXQsIGV4cHI6IGV4cHIgfTsKICAgICAgICB9OwoKICAgICAgICBTaXp6bGUuZmlsdGVyID0gZnVuY3Rpb24gKGV4cHIsIHNldCwgaW5wbGFjZSwgbm90KSB7CiAgICAgICAgICAgIHZhciBtYXRjaCwgYW55Rm91bmQsCiAgICAgICAgICAgICAgICB0eXBlLCBmb3VuZCwgaXRlbSwgZmlsdGVyLCBsZWZ0LAogICAgICAgICAgICAgICAgaSwgcGFzcywKICAgICAgICAgICAgICAgIG9sZCA9IGV4cHIsCiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXSwKICAgICAgICAgICAgICAgIGN1ckxvb3AgPSBzZXQsCiAgICAgICAgICAgICAgICBpc1hNTEZpbHRlciA9IHNldCAmJiBzZXRbMF0gJiYgU2l6emxlLmlzWE1MKHNldFswXSk7CgogICAgICAgICAgICB3aGlsZSAoZXhwciAmJiBzZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBmb3IgKHR5cGUgaW4gRXhwci5maWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKG1hdGNoID0gRXhwci5sZWZ0TWF0Y2hbIHR5cGUgXS5leGVjKGV4cHIpKSAhPSBudWxsICYmIG1hdGNoWzJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlciA9IEV4cHIuZmlsdGVyWyB0eXBlIF07CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQgPSBtYXRjaFsxXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGFueUZvdW5kID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaC5zcGxpY2UoMSwgMSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVmdC5zdWJzdHIobGVmdC5sZW5ndGggLSAxKSA9PT0gIlxcIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJMb29wID09PSByZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoRXhwci5wcmVGaWx0ZXJbIHR5cGUgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBFeHByLnByZUZpbHRlclsgdHlwZSBdKG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUxGaWx0ZXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnlGb3VuZCA9IGZvdW5kID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgKGl0ZW0gPSBjdXJMb29wW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IGZpbHRlcihpdGVtLCBtYXRjaCwgaSwgY3VyTG9vcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MgPSBub3QgXiBmb3VuZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnBsYWNlICYmIGZvdW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW55Rm91bmQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyTG9vcFtpXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFueUZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5wbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1ckxvb3AgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwciA9IGV4cHIucmVwbGFjZShFeHByLm1hdGNoWyB0eXBlIF0sICIiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFueUZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEltcHJvcGVyIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgIGlmIChleHByID09PSBvbGQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYW55Rm91bmQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IoZXhwcik7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBvbGQgPSBleHByOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY3VyTG9vcDsKICAgICAgICB9OwoKICAgICAgICBTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmVpdmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICAgICAgICAgKi8KICAgICAgICB2YXIgZ2V0VGV4dCA9IFNpenpsZS5nZXRUZXh0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIGksIG5vZGUsCiAgICAgICAgICAgICAgICBub2RlVHlwZSA9IGVsZW0ubm9kZVR5cGUsCiAgICAgICAgICAgICAgICByZXQgPSAiIjsKCiAgICAgICAgICAgIGlmIChub2RlVHlwZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSkgewogICAgICAgICAgICAgICAgICAgIC8vIFVzZSB0ZXh0Q29udGVudCB8fCBpbm5lclRleHQgZm9yIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtLmlubmVyVGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVwbGFjZSBJRSdzIGNhcnJpYWdlIHJldHVybnMKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uaW5uZXJUZXh0LnJlcGxhY2UoclJldHVybiwgJycpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYXZlcnNlIGl0J3MgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9IGdldFRleHQoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyAobm9kZSA9IGVsZW1baV0pOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlICE9PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSBnZXRUZXh0KG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CgogICAgICAgIHZhciBFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKICAgICAgICAgICAgb3JkZXI6IFsgIklEIiwgIk5BTUUiLCAiVEFHIiBdLAoKICAgICAgICAgICAgbWF0Y2g6IHsKICAgICAgICAgICAgICAgIElEOiAvIygoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKS8sCiAgICAgICAgICAgICAgICBDTEFTUzogL1wuKCg/Oltcd1x1MDBjMC1cdUZGRkZcLV18XFwuKSspLywKICAgICAgICAgICAgICAgIE5BTUU6IC9cW25hbWU9WyciXSooKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKylbJyJdKlxdLywKICAgICAgICAgICAgICAgIEFUVFI6IC9cW1xzKigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKVxzKig/OihcUz89KVxzKig/OihbJyJdKSguKj8pXDN8KCM/KD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKil8KXwpXHMqXF0vLAogICAgICAgICAgICAgICAgVEFHOiAvXigoPzpbXHdcdTAwYzAtXHVGRkZGXCpcLV18XFwuKSspLywKICAgICAgICAgICAgICAgIENISUxEOiAvOihvbmx5fG50aHxsYXN0fGZpcnN0KS1jaGlsZCg/OlwoXHMqKGV2ZW58b2RkfCg/OlsrXC1dP1xkK3woPzpbK1wtXT9cZCopP25ccyooPzpbK1wtXVxzKlxkKyk/KSlccypcKSk/LywKICAgICAgICAgICAgICAgIFBPUzogLzoobnRofGVxfGd0fGx0fGZpcnN0fGxhc3R8ZXZlbnxvZGQpKD86XCgoXGQqKVwpKT8oPz1bXlwtXXwkKS8sCiAgICAgICAgICAgICAgICBQU0VVRE86IC86KCg/Oltcd1x1MDBjMC1cdUZGRkZcLV18XFwuKSspKD86XCgoWyciXT8pKCg/OlwoW15cKV0rXCl8W15cKFwpXSopKylcMlwpKT8vCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBsZWZ0TWF0Y2g6IHt9LAoKICAgICAgICAgICAgYXR0ck1hcDogewogICAgICAgICAgICAgICAgImNsYXNzIjogImNsYXNzTmFtZSIsCiAgICAgICAgICAgICAgICAiZm9yIjogImh0bWxGb3IiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhdHRySGFuZGxlOiB7CiAgICAgICAgICAgICAgICBocmVmOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHR5cGU6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWxhdGl2ZTogewogICAgICAgICAgICAgICAgIisiOiBmdW5jdGlvbiAoY2hlY2tTZXQsIHBhcnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICBpc1RhZyA9IGlzUGFydFN0ciAmJiAhck5vbldvcmQudGVzdChwYXJ0KSwKICAgICAgICAgICAgICAgICAgICAgICAgaXNQYXJ0U3RyTm90VGFnID0gaXNQYXJ0U3RyICYmICFpc1RhZzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aCwgZWxlbTsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGVsZW0gPSBjaGVja1NldFtpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoZWxlbSA9IGVsZW0ucHJldmlvdXNTaWJsaW5nKSAmJiBlbGVtLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXRbaV0gPSBpc1BhcnRTdHJOb3RUYWcgfHwgZWxlbSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IHBhcnQgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gfHwgZmFsc2UgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPT09IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1BhcnRTdHJOb3RUYWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlLmZpbHRlcihwYXJ0LCBjaGVja1NldCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiPiI6IGZ1bmN0aW9uIChjaGVja1NldCwgcGFydCkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtLAogICAgICAgICAgICAgICAgICAgICAgICBpc1BhcnRTdHIgPSB0eXBlb2YgcGFydCA9PT0gInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICBsID0gY2hlY2tTZXQubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNQYXJ0U3RyICYmICFyTm9uV29yZC50ZXN0KHBhcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGNoZWNrU2V0W2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NldFtpXSA9IHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJ0ID8gcGFyZW50IDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBjaGVja1NldFtpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2V0W2ldID0gaXNQYXJ0U3RyID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlID09PSBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQYXJ0U3RyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZmlsdGVyKHBhcnQsIGNoZWNrU2V0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgIiI6IGZ1bmN0aW9uIChjaGVja1NldCwgcGFydCwgaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZUNoZWNrLAogICAgICAgICAgICAgICAgICAgICAgICBkb25lTmFtZSA9IGRvbmUrKywKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tGbiA9IGRpckNoZWNrOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcnQgPT09ICJzdHJpbmciICYmICFyTm9uV29yZC50ZXN0KHBhcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVDaGVjayA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRm4gPSBkaXJOb2RlQ2hlY2s7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjaGVja0ZuKCJwYXJlbnROb2RlIiwgcGFydCwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgIn4iOiBmdW5jdGlvbiAoY2hlY2tTZXQsIHBhcnQsIGlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVDaGVjaywKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZU5hbWUgPSBkb25lKyssCiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRm4gPSBkaXJDaGVjazsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhck5vbldvcmQudGVzdChwYXJ0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gcGFydC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlQ2hlY2sgPSBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBjaGVja0ZuID0gZGlyTm9kZUNoZWNrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2hlY2tGbigicHJldmlvdXNTaWJsaW5nIiwgcGFydCwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbmQ6IHsKICAgICAgICAgICAgICAgIElEOiBmdW5jdGlvbiAobWF0Y2gsIGNvbnRleHQsIGlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG1hdGNoWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbSAmJiBtLnBhcmVudE5vZGUgPyBbbV0gOiBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIE5BTUU6IGZ1bmN0aW9uIChtYXRjaCwgY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUobWF0Y2hbMV0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXN1bHRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHNbaV0uZ2V0QXR0cmlidXRlKCJuYW1lIikgPT09IG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2gocmVzdWx0c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQubGVuZ3RoID09PSAwID8gbnVsbCA6IHJldDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIFRBRzogZnVuY3Rpb24gKG1hdGNoLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShtYXRjaFsxXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcmVGaWx0ZXI6IHsKICAgICAgICAgICAgICAgIENMQVNTOiBmdW5jdGlvbiAobWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTCkgewogICAgICAgICAgICAgICAgICAgIG1hdGNoID0gIiAiICsgbWF0Y2hbMV0ucmVwbGFjZShyQmFja3NsYXNoLCAiIikgKyAiICI7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1hNTCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBjdXJMb29wW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3QgXiAoZWxlbS5jbGFzc05hbWUgJiYgKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXHRcblxyXS9nLCAiICIpLmluZGV4T2YobWF0Y2gpID49IDApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlucGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJMb29wW2ldID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgSUQ6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaFsxXS5yZXBsYWNlKHJCYWNrc2xhc2gsICIiKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgVEFHOiBmdW5jdGlvbiAobWF0Y2gsIGN1ckxvb3ApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hbMV0ucmVwbGFjZShyQmFja3NsYXNoLCAiIikudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgQ0hJTEQ6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFsxXSA9PT0gIm50aCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaFsyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbMl0gPSBtYXRjaFsyXS5yZXBsYWNlKC9eXCt8XHMqL2csICcnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcnNlIGVxdWF0aW9ucyBsaWtlICdldmVuJywgJ29kZCcsICc1JywgJzJuJywgJzNuKzInLCAnNG4tMScsICctbis2JwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVzdCA9IC8oLT8pKFxkKikoPzpuKFsrXC1dP1xkKikpPy8uZXhlYygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoWzJdID09PSAiZXZlbiIgJiYgIjJuIiB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgJiYgIjJuKzEiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIS9cRC8udGVzdChtYXRjaFsyXSkgJiYgIjBuKyIgKyBtYXRjaFsyXSB8fCBtYXRjaFsyXSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGUgdGhlIG51bWJlcnMgKGZpcnN0KW4rKGxhc3QpIGluY2x1ZGluZyBpZiB0aGV5IGFyZSBuZWdhdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFsyXSA9ICh0ZXN0WzFdICsgKHRlc3RbMl0gfHwgMSkpIC0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbM10gPSB0ZXN0WzNdIC0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IE1vdmUgdG8gbm9ybWFsIGNhY2hpbmcgc3lzdGVtCiAgICAgICAgICAgICAgICAgICAgbWF0Y2hbMF0gPSBkb25lKys7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgQVRUUjogZnVuY3Rpb24gKG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZShyQmFja3NsYXNoLCAiIik7CgogICAgICAgICAgICAgICAgICAgIGlmICghaXNYTUwgJiYgRXhwci5hdHRyTWFwW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoWzFdID0gRXhwci5hdHRyTWFwW25hbWVdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIGlmIGFuIHVuLXF1b3RlZCB2YWx1ZSB3YXMgdXNlZAogICAgICAgICAgICAgICAgICAgIG1hdGNoWzRdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UockJhY2tzbGFzaCwgIiIpOwoKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hbMl0gPT09ICJ+PSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbNF0gPSAiICIgKyBtYXRjaFs0XSArICIgIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgUFNFVURPOiBmdW5jdGlvbiAobWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzFdID09PSAibm90IikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBjb21wbGV4IGV4cHJlc3Npb24sIG9yIGEgc2ltcGxlIG9uZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCBjaHVua2VyLmV4ZWMobWF0Y2hbM10pIHx8ICIiICkubGVuZ3RoID4gMSB8fCAvXlx3Ly50ZXN0KG1hdGNoWzNdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbM10gPSBTaXp6bGUobWF0Y2hbM10sIG51bGwsIG51bGwsIGN1ckxvb3ApOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBTaXp6bGUuZmlsdGVyKG1hdGNoWzNdLCBjdXJMb29wLCBpbnBsYWNlLCB0cnVlIF4gbm90KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlucGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaC5hcHBseShyZXN1bHQsIHJldCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRXhwci5tYXRjaC5QT1MudGVzdChtYXRjaFswXSkgfHwgRXhwci5tYXRjaC5DSElMRC50ZXN0KG1hdGNoWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgUE9TOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICBtYXRjaC51bnNoaWZ0KHRydWUpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmaWx0ZXJzOiB7CiAgICAgICAgICAgICAgICBlbmFibGVkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZSAmJiBlbGVtLnR5cGUgIT09ICJoaWRkZW4iOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgY2hlY2tlZDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5jaGVja2VkID09PSB0cnVlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBzZWxlY3RlZDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5zZWxlY3RlZCA9PT0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhIWVsZW0uZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFlbGVtLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGhhczogZnVuY3Rpb24gKGVsZW0sIGksIG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhU2l6emxlKG1hdGNoWzNdLCBlbGVtKS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGhlYWRlcjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKC9oXGQvaSkudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIiksIHR5cGUgPSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgLy8gSUU2IGFuZCA3IHdpbGwgbWFwIGVsZW0udHlwZSB0byAndGV4dCcgZm9yIG5ldyBIVE1MNSB0eXBlcyAoc2VhcmNoLCBldGMpCiAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGdldEF0dHJpYnV0ZSBpbnN0ZWFkIHRvIHRlc3QgdGhpcyBjYXNlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAidGV4dCIgPT09IHR5cGUgJiYgKCBhdHRyID09PSB0eXBlIHx8IGF0dHIgPT09IG51bGwgKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcmFkaW86IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAicmFkaW8iID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGNoZWNrYm94OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgImNoZWNrYm94IiA9PT0gZWxlbS50eXBlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBmaWxlOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgImZpbGUiID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgInBhc3N3b3JkIiA9PT0gZWxlbS50eXBlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBzdWJtaXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiAic3VibWl0IiA9PT0gZWxlbS50eXBlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBpbWFnZTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJpbWFnZSIgPT09IGVsZW0udHlwZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiAicmVzZXQiID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGJ1dHRvbjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiAiYnV0dG9uIiA9PT0gZWxlbS50eXBlIHx8IG5hbWUgPT09ICJidXR0b24iOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBpbnB1dDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uL2kpLnRlc3QoZWxlbS5ub2RlTmFtZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0RmlsdGVyczogewogICAgICAgICAgICAgICAgZmlyc3Q6IGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkgPT09IDA7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGxhc3Q6IGZ1bmN0aW9uIChlbGVtLCBpLCBtYXRjaCwgYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSA9PT0gYXJyYXkubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZXZlbjogZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSAlIDIgPT09IDA7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIG9kZDogZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSAlIDIgPT09IDE7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGx0OiBmdW5jdGlvbiAoZWxlbSwgaSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSA8IG1hdGNoWzNdIC0gMDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZ3Q6IGZ1bmN0aW9uIChlbGVtLCBpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpID4gbWF0Y2hbM10gLSAwOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBudGg6IGZ1bmN0aW9uIChlbGVtLCBpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaFszXSAtIDAgPT09IGk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGVxOiBmdW5jdGlvbiAoZWxlbSwgaSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hbM10gLSAwID09PSBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmaWx0ZXI6IHsKICAgICAgICAgICAgICAgIFBTRVVETzogZnVuY3Rpb24gKGVsZW0sIG1hdGNoLCBpLCBhcnJheSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gbWF0Y2hbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlciA9IEV4cHIuZmlsdGVyc1sgbmFtZSBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXIoZWxlbSwgaSwgbWF0Y2gsIGFycmF5KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAiY29udGFpbnMiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KFsgZWxlbSBdKSB8fCAiIikuaW5kZXhPZihtYXRjaFszXSkgPj0gMDsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAibm90IikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm90ID0gbWF0Y2hbM107CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgbCA9IG5vdC5sZW5ndGg7IGogPCBsOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3Rbal0gPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBDSElMRDogZnVuY3Rpb24gKGVsZW0sIG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0LCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICBkb25lTmFtZSwgcGFyZW50LCBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgY291bnQsIGRpZmYsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGVsZW07CgogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJvbmx5IjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZmlyc3QiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gImZpcnN0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwoKICAgICAgICAgICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJsYXN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm50aCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IG1hdGNoWzNdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZU5hbWUgPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50ICYmIChwYXJlbnRbIGV4cGFuZG8gXSAhPT0gZG9uZU5hbWUgfHwgIWVsZW0ubm9kZUluZGV4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChub2RlID0gcGFyZW50LmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm5vZGVJbmRleCA9ICsrY291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFsgZXhwYW5kbyBdID0gZG9uZU5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZiA9IGVsZW0ubm9kZUluZGV4IC0gbGFzdDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3QgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgSUQ6IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBtYXRjaDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgVEFHOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG1hdGNoID09PSAiKiIgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgfHwgISFlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbWF0Y2g7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIENMQVNTOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCIgIiArIChlbGVtLmNsYXNzTmFtZSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3MiKSkgKyAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5pbmRleE9mKG1hdGNoKSA+IC0xOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBBVFRSOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IG1hdGNoWzFdLAogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBTaXp6bGUuYXR0ciA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuYXR0cihlbGVtLCBuYW1lKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeHByLmF0dHJIYW5kbGVbIG5hbWUgXSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXhwci5hdHRySGFuZGxlWyBuYW1lIF0oZWxlbSkgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1bIG5hbWUgXSAhPSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgbmFtZSBdIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0ICsgIiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBtYXRjaFsyXSwKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBtYXRjaFs0XTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIiE9IiA6CiAgICAgICAgICAgICAgICAgICAgICAgICF0eXBlICYmIFNpenpsZS5hdHRyID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCAhPSBudWxsIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICI9IiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPT09IGNoZWNrIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSAiKj0iID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuaW5kZXhPZihjaGVjaykgPj0gMCA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICJ+PSIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCIgIiArIHZhbHVlICsgIiAiKS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICFjaGVjayA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgJiYgcmVzdWx0ICE9PSBmYWxzZSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIiE9IiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICE9PSBjaGVjayA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICJePSIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuaW5kZXhPZihjaGVjaykgPT09IDAgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIiQ9IiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc3Vic3RyKHZhbHVlLmxlbmd0aCAtIGNoZWNrLmxlbmd0aCkgPT09IGNoZWNrIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSAifD0iID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPT09IGNoZWNrIHx8IHZhbHVlLnN1YnN0cigwLCBjaGVjay5sZW5ndGggKyAxKSA9PT0gY2hlY2sgKyAiLSIgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWxzZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgUE9TOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gsIGksIGFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBtYXRjaFsyXSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyID0gRXhwci5zZXRGaWx0ZXJzWyBuYW1lIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcihlbGVtLCBpLCBtYXRjaCwgYXJyYXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBvcmlnUE9TID0gRXhwci5tYXRjaC5QT1MsCiAgICAgICAgICAgIGZlc2NhcGUgPSBmdW5jdGlvbiAoYWxsLCBudW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiAiXFwiICsgKG51bSAtIDAgKyAxKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgZm9yICh2YXIgdHlwZSBpbiBFeHByLm1hdGNoKSB7CiAgICAgICAgICAgIEV4cHIubWF0Y2hbIHR5cGUgXSA9IG5ldyBSZWdFeHAoRXhwci5tYXRjaFsgdHlwZSBdLnNvdXJjZSArICgvKD8hW15cW10qXF0pKD8hW15cKF0qXCkpLy5zb3VyY2UpKTsKICAgICAgICAgICAgRXhwci5sZWZ0TWF0Y2hbIHR5cGUgXSA9IG5ldyBSZWdFeHAoLyheKD86LnxccnxcbikqPykvLnNvdXJjZSArIEV4cHIubWF0Y2hbIHR5cGUgXS5zb3VyY2UucmVwbGFjZSgvXFwoXGQrKS9nLCBmZXNjYXBlKSk7CiAgICAgICAgfQovLyBFeHBvc2Ugb3JpZ1BPUwovLyAiZ2xvYmFsIiBhcyBpbiByZWdhcmRsZXNzIG9mIHJlbGF0aW9uIHRvIGJyYWNrZXRzL3BhcmVucwogICAgICAgIEV4cHIubWF0Y2guZ2xvYmFsUE9TID0gb3JpZ1BPUzsKCiAgICAgICAgdmFyIG1ha2VBcnJheSA9IGZ1bmN0aW9uIChhcnJheSwgcmVzdWx0cykgewogICAgICAgICAgICBhcnJheSA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFycmF5LCAwKTsKCiAgICAgICAgICAgIGlmIChyZXN1bHRzKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2guYXBwbHkocmVzdWx0cywgYXJyYXkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICB9OwoKLy8gUGVyZm9ybSBhIHNpbXBsZSBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGhlIGJyb3dzZXIgaXMgY2FwYWJsZSBvZgovLyBjb252ZXJ0aW5nIGEgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgYnVpbHRpbiBtZXRob2RzLgovLyBBbHNvIHZlcmlmaWVzIHRoYXQgdGhlIHJldHVybmVkIGFycmF5IGhvbGRzIERPTSBub2RlcwovLyAod2hpY2ggaXMgbm90IHRoZSBjYXNlIGluIHRoZSBCbGFja2JlcnJ5IGJyb3dzZXIpCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNoaWxkTm9kZXMsIDApWzBdLm5vZGVUeXBlOwoKLy8gUHJvdmlkZSBhIGZhbGxiYWNrIG1ldGhvZCBpZiBpdCBkb2VzIG5vdCB3b3JrCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBtYWtlQXJyYXkgPSBmdW5jdGlvbiAoYXJyYXksIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gMCwKICAgICAgICAgICAgICAgICAgICByZXQgPSByZXN1bHRzIHx8IFtdOwoKICAgICAgICAgICAgICAgIGlmICh0b1N0cmluZy5jYWxsKGFycmF5KSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgICAgICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHJldCwgYXJyYXkpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcnJheS5sZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgYXJyYXlbaV07IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goYXJyYXlbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICB2YXIgc29ydE9yZGVyLCBzaWJsaW5nQ2hlY2s7CgogICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgc29ydE9yZGVyID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gfHwgIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IDE7CiAgICAgICAgICAgIH07CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNvcnRPcmRlciA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgbm9kZXMgYXJlIGlkZW50aWNhbCwgd2UgY2FuIGV4aXQgZWFybHkKICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKCiAgICAgICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gdXNpbmcgc291cmNlSW5kZXggKGluIElFKSBpZiBpdCdzIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGEuc291cmNlSW5kZXggJiYgYi5zb3VyY2VJbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgYWwsIGJsLAogICAgICAgICAgICAgICAgICAgIGFwID0gW10sCiAgICAgICAgICAgICAgICAgICAgYnAgPSBbXSwKICAgICAgICAgICAgICAgICAgICBhdXAgPSBhLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgYnVwID0gYi5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgIGN1ciA9IGF1cDsKCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzIChvciBpZGVudGljYWwpIHdlIGNhbiBkbyBhIHF1aWNrIGNoZWNrCiAgICAgICAgICAgICAgICBpZiAoYXVwID09PSBidXApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2libGluZ0NoZWNrKGEsIGIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBubyBwYXJlbnRzIHdlcmUgZm91bmQgdGhlbiB0aGUgbm9kZXMgYXJlIGRpc2Nvbm5lY3RlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYXVwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJ1cCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSB0aGV5J3JlIHNvbWV3aGVyZSBlbHNlIGluIHRoZSB0cmVlIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgIC8vIHRvIGJ1aWxkIHVwIGEgZnVsbCBsaXN0IG9mIHRoZSBwYXJlbnROb2RlcyBmb3IgY29tcGFyaXNvbgogICAgICAgICAgICAgICAgd2hpbGUgKGN1cikgewogICAgICAgICAgICAgICAgICAgIGFwLnVuc2hpZnQoY3VyKTsKICAgICAgICAgICAgICAgICAgICBjdXIgPSBjdXIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdXIgPSBidXA7CgogICAgICAgICAgICAgICAgd2hpbGUgKGN1cikgewogICAgICAgICAgICAgICAgICAgIGJwLnVuc2hpZnQoY3VyKTsKICAgICAgICAgICAgICAgICAgICBjdXIgPSBjdXIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhbCA9IGFwLmxlbmd0aDsKICAgICAgICAgICAgICAgIGJsID0gYnAubGVuZ3RoOwoKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IHdhbGtpbmcgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFsICYmIGkgPCBibDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFwW2ldICE9PSBicFtpXSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2libGluZ0NoZWNrKGFwW2ldLCBicFtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFdlIGVuZGVkIHNvbWVwbGFjZSB1cCB0aGUgdHJlZSBzbyBkbyBhIHNpYmxpbmcgY2hlY2sKICAgICAgICAgICAgICAgIHJldHVybiBpID09PSBhbCA/CiAgICAgICAgICAgICAgICAgICAgc2libGluZ0NoZWNrKGEsIGJwW2ldLCAtMSkgOgogICAgICAgICAgICAgICAgICAgIHNpYmxpbmdDaGVjayhhcFtpXSwgYiwgMSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzaWJsaW5nQ2hlY2sgPSBmdW5jdGlvbiAoYSwgYiwgcmV0KSB7CiAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGN1ciA9IGEubmV4dFNpYmxpbmc7CgogICAgICAgICAgICAgICAgd2hpbGUgKGN1cikgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXIgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY3VyID0gY3VyLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9OwogICAgICAgIH0KCi8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUgd2hlbgovLyBxdWVyeWluZyBieSBnZXRFbGVtZW50QnlJZCAoYW5kIHByb3ZpZGUgYSB3b3JrYXJvdW5kKQogICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIFdlJ3JlIGdvaW5nIHRvIGluamVjdCBhIGZha2UgaW5wdXQgZWxlbWVudCB3aXRoIGEgc3BlY2lmaWVkIG5hbWUKICAgICAgICAgICAgdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgICAgICAgICAgIGlkID0gInNjcmlwdCIgKyAobmV3IERhdGUoKSkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgIGZvcm0uaW5uZXJIVE1MID0gIjxhIG5hbWU9JyIgKyBpZCArICInLz4iOwoKICAgICAgICAgICAgLy8gSW5qZWN0IGl0IGludG8gdGhlIHJvb3QgZWxlbWVudCwgY2hlY2sgaXRzIHN0YXR1cywgYW5kIHJlbW92ZSBpdCBxdWlja2x5CiAgICAgICAgICAgIHJvb3QuaW5zZXJ0QmVmb3JlKGZvcm0sIHJvb3QuZmlyc3RDaGlsZCk7CgogICAgICAgICAgICAvLyBUaGUgd29ya2Fyb3VuZCBoYXMgdG8gZG8gYWRkaXRpb25hbCBjaGVja3MgYWZ0ZXIgYSBnZXRFbGVtZW50QnlJZAogICAgICAgICAgICAvLyBXaGljaCBzbG93cyB0aGluZ3MgZG93biBmb3Igb3RoZXIgYnJvd3NlcnMgKGhlbmNlIHRoZSBicmFuY2hpbmcpCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpIHsKICAgICAgICAgICAgICAgIEV4cHIuZmluZC5JRCA9IGZ1bmN0aW9uIChtYXRjaCwgY29udGV4dCwgaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG0gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gbWF0Y2hbMV0gfHwgdHlwZW9mIG0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gInVuZGVmaW5lZCIgJiYgbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpLm5vZGVWYWx1ZSA9PT0gbWF0Y2hbMV0gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFttXSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgRXhwci5maWx0ZXIuSUQgPSBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgbm9kZSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gbWF0Y2g7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByb290LnJlbW92ZUNoaWxkKGZvcm0pOwoKICAgICAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICAgICAgcm9vdCA9IGZvcm0gPSBudWxsOwogICAgICAgIH0pKCk7CgogICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIG9ubHkgZWxlbWVudHMKICAgICAgICAgICAgLy8gd2hlbiBkb2luZyBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpCgogICAgICAgICAgICAvLyBDcmVhdGUgYSBmYWtlIGVsZW1lbnQKICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikpOwoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIG5vIGNvbW1lbnRzIGFyZSBmb3VuZAogICAgICAgICAgICBpZiAoZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgRXhwci5maW5kLlRBRyA9IGZ1bmN0aW9uIChtYXRjaCwgY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShtYXRjaFsxXSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hbMV0gPT09ICIqIikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gW107CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgcmVzdWx0c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0c1tpXS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcC5wdXNoKHJlc3VsdHNbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gdG1wOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgYW4gYXR0cmlidXRlIHJldHVybnMgbm9ybWFsaXplZCBocmVmIGF0dHJpYnV0ZXMKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCiAgICAgICAgICAgIGlmIChkaXYuZmlyc3RDaGlsZCAmJiB0eXBlb2YgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlICE9PSAidW5kZWZpbmVkIiAmJgogICAgICAgICAgICAgICAgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgIT09ICIjIikgewoKICAgICAgICAgICAgICAgIEV4cHIuYXR0ckhhbmRsZS5ocmVmID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImhyZWYiLCAyKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5IGluIElFCiAgICAgICAgICAgIGRpdiA9IG51bGw7CiAgICAgICAgfSkoKTsKCiAgICAgICAgaWYgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRTaXp6bGUgPSBTaXp6bGUsCiAgICAgICAgICAgICAgICAgICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgICAgICAgICAgaWQgPSAiX19zaXp6bGVfXyI7CgogICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8cCBjbGFzcz0nVEVTVCc+PC9wPiI7CgogICAgICAgICAgICAgICAgLy8gU2FmYXJpIGNhbid0IGhhbmRsZSB1cHBlcmNhc2Ugb3IgdW5pY29kZSBjaGFyYWN0ZXJzIHdoZW4KICAgICAgICAgICAgICAgIC8vIGluIHF1aXJrcyBtb2RlLgogICAgICAgICAgICAgICAgaWYgKGRpdi5xdWVyeVNlbGVjdG9yQWxsICYmIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCIuVEVTVCIpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBTaXp6bGUgPSBmdW5jdGlvbiAocXVlcnksIGNvbnRleHQsIGV4dHJhLCBzZWVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgdXNlIHF1ZXJ5U2VsZWN0b3JBbGwgb24gbm9uLVhNTCBkb2N1bWVudHMKICAgICAgICAgICAgICAgICAgICAvLyAoSUQgc2VsZWN0b3JzIGRvbid0IHdvcmsgaW4gbm9uLUhUTUwgZG9jdW1lbnRzKQogICAgICAgICAgICAgICAgICAgIGlmICghc2VlZCAmJiAhU2l6emxlLmlzWE1MKGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlZSBpZiB3ZSBmaW5kIGEgc2VsZWN0b3IgdG8gc3BlZWQgdXAKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gL14oXHcrJCl8XlwuKFtcd1wtXSskKXxeIyhbXHdcLV0rJCkvLmV4ZWMocXVlcnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoICYmIChjb250ZXh0Lm5vZGVUeXBlID09PSAxIHx8IGNvbnRleHQubm9kZVR5cGUgPT09IDkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHF1ZXJ5KSwgZXh0cmEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsyXSAmJiBFeHByLmZpbmQuQ0xBU1MgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobWF0Y2hbMl0pLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0Lm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVlZC11cDogU2l6emxlKCJib2R5IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBib2R5IGVsZW1lbnQgb25seSBleGlzdHMgb25jZSwgb3B0aW1pemUgZmluZGluZyBpdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5ID09PSAiYm9keSIgJiYgY29udGV4dC5ib2R5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShbIGNvbnRleHQuYm9keSBdLCBleHRyYSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoICYmIG1hdGNoWzNdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG1hdGNoWzNdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5pZCA9PT0gbWF0Y2hbM10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlQXJyYXkoWyBlbGVtIF0sIGV4dHJhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUFycmF5KFtdLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkpLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChxc2FFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0Lm5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gY29udGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuaWQgPSBvbGQgfHwgaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUGFyZW50ID0gY29udGV4dC5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlSGllcmFyY2h5U2VsZWN0b3IgPSAvXlxzKlsrfl0vLnRlc3QocXVlcnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5zZXRBdHRyaWJ1dGUoImlkIiwgbmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmlkID0gbmlkLnJlcGxhY2UoLycvZywgIlxcJCYiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGl2ZUhpZXJhcmNoeVNlbGVjdG9yICYmIGhhc1BhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0aXZlSGllcmFyY2h5U2VsZWN0b3IgfHwgaGFzUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlQXJyYXkoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCJbaWQ9JyIgKyBuaWQgKyAiJ10gIiArIHF1ZXJ5KSwgZXh0cmEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChwc2V1ZG9FcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9sZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRDb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBvbGRTaXp6bGUocXVlcnksIGNvbnRleHQsIGV4dHJhLCBzZWVkKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvbGRTaXp6bGUpIHsKICAgICAgICAgICAgICAgICAgICBTaXp6bGVbIHByb3AgXSA9IG9sZFNpenpsZVsgcHJvcCBdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5IGluIElFCiAgICAgICAgICAgICAgICBkaXYgPSBudWxsOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBtYXRjaGVzID0gaHRtbC5tYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC5tc01hdGNoZXNTZWxlY3RvcjsKCiAgICAgICAgICAgIGlmIChtYXRjaGVzKSB7CiAgICAgICAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKICAgICAgICAgICAgICAgIC8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkgZmFpbHMgdGhpcykKICAgICAgICAgICAgICAgIHZhciBkaXNjb25uZWN0ZWRNYXRjaCA9ICFtYXRjaGVzLmNhbGwoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksICJkaXYiKSwKICAgICAgICAgICAgICAgICAgICBwc2V1ZG9Xb3JrcyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgogICAgICAgICAgICAgICAgICAgIC8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLmNhbGwoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiW3Rlc3QhPScnXTpzaXp6bGUiKTsKCiAgICAgICAgICAgICAgICB9IGNhdGNoIChwc2V1ZG9FcnJvcikgewogICAgICAgICAgICAgICAgICAgIHBzZXVkb1dvcmtzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKG5vZGUsIGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKICAgICAgICAgICAgICAgICAgICBleHByID0gZXhwci5yZXBsYWNlKC9cPVxzKihbXiciXF1dKilccypcXS9nLCAiPSckMSddIik7CgogICAgICAgICAgICAgICAgICAgIGlmICghU2l6emxlLmlzWE1MKG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHNldWRvV29ya3MgfHwgIUV4cHIubWF0Y2guUFNFVURPLnRlc3QoZXhwcikgJiYgIS8hPS8udGVzdChleHByKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBtYXRjaGVzLmNhbGwobm9kZSwgZXhwcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0IHx8ICFkaXNjb25uZWN0ZWRNYXRjaCB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmcmFnbWVudCBpbiBJRSA5LCBzbyBjaGVjayBmb3IgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRvY3VtZW50ICYmIG5vZGUuZG9jdW1lbnQubm9kZVR5cGUgIT09IDExKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgW25vZGVdKS5sZW5ndGggPiAwOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0pKCk7CgogICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPGRpdiBjbGFzcz0ndGVzdCBlJz48L2Rpdj48ZGl2IGNsYXNzPSd0ZXN0Jz48L2Rpdj4iOwoKICAgICAgICAgICAgLy8gT3BlcmEgY2FuJ3QgZmluZCBhIHNlY29uZCBjbGFzc25hbWUgKGluIDkuNikKICAgICAgICAgICAgLy8gQWxzbywgbWFrZSBzdXJlIHRoYXQgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBhY3R1YWxseSBleGlzdHMKICAgICAgICAgICAgaWYgKCFkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTYWZhcmkgY2FjaGVzIGNsYXNzIGF0dHJpYnV0ZXMsIGRvZXNuJ3QgY2F0Y2ggY2hhbmdlcyAoaW4gMy4yKQogICAgICAgICAgICBkaXYubGFzdENoaWxkLmNsYXNzTmFtZSA9ICJlIjsKCiAgICAgICAgICAgIGlmIChkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBFeHByLm9yZGVyLnNwbGljZSgxLCAwLCAiQ0xBU1MiKTsKICAgICAgICAgICAgRXhwci5maW5kLkNMQVNTID0gZnVuY3Rpb24gKG1hdGNoLCBjb250ZXh0LCBpc1hNTCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICAgICAgZGl2ID0gbnVsbDsKICAgICAgICB9KSgpOwoKICAgICAgICBmdW5jdGlvbiBkaXJOb2RlQ2hlY2soZGlyLCBjdXIsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBjaGVja1NldFtpXTsKCiAgICAgICAgICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbVtkaXJdOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbVsgZXhwYW5kbyBdID09PSBkb25lTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBleHBhbmRvIF0gPSBkb25lTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc2l6c2V0ID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gY3VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IGVsZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW1bZGlyXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNoZWNrU2V0W2ldID0gbWF0Y2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRpckNoZWNrKGRpciwgY3VyLCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGVja1NldC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtID0gY2hlY2tTZXRbaV07CgogICAgICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW1bZGlyXTsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1bIGV4cGFuZG8gXSA9PT0gZG9uZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gY2hlY2tTZXRbZWxlbS5zaXpzZXRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgZXhwYW5kbyBdID0gZG9uZU5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5zaXpzZXQgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtID09PSBjdXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChTaXp6bGUuZmlsdGVyKGN1ciwgW2VsZW1dKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBlbGVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbVtkaXJdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXRbaV0gPSBtYXRjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb250YWlucykgewogICAgICAgICAgICBTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGEgIT09IGIgJiYgKGEuY29udGFpbnMgPyBhLmNvbnRhaW5zKGIpIDogdHJ1ZSk7CiAgICAgICAgICAgIH07CgogICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgIFNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gISEoYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDE2KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgU2l6emxlLmlzWE1MID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdAogICAgICAgICAgICAvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykKICAgICAgICAgICAgdmFyIGRvY3VtZW50RWxlbWVudCA9IChlbGVtID8gZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gOiAwKS5kb2N1bWVudEVsZW1lbnQ7CgogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICB2YXIgcG9zUHJvY2VzcyA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgc2VlZCkgewogICAgICAgICAgICB2YXIgbWF0Y2gsCiAgICAgICAgICAgICAgICB0bXBTZXQgPSBbXSwKICAgICAgICAgICAgICAgIGxhdGVyID0gIiIsCiAgICAgICAgICAgICAgICByb290ID0gY29udGV4dC5ub2RlVHlwZSA/IFtjb250ZXh0XSA6IGNvbnRleHQ7CgogICAgICAgICAgICAvLyBQb3NpdGlvbiBzZWxlY3RvcnMgbXVzdCBiZSBkb25lIGFmdGVyIHRoZSBmaWx0ZXIKICAgICAgICAgICAgLy8gQW5kIHNvIG11c3QgOm5vdChwb3NpdGlvbmFsKSBzbyB3ZSBtb3ZlIGFsbCBQU0VVRE9zIHRvIHRoZSBlbmQKICAgICAgICAgICAgd2hpbGUgKChtYXRjaCA9IEV4cHIubWF0Y2guUFNFVURPLmV4ZWMoc2VsZWN0b3IpKSkgewogICAgICAgICAgICAgICAgbGF0ZXIgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoRXhwci5tYXRjaC5QU0VVRE8sICIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZWN0b3IgPSBFeHByLnJlbGF0aXZlW3NlbGVjdG9yXSA/IHNlbGVjdG9yICsgIioiIDogc2VsZWN0b3I7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHJvb3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBTaXp6bGUoc2VsZWN0b3IsIHJvb3RbaV0sIHRtcFNldCwgc2VlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBTaXp6bGUuZmlsdGVyKGxhdGVyLCB0bXBTZXQpOwogICAgICAgIH07CgovLyBFWFBPU0UKLy8gT3ZlcnJpZGUgc2l6emxlIGF0dHJpYnV0ZSByZXRyaWV2YWwKICAgICAgICBTaXp6bGUuYXR0ciA9IGpRdWVyeS5hdHRyOwogICAgICAgIFNpenpsZS5zZWxlY3RvcnMuYXR0ck1hcCA9IHt9OwogICAgICAgIGpRdWVyeS5maW5kID0gU2l6emxlOwogICAgICAgIGpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKICAgICAgICBqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIuZmlsdGVyczsKICAgICAgICBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CiAgICAgICAgalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsKICAgICAgICBqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CiAgICAgICAgalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwoKCiAgICB9KSgpOwoKCiAgICB2YXIgcnVudGlsID0gL1VudGlsJC8sCiAgICAgICAgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXZVbnRpbHxwcmV2QWxsKS8sCiAgICAvLyBOb3RlOiBUaGlzIFJlZ0V4cCBzaG91bGQgYmUgaW1wcm92ZWQsIG9yIGxpa2VseSBwdWxsZWQgZnJvbSBTaXp6bGUKICAgICAgICBybXVsdGlzZWxlY3RvciA9IC8sLywKICAgICAgICBpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC8sCiAgICAgICAgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgUE9TID0galF1ZXJ5LmV4cHIubWF0Y2guZ2xvYmFsUE9TLAogICAgLy8gbWV0aG9kcyBndWFyYW50ZWVkIHRvIHByb2R1Y2UgYSB1bmlxdWUgc2V0IHdoZW4gc3RhcnRpbmcgZnJvbSBhIHVuaXF1ZSBzZXQKICAgICAgICBndWFyYW50ZWVkVW5pcXVlID0gewogICAgICAgICAgICBjaGlsZHJlbjogdHJ1ZSwKICAgICAgICAgICAgY29udGVudHM6IHRydWUsCiAgICAgICAgICAgIG5leHQ6IHRydWUsCiAgICAgICAgICAgIHByZXY6IHRydWUKICAgICAgICB9OwoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICBpLCBsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNlbGYubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuY29udGFpbnMoc2VsZlsgaSBdLCB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHJldCA9IHRoaXMucHVzaFN0YWNrKCIiLCAiZmluZCIsIHNlbGVjdG9yKSwKICAgICAgICAgICAgICAgIGxlbmd0aCwgbiwgcjsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgbGVuZ3RoID0gcmV0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGpRdWVyeS5maW5kKHNlbGVjdG9yLCB0aGlzW2ldLCByZXQpOwoKICAgICAgICAgICAgICAgIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXN1bHRzIGFyZSB1bmlxdWUKICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSBsZW5ndGg7IG4gPCByZXQubGVuZ3RoOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyID0gMDsgciA8IGxlbmd0aDsgcisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0W3JdID09PSByZXRbbl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQuc3BsaWNlKG4tLSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgaGFzOiBmdW5jdGlvbiAodGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRzID0galF1ZXJ5KHRhcmdldCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRhcmdldHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyh0aGlzLCB0YXJnZXRzW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIG5vdDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IsIGZhbHNlKSwgIm5vdCIsIHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sod2lubm93KHRoaXMsIHNlbGVjdG9yLCB0cnVlKSwgImZpbHRlciIsIHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBpczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiAhIXNlbGVjdG9yICYmICgKICAgICAgICAgICAgICAgIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPwogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKICAgICAgICAgICAgICAgICAgICAvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCiAgICAgICAgICAgICAgICAgICAgUE9TLnRlc3Qoc2VsZWN0b3IpID8KICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHNlbGVjdG9yLCB0aGlzLmNvbnRleHQpLmluZGV4KHRoaXNbMF0pID49IDAgOgogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCB0aGlzKS5sZW5ndGggPiAwIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcihzZWxlY3RvcikubGVuZ3RoID4gMCApOwogICAgICAgIH0sCgogICAgICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIChzZWxlY3RvcnMsIGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHJldCA9IFtdLCBpLCBsLCBjdXIgPSB0aGlzWzBdOwoKICAgICAgICAgICAgLy8gQXJyYXkgKGRlcHJlY2F0ZWQgYXMgb2YgalF1ZXJ5IDEuNykKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHNlbGVjdG9ycykpIHsKICAgICAgICAgICAgICAgIHZhciBsZXZlbCA9IDE7CgogICAgICAgICAgICAgICAgd2hpbGUgKGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VsZWN0b3JzLmxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5KGN1cikuaXMoc2VsZWN0b3JzWyBpIF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaCh7IHNlbGVjdG9yOiBzZWxlY3RvcnNbIGkgXSwgZWxlbTogY3VyLCBsZXZlbDogbGV2ZWwgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGxldmVsKys7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RyaW5nCiAgICAgICAgICAgIHZhciBwb3MgPSBQT1MudGVzdChzZWxlY3RvcnMpIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KICAgICAgICAgICAgICAgIGpRdWVyeShzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0KSA6CiAgICAgICAgICAgICAgICAwOwoKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdXIgPSB0aGlzW2ldOwoKICAgICAgICAgICAgICAgIHdoaWxlIChjdXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9zID8gcG9zLmluZGV4KGN1cikgPiAtMSA6IGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goY3VyKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWN1ciB8fCAhY3VyLm93bmVyRG9jdW1lbnQgfHwgY3VyID09PSBjb250ZXh0IHx8IGN1ci5ub2RlVHlwZSA9PT0gMTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXQgPSByZXQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUocmV0KSA6IHJldDsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyZXQsICJjbG9zZXN0Iiwgc2VsZWN0b3JzKTsKICAgICAgICB9LAoKICAgICAgICAvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCiAgICAgICAgLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCiAgICAgICAgaW5kZXg6IGZ1bmN0aW9uIChlbGVtKSB7CgogICAgICAgICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICAgICAgICBpZiAoIWVsZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiAoIHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlICkgPyB0aGlzLnByZXZBbGwoKS5sZW5ndGggOiAtMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaW5kZXggaW4gc2VsZWN0b3IKICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5pbkFycmF5KHRoaXNbMF0sIGpRdWVyeShlbGVtKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIExvY2F0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIGRlc2lyZWQgZWxlbWVudAogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkoCiAgICAgICAgICAgICAgICAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgICAgICAgICAgIGVsZW0uanF1ZXJ5ID8gZWxlbVswXSA6IGVsZW0sIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIGFkZDogZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KICAgICAgICAgICAgICAgICAgICBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpIDoKICAgICAgICAgICAgICAgICAgICBqUXVlcnkubWFrZUFycmF5KHNlbGVjdG9yICYmIHNlbGVjdG9yLm5vZGVUeXBlID8gWyBzZWxlY3RvciBdIDogc2VsZWN0b3IpLAogICAgICAgICAgICAgICAgYWxsID0galF1ZXJ5Lm1lcmdlKHRoaXMuZ2V0KCksIHNldCk7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soaXNEaXNjb25uZWN0ZWQoc2V0WzBdKSB8fCBpc0Rpc2Nvbm5lY3RlZChhbGxbMF0pID8KICAgICAgICAgICAgICAgIGFsbCA6CiAgICAgICAgICAgICAgICBqUXVlcnkudW5pcXVlKGFsbCkpOwogICAgICAgIH0sCgogICAgICAgIGFuZFNlbGY6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKHRoaXMucHJldk9iamVjdCk7CiAgICAgICAgfQogICAgfSk7CgovLyBBIHBhaW5mdWxseSBzaW1wbGUgY2hlY2sgdG8gc2VlIGlmIGFuIGVsZW1lbnQgaXMgZGlzY29ubmVjdGVkCi8vIGZyb20gYSBkb2N1bWVudCAoc2hvdWxkIGJlIGltcHJvdmVkLCB3aGVyZSBmZWFzaWJsZSkuCiAgICBmdW5jdGlvbiBpc0Rpc2Nvbm5lY3RlZChub2RlKSB7CiAgICAgICAgcmV0dXJuICFub2RlIHx8ICFub2RlLnBhcmVudE5vZGUgfHwgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMTsKICAgIH0KCiAgICBqUXVlcnkuZWFjaCh7CiAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgICAgIH0sCiAgICAgICAgcGFyZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgInBhcmVudE5vZGUiKTsKICAgICAgICB9LAogICAgICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwpOwogICAgICAgIH0sCiAgICAgICAgbmV4dDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5udGgoZWxlbSwgMiwgIm5leHRTaWJsaW5nIik7CiAgICAgICAgfSwKICAgICAgICBwcmV2OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm50aChlbGVtLCAyLCAicHJldmlvdXNTaWJsaW5nIik7CiAgICAgICAgfSwKICAgICAgICBuZXh0QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAibmV4dFNpYmxpbmciKTsKICAgICAgICB9LAogICAgICAgIHByZXZBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICJwcmV2aW91c1NpYmxpbmciKTsKICAgICAgICB9LAogICAgICAgIG5leHRVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsKTsKICAgICAgICB9LAogICAgICAgIHByZXZVbnRpbDogZnVuY3Rpb24gKGVsZW0sIGksIHVudGlsKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICJwcmV2aW91c1NpYmxpbmciLCB1bnRpbCk7CiAgICAgICAgfSwKICAgICAgICBzaWJsaW5nczogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCggZWxlbS5wYXJlbnROb2RlIHx8IHt9ICkuZmlyc3RDaGlsZCwgZWxlbSk7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKGVsZW0uZmlyc3RDaGlsZCk7CiAgICAgICAgfSwKICAgICAgICBjb250ZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaWZyYW1lIikgPwogICAgICAgICAgICAgICAgZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDoKICAgICAgICAgICAgICAgIGpRdWVyeS5tYWtlQXJyYXkoZWxlbS5jaGlsZE5vZGVzKTsKICAgICAgICB9CiAgICB9LCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgICAgICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uICh1bnRpbCwgc2VsZWN0b3IpIHsKICAgICAgICAgICAgdmFyIHJldCA9IGpRdWVyeS5tYXAodGhpcywgZm4sIHVudGlsKTsKCiAgICAgICAgICAgIGlmICghcnVudGlsLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gdW50aWw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXQgPSBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCByZXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXQgPSB0aGlzLmxlbmd0aCA+IDEgJiYgIWd1YXJhbnRlZWRVbmlxdWVbIG5hbWUgXSA/IGpRdWVyeS51bmlxdWUocmV0KSA6IHJldDsKCiAgICAgICAgICAgIGlmICgodGhpcy5sZW5ndGggPiAxIHx8IHJtdWx0aXNlbGVjdG9yLnRlc3Qoc2VsZWN0b3IpKSAmJiBycGFyZW50c3ByZXYudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgcmV0ID0gcmV0LnJldmVyc2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHJldCwgbmFtZSwgc2xpY2UuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGpRdWVyeS5leHRlbmQoewogICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKGV4cHIsIGVsZW1zLCBub3QpIHsKICAgICAgICAgICAgaWYgKG5vdCkgewogICAgICAgICAgICAgICAgZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxID8KICAgICAgICAgICAgICAgIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihlbGVtc1swXSwgZXhwcikgPyBbIGVsZW1zWzBdIF0gOiBbXSA6CiAgICAgICAgICAgICAgICBqUXVlcnkuZmluZC5tYXRjaGVzKGV4cHIsIGVsZW1zKTsKICAgICAgICB9LAoKICAgICAgICBkaXI6IGZ1bmN0aW9uIChlbGVtLCBkaXIsIHVudGlsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaGVkID0gW10sCiAgICAgICAgICAgICAgICBjdXIgPSBlbGVtWyBkaXIgXTsKCiAgICAgICAgICAgIHdoaWxlIChjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSA5ICYmICh1bnRpbCA9PT0gdW5kZWZpbmVkIHx8IGN1ci5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5KGN1cikuaXModW50aWwpKSkgewogICAgICAgICAgICAgICAgaWYgKGN1ci5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIG1hdGNoZWQucHVzaChjdXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VyID0gY3VyW2Rpcl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgICAgfSwKCiAgICAgICAgbnRoOiBmdW5jdGlvbiAoY3VyLCByZXN1bHQsIGRpciwgZWxlbSkgewogICAgICAgICAgICByZXN1bHQgPSByZXN1bHQgfHwgMTsKICAgICAgICAgICAgdmFyIG51bSA9IDA7CgogICAgICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXJbZGlyXSkgewogICAgICAgICAgICAgICAgaWYgKGN1ci5ub2RlVHlwZSA9PT0gMSAmJiArK251bSA9PT0gcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjdXI7CiAgICAgICAgfSwKCiAgICAgICAgc2libGluZzogZnVuY3Rpb24gKG4sIGVsZW0pIHsKICAgICAgICAgICAgdmFyIHIgPSBbXTsKCiAgICAgICAgICAgIGZvciAoOyBuOyBuID0gbi5uZXh0U2libGluZykgewogICAgICAgICAgICAgICAgaWYgKG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHIucHVzaChuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfQogICAgfSk7CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdAogICAgZnVuY3Rpb24gd2lubm93KGVsZW1lbnRzLCBxdWFsaWZpZXIsIGtlZXApIHsKCiAgICAgICAgLy8gQ2FuJ3QgcGFzcyBudWxsIG9yIHVuZGVmaW5lZCB0byBpbmRleE9mIGluIEZpcmVmb3ggNAogICAgICAgIC8vIFNldCB0byAwIHRvIHNraXAgc3RyaW5nIGNoZWNrCiAgICAgICAgcXVhbGlmaWVyID0gcXVhbGlmaWVyIHx8IDA7CgogICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihxdWFsaWZpZXIpKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgIHZhciByZXRWYWwgPSAhIXF1YWxpZmllci5jYWxsKGVsZW0sIGksIGVsZW0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHJldFZhbCA9PT0ga2VlcDsKICAgICAgICAgICAgfSk7CgogICAgICAgIH0gZWxzZSBpZiAocXVhbGlmaWVyLm5vZGVUeXBlKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApID09PSBrZWVwOwogICAgICAgICAgICB9KTsKCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIikgewogICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChpc1NpbXBsZS50ZXN0KHF1YWxpZmllcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZmlsdGVyKHF1YWxpZmllciwgZmlsdGVyZWQsICFrZWVwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBmaWx0ZXJlZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgcmV0dXJuICggalF1ZXJ5LmluQXJyYXkoZWxlbSwgcXVhbGlmaWVyKSA+PSAwICkgPT09IGtlZXA7CiAgICAgICAgfSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNyZWF0ZVNhZmVGcmFnbWVudChkb2N1bWVudCkgewogICAgICAgIHZhciBsaXN0ID0gbm9kZU5hbWVzLnNwbGl0KCJ8IiksCiAgICAgICAgICAgIHNhZmVGcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKICAgICAgICBpZiAoc2FmZUZyYWcuY3JlYXRlRWxlbWVudCkgewogICAgICAgICAgICB3aGlsZSAobGlzdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICAgICAgbGlzdC5wb3AoKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2FmZUZyYWc7CiAgICB9CgogICAgdmFyIG5vZGVOYW1lcyA9ICJhYmJyfGFydGljbGV8YXNpZGV8YXVkaW98YmRpfGNhbnZhc3xkYXRhfGRhdGFsaXN0fGRldGFpbHN8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfCIgKwogICAgICAgICAgICAiaGVhZGVyfGhncm91cHxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cHJvZ3Jlc3N8c2VjdGlvbnxzdW1tYXJ5fHRpbWV8dmlkZW8iLAogICAgICAgIHJpbmxpbmVqUXVlcnkgPSAvIGpRdWVyeVxkKz0iKD86XGQrfG51bGwpIi9nLAogICAgICAgIHJsZWFkaW5nV2hpdGVzcGFjZSA9IC9eXHMrLywKICAgICAgICByeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2lnLAogICAgICAgIHJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sCiAgICAgICAgcnRib2R5ID0gLzx0Ym9keS9pLAogICAgICAgIHJodG1sID0gLzx8JiM/XHcrOy8sCiAgICAgICAgcm5vSW5uZXJodG1sID0gLzwoPzpzY3JpcHR8c3R5bGUpL2ksCiAgICAgICAgcm5vY2FjaGUgPSAvPCg/OnNjcmlwdHxvYmplY3R8ZW1iZWR8b3B0aW9ufHN0eWxlKS9pLAogICAgICAgIHJub3NoaW1jYWNoZSA9IG5ldyBSZWdFeHAoIjwoPzoiICsgbm9kZU5hbWVzICsgIilbXFxzLz5dIiwgImkiKSwKICAgIC8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKICAgICAgICByY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAogICAgICAgIHJzY3JpcHRUeXBlID0gL1wvKGphdmF8ZWNtYSlzY3JpcHQvaSwKICAgICAgICByY2xlYW5TY3JpcHQgPSAvXlxzKjwhKD86XFtDREFUQVxbfFwtXC0pLywKICAgICAgICB3cmFwTWFwID0gewogICAgICAgICAgICBvcHRpb246IFsgMSwgIjxzZWxlY3QgbXVsdGlwbGU9J211bHRpcGxlJz4iLCAiPC9zZWxlY3Q+IiBdLAogICAgICAgICAgICBsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCiAgICAgICAgICAgIHRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAogICAgICAgICAgICB0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKICAgICAgICAgICAgdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICAgICAgICAgIGNvbDogWyAyLCAiPHRhYmxlPjx0Ym9keT48L3Rib2R5Pjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKICAgICAgICAgICAgYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAogICAgICAgICAgICBfZGVmYXVsdDogWyAwLCAiIiwgIiIgXQogICAgICAgIH0sCiAgICAgICAgc2FmZUZyYWdtZW50ID0gY3JlYXRlU2FmZUZyYWdtZW50KGRvY3VtZW50KTsKCiAgICB3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CiAgICB3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwogICAgd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgovLyBJRSBjYW4ndCBzZXJpYWxpemUgPGxpbms+IGFuZCA8c2NyaXB0PiB0YWdzIG5vcm1hbGx5CiAgICBpZiAoIWpRdWVyeS5zdXBwb3J0Lmh0bWxTZXJpYWxpemUpIHsKICAgICAgICB3cmFwTWFwLl9kZWZhdWx0ID0gWyAxLCAiZGl2PGRpdj4iLCAiPC9kaXY+IiBdOwogICAgfQoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIHRleHQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KICAgICAgICAgICAgICAgICAgICBqUXVlcnkudGV4dCh0aGlzKSA6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbXB0eSgpLmFwcGVuZCgoIHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkuY3JlYXRlVGV4dE5vZGUodmFsdWUpKTsKICAgICAgICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgICAgIH0sCgogICAgICAgIHdyYXBBbGw6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgICAgICAgICB2YXIgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICB3cmFwLmluc2VydEJlZm9yZSh0aGlzWzBdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdENoaWxkICYmIGVsZW0uZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW07CiAgICAgICAgICAgICAgICB9KS5hcHBlbmQodGhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHdyYXBJbm5lcjogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBJbm5lcihodG1sLmNhbGwodGhpcywgaSkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksCiAgICAgICAgICAgICAgICAgICAgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgogICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRlbnRzLndyYXBBbGwoaHRtbCk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmFwcGVuZChodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgd3JhcDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgICAgICAgdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbihodG1sKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgdW53cmFwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkubm9kZU5hbWUodGhpcywgImJvZHkiKSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KS5lbmQoKTsKICAgICAgICB9LAoKICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKGVsZW0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgdHJ1ZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcy5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYmVmb3JlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIHNldCA9IGpRdWVyeS5jbGVhbihhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgc2V0LnB1c2guYXBwbHkoc2V0LCB0aGlzLnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soc2V0LCAiYmVmb3JlIiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFmdGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmYWxzZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIHNldCA9IHRoaXMucHVzaFN0YWNrKHRoaXMsICJhZnRlciIsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBzZXQucHVzaC5hcHBseShzZXQsIGpRdWVyeS5jbGVhbihhcmd1bWVudHMpKTsKICAgICAgICAgICAgICAgIHJldHVybiBzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKHNlbGVjdG9yLCBrZWVwRGF0YSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghc2VsZWN0b3IgfHwgalF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgWyBlbGVtIF0pLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcERhdGEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoWyBlbGVtIF0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKICAgICAgICAgICAgICAgIHdoaWxlIChlbGVtLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUNoaWxkKGVsZW0uZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGNsb25lOiBmdW5jdGlvbiAoZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgICAgICAgZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKICAgICAgICAgICAgZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkuY2xvbmUodGhpcywgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBodG1sOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IHRoaXNbMF0gfHwge30sCiAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgbCA9IHRoaXMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgPwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTC5yZXBsYWNlKHJpbmxpbmVqUXVlcnksICIiKSA6CiAgICAgICAgICAgICAgICAgICAgICAgIG51bGw7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCh2YWx1ZSkgJiYKICAgICAgICAgICAgICAgICAgICAoIGpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlIHx8ICFybGVhZGluZ1doaXRlc3BhY2UudGVzdCh2YWx1ZSkgKSAmJiAhd3JhcE1hcFsgKCBydGFnTmFtZS5leGVjKHZhbHVlKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCkgXSkgewoKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UocnhodG1sVGFnLCAiPCQxPjwvJDI+Iik7CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSB0aGlzW2ldIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbXB0eSgpLmFwcGVuZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgICAgICB9LAoKICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGVsZW1lbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTSBiZWZvcmUgdGhleSBhcmUgaW5zZXJ0ZWQKICAgICAgICAgICAgICAgIC8vIHRoaXMgY2FuIGhlbHAgZml4IHJlcGxhY2luZyBhIHBhcmVudCB3aXRoIGNoaWxkIGVsZW1lbnRzCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgb2xkID0gc2VsZi5odG1sKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVwbGFjZVdpdGgodmFsdWUuY2FsbCh0aGlzLCBpLCBvbGQpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5KHZhbHVlKS5kZXRhY2goKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHRoaXMubmV4dFNpYmxpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlbW92ZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkobmV4dCkuYmVmb3JlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkocGFyZW50KS5hcHBlbmQodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoID8KICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hTdGFjayhqUXVlcnkoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlKSwgInJlcGxhY2VXaXRoIiwgdmFsdWUpIDoKICAgICAgICAgICAgICAgICAgICB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZGV0YWNoOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKHNlbGVjdG9yLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICBkb21NYW5pcDogZnVuY3Rpb24gKGFyZ3MsIHRhYmxlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0cywgZmlyc3QsIGZyYWdtZW50LCBwYXJlbnQsCiAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbMF0sCiAgICAgICAgICAgICAgICBzY3JpcHRzID0gW107CgogICAgICAgICAgICAvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKICAgICAgICAgICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDMgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiByY2hlY2tlZC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLmRvbU1hbmlwKGFyZ3MsIHRhYmxlLCBjYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpOwogICAgICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSB2YWx1ZS5jYWxsKHRoaXMsIGksIHRhYmxlID8gc2VsZi5odG1sKCkgOiB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuZG9tTWFuaXAoYXJncywgdGFibGUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpc1swXSkgewogICAgICAgICAgICAgICAgcGFyZW50ID0gdmFsdWUgJiYgdmFsdWUucGFyZW50Tm9kZTsKCiAgICAgICAgICAgICAgICAvLyBJZiB3ZSdyZSBpbiBhIGZyYWdtZW50LCBqdXN0IHVzZSB0aGF0IGluc3RlYWQgb2YgYnVpbGRpbmcgYSBuZXcgb25lCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQucGFyZW50Tm9kZSAmJiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlID09PSAxMSAmJiBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IHsgZnJhZ21lbnQ6IHBhcmVudCB9OwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IGpRdWVyeS5idWlsZEZyYWdtZW50KGFyZ3MsIHRoaXMsIHNjcmlwdHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gcmVzdWx0cy5mcmFnbWVudDsKCiAgICAgICAgICAgICAgICBpZiAoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IGZyYWdtZW50ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChmaXJzdCkgewogICAgICAgICAgICAgICAgICAgIHRhYmxlID0gdGFibGUgJiYgalF1ZXJ5Lm5vZGVOYW1lKGZpcnN0LCAidHIiKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCwgbGFzdEluZGV4ID0gbCAtIDE7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb290KHRoaXNbaV0sIGZpcnN0KSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlIGRvIG5vdCBsZWFrIG1lbW9yeSBieSBpbmFkdmVydGVudGx5IGRpc2NhcmRpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBvcmlnaW5hbCBmcmFnbWVudCAod2hpY2ggbWlnaHQgaGF2ZSBhdHRhY2hlZCBkYXRhKSBpbnN0ZWFkIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1c2luZyBpdDsgaW4gYWRkaXRpb24sIHVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgb2JqZWN0IGZvciB0aGUgbGFzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXRlbSBpbnN0ZWFkIG9mIGZpcnN0IGJlY2F1c2UgaXQgY2FuIGVuZCB1cCBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKEJ1ZyAjODA3MCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGcmFnbWVudHMgZnJvbSB0aGUgZnJhZ21lbnQgY2FjaGUgbXVzdCBhbHdheXMgYmUgY2xvbmVkIGFuZCBuZXZlciB1c2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBwbGFjZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY2FjaGVhYmxlIHx8ICggbCA+IDEgJiYgaSA8IGxhc3RJbmRleCApID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuY2xvbmUoZnJhZ21lbnQsIHRydWUsIHRydWUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudAogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2NyaXB0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZWFjaChzY3JpcHRzLCBmdW5jdGlvbiAoaSwgZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5zcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWw6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogZWxlbS5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAic2NyaXB0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZ2xvYmFsRXZhbCgoIGVsZW0udGV4dCB8fCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJIVE1MIHx8ICIiICkucmVwbGFjZShyY2xlYW5TY3JpcHQsICIvKiQwKi8iKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiByb290KGVsZW0sIGN1cikgewogICAgICAgIHJldHVybiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgInRhYmxlIikgPwogICAgICAgICAgICAoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGJvZHkiKVswXSB8fAogICAgICAgICAgICAgICAgZWxlbS5hcHBlbmRDaGlsZChlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSkpIDoKICAgICAgICAgICAgZWxlbTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9uZUNvcHlFdmVudChzcmMsIGRlc3QpIHsKCiAgICAgICAgaWYgKGRlc3Qubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeS5oYXNEYXRhKHNyYykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cGUsIGksIGwsCiAgICAgICAgICAgIG9sZERhdGEgPSBqUXVlcnkuX2RhdGEoc3JjKSwKICAgICAgICAgICAgY3VyRGF0YSA9IGpRdWVyeS5fZGF0YShkZXN0LCBvbGREYXRhKSwKICAgICAgICAgICAgZXZlbnRzID0gb2xkRGF0YS5ldmVudHM7CgogICAgICAgIGlmIChldmVudHMpIHsKICAgICAgICAgICAgZGVsZXRlIGN1ckRhdGEuaGFuZGxlOwogICAgICAgICAgICBjdXJEYXRhLmV2ZW50cyA9IHt9OwoKICAgICAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IGV2ZW50c1sgdHlwZSBdLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZGVzdCwgdHlwZSwgZXZlbnRzWyB0eXBlIF1bIGkgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIG1ha2UgdGhlIGNsb25lZCBwdWJsaWMgZGF0YSBvYmplY3QgYSBjb3B5IGZyb20gdGhlIG9yaWdpbmFsCiAgICAgICAgaWYgKGN1ckRhdGEuZGF0YSkgewogICAgICAgICAgICBjdXJEYXRhLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKHt9LCBjdXJEYXRhLmRhdGEpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjbG9uZUZpeEF0dHJpYnV0ZXMoc3JjLCBkZXN0KSB7CiAgICAgICAgdmFyIG5vZGVOYW1lOwoKICAgICAgICAvLyBXZSBkbyBub3QgbmVlZCB0byBkbyBhbnl0aGluZyBmb3Igbm9uLUVsZW1lbnRzCiAgICAgICAgaWYgKGRlc3Qubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gY2xlYXJBdHRyaWJ1dGVzIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZXMsIHdoaWNoIHdlIGRvbid0IHdhbnQsCiAgICAgICAgLy8gYnV0IGFsc28gcmVtb3ZlcyB0aGUgYXR0YWNoRXZlbnQgZXZlbnRzLCB3aGljaCB3ZSAqZG8qIHdhbnQKICAgICAgICBpZiAoZGVzdC5jbGVhckF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgZGVzdC5jbGVhckF0dHJpYnV0ZXMoKTsKICAgICAgICB9CgogICAgICAgIC8vIG1lcmdlQXR0cmlidXRlcywgaW4gY29udHJhc3QsIG9ubHkgbWVyZ2VzIGJhY2sgb24gdGhlCiAgICAgICAgLy8gb3JpZ2luYWwgYXR0cmlidXRlcywgbm90IHRoZSBldmVudHMKICAgICAgICBpZiAoZGVzdC5tZXJnZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgZGVzdC5tZXJnZUF0dHJpYnV0ZXMoc3JjKTsKICAgICAgICB9CgogICAgICAgIG5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAvLyBJRTYtOCBmYWlsIHRvIGNsb25lIGNoaWxkcmVuIGluc2lkZSBvYmplY3QgZWxlbWVudHMgdGhhdCB1c2UKICAgICAgICAvLyB0aGUgcHJvcHJpZXRhcnkgY2xhc3NpZCBhdHRyaWJ1dGUgdmFsdWUgKHJhdGhlciB0aGFuIHRoZSB0eXBlCiAgICAgICAgLy8gYXR0cmlidXRlKSB0byBpZGVudGlmeSB0aGUgdHlwZSBvZiBjb250ZW50IHRvIGRpc3BsYXkKICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGRlc3Qub3V0ZXJIVE1MID0gc3JjLm91dGVySFRNTDsKCiAgICAgICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoc3JjLnR5cGUgPT09ICJjaGVja2JveCIgfHwgc3JjLnR5cGUgPT09ICJyYWRpbyIpKSB7CiAgICAgICAgICAgIC8vIElFNi04IGZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3gKICAgICAgICAgICAgLy8gb3IgcmFkaW8gYnV0dG9uLiBXb3JzZSwgSUU2LTcgZmFpbCB0byBnaXZlIHRoZSBjbG9uZWQgZWxlbWVudAogICAgICAgICAgICAvLyBhIGNoZWNrZWQgYXBwZWFyYW5jZSBpZiB0aGUgZGVmYXVsdENoZWNrZWQgdmFsdWUgaXNuJ3QgYWxzbyBzZXQKICAgICAgICAgICAgaWYgKHNyYy5jaGVja2VkKSB7CiAgICAgICAgICAgICAgICBkZXN0LmRlZmF1bHRDaGVja2VkID0gZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElFNi03IGdldCBjb25mdXNlZCBhbmQgZW5kIHVwIHNldHRpbmcgdGhlIHZhbHVlIG9mIGEgY2xvbmVkCiAgICAgICAgICAgIC8vIGNoZWNrYm94L3JhZGlvIGJ1dHRvbiB0byBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiAib24iCiAgICAgICAgICAgIGlmIChkZXN0LnZhbHVlICE9PSBzcmMudmFsdWUpIHsKICAgICAgICAgICAgICAgIGRlc3QudmFsdWUgPSBzcmMudmFsdWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElFNi04IGZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkCiAgICAgICAgICAgIC8vIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCiAgICAgICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gIm9wdGlvbiIpIHsKICAgICAgICAgICAgZGVzdC5zZWxlY3RlZCA9IHNyYy5kZWZhdWx0U2VsZWN0ZWQ7CgogICAgICAgICAgICAvLyBJRTYtOCBmYWlscyB0byBzZXQgdGhlIGRlZmF1bHRWYWx1ZSB0byB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuCiAgICAgICAgICAgIC8vIGNsb25pbmcgb3RoZXIgdHlwZXMgb2YgaW5wdXQgZmllbGRzCiAgICAgICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICAgICAgICBkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7CgogICAgICAgICAgICAvLyBJRSBibGFua3MgY29udGVudHMgd2hlbiBjbG9uaW5nIHNjcmlwdHMKICAgICAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAic2NyaXB0IiAmJiBkZXN0LnRleHQgIT09IHNyYy50ZXh0KSB7CiAgICAgICAgICAgIGRlc3QudGV4dCA9IHNyYy50ZXh0OwogICAgICAgIH0KCiAgICAgICAgLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8KICAgICAgICAvLyBnZXRzIGNvcGllZCB0b28KICAgICAgICBkZXN0LnJlbW92ZUF0dHJpYnV0ZShqUXVlcnkuZXhwYW5kbyk7CgogICAgICAgIC8vIENsZWFyIGZsYWdzIGZvciBidWJibGluZyBzcGVjaWFsIGNoYW5nZS9zdWJtaXQgZXZlbnRzLCB0aGV5IG11c3QKICAgICAgICAvLyBiZSByZWF0dGFjaGVkIHdoZW4gdGhlIG5ld2x5IGNsb25lZCBldmVudHMgYXJlIGZpcnN0IGFjdGl2YXRlZAogICAgICAgIGRlc3QucmVtb3ZlQXR0cmlidXRlKCJfc3VibWl0X2F0dGFjaGVkIik7CiAgICAgICAgZGVzdC5yZW1vdmVBdHRyaWJ1dGUoIl9jaGFuZ2VfYXR0YWNoZWQiKTsKICAgIH0KCiAgICBqUXVlcnkuYnVpbGRGcmFnbWVudCA9IGZ1bmN0aW9uIChhcmdzLCBub2Rlcywgc2NyaXB0cykgewogICAgICAgIHZhciBmcmFnbWVudCwgY2FjaGVhYmxlLCBjYWNoZXJlc3VsdHMsIGRvYywKICAgICAgICAgICAgZmlyc3QgPSBhcmdzWyAwIF07CgogICAgICAgIC8vIG5vZGVzIG1heSBjb250YWluIGVpdGhlciBhbiBleHBsaWNpdCBkb2N1bWVudCBvYmplY3QsCiAgICAgICAgLy8gYSBqUXVlcnkgY29sbGVjdGlvbiBvciBjb250ZXh0IG9iamVjdC4KICAgICAgICAvLyBJZiBub2Rlc1swXSBjb250YWlucyBhIHZhbGlkIG9iamVjdCB0byBhc3NpZ24gdG8gZG9jCiAgICAgICAgaWYgKG5vZGVzICYmIG5vZGVzWzBdKSB7CiAgICAgICAgICAgIGRvYyA9IG5vZGVzWzBdLm93bmVyRG9jdW1lbnQgfHwgbm9kZXNbMF07CiAgICAgICAgfQoKICAgICAgICAvLyBFbnN1cmUgdGhhdCBhbiBhdHRyIG9iamVjdCBkb2Vzbid0IGluY29ycmVjdGx5IHN0YW5kIGluIGFzIGEgZG9jdW1lbnQgb2JqZWN0CiAgICAgICAgLy8gQ2hyb21lIGFuZCBGaXJlZm94IHNlZW0gdG8gYWxsb3cgdGhpcyB0byBvY2N1ciBhbmQgd2lsbCB0aHJvdyBleGNlcHRpb24KICAgICAgICAvLyBGaXhlcyAjODk1MAogICAgICAgIGlmICghZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQpIHsKICAgICAgICAgICAgZG9jID0gZG9jdW1lbnQ7CiAgICAgICAgfQoKICAgICAgICAvLyBPbmx5IGNhY2hlICJzbWFsbCIgKDEvMiBLQikgSFRNTCBzdHJpbmdzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFpbiBkb2N1bWVudAogICAgICAgIC8vIENsb25pbmcgb3B0aW9ucyBsb3NlcyB0aGUgc2VsZWN0ZWQgc3RhdGUsIHNvIGRvbid0IGNhY2hlIHRoZW0KICAgICAgICAvLyBJRSA2IGRvZXNuJ3QgbGlrZSBpdCB3aGVuIHlvdSBwdXQgPG9iamVjdD4gb3IgPGVtYmVkPiBlbGVtZW50cyBpbiBhIGZyYWdtZW50CiAgICAgICAgLy8gQWxzbywgV2ViS2l0IGRvZXMgbm90IGNsb25lICdjaGVja2VkJyBhdHRyaWJ1dGVzIG9uIGNsb25lTm9kZSwgc28gZG9uJ3QgY2FjaGUKICAgICAgICAvLyBMYXN0bHksIElFNiw3LDggd2lsbCBub3QgY29ycmVjdGx5IHJldXNlIGNhY2hlZCBmcmFnbWVudHMgdGhhdCB3ZXJlIGNyZWF0ZWQgZnJvbSB1bmtub3duIGVsZW1zICMxMDUwMQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgZmlyc3QgPT09ICJzdHJpbmciICYmIGZpcnN0Lmxlbmd0aCA8IDUxMiAmJiBkb2MgPT09IGRvY3VtZW50ICYmCiAgICAgICAgICAgIGZpcnN0LmNoYXJBdCgwKSA9PT0gIjwiICYmICFybm9jYWNoZS50ZXN0KGZpcnN0KSAmJgogICAgICAgICAgICAoalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSB8fCAhcmNoZWNrZWQudGVzdChmaXJzdCkpICYmCiAgICAgICAgICAgIChqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8ICFybm9zaGltY2FjaGUudGVzdChmaXJzdCkpKSB7CgogICAgICAgICAgICBjYWNoZWFibGUgPSB0cnVlOwoKICAgICAgICAgICAgY2FjaGVyZXN1bHRzID0galF1ZXJ5LmZyYWdtZW50c1sgZmlyc3QgXTsKICAgICAgICAgICAgaWYgKGNhY2hlcmVzdWx0cyAmJiBjYWNoZXJlc3VsdHMgIT09IDEpIHsKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gY2FjaGVyZXN1bHRzOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWZyYWdtZW50KSB7CiAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgalF1ZXJ5LmNsZWFuKGFyZ3MsIGRvYywgZnJhZ21lbnQsIHNjcmlwdHMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNhY2hlYWJsZSkgewogICAgICAgICAgICBqUXVlcnkuZnJhZ21lbnRzWyBmaXJzdCBdID0gY2FjaGVyZXN1bHRzID8gZnJhZ21lbnQgOiAxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgZnJhZ21lbnQ6IGZyYWdtZW50LCBjYWNoZWFibGU6IGNhY2hlYWJsZSB9OwogICAgfTsKCiAgICBqUXVlcnkuZnJhZ21lbnRzID0ge307CgogICAgalF1ZXJ5LmVhY2goewogICAgICAgIGFwcGVuZFRvOiAiYXBwZW5kIiwKICAgICAgICBwcmVwZW5kVG86ICJwcmVwZW5kIiwKICAgICAgICBpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAogICAgICAgIGluc2VydEFmdGVyOiAiYWZ0ZXIiLAogICAgICAgIHJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKICAgIH0sIGZ1bmN0aW9uIChuYW1lLCBvcmlnaW5hbCkgewogICAgICAgIGpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBbXSwKICAgICAgICAgICAgICAgIGluc2VydCA9IGpRdWVyeShzZWxlY3RvciksCiAgICAgICAgICAgICAgICBwYXJlbnQgPSB0aGlzLmxlbmd0aCA9PT0gMSAmJiB0aGlzWzBdLnBhcmVudE5vZGU7CgogICAgICAgICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSA9PT0gMTEgJiYgcGFyZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICYmIGluc2VydC5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIGluc2VydFsgb3JpZ2luYWwgXSh0aGlzWzBdKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaW5zZXJ0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtcyA9ICggaSA+IDAgPyB0aGlzLmNsb25lKHRydWUpIDogdGhpcyApLmdldCgpOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeShpbnNlcnRbaV0pWyBvcmlnaW5hbCBdKGVsZW1zKTsKICAgICAgICAgICAgICAgICAgICByZXQgPSByZXQuY29uY2F0KGVsZW1zKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socmV0LCBuYW1lLCBpbnNlcnQuc2VsZWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGdldEFsbChlbGVtKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpOwoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoIioiKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgIH0KCi8vIFVzZWQgaW4gY2xlYW4sIGZpeGVzIHRoZSBkZWZhdWx0Q2hlY2tlZCBwcm9wZXJ0eQogICAgZnVuY3Rpb24gZml4RGVmYXVsdENoZWNrZWQoZWxlbSkgewogICAgICAgIGlmIChlbGVtLnR5cGUgPT09ICJjaGVja2JveCIgfHwgZWxlbS50eXBlID09PSAicmFkaW8iKSB7CiAgICAgICAgICAgIGVsZW0uZGVmYXVsdENoZWNrZWQgPSBlbGVtLmNoZWNrZWQ7CiAgICAgICAgfQogICAgfQoKLy8gRmluZHMgYWxsIGlucHV0cyBhbmQgcGFzc2VzIHRoZW0gdG8gZml4RGVmYXVsdENoZWNrZWQKICAgIGZ1bmN0aW9uIGZpbmRJbnB1dHMoZWxlbSkgewogICAgICAgIHZhciBub2RlTmFtZSA9ICggZWxlbS5ub2RlTmFtZSB8fCAiIiApLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiKSB7CiAgICAgICAgICAgIGZpeERlZmF1bHRDaGVja2VkKGVsZW0pOwogICAgICAgICAgICAvLyBTa2lwIHNjcmlwdHMsIGdldCBvdGhlciBjaGlsZHJlbgogICAgICAgIH0gZWxzZSBpZiAobm9kZU5hbWUgIT09ICJzY3JpcHQiICYmIHR5cGVvZiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBqUXVlcnkuZ3JlcChlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpLCBmaXhEZWZhdWx0Q2hlY2tlZCk7CiAgICAgICAgfQogICAgfQoKLy8gRGVyaXZlZCBGcm9tOiBodHRwOi8vd3d3LmllY3NzLmNvbS9zaGltcHJvdmUvamF2YXNjcmlwdC9zaGltcHJvdmUuMS0wLTEuanMKICAgIGZ1bmN0aW9uIHNoaW1DbG9uZU5vZGUoZWxlbSkgewogICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBzYWZlRnJhZ21lbnQuYXBwZW5kQ2hpbGQoZGl2KTsKCiAgICAgICAgZGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwogICAgICAgIHJldHVybiBkaXYuZmlyc3RDaGlsZDsKICAgIH0KCiAgICBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICBjbG9uZTogZnVuY3Rpb24gKGVsZW0sIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICAgIHZhciBzcmNFbGVtZW50cywKICAgICAgICAgICAgICAgIGRlc3RFbGVtZW50cywKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgIC8vIElFPD04IGRvZXMgbm90IHByb3Blcmx5IGNsb25lIGRldGFjaGVkLCB1bmtub3duIGVsZW1lbnQgbm9kZXMKICAgICAgICAgICAgICAgIGNsb25lID0galF1ZXJ5LnN1cHBvcnQuaHRtbDVDbG9uZSB8fCBqUXVlcnkuaXNYTUxEb2MoZWxlbSkgfHwgIXJub3NoaW1jYWNoZS50ZXN0KCI8IiArIGVsZW0ubm9kZU5hbWUgKyAiPiIpID8KICAgICAgICAgICAgICAgICAgICBlbGVtLmNsb25lTm9kZSh0cnVlKSA6CiAgICAgICAgICAgICAgICAgICAgc2hpbUNsb25lTm9kZShlbGVtKTsKCiAgICAgICAgICAgIGlmICgoIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVFdmVudCB8fCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUNoZWNrZWQpICYmCiAgICAgICAgICAgICAgICAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSkgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgICAgICAgICAgLy8gSUUgY29waWVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQgd2hlbiB1c2luZyBjbG9uZU5vZGUuCiAgICAgICAgICAgICAgICAvLyBDYWxsaW5nIGRldGFjaEV2ZW50IG9uIHRoZSBjbG9uZSB3aWxsIGFsc28gcmVtb3ZlIHRoZSBldmVudHMKICAgICAgICAgICAgICAgIC8vIGZyb20gdGhlIG9yaWdpbmFsLiBJbiBvcmRlciB0byBnZXQgYXJvdW5kIHRoaXMsIHdlIHVzZSBzb21lCiAgICAgICAgICAgICAgICAvLyBwcm9wcmlldGFyeSBtZXRob2RzIHRvIGNsZWFyIHRoZSBldmVudHMuIFRoYW5rcyB0byBNb29Ub29scwogICAgICAgICAgICAgICAgLy8gZ3V5cyBmb3IgdGhpcyBob3RuZXNzLgoKICAgICAgICAgICAgICAgIGNsb25lRml4QXR0cmlidXRlcyhlbGVtLCBjbG9uZSk7CgogICAgICAgICAgICAgICAgLy8gVXNpbmcgU2l6emxlIGhlcmUgaXMgY3Jhenkgc2xvdywgc28gd2UgdXNlIGdldEVsZW1lbnRzQnlUYWdOYW1lIGluc3RlYWQKICAgICAgICAgICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgICAgICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lKTsKCiAgICAgICAgICAgICAgICAvLyBXZWlyZCBpdGVyYXRpb24gYmVjYXVzZSBJRSB3aWxsIHJlcGxhY2UgdGhlIGxlbmd0aCBwcm9wZXJ0eQogICAgICAgICAgICAgICAgLy8gd2l0aCBhbiBlbGVtZW50IGlmIHlvdSBhcmUgY2xvbmluZyB0aGUgYm9keSBhbmQgb25lIG9mIHRoZQogICAgICAgICAgICAgICAgLy8gZWxlbWVudHMgb24gdGhlIHBhZ2UgaGFzIGEgbmFtZSBvciBpZCBvZiAibGVuZ3RoIgogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgc3JjRWxlbWVudHNbaV07ICsraSkgewogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBub2RlIGlzIG5vdCBudWxsOyBGaXhlcyAjOTU4NwogICAgICAgICAgICAgICAgICAgIGlmIChkZXN0RWxlbWVudHNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmVGaXhBdHRyaWJ1dGVzKHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQogICAgICAgICAgICBpZiAoZGF0YUFuZEV2ZW50cykgewogICAgICAgICAgICAgICAgY2xvbmVDb3B5RXZlbnQoZWxlbSwgY2xvbmUpOwoKICAgICAgICAgICAgICAgIGlmIChkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICAgICAgICAgICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IHNyY0VsZW1lbnRzW2ldOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmVDb3B5RXZlbnQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBzcmNFbGVtZW50cyA9IGRlc3RFbGVtZW50cyA9IG51bGw7CgogICAgICAgICAgICAvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKICAgICAgICAgICAgcmV0dXJuIGNsb25lOwogICAgICAgIH0sCgogICAgICAgIGNsZWFuOiBmdW5jdGlvbiAoZWxlbXMsIGNvbnRleHQsIGZyYWdtZW50LCBzY3JpcHRzKSB7CiAgICAgICAgICAgIHZhciBjaGVja1NjcmlwdFR5cGUsIHNjcmlwdCwgaiwKICAgICAgICAgICAgICAgIHJldCA9IFtdOwoKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyAhY29udGV4dC5jcmVhdGVFbGVtZW50IGZhaWxzIGluIElFIHdpdGggYW4gZXJyb3IgYnV0IHJldHVybnMgdHlwZW9mICdvYmplY3QnCiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5jcmVhdGVFbGVtZW50ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0WzBdICYmIGNvbnRleHRbMF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIGVsZW0gKz0gIiI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGlmICghcmh0bWwudGVzdChlbGVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXggIlhIVE1MIi1zdHlsZSB0YWdzIGluIGFsbCBicm93c2VycwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbS5yZXBsYWNlKHJ4aHRtbFRhZywgIjwkMT48LyQyPiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpbSB3aGl0ZXNwYWNlLCBvdGhlcndpc2UgaW5kZXhPZiB3b24ndCB3b3JrIGFzIGV4cGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoZWxlbSkgfHwgWyIiLCAiIl0gKVsxXS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JhcCA9IHdyYXBNYXBbIHRhZyBdIHx8IHdyYXBNYXAuX2RlZmF1bHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXB0aCA9IHdyYXBbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUNoaWxkTm9kZXMgPSBzYWZlRnJhZ21lbnQuY2hpbGROb2RlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB3cmFwcGVyIGVsZW1lbnQgdG8gdW5rbm93biBlbGVtZW50IHNhZmUgZG9jIGZyYWdtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0ID09PSBkb2N1bWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBmcmFnbWVudCB3ZSd2ZSBhbHJlYWR5IGNyZWF0ZWQgZm9yIHRoaXMgZG9jdW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVGcmFnbWVudC5hcHBlbmRDaGlsZChkaXYpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVXNlIGEgZnJhZ21lbnQgY3JlYXRlZCB3aXRoIHRoZSBvd25lciBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2FmZUZyYWdtZW50KGNvbnRleHQpLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtICsgd3JhcFsyXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1vdmUgdG8gdGhlIHJpZ2h0IGRlcHRoCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChkZXB0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYgPSBkaXYubGFzdENoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgSUUncyBhdXRvaW5zZXJ0ZWQgPHRib2R5PiBmcm9tIHRhYmxlIGZyYWdtZW50cwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LnRib2R5KSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0JvZHkgPSBydGJvZHkudGVzdChlbGVtKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Ym9keSA9IHRhZyA9PT0gInRhYmxlIiAmJiAhaGFzQm9keSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5maXJzdENoaWxkICYmIGRpdi5maXJzdENoaWxkLmNoaWxkTm9kZXMgOgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RyaW5nIHdhcyBhIGJhcmUgPHRoZWFkPiBvciA8dGZvb3Q+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBbMV0gPT09ICI8dGFibGU+IiAmJiAhaGFzQm9keSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYuY2hpbGROb2RlcyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSB0Ym9keS5sZW5ndGggLSAxOyBqID49IDA7IC0taikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkubm9kZU5hbWUodGJvZHlbIGogXSwgInRib2R5IikgJiYgIXRib2R5WyBqIF0uY2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRib2R5WyBqIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSUUgY29tcGxldGVseSBraWxscyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiBpbm5lckhUTUwgaXMgdXNlZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlICYmIHJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KGVsZW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYuaW5zZXJ0QmVmb3JlKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUocmxlYWRpbmdXaGl0ZXNwYWNlLmV4ZWMoZWxlbSlbMF0pLCBkaXYuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBkaXYuY2hpbGROb2RlczsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGVsZW1lbnRzIGZyb20gRG9jdW1lbnRGcmFnbWVudCAoc2FmZUZyYWdtZW50IG9yIG90aGVyd2lzZSkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gYXZvaWQgaG9hcmRpbmcgZWxlbWVudHMuIEZpeGVzICMxMTM1NgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGl2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkaXYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEd1YXJkIGFnYWluc3QgLTEgaW5kZXggZXhjZXB0aW9ucyBpbiBGRjMuNgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNhZmVDaGlsZE5vZGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmUgPSBzYWZlQ2hpbGROb2Rlc1sgc2FmZUNoaWxkTm9kZXMubGVuZ3RoIC0gMSBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlICYmIHJlbW92ZS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJlbW92ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlc2V0cyBkZWZhdWx0Q2hlY2tlZCBmb3IgYW55IHJhZGlvcyBhbmQgY2hlY2tib3hlcwogICAgICAgICAgICAgICAgLy8gYWJvdXQgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIERPTSBpbiBJRSA2LzcgKCM4MDYwKQogICAgICAgICAgICAgICAgdmFyIGxlbjsKICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuYXBwZW5kQ2hlY2tlZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtWzBdICYmIHR5cGVvZiAobGVuID0gZWxlbS5sZW5ndGgpID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRJbnB1dHMoZWxlbVtqXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaW5kSW5wdXRzKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSkgewogICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXQgPSBqUXVlcnkubWVyZ2UocmV0LCBlbGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZyYWdtZW50KSB7CiAgICAgICAgICAgICAgICBjaGVja1NjcmlwdFR5cGUgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhZWxlbS50eXBlIHx8IHJzY3JpcHRUeXBlLnRlc3QoZWxlbS50eXBlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyByZXRbaV07IGkrKykgewogICAgICAgICAgICAgICAgICAgIHNjcmlwdCA9IHJldFtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0cyAmJiBqUXVlcnkubm9kZU5hbWUoc2NyaXB0LCAic2NyaXB0IikgJiYgKCFzY3JpcHQudHlwZSB8fCByc2NyaXB0VHlwZS50ZXN0KHNjcmlwdC50eXBlKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0cy5wdXNoKHNjcmlwdC5wYXJlbnROb2RlID8gc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KSA6IHNjcmlwdCk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY3JpcHQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqc1RhZ3MgPSBqUXVlcnkuZ3JlcChzY3JpcHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInNjcmlwdCIpLCBjaGVja1NjcmlwdFR5cGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldC5zcGxpY2UuYXBwbHkocmV0LCBbaSArIDEsIDBdLmNvbmNhdChqc1RhZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICBjbGVhbkRhdGE6IGZ1bmN0aW9uIChlbGVtcykgewogICAgICAgICAgICB2YXIgZGF0YSwgaWQsCiAgICAgICAgICAgICAgICBjYWNoZSA9IGpRdWVyeS5jYWNoZSwKICAgICAgICAgICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwKICAgICAgICAgICAgICAgIGRlbGV0ZUV4cGFuZG8gPSBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZU5hbWUgJiYgalF1ZXJ5Lm5vRGF0YVtlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWQgPSBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoKICAgICAgICAgICAgICAgIGlmIChpZCkgewogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBjYWNoZVsgaWQgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdHlwZSBpbiBkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxbIHR5cGUgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTnVsbCB0aGUgRE9NIHJlZmVyZW5jZSB0byBhdm9pZCBJRTYvNy84IGxlYWsgKCM3MDU0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuaGFuZGxlLmVsZW0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlRXhwYW5kbykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLnJlbW92ZUF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShqUXVlcnkuZXhwYW5kbyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVbIGlkIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCgogICAgdmFyIHJhbHBoYSA9IC9hbHBoYVwoW14pXSpcKS9pLAogICAgICAgIHJvcGFjaXR5ID0gL29wYWNpdHk9KFteKV0qKS8sCiAgICAvLyBmaXhlZCBmb3IgSUU5LCBzZWUgIzgzNDYKICAgICAgICBydXBwZXIgPSAvKFtBLVpdfF5tcykvZywKICAgICAgICBybnVtID0gL15bXC0rXT8oPzpcZCpcLik/XGQrJC9pLAogICAgICAgIHJudW1ub25weCA9IC9eLT8oPzpcZCpcLik/XGQrKD8hcHgpW15cZFxzXSskL2ksCiAgICAgICAgcnJlbE51bSA9IC9eKFtcLStdKT0oW1wtKy5cZGVdKykvLAogICAgICAgIHJtYXJnaW4gPSAvXm1hcmdpbi8sCgogICAgICAgIGNzc1Nob3cgPSB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB2aXNpYmlsaXR5OiAiaGlkZGVuIiwgZGlzcGxheTogImJsb2NrIiB9LAoKICAgIC8vIG9yZGVyIGlzIGltcG9ydGFudCEKICAgICAgICBjc3NFeHBhbmQgPSBbICJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiIF0sCgogICAgICAgIGN1ckNTUywKCiAgICAgICAgZ2V0Q29tcHV0ZWRTdHlsZSwKICAgICAgICBjdXJyZW50U3R5bGU7CgogICAgalF1ZXJ5LmZuLmNzcyA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgbmFtZSwgdmFsdWUpIDoKICAgICAgICAgICAgICAgIGpRdWVyeS5jc3MoZWxlbSwgbmFtZSk7CiAgICAgICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH07CgogICAgalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAgICAgLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5CiAgICAgICAgY3NzSG9va3M6IHsKICAgICAgICAgICAgb3BhY2l0eTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IGN1ckNTUyhlbGVtLCAib3BhY2l0eSIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uc3R5bGUub3BhY2l0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBFeGNsdWRlIHRoZSBmb2xsb3dpbmcgY3NzIHByb3BlcnRpZXMgdG8gYWRkIHB4CiAgICAgICAgY3NzTnVtYmVyOiB7CiAgICAgICAgICAgICJmaWxsT3BhY2l0eSI6IHRydWUsCiAgICAgICAgICAgICJmb250V2VpZ2h0IjogdHJ1ZSwKICAgICAgICAgICAgImxpbmVIZWlnaHQiOiB0cnVlLAogICAgICAgICAgICAib3BhY2l0eSI6IHRydWUsCiAgICAgICAgICAgICJvcnBoYW5zIjogdHJ1ZSwKICAgICAgICAgICAgIndpZG93cyI6IHRydWUsCiAgICAgICAgICAgICJ6SW5kZXgiOiB0cnVlLAogICAgICAgICAgICAiem9vbSI6IHRydWUKICAgICAgICB9LAoKICAgICAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAgICAgLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQogICAgICAgIGNzc1Byb3BzOiB7CiAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBmbG9hdCBjc3MgcHJvcGVydHkKICAgICAgICAgICAgImZsb2F0IjogalF1ZXJ5LnN1cHBvcnQuY3NzRmxvYXQgPyAiY3NzRmxvYXQiIDogInN0eWxlRmxvYXQiCiAgICAgICAgfSwKCiAgICAgICAgLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKICAgICAgICBzdHlsZTogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlLCBleHRyYSkgewogICAgICAgICAgICAvLyBEb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgICAgICAgaWYgKCFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgICAgICAgICAgdmFyIHJldCwgdHlwZSwgb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpLAogICAgICAgICAgICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlLCBob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCiAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgb3JpZ05hbWU7CgogICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgogICAgICAgICAgICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInN0cmluZyIgJiYgKHJldCA9IHJyZWxOdW0uZXhlYyh2YWx1ZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAoICsoIHJldFsxXSArIDEpICogK3JldFsyXSApICsgcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIG5hbWUpKTsKICAgICAgICAgICAgICAgICAgICAvLyBGaXhlcyBidWcgIzkyMzcKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIm51bWJlciI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgTmFOIGFuZCBudWxsIHZhbHVlcyBhcmVuJ3Qgc2V0LiBTZWU6ICM3MTE2CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB0eXBlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkICdweCcgdG8gdGhlIChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIgJiYgIWpRdWVyeS5jc3NOdW1iZXJbIG9yaWdOYW1lIF0pIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAicHgiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQogICAgICAgICAgICAgICAgaWYgKCFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIHdoZW4gJ2ludmFsaWQnIHZhbHVlcyBhcmUgcHJvdmlkZWQKICAgICAgICAgICAgICAgICAgICAvLyBGaXhlcyBidWcgIzU1MDkKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZVsgbmFtZSBdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgbm9uLWNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKICAgICAgICAgICAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIGZhbHNlLCBleHRyYSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CiAgICAgICAgICAgICAgICByZXR1cm4gc3R5bGVbIG5hbWUgXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGNzczogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGV4dHJhKSB7CiAgICAgICAgICAgIHZhciByZXQsIGhvb2tzOwoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpOwogICAgICAgICAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdOwogICAgICAgICAgICBuYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBuYW1lIF0gfHwgbmFtZTsKCiAgICAgICAgICAgIC8vIGNzc0Zsb2F0IG5lZWRzIGEgc3BlY2lhbCB0cmVhdG1lbnQKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJjc3NGbG9hdCIpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSAiZmxvYXQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICAgICAgICBpZiAoaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCB0cnVlLCBleHRyYSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CgogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJDU1MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJDU1MoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zCiAgICAgICAgc3dhcDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBvbGQgPSB7fSwKICAgICAgICAgICAgICAgIHJldCwgbmFtZTsKCiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgICAgICAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgb2xkWyBuYW1lIF0gPSBlbGVtLnN0eWxlWyBuYW1lIF07CiAgICAgICAgICAgICAgICBlbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IGNhbGxiYWNrLmNhbGwoZWxlbSk7CgogICAgICAgICAgICAvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKICAgICAgICAgICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgIH0pOwoKLy8gREVQUkVDQVRFRCBpbiAxLjMsIFVzZSBqUXVlcnkuY3NzKCkgaW5zdGVhZAogICAgalF1ZXJ5LmN1ckNTUyA9IGpRdWVyeS5jc3M7CgogICAgaWYgKGRvY3VtZW50LmRlZmF1bHRWaWV3ICYmIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICBnZXRDb21wdXRlZFN0eWxlID0gZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgICAgICAgdmFyIHJldCwgZGVmYXVsdFZpZXcsIGNvbXB1dGVkU3R5bGUsIHdpZHRoLAogICAgICAgICAgICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlOwoKICAgICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZShydXBwZXIsICItJDEiKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgaWYgKChkZWZhdWx0VmlldyA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldykgJiYKICAgICAgICAgICAgICAgIChjb21wdXRlZFN0eWxlID0gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKSkpIHsKCiAgICAgICAgICAgICAgICByZXQgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUobmFtZSk7CiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSAiIiAmJiAhalF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGVsZW0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0ID0galF1ZXJ5LnN0eWxlKGVsZW0sIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgogICAgICAgICAgICAvLyBXZWJLaXQgdXNlcyAiY29tcHV0ZWQgdmFsdWUgKHBlcmNlbnRhZ2UgaWYgc3BlY2lmaWVkKSIgaW5zdGVhZCBvZiAidXNlZCB2YWx1ZSIgZm9yIG1hcmdpbnMKICAgICAgICAgICAgLy8gd2hpY2ggaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzogaHR0cDovL2Rldi53My5vcmcvY3Nzd2cvY3Nzb20vI3Jlc29sdmVkLXZhbHVlcwogICAgICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LnBpeGVsTWFyZ2luICYmIGNvbXB1dGVkU3R5bGUgJiYgcm1hcmdpbi50ZXN0KG5hbWUpICYmIHJudW1ub25weC50ZXN0KHJldCkpIHsKICAgICAgICAgICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgICAgICAgICBzdHlsZS53aWR0aCA9IHJldDsKICAgICAgICAgICAgICAgIHJldCA9IGNvbXB1dGVkU3R5bGUud2lkdGg7CiAgICAgICAgICAgICAgICBzdHlsZS53aWR0aCA9IHdpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CiAgICB9CgogICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUpIHsKICAgICAgICBjdXJyZW50U3R5bGUgPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAgICAgICB2YXIgbGVmdCwgcnNMZWZ0LCB1bmNvbXB1dGVkLAogICAgICAgICAgICAgICAgcmV0ID0gZWxlbS5jdXJyZW50U3R5bGUgJiYgZWxlbS5jdXJyZW50U3R5bGVbIG5hbWUgXSwKICAgICAgICAgICAgICAgIHN0eWxlID0gZWxlbS5zdHlsZTsKCiAgICAgICAgICAgIC8vIEF2b2lkIHNldHRpbmcgcmV0IHRvIGVtcHR5IHN0cmluZyBoZXJlCiAgICAgICAgICAgIC8vIHNvIHdlIGRvbid0IGRlZmF1bHQgdG8gYXV0bwogICAgICAgICAgICBpZiAocmV0ID09IG51bGwgJiYgc3R5bGUgJiYgKHVuY29tcHV0ZWQgPSBzdHlsZVsgbmFtZSBdKSkgewogICAgICAgICAgICAgICAgcmV0ID0gdW5jb21wdXRlZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwogICAgICAgICAgICAvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgogICAgICAgICAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgICAgICAgICAgLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCiAgICAgICAgICAgIGlmIChybnVtbm9ucHgudGVzdChyZXQpKSB7CgogICAgICAgICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgICAgICAgICAgbGVmdCA9IHN0eWxlLmxlZnQ7CiAgICAgICAgICAgICAgICByc0xlZnQgPSBlbGVtLnJ1bnRpbWVTdHlsZSAmJiBlbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0OwoKICAgICAgICAgICAgICAgIC8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKICAgICAgICAgICAgICAgIGlmIChyc0xlZnQpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0eWxlLmxlZnQgPSBuYW1lID09PSAiZm9udFNpemUiID8gIjFlbSIgOiByZXQ7CiAgICAgICAgICAgICAgICByZXQgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgICAgICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKICAgICAgICAgICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0OwogICAgICAgICAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICAgICAgICAgIGVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSByc0xlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQgPT09ICIiID8gImF1dG8iIDogcmV0OwogICAgICAgIH07CiAgICB9CgogICAgY3VyQ1NTID0gZ2V0Q29tcHV0ZWRTdHlsZSB8fCBjdXJyZW50U3R5bGU7CgogICAgZnVuY3Rpb24gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSkgewoKICAgICAgICAvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eQogICAgICAgIHZhciB2YWwgPSBuYW1lID09PSAid2lkdGgiID8gZWxlbS5vZmZzZXRXaWR0aCA6IGVsZW0ub2Zmc2V0SGVpZ2h0LAogICAgICAgICAgICBpID0gbmFtZSA9PT0gIndpZHRoIiA/IDEgOiAwLAogICAgICAgICAgICBsZW4gPSA0OwoKICAgICAgICBpZiAodmFsID4gMCkgewogICAgICAgICAgICBpZiAoZXh0cmEgIT09ICJib3JkZXIiKSB7CiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFleHRyYSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgLT0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdKSkgfHwgMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4dHJhID09PSAibWFyZ2luIikgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0pKSB8fCAwOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCAtPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIpKSB8fCAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbCArICJweCI7CiAgICAgICAgfQoKICAgICAgICAvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKICAgICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSk7CiAgICAgICAgaWYgKHZhbCA8IDAgfHwgdmFsID09IG51bGwpIHsKICAgICAgICAgICAgdmFsID0gZWxlbS5zdHlsZVsgbmFtZSBdOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29tcHV0ZWQgdW5pdCBpcyBub3QgcGl4ZWxzLiBTdG9wIGhlcmUgYW5kIHJldHVybi4KICAgICAgICBpZiAocm51bW5vbnB4LnRlc3QodmFsKSkgewogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0KCiAgICAgICAgLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKICAgICAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCkgfHwgMDsKCiAgICAgICAgLy8gQWRkIHBhZGRpbmcsIGJvcmRlciwgbWFyZ2luCiAgICAgICAgaWYgKGV4dHJhKSB7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgICAgICAgICAgIHZhbCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgInBhZGRpbmciICsgY3NzRXhwYW5kWyBpIF0pKSB8fCAwOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhICE9PSAicGFkZGluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiKSkgfHwgMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleHRyYSA9PT0gIm1hcmdpbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0pKSB8fCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsICsgInB4IjsKICAgIH0KCiAgICBqUXVlcnkuZWFjaChbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAgICAgalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkLCBleHRyYSkgewogICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ub2Zmc2V0V2lkdGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkuc3dhcChlbGVtLCBjc3NTaG93LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcm51bS50ZXN0KHZhbHVlKSA/CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgKyAicHgiIDoKICAgICAgICAgICAgICAgICAgICB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KTsKCiAgICBpZiAoIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkpIHsKICAgICAgICBqUXVlcnkuY3NzSG9va3Mub3BhY2l0eSA9IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgIC8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQogICAgICAgICAgICAgICAgcmV0dXJuIHJvcGFjaXR5LnRlc3QoKGNvbXB1dGVkICYmIGVsZW0uY3VycmVudFN0eWxlID8gZWxlbS5jdXJyZW50U3R5bGUuZmlsdGVyIDogZWxlbS5zdHlsZS5maWx0ZXIpIHx8ICIiKSA/CiAgICAgICAgICAgICAgICAgICAgKCBwYXJzZUZsb2F0KFJlZ0V4cC4kMSkgLyAxMDAgKSArICIiIDoKICAgICAgICAgICAgICAgICAgICBjb21wdXRlZCA/ICIxIiA6ICIiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IGVsZW0uc3R5bGUsCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWModmFsdWUpID8gImFscGhhKG9wYWNpdHk9IiArIHZhbHVlICogMTAwICsgIikiIDogIiIsCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyID0gY3VycmVudFN0eWxlICYmIGN1cnJlbnRTdHlsZS5maWx0ZXIgfHwgc3R5bGUuZmlsdGVyIHx8ICIiOwoKICAgICAgICAgICAgICAgIC8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dAogICAgICAgICAgICAgICAgLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAogICAgICAgICAgICAgICAgc3R5bGUuem9vbSA9IDE7CgogICAgICAgICAgICAgICAgLy8gaWYgc2V0dGluZyBvcGFjaXR5IHRvIDEsIGFuZCBubyBvdGhlciBmaWx0ZXJzIGV4aXN0IC0gYXR0ZW1wdCB0byByZW1vdmUgZmlsdGVyIGF0dHJpYnV0ZSAjNjY1MgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID49IDEgJiYgalF1ZXJ5LnRyaW0oZmlsdGVyLnJlcGxhY2UocmFscGhhLCAiIikpID09PSAiIikgewoKICAgICAgICAgICAgICAgICAgICAvLyBTZXR0aW5nIHN0eWxlLmZpbHRlciB0byBudWxsLCAiIiAmICIgIiBzdGlsbCBsZWF2ZSAiZmlsdGVyOiIgaW4gdGhlIGNzc1RleHQKICAgICAgICAgICAgICAgICAgICAvLyBpZiAiZmlsdGVyOiIgaXMgcHJlc2VudCBhdCBhbGwsIGNsZWFyVHlwZSBpcyBkaXNhYmxlZCwgd2Ugd2FudCB0byBhdm9pZCB0aGlzCiAgICAgICAgICAgICAgICAgICAgLy8gc3R5bGUucmVtb3ZlQXR0cmlidXRlIGlzIElFIE9ubHksIGJ1dCBzbyBhcHBhcmVudGx5IGlzIHRoaXMgY29kZSBwYXRoLi4uCiAgICAgICAgICAgICAgICAgICAgc3R5bGUucmVtb3ZlQXR0cmlidXRlKCJmaWx0ZXIiKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlcmUgdGhlcmUgaXMgbm8gZmlsdGVyIHN0eWxlIGFwcGxpZWQgaW4gYSBjc3MgcnVsZSwgd2UgYXJlIGRvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0eWxlICYmICFjdXJyZW50U3R5bGUuZmlsdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBzZXQgbmV3IGZpbHRlciB2YWx1ZXMKICAgICAgICAgICAgICAgIHN0eWxlLmZpbHRlciA9IHJhbHBoYS50ZXN0KGZpbHRlcikgPwogICAgICAgICAgICAgICAgICAgIGZpbHRlci5yZXBsYWNlKHJhbHBoYSwgb3BhY2l0eSkgOgogICAgICAgICAgICAgICAgICAgIGZpbHRlciArICIgIiArIG9wYWNpdHk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIGpRdWVyeShmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gVGhpcyBob29rIGNhbm5vdCBiZSBhZGRlZCB1bnRpbCBET00gcmVhZHkgYmVjYXVzZSB0aGUgc3VwcG9ydCB0ZXN0CiAgICAgICAgLy8gZm9yIGl0IGlzIG5vdCBydW4gdW50aWwgYWZ0ZXIgRE9NIHJlYWR5CiAgICAgICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0KSB7CiAgICAgICAgICAgIGpRdWVyeS5jc3NIb29rcy5tYXJnaW5SaWdodCA9IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CiAgICAgICAgICAgICAgICAgICAgLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5zd2FwKGVsZW0sIHsgImRpc3BsYXkiOiAiaW5saW5lLWJsb2NrIiB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1ckNTUyhlbGVtLCAibWFyZ2luLXJpZ2h0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5zdHlsZS5tYXJnaW5SaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIGlmIChqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzKSB7CiAgICAgICAgalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgd2lkdGggPSBlbGVtLm9mZnNldFdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0ID0gZWxlbS5vZmZzZXRIZWlnaHQ7CgogICAgICAgICAgICByZXR1cm4gKCB3aWR0aCA9PT0gMCAmJiBoZWlnaHQgPT09IDAgKSB8fCAoIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cyAmJiAoKGVsZW0uc3R5bGUgJiYgZWxlbS5zdHlsZS5kaXNwbGF5KSB8fCBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IikpID09PSAibm9uZSIpOwogICAgICAgIH07CgogICAgICAgIGpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oZWxlbSk7CiAgICAgICAgfTsKICAgIH0KCi8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgICBtYXJnaW46ICIiLAogICAgICAgIHBhZGRpbmc6ICIiLAogICAgICAgIGJvcmRlcjogIldpZHRoIgogICAgfSwgZnVuY3Rpb24gKHByZWZpeCwgc3VmZml4KSB7CgogICAgICAgIGpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CiAgICAgICAgICAgIGV4cGFuZDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwKCiAgICAgICAgICAgICAgICAvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiICIpIDogWyB2YWx1ZSBdLAogICAgICAgICAgICAgICAgICAgIGV4cGFuZGVkID0ge307CgogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGV4cGFuZGVkWyBwcmVmaXggKyBjc3NFeHBhbmRbIGkgXSArIHN1ZmZpeCBdID0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KTsKCgogICAgdmFyIHIyMCA9IC8lMjAvZywKICAgICAgICByYnJhY2tldCA9IC9cW1xdJC8sCiAgICAgICAgckNSTEYgPSAvXHI/XG4vZywKICAgICAgICByaGFzaCA9IC8jLiokLywKICAgICAgICByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCiAgICAgICAgcmlucHV0ID0gL14oPzpjb2xvcnxkYXRlfGRhdGV0aW1lfGRhdGV0aW1lLWxvY2FsfGVtYWlsfGhpZGRlbnxtb250aHxudW1iZXJ8cGFzc3dvcmR8cmFuZ2V8c2VhcmNofHRlbHx0ZXh0fHRpbWV8dXJsfHdlZWspJC9pLAogICAgLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgICAgICAgcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHBcLXN0b3JhZ2V8LitcLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAogICAgICAgIHJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLAogICAgICAgIHJwcm90b2NvbCA9IC9eXC9cLy8sCiAgICAgICAgcnF1ZXJ5ID0gL1w/LywKICAgICAgICByc2NyaXB0ID0gLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCiAgICAgICAgcnNlbGVjdFRleHRhcmVhID0gL14oPzpzZWxlY3R8dGV4dGFyZWEpL2ksCiAgICAgICAgcnNwYWNlc0FqYXggPSAvXHMrLywKICAgICAgICBydHMgPSAvKFs/Jl0pXz1bXiZdKi8sCiAgICAgICAgcnVybCA9IC9eKFtcd1wrXC5cLV0rOikoPzpcL1wvKFteXC8/IzpdKikoPzo6KFxkKykpPyk/LywKCiAgICAvLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCiAgICAgICAgX2xvYWQgPSBqUXVlcnkuZm4ubG9hZCwKCiAgICAvKiBQcmVmaWx0ZXJzCiAgICAgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQogICAgICogMikgVGhlc2UgYXJlIGNhbGxlZDoKICAgICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgICAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKICAgICAqIDMpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKICAgICAqLwogICAgICAgIHByZWZpbHRlcnMgPSB7fSwKCiAgICAvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCiAgICAgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAogICAgICovCiAgICAgICAgdHJhbnNwb3J0cyA9IHt9LAoKICAgIC8vIERvY3VtZW50IGxvY2F0aW9uCiAgICAgICAgYWpheExvY2F0aW9uLAoKICAgIC8vIERvY3VtZW50IGxvY2F0aW9uIHNlZ21lbnRzCiAgICAgICAgYWpheExvY1BhcnRzLAoKICAgIC8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbgogICAgICAgIGFsbFR5cGVzID0gWyIqLyJdICsgWyIqIl07CgovLyAjODEzOCwgSUUgbWF5IHRocm93IGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwovLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQKICAgIHRyeSB7CiAgICAgICAgYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAogICAgICAgIC8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCiAgICAgICAgYWpheExvY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgIGFqYXhMb2NhdGlvbi5ocmVmID0gIiI7CiAgICAgICAgYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7CiAgICB9CgovLyBTZWdtZW50IGxvY2F0aW9uIGludG8gcGFydHMKICAgIGFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyhhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSkgfHwgW107CgovLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydAogICAgZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSkgewoKICAgICAgICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jKSB7CgogICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CiAgICAgICAgICAgICAgICBkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgICAgICAgICAgdmFyIGRhdGFUeXBlcyA9IGRhdGFUeXBlRXhwcmVzc2lvbi50b0xvd2VyQ2FzZSgpLnNwbGl0KHJzcGFjZXNBamF4KSwKICAgICAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBkYXRhVHlwZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlLAogICAgICAgICAgICAgICAgICAgIGxpc3QsCiAgICAgICAgICAgICAgICAgICAgcGxhY2VCZWZvcmU7CgogICAgICAgICAgICAgICAgLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGVzWyBpIF07CiAgICAgICAgICAgICAgICAgICAgLy8gV2UgY29udHJvbCBpZiB3ZSdyZSBhc2tlZCB0byBhZGQgYmVmb3JlCiAgICAgICAgICAgICAgICAgICAgLy8gYW55IGV4aXN0aW5nIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBwbGFjZUJlZm9yZSA9IC9eXCsvLnRlc3QoZGF0YVR5cGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChwbGFjZUJlZm9yZSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnN1YnN0cigxKSB8fCAiKiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxpc3QgPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW107CiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiB3ZSBhZGQgdG8gdGhlIHN0cnVjdHVyZSBhY2NvcmRpbmdseQogICAgICAgICAgICAgICAgICAgIGxpc3RbIHBsYWNlQmVmb3JlID8gInVuc2hpZnQiIDogInB1c2giIF0oZnVuYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzCiAgICBmdW5jdGlvbiBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyhzdHJ1Y3R1cmUsIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIsIGRhdGFUeXBlIC8qIGludGVybmFsICovLCBpbnNwZWN0ZWQgLyogaW50ZXJuYWwgKi8pIHsKCiAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdOwogICAgICAgIGluc3BlY3RlZCA9IGluc3BlY3RlZCB8fCB7fTsKCiAgICAgICAgaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsKCiAgICAgICAgdmFyIGxpc3QgPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0sCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICBsZW5ndGggPSBsaXN0ID8gbGlzdC5sZW5ndGggOiAwLAogICAgICAgICAgICBleGVjdXRlT25seSA9ICggc3RydWN0dXJlID09PSBwcmVmaWx0ZXJzICksCiAgICAgICAgICAgIHNlbGVjdGlvbjsKCiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGggJiYgKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICk7IGkrKykgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBsaXN0WyBpIF0ob3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUik7CiAgICAgICAgICAgIC8vIElmIHdlIGdvdCByZWRpcmVjdGVkIHRvIGFub3RoZXIgZGF0YVR5cGUKICAgICAgICAgICAgLy8gd2UgdHJ5IHRoZXJlIGlmIGV4ZWN1dGluZyBvbmx5IGFuZCBub3QgZG9uZSBhbHJlYWR5CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0aW9uID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKCFleGVjdXRlT25seSB8fCBpbnNwZWN0ZWRbIHNlbGVjdGlvbiBdKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KHNlbGVjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwgc2VsZWN0aW9uLCBpbnNwZWN0ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIElmIHdlJ3JlIG9ubHkgZXhlY3V0aW5nIG9yIG5vdGhpbmcgd2FzIHNlbGVjdGVkCiAgICAgICAgLy8gd2UgdHJ5IHRoZSBjYXRjaGFsbCBkYXRhVHlwZSBpZiBub3QgZG9uZSBhbHJlYWR5CiAgICAgICAgaWYgKCggZXhlY3V0ZU9ubHkgfHwgIXNlbGVjdGlvbiApICYmICFpbnNwZWN0ZWRbICIqIiBdKSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKAogICAgICAgICAgICAgICAgc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSLCAiKiIsIGluc3BlY3RlZCk7CiAgICAgICAgfQogICAgICAgIC8vIHVubmVjZXNzYXJ5IHdoZW4gb25seSBleGVjdXRpbmcgKHByZWZpbHRlcnMpCiAgICAgICAgLy8gYnV0IGl0J2xsIGJlIGlnbm9yZWQgYnkgdGhlIGNhbGxlciBpbiB0aGF0IGNhc2UKICAgICAgICByZXR1cm4gc2VsZWN0aW9uOwogICAgfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwogICAgZnVuY3Rpb24gYWpheEV4dGVuZCh0YXJnZXQsIHNyYykgewogICAgICAgIHZhciBrZXksIGRlZXAsCiAgICAgICAgICAgIGZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKICAgICAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgaWYgKHNyY1sga2V5IF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgKCBmbGF0T3B0aW9uc1sga2V5IF0gPyB0YXJnZXQgOiAoIGRlZXAgfHwgKCBkZWVwID0ge30gKSApIClbIGtleSBdID0gc3JjWyBrZXkgXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVlcCkgewogICAgICAgICAgICBqUXVlcnkuZXh0ZW5kKHRydWUsIHRhcmdldCwgZGVlcCk7CiAgICAgICAgfQogICAgfQoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIGxvYWQ6IGZ1bmN0aW9uICh1cmwsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX2xvYWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgICAgICAvLyBEb24ndCBkbyBhIHJlcXVlc3QgaWYgbm8gZWxlbWVudHMgYXJlIGJlaW5nIHJlcXVlc3RlZAogICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwogICAgICAgICAgICBpZiAob2ZmID49IDApIHsKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RvciA9IHVybC5zbGljZShvZmYsIHVybC5sZW5ndGgpOwogICAgICAgICAgICAgICAgdXJsID0gdXJsLnNsaWNlKDAsIG9mZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERlZmF1bHQgdG8gYSBHRVQgcmVxdWVzdAogICAgICAgICAgICB2YXIgdHlwZSA9ICJHRVQiOwoKICAgICAgICAgICAgLy8gSWYgdGhlIHNlY29uZCBwYXJhbWV0ZXIgd2FzIHByb3ZpZGVkCiAgICAgICAgICAgIGlmIChwYXJhbXMpIHsKICAgICAgICAgICAgICAgIC8vIElmIGl0J3MgYSBmdW5jdGlvbgogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHBhcmFtcykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IGpRdWVyeS5wYXJhbShwYXJhbXMsIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwpOwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiUE9TVCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAogICAgICAgICAgICBqUXVlcnkuYWpheCh7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICAgICAgICAgICAgZGF0YTogcGFyYW1zLAogICAgICAgICAgICAgICAgLy8gQ29tcGxldGUgY2FsbGJhY2sgKHJlc3BvbnNlVGV4dCBpcyB1c2VkIGludGVybmFsbHkpCiAgICAgICAgICAgICAgICBjb21wbGV0ZTogZnVuY3Rpb24gKGpxWEhSLCBzdGF0dXMsIHJlc3BvbnNlVGV4dCkgewogICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIHRoZSByZXNwb25zZSBhcyBzcGVjaWZpZWQgYnkgdGhlIGpxWEhSIG9iamVjdAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlVGV4dCA9IGpxWEhSLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBzdWNjZXNzZnVsLCBpbmplY3QgdGhlIEhUTUwgaW50byBhbGwgdGhlIG1hdGNoZWQgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICBpZiAoanFYSFIuaXNSZXNvbHZlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICM0ODI1OiBHZXQgdGhlIGFjdHVhbCByZXNwb25zZSBpbiBjYXNlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGEgZGF0YUZpbHRlciBpcyBwcmVzZW50IGluIGFqYXhTZXR0aW5ncwogICAgICAgICAgICAgICAgICAgICAgICBqcVhIUi5kb25lKGZ1bmN0aW9uIChyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZVRleHQgPSByOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGlmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmh0bWwoc2VsZWN0b3IgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgZHVtbXkgZGl2IHRvIGhvbGQgdGhlIHJlc3VsdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSgiPGRpdj4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluamVjdCB0aGUgY29udGVudHMgb2YgdGhlIGRvY3VtZW50IGluLCByZW1vdmluZyB0aGUgc2NyaXB0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIGF2b2lkIGFueSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycyBpbiBJRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBlbmQocmVzcG9uc2VUZXh0LnJlcGxhY2UocnNjcmlwdCwgIiIpKQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maW5kKHNlbGVjdG9yKSA6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm90LCBqdXN0IGluamVjdCB0aGUgZnVsbCByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlVGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lYWNoKGNhbGxiYWNrLCBbIHJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkucGFyYW0odGhpcy5zZXJpYWxpemVBcnJheSgpKTsKICAgICAgICB9LAoKICAgICAgICBzZXJpYWxpemVBcnJheTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KHRoaXMuZWxlbWVudHMpIDogdGhpczsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCB0aGlzLmNoZWNrZWQgfHwgcnNlbGVjdFRleHRhcmVhLnRlc3QodGhpcy5ub2RlTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJpbnB1dC50ZXN0KHRoaXMudHlwZSkgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uIChpLCBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IGpRdWVyeSh0aGlzKS52YWwoKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbCA9PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCA6CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5pc0FycmF5KHZhbCkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWwsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgIlxyXG4iKSB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkgOgogICAgICAgICAgICAgICAgICAgICAgICB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAiXHJcbiIpIH07CiAgICAgICAgICAgICAgICB9KS5nZXQoKTsKICAgICAgICB9CiAgICB9KTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCiAgICBqUXVlcnkuZWFjaCgiYWpheFN0YXJ0IGFqYXhTdG9wIGFqYXhDb21wbGV0ZSBhamF4RXJyb3IgYWpheFN1Y2Nlc3MgYWpheFNlbmQiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChpLCBvKSB7CiAgICAgICAgalF1ZXJ5LmZuWyBvIF0gPSBmdW5jdGlvbiAoZikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vbihvLCBmKTsKICAgICAgICB9OwogICAgfSk7CgogICAgalF1ZXJ5LmVhY2goWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uIChpLCBtZXRob2QpIHsKICAgICAgICBqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24gKHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUpIHsKICAgICAgICAgICAgLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGRhdGEpKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZGF0YTsKICAgICAgICAgICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgICAgICAgICAgICB0eXBlOiBtZXRob2QsCiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICBzdWNjZXNzOiBjYWxsYmFjaywKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiB0eXBlCiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKCiAgICBqUXVlcnkuZXh0ZW5kKHsKCiAgICAgICAgZ2V0U2NyaXB0OiBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiKTsKICAgICAgICB9LAoKICAgICAgICBnZXRKU09OOiBmdW5jdGlvbiAodXJsLCBkYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwogICAgICAgIH0sCgogICAgICAgIC8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CiAgICAgICAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogICAgICAgIC8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCiAgICAgICAgYWpheFNldHVwOiBmdW5jdGlvbiAodGFyZ2V0LCBzZXR0aW5ncykgewogICAgICAgICAgICBpZiAoc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIC8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CiAgICAgICAgICAgICAgICBhamF4RXh0ZW5kKHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHRhcmdldDsKICAgICAgICAgICAgICAgIHRhcmdldCA9IGpRdWVyeS5hamF4U2V0dGluZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWpheEV4dGVuZCh0YXJnZXQsIHNldHRpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBhamF4U2V0dGluZ3M6IHsKICAgICAgICAgICAgdXJsOiBhamF4TG9jYXRpb24sCiAgICAgICAgICAgIGlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QoYWpheExvY1BhcnRzWyAxIF0pLAogICAgICAgICAgICBnbG9iYWw6IHRydWUsCiAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCiAgICAgICAgICAgIHByb2Nlc3NEYXRhOiB0cnVlLAogICAgICAgICAgICBhc3luYzogdHJ1ZSwKICAgICAgICAgICAgLyoKICAgICAgICAgICAgIHRpbWVvdXQ6IDAsCiAgICAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgICAgZGF0YVR5cGU6IG51bGwsCiAgICAgICAgICAgICB1c2VybmFtZTogbnVsbCwKICAgICAgICAgICAgIHBhc3N3b3JkOiBudWxsLAogICAgICAgICAgICAgY2FjaGU6IG51bGwsCiAgICAgICAgICAgICB0cmFkaXRpb25hbDogZmFsc2UsCiAgICAgICAgICAgICBoZWFkZXJzOiB7fSwKICAgICAgICAgICAgICovCgogICAgICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgICAgICB4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKICAgICAgICAgICAgICAgIGh0bWw6ICJ0ZXh0L2h0bWwiLAogICAgICAgICAgICAgICAgdGV4dDogInRleHQvcGxhaW4iLAogICAgICAgICAgICAgICAganNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIsCiAgICAgICAgICAgICAgICAiKiI6IGFsbFR5cGVzCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjb250ZW50czogewogICAgICAgICAgICAgICAgeG1sOiAveG1sLywKICAgICAgICAgICAgICAgIGh0bWw6IC9odG1sLywKICAgICAgICAgICAgICAgIGpzb246IC9qc29uLwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVzcG9uc2VGaWVsZHM6IHsKICAgICAgICAgICAgICAgIHhtbDogInJlc3BvbnNlWE1MIiwKICAgICAgICAgICAgICAgIHRleHQ6ICJyZXNwb25zZVRleHQiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBMaXN0IG9mIGRhdGEgY29udmVydGVycwogICAgICAgICAgICAvLyAxKSBrZXkgZm9ybWF0IGlzICJzb3VyY2VfdHlwZSBkZXN0aW5hdGlvbl90eXBlIiAoYSBzaW5nbGUgc3BhY2UgaW4tYmV0d2VlbikKICAgICAgICAgICAgLy8gMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQgZm9yIHNvdXJjZV90eXBlCiAgICAgICAgICAgIGNvbnZlcnRlcnM6IHsKCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKICAgICAgICAgICAgICAgICIqIHRleHQiOiB3aW5kb3cuU3RyaW5nLAoKICAgICAgICAgICAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAgICAgICAgICAgInRleHQgaHRtbCI6IHRydWUsCgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgogICAgICAgICAgICAgICAgLy8gUGFyc2UgdGV4dCBhcyB4bWwKICAgICAgICAgICAgICAgICJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKICAgICAgICAgICAgLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgogICAgICAgICAgICAvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQogICAgICAgICAgICAvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKICAgICAgICAgICAgZmxhdE9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIGNvbnRleHQ6IHRydWUsCiAgICAgICAgICAgICAgICB1cmw6IHRydWUKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzKSwKICAgICAgICBhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cyksCgogICAgICAgIC8vIE1haW4gbWV0aG9kCiAgICAgICAgYWpheDogZnVuY3Rpb24gKHVybCwgb3B0aW9ucykgewoKICAgICAgICAgICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgICAgICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgICAgICAgIHZhciAvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CiAgICAgICAgICAgICAgICBzID0galF1ZXJ5LmFqYXhTZXR1cCh7fSwgb3B0aW9ucyksCiAgICAgICAgICAgIC8vIENhbGxiYWNrcyBjb250ZXh0CiAgICAgICAgICAgICAgICBjYWxsYmFja0NvbnRleHQgPSBzLmNvbnRleHQgfHwgcywKICAgICAgICAgICAgLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cwogICAgICAgICAgICAvLyBJdCdzIHRoZSBjYWxsYmFja0NvbnRleHQgaWYgb25lIHdhcyBwcm92aWRlZCBpbiB0aGUgb3B0aW9ucwogICAgICAgICAgICAvLyBhbmQgaWYgaXQncyBhIERPTSBub2RlIG9yIGEgalF1ZXJ5IGNvbGxlY3Rpb24KICAgICAgICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dCA9IGNhbGxiYWNrQ29udGV4dCAhPT0gcyAmJgogICAgICAgICAgICAgICAgICAgICggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSApID8KICAgICAgICAgICAgICAgICAgICBqUXVlcnkoY2FsbGJhY2tDb250ZXh0KSA6IGpRdWVyeS5ldmVudCwKICAgICAgICAgICAgLy8gRGVmZXJyZWRzCiAgICAgICAgICAgICAgICBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICAgICAgICAgICAgY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAogICAgICAgICAgICAvLyBpZk1vZGlmaWVkIGtleQogICAgICAgICAgICAgICAgaWZNb2RpZmllZEtleSwKICAgICAgICAgICAgLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKICAgICAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzID0ge30sCiAgICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCiAgICAgICAgICAgIC8vIFJlc3BvbnNlIGhlYWRlcnMKICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZywKICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgLy8gdHJhbnNwb3J0CiAgICAgICAgICAgICAgICB0cmFuc3BvcnQsCiAgICAgICAgICAgIC8vIHRpbWVvdXQgaGFuZGxlCiAgICAgICAgICAgICAgICB0aW1lb3V0VGltZXIsCiAgICAgICAgICAgIC8vIENyb3NzLWRvbWFpbiBkZXRlY3Rpb24gdmFycwogICAgICAgICAgICAgICAgcGFydHMsCiAgICAgICAgICAgIC8vIFRoZSBqcVhIUiBzdGF0ZQogICAgICAgICAgICAgICAgc3RhdGUgPSAwLAogICAgICAgICAgICAvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKICAgICAgICAgICAgICAgIGZpcmVHbG9iYWxzLAogICAgICAgICAgICAvLyBMb29wIHZhcmlhYmxlCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAvLyBGYWtlIHhocgogICAgICAgICAgICAgICAganFYSFIgPSB7CgogICAgICAgICAgICAgICAgICAgIHJlYWR5U3RhdGU6IDAsCgogICAgICAgICAgICAgICAgICAgIC8vIENhY2hlcyB0aGUgaGVhZGVyCiAgICAgICAgICAgICAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnNbIG5hbWUgXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8vIFJhdyBzdHJpbmcKICAgICAgICAgICAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlID09PSAyID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCggbWF0Y2ggPSByaGVhZGVycy5leGVjKHJlc3BvbnNlSGVhZGVyc1N0cmluZykgKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNbIGtleS50b0xvd2VyQ2FzZSgpIF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoID09PSB1bmRlZmluZWQgPyBudWxsIDogbWF0Y2g7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKICAgICAgICAgICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLm1pbWVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24gKHN0YXR1c1RleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHN0YXR1c1RleHQgfHwgImFib3J0IjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zcG9ydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0LmFib3J0KHN0YXR1c1RleHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoMCwgc3RhdHVzVGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKICAgICAgICAgICAgLy8gSXQgaXMgZGVmaW5lZCBoZXJlIGJlY2F1c2UganNsaW50IGNvbXBsYWlucyBpZiBpdCBpcyBkZWNsYXJlZAogICAgICAgICAgICAvLyBhdCB0aGUgZW5kIG9mIHRoZSBmdW5jdGlvbiAod2hpY2ggd291bGQgYmUgbW9yZSBsb2dpY2FsIGFuZCByZWFkYWJsZSkKICAgICAgICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycykgewoKICAgICAgICAgICAgICAgIC8vIENhbGxlZCBvbmNlCiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU3RhdGUgaXMgImRvbmUiIG5vdwogICAgICAgICAgICAgICAgc3RhdGUgPSAyOwoKICAgICAgICAgICAgICAgIC8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgICAgICBpZiAodGltZW91dFRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICAgICAgICAgIC8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCiAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCiAgICAgICAgICAgICAgICAvLyBTZXQgcmVhZHlTdGF0ZQogICAgICAgICAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCiAgICAgICAgICAgICAgICB2YXIgaXNTdWNjZXNzLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MsCiAgICAgICAgICAgICAgICAgICAgZXJyb3IsCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQsCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXNwb25zZXMgPyBhamF4SGFuZGxlUmVzcG9uc2VzKHMsIGpxWEhSLCByZXNwb25zZXMpIDogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgIGxhc3RNb2RpZmllZCwKICAgICAgICAgICAgICAgICAgICBldGFnOwoKICAgICAgICAgICAgICAgIC8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAgfHwgc3RhdHVzID09PSAzMDQpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgICAgICAgICAgICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCBsYXN0TW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGlmTW9kaWZpZWRLZXkgXSA9IGxhc3RNb2RpZmllZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCBldGFnID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkV0YWciKSApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdID0gZXRhZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm90IG1vZGlmaWVkCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gMzA0KSB7CgogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKICAgICAgICAgICAgICAgICAgICAgICAgaXNTdWNjZXNzID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgZGF0YQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGFqYXhDb252ZXJ0KHMsIHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAic3VjY2VzcyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1N1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIGEgcGFyc2VyZXJyb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAicGFyc2VyZXJyb3IiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAogICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cwogICAgICAgICAgICAgICAgICAgIGVycm9yID0gc3RhdHVzVGV4dDsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXR1c1RleHQgfHwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiZXJyb3IiOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAogICAgICAgICAgICAgICAganFYSFIuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgICAganFYSFIuc3RhdHVzVGV4dCA9ICIiICsgKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKTsKCiAgICAgICAgICAgICAgICAvLyBTdWNjZXNzL0Vycm9yCiAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbIHN1Y2Nlc3MsIHN0YXR1c1RleHQsIGpxWEhSIF0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3RXaXRoKGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCwgZXJyb3IgXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICAgICAgICAgIGpxWEhSLnN0YXR1c0NvZGUoc3RhdHVzQ29kZSk7CiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4IiArICggaXNTdWNjZXNzID8gIlN1Y2Nlc3MiIDogIkVycm9yIiApLAogICAgICAgICAgICAgICAgICAgICAgICBbIGpxWEhSLCBzLCBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IgXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ29tcGxldGUKICAgICAgICAgICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0pOwoKICAgICAgICAgICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4Q29tcGxldGUiLCBbIGpxWEhSLCBzIF0pOwogICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgogICAgICAgICAgICAgICAgICAgIGlmICghKCAtLWpRdWVyeS5hY3RpdmUgKSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEF0dGFjaCBkZWZlcnJlZHMKICAgICAgICAgICAgZGVmZXJyZWQucHJvbWlzZShqcVhIUik7CiAgICAgICAgICAgIGpxWEhSLnN1Y2Nlc3MgPSBqcVhIUi5kb25lOwogICAgICAgICAgICBqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CiAgICAgICAgICAgIGpxWEhSLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CgogICAgICAgICAgICAvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwogICAgICAgICAgICBqcVhIUi5zdGF0dXNDb2RlID0gZnVuY3Rpb24gKG1hcCkgewogICAgICAgICAgICAgICAgaWYgKG1hcCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0bXA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlIDwgMikgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHRtcCBpbiBtYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGVbIHRtcCBdID0gWyBzdGF0dXNDb2RlW3RtcF0sIG1hcFt0bXBdIF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSBtYXBbIGpxWEhSLnN0YXR1cyBdOwogICAgICAgICAgICAgICAgICAgICAgICBqcVhIUi50aGVuKHRtcCwgdG1wKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQogICAgICAgICAgICAvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkICgjNTg2NjogSUU3IGlzc3VlIHdpdGggcHJvdG9jb2wtbGVzcyB1cmxzKQogICAgICAgICAgICAvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUKICAgICAgICAgICAgcy51cmwgPSAoICggdXJsIHx8IHMudXJsICkgKyAiIiApLnJlcGxhY2Uocmhhc2gsICIiKS5yZXBsYWNlKHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iKTsKCiAgICAgICAgICAgIC8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKICAgICAgICAgICAgcy5kYXRhVHlwZXMgPSBqUXVlcnkudHJpbShzLmRhdGFUeXBlIHx8ICIqIikudG9Mb3dlckNhc2UoKS5zcGxpdChyc3BhY2VzQWpheCk7CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgaWYgYSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlcgogICAgICAgICAgICBpZiAocy5jcm9zc0RvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwYXJ0cyA9IHJ1cmwuZXhlYyhzLnVybC50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSAhISggcGFydHMgJiYKICAgICAgICAgICAgICAgICAgICAoIHBhcnRzWyAxIF0gIT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPSBhamF4TG9jUGFydHNbIDIgXSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICE9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZwogICAgICAgICAgICBpZiAocy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBcHBseSBwcmVmaWx0ZXJzCiAgICAgICAgICAgIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSKTsKCiAgICAgICAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwogICAgICAgICAgICBmaXJlR2xvYmFscyA9IHMuZ2xvYmFsOwoKICAgICAgICAgICAgLy8gVXBwZXJjYXNlIHRoZSB0eXBlCiAgICAgICAgICAgIHMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgICAgICAgICAgcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdChzLnR5cGUpOwoKICAgICAgICAgICAgLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwogICAgICAgICAgICBpZiAoZmlyZUdsb2JhbHMgJiYgalF1ZXJ5LmFjdGl2ZSsrID09PSAwKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0YXJ0Iik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CiAgICAgICAgICAgIGlmICghcy5oYXNDb250ZW50KSB7CgogICAgICAgICAgICAgICAgLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybAogICAgICAgICAgICAgICAgaWYgKHMuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHMudXJsICs9ICggcnF1ZXJ5LnRlc3Qocy51cmwpID8gIiYiIDogIj8iICkgKyBzLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBzLmRhdGE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2V0IGlmTW9kaWZpZWRLZXkgYmVmb3JlIGFkZGluZyB0aGUgYW50aS1jYWNoZSBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIGlmTW9kaWZpZWRLZXkgPSBzLnVybDsKCiAgICAgICAgICAgICAgICAvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICBpZiAocy5jYWNoZSA9PT0gZmFsc2UpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRzID0galF1ZXJ5Lm5vdygpLAogICAgICAgICAgICAgICAgICAgIC8vIHRyeSByZXBsYWNpbmcgXz0gaWYgaXQgaXMgdGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gcy51cmwucmVwbGFjZShydHMsICIkMV89IiArIHRzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90aGluZyB3YXMgcmVwbGFjZWQsIGFkZCB0aW1lc3RhbXAgdG8gdGhlIGVuZAogICAgICAgICAgICAgICAgICAgIHMudXJsID0gcmV0ICsgKCAoIHJldCA9PT0gcy51cmwgKSA/ICggcnF1ZXJ5LnRlc3Qocy51cmwpID8gIiYiIDogIj8iICkgKyAiXz0iICsgdHMgOiAiIiApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKICAgICAgICAgICAgaWYgKHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSkgewogICAgICAgICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgICAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKICAgICAgICAgICAgICAgIGlmTW9kaWZpZWRLZXkgPSBpZk1vZGlmaWVkS2V5IHx8IHMudXJsOwogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5sYXN0TW9kaWZpZWRbIGlmTW9kaWZpZWRLZXkgXSkgewogICAgICAgICAgICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuZXRhZ1sgaWZNb2RpZmllZEtleSBdKSB7CiAgICAgICAgICAgICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoCiAgICAgICAgICAgICAgICAiQWNjZXB0IiwKICAgICAgICAgICAgICAgIHMuZGF0YVR5cGVzWyAwIF0gJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdID8KICAgICAgICAgICAgICAgICAgICBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gKyAoIHMuZGF0YVR5cGVzWyAwIF0gIT09ICIqIiA/ICIsICIgKyBhbGxUeXBlcyArICI7IHE9MC4wMSIgOiAiIiApIDoKICAgICAgICAgICAgICAgICAgICBzLmFjY2VwdHNbICIqIiBdCiAgICAgICAgICAgICk7CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KICAgICAgICAgICAgZm9yIChpIGluIHMuaGVhZGVycykgewogICAgICAgICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcihpLCBzLmhlYWRlcnNbIGkgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKICAgICAgICAgICAgaWYgKHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMpID09PSBmYWxzZSB8fCBzdGF0ZSA9PT0gMiApKSB7CiAgICAgICAgICAgICAgICAvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5CiAgICAgICAgICAgICAgICBqcVhIUi5hYm9ydCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCiAgICAgICAgICAgIGZvciAoaSBpbiB7IHN1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMSB9KSB7CiAgICAgICAgICAgICAgICBqcVhIUlsgaSBdKHNbIGkgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdldCB0cmFuc3BvcnQKICAgICAgICAgICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIpOwoKICAgICAgICAgICAgLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CiAgICAgICAgICAgIGlmICghdHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgICBkb25lKC0xLCAiTm8gVHJhbnNwb3J0Iik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gMTsKICAgICAgICAgICAgICAgIC8vIFNlbmQgZ2xvYmFsIGV2ZW50CiAgICAgICAgICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgICAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcigiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gVGltZW91dAogICAgICAgICAgICAgICAgaWYgKHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBqcVhIUi5hYm9ydCgidGltZW91dCIpOwogICAgICAgICAgICAgICAgICAgIH0sIHMudGltZW91dCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNwb3J0LnNlbmQocmVxdWVzdEhlYWRlcnMsIGRvbmUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFByb3BhZ2F0ZSBleGNlcHRpb24gYXMgZXJyb3IgaWYgbm90IGRvbmUKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPCAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoLTEsIGUpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW1wbHkgcmV0aHJvdyBvdGhlcndpc2UKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGpxWEhSOwogICAgICAgIH0sCgogICAgICAgIC8vIFNlcmlhbGl6ZSBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIG9yIGEgc2V0IG9mCiAgICAgICAgLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCiAgICAgICAgcGFyYW06IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgICAgICAgICB2YXIgcyA9IFtdLAogICAgICAgICAgICAgICAgYWRkID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlKCkgOiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCiAgICAgICAgICAgIGlmICh0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShhKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdChhKSApKSB7CiAgICAgICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKGEsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBhZGQodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCwgYVsgcHJlZml4IF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCiAgICAgICAgICAgIHJldHVybiBzLmpvaW4oIiYiKS5yZXBsYWNlKHIyMCwgIisiKTsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShvYmopKSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgogICAgICAgICAgICBqUXVlcnkuZWFjaChvYmosIGZ1bmN0aW9uIChpLCB2KSB7CiAgICAgICAgICAgICAgICBpZiAodHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdChwcmVmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgogICAgICAgICAgICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfSBlbHNlIGlmICghdHJhZGl0aW9uYWwgJiYgalF1ZXJ5LnR5cGUob2JqKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgogICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIG9iaikgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqWyBuYW1lIF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSBzY2FsYXIgaXRlbS4KICAgICAgICAgICAgYWRkKHByZWZpeCwgb2JqKTsKICAgICAgICB9CiAgICB9CgovLyBUaGlzIGlzIHN0aWxsIG9uIHRoZSBqUXVlcnkgb2JqZWN0Li4uIGZvciBub3cKLy8gV2FudCB0byBtb3ZlIHRoaXMgdG8galF1ZXJ5LmFqYXggc29tZSBkYXkKICAgIGpRdWVyeS5leHRlbmQoewoKICAgICAgICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICAgICAgICBhY3RpdmU6IDAsCgogICAgICAgIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICAgICAgICBsYXN0TW9kaWZpZWQ6IHt9LAogICAgICAgIGV0YWc6IHt9CgogICAgfSk7CgogICAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICAgICogLSBzZXRzIGFsbCByZXNwb25zZVhYWCBmaWVsZHMgYWNjb3JkaW5nbHkKICAgICAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAgICAgKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICAgICAqLwogICAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CgogICAgICAgIHZhciBjb250ZW50cyA9IHMuY29udGVudHMsCiAgICAgICAgICAgIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAogICAgICAgICAgICByZXNwb25zZUZpZWxkcyA9IHMucmVzcG9uc2VGaWVsZHMsCiAgICAgICAgICAgIGN0LAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBmaW5hbERhdGFUeXBlLAogICAgICAgICAgICBmaXJzdERhdGFUeXBlOwoKICAgICAgICAvLyBGaWxsIHJlc3BvbnNlWFhYIGZpZWxkcwogICAgICAgIGZvciAodHlwZSBpbiByZXNwb25zZUZpZWxkcykgewogICAgICAgICAgICBpZiAodHlwZSBpbiByZXNwb25zZXMpIHsKICAgICAgICAgICAgICAgIGpxWEhSWyByZXNwb25zZUZpZWxkc1t0eXBlXSBdID0gcmVzcG9uc2VzWyB0eXBlIF07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCiAgICAgICAgd2hpbGUgKGRhdGFUeXBlc1sgMCBdID09PSAiKiIpIHsKICAgICAgICAgICAgZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmIChjdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoImNvbnRlbnQtdHlwZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKICAgICAgICBpZiAoY3QpIHsKICAgICAgICAgICAgZm9yICh0eXBlIGluIGNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoY29udGVudHNbIHR5cGUgXSAmJiBjb250ZW50c1sgdHlwZSBdLnRlc3QoY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodHlwZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgICAgIGlmIChkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMpIHsKICAgICAgICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgICAgICAgICAgaWYgKCFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsRGF0YVR5cGUgPSB0eXBlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgZmlyc3REYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCiAgICAgICAgICAgIGZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCiAgICAgICAgLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKICAgICAgICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICAgICAgaWYgKGZpbmFsRGF0YVR5cGUpIHsKICAgICAgICAgICAgaWYgKGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdKSB7CiAgICAgICAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdChmaW5hbERhdGFUeXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07CiAgICAgICAgfQogICAgfQoKLy8gQ2hhaW4gY29udmVyc2lvbnMgZ2l2ZW4gdGhlIHJlcXVlc3QgYW5kIHRoZSBvcmlnaW5hbCByZXNwb25zZQogICAgZnVuY3Rpb24gYWpheENvbnZlcnQocywgcmVzcG9uc2UpIHsKCiAgICAgICAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICAgICAgICBpZiAocy5kYXRhRmlsdGVyKSB7CiAgICAgICAgICAgIHJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKHJlc3BvbnNlLCBzLmRhdGFUeXBlKTsKICAgICAgICB9CgogICAgICAgIHZhciBkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcywKICAgICAgICAgICAgY29udmVydGVycyA9IHt9LAogICAgICAgICAgICBpLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIGxlbmd0aCA9IGRhdGFUeXBlcy5sZW5ndGgsCiAgICAgICAgICAgIHRtcCwKICAgICAgICAvLyBDdXJyZW50IGFuZCBwcmV2aW91cyBkYXRhVHlwZXMKICAgICAgICAgICAgY3VycmVudCA9IGRhdGFUeXBlc1sgMCBdLAogICAgICAgICAgICBwcmV2LAogICAgICAgIC8vIENvbnZlcnNpb24gZXhwcmVzc2lvbgogICAgICAgICAgICBjb252ZXJzaW9uLAogICAgICAgIC8vIENvbnZlcnNpb24gZnVuY3Rpb24KICAgICAgICAgICAgY29udiwKICAgICAgICAvLyBDb252ZXJzaW9uIGZ1bmN0aW9ucyAodHJhbnNpdGl2ZSBjb252ZXJzaW9uKQogICAgICAgICAgICBjb252MSwKICAgICAgICAgICAgY29udjI7CgogICAgICAgIC8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBjaGFpbgogICAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwCiAgICAgICAgICAgIC8vIHdpdGggbG93ZXJjYXNlZCBrZXlzCiAgICAgICAgICAgIGlmIChpID09PSAxKSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBzLmNvbnZlcnRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVydGVyc1sga2V5LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sga2V5IF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZXQgdGhlIGRhdGFUeXBlcwogICAgICAgICAgICBwcmV2ID0gY3VycmVudDsKICAgICAgICAgICAgY3VycmVudCA9IGRhdGFUeXBlc1sgaSBdOwoKICAgICAgICAgICAgLy8gSWYgY3VycmVudCBpcyBhdXRvIGRhdGFUeXBlLCB1cGRhdGUgaXQgdG8gcHJldgogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gIioiKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gcHJldjsKICAgICAgICAgICAgICAgIC8vIElmIG5vIGF1dG8gYW5kIGRhdGFUeXBlcyBhcmUgYWN0dWFsbHkgZGlmZmVyZW50CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQpIHsKCiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGNvbnZlcnRlcgogICAgICAgICAgICAgICAgY29udmVyc2lvbiA9IHByZXYgKyAiICIgKyBjdXJyZW50OwogICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbIGNvbnZlcnNpb24gXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGRpcmVjdCBjb252ZXJ0ZXIsIHNlYXJjaCB0cmFuc2l0aXZlbHkKICAgICAgICAgICAgICAgIGlmICghY29udikgewogICAgICAgICAgICAgICAgICAgIGNvbnYyID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGZvciAoY29udjEgaW4gY29udmVydGVycykgewogICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSBjb252MS5zcGxpdCgiICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wWyAwIF0gPT09IHByZXYgfHwgdG1wWyAwIF0gPT09ICIqIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udjIgPSBjb252ZXJ0ZXJzWyB0bXBbMV0gKyAiICIgKyBjdXJyZW50IF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252MSA9IGNvbnZlcnRlcnNbIGNvbnYxIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnYxID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnYgPSBjb252MjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnYyID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnYgPSBjb252MTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBmb3VuZCBubyBjb252ZXJ0ZXIsIGRpc3BhdGNoIGFuIGVycm9yCiAgICAgICAgICAgICAgICBpZiAoISggY29udiB8fCBjb252MiApKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmVycm9yKCJObyBjb252ZXJzaW9uIGZyb20gIiArIGNvbnZlcnNpb24ucmVwbGFjZSgiICIsICIgdG8gIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gSWYgZm91bmQgY29udmVydGVyIGlzIG5vdCBhbiBlcXVpdmFsZW5jZQogICAgICAgICAgICAgICAgaWYgKGNvbnYgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHdpdGggMSBvciAyIGNvbnZlcnRlcnMgYWNjb3JkaW5nbHkKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYgPyBjb252KHJlc3BvbnNlKSA6IGNvbnYyKGNvbnYxKHJlc3BvbnNlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgfQoKCiAgICB2YXIganNjID0galF1ZXJ5Lm5vdygpLAogICAgICAgIGpzcmUgPSAvKFw9KVw/KCZ8JCl8XD9cPy9pOwoKLy8gRGVmYXVsdCBqc29ucCBzZXR0aW5ncwogICAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICAgICAganNvbnA6ICJjYWxsYmFjayIsCiAgICAgICAganNvbnBDYWxsYmFjazogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIGpzYysrICk7CiAgICAgICAgfQogICAgfSk7CgovLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKICAgIGpRdWVyeS5hamF4UHJlZmlsdGVyKCJqc29uIGpzb25wIiwgZnVuY3Rpb24gKHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSKSB7CgogICAgICAgIHZhciBpbnNwZWN0RGF0YSA9ICggdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgKSAmJiAvXmFwcGxpY2F0aW9uXC94XC13d3dcLWZvcm1cLXVybGVuY29kZWQvLnRlc3Qocy5jb250ZW50VHlwZSk7CgogICAgICAgIGlmIChzLmRhdGFUeXBlc1sgMCBdID09PSAianNvbnAiIHx8CiAgICAgICAgICAgIHMuanNvbnAgIT09IGZhbHNlICYmICgganNyZS50ZXN0KHMudXJsKSB8fAogICAgICAgICAgICAgICAgaW5zcGVjdERhdGEgJiYganNyZS50ZXN0KHMuZGF0YSkgKSkgewoKICAgICAgICAgICAgdmFyIHJlc3BvbnNlQ29udGFpbmVyLAogICAgICAgICAgICAgICAganNvbnBDYWxsYmFjayA9IHMuanNvbnBDYWxsYmFjayA9CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmlzRnVuY3Rpb24ocy5qc29ucENhbGxiYWNrKSA/IHMuanNvbnBDYWxsYmFjaygpIDogcy5qc29ucENhbGxiYWNrLAogICAgICAgICAgICAgICAgcHJldmlvdXMgPSB3aW5kb3dbIGpzb25wQ2FsbGJhY2sgXSwKICAgICAgICAgICAgICAgIHVybCA9IHMudXJsLAogICAgICAgICAgICAgICAgZGF0YSA9IHMuZGF0YSwKICAgICAgICAgICAgICAgIHJlcGxhY2UgPSAiJDEiICsganNvbnBDYWxsYmFjayArICIkMiI7CgogICAgICAgICAgICBpZiAocy5qc29ucCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKGpzcmUsIHJlcGxhY2UpOwogICAgICAgICAgICAgICAgaWYgKHMudXJsID09PSB1cmwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5zcGVjdERhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShqc3JlLCByZXBsYWNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHMuZGF0YSA9PT0gZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBBZGQgY2FsbGJhY2sgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgdXJsICs9ICgvXD8vLnRlc3QodXJsKSA/ICImIiA6ICI/IikgKyBzLmpzb25wICsgIj0iICsganNvbnBDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHMudXJsID0gdXJsOwogICAgICAgICAgICBzLmRhdGEgPSBkYXRhOwoKICAgICAgICAgICAgLy8gSW5zdGFsbCBjYWxsYmFjawogICAgICAgICAgICB3aW5kb3dbIGpzb25wQ2FsbGJhY2sgXSA9IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgcmVzcG9uc2VDb250YWluZXIgPSBbIHJlc3BvbnNlIF07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDbGVhbi11cCBmdW5jdGlvbgogICAgICAgICAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gU2V0IGNhbGxiYWNrIGJhY2sgdG8gcHJldmlvdXMgdmFsdWUKICAgICAgICAgICAgICAgIHdpbmRvd1sganNvbnBDYWxsYmFjayBdID0gcHJldmlvdXM7CiAgICAgICAgICAgICAgICAvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZUNvbnRhaW5lciAmJiBqUXVlcnkuaXNGdW5jdGlvbihwcmV2aW91cykpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbIGpzb25wQ2FsbGJhY2sgXShyZXNwb25zZUNvbnRhaW5lclsgMCBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uCiAgICAgICAgICAgIHMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2VDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXJyb3IoanNvbnBDYWxsYmFjayArICIgd2FzIG5vdCBjYWxsZWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUNvbnRhaW5lclsgMCBdOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gZm9yY2UganNvbiBkYXRhVHlwZQogICAgICAgICAgICBzLmRhdGFUeXBlc1sgMCBdID0gImpzb24iOwoKICAgICAgICAgICAgLy8gRGVsZWdhdGUgdG8gc2NyaXB0CiAgICAgICAgICAgIHJldHVybiAic2NyaXB0IjsKICAgICAgICB9CiAgICB9KTsKCgovLyBJbnN0YWxsIHNjcmlwdCBkYXRhVHlwZQogICAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICAgICAgYWNjZXB0czogewogICAgICAgICAgICBzY3JpcHQ6ICJ0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCIKICAgICAgICB9LAogICAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogL2phdmFzY3JpcHR8ZWNtYXNjcmlwdC8KICAgICAgICB9LAogICAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAgICAgInRleHQgc2NyaXB0IjogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCi8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgZ2xvYmFsCiAgICBqUXVlcnkuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24gKHMpIHsKICAgICAgICBpZiAocy5jYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHMuY2FjaGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgcy50eXBlID0gIkdFVCI7CiAgICAgICAgICAgIHMuZ2xvYmFsID0gZmFsc2U7CiAgICAgICAgfQogICAgfSk7CgovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQKICAgIGpRdWVyeS5hamF4VHJhbnNwb3J0KCJzY3JpcHQiLCBmdW5jdGlvbiAocykgewoKICAgICAgICAvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCiAgICAgICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKCiAgICAgICAgICAgIHZhciBzY3JpcHQsCiAgICAgICAgICAgICAgICBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgIHJldHVybiB7CgogICAgICAgICAgICAgICAgc2VuZDogZnVuY3Rpb24gKF8sIGNhbGxiYWNrKSB7CgogICAgICAgICAgICAgICAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoKICAgICAgICAgICAgICAgICAgICBzY3JpcHQuYXN5bmMgPSAiYXN5bmMiOwoKICAgICAgICAgICAgICAgICAgICBpZiAocy5zY3JpcHRDaGFyc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5jaGFyc2V0ID0gcy5zY3JpcHRDaGFyc2V0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9IHMudXJsOwoKICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwogICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKF8sIGlzQWJvcnQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Fib3J0IHx8ICFzY3JpcHQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHNjcmlwdC5yZWFkeVN0YXRlKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgc2NyaXB0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEZXJlZmVyZW5jZSB0aGUgc2NyaXB0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWJvcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygyMDAsICJzdWNjZXNzIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIC8vIFVzZSBpbnNlcnRCZWZvcmUgaW5zdGVhZCBvZiBhcHBlbmRDaGlsZCAgdG8gY2lyY3VtdmVudCBhbiBJRTYgYnVnLgogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJpc2VzIHdoZW4gYSBiYXNlIG5vZGUgaXMgdXNlZCAoIzI3MDkgYW5kICM0Mzc4KS4KICAgICAgICAgICAgICAgICAgICBoZWFkLmluc2VydEJlZm9yZShzY3JpcHQsIGhlYWQuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmlwdCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25sb2FkKDAsIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCgogICAgdmFyIC8vICM1MjgwOiBJbnRlcm5ldCBFeHBsb3JlciB3aWxsIGtlZXAgY29ubmVjdGlvbnMgYWxpdmUgaWYgd2UgZG9uJ3QgYWJvcnQgb24gdW5sb2FkCiAgICAgICAgeGhyT25VbmxvYWRBYm9ydCA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBBYm9ydCBhbGwgcGVuZGluZyByZXF1ZXN0cwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4geGhyQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgICB4aHJDYWxsYmFja3NbIGtleSBdKDAsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfSA6IGZhbHNlLAogICAgICAgIHhocklkID0gMCwKICAgICAgICB4aHJDYWxsYmFja3M7CgovLyBGdW5jdGlvbnMgdG8gY3JlYXRlIHhocnMKICAgIGZ1bmN0aW9uIGNyZWF0ZVN0YW5kYXJkWEhSKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVBY3RpdmVYSFIoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgfQoKLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAovLyAoVGhpcyBpcyBzdGlsbCBhdHRhY2hlZCB0byBhamF4U2V0dGluZ3MgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCiAgICBqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8KICAgICAgICAvKiBNaWNyb3NvZnQgZmFpbGVkIHRvIHByb3Blcmx5CiAgICAgICAgICogaW1wbGVtZW50IHRoZSBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgKGNhbid0IHJlcXVlc3QgbG9jYWwgZmlsZXMpLAogICAgICAgICAqIHNvIHdlIHVzZSB0aGUgQWN0aXZlWE9iamVjdCB3aGVuIGl0IGlzIGF2YWlsYWJsZQogICAgICAgICAqIEFkZGl0aW9uYWxseSBYTUxIdHRwUmVxdWVzdCBjYW4gYmUgZGlzYWJsZWQgaW4gSUU3L0lFOCBzbwogICAgICAgICAqIHdlIG5lZWQgYSBmYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAhdGhpcy5pc0xvY2FsICYmIGNyZWF0ZVN0YW5kYXJkWEhSKCkgfHwgY3JlYXRlQWN0aXZlWEhSKCk7CiAgICAgICAgfSA6CiAgICAgICAgLy8gRm9yIGFsbCBvdGhlciBicm93c2VycywgdXNlIHRoZSBzdGFuZGFyZCBYTUxIdHRwUmVxdWVzdCBvYmplY3QKICAgICAgICBjcmVhdGVTdGFuZGFyZFhIUjsKCi8vIERldGVybWluZSBzdXBwb3J0IHByb3BlcnRpZXMKICAgIChmdW5jdGlvbiAoeGhyKSB7CiAgICAgICAgalF1ZXJ5LmV4dGVuZChqUXVlcnkuc3VwcG9ydCwgewogICAgICAgICAgICBhamF4OiAhIXhociwKICAgICAgICAgICAgY29yczogISF4aHIgJiYgKCAid2l0aENyZWRlbnRpYWxzIiBpbiB4aHIgKQogICAgICAgIH0pOwogICAgfSkoalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKSk7CgovLyBDcmVhdGUgdHJhbnNwb3J0IGlmIHRoZSBicm93c2VyIGNhbiBwcm92aWRlIGFuIHhocgogICAgaWYgKGpRdWVyeS5zdXBwb3J0LmFqYXgpIHsKCiAgICAgICAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoZnVuY3Rpb24gKHMpIHsKICAgICAgICAgICAgLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdAogICAgICAgICAgICBpZiAoIXMuY3Jvc3NEb21haW4gfHwgalF1ZXJ5LnN1cHBvcnQuY29ycykgewoKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHNlbmQ6IGZ1bmN0aW9uIChoZWFkZXJzLCBjb21wbGV0ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGEgbmV3IHhocgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgeGhyID0gcy54aHIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPcGVuIHRoZSBzb2NrZXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUGFzc2luZyBudWxsIHVzZXJuYW1lLCBnZW5lcmF0ZXMgYSBsb2dpbiBwb3B1cCBvbiBPcGVyYSAoIzI4NjUpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnVzZXJuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub3BlbihzLnR5cGUsIHMudXJsLCBzLmFzeW5jLCBzLnVzZXJuYW1lLCBzLnBhc3N3b3JkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5vcGVuKHMudHlwZSwgcy51cmwsIHMuYXN5bmMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnhockZpZWxkcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIHMueGhyRmllbGRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyWyBpIF0gPSBzLnhockZpZWxkc1sgaSBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZShzLm1pbWVUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cywgc2VlaW5nIGFzIGNvbmRpdGlvbnMgZm9yIGEgcHJlZmxpZ2h0IGFyZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgogICAgICAgICAgICAgICAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yIHNhbWUtZG9tYWluIHJlcXVlc3RzLCB3b24ndCBjaGFuZ2UgaGVhZGVyIGlmIGFscmVhZHkgcHJvdmlkZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzWyAiWC1SZXF1ZXN0ZWQtV2l0aCIgXSA9ICJYTUxIdHRwUmVxdWVzdCI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIGhlYWRlcnNbIGkgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG8gc2VuZCB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24gd2hpY2ggaXMgYWN0dWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFuZGxlZCBpbiBqUXVlcnkuYWpheCAoc28gbm8gdHJ5L2NhdGNoIGhlcmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zZW5kKCggcy5oYXNDb250ZW50ICYmIHMuZGF0YSApIHx8IG51bGwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuZXIKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoXywgaXNBYm9ydCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJlZm94IHRocm93cyBleGNlcHRpb25zIHdoZW4gYWNjZXNzaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9mIGFuIHhociB3aGVuIGEgbmV0d29yayBlcnJvciBvY2N1cmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vaGVscGZ1bC5rbm9icy1kaWFscy5jb20vaW5kZXgucGhwL0NvbXBvbmVudF9yZXR1cm5lZF9mYWlsdXJlX2NvZGU6XzB4ODAwNDAxMTFfKE5TX0VSUk9SX05PVF9BVkFJTEFCTEUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXYXMgbmV2ZXIgY2FsbGVkIGFuZCBpcyBhYm9ydGVkIG9yIGNvbXBsZXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICYmICggaXNBYm9ydCB8fCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IGNhbGxlZCBvbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG8gbm90IGtlZXAgYXMgYWN0aXZlIGFueW1vcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhock9uVW5sb2FkQWJvcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgaXQncyBhbiBhYm9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBYm9ydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWJvcnQgaXQgbWFudWFsbHkgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgIT09IDQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHhoci5yZXNwb25zZVhNTDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDb25zdHJ1Y3QgcmVzcG9uc2UgbGlzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbCAmJiB4bWwuZG9jdW1lbnRFbGVtZW50IC8qICM0OTU4ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VzLnhtbCA9IHhtbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXaGVuIHJlcXVlc3RpbmcgYmluYXJ5IGRhdGEsIElFNi05IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhbnkgYXR0ZW1wdCB0byBhY2Nlc3MgcmVzcG9uc2VUZXh0ICgjMTE0MjYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlcy50ZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJlZm94IHRocm93cyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0YXR1c1RleHQgZm9yIGZhdWx0eSBjcm9zcy1kb21haW4gcmVxdWVzdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgc3RhdHVzIGZvciBub24gc3RhbmRhcmQgYmVoYXZpb3JzCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3QgaXMgbG9jYWwgYW5kIHdlIGhhdmUgZGF0YTogYXNzdW1lIGEgc3VjY2VzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKHN1Y2Nlc3Mgd2l0aCBubyBkYXRhIHdvbid0IGdldCBub3RpZmllZCwgdGhhdCdzIHRoZSBiZXN0IHdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjYW4gZG8gZ2l2ZW4gY3VycmVudCBpbXBsZW1lbnRhdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXR1cyAmJiBzLmlzTG9jYWwgJiYgIXMuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSByZXNwb25zZXMudGV4dCA/IDIwMCA6IDQwNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJRSAtICMxNDUwOiBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDEyMjMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSAyMDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChmaXJlZm94QWNjZXNzRXhjZXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Fib3J0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKC0xLCBmaXJlZm94QWNjZXNzRXhjZXB0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCBjb21wbGV0ZSBpZiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZShzdGF0dXMsIHN0YXR1c1RleHQsIHJlc3BvbnNlcywgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGluIHN5bmMgbW9kZSBvciBpdCdzIGluIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBoYXMgYmVlbiByZXRyaWV2ZWQgZGlyZWN0bHkgKElFNiAmIElFNykKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBtYW51YWxseSBmaXJlIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMuYXN5bmMgfHwgeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUgPSArK3hocklkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhock9uVW5sb2FkQWJvcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFjdGl2ZSB4aHJzIGNhbGxiYWNrcyBsaXN0IGlmIG5lZWRlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBhdHRhY2ggdGhlIHVubG9hZCBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF4aHJDYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyQ2FsbGJhY2tzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSh3aW5kb3cpLnVubG9hZCh4aHJPblVubG9hZEFib3J0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHRvIGxpc3Qgb2YgYWN0aXZlIHhocnMgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyQ2FsbGJhY2tzWyBoYW5kbGUgXSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygwLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCgogICAgdmFyIGVsZW1kaXNwbGF5ID0ge30sCiAgICAgICAgaWZyYW1lLCBpZnJhbWVEb2MsCiAgICAgICAgcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCiAgICAgICAgcmZ4bnVtID0gL14oWytcLV09KT8oW1xkKy5cLV0rKShbYS16JV0qKSQvaSwKICAgICAgICB0aW1lcklkLAogICAgICAgIGZ4QXR0cnMgPSBbCiAgICAgICAgICAgIC8vIGhlaWdodCBhbmltYXRpb25zCiAgICAgICAgICAgIFsgImhlaWdodCIsICJtYXJnaW5Ub3AiLCAibWFyZ2luQm90dG9tIiwgInBhZGRpbmdUb3AiLCAicGFkZGluZ0JvdHRvbSIgXSwKICAgICAgICAgICAgLy8gd2lkdGggYW5pbWF0aW9ucwogICAgICAgICAgICBbICJ3aWR0aCIsICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiwgInBhZGRpbmdMZWZ0IiwgInBhZGRpbmdSaWdodCIgXSwKICAgICAgICAgICAgLy8gb3BhY2l0eSBhbmltYXRpb25zCiAgICAgICAgICAgIFsgIm9wYWNpdHkiIF0KICAgICAgICBdLAogICAgICAgIGZ4Tm93OwoKICAgIGpRdWVyeS5mbi5leHRlbmQoewogICAgICAgIHNob3c6IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZWxlbSwgZGlzcGxheTsKCiAgICAgICAgICAgIGlmIChzcGVlZCB8fCBzcGVlZCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShnZW5GeCgic2hvdyIsIDMpLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB0aGlzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGVsZW0gPSB0aGlzWyBpIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkuX2RhdGEoZWxlbSwgIm9sZGRpc3BsYXkiKSAmJiBkaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IGVsZW1lbnRzIHdoaWNoIGhhdmUgYmVlbiBvdmVycmlkZGVuIHdpdGggZGlzcGxheTogbm9uZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBhIHN0eWxlc2hlZXQgdG8gd2hhdGV2ZXIgdGhlIGRlZmF1bHQgYnJvd3NlciBzdHlsZSBpcwogICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3Igc3VjaCBhbiBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZGlzcGxheSA9PT0gIiIgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpID09PSAibm9uZSIpIHx8ICFqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZWxlbSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5fZGF0YShlbGVtLCAib2xkZGlzcGxheSIsIGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGRpc3BsYXkgb2YgbW9zdCBvZiB0aGUgZWxlbWVudHMgaW4gYSBzZWNvbmQgbG9vcAogICAgICAgICAgICAgICAgLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGVsZW0gPSB0aGlzWyBpIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzcGxheSA9PT0gIiIgfHwgZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSBqUXVlcnkuX2RhdGEoZWxlbSwgIm9sZGRpc3BsYXkiKSB8fCAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGhpZGU6IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoc3BlZWQgfHwgc3BlZWQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGUoZ2VuRngoImhpZGUiLCAzKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtLCBkaXNwbGF5LAogICAgICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgICAgIGogPSB0aGlzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGVsZW0gPSB0aGlzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5Iik7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzcGxheSAhPT0gIm5vbmUiICYmICFqUXVlcnkuX2RhdGEoZWxlbSwgIm9sZGRpc3BsYXkiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sICJvbGRkaXNwbGF5IiwgZGlzcGxheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBkaXNwbGF5IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCiAgICAgICAgICAgICAgICAvLyB0byBhdm9pZCB0aGUgY29uc3RhbnQgcmVmbG93CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbaV0uc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFNhdmUgdGhlIG9sZCB0b2dnbGUgZnVuY3Rpb24KICAgICAgICBfdG9nZ2xlOiBqUXVlcnkuZm4udG9nZ2xlLAoKICAgICAgICB0b2dnbGU6IGZ1bmN0aW9uIChmbiwgZm4yLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgYm9vbCA9IHR5cGVvZiBmbiA9PT0gImJvb2xlYW4iOwoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGZuKSAmJiBqUXVlcnkuaXNGdW5jdGlvbihmbjIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90b2dnbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCB8fCBib29sKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGJvb2wgPyBmbiA6IGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKVsgc3RhdGUgPyAic2hvdyIgOiAiaGlkZSIgXSgpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5hbmltYXRlKGdlbkZ4KCJ0b2dnbGUiLCAzKSwgZm4sIGZuMiwgY2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBmYWRlVG86IGZ1bmN0aW9uIChzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKCI6aGlkZGVuIikuY3NzKCJvcGFjaXR5IiwgMCkuc2hvdygpLmVuZCgpCiAgICAgICAgICAgICAgICAuYW5pbWF0ZSh7b3BhY2l0eTogdG99LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgYW5pbWF0ZTogZnVuY3Rpb24gKHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0VtcHR5T2JqZWN0KHByb3ApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKG9wdGFsbC5jb21wbGV0ZSwgWyBmYWxzZSBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRG8gbm90IGNoYW5nZSByZWZlcmVuY2VkIHByb3BlcnRpZXMgYXMgcGVyLXByb3BlcnR5IGVhc2luZyB3aWxsIGJlIGxvc3QKICAgICAgICAgICAgcHJvcCA9IGpRdWVyeS5leHRlbmQoe30sIHByb3ApOwoKICAgICAgICAgICAgZnVuY3Rpb24gZG9BbmltYXRpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBYWFggJ3RoaXMnIGRvZXMgbm90IGFsd2F5cyBoYXZlIGEgbm9kZU5hbWUgd2hlbiBydW5uaW5nIHRoZQogICAgICAgICAgICAgICAgLy8gdGVzdCBzdWl0ZQoKICAgICAgICAgICAgICAgIGlmIChvcHRhbGwucXVldWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9tYXJrKHRoaXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBvcHQgPSBqUXVlcnkuZXh0ZW5kKHt9LCBvcHRhbGwpLAogICAgICAgICAgICAgICAgICAgIGlzRWxlbWVudCA9IHRoaXMubm9kZVR5cGUgPT09IDEsCiAgICAgICAgICAgICAgICAgICAgaGlkZGVuID0gaXNFbGVtZW50ICYmIGpRdWVyeSh0aGlzKS5pcygiOmhpZGRlbiIpLAogICAgICAgICAgICAgICAgICAgIG5hbWUsIHZhbCwgcCwgZSwgaG9va3MsIHJlcGxhY2UsCiAgICAgICAgICAgICAgICAgICAgcGFydHMsIHN0YXJ0LCBlbmQsIHVuaXQsCiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOwoKICAgICAgICAgICAgICAgIC8vIHdpbGwgc3RvcmUgcGVyIHByb3BlcnR5IGVhc2luZyBhbmQgYmUgdXNlZCB0byBkZXRlcm1pbmUgd2hlbiBhbiBhbmltYXRpb24gaXMgY29tcGxldGUKICAgICAgICAgICAgICAgIG9wdC5hbmltYXRlZFByb3BlcnRpZXMgPSB7fTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBwYXNzIG92ZXIgcHJvcGVydHlzIHRvIGV4cGFuZCAvIG5vcm1hbGl6ZQogICAgICAgICAgICAgICAgZm9yIChwIGluIHByb3ApIHsKICAgICAgICAgICAgICAgICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShwKTsKICAgICAgICAgICAgICAgICAgICBpZiAocCAhPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9wWyBuYW1lIF0gPSBwcm9wWyBwIF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwcm9wWyBwIF07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoKCBob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdICkgJiYgImV4cGFuZCIgaW4gaG9va3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSA9IGhvb2tzLmV4cGFuZChwcm9wWyBuYW1lIF0pOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcHJvcFsgbmFtZSBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbHNvIC0gcmV1c2luZyAncCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocCBpbiByZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISggcCBpbiBwcm9wICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wWyBwIF0gPSByZXBsYWNlWyBwIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIHByb3ApIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBwcm9wWyBuYW1lIF07CiAgICAgICAgICAgICAgICAgICAgLy8gZWFzaW5nIHJlc29sdXRpb246IHBlciBwcm9wZXJ0eSA+IG9wdC5zcGVjaWFsRWFzaW5nID4gb3B0LmVhc2luZyA+ICdzd2luZycgKGRlZmF1bHQpCiAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmFuaW1hdGVkUHJvcGVydGllc1sgbmFtZSBdID0gdmFsWyAxIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHByb3BbIG5hbWUgXSA9IHZhbFsgMCBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5hbmltYXRlZFByb3BlcnRpZXNbIG5hbWUgXSA9IG9wdC5zcGVjaWFsRWFzaW5nICYmIG9wdC5zcGVjaWFsRWFzaW5nWyBuYW1lIF0gfHwgb3B0LmVhc2luZyB8fCAnc3dpbmcnOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gImhpZGUiICYmIGhpZGRlbiB8fCB2YWwgPT09ICJzaG93IiAmJiAhaGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHQuY29tcGxldGUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpc0VsZW1lbnQgJiYgKCBuYW1lID09PSAiaGVpZ2h0IiB8fCBuYW1lID09PSAid2lkdGgiICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5vdmVyZmxvdyA9IFsgdGhpcy5zdHlsZS5vdmVyZmxvdywgdGhpcy5zdHlsZS5vdmVyZmxvd1gsIHRoaXMuc3R5bGUub3ZlcmZsb3dZIF07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmltYXRpb25zIG9uIGlubGluZSBlbGVtZW50cyB0aGF0IGFyZSBoYXZpbmcgd2lkdGgvaGVpZ2h0IGFuaW1hdGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuY3NzKHRoaXMsICJkaXNwbGF5IikgPT09ICJpbmxpbmUiICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuY3NzKHRoaXMsICJmbG9hdCIpID09PSAibm9uZSIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrLWxldmVsIGVsZW1lbnRzIG5lZWQgdG8gYmUgaW5saW5lIHdpdGggbGF5b3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LmlubGluZUJsb2NrTmVlZHNMYXlvdXQgfHwgZGVmYXVsdERpc3BsYXkodGhpcy5ub2RlTmFtZSkgPT09ICJpbmxpbmUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLnpvb20gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChvcHQub3ZlcmZsb3cgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gcHJvcCkgewogICAgICAgICAgICAgICAgICAgIGUgPSBuZXcgalF1ZXJ5LmZ4KHRoaXMsIG9wdCwgcCk7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gcHJvcFsgcCBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAocmZ4dHlwZXMudGVzdCh2YWwpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmFja3Mgd2hldGhlciB0byBzaG93IG9yIGhpZGUgYmFzZWQgb24gcHJpdmF0ZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IGpRdWVyeS5fZGF0YSh0aGlzLCAidG9nZ2xlIiArIHApIHx8ICggdmFsID09PSAidG9nZ2xlIiA/IGhpZGRlbiA/ICJzaG93IiA6ICJoaWRlIiA6IDAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKHRoaXMsICJ0b2dnbGUiICsgcCwgbWV0aG9kID09PSAic2hvdyIgPyAiaGlkZSIgOiAic2hvdyIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZVsgbWV0aG9kIF0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVbIHZhbCBdKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSByZnhudW0uZXhlYyh2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGUuY3VyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHBhcnNlRmxvYXQocGFydHNbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdCA9IHBhcnRzWzNdIHx8ICggalF1ZXJ5LmNzc051bWJlclsgcCBdID8gIiIgOiAicHgiICk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBjb21wdXRlIHN0YXJ0aW5nIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5pdCAhPT0gInB4IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5zdHlsZSh0aGlzLCBwLCAoZW5kIHx8IDEpICsgdW5pdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSAoIChlbmQgfHwgMSkgLyBlLmN1cigpICkgKiBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuc3R5bGUodGhpcywgcCwgc3RhcnQgKyB1bml0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0c1sxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9ICggKHBhcnRzWyAxIF0gPT09ICItPSIgPyAtMSA6IDEpICogZW5kICkgKyBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmN1c3RvbShzdGFydCwgZW5kLCB1bml0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmN1c3RvbShzdGFydCwgdmFsLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRm9yIEpTIHN0cmljdCBjb21wbGlhbmNlCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwogICAgICAgICAgICAgICAgdGhpcy5lYWNoKGRvQW5pbWF0aW9uKSA6CiAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlKG9wdGFsbC5xdWV1ZSwgZG9BbmltYXRpb24pOwogICAgICAgIH0sCgogICAgICAgIHN0b3A6IGZ1bmN0aW9uICh0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGdvdG9FbmQgPSBjbGVhclF1ZXVlOwogICAgICAgICAgICAgICAgY2xlYXJRdWV1ZSA9IHR5cGU7CiAgICAgICAgICAgICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjbGVhclF1ZXVlICYmIHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlKHR5cGUgfHwgImZ4IiwgW10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCwKICAgICAgICAgICAgICAgICAgICBoYWRUaW1lcnMgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBqUXVlcnkuX2RhdGEodGhpcyk7CgogICAgICAgICAgICAgICAgLy8gY2xlYXIgbWFya2VyIGNvdW50ZXJzIGlmIHdlIGtub3cgdGhleSB3b24ndCBiZQogICAgICAgICAgICAgICAgaWYgKCFnb3RvRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll91bm1hcmsodHJ1ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc3RvcFF1ZXVlKGVsZW0sIGRhdGEsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhvb2tzID0gZGF0YVsgaW5kZXggXTsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCBpbmRleCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaG9va3Muc3RvcChnb3RvRW5kKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWyBpbmRleCBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCAmJiBpbmRleC5pbmRleE9mKCIucnVuIikgPT09IGluZGV4Lmxlbmd0aCAtIDQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BRdWV1ZSh0aGlzLCBkYXRhLCBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFbIGluZGV4ID0gdHlwZSArICIucnVuIiBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCkgewogICAgICAgICAgICAgICAgICAgIHN0b3BRdWV1ZSh0aGlzLCBkYXRhLCBpbmRleCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVyc1sgaW5kZXggXS5lbGVtID09PSB0aGlzICYmICh0eXBlID09IG51bGwgfHwgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ290b0VuZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvcmNlIHRoZSBuZXh0IHN0ZXAgdG8gYmUgdGhlIGxhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyc1sgaW5kZXggXSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyc1sgaW5kZXggXS5zYXZlU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYWRUaW1lcnMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZAogICAgICAgICAgICAgICAgLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKICAgICAgICAgICAgICAgIC8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kCiAgICAgICAgICAgICAgICBpZiAoISggZ290b0VuZCAmJiBoYWRUaW1lcnMgKSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgfSk7CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CiAgICBmdW5jdGlvbiBjcmVhdGVGeE5vdygpIHsKICAgICAgICBzZXRUaW1lb3V0KGNsZWFyRnhOb3csIDApOwogICAgICAgIHJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJGeE5vdygpIHsKICAgICAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICAgIH0KCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCiAgICBmdW5jdGlvbiBnZW5GeCh0eXBlLCBudW0pIHsKICAgICAgICB2YXIgb2JqID0ge307CgogICAgICAgIGpRdWVyeS5lYWNoKGZ4QXR0cnMuY29uY2F0LmFwcGx5KFtdLCBmeEF0dHJzLnNsaWNlKDAsIG51bSkpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIG9ialsgdGhpcyBdID0gdHlwZTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCi8vIEdlbmVyYXRlIHNob3J0Y3V0cyBmb3IgY3VzdG9tIGFuaW1hdGlvbnMKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgICBzbGlkZURvd246IGdlbkZ4KCJzaG93IiwgMSksCiAgICAgICAgc2xpZGVVcDogZ2VuRngoImhpZGUiLCAxKSwKICAgICAgICBzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIsIDEpLAogICAgICAgIGZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKICAgICAgICBmYWRlT3V0OiB7IG9wYWNpdHk6ICJoaWRlIiB9LAogICAgICAgIGZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQogICAgfSwgZnVuY3Rpb24gKG5hbWUsIHByb3BzKSB7CiAgICAgICAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgICAgIH07CiAgICB9KTsKCiAgICBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICBzcGVlZDogZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGZuKSB7CiAgICAgICAgICAgIHZhciBvcHQgPSBzcGVlZCAmJiB0eXBlb2Ygc3BlZWQgPT09ICJvYmplY3QiID8galF1ZXJ5LmV4dGVuZCh7fSwgc3BlZWQpIDogewogICAgICAgICAgICAgICAgY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuaXNGdW5jdGlvbihzcGVlZCkgJiYgc3BlZWQsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogc3BlZWQsCiAgICAgICAgICAgICAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKGVhc2luZykgJiYgZWFzaW5nCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKICAgICAgICAgICAgICAgIG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKICAgICAgICAgICAgLy8gbm9ybWFsaXplIG9wdC5xdWV1ZSAtIHRydWUvdW5kZWZpbmVkL251bGwgLT4gImZ4IgogICAgICAgICAgICBpZiAob3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBvcHQucXVldWUgPSAiZngiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBRdWV1ZWluZwogICAgICAgICAgICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwoKICAgICAgICAgICAgb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24gKG5vVW5tYXJrKSB7CiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ob3B0Lm9sZCkpIHsKICAgICAgICAgICAgICAgICAgICBvcHQub2xkLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdC5xdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIG9wdC5xdWV1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vVW5tYXJrICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5fdW5tYXJrKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIG9wdDsKICAgICAgICB9LAoKICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgbGluZWFyOiBmdW5jdGlvbiAocCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN3aW5nOiBmdW5jdGlvbiAocCkgewogICAgICAgICAgICAgICAgcmV0dXJuICggLU1hdGguY29zKHAgKiBNYXRoLlBJKSAvIDIgKSArIDAuNTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHRpbWVyczogW10sCgogICAgICAgIGZ4OiBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgcHJvcCkgewogICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICB0aGlzLmVsZW0gPSBlbGVtOwogICAgICAgICAgICB0aGlzLnByb3AgPSBwcm9wOwoKICAgICAgICAgICAgb3B0aW9ucy5vcmlnID0gb3B0aW9ucy5vcmlnIHx8IHt9OwogICAgICAgIH0KCiAgICB9KTsKCiAgICBqUXVlcnkuZngucHJvdG90eXBlID0gewogICAgICAgIC8vIFNpbXBsZSBmdW5jdGlvbiBmb3Igc2V0dGluZyBhIHN0eWxlIHZhbHVlCiAgICAgICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc3RlcCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCh0aGlzLmVsZW0sIHRoaXMubm93LCB0aGlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgKCBqUXVlcnkuZnguc3RlcFsgdGhpcy5wcm9wIF0gfHwgalF1ZXJ5LmZ4LnN0ZXAuX2RlZmF1bHQgKSh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvLyBHZXQgdGhlIGN1cnJlbnQgc2l6ZQogICAgICAgIGN1cjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5lbGVtWyB0aGlzLnByb3AgXSAhPSBudWxsICYmICghdGhpcy5lbGVtLnN0eWxlIHx8IHRoaXMuZWxlbS5zdHlsZVsgdGhpcy5wcm9wIF0gPT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVsZW1bIHRoaXMucHJvcCBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcGFyc2VkLAogICAgICAgICAgICAgICAgciA9IGpRdWVyeS5jc3ModGhpcy5lbGVtLCB0aGlzLnByb3ApOwogICAgICAgICAgICAvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAsCiAgICAgICAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLAogICAgICAgICAgICAvLyBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCiAgICAgICAgICAgIHJldHVybiBpc05hTihwYXJzZWQgPSBwYXJzZUZsb2F0KHIpKSA/ICFyIHx8IHIgPT09ICJhdXRvIiA/IDAgOiByIDogcGFyc2VkOwogICAgICAgIH0sCgogICAgICAgIC8vIFN0YXJ0IGFuIGFuaW1hdGlvbiBmcm9tIG9uZSBudW1iZXIgdG8gYW5vdGhlcgogICAgICAgIGN1c3RvbTogZnVuY3Rpb24gKGZyb20sIHRvLCB1bml0KSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgIGZ4ID0galF1ZXJ5LmZ4OwoKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpOwogICAgICAgICAgICB0aGlzLmVuZCA9IHRvOwogICAgICAgICAgICB0aGlzLm5vdyA9IHRoaXMuc3RhcnQgPSBmcm9tOwogICAgICAgICAgICB0aGlzLnBvcyA9IHRoaXMuc3RhdGUgPSAwOwogICAgICAgICAgICB0aGlzLnVuaXQgPSB1bml0IHx8IHRoaXMudW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHRoaXMucHJvcCBdID8gIiIgOiAicHgiICk7CgogICAgICAgICAgICBmdW5jdGlvbiB0KGdvdG9FbmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnN0ZXAoZ290b0VuZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHQucXVldWUgPSB0aGlzLm9wdGlvbnMucXVldWU7CiAgICAgICAgICAgIHQuZWxlbSA9IHRoaXMuZWxlbTsKICAgICAgICAgICAgdC5zYXZlU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Ll9kYXRhKHNlbGYuZWxlbSwgImZ4c2hvdyIgKyBzZWxmLnByb3ApID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmhpZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKHNlbGYuZWxlbSwgImZ4c2hvdyIgKyBzZWxmLnByb3AsIHNlbGYuc3RhcnQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VsZi5vcHRpb25zLnNob3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKHNlbGYuZWxlbSwgImZ4c2hvdyIgKyBzZWxmLnByb3AsIHNlbGYuZW5kKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodCgpICYmIGpRdWVyeS50aW1lcnMucHVzaCh0KSAmJiAhdGltZXJJZCkgewogICAgICAgICAgICAgICAgdGltZXJJZCA9IHNldEludGVydmFsKGZ4LnRpY2ssIGZ4LmludGVydmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFNpbXBsZSAnc2hvdycgZnVuY3Rpb24KICAgICAgICBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBkYXRhU2hvdyA9IGpRdWVyeS5fZGF0YSh0aGlzLmVsZW0sICJmeHNob3ciICsgdGhpcy5wcm9wKTsKCiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9yaWdbIHRoaXMucHJvcCBdID0gZGF0YVNob3cgfHwgalF1ZXJ5LnN0eWxlKHRoaXMuZWxlbSwgdGhpcy5wcm9wKTsKICAgICAgICAgICAgdGhpcy5vcHRpb25zLnNob3cgPSB0cnVlOwoKICAgICAgICAgICAgLy8gQmVnaW4gdGhlIGFuaW1hdGlvbgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSBzdGFydCBhdCBhIHNtYWxsIHdpZHRoL2hlaWdodCB0byBhdm9pZCBhbnkgZmxhc2ggb2YgY29udGVudAogICAgICAgICAgICBpZiAoZGF0YVNob3cgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgLy8gVGhpcyBzaG93IGlzIHBpY2tpbmcgdXAgd2hlcmUgYSBwcmV2aW91cyBoaWRlIG9yIHNob3cgbGVmdCBvZmYKICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tKHRoaXMuY3VyKCksIGRhdGFTaG93KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tKHRoaXMucHJvcCA9PT0gIndpZHRoIiB8fCB0aGlzLnByb3AgPT09ICJoZWlnaHQiID8gMSA6IDAsIHRoaXMuY3VyKCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdGFydCBieSBzaG93aW5nIHRoZSBlbGVtZW50CiAgICAgICAgICAgIGpRdWVyeSh0aGlzLmVsZW0pLnNob3coKTsKICAgICAgICB9LAoKICAgICAgICAvLyBTaW1wbGUgJ2hpZGUnIGZ1bmN0aW9uCiAgICAgICAgaGlkZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBSZW1lbWJlciB3aGVyZSB3ZSBzdGFydGVkLCBzbyB0aGF0IHdlIGNhbiBnbyBiYWNrIHRvIGl0IGxhdGVyCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5vcmlnWyB0aGlzLnByb3AgXSA9IGpRdWVyeS5fZGF0YSh0aGlzLmVsZW0sICJmeHNob3ciICsgdGhpcy5wcm9wKSB8fCBqUXVlcnkuc3R5bGUodGhpcy5lbGVtLCB0aGlzLnByb3ApOwogICAgICAgICAgICB0aGlzLm9wdGlvbnMuaGlkZSA9IHRydWU7CgogICAgICAgICAgICAvLyBCZWdpbiB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgIHRoaXMuY3VzdG9tKHRoaXMuY3VyKCksIDApOwogICAgICAgIH0sCgogICAgICAgIC8vIEVhY2ggc3RlcCBvZiBhbiBhbmltYXRpb24KICAgICAgICBzdGVwOiBmdW5jdGlvbiAoZ290b0VuZCkgewogICAgICAgICAgICB2YXIgcCwgbiwgY29tcGxldGUsCiAgICAgICAgICAgICAgICB0ID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlLAogICAgICAgICAgICAgICAgZWxlbSA9IHRoaXMuZWxlbSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgogICAgICAgICAgICBpZiAoZ290b0VuZCB8fCB0ID49IG9wdGlvbnMuZHVyYXRpb24gKyB0aGlzLnN0YXJ0VGltZSkgewogICAgICAgICAgICAgICAgdGhpcy5ub3cgPSB0aGlzLmVuZDsKICAgICAgICAgICAgICAgIHRoaXMucG9zID0gdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSgpOwoKICAgICAgICAgICAgICAgIG9wdGlvbnMuYW5pbWF0ZWRQcm9wZXJ0aWVzWyB0aGlzLnByb3AgXSA9IHRydWU7CgogICAgICAgICAgICAgICAgZm9yIChwIGluIG9wdGlvbnMuYW5pbWF0ZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuYW5pbWF0ZWRQcm9wZXJ0aWVzWyBwIF0gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRoZSBvdmVyZmxvdwogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm92ZXJmbG93ICE9IG51bGwgJiYgIWpRdWVyeS5zdXBwb3J0LnNocmlua1dyYXBCbG9ja3MpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKFsgIiIsICJYIiwgIlkiIF0sIGZ1bmN0aW9uIChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc3R5bGVbICJvdmVyZmxvdyIgKyB2YWx1ZSBdID0gb3B0aW9ucy5vdmVyZmxvd1sgaW5kZXggXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBIaWRlIHRoZSBlbGVtZW50IGlmIHRoZSAiaGlkZSIgb3BlcmF0aW9uIHdhcyBkb25lCiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGlkZSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoZWxlbSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgdGhlIHByb3BlcnRpZXMsIGlmIHRoZSBpdGVtIGhhcyBiZWVuIGhpZGRlbiBvciBzaG93bgogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmhpZGUgfHwgb3B0aW9ucy5zaG93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocCBpbiBvcHRpb25zLmFuaW1hdGVkUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKGVsZW0sIHAsIG9wdGlvbnMub3JpZ1sgcCBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVEYXRhKGVsZW0sICJmeHNob3ciICsgcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUb2dnbGUgZGF0YSBpcyBubyBsb25nZXIgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCAidG9nZ2xlIiArIHAsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBjb21wbGV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCB0aGF0IHRoZSBjb21wbGV0ZSBmdW5jdGlvbiB0aHJvd3MgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBlbnN1cmUgaXQgd29uJ3QgYmUgY2FsbGVkIHR3aWNlLiAjNTY4NAoKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNvbXBsZXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlLmNhbGwoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBjbGFzc2ljYWwgZWFzaW5nIGNhbm5vdCBiZSB1c2VkIHdpdGggYW4gSW5maW5pdHkgZHVyYXRpb24KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmR1cmF0aW9uID09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3cgPSB0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuID0gdCAtIHRoaXMuc3RhcnRUaW1lOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBuIC8gb3B0aW9ucy5kdXJhdGlvbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gUGVyZm9ybSB0aGUgZWFzaW5nIGZ1bmN0aW9uLCBkZWZhdWx0cyB0byBzd2luZwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9zID0galF1ZXJ5LmVhc2luZ1sgb3B0aW9ucy5hbmltYXRlZFByb3BlcnRpZXNbdGhpcy5wcm9wXSBdKHRoaXMuc3RhdGUsIG4sIDAsIDEsIG9wdGlvbnMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIHRoaXMubm93ID0gdGhpcy5zdGFydCArICggKHRoaXMuZW5kIC0gdGhpcy5zdGFydCkgKiB0aGlzLnBvcyApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gUGVyZm9ybSB0aGUgbmV4dCBzdGVwIG9mIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH07CgogICAgalF1ZXJ5LmV4dGVuZChqUXVlcnkuZngsIHsKICAgICAgICB0aWNrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aW1lciwKICAgICAgICAgICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgICAgICAgICBpID0gMDsKCiAgICAgICAgICAgIGZvciAoOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aW1lciA9IHRpbWVyc1sgaSBdOwogICAgICAgICAgICAgICAgLy8gQ2hlY2tzIHRoZSB0aW1lciBoYXMgbm90IGFscmVhZHkgYmVlbiByZW1vdmVkCiAgICAgICAgICAgICAgICBpZiAoIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGltZXJzLnNwbGljZShpLS0sIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRpbWVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5meC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBpbnRlcnZhbDogMTMsCgogICAgICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcklkKTsKICAgICAgICAgICAgdGltZXJJZCA9IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgc3BlZWRzOiB7CiAgICAgICAgICAgIHNsb3c6IDYwMCwKICAgICAgICAgICAgZmFzdDogMjAwLAogICAgICAgICAgICAvLyBEZWZhdWx0IHNwZWVkCiAgICAgICAgICAgIF9kZWZhdWx0OiA0MDAKICAgICAgICB9LAoKICAgICAgICBzdGVwOiB7CiAgICAgICAgICAgIG9wYWNpdHk6IGZ1bmN0aW9uIChmeCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKGZ4LmVsZW0sICJvcGFjaXR5IiwgZngubm93KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9kZWZhdWx0OiBmdW5jdGlvbiAoZngpIHsKICAgICAgICAgICAgICAgIGlmIChmeC5lbGVtLnN0eWxlICYmIGZ4LmVsZW0uc3R5bGVbIGZ4LnByb3AgXSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZnguZWxlbS5zdHlsZVsgZngucHJvcCBdID0gZngubm93ICsgZngudW5pdDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZnguZWxlbVsgZngucHJvcCBdID0gZngubm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgovLyBFbnN1cmUgcHJvcHMgdGhhdCBjYW4ndCBiZSBuZWdhdGl2ZSBkb24ndCBnbyB0aGVyZSBvbiB1bmRlcnNob290IGVhc2luZwogICAgalF1ZXJ5LmVhY2goZnhBdHRycy5jb25jYXQuYXBwbHkoW10sIGZ4QXR0cnMpLCBmdW5jdGlvbiAoaSwgcHJvcCkgewogICAgICAgIC8vIGV4Y2x1ZGUgbWFyZ2luVG9wLCBtYXJnaW5MZWZ0LCBtYXJnaW5Cb3R0b20gYW5kIG1hcmdpblJpZ2h0IGZyb20gdGhpcyBsaXN0CiAgICAgICAgaWYgKHByb3AuaW5kZXhPZigibWFyZ2luIikpIHsKICAgICAgICAgICAgalF1ZXJ5LmZ4LnN0ZXBbIHByb3AgXSA9IGZ1bmN0aW9uIChmeCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKGZ4LmVsZW0sIHByb3AsIE1hdGgubWF4KDAsIGZ4Lm5vdykgKyBmeC51bml0KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICBpZiAoalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycykgewogICAgICAgIGpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycyxmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtID09PSBmbi5lbGVtOwogICAgICAgICAgICB9KS5sZW5ndGg7CiAgICAgICAgfTsKICAgIH0KCi8vIFRyeSB0byByZXN0b3JlIHRoZSBkZWZhdWx0IGRpc3BsYXkgdmFsdWUgb2YgYW4gZWxlbWVudAogICAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKCiAgICAgICAgaWYgKCFlbGVtZGlzcGxheVsgbm9kZU5hbWUgXSkgewoKICAgICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5LAogICAgICAgICAgICAgICAgZWxlbSA9IGpRdWVyeSgiPCIgKyBub2RlTmFtZSArICI+IikuYXBwZW5kVG8oYm9keSksCiAgICAgICAgICAgICAgICBkaXNwbGF5ID0gZWxlbS5jc3MoImRpc3BsYXkiKTsKICAgICAgICAgICAgZWxlbS5yZW1vdmUoKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBzaW1wbGUgd2F5IGZhaWxzLAogICAgICAgICAgICAvLyBnZXQgZWxlbWVudCdzIHJlYWwgZGVmYXVsdCBkaXNwbGF5IGJ5IGF0dGFjaGluZyBpdCB0byBhIHRlbXAgaWZyYW1lCiAgICAgICAgICAgIGlmIChkaXNwbGF5ID09PSAibm9uZSIgfHwgZGlzcGxheSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIC8vIE5vIGlmcmFtZSB0byB1c2UgeWV0LCBzbyBjcmVhdGUgaXQKICAgICAgICAgICAgICAgIGlmICghaWZyYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaWZyYW1lIik7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lLmZyYW1lQm9yZGVyID0gaWZyYW1lLndpZHRoID0gaWZyYW1lLmhlaWdodCA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm9keS5hcHBlbmRDaGlsZChpZnJhbWUpOwoKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhIGNhY2hlYWJsZSBjb3B5IG9mIHRoZSBpZnJhbWUgZG9jdW1lbnQgb24gZmlyc3QgY2FsbC4KICAgICAgICAgICAgICAgIC8vIElFIGFuZCBPcGVyYSB3aWxsIGFsbG93IHVzIHRvIHJldXNlIHRoZSBpZnJhbWVEb2Mgd2l0aG91dCByZS13cml0aW5nIHRoZSBmYWtlIEhUTUwKICAgICAgICAgICAgICAgIC8vIGRvY3VtZW50IHRvIGl0OyBXZWJLaXQgJiBGaXJlZm94IHdvbid0IGFsbG93IHJldXNpbmcgdGhlIGlmcmFtZSBkb2N1bWVudC4KICAgICAgICAgICAgICAgIGlmICghaWZyYW1lRG9jIHx8ICFpZnJhbWUuY3JlYXRlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmcmFtZURvYyA9ICggaWZyYW1lLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lLmNvbnRlbnREb2N1bWVudCApLmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIGlmcmFtZURvYy53cml0ZSgoIGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsID8gIjwhZG9jdHlwZSBodG1sPiIgOiAiIiApICsgIjxodG1sPjxib2R5PiIpOwogICAgICAgICAgICAgICAgICAgIGlmcmFtZURvYy5jbG9zZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGVsZW0gPSBpZnJhbWVEb2MuY3JlYXRlRWxlbWVudChub2RlTmFtZSk7CgogICAgICAgICAgICAgICAgaWZyYW1lRG9jLmJvZHkuYXBwZW5kQ2hpbGQoZWxlbSk7CgogICAgICAgICAgICAgICAgZGlzcGxheSA9IGpRdWVyeS5jc3MoZWxlbSwgImRpc3BsYXkiKTsKICAgICAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQoaWZyYW1lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CiAgICAgICAgICAgIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKICAgIH0KCgogICAgdmFyIGdldE9mZnNldCwKICAgICAgICBydGFibGUgPSAvXnQoPzphYmxlfGR8aCkkL2ksCiAgICAgICAgcnJvb3QgPSAvXig/OmJvZHl8aHRtbCkkL2k7CgogICAgaWYgKCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgewogICAgICAgIGdldE9mZnNldCA9IGZ1bmN0aW9uIChlbGVtLCBkb2MsIGRvY0VsZW0sIGJveCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQogICAgICAgICAgICBpZiAoIWJveCB8fCAhalF1ZXJ5LmNvbnRhaW5zKGRvY0VsZW0sIGVsZW0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYm94ID8geyB0b3A6IGJveC50b3AsIGxlZnQ6IGJveC5sZWZ0IH0gOiB7IHRvcDogMCwgbGVmdDogMCB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYm9keSA9IGRvYy5ib2R5LAogICAgICAgICAgICAgICAgd2luID0gZ2V0V2luZG93KGRvYyksCiAgICAgICAgICAgICAgICBjbGllbnRUb3AgPSBkb2NFbGVtLmNsaWVudFRvcCB8fCBib2R5LmNsaWVudFRvcCB8fCAwLAogICAgICAgICAgICAgICAgY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMCwKICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IHdpbi5wYWdlWU9mZnNldCB8fCBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCAmJiBkb2NFbGVtLnNjcm9sbFRvcCB8fCBib2R5LnNjcm9sbFRvcCwKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgPSB3aW4ucGFnZVhPZmZzZXQgfHwgalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgZG9jRWxlbS5zY3JvbGxMZWZ0IHx8IGJvZHkuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgICAgIHRvcCA9IGJveC50b3AgKyBzY3JvbGxUb3AgLSBjbGllbnRUb3AsCiAgICAgICAgICAgICAgICBsZWZ0ID0gYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdDsKCiAgICAgICAgICAgIHJldHVybiB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH07CiAgICAgICAgfTsKCiAgICB9IGVsc2UgewogICAgICAgIGdldE9mZnNldCA9IGZ1bmN0aW9uIChlbGVtLCBkb2MsIGRvY0VsZW0pIHsKICAgICAgICAgICAgdmFyIGNvbXB1dGVkU3R5bGUsCiAgICAgICAgICAgICAgICBvZmZzZXRQYXJlbnQgPSBlbGVtLm9mZnNldFBhcmVudCwKICAgICAgICAgICAgICAgIHByZXZPZmZzZXRQYXJlbnQgPSBlbGVtLAogICAgICAgICAgICAgICAgYm9keSA9IGRvYy5ib2R5LAogICAgICAgICAgICAgICAgZGVmYXVsdFZpZXcgPSBkb2MuZGVmYXVsdFZpZXcsCiAgICAgICAgICAgICAgICBwcmV2Q29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKSA6IGVsZW0uY3VycmVudFN0eWxlLAogICAgICAgICAgICAgICAgdG9wID0gZWxlbS5vZmZzZXRUb3AsCiAgICAgICAgICAgICAgICBsZWZ0ID0gZWxlbS5vZmZzZXRMZWZ0OwoKICAgICAgICAgICAgd2hpbGUgKChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtICE9PSBib2R5ICYmIGVsZW0gIT09IGRvY0VsZW0pIHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuc3VwcG9ydC5maXhlZFBvc2l0aW9uICYmIHByZXZDb21wdXRlZFN0eWxlLnBvc2l0aW9uID09PSAiZml4ZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKSA6IGVsZW0uY3VycmVudFN0eWxlOwogICAgICAgICAgICAgICAgdG9wIC09IGVsZW0uc2Nyb2xsVG9wOwogICAgICAgICAgICAgICAgbGVmdCAtPSBlbGVtLnNjcm9sbExlZnQ7CgogICAgICAgICAgICAgICAgaWYgKGVsZW0gPT09IG9mZnNldFBhcmVudCkgewogICAgICAgICAgICAgICAgICAgIHRvcCArPSBlbGVtLm9mZnNldFRvcDsKICAgICAgICAgICAgICAgICAgICBsZWZ0ICs9IGVsZW0ub2Zmc2V0TGVmdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5zdXBwb3J0LmRvZXNOb3RBZGRCb3JkZXIgJiYgIShqUXVlcnkuc3VwcG9ydC5kb2VzQWRkQm9yZGVyRm9yVGFibGVBbmRDZWxscyAmJiBydGFibGUudGVzdChlbGVtLm5vZGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9wICs9IHBhcnNlRmxvYXQoY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdCArPSBwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUuYm9yZGVyTGVmdFdpZHRoKSB8fCAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcHJldk9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudDsKICAgICAgICAgICAgICAgICAgICBvZmZzZXRQYXJlbnQgPSBlbGVtLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuc3VidHJhY3RzQm9yZGVyRm9yT3ZlcmZsb3dOb3RWaXNpYmxlICYmIGNvbXB1dGVkU3R5bGUub3ZlcmZsb3cgIT09ICJ2aXNpYmxlIikgewogICAgICAgICAgICAgICAgICAgIHRvcCArPSBwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUuYm9yZGVyVG9wV2lkdGgpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgbGVmdCArPSBwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUuYm9yZGVyTGVmdFdpZHRoKSB8fCAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHByZXZDb21wdXRlZFN0eWxlID0gY29tcHV0ZWRTdHlsZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHByZXZDb21wdXRlZFN0eWxlLnBvc2l0aW9uID09PSAicmVsYXRpdmUiIHx8IHByZXZDb21wdXRlZFN0eWxlLnBvc2l0aW9uID09PSAic3RhdGljIikgewogICAgICAgICAgICAgICAgdG9wICs9IGJvZHkub2Zmc2V0VG9wOwogICAgICAgICAgICAgICAgbGVmdCArPSBib2R5Lm9mZnNldExlZnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChqUXVlcnkuc3VwcG9ydC5maXhlZFBvc2l0aW9uICYmIHByZXZDb21wdXRlZFN0eWxlLnBvc2l0aW9uID09PSAiZml4ZWQiKSB7CiAgICAgICAgICAgICAgICB0b3AgKz0gTWF0aC5tYXgoZG9jRWxlbS5zY3JvbGxUb3AsIGJvZHkuc2Nyb2xsVG9wKTsKICAgICAgICAgICAgICAgIGxlZnQgKz0gTWF0aC5tYXgoZG9jRWxlbS5zY3JvbGxMZWZ0LCBib2R5LnNjcm9sbExlZnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4geyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9OwogICAgICAgIH07CiAgICB9CgogICAgalF1ZXJ5LmZuLm9mZnNldCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgICAgICAgICB0aGlzIDoKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIG9wdGlvbnMsIGkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgICAgIGRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwoKICAgICAgICBpZiAoIWRvYykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChlbGVtID09PSBkb2MuYm9keSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm9mZnNldC5ib2R5T2Zmc2V0KGVsZW0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldE9mZnNldChlbGVtLCBkb2MsIGRvYy5kb2N1bWVudEVsZW1lbnQpOwogICAgfTsKCiAgICBqUXVlcnkub2Zmc2V0ID0gewoKICAgICAgICBib2R5T2Zmc2V0OiBmdW5jdGlvbiAoYm9keSkgewogICAgICAgICAgICB2YXIgdG9wID0gYm9keS5vZmZzZXRUb3AsCiAgICAgICAgICAgICAgICBsZWZ0ID0gYm9keS5vZmZzZXRMZWZ0OwoKICAgICAgICAgICAgaWYgKGpRdWVyeS5zdXBwb3J0LmRvZXNOb3RJbmNsdWRlTWFyZ2luSW5Cb2R5T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICB0b3AgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGJvZHksICJtYXJnaW5Ub3AiKSkgfHwgMDsKICAgICAgICAgICAgICAgIGxlZnQgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKGJvZHksICJtYXJnaW5MZWZ0IikpIHx8IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH07CiAgICAgICAgfSwKCiAgICAgICAgc2V0T2Zmc2V0OiBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgaSkgewogICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICJwb3NpdGlvbiIpOwoKICAgICAgICAgICAgLy8gc2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQogICAgICAgICAgICBpZiAocG9zaXRpb24gPT09ICJzdGF0aWMiKSB7CiAgICAgICAgICAgICAgICBlbGVtLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGN1ckVsZW0gPSBqUXVlcnkoZWxlbSksCiAgICAgICAgICAgICAgICBjdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpLAogICAgICAgICAgICAgICAgY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyhlbGVtLCAidG9wIiksCiAgICAgICAgICAgICAgICBjdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyhlbGVtLCAibGVmdCIpLAogICAgICAgICAgICAgICAgY2FsY3VsYXRlUG9zaXRpb24gPSAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgJiYgalF1ZXJ5LmluQXJyYXkoImF1dG8iLCBbY3VyQ1NTVG9wLCBjdXJDU1NMZWZ0XSkgPiAtMSwKICAgICAgICAgICAgICAgIHByb3BzID0ge30sIGN1clBvc2l0aW9uID0ge30sIGN1clRvcCwgY3VyTGVmdDsKCiAgICAgICAgICAgIC8vIG5lZWQgdG8gYmUgYWJsZSB0byBjYWxjdWxhdGUgcG9zaXRpb24gaWYgZWl0aGVyIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAogICAgICAgICAgICBpZiAoY2FsY3VsYXRlUG9zaXRpb24pIHsKICAgICAgICAgICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgICAgICAgICAgY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwogICAgICAgICAgICAgICAgY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICAgICAgICAgIGN1ckxlZnQgPSBwYXJzZUZsb2F0KGN1ckNTU0xlZnQpIHx8IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuY2FsbChlbGVtLCBpLCBjdXJPZmZzZXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHByb3BzLmxlZnQgPSAoIG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICkgKyBjdXJMZWZ0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoInVzaW5nIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VyRWxlbS5jc3MocHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CgogICAgICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpc1swXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbGVtID0gdGhpc1swXSwKCiAgICAgICAgICAgIC8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50CiAgICAgICAgICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAoKICAgICAgICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gdGhpcy5vZmZzZXQoKSwKICAgICAgICAgICAgICAgIHBhcmVudE9mZnNldCA9IHJyb290LnRlc3Qob2Zmc2V0UGFyZW50WzBdLm5vZGVOYW1lKSA/IHsgdG9wOiAwLCBsZWZ0OiAwIH0gOiBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CgogICAgICAgICAgICAvLyBTdWJ0cmFjdCBlbGVtZW50IG1hcmdpbnMKICAgICAgICAgICAgLy8gbm90ZTogd2hlbiBhbiBlbGVtZW50IGhhcyBtYXJnaW46IGF1dG8gdGhlIG9mZnNldExlZnQgYW5kIG1hcmdpbkxlZnQKICAgICAgICAgICAgLy8gYXJlIHRoZSBzYW1lIGluIFNhZmFyaSBjYXVzaW5nIG9mZnNldC5sZWZ0IHRvIGluY29ycmVjdGx5IGJlIDAKICAgICAgICAgICAgb2Zmc2V0LnRvcCAtPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpblRvcCIpKSB8fCAwOwogICAgICAgICAgICBvZmZzZXQubGVmdCAtPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpbkxlZnQiKSkgfHwgMDsKCiAgICAgICAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICAgICAgICBwYXJlbnRPZmZzZXQudG9wICs9IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJUb3BXaWR0aCIpKSB8fCAwOwogICAgICAgICAgICBwYXJlbnRPZmZzZXQubGVmdCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAiYm9yZGVyTGVmdFdpZHRoIikpIHx8IDA7CgogICAgICAgICAgICAvLyBTdWJ0cmFjdCB0aGUgdHdvIG9mZnNldHMKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHRvcDogb2Zmc2V0LnRvcCAtIHBhcmVudE9mZnNldC50b3AsCiAgICAgICAgICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgKCFycm9vdC50ZXN0KG9mZnNldFBhcmVudC5ub2RlTmFtZSkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikpIHsKICAgICAgICAgICAgICAgICAgICBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldFBhcmVudDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCiAgICBqUXVlcnkuZWFjaCh7c2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQifSwgZnVuY3Rpb24gKG1ldGhvZCwgcHJvcCkgewogICAgICAgIHZhciB0b3AgPSAvWS8udGVzdChwcm9wKTsKCiAgICAgICAgalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG1ldGhvZCwgdmFsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2luID0gZ2V0V2luZG93KGVsZW0pOwoKICAgICAgICAgICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW4gPyAocHJvcCBpbiB3aW4pID8gd2luWyBwcm9wIF0gOgogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCAmJiB3aW4uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyBtZXRob2QgXSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luLmRvY3VtZW50LmJvZHlbIG1ldGhvZCBdIDoKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgbWV0aG9kIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHdpbikgewogICAgICAgICAgICAgICAgICAgIHdpbi5zY3JvbGxUbygKICAgICAgICAgICAgICAgICAgICAgICAgIXRvcCA/IHZhbCA6IGpRdWVyeSh3aW4pLnNjcm9sbExlZnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wID8gdmFsIDogalF1ZXJ5KHdpbikuc2Nyb2xsVG9wKCkKICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbVsgbWV0aG9kIF0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsKTsKICAgICAgICB9OwogICAgfSk7CgogICAgZnVuY3Rpb24gZ2V0V2luZG93KGVsZW0pIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmlzV2luZG93KGVsZW0pID8KICAgICAgICAgICAgZWxlbSA6CiAgICAgICAgICAgIGVsZW0ubm9kZVR5cGUgPT09IDkgPwogICAgICAgICAgICAgICAgZWxlbS5kZWZhdWx0VmlldyB8fCBlbGVtLnBhcmVudFdpbmRvdyA6CiAgICAgICAgICAgICAgICBmYWxzZTsKICAgIH0KCgovLyBDcmVhdGUgd2lkdGgsIGhlaWdodCwgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKICAgIGpRdWVyeS5lYWNoKHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICB2YXIgY2xpZW50UHJvcCA9ICJjbGllbnQiICsgbmFtZSwKICAgICAgICAgICAgc2Nyb2xsUHJvcCA9ICJzY3JvbGwiICsgbmFtZSwKICAgICAgICAgICAgb2Zmc2V0UHJvcCA9ICJvZmZzZXQiICsgbmFtZTsKCiAgICAgICAgLy8gaW5uZXJIZWlnaHQgYW5kIGlubmVyV2lkdGgKICAgICAgICBqUXVlcnkuZm5bICJpbm5lciIgKyBuYW1lIF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbGVtID0gdGhpc1swXTsKICAgICAgICAgICAgcmV0dXJuIGVsZW0gPwogICAgICAgICAgICAgICAgZWxlbS5zdHlsZSA/CiAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIHR5cGUsICJwYWRkaW5nIikpIDoKICAgICAgICAgICAgICAgICAgICB0aGlzWyB0eXBlIF0oKSA6CiAgICAgICAgICAgICAgICBudWxsOwogICAgICAgIH07CgogICAgICAgIC8vIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoCiAgICAgICAgalF1ZXJ5LmZuWyAib3V0ZXIiICsgbmFtZSBdID0gZnVuY3Rpb24gKG1hcmdpbikgewogICAgICAgICAgICB2YXIgZWxlbSA9IHRoaXNbMF07CiAgICAgICAgICAgIHJldHVybiBlbGVtID8KICAgICAgICAgICAgICAgIGVsZW0uc3R5bGUgPwogICAgICAgICAgICAgICAgICAgIHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhlbGVtLCB0eXBlLCBtYXJnaW4gPyAibWFyZ2luIiA6ICJib3JkZXIiKSkgOgogICAgICAgICAgICAgICAgICAgIHRoaXNbIHR5cGUgXSgpIDoKICAgICAgICAgICAgICAgIG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgZG9jLCBkb2NFbGVtUHJvcCwgb3JpZywgcmV0OwoKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyAzcmQgY29uZGl0aW9uIGFsbG93cyBOb2tpYSBzdXBwb3J0LCBhcyBpdCBzdXBwb3J0cyB0aGUgZG9jRWxlbSBwcm9wIGJ1dCBub3QgQ1NTMUNvbXBhdAogICAgICAgICAgICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgZG9jRWxlbVByb3AgPSBkb2MuZG9jdW1lbnRFbGVtZW50WyBjbGllbnRQcm9wIF07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsICYmIGRvY0VsZW1Qcm9wIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5ib2R5ICYmIGRvYy5ib2R5WyBjbGllbnRQcm9wIF0gfHwgZG9jRWxlbVByb3A7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0sIHdoaWNoZXZlciBpcyBncmVhdGVyCiAgICAgICAgICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CgogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gYSB3aW5kb3cgPiBkb2N1bWVudCwgSUU2IHJlcG9ydHMgYSBvZmZzZXRbV2lkdGgvSGVpZ2h0XSA+IGNsaWVudFtXaWR0aC9IZWlnaHRdCiAgICAgICAgICAgICAgICAgICAgLy8gc28gd2UgY2FuJ3QgdXNlIG1heCwgYXMgaXQnbGwgY2hvb3NlIHRoZSBpbmNvcnJlY3Qgb2Zmc2V0W1dpZHRoL0hlaWdodF0KICAgICAgICAgICAgICAgICAgICAvLyBpbnN0ZWFkIHdlIHVzZSB0aGUgY29ycmVjdCBjbGllbnRbV2lkdGgvSGVpZ2h0XQogICAgICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQ6SUU2CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY1sgY2xpZW50UHJvcCBdID49IGRvY1sgc2Nyb2xsUHJvcCBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2NbIGNsaWVudFByb3AgXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5ib2R5WyBzY3JvbGxQcm9wIF0sIGRvY1sgc2Nyb2xsUHJvcCBdLAogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmJvZHlbIG9mZnNldFByb3AgXSwgZG9jWyBvZmZzZXRQcm9wIF0KICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgb3JpZyA9IGpRdWVyeS5jc3MoZWxlbSwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0ID0gcGFyc2VGbG9hdChvcmlnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LmlzTnVtZXJpYyhyZXQpID8gcmV0IDogb3JpZzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgalF1ZXJ5KGVsZW0pLmNzcyh0eXBlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0sIHR5cGUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsKTsKICAgICAgICB9OwogICAgfSk7CgoKLy8gRXhwb3NlIGpRdWVyeSB0byB0aGUgZ2xvYmFsIG9iamVjdAogICAgd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5OwoKLy8gRXhwb3NlIGpRdWVyeSBhcyBhbiBBTUQgbW9kdWxlLCBidXQgb25seSBmb3IgQU1EIGxvYWRlcnMgdGhhdAovLyB1bmRlcnN0YW5kIHRoZSBpc3N1ZXMgd2l0aCBsb2FkaW5nIG11bHRpcGxlIHZlcnNpb25zIG9mIGpRdWVyeQovLyBpbiBhIHBhZ2UgdGhhdCBhbGwgbWlnaHQgY2FsbCBkZWZpbmUoKS4gVGhlIGxvYWRlciB3aWxsIGluZGljYXRlCi8vIHRoZXkgaGF2ZSBzcGVjaWFsIGFsbG93YW5jZXMgZm9yIG11bHRpcGxlIGpRdWVyeSB2ZXJzaW9ucyBieQovLyBzcGVjaWZ5aW5nIGRlZmluZS5hbWQualF1ZXJ5ID0gdHJ1ZS4gUmVnaXN0ZXIgYXMgYSBuYW1lZCBtb2R1bGUsCi8vIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIgZmlsZXMgdGhhdCBtYXkgdXNlIGRlZmluZSwKLy8gYnV0IG5vdCB1c2UgYSBwcm9wZXIgY29uY2F0ZW5hdGlvbiBzY3JpcHQgdGhhdCB1bmRlcnN0YW5kcyBhbm9ueW1vdXMKLy8gQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3Qgd2F5IHRvIHJlZ2lzdGVyLgovLyBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZSBkZXJpdmVkIGZyb20KLy8gZmlsZSBuYW1lcywgYW5kIGpRdWVyeSBpcyBub3JtYWxseSBkZWxpdmVyZWQgaW4gYSBsb3dlcmNhc2UgZmlsZSBuYW1lLgovLyBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzIHRvIGNhbGwKLy8gbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgJiYgZGVmaW5lLmFtZC5qUXVlcnkpIHsKICAgICAgICBkZWZpbmUoImpxdWVyeSIsIFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnk7CiAgICAgICAgfSk7CiAgICB9CgoKfSkod2luZG93KTsKCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMC43CiAqIChjKSAyMDEwLTIwMTIgR29vZ2xlLCBJbmMuIGh0dHA6Ly9hbmd1bGFyanMub3JnCiAqIExpY2Vuc2U6IE1JVAogKi8KKGZ1bmN0aW9uICh3aW5kb3csIGRvY3VtZW50KSB7CiAgICB2YXIgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnkubm9Db25mbGljdCh0cnVlKTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIHRvIGJlIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBMb3dlcmNhc2VkIHN0cmluZy4KICAgICAqLwogICAgdmFyIGxvd2VyY2FzZSA9IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b0xvd2VyQ2FzZSgpIDogc3RyaW5nOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFVwcGVyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvVXBwZXJDYXNlKCkgOiBzdHJpbmc7CiAgICB9OwoKCiAgICB2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uIChjaCkgewogICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjaC5jaGFyQ29kZUF0KDApIHwgMzIpOwogICAgICAgIH0pCiAgICAgICAgICAgIDogczsKICAgIH07CiAgICB2YXIgbWFudWFsVXBwZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uIChjaCkgewogICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjaC5jaGFyQ29kZUF0KDApICYgfjMyKTsKICAgICAgICB9KQogICAgICAgICAgICA6IHM7CiAgICB9OwoKCi8vIFN0cmluZyN0b0xvd2VyQ2FzZSBhbmQgU3RyaW5nI3RvVXBwZXJDYXNlIGRvbid0IHByb2R1Y2UgY29ycmVjdCByZXN1bHRzIGluIGJyb3dzZXJzIHdpdGggVHVya2lzaAovLyBsb2NhbGUsIGZvciB0aGlzIHJlYXNvbiB3ZSBuZWVkIHRvIGRldGVjdCB0aGlzIGNhc2UgYW5kIHJlZGVmaW5lIGxvd2VyY2FzZS91cHBlcmNhc2UgbWV0aG9kcwovLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCiAgICBpZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogICAgICAgIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICAgICAgICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7CiAgICB9CgoKICAgIHZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgICAgICAgICBtc2llID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSksCiAgICAgICAganFMaXRlLCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZyBzaW5jZSBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGFmdGVyIHVzLgogICAgICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgICAgICBzbGljZSA9IFtdLnNsaWNlLAogICAgICAgIHB1c2ggPSBbXS5wdXNoLAogICAgICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKCiAgICAgICAgLyoqIEBuYW1lIGFuZ3VsYXIgKi8KICAgICAgICAgICAgYW5ndWxhciA9IHdpbmRvdy5hbmd1bGFyIHx8ICh3aW5kb3cuYW5ndWxhciA9IHt9KSwKICAgICAgICBhbmd1bGFyTW9kdWxlLAogICAgICAgIG5vZGVOYW1lXywKICAgICAgICB1aWQgPSBbJzAnLCAnMCcsICcwJ107CgoKICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqCiAgICAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgYG9iamAgaXMgYW4gYXJyYXkgb3IgYXJyYXktbGlrZSBvYmplY3QgKE5vZGVMaXN0LCBBcmd1bWVudHMsIC4uLikKICAgICAqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2Uob2JqKSB7CiAgICAgICAgaWYgKCFvYmogfHwgKHR5cGVvZiBvYmoubGVuZ3RoICE9PSAnbnVtYmVyJykpIHJldHVybiBmYWxzZTsKCiAgICAgICAgLy8gV2UgaGF2ZSBvbiBvYmplY3Qgd2hpY2ggaGFzIGxlbmd0aCBwcm9wZXJ0eS4gU2hvdWxkIHdlIHRyZWF0IGl0IGFzIGFycmF5PwogICAgICAgIGlmICh0eXBlb2Ygb2JqLmhhc093blByb3BlcnR5ICE9ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgdHlwZW9mIG9iai5jb25zdHJ1Y3RvciAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgaGVyZSBmb3IgSUU4OiBpdCBpcyBhIGJvZ3VzIG9iamVjdCB0cmVhdCBpdCBhcyBhcnJheTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEpRTGl0ZSB8fCAgICAgICAgICAgICAgICAgICAgICAvLyBKUUxpdGUKICAgICAgICAgICAgICAgIChqUXVlcnkgJiYgb2JqIGluc3RhbmNlb2YgalF1ZXJ5KSB8fCAgICAgICAgICAvLyBqUXVlcnkKICAgICAgICAgICAgICAgIHRvU3RyaW5nLmNhbGwob2JqKSAhPT0gJ1tvYmplY3QgT2JqZWN0XScgfHwgICAvLyBzb21lIGJyb3dzZXIgbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgdHlwZW9mIG9iai5jYWxsZWUgPT09ICdmdW5jdGlvbic7ICAgICAgICAgICAgICAvLyBhcmd1bWVudHMgKG9uIElFOCBsb29rcyBsaWtlIHJlZ3VsYXIgb2JqKQogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnZva2VzIHRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggaXRlbSBpbiBgb2JqYCBjb2xsZWN0aW9uLCB3aGljaCBjYW4gYmUgZWl0aGVyIGFuCiAgICAgKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSlgLCB3aGVyZSBgdmFsdWVgCiAgICAgKiBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkga2V5IG9yCiAgICAgKiBhcnJheSBlbGVtZW50IGluZGV4LiBTcGVjaWZ5aW5nIGEgYGNvbnRleHRgIGZvciB0aGUgZnVuY3Rpb24gaXMgb3B0aW9uYWwuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiB3YXMgcHJldmlvdXNseSBrbm93biBhcyBgYW5ndWxhci5mb3JlYWNoYC4KICAgICAqCiAgICAgPHByZT4KICAgICB2YXIgdmFsdWVzID0ge25hbWU6ICdtaXNrbycsIGdlbmRlcjogJ21hbGUnfTsKICAgICB2YXIgbG9nID0gW107CiAgICAgYW5ndWxhci5mb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICB9LCBsb2cpOwogICAgIGV4cGVjdChsb2cpLnRvRXF1YWwoWyduYW1lOiBtaXNrbycsICdnZW5kZXI6bWFsZSddKTsKICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRvciBJdGVyYXRvciBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29udGV4dCBPYmplY3QgdG8gYmVjb21lIGNvbnRleHQgKGB0aGlzYCkgZm9yIHRoZSBpdGVyYXRvciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl9IFJlZmVyZW5jZSB0byBgb2JqYC4KICAgICAqLwogICAgZnVuY3Rpb24gZm9yRWFjaChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGtleTsKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gJ3Byb3RvdHlwZScgJiYga2V5ICE9ICdsZW5ndGgnICYmIGtleSAhPSAnbmFtZScgJiYgb2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLmZvckVhY2ggJiYgb2JqLmZvckVhY2ggIT09IGZvckVhY2gpIHsKICAgICAgICAgICAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShvYmopKSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSA9IDA7IGtleSA8IG9iai5sZW5ndGg7IGtleSsrKQogICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICBmdW5jdGlvbiBzb3J0ZWRLZXlzKG9iaikgewogICAgICAgIHZhciBrZXlzID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzLnNvcnQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmb3JFYWNoU29ydGVkKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5cyA9IHNvcnRlZEtleXMob2JqKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4ga2V5czsKICAgIH0KCgogICAgLyoqCiAgICAgKiB3aGVuIHVzaW5nIGZvckVhY2ggdGhlIHBhcmFtcyBhcmUgdmFsdWUsIGtleSwgYnV0IGl0IGlzIG9mdGVuIHVzZWZ1bCB0byBoYXZlIGtleSwgdmFsdWUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZywgKil9IGl0ZXJhdG9yRm4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigqLCBzdHJpbmcpfQogICAgICovCiAgICBmdW5jdGlvbiByZXZlcnNlUGFyYW1zKGl0ZXJhdG9yRm4pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgaXRlcmF0b3JGbihrZXksIHZhbHVlKQogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogICAgICogY2hhcmFjdGVycyBzdWNoIGFzICcwMTJBQkMnLiBUaGUgcmVhc29uIHdoeSB3ZSBhcmUgbm90IHVzaW5nIHNpbXBseSBhIG51bWJlciBjb3VudGVyIGlzIHRoYXQKICAgICAqIHRoZSBudW1iZXIgc3RyaW5nIGdldHMgbG9uZ2VyIG92ZXIgdGltZSwgYW5kIGl0IGNhbiBhbHNvIG92ZXJmbG93LCB3aGVyZSBhcyB0aGUgbmV4dElkCiAgICAgKiB3aWxsIGdyb3cgbXVjaCBzbG93ZXIsIGl0IGlzIGEgc3RyaW5nLCBhbmQgaXQgd2lsbCBuZXZlciBvdmVyZmxvdy4KICAgICAqCiAgICAgKiBAcmV0dXJucyBhbiB1bmlxdWUgYWxwaGEtbnVtZXJpYyBzdHJpbmcKICAgICAqLwogICAgZnVuY3Rpb24gbmV4dFVpZCgpIHsKICAgICAgICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogICAgICAgIHZhciBkaWdpdDsKCiAgICAgICAgd2hpbGUgKGluZGV4KSB7CiAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgIGRpZ2l0ID0gdWlkW2luZGV4XS5jaGFyQ29kZUF0KDApOwogICAgICAgICAgICBpZiAoZGlnaXQgPT0gNTcgLyonOScqLykgewogICAgICAgICAgICAgICAgdWlkW2luZGV4XSA9ICdBJzsKICAgICAgICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZ2l0ID09IDkwICAvKidaJyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdWlkW2luZGV4XSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGlnaXQgKyAxKTsKICAgICAgICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdWlkLnVuc2hpZnQoJzAnKTsKICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgfQoKCiAgICAvKioKICAgICAqIFNldCBvciBjbGVhciB0aGUgaGFzaGtleSBmb3IgYW4gb2JqZWN0LgogICAgICogQHBhcmFtIG9iaiBvYmplY3QKICAgICAqIEBwYXJhbSBoIHRoZSBoYXNoa2V5ICghdHJ1dGh5IHRvIGRlbGV0ZSB0aGUgaGFzaGtleSkKICAgICAqLwogICAgZnVuY3Rpb24gc2V0SGFzaEtleShvYmosIGgpIHsKICAgICAgICBpZiAoaCkgewogICAgICAgICAgICBvYmouJCRoYXNoS2V5ID0gaDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGRlbGV0ZSBvYmouJCRoYXNoS2V5OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5leHRlbmQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXh0ZW5kcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGBkc3RgIGJ5IGNvcHlpbmcgYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGBzcmNgIG9iamVjdChzKQogICAgICogdG8gYGRzdGAuIFlvdSBjYW4gc3BlY2lmeSBtdWx0aXBsZSBgc3JjYCBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkc3QgRGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IHNyYyBTb3VyY2Ugb2JqZWN0KHMpLgogICAgICogQHJldHVybnMge09iamVjdH0gUmVmZXJlbmNlIHRvIGBkc3RgLgogICAgICovCiAgICBmdW5jdGlvbiBleHRlbmQoZHN0KSB7CiAgICAgICAgdmFyIGggPSBkc3QuJCRoYXNoS2V5OwogICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogIT09IGRzdCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNldEhhc2hLZXkoZHN0LCBoKTsKICAgICAgICByZXR1cm4gZHN0OwogICAgfQoKICAgIGZ1bmN0aW9uIGludChzdHIpIHsKICAgICAgICByZXR1cm4gcGFyc2VJbnQoc3RyLCAxMCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogICAgICAgIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24gKCkgewogICAgICAgIH0sIHtwcm90b3R5cGU6IHBhcmVudH0pKSgpLCBleHRyYSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLm5vb3AKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIG5vIG9wZXJhdGlvbnMuIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiBmb28oY2FsbGJhY2spIHsKICAgICAgIHZhciByZXN1bHQgPSBjYWxjdWxhdGVSZXN1bHQoKTsKICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgfQogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkgewogICAgfQoKICAgIG5vb3AuJGluamVjdCA9IFtdOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICAqCiAgICAgPHByZT4KICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGlkZW50aXR5KSh2YWx1ZSk7CiAgICAgfTsKICAgICA8L3ByZT4KICAgICAqLwogICAgZnVuY3Rpb24gaWRlbnRpdHkoJCkgewogICAgICAgIHJldHVybiAkOwogICAgfQoKICAgIGlkZW50aXR5LiRpbmplY3QgPSBbXTsKCgogICAgZnVuY3Rpb24gdmFsdWVGbih2YWx1ZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzVW5kZWZpbmVkCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgZGVmaW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNEZWZpbmVkKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPSAndW5kZWZpbmVkJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNPYmplY3QKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhbiBgT2JqZWN0YC4gVW5saWtlIGB0eXBlb2ZgIGluIEphdmFTY3JpcHQsIGBudWxsYHMgYXJlIG5vdAogICAgICogY29uc2lkZXJlZCB0byBiZSBvYmplY3RzLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgT2JqZWN0YCBidXQgbm90IGBudWxsYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzU3RyaW5nCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgU3RyaW5nYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgU3RyaW5nYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNTdHJpbmcodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYE51bWJlcmAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYE51bWJlcmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNEYXRlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSB2YWx1ZSBpcyBhIGRhdGUuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYERhdGVgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IERhdGVdJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNBcnJheQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodmFsdWUpID09ICdbb2JqZWN0IEFycmF5XSc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBGdW5jdGlvbmAuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9iaiBPYmplY3QgdG8gY2hlY2sKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICAgICAqLwogICAgZnVuY3Rpb24gaXNXaW5kb3cob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouZG9jdW1lbnQgJiYgb2JqLmxvY2F0aW9uICYmIG9iai5hbGVydCAmJiBvYmouc2V0SW50ZXJ2YWw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouJGV2YWxBc3luYyAmJiBvYmouJHdhdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0ZpbGUob2JqKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KG9iaikgPT09ICdbb2JqZWN0IEZpbGVdJzsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnYm9vbGVhbic7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRyaW0odmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUucmVwbGFjZSgvXlxzKi8sICcnKS5yZXBsYWNlKC9ccyokLywgJycpIDogdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAgICovCiAgICBmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiBub2RlICYmCiAgICAgICAgICAgIChub2RlLm5vZGVOYW1lICAvLyB3ZSBhcmUgYSBkaXJlY3QgZWxlbWVudAogICAgICAgICAgICAgICAgfHwgKG5vZGUuYmluZCAmJiBub2RlLmZpbmQpKTsgIC8vIHdlIGhhdmUgYSBiaW5kIGFuZCBmaW5kIG1ldGhvZCBwYXJ0IG9mIGpRdWVyeSBBUEkKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSBzdHIgJ2tleTEsa2V5MiwuLi4nCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7a2V5MTp0cnVlLCBrZXkyOnRydWUsIC4uLn0KICAgICAqLwogICAgZnVuY3Rpb24gbWFrZU1hcChzdHIpIHsKICAgICAgICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCIsIiksIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKQogICAgICAgICAgICBvYmpbIGl0ZW1zW2ldIF0gPSB0cnVlOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgoKICAgIGlmIChtc2llIDwgOSkgewogICAgICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgICAgICAgICAgPyB1cHBlcmNhc2UoZWxlbWVudC5zY29wZU5hbWUgKyAnOicgKyBlbGVtZW50Lm5vZGVOYW1lKSA6IGVsZW1lbnQubm9kZU5hbWU7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50Lm5vZGVOYW1lIDogZWxlbWVudFswXS5ub2RlTmFtZTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBtYXAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CgoKICAgIC8qKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXksIHRoZSBudW1iZXIgb2YgcHJvcGVydGllcyBhbiBvYmplY3QgaGFzLCBvcgogICAgICogdGhlIGxlbmd0aCBvZiBhIHN0cmluZy4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgYW5ndWxhci5PYmplY3R9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fHN0cmluZ30gb2JqIE9iamVjdCwgYXJyYXksIG9yIHN0cmluZyB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3duUHJvcHNPbmx5PWZhbHNlXSBDb3VudCBvbmx5ICJvd24iIHByb3BlcnRpZXMgaW4gYW4gb2JqZWN0CiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgc2l6ZSBvZiBgb2JqYCBvciBgMGAgaWYgYG9iamAgaXMgbmVpdGhlciBhbiBvYmplY3Qgbm9yIGFuIGFycmF5LgogICAgICovCiAgICBmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgICAgICAgdmFyIHNpemUgPSAwLCBrZXk7CgogICAgICAgIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgICAgICAgICByZXR1cm4gb2JqLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKQogICAgICAgICAgICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNpemU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGluY2x1ZGVzKGFycmF5LCBvYmopIHsKICAgICAgICByZXR1cm4gaW5kZXhPZihhcnJheSwgb2JqKSAhPSAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICAgICAgICBpZiAoYXJyYXkuaW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2Yob2JqKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAob2JqID09PSBhcnJheVtpXSkgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBhcnJheVJlbW92ZShhcnJheSwgdmFsdWUpIHsKICAgICAgICB2YXIgaW5kZXggPSBpbmRleE9mKGFycmF5LCB2YWx1ZSk7CiAgICAgICAgaWYgKGluZGV4ID49IDApCiAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGVhZk5vZGUobm9kZSkgewogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlTmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAiT1BUSU9OIjoKICAgICAgICAgICAgICAgIGNhc2UgIlBSRSI6CiAgICAgICAgICAgICAgICBjYXNlICJUSVRMRSI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmNvcHkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIGRlZXAgY29weSBvZiBgc291cmNlYCwgd2hpY2ggc2hvdWxkIGJlIGFuIG9iamVjdCBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiAqIElmIG5vIGRlc3RpbmF0aW9uIGlzIHN1cHBsaWVkLCBhIGNvcHkgb2YgdGhlIG9iamVjdCBvciBhcnJheSBpcyBjcmVhdGVkLgogICAgICogKiBJZiBhIGRlc3RpbmF0aW9uIGlzIHByb3ZpZGVkLCBhbGwgb2YgaXRzIGVsZW1lbnRzIChmb3IgYXJyYXkpIG9yIHByb3BlcnRpZXMgKGZvciBvYmplY3RzKQogICAgICogICBhcmUgZGVsZXRlZCBhbmQgdGhlbiBhbGwgZWxlbWVudHMvcHJvcGVydGllcyBmcm9tIHRoZSBzb3VyY2UgYXJlIGNvcGllZCB0byBpdC4KICAgICAqICogSWYgIGBzb3VyY2VgIGlzIG5vdCBhbiBvYmplY3Qgb3IgYXJyYXksIGBzb3VyY2VgIGlzIHJldHVybmVkLgogICAgICoKICAgICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHNvdXJjZSBUaGUgc291cmNlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIG1ha2UgYSBjb3B5LgogICAgICogICAgICAgICAgICAgICAgICAgQ2FuIGJlIGFueSB0eXBlLCBpbmNsdWRpbmcgcHJpbWl0aXZlcywgYG51bGxgLCBhbmQgYHVuZGVmaW5lZGAuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8QXJyYXkpPX0gZGVzdGluYXRpb24gRGVzdGluYXRpb24gaW50byB3aGljaCB0aGUgc291cmNlIGlzIGNvcGllZC4gSWYKICAgICAqICAgICBwcm92aWRlZCwgbXVzdCBiZSBvZiB0aGUgc2FtZSB0eXBlIGFzIGBzb3VyY2VgLgogICAgICogQHJldHVybnMgeyp9IFRoZSBjb3B5IG9yIHVwZGF0ZWQgYGRlc3RpbmF0aW9uYCwgaWYgYGRlc3RpbmF0aW9uYCB3YXMgc3BlY2lmaWVkLgogICAgICovCiAgICBmdW5jdGlvbiBjb3B5KHNvdXJjZSwgZGVzdGluYXRpb24pIHsKICAgICAgICBpZiAoaXNXaW5kb3coc291cmNlKSB8fCBpc1Njb3BlKHNvdXJjZSkpIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IFdpbmRvdyBvciBTY29wZSIpOwogICAgICAgIGlmICghZGVzdGluYXRpb24pIHsKICAgICAgICAgICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGF0ZShzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIHt9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBFcnJvcigiQ2FuJ3QgY29weSBlcXVpdmFsZW50IG9iamVjdHMgb3IgYXJyYXlzIik7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uLnB1c2goY29weShzb3VyY2VbaV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBoID0gZGVzdGluYXRpb24uJCRoYXNoS2V5OwogICAgICAgICAgICAgICAgZm9yRWFjaChkZXN0aW5hdGlvbiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGVzdGluYXRpb25ba2V5XTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uW2tleV0gPSBjb3B5KHNvdXJjZVtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEhhc2hLZXkoZGVzdGluYXRpb24sIGgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXN0aW5hdGlvbjsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZSBhIHNoYWxsb3cgY29weSBvZiBhbiBvYmplY3QKICAgICAqLwogICAgZnVuY3Rpb24gc2hhbGxvd0NvcHkoc3JjLCBkc3QpIHsKICAgICAgICBkc3QgPSBkc3QgfHwge307CgogICAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgaWYgKHNyYy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGtleS5zdWJzdHIoMCwgMikgIT09ICckJCcpIHsKICAgICAgICAgICAgICAgIGRzdFtrZXldID0gc3JjW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmVxdWFscwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIHR3byBvYmplY3RzIG9yIHR3byB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQuIFN1cHBvcnRzIHZhbHVlIHR5cGVzLCBhcnJheXMgYW5kCiAgICAgKiBvYmplY3RzLgogICAgICoKICAgICAqIFR3byBvYmplY3RzIG9yIHZhbHVlcyBhcmUgY29uc2lkZXJlZCBlcXVpdmFsZW50IGlmIGF0IGxlYXN0IG9uZSBvZiB0aGUgZm9sbG93aW5nIGlzIHRydWU6CiAgICAgKgogICAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBhcmUgb2YgdGhlIHNhbWUgdHlwZSBhbmQgYWxsIG9mIHRoZWlyIHByb3BlcnRpZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogICAgICogKiBCb3RoIHZhbHVlcyBhcmUgTmFOLiAoSW4gSmF2YXNTY3JpcHQsIE5hTiA9PSBOYU4gPT4gZmFsc2UuIEJ1dCB3ZSBjb25zaWRlciB0d28gTmFOIGFzIGVxdWFsKQogICAgICoKICAgICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzaW9uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAgICAgKiB0aGF0IGJlZ2luIHdpdGggYCRgIGFyZSBpZ25vcmVkLgogICAgICoKICAgICAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gbzEgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYXJndW1lbnRzIGFyZSBlcXVhbC4KICAgICAqLwogICAgZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogICAgICAgIGlmIChvMSA9PT0gbzIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICAgICAgICB2YXIgdDEgPSB0eXBlb2YgbzEsIHQyID0gdHlwZW9mIG8yLCBsZW5ndGgsIGtleSwga2V5U2V0OwogICAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgICAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG8xKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0RhdGUobzIpICYmIG8xLmdldFRpbWUoKSA9PSBvMi5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1Njb3BlKG8xKSB8fCBpc1Njb3BlKG8yKSB8fCBpc1dpbmRvdyhvMSkgfHwgaXNXaW5kb3cobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAga2V5U2V0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbzEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgPT09ICckJyB8fCBpc0Z1bmN0aW9uKG8xW2tleV0pKSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAga2V5U2V0W2tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvMikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtleVNldFtrZXldICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkuY2hhckF0KDApICE9PSAnJCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8yW2tleV0gIT09IHVuZGVmaW5lZCAmJiAhaXNGdW5jdGlvbihvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbmNhdChhcnJheTEsIGFycmF5MiwgaW5kZXgpIHsKICAgICAgICByZXR1cm4gYXJyYXkxLmNvbmNhdChzbGljZS5jYWxsKGFycmF5MiwgaW5kZXgpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzbGljZUFyZ3MoYXJncywgc3RhcnRJbmRleCkgewogICAgICAgIHJldHVybiBzbGljZS5jYWxsKGFyZ3MsIHN0YXJ0SW5kZXggfHwgMCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmJpbmQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIGZ1bmN0aW9uIGBmbmAgYm91bmQgdG8gYHNlbGZgIChgc2VsZmAgYmVjb21lcyB0aGUgYHRoaXNgIGZvcgogICAgICogYGZuYCkuIFlvdSBjYW4gc3VwcGx5IG9wdGlvbmFsIGBhcmdzYCB0aGF0IGFyZSBwcmVib3VuZCB0byB0aGUgZnVuY3Rpb24uIFRoaXMgZmVhdHVyZSBpcyBhbHNvCiAgICAgKiBrbm93biBhcyBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcpLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZWxmIENvbnRleHQgd2hpY2ggYGZuYCBzaG91bGQgYmUgZXZhbHVhdGVkIGluLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBhcmd1bWVudHMgdG8gYmUgcHJlYm91bmQgdG8gdGhlIGBmbmAgZnVuY3Rpb24gY2FsbC4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBGdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBgZm5gIHdpdGggYWxsIHRoZSBzcGVjaWZpZWQgYmluZGluZ3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJpbmQoc2VsZiwgZm4pIHsKICAgICAgICB2YXIgY3VycnlBcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBzbGljZUFyZ3MoYXJndW1lbnRzLCAyKSA6IFtdOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKGZuKSAmJiAhKGZuIGluc3RhbmNlb2YgUmVnRXhwKSkgewogICAgICAgICAgICByZXR1cm4gY3VycnlBcmdzLmxlbmd0aAogICAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgY3VycnlBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKQogICAgICAgICAgICAgICAgICAgIDogZm4uYXBwbHkoc2VsZiwgY3VycnlBcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICAgICAgaWYgKC9eXCQrLy50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIGRvY3VtZW50ID09PSB2YWx1ZSkgewogICAgICAgICAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICAgICAgICB9IGVsc2UgaWYgKGlzU2NvcGUodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckU0NPUEUnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNlcmlhbGl6ZXMgaW5wdXQgaW50byBhIEpTT04tZm9ybWF0dGVkIHN0cmluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBiZSBzZXJpYWxpemVkIGludG8gSlNPTi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHByZXR0eSBJZiBzZXQgdG8gdHJ1ZSwgdGhlIEpTT04gb3V0cHV0IHdpbGwgY29udGFpbiBuZXdsaW5lcyBhbmQgd2hpdGVzcGFjZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEpzb25pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqLCB0b0pzb25SZXBsYWNlciwgcHJldHR5ID8gJyAgJyA6IG51bGwpOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mcm9tSnNvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXNlcmlhbGl6ZXMgYSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ganNvbiBKU09OIHN0cmluZyB0byBkZXNlcmlhbGl6ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBEZXNlcmlhbGl6ZWQgdGhpbmd5LgogICAgICovCiAgICBmdW5jdGlvbiBmcm9tSnNvbihqc29uKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKGpzb24pCiAgICAgICAgICAgID8gSlNPTi5wYXJzZShqc29uKQogICAgICAgICAgICA6IGpzb247CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRvQm9vbGVhbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgdmFyIHYgPSBsb3dlcmNhc2UoIiIgKyB2YWx1ZSk7CiAgICAgICAgICAgIHZhbHVlID0gISh2ID09ICdmJyB8fCB2ID09ICcwJyB8fCB2ID09ICdmYWxzZScgfHwgdiA9PSAnbm8nIHx8IHYgPT0gJ24nIHx8IHYgPT0gJ1tdJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlbGVtZW50LgogICAgICovCiAgICBmdW5jdGlvbiBzdGFydGluZ1RhZyhlbGVtZW50KSB7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KS5jbG9uZSgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIHR1cm5zIG91dCBJRSBkb2VzIG5vdCBsZXQgeW91IHNldCAuaHRtbCgpIG9uIGVsZW1lbnRzIHdoaWNoCiAgICAgICAgICAgIC8vIGFyZSBub3QgYWxsb3dlZCB0byBoYXZlIGNoaWxkcmVuLiBTbyB3ZSBqdXN0IGlnbm9yZSBpdC4KICAgICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICAgIC8vIEFzIFBlciBET00gU3RhbmRhcmRzCiAgICAgICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICAgICAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgICAgICAgICAgZWxlbUh0bWwuCiAgICAgICAgICAgICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9ePChbXHdcLV0rKS8sIGZ1bmN0aW9uIChtYXRjaCwgbm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8JyArIGxvd2VyY2FzZShub2RlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbG93ZXJjYXNlKGVsZW1IdG1sKTsKICAgICAgICB9CgogICAgfQoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIFBhcnNlcyBhbiBlc2NhcGVkIHVybCBxdWVyeSBzdHJpbmcgaW50byBrZXktdmFsdWUgcGFpcnMuCiAgICAgKiBAcmV0dXJucyBPYmplY3QuPChzdHJpbmd8Ym9vbGVhbik+CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnNlS2V5VmFsdWUoLyoqc3RyaW5nKi9rZXlWYWx1ZSkgewogICAgICAgIHZhciBvYmogPSB7fSwga2V5X3ZhbHVlLCBrZXk7CiAgICAgICAgZm9yRWFjaCgoa2V5VmFsdWUgfHwgIiIpLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChrZXlWYWx1ZSkgewogICAgICAgICAgICBpZiAoa2V5VmFsdWUpIHsKICAgICAgICAgICAgICAgIGtleV92YWx1ZSA9IGtleVZhbHVlLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgICAgICBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzBdKTsKICAgICAgICAgICAgICAgIG9ialtrZXldID0gaXNEZWZpbmVkKGtleV92YWx1ZVsxXSkgPyBkZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzFdKSA6IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwogICAgfQoKCiAgICAvKioKICAgICAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZG9lc24ndCBmb2xsb3cKICAgICAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogICAgICogc2VnbWVudHM6CiAgICAgKiAgICBzZWdtZW50ICAgICAgID0gKnBjaGFyCiAgICAgKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogICAgICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogICAgICAgIHJldHVybiBlbmNvZGVVcmlRdWVyeSh2YWwsIHRydWUpLgogICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJCL2dpLCAnKycpOwogICAgfQoKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGludGVuZGVkIGZvciBlbmNvZGluZyAqa2V5KiBvciAqdmFsdWUqIHBhcnRzIG9mIHF1ZXJ5IGNvbXBvbmVudC4gV2UgbmVlZCBhIGN1c3RvbQogICAgICogbWV0aG9kIGJlY3Vhc2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgICAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAgICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICByZXBsYWNlKC8lNDAvZ2ksICdAJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUzQS9naSwgJzonKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyQy9naSwgJywnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTIwL2csIChwY3RFbmNvZGVTcGFjZXMgPyAnJTIwJyA6ICcrJykpOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0FwcAogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICAgICAqICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZX0gbmFtZSB0byBsb2FkLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byBhdXRvLWJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4gT25seQogICAgICogb25lIGRpcmVjdGl2ZSBjYW4gYmUgdXNlZCBwZXIgSFRNTCBkb2N1bWVudC4gVGhlIGRpcmVjdGl2ZQogICAgICogZGVzaWduYXRlcyB0aGUgcm9vdCBvZiB0aGUgYXBwbGljYXRpb24gYW5kIGlzIHR5cGljYWxseSBwbGFjZWQKICAgICAqIGF0IHRoZSByb290IG9mIHRoZSBwYWdlLgogICAgICoKICAgICAqIEluIHRoZSBleGFtcGxlIGJlbG93IGlmIHRoZSBgbmdBcHBgIGRpcmVjdGl2ZSB3b3VsZCBub3QgYmUgcGxhY2VkCiAgICAgKiBvbiB0aGUgYGh0bWxgIGVsZW1lbnQgdGhlbiB0aGUgZG9jdW1lbnQgd291bGQgbm90IGJlIGNvbXBpbGVkCiAgICAgKiBhbmQgdGhlIGB7eyAxKzIgfX1gIHdvdWxkIG5vdCBiZSByZXNvbHZlZCB0byBgM2AuCiAgICAgKgogICAgICogYG5nQXBwYCBpcyB0aGUgZWFzaWVzdCB3YXkgdG8gYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLgogICAgICoKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgSSBjYW4gYWRkOiAxICsgMiA9ICB7eyAxKzIgfX0KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFuZ3VsYXJJbml0KGVsZW1lbnQsIGJvb3RzdHJhcCkgewogICAgICAgIHZhciBlbGVtZW50cyA9IFtlbGVtZW50XSwKICAgICAgICAgICAgYXBwRWxlbWVudCwKICAgICAgICAgICAgbW9kdWxlLAogICAgICAgICAgICBuYW1lcyA9IFsnbmc6YXBwJywgJ25nLWFwcCcsICd4LW5nLWFwcCcsICdkYXRhLW5nLWFwcCddLAogICAgICAgICAgICBOR19BUFBfQ0xBU1NfUkVHRVhQID0gL1xzbmdbOlwtXWFwcCg6XHMqKFtcd1xkX10rKTs/KT9ccy87CgogICAgICAgIGZ1bmN0aW9uIGFwcGVuZChlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgJiYgZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGZvckVhY2gobmFtZXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIG5hbWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgYXBwZW5kKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG5hbWUpKTsKICAgICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgnOicsICdcXDonKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lICsgJ1xcOicpLCBhcHBlbmQpOwogICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgbmFtZSArICddJyksIGFwcGVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKCFhcHBFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICc7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBOR19BUFBfQ0xBU1NfUkVHRVhQLmV4ZWMoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IChtYXRjaFsyXSB8fCAnJykucmVwbGFjZSgvXHMrL2csICcsJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbiAoYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQgJiYgbmFtZXNbYXR0ci5uYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAoYXBwRWxlbWVudCkgewogICAgICAgICAgICBib290c3RyYXAoYXBwRWxlbWVudCwgbW9kdWxlID8gW21vZHVsZV0gOiBbXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmJvb3RzdHJhcAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhpcyBmdW5jdGlvbiB0byBtYW51YWxseSBzdGFydCB1cCBhbmd1bGFyIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIFNlZToge0BsaW5rIGd1aWRlL2Jvb3RzdHJhcCBCb290c3RyYXB9CiAgICAgKgogICAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IERPTSBlbGVtZW50IHdoaWNoIGlzIHRoZSByb290IG9mIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKiBAcGFyYW0ge0FycmF5PFN0cmluZ3xGdW5jdGlvbj49fSBtb2R1bGVzIGFuIGFycmF5IG9mIG1vZHVsZSBkZWNsYXJhdGlvbnMuIFNlZToge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9CiAgICAgKiBAcmV0dXJucyB7QVVUTy4kaW5qZWN0b3J9IFJldHVybnMgdGhlIG5ld2x5IGNyZWF0ZWQgaW5qZWN0b3IgZm9yIHRoaXMgYXBwLgogICAgICovCiAgICBmdW5jdGlvbiBib290c3RyYXAoZWxlbWVudCwgbW9kdWxlcykgewogICAgICAgIHZhciByZXN1bWVCb290c3RyYXBJbnRlcm5hbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKICAgICAgICAgICAgbW9kdWxlcyA9IG1vZHVsZXMgfHwgW107CiAgICAgICAgICAgIG1vZHVsZXMudW5zaGlmdChbJyRwcm92aWRlJywgZnVuY3Rpb24gKCRwcm92aWRlKSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KCduZycpOwogICAgICAgICAgICB2YXIgaW5qZWN0b3IgPSBjcmVhdGVJbmplY3Rvcihtb2R1bGVzKTsKICAgICAgICAgICAgaW5qZWN0b3IuaW52b2tlKFsnJHJvb3RTY29wZScsICckcm9vdEVsZW1lbnQnLCAnJGNvbXBpbGUnLCAnJGluamVjdG9yJywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgY29tcGlsZSwgaW5qZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoJyRpbmplY3RvcicsIGluamVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZShlbGVtZW50KShzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9XQogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm4gaW5qZWN0b3I7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIE5HX0RFRkVSX0JPT1RTVFJBUCA9IC9eTkdfREVGRVJfQk9PVFNUUkFQIS87CgogICAgICAgIGlmICh3aW5kb3cgJiYgIU5HX0RFRkVSX0JPT1RTVFJBUC50ZXN0KHdpbmRvdy5uYW1lKSkgewogICAgICAgICAgICByZXR1cm4gcmVzdW1lQm9vdHN0cmFwSW50ZXJuYWwoKTsKICAgICAgICB9CgogICAgICAgIHdpbmRvdy5uYW1lID0gd2luZG93Lm5hbWUucmVwbGFjZShOR19ERUZFUl9CT09UU1RSQVAsICcnKTsKICAgICAgICBhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCA9IGZ1bmN0aW9uIChleHRyYU1vZHVsZXMpIHsKICAgICAgICAgICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgICAgICAgICAgIG1vZHVsZXMucHVzaChtb2R1bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmVzdW1lQm9vdHN0cmFwSW50ZXJuYWwoKTsKICAgICAgICB9OwogICAgfQoKICAgIHZhciBTTkFLRV9DQVNFX1JFR0VYUCA9IC9bQS1aXS9nOwoKICAgIGZ1bmN0aW9uIHNuYWtlX2Nhc2UobmFtZSwgc2VwYXJhdG9yKSB7CiAgICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICdfJzsKICAgICAgICByZXR1cm4gbmFtZS5yZXBsYWNlKFNOQUtFX0NBU0VfUkVHRVhQLCBmdW5jdGlvbiAobGV0dGVyLCBwb3MpIHsKICAgICAgICAgICAgcmV0dXJuIChwb3MgPyBzZXBhcmF0b3IgOiAnJykgKyBsZXR0ZXIudG9Mb3dlckNhc2UoKTsKICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBiaW5kSlF1ZXJ5KCkgewogICAgICAgIC8vIGJpbmQgdG8galF1ZXJ5IGlmIHByZXNlbnQ7CiAgICAgICAgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKICAgICAgICAvLyByZXNldCB0byBqUXVlcnkgb3IgZGVmYXVsdCB0byB1cy4KICAgICAgICBpZiAoalF1ZXJ5KSB7CiAgICAgICAgICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgICAgICAgICAgZXh0ZW5kKGpRdWVyeS5mbiwgewogICAgICAgICAgICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZSwKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEpRTGl0ZVByb3RvdHlwZS5jb250cm9sbGVyLAogICAgICAgICAgICAgICAgaW5qZWN0b3I6IEpRTGl0ZVByb3RvdHlwZS5pbmplY3RvciwKICAgICAgICAgICAgICAgIGluaGVyaXRlZERhdGE6IEpRTGl0ZVByb3RvdHlwZS5pbmhlcml0ZWREYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgncmVtb3ZlJywgdHJ1ZSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdlbXB0eScpOwogICAgICAgICAgICBKUUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnaHRtbCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGpxTGl0ZSA9IEpRTGl0ZTsKICAgICAgICB9CiAgICAgICAgYW5ndWxhci5lbGVtZW50ID0ganFMaXRlOwogICAgfQoKICAgIC8qKgogICAgICogdGhyb3cgZXJyb3IgaWYgdGhlIGFyZ3VtZW50IGlzIGZhbHN5LgogICAgICovCiAgICBmdW5jdGlvbiBhc3NlcnRBcmcoYXJnLCBuYW1lLCByZWFzb24pIHsKICAgICAgICBpZiAoIWFyZykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50ICciICsgKG5hbWUgfHwgJz8nKSArICInIGlzICIgKyAocmVhc29uIHx8ICJyZXF1aXJlZCIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KCiAgICBmdW5jdGlvbiBhc3NlcnRBcmdGbihhcmcsIG5hbWUsIGFjY2VwdEFycmF5QW5ub3RhdGlvbikgewogICAgICAgIGlmIChhY2NlcHRBcnJheUFubm90YXRpb24gJiYgaXNBcnJheShhcmcpKSB7CiAgICAgICAgICAgIGFyZyA9IGFyZ1thcmcubGVuZ3RoIC0gMV07CiAgICAgICAgfQoKICAgICAgICBhc3NlcnRBcmcoaXNGdW5jdGlvbihhcmcpLCBuYW1lLCAnbm90IGEgZnVuY3Rpb24sIGdvdCAnICsKICAgICAgICAgICAgKGFyZyAmJiB0eXBlb2YgYXJnID09ICdvYmplY3QnID8gYXJnLmNvbnN0cnVjdG9yLm5hbWUgfHwgJ09iamVjdCcgOiB0eXBlb2YgYXJnKSk7CiAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnRlcmZhY2UKICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogICAgICovCgogICAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnN1cmUoZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpLCAnbW9kdWxlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvKiogQHR5cGUge09iamVjdC48c3RyaW5nLCBhbmd1bGFyLk1vZHVsZT59ICovCiAgICAgICAgICAgIHZhciBtb2R1bGVzID0ge307CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIubW9kdWxlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGUgYGFuZ3VsYXIubW9kdWxlYCBpcyBhIGdsb2JhbCBwbGFjZSBmb3IgY3JlYXRpbmcgYW5kIHJlZ2lzdGVyaW5nIEFuZ3VsYXIgbW9kdWxlcy4gQWxsCiAgICAgICAgICAgICAqIG1vZHVsZXMgKGFuZ3VsYXIgY29yZSBvciAzcmQgcGFydHkpIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbiBhcHBsaWNhdGlvbiBtdXN0IGJlCiAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQgdXNpbmcgdGhpcyBtZWNoYW5pc20uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICMgTW9kdWxlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEEgbW9kdWxlIGlzIGEgY29sbG9jYXRpb24gb2Ygc2VydmljZXMsIGRpcmVjdGl2ZXMsIGZpbHRlcnMsIGFuZCBjb25maWd1cmF0aW9uIGluZm9ybWF0aW9uLiBNb2R1bGUKICAgICAgICAgICAgICogaXMgdXNlZCB0byBjb25maWd1cmUgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgKiAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlCiAgICAgICAgICAgICAqIHZhciBteU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdteU1vZHVsZScsIFtdKTsKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogLy8gcmVnaXN0ZXIgYSBuZXcgc2VydmljZQogICAgICAgICAgICAgKiBteU1vZHVsZS52YWx1ZSgnYXBwTmFtZScsICdNeUNvb2xBcHAnKTsKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogLy8gY29uZmlndXJlIGV4aXN0aW5nIHNlcnZpY2VzIGluc2lkZSBpbml0aWFsaXphdGlvbiBibG9ja3MuCiAgICAgICAgICAgICAqIG15TW9kdWxlLmNvbmZpZyhmdW5jdGlvbigkbG9jYXRpb25Qcm92aWRlcikgewogICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgKiAgICRsb2NhdGlvblByb3ZpZGVyLmhhc2hQcmVmaXgoJyEnKTsKICAgICAqIH0pOwogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhlbiB5b3UgY2FuIGNyZWF0ZSBhbiBpbmplY3RvciBhbmQgbG9hZCB5b3VyIG1vZHVsZXMgbGlrZSB0aGlzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgKiB2YXIgaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnLCAnTXlNb2R1bGUnXSkKICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEhvd2V2ZXIgaXQncyBtb3JlIGxpa2VseSB0aGF0IHlvdSdsbCBqdXN0IHVzZQogICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfSBvcgogICAgICAgICAgICAgKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IHRvIHNpbXBsaWZ5IHRoaXMgcHJvY2VzcyBmb3IgeW91LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0geyFzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1vZHVsZSB0byBjcmVhdGUgb3IgcmV0cmlldmUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz49fSByZXF1aXJlcyBJZiBzcGVjaWZpZWQgdGhlbiBuZXcgbW9kdWxlIGlzIGJlaW5nIGNyZWF0ZWQuIElmIHVuc3BlY2lmaWVkIHRoZW4gdGhlCiAgICAgICAgICAgICAqICAgICAgICB0aGUgbW9kdWxlIGlzIGJlaW5nIHJldHJpZXZlZCBmb3IgZnVydGhlciBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBPcHRpb25hbCBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGUgbW9kdWxlLiBTYW1lIGFzCiAgICAgICAgICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnIE1vZHVsZSNjb25maWcoKX0uCiAgICAgICAgICAgICAqIEByZXR1cm5zIHttb2R1bGV9IG5ldyBtb2R1bGUgd2l0aCB0aGUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlfSBhcGkuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbW9kdWxlKG5hbWUsIHJlcXVpcmVzLCBjb25maWdGbikgewogICAgICAgICAgICAgICAgaWYgKHJlcXVpcmVzICYmIG1vZHVsZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBtb2R1bGVzW25hbWVdID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBlbnN1cmUobW9kdWxlcywgbmFtZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVxdWlyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIG1vZHVsZTogJyArIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEFycmF5LjwqPj59ICovCiAgICAgICAgICAgICAgICAgICAgdmFyIGludm9rZVF1ZXVlID0gW107CgogICAgICAgICAgICAgICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxGdW5jdGlvbj59ICovCiAgICAgICAgICAgICAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgY29uZmlnID0gaW52b2tlTGF0ZXIoJyRpbmplY3RvcicsICdpbnZva2UnKTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHthbmd1bGFyLk1vZHVsZX0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgbW9kdWxlSW5zdGFuY2UgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByaXZhdGUgc3RhdGUKICAgICAgICAgICAgICAgICAgICAgICAgX2ludm9rZVF1ZXVlOiBpbnZva2VRdWV1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgX3J1bkJsb2NrczogcnVuQmxvY2tzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNyZXF1aXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IExpc3Qgb2YgbW9kdWxlIG5hbWVzIHdoaWNoIG11c3QgYmUgbG9hZGVkIGJlZm9yZSB0aGlzIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEhvbGRzIHRoZSBsaXN0IG9mIG1vZHVsZXMgd2hpY2ggdGhlIGluamVjdG9yIHdpbGwgbG9hZCBiZWZvcmUgdGhlIGN1cnJlbnQgbW9kdWxlIGlzIGxvYWRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVzOiByZXF1aXJlcywKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBOYW1lIG9mIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNwcm92aWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyVHlwZSBDb25zdHJ1Y3Rpb24gZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNwcm92aWRlciAkcHJvdmlkZS5wcm92aWRlcigpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAncHJvdmlkZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2ZhY3RvcnkKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlckZ1bmN0aW9uIEZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjZmFjdG9yeSAkcHJvdmlkZS5mYWN0b3J5KCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZmFjdG9yeTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2ZhY3RvcnknKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3NlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBBIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3NlcnZpY2UnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3ZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsqfSBvYmplY3QgU2VydmljZSBpbnN0YW5jZSBvYmplY3QuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjdmFsdWUgJHByb3ZpZGUudmFsdWUoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3ZhbHVlJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb25zdGFudAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgY29uc3RhbnQgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBDb25zdGFudCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEJlY2F1c2UgdGhlIGNvbnN0YW50IGFyZSBmaXhlZCwgdGhleSBnZXQgYXBwbGllZCBiZWZvcmUgb3RoZXIgcHJvdmlkZSBtZXRob2RzLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQgJHByb3ZpZGUuY29uc3RhbnQoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdGFudDogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2NvbnN0YW50JywgJ3Vuc2hpZnQnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2ZpbHRlcgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRmlsdGVyIG5hbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlckZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIGZpbHRlci4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcjogaW52b2tlTGF0ZXIoJyRmaWx0ZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29udHJvbGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgQ29udHJvbGxlciBuYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyICRjb250cm9sbGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBpbnZva2VMYXRlcignJGNvbnRyb2xsZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZGlyZWN0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBkaXJlY3RpdmUgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBkaXJlY3RpdmVGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZgogICAgICAgICAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmVzLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZTogaW52b2tlTGF0ZXIoJyRjb21waWxlUHJvdmlkZXInLCAnZGlyZWN0aXZlJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb25maWcKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBvbiBtb2R1bGUgbG9hZC4gVXNlZnVsIGZvciBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBuZWVkcyB0byBiZSBwZXJmb3JtZWQgb24gbW9kdWxlIGxvYWRpbmcuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZywKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3J1bgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW5pdGlhbGl6YXRpb25GbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gYWZ0ZXIgaW5qZWN0b3IgY3JlYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgIFVzZWZ1bCBmb3IgYXBwbGljYXRpb24gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBzaG91bGQgYmUgcGVyZm9ybWVkIHdoZW4gdGhlIGluamVjdG9yIGlzIGRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICogbG9hZGluZyBhbGwgbW9kdWxlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bjogZnVuY3Rpb24gKGJsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChibG9jayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWdGbikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcoY29uZmlnRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlUXVldWVbaW5zZXJ0TWV0aG9kIHx8ICdwdXNoJ10oW3Byb3ZpZGVyLCBtZXRob2QsIGFyZ3VtZW50c10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSBhbmd1bGFyLnZlcnNpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgQW5ndWxhckpTIHZlcnNpb24uIFRoaXMgb2JqZWN0IGhhcyB0aGUKICAgICAqIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqIC0gYGZ1bGxgIOKAkyBge3N0cmluZ31gIOKAkyBGdWxsIHZlcnNpb24gc3RyaW5nLCBzdWNoIGFzICIwLjkuMTgiLgogICAgICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBNYWpvciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMCIuCiAgICAgKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICAgICAqIC0gYGRvdGAg4oCTIGB7bnVtYmVyfWAg4oCTIERvdCB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMTgiLgogICAgICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBDb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIHN1Y2ggYXMgImppZ2dsaW5nLWFybWZhdCIuCiAgICAgKi8KICAgIHZhciB2ZXJzaW9uID0gewogICAgICAgIGZ1bGw6ICcxLjAuNycsICAgIC8vIGFsbCBvZiB0aGVzZSBwbGFjZWhvbGRlciBzdHJpbmdzIHdpbGwgYmUgcmVwbGFjZWQgYnkgZ3J1bnQncwogICAgICAgIG1ham9yOiAxLCAgICAvLyBwYWNrYWdlIHRhc2sKICAgICAgICBtaW5vcjogMCwKICAgICAgICBkb3Q6IDcsCiAgICAgICAgY29kZU5hbWU6ICdtb25vY2hyb21hdGljLXJhaW5ib3cnCiAgICB9OwoKCiAgICBmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcikgewogICAgICAgIGV4dGVuZChhbmd1bGFyLCB7CiAgICAgICAgICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAgICAgICAgICdjb3B5JzogY29weSwKICAgICAgICAgICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICAgICAgICAgJ2VxdWFscyc6IGVxdWFscywKICAgICAgICAgICAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgICAgICAgICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICAgICAgICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAgICAgICAgICdub29wJzogbm9vcCwKICAgICAgICAgICAgJ2JpbmQnOiBiaW5kLAogICAgICAgICAgICAndG9Kc29uJzogdG9Kc29uLAogICAgICAgICAgICAnZnJvbUpzb24nOiBmcm9tSnNvbiwKICAgICAgICAgICAgJ2lkZW50aXR5JzogaWRlbnRpdHksCiAgICAgICAgICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgICAgICAgICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICAgICAgICAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICAgICAgICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgICAgICAgICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAgICAgICAgICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAgICAgICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAgICAgICAgICdpc0FycmF5JzogaXNBcnJheSwKICAgICAgICAgICAgJ3ZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAnaXNEYXRlJzogaXNEYXRlLAogICAgICAgICAgICAnbG93ZXJjYXNlJzogbG93ZXJjYXNlLAogICAgICAgICAgICAndXBwZXJjYXNlJzogdXBwZXJjYXNlLAogICAgICAgICAgICAnY2FsbGJhY2tzJzoge2NvdW50ZXI6IDB9CiAgICAgICAgfSk7CgogICAgICAgIGFuZ3VsYXJNb2R1bGUgPSBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScsIFtdKS5wcm92aWRlcignJGxvY2FsZScsICRMb2NhbGVQcm92aWRlcik7CiAgICAgICAgfQoKICAgICAgICBhbmd1bGFyTW9kdWxlKCduZycsIFsnbmdMb2NhbGUnXSwgWyckcHJvdmlkZScsCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nTW9kdWxlKCRwcm92aWRlKSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUoewogICAgICAgICAgICAgICAgICAgICAgICBhOiBodG1sQW5jaG9yRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dDogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRhcmVhOiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybTogZm9ybURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0OiBzY3JpcHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmQ6IG5nQmluZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdCaW5kSHRtbFVuc2FmZTogbmdCaW5kSHRtbFVuc2FmZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdCaW5kVGVtcGxhdGU6IG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NsYXNzOiBuZ0NsYXNzRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NsYXNzRXZlbjogbmdDbGFzc0V2ZW5EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NPZGQ6IG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ3NwOiBuZ0NzcERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbG9hazogbmdDbG9ha0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDb250cm9sbGVyOiBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nRm9ybTogbmdGb3JtRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0hpZGU6IG5nSGlkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdJbmNsdWRlOiBuZ0luY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSW5pdDogbmdJbml0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ05vbkJpbmRhYmxlOiBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1BsdXJhbGl6ZTogbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nUmVwZWF0OiBuZ1JlcGVhdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTaG93OiBuZ1Nob3dEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3VibWl0OiBuZ1N1Ym1pdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTdHlsZTogbmdTdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2g6IG5nU3dpdGNoRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaFdoZW46IG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2hEZWZhdWx0OiBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nT3B0aW9uczogbmdPcHRpb25zRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1ZpZXc6IG5nVmlld0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdUcmFuc2NsdWRlOiBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWw6IG5nTW9kZWxEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nTGlzdDogbmdMaXN0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NoYW5nZTogbmdDaGFuZ2VEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdSZXF1aXJlZDogcmVxdWlyZWREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmFsdWU6IG5nVmFsdWVEaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICB9KS4KICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUobmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMpLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0V2ZW50RGlyZWN0aXZlcyk7CiAgICAgICAgICAgICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbDogJEFuY2hvclNjcm9sbFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRicm93c2VyOiAkQnJvd3NlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjYWNoZUZhY3Rvcnk6ICRDYWNoZUZhY3RvcnlQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkY29udHJvbGxlcjogJENvbnRyb2xsZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkZG9jdW1lbnQ6ICREb2N1bWVudFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyOiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRmaWx0ZXI6ICRGaWx0ZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkaW50ZXJwb2xhdGU6ICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRodHRwOiAkSHR0cFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZDogJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uOiAkTG9jYXRpb25Qcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9nOiAkTG9nUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHBhcnNlOiAkUGFyc2VQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm91dGU6ICRSb3V0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZVBhcmFtczogJFJvdXRlUGFyYW1zUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRxOiAkUVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRzbmlmZmVyOiAkU25pZmZlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlOiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICR3aW5kb3c6ICRXaW5kb3dQcm92aWRlcgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICBdKTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy9KUUxpdGUKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmVsZW1lbnQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JhcHMgYSByYXcgRE9NIGVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgYXMgYSBbalF1ZXJ5XShodHRwOi8vanF1ZXJ5LmNvbSkgZWxlbWVudC4KICAgICAqIGBhbmd1bGFyLmVsZW1lbnRgIGNhbiBiZSBlaXRoZXIgYW4gYWxpYXMgZm9yIFtqUXVlcnldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkvKSBmdW5jdGlvbiwgaWYKICAgICAqIGpRdWVyeSBpcyBhdmFpbGFibGUsIG9yIGEgZnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgZWxlbWVudCBvciBzdHJpbmcgaW4gQW5ndWxhcidzIGpRdWVyeSBsaXRlCiAgICAgKiBpbXBsZW1lbnRhdGlvbiAoY29tbW9ubHkgcmVmZXJyZWQgdG8gYXMganFMaXRlKS4KICAgICAqCiAgICAgKiBSZWFsIGpRdWVyeSBhbHdheXMgdGFrZXMgcHJlY2VkZW5jZSBvdmVyIGpxTGl0ZSwgcHJvdmlkZWQgaXQgd2FzIGxvYWRlZCBiZWZvcmUgYERPTUNvbnRlbnRMb2FkZWRgCiAgICAgKiBldmVudCBmaXJlZC4KICAgICAqCiAgICAgKiBqcUxpdGUgaXMgYSB0aW55LCBBUEktY29tcGF0aWJsZSBzdWJzZXQgb2YgalF1ZXJ5IHRoYXQgYWxsb3dzCiAgICAgKiBBbmd1bGFyIHRvIG1hbmlwdWxhdGUgdGhlIERPTS4ganFMaXRlIGltcGxlbWVudHMgb25seSB0aGUgbW9zdCBjb21tb25seSBuZWVkZWQgZnVuY3Rpb25hbGl0eQogICAgICogd2l0aGluIGEgdmVyeSBzbWFsbCBmb290cHJpbnQsIHNvIG9ubHkgYSBzdWJzZXQgb2YgdGhlIGpRdWVyeSBBUEkgLSBtZXRob2RzLCBhcmd1bWVudHMgYW5kCiAgICAgKiBpbnZvY2F0aW9uIHN0eWxlcyAtIGFyZSBzdXBwb3J0ZWQuCiAgICAgKgogICAgICogTm90ZTogQWxsIGVsZW1lbnQgcmVmZXJlbmNlcyBpbiBBbmd1bGFyIGFyZSBhbHdheXMgd3JhcHBlZCB3aXRoIGpRdWVyeSBvciBqcUxpdGU7IHRoZXkgYXJlIG5ldmVyCiAgICAgKiByYXcgRE9NIHJlZmVyZW5jZXMuCiAgICAgKgogICAgICogIyMgQW5ndWxhcidzIGpRdWVyeSBsaXRlIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgbWV0aG9kczoKICAgICAqCiAgICAgKiAtIFthZGRDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWRkQ2xhc3MvKQogICAgICogLSBbYWZ0ZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FmdGVyLykKICAgICAqIC0gW2FwcGVuZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXBwZW5kLykKICAgICAqIC0gW2F0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2F0dHIvKQogICAgICogLSBbYmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICAgKiAtIFtjaGlsZHJlbigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2hpbGRyZW4vKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtjbG9uZSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2xvbmUvKQogICAgICogLSBbY29udGVudHMoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NvbnRlbnRzLykKICAgICAqIC0gW2NzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY3NzLykKICAgICAqIC0gW2RhdGEoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2RhdGEvKQogICAgICogLSBbZXEoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2VxLykKICAgICAqIC0gW2ZpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2ZpbmQvKSAtIExpbWl0ZWQgdG8gbG9va3VwcyBieSB0YWcgbmFtZQogICAgICogLSBbaGFzQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2hhc0NsYXNzLykKICAgICAqIC0gW2h0bWwoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2h0bWwvKQogICAgICogLSBbbmV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vbmV4dC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW3BhcmVudCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcGFyZW50LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbcHJlcGVuZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJlcGVuZC8pCiAgICAgKiAtIFtwcm9wKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcm9wLykKICAgICAqIC0gW3JlYWR5KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZWFkeS8pCiAgICAgKiAtIFtyZW1vdmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZS8pCiAgICAgKiAtIFtyZW1vdmVBdHRyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVBdHRyLykKICAgICAqIC0gW3JlbW92ZUNsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVDbGFzcy8pCiAgICAgKiAtIFtyZW1vdmVEYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVEYXRhLykKICAgICAqIC0gW3JlcGxhY2VXaXRoKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZXBsYWNlV2l0aC8pCiAgICAgKiAtIFt0ZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90ZXh0LykKICAgICAqIC0gW3RvZ2dsZUNsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90b2dnbGVDbGFzcy8pCiAgICAgKiAtIFt0cmlnZ2VySGFuZGxlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdHJpZ2dlckhhbmRsZXIvKSAtIERvZXNuJ3QgcGFzcyBuYXRpdmUgZXZlbnQgb2JqZWN0cyB0byBoYW5kbGVycy4KICAgICAqIC0gW3VuYmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdW5iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICAgICAqIC0gW3ZhbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdmFsLykKICAgICAqIC0gW3dyYXAoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3dyYXAvKQogICAgICoKICAgICAqICMjIEluIGFkZHRpb24gdG8gdGhlIGFib3ZlLCBBbmd1bGFyIHByb3ZpZGVzIGFkZGl0aW9uYWwgbWV0aG9kcyB0byBib3RoIGpRdWVyeSBhbmQgalF1ZXJ5IGxpdGU6CiAgICAgKgogICAgICogLSBgY29udHJvbGxlcihuYW1lKWAgLSByZXRyaWV2ZXMgdGhlIGNvbnRyb2xsZXIgb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LiBCeSBkZWZhdWx0CiAgICAgKiAgIHJldHJpZXZlcyBjb250cm9sbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlLiBJZiBgbmFtZWAgaXMgcHJvdmlkZWQgYXMKICAgICAqICAgY2FtZWxDYXNlIGRpcmVjdGl2ZSBuYW1lLCB0aGVuIHRoZSBjb250cm9sbGVyIGZvciB0aGlzIGRpcmVjdGl2ZSB3aWxsIGJlIHJldHJpZXZlZCAoZS5nLgogICAgICogICBgJ25nTW9kZWwnYCkuCiAgICAgKiAtIGBpbmplY3RvcigpYCAtIHJldHJpZXZlcyB0aGUgaW5qZWN0b3Igb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LgogICAgICogLSBgc2NvcGUoKWAgLSByZXRyaWV2ZXMgdGhlIHtAbGluayBhcGkvbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gb2YgdGhlIGN1cnJlbnQKICAgICAqICAgZWxlbWVudCBvciBpdHMgcGFyZW50LgogICAgICogLSBgaW5oZXJpdGVkRGF0YSgpYCAtIHNhbWUgYXMgYGRhdGEoKWAsIGJ1dCB3YWxrcyB1cCB0aGUgRE9NIHVudGlsIGEgdmFsdWUgaXMgZm91bmQgb3IgdGhlIHRvcAogICAgICogICBwYXJlbnQgZWxlbWVudCBpcyByZWFjaGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfERPTUVsZW1lbnR9IGVsZW1lbnQgSFRNTCBzdHJpbmcgb3IgRE9NRWxlbWVudCB0byBiZSB3cmFwcGVkIGludG8galF1ZXJ5LgogICAgICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IG9iamVjdC4KICAgICAqLwoKICAgIHZhciBqcUNhY2hlID0gSlFMaXRlLmNhY2hlID0ge30sCiAgICAgICAganFOYW1lID0gSlFMaXRlLmV4cGFuZG8gPSAnbmctJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgIGpxSWQgPSAxLAogICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcgogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKICAgICAgICB9KSwKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4gPSAod2luZG93LmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIKICAgICAgICAgICAgPyBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgICAgICA6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICBlbGVtZW50LmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CiAgICAgICAgfSk7CgogICAgZnVuY3Rpb24ganFOZXh0SWQoKSB7CiAgICAgICAgcmV0dXJuICsranFJZDsKICAgIH0KCgogICAgdmFyIFNQRUNJQUxfQ0hBUlNfUkVHRVhQID0gLyhbXDpcLVxfXSsoLikpL2c7CiAgICB2YXIgTU9aX0hBQ0tfUkVHRVhQID0gL15tb3ooW0EtWl0pLzsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIHNuYWtlX2Nhc2UgdG8gY2FtZWxDYXNlLgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuCiAgICAgICAgICAgIHJlcGxhY2UoU1BFQ0lBTF9DSEFSU19SRUdFWFAsZnVuY3Rpb24gKF8sIHNlcGFyYXRvciwgbGV0dGVyLCBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgICAgICAgICAgfSkuCiAgICAgICAgICAgIHJlcGxhY2UoTU9aX0hBQ0tfUkVHRVhQLCAnTW96JDEnKTsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBqUXVlcnkgbXV0YXRpb24gcGF0Y2gKLy8KLy8gIEluIGNvbmp1bmN0aW9uIHdpdGggYmluZEpRdWVyeSBpbnRlcmNlcHRzIGFsbCBqUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgYQovLyAkZGVzdHJveSBldmVudCBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuCi8vCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKG5hbWUsIGRpc3BhdGNoVGhpcykgewogICAgICAgIHZhciBvcmlnaW5hbEpxRm4gPSBqUXVlcnkuZm5bbmFtZV07CiAgICAgICAgb3JpZ2luYWxKcUZuID0gb3JpZ2luYWxKcUZuLiRvcmlnaW5hbCB8fCBvcmlnaW5hbEpxRm47CiAgICAgICAgcmVtb3ZlUGF0Y2guJG9yaWdpbmFsID0gb3JpZ2luYWxKcUZuOwogICAgICAgIGpRdWVyeS5mbltuYW1lXSA9IHJlbW92ZVBhdGNoOwoKICAgICAgICBmdW5jdGlvbiByZW1vdmVQYXRjaCgpIHsKICAgICAgICAgICAgdmFyIGxpc3QgPSBbdGhpc10sCiAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSBkaXNwYXRjaFRoaXMsCiAgICAgICAgICAgICAgICBzZXQsIHNldEluZGV4LCBzZXRMZW5ndGgsCiAgICAgICAgICAgICAgICBlbGVtZW50LCBjaGlsZEluZGV4LCBjaGlsZExlbmd0aCwgY2hpbGRyZW4sCiAgICAgICAgICAgICAgICBmbnMsIGV2ZW50czsKCiAgICAgICAgICAgIHdoaWxlIChsaXN0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgc2V0ID0gbGlzdC5zaGlmdCgpOwogICAgICAgICAgICAgICAgZm9yIChzZXRJbmRleCA9IDAsIHNldExlbmd0aCA9IHNldC5sZW5ndGg7IHNldEluZGV4IDwgc2V0TGVuZ3RoOyBzZXRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShzZXRbc2V0SW5kZXhdKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChjaGlsZEluZGV4ID0gMCwgY2hpbGRMZW5ndGggPSAoY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCkpLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkSW5kZXggPCBjaGlsZExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnB1c2goalF1ZXJ5KGNoaWxkcmVuW2NoaWxkSW5kZXhdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEpxRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIGZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBKUUxpdGUpKSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSAmJiBlbGVtZW50LmNoYXJBdCgwKSAhPSAnPCcpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdzZWxlY3RvcnMgbm90IGltcGxlbWVudGVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBKUUxpdGUoZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAvLyBSZWFkIGFib3V0IHRoZSBOb1Njb3BlIGVsZW1lbnRzIGhlcmU6CiAgICAgICAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzMzg5NyhWUy44NSkuYXNweAogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxkaXY+JiMxNjA7PC9kaXY+JyArIGVsZW1lbnQ7IC8vIElFIGluc2FuaXR5IHRvIG1ha2UgTm9TY29wZSBlbGVtZW50cyB3b3JrIQogICAgICAgICAgICBkaXYucmVtb3ZlQ2hpbGQoZGl2LmZpcnN0Q2hpbGQpOyAvLyByZW1vdmUgdGhlIHN1cGVyZmx1b3VzIGRpdgogICAgICAgICAgICBKUUxpdGVBZGROb2Rlcyh0aGlzLCBkaXYuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKCk7IC8vIGRldGFjaCB0aGUgZWxlbWVudHMgZnJvbSB0aGUgdGVtcG9yYXJ5IERPTSBkaXYuCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModGhpcywgZWxlbWVudCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUNsb25lKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlRGVhbG9jKGVsZW1lbnQpIHsKICAgICAgICBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhjaGlsZHJlbltpXSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVVuYmluZChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICBoYW5kbGUgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgICAgICBpZiAoIWhhbmRsZSkgcmV0dXJuOyAvL25vIGxpc3RlbmVycyByZWdpc3RlcmVkCgogICAgICAgIGlmIChpc1VuZGVmaW5lZCh0eXBlKSkgewogICAgICAgICAgICBmb3JFYWNoKGV2ZW50cywgZnVuY3Rpb24gKGV2ZW50SGFuZGxlciwgdHlwZSkgewogICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50SGFuZGxlcik7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRzW3R5cGVdKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShldmVudHNbdHlwZV0sIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpIHsKICAgICAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgICAgIGlmIChleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICBKUUxpdGVVbmJpbmQoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRhID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgICAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAgICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgICAgICBpZiAoIWRhdGEgJiYgIWlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGtleURlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gKCgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgICAgICAgIGluZGV4T2YoIiAiICsgc2VsZWN0b3IgKyAiICIpID4gLTEpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oCiAgICAgICAgICAgICAgICAgICAgKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKQogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIikKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoIiAiICsgdHJpbShjc3NDbGFzcykgKyAiICIsICIgIikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVBZGRDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgICAgICAgaWYgKGNzc0NsYXNzZXMpIHsKICAgICAgICAgICAgZm9yRWFjaChjc3NDbGFzc2VzLnNwbGl0KCcgJyksIGZ1bmN0aW9uIChjc3NDbGFzcykgewogICAgICAgICAgICAgICAgaWYgKCFKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBjc3NDbGFzcykpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKyB0cmltKGNzc0NsYXNzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVBZGROb2Rlcyhyb290LCBlbGVtZW50cykgewogICAgICAgIGlmIChlbGVtZW50cykgewogICAgICAgICAgICBlbGVtZW50cyA9ICghZWxlbWVudHMubm9kZU5hbWUgJiYgaXNEZWZpbmVkKGVsZW1lbnRzLmxlbmd0aCkgJiYgIWlzV2luZG93KGVsZW1lbnRzKSkKICAgICAgICAgICAgICAgID8gZWxlbWVudHMKICAgICAgICAgICAgICAgIDogWyBlbGVtZW50cyBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUNvbnRyb2xsZXIoZWxlbWVudCwgbmFtZSkgewogICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgICAgIGlmIChlbGVtZW50WzBdLm5vZGVUeXBlID09IDkpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQuZmluZCgnaHRtbCcpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9IGVsZW1lbnQuZGF0YShuYW1lKSkgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICB2YXIgSlFMaXRlUHJvdG90eXBlID0gSlFMaXRlLnByb3RvdHlwZSA9IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHZhciBmaXJlZCA9IGZhbHNlOwoKICAgICAgICAgICAgZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgICAgICAgICAgIGlmIChmaXJlZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iaW5kKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7IC8vIHdvcmtzIGZvciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFOQogICAgICAgICAgICAvLyB3ZSBjYW4gbm90IHVzZSBqcUxpdGUgc2luY2Ugd2UgYXJlIG5vdCBkb25lIGxvYWRpbmcgYW5kIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgbGF0ZXIuCiAgICAgICAgICAgIEpRTGl0ZSh3aW5kb3cpLmJpbmQoJ2xvYWQnLCB0cmlnZ2VyKTsgLy8gZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCBmb3Igb3RoZXJzCiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFsdWUucHVzaCgnJyArIGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuICdbJyArIHZhbHVlLmpvaW4oJywgJykgKyAnXSc7CiAgICAgICAgfSwKCiAgICAgICAgZXE6IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgICAgICByZXR1cm4gKGluZGV4ID49IDApID8ganFMaXRlKHRoaXNbaW5kZXhdKSA6IGpxTGl0ZSh0aGlzW3RoaXMubGVuZ3RoICsgaW5kZXhdKTsKICAgICAgICB9LAoKICAgICAgICBsZW5ndGg6IDAsCiAgICAgICAgcHVzaDogcHVzaCwKICAgICAgICBzb3J0OiBbXS5zb3J0LAogICAgICAgIHNwbGljZTogW10uc3BsaWNlCiAgICB9OwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyBpdGVyYXRpbmcgZ2V0dGVyL3NldHRlcnMuCi8vIHRoZXNlIGZ1bmN0aW9ucyByZXR1cm4gc2VsZiBvbiBzZXR0ZXIgYW5kCi8vIHZhbHVlIG9uIGdldC4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICB2YXIgQk9PTEVBTl9BVFRSID0ge307CiAgICBmb3JFYWNoKCdtdWx0aXBsZSxzZWxlY3RlZCxjaGVja2VkLGRpc2FibGVkLHJlYWRPbmx5LHJlcXVpcmVkJy5zcGxpdCgnLCcpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICAgIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0nLnNwbGl0KCcsJyksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIEJPT0xFQU5fRUxFTUVOVFNbdXBwZXJjYXNlKHZhbHVlKV0gPSB0cnVlOwogICAgfSk7CgogICAgZnVuY3Rpb24gZ2V0Qm9vbGVhbkF0dHJOYW1lKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICAvLyBjaGVjayBkb20gbGFzdCBzaW5jZSB3ZSB3aWxsIG1vc3QgbGlrZWx5IGZhaWwgb24gbmFtZQogICAgICAgIHZhciBib29sZWFuQXR0ciA9IEJPT0xFQU5fQVRUUltuYW1lLnRvTG93ZXJDYXNlKCldOwoKICAgICAgICAvLyBib29sZWFuQXR0ciBpcyBoZXJlIHR3aWNlIHRvIG1pbmltaXplIERPTSBhY2Nlc3MKICAgICAgICByZXR1cm4gYm9vbGVhbkF0dHIgJiYgQk9PTEVBTl9FTEVNRU5UU1tlbGVtZW50Lm5vZGVOYW1lXSAmJiBib29sZWFuQXR0cjsKICAgIH0KCiAgICBmb3JFYWNoKHsKICAgICAgICBkYXRhOiBKUUxpdGVEYXRhLAogICAgICAgIGluaGVyaXRlZERhdGE6IEpRTGl0ZUluaGVyaXRlZERhdGEsCgogICAgICAgIHNjb3BlOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJHNjb3BlJyk7CiAgICAgICAgfSwKCiAgICAgICAgY29udHJvbGxlcjogSlFMaXRlQ29udHJvbGxlciwKCiAgICAgICAgaW5qZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckaW5qZWN0b3InKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgICB9LAoKICAgICAgICBoYXNDbGFzczogSlFMaXRlSGFzQ2xhc3MsCgogICAgICAgIGNzczogZnVuY3Rpb24gKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIG5hbWUgPSBjYW1lbENhc2UobmFtZSk7CgogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHZhbDsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBzb21lIElFIHNwZWNpZmljIHdlaXJkbmVzcyB0aGF0IGpRdWVyeSAxLjYuNCBkb2VzIG5vdCBzdXJlIHdoeQogICAgICAgICAgICAgICAgICAgIHZhbCA9IGVsZW1lbnQuY3VycmVudFN0eWxlICYmIGVsZW1lbnQuY3VycmVudFN0eWxlW25hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWwgPT09ICcnKSB2YWwgPSAnYXV0byc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFsID0gdmFsIHx8IGVsZW1lbnQuc3R5bGVbbmFtZV07CgogICAgICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgICAgIC8vIGpxdWVyeSB3ZWlyZG5lc3MgOi0vCiAgICAgICAgICAgICAgICAgICAgdmFsID0gKHZhbCA9PT0gJycpID8gdW5kZWZpbmVkIDogdmFsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAgdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYXR0cjogZnVuY3Rpb24gKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBsb3dlcmNhc2VkTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgICAgICAgaWYgKEJPT0xFQU5fQVRUUltsb3dlcmNhc2VkTmFtZV0pIHsKICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEhdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIGxvd2VyY2FzZWROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGxvd2VyY2FzZWROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZWxlbWVudFtuYW1lXSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoZWxlbWVudC5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKSB8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgICAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAvLyB0aGUgZXh0cmEgYXJndW1lbnQgIjIiIGlzIHRvIGdldCB0aGUgcmlnaHQgdGhpbmcgZm9yIGEuaHJlZiBpbiBJRSwgc2VlIGpRdWVyeSBjb2RlCiAgICAgICAgICAgICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgICAgICAgICAgIHZhciByZXQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShuYW1lLCAyKTsKICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBub24tZXhpc3RpbmcgYXR0cmlidXRlcyB0byB1bmRlZmluZWQgKGFzIGpRdWVyeSkKICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcm9wOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogZXh0ZW5kKChtc2llIDwgOSkKICAgICAgICAgICAgPyBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMSAvKiogRWxlbWVudCAqLykgewogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5pbm5lclRleHQ7CiAgICAgICAgICAgICAgICBlbGVtZW50LmlubmVyVGV4dCA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlVmFsdWU7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm5vZGVWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICA6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC50ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgfSwgeyRkdjogJyd9KSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIGh0bWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZm4sIG5hbWUpIHsKICAgICAgICAvKioKICAgICAgICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciBpLCBrZXk7CgogICAgICAgICAgICAvLyBKUUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgICAgICAgICAgLy8gaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcyBtaW5pZmljYXRpb24uCiAgICAgICAgICAgIGlmICgoKGZuLmxlbmd0aCA9PSAyICYmIChmbiAhPT0gSlFMaXRlSGFzQ2xhc3MgJiYgZm4gIT09IEpRTGl0ZUNvbnRyb2xsZXIpKSA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoYXJnMSkpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIGJ1dCB0aGUgb2JqZWN0IHByb3BlcnRpZXMgYXJlIHRoZSBrZXkvdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuID09PSBKUUxpdGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhKCkgdGFrZXMgdGhlIHdob2xlIG9iamVjdCBpbiBqUXVlcnkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gYXJnMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4odGhpc1swXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm4uJGR2OwogICAgICAgIH07CiAgICB9KTsKCiAgICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgICAgdmFyIGV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCwgdHlwZSkgewogICAgICAgICAgICBpZiAoIWV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50ID0gZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50LmNhbGwoZXZlbnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbWVudCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSBtb25rZXktcGF0Y2hlZCBtZXRob2RzIChJRSksCiAgICAgICAgICAgIC8vIGFzIHRoZXkgd291bGQgY2F1c2UgbWVtb3J5IGxlYWtzIGluIElFOC4KICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgLy8gSUU3LzggZG9lcyBub3QgYWxsb3cgdG8gZGVsZXRlIHByb3BlcnR5IG9uIG5hdGl2ZSBvYmplY3QKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSXQgc2hvdWxkbid0IGFmZmVjdCBub3JtYWwgYnJvd3NlcnMgKG5hdGl2ZSBtZXRob2RzIGFyZSBkZWZpbmVkIG9uIHByb3RvdHlwZSkuCiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuc3RvcFByb3BhZ2F0aW9uOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXZlbnRIYW5kbGVyLmVsZW0gPSBlbGVtZW50OwogICAgICAgIHJldHVybiBldmVudEhhbmRsZXI7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyB0cmF2ZXJzYWwuCi8vIFRoZXNlIGZ1bmN0aW9ucyBjaGFpbiByZXN1bHRzIGludG8gYSBzaW5nbGUKLy8gc2VsZWN0b3IuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgZm9yRWFjaCh7CiAgICAgICAgcmVtb3ZlRGF0YTogSlFMaXRlUmVtb3ZlRGF0YSwKCiAgICAgICAgZGVhbG9jOiBKUUxpdGVEZWFsb2MsCgogICAgICAgIGJpbmQ6IGZ1bmN0aW9uIGJpbmRGbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICAgICAgICAgIGhhbmRsZSA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJyk7CgogICAgICAgICAgICBpZiAoIWV2ZW50cykgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnLCBldmVudHMgPSB7fSk7CiAgICAgICAgICAgIGlmICghaGFuZGxlKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScsIGhhbmRsZSA9IGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpKTsKCiAgICAgICAgICAgIGZvckVhY2godHlwZS5zcGxpdCgnICcpLCBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gZXZlbnRzW3R5cGVdOwoKICAgICAgICAgICAgICAgIGlmICghZXZlbnRGbnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSAnbW91c2VlbnRlcicgfHwgdHlwZSA9PSAnbW91c2VsZWF2ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5zID0gZG9jdW1lbnQuYm9keS5jb250YWlucyB8fCBkb2N1bWVudC5ib2R5LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zKGJ1cCkgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGIgPSBiLnBhcmVudE5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYiA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGpRdWVyeSdzIGltcGxlbWVudGF0aW9uIG9mIG1vdXNlZW50ZXIgJiBtb3VzZWxlYXZlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9ldmVudHNfbW91c2UuaHRtbCNsaW5rOAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRtYXAgPSB7IG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIifQogICAgICAgICAgICAgICAgICAgICAgICBiaW5kRm4oZWxlbWVudCwgZXZlbnRtYXBbdHlwZV0sIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCwgdGFyZ2V0ID0gdGhpcywgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWNvbnRhaW5zKHRhcmdldCwgcmVsYXRlZCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlKGV2ZW50LCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzW3R5cGVdID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV2ZW50Rm5zID0gZXZlbnRzW3R5cGVdCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBldmVudEZucy5wdXNoKGZuKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgdW5iaW5kOiBKUUxpdGVVbmJpbmQsCgogICAgICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbiAoZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgICAgICAgICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgICAgIGlmIChpbmRleCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXggPSBub2RlOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBjaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4ucHVzaChlbGVtZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9LAoKICAgICAgICBjb250ZW50czogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsKICAgICAgICB9LAoKICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uIChlbGVtZW50LCBub2RlKSB7CiAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoaWxkLCBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cmFwOiBmdW5jdGlvbiAoZWxlbWVudCwgd3JhcE5vZGUpIHsKICAgICAgICAgICAgd3JhcE5vZGUgPSBqcUxpdGUod3JhcE5vZGUpWzBdOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cmFwTm9kZS5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIGFmdGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgbmV3RWxlbWVudCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSBlbGVtZW50LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShuZXdFbGVtZW50KSwgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgaW5kZXggPSBub2RlOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhZGRDbGFzczogSlFMaXRlQWRkQ2xhc3MsCiAgICAgICAgcmVtb3ZlQ2xhc3M6IEpRTGl0ZVJlbW92ZUNsYXNzLAoKICAgICAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yLCBjb25kaXRpb24pIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvbmRpdGlvbikpIHsKICAgICAgICAgICAgICAgIGNvbmRpdGlvbiA9ICFKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKGNvbmRpdGlvbiA/IEpRTGl0ZUFkZENsYXNzIDogSlFMaXRlUmVtb3ZlQ2xhc3MpKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgbmV4dDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElFOCBkb2Vzbid0IGhhdmUgbmV4dEVsZW1lbnRTaWJsaW5nCiAgICAgICAgICAgIHZhciBlbG0gPSBlbGVtZW50Lm5leHRTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAoZWxtICE9IG51bGwgJiYgZWxtLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICBlbG0gPSBlbG0ubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsbTsKICAgICAgICB9LAoKICAgICAgICBmaW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIGNsb25lOiBKUUxpdGVDbG9uZSwKCiAgICAgICAgdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudE5hbWUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gKEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50Rm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbWVudCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICAgICAqLwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoYXJnMSwgYXJnMikgewogICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0ganFMaXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZCA/IHRoaXMgOiB2YWx1ZTsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDb21wdXRlcyBhIGhhc2ggb2YgYW4gJ29iaicuCiAgICAgKiBIYXNoIG9mIGE6CiAgICAgKiAgc3RyaW5nIGlzIHN0cmluZwogICAgICogIG51bWJlciBpcyBudW1iZXIgYXMgc3RyaW5nCiAgICAgKiAgb2JqZWN0IGlzIGVpdGhlciByZXN1bHQgb2YgY2FsbGluZyAkJGhhc2hLZXkgZnVuY3Rpb24gb24gdGhlIG9iamVjdCBvciB1bmlxdWVseSBnZW5lcmF0ZWQgaWQsCiAgICAgKiAgICAgICAgIHRoYXQgaXMgYWxzbyBhc3NpZ25lZCB0byB0aGUgJCRoYXNoS2V5IHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIG9iagogICAgICogQHJldHVybnMge3N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZy4KICAgICAqICAgICAgICAgVGhlIHJlc3VsdGluZyBzdHJpbmcga2V5IGlzIGluICd0eXBlOmhhc2hLZXknIGZvcm1hdC4KICAgICAqLwogICAgZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICAgICAgICB2YXIgb2JqVHlwZSA9IHR5cGVvZiBvYmosCiAgICAgICAgICAgIGtleTsKCiAgICAgICAgaWYgKG9ialR5cGUgPT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgKGtleSA9IG9iai4kJGhhc2hLZXkpID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIC8vIG11c3QgaW52b2tlIG9uIG9iamVjdCB0byBrZWVwIHRoZSByaWdodCB0aGlzCiAgICAgICAgICAgICAgICBrZXkgPSBvYmouJCRoYXNoS2V5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgPSBvYmo7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb2JqVHlwZSArICc6JyArIGtleTsKICAgIH0KCiAgICAvKioKICAgICAqIEhhc2hNYXAgd2hpY2ggY2FuIHVzZSBvYmplY3RzIGFzIGtleXMKICAgICAqLwogICAgZnVuY3Rpb24gSGFzaE1hcChhcnJheSkgewogICAgICAgIGZvckVhY2goYXJyYXksIHRoaXMucHV0LCB0aGlzKTsKICAgIH0KCiAgICBIYXNoTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZSBrZXkgdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkga2V5IHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXNbaGFzaEtleShrZXkpXSA9IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSBrZXkKICAgICAgICAgKiBAcmV0dXJucyB0aGUgdmFsdWUgZm9yIHRoZSBrZXkKICAgICAgICAgKi8KICAgICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbaGFzaEtleShrZXkpXTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmUgdGhlIGtleS92YWx1ZSBwYWlyCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzW2tleSA9IGhhc2hLZXkoa2V5KV07CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQSBtYXAgd2hlcmUgbXVsdGlwbGUgdmFsdWVzIGNhbiBiZSBhZGRlZCB0byB0aGUgc2FtZSBrZXkgc3VjaCB0aGF0IHRoZXkgZm9ybSBhIHF1ZXVlLgogICAgICogQHJldHVybnMge0hhc2hRdWV1ZU1hcH0KICAgICAqLwogICAgZnVuY3Rpb24gSGFzaFF1ZXVlTWFwKCkgewogICAgfQoKICAgIEhhc2hRdWV1ZU1hcC5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogU2FtZSBhcyBhcnJheSBwdXNoLCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHB1c2g6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICAgICAgdGhpc1trZXldID0gW3ZhbHVlXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5LnB1c2godmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2FtZSBhcyBhcnJheSBzaGlmdCwgYnV0IHVzaW5nIGFuIGFycmF5IGFzIHRoZSB2YWx1ZSBmb3IgdGhlIGhhc2gKICAgICAgICAgKi8KICAgICAgICBzaGlmdDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSB0aGlzW2tleSA9IGhhc2hLZXkoa2V5KV07CiAgICAgICAgICAgIGlmIChhcnJheSkgewogICAgICAgICAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheS5zaGlmdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogcmV0dXJuIHRoZSBmaXJzdCBpdGVtIHdpdGhvdXQgZGVsZXRpbmcgaXQKICAgICAgICAgKi8KICAgICAgICBwZWVrOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNbaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXlbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmluamVjdG9yCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogICAgICogZGVwZW5kZW5jeSBpbmplY3Rpb24gKHNlZSB7QGxpbmsgZ3VpZGUvZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICAgICAqCgogICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICAgICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5tb2R1bGV9LiBUaGUgYG5nYCBtb2R1bGUgbXVzdCBiZSBleHBsaWNpdGx5IGFkZGVkLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEluamVjdG9yIGZ1bmN0aW9uLiBTZWUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFR5cGljYWwgdXNhZ2UKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGNyZWF0ZSBhbiBpbmplY3RvcgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJ10pOwogICAgICoKICAgICAqICAgLy8gdXNlIHRoZSBpbmplY3RvciB0byBraWNrIG9mZiB5b3VyIGFwcGxpY2F0aW9uCiAgICAgKiAgIC8vIHVzZSB0aGUgdHlwZSBpbmZlcmVuY2UgdG8gYXV0byBpbmplY3QgYXJndW1lbnRzLCBvciB1c2UgaW1wbGljaXQgaW5qZWN0aW9uCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRkb2N1bWVudCl7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvdmVydmlldwogICAgICogQG5hbWUgQVVUTwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAgICovCgogICAgdmFyIEZOX0FSR1MgPSAvXmZ1bmN0aW9uXHMqW15cKF0qXChccyooW15cKV0qKVwpL207CiAgICB2YXIgRk5fQVJHX1NQTElUID0gLywvOwogICAgdmFyIEZOX0FSRyA9IC9eXHMqKF8/KShcUys/KVwxXHMqJC87CiAgICB2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwoKICAgIGZ1bmN0aW9uIGFubm90YXRlKGZuKSB7CiAgICAgICAgdmFyICRpbmplY3QsCiAgICAgICAgICAgIGZuVGV4dCwKICAgICAgICAgICAgYXJnRGVjbCwKICAgICAgICAgICAgbGFzdDsKCiAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGlmICghKCRpbmplY3QgPSBmbi4kaW5qZWN0KSkgewogICAgICAgICAgICAgICAgJGluamVjdCA9IFtdOwogICAgICAgICAgICAgICAgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICAgICAgICAgICAgICBhcmdEZWNsID0gZm5UZXh0Lm1hdGNoKEZOX0FSR1MpOwogICAgICAgICAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uIChhbGwsIHVuZGVyc2NvcmUsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGluamVjdC5wdXNoKG5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbi4kaW5qZWN0ID0gJGluamVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShmbikpIHsKICAgICAgICAgICAgbGFzdCA9IGZuLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuW2xhc3RdLCAnZm4nKTsKICAgICAgICAgICAgJGluamVjdCA9IGZuLnNsaWNlKDAsIGxhc3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuLCAnZm4nLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRpbmplY3Q7CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBgJGluamVjdG9yYCBpcyB1c2VkIHRvIHJldHJpZXZlIG9iamVjdCBpbnN0YW5jZXMgYXMgZGVmaW5lZCBieQogICAgICoge0BsaW5rIEFVVE8uJHByb3ZpZGUgcHJvdmlkZXJ9LCBpbnN0YW50aWF0ZSB0eXBlcywgaW52b2tlIG1ldGhvZHMsCiAgICAgKiBhbmQgbG9hZCBtb2R1bGVzLgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgYWx3YXlzIGhvbGRzIHRydWU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5nZXQoJyRpbmplY3RvcicpKS50b0JlKCRpbmplY3Rvcik7CiAgICAgKiAgIGV4cGVjdCgkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRpbmplY3Rvcil7CiAqICAgICByZXR1cm4gJGluamVjdG9yOwogKiAgIH0pLnRvQmUoJGluamVjdG9yKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMgSW5qZWN0aW9uIEZ1bmN0aW9uIEFubm90YXRpb24KICAgICAqCiAgICAgKiBKYXZhU2NyaXB0IGRvZXMgbm90IGhhdmUgYW5ub3RhdGlvbnMsIGFuZCBhbm5vdGF0aW9ucyBhcmUgbmVlZGVkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbi4gVGhlCiAgICAgKiBmb2xsb3dpbmcgYXJlIGFsbCB2YWxpZCB3YXlzIG9mIGFubm90YXRpbmcgZnVuY3Rpb24gd2l0aCBpbmplY3Rpb24gYXJndW1lbnRzIGFuZCBhcmUgZXF1aXZhbGVudC4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBpbmZlcnJlZCAob25seSB3b3JrcyBpZiBjb2RlIG5vdCBtaW5pZmllZC9vYmZ1c2NhdGVkKQogICAgICogICAkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKHNlcnZpY2VBKXt9KTsKICAgICAqCiAgICAgKiAgIC8vIGFubm90YXRlZAogICAgICogICBmdW5jdGlvbiBleHBsaWNpdChzZXJ2aWNlQSkge307CiAgICAgKiAgIGV4cGxpY2l0LiRpbmplY3QgPSBbJ3NlcnZpY2VBJ107CiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZXhwbGljaXQpOwogICAgICoKICAgICAqICAgLy8gaW5saW5lCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoWydzZXJ2aWNlQScsIGZ1bmN0aW9uKHNlcnZpY2VBKXt9XSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIyBJbmZlcmVuY2UKICAgICAqCiAgICAgKiBJbiBKYXZhU2NyaXB0IGNhbGxpbmcgYHRvU3RyaW5nKClgIG9uIGEgZnVuY3Rpb24gcmV0dXJucyB0aGUgZnVuY3Rpb24gZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24gY2FuIHRoZW4gYmUKICAgICAqIHBhcnNlZCBhbmQgdGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjYW4gYmUgZXh0cmFjdGVkLiAqTk9URToqIFRoaXMgZG9lcyBub3Qgd29yayB3aXRoIG1pbmlmaWNhdGlvbiwgYW5kIG9iZnVzY2F0aW9uCiAgICAgKiB0b29scyBzaW5jZSB0aGVzZSB0b29scyBjaGFuZ2UgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAgICoKICAgICAqICMjIGAkaW5qZWN0YCBBbm5vdGF0aW9uCiAgICAgKiBCeSBhZGRpbmcgYSBgJGluamVjdGAgcHJvcGVydHkgb250byBhIGZ1bmN0aW9uIHRoZSBpbmplY3Rpb24gcGFyYW1ldGVycyBjYW4gYmUgc3BlY2lmaWVkLgogICAgICoKICAgICAqICMjIElubGluZQogICAgICogQXMgYW4gYXJyYXkgb2YgaW5qZWN0aW9uIG5hbWVzLCB3aGVyZSB0aGUgbGFzdCBpdGVtIGluIHRoZSBhcnJheSBpcyB0aGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjZ2V0CiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybiBhbiBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdG8gcmV0cmlldmUuCiAgICAgKiBAcmV0dXJuIHsqfSBUaGUgaW5zdGFuY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2ludm9rZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnZva2UgdGhlIG1ldGhvZCBhbmQgc3VwcGx5IHRoZSBtZXRob2QgYXJndW1lbnRzIGZyb20gdGhlIGAkaW5qZWN0b3JgLgogICAgICoKICAgICAqIEBwYXJhbSB7IWZ1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLiBUaGUgZnVuY3Rpb24gYXJndW1lbnRzIGNvbWUgZm9ybSB0aGUgZnVuY3Rpb24gYW5ub3RhdGlvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gc2VsZiBUaGUgYHRoaXNgIGZvciB0aGUgaW52b2tlZCBtZXRob2QuCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGxvY2FscyBPcHRpb25hbCBvYmplY3QuIElmIHByZXNldCB0aGVuIGFueSBhcmd1bWVudCBuYW1lcyBhcmUgcmVhZCBmcm9tIHRoaXMgb2JqZWN0IGZpcnN0LCBiZWZvcmUKICAgICAqICAgdGhlIGAkaW5qZWN0b3JgIGlzIGNvbnN1bHRlZC4KICAgICAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgcmV0dXJuZWQgYnkgdGhlIGludm9rZWQgYGZuYCBmdW5jdGlvbi4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjaW5zdGFudGlhdGUKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgSlMgdHlwZS4gVGhlIG1ldGhvZCB0YWtlcyBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGludm9rZXMgdGhlIG5ldyBvcGVyYXRvciBhbmQgc3VwcGxpZXMKICAgICAqIGFsbCBvZiB0aGUgYXJndW1lbnRzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBhcyBzcGVjaWZpZWQgYnkgdGhlIGNvbnN0cnVjdG9yIGFubm90YXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gVHlwZSBBbm5vdGF0ZWQgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGxvY2FscyBPcHRpb25hbCBvYmplY3QuIElmIHByZXNldCB0aGVuIGFueSBhcmd1bWVudCBuYW1lcyBhcmUgcmVhZCBmcm9tIHRoaXMgb2JqZWN0IGZpcnN0LCBiZWZvcmUKICAgICAqICAgdGhlIGAkaW5qZWN0b3JgIGlzIGNvbnN1bHRlZC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IG5ldyBpbnN0YW5jZSBvZiBgVHlwZWAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2Fubm90YXRlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgYW4gYXJyYXkgb2Ygc2VydmljZSBuYW1lcyB3aGljaCB0aGUgZnVuY3Rpb24gaXMgcmVxdWVzdGluZyBmb3IgaW5qZWN0aW9uLiBUaGlzIEFQSSBpcyB1c2VkIGJ5IHRoZSBpbmplY3RvcgogICAgICogdG8gZGV0ZXJtaW5lIHdoaWNoIHNlcnZpY2VzIG5lZWQgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24gd2hlbiB0aGUgZnVuY3Rpb24gaXMgaW52b2tlZC4gVGhlcmUgYXJlIHRocmVlCiAgICAgKiB3YXlzIGluIHdoaWNoIHRoZSBmdW5jdGlvbiBjYW4gYmUgYW5ub3RhdGVkIHdpdGggdGhlIG5lZWRlZCBkZXBlbmRlbmNpZXMuCiAgICAgKgogICAgICogIyBBcmd1bWVudCBuYW1lcwogICAgICoKICAgICAqIFRoZSBzaW1wbGVzdCBmb3JtIGlzIHRvIGV4dHJhY3QgdGhlIGRlcGVuZGVuY2llcyBmcm9tIHRoZSBhcmd1bWVudHMgb2YgdGhlIGZ1bmN0aW9uLiBUaGlzIGlzIGRvbmUgYnkgY29udmVydGluZwogICAgICogdGhlIGZ1bmN0aW9uIGludG8gYSBzdHJpbmcgdXNpbmcgYHRvU3RyaW5nKClgIG1ldGhvZCBhbmQgZXh0cmFjdGluZyB0aGUgYXJndW1lbnQgbmFtZXMuCiAgICAgKiA8cHJlPgogICAgICogICAvLyBHaXZlbgogICAgICogICBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkcm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluZmljYXRpb24gLyBvYmZ1c2NhdGlvbi4gRm9yIHRoaXMgcmVhc29uIHRoZSBmb2xsb3dpbmcgYW5ub3RhdGlvbiBzdHJhdGVnaWVzCiAgICAgKiBhcmUgc3VwcG9ydGVkLgogICAgICoKICAgICAqICMgVGhlIGAkaW5qZWN0YCBwcm9wZXJ0eQogICAgICoKICAgICAqIElmIGEgZnVuY3Rpb24gaGFzIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBhbmQgaXRzIHZhbHVlIGlzIGFuIGFycmF5IG9mIHN0cmluZ3MsIHRoZW4gdGhlIHN0cmluZ3MgcmVwcmVzZW50IG5hbWVzIG9mCiAgICAgKiBzZXJ2aWNlcyB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbi4KICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIEdpdmVuCiAgICAgKiAgIHZhciBNeUNvbnRyb2xsZXIgPSBmdW5jdGlvbihvYmZ1c2NhdGVkU2NvcGUsIG9iZnVzY2F0ZWRSb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAgICogICAvLyBEZWZpbmUgZnVuY3Rpb24gZGVwZW5kZW5jaWVzCiAgICAgKiAgIE15Q29udHJvbGxlci4kaW5qZWN0ID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAgICAgKgogICAgICogICAvLyBUaGVuCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAgICAgKgogICAgICogSXQgaXMgb2Z0ZW4gZGVzaXJhYmxlIHRvIGlubGluZSBJbmplY3RlZCBmdW5jdGlvbnMgYW5kIHRoYXQncyB3aGVuIHNldHRpbmcgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eSBpcyB2ZXJ5CiAgICAgKiBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzCiAgICAgKiBtaW5pZmljYXRpb24gaXMgYSBiZXR0ZXIgY2hvaWNlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIFdlIHdpc2ggdG8gd3JpdGUgdGhpcyAobm90IG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uIHNhZmUpCiAgICAgKiAgIGluamVjdG9yLmludm9rZShmdW5jdGlvbigkY29tcGlsZSwgJHJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfSk7CiAgICAgKgogICAgICogICAvLyBXZSBhcmUgZm9yY2VkIHRvIHdyaXRlIGJyZWFrIGlubGluaW5nCiAgICAgKiAgIHZhciB0bXBGbiA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRDb21waWxlLCBvYmZ1c2NhdGVkUm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9OwogICAgICogICB0bXBGbi4kaW5qZWN0ID0gWyckY29tcGlsZScsICckcm9vdFNjb3BlJ107CiAgICAgKiAgIGluamVjdG9yLmludm9rZSh0bXBGbik7CiAgICAgKgogICAgICogICAvLyBUbyBiZXR0ZXIgc3VwcG9ydCBpbmxpbmUgZnVuY3Rpb24gdGhlIGlubGluZSBhbm5vdGF0aW9uIGlzIHN1cHBvcnRlZAogICAgICogICBpbmplY3Rvci5pbnZva2UoWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmQ29tcGlsZSwgb2JmUm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9XSk7CiAgICAgKgogICAgICogICAvLyBUaGVyZWZvcmUKICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKAogICAgICogICAgICBbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZ1c18kY29tcGlsZSwgb2JmdXNfJHJvb3RTY29wZSkge31dKQogICAgICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvIGJlIHJldHJpZXZlZCBhcyBkZXNjcmliZWQKICAgICAqICAgYWJvdmUuCiAgICAgKgogICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2UgYCRwcm92aWRlYCB0byByZWdpc3RlciBuZXcgcHJvdmlkZXJzIHdpdGggdGhlIGAkaW5qZWN0b3JgLiBUaGUgcHJvdmlkZXJzIGFyZSB0aGUgZmFjdG9yaWVzIGZvciB0aGUgaW5zdGFuY2UuCiAgICAgKiBUaGUgcHJvdmlkZXJzIHNoYXJlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGluc3RhbmNlIHRoZXkgY3JlYXRlIHdpdGggYFByb3ZpZGVyYCBzdWZmaXhlZCB0byB0aGVtLgogICAgICoKICAgICAqIEEgcHJvdmlkZXIgaXMgYW4gb2JqZWN0IHdpdGggYSBgJGdldCgpYCBtZXRob2QuIFRoZSBpbmplY3RvciBjYWxscyB0aGUgYCRnZXRgIG1ldGhvZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgICAqIGEgc2VydmljZS4gVGhlIFByb3ZpZGVyIGNhbiBoYXZlIGFkZGl0aW9uYWwgbWV0aG9kcyB3aGljaCB3b3VsZCBhbGxvdyBmb3IgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgZnVuY3Rpb24gR3JlZXRQcm92aWRlcigpIHsKICogICAgIHZhciBzYWx1dGF0aW9uID0gJ0hlbGxvJzsKICoKICogICAgIHRoaXMuc2FsdXRhdGlvbiA9IGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgc2FsdXRhdGlvbiA9IHRleHQ7CiAqICAgICB9OwogKgogKiAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogKiAgICAgICAgIHJldHVybiBzYWx1dGF0aW9uICsgJyAnICsgbmFtZSArICchJzsKICogICAgICAgfTsKICogICAgIH07CiAqICAgfQogICAgICoKICAgICAqICAgZGVzY3JpYmUoJ0dyZWV0ZXInLCBmdW5jdGlvbigpewogKgogKiAgICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oJHByb3ZpZGUpIHsKICogICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJ2dyZWV0JywgR3JlZXRQcm92aWRlcik7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGdyZWV0JywgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdIZWxsbyBhbmd1bGFyIScpOwogKiAgICAgfSkpOwogKgogKiAgICAgaXQoJ3Nob3VsZCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHNhbHV0YXRpb24nLCBmdW5jdGlvbigpIHsKICogICAgICAgbW9kdWxlKGZ1bmN0aW9uKGdyZWV0UHJvdmlkZXIpIHsKICogICAgICAgICBncmVldFByb3ZpZGVyLnNhbHV0YXRpb24oJ0Fob2onKTsKICogICAgICAgfSk7CiAqICAgICAgIGluamVjdChmdW5jdGlvbihncmVldCkgewogKiAgICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdBaG9qIGFuZ3VsYXIhJyk7CiAqICAgICAgIH0pOwogKiAgICAgfSk7CiAqIDwvcHJlPgogKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBSZWdpc3RlciBhIHByb3ZpZGVyIGZvciBhIHNlcnZpY2UuIFRoZSBwcm92aWRlcnMgY2FuIGJlIHJldHJpZXZlZCBhbmQgY2FuIGhhdmUgYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG1ldGhvZHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKyAnUHJvdmlkZXInYCBrZXkuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICAgICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICAgKiAgICAgICAgICAgICAgIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZmFjdG9yeQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgb25seSBgJGdldGAgbWV0aG9kIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZCBmb3IKICAgICAqIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciByZWdpc3RlcmluZyBzZXJ2aWNlIG9mIGdpdmVuIGNsYXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSN2YWx1ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgdGhlIGAkZ2V0YCBtZXRob2QgaXMgYSBjb25zdGFudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIGNvbnN0YW50IHZhbHVlLCBidXQgdW5saWtlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUgaW5qZWN0ZWQKICAgICAqIGludG8gY29uZmlndXJhdGlvbiBmdW5jdGlvbiAob3RoZXIgbW9kdWxlcykgYW5kIGl0IGlzIG5vdCBpbnRlcmNlcHRhYmxlIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZGVjb3JhdG9yCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRGVjb3JhdGlvbiBvZiBzZXJ2aWNlLCBhbGxvd3MgdGhlIGRlY29yYXRvciB0byBpbnRlcmNlcHQgdGhlIHNlcnZpY2UgaW5zdGFuY2UgY3JlYXRpb24uIFRoZQogICAgICogcmV0dXJuZWQgaW5zdGFuY2UgbWF5IGJlIHRoZSBvcmlnaW5hbCBpbnN0YW5jZSwgb3IgYSBuZXcgaW5zdGFuY2Ugd2hpY2ggZGVsZWdhdGVzIHRvIHRoZQogICAgICogb3JpZ2luYWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAgICAgKiAgICBpbnN0YW50aWF0ZWQuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqICAgIGluamVjdG9yLmludm9rZX0gbWV0aG9kIGFuZCBpcyB0aGVyZWZvcmUgZnVsbHkgaW5qZWN0YWJsZS4gTG9jYWwgaW5qZWN0aW9uIGFyZ3VtZW50czoKICAgICAqCiAgICAgKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICAgICAqICAgICAgZGVjb3JhdGVkIG9yIGRlbGVnYXRlZCB0by4KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjcmVhdGVJbmplY3Rvcihtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICAgICAgICBwYXRoID0gW10sCiAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcCgpLAogICAgICAgICAgICBwcm92aWRlckNhY2hlID0gewogICAgICAgICAgICAgICAgJHByb3ZpZGU6IHsKICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogc3VwcG9ydE9iamVjdChwcm92aWRlciksCiAgICAgICAgICAgICAgICAgICAgZmFjdG9yeTogc3VwcG9ydE9iamVjdChmYWN0b3J5KSwKICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBzdXBwb3J0T2JqZWN0KHNlcnZpY2UpLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdXBwb3J0T2JqZWN0KHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBjb25zdGFudDogc3VwcG9ydE9iamVjdChjb25zdGFudCksCiAgICAgICAgICAgICAgICAgICAgZGVjb3JhdG9yOiBkZWNvcmF0b3IKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJvdmlkZXJJbmplY3RvciA9IGNyZWF0ZUludGVybmFsSW5qZWN0b3IocHJvdmlkZXJDYWNoZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIlVua25vd24gcHJvdmlkZXI6ICIgKyBwYXRoLmpvaW4oJyA8LSAnKSk7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgICAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbiAoc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3RvcjsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gJHByb3ZpZGVyCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIGZ1bmN0aW9uIHN1cHBvcnRPYmplY3QoZGVsZWdhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3Qoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGZvckVhY2goa2V5LCByZXZlcnNlUGFyYW1zKGRlbGVnYXRlKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZShrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJvdmlkZXIobmFtZSwgcHJvdmlkZXJfKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHByb3ZpZGVyXykgfHwgaXNBcnJheShwcm92aWRlcl8pKSB7CiAgICAgICAgICAgICAgICBwcm92aWRlcl8gPSBwcm92aWRlckluamVjdG9yLmluc3RhbnRpYXRlKHByb3ZpZGVyXyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFwcm92aWRlcl8uJGdldCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ1Byb3ZpZGVyICcgKyBuYW1lICsgJyBtdXN0IGRlZmluZSAkZ2V0IGZhY3RvcnkgbWV0aG9kLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlW25hbWUgKyBwcm92aWRlclN1ZmZpeF0gPSBwcm92aWRlcl87CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbikgewogICAgICAgICAgICByZXR1cm4gcHJvdmlkZXIobmFtZSwgeyAkZ2V0OiBmYWN0b3J5Rm4gfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXJ2aWNlKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24gKCRpbmplY3RvcikgewogICAgICAgICAgICAgICAgcmV0dXJuICRpbmplY3Rvci5pbnN0YW50aWF0ZShjb25zdHJ1Y3Rvcik7CiAgICAgICAgICAgIH1dKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHZhbHVlKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlRm4odmFsdWUpKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVjb3JhdG9yKHNlcnZpY2VOYW1lLCBkZWNvckZuKSB7CiAgICAgICAgICAgIHZhciBvcmlnUHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlTmFtZSArIHByb3ZpZGVyU3VmZml4KSwKICAgICAgICAgICAgICAgIG9yaWckZ2V0ID0gb3JpZ1Byb3ZpZGVyLiRnZXQ7CgogICAgICAgICAgICBvcmlnUHJvdmlkZXIuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBvcmlnSW5zdGFuY2UgPSBpbnN0YW5jZUluamVjdG9yLmludm9rZShvcmlnJGdldCwgb3JpZ1Byb3ZpZGVyKTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShkZWNvckZuLCBudWxsLCB7JGRlbGVnYXRlOiBvcmlnSW5zdGFuY2V9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIE1vZHVsZSBMb2FkaW5nCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgZnVuY3Rpb24gbG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCkgewogICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CiAgICAgICAgICAgIGZvckVhY2gobW9kdWxlc1RvTG9hZCwgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMucHV0KG1vZHVsZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVGbiA9IGFuZ3VsYXJNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpbnZva2VRdWV1ZSA9IG1vZHVsZUZuLl9pbnZva2VRdWV1ZSwgaSA9IDAsIGlpID0gaW52b2tlUXVldWUubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGludm9rZUFyZ3MgPSBpbnZva2VRdWV1ZVtpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlciA9IGludm9rZUFyZ3NbMF0gPT0gJyRpbmplY3RvcicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwcm92aWRlckluamVjdG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogcHJvdmlkZXJJbmplY3Rvci5nZXQoaW52b2tlQXJnc1swXSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXJbaW52b2tlQXJnc1sxXV0uYXBwbHkocHJvdmlkZXIsIGludm9rZUFyZ3NbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBtb2R1bGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKG1vZHVsZSkpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgU3RyaW5nKG1vZHVsZVttb2R1bGUubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4obW9kdWxlLCAnbW9kdWxlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcnVuQmxvY2tzOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gaW50ZXJuYWwgSW5qZWN0b3IKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW50ZXJuYWxJbmplY3RvcihjYWNoZSwgZmFjdG9yeSkgewoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0U2VydmljZShzZXJ2aWNlTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlTmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignU2VydmljZSBuYW1lIGV4cGVjdGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignQ2lyY3VsYXIgZGVwZW5kZW5jeTogJyArIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC51bnNoaWZ0KHNlcnZpY2VOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVbc2VydmljZU5hbWVdID0gSU5TVEFOVElBVElORzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXSA9IGZhY3Rvcnkoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGguc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZShmbiwgc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdLAogICAgICAgICAgICAgICAgICAgICRpbmplY3QgPSBhbm5vdGF0ZShmbiksCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLCBpLAogICAgICAgICAgICAgICAgICAgIGtleTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gJGluamVjdFtpXTsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSBvcHRpbWl6YXRpb246IGh0dHA6Ly9qc3BlcmYuY29tL2FwcGx5LXZzLWNhbGwtdnMtaW52b2tlCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYgPyAtMSA6IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAzOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDU6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA2OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDg6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA5OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10sIGFyZ3NbOF0sIGFyZ3NbOV0pOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSwgcmV0dXJuZWRWYWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIC8vIGUuZy4gc29tZU1vZHVsZS5mYWN0b3J5KCdncmVldGVyJywgWyckd2luZG93JywgZnVuY3Rpb24ocmVuYW1lZCR3aW5kb3cpIHt9XSk7CiAgICAgICAgICAgICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShUeXBlKSA/IFR5cGVbVHlwZS5sZW5ndGggLSAxXSA6IFR5cGUpLnByb3RvdHlwZTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgICAgICAgICAgICByZXR1cm5lZFZhbHVlID0gaW52b2tlKFR5cGUsIGluc3RhbmNlLCBsb2NhbHMpOwoKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSA/IHJldHVybmVkVmFsdWUgOiBpbnN0YW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGludm9rZTogaW52b2tlLAogICAgICAgICAgICAgICAgaW5zdGFudGlhdGU6IGluc3RhbnRpYXRlLAogICAgICAgICAgICAgICAgZ2V0OiBnZXRTZXJ2aWNlLAogICAgICAgICAgICAgICAgYW5ub3RhdGU6IGFubm90YXRlCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdoZW4gY2FsbGVkLCBpdCBjaGVja3MgY3VycmVudCB2YWx1ZSBvZiBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB0byByZWxhdGVkIGVsZW1lbnQsCiAgICAgKiBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgKiB7QGxpbmsgaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3RoZS1pbmRpY2F0ZWQtcGFydC1vZi10aGUtZG9jdW1lbnQgSHRtbDUgc3BlY30uCiAgICAgKgogICAgICogSXQgYWxzbyB3YXRjaGVzIHRoZSBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB3aGVuZXZlciBpdCBjaGFuZ2VzIHRvIG1hdGNoIGFueSBhbmNob3IuCiAgICAgKiBUaGlzIGNhbiBiZSBkaXNhYmxlZCBieSBjYWxsaW5nIGAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIuZGlzYWJsZUF1dG9TY3JvbGxpbmcoKWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRBbmNob3JTY3JvbGxQcm92aWRlcigpIHsKCiAgICAgICAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIGZpbHRlci5maWx0ZXIsIGFzIGl0IGFjY2VwdHMgb25seSBpbnN0YW5jZXMgb2YgQXJyYXkKICAgICAgICAgICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0ICYmIGxvd2VyY2FzZShlbGVtZW50Lm5vZGVOYW1lKSA9PT0gJ2EnKSByZXN1bHQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzY3JvbGwoKSB7CiAgICAgICAgICAgICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCksIGVsbTsKCiAgICAgICAgICAgICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgaWYgKCFoYXNoKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwoKICAgICAgICAgICAgICAgIC8vIGVsZW1lbnQgd2l0aCBnaXZlbiBpZAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGhhc2gpKSkgZWxtLnNjcm9sbEludG9WaWV3KCk7CgogICAgICAgICAgICAgICAgLy8gZmlyc3QgYW5jaG9yIHdpdGggZ2l2ZW4gbmFtZSA6LUQKICAgICAgICAgICAgICAgIGVsc2UgaWYgKChlbG0gPSBnZXRGaXJzdEFuY2hvcihkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZShoYXNoKSkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBubyBlbGVtZW50IGFuZCBoYXNoID09ICd0b3AnLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzaCA9PT0gJ3RvcCcpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAgICAgICAgIC8vIChubyB1cmwgY2hhbmdlLCBubyAkbG9jYXRpb24uaGFzaCgpIGNoYW5nZSksIGJyb3dzZXIgbmF0aXZlIGRvZXMgc2Nyb2xsCiAgICAgICAgICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uLmhhc2goKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaEFjdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKHNjcm9sbCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBzY3JvbGw7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiAhIFRoaXMgaXMgYSBwcml2YXRlIHVuZG9jdW1lbnRlZCBzZXJ2aWNlICEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRsb2cKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICAgICAqCiAgICAgKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAgICAgKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICAgICAqCiAgICAgKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAgICAgKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAgICAgKiB0aGUgcmVhbCBicm93c2VyIGFwaXMuCiAgICAgKi8KICAgIC8qKgogICAgICogQHBhcmFtIHtvYmplY3R9IHdpbmRvdyBUaGUgZ2xvYmFsIHdpbmRvdyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkbG9nIGNvbnNvbGUubG9nIG9yIGFuIG9iamVjdCB3aXRoIHRoZSBzYW1lIGludGVyZmFjZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIEJyb3dzZXIod2luZG93LCBkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgIHJhd0RvY3VtZW50ID0gZG9jdW1lbnRbMF0sCiAgICAgICAgICAgIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAogICAgICAgICAgICBoaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCiAgICAgICAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgICAgICAgcGVuZGluZ0RlZmVySWRzID0ge307CgogICAgICAgIHNlbGYuaXNNb2NrID0gZmFsc2U7CgogICAgICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IDA7CiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcyA9IFtdOwoKICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIHRoaXMgdGVtcG9yYXJ5IGFwaQogICAgICAgIHNlbGYuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdCA9IGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0OwogICAgICAgIHNlbGYuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBFeGVjdXRlcyB0aGUgYGZuYCBmdW5jdGlvbihzdXBwb3J0cyBjdXJyeWluZykgYW5kIGRlY3JlbWVudHMgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgCiAgICAgICAgICogY291bnRlci4gSWYgdGhlIGNvdW50ZXIgcmVhY2hlcyAwLCBhbGwgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgIGFyZSBleGVjdXRlZC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgc2xpY2VBcmdzKGFyZ3VtZW50cywgMSkpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQtLTsKICAgICAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICAgICAgICovCiAgICAgICAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIC8vIGZvcmNlIGJyb3dzZXIgdG8gZXhlY3V0ZSBhbGwgcG9sbEZucyAtIHRoaXMgaXMgbmVlZGVkIHNvIHRoYXQgY29va2llcyBhbmQgb3RoZXIgcG9sbGVycyBmaXJlCiAgICAgICAgICAgIC8vIGF0IHNvbWUgZGV0ZXJtaW5pc3RpYyB0aW1lIGluIHJlc3BlY3QgdG8gdGhlIHRlc3QgcnVubmVyJ3MgYWN0aW9ucy4gTGVhdmluZyB0aGluZ3MgdXAgdG8gdGhlCiAgICAgICAgICAgIC8vIHJlZ3VsYXIgcG9sbGVyIHdvdWxkIHJlc3VsdCBpbiBmbGFreSB0ZXN0cy4KICAgICAgICAgICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbiAocG9sbEZuKSB7CiAgICAgICAgICAgICAgICBwb2xsRm4oKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIFBvbGwgV2F0Y2hlciBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBwb2xsRm5zID0gW10sCiAgICAgICAgICAgIHBvbGxUaW1lb3V0OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNhZGRQb2xsRm4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gUG9sbCBmdW5jdGlvbiB0byBhZGQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBmdW5jdGlvbiB0byB0aGUgbGlzdCBvZiBmdW5jdGlvbnMgdGhhdCBwb2xsZXIgcGVyaW9kaWNhbGx5IGV4ZWN1dGVzLAogICAgICAgICAqIGFuZCBzdGFydHMgcG9sbGluZyBpZiBub3Qgc3RhcnRlZCB5ZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gdGhlIGFkZGVkIGZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgc2VsZi5hZGRQb2xsRm4gPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBvbGxUaW1lb3V0KSkgc3RhcnRQb2xsZXIoMTAwLCBzZXRUaW1lb3V0KTsKICAgICAgICAgICAgcG9sbEZucy5wdXNoKGZuKTsKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICAgICAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAgICAgICAgIChmdW5jdGlvbiBjaGVjaygpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24gKHBvbGxGbikgewogICAgICAgICAgICAgICAgICAgIHBvbGxGbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gVVJMIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHZhciBsYXN0QnJvd3NlclVybCA9IGxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuZmluZCgnYmFzZScpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciN1cmwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEdFVFRFUjoKICAgICAgICAgKiBXaXRob3V0IGFueSBhcmd1bWVudCwgdGhpcyBtZXRob2QganVzdCByZXR1cm5zIGN1cnJlbnQgdmFsdWUgb2YgbG9jYXRpb24uaHJlZi4KICAgICAgICAgKgogICAgICAgICAqIFNFVFRFUjoKICAgICAgICAgKiBXaXRoIGF0IGxlYXN0IG9uZSBhcmd1bWVudCwgdGhpcyBtZXRob2Qgc2V0cyB1cmwgdG8gbmV3IHZhbHVlLgogICAgICAgICAqIElmIGh0bWw1IGhpc3RvcnkgYXBpIHN1cHBvcnRlZCwgcHVzaFN0YXRlL3JlcGxhY2VTdGF0ZSBpcyB1c2VkLCBvdGhlcndpc2UKICAgICAgICAgKiBsb2NhdGlvbi5ocmVmL2xvY2F0aW9uLnJlcGxhY2UgaXMgdXNlZC4KICAgICAgICAgKiBSZXR1cm5zIGl0cyBvd24gaW5zdGFuY2UgdG8gYWxsb3cgY2hhaW5pbmcKICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gY2hhbmdlIHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTmV3IHVybCAod2hlbiB1c2VkIGFzIHNldHRlcikKICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXBsYWNlIFNob3VsZCBuZXcgdXJsIHJlcGxhY2UgY3VycmVudCBoaXN0b3J5IHJlY29yZCA/CiAgICAgICAgICovCiAgICAgICAgc2VsZi51cmwgPSBmdW5jdGlvbiAodXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIC8vIHNldHRlcgogICAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gdXJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBsYXN0QnJvd3NlclVybCA9IHVybDsKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2UpIGhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JhenkgT3BlcmEgQnVnOiBodHRwOi8vbXkub3BlcmEuY29tL2NvbW11bml0eS9mb3J1bXMvdG9waWMuZG1sP2lkPTExODU0NjIKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZUVsZW1lbnQuYXR0cignaHJlZicsIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgbG9jYXRpb24ucmVwbGFjZSh1cmwpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgbG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgICAgICAgICAgLy8gZ2V0dGVyCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB0aGUgcmVwbGFjZW1lbnQgaXMgYSB3b3JrYXJvdW5kIGZvciBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00MDcxNzIKICAgICAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyUyNy9nLCAiJyIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHVybENoYW5nZUxpc3RlbmVycyA9IFtdLAogICAgICAgICAgICB1cmxDaGFuZ2VJbml0ID0gZmFsc2U7CgogICAgICAgIGZ1bmN0aW9uIGZpcmVVcmxDaGFuZ2UoKSB7CiAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSBzZWxmLnVybCgpKSByZXR1cm47CgogICAgICAgICAgICBsYXN0QnJvd3NlclVybCA9IHNlbGYudXJsKCk7CiAgICAgICAgICAgIGZvckVhY2godXJsQ2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI29uVXJsQ2hhbmdlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICogQFRPRE8odm9qdGEpOiByZWZhY3RvciB0byB1c2Ugbm9kZSdzIHN5bnRheCBmb3IgZXZlbnRzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqCiAgICAgICAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBieSBvdXRzaWRlIG9mIGFuZ3VsYXI6CiAgICAgICAgICogLSB1c2VyIHR5cGVzIGRpZmZlcmVudCB1cmwgaW50byBhZGRyZXNzIGJhcgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gaGlzdG9yeSAoZm9yd2FyZC9iYWNrKSBidXR0b24KICAgICAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGEgbGluawogICAgICAgICAqCiAgICAgICAgICogSXQncyBub3QgY2FsbGVkIHdoZW4gdXJsIGlzIGNoYW5nZWQgYnkgJGJyb3dzZXIudXJsKCkgbWV0aG9kCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBuZXcgdXJsIGFzIHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciB1cmwgY2hhbmdlcyBpbiBhbmd1bGFyIGFwcHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZyl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICAgICAqIEByZXR1cm4ge2Z1bmN0aW9uKHN0cmluZyl9IFJldHVybnMgdGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXIgZm4gLSBoYW5keSBpZiB0aGUgZm4gaXMgYW5vbnltb3VzLgogICAgICAgICAqLwogICAgICAgIHNlbGYub25VcmxDaGFuZ2UgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKCF1cmxDaGFuZ2VJbml0KSB7CiAgICAgICAgICAgICAgICAvLyBXZSBsaXN0ZW4gb24gYm90aCAoaGFzaGNoYW5nZS9wb3BzdGF0ZSkgd2hlbiBhdmFpbGFibGUsIGFzIHNvbWUgYnJvd3NlcnMgKGUuZy4gT3BlcmEpCiAgICAgICAgICAgICAgICAvLyBkb24ndCBmaXJlIHBvcHN0YXRlIHdoZW4gdXNlciBjaGFuZ2UgdGhlIGFkZHJlc3MgYmFyIGFuZCBkb24ndCBmaXJlIGhhc2hjaGFuZ2Ugd2hlbiB1cmwKICAgICAgICAgICAgICAgIC8vIGNoYW5nZWQgYnkgcHVzaC9yZXBsYWNlU3RhdGUKCiAgICAgICAgICAgICAgICAvLyBodG1sNSBoaXN0b3J5IGFwaSAtIHBvcHN0YXRlIGV2ZW50CiAgICAgICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkganFMaXRlKHdpbmRvdykuYmluZCgncG9wc3RhdGUnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIGhhc2hjaGFuZ2UgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oYXNoY2hhbmdlKSBqcUxpdGUod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgZmlyZVVybENoYW5nZSk7CiAgICAgICAgICAgICAgICAvLyBwb2xsaW5nCiAgICAgICAgICAgICAgICBlbHNlIHNlbGYuYWRkUG9sbEZuKGZpcmVVcmxDaGFuZ2UpOwoKICAgICAgICAgICAgICAgIHVybENoYW5nZUluaXQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB1cmxDaGFuZ2VMaXN0ZW5lcnMucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIE1pc2MgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBjdXJyZW50IDxiYXNlIGhyZWY+CiAgICAgICAgICogKGFsd2F5cyByZWxhdGl2ZSAtIHdpdGhvdXQgZG9tYWluKQogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge3N0cmluZz19CiAgICAgICAgICovCiAgICAgICAgc2VsZi5iYXNlSHJlZiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGhyZWYgPSBiYXNlRWxlbWVudC5hdHRyKCdocmVmJyk7CiAgICAgICAgICAgIHJldHVybiBocmVmID8gaHJlZi5yZXBsYWNlKC9eaHR0cHM/XDpcL1wvW15cL10qLywgJycpIDogJyc7CiAgICAgICAgfTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBDb29raWVzIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIGxhc3RDb29raWVzID0ge307CiAgICAgICAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKICAgICAgICB2YXIgY29va2llUGF0aCA9IHNlbGYuYmFzZUhyZWYoKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjY29va2llcwogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIENvb2tpZSBuYW1lCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBDb2traWUgdmFsdWUKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoZSBjb29raWVzIG1ldGhvZCBwcm92aWRlcyBhICdwcml2YXRlJyBsb3cgbGV2ZWwgYWNjZXNzIHRvIGJyb3dzZXIgY29va2llcy4KICAgICAgICAgKiBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSwgdXNlIHRoZSAkY29va2llIHNlcnZpY2UgaW5zdGVhZC4KICAgICAgICAgKgogICAgICAgICAqIFRoZSByZXR1cm4gdmFsdWVzIHZhcnkgZGVwZW5kaW5nIG9uIHRoZSBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBhcyBmb2xsb3dzOgogICAgICAgICAqIDx1bD4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKCkgLT4gaGFzaCBvZiBhbGwgY29va2llcywgdGhpcyBpcyBOT1QgYSBjb3B5IG9mIHRoZSBpbnRlcm5hbCBzdGF0ZSwgc28gZG8gbm90IG1vZGlmeSBpdDwvbGk+CiAgICAgICAgICogICA8bGk+Y29va2llcyhuYW1lLCB2YWx1ZSkgLT4gc2V0IG5hbWUgdG8gdmFsdWUsIGlmIHZhbHVlIGlzIHVuZGVmaW5lZCBkZWxldGUgdGhlIGNvb2tpZTwvbGk+CiAgICAgICAgICogICA8bGk+Y29va2llcyhuYW1lKSAtPiB0aGUgc2FtZSBhcyAobmFtZSwgdW5kZWZpbmVkKSA9PSBERUxFVEVTIChubyBvbmUgY2FsbHMgaXQgcmlnaHQgbm93IHRoYXQgd2F5KTwvbGk+CiAgICAgICAgICogPC91bD4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IEhhc2ggb2YgYWxsIGNvb2tpZXMgKGlmIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIpCiAgICAgICAgICovCiAgICAgICAgc2VsZi5jb29raWVzID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjb29raWVMZW5ndGgsIGNvb2tpZUFycmF5LCBjb29raWUsIGksIGluZGV4OwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgIj07cGF0aD0iICsgY29va2llUGF0aCArICI7ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llTGVuZ3RoID0gKHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICc9JyArIGVzY2FwZSh2YWx1ZSkgKyAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBwZXIgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMjEwOS50eHQgYnJvd3NlciBtdXN0IGFsbG93IGF0IG1pbmltdW06CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gMzAwIGNvb2tpZXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gNDA5NiBieXRlcyBwZXIgY29va2llCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIiArIG5hbWUgKyAiJyBwb3NzaWJseSBub3Qgc2V0IG9yIG92ZXJmbG93ZWQgYmVjYXVzZSBpdCB3YXMgdG9vIGxhcmdlICgiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggKyAiID4gNDA5NiBieXRlcykhIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICAgICAgICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgICAgICAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZSA9IGNvb2tpZUFycmF5W2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSB1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKDAsIGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb2xsb3cgYXJlIGZvciBsZXNzIHNwZWNpZmljIHBhdGhzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llc1tuYW1lXSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoaW5kZXggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdENvb2tpZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9uaW91c2x5IHZpYSBgc2V0VGltZW91dChmbiwgZGVsYXkpYC4KICAgICAgICAgKgogICAgICAgICAqIFVubGlrZSB3aGVuIGNhbGxpbmcgYHNldFRpbWVvdXRgIGRpcmVjdGx5LCBpbiB0ZXN0IHRoaXMgZnVuY3Rpb24gaXMgbW9ja2VkIGFuZCBpbnN0ZWFkIG9mIHVzaW5nCiAgICAgICAgICogYHNldFRpbWVvdXRgIGluIHRlc3RzLCB0aGUgZm5zIGFyZSBxdWV1ZWQgaW4gYW4gYXJyYXksIHdoaWNoIGNhbiBiZSBwcm9ncmFtbWF0aWNhbGx5IGZsdXNoZWQKICAgICAgICAgKiB2aWEgYCRicm93c2VyLmRlZmVyLmZsdXNoKClgLgogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2VsZi5kZWZlciA9IGZ1bmN0aW9uIChmbiwgZGVsYXkpIHsKICAgICAgICAgICAgdmFyIHRpbWVvdXRJZDsKICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgICAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW3RpbWVvdXRJZF07CiAgICAgICAgICAgICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbik7CiAgICAgICAgICAgIH0sIGRlbGF5IHx8IDApOwogICAgICAgICAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0aW1lb3V0SWQ7CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2RlZmVyLmNhbmNlbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3Nlci5kZWZlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2FuY2VscyBhIGRlZmVyZWQgdGFzayBpZGVudGlmaWVkIHdpdGggYGRlZmVySWRgLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHsqfSBkZWZlcklkIFRva2VuIHJldHVybmVkIGJ5IHRoZSBgJGJyb3dzZXIuZGVmZXJgIGZ1bmN0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bHkgY2FuY2VsZWQuCiAgICAgICAgICovCiAgICAgICAgc2VsZi5kZWZlci5jYW5jZWwgPSBmdW5jdGlvbiAoZGVmZXJJZCkgewogICAgICAgICAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGRlZmVySWQpOwogICAgICAgICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICB9CgogICAgZnVuY3Rpb24gJEJyb3dzZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvZycsICckc25pZmZlcicsICckZG9jdW1lbnQnLAogICAgICAgICAgICBmdW5jdGlvbiAoJHdpbmRvdywgJGxvZywgJHNuaWZmZXIsICRkb2N1bWVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBCcm93c2VyKCR3aW5kb3csICRkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpOwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjYWNoZUZhY3RvcnkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZhY3RvcnkgdGhhdCBjb25zdHJ1Y3RzIGNhY2hlIG9iamVjdHMuCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgY2FjaGUuCiAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QgdGhhdCBzcGVjaWZpZXMgdGhlIGNhY2hlIGJlaGF2aW9yLiBQcm9wZXJ0aWVzOgogICAgICoKICAgICAqICAgLSBge251bWJlcj19YCBgY2FwYWNpdHlgIOKAlCB0dXJucyB0aGUgY2FjaGUgaW50byBMUlUgY2FjaGUuCiAgICAgKgogICAgICogQHJldHVybnMge29iamVjdH0gTmV3bHkgY3JlYXRlZCBjYWNoZSBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHNldCBvZiBtZXRob2RzOgogICAgICoKICAgICAqIC0gYHtvYmplY3R9YCBgaW5mbygpYCDigJQgUmV0dXJucyBpZCwgc2l6ZSwgYW5kIG9wdGlvbnMgb2YgY2FjaGUuCiAgICAgKiAtIGB7dm9pZH1gIGBwdXQoe3N0cmluZ30ga2V5LCB7Kn0gdmFsdWUpYCDigJQgUHV0cyBhIG5ldyBrZXktdmFsdWUgcGFpciBpbnRvIHRoZSBjYWNoZS4KICAgICAqIC0gYHt7Kn19YCBgZ2V0KHtzdHJpbmd9IGtleSlgIOKAlCBSZXR1cm5zIGNhY2hlZCB2YWx1ZSBmb3IgYGtleWAgb3IgdW5kZWZpbmVkIGZvciBjYWNoZSBtaXNzLgogICAgICogLSBge3ZvaWR9YCBgcmVtb3ZlKHtzdHJpbmd9IGtleSlgIOKAlCBSZW1vdmVzIGEga2V5LXZhbHVlIHBhaXIgZnJvbSB0aGUgY2FjaGUuCiAgICAgKiAtIGB7dm9pZH1gIGByZW1vdmVBbGwoKWAg4oCUIFJlbW92ZXMgYWxsIGNhY2hlZCB2YWx1ZXMuCiAgICAgKiAtIGB7dm9pZH1gIGBkZXN0cm95KClgIOKAlCBSZW1vdmVzIHJlZmVyZW5jZXMgdG8gdGhpcyBjYWNoZSBmcm9tICRjYWNoZUZhY3RvcnkuCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIoKSB7CgogICAgICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgICAgICAgICAgZnVuY3Rpb24gY2FjaGVGYWN0b3J5KGNhY2hlSWQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdjYWNoZUlkICcgKyBjYWNoZUlkICsgJyB0YWtlbicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzaXplID0gMCwKICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgICAgICAgICAgICBwdXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0ge2tleToga2V5fSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoa2V5IGluIGRhdGEpKSBzaXplKys7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpemUgPiBjYXBhY2l0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoc3RhbGVFbmQua2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaChscnVFbnRyeSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IGZyZXNoRW5kKSBmcmVzaEVuZCA9IGxydUVudHJ5LnA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sIGxydUVudHJ5LnApOwoKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGxydUhhc2hba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZS0tOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICByZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBzaXplID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbHJ1SGFzaCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IHN0YWxlRW5kID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgaW5mbzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXh0ZW5kKHt9LCBzdGF0cywge3NpemU6IHNpemV9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIG1ha2VzIHRoZSBgZW50cnlgIHRoZSBmcmVzaEVuZCBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlZnJlc2goZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnkgIT0gZnJlc2hFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGFsZUVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFsZUVuZCA9PSBlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeS5uOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGVudHJ5Lm4sIGVudHJ5LnApOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGVudHJ5LCBmcmVzaEVuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gZW50cnk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kLm4gPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBiaWRpcmVjdGlvbmFsbHkgbGlua3MgdHdvIGVudHJpZXMgb2YgdGhlIExSVSBsaW5rZWQgbGlzdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBsaW5rKG5leHRFbnRyeSwgcHJldkVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRFbnRyeSAhPSBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRFbnRyeSkgbmV4dEVudHJ5LnAgPSBwcmV2RW50cnk7IC8vcCBzdGFuZHMgZm9yIHByZXZpb3VzLCAncHJldicgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldkVudHJ5KSBwcmV2RW50cnkubiA9IG5leHRFbnRyeTsgLy9uIHN0YW5kcyBmb3IgbmV4dCwgJ25leHQnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBjYWNoZUZhY3RvcnkuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgICAgICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24gKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgY2FjaGVGYWN0b3J5LmdldCA9IGZ1bmN0aW9uIChjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICB9OwoKCiAgICAgICAgICAgIHJldHVybiBjYWNoZUZhY3Rvcnk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR0ZW1wbGF0ZUNhY2hlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDYWNoZSB1c2VkIGZvciBzdG9yaW5nIGh0bWwgdGVtcGxhdGVzLgogICAgICoKICAgICAqIFNlZSB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fS4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24gKCRjYWNoZUZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3RlbXBsYXRlcycpOwogICAgICAgIH1dOwogICAgfQoKICAgIC8qICEgVkFSSUFCTEUvRlVOQ1RJT04gTkFNSU5HIENPTlZFTlRJT05TIFRIQVQgQVBQTFkgVE8gVEhJUyBGSUxFIQogICAgICoKICAgICAqIERPTS1yZWxhdGVkIHZhcmlhYmxlczoKICAgICAqCiAgICAgKiAtICJub2RlIiAtIERPTSBOb2RlCiAgICAgKiAtICJlbGVtZW50IiAtIERPTSBFbGVtZW50IG9yIE5vZGUKICAgICAqIC0gIiRub2RlIiBvciAiJGVsZW1lbnQiIC0ganFMaXRlLXdyYXBwZWQgbm9kZSBvciBlbGVtZW50CiAgICAgKgogICAgICoKICAgICAqIENvbXBpbGVyIHJlbGF0ZWQgc3R1ZmY6CiAgICAgKgogICAgICogLSAibGlua0ZuIiAtIGxpbmtpbmcgZm4gb2YgYSBzaW5nbGUgZGlyZWN0aXZlCiAgICAgKiAtICJub2RlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgcGFydGljdWxhciBub2RlCiAgICAgKiAtICJjaGlsZExpbmtGbiIgLSAgZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgY2hpbGQgbm9kZXMgb2YgYSBwYXJ0aWN1bGFyIG5vZGUKICAgICAqIC0gImNvbXBvc2l0ZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIGNvbXBpbGF0aW9uIHJvb3QgKG5vZGVMaXN0KQogICAgICovCgoKICAgIHZhciBOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OID0gJ05vbi1hc3NpZ25hYmxlIG1vZGVsIGV4cHJlc3Npb246ICc7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kY29tcGlsZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb21waWxlcyBhIHBpZWNlIG9mIEhUTUwgc3RyaW5nIG9yIERPTSBpbnRvIGEgdGVtcGxhdGUgYW5kIHByb2R1Y2VzIGEgdGVtcGxhdGUgZnVuY3Rpb24sIHdoaWNoCiAgICAgKiBjYW4gdGhlbiBiZSB1c2VkIHRvIGxpbmsge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAgICAgKgogICAgICogVGhlIGNvbXBpbGF0aW9uIGlzIGEgcHJvY2VzcyBvZiB3YWxraW5nIHRoZSBET00gdHJlZSBhbmQgdHJ5aW5nIHRvIG1hdGNoIERPTSBlbGVtZW50cyB0bwogICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LiBGb3IgZWFjaCBtYXRjaCBpdAogICAgICogZXhlY3V0ZXMgY29ycmVzcG9uZGluZyB0ZW1wbGF0ZSBmdW5jdGlvbiBhbmQgY29sbGVjdHMgdGhlCiAgICAgKiBpbnN0YW5jZSBmdW5jdGlvbnMgaW50byBhIHNpbmdsZSB0ZW1wbGF0ZSBmdW5jdGlvbiB3aGljaCBpcyB0aGVuIHJldHVybmVkLgogICAgICoKICAgICAqIFRoZSB0ZW1wbGF0ZSBmdW5jdGlvbiBjYW4gdGhlbiBiZSB1c2VkIG9uY2UgdG8gcHJvZHVjZSB0aGUgdmlldyBvciBhcyBpdCBpcyB0aGUgY2FzZSB3aXRoCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IHJlcGVhdGVyfSBtYW55LXRpbWVzLCBpbiB3aGljaAogICAgICogY2FzZSBlYWNoIGNhbGwgcmVzdWx0cyBpbiBhIHZpZXcgdGhhdCBpcyBhIERPTSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgdGVtcGxhdGUuCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZSBtb2R1bGU9ImNvbXBpbGUiPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgLy8gZGVjbGFyZSBhIG5ldyBtb2R1bGUsIGFuZCBpbmplY3QgdGhlICRjb21waWxlUHJvdmlkZXIKICAgICBhbmd1bGFyLm1vZHVsZSgnY29tcGlsZScsIFtdLCBmdW5jdGlvbigkY29tcGlsZVByb3ZpZGVyKSB7CiAgICAgICAgLy8gY29uZmlndXJlIG5ldyAnY29tcGlsZScgZGlyZWN0aXZlIGJ5IHBhc3NpbmcgYSBkaXJlY3RpdmUKICAgICAgICAvLyBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBpbmplY3RzIHRoZSAnJGNvbXBpbGUnCiAgICAgICAgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoJ2NvbXBpbGUnLCBmdW5jdGlvbigkY29tcGlsZSkgewogICAgICAgICAgLy8gZGlyZWN0aXZlIGZhY3RvcnkgY3JlYXRlcyBhIGxpbmsgZnVuY3Rpb24KICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKAogICAgICAgICAgICAgIGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgLy8gd2F0Y2ggdGhlICdjb21waWxlJyBleHByZXNzaW9uIGZvciBjaGFuZ2VzCiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuJGV2YWwoYXR0cnMuY29tcGlsZSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gY2hhbmdlcwogICAgICAgICAgICAgICAgLy8gYXNzaWduIGl0IGludG8gdGhlIGN1cnJlbnQgRE9NCiAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodmFsdWUpOwoKICAgICAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIG5ldyBET00gYW5kIGxpbmsgaXQgdG8gdGhlIGN1cnJlbnQKICAgICAgICAgICAgICAgIC8vIHNjb3BlLgogICAgICAgICAgICAgICAgLy8gTk9URTogd2Ugb25seSBjb21waWxlIC5jaGlsZE5vZGVzIHNvIHRoYXQKICAgICAgICAgICAgICAgIC8vIHdlIGRvbid0IGdldCBpbnRvIGluZmluaXRlIGxvb3AgY29tcGlsaW5nIG91cnNlbHZlcwogICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShzY29wZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgfTsKICAgICAgICB9KQogICAgICB9KTsKCiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAkc2NvcGUubmFtZSA9ICdBbmd1bGFyJzsKICAgICAgICAkc2NvcGUuaHRtbCA9ICdIZWxsbyB7e25hbWV9fSc7CiAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCBuZy1tb2RlbD0ibmFtZSI+IDxicj4KICAgICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgICA8ZGl2IGNvbXBpbGU9Imh0bWwiPjwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgYXV0byBjb21waWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudCgnZGl2W2NvbXBpbGVdJykudGV4dCgpKS50b0JlKCdIZWxsbyBBbmd1bGFyJyk7CiAgICAgICBpbnB1dCgnaHRtbCcpLmVudGVyKCd7e25hbWV9fSEnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0FuZ3VsYXIhJyk7CiAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfERPTUVsZW1lbnR9IGVsZW1lbnQgRWxlbWVudCBvciBIVE1MIHN0cmluZyB0byBjb21waWxlIGludG8gYSB0ZW1wbGF0ZSBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBkaXJlY3RpdmVzLgogICAgICogQHBhcmFtIHtudW1iZXJ9IG1heFByaW9yaXR5IG9ubHkgYXBwbHkgZGlyZWN0aXZlcyBsb3dlciB0aGVuIGdpdmVuIHByaW9yaXR5IChPbmx5IGVmZmVjdHMgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgcm9vdCBlbGVtZW50KHMpLCBub3QgdGhlaXIgY2hpbGRyZW4pCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc2NvcGVbLCBjbG9uZUF0dGFjaEZuXSl9IGEgbGluayBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGJpbmQgdGVtcGxhdGUKICAgICAqIChhIERPTSBlbGVtZW50L3RyZWUpIHRvIGEgc2NvcGUuIFdoZXJlOgogICAgICoKICAgICAqICAqIGBzY29wZWAgLSBBIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSB0byBiaW5kIHRvLgogICAgICogICogYGNsb25lQXR0YWNoRm5gIC0gSWYgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLCB0aGVuIHRoZSBsaW5rIGZ1bmN0aW9uIHdpbGwgY2xvbmUgdGhlCiAgICAgKiAgICAgICAgICAgICAgIGB0ZW1wbGF0ZWAgYW5kIGNhbGwgdGhlIGBjbG9uZUF0dGFjaEZuYCBmdW5jdGlvbiBhbGxvd2luZyB0aGUgY2FsbGVyIHRvIGF0dGFjaCB0aGUKICAgICAqICAgICAgICAgICAgICAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAgICAgKiAgICAgICAgICAgICAgIGNhbGxlZCBhczogPGJyPiBgY2xvbmVBdHRhY2hGbihjbG9uZWRFbGVtZW50LCBzY29wZSlgIHdoZXJlOgogICAgICoKICAgICAqICAgICAgKiBgY2xvbmVkRWxlbWVudGAgLSBpcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBgZWxlbWVudGAgcGFzc2VkIGludG8gdGhlIGNvbXBpbGVyLgogICAgICogICAgICAqIGBzY29wZWAgLSBpcyB0aGUgY3VycmVudCBzY29wZSB3aXRoIHdoaWNoIHRoZSBsaW5raW5nIGZ1bmN0aW9uIGlzIHdvcmtpbmcgd2l0aC4KICAgICAqCiAgICAgKiBDYWxsaW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHJldHVybnMgdGhlIGVsZW1lbnQgb2YgdGhlIHRlbXBsYXRlLiBJdCBpcyBlaXRoZXIgdGhlIG9yaWdpbmFsIGVsZW1lbnQKICAgICAqIHBhc3NlZCBpbiwgb3IgdGhlIGNsb25lIG9mIHRoZSBlbGVtZW50IGlmIHRoZSBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQWZ0ZXIgbGlua2luZyB0aGUgdmlldyBpcyBub3QgdXBkYXRlZCB1bnRpbCBhZnRlciBhIGNhbGwgdG8gJGRpZ2VzdCB3aGljaCB0eXBpY2FsbHkgaXMgZG9uZSBieQogICAgICogQW5ndWxhciBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIElmIHlvdSBuZWVkIGFjY2VzcyB0byB0aGUgYm91bmQgdmlldywgdGhlcmUgYXJlIHR3byB3YXlzIHRvIGRvIGl0OgogICAgICoKICAgICAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogICAgICogICBiZWZvcmUgeW91IHNlbmQgdGhlbSB0byB0aGUgY29tcGlsZXIgYW5kIGtlZXAgdGhpcyByZWZlcmVuY2UgYXJvdW5kLgogICAgICogICA8cHJlPgogICAgICogICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxwPnt7dG90YWx9fTwvcD4nKShzY29wZSk7CiAgICAgKiAgIDwvcHJlPgogICAgICoKICAgICAqIC0gaWYgb24gdGhlIG90aGVyIGhhbmQsIHlvdSBuZWVkIHRoZSBlbGVtZW50IHRvIGJlIGNsb25lZCwgdGhlIHZpZXcgcmVmZXJlbmNlIGZyb20gdGhlIG9yaWdpbmFsCiAgICAgKiAgIGV4YW1wbGUgd291bGQgbm90IHBvaW50IHRvIHRoZSBjbG9uZSwgYnV0IHJhdGhlciB0byB0aGUgb3JpZ2luYWwgdGVtcGxhdGUgdGhhdCB3YXMgY2xvbmVkLiBJbgogICAgICogICB0aGlzIGNhc2UsIHlvdSBjYW4gYWNjZXNzIHRoZSBjbG9uZSB2aWEgdGhlIGNsb25lQXR0YWNoRm46CiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIHRlbXBsYXRlSFRNTCA9IGFuZ3VsYXIuZWxlbWVudCgnPHA+e3t0b3RhbH19PC9wPicpLAogICAgICogICAgICAgICBzY29wZSA9IC4uLi47CiAgICAgKgogICAgICogICAgIHZhciBjbG9uZWRFbGVtZW50ID0gJGNvbXBpbGUodGVtcGxhdGVIVE1MKShzY29wZSwgZnVuY3Rpb24oY2xvbmVkRWxlbWVudCwgc2NvcGUpIHsKICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICogICAgIH0pOwogICAgICoKICAgICAqICAgICAvL25vdyB3ZSBoYXZlIHJlZmVyZW5jZSB0byB0aGUgY2xvbmVkIERPTSB2aWEgYGNsb25lYAogICAgICogICA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogRm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0aGUgY29tcGlsZXIgd29ya3MsIHNlZSB0aGUKICAgICAqIHtAbGluayBndWlkZS9jb21waWxlciBBbmd1bGFyIEhUTUwgQ29tcGlsZXJ9IHNlY3Rpb24gb2YgdGhlIERldmVsb3BlciBHdWlkZS4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqLwogICAgJENvbXBpbGVQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJENvbXBpbGVQcm92aWRlcigkcHJvdmlkZSkgewogICAgICAgIHZhciBoYXNEaXJlY3RpdmVzID0ge30sCiAgICAgICAgICAgIFN1ZmZpeCA9ICdEaXJlY3RpdmUnLAogICAgICAgICAgICBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAgPSAvXlxzKmRpcmVjdGl2ZVw6XHMqKFtcZFx3XC1fXSspXHMrKC4qKSQvLAogICAgICAgICAgICBDTEFTU19ESVJFQ1RJVkVfUkVHRVhQID0gLygoW1xkXHdcLV9dKykoPzpcOihbXjtdKykpPzs/KS8sCiAgICAgICAgICAgIE1VTFRJX1JPT1RfVEVNUExBVEVfRVJST1IgPSAnVGVtcGxhdGUgbXVzdCBoYXZlIGV4YWN0bHkgb25lIHJvb3QgZWxlbWVudC4gd2FzOiAnLAogICAgICAgICAgICB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSAvXlxzKihodHRwcz98ZnRwfG1haWx0b3xmaWxlKTovOwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVnaXN0ZXIgYSBuZXcgZGlyZWN0aXZlcyB3aXRoIHRoZSBjb21waWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGRpcmVjdGl2ZSBpbiBjYW1lbC1jYXNlLiAoaWUgPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaCB3aWxsIG1hdGNoIGFzCiAgICAgICAgICogICAgICAgICAgICAgICAgPGNvZGU+bmctYmluZDwvY29kZT4pLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdHJveSBmdW5jdGlvbi4gU2VlIHtAbGluayBndWlkZS9kaXJlY3RpdmV9IGZvciBtb3JlCiAgICAgICAgICogICAgICAgICAgICAgICAgaW5mby4KICAgICAgICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5kaXJlY3RpdmUgPSBmdW5jdGlvbiByZWdpc3RlckRpcmVjdGl2ZShuYW1lLCBkaXJlY3RpdmVGYWN0b3J5KSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhuYW1lKSkgewogICAgICAgICAgICAgICAgYXNzZXJ0QXJnKGRpcmVjdGl2ZUZhY3RvcnksICdkaXJlY3RpdmUnKTsKICAgICAgICAgICAgICAgIGlmICghaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBTdWZmaXgsIFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmVzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGhhc0RpcmVjdGl2ZXNbbmFtZV0sIGZ1bmN0aW9uIChkaXJlY3RpdmVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZSA9ICRpbmplY3Rvci5pbnZva2UoZGlyZWN0aXZlRmFjdG9yeSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpcmVjdGl2ZS5jb21waWxlICYmIGRpcmVjdGl2ZS5saW5rKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUuY29tcGlsZSA9IHZhbHVlRm4oZGlyZWN0aXZlLmxpbmspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5wcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUubmFtZSA9IGRpcmVjdGl2ZS5uYW1lIHx8IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmUgfHwgKGRpcmVjdGl2ZS5jb250cm9sbGVyICYmIGRpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKGRpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgICAgICAgICB9XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYXNEaXJlY3RpdmVzW25hbWVdLnB1c2goZGlyZWN0aXZlRmFjdG9yeSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG5hbWUsIHJldmVyc2VQYXJhbXMocmVnaXN0ZXJEaXJlY3RpdmUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlciN1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAgICAgICAqIHVybHMgZHVyaW5nIGFbaHJlZl0gc2FuaXRpemF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgICAgICAgKgogICAgICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gYVtocmVmXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvIGFuCiAgICAgICAgICogYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0YCByZWd1bGFyCiAgICAgICAgICogZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UgdGhlCiAgICAgICAgICogYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXQgaXMgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICAgICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uIChyZWdleHApIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgICAgICAgICB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbCiAgICAgICAgICAgICckaW5qZWN0b3InLCAnJGludGVycG9sYXRlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRwYXJzZScsCiAgICAgICAgICAgICckY29udHJvbGxlcicsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRpbnRlcnBvbGF0ZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHBhcnNlLCAkY29udHJvbGxlciwgJHJvb3RTY29wZSwgJGRvY3VtZW50KSB7CgogICAgICAgICAgICAgICAgdmFyIEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyID0gYXR0ciB8fCB7fTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgQXR0cmlidXRlcy5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogU2V0IGEgbm9ybWFsaXplZCBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgaW4gYSB3YXkgc3VjaCB0aGF0IGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKQogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGJvb2xlYW59IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuIElmIGBudWxsYCBhdHRyaWJ1dGUgd2lsbCBiZSBkZWxldGVkLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF0dHJOYW1lIE9wdGlvbmFsIG5vbmUgbm9ybWFsaXplZCBuYW1lLiBEZWZhdWx0cyB0byBrZXkuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHNldDogZnVuY3Rpb24gKGtleSwgdmFsdWUsIHdyaXRlQXR0ciwgYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJvb2xlYW5LZXkgPSBnZXRCb29sZWFuQXR0ck5hbWUodGhpcy4kJGVsZW1lbnRbMF0sIGtleSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IHRoaXMuJCRvYnNlcnZlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmFsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvb2xlYW5LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnByb3Aoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGJvb2xlYW5LZXk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNsYXRlIG5vcm1hbGl6ZWQga2V5IHRvIGFjdHVhbCBrZXkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gdGhpcy4kYXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lID0gc25ha2VfY2FzZShrZXksICctJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzYW5pdGl6ZSBhW2hyZWZdIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZU5hbWVfKHRoaXMuJCRlbGVtZW50WzBdKSA9PT0gJ0EnICYmIGtleSA9PT0gJ2hyZWYnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmxTYW5pdGl6YXRpb25Ob2RlLnNldEF0dHJpYnV0ZSgnaHJlZicsIHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBocmVmIHByb3BlcnR5IGFsd2F5cyByZXR1cm5zIG5vcm1hbGl6ZWQgYWJzb2x1dGUgdXJsLCBzbyB3ZSBjYW4gbWF0Y2ggYWdhaW5zdCB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmFsID0gdXJsU2FuaXRpemF0aW9uTm9kZS5ocmVmOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFub3JtYWxpemVkVmFsLm1hdGNoKHVybFNhbml0aXphdGlvbldoaXRlbGlzdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZSA9ICd1bnNhZmU6JyArIG5vcm1hbGl6ZWRWYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAod3JpdGVBdHRyICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQuYXR0cihhdHRyTmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBmaXJlIG9ic2VydmVycwogICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyAmJiBmb3JFYWNoKCQkb2JzZXJ2ZXJzW2tleV0sIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBPYnNlcnZlIGFuIGludGVycG9sYXRlZCBhdHRyaWJ1dGUuCiAgICAgICAgICAgICAgICAgICAgICogVGhlIG9ic2VydmVyIHdpbGwgbmV2ZXIgYmUgY2FsbGVkLCBpZiBnaXZlbiBhdHRyaWJ1dGUgaXMgbm90IGludGVycG9sYXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkgLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil9IGZuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgdGhlIGF0dHJpYnV0ZSB2YWx1ZSBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigqKX0gdGhlIGBmbmAgRnVuY3Rpb24gcGFzc2VkIGluLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRvYnNlcnZlOiBmdW5jdGlvbiAoa2V5LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCRvYnNlcnZlcnMgPSAoYXR0cnMuJCRvYnNlcnZlcnMgfHwgKGF0dHJzLiQkb2JzZXJ2ZXJzID0ge30pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyBvbmUgcmVnaXN0ZXJlZCBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiwgc28gbGV0cyBjYWxsIGl0IG1hbnVhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oYXR0cnNba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgdXJsU2FuaXRpemF0aW9uTm9kZSA9ICRkb2N1bWVudFswXS5jcmVhdGVFbGVtZW50KCdhJyksCiAgICAgICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBlbmRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sKCksCiAgICAgICAgICAgICAgICAgICAgZGVub3JtYWxpemVUZW1wbGF0ZSA9IChzdGFydFN5bWJvbCA9PSAne3snIHx8IGVuZFN5bWJvbCA9PSAnfX0nKQogICAgICAgICAgICAgICAgICAgICAgICA/IGlkZW50aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gZGVub3JtYWxpemVUZW1wbGF0ZSh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZTsKCiAgICAgICAgICAgICAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IGFsd2F5cyByZXdyYXBzLCB3aGVyZWFzIHdlIG5lZWQgdG8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNlbGVjdG9yIHNvIHRoYXQgd2UgY2FuIG1vZGlmeSBpdC4KICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlcyA9IGpxTGl0ZSgkY29tcGlsZU5vZGVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAgICAgICAgICAgICAgIC8vIG5vdCBiZSBhYmxlIHRvIGF0dGFjaCBzY29wZSBkYXRhIHRvIHRoZW0sIHNvIHdlIHdpbGwgd3JhcCB0aGVtIGluIDxzcGFuPgogICAgICAgICAgICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24gKG5vZGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDMgLyogdGV4dCBub2RlICovICYmIG5vZGUubm9kZVZhbHVlLm1hdGNoKC9cUysvKSAvKiBub24tZW1wdHkgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZXNbaW5kZXhdID0ganFMaXRlKG5vZGUpLndyYXAoJzxzcGFuPjwvc3Bhbj4nKS5wYXJlbnQoKVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZhciBjb21wb3NpdGVMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLCBtYXhQcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnKHNjb3BlLCAnc2NvcGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW1wb3J0YW50ISE6IHdlIG11c3QgY2FsbCBvdXIganFMaXRlLmNsb25lKCkgc2luY2UgdGhlIGpRdWVyeSBvbmUgaXMgdHJ5aW5nIHRvIGJlIHNtYXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkbGlua05vZGUgPSBjbG9uZUNvbm5lY3RGbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCgkY29tcGlsZU5vZGVzKSAvLyBJTVBPUlRBTlQhISEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJGNvbXBpbGVOb2RlczsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBzY29wZSBvbmx5IHRvIG5vbi10ZXh0IG5vZGVzLgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSAkbGlua05vZGUubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSAkbGlua05vZGVbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxIC8qIGVsZW1lbnQgKi8gfHwgbm9kZS5ub2RlVHlwZSA9PSA5IC8qIGRvY3VtZW50ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxpbmtOb2RlLmVxKGkpLmRhdGEoJyRzY29wZScsIHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGxpbmtOb2RlLCAnbmctc2NvcGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsb25lQ29ubmVjdEZuKSBjbG9uZUNvbm5lY3RGbigkbGlua05vZGUsIHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvc2l0ZUxpbmtGbikgY29tcG9zaXRlTGlua0ZuKHNjb3BlLCAkbGlua05vZGUsICRsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkbGlua05vZGU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB3cm9uZ01vZGUobG9jYWxOYW1lLCBtb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIlVuc3VwcG9ydGVkICciICsgbW9kZSArICInIGZvciAnIiArIGxvY2FsTmFtZSArICInLiIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQ29tcGlsZSBmdW5jdGlvbiBtYXRjaGVzIGVhY2ggbm9kZSBpbiBub2RlTGlzdCBhZ2FpbnN0IHRoZSBkaXJlY3RpdmVzLiBPbmNlIGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbnMgcmV0dXJuIHZhbHVlcyAtIHRoZSBsaW5raW5nIGZ1bmN0aW9ucyAtIGFyZSBjb21iaW5lZCBpbnRvIGEgY29tcG9zaXRlIGxpbmtpbmcKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uLCB3aGljaCBpcyB0aGUgYSBsaW5raW5nIGZ1bmN0aW9uIGZvciB0aGUgbm9kZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGVMaXN0fSBub2RlTGlzdCBhbiBhcnJheSBvZiBub2RlcyBvciBOb2RlTGlzdCB0byBjb21waWxlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gJHJvb3RFbGVtZW50IElmIHRoZSBub2RlTGlzdCBpcyB0aGUgcm9vdCBvZiB0aGUgY29tcGlsYXRpb24gdHJlZSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHJvb3RFbGVtZW50IG11c3QgYmUgc2V0IHRoZSBqcUxpdGUgY29sbGVjdGlvbiBvZiB0aGUgY29tcGlsZSByb290LiBUaGlzIGlzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heCBkaXJlY3RpdmUgcHJpb3JpdHkKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHs/ZnVuY3Rpb259IEEgY29tcG9zaXRlIGxpbmtpbmcgZnVuY3Rpb24gb2YgYWxsIG9mIHRoZSBtYXRjaGVkIGRpcmVjdGl2ZXMgb3IgbnVsbC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZU5vZGVzKG5vZGVMaXN0LCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0ZucyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgZGlyZWN0aXZlcywgYXR0cnMsIGxpbmtGbkZvdW5kOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzID0gbmV3IEF0dHJpYnV0ZXMoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG11c3QgYWx3YXlzIHJlZmVyIHRvIG5vZGVMaXN0W2ldIHNpbmNlIHRoZSBub2RlcyBjYW4gYmUgcmVwbGFjZWQgdW5kZXJuZWF0aCB1cy4KICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKG5vZGVMaXN0W2ldLCBbXSwgYXR0cnMsIG1heFByaW9yaXR5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSAoZGlyZWN0aXZlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBub2RlTGlzdFtpXSwgYXR0cnMsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnRlcm1pbmFsIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBjb21waWxlTm9kZXMobm9kZUxpc3RbaV0uY2hpbGROb2RlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPyBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgOiB0cmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0Zucy5wdXNoKG5vZGVMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2goY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5Gb3VuZCA9IChsaW5rRm5Gb3VuZCB8fCBub2RlTGlua0ZuIHx8IGNoaWxkTGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBhIGxpbmtpbmcgZnVuY3Rpb24gaWYgd2UgaGF2ZSBmb3VuZCBhbnl0aGluZywgbnVsbCBvdGhlcndpc2UKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlua0ZuRm91bmQgPyBjb21wb3NpdGVMaW5rRm4gOiBudWxsOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgbm9kZSwgY2hpbGRTY29wZSwgY2hpbGRUcmFuc2NsdWRlRm4sIGksIGlpLCBuOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSBub2RlTGlzdCBzbyB0aGF0IGxpbmtpbmcgZG9lc24ndCBicmVhayBkdWUgdG8gbGl2ZSBsaXN0IHVwZGF0ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFibGVOb2RlTGlzdCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IG5vZGVMaXN0Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWJsZU5vZGVMaXN0LnB1c2gobm9kZUxpc3RbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBuID0gMCwgaWkgPSBsaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBzdGFibGVOb2RlTGlzdFtuXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IGxpbmtGbnNbaSsrXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZUxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KGlzT2JqZWN0KG5vZGVMaW5rRm4uc2NvcGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKG5vZGUpLmRhdGEoJyRzY29wZScsIGNoaWxkU2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBub2RlTGlua0ZuLnRyYW5zY2x1ZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkVHJhbnNjbHVkZUZuIHx8ICghYm91bmRUcmFuc2NsdWRlRm4gJiYgdHJhbnNjbHVkZUZuKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBjaGlsZFNjb3BlLCBub2RlLCAkcm9vdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoY2xvbmVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNjbHVkZVNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlU2NvcGUuJCR0cmFuc2NsdWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJhbnNjbHVkZUZuKHRyYW5zY2x1ZGVTY29wZSwgY2xvbmVGbikuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kKCckZGVzdHJveScsIGJpbmQodHJhbnNjbHVkZVNjb3BlLCB0cmFuc2NsdWRlU2NvcGUuJGRlc3Ryb3kpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkoY2hpbGRUcmFuc2NsdWRlRm4gfHwgdHJhbnNjbHVkZUZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRMaW5rRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbihzY29wZSwgbm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBMb29rcyBmb3IgZGlyZWN0aXZlcyBvbiB0aGUgZ2l2ZW4gbm9kZSBhbmQgYWRkcyB0aGVtIHRvIHRoZSBkaXJlY3RpdmUgY29sbGVjdGlvbiB3aGljaCBpcwogICAgICAgICAgICAgICAgICogc29ydGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSBub2RlIE5vZGUgdG8gc2VhcmNoLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGRpcmVjdGl2ZXMgQW4gYXJyYXkgdG8gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFkZGVkIHRvLiBUaGlzIGFycmF5IGlzIHNvcnRlZCBiZWZvcmUKICAgICAgICAgICAgICAgICAqICAgICAgICB0aGUgZnVuY3Rpb24gcmV0dXJucy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSBhdHRycyBUaGUgc2hhcmVkIGF0dHJzIG9iamVjdCB3aGljaCBpcyB1c2VkIHRvIHBvcHVsYXRlIHRoZSBub3JtYWxpemVkIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbGxlY3REaXJlY3RpdmVzKG5vZGUsIGRpcmVjdGl2ZXMsIGF0dHJzLCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU7CgogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOiAvKiBFbGVtZW50ICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1c2UgdGhlIG5vZGUgbmFtZTogPGRpcmVjdGl2ZT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5vcm1hbGl6ZShub2RlTmFtZV8obm9kZSkudG9Mb3dlckNhc2UoKSksICdFJywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciB0aGUgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ciwgbmFtZSwgbk5hbWUsIHZhbHVlLCBuQXR0cnMgPSBub2RlLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gMCwgamogPSBuQXR0cnMgJiYgbkF0dHJzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gbkF0dHJzW2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnNwZWNpZmllZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gYXR0ci5uYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc01hcFtuTmFtZV0gPSBuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB2YWx1ZSA9IHRyaW0oKG1zaWUgJiYgbmFtZSA9PSAnaHJlZicpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGRlY29kZVVSSUNvbXBvbmVudChub2RlLmdldEF0dHJpYnV0ZShuYW1lLCAyKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnZXRCb29sZWFuQXR0ck5hbWUobm9kZSwgbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cnVlOyAvLyBwcmVzZW5jZSBtZWFucyB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0EnLCBtYXhQcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSBjbGFzcyBhcyBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGNsYXNzTmFtZSkgJiYgY2xhc3NOYW1lICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IENMQVNTX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0MnLCBtYXhQcmlvcml0eSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbM10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5zdWJzdHIobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6IC8qIFRleHQgTm9kZSAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6IC8qIENvbW1lbnQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHR1cm5zIG91dCB0aGF0IHVuZGVyIHNvbWUgY2lyY3Vtc3RhbmNlcyBJRTkgdGhyb3dzIGVycm9ycyB3aGVuIG9uZSBhdHRlbXB0cyB0byByZWFkIGNvbW1lbnQncyBub2RlIHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1c3QgaWdub3JlIGl0IGFuZCBjb250aW51ZS4gKENhbid0IHNlZW0gdG8gcmVwcm9kdWNlIGluIHRlc3QgY2FzZS4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBPbmNlIHRoZSBkaXJlY3RpdmVzIGhhdmUgYmVlbiBjb2xsZWN0ZWQsIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhpcyBtZXRob2QKICAgICAgICAgICAgICAgICAqIGlzIHJlc3BvbnNpYmxlIGZvciBpbmxpbmluZyBkaXJlY3RpdmUgdGVtcGxhdGVzIGFzIHdlbGwgYXMgdGVybWluYXRpbmcgdGhlIGFwcGxpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBvZiB0aGUgZGlyZWN0aXZlcyBpZiB0aGUgdGVybWluYWwgZGlyZWN0aXZlIGhhcyBiZWVuIHJlYWNoZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZGlyZWN0aXZlcyBBcnJheSBvZiBjb2xsZWN0ZWQgZGlyZWN0aXZlcyB0byBleGVjdXRlIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKiAgICAgICAgdGhpcyBuZWVkcyB0byBiZSBwcmUtc29ydGVkIGJ5IHByaW9yaXR5IG9yZGVyLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtOb2RlfSBjb21waWxlTm9kZSBUaGUgcmF3IERPTSBub2RlIHRvIGFwcGx5IHRoZSBjb21waWxlIGZ1bmN0aW9ucyB0bwogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlQXR0cnMgVGhlIHNoYXJlZCBhdHRyaWJ1dGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pRTGl0ZX0ganFDb2xsZWN0aW9uIElmIHdlIGFyZSB3b3JraW5nIG9uIHRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUgdGhlbiB0aGlzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgYXJndW1lbnQgaGFzIHRoZSByb290IGpxTGl0ZSBhcnJheSBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzIG9uIGl0LgogICAgICAgICAgICAgICAgICogQHJldHVybnMgbGlua0ZuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgdHJhbnNjbHVkZUZuLCBqcUNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVybWluYWxQcmlvcml0eSA9IC1OdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgICAgICAgICAgICAgICBwcmVMaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RMaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9IGpxTGl0ZShjb21waWxlTm9kZSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IHRyYW5zY2x1ZGVGbiwKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlVmFsdWU7CgogICAgICAgICAgICAgICAgICAgIC8vIGV4ZWN1dGVzIGFsbCBkaXJlY3RpdmVzIG9uIHRoZSBjdXJyZW50IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0gZGlyZWN0aXZlc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlcm1pbmFsUHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBwcmV2ZW50IGZ1cnRoZXIgcHJvY2Vzc2luZyBvZiBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5zY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoZGlyZWN0aXZlVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRjb21waWxlTm9kZSwgJ25nLWlzb2xhdGUtc2NvcGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctc2NvcGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbmV3U2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlLm5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXMgPSBjb250cm9sbGVyRGlyZWN0aXZlcyB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCInIiArIGRpcmVjdGl2ZU5hbWUgKyAiJyBjb250cm9sbGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0gPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndHJhbnNjbHVzaW9uJywgdHJhbnNjbHVkZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNjbHVkZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPT0gJ2VsZW1lbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxTGl0ZShkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgJyArIGRpcmVjdGl2ZU5hbWUgKyAnOiAnICsgdGVtcGxhdGVBdHRyc1tkaXJlY3RpdmVOYW1lXSArICcgJykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwganFMaXRlKCR0ZW1wbGF0ZVswXSksIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4sIHRlcm1pbmFsUHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoSlFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKCcnKTsgLy8gY2xlYXIgY29udGVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGRpcmVjdGl2ZVZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyaW0oZGlyZWN0aXZlVmFsdWUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKE1VTFRJX1JPT1RfVEVNUExBVEVfRVJST1IgKyBkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sICRjb21waWxlTm9kZSwgY29tcGlsZU5vZGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21iaW5lIGRpcmVjdGl2ZXMgZnJvbSB0aGUgb3JpZ2luYWwgbm9kZSBhbmQgZnJvbSB0aGUgdGVtcGxhdGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSB0YWtlIHRoZSBhcnJheSBvZiBkaXJlY3RpdmVzIGZvciB0aGlzIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIHNwbGl0IGl0IGludG8gdHdvIHBhcnRzLCB0aG9zZSB0aGF0IHdlcmUgYWxyZWFkeSBhcHBsaWVkIGFuZCB0aG9zZSB0aGF0IHdlcmVuJ3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGNvbGxlY3QgZGlyZWN0aXZlcyBmcm9tIHRoZSB0ZW1wbGF0ZSwgYWRkIHRoZW0gdG8gdGhlIHNlY29uZCBncm91cCBhbmQgc29ydCB0aGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBhcHBlbmQgdGhlIHNlY29uZCBncm91cCB3aXRoIG5ldyBkaXJlY3RpdmVzIHRvIHRoZSBmaXJzdCBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzLmNvbmNhdCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdERpcmVjdGl2ZXMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMuc3BsaWNlKGkgKyAxLCBkaXJlY3RpdmVzLmxlbmd0aCAtIChpICsgMSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3VGVtcGxhdGVBdHRycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0ZW1wbGF0ZUF0dHJzLCBuZXdUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoZGlyZWN0aXZlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuID0gY29tcGlsZVRlbXBsYXRlVXJsKGRpcmVjdGl2ZXMuc3BsaWNlKGksIGRpcmVjdGl2ZXMubGVuZ3RoIC0gaSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiwgJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBqcUNvbGxlY3Rpb24sIGRpcmVjdGl2ZS5yZXBsYWNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aXZlLmNvbXBpbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gZGlyZWN0aXZlLmNvbXBpbGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlua0ZuKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRMaW5rRm5zKG51bGwsIGxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsaW5rRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhsaW5rRm4ucHJlLCBsaW5rRm4ucG9zdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRjb21waWxlTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnRlcm1pbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBNYXRoLm1heCh0ZXJtaW5hbFByaW9yaXR5LCBkaXJlY3RpdmUucHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi5zY29wZSA9IG5ld1Njb3BlRGlyZWN0aXZlICYmIG5ld1Njb3BlRGlyZWN0aXZlLnNjb3BlOwogICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4udHJhbnNjbHVkZSA9IHRyYW5zY2x1ZGVEaXJlY3RpdmUgJiYgY2hpbGRUcmFuc2NsdWRlRm47CgogICAgICAgICAgICAgICAgICAgIC8vIG1pZ2h0IGJlIG5vcm1hbCBvciBkZWxheWVkIG5vZGVMaW5rRm4gZGVwZW5kaW5nIG9uIGlmIHRlbXBsYXRlVXJsIGlzIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZUxpbmtGbjsKCiAgICAgICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkTGlua0ZucyhwcmUsIHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMucHVzaChwcmUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RMaW5rRm5zLnB1c2gocG9zdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRDb250cm9sbGVycyhyZXF1aXJlLCAkZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsIHJldHJpZXZhbE1ldGhvZCA9ICdkYXRhJywgb3B0aW9uYWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHJlcXVpcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKHZhbHVlID0gcmVxdWlyZS5jaGFyQXQoMCkpID09ICdeJyB8fCB2YWx1ZSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlID0gcmVxdWlyZS5zdWJzdHIoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWV2YWxNZXRob2QgPSAnaW5oZXJpdGVkRGF0YSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAkZWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiTm8gY29udHJvbGxlcjogIiArIHJlcXVpcmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlcXVpcmUsIGZ1bmN0aW9uIChyZXF1aXJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaChnZXRDb250cm9sbGVycyhyZXF1aXJlLCAkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cnMsICRlbGVtZW50LCBpLCBpaSwgbGlua0ZuLCBjb250cm9sbGVyOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBpbGVOb2RlID09PSBsaW5rTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSB0ZW1wbGF0ZUF0dHJzOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBzaGFsbG93Q29weSh0ZW1wbGF0ZUF0dHJzLCBuZXcgQXR0cmlidXRlcyhqcUxpdGUobGlua05vZGUpLCB0ZW1wbGF0ZUF0dHJzLiRhdHRyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBhdHRycy4kJGVsZW1lbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgTE9DQUxfUkVHRVhQID0gL15ccyooW0A9Jl0pXHMqKFx3KilccyokLzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U2NvcGUgPSBzY29wZS4kcGFyZW50IHx8IHNjb3BlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnNjb3BlLCBmdW5jdGlvbiAoZGVmaW5pdG9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBkZWZpbml0b24ubWF0Y2goTE9DQUxfUkVHRVhQKSB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFsyXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCwgcGFyZW50U2V0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kJGlzb2xhdGVCaW5kaW5nc1tzY29wZU5hbWVdID0gbW9kZSArIGF0dHJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0AnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycy4kJG9ic2VydmVyc1thdHRyTmFtZV0uJCRzY29wZSA9IHBhcmVudFNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz0nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldCA9IHBhcmVudEdldC5hc3NpZ24gfHwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc2V0IHRoZSBjaGFuZ2UsIG9yIHdlIHdpbGwgdGhyb3cgdGhpcyBleGNlcHRpb24gb24gZXZlcnkgJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQocGFyZW50U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gKyBhdHRyc1thdHRyTmFtZV0gKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIChkaXJlY3RpdmU6ICcgKyBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSArICcpJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gcGFyZW50VmFsdWVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VmFsdWUgPSBwYXJlbnRHZXQocGFyZW50U2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IHNjb3BlW3Njb3BlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIG91dCBvZiBzeW5jIGFuZCBuZWVkIHRvIGNvcHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFZhbHVlICE9PSBsYXN0VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0KHBhcmVudFNjb3BlLCBwYXJlbnRWYWx1ZSA9IGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSBmdW5jdGlvbiAobG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChwYXJlbnRTY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUgKyAnOiAnICsgZGVmaW5pdG9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uIChkaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jYWxzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudDogJGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdHRyczogYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0cmFuc2NsdWRlOiBib3VuZFRyYW5zY2x1ZGVGbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlciA9PSAnQCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGF0dHJzW2RpcmVjdGl2ZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmRhdGEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29udHJvbGxlcihjb250cm9sbGVyLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBQUkVMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gcHJlTGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiA9IHByZUxpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFQ1VSU0lPTgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiAmJiBjaGlsZExpbmtGbihzY29wZSwgbGlua05vZGUuY2hpbGROb2RlcywgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBQT1NUTElOS0lORwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IHBvc3RMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbG9va3MgdXAgdGhlIGRpcmVjdGl2ZSBhbmQgZGVjb3JhdGVzIGl0IHdpdGggZXhjZXB0aW9uIGhhbmRsaW5nIGFuZCBwcm9wZXIgcGFyYW1ldGVycy4gV2UKICAgICAgICAgICAgICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZSBvZiB0aGUgZGlyZWN0aXZlIHRvIGxvb2sgdXAuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAgICAgICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICAgICAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgKiAgICogYENgOiBjbGFzcwogICAgICAgICAgICAgICAgICogICAqIGBNYDogY29tbWVudAogICAgICAgICAgICAgICAgICogQHJldHVybnMgdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGREaXJlY3RpdmUodERpcmVjdGl2ZXMsIG5hbWUsIGxvY2F0aW9uLCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGRpcmVjdGl2ZSwgZGlyZWN0aXZlcyA9ICRpbmplY3Rvci5nZXQobmFtZSArIFN1ZmZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobWF4UHJpb3JpdHkgPT09IHVuZGVmaW5lZCB8fCBtYXhQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogV2hlbiB0aGUgZWxlbWVudCBpcyByZXBsYWNlZCB3aXRoIEhUTUwgdGVtcGxhdGUgdGhlbiB0aGUgbmV3IGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgICAgICAgICAgICAgKiBUaGUgZGVzaXJlZCBlZmZlY3QgaXMgdG8gaGF2ZSBib3RoIG9mIHRoZSBhdHRyaWJ1dGVzIHByZXNlbnQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gc3JjIHNvdXJjZSBhdHRyaWJ1dGVzIChmcm9tIHRoZSBkaXJlY3RpdmUgdGVtcGxhdGUpCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0F0dHIgPSBzcmMuJGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgIGRzdEF0dHIgPSBkc3QuJGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgLy8gcmVhcHBseSB0aGUgb2xkIGF0dHJpYnV0ZXMgdG8gdGhlIG5ldyBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChkc3QsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyY1trZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKz0gKGtleSA9PT0gJ3N0eWxlJyA/ICc7JyA6ICcgJykgKyBzcmNba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdC4kc2V0KGtleSwgdmFsdWUsIHRydWUsIHNyY0F0dHJba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aGUgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIG9sZCBhdHRycyBvYmplY3QKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNyYywgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFsnY2xhc3MnXSA9IChkc3RbJ2NsYXNzJ10gPyBkc3RbJ2NsYXNzJ10gKyAnICcgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYXR0cignc3R5bGUnLCAkZWxlbWVudC5hdHRyKCdzdHlsZScpICsgJzsnICsgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdEF0dHJba2V5XSA9IHNyY0F0dHJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRBdHRycywgJHJvb3RFbGVtZW50LCByZXBsYWNlLCBjaGlsZFRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgIHZhciBsaW5rUXVldWUgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4sCiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlID0gZGlyZWN0aXZlcy5zaGlmdCgpLAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBmYWN0IHRoYXQgd2UgaGF2ZSB0byBjb3B5IGFuZCBwYXRjaCB0aGUgZGlyZWN0aXZlIHNlZW1zIHdyb25nIQogICAgICAgICAgICAgICAgICAgICAgICBkZXJpdmVkU3luY0RpcmVjdGl2ZSA9IGV4dGVuZCh7fSwgb3JpZ0FzeW5jRGlyZWN0aXZlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBudWxsLCB0ZW1wbGF0ZVVybDogbnVsbCwgdHJhbnNjbHVkZTogbnVsbCwgc2NvcGU6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKCcnKTsKCiAgICAgICAgICAgICAgICAgICAgJGh0dHAuZ2V0KG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCwge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29tcGlsZU5vZGUsIHRlbXBUZW1wbGF0ZUF0dHJzLCAkdGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGRlbm9ybWFsaXplVGVtcGxhdGUoY29udGVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArIHRyaW0oY29udGVudCkgKyAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiArIGNvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcFRlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsICRjb21waWxlTm9kZSwgY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3REaXJlY3RpdmVzKGNvbXBpbGVOb2RlLCBkaXJlY3RpdmVzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChjb250ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnVuc2hpZnQoZGVyaXZlZFN5bmNEaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4gPSBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRBdHRycywgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuID0gY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZVswXS5jaGlsZE5vZGVzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsaW5rUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBsaW5rUXVldWUucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gY29tcGlsZU5vZGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBKUUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGxpbmtSb290RWxlbWVudCwganFMaXRlKGJlZm9yZVRlbXBsYXRlTGlua05vZGUpLCBsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9KS4KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24gKHJlc3BvbnNlLCBjb2RlLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdGYWlsZWQgdG8gbG9hZCB0ZW1wbGF0ZTogJyArIGNvbmZpZy51cmwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlbGF5ZWROb2RlTGlua0ZuKGlnbm9yZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogU29ydGluZyBmdW5jdGlvbiBmb3IgYm91bmQgZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGIucHJpb3JpdHkgLSBhLnByaW9yaXR5OwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdNdWx0aXBsZSBkaXJlY3RpdmVzIFsnICsgcHJldmlvdXNEaXJlY3RpdmUubmFtZSArICcsICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgKyAnXSBhc2tpbmcgZm9yICcgKyB3aGF0ICsgJyBvbjogJyArIHN0YXJ0aW5nVGFnKGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCB0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZTogdmFsdWVGbihmdW5jdGlvbiB0ZXh0SW50ZXJwb2xhdGVMaW5rRm4oc2NvcGUsIG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gbm9kZS5wYXJlbnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSBwYXJlbnQuZGF0YSgnJGJpbmRpbmcnKSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncy5wdXNoKGludGVycG9sYXRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhwYXJlbnQuZGF0YSgnJGJpbmRpbmcnLCBiaW5kaW5ncyksICduZy1iaW5kaW5nJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlWzBdLm5vZGVWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh2YWx1ZSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgIC8vIG5vIGludGVycG9sYXRpb24gZm91bmQgLT4gaWdub3JlCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIGF0dHJJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gKGF0dHIuJCRvYnNlcnZlcnMgfHwgKGF0dHIuJCRvYnNlcnZlcnMgPSB7fSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lID09PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBpbnRlcnBvbGF0ZSBjbGFzc2VzIGFnYWluLCBpbiB0aGUgY2FzZSB0aGUgZWxlbWVudCB3YXMgcmVwbGFjZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgdGhlcmVmb3JlIHRoZSB0d28gY2xhc3MgYXR0cnMgZ290IG1lcmdlZCAtIHdlIHdhbnQgdG8gaW50ZXJwb2xhdGUgdGhlIHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoYXR0cltuYW1lXSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cltuYW1lXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICgkJG9ic2VydmVyc1tuYW1lXSB8fCAoJCRvYnNlcnZlcnNbbmFtZV0gPSBbXSkpLiQkaW50ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGF0dHIuJCRvYnNlcnZlcnMgJiYgYXR0ci4kJG9ic2VydmVyc1tuYW1lXS4kJHNjb3BlIHx8IHNjb3BlKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogVGhpcyBpcyBhIHNwZWNpYWwganFMaXRlLnJlcGxhY2VXaXRoLCB3aGljaCBjYW4gcmVwbGFjZSBpdGVtcyB3aGljaAogICAgICAgICAgICAgICAgICogaGF2ZSBubyBwYXJlbnRzLCBwcm92aWRlZCB0aGF0IHRoZSBjb250YWluaW5nIGpxTGl0ZSBjb2xsZWN0aW9uIGlzIHByb3ZpZGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlPX0gJHJvb3RFbGVtZW50IFRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUuIFVzZWQgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICAgICAgICAgICAgICogICAgaW4gdGhlIHJvb3Qgb2YgdGhlIHRyZWUuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pxTGl0ZX0gJGVsZW1lbnQgVGhlIGpxTGl0ZSBlbGVtZW50IHdoaWNoIHdlIGFyZSBnb2luZyB0byByZXBsYWNlLiBXZSBrZWVwIHRoZSBzaGVsbCwKICAgICAgICAgICAgICAgICAqICAgIGJ1dCByZXBsYWNlIGl0cyBET00gbm9kZSByZWZlcmVuY2UuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IG5ld05vZGUgVGhlIG5ldyBET00gbm9kZS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkZWxlbWVudCwgbmV3Tm9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBvbGROb2RlID0gJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IG9sZE5vZGUucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgaSwgaWk7CgogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBvbGROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50W2ldID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbmV3Tm9kZVtqcUxpdGUuZXhwYW5kb10gPSBvbGROb2RlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudFswXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhbGwgYWNjZXB0ZWQgZGlyZWN0aXZlcyBmb3JtYXQgaW50byBwcm9wZXIgZGlyZWN0aXZlIG5hbWUuCiAgICAgKiBBbGwgb2YgdGhlc2Ugd2lsbCBiZWNvbWUgJ215RGlyZWN0aXZlJzoKICAgICAqICAgbXk6RGlSZWN0aXZlCiAgICAgKiAgIG15LWRpcmVjdGl2ZQogICAgICogICB4LW15LWRpcmVjdGl2ZQogICAgICogICBkYXRhLW15OmRpcmVjdGl2ZQogICAgICoKICAgICAqIEFsc28gdGhlcmUgaXMgc3BlY2lhbCBjYXNlIGZvciBNb3ogcHJlZml4IHN0YXJ0aW5nIHdpdGggdXBwZXIgY2FzZSBsZXR0ZXIuCiAgICAgKiBAcGFyYW0gbmFtZSBOYW1lIHRvIG5vcm1hbGl6ZQogICAgICovCiAgICBmdW5jdGlvbiBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSkgewogICAgICAgIHJldHVybiBjYW1lbENhc2UobmFtZS5yZXBsYWNlKFBSRUZJWF9SRUdFWFAsICcnKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaGFyZWQgb2JqZWN0IGJldHdlZW4gZGlyZWN0aXZlIGNvbXBpbGUgLyBsaW5raW5nIGZ1bmN0aW9ucyB3aGljaCBjb250YWlucyBub3JtYWxpemVkIERPTSBlbGVtZW50CiAgICAgKiBhdHRyaWJ1dGVzLiBUaGUgdGhlIHZhbHVlcyByZWZsZWN0IGN1cnJlbnQgYmluZGluZyBzdGF0ZSBge3sgfX1gLiBUaGUgbm9ybWFsaXphdGlvbiBpcyBuZWVkZWQKICAgICAqIHNpbmNlIGFsbCBvZiB0aGVzZSBhcmUgdHJlYXRlZCBhcyBlcXVpdmFsZW50IGluIEFuZ3VsYXI6CiAgICAgKgogICAgICogICAgICAgICAgPHNwYW4gbmc6YmluZD0iYSIgbmctYmluZD0iYSIgZGF0YS1uZy1iaW5kPSJhIiB4LW5nLWJpbmQ9ImEiPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyCiAgICAgKiBAcHJvcGVydHlPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQHJldHVybnMge29iamVjdH0gQSBtYXAgb2YgRE9NIGVsZW1lbnQgYXR0cmlidXRlIG5hbWVzIHRvIHRoZSBub3JtYWxpemVkIG5hbWUuIFRoaXMgaXMKICAgICAqICAgICAgICAgIG5lZWRlZCB0byBkbyByZXZlcnNlIGxvb2t1cCBmcm9tIG5vcm1hbGl6ZWQgbmFtZSBiYWNrIHRvIGFjdHVhbCBuYW1lLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkc2V0CiAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0IERPTSBlbGVtZW50IGF0dHJpYnV0ZSB2YWx1ZS4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTm9ybWFsaXplZCBlbGVtZW50IGF0dHJpYnV0ZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBtb2RpZnkuIFRoZSBuYW1lIGlzCiAgICAgKiAgICAgICAgICByZXZlcnMgdHJhbnNsYXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyICRhdHRyfQogICAgICogICAgICAgICAgcHJvcGVydHkgdG8gdGhlIG9yaWdpbmFsIG5hbWUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVmFsdWUgdG8gc2V0IHRoZSBhdHRyaWJ1dGUgdG8uCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBDbG9zdXJlIGNvbXBpbGVyIHR5cGUgaW5mb3JtYXRpb24KICAgICAqLwoKICAgIGZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwgLyogTm9kZUxpc3QgKi8gbm9kZUxpc3QsIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgfQoKICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigvKiBub2Rlc2V0TGlua2luZ0ZuICovIG5vZGVzZXRMaW5raW5nRm4sIC8qIGFuZ3VsYXIuU2NvcGUgKi8gc2NvcGUsIC8qIE5vZGUgKi8gbm9kZSwgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXIgc2VydmljZX0gaXMgdXNlZCBieSBBbmd1bGFyIHRvIGNyZWF0ZSBuZXcKICAgICAqIGNvbnRyb2xsZXJzLgogICAgICoKICAgICAqIFRoaXMgcHJvdmlkZXIgYWxsb3dzIGNvbnRyb2xsZXIgcmVnaXN0cmF0aW9uIHZpYSB0aGUKICAgICAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyIHJlZ2lzdGVyfSBtZXRob2QuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDb250cm9sbGVyUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNvbnRyb2xsZXJzID0ge307CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5fSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZuIChvcHRpb25hbGx5IGRlY29yYXRlZCB3aXRoIERJCiAgICAgICAgICogICAgYW5ub3RhdGlvbnMgaW4gdGhlIGFycmF5IG5vdGF0aW9uKS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXJzLCBuYW1lKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udHJvbGxlcnNbbmFtZV0gPSBjb25zdHJ1Y3RvcjsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckd2luZG93JywgZnVuY3Rpb24gKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlcgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGgge0BsaW5rIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgKICAgICAgICAgICAgICogQkMgdmVyc2lvbn0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGNvbnN0cnVjdG9yLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhjb25zdHJ1Y3RvcikpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICAgICAgICAgIGNvbnN0cnVjdG9yID0gY29udHJvbGxlcnMuaGFzT3duUHJvcGVydHkobmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgPyBjb250cm9sbGVyc1tuYW1lXQogICAgICAgICAgICAgICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBuYW1lLCB0cnVlKSB8fCBnZXR0ZXIoJHdpbmRvdywgbmFtZSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGNvbnN0cnVjdG9yLCBuYW1lLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yLCBsb2NhbHMpOwogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGRvY3VtZW50CiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSB7QGxpbmsgYW5ndWxhci5lbGVtZW50IGpRdWVyeSAobGl0ZSl9LXdyYXBwZWQgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvdy5kb2N1bWVudGAKICAgICAqIGVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICREb2N1bWVudFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uICh3aW5kb3cpIHsKICAgICAgICAgICAgcmV0dXJuIGpxTGl0ZSh3aW5kb3cuZG9jdW1lbnQpOwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kZXhjZXB0aW9uSGFuZGxlcgogICAgICogQHJlcXVpcmVzICRsb2cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEFueSB1bmNhdWdodCBleGNlcHRpb24gaW4gYW5ndWxhciBleHByZXNzaW9ucyBpcyBkZWxlZ2F0ZWQgdG8gdGhpcyBzZXJ2aWNlLgogICAgICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAgICAgKiB0aGUgYnJvd3NlciBjb25zb2xlLgogICAgICoKICAgICAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZGVuIGJ5CiAgICAgKiB7QGxpbmsgbmdNb2NrLiRleGNlcHRpb25IYW5kbGVyIG1vY2sgJGV4Y2VwdGlvbkhhbmRsZXJ9IHdoaWNoIGFpZHMgaW4gdGVzdGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Vycm9yfSBleGNlcHRpb24gRXhjZXB0aW9uIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXJyb3IuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGNhdXNlIG9wdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjb250ZXh0IGluIHdoaWNoCiAgICAgKiAgICAgICB0aGUgZXJyb3Igd2FzIHRocm93bi4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckbG9nJywgZnVuY3Rpb24gKCRsb2cpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChleGNlcHRpb24sIGNhdXNlKSB7CiAgICAgICAgICAgICAgICAkbG9nLmVycm9yLmFwcGx5KCRsb2csIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGludGVycG9sYXRpb24gbWFya3VwLiBEZWZhdWx0cyB0byBge3tgIGFuZCBgfX1gLgogICAgICovCiAgICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogICAgICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIGVuZGluZyBzeW1ib2wgdG8uCiAgICAgICAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgZnVuY3Rpb24gKCRwYXJzZSkgewogICAgICAgICAgICB2YXIgc3RhcnRTeW1ib2xMZW5ndGggPSBzdGFydFN5bWJvbC5sZW5ndGgsCiAgICAgICAgICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcGFyc2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgICAgICAgICAqIEhUTUwge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSBzZXJ2aWNlIGZvciBkYXRhIGJpbmRpbmcuIFNlZQogICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIgJGludGVycG9sYXRlUHJvdmlkZXJ9IGZvciBjb25maWd1cmluZyB0aGUKICAgICAgICAgICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICA8cHJlPgogICAgICAgICAgICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAgICAgICAgIHZhciBleHAgPSAkaW50ZXJwb2xhdGUoJ0hlbGxvIHt7bmFtZX19IScpOwogICAgICAgICAgICAgZXhwZWN0KGV4cCh7bmFtZTonQW5ndWxhcid9KS50b0VxdWFsKCdIZWxsbyBBbmd1bGFyIScpOwogICAgICAgICAgICAgPC9wcmU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRoZSB0ZXh0IHdpdGggbWFya3VwIHRvIGludGVycG9sYXRlLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBtdXN0SGF2ZUV4cHJlc3Npb24gaWYgc2V0IHRvIHRydWUgdGhlbiB0aGUgaW50ZXJwb2xhdGlvbiBzdHJpbmcgbXVzdCBoYXZlCiAgICAgICAgICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gaW4gb3JkZXIgdG8gcmV0dXJuIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFN0cmluZ3Mgd2l0aCBubwogICAgICAgICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIHdpbGwgcmV0dXJuIG51bGwgZm9yIHRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCl9IGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBjb21wdXRlIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICAgICAgICogICAgc3RyaW5nLiBUaGUgZnVuY3Rpb24gaGFzIHRoZXNlIHBhcmFtZXRlcnM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgOiBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MgYXJlIGV2YWx1YXRlZAogICAgICAgICAgICAgKiAgICAgIGFnYWluc3QuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiAkaW50ZXJwb2xhdGUodGV4dCwgbXVzdEhhdmVFeHByZXNzaW9uKSB7CiAgICAgICAgICAgICAgICB2YXIgc3RhcnRJbmRleCwKICAgICAgICAgICAgICAgICAgICBlbmRJbmRleCwKICAgICAgICAgICAgICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSB0ZXh0Lmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBoYXNJbnRlcnBvbGF0aW9uID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZm4sCiAgICAgICAgICAgICAgICAgICAgZXhwLAogICAgICAgICAgICAgICAgICAgIGNvbmNhdCA9IFtdOwoKICAgICAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmICgoKHN0YXJ0SW5kZXggPSB0ZXh0LmluZGV4T2Yoc3RhcnRTeW1ib2wsIGluZGV4KSkgIT0gLTEpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICgoZW5kSW5kZXggPSB0ZXh0LmluZGV4T2YoZW5kU3ltYm9sLCBzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgpKSAhPSAtMSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgKGluZGV4ICE9IHN0YXJ0SW5kZXgpICYmIHBhcnRzLnB1c2godGV4dC5zdWJzdHJpbmcoaW5kZXgsIHN0YXJ0SW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChmbiA9ICRwYXJzZShleHAgPSB0ZXh0LnN1YnN0cmluZyhzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgsIGVuZEluZGV4KSkpOwogICAgICAgICAgICAgICAgICAgICAgICBmbi5leHAgPSBleHA7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gZW5kSW5kZXggKyBlbmRTeW1ib2xMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGRpZCBub3QgZmluZCBhbnl0aGluZywgc28gd2UgaGF2ZSB0byBhZGQgdGhlIHJlbWFpbmRlciB0byB0aGUgcGFydHMgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgKGluZGV4ICE9IGxlbmd0aCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCEobGVuZ3RoID0gcGFydHMubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFkZGVkLCBub3RoaW5nLCBtdXN0IGhhdmUgYmVlbiBhbiBlbXB0eSBzdHJpbmcuCiAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIW11c3RIYXZlRXhwcmVzc2lvbiB8fCBoYXNJbnRlcnBvbGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgY29uY2F0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGxlbmd0aCwgcGFydDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgKHBhcnQgPSBwYXJ0c1tpXSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0KGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0ID09IG51bGwgfHwgcGFydCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhcnQgIT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHRvSnNvbihwYXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25jYXRbaV0gPSBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25jYXQuam9pbignJyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBmbi5leHAgPSB0ZXh0OwogICAgICAgICAgICAgICAgICAgIGZuLnBhcnRzID0gcGFydHM7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI3N0YXJ0U3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbH0gdG8gY2hhbmdlCiAgICAgICAgICAgICAqIHRoZSBzeW1ib2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHN0YXJ0IHN5bWJvbC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZSNlbmRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFVzZSB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbH0gdG8gY2hhbmdlCiAgICAgICAgICAgICAqIHRoZSBzeW1ib2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHN0YXJ0IHN5bWJvbC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2wgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJGludGVycG9sYXRlOwogICAgICAgIH1dOwogICAgfQoKICAgIHZhciBVUkxfTUFUQ0ggPSAvXihbXjpdKyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXHs/W1x3XC4tXSpcfT8pKDooWzAtOV0rKSk/KFwvW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBQQVRIX01BVENIID0gL14oW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBIQVNIX01BVENIID0gUEFUSF9NQVRDSCwKICAgICAgICBERUZBVUxUX1BPUlRTID0geydodHRwJzogODAsICdodHRwcyc6IDQ0MywgJ2Z0cCc6IDIxfTsKCgogICAgLyoqCiAgICAgKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBQYXRoIHRvIGVuY29kZQogICAgICogQHJldHVybnMge3N0cmluZ30KICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlUGF0aChwYXRoKSB7CiAgICAgICAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLycpLAogICAgICAgICAgICBpID0gc2VnbWVudHMubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIHNlZ21lbnRzW2ldID0gZW5jb2RlVXJpU2VnbWVudChzZWdtZW50c1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VnbWVudHMuam9pbignLycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmlwSGFzaCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hdGNoVXJsKHVybCwgb2JqKSB7CiAgICAgICAgdmFyIG1hdGNoID0gVVJMX01BVENILmV4ZWModXJsKTsKCiAgICAgICAgbWF0Y2ggPSB7CiAgICAgICAgICAgIHByb3RvY29sOiBtYXRjaFsxXSwKICAgICAgICAgICAgaG9zdDogbWF0Y2hbM10sCiAgICAgICAgICAgIHBvcnQ6IGludChtYXRjaFs1XSkgfHwgREVGQVVMVF9QT1JUU1ttYXRjaFsxXV0gfHwgbnVsbCwKICAgICAgICAgICAgcGF0aDogbWF0Y2hbNl0gfHwgJy8nLAogICAgICAgICAgICBzZWFyY2g6IG1hdGNoWzhdLAogICAgICAgICAgICBoYXNoOiBtYXRjaFsxMF0KICAgICAgICB9OwoKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgIG9iai4kJHByb3RvY29sID0gbWF0Y2gucHJvdG9jb2w7CiAgICAgICAgICAgIG9iai4kJGhvc3QgPSBtYXRjaC5ob3N0OwogICAgICAgICAgICBvYmouJCRwb3J0ID0gbWF0Y2gucG9ydDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXRjaDsKICAgIH0KCgogICAgZnVuY3Rpb24gY29tcG9zZVByb3RvY29sSG9zdFBvcnQocHJvdG9jb2wsIGhvc3QsIHBvcnQpIHsKICAgICAgICByZXR1cm4gcHJvdG9jb2wgKyAnOi8vJyArIGhvc3QgKyAocG9ydCA9PSBERUZBVUxUX1BPUlRTW3Byb3RvY29sXSA/ICcnIDogJzonICsgcG9ydCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCkgewogICAgICAgIHJldHVybiBiYXNlUGF0aC5zdWJzdHIoMCwgYmFzZVBhdGgubGFzdEluZGV4T2YoJy8nKSk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0h0bWw1VXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGh0bWw1IHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgIT0gYmFzZVBhdGggfHwgaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgfHwKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaGFzaGJhbmcgdXJsIC0+IGh0bWw1IHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKwogICAgICAgICAgICAgICAgcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSArIG1hdGNoLmhhc2guc3Vic3RyKGhhc2hQcmVmaXgubGVuZ3RoKTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIGNvbnZlcnRUb0hhc2hiYW5nVXJsKHVybCwgYmFzZVBhdGgsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwpOwoKICAgICAgICAvLyBhbHJlYWR5IGhhc2hiYW5nIHVybAogICAgICAgIGlmIChkZWNvZGVVUklDb21wb25lbnQobWF0Y2gucGF0aCkgPT0gYmFzZVBhdGggJiYgIWlzVW5kZWZpbmVkKG1hdGNoLmhhc2gpICYmCiAgICAgICAgICAgIG1hdGNoLmhhc2guaW5kZXhPZihoYXNoUHJlZml4KSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgICAgICAvLyBjb252ZXJ0IGh0bWw1IHVybCAtPiBoYXNoYmFuZyB1cmwKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gbWF0Y2guc2VhcmNoICYmICc/JyArIG1hdGNoLnNlYXJjaCB8fCAnJywKICAgICAgICAgICAgICAgIGhhc2ggPSBtYXRjaC5oYXNoICYmICcjJyArIG1hdGNoLmhhc2ggfHwgJycsCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSwKICAgICAgICAgICAgICAgIHBhdGggPSBtYXRjaC5wYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCk7CgogICAgICAgICAgICBpZiAobWF0Y2gucGF0aC5pbmRleE9mKHBhdGhQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChtYXRjaC5wcm90b2NvbCwgbWF0Y2guaG9zdCwgbWF0Y2gucG9ydCkgKyBiYXNlUGF0aCArCiAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgcGF0aCArIHNlYXJjaCArIGhhc2g7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uVXJsIHJlcHJlc2VudHMgYW4gdXJsCiAgICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gSFRNTDUgbW9kZSBpcyBlbmFibGVkIGFuZCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSFRNTDUgdXJsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aFByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvblVybCh1cmwsIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpIHsKICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeCB8fCAnJzsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaHRtbDUgKHJlZ3VsYXIpIHVybCBzdHJpbmcgaW50byBwcm9wZXJ0aWVzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0Fic29sdXRlVXJsIEhUTUw1IHVybAogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24gKG5ld0Fic29sdXRlVXJsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKG5ld0Fic29sdXRlVXJsLCB0aGlzKTsKCiAgICAgICAgICAgIGlmIChtYXRjaC5wYXRoLmluZGV4T2YocGF0aFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIG5ld0Fic29sdXRlVXJsICsgJyIsIG1pc3NpbmcgcGF0aCBwcmVmaXggIicgKyBwYXRoUHJlZml4ICsgJyIgIScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCkpOwogICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaC5zZWFyY2gpOwogICAgICAgICAgICB0aGlzLiQkaGFzaCA9IG1hdGNoLmhhc2ggJiYgZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLmhhc2gpIHx8ICcnOwoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydCh0aGlzLiQkcHJvdG9jb2wsIHRoaXMuJCRob3N0LCB0aGlzLiQkcG9ydCkgKwogICAgICAgICAgICAgICAgcGF0aFByZWZpeCArIHRoaXMuJCR1cmw7CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24gKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZiAoYWJzb2x1dGVMaW5rVXJsLmluZGV4T2YoYXBwQmFzZVVybCkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFic29sdXRlTGlua1VybDsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHRoaXMuJCRwYXJzZSh1cmwpOwogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBodG1sNSBoaXN0b3J5IGFwaSBpcyBkaXNhYmxlZCBvciBub3Qgc3VwcG9ydGVkCiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIExlZ2FjeSB1cmwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IFByZWZpeCBmb3IgaGFzaCBwYXJ0IChjb250YWluaW5nIHBhdGggYW5kIHNlYXJjaCkKICAgICAqLwogICAgZnVuY3Rpb24gTG9jYXRpb25IYXNoYmFuZ1VybCh1cmwsIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwpIHsKICAgICAgICB2YXIgYmFzZVBhdGg7CgogICAgICAgIC8qKgogICAgICAgICAqIFBhcnNlIGdpdmVuIGhhc2hiYW5nIHVybCBpbnRvIHByb3BlcnRpZXMKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIEhhc2hiYW5nIHVybAogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24gKHVybCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaFVybCh1cmwsIHRoaXMpOwoKCiAgICAgICAgICAgIGlmIChtYXRjaC5oYXNoICYmIG1hdGNoLmhhc2guaW5kZXhPZihoYXNoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgdXJsICsgJyIsIG1pc3NpbmcgaGFzaCBwcmVmaXggIicgKyBoYXNoUHJlZml4ICsgJyIgIScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBiYXNlUGF0aCA9IG1hdGNoLnBhdGggKyAobWF0Y2guc2VhcmNoID8gJz8nICsgbWF0Y2guc2VhcmNoIDogJycpOwogICAgICAgICAgICBtYXRjaCA9IEhBU0hfTUFUQ0guZXhlYygobWF0Y2guaGFzaCB8fCAnJykuc3Vic3RyKGhhc2hQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgICAgICAgdGhpcy4kJHBhdGggPSAobWF0Y2hbMV0uY2hhckF0KDApID09ICcvJyA/ICcnIDogJy8nKSArIGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkcGF0aCA9ICcnOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaFszXSk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2hbNV0gJiYgZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzVdKSB8fCAnJzsKCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcG9zZSBoYXNoYmFuZyB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gY29tcG9zZVByb3RvY29sSG9zdFBvcnQodGhpcy4kJHByb3RvY29sLCB0aGlzLiQkaG9zdCwgdGhpcy4kJHBvcnQpICsKICAgICAgICAgICAgICAgIGJhc2VQYXRoICsgKHRoaXMuJCR1cmwgPyAnIycgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZUFwcFVybCA9IGZ1bmN0aW9uIChhYnNvbHV0ZUxpbmtVcmwpIHsKICAgICAgICAgICAgaWYgKGFic29sdXRlTGlua1VybC5pbmRleE9mKGFwcEJhc2VVcmwpID09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBhYnNvbHV0ZUxpbmtVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICB0aGlzLiQkcGFyc2UodXJsKTsKICAgIH0KCgogICAgTG9jYXRpb25VcmwucHJvdG90eXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBIYXMgYW55IGNoYW5nZSBiZWVuIHJlcGxhY2luZyA/CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICAkJHJlcGxhY2U6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI2Fic1VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIGZ1bGwgdXJsIHJlcHJlc2VudGF0aW9uIHdpdGggYWxsIHNlZ21lbnRzIGVuY29kZWQgYWNjb3JkaW5nIHRvIHJ1bGVzIHNwZWNpZmllZCBpbgogICAgICAgICAqIHtAbGluayBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCBSRkMgMzk4Nn0uCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGZ1bGwgdXJsCiAgICAgICAgICovCiAgICAgICAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiN1cmwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gdXJsIChlLmcuIGAvcGF0aD9hPWIjaGFzaGApIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBwYXRoLCBzZWFyY2ggYW5kIGhhc2gsIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHVybCBOZXcgdXJsIHdpdGhvdXQgYmFzZSBwcmVmaXggKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHVybAogICAgICAgICAqLwogICAgICAgIHVybDogZnVuY3Rpb24gKHVybCwgcmVwbGFjZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdXJsOwoKICAgICAgICAgICAgdmFyIG1hdGNoID0gUEFUSF9NQVRDSC5leGVjKHVybCk7CiAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgICBpZiAobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pIHRoaXMuc2VhcmNoKG1hdGNoWzNdIHx8ICcnKTsKICAgICAgICAgICAgdGhpcy5oYXNoKG1hdGNoWzVdIHx8ICcnLCByZXBsYWNlKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcHJvdG9jb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwcm90b2NvbCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgICAgICAgKi8KICAgICAgICBwcm90b2NvbDogbG9jYXRpb25HZXR0ZXIoJyQkcHJvdG9jb2wnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNob3N0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKi8KICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcG9ydAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgICAgICAgKi8KICAgICAgICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcGF0aAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBwYXRoIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBOb3RlOiBQYXRoIHNob3VsZCBhbHdheXMgYmVnaW4gd2l0aCBmb3J3YXJkIHNsYXNoICgvKSwgdGhpcyBtZXRob2Qgd2lsbCBhZGQgdGhlIGZvcndhcmQgc2xhc2gKICAgICAgICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwYXRoIE5ldyBwYXRoCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICAgICAgICovCiAgICAgICAgcGF0aDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkcGF0aCcsIGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoLmNoYXJBdCgwKSA9PSAnLycgPyBwYXRoIDogJy8nICsgcGF0aDsKICAgICAgICB9KSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNzZWFyY2gKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gc2VhcmNoIHBhcnQgKGFzIG9iamVjdCkgb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3Q8c3RyaW5nLHN0cmluZz49fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IgaGFzaCBvYmplY3QKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcsIHRoZW4gYHBhcmFtVmFsdWVgIHdpbGwgb3ZlcnJpZGUgb25seSBhCiAgICAgICAgICogICAgc2luZ2xlIHNlYXJjaCBwYXJhbWV0ZXIuIElmIHRoZSB2YWx1ZSBpcyBgbnVsbGAsIHRoZSBwYXJhbWV0ZXIgd2lsbCBiZSBkZWxldGVkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBzZWFyY2gKICAgICAgICAgKi8KICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uIChzZWFyY2gsIHBhcmFtVmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHNlYXJjaCkpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kJHNlYXJjaDsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocGFyYW1WYWx1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJhbVZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuJCRzZWFyY2hbc2VhcmNoXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaFtzZWFyY2hdID0gcGFyYW1WYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBpc1N0cmluZyhzZWFyY2gpID8gcGFyc2VLZXlWYWx1ZShzZWFyY2gpIDogc2VhcmNoOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI2hhc2gKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBoYXNoIE5ldyBoYXNoIGZyYWdtZW50CiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBoYXNoCiAgICAgICAgICovCiAgICAgICAgaGFzaDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkaGFzaCcsIGlkZW50aXR5KSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNyZXBsYWNlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogSWYgY2FsbGVkLCBhbGwgY2hhbmdlcyB0byAkbG9jYXRpb24gZHVyaW5nIGN1cnJlbnQgYCRkaWdlc3RgIHdpbGwgYmUgcmVwbGFjaW5nIGN1cnJlbnQgaGlzdG9yeQogICAgICAgICAqIHJlY29yZCwgaW5zdGVhZCBvZiBhZGRpbmcgbmV3IG9uZS4KICAgICAgICAgKi8KICAgICAgICByZXBsYWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuJCRyZXBsYWNlID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9IGluaGVyaXQoTG9jYXRpb25VcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCh1cmwsIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VFeHRyYSkgewogICAgICAgIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24gKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZiAoYWJzb2x1dGVMaW5rVXJsLmluZGV4T2YoYXBwQmFzZVVybCkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFwcEJhc2VVcmwgKyBiYXNlRXh0cmEgKyAnIycgKyBoYXNoUHJlZml4ICsgYWJzb2x1dGVMaW5rVXJsLnN1YnN0cihhcHBCYXNlVXJsLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSk7CgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CiAgICAgICAgfTsKICAgIH0KCgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXJTZXR0ZXIocHJvcGVydHksIHByZXByb2Nlc3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CgogICAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24KICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkc25pZmZlcgogICAgICogQHJlcXVpcmVzICRyb290RWxlbWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlICRsb2NhdGlvbiBzZXJ2aWNlIHBhcnNlcyB0aGUgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyIChiYXNlZCBvbiB0aGUKICAgICAqIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24gd2luZG93LmxvY2F0aW9ufSkgYW5kIG1ha2VzIHRoZSBVUkwKICAgICAqIGF2YWlsYWJsZSB0byB5b3VyIGFwcGxpY2F0aW9uLiBDaGFuZ2VzIHRvIHRoZSBVUkwgaW4gdGhlIGFkZHJlc3MgYmFyIGFyZSByZWZsZWN0ZWQgaW50bwogICAgICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICAgICAqCiAgICAgKiAqKlRoZSAkbG9jYXRpb24gc2VydmljZToqKgogICAgICoKICAgICAqIC0gRXhwb3NlcyB0aGUgY3VycmVudCBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIsIHNvIHlvdSBjYW4KICAgICAqICAgLSBXYXRjaCBhbmQgb2JzZXJ2ZSB0aGUgVVJMLgogICAgICogICAtIENoYW5nZSB0aGUgVVJMLgogICAgICogLSBTeW5jaHJvbml6ZXMgdGhlIFVSTCB3aXRoIHRoZSBicm93c2VyIHdoZW4gdGhlIHVzZXIKICAgICAqICAgLSBDaGFuZ2VzIHRoZSBhZGRyZXNzIGJhci4KICAgICAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAgICAgKiAgIC0gQ2xpY2tzIG9uIGEgbGluay4KICAgICAqIC0gUmVwcmVzZW50cyB0aGUgVVJMIG9iamVjdCBhcyBhIHNldCBvZiBtZXRob2RzIChwcm90b2NvbCwgaG9zdCwgcG9ydCwgcGF0aCwgc2VhcmNoLCBoYXNoKS4KICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5zZXJ2aWNlcy4kbG9jYXRpb24gRGV2ZWxvcGVyIEd1aWRlOiBBbmd1bGFyCiAgICAgKiBTZXJ2aWNlczogVXNpbmcgJGxvY2F0aW9ufQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCkgewogICAgICAgIHZhciBoYXNoUHJlZml4ID0gJycsCiAgICAgICAgICAgIGh0bWw1TW9kZSA9IGZhbHNlOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNoYXNoUHJlZml4CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHByZWZpeCkpIHsKICAgICAgICAgICAgICAgIGhhc2hQcmVmaXggPSBwcmVmaXg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBoYXNoUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uUHJvdmlkZXIjaHRtbDVNb2RlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtb2RlIFVzZSBIVE1MNSBzdHJhdGVneSBpZiBhdmFpbGFibGUuCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uIChtb2RlKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgICAgICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRicm93c2VyLCAkc25pZmZlciwgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoLAogICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybCA9ICRicm93c2VyLnVybCgpLAogICAgICAgICAgICAgICAgICAgIGluaXRVcmxQYXJ0cyA9IG1hdGNoVXJsKGluaXRVcmwpLAogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmw7CgogICAgICAgICAgICAgICAgaWYgKGh0bWw1TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGJhc2VQYXRoID0gJGJyb3dzZXIuYmFzZUhyZWYoKSB8fCAnLyc7CiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhQcmVmaXhGcm9tQmFzZShiYXNlUGF0aCk7CiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KGluaXRVcmxQYXJ0cy5wcm90b2NvbCwgaW5pdFVybFBhcnRzLmhvc3QsIGluaXRVcmxQYXJ0cy5wb3J0KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25VcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IdG1sNVVybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9IYXNoYmFuZ1VybChpbml0VXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoUHJlZml4LCBhcHBCYXNlVXJsLCBiYXNlUGF0aC5zdWJzdHIocGF0aFByZWZpeC5sZW5ndGggKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpbml0VXJsUGFydHMucGF0aCB8fCAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5zZWFyY2ggPyAoJz8nICsgaW5pdFVybFBhcnRzLnNlYXJjaCkgOiAnJykgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyMnICsgaGFzaFByZWZpeCArICcvJzsKCiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uID0gbmV3IExvY2F0aW9uSGFzaGJhbmdVcmwoaW5pdFVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJld3JpdGUgbGluayB3aGVuIG9wZW5pbmcgaW4gbmV3IHRhYi93aW5kb3cgKGluIGxlZ2FjeSBicm93c2VyKQogICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC53aGljaCA9PSAyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIHZhciBlbG0gPSBqcUxpdGUoZXZlbnQudGFyZ2V0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxvd2VyY2FzZShlbG1bMF0ubm9kZU5hbWUpICE9PSAnYScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlIHJld3JpdGluZyBpZiBubyBBIHRhZyAocmVhY2hlZCByb290IGVsZW1lbnQsIG9yIG5vIHBhcmVudCAtIHJlbW92ZWQgZnJvbSBkb2N1bWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsbVswXSA9PT0gJHJvb3RFbGVtZW50WzBdIHx8ICEoZWxtID0gZWxtLnBhcmVudCgpKVswXSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGFic0hyZWYgPSBlbG0ucHJvcCgnaHJlZicpLAogICAgICAgICAgICAgICAgICAgICAgICByZXdyaXR0ZW5VcmwgPSAkbG9jYXRpb24uJCRyZXdyaXRlQXBwVXJsKGFic0hyZWYpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmIHJld3JpdHRlblVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgbG9jYXRpb24gbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UocmV3cml0dGVuVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFjayB0byB3b3JrIGFyb3VuZCBGRjYgYnVnIDY4NDIwOCB3aGVuIHNjZW5hcmlvIHJ1bm5lciBjbGlja3Mgb24gbGlua3MKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmFuZ3VsYXJbJ2ZmLTY4NDIwOC1wcmV2ZW50RGVmYXVsdCddID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCgogICAgICAgICAgICAgICAgLy8gcmV3cml0ZSBoYXNoYmFuZyB1cmwgPD4gaHRtbDUgdXJsCiAgICAgICAgICAgICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IGluaXRVcmwpIHsKICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgJGxvY2F0aW9uIHdoZW4gJGJyb3dzZXIgdXJsIGNoYW5nZXMKICAgICAgICAgICAgICAgICRicm93c2VyLm9uVXJsQ2hhbmdlKGZ1bmN0aW9uIChuZXdVcmwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IG5ld1VybCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsIG5ld1VybCwgJGxvY2F0aW9uLmFic1VybCgpKS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi5hYnNVcmwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBicm93c2VyCiAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiAkbG9jYXRpb25XYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGJyb3dzZXIudXJsKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjaGFuZ2VDb3VudGVyIHx8IG9sZFVybCAhPSAkbG9jYXRpb24uYWJzVXJsKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlQ291bnRlcisrOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG9sZFVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIGN1cnJlbnRSZXBsYWNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRyZXBsYWNlID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGFuZ2VDb3VudGVyOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgcmV0dXJuICRsb2NhdGlvbjsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9nCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2ltcGxlIHNlcnZpY2UgZm9yIGxvZ2dpbmcuIERlZmF1bHQgaW1wbGVtZW50YXRpb24gd3JpdGVzIHRoZSBtZXNzYWdlCiAgICAgKiBpbnRvIHRoZSBicm93c2VyJ3MgY29uc29sZSAoaWYgcHJlc2VudCkuCiAgICAgKgogICAgICogVGhlIG1haW4gcHVycG9zZSBvZiB0aGlzIHNlcnZpY2UgaXMgdG8gc2ltcGxpZnkgZGVidWdnaW5nIGFuZCB0cm91Ymxlc2hvb3RpbmcuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGZ1bmN0aW9uIExvZ0N0cmwoJHNjb3BlLCAkbG9nKSB7CiAgICAgICAgICRzY29wZS4kbG9nID0gJGxvZzsKICAgICAgICAgJHNjb3BlLm1lc3NhZ2UgPSAnSGVsbG8gV29ybGQhJzsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJMb2dDdHJsIj4KICAgICA8cD5SZWxvYWQgdGhpcyBwYWdlIHdpdGggb3BlbiBjb25zb2xlLCBlbnRlciB0ZXh0IGFuZCBoaXQgdGhlIGxvZyBidXR0b24uLi48L3A+CiAgICAgTWVzc2FnZToKICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im1lc3NhZ2UiLz4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmxvZyhtZXNzYWdlKSI+bG9nPC9idXR0b24+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy53YXJuKG1lc3NhZ2UpIj53YXJuPC9idXR0b24+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5pbmZvKG1lc3NhZ2UpIj5pbmZvPC9idXR0b24+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5lcnJvcihtZXNzYWdlKSI+ZXJyb3I8L2J1dHRvbj4KICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgogICAgZnVuY3Rpb24gJExvZ1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uICgkd2luZG93KSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjbG9nCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyN3YXJuCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSB3YXJuaW5nIG1lc3NhZ2UKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgd2FybjogY29uc29sZUxvZygnd2FybicpLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNpbmZvCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gaW5mb3JtYXRpb24gbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpbmZvOiBjb25zb2xlTG9nKCdpbmZvJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2Vycm9yCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0RXJyb3IoYXJnKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IChhcmcubWVzc2FnZSAmJiBhcmcuc3RhY2suaW5kZXhPZihhcmcubWVzc2FnZSkgPT09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnRXJyb3I6ICcgKyBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc3RhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYXJnLnN0YWNrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnLnNvdXJjZVVSTCkgewogICAgICAgICAgICAgICAgICAgICAgICBhcmcgPSBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc291cmNlVVJMICsgJzonICsgYXJnLmxpbmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY29uc29sZUxvZyh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgY29uc29sZSA9ICR3aW5kb3cuY29uc29sZSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICBsb2dGbiA9IGNvbnNvbGVbdHlwZV0gfHwgY29uc29sZS5sb2cgfHwgbm9vcDsKCiAgICAgICAgICAgICAgICBpZiAobG9nRm4uYXBwbHkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGZvcm1hdEVycm9yKGFyZykpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2UgYXJlIElFIHdoaWNoIGVpdGhlciBkb2Vzbid0IGhhdmUgd2luZG93LmNvbnNvbGUgPT4gdGhpcyBpcyBub29wIGFuZCB3ZSBkbyBub3RoaW5nLAogICAgICAgICAgICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFyZzEsIGFyZzIpIHsKICAgICAgICAgICAgICAgICAgICBsb2dGbihhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH1dOwogICAgfQoKICAgIHZhciBPUEVSQVRPUlMgPSB7CiAgICAgICAgJ251bGwnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCiAgICAgICAgJ3RydWUnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgJ2ZhbHNlJzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICB1bmRlZmluZWQ6IG5vb3AsCiAgICAgICAgJysnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaXNEZWZpbmVkKGIpID8gYiA6IHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgICctJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICBhID0gYShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICBiID0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICByZXR1cm4gKGlzRGVmaW5lZChhKSA/IGEgOiAwKSAtIChpc0RlZmluZWQoYikgPyBiIDogMCk7CiAgICAgICAgfSwKICAgICAgICAnKic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAqIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICcvJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpIC8gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyUnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgJSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnXic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSBeIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICc9Jzogbm9vcCwKICAgICAgICAnPT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPT0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyE9JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICE9IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICc8JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpIDwgYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJz4nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPiBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPD0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPD0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJz49JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpID49IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICcmJic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAmJiBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnfHwnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgfHwgYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyYnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgJiBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKLy8gICAgJ3wnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYXxiO30sCiAgICAgICAgJ3wnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBiKHNlbGYsIGxvY2Fscykoc2VsZiwgbG9jYWxzLCBhKHNlbGYsIGxvY2FscykpOwogICAgICAgIH0sCiAgICAgICAgJyEnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhKSB7CiAgICAgICAgICAgIHJldHVybiAhYShzZWxmLCBsb2NhbHMpOwogICAgICAgIH0KICAgIH07CiAgICB2YXIgRVNDQVBFID0geyJuIjogIlxuIiwgImYiOiAiXGYiLCAiciI6ICJcciIsICJ0IjogIlx0IiwgInYiOiAiXHYiLCAiJyI6ICInIiwgJyInOiAnIid9OwoKICAgIGZ1bmN0aW9uIGxleCh0ZXh0LCBjc3ApIHsKICAgICAgICB2YXIgdG9rZW5zID0gW10sCiAgICAgICAgICAgIHRva2VuLAogICAgICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgICAgIGpzb24gPSBbXSwKICAgICAgICAgICAgY2gsCiAgICAgICAgICAgIGxhc3RDaCA9ICc6JzsgLy8gY2FuIHN0YXJ0IHJlZ2V4cAoKICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgaWYgKGlzKCciXCcnKSkgewogICAgICAgICAgICAgICAgcmVhZFN0cmluZyhjaCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoY2gpIHx8IGlzKCcuJykgJiYgaXNOdW1iZXIocGVlaygpKSkgewogICAgICAgICAgICAgICAgcmVhZE51bWJlcigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzSWRlbnQoY2gpKSB7CiAgICAgICAgICAgICAgICByZWFkSWRlbnQoKTsKICAgICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJzIGNhbiBvbmx5IGJlIGlmIHRoZSBwcmVjZWRpbmcgY2hhciB3YXMgYSB7IG9yICwKICAgICAgICAgICAgICAgIGlmICh3YXMoJ3ssJykgJiYganNvblswXSA9PSAneycgJiYKICAgICAgICAgICAgICAgICAgICAodG9rZW4gPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuLmpzb24gPSB0b2tlbi50ZXh0LmluZGV4T2YoJy4nKSA9PSAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpcygnKCl7fVtdLiw7OicpKSB7CiAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGluZGV4LAogICAgICAgICAgICAgICAgICAgIHRleHQ6IGNoLAogICAgICAgICAgICAgICAgICAgIGpzb246ICh3YXMoJzpbLCcpICYmIGlzKCd7WycpKSB8fCBpcygnfV06LCcpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChpcygne1snKSkganNvbi51bnNoaWZ0KGNoKTsKICAgICAgICAgICAgICAgIGlmIChpcygnfV0nKSkganNvbi5zaGlmdCgpOwogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgY2gyID0gY2ggKyBwZWVrKCksCiAgICAgICAgICAgICAgICAgICAgZm4gPSBPUEVSQVRPUlNbY2hdLAogICAgICAgICAgICAgICAgICAgIGZuMiA9IE9QRVJBVE9SU1tjaDJdOwogICAgICAgICAgICAgICAgaWYgKGZuMikgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHtpbmRleDogaW5kZXgsIHRleHQ6IGNoMiwgZm46IGZuMn0pOwogICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OiBpbmRleCwgdGV4dDogY2gsIGZuOiBmbiwganNvbjogd2FzKCdbLDonKSAmJiBpcygnKy0nKX0pOwogICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIlVuZXhwZWN0ZWQgbmV4dCBjaGFyYWN0ZXIgIiwgaW5kZXgsIGluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENoID0gY2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbnM7CgogICAgICAgIGZ1bmN0aW9uIGlzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGNoKSAhPSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcyhjaGFycykgewogICAgICAgICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlaygpIHsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ICsgMSA8IHRleHQubGVuZ3RoID8gdGV4dC5jaGFyQXQoaW5kZXggKyAxKSA6IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNOdW1iZXIoY2gpIHsKICAgICAgICAgICAgcmV0dXJuICcwJyA8PSBjaCAmJiBjaCA8PSAnOSc7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICcgJyB8fCBjaCA9PSAnXHInIHx8IGNoID09ICdcdCcgfHwKICAgICAgICAgICAgICAgIGNoID09ICdcbicgfHwgY2ggPT0gJ1x2JyB8fCBjaCA9PSAnXHUwMEEwJzsgLy8gSUUgdHJlYXRzIG5vbi1icmVha2luZyBzcGFjZSBhcyBcdTAwQTAKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzSWRlbnQoY2gpIHsKICAgICAgICAgICAgcmV0dXJuICdhJyA8PSBjaCAmJiBjaCA8PSAneicgfHwKICAgICAgICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAgICAgICdfJyA9PSBjaCB8fCBjaCA9PSAnJCc7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0V4cE9wZXJhdG9yKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBjaCA9PSAnLScgfHwgY2ggPT0gJysnIHx8IGlzTnVtYmVyKGNoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRocm93RXJyb3IoZXJyb3IsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgZW5kID0gZW5kIHx8IGluZGV4OwogICAgICAgICAgICB0aHJvdyBFcnJvcigiTGV4ZXIgRXJyb3I6ICIgKyBlcnJvciArICIgYXQgY29sdW1uIiArCiAgICAgICAgICAgICAgICAoaXNEZWZpbmVkKHN0YXJ0KQogICAgICAgICAgICAgICAgICAgID8gInMgIiArIHN0YXJ0ICsgIi0iICsgaW5kZXggKyAiIFsiICsgdGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAiXSIKICAgICAgICAgICAgICAgICAgICA6ICIgIiArIGVuZCkgKwogICAgICAgICAgICAgICAgIiBpbiBleHByZXNzaW9uIFsiICsgdGV4dCArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZE51bWJlcigpIHsKICAgICAgICAgICAgdmFyIG51bWJlciA9ICIiOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0ZXh0LmNoYXJBdChpbmRleCkpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBwZWVrQ2ggPSBwZWVrKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICdlJyAmJiBpc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICghcGVla0NoIHx8ICFpc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OiBzdGFydCwgdGV4dDogbnVtYmVyLCBqc29uOiB0cnVlLAogICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVtYmVyOwogICAgICAgICAgICAgICAgfX0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZElkZW50KCkgewogICAgICAgICAgICB2YXIgaWRlbnQgPSAiIiwKICAgICAgICAgICAgICAgIHN0YXJ0ID0gaW5kZXgsCiAgICAgICAgICAgICAgICBsYXN0RG90LCBwZWVrSW5kZXgsIG1ldGhvZE5hbWUsIGNoOwoKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc0lkZW50KGNoKSB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nKSBsYXN0RG90ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgaWRlbnQgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9jaGVjayBpZiB0aGlzIGlzIG5vdCBhIG1ldGhvZCBpbnZvY2F0aW9uIGFuZCBpZiBpdCBpcyBiYWNrIG91dCB0byBsYXN0IGRvdAogICAgICAgICAgICBpZiAobGFzdERvdCkgewogICAgICAgICAgICAgICAgcGVla0luZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICB3aGlsZSAocGVla0luZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjaCA9IHRleHQuY2hhckF0KHBlZWtJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICcoJykgewogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZGVudCA9IGlkZW50LnN1YnN0cigwLCBsYXN0RG90IC0gc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IHBlZWtJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlZWtJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIHZhciB0b2tlbiA9IHsKICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgIHRleHQ6IGlkZW50CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoT1BFUkFUT1JTLmhhc093blByb3BlcnR5KGlkZW50KSkgewogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSB0b2tlbi5qc29uID0gT1BFUkFUT1JTW2lkZW50XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBnZXR0ZXJGbihpZGVudCwgY3NwKTsKICAgICAgICAgICAgICAgIHRva2VuLmZuID0gZXh0ZW5kKGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGdldHRlcihzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGVyKHNlbGYsIGlkZW50LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKCiAgICAgICAgICAgIGlmIChtZXRob2ROYW1lKSB7CiAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGxhc3REb3QsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogJy4nLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogbWV0aG9kTmFtZSwKICAgICAgICAgICAgICAgICAgICBqc29uOiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlYWRTdHJpbmcocXVvdGUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gaW5kZXg7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIjsKICAgICAgICAgICAgdmFyIHJhd1N0cmluZyA9IHF1b3RlOwogICAgICAgICAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICByYXdTdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICd1JykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGV4ID0gdGV4dC5zdWJzdHJpbmcoaW5kZXggKyAxLCBpbmRleCArIDUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIkludmFsaWQgdW5pY29kZSBlc2NhcGUgW1xcdSIgKyBoZXggKyAiXSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChoZXgsIDE2KSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcCA9IEVTQ0FQRVtjaF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSByZXA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09ICdcXCcpIHsKICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PSBxdW90ZSkgewogICAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogc3RhcnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHJhd1N0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nOiBzdHJpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93RXJyb3IoIlVudGVybWluYXRlZCBxdW90ZSIsIHN0YXJ0KTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHBhcnNlcih0ZXh0LCBqc29uLCAkZmlsdGVyLCBjc3ApIHsKICAgICAgICB2YXIgWkVSTyA9IHZhbHVlRm4oMCksCiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICB0b2tlbnMgPSBsZXgodGV4dCwgY3NwKSwKICAgICAgICAgICAgYXNzaWdubWVudCA9IF9hc3NpZ25tZW50LAogICAgICAgICAgICBmdW5jdGlvbkNhbGwgPSBfZnVuY3Rpb25DYWxsLAogICAgICAgICAgICBmaWVsZEFjY2VzcyA9IF9maWVsZEFjY2VzcywKICAgICAgICAgICAgb2JqZWN0SW5kZXggPSBfb2JqZWN0SW5kZXgsCiAgICAgICAgICAgIGZpbHRlckNoYWluID0gX2ZpbHRlckNoYWluOwoKICAgICAgICBpZiAoanNvbikgewogICAgICAgICAgICAvLyBUaGUgZXh0cmEgbGV2ZWwgb2YgYWxpYXNpbmcgaXMgaGVyZSwganVzdCBpbiBjYXNlIHRoZSBsZXhlciBtaXNzZXMgc29tZXRoaW5nLCBzbyB0aGF0CiAgICAgICAgICAgIC8vIHdlIHByZXZlbnQgYW55IGFjY2lkZW50YWwgZXhlY3V0aW9uIGluIEpTT04uCiAgICAgICAgICAgIGFzc2lnbm1lbnQgPSBsb2dpY2FsT1I7CiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9CiAgICAgICAgICAgICAgICBmaWVsZEFjY2VzcyA9CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0SW5kZXggPQogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJDaGFpbiA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB7dGV4dDogdGV4dCwgaW5kZXg6IDB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhbHVlID0gcHJpbWFyeSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gc3RhdGVtZW50cygpOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBhbiB1bmV4cGVjdGVkIHRva2VuIiwgdG9rZW5zWzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIGZ1bmN0aW9uIHRocm93RXJyb3IobXNnLCB0b2tlbikgewogICAgICAgICAgICB0aHJvdyBFcnJvcigiU3ludGF4IEVycm9yOiBUb2tlbiAnIiArIHRva2VuLnRleHQgKwogICAgICAgICAgICAgICAgIicgIiArIG1zZyArICIgYXQgY29sdW1uICIgKwogICAgICAgICAgICAgICAgKHRva2VuLmluZGV4ICsgMSkgKyAiIG9mIHRoZSBleHByZXNzaW9uIFsiICsKICAgICAgICAgICAgICAgIHRleHQgKyAiXSBzdGFydGluZyBhdCBbIiArIHRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSArICJdLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVla1Rva2VuKCkgewogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJVbmV4cGVjdGVkIGVuZCBvZiBleHByZXNzaW9uOiAiICsgdGV4dCk7CiAgICAgICAgICAgIHJldHVybiB0b2tlbnNbMF07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKGUxLCBlMiwgZTMsIGU0KSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zWzBdOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0b2tlbi50ZXh0OwogICAgICAgICAgICAgICAgaWYgKHQgPT0gZTEgfHwgdCA9PSBlMiB8fCB0ID09IGUzIHx8IHQgPT0gZTQgfHwKICAgICAgICAgICAgICAgICAgICAoIWUxICYmICFlMiAmJiAhZTMgJiYgIWU0KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleHBlY3QoZTEsIGUyLCBlMywgZTQpIHsKICAgICAgICAgICAgdmFyIHRva2VuID0gcGVlayhlMSwgZTIsIGUzLCBlNCk7CiAgICAgICAgICAgIGlmICh0b2tlbikgewogICAgICAgICAgICAgICAgaWYgKGpzb24gJiYgIXRva2VuLmpzb24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRva2Vucy5zaGlmdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbnN1bWUoZTEpIHsKICAgICAgICAgICAgaWYgKCFleHBlY3QoZTEpKSB7CiAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyB1bmV4cGVjdGVkLCBleHBlY3RpbmcgWyIgKyBlMSArICJdIiwgcGVlaygpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdW5hcnlGbihmbiwgcmlnaHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIHJpZ2h0KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJpbmFyeUZuKGxlZnQsIGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgbGVmdCwgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc3RhdGVtZW50cygpIHsKICAgICAgICAgICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID4gMCAmJiAhcGVlaygnfScsICcpJywgJzsnLCAnXScpKQogICAgICAgICAgICAgICAgICAgIHN0YXRlbWVudHMucHVzaChmaWx0ZXJDaGFpbigpKTsKICAgICAgICAgICAgICAgIGlmICghZXhwZWN0KCc7JykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBvcHRpbWl6ZSBmb3IgdGhlIGNvbW1vbiBjYXNlIHdoZXJlIHRoZXJlIGlzIG9ubHkgb25lIHN0YXRlbWVudC4KICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHNpemUpOiBtYXliZSB3ZSBzaG91bGQgbm90IHN1cHBvcnQgbXVsdGlwbGUgc3RhdGVtZW50cz8KICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGVtZW50cy5sZW5ndGggPT0gMQogICAgICAgICAgICAgICAgICAgICAgICA/IHN0YXRlbWVudHNbMF0KICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdGVtZW50ID0gc3RhdGVtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnQoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpbHRlckNoYWluKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGV4cHJlc3Npb24oKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnfCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZmlsdGVyKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlsdGVyKCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgdmFyIGZuID0gJGZpbHRlcih0b2tlbi50ZXh0KTsKICAgICAgICAgICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnOicpKSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NGbi5wdXNoKGV4cHJlc3Npb24oKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBmbkludm9rZSA9IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cHJlc3Npb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhc3NpZ25tZW50KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfYXNzaWdubWVudCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz0nKSkpIHsKICAgICAgICAgICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgIl0gY2FuIG5vdCBiZSBhc3NpZ25lZCB0byIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJpZ2h0ID0gbG9naWNhbE9SKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdC5hc3NpZ24oc2NvcGUsIHJpZ2h0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBsb2dpY2FsT1IoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbG9naWNhbEFORCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8fCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbG9naWNhbEFORCgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxBTkQoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXF1YWxpdHkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXF1YWxpdHkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gcmVsYXRpb25hbCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywgJyE9JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGVxdWFsaXR5KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVsYXRpb25hbCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBhZGRpdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJzwnLCAnPicsICc8PScsICc+PScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCByZWxhdGlvbmFsKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkaXRpdmUoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbXVsdGlwbGljYXRpdmUoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAoKHRva2VuID0gZXhwZWN0KCcrJywgJy0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbXVsdGlwbGljYXRpdmUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtdWx0aXBsaWNhdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSB1bmFyeSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJyonLCAnLycsICclJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdW5hcnkoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKGV4cGVjdCgnKycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJpbWFyeSgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnLScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGJpbmFyeUZuKFpFUk8sIHRva2VuLmZuLCB1bmFyeSgpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgodG9rZW4gPSBleHBlY3QoJyEnKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmFyeUZuKHRva2VuLmZuLCB1bmFyeSgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBwcmltYXJ5KCkgewogICAgICAgICAgICB2YXIgcHJpbWFyeTsKICAgICAgICAgICAgaWYgKGV4cGVjdCgnKCcpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZmlsdGVyQ2hhaW4oKTsKICAgICAgICAgICAgICAgIGNvbnN1bWUoJyknKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3QoJ1snKSkgewogICAgICAgICAgICAgICAgcHJpbWFyeSA9IGFycmF5RGVjbGFyYXRpb24oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3QoJ3snKSkgewogICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gZXhwZWN0KCk7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gdG9rZW4uZm47CiAgICAgICAgICAgICAgICBpZiAoIXByaW1hcnkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJub3QgYSBwcmltYXJ5IGV4cHJlc3Npb24iLCB0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBuZXh0LCBjb250ZXh0OwogICAgICAgICAgICB3aGlsZSAoKG5leHQgPSBleHBlY3QoJygnLCAnWycsICcuJykpKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICdbJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBvYmplY3RJbmRleChwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnLicpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZmllbGRBY2Nlc3MocHJpbWFyeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIklNUE9TU0lCTEUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJpbWFyeTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9maWVsZEFjY2VzcyhvYmplY3QpIHsKICAgICAgICAgICAgdmFyIGZpZWxkID0gZXhwZWN0KCkudGV4dDsKICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkLCBjc3ApOwogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMsIHNlbGYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyKHNlbGYgfHwgb2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzY29wZSwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGVyKG9iamVjdChzY29wZSwgbG9jYWxzKSwgZmllbGQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfb2JqZWN0SW5kZXgob2JqKSB7CiAgICAgICAgICAgIHZhciBpbmRleEZuID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICBjb25zdW1lKCddJyk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG8gPSBvYmooc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgICAgdiwgcDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHYgPSBvW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh2ICYmIHYudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLiQkdiA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB2LiQkdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduOiBmdW5jdGlvbiAoc2VsZiwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqKHNlbGYsIGxvY2FscylbaW5kZXhGbihzZWxmLCBsb2NhbHMpXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2Z1bmN0aW9uQ2FsbChmbiwgY29udGV4dEdldHRlcikgewogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICcpJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGFyZ3NGbi5wdXNoKGV4cHJlc3Npb24oKSk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHRHZXR0ZXIgPyBjb250ZXh0R2V0dGVyKHNjb3BlLCBsb2NhbHMpIDogc2NvcGU7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBmblB0ciA9IGZuKHNjb3BlLCBsb2NhbHMsIGNvbnRleHQpIHx8IG5vb3A7CiAgICAgICAgICAgICAgICAvLyBJRSBzdHVwaWRpdHkhCiAgICAgICAgICAgICAgICByZXR1cm4gZm5QdHIuYXBwbHkKICAgICAgICAgICAgICAgICAgICA/IGZuUHRyLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgICAgICAgICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgdXNlZCB3aXRoIGpzb24gYXJyYXkgZGVjbGFyYXRpb24KICAgICAgICBmdW5jdGlvbiBhcnJheURlY2xhcmF0aW9uKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnXScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50Rm5zLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCddJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudEZucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudEZuc1tpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9iamVjdCgpIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnfScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKSwKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdG9rZW4uc3RyaW5nIHx8IHRva2VuLnRleHQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3VtZSgiOiIpOwogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgICAgICBrZXlWYWx1ZXMucHVzaCh7a2V5OiBrZXksIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ30nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBvYmplY3QgPSB7fTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleVZhbHVlID0ga2V5VmFsdWVzW2ldOwogICAgICAgICAgICAgICAgICAgIG9iamVjdFtrZXlWYWx1ZS5rZXldID0ga2V5VmFsdWUudmFsdWUoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gUGFyc2VyIGhlbHBlciBmdW5jdGlvbnMKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBzZXR0ZXIob2JqLCBwYXRoLCBzZXRWYWx1ZSkgewogICAgICAgIHZhciBlbGVtZW50ID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBlbGVtZW50Lmxlbmd0aCA+IDE7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5zaGlmdCgpOwogICAgICAgICAgICB2YXIgcHJvcGVydHlPYmogPSBvYmpba2V5XTsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eU9iaikgewogICAgICAgICAgICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgICAgICAgICAgIG9ialtrZXldID0gcHJvcGVydHlPYmo7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2JqID0gcHJvcGVydHlPYmo7CiAgICAgICAgfQogICAgICAgIG9ialtlbGVtZW50LnNoaWZ0KCldID0gc2V0VmFsdWU7CiAgICAgICAgcmV0dXJuIHNldFZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc2libGUgZnJvbSB0aGUgb2JqZWN0IGJ5IHBhdGguIEFueSB1bmRlZmluZWQgdHJhdmVyc2FscyBhcmUgaWdub3JlZAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHBhdGggdG8gdHJhdmVyc2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj10cnVlfSBiaW5kRm5Ub1Njb3BlCiAgICAgKiBAcmV0dXJucyB2YWx1ZSBhcyBhY2Nlc2JpbGUgYnkgcGF0aAogICAgICovCi8vVE9ETyhtaXNrbyk6IHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmVtb3ZlZAogICAgZnVuY3Rpb24gZ2V0dGVyKG9iaiwgcGF0aCwgYmluZEZuVG9TY29wZSkgewogICAgICAgIGlmICghcGF0aCkgcmV0dXJuIG9iajsKICAgICAgICB2YXIga2V5cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgICAgICB2YXIga2V5OwogICAgICAgIHZhciBsYXN0SW5zdGFuY2UgPSBvYmo7CiAgICAgICAgdmFyIGxlbiA9IGtleXMubGVuZ3RoOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgICAgIG9iaiA9IChsYXN0SW5zdGFuY2UgPSBvYmopW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFiaW5kRm5Ub1Njb3BlICYmIGlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgICAgICByZXR1cm4gYmluZChsYXN0SW5zdGFuY2UsIG9iaik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgdmFyIGdldHRlckZuQ2FjaGUgPSB7fTsKCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICAgICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAgICovCiAgICBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlLAogICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgIGlmIChwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkwXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5MSB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkxXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5MiB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkyXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5MyB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkzXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5NCB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXk0XTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwYXRoVmFsOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0dGVyRm4ocGF0aCwgY3NwKSB7CiAgICAgICAgaWYgKGdldHRlckZuQ2FjaGUuaGFzT3duUHJvcGVydHkocGF0aCkpIHsKICAgICAgICAgICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF07CiAgICAgICAgfQoKICAgICAgICB2YXIgcGF0aEtleXMgPSBwYXRoLnNwbGl0KCcuJyksCiAgICAgICAgICAgIHBhdGhLZXlzTGVuZ3RoID0gcGF0aEtleXMubGVuZ3RoLAogICAgICAgICAgICBmbjsKCiAgICAgICAgaWYgKGNzcCkgewogICAgICAgICAgICBmbiA9IChwYXRoS2V5c0xlbmd0aCA8IDYpCiAgICAgICAgICAgICAgICA/IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1swXSwgcGF0aEtleXNbMV0sIHBhdGhLZXlzWzJdLCBwYXRoS2V5c1szXSwgcGF0aEtleXNbNF0pCiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgaSA9IDAsIHZhbDsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBjc3BTYWZlR2V0dGVyRm4oCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10sIHBhdGhLZXlzW2krK10KICAgICAgICAgICAgICAgICAgICApKHNjb3BlLCBsb2NhbHMpOwoKICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB1bmRlZmluZWQ7IC8vIGNsZWFyIGFmdGVyIGZpcnN0IGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgIHNjb3BlID0gdmFsOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaSA8IHBhdGhLZXlzTGVuZ3RoKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgY29kZSA9ICd2YXIgbCwgZm4sIHA7XG4nOwogICAgICAgICAgICBmb3JFYWNoKHBhdGhLZXlzLCBmdW5jdGlvbiAoa2V5LCBpbmRleCkgewogICAgICAgICAgICAgICAgY29kZSArPSAnaWYocyA9PT0gbnVsbCB8fCBzID09PSB1bmRlZmluZWQpIHJldHVybiBzO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAgICAgICAgICdzPScgKyAoaW5kZXgKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzaW1wbHkgZGVyZWZlcmVuY2UgJ3MnIG9uIGFueSAuZG90IG5vdGF0aW9uCiAgICAgICAgICAgICAgICAgICAgPyAncycKICAgICAgICAgICAgICAgICAgICAvLyBidXQgaWYgd2UgYXJlIGZpcnN0IHRoZW4gd2UgY2hlY2sgbG9jYWxzIGZpcnN0LCBhbmQgaWYgc28gcmVhZCBpdCBmaXJzdAogICAgICAgICAgICAgICAgICAgIDogJygoayYmay5oYXNPd25Qcm9wZXJ0eSgiJyArIGtleSArICciKSk/azpzKScpICsgJ1siJyArIGtleSArICciXScgKyAnO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ2lmIChzICYmIHMudGhlbikge1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBpZiAoISgiJCR2IiBpbiBzKSkge1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBwPXM7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAuJCR2ID0gdW5kZWZpbmVkO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJyBwLnRoZW4oZnVuY3Rpb24odikge3AuJCR2PXY7fSk7XG4nICsKICAgICAgICAgICAgICAgICAgICAnfVxuJyArCiAgICAgICAgICAgICAgICAgICAgJyBzPXMuJCR2XG4nICsKICAgICAgICAgICAgICAgICAgICAnfVxuJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvZGUgKz0gJ3JldHVybiBzOyc7CiAgICAgICAgICAgIGZuID0gRnVuY3Rpb24oJ3MnLCAnaycsIGNvZGUpOyAvLyBzPXNjb3BlLCBrPWxvY2FscwogICAgICAgICAgICBmbi50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb2RlOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRwYXJzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAgICAgKiAgIHZhciBzZXR0ZXIgPSBnZXR0ZXIuYXNzaWduOwogICAgICogICB2YXIgY29udGV4dCA9IHt1c2VyOntuYW1lOidhbmd1bGFyJ319OwogICAgICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogICAgICoKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0KSkudG9FcXVhbCgnYW5ndWxhcicpOwogICAgICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAgICAgKiAgIGV4cGVjdChjb250ZXh0LnVzZXIubmFtZSkudG9FcXVhbCgnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGdldHRlcihjb250ZXh0LCBsb2NhbHMpKS50b0VxdWFsKCdsb2NhbCcpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICoKICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0aXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICogICAgICBgY29udGV4dGAuCiAgICAgKgogICAgICogICAgVGhlIHJldHVybiBmdW5jdGlvbiBhbHNvIGhhcyBhbiBgYXNzaWduYCBwcm9wZXJ0eSwgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgd2hpY2gKICAgICAqICAgIGFsbG93cyBvbmUgdG8gc2V0IHZhbHVlcyB0byBleHByZXNzaW9ucy4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkZmlsdGVyLCAkc25pZmZlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4cCkgewogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gY2FjaGVbZXhwXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBjYWNoZVtleHBdID0gcGFyc2VyKGV4cCwgZmFsc2UsICRmaWx0ZXIsICRzbmlmZmVyLmNzcCk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub29wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lIG5nLiRxCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBwcm9taXNlL2RlZmVycmVkIGltcGxlbWVudGF0aW9uIGluc3BpcmVkIGJ5IFtLcmlzIEtvd2FsJ3MgUV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKS4KICAgICAqCiAgICAgKiBbVGhlIENvbW1vbkpTIFByb21pc2UgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmNvbW1vbmpzLm9yZy93aWtpL1Byb21pc2VzKSBkZXNjcmliZXMgYSBwcm9taXNlIGFzIGFuCiAgICAgKiBpbnRlcmZhY2UgZm9yIGludGVyYWN0aW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgcmVwcmVzZW50cyB0aGUgcmVzdWx0IG9mIGFuIGFjdGlvbiB0aGF0IGlzCiAgICAgKiBwZXJmb3JtZWQgYXN5bmNocm9ub3VzbHksIGFuZCBtYXkgb3IgbWF5IG5vdCBiZSBmaW5pc2hlZCBhdCBhbnkgZ2l2ZW4gcG9pbnQgaW4gdGltZS4KICAgICAqCiAgICAgKiBGcm9tIHRoZSBwZXJzcGVjdGl2ZSBvZiBkZWFsaW5nIHdpdGggZXJyb3IgaGFuZGxpbmcsIGRlZmVycmVkIGFuZCBwcm9taXNlIEFQSXMgYXJlIHRvCiAgICAgKiBhc3luY2hyb25vdXMgcHJvZ3JhbW1pbmcgd2hhdCBgdHJ5YCwgYGNhdGNoYCBhbmQgYHRocm93YCBrZXl3b3JkcyBhcmUgdG8gc3luY2hyb25vdXMgcHJvZ3JhbW1pbmcuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gZm9yIHRoZSBwdXJwb3NlIG9mIHRoaXMgZXhhbXBsZSBsZXQncyBhc3N1bWUgdGhhdCB2YXJpYWJsZXMgYCRxYCBhbmQgYHNjb3BlYCBhcmUKICAgICAqICAgLy8gYXZhaWxhYmxlIGluIHRoZSBjdXJyZW50IGxleGljYWwgc2NvcGUgKHRoZXkgY291bGQgaGF2ZSBiZWVuIGluamVjdGVkIG9yIHBhc3NlZCBpbikuCiAgICAgKgogICAgICogICBmdW5jdGlvbiBhc3luY0dyZWV0KG5hbWUpIHsKICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqCiAqICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAvLyBzaW5jZSB0aGlzIGZuIGV4ZWN1dGVzIGFzeW5jIGluIGEgZnV0dXJlIHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AsIHdlIG5lZWQgdG8gd3JhcAogKiAgICAgICAvLyBvdXIgY29kZSBpbnRvIGFuICRhcHBseSBjYWxsIHNvIHRoYXQgdGhlIG1vZGVsIGNoYW5nZXMgYXJlIHByb3Blcmx5IG9ic2VydmVkLgogKiAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAqICAgICAgICAgaWYgKG9rVG9HcmVldChuYW1lKSkgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICogICAgICAgICB9IGVsc2UgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KCdHcmVldGluZyAnICsgbmFtZSArICcgaXMgbm90IGFsbG93ZWQuJyk7CiAqICAgICAgICAgfQogKiAgICAgICB9KTsKICogICAgIH0sIDEwMDApOwogKgogKiAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAqICAgfQogICAgICoKICAgICAqICAgdmFyIHByb21pc2UgPSBhc3luY0dyZWV0KCdSb2JpbiBIb29kJyk7CiAgICAgKiAgIHByb21pc2UudGhlbihmdW5jdGlvbihncmVldGluZykgewogKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAqICAgICBhbGVydCgnRmFpbGVkOiAnICsgcmVhc29uKTsKICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEF0IGZpcnN0IGl0IG1pZ2h0IG5vdCBiZSBvYnZpb3VzIHdoeSB0aGlzIGV4dHJhIGNvbXBsZXhpdHkgaXMgd29ydGggdGhlIHRyb3VibGUuIFRoZSBwYXlvZmYKICAgICAqIGNvbWVzIGluIHRoZSB3YXkgb2YKICAgICAqIFtndWFyYW50ZWVzIHRoYXQgcHJvbWlzZSBhbmQgZGVmZXJyZWQgQVBJcyBtYWtlXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3VuY29tbW9uanMvYmxvYi9tYXN0ZXIvcHJvbWlzZXMvc3BlY2lmaWNhdGlvbi5tZCkuCiAgICAgKgogICAgICogQWRkaXRpb25hbGx5IHRoZSBwcm9taXNlIGFwaSBhbGxvd3MgZm9yIGNvbXBvc2l0aW9uIHRoYXQgaXMgdmVyeSBoYXJkIHRvIGRvIHdpdGggdGhlCiAgICAgKiB0cmFkaXRpb25hbCBjYWxsYmFjayAoW0NQU10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db250aW51YXRpb24tcGFzc2luZ19zdHlsZSkpIGFwcHJvYWNoLgogICAgICogRm9yIG1vcmUgb24gdGhpcyBwbGVhc2Ugc2VlIHRoZSBbUSBkb2N1bWVudGF0aW9uXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpIGVzcGVjaWFsbHkgdGhlCiAgICAgKiBzZWN0aW9uIG9uIHNlcmlhbCBvciBwYXJhbGxlbCBqb2luaW5nIG9mIHByb21pc2VzLgogICAgICoKICAgICAqCiAgICAgKiAjIFRoZSBEZWZlcnJlZCBBUEkKICAgICAqCiAgICAgKiBBIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZCBpcyBjb25zdHJ1Y3RlZCBieSBjYWxsaW5nIGAkcS5kZWZlcigpYC4KICAgICAqCiAgICAgKiBUaGUgcHVycG9zZSBvZiB0aGUgZGVmZXJyZWQgb2JqZWN0IGlzIHRvIGV4cG9zZSB0aGUgYXNzb2NpYXRlZCBQcm9taXNlIGluc3RhbmNlIGFzIHdlbGwgYXMgQVBJcwogICAgICogdGhhdCBjYW4gYmUgdXNlZCBmb3Igc2lnbmFsaW5nIHRoZSBzdWNjZXNzZnVsIG9yIHVuc3VjY2Vzc2Z1bCBjb21wbGV0aW9uIG9mIHRoZSB0YXNrLgogICAgICoKICAgICAqICoqTWV0aG9kcyoqCiAgICAgKgogICAgICogLSBgcmVzb2x2ZSh2YWx1ZSlgIOKAkyByZXNvbHZlcyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGB2YWx1ZWAuIElmIHRoZSB2YWx1ZSBpcyBhIHJlamVjdGlvbgogICAgICogICBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAsIHRoZSBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgaW5zdGVhZC4KICAgICAqIC0gYHJlamVjdChyZWFzb24pYCDigJMgcmVqZWN0cyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGByZWFzb25gLiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8KICAgICAqICAgcmVzb2x2aW5nIGl0IHdpdGggYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLgogICAgICoKICAgICAqICoqUHJvcGVydGllcyoqCiAgICAgKgogICAgICogLSBwcm9taXNlIOKAkyBge1Byb21pc2V9YCDigJMgcHJvbWlzZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVmZXJyZWQuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIFByb21pc2UgQVBJCiAgICAgKgogICAgICogQSBuZXcgcHJvbWlzZSBpbnN0YW5jZSBpcyBjcmVhdGVkIHdoZW4gYSBkZWZlcnJlZCBpbnN0YW5jZSBpcyBjcmVhdGVkIGFuZCBjYW4gYmUgcmV0cmlldmVkIGJ5CiAgICAgKiBjYWxsaW5nIGBkZWZlcnJlZC5wcm9taXNlYC4KICAgICAqCiAgICAgKiBUaGUgcHVycG9zZSBvZiB0aGUgcHJvbWlzZSBvYmplY3QgaXMgdG8gYWxsb3cgZm9yIGludGVyZXN0ZWQgcGFydGllcyB0byBnZXQgYWNjZXNzIHRvIHRoZSByZXN1bHQKICAgICAqIG9mIHRoZSBkZWZlcnJlZCB0YXNrIHdoZW4gaXQgY29tcGxldGVzLgogICAgICoKICAgICAqICoqTWV0aG9kcyoqCiAgICAgKgogICAgICogLSBgdGhlbihzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spYCDigJMgcmVnYXJkbGVzcyBvZiB3aGVuIHRoZSBwcm9taXNlIHdhcyBvciB3aWxsIGJlIHJlc29sdmVkCiAgICAgKiAgIG9yIHJlamVjdGVkIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkgYXMgc29vbiBhcyB0aGUgcmVzdWx0CiAgICAgKiAgIGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQgdGhlIHJlc3VsdCBvciByZWplY3Rpb24gcmVhc29uLgogICAgICoKICAgICAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAgICAgKiAgIGBzdWNjZXNzQ2FsbGJhY2tgIG9yIGBlcnJvckNhbGxiYWNrYC4KICAgICAqCiAgICAgKgogICAgICogIyBDaGFpbmluZyBwcm9taXNlcwogICAgICoKICAgICAqIEJlY2F1c2UgY2FsbGluZyBgdGhlbmAgYXBpIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5IHBvc3NpYmxlCiAgICAgKiB0byBjcmVhdGUgYSBjaGFpbiBvZiBwcm9taXNlczoKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAqICAgICByZXR1cm4gcmVzdWx0ICsgMTsKICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIHByb21pc2VCIHdpbGwgYmUgcmVzb2x2ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgcHJvbWlzZUEgaXMgcmVzb2x2ZWQgYW5kIGl0cyB2YWx1ZSB3aWxsIGJlCiAgICAgKiAgIC8vIHRoZSByZXN1bHQgb2YgcHJvbWlzZUEgaW5jcmVtZW50ZWQgYnkgMQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogSXQgaXMgcG9zc2libGUgdG8gY3JlYXRlIGNoYWlucyBvZiBhbnkgbGVuZ3RoIGFuZCBzaW5jZSBhIHByb21pc2UgY2FuIGJlIHJlc29sdmVkIHdpdGggYW5vdGhlcgogICAgICogcHJvbWlzZSAod2hpY2ggd2lsbCBkZWZlciBpdHMgcmVzb2x1dGlvbiBmdXJ0aGVyKSwgaXQgaXMgcG9zc2libGUgdG8gcGF1c2UvZGVmZXIgcmVzb2x1dGlvbiBvZgogICAgICogdGhlIHByb21pc2VzIGF0IGFueSBwb2ludCBpbiB0aGUgY2hhaW4uIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gaW1wbGVtZW50IHBvd2VyZnVsIGFwaXMgbGlrZQogICAgICogJGh0dHAncyByZXNwb25zZSBpbnRlcmNlcHRvcnMuCiAgICAgKgogICAgICoKICAgICAqICMgRGlmZmVyZW5jZXMgYmV0d2VlbiBLcmlzIEtvd2FsJ3MgUSBhbmQgJHEKICAgICAqCiAgICAgKiAgVGhlcmUgYXJlIHRocmVlIG1haW4gZGlmZmVyZW5jZXM6CiAgICAgKgogICAgICogLSAkcSBpcyBpbnRlZ3JhdGVkIHdpdGggdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlfSBTY29wZSBtb2RlbCBvYnNlcnZhdGlvbgogICAgICogICBtZWNoYW5pc20gaW4gYW5ndWxhciwgd2hpY2ggbWVhbnMgZmFzdGVyIHByb3BhZ2F0aW9uIG9mIHJlc29sdXRpb24gb3IgcmVqZWN0aW9uIGludG8geW91cgogICAgICogICBtb2RlbHMgYW5kIGF2b2lkaW5nIHVubmVjZXNzYXJ5IGJyb3dzZXIgcmVwYWludHMsIHdoaWNoIHdvdWxkIHJlc3VsdCBpbiBmbGlja2VyaW5nIFVJLgogICAgICogLSAkcSBwcm9taXNlcyBhcmUgcmVjb2duaXplZCBieSB0aGUgdGVtcGxhdGluZyBlbmdpbmUgaW4gYW5ndWxhciwgd2hpY2ggbWVhbnMgdGhhdCBpbiB0ZW1wbGF0ZXMKICAgICAqICAgeW91IGNhbiB0cmVhdCBwcm9taXNlcyBhdHRhY2hlZCB0byBhIHNjb3BlIGFzIGlmIHRoZXkgd2VyZSB0aGUgcmVzdWx0aW5nIHZhbHVlcy4KICAgICAqIC0gUSBoYXMgbWFueSBtb3JlIGZlYXR1cmVzIHRoYW4gJHEsIGJ1dCB0aGF0IGNvbWVzIGF0IGEgY29zdCBvZiBieXRlcy4gJHEgaXMgdGlueSwgYnV0IGNvbnRhaW5zCiAgICAgKiAgIGFsbCB0aGUgaW1wb3J0YW50IGZ1bmN0aW9uYWxpdHkgbmVlZGVkIGZvciBjb21tb24gYXN5bmMgdGFza3MuCiAgICAgKgogICAgICogICMgVGVzdGluZwogICAgICoKICAgICAqICA8cHJlPgogICAgICogICAgaXQoJ3Nob3VsZCBzaW11bGF0ZSBwcm9taXNlJywgaW5qZWN0KGZ1bmN0aW9uKCRxLCAkcm9vdFNjb3BlKSB7CiAqICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICogICAgICB2YXIgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2U7CiAqICAgICAgdmFyIHJlc29sdmVkVmFsdWU7CiAqIAogKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFNpbXVsYXRlIHJlc29sdmluZyBvZiBwcm9taXNlCiAqICAgICAgZGVmZXJyZWQucmVzb2x2ZSgxMjMpOwogKiAgICAgIC8vIE5vdGUgdGhhdCB0aGUgJ3RoZW4nIGZ1bmN0aW9uIGRvZXMgbm90IGdldCBjYWxsZWQgc3luY2hyb25vdXNseS4KICogICAgICAvLyBUaGlzIGlzIGJlY2F1c2Ugd2Ugd2FudCB0aGUgcHJvbWlzZSBBUEkgdG8gYWx3YXlzIGJlIGFzeW5jLCB3aGV0aGVyIG9yIG5vdAogKiAgICAgIC8vIGl0IGdvdCBjYWxsZWQgc3luY2hyb25vdXNseSBvciBhc3luY2hyb25vdXNseS4KICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogKiAKICogICAgICAvLyBQcm9wYWdhdGUgcHJvbWlzZSByZXNvbHV0aW9uIHRvICd0aGVuJyBmdW5jdGlvbnMgdXNpbmcgJGFwcGx5KCkuCiAqICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9FcXVhbCgxMjMpOwogKiAgICB9KTsKICAgICAqICA8L3ByZT4KICAgICAqLwogICAgZnVuY3Rpb24gJFFQcm92aWRlcigpIHsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgZnVuY3Rpb24gKCRyb290U2NvcGUsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgIHJldHVybiBxRmFjdG9yeShmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICAgICAgICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICAgICAgICB9XTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDb25zdHJ1Y3RzIGEgcHJvbWlzZSBtYW5hZ2VyLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZnVuY3Rpb24pfSBuZXh0VGljayBGdW5jdGlvbiBmb3IgZXhlY3V0aW5nIGZ1bmN0aW9ucyBpbiB0aGUgbmV4dCB0dXJuLgogICAgICogQHBhcmFtIHtmdW5jdGlvbiguLi4qKX0gZXhjZXB0aW9uSGFuZGxlciBGdW5jdGlvbiBpbnRvIHdoaWNoIHVuZXhwZWN0ZWQgZXhjZXB0aW9ucyBhcmUgcGFzc2VkIGZvcgogICAgICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFByb21pc2UgbWFuYWdlci4KICAgICAqLwogICAgZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjZGVmZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHEKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDcmVhdGVzIGEgYERlZmVycmVkYCBvYmplY3Qgd2hpY2ggcmVwcmVzZW50cyBhIHRhc2sgd2hpY2ggd2lsbCBmaW5pc2ggaW4gdGhlIGZ1dHVyZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtEZWZlcnJlZH0gUmV0dXJucyBhIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZC4KICAgICAgICAgKi8KICAgICAgICB2YXIgZGVmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gW10sCiAgICAgICAgICAgICAgICB2YWx1ZSwgZGVmZXJyZWQ7CgogICAgICAgICAgICBkZWZlcnJlZCA9IHsKCiAgICAgICAgICAgICAgICByZXNvbHZlOiBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHBlbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVmKHZhbCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbihjYWxsYmFja1swXSwgY2FsbGJhY2tbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZWplY3QocmVhc29uKSk7CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBwcm9taXNlOiB7CiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRDYWxsYmFjayA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLnB1c2goW3dyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2tdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICAgICAgfTsKCgogICAgICAgIHZhciByZWYgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLnRoZW4pIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgICAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoY2FsbGJhY2sodmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI3JlamVjdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgICAgICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgICAgICAgKiBhIHByb21pc2UgY2hhaW4sIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LgogICAgICAgICAqCiAgICAgICAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICAgICAgICogYHJlamVjdGAgYXMgdGhlIGB0aHJvd2Aga2V5d29yZCBpbiBKYXZhU2NyaXB0LiBUaGlzIGFsc28gbWVhbnMgdGhhdCBpZiB5b3UgImNhdGNoIiBhbiBlcnJvciB2aWEKICAgICAgICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgICAgICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAgICAgICAqIGByZWplY3RgLgogICAgICAgICAqCiAgICAgICAgICogPHByZT4KICAgICAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgKiAgICAgLy8gc3VjY2VzczogZG8gc29tZXRoaW5nIGFuZCByZXNvbHZlIHByb21pc2VCCiAgICogICAgIC8vICAgICAgICAgIHdpdGggdGhlIG9sZCBvciBhIG5ldyByZXN1bHQKICAgKiAgICAgcmV0dXJuIHJlc3VsdDsKICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAqICAgICAvLyBlcnJvcjogaGFuZGxlIHRoZSBlcnJvciBpZiBwb3NzaWJsZSBhbmQKICAgKiAgICAgLy8gICAgICAgIHJlc29sdmUgcHJvbWlzZUIgd2l0aCBuZXdQcm9taXNlT3JWYWx1ZSwKICAgKiAgICAgLy8gICAgICAgIG90aGVyd2lzZSBmb3J3YXJkIHRoZSByZWplY3Rpb24gdG8gcHJvbWlzZUIKICAgKiAgICAgaWYgKGNhbkhhbmRsZShyZWFzb24pKSB7CiAgICogICAgICAvLyBoYW5kbGUgdGhlIGVycm9yIGFuZCByZWNvdmVyCiAgICogICAgICByZXR1cm4gbmV3UHJvbWlzZU9yVmFsdWU7CiAgICogICAgIH0KICAgKiAgICAgcmV0dXJuICRxLnJlamVjdChyZWFzb24pOwogICAqICAgfSk7CiAgICAgICAgICogPC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHJlYXNvbiBDb25zdGFudCwgbWVzc2FnZSwgZXhjZXB0aW9uIG9yIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlamVjdGlvbiByZWFzb24uCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICAgICAgICovCiAgICAgICAgdmFyIHJlamVjdCA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uIChjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgICAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjd2hlbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICAgICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAgICAgKi8KICAgICAgICB2YXIgd2hlbiA9IGZ1bmN0aW9uICh2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCksCiAgICAgICAgICAgICAgICBkb25lOwoKICAgICAgICAgICAgdmFyIHdyYXBwZWRDYWxsYmFjayA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGNhbGxiYWNrIHx8IGRlZmF1bHRDYWxsYmFjaykodmFsdWUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlcnJiYWNrIHx8IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJlZih2YWx1ZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHJlZih2YWx1ZSkudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrKSk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh3cmFwcGVkRXJyYmFjayhyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICB9OwoKCiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdENhbGxiYWNrKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0RXJyYmFjayhyZWFzb24pIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdChyZWFzb24pOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYwogICAgICAgICAqIEBuYW1lIG5nLiRxI2FsbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbWJpbmVzIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gYWxsIG9mIHRoZSBpbnB1dAogICAgICAgICAqIHByb21pc2VzIGFyZSByZXNvbHZlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvZiBwcm9taXNlcy4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5IG9mIHZhbHVlcywKICAgICAgICAgKiAgIGVhY2ggdmFsdWUgY29ycmVzcG9uZGluZyB0byB0aGUgcHJvbWlzZSBhdCB0aGUgc2FtZSBpbmRleCBpbiB0aGUgYHByb21pc2VzYCBhcnJheS4gSWYgYW55IG9mCiAgICAgICAgICogICB0aGUgcHJvbWlzZXMgaXMgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbiwgdGhpcyByZXN1bHRpbmcgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggdGhlCiAgICAgICAgICogICBzYW1lIHJlamVjdGlvbi4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGNvdW50ZXIgPSBwcm9taXNlcy5sZW5ndGgsCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICBpZiAoY291bnRlcikgewogICAgICAgICAgICAgICAgZm9yRWFjaChwcm9taXNlcywgZnVuY3Rpb24gKHByb21pc2UsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcmVmKHByb21pc2UpLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCBpbiByZXN1bHRzKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKC0tY291bnRlcikpIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggaW4gcmVzdWx0cykgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkZWZlcjogZGVmZXIsCiAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICB3aGVuOiB3aGVuLAogICAgICAgICAgICBhbGw6IGFsbAogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm91dGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgcm91dGVzLiBTZWUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IGZvciBhbiBleGFtcGxlLgogICAgICovCiAgICBmdW5jdGlvbiAkUm91dGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgcm91dGVzID0ge307CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGVQcm92aWRlciN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBSb3V0ZSBwYXRoIChtYXRjaGVkIGFnYWluc3QgYCRsb2NhdGlvbi5wYXRoYCkuIElmIGAkbG9jYXRpb24ucGF0aGAKICAgICAgICAgKiAgICBjb250YWlucyByZWR1bmRhbnQgdHJhaWxpbmcgc2xhc2ggb3IgaXMgbWlzc2luZyBvbmUsIHRoZSByb3V0ZSB3aWxsIHN0aWxsIG1hdGNoIGFuZCB0aGUKICAgICAgICAgKiAgICBgJGxvY2F0aW9uLnBhdGhgIHdpbGwgYmUgdXBkYXRlZCB0byBhZGQgb3IgZHJvcCB0aGUgdHJhaWxpbmcgc2xhc2ggdG8gZXhhY3RseSBtYXRjaCB0aGUKICAgICAgICAgKiAgICByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAqCiAgICAgICAgICogICAgYHBhdGhgIGNhbiBjb250YWluIG5hbWVkIGdyb3VwcyBzdGFydGluZyB3aXRoIGEgY29sb24gKGA6bmFtZWApLiBBbGwgY2hhcmFjdGVycyB1cCB0byB0aGUKICAgICAgICAgKiAgICBuZXh0IHNsYXNoIGFyZSBtYXRjaGVkIGFuZCBzdG9yZWQgaW4gYCRyb3V0ZVBhcmFtc2AgdW5kZXIgdGhlIGdpdmVuIGBuYW1lYCB3aGVuIHRoZSByb3V0ZQogICAgICAgICAqICAgIG1hdGNoZXMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcm91dGUgTWFwcGluZyBpbmZvcm1hdGlvbiB0byBiZSBhc3NpZ25lZCB0byBgJHJvdXRlLmN1cnJlbnRgIG9uIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2guCiAgICAgICAgICoKICAgICAgICAgKiAgICBPYmplY3QgcHJvcGVydGllczoKICAgICAgICAgKgogICAgICAgICAqICAgIC0gYGNvbnRyb2xsZXJgIOKAkyBgeyhzdHJpbmd8ZnVuY3Rpb24oKT19YCDigJMgQ29udHJvbGxlciBmbiB0aGF0IHNob3VsZCBiZSBhc3NvY2lhdGVkIHdpdGggbmV3bHkKICAgICAgICAgKiAgICAgIGNyZWF0ZWQgc2NvcGUgb3IgdGhlIG5hbWUgb2YgYSB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29udHJvbGxlciByZWdpc3RlcmVkIGNvbnRyb2xsZXJ9CiAgICAgICAgICogICAgICBpZiBwYXNzZWQgYXMgYSBzdHJpbmcuCiAgICAgICAgICogICAgLSBgdGVtcGxhdGVgIOKAkyBge3N0cmluZz19YCDigJMgIGh0bWwgdGVtcGxhdGUgYXMgYSBzdHJpbmcgdGhhdCBzaG91bGQgYmUgdXNlZCBieQogICAgICAgICAqICAgICAge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1ZpZXcgbmdWaWV3fSBvcgogICAgICAgICAqICAgICAge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUgbmdJbmNsdWRlfSBkaXJlY3RpdmVzLgogICAgICAgICAqICAgICAgdGhpcyBwcm9wZXJ0eSB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgYHRlbXBsYXRlVXJsYC4KICAgICAgICAgKiAgICAtIGB0ZW1wbGF0ZVVybGAg4oCTIGB7c3RyaW5nPX1gIOKAkyBwYXRoIHRvIGFuIGh0bWwgdGVtcGxhdGUgdGhhdCBzaG91bGQgYmUgdXNlZCBieQogICAgICAgICAqICAgICAge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1ZpZXcgbmdWaWV3fS4KICAgICAgICAgKiAgICAtIGByZXNvbHZlYCAtIGB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uPj19YCAtIEFuIG9wdGlvbmFsIG1hcCBvZiBkZXBlbmRlbmNpZXMgd2hpY2ggc2hvdWxkCiAgICAgICAgICogICAgICBiZSBpbmplY3RlZCBpbnRvIHRoZSBjb250cm9sbGVyLiBJZiBhbnkgb2YgdGhlc2UgZGVwZW5kZW5jaWVzIGFyZSBwcm9taXNlcywgdGhleSB3aWxsIGJlCiAgICAgICAgICogICAgICByZXNvbHZlZCBhbmQgY29udmVydGVkIHRvIGEgdmFsdWUgYmVmb3JlIHRoZSBjb250cm9sbGVyIGlzIGluc3RhbnRpYXRlZCBhbmQgdGhlCiAgICAgICAgICogICAgICBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgZXZlbnQgaXMgZmlyZWQuIFRoZSBtYXAgb2JqZWN0IGlzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGBrZXlgIOKAkyBge3N0cmluZ31gOiBhIG5hbWUgb2YgYSBkZXBlbmRlbmN5IHRvIGJlIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuCiAgICAgICAgICogICAgICAtIGBmYWN0b3J5YCAtIGB7c3RyaW5nfGZ1bmN0aW9ufWA6IElmIGBzdHJpbmdgIHRoZW4gaXQgaXMgYW4gYWxpYXMgZm9yIGEgc2VydmljZS4KICAgICAgICAgKiAgICAgICAgT3RoZXJ3aXNlIGlmIGZ1bmN0aW9uLCB0aGVuIGl0IGlzIHtAbGluayBhcGkvQVVUTy4kaW5qZWN0b3IjaW52b2tlIGluamVjdGVkfQogICAgICAgICAqICAgICAgICBhbmQgdGhlIHJldHVybiB2YWx1ZSBpcyB0cmVhdGVkIGFzIHRoZSBkZXBlbmRlbmN5LiBJZiB0aGUgcmVzdWx0IGlzIGEgcHJvbWlzZSwgaXQgaXMgcmVzb2x2ZWQKICAgICAgICAgKiAgICAgICAgYmVmb3JlIGl0cyB2YWx1ZSBpcyBpbmplY3RlZCBpbnRvIHRoZSBjb250cm9sbGVyLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgcmVkaXJlY3RUb2Ag4oCTIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0g4oCTIHZhbHVlIHRvIHVwZGF0ZQogICAgICAgICAqICAgICAge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb259IHBhdGggd2l0aCBhbmQgdHJpZ2dlciByb3V0ZSByZWRpcmVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgYHJlZGlyZWN0VG9gIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0LjxzdHJpbmc+fWAgLSByb3V0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgIGAkbG9jYXRpb24ucGF0aCgpYCBieSBhcHBseWluZyB0aGUgY3VycmVudCByb3V0ZSB0ZW1wbGF0ZVVybC4KICAgICAgICAgKiAgICAgIC0gYHtzdHJpbmd9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5wYXRoKClgCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0fWAgLSBjdXJyZW50IGAkbG9jYXRpb24uc2VhcmNoKClgCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIFRoZSBjdXN0b20gYHJlZGlyZWN0VG9gIGZ1bmN0aW9uIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHN0cmluZyB3aGljaCB3aWxsIGJlIHVzZWQKICAgICAgICAgKiAgICAgIHRvIHVwZGF0ZSBgJGxvY2F0aW9uLnBhdGgoKWAgYW5kIGAkbG9jYXRpb24uc2VhcmNoKClgLgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgW3JlbG9hZE9uU2VhcmNoPXRydWVdYCAtIHtib29sZWFuPX0gLSByZWxvYWQgcm91dGUgd2hlbiBvbmx5ICRsb2NhdGlvbi5zZWFyY2goKQogICAgICAgICAqICAgIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgIElmIHRoZSBvcHRpb24gaXMgc2V0IHRvIGBmYWxzZWAgYW5kIHVybCBpbiB0aGUgYnJvd3NlciBjaGFuZ2VzLCB0aGVuCiAgICAgICAgICogICAgICBgJHJvdXRlVXBkYXRlYCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGUgcm9vdCBzY29wZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHNlbGYKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBuZXcgcm91dGUgZGVmaW5pdGlvbiB0byB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLndoZW4gPSBmdW5jdGlvbiAocGF0aCwgcm91dGUpIHsKICAgICAgICAgICAgcm91dGVzW3BhdGhdID0gZXh0ZW5kKHtyZWxvYWRPblNlYXJjaDogdHJ1ZX0sIHJvdXRlKTsKCiAgICAgICAgICAgIC8vIGNyZWF0ZSByZWRpcmVjdGlvbiBmb3IgdHJhaWxpbmcgc2xhc2hlcwogICAgICAgICAgICBpZiAocGF0aCkgewogICAgICAgICAgICAgICAgdmFyIHJlZGlyZWN0UGF0aCA9IChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gPT0gJy8nKQogICAgICAgICAgICAgICAgICAgID8gcGF0aC5zdWJzdHIoMCwgcGF0aC5sZW5ndGggLSAxKQogICAgICAgICAgICAgICAgICAgIDogcGF0aCArICcvJzsKCiAgICAgICAgICAgICAgICByb3V0ZXNbcmVkaXJlY3RQYXRoXSA9IHtyZWRpcmVjdFRvOiBwYXRofTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI290aGVyd2lzZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm91dGVQcm92aWRlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyByb3V0ZSBkZWZpbml0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHJvdXRlIGNoYW5nZSB3aGVuIG5vIG90aGVyIHJvdXRlIGRlZmluaXRpb24KICAgICAgICAgKiBpcyBtYXRjaGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAuCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqLwogICAgICAgIHRoaXMub3RoZXJ3aXNlID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgICAgICAgICB0aGlzLndoZW4obnVsbCwgcGFyYW1zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckbG9jYXRpb24nLCAnJHJvdXRlUGFyYW1zJywgJyRxJywgJyRpbmplY3RvcicsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkbG9jYXRpb24sICRyb3V0ZVBhcmFtcywgJHEsICRpbmplY3RvciwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkbG9jYXRpb24KICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcm91dGVQYXJhbXMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge09iamVjdH0gY3VycmVudCBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgcm91dGUgZGVmaW5pdGlvbi4KICAgICAgICAgICAgICAgICAqIFRoZSByb3V0ZSBkZWZpbml0aW9uIGNvbnRhaW5zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSBgY29udHJvbGxlcmA6IFRoZSBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGFzIGRlZmluZSBpbiByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogICAtIGBsb2NhbHNgOiBBIG1hcCBvZiBsb2NhbHMgd2hpY2ggaXMgdXNlZCBieSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXJ9IHNlcnZpY2UgZm9yCiAgICAgICAgICAgICAgICAgKiAgICAgY29udHJvbGxlciBpbnN0YW50aWF0aW9uLiBUaGUgYGxvY2Fsc2AgY29udGFpbgogICAgICAgICAgICAgICAgICogICAgIHRoZSByZXNvbHZlZCB2YWx1ZXMgb2YgdGhlIGByZXNvbHZlYCBtYXAuIEFkZGl0aW9uYWxseSB0aGUgYGxvY2Fsc2AgYWxzbyBjb250YWluOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgICAtIGAkc2NvcGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiAgICAgLSBgJHRlbXBsYXRlYCAtIFRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlIEhUTUwuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcm91dGVzIEFycmF5IG9mIGFsbCBjb25maWd1cmVkIHJvdXRlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIElzIHVzZWQgZm9yIGRlZXAtbGlua2luZyBVUkxzIHRvIGNvbnRyb2xsZXJzIGFuZCB2aWV3cyAoSFRNTCBwYXJ0aWFscykuCiAgICAgICAgICAgICAgICAgKiBJdCB3YXRjaGVzIGAkbG9jYXRpb24udXJsKClgIGFuZCB0cmllcyB0byBtYXAgdGhlIHBhdGggdG8gYW4gZXhpc3Rpbmcgcm91dGUgZGVmaW5pdGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBZb3UgY2FuIGRlZmluZSByb3V0ZXMgdGhyb3VnaCB7QGxpbmsgbmcuJHJvdXRlUHJvdmlkZXIgJHJvdXRlUHJvdmlkZXJ9J3MgQVBJLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSBgJHJvdXRlYCBzZXJ2aWNlIGlzIHR5cGljYWxseSB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGgge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1ZpZXcgbmdWaWV3fQogICAgICAgICAgICAgICAgICogZGlyZWN0aXZlIGFuZCB0aGUge0BsaW5rIG5nLiRyb3V0ZVBhcmFtcyAkcm91dGVQYXJhbXN9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IGNoYW5naW5nIHRoZSBVUkwgaGFzaCBjYXVzZXMgdGhlIGAkcm91dGVgIHRvIG1hdGNoIGEgcm91dGUgYWdhaW5zdCB0aGUKICAgICAgICAgICAgICAgICBVUkwsIGFuZCB0aGUgYG5nVmlld2AgcHVsbHMgaW4gdGhlIHBhcnRpYWwuCgogICAgICAgICAgICAgICAgIE5vdGUgdGhhdCB0aGlzIGV4YW1wbGUgaXMgdXNpbmcge0BsaW5rIG5nLmRpcmVjdGl2ZTpzY3JpcHQgaW5saW5lZCB0ZW1wbGF0ZXN9CiAgICAgICAgICAgICAgICAgdG8gZ2V0IGl0IHdvcmtpbmcgb24ganNmaWRkbGUgYXMgd2VsbC4KCiAgICAgICAgICAgICAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgICAgICAgICAgICAgIENob29zZToKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgICAgICAgICAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgICAgICAgICAgICAgIDxociAvPgoKICAgICAgICAgICAgICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICAgICAgICAgICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICAgICAgICAgICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICAgICAgICAgICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgICAgICAgICAgICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICAgICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQnLCB7CiAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ2Jvb2suaHRtbCcsCiAgICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bCwKICAgICAgICAgICAgIHJlc29sdmU6IHsKICAgICAgICAgICAgICAgLy8gSSB3aWxsIGNhdXNlIGEgMSBzZWNvbmQgZGVsYXkKICAgICAgICAgICAgICAgZGVsYXk6IGZ1bmN0aW9uKCRxLCAkdGltZW91dCkgewogICAgICAgICAgICAgICAgIHZhciBkZWxheSA9ICRxLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZGVsYXkucmVzb2x2ZSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGF5LnByb21pc2U7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0KICAgICAgICAgICB9KTsKICAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ2NoYXB0ZXIuaHRtbCcsCiAgICAgICAgICAgICBjb250cm9sbGVyOiBDaGFwdGVyQ250bAogICAgICAgICAgIH0pOwoKICAgICAgICAgICAvLyBjb25maWd1cmUgaHRtbDUgdG8gZ2V0IGxpbmtzIHdvcmtpbmcgb24ganNmaWRkbGUKICAgICAgICAgICAkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUodHJ1ZSk7CiAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlID0gJHJvdXRlOwogICAgICAgICAgICRzY29wZS4kbG9jYXRpb24gPSAkbG9jYXRpb247CiAgICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQoKICAgICAgICAgICAgICAgICBmdW5jdGlvbiBCb29rQ250bCgkc2NvcGUsICRyb3V0ZVBhcmFtcykgewogICAgICAgICAgICRzY29wZS5uYW1lID0gIkJvb2tDbnRsIjsKICAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIENoYXB0ZXJDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQ2hhcHRlckNudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGxvYWQgYW5kIGNvbXBpbGUgY29ycmVjdCB0ZW1wbGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGVsZW1lbnQoJ2E6Y29udGFpbnMoIk1vYnk6IENoMSIpJykuY2xpY2soKTsKICAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IENoYXB0ZXJDbnRsLyk7CiAgICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0Jvb2sgSWRcOiBNb2J5Lyk7CiAgICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgIGVsZW1lbnQoJ2E6Y29udGFpbnMoIlNjYXJsZXQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgc2xlZXAoMik7IC8vIHByb21pc2VzIGFyZSBub3QgcGFydCBvZiBzY2VuYXJpbyB3YWl0aW5nCiAgICAgICAgICAgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0Jvb2sgSWRcOiBTY2FybGV0Lyk7CiAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8L2V4YW1wbGU+CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN0YXJ0CiAgICAgICAgICAgICAgICAgKiBAZXZlbnRPZiBuZy4kcm91dGUKICAgICAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQnJvYWRjYXN0ZWQgYmVmb3JlIGEgcm91dGUgY2hhbmdlLiBBdCB0aGlzICBwb2ludCB0aGUgcm91dGUgc2VydmljZXMgc3RhcnRzCiAgICAgICAgICAgICAgICAgKiByZXNvbHZpbmcgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgbmVlZGVkIGZvciB0aGUgcm91dGUgY2hhbmdlIHRvIG9jY3Vycy4KICAgICAgICAgICAgICAgICAqIFR5cGljYWxseSB0aGlzIGludm9sdmVzIGZldGNoaW5nIHRoZSB2aWV3IHRlbXBsYXRlIGFzIHdlbGwgYXMgYW55IGRlcGVuZGVuY2llcwogICAgICAgICAgICAgICAgICogZGVmaW5lZCBpbiBgcmVzb2x2ZWAgcm91dGUgcHJvcGVydHkuIE9uY2UgIGFsbCBvZiB0aGUgZGVwZW5kZW5jaWVzIGFyZSByZXNvbHZlZAogICAgICAgICAgICAgICAgICogYCRyb3V0ZUNoYW5nZVN1Y2Nlc3NgIGlzIGZpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Um91dGV9IG5leHQgRnV0dXJlIHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VTdWNjZXNzCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRPZiBuZy4kcm91dGUKICAgICAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQnJvYWRjYXN0ZWQgYWZ0ZXIgYSByb3V0ZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkLgogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1ZpZXcgbmdWaWV3fSBsaXN0ZW5zIGZvciB0aGUgZGlyZWN0aXZlCiAgICAgICAgICAgICAgICAgKiB0byBpbnN0YW50aWF0ZSB0aGUgY29udHJvbGxlciBhbmQgcmVuZGVyIHRoZSB2aWV3LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Um91dGV9IGN1cnJlbnQgQ3VycmVudCByb3V0ZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Um91dGV8VW5kZWZpbmVkfSBwcmV2aW91cyBQcmV2aW91cyByb3V0ZSBpbmZvcm1hdGlvbiwgb3IgdW5kZWZpbmVkIGlmIGN1cnJlbnQgaXMgZmlyc3Qgcm91dGUgZW50ZXJlZC4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlRXJyb3IKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBpZiBhbnkgb2YgdGhlIHJlc29sdmUgcHJvbWlzZXMgYXJlIHJlamVjdGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Um91dGV9IGN1cnJlbnQgQ3VycmVudCByb3V0ZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Um91dGV9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcmVqZWN0aW9uIFJlamVjdGlvbiBvZiB0aGUgcHJvbWlzZS4gVXN1YWxseSB0aGUgZXJyb3Igb2YgdGhlIGZhaWxlZCBwcm9taXNlLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVVcGRhdGUKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGByZWxvYWRPblNlYXJjaGAgcHJvcGVydHkgaGFzIGJlZW4gc2V0IHRvIGZhbHNlLCBhbmQgd2UgYXJlIHJldXNpbmcgdGhlIHNhbWUKICAgICAgICAgICAgICAgICAqIGluc3RhbmNlIG9mIHRoZSBDb250cm9sbGVyLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgdmFyIGZvcmNlUmVsb2FkID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlID0gewogICAgICAgICAgICAgICAgICAgICAgICByb3V0ZXM6IHJvdXRlcywKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSNyZWxvYWQKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQ2F1c2VzIGAkcm91dGVgIHNlcnZpY2UgdG8gcmVsb2FkIHRoZSBjdXJyZW50IHJvdXRlIGV2ZW4gaWYKICAgICAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb259IGhhc24ndCBjaGFuZ2VkLgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBBcyBhIHJlc3VsdCBvZiB0aGF0LCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgICAgICAgICAqIGNyZWF0ZXMgbmV3IHNjb3BlLCByZWluc3RhbnRpYXRlcyB0aGUgY29udHJvbGxlci4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbG9hZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VSZWxvYWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKHVwZGF0ZVJvdXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kb24oJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCB1cGRhdGVSb3V0ZSk7CgogICAgICAgICAgICAgICAgcmV0dXJuICRyb3V0ZTsKCiAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG9uIHtzdHJpbmd9IGN1cnJlbnQgdXJsCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gd2hlbiB7c3RyaW5nfSByb3V0ZSB3aGVuIHRlbXBsYXRlIHRvIG1hdGNoIHRoZSB1cmwgYWdhaW5zdAogICAgICAgICAgICAgICAgICogQHJldHVybiB7P09iamVjdH0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc3dpdGNoUm91dGVNYXRjaGVyKG9uLCB3aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyhpKTogdGhpcyBjb2RlIGlzIGNvbnZvbHV0ZWQgYW5kIGluZWZmaWNpZW50LCB3ZSBzaG91bGQgY29uc3RydWN0IHRoZSByb3V0ZSBtYXRjaGluZwogICAgICAgICAgICAgICAgICAgIC8vICAgcmVnZXggb25seSBvbmNlIGFuZCB0aGVuIHJldXNlIGl0CgogICAgICAgICAgICAgICAgICAgIC8vIEVzY2FwZSByZWdleHAgc3BlY2lhbCBjaGFyYWN0ZXJzLgogICAgICAgICAgICAgICAgICAgIHdoZW4gPSAnXicgKyB3aGVuLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAiXFwkJiIpICsgJyQnOwogICAgICAgICAgICAgICAgICAgIHZhciByZWdleCA9ICcnLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0ID0ge307CgogICAgICAgICAgICAgICAgICAgIHZhciByZSA9IC86KFx3KykvZywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1NYXRjaCwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoZWRJbmRleCA9IDA7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlICgocGFyYW1NYXRjaCA9IHJlLmV4ZWMod2hlbikpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgZWFjaCA6cGFyYW0gaW4gYHdoZW5gIGFuZCByZXBsYWNlIGl0IHdpdGggYSBjYXB0dXJpbmcgZ3JvdXAuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCBhbGwgb3RoZXIgc2VjdGlvbnMgb2Ygd2hlbiB1bmNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2V4ICs9IHdoZW4uc2xpY2UobGFzdE1hdGNoZWRJbmRleCwgcGFyYW1NYXRjaC5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2V4ICs9ICcoW15cXC9dKiknOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbU1hdGNoWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoZWRJbmRleCA9IHJlLmxhc3RJbmRleDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIHRyYWlsaW5nIHBhdGggcGFydC4KICAgICAgICAgICAgICAgICAgICByZWdleCArPSB3aGVuLnN1YnN0cihsYXN0TWF0Y2hlZEluZGV4KTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gb24ubWF0Y2gobmV3IFJlZ0V4cChyZWdleCkpOwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24gKG5hbWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3RbbmFtZV0gPSBtYXRjaFtpbmRleCArIDFdOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoID8gZHN0IDogbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVSb3V0ZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHBhcnNlUm91dGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9ICRyb3V0ZS5jdXJyZW50OwoKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBsYXN0ICYmIG5leHQuJCRyb3V0ZSA9PT0gbGFzdC4kJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICYmIGVxdWFscyhuZXh0LnBhdGhQYXJhbXMsIGxhc3QucGF0aFBhcmFtcykgJiYgIW5leHQucmVsb2FkT25TZWFyY2ggJiYgIWZvcmNlUmVsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QucGFyYW1zID0gbmV4dC5wYXJhbXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvcHkobGFzdC5wYXJhbXMsICRyb3V0ZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlVXBkYXRlJywgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0IHx8IGxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VSZWxvYWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdGFydCcsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm91dGUuY3VycmVudCA9IG5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dC5yZWRpcmVjdFRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5leHQucmVkaXJlY3RUbykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoaW50ZXJwb2xhdGUobmV4dC5yZWRpcmVjdFRvLCBuZXh0LnBhcmFtcykpLnNlYXJjaChuZXh0LnBhcmFtcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLnVybChuZXh0LnJlZGlyZWN0VG8obmV4dC5wYXRoUGFyYW1zLCAkbG9jYXRpb24ucGF0aCgpLCAkbG9jYXRpb24uc2VhcmNoKCkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRxLndoZW4obmV4dCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5cyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gobmV4dC5yZXNvbHZlIHx8IHt9LCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChpc1N0cmluZyh2YWx1ZSkgPyAkaW5qZWN0b3IuZ2V0KHZhbHVlKSA6ICRpbmplY3Rvci5pbnZva2UodmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQodGVtcGxhdGUgPSBuZXh0LnRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSA9IG5leHQudGVtcGxhdGVVcmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9ICRodHRwLmdldCh0ZW1wbGF0ZSwge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQodGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzLnB1c2goJyR0ZW1wbGF0ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcS5hbGwodmFsdWVzKS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmFsdWVzLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW2tleXNbaW5kZXhdXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFmdGVyIHJvdXRlIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbihmdW5jdGlvbiAobG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQgPT0gJHJvdXRlLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQubG9jYWxzID0gbG9jYWxzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weShuZXh0LnBhcmFtcywgJHJvdXRlUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCBuZXh0LCBsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZUVycm9yJywgbmV4dCwgbGFzdCwgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0aGUgY3VycmVudCBhY3RpdmUgcm91dGUsIGJ5IG1hdGNoaW5nIGl0IGFnYWluc3QgdGhlIFVSTAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBwYXJzZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIC8vIE1hdGNoIGEgcm91dGUKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW1zLCBtYXRjaDsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJvdXRlcywgZnVuY3Rpb24gKHJvdXRlLCBwYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbWF0Y2ggJiYgKHBhcmFtcyA9IHN3aXRjaFJvdXRlTWF0Y2hlcigkbG9jYXRpb24ucGF0aCgpLCBwYXRoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gaW5oZXJpdChyb3V0ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtczogZXh0ZW5kKHt9LCAkbG9jYXRpb24uc2VhcmNoKCksIHBhcmFtcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aFBhcmFtczogcGFyYW1zfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaC4kJHJvdXRlID0gcm91dGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBObyByb3V0ZSBtYXRjaGVkOyBmYWxsYmFjayB0byAib3RoZXJ3aXNlIiByb3V0ZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaCB8fCByb3V0ZXNbbnVsbF0gJiYgaW5oZXJpdChyb3V0ZXNbbnVsbF0sIHtwYXJhbXM6IHt9LCBwYXRoUGFyYW1zOiB7fX0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQHJldHVybnMgaW50ZXJwb2xhdGlvbiBvZiB0aGUgcmVkaXJlY3QgcGF0aCB3aXRoIHRoZSBwYXJhbWV0cnMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RyaW5nLCBwYXJhbXMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCgoc3RyaW5nIHx8ICcnKS5zcGxpdCgnOicpLCBmdW5jdGlvbiAoc2VnbWVudCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChzZWdtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZWdtZW50TWF0Y2ggPSBzZWdtZW50Lm1hdGNoKC8oXHcrKSguKikvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBzZWdtZW50TWF0Y2hbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChwYXJhbXNba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChzZWdtZW50TWF0Y2hbMl0gfHwgJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHBhcmFtc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm91dGVQYXJhbXMKICAgICAqIEByZXF1aXJlcyAkcm91dGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEN1cnJlbnQgc2V0IG9mIHJvdXRlIHBhcmFtZXRlcnMuIFRoZSByb3V0ZSBwYXJhbWV0ZXJzIGFyZSBhIGNvbWJpbmF0aW9uIG9mIHRoZQogICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb259IGBzZWFyY2goKWAsIGFuZCBgcGF0aCgpYC4gVGhlIGBwYXRoYCBwYXJhbWV0ZXJzCiAgICAgKiBhcmUgZXh0cmFjdGVkIHdoZW4gdGhlIHtAbGluayBuZy4kcm91dGUgJHJvdXRlfSBwYXRoIGlzIG1hdGNoZWQuCiAgICAgKgogICAgICogSW4gY2FzZSBvZiBwYXJhbWV0ZXIgbmFtZSBjb2xsaXNpb24sIGBwYXRoYCBwYXJhbXMgdGFrZSBwcmVjZWRlbmNlIG92ZXIgYHNlYXJjaGAgcGFyYW1zLgogICAgICoKICAgICAqIFRoZSBzZXJ2aWNlIGd1YXJhbnRlZXMgdGhhdCB0aGUgaWRlbnRpdHkgb2YgdGhlIGAkcm91dGVQYXJhbXNgIG9iamVjdCB3aWxsIHJlbWFpbiB1bmNoYW5nZWQKICAgICAqIChidXQgaXRzIHByb3BlcnRpZXMgd2lsbCBsaWtlbHkgY2hhbmdlKSBldmVuIHdoZW4gYSByb3V0ZSBjaGFuZ2Ugb2NjdXJzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogIC8vIEdpdmVuOgogICAgICogIC8vIFVSTDogaHR0cDovL3NlcnZlci5jb20vaW5kZXguaHRtbCMvQ2hhcHRlci8xL1NlY3Rpb24vMj9zZWFyY2g9bW9ieQogICAgICogIC8vIFJvdXRlOiAvQ2hhcHRlci86Y2hhcHRlcklkL1NlY3Rpb24vOnNlY3Rpb25JZAogICAgICogIC8vCiAgICAgKiAgLy8gVGhlbgogICAgICogICRyb3V0ZVBhcmFtcyA9PT4ge2NoYXB0ZXJJZDoxLCBzZWN0aW9uSWQ6Miwgc2VhcmNoOidtb2J5J30KICAgICAqIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUm91dGVQYXJhbXNQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHt9KTsKICAgIH0KCiAgICAvKioKICAgICAqIERFU0lHTiBOT1RFUwogICAgICoKICAgICAqIFRoZSBkZXNpZ24gZGVjaXNpb25zIGJlaGluZCB0aGUgc2NvcGUgYXJlIGhlYXZpbHkgZmF2b3JlZCBmb3Igc3BlZWQgYW5kIG1lbW9yeSBjb25zdW1wdGlvbi4KICAgICAqCiAgICAgKiBUaGUgdHlwaWNhbCB1c2Ugb2Ygc2NvcGUgaXMgdG8gd2F0Y2ggdGhlIGV4cHJlc3Npb25zLCB3aGljaCBtb3N0IG9mIHRoZSB0aW1lIHJldHVybiB0aGUgc2FtZQogICAgICogdmFsdWUgYXMgbGFzdCB0aW1lIHNvIHdlIG9wdGltaXplIHRoZSBvcGVyYXRpb24uCiAgICAgKgogICAgICogQ2xvc3VyZXMgY29uc3RydWN0aW9uIGlzIGV4cGVuc2l2ZSBpbiB0ZXJtcyBvZiBzcGVlZCBhcyB3ZWxsIGFzIG1lbW9yeToKICAgICAqICAgLSBObyBjbG9zdXJlcywgaW5zdGVhZCB1c2UgcHJvdG90eXBpY2FsIGluaGVyaXRhbmNlIGZvciBBUEkKICAgICAqICAgLSBJbnRlcm5hbCBzdGF0ZSBuZWVkcyB0byBiZSBzdG9yZWQgb24gc2NvcGUgZGlyZWN0bHksIHdoaWNoIG1lYW5zIHRoYXQgcHJpdmF0ZSBzdGF0ZSBpcwogICAgICogICAgIGV4cG9zZWQgYXMgJCRfX19fIHByb3BlcnRpZXMKICAgICAqCiAgICAgKiBMb29wIG9wZXJhdGlvbnMgYXJlIG9wdGltaXplZCBieSB1c2luZyB3aGlsZShjb3VudC0tKSB7IC4uLiB9CiAgICAgKiAgIC0gdGhpcyBtZWFucyB0aGF0IGluIG9yZGVyIHRvIGtlZXAgdGhlIHNhbWUgb3JkZXIgb2YgZXhlY3V0aW9uIGFzIGFkZGl0aW9uIHdlIGhhdmUgdG8gYWRkCiAgICAgKiAgICAgaXRlbXMgdG8gdGhlIGFycmF5IGF0IHRoZSBiZWdpbm5pbmcgKHNoaWZ0KSBpbnN0ZWFkIG9mIGF0IHRoZSBlbmQgKHB1c2gpCiAgICAgKgogICAgICogQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIGFuZCByZW1vdmVkIG9mdGVuCiAgICAgKiAgIC0gVXNpbmcgYW4gYXJyYXkgd291bGQgYmUgc2xvdyBzaW5jZSBpbnNlcnRzIGluIG1pZGRsZSBhcmUgZXhwZW5zaXZlIHNvIHdlIHVzZSBsaW5rZWQgbGlzdAogICAgICoKICAgICAqIFRoZXJlIGFyZSBmZXcgd2F0Y2hlcyB0aGVuIGEgbG90IG9mIG9ic2VydmVycy4gVGhpcyBpcyB3aHkgeW91IGRvbid0IHdhbnQgdGhlIG9ic2VydmVyIHRvIGJlCiAgICAgKiBpbXBsZW1lbnRlZCBpbiB0aGUgc2FtZSB3YXkgYXMgd2F0Y2guIFdhdGNoIHJlcXVpcmVzIHJldHVybiBvZiBpbml0aWFsaXphdGlvbiBmdW5jdGlvbiB3aGljaAogICAgICogYXJlIGV4cGVuc2l2ZSB0byBjb25zdHJ1Y3QuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFByb3ZpZGVyIGZvciB0aGUgJHJvb3RTY29wZSBzZXJ2aWNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlciNkaWdlc3RUdGwKICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFNldHMgdGhlIG51bWJlciBvZiBkaWdlc3QgaXRlcmF0aW9ucyB0aGUgc2NvcGUgc2hvdWxkIGF0dGVtcHQgdG8gZXhlY3V0ZSBiZWZvcmUgZ2l2aW5nIHVwIGFuZAogICAgICogYXNzdW1pbmcgdGhhdCB0aGUgbW9kZWwgaXMgdW5zdGFibGUuCiAgICAgKgogICAgICogVGhlIGN1cnJlbnQgZGVmYXVsdCBpcyAxMCBpdGVyYXRpb25zLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsaW1pdCBUaGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRXZlcnkgYXBwbGljYXRpb24gaGFzIGEgc2luZ2xlIHJvb3Qge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICogQWxsIG90aGVyIHNjb3BlcyBhcmUgY2hpbGQgc2NvcGVzIG9mIHRoZSByb290IHNjb3BlLiBTY29wZXMgcHJvdmlkZSBtZWNoYW5pc20gZm9yIHdhdGNoaW5nIHRoZSBtb2RlbCBhbmQgcHJvdmlkZQogICAgICogZXZlbnQgcHJvY2Vzc2luZyBsaWZlLWN5Y2xlLiBTZWUge0BsaW5rIGd1aWRlL3Njb3BlIGRldmVsb3BlciBndWlkZSBvbiBzY29wZXN9LgogICAgICovCiAgICBmdW5jdGlvbiAkUm9vdFNjb3BlUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIFRUTCA9IDEwOwoKICAgICAgICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFRUTDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLAogICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlciwgJHBhcnNlKSB7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEEgcm9vdCBzY29wZSBjYW4gYmUgcmV0cmlldmVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZSAkcm9vdFNjb3BlfSBrZXkgZnJvbSB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgdXNpbmcgdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3ICRuZXcoKX0gbWV0aG9kLiAoTW9zdCBzY29wZXMgYXJlIGNyZWF0ZWQgYXV0b21hdGljYWxseSB3aGVuCiAgICAgICAgICAgICAgICAgKiBjb21waWxlZCBIVE1MIHRlbXBsYXRlIGlzIGV4ZWN1dGVkLikKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBIZXJlIGlzIGEgc2ltcGxlIHNjb3BlIHNuaXBwZXQgdG8gc2hvdyBob3cgeW91IGNhbiBpbnRlcmFjdCB3aXRoIHRoZSBzY29wZS4KICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgYW5ndWxhci5pbmplY3RvcihbJ25nJ10pLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZS4kbmV3KCk7CiAgICAgICAgICAgc2NvcGUuc2FsdXRhdGlvbiA9ICdIZWxsbyc7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdXb3JsZCc7CgogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCh1bmRlZmluZWQpOwoKICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIHNjb3BlLmdyZWV0aW5nID0gc2NvcGUuc2FsdXRhdGlvbiArICcgJyArIHNjb3BlLm5hbWUgKyAnISc7CiAgICAgICAgICAgfSk7IC8vIGluaXRpYWxpemUgdGhlIHdhdGNoCgogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCh1bmRlZmluZWQpOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnTWlza28nOwogICAgICAgICAgIC8vIHN0aWxsIG9sZCB2YWx1ZSwgc2luY2Ugd2F0Y2hlcyBoYXZlIG5vdCBiZWVuIGNhbGxlZCB5ZXQKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwodW5kZWZpbmVkKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOyAvLyBmaXJlIGFsbCAgdGhlIHdhdGNoZXMKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZ3JlZXRpbmcpLnRvRXF1YWwoJ0hlbGxvIE1pc2tvIScpOwogICAgICAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBJbmhlcml0YW5jZQogICAgICAgICAgICAgICAgICogQSBzY29wZSBjYW4gaW5oZXJpdCBmcm9tIGEgcGFyZW50IHNjb3BlLCBhcyBpbiB0aGlzIGV4YW1wbGU6CiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSAkcm9vdFNjb3BlOwogICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC4kbmV3KCk7CgogICAgICAgICAgICAgICAgIHBhcmVudC5zYWx1dGF0aW9uID0gIkhlbGxvIjsKICAgICAgICAgICAgICAgICBjaGlsZC5uYW1lID0gIldvcmxkIjsKICAgICAgICAgICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKCiAgICAgICAgICAgICAgICAgY2hpbGQuc2FsdXRhdGlvbiA9ICJXZWxjb21lIjsKICAgICAgICAgICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnV2VsY29tZScpOwogICAgICAgICAgICAgICAgIGV4cGVjdChwYXJlbnQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IHByb3ZpZGVycyBNYXAgb2Ygc2VydmljZSBmYWN0b3J5IHdoaWNoIG5lZWQgdG8gYmUgcHJvdmlkZWQKICAgICAgICAgICAgICAgICAqICAgICBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAgICAgICAgICAgICAqICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZwogICAgICAgICAgICAgICAgICogICAgIHRoZSBuZWVkIHRvIG92ZXJyaWRlIGEgZGVmYXVsdCBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3bHkgY3JlYXRlZCBzY29wZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIFNjb3BlKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRwaGFzZSA9IHRoaXMuJHBhcmVudCA9IHRoaXMuJCR3YXRjaGVycyA9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpc1sndGhpcyddID0gdGhpcy4kcm9vdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRpc29sYXRlQmluZGluZ3MgPSB7fTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkaWQKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFVuaXF1ZSBzY29wZSBJRCAobW9ub3RvbmljYWxseSBpbmNyZWFzaW5nIGFscGhhbnVtZXJpYyBzZXF1ZW5jZSkgdXNlZnVsIGZvcgogICAgICAgICAgICAgICAgICogICBkZWJ1Z2dpbmcuCiAgICAgICAgICAgICAgICAgKi8KCgogICAgICAgICAgICAgICAgU2NvcGUucHJvdG90eXBlID0gewogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldwogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBDcmVhdGVzIGEgbmV3IGNoaWxkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBwYXJlbnQgc2NvcGUgd2lsbCBwcm9wYWdhdGUgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gZXZlbnRzLiBUaGUgc2NvcGUgY2FuIGJlIHJlbW92ZWQgZnJvbSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBoaWVyYXJjaHkgdXNpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kgJGRlc3Ryb3koKX0uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfSBtdXN0IGJlIGNhbGxlZCBvbiBhIHNjb3BlIHdoZW4gaXQgaXMgZGVzaXJlZCBmb3IKICAgICAgICAgICAgICAgICAgICAgKiB0aGUgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMgdG8gYmUgcGVybWFuZW50bHkgZGV0YWNoZWQgZnJvbSB0aGUgcGFyZW50IGFuZCB0aHVzIHN0b3AKICAgICAgICAgICAgICAgICAgICAgKiBwYXJ0aWNpcGF0aW5nIGluIG1vZGVsIGNoYW5nZSBkZXRlY3Rpb24gYW5kIGxpc3RlbmVyIG5vdGlmaWNhdGlvbiBieSBpbnZva2luZy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNvbGF0ZSBpZiB0cnVlIHRoZW4gdGhlIHNjb3BlIGRvZXMgbm90IHByb3RvdHlwaWNhbGx5IGluaGVyaXQgZnJvbSB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICAgICAgIHBhcmVudCBzY29wZS4gVGhlIHNjb3BlIGlzIGlzb2xhdGVkLCBhcyBpdCBjYW4gbm90IHNlZSBwYXJlbnQgc2NvcGUgcHJvcGVydGllcy4KICAgICAgICAgICAgICAgICAgICAgKiAgICAgICAgIFdoZW4gY3JlYXRpbmcgd2lkZ2V0cyBpdCBpcyB1c2VmdWwgZm9yIHRoZSB3aWRnZXQgdG8gbm90IGFjY2lkZW50YWxseSByZWFkIHBhcmVudAogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgc3RhdGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgbmV3bHkgY3JlYXRlZCBjaGlsZCBzY29wZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRuZXc6IGZ1bmN0aW9uIChpc29sYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBDaGlsZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oaXNvbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHJlbW92ZSBhdCBzb21lIHBvaW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignQVBJLUNIQU5HRTogVXNlICRjb250cm9sbGVyIHRvIGluc3RhbnRpYXRlIGNvbnRyb2xsZXJzLicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc29sYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IG5ldyBTY29wZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJHJvb3QgPSB0aGlzLiRyb290OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OyAvLyBzaG91bGQgYmUgYW5vbnltb3VzOyBUaGlzIGlzIHNvIHRoYXQgd2hlbiB0aGUgbWluaWZpZXIgbXVuZ2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgbmFtZSBpdCBkb2VzIG5vdCBiZWNvbWUgcmFuZG9tIHNldCBvZiBjaGFycy4gVGhlc2Ugd2lsbCB0aGVuIHNob3cgdXAgYXMgY2xhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5hbWUgaW4gdGhlIGRlYnVnZ2VyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hpbGQucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IENoaWxkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRbJ3RoaXMnXSA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcGFyZW50ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRhc3luY1F1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkd2F0Y2hlcnMgPSBjaGlsZC4kJG5leHRTaWJsaW5nID0gY2hpbGQuJCRjaGlsZEhlYWQgPSBjaGlsZC4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRUYWlsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJGNoaWxkSGVhZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBSZWdpc3RlcnMgYSBgbGlzdGVuZXJgIGNhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkIHdoZW5ldmVyIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgYHdhdGNoRXhwcmVzc2lvbmAgaXMgY2FsbGVkIG9uIGV2ZXJ5IGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqICAgc2hvdWxkIHJldHVybiB0aGUgdmFsdWUgd2hpY2ggd2lsbCBiZSB3YXRjaGVkLiAoU2luY2Uge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9CiAgICAgICAgICAgICAgICAgICAgICogICByZXJ1bnMgd2hlbiBpdCBkZXRlY3RzIGNoYW5nZXMgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlcgogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZCBzaG91bGQgYmUgaWRlbXBvdGVudC4pCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgb25seSB3aGVuIHRoZSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IGB3YXRjaEV4cHJlc3Npb25gIGFuZCB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgIHByZXZpb3VzIGNhbGwgdG8gYHdhdGNoRXhwcmVzc2lvbmAgYXJlIG5vdCBlcXVhbCAod2l0aCB0aGUgZXhjZXB0aW9uIG9mIHRoZSBpbml0aWFsIHJ1biwKICAgICAgICAgICAgICAgICAgICAgKiAgIHNlZSBiZWxvdykuIFRoZSBpbmVxdWFsaXR5IGlzIGRldGVybWluZWQgYWNjb3JkaW5nIHRvCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgYW5ndWxhci5lcXVhbHN9IGZ1bmN0aW9uLiBUbyBzYXZlIHRoZSB2YWx1ZSBvZiB0aGUgb2JqZWN0IGZvciBsYXRlciBjb21wYXJpc29uLCB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmNvcHl9IGZ1bmN0aW9uIGlzIHVzZWQuIEl0IGFsc28gbWVhbnMgdGhhdCB3YXRjaGluZyBjb21wbGV4IG9wdGlvbnMgd2lsbAogICAgICAgICAgICAgICAgICAgICAqICAgaGF2ZSBhZHZlcnNlIG1lbW9yeSBhbmQgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLgogICAgICAgICAgICAgICAgICAgICAqIC0gVGhlIHdhdGNoIGBsaXN0ZW5lcmAgbWF5IGNoYW5nZSB0aGUgbW9kZWwsIHdoaWNoIG1heSB0cmlnZ2VyIG90aGVyIGBsaXN0ZW5lcmBzIHRvIGZpcmUuIFRoaXMKICAgICAgICAgICAgICAgICAgICAgKiAgIGlzIGFjaGlldmVkIGJ5IHJlcnVubmluZyB0aGUgd2F0Y2hlcnMgdW50aWwgbm8gY2hhbmdlcyBhcmUgZGV0ZWN0ZWQuIFRoZSByZXJ1biBpdGVyYXRpb24KICAgICAgICAgICAgICAgICAgICAgKiAgIGxpbWl0IGlzIDEwIHRvIHByZXZlbnQgYW4gaW5maW5pdGUgbG9vcCBkZWFkbG9jay4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBpcyBjYWxsZWQsCiAgICAgICAgICAgICAgICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uIHdpdGggbm8gYGxpc3RlbmVyYC4gKFNpbmNlIGB3YXRjaEV4cHJlc3Npb25gCiAgICAgICAgICAgICAgICAgICAgICogY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUgd2hlbiBhIGNoYW5nZSBpcwogICAgICAgICAgICAgICAgICAgICAqIGRldGVjdGVkLCBiZSBwcmVwYXJlZCBmb3IgbXVsdGlwbGUgY2FsbHMgdG8geW91ciBsaXN0ZW5lci4pCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBZnRlciBhIHdhdGNoZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBzY29wZSwgdGhlIGBsaXN0ZW5lcmAgZm4gaXMgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgICAgICAgICAgICAgICAgICogKHZpYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jICRldmFsQXN5bmN9KSB0byBpbml0aWFsaXplIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHdhdGNoZXIuIEluIHJhcmUgY2FzZXMsIHRoaXMgaXMgdW5kZXNpcmFibGUgYmVjYXVzZSB0aGUgbGlzdGVuZXIgaXMgY2FsbGVkIHdoZW4gdGhlIHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAqIG9mIGB3YXRjaEV4cHJlc3Npb25gIGRpZG4ndCBjaGFuZ2UuIFRvIGRldGVjdCB0aGlzIHNjZW5hcmlvIHdpdGhpbiB0aGUgYGxpc3RlbmVyYCBmbiwgeW91CiAgICAgICAgICAgICAgICAgICAgICogY2FuIGNvbXBhcmUgdGhlIGBuZXdWYWxgIGFuZCBgb2xkVmFsYC4gSWYgdGhlc2UgdHdvIHZhbHVlcyBhcmUgaWRlbnRpY2FsIChgPT09YCkgdGhlbiB0aGUKICAgICAgICAgICAgICAgICAgICAgKiBsaXN0ZW5lciB3YXMgY2FsbGVkIGR1ZSB0byBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgLy8gbGV0J3MgYXNzdW1lIHRoYXQgc2NvcGUgd2FzIGRlcGVuZGVuY3kgaW5qZWN0ZWQgYXMgdGhlICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgeyBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7IH0pOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgLy8gbm8gdmFyaWFibGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyl9IHdhdGNoRXhwcmVzc2lvbiBFeHByZXNzaW9uIHRoYXQgaXMgZXZhbHVhdGVkIG9uIGVhY2gKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzIGEKICAgICAgICAgICAgICAgICAgICAgKiAgICBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBgc2NvcGVgIGFzIGEgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKT19IGxpc3RlbmVyIENhbGxiYWNrIGNhbGxlZCB3aGVuZXZlciB0aGUgcmV0dXJuIHZhbHVlIG9mCiAgICAgICAgICAgICAgICAgICAgICogICB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWVzIGFzIHBhcmFtZXRlcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIG9iamVjdCBmb3IgZXF1YWxpdHkgcmF0aGVyIHRoYW4gZm9yIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICR3YXRjaDogZnVuY3Rpb24gKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24gKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbkZuKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoYXJyYXksIHdhdGNoZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBQcm9jZXNzZXMgYWxsIG9mIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9IG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSBhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyfSdzIGxpc3RlbmVyIGNhbiBjaGFuZ2UgdGhlIG1vZGVsLCB0aGUKICAgICAgICAgICAgICAgICAgICAgKiBgJGRpZ2VzdCgpYCBrZWVwcyBjYWxsaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9IHVudGlsIG5vIG1vcmUgbGlzdGVuZXJzIGFyZQogICAgICAgICAgICAgICAgICAgICAqIGZpcmluZy4gVGhpcyBtZWFucyB0aGF0IGl0IGlzIHBvc3NpYmxlIHRvIGdldCBpbnRvIGFuIGluZmluaXRlIGxvb3AuIFRoaXMgZnVuY3Rpb24gd2lsbCB0aHJvdwogICAgICAgICAgICAgICAgICAgICAqIGAnTWF4aW11bSBpdGVyYXRpb24gbGltaXQgZXhjZWVkZWQuJ2AgaWYgdGhlIG51bWJlciBvZiBpdGVyYXRpb25zIGV4Y2VlZHMgMTAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBVc3VhbGx5IHlvdSBkb24ndCBjYWxsIGAkZGlnZXN0KClgIGRpcmVjdGx5IGluCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIgY29udHJvbGxlcnN9IG9yIGluCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogICAgICAgICAgICAgICAgICAgICAqIEluc3RlYWQgYSBjYWxsIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHkoKX0gKHR5cGljYWxseSBmcm9tIHdpdGhpbiBhCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9KSB3aWxsIGZvcmNlIGEgYCRkaWdlc3QoKWAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciBgJGRpZ2VzdCgpYCBpcyBjYWxsZWQsCiAgICAgICAgICAgICAgICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uICB3aXRoIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCAkd2F0Y2goKX0KICAgICAgICAgICAgICAgICAgICAgKiB3aXRoIG5vIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBZb3UgbWF5IGhhdmUgYSBuZWVkIHRvIGNhbGwgYCRkaWdlc3QoKWAgZnJvbSB3aXRoaW4gdW5pdC10ZXN0cywgdG8gc2ltdWxhdGUgdGhlIHNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogbGlmZS1jeWNsZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9IC4uLjsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOwogICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgLy8gbm8gdmFyaWFibGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRkaWdlc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdhdGNoLCB2YWx1ZSwgbGFzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmNRdWV1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnR5LCB0dGwgPSBUVEwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0LCBjdXJyZW50LCB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hMb2cgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCwgbG9nTXNnOwoKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGRpZ2VzdCcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmNRdWV1ZSA9IGN1cnJlbnQuJCRhc3luY1F1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC4kZXZhbChhc3luY1F1ZXVlLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJiAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXF1YWxzKHZhbHVlLCBsYXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICh0eXBlb2YgdmFsdWUgPT0gJ251bWJlcicgJiYgdHlwZW9mIGxhc3QgPT0gJ251bWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcnR5ICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKFRUTCArICcgJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1dhdGNoZXJzIGZpcmVkIGluIHRoZSBsYXN0IDUgaXRlcmF0aW9uczogJyArIHRvSnNvbih3YXRjaExvZykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkaXJ0eSB8fCBhc3luY1F1ZXVlLmxlbmd0aCk7CgogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gc2NvcGUgYmVpbmcgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCB3aGVuIGEgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbiBhcmUgYmVpbmcgZGVzdHJveWVkLgogICAgICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgc2NvcGUgKGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuKSBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFJlbW92YWwgaW1wbGllcwogICAgICAgICAgICAgICAgICAgICAqIHRoYXQgY2FsbHMgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHdpbGwgbm8gbG9uZ2VyCiAgICAgICAgICAgICAgICAgICAgICogcHJvcGFnYXRlIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCBpdHMgY2hpbGRyZW4uIFJlbW92YWwgYWxzbyBpbXBsaWVzIHRoYXQgdGhlIGN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAgKiBzY29wZSBpcyBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGAkZGVzdHJveSgpYCBpcyB1c3VhbGx5IHVzZWQgYnkgZGlyZWN0aXZlcyBzdWNoIGFzCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gZm9yIG1hbmFnaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHVucm9sbGluZyBvZiB0aGUgbG9vcC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEp1c3QgYmVmb3JlIGEgc2NvcGUgaXMgZGVzdHJveWVkIGEgYCRkZXN0cm95YCBldmVudCBpcyBicm9hZGNhc3RlZCBvbiB0aGlzIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGNoYW5jZSB0bwogICAgICAgICAgICAgICAgICAgICAqIHBlcmZvcm0gYW55IG5lY2Vzc2FyeSBjbGVhbnVwLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGRlc3Ryb3kgdGhlIHJvb3Qgc2NvcGUgb3IgYSBzY29wZSB0aGF0IGhhcyBiZWVuIGFscmVhZHkgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlID09IHRoaXMgfHwgdGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy4kcGFyZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYnJvYWRjYXN0KCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRUYWlsID09IHRoaXMpIHBhcmVudC4kJGNoaWxkVGFpbCA9IHRoaXMuJCRwcmV2U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBib2d1cyBjb2RlIHRoYXQgd29ya3MgYXJvdW5kIENocm9tZSdzIEdDIGxlYWsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy8xMzEzI2lzc3VlY29tbWVudC0xMDM3ODQ1MQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRIZWFkID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWwKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5pbmcgdGhlIHJlc3VsdC4gQW55IGV4Y2VwdGlvbnMgaW4gdGhlCiAgICAgICAgICAgICAgICAgICAgICogZXhwcmVzc2lvbiBhcmUgcHJvcGFnYXRlZCAodW5jYXVnaHQpLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV2YWx1YXRpbmcgQW5ndWxhciBleHByZXNzaW9ucy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9IG5nLiRyb290U2NvcGUuU2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYSA9IDE7CiAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKGZ1bmN0aW9uKHNjb3BlKXsgcmV0dXJuIHNjb3BlLmEgKyBzY29wZS5iOyB9KSkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGV2YWw6IGZ1bmN0aW9uIChleHByLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRwYXJzZShleHByKSh0aGlzLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWxBc3luYwogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUgY3VycmVudCBzY29wZSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRldmFsQXN5bmNgIG1ha2VzIG5vIGd1YXJhbnRlZXMgYXMgdG8gd2hlbiB0aGUgYGV4cHJlc3Npb25gIHdpbGwgYmUgZXhlY3V0ZWQsIG9ubHkgdGhhdDoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgaW4gdGhlIGN1cnJlbnQgc2NyaXB0IGV4ZWN1dGlvbiBjb250ZXh0IChiZWZvcmUgYW55IERPTSByZW5kZXJpbmcpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgICAgICAgICAgICAgICAqICAgICBgZXhwcmVzc2lvbmAgZXhlY3V0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGV2YWxBc3luYzogZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUucHVzaChleHByKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseQogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBgJGFwcGx5KClgIGlzIHVzZWQgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIGFuZ3VsYXIgZnJvbSBvdXRzaWRlIG9mIHRoZSBhbmd1bGFyIGZyYW1ld29yay4KICAgICAgICAgICAgICAgICAgICAgKiAoRm9yIGV4YW1wbGUgZnJvbSBicm93c2VyIERPTSBldmVudHMsIHNldFRpbWVvdXQsIFhIUiBvciB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMpLgogICAgICAgICAgICAgICAgICAgICAqIEJlY2F1c2Ugd2UgYXJlIGNhbGxpbmcgaW50byB0aGUgYW5ndWxhciBmcmFtZXdvcmsgd2UgbmVlZCB0byBwZXJmb3JtIHByb3BlciBzY29wZSBsaWZlLWN5Y2xlCiAgICAgICAgICAgICAgICAgICAgICogb2Yge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyIGV4Y2VwdGlvbiBoYW5kbGluZ30sCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCBleGVjdXRpbmcgd2F0Y2hlc30uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIyBMaWZlIGN5Y2xlCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIFBzZXVkby1Db2RlIG9mIGAkYXBwbHkoKWAKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAkYXBwbHkoZXhwcikgewogICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgcmV0dXJuICRldmFsKGV4cHIpOwogICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICRyb290LiRkaWdlc3QoKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFNjb3BlJ3MgYCRhcHBseSgpYCBtZXRob2QgdHJhbnNpdGlvbnMgdGhyb3VnaCB0aGUgZm9sbG93aW5nIHN0YWdlczoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIDEuIFRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBleGVjdXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbCAkZXZhbCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICogICAge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqIDMuIFRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2h9IGxpc3RlbmVycyBhcmUgZmlyZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgdGhlIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICAgKiAgICB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGFwcGx5OiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbgogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBMaXN0ZW5zIG9uIGV2ZW50cyBvZiBhIGdpdmVuIHR5cGUuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdCAkZW1pdH0gZm9yIGRpc2N1c3Npb24gb2YKICAgICAgICAgICAgICAgICAgICAgKiBldmVudCBsaWZlIGN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIGZvcm1hdCBpczogYGZ1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKWAuIFRoZSBgZXZlbnRgIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAqIHBhc3NlZCBpbnRvIHRoZSBsaXN0ZW5lciBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGB0YXJnZXRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBzY29wZSBvbiB3aGljaCB0aGUgZXZlbnQgd2FzIGAkZW1pdGAtZWQgb3IgYCRicm9hZGNhc3RgLWVkLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgY3VycmVudFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIGN1cnJlbnQgc2NvcGUgd2hpY2ggaXMgaGFuZGxpbmcgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgbmFtZWAgLSBge3N0cmluZ31gOiBOYW1lIG9mIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHN0b3BQcm9wYWdhdGlvbmAgLSBge2Z1bmN0aW9uPX1gOiBjYWxsaW5nIGBzdG9wUHJvcGFnYXRpb25gIGZ1bmN0aW9uIHdpbGwgY2FuY2VsIGZ1cnRoZXIgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgKiAgICAgcHJvcGFnYXRpb24gKGF2YWlsYWJsZSBvbmx5IGZvciBldmVudHMgdGhhdCB3ZXJlIGAkZW1pdGAtZWQpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgcHJldmVudERlZmF1bHRgIC0gYHtmdW5jdGlvbn1gOiBjYWxsaW5nIGBwcmV2ZW50RGVmYXVsdGAgc2V0cyBgZGVmYXVsdFByZXZlbnRlZGAgZmxhZyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgZGVmYXVsdFByZXZlbnRlZGAgLSBge2Jvb2xlYW59YDogdHJ1ZSBpZiBgcHJldmVudERlZmF1bHRgIHdhcyBjYWxsZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGxpc3RlbiBvbi4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKX0gbGlzdGVuZXIgRnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBldmVudCBpcyBlbWl0dGVkLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9uOiBmdW5jdGlvbiAobmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaW5kZXhPZihuYW1lZExpc3RlbmVycywgbGlzdGVuZXIpXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQKICAgICAgICAgICAgICAgICAgICAgKiBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycyBjYW5jZWxzIGl0LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBlbWl0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZW1pdDogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLCBsZW5ndGg7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycyA9IHNjb3BlLiQkbGlzdGVuZXJzW25hbWVdIHx8IGVtcHR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBuYW1lZExpc3RlbmVycy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpXS5hcHBseShudWxsLCBsaXN0ZW5lckFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcFByb3BhZ2F0aW9uKSByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RyYXZlcnNlIHVwd2FyZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlID0gc2NvcGUuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoc2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgZG93bndhcmRzIHRvIGFsbCBjaGlsZCBzY29wZXMgKGFuZCB0aGVpciBjaGlsZHJlbikgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkYnJvYWRjYXN0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgcHJvcGFnYXRlcyB0byBhbGwgZGlyZWN0IGFuZCBpbmRpcmVjdCBzY29wZXMgb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kCiAgICAgICAgICAgICAgICAgICAgICogY2FsbHMgYWxsIHJlZ2lzdGVyZWQgbGlzdGVuZXJzIGFsb25nIHRoZSB3YXkuIFRoZSBldmVudCBjYW5ub3QgYmUgY2FuY2VsZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtbWl0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGJyb2FkY2FzdC4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgc2V0IG9mIGFyZ3VtZW50cyB3aGljaCB3aWxsIGJlIHBhc3NlZCBvbnRvIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybiB7T2JqZWN0fSBFdmVudCBvYmplY3QsIHNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGJyb2FkY2FzdDogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMsIGksIGxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vZG93biB3aGlsZSB5b3UgY2FuLCB0aGVuIHVwIGFuZCBuZXh0IHNpYmxpbmcgb3IgdXAgYW5kIG5leHQgc2libGluZyB1bnRpbCBiYWNrIGF0IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzID0gY3VycmVudC4kJGxpc3RlbmVyc1tuYW1lXSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseShudWxsLCBsaXN0ZW5lckFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8IChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciAkcm9vdFNjb3BlID0gbmV3IFNjb3BlKCk7CgogICAgICAgICAgICAgICAgcmV0dXJuICRyb290U2NvcGU7CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGJlZ2luUGhhc2UocGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCRyb290U2NvcGUuJCRwaGFzZSArICcgYWxyZWFkeSBpbiBwcm9ncmVzcycpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBoYXNlID0gcGhhc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJQaGFzZSgpIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUb0ZuKGV4cCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShleHApOwogICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbiB1c2VkIGFzIGFuIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzLgogICAgICAgICAgICAgICAgICogYmVjYXVzZSBpdCdzIHVuaXF1ZSB3ZSBjYW4gZWFzaWx5IHRlbGwgaXQgYXBhcnQgZnJvbSBvdGhlciB2YWx1ZXMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdFdhdGNoVmFsKCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kc25pZmZlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzaGNoYW5nZSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudCA/CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogICAgICovCiAgICBmdW5jdGlvbiAkU25pZmZlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uICgkd2luZG93KSB7CiAgICAgICAgICAgIHZhciBldmVudFN1cHBvcnQgPSB7fSwKICAgICAgICAgICAgICAgIGFuZHJvaWQgPSBpbnQoKC9hbmRyb2lkIChcZCspLy5leGVjKGxvd2VyY2FzZSgkd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpKSB8fCBbXSlbMV0pOwoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8vIEFuZHJvaWQgaGFzIGhpc3RvcnkucHVzaFN0YXRlLCBidXQgaXQgZG9lcyBub3QgdXBkYXRlIGxvY2F0aW9uIGNvcnJlY3RseQogICAgICAgICAgICAgICAgLy8gc28gbGV0J3Mgbm90IHVzZSB0aGUgaGlzdG9yeSBBUEkgYXQgYWxsLgogICAgICAgICAgICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2FuZHJvaWQvaXNzdWVzL2RldGFpbD9pZD0xNzQ3MQogICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTA0CiAgICAgICAgICAgICAgICBoaXN0b3J5OiAhISgkd2luZG93Lmhpc3RvcnkgJiYgJHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSAmJiAhKGFuZHJvaWQgPCA0KSksCiAgICAgICAgICAgICAgICBoYXNoY2hhbmdlOiAnb25oYXNoY2hhbmdlJyBpbiAkd2luZG93ICYmCiAgICAgICAgICAgICAgICAgICAgLy8gSUU4IGNvbXBhdGlibGUgbW9kZSBsaWVzCiAgICAgICAgICAgICAgICAgICAgKCEkd2luZG93LmRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCAkd2luZG93LmRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDcpLAogICAgICAgICAgICAgICAgaGFzRXZlbnQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gSW4gcGFydGljdWxhciB0aGUgZXZlbnQgaXMgbm90IGZpcmVkIHdoZW4gYmFja3NwYWNlIG9yIGRlbGV0ZSBrZXkgYXJlIHByZXNzZWQgb3IKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnRTdXBwb3J0W2V2ZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpdkVsbSA9ICR3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50U3VwcG9ydFtldmVudF0gPSAnb24nICsgZXZlbnQgaW4gZGl2RWxtOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50U3VwcG9ydFtldmVudF07CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gVE9ETyhpKTogY3VycmVudGx5IHRoZXJlIGlzIG5vIHdheSB0byBmZWF0dXJlIGRldGVjdCBDU1Agd2l0aG91dCB0cmlnZ2VyaW5nIGFsZXJ0cwogICAgICAgICAgICAgICAgY3NwOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHdpbmRvdwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93YCBvYmplY3QuIFdoaWxlIGB3aW5kb3dgCiAgICAgKiBpcyBnbG9iYWxseSBhdmFpbGFibGUgaW4gSmF2YVNjcmlwdCwgaXQgY2F1c2VzIHRlc3RhYmlsaXR5IHByb2JsZW1zLCBiZWNhdXNlCiAgICAgKiBpdCBpcyBhIGdsb2JhbCB2YXJpYWJsZS4gSW4gYW5ndWxhciB3ZSBhbHdheXMgcmVmZXIgdG8gaXQgdGhyb3VnaCB0aGUKICAgICAqIGAkd2luZG93YCBzZXJ2aWNlLCBzbyBpdCBtYXkgYmUgb3ZlcnJpZGVuLCByZW1vdmVkIG9yIG1vY2tlZCBmb3IgdGVzdGluZy4KICAgICAqCiAgICAgKiBBbGwgZXhwcmVzc2lvbnMgYXJlIGV2YWx1YXRlZCB3aXRoIHJlc3BlY3QgdG8gY3VycmVudCBzY29wZSBzbyB0aGV5IGRvbid0CiAgICAgKiBzdWZmZXIgZnJvbSB3aW5kb3cgZ2xvYmFsaXR5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUsICR3aW5kb3cpIHsKICAgICAgICAgICAkc2NvcGUuJHdpbmRvdyA9ICR3aW5kb3c7CiAgICAgICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ0hlbGxvLCBXb3JsZCEnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImdyZWV0aW5nIiAvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiR3aW5kb3cuYWxlcnQoZ3JlZXRpbmcpIj5BTEVSVDwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZGlzcGxheSB0aGUgZ3JlZXRpbmcgaW4gdGhlIGlucHV0IGJveCcsIGZ1bmN0aW9uKCkgewogICAgICAgaW5wdXQoJ2dyZWV0aW5nJykuZW50ZXIoJ0hlbGxvLCBFMkUgVGVzdHMnKTsKICAgICAgIC8vIElmIHdlIGNsaWNrIHRoZSBidXR0b24gaXQgd2lsbCBibG9jayB0aGUgdGVzdCBydW5uZXIKICAgICAgIC8vIGVsZW1lbnQoJzpidXR0b24nKS5jbGljaygpOwogICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiAkV2luZG93UHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gdmFsdWVGbih3aW5kb3cpOwogICAgfQoKICAgIC8qKgogICAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICAgIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogICAgICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICAgICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgICAgICBpID0gbGluZS5pbmRleE9mKCc6Jyk7CiAgICAgICAgICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSk7CiAgICAgICAgICAgIHZhbCA9IHRyaW0obGluZS5zdWJzdHIoaSArIDEpKTsKCiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRba2V5XSkgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldICs9ICcsICcgKyB2YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CgoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYWNjZXNzIHRvIHBhcnNlZCBoZWFkZXJzLgogICAgICoKICAgICAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogICAgICogQHNlZSBwYXJzZUhlYWRlcnMKICAgICAqCiAgICAgKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZz0pfSBSZXR1cm5zIGEgZ2V0dGVyIGZ1bmN0aW9uIHdoaWNoIGlmIGNhbGxlZCB3aXRoOgogICAgICoKICAgICAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCBoZWFkZXJzLgogICAgICovCiAgICBmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICAgICAgICB2YXIgaGVhZGVyc09iaiA9IGlzT2JqZWN0KGhlYWRlcnMpID8gaGVhZGVycyA6IHVuZGVmaW5lZDsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9IHBhcnNlSGVhZGVycyhoZWFkZXJzKTsKCiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGVhZGVyc09ialtsb3dlcmNhc2UobmFtZSldIHx8IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogICAgICoKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgYm90aCByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1pbmcKICAgICAqCiAgICAgKiBAcGFyYW0geyp9IGRhdGEgRGF0YSB0byB0cmFuc2Zvcm0uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZz0pfSBoZWFkZXJzIEh0dHAgaGVhZGVycyBnZXR0ZXIgZm4uCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbnxBcnJheS48ZnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICAgICAqIEByZXR1cm5zIHsqfSBUcmFuc2Zvcm1lZCBkYXRhLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICAgICAgICAgIHJldHVybiBmbnMoZGF0YSwgaGVhZGVycyk7CgogICAgICAgIGZvckVhY2goZm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgZGF0YSA9IGZuKGRhdGEsIGhlYWRlcnMpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTdWNjZXNzKHN0YXR1cykgewogICAgICAgIHJldHVybiAyMDAgPD0gc3RhdHVzICYmIHN0YXR1cyA8IDMwMDsKICAgIH0KCgogICAgZnVuY3Rpb24gJEh0dHBQcm92aWRlcigpIHsKICAgICAgICB2YXIgSlNPTl9TVEFSVCA9IC9eXHMqKFxbfFx7W15ce10pLywKICAgICAgICAgICAgSlNPTl9FTkQgPSAvW1x9XF1dXHMqJC8sCiAgICAgICAgICAgIFBST1RFQ1RJT05fUFJFRklYID0gL15cKVxdXH0nLD9cbi87CgogICAgICAgIHZhciAkY29uZmlnID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgICAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IFtmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShQUk9URUNUSU9OX1BSRUZJWCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24gKGQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChkKSAmJiAhaXNGaWxlKGQpID8gdG9Kc29uKGQpIDogZDsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyBkZWZhdWx0IGhlYWRlcnMKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgY29tbW9uOiB7CiAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonLAogICAgICAgICAgICAgICAgICAgICdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBvc3Q6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9LAogICAgICAgICAgICAgICAgcHV0OiB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMgPSB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGh0dHBCYWNrZW5kJywgJyRicm93c2VyJywgJyRjYWNoZUZhY3RvcnknLCAnJHJvb3RTY29wZScsICckcScsICckaW5qZWN0b3InLAogICAgICAgICAgICBmdW5jdGlvbiAoJGh0dHBCYWNrZW5kLCAkYnJvd3NlciwgJGNhY2hlRmFjdG9yeSwgJHJvb3RTY29wZSwgJHEsICRpbmplY3RvcikgewoKICAgICAgICAgICAgICAgIHZhciBkZWZhdWx0Q2FjaGUgPSAkY2FjaGVGYWN0b3J5KCckaHR0cCcpLAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogICAgICAgICAgICAgICAgZm9yRWFjaChwcm92aWRlclJlc3BvbnNlSW50ZXJjZXB0b3JzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKAogICAgICAgICAgICAgICAgICAgICAgICBpc1N0cmluZyhpbnRlcmNlcHRvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJGluamVjdG9yLmdldChpbnRlcmNlcHRvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJGluamVjdG9yLmludm9rZShpbnRlcmNlcHRvcikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRodHRwQmFja2VuZAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGNvcmUgQW5ndWxhciBzZXJ2aWNlIHRoYXQgZmFjaWxpdGF0ZXMgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSByZW1vdGUKICAgICAgICAgICAgICAgICAqIEhUVFAgc2VydmVycyB2aWEgdGhlIGJyb3dzZXIncyB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4veG1saHR0cHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0fSBvYmplY3Qgb3IgdmlhIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QIEpTT05QfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgJGh0dHBCYWNrZW5kIG1vY2t9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgICAgICAgICAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICAgICAgICAgICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAgICAgICAgICAgICAqIGl0IGlzIGltcG9ydGFudCB0byBmYW1pbGlhcml6ZSB5b3Vyc2VsZiB3aXRoIHRoZXNlIEFQSXMgYW5kIHRoZSBndWFyYW50ZWVzIHRoZXkgcHJvdmlkZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBHZW5lcmFsIHVzYWdlCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQg4oCUIGEgY29uZmlndXJhdGlvbiBvYmplY3Qg4oCUCiAgICAgICAgICAgICAgICAgKiB0aGF0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgYW4gSFRUUCByZXF1ZXN0IGFuZCByZXR1cm5zICBhIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAgICAgICAgICogd2l0aCB0d28gJGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwKHttZXRob2Q6ICdHRVQnLCB1cmw6ICcvc29tZVVybCd9KS4KICAgICAgICAgICAgICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAqICAgICB9KS4KICAgICAgICAgICAgICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgKiAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAgICAgICAgICAgICAqIHRoZSBgdGhlbmAgbWV0aG9kIHRvIHJlZ2lzdGVyIGNhbGxiYWNrcywgYW5kIHRoZXNlIGNhbGxiYWNrcyB3aWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQg4oCTCiAgICAgICAgICAgICAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAgICAgICAgICAgICAqIGRldGFpbHMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAgICAgICAgICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3Qgd2lsbCB0cmFuc3BhcmVudGx5IGZvbGxvdyBpdCwgbWVhbmluZyB0aGF0IHRoZSBlcnJvciBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAgICAgICAgICAgICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSBhbGwgaW52b2NhdGlvbnMgb2YgdGhlICRodHRwIHNlcnZpY2UgcmVxdWlyZSBwYXNzaW5nIGluIGFuIEhUVFAgbWV0aG9kIGFuZCBVUkwsIGFuZAogICAgICAgICAgICAgICAgICogUE9TVC9QVVQgcmVxdWVzdHMgcmVxdWlyZSByZXF1ZXN0IGRhdGEgdG8gYmUgcHJvdmlkZWQgYXMgd2VsbCwgc2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICogd2VyZSBjcmVhdGVkOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLnBvc3QoJy9zb21lVXJsJywgZGF0YSkuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQ29tcGxldGUgbGlzdCBvZiBzaG9ydGN1dCBtZXRob2RzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNoZWFkICRodHRwLmhlYWR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZGVsZXRlICRodHRwLmRlbGV0ZX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCBjZXJ0YWluIEhUVFAgaGVhZGVycyB0byBhbGwgcmVxdWVzdHMuIFRoZXNlIGRlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAgICAgICAgICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAgICAgICAgICAgICAqICAgLSBgWC1SZXF1ZXN0ZWQtV2l0aDogWE1MSHR0cFJlcXVlc3RgCiAgICAgICAgICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucG9zdGA6IChoZWFkZXIgZGVmYXVsdHMgZm9yIFBPU1QgcmVxdWVzdHMpCiAgICAgICAgICAgICAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wdXRgIChoZWFkZXIgZGVmYXVsdHMgZm9yIFBVVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGFkZCBvciBvdmVyd3JpdGUgdGhlc2UgZGVmYXVsdHMsIHNpbXBseSBhZGQgb3IgcmVtb3ZlIGEgcHJvcGVydHkgZnJvbSB0aGVzZSBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgKiBvYmplY3RzLiBUbyBhZGQgaGVhZGVycyBmb3IgYW4gSFRUUCBtZXRob2Qgb3RoZXIgdGhhbiBQT1NUIG9yIFBVVCwgc2ltcGx5IGFkZCBhIG5ldyBvYmplY3QKICAgICAgICAgICAgICAgICAqIHdpdGggdGhlIGxvd2VyY2FzZWQgSFRUUCBtZXRob2QgbmFtZSBhcyB0aGUga2V5LCBlLmcuCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmdldFsnTXktSGVhZGVyJ109J3ZhbHVlJ2AuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQWRkaXRpb25hbGx5LCB0aGUgZGVmYXVsdHMgY2FuIGJlIHNldCBhdCBydW50aW1lIHZpYSB0aGUgYCRodHRwLmRlZmF1bHRzYCBvYmplY3QgaW4gdGhlIHNhbWUKICAgICAgICAgICAgICAgICAqIGZhc2hpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCb3RoIHJlcXVlc3RzIGFuZCByZXNwb25zZXMgY2FuIGJlIHRyYW5zZm9ybWVkIHVzaW5nIHRyYW5zZm9ybSBmdW5jdGlvbnMuIEJ5IGRlZmF1bHQsIEFuZ3VsYXIKICAgICAgICAgICAgICAgICAqIGFwcGxpZXMgdGhlc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFJlcXVlc3QgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0gSWYgdGhlIGBkYXRhYCBwcm9wZXJ0eSBvZiB0aGUgcmVxdWVzdCBjb25maWd1cmF0aW9uIG9iamVjdCBjb250YWlucyBhbiBvYmplY3QsIHNlcmlhbGl6ZSBpdCBpbnRvCiAgICAgICAgICAgICAgICAgKiAgIEpTT04gZm9ybWF0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFJlc3BvbnNlIHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgLSBJZiBYU1JGIHByZWZpeCBpcyBkZXRlY3RlZCwgc3RyaXAgaXQgKHNlZSBTZWN1cml0eSBDb25zaWRlcmF0aW9ucyBzZWN0aW9uIGJlbG93KS4KICAgICAgICAgICAgICAgICAqICAtIElmIEpTT04gcmVzcG9uc2UgaXMgZGV0ZWN0ZWQsIGRlc2VyaWFsaXplIGl0IHVzaW5nIGEgSlNPTiBwYXJzZXIuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gZ2xvYmFsbHkgYXVnbWVudCBvciBvdmVycmlkZSB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1zLCBtb2RpZnkgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgIGFuZAogICAgICAgICAgICAgICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2VgIHByb3BlcnRpZXMuIFRoZXNlIHByb3BlcnRpZXMgYXJlIGJ5IGRlZmF1bHQgYW4KICAgICAgICAgICAgICAgICAqIGFycmF5IG9mIHRyYW5zZm9ybSBmdW5jdGlvbnMsIHdoaWNoIGFsbG93cyB5b3UgdG8gYHB1c2hgIG9yIGB1bnNoaWZ0YCBhIG5ldyB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbiBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gY2hhaW4uIFlvdSBjYW4gYWxzbyBkZWNpZGUgdG8gY29tcGxldGVseSBvdmVycmlkZSBhbnkgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnMgYnkgYXNzaWduaW5nIHlvdXIKICAgICAgICAgICAgICAgICAqIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9ucyB0byB0aGVzZSBwcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGhvdXQgdGhlIGFycmF5IHdyYXBwZXIuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2ltaWxhcmx5LCB0byBsb2NhbGx5IG92ZXJyaWRlIHRoZSByZXF1ZXN0L3Jlc3BvbnNlIHRyYW5zZm9ybXMsIGF1Z21lbnQgdGhlIGB0cmFuc2Zvcm1SZXF1ZXN0YCBhbmQvb3IKICAgICAgICAgICAgICAgICAqIGB0cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QgcGFzc2VkIGludG8gYCRodHRwYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBDYWNoaW5nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gZW5hYmxlIGNhY2hpbmcsIHNldCB0aGUgY29uZmlndXJhdGlvbiBwcm9wZXJ0eSBgY2FjaGVgIHRvIGB0cnVlYC4gV2hlbiB0aGUgY2FjaGUgaXMKICAgICAgICAgICAgICAgICAqIGVuYWJsZWQsIGAkaHR0cGAgc3RvcmVzIHRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgaW4gbG9jYWwgY2FjaGUuIE5leHQgdGltZSB0aGUKICAgICAgICAgICAgICAgICAqIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIHRoZSBjYWNoZSB3aXRob3V0IHNlbmRpbmcgYSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIGNhY2hlLCBkZWxpdmVyeSBvZiB0aGUgZGF0YSBpcyBhc3luY2hyb25vdXMgaW4KICAgICAgICAgICAgICAgICAqIHRoZSBzYW1lIHdheSB0aGF0IHJlYWwgcmVxdWVzdHMgYXJlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBHRVQgcmVxdWVzdHMgZm9yIHRoZSBzYW1lIFVSTCB0aGF0IHNob3VsZCBiZSBjYWNoZWQgdXNpbmcgdGhlIHNhbWUKICAgICAgICAgICAgICAgICAqIGNhY2hlLCBidXQgdGhlIGNhY2hlIGlzIG5vdCBwb3B1bGF0ZWQgeWV0LCBvbmx5IG9uZSByZXF1ZXN0IHRvIHRoZSBzZXJ2ZXIgd2lsbCBiZSBtYWRlIGFuZAogICAgICAgICAgICAgICAgICogdGhlIHJlbWFpbmluZyByZXF1ZXN0cyB3aWxsIGJlIGZ1bGZpbGxlZCB1c2luZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgZmlyc3QgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBSZXNwb25zZSBpbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgICAgICAgICAgICAgKiBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZyBvZiByZWNlaXZlZCByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZSBhYmxlIHRvIGludGVyY2VwdAogICAgICAgICAgICAgICAgICogcmVzcG9uc2VzIGZvciBodHRwIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgICAgICAgICAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSByZXNwb25zZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICAgICAgICAgICAgICogcHJvbWlzZSBhcGlzfSB0byBmdWxmaWwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlICRodHRwUHJvdmlkZXIgYnkKICAgICAgICAgICAgICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvciAg4oCUIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogdGFrZXMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gYW5kIHJldHVybnMgdGhlIG9yaWdpbmFsIG9yIGEgbmV3IHByb21pc2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICAgICAgICAgICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlc3BvbnNlKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVzcG9uc2UpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBXaGVuIGRlc2lnbmluZyB3ZWIgYXBwbGljYXRpb25zLCBjb25zaWRlciBzZWN1cml0eSB0aHJlYXRzIGZyb206CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiAgIEpTT04gdnVsbmVyYWJpbGl0eX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCb3RoIHNlcnZlciBhbmQgdGhlIGNsaWVudCBtdXN0IGNvb3BlcmF0ZSBpbiBvcmRlciB0byBlbGltaW5hdGUgdGhlc2UgdGhyZWF0cy4gQW5ndWxhciBjb21lcwogICAgICAgICAgICAgICAgICogcHJlLWNvbmZpZ3VyZWQgd2l0aCBzdHJhdGVnaWVzIHRoYXQgYWRkcmVzcyB0aGVzZSBpc3N1ZXMsIGJ1dCBmb3IgdGhpcyB0byB3b3JrIGJhY2tlbmQgc2VydmVyCiAgICAgICAgICAgICAgICAgKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBKU09OIFZ1bG5lcmFiaWxpdHkgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEge0BsaW5rIGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweAogICAgICAgICAgICAgICAgICogSlNPTiB2dWxuZXJhYmlsaXR5fSBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9IHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogICAgICAgICAgICAgICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiApXX0nLAogICAgICAgICAgICAgICAgICogWydvbmUnLCd0d28nXQogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5IFhTUkZ9IGlzIGEgdGVjaG5pcXVlIGJ5IHdoaWNoCiAgICAgICAgICAgICAgICAgKiBhbiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgYSBtZWNoYW5pc20KICAgICAgICAgICAgICAgICAqIHRvIGNvdW50ZXIgWFNSRi4gV2hlbiBwZXJmb3JtaW5nIFhIUiByZXF1ZXN0cywgdGhlICRodHRwIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgYFhTUkYtVE9LRU5gIGFuZCBzZXRzIGl0IGFzIHRoZSBIVFRQIGhlYWRlciBgWC1YU1JGLVRPS0VOYC4gU2luY2Ugb25seSBKYXZhU2NyaXB0IHRoYXQKICAgICAgICAgICAgICAgICAqIHJ1bnMgb24geW91ciBkb21haW4gY291bGQgcmVhZCB0aGUgY29va2llLCB5b3VyIHNlcnZlciBjYW4gYmUgYXNzdXJlZCB0aGF0IHRoZSBYSFIgY2FtZSBmcm9tCiAgICAgICAgICAgICAgICAgKiBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gdGFrZSBhZHZhbnRhZ2Ugb2YgdGhpcywgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gc2V0IGEgdG9rZW4gaW4gYSBKYXZhU2NyaXB0IHJlYWRhYmxlIHNlc3Npb24KICAgICAgICAgICAgICAgICAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIHRoZSBmaXJzdCBIVFRQIEdFVCByZXF1ZXN0LiBPbiBzdWJzZXF1ZW50IFhIUiByZXF1ZXN0cyB0aGUKICAgICAgICAgICAgICAgICAqIHNlcnZlciBjYW4gdmVyaWZ5IHRoYXQgdGhlIGNvb2tpZSBtYXRjaGVzIGBYLVhTUkYtVE9LRU5gIEhUVFAgaGVhZGVyLCBhbmQgdGhlcmVmb3JlIGJlIHN1cmUKICAgICAgICAgICAgICAgICAqIHRoYXQgb25seSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4gY291bGQgaGF2ZSBzZW50IHRoZSByZXF1ZXN0LiBUaGUgdG9rZW4gbXVzdCBiZQogICAgICAgICAgICAgICAgICogdW5pcXVlIGZvciBlYWNoIHVzZXIgYW5kIG11c3QgYmUgdmVyaWZpYWJsZSBieSB0aGUgc2VydmVyICh0byBwcmV2ZW50IHRoZSBKYXZhU2NyaXB0IGZyb20gbWFraW5nCiAgICAgICAgICAgICAgICAgKiB1cCBpdHMgb3duIHRva2VucykuIFdlIHJlY29tbWVuZCB0aGF0IHRoZSB0b2tlbiBpcyBhIGRpZ2VzdCBvZiB5b3VyIHNpdGUncyBhdXRoZW50aWNhdGlvbgogICAgICAgICAgICAgICAgICogY29va2llIHdpdGggYSB7QGxpbmsgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FsdF8oY3J5cHRvZ3JhcGh5KSBzYWx0fSBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIHJlcXVlc3QgdG8gYmUgbWFkZSBhbmQgaG93IGl0IHNob3VsZCBiZQogICAgICAgICAgICAgICAgICogICAgcHJvY2Vzc2VkLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAtICoqbWV0aG9kKiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgbWV0aG9kIChlLmcuICdHRVQnLCAnUE9TVCcsIGV0YykKICAgICAgICAgICAgICAgICAqICAgIC0gKip1cmwqKiDigJMgYHtzdHJpbmd9YCDigJMgQWJzb2x1dGUgb3IgcmVsYXRpdmUgVVJMIG9mIHRoZSByZXNvdXJjZSB0aGF0IGlzIGJlaW5nIHJlcXVlc3RlZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipwYXJhbXMqKiDigJMgYHtPYmplY3QuPHN0cmluZ3xPYmplY3Q+fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIG9iamVjdHMgd2hpY2ggd2lsbCBiZSB0dXJuZWQgdG8KICAgICAgICAgICAgICAgICAqICAgICAgYD9rZXkxPXZhbHVlMSZrZXkyPXZhbHVlMmAgYWZ0ZXIgdGhlIHVybC4gSWYgdGhlIHZhbHVlIGlzIG5vdCBhIHN0cmluZywgaXQgd2lsbCBiZSBKU09OaWZpZWQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgRGF0YSB0byBiZSBzZW50IGFzIHRoZSByZXF1ZXN0IG1lc3NhZ2UgZGF0YS4KICAgICAgICAgICAgICAgICAqICAgIC0gKipoZWFkZXJzKiog4oCTIGB7T2JqZWN0fWAg4oCTIE1hcCBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyBIVFRQIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlcXVlc3QqKiDigJMgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgICAgICAgICAgICAgKiAgICAgIHRyYW5zZm9ybSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdWNoIGZ1bmN0aW9ucy4gVGhlIHRyYW5zZm9ybSBmdW5jdGlvbiB0YWtlcyB0aGUgaHR0cAogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0IGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKmNhY2hlKiog4oCTIGB7Ym9vbGVhbnxDYWNoZX1gIOKAkyBJZiB0cnVlLCBhIGRlZmF1bHQgJGh0dHAgY2FjaGUgd2lsbCBiZSB1c2VkIHRvIGNhY2hlIHRoZQogICAgICAgICAgICAgICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICAgICAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgICAgICAgICAgICAgKiAgICAgIGNhY2hpbmcuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcn1gIOKAkyB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip3aXRoQ3JlZGVudGlhbHMqKiAtIGB7Ym9vbGVhbn1gIC0gd2hldGhlciB0byB0byBzZXQgdGhlIGB3aXRoQ3JlZGVudGlhbHNgIGZsYWcgb24gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vaHR0cF9hY2Nlc3NfY29udHJvbCNzZWN0aW9uXzUKICAgICAgICAgICAgICAgICAqICAgICAgcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgICAgICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAgICAgICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAgICAgICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybSBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0ibWV0aG9kIj4KICAgICAgICAgICAgICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnR0VUJywgJ2h0dHAtaGVsbG8uaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPlNhbXBsZSBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OUCcsICdodHRwOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPkludmFsaWQgSlNPTlA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBGZXRjaEN0cmwoJHNjb3BlLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKICAgICAgICAgICAgJHNjb3BlLm1ldGhvZCA9ICdHRVQnOwogICAgICAgICAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgICAgICAgICAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkc2NvcGUuY29kZSA9IG51bGw7CiAgICAgICAgICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICAgICAgICAgJGh0dHAoe21ldGhvZDogJHNjb3BlLm1ldGhvZCwgdXJsOiAkc2NvcGUudXJsLCBjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhID0gZGF0YSB8fCAiUmVxdWVzdCBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZU1vZGVsID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKICAgICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAgICAgICAgICRzY29wZS51cmwgPSB1cmw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9Imh0dHAtaGVsbG8uaHRtbCI+CiAgICAgICAgICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgR0VUIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvSGVsbG8sIFwkaHR0cCEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiU2FtcGxlIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcyMDAnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2RhdGEnKSkudG9NYXRjaCgvU3VwZXIgSGVybyEvKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0JlKCdSZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gJGh0dHAoY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcVRyYW5zZm9ybUZuID0gY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICByZXNwVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UgfHwgJGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVycyA9ICRjb25maWcuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgcmVxSGVhZGVycyA9IGV4dGVuZCh7J1gtWFNSRi1UT0tFTic6ICRicm93c2VyLmNvb2tpZXMoKVsnWFNSRi1UT0tFTiddfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZkhlYWRlcnMuY29tbW9uLCBkZWZIZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0sIGNvbmZpZy5oZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxRGF0YSA9IHRyYW5zZm9ybURhdGEoY29uZmlnLmRhdGEsIGhlYWRlcnNHZXR0ZXIocmVxSGVhZGVycyksIHJlcVRyYW5zZm9ybUZuKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAgY29udGVudC10eXBlIGlmIGRhdGEgaXMgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvbmZpZy5kYXRhKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcmVxSGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpOwoKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGZ1dHVyZSByZXNwb25zZQogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9ycywgZnVuY3Rpb24gKGludGVyY2VwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBpbnRlcmNlcHRvcihwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5zdWNjZXNzID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKG51bGwsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZm9ybVJlc3BvbnNlKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1ha2UgYSBjb3B5IHNpbmNlIHRoZSByZXNwb25zZSBtdXN0IGJlIGNhY2hlYWJsZQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcCA9IGV4dGVuZCh7fSwgcmVzcG9uc2UsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRyYW5zZm9ybURhdGEocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2UuaGVhZGVycywgcmVzcFRyYW5zZm9ybUZuKQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChpc1N1Y2Nlc3MocmVzcG9uc2Uuc3RhdHVzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gcmVzcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkcS5yZWplY3QocmVzcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cyA9IFtdOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjZ2V0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBHRVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjZGVsZXRlCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBERUxFVEVgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjaGVhZAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSEVBRGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNqc29ucAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSlNPTlBgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgIFNob3VsZCBjb250YWluIGBKU09OX0NBTExCQUNLYCBzdHJpbmcuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNyZWF0ZVNob3J0TWV0aG9kcygnZ2V0JywgJ2RlbGV0ZScsICdoZWFkJywgJ2pzb25wJyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNwb3N0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQT1NUYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3B1dAogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUFVUYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKCdwb3N0JywgJ3B1dCcpOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWZhdWx0cwogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFJ1bnRpbWUgZXF1aXZhbGVudCBvZiB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHNgIHByb3BlcnR5LiBBbGxvd3MgY29uZmlndXJhdGlvbiBvZgogICAgICAgICAgICAgICAgICogZGVmYXVsdCBoZWFkZXJzIGFzIHdlbGwgYXMgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNlZSAiU2V0dGluZyBIVFRQIEhlYWRlcnMiIGFuZCAiVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMiIHNlY3Rpb25zIGFib3ZlLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAkaHR0cC5kZWZhdWx0cyA9ICRjb25maWc7CgoKICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cDsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY3JlYXRlU2hvcnRNZXRob2RzKG5hbWVzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24gKHVybCwgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YShuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24gKHVybCwgZGF0YSwgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogTWFrZXMgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogISEhIEFDQ0VTU0VTIENMT1NVUkUgVkFSUzoKICAgICAgICAgICAgICAgICAqICRodHRwQmFja2VuZCwgJGNvbmZpZywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuY2FjaGUgJiYgY29uZmlnLm1ldGhvZCA9PSAnR0VUJykgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSA9IGlzT2JqZWN0KGNvbmZpZy5jYWNoZSkgPyBjb25maWcuY2FjaGUgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZFJlc3AudGhlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkUmVzcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VydmluZyBmcm9tIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgY29weShjYWNoZWRSZXNwWzJdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHV0IHRoZSBwcm9taXNlIGZvciB0aGUgbm9uLXRyYW5zZm9ybWVkIHJlc3BvbnNlIGludG8gY2FjaGUgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIHdvbid0IGhhdmUgdGhlIHJlc3BvbnNlIGluIGNhY2hlLCBzZW5kIHRoZSByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZChjb25maWcubWV0aG9kLCB1cmwsIHJlcURhdGEsIGRvbmUsIHJlcUhlYWRlcnMsIGNvbmZpZy50aW1lb3V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIENhbGxiYWNrIHJlZ2lzdGVyZWQgdG8gJGh0dHBCYWNrZW5kKCk6CiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FjaGVzIHRoZSByZXNwb25zZSBpZiBkZXNpcmVkCiAgICAgICAgICAgICAgICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAgICAgICAgICAgICAgICogIC0gY2FsbHMgJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3VjY2VzcyhzdGF0dXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgcHJvbWlzZSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlLnJlbW92ZSh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gaW5kZXhPZigkaHR0cC5wZW5kaW5nUmVxdWVzdHMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB0b0pzb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsICsgKCh1cmwuaW5kZXhPZignPycpID09IC0xKSA/ICc/JyA6ICcmJykgKyBwYXJ0cy5qb2luKCcmJyk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFhIUiA9IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC42LjAiKTsKICAgICAgICB9IGNhdGNoIChlMSkgewogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjMuMCIpOwogICAgICAgIH0gY2F0Y2ggKGUyKSB7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAiKTsKICAgICAgICB9IGNhdGNoIChlMykgewogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFhNTEh0dHBSZXF1ZXN0LiIpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaHR0cEJhY2tlbmQKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUVFAgYmFja2VuZCB1c2VkIGJ5IHRoZSB7QGxpbmsgbmcuJGh0dHAgc2VydmljZX0gdGhhdCBkZWxlZ2F0ZXMgdG8KICAgICAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogICAgICoKICAgICAqIFlvdSBzaG91bGQgbmV2ZXIgbmVlZCB0byB1c2UgdGhpcyBzZXJ2aWNlIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZSB0aGUgaGlnaGVyLWxldmVsIGFic3RyYWN0aW9uczoKICAgICAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAgICAgKgogICAgICogRHVyaW5nIHRlc3RpbmcgdGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBzd2FwcGVkIHdpdGgge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgbW9jawogICAgICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3Nlci5kZWZlciwgJHdpbmRvdy5hbmd1bGFyLmNhbGxiYWNrcywKICAgICAgICAgICAgICAgICRkb2N1bWVudFswXSwgJHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKCc6JywgJycpKTsKICAgICAgICB9XTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3NlckRlZmVyLCBjYWxsYmFja3MsIHJhd0RvY3VtZW50LCBsb2NhdGlvblByb3RvY29sKSB7CiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMsIHRpbWVvdXQsIHdpdGhDcmVkZW50aWFscykgewogICAgICAgICAgICAkYnJvd3Nlci4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50KCk7CiAgICAgICAgICAgIHVybCA9IHVybCB8fCAkYnJvd3Nlci51cmwoKTsKCiAgICAgICAgICAgIGlmIChsb3dlcmNhc2UobWV0aG9kKSA9PSAnanNvbnAnKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tJZCA9ICdfJyArIChjYWxsYmFja3MuY291bnRlcisrKS50b1N0cmluZygzNik7CiAgICAgICAgICAgICAgICBjYWxsYmFja3NbY2FsbGJhY2tJZF0gPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIDIwMCwgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCAtMik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxiYWNrc1tjYWxsYmFja0lkXTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWEhSKCk7CiAgICAgICAgICAgICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHZhciBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gSW4gSUU2IGFuZCA3LCB0aGlzIG1pZ2h0IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5IHdoZW4geGhyLnNlbmQgYmVsb3cgaXMgY2FsbGVkIGFuZCB0aGUKICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlIGlzIGluIHRoZSBjYWNoZS4gdGhlIHByb21pc2UgYXBpIHdpbGwgZW5zdXJlIHRoYXQgdG8gdGhlIGFwcCBjb2RlIHRoZSBhcGkgaXMKICAgICAgICAgICAgICAgIC8vIGFsd2F5cyBhc3luYwogICAgICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlbW92ZSBvbmNlIEZpcmVmb3ggMjEgZ2V0cyByZWxlYXNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVnaW46IHdvcmthcm91bmQgdG8gb3ZlcmNvbWUgRmlyZWZveCBDT1JTIGh0dHAgcmVzcG9uc2UgaGVhZGVycyBidWcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjA4NzM1CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggYWxyZWFkeSBwYXRjaGVkIGluIG5pZ2h0bHkuIFNob3VsZCBsYW5kIGluIEZpcmVmb3ggMjEuCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDT1JTICJzaW1wbGUgcmVzcG9uc2UgaGVhZGVycyIgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2ltcGxlSGVhZGVycyA9IFsiQ2FjaGUtQ29udHJvbCIsICJDb250ZW50LUxhbmd1YWdlIiwgIkNvbnRlbnQtVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGlyZXMiLCAiTGFzdC1Nb2RpZmllZCIsICJQcmFnbWEiXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzaW1wbGVIZWFkZXJzLCBmdW5jdGlvbiAoaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKGhlYWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyArPSBoZWFkZXIgKyAiOiAiICsgdmFsdWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuZCBvZiB0aGUgd29ya2Fyb3VuZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzIHx8IHhoci5zdGF0dXMsIHhoci5yZXNwb25zZVRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKHdpdGhDcmVkZW50aWFscykgewogICAgICAgICAgICAgICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHhoci5zZW5kKHBvc3QgfHwgJycpOwoKICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyRGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgeGhyLmFib3J0KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGltZW91dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFVSTF9NQVRDSCBpcyBkZWZpbmVkIGluIHNyYy9zZXJ2aWNlL2xvY2F0aW9uLmpzCiAgICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSAodXJsLm1hdGNoKFVSTF9NQVRDSCkgfHwgWycnLCBsb2NhdGlvblByb3RvY29sXSlbMV07CgogICAgICAgICAgICAgICAgLy8gZml4IHN0YXR1cyBjb2RlIGZvciBmaWxlIHByb3RvY29sIChpdCdzIGFsd2F5cyAwKQogICAgICAgICAgICAgICAgc3RhdHVzID0gKHByb3RvY29sID09ICdmaWxlJykgPyAocmVzcG9uc2UgPyAyMDAgOiA0MDQpIDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBJRSBidWcgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzE0NTApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSBzdGF0dXMgPT0gMTIyMyA/IDIwNCA6IHN0YXR1czsKCiAgICAgICAgICAgICAgICBjYWxsYmFjayhzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nKTsKICAgICAgICAgICAgICAgICRicm93c2VyLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBqc29ucFJlcSh1cmwsIGRvbmUpIHsKICAgICAgICAgICAgLy8gd2UgY2FuJ3QgdXNlIGpRdWVyeS9qcUxpdGUgaGVyZSBiZWNhdXNlIGpRdWVyeSBkb2VzIGNyYXp5IHNoaXQgd2l0aCBzY3JpcHQgZWxlbWVudHMsIGUuZy46CiAgICAgICAgICAgIC8vIC0gZmV0Y2hlcyBsb2NhbCBzY3JpcHRzIHZpYSBYSFIgYW5kIGV2YWxzIHRoZW0KICAgICAgICAgICAgLy8gLSBhZGRzIGFuZCBpbW1lZGlhdGVseSByZW1vdmVzIHNjcmlwdCBlbGVtZW50cyBmcm9tIHRoZSBkb2N1bWVudAogICAgICAgICAgICB2YXIgc2NyaXB0ID0gcmF3RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JyksCiAgICAgICAgICAgICAgICBkb25lV3JhcHBlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByYXdEb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIGRvbmUoKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOwogICAgICAgICAgICBzY3JpcHQuc3JjID0gdXJsOwoKICAgICAgICAgICAgaWYgKG1zaWUpIHsKICAgICAgICAgICAgICAgIHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSBkb25lV3JhcHBlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25lcnJvciA9IGRvbmVXcmFwcGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICByYXdEb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvY2FsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogJGxvY2FsZSBzZXJ2aWNlIHByb3ZpZGVzIGxvY2FsaXphdGlvbiBydWxlcyBmb3IgdmFyaW91cyBBbmd1bGFyIGNvbXBvbmVudHMuIEFzIG9mIHJpZ2h0IG5vdyB0aGUKICAgICAqIG9ubHkgcHVibGljIGFwaSBpczoKICAgICAqCiAgICAgKiAqIGBpZGAg4oCTIGB7c3RyaW5nfWAg4oCTIGxvY2FsZSBpZCBmb3JtYXR0ZWQgYXMgYGxhbmd1YWdlSWQtY291bnRyeUlkYCAoZS5nLiBgZW4tdXNgKQogICAgICovCiAgICBmdW5jdGlvbiAkTG9jYWxlUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaWQ6ICdlbi11cycsCgogICAgICAgICAgICAgICAgTlVNQkVSX0ZPUk1BVFM6IHsKICAgICAgICAgICAgICAgICAgICBERUNJTUFMX1NFUDogJy4nLAogICAgICAgICAgICAgICAgICAgIEdST1VQX1NFUDogJywnLAogICAgICAgICAgICAgICAgICAgIFBBVFRFUk5TOiBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsgLy8gRGVjaW1hbCBQYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5GcmFjOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4RnJhYzogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1ByZTogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NTdWY6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnUHJlOiAnLScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdTdWY6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgeyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJyknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgREFURVRJTUVfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIE1PTlRIOiAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlRNT05USDogJ0phbixGZWIsTWFyLEFwcixNYXksSnVuLEp1bCxBdWcsU2VwLE9jdCxOb3YsRGVjJy5zcGxpdCgnLCcpLAogICAgICAgICAgICAgICAgICAgIERBWTogJ1N1bmRheSxNb25kYXksVHVlc2RheSxXZWRuZXNkYXksVGh1cnNkYXksRnJpZGF5LFNhdHVyZGF5Jy5zcGxpdCgnLCcpLAogICAgICAgICAgICAgICAgICAgIFNIT1JUREFZOiAnU3VuLE1vbixUdWUsV2VkLFRodSxGcmksU2F0Jy5zcGxpdCgnLCcpLAogICAgICAgICAgICAgICAgICAgIEFNUE1TOiBbJ0FNJywgJ1BNJ10sCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtOiAnTU1NIGQsIHkgaDptbTpzcyBhJywKICAgICAgICAgICAgICAgICAgICBzaG9ydDogJ00vZC95eSBoOm1tIGEnLAogICAgICAgICAgICAgICAgICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBsb25nRGF0ZTogJ01NTU0gZCwgeScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtRGF0ZTogJ01NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgICAgICAgICAgICAgICAgIG1lZGl1bVRpbWU6ICdoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0VGltZTogJ2g6bW0gYScKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbiAobnVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ29uZSc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gJFRpbWVvdXRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGJyb3dzZXIsICRxLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgdmFyIGRlZmVycmVkcyA9IHt9OwoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHRpbWVvdXQKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAgICAgICAgICAgICogYmxvY2sgYW5kIGRlbGVnYXRlcyBhbnkgZXhjZXB0aW9ucyB0bwogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgcmVnaXN0ZXJpbmcgYSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGEgcHJvbWlzZSwgd2hpY2ggd2lsbCBiZSByZXNvbHZlZCB3aGVuCiAgICAgICAgICAgICAgICAgKiB0aGUgdGltZW91dCBpcyByZWFjaGVkIGFuZCB0aGUgdGltZW91dCBmdW5jdGlvbiBpcyBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBjYW5jZWwgYSB0aW1lb3V0IHJlcXVlc3QsIGNhbGwgYCR0aW1lb3V0LmNhbmNlbChwcm9taXNlKWAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICAgICAgICAgICAgKiBzeW5jaHJvbm91c2x5IGZsdXNoIHRoZSBxdWV1ZSBvZiBkZWZlcnJlZCBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBEZWxheSBpbiBtaWxsaXNlY29uZHMuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbaW52b2tlQXBwbHk9dHJ1ZV0gSWYgc2V0IHRvIGBmYWxzZWAgc2tpcHMgbW9kZWwgZGlydHkgY2hlY2tpbmcsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2hlbiB0aGUgdGltZW91dCBpcyByZWFjaGVkLiBUaGUgdmFsdWUgdGhpcwogICAgICAgICAgICAgICAgICogICBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBpcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBgZm5gIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0aW1lb3V0KGZuLCBkZWxheSwgaW52b2tlQXBwbHkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcEFwcGx5ID0gKGlzRGVmaW5lZChpbnZva2VBcHBseSkgJiYgIWludm9rZUFwcGx5KSwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dElkLCBjbGVhbnVwOwoKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZuKCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR0aW1lb3V0SWQgPSB0aW1lb3V0SWQ7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWRzW3RpbWVvdXRJZF0gPSBkZWZlcnJlZDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oY2xlYW51cCwgY2xlYW51cCk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHRpbWVvdXQjY2FuY2VsCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHRpbWVvdXQKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICAgICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgICAgKiAgIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uIChwcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb21pc2UgJiYgcHJvbWlzZS4kJHRpbWVvdXRJZCBpbiBkZWZlcnJlZHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdLnJlamVjdCgnY2FuY2VsZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRicm93c2VyLmRlZmVyLmNhbmNlbChwcm9taXNlLiQkdGltZW91dElkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdGltZW91dDsKICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEZpbHRlcnMgYXJlIGp1c3QgZnVuY3Rpb25zIHdoaWNoIHRyYW5zZm9ybSBpbnB1dCB0byBhbiBvdXRwdXQuIEhvd2V2ZXIgZmlsdGVycyBuZWVkIHRvIGJlIERlcGVuZGVuY3kgSW5qZWN0ZWQuIFRvCiAgICAgKiBhY2hpZXZlIHRoaXMgYSBmaWx0ZXIgZGVmaW5pdGlvbiBjb25zaXN0cyBvZiBhIGZhY3RvcnkgZnVuY3Rpb24gd2hpY2ggaXMgYW5ub3RhdGVkIHdpdGggZGVwZW5kZW5jaWVzIGFuZCBpcwogICAgICogcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGEgZmlsdGVyIGZ1bmN0aW9uLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIEZpbHRlciByZWdpc3RyYXRpb24KICAgICAqICAgZnVuY3Rpb24gTXlNb2R1bGUoJHByb3ZpZGUsICRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgLy8gY3JlYXRlIGEgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBpbmplY3Rpb24gKG5vdCBhbHdheXMgbmVlZGVkKQogKiAgICAgJHByb3ZpZGUudmFsdWUoJ2dyZWV0JywgZnVuY3Rpb24obmFtZSl7CiAqICAgICAgIHJldHVybiAnSGVsbG8gJyArIG5hbWUgKyAnISc7CiAqICAgICB9KTsKICoKICogICAgIC8vIHJlZ2lzdGVyIGEgZmlsdGVyIGZhY3Rvcnkgd2hpY2ggdXNlcyB0aGUKICogICAgIC8vIGdyZWV0IHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgREkuCiAqICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ2dyZWV0JywgZnVuY3Rpb24oZ3JlZXQpewogKiAgICAgICAvLyByZXR1cm4gdGhlIGZpbHRlciBmdW5jdGlvbiB3aGljaCB1c2VzIHRoZSBncmVldCBzZXJ2aWNlCiAqICAgICAgIC8vIHRvIGdlbmVyYXRlIHNhbHV0YXRpb24KICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRleHQpIHsKICogICAgICAgICAvLyBmaWx0ZXJzIG5lZWQgdG8gYmUgZm9yZ2l2aW5nIHNvIGNoZWNrIGlucHV0IHZhbGlkaXR5CiAqICAgICAgICAgcmV0dXJuIHRleHQgJiYgZ3JlZXQodGV4dCkgfHwgdGV4dDsKICogICAgICAgfTsKICogICAgIH0pOwogKiAgIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBmaWx0ZXIgZnVuY3Rpb24gaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGluamVjdG9yYCB1bmRlciB0aGUgZmlsdGVyIG5hbWUgc3VmZml4ZSB3aXRoIGBGaWx0ZXJgLgogICAgICogPHByZT4KICAgICAqICAgaXQoJ3Nob3VsZCBiZSB0aGUgc2FtZSBpbnN0YW5jZScsIGluamVjdCgKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyUHJvdmlkZXIpIHsKICogICAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdyZXZlcnNlJywgZnVuY3Rpb24oKXsKICogICAgICAgICByZXR1cm4gLi4uOwogKiAgICAgICB9KTsKICogICAgIH0sCiAgICAgKiAgICAgZnVuY3Rpb24oJGZpbHRlciwgcmV2ZXJzZUZpbHRlcikgewogKiAgICAgICBleHBlY3QoJGZpbHRlcigncmV2ZXJzZScpKS50b0JlKHJldmVyc2VGaWx0ZXIpOwogKiAgICAgfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgZmlsdGVycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biBmaWx0ZXJzLCBzZWUKICAgICAqIHtAbGluayBndWlkZS9kZXZfZ3VpZGUudGVtcGxhdGVzLmZpbHRlcnMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIEZpbHRlcnN9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlcgogICAgICogR3VpZGUuCiAgICAgKi8KICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgbmcuJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgKiBAbWV0aG9kT2YgbmcuJGZpbHRlclByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVyIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZpbHRlci4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZuIFRoZSBmaWx0ZXIgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBpbmplY3RhYmxlLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmlsdGVycyBhcmUgdXNlZCBmb3IgZm9ybWF0dGluZyBkYXRhIGRpc3BsYXllZCB0byB0aGUgdXNlci4KICAgICAqCiAgICAgKiBUaGUgZ2VuZXJhbCBzeW50YXggaW4gdGVtcGxhdGVzIGlzIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogICAgICAgICB7eyBleHByZXNzaW9uIFt8IGZpbHRlcl9uYW1lWzpwYXJhbWV0ZXJfdmFsdWVdIC4uLiBdIH19CiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHRvIHJldHJpZXZlCiAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gdGhlIGZpbHRlciBmdW5jdGlvbgogICAgICovCiAgICAkRmlsdGVyUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICAgIGZ1bmN0aW9uICRGaWx0ZXJQcm92aWRlcigkcHJvdmlkZSkgewogICAgICAgIHZhciBzdWZmaXggPSAnRmlsdGVyJzsKCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgZmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgc3VmZml4LCBmYWN0b3J5KTsKICAgICAgICB9CgogICAgICAgIHRoaXMucmVnaXN0ZXIgPSByZWdpc3RlcjsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCBmdW5jdGlvbiAoJGluamVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRpbmplY3Rvci5nZXQobmFtZSArIHN1ZmZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICB9XTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICByZWdpc3RlcignY3VycmVuY3knLCBjdXJyZW5jeUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2RhdGUnLCBkYXRlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZmlsdGVyJywgZmlsdGVyRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignanNvbicsIGpzb25GaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdsaW1pdFRvJywgbGltaXRUb0ZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xvd2VyY2FzZScsIGxvd2VyY2FzZUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ251bWJlcicsIG51bWJlckZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ29yZGVyQnknLCBvcmRlckJ5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcigndXBwZXJjYXNlJywgdXBwZXJjYXNlRmlsdGVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2VsZWN0cyBhIHN1YnNldCBvZiBpdGVtcyBmcm9tIGBhcnJheWAgYW5kIHJldHVybnMgaXQgYXMgYSBuZXcgYXJyYXkuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fGZ1bmN0aW9uKCl9IGV4cHJlc3Npb24gVGhlIHByZWRpY2F0ZSB0byBiZSB1c2VkIGZvciBzZWxlY3RpbmcgaXRlbXMgZnJvbQogICAgICogICBgYXJyYXlgLgogICAgICoKICAgICAqICAgQ2FuIGJlIG9uZSBvZjoKICAgICAqCiAgICAgKiAgIC0gYHN0cmluZ2A6IFByZWRpY2F0ZSB0aGF0IHJlc3VsdHMgaW4gYSBzdWJzdHJpbmcgbWF0Y2ggdXNpbmcgdGhlIHZhbHVlIG9mIGBleHByZXNzaW9uYAogICAgICogICAgIHN0cmluZy4gQWxsIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aXRoIHN0cmluZyBwcm9wZXJ0aWVzIGluIGBhcnJheWAgdGhhdCBjb250YWluIHRoaXMgc3RyaW5nCiAgICAgKiAgICAgd2lsbCBiZSByZXR1cm5lZC4gVGhlIHByZWRpY2F0ZSBjYW4gYmUgbmVnYXRlZCBieSBwcmVmaXhpbmcgdGhlIHN0cmluZyB3aXRoIGAhYC4KICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IEEgcGF0dGVybiBvYmplY3QgY2FuIGJlIHVzZWQgdG8gZmlsdGVyIHNwZWNpZmljIHByb3BlcnRpZXMgb24gb2JqZWN0cyBjb250YWluZWQKICAgICAqICAgICBieSBgYXJyYXlgLiBGb3IgZXhhbXBsZSBge25hbWU6Ik0iLCBwaG9uZToiMSJ9YCBwcmVkaWNhdGUgd2lsbCByZXR1cm4gYW4gYXJyYXkgb2YgaXRlbXMKICAgICAqICAgICB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYCBjb250YWluaW5nICJNIiBhbmQgcHJvcGVydHkgYHBob25lYCBjb250YWluaW5nICIxIi4gQSBzcGVjaWFsCiAgICAgKiAgICAgcHJvcGVydHkgbmFtZSBgJGAgY2FuIGJlIHVzZWQgKGFzIGluIGB7JDoidGV4dCJ9YCkgdG8gYWNjZXB0IGEgbWF0Y2ggYWdhaW5zdCBhbnkKICAgICAqICAgICBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LiBUaGF0J3MgZXF1aXZhbGVudCB0byB0aGUgc2ltcGxlIHN1YnN0cmluZyBtYXRjaCB3aXRoIGEgYHN0cmluZ2AKICAgICAqICAgICBhcyBkZXNjcmliZWQgYWJvdmUuCiAgICAgKgogICAgICogICAtIGBmdW5jdGlvbmA6IEEgcHJlZGljYXRlIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIHdyaXRlIGFyYml0cmFyeSBmaWx0ZXJzLiBUaGUgZnVuY3Rpb24gaXMKICAgICAqICAgICBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlIGVsZW1lbnRzIHRoYXQKICAgICAqICAgICB0aGUgcHJlZGljYXRlIHJldHVybmVkIHRydWUgZm9yLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJ30sCiAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfV0iPjwvZGl2PgoKICAgICBTZWFyY2g6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoVGV4dCI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hUZXh0UmVzdWx0cyI+CiAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgIDwvdHI+CiAgICAgPC90YWJsZT4KICAgICA8aHI+CiAgICAgQW55OiA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC4kIj4gPGJyPgogICAgIE5hbWUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5uYW1lIj48YnI+CiAgICAgUGhvbmUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5waG9uZSI+PGJyPgogICAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoIj4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgc2VhcmNoIGFjcm9zcyBhbGwgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3NlYXJjaFRleHQnKS5lbnRlcignbScpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnTWlrZScsICdBZGFtJ10pOwoKICAgICAgICAgaW5wdXQoJ3NlYXJjaFRleHQnKS5lbnRlcignNzYnKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcjc2VhcmNoVGV4dFJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydKb2huJywgJ0p1bGllJ10pOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoLiQnKS5lbnRlcignaScpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hPYmpSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0p1bGllJ10pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB2YXIgcHJlZGljYXRlcyA9IFtdOwogICAgICAgICAgICBwcmVkaWNhdGVzLmNoZWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByZWRpY2F0ZXNbal0odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uIChvYmosIHRleHQpIHsKICAgICAgICAgICAgICAgIGlmICh0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoJycgKyBvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmpLZXkuY2hhckF0KDApICE9PSAnJCcgJiYgc2VhcmNoKG9ialtvYmpLZXldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjYXNlICJhcnJheSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VhcmNoKG9ialtpXSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHByZXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7JDogZXhwcmVzc2lvbn07CiAgICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBleHByZXNzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnICsgZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaCh2YWx1ZSwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9ICgnJyArIGV4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWFyY2goZ2V0dGVyKHZhbHVlLCBwYXRoKSwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGVzLmNoZWNrKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6Y3VycmVuY3kKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRm9ybWF0cyBhIG51bWJlciBhcyBhIGN1cnJlbmN5IChpZSAkMSwyMzQuNTYpLiBXaGVuIG5vIGN1cnJlbmN5IHN5bWJvbCBpcyBwcm92aWRlZCwgZGVmYXVsdAogICAgICogc3ltYm9sIGZvciBjdXJyZW50IGxvY2FsZSBpcyB1c2VkLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgSW5wdXQgdG8gZmlsdGVyLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBzeW1ib2wgQ3VycmVuY3kgc3ltYm9sIG9yIGlkZW50aWZpZXIgdG8gYmUgZGlzcGxheWVkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuZy1tb2RlbD0iYW1vdW50Ij4gPGJyPgogICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKToge3thbW91bnQgfCBjdXJyZW5jeX19PGJyPgogICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdCB3aXRoIDEyMzQuNTYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJ1VTRCQxLDIzNC41NicpOwogICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2Ftb3VudCcpLmVudGVyKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnKCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCcoVVNEJDEsMjM0LjAwKScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGN1cnJlbmN5U3ltYm9sKSkgY3VycmVuY3lTeW1ib2wgPSBmb3JtYXRzLkNVUlJFTkNZX1NZTTsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCAyKS4KICAgICAgICAgICAgICAgIHJlcGxhY2UoL1x1MDBBNC9nLCBjdXJyZW5jeVN5bWJvbCk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpudW1iZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRm9ybWF0cyBhIG51bWJlciBhcyB0ZXh0LgogICAgICoKICAgICAqIElmIHRoZSBpbnB1dCBpcyBub3QgYSBudW1iZXIgYW4gZW1wdHkgc3RyaW5nIGlzIHJldHVybmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAgICAgKiBAcGFyYW0geyhudW1iZXJ8c3RyaW5nKT19IFtmcmFjdGlvblNpemU9Ml0gTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBudW1iZXIgdG8uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBOdW1iZXIgcm91bmRlZCB0byBkZWNpbWFsUGxhY2VzIGFuZCBwbGFjZXMgYSDigJws4oCdIGFmdGVyIGVhY2ggdGhpcmQgZGlnaXQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS52YWwgPSAxMjM0LjU2Nzg5OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBFbnRlciBudW1iZXI6IDxpbnB1dCBuZy1tb2RlbD0ndmFsJz48YnI+CiAgICAgRGVmYXVsdCBmb3JtYXR0aW5nOiB7e3ZhbCB8IG51bWJlcn19PGJyPgogICAgIE5vIGZyYWN0aW9uczoge3t2YWwgfCBudW1iZXI6MH19PGJyPgogICAgIE5lZ2F0aXZlIG51bWJlcjoge3stdmFsIHwgbnVtYmVyOjR9fQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZm9ybWF0IG51bWJlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCcxLDIzNC41NjgnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTEsMjM0LjU2NzknKTsKICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgndmFsJykuZW50ZXIoJzMzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXInKSkudG9CZSgnMywzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS50b0JlKCczLDM3NCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLnRvQmUoJy0zLDM3NC4zMzMwJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgoKICAgIG51bWJlckZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgICBmdW5jdGlvbiBudW1iZXJGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG51bWJlciwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROdW1iZXIobnVtYmVyLCBmb3JtYXRzLlBBVFRFUk5TWzBdLCBmb3JtYXRzLkdST1VQX1NFUCwgZm9ybWF0cy5ERUNJTUFMX1NFUCwKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CgogICAgZnVuY3Rpb24gZm9ybWF0TnVtYmVyKG51bWJlciwgcGF0dGVybiwgZ3JvdXBTZXAsIGRlY2ltYWxTZXAsIGZyYWN0aW9uU2l6ZSkgewogICAgICAgIGlmIChpc05hTihudW1iZXIpIHx8ICFpc0Zpbml0ZShudW1iZXIpKSByZXR1cm4gJyc7CgogICAgICAgIHZhciBpc05lZ2F0aXZlID0gbnVtYmVyIDwgMDsKICAgICAgICBudW1iZXIgPSBNYXRoLmFicyhudW1iZXIpOwogICAgICAgIHZhciBudW1TdHIgPSBudW1iZXIgKyAnJywKICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gJycsCiAgICAgICAgICAgIHBhcnRzID0gW107CgogICAgICAgIHZhciBoYXNFeHBvbmVudCA9IGZhbHNlOwogICAgICAgIGlmIChudW1TdHIuaW5kZXhPZignZScpICE9PSAtMSkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBudW1TdHIubWF0Y2goLyhbXGRcLl0rKWUoLT8pKFxkKykvKTsKICAgICAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoWzJdID09ICctJyAmJiBtYXRjaFszXSA+IGZyYWN0aW9uU2l6ZSArIDEpIHsKICAgICAgICAgICAgICAgIG51bVN0ciA9ICcwJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCA9IG51bVN0cjsKICAgICAgICAgICAgICAgIGhhc0V4cG9uZW50ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNFeHBvbmVudCkgewogICAgICAgICAgICB2YXIgZnJhY3Rpb25MZW4gPSAobnVtU3RyLnNwbGl0KERFQ0lNQUxfU0VQKVsxXSB8fCAnJykubGVuZ3RoOwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGZyYWN0aW9uU2l6ZSBpZiBpdCBpcyBub3Qgc3BlY2lmaWVkCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvblNpemUgPSBNYXRoLm1pbihNYXRoLm1heChwYXR0ZXJuLm1pbkZyYWMsIGZyYWN0aW9uTGVuKSwgcGF0dGVybi5tYXhGcmFjKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHBvdyA9IE1hdGgucG93KDEwLCBmcmFjdGlvblNpemUpOwogICAgICAgICAgICBudW1iZXIgPSBNYXRoLnJvdW5kKG51bWJlciAqIHBvdykgLyBwb3c7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbiA9ICgnJyArIG51bWJlcikuc3BsaXQoREVDSU1BTF9TRVApOwogICAgICAgICAgICB2YXIgd2hvbGUgPSBmcmFjdGlvblswXTsKICAgICAgICAgICAgZnJhY3Rpb24gPSBmcmFjdGlvblsxXSB8fCAnJzsKCiAgICAgICAgICAgIHZhciBwb3MgPSAwLAogICAgICAgICAgICAgICAgbGdyb3VwID0gcGF0dGVybi5sZ1NpemUsCiAgICAgICAgICAgICAgICBncm91cCA9IHBhdHRlcm4uZ1NpemU7CgogICAgICAgICAgICBpZiAod2hvbGUubGVuZ3RoID49IChsZ3JvdXAgKyBncm91cCkpIHsKICAgICAgICAgICAgICAgIHBvcyA9IHdob2xlLmxlbmd0aCAtIGxncm91cDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9zOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHBvcyAtIGkpICUgZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoKHdob2xlLmxlbmd0aCAtIGkpICUgbGdyb3VwID09PSAwICYmIGkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gZ3JvdXBTZXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBmb3JtYXQgZnJhY3Rpb24gcGFydC4KICAgICAgICAgICAgd2hpbGUgKGZyYWN0aW9uLmxlbmd0aCA8IGZyYWN0aW9uU2l6ZSkgewogICAgICAgICAgICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogICAgICAgIH0KCiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdQcmUgOiBwYXR0ZXJuLnBvc1ByZSk7CiAgICAgICAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogICAgICAgIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnU3VmIDogcGF0dGVybi5wb3NTdWYpOwogICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYWROdW1iZXIobnVtLCBkaWdpdHMsIHRyaW0pIHsKICAgICAgICB2YXIgbmVnID0gJyc7CiAgICAgICAgaWYgKG51bSA8IDApIHsKICAgICAgICAgICAgbmVnID0gJy0nOwogICAgICAgICAgICBudW0gPSAtbnVtOwogICAgICAgIH0KICAgICAgICBudW0gPSAnJyArIG51bTsKICAgICAgICB3aGlsZSAobnVtLmxlbmd0aCA8IGRpZ2l0cykgbnVtID0gJzAnICsgbnVtOwogICAgICAgIGlmICh0cmltKQogICAgICAgICAgICBudW0gPSBudW0uc3Vic3RyKG51bS5sZW5ndGggLSBkaWdpdHMpOwogICAgICAgIHJldHVybiBuZWcgKyBudW07CiAgICB9CgoKICAgIGZ1bmN0aW9uIGRhdGVHZXR0ZXIobmFtZSwgc2l6ZSwgb2Zmc2V0LCB0cmltKSB7CiAgICAgICAgb2Zmc2V0ID0gb2Zmc2V0IHx8IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRlKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgICAgICAgICBpZiAob2Zmc2V0ID4gMCB8fCB2YWx1ZSA+IC1vZmZzZXQpCiAgICAgICAgICAgICAgICB2YWx1ZSArPSBvZmZzZXQ7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiBvZmZzZXQgPT0gLTEyKSB2YWx1ZSA9IDEyOwogICAgICAgICAgICByZXR1cm4gcGFkTnVtYmVyKHZhbHVlLCBzaXplLCB0cmltKTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGRhdGVTdHJHZXR0ZXIobmFtZSwgc2hvcnRGb3JtKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgICAgICAgICB2YXIgZ2V0ID0gdXBwZXJjYXNlKHNob3J0Rm9ybSA/ICgnU0hPUlQnICsgbmFtZSkgOiBuYW1lKTsKCiAgICAgICAgICAgIHJldHVybiBmb3JtYXRzW2dldF1bdmFsdWVdOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIoZGF0ZSkgewogICAgICAgIHZhciB6b25lID0gLTEgKiBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgdmFyIHBhZGRlZFpvbmUgPSAoem9uZSA+PSAwKSA/ICIrIiA6ICIiOwoKICAgICAgICBwYWRkZWRab25lICs9IHBhZE51bWJlcihNYXRoW3pvbmUgPiAwID8gJ2Zsb29yJyA6ICdjZWlsJ10oem9uZSAvIDYwKSwgMikgKwogICAgICAgICAgICBwYWROdW1iZXIoTWF0aC5hYnMoem9uZSAlIDYwKSwgMik7CgogICAgICAgIHJldHVybiBwYWRkZWRab25lOwogICAgfQoKICAgIGZ1bmN0aW9uIGFtcG1HZXR0ZXIoZGF0ZSwgZm9ybWF0cykgewogICAgICAgIHJldHVybiBkYXRlLmdldEhvdXJzKCkgPCAxMiA/IGZvcm1hdHMuQU1QTVNbMF0gOiBmb3JtYXRzLkFNUE1TWzFdOwogICAgfQoKICAgIHZhciBEQVRFX0ZPUk1BVFMgPSB7CiAgICAgICAgeXl5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCA0KSwKICAgICAgICB5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCAyLCAwLCB0cnVlKSwKICAgICAgICB5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDEpLAogICAgICAgIE1NTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJyksCiAgICAgICAgTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcsIHRydWUpLAogICAgICAgIE1NOiBkYXRlR2V0dGVyKCdNb250aCcsIDIsIDEpLAogICAgICAgIE06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMSwgMSksCiAgICAgICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgICAgICBkOiBkYXRlR2V0dGVyKCdEYXRlJywgMSksCiAgICAgICAgSEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiksCiAgICAgICAgSDogZGF0ZUdldHRlcignSG91cnMnLCAxKSwKICAgICAgICBoaDogZGF0ZUdldHRlcignSG91cnMnLCAyLCAtMTIpLAogICAgICAgIGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMSwgLTEyKSwKICAgICAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgICAgIG06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAxKSwKICAgICAgICBzczogZGF0ZUdldHRlcignU2Vjb25kcycsIDIpLAogICAgICAgIHM6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAxKSwKICAgICAgICBFRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknKSwKICAgICAgICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgICAgIGE6IGFtcG1HZXR0ZXIsCiAgICAgICAgWjogdGltZVpvbmVHZXR0ZXIKICAgIH07CgogICAgdmFyIERBVEVfRk9STUFUU19TUExJVCA9IC8oKD86W155TWRIaG1zYVpFJ10rKXwoPzonKD86W14nXXwnJykqJyl8KD86RSt8eSt8TSt8ZCt8SCt8aCt8bSt8cyt8YXxaKSkoLiopLywKICAgICAgICBOVU1CRVJfU1RSSU5HID0gL15cZCskLzsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpkYXRlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgRm9ybWF0cyBgZGF0ZWAgdG8gYSBzdHJpbmcgYmFzZWQgb24gdGhlIHJlcXVlc3RlZCBgZm9ybWF0YC4KICAgICAqCiAgICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYmUgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZyBlbGVtZW50czoKICAgICAqCiAgICAgKiAgICogYCd5eXl5J2A6IDQgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciAoZS5nLiBBRCAxID0+IDAwMDEsIEFEIDIwMTAgPT4gMjAxMCkKICAgICAqICAgKiBgJ3l5J2A6IDIgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgcGFkZGVkICgwMC05OSkuIChlLmcuIEFEIDIwMDEgPT4gMDEsIEFEIDIwMTAgPT4gMTApCiAgICAgKiAgICogYCd5J2A6IDEgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgZS5nLiAoQUQgMSA9PiAxLCBBRCAxOTkgPT4gMTk5KQogICAgICogICAqIGAnTU1NTSdgOiBNb250aCBpbiB5ZWFyIChKYW51YXJ5LURlY2VtYmVyKQogICAgICogICAqIGAnTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbi1EZWMpCiAgICAgKiAgICogYCdNTSdgOiBNb250aCBpbiB5ZWFyLCBwYWRkZWQgKDAxLTEyKQogICAgICogICAqIGAnTSdgOiBNb250aCBpbiB5ZWFyICgxLTEyKQogICAgICogICAqIGAnZGQnYDogRGF5IGluIG1vbnRoLCBwYWRkZWQgKDAxLTMxKQogICAgICogICAqIGAnZCdgOiBEYXkgaW4gbW9udGggKDEtMzEpCiAgICAgKiAgICogYCdFRUVFJ2A6IERheSBpbiBXZWVrLChTdW5kYXktU2F0dXJkYXkpCiAgICAgKiAgICogYCdFRUUnYDogRGF5IGluIFdlZWssIChTdW4tU2F0KQogICAgICogICAqIGAnSEgnYDogSG91ciBpbiBkYXksIHBhZGRlZCAoMDAtMjMpCiAgICAgKiAgICogYCdIJ2A6IEhvdXIgaW4gZGF5ICgwLTIzKQogICAgICogICAqIGAnaGgnYDogSG91ciBpbiBhbS9wbSwgcGFkZGVkICgwMS0xMikKICAgICAqICAgKiBgJ2gnYDogSG91ciBpbiBhbS9wbSwgKDEtMTIpCiAgICAgKiAgICogYCdtbSdgOiBNaW51dGUgaW4gaG91ciwgcGFkZGVkICgwMC01OSkKICAgICAqICAgKiBgJ20nYDogTWludXRlIGluIGhvdXIgKDAtNTkpCiAgICAgKiAgICogYCdzcydgOiBTZWNvbmQgaW4gbWludXRlLCBwYWRkZWQgKDAwLTU5KQogICAgICogICAqIGAncydgOiBTZWNvbmQgaW4gbWludXRlICgwLTU5KQogICAgICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICAgICAqICAgKiBgJ1onYDogNCBkaWdpdCAoK3NpZ24pIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aW1lem9uZSBvZmZzZXQgKC0xMjAwLSsxMjAwKQogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICAgICAqICAge0BsaW5rIGd1aWRlL2kxOG4gbG9jYWxpemFibGUgZm9ybWF0c306CiAgICAgKgogICAgICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gU2VwIDMsIDIwMTAgMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICAgICAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQseSdgIGZvciBlbl9VUyAgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gRnJpZGF5LCBTZXB0ZW1iZXIgMywgMjAxMCkKICAgICAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMAogICAgICogICAqIGAnbWVkaXVtRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXAgMywgMjAxMCkKICAgICAqICAgKiBgJ3Nob3J0RGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5J2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiA5LzMvMTApCiAgICAgKiAgICogYCdtZWRpdW1UaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1OjA4IHBtKQogICAgICogICAqIGAnc2hvcnRUaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1IHBtKQogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBjb250YWluIGxpdGVyYWwgdmFsdWVzLiBUaGVzZSBuZWVkIHRvIGJlIHF1b3RlZCB3aXRoIHNpbmdsZSBxdW90ZXMgKGUuZy4KICAgICAqICAgYCJoICdpbiB0aGUgbW9ybmluZyciYCkuIEluIG9yZGVyIHRvIG91dHB1dCBzaW5nbGUgcXVvdGUsIHVzZSB0d28gc2luZ2xlIHF1b3RlcyBpbiBhIHNlcXVlbmNlCiAgICAgKiAgIChlLmcuIGAiaCBvJydjbG9jayJgKS4KICAgICAqCiAgICAgKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICAgICAqICAgIG51bWJlcikgb3IgdmFyaW91cyBJU08gODYwMSBkYXRldGltZSBzdHJpbmcgZm9ybWF0cyAoZS5nLiB5eXl5LU1NLWRkVEhIOm1tOnNzLlNTU1ogYW5kIGl0cwogICAgICogICAgc2hvcnRlciB2ZXJzaW9ucyBsaWtlIHl5eXktTU0tZGRUSEg6bW1aLCB5eXl5LU1NLWRkIG9yIHl5eXlNTWRkVEhIbW1zc1opLiBJZiBubyB0aW1lem9uZSBpcwogICAgICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBmb3JtYXQgRm9ybWF0dGluZyBydWxlcyAoc2VlIERlc2NyaXB0aW9uKS4gSWYgbm90IHNwZWNpZmllZCwKICAgICAqICAgIGBtZWRpdW1EYXRlYCBpcyB1c2VkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgICAge3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PGJyPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+OgogICAgIHt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTxicj4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PC9zcGFuPjoKICAgICB7eycxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTxicj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJyIpKS4KICAgICAgICAgICAgdG9NYXRjaCgvT2N0IDJcZCwgMjAxMCBcZHsxLDJ9OlxkezJ9OlxkezJ9IChBTXxQTSkvKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonIikpLgogICAgICAgICAgICB0b01hdGNoKC8yMDEwXC0xMFwtMlxkIFxkezJ9OlxkezJ9OlxkezJ9IChcLXxcKyk/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSciKSkuCiAgICAgdG9NYXRjaCgvMTBcLzJcZFwvMjAxMCBAIFxkezEsMn06XGR7Mn0oQU18UE0pLyk7CiAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgICBmdW5jdGlvbiBkYXRlRmlsdGVyKCRsb2NhbGUpIHsKCgogICAgICAgIHZhciBSX0lTTzg2MDFfU1RSID0gL14oXGR7NH0pLT8oXGRcZCktPyhcZFxkKSg/OlQoXGRcZCkoPzo6PyhcZFxkKSg/Ojo/KFxkXGQpKD86XC4oXGQrKSk/KT8pPyhafChbKy1dKShcZFxkKTo/KFxkXGQpKT8pPyQvOwoKICAgICAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIGlmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzg2MDFfU1RSKSkgewogICAgICAgICAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKSwKICAgICAgICAgICAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgICAgICAgICAgIHR6TWluID0gMDsKICAgICAgICAgICAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcihpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0hvdXJzKGludChtYXRjaFs0XSB8fCAwKSAtIHR6SG91ciwgaW50KG1hdGNoWzVdIHx8IDApIC0gdHpNaW4sIGludChtYXRjaFs2XSB8fCAwKSwgaW50KG1hdGNoWzddIHx8IDApKTsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfQoKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRlLCBmb3JtYXQpIHsKICAgICAgICAgICAgdmFyIHRleHQgPSAnJywKICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICBmbiwgbWF0Y2g7CgogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJ21lZGl1bURhdGUnOwogICAgICAgICAgICBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICAgICAgICAgICAgaWYgKE5VTUJFUl9TVFJJTkcudGVzdChkYXRlKSkgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBpbnQoZGF0ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGUgPSBqc29uU3RyaW5nVG9EYXRlKGRhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFpc0RhdGUoZGF0ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZSAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICBtYXRjaCA9IERBVEVfRk9STUFUU19TUExJVC5leGVjKGZvcm1hdCk7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgICAgICAgICAgICAgIGZvcm1hdCA9IHBhcnRzLnBvcCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdCk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yRWFjaChwYXJ0cywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgICAgICAgICAgICB0ZXh0ICs9IGZuID8gZm4oZGF0ZSwgJGxvY2FsZS5EQVRFVElNRV9GT1JNQVRTKQogICAgICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpqc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogICAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGU6CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24ganNvbkZpbHRlcigpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gdG9Kc29uKG9iamVjdCwgdHJ1ZSk7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bG93ZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29udmVydHMgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICAgICAqIEBzZWUgYW5ndWxhci5sb3dlcmNhc2UKICAgICAqLwogICAgdmFyIGxvd2VyY2FzZUZpbHRlciA9IHZhbHVlRm4obG93ZXJjYXNlKTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6dXBwZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29udmVydHMgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICAgICAqIEBzZWUgYW5ndWxhci51cHBlcmNhc2UKICAgICAqLwogICAgdmFyIHVwcGVyY2FzZUZpbHRlciA9IHZhbHVlRm4odXBwZXJjYXNlKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOmxpbWl0VG8KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIG5ldyBhcnJheSBjb250YWluaW5nIG9ubHkgYSBzcGVjaWZpZWQgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LiBUaGUgZWxlbWVudHMKICAgICAqIGFyZSB0YWtlbiBmcm9tIGVpdGhlciB0aGUgYmVnaW5uaW5nIG9yIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSwgYXMgc3BlY2lmaWVkIGJ5IHRoZQogICAgICogdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgU291cmNlIGFycmF5IHRvIGJlIGxpbWl0ZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xOdW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5LiBJZiB0aGUgYGxpbWl0YCBudW1iZXIgaXMKICAgICAqICAgICBwb3NpdGl2ZSwgYGxpbWl0YCBudW1iZXIgb2YgaXRlbXMgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzb3VyY2UgYXJyYXkgYXJlIGNvcGllZC4KICAgICAqICAgICBJZiB0aGUgbnVtYmVyIGlzIG5lZ2F0aXZlLCBgbGltaXRgIG51bWJlciAgb2YgaXRlbXMgZnJvbSB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXkgYXJlCiAgICAgKiAgICAgY29waWVkLiBUaGUgYGxpbWl0YCB3aWxsIGJlIHRyaW1tZWQgaWYgaXQgZXhjZWVkcyBgYXJyYXkubGVuZ3RoYAogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdWItYXJyYXkgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheSBoYWQgbGVzcyB0aGFuIGBsaW1pdGAKICAgICAqICAgICBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICRzY29wZS5saW1pdCA9IDM7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIExpbWl0IHt7bnVtYmVyc319IHRvOiA8aW5wdXQgdHlwZT0iaW50ZWdlciIgbmctbW9kZWw9ImxpbWl0Ij4KICAgICA8cD5PdXRwdXQ6IHt7IG51bWJlcnMgfCBsaW1pdFRvOmxpbWl0IH19PC9wPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgbGltaXQgdGhlIG51bWVyIGFycmF5IHRvIGZpcnN0IHRocmVlIGl0ZW1zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBpbnB1dFtuZy1tb2RlbD1saW1pdF0nKS52YWwoKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzEsMiwzXScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKC0zKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ251bWJlcnMgfCBsaW1pdFRvOmxpbWl0JykpLnRvRXF1YWwoJ1s3LDgsOV0nKTsKICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIG5vdCBleGNlZWQgdGhlIG1heGltdW0gc2l6ZSBvZiBpbnB1dCBhcnJheScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnbGltaXQnKS5lbnRlcigxMDApOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gbGltaXRUb0ZpbHRlcigpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFycmF5LCBsaW1pdCkgewogICAgICAgICAgICBpZiAoIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CiAgICAgICAgICAgIHZhciBvdXQgPSBbXSwKICAgICAgICAgICAgICAgIGksIG47CgogICAgICAgICAgICAvLyBjaGVjayB0aGF0IGFycmF5IGlzIGl0ZXJhYmxlCiAgICAgICAgICAgIGlmICghYXJyYXkgfHwgIShhcnJheSBpbnN0YW5jZW9mIEFycmF5KSkKICAgICAgICAgICAgICAgIHJldHVybiBvdXQ7CgogICAgICAgICAgICAvLyBpZiBhYnMobGltaXQpIGV4Y2VlZHMgbWF4aW11bSBsZW5ndGgsIHRyaW0gaXQKICAgICAgICAgICAgaWYgKGxpbWl0ID4gYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICAgIGVsc2UgaWYgKGxpbWl0IDwgLWFycmF5Lmxlbmd0aCkKICAgICAgICAgICAgICAgIGxpbWl0ID0gLWFycmF5Lmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgbiA9IGxpbWl0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaSA9IGFycmF5Lmxlbmd0aCArIGxpbWl0OwogICAgICAgICAgICAgICAgbiA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgICAgICAgIG91dC5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLmZpbHRlcjpvcmRlckJ5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE9yZGVycyBhIHNwZWNpZmllZCBgYXJyYXlgIGJ5IHRoZSBgZXhwcmVzc2lvbmAgcHJlZGljYXRlLgogICAgICoKICAgICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc29ydC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil8c3RyaW5nfEFycmF5LjwoZnVuY3Rpb24oKil8c3RyaW5nKT59IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICAgICAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICAgICAqCiAgICAgKiAgICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgIC0gYGZ1bmN0aW9uYDogR2V0dGVyIGZ1bmN0aW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBzb3J0ZWQgdXNpbmcgdGhlCiAgICAgKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAgICAgKiAgICAtIGBzdHJpbmdgOiBBbiBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIG9iamVjdCB0byBvcmRlciBieSwgc3VjaCBhcyAnbmFtZScKICAgICAqICAgICAgdG8gc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wKICAgICAqICAgICAgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgc29ydCBvcmRlciAoZm9yIGV4YW1wbGUsICtuYW1lIG9yIC1uYW1lKS4KICAgICAqICAgIC0gYEFycmF5YDogQW4gYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMuIFRoZSBmaXJzdCBwcmVkaWNhdGUgaW4gdGhlIGFycmF5CiAgICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHR3byBpdGVtcyBhcmUgZXF1aXZhbGVudCwgdGhlIG5leHQgcHJlZGljYXRlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciB0aGUgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFNvcnRlZCBjb3B5IG9mIHRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5mcmllbmRzID0KICAgICAgICAgICAgICAgW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjEyJywgYWdlOjEwfSwKICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzU1NS05ODc2JywgYWdlOjE5fSwKICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgIHtuYW1lOidBZGFtJywgcGhvbmU6JzU1NS01Njc4JywgYWdlOjM1fSwKICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NScsIGFnZToyOX1dCiAgICAgICAgICAgJHNjb3BlLnByZWRpY2F0ZSA9ICctYWdlJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPHByZT5Tb3J0aW5nIHByZWRpY2F0ZSA9IHt7cHJlZGljYXRlfX07IHJldmVyc2UgPSB7e3JldmVyc2V9fTwvcHJlPgogICAgIDxoci8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGU9JyciPnVuc29ydGVkPC9hPiBdCiAgICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICAgIDx0cj4KICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ25hbWUnOyByZXZlcnNlPWZhbHNlIj5OYW1lPC9hPgogICAgICg8YSBocmVmIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnLW5hbWUnOyByZXZlcnNlPWZhbHNlIj5ePC9hPik8L3RoPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAncGhvbmUnOyByZXZlcnNlPSFyZXZlcnNlIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ2FnZSc7IHJldmVyc2U9IXJldmVyc2UiPkFnZTwvYT48L3RoPgogICAgIDwvdHI+CiAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBvcmRlckJ5OnByZWRpY2F0ZTpyZXZlcnNlIj4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPHRkPnt7ZnJpZW5kLmFnZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBiZSByZXZlcnNlIG9yZGVyZWQgYnkgYWdlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygncHJlZGljYXRlJykpLnRvQmUoJy1hZ2UnKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5hZ2UnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzI5JywgJzIxJywgJzE5JywgJzEwJ10pOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0FkYW0nLCAnSnVsaWUnLCAnTWlrZScsICdNYXJ5JywgJ0pvaG4nXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCByZW9yZGVyIHRoZSB0YWJsZSB3aGVuIHVzZXIgc2VsZWN0cyBkaWZmZXJlbnQgcHJlZGljYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMoIk5hbWUiKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKb2huJywgJ0p1bGllJywgJ01hcnknLCAnTWlrZSddKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5hZ2UnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzEwJywgJzI5JywgJzE5JywgJzIxJ10pOwoKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiUGhvbmUiKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQucGhvbmUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJzU1NS05ODc2JywgJzU1NS04NzY1JywgJzU1NS01Njc4JywgJzU1NS00MzIxJywgJzU1NS0xMjEyJ10pOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnSnVsaWUnLCAnQWRhbScsICdNaWtlJywgJ0pvaG4nXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBvcmRlckJ5RmlsdGVyLiRpbmplY3QgPSBbJyRwYXJzZSddOwogICAgZnVuY3Rpb24gb3JkZXJCeUZpbHRlcigkcGFyc2UpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFycmF5LCBzb3J0UHJlZGljYXRlLCByZXZlcnNlT3JkZXIpIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBpZiAoIXNvcnRQcmVkaWNhdGUpIHJldHVybiBhcnJheTsKICAgICAgICAgICAgc29ydFByZWRpY2F0ZSA9IGlzQXJyYXkoc29ydFByZWRpY2F0ZSkgPyBzb3J0UHJlZGljYXRlIDogW3NvcnRQcmVkaWNhdGVdOwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gbWFwKHNvcnRQcmVkaWNhdGUsIGZ1bmN0aW9uIChwcmVkaWNhdGUpIHsKICAgICAgICAgICAgICAgIHZhciBkZXNjZW5kaW5nID0gZmFsc2UsIGdldCA9IHByZWRpY2F0ZSB8fCBpZGVudGl0eTsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY2VuZGluZyA9IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nOwogICAgICAgICAgICAgICAgICAgICAgICBwcmVkaWNhdGUgPSBwcmVkaWNhdGUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBnZXQgPSAkcGFyc2UocHJlZGljYXRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb21wYXJlKGdldChhKSwgZ2V0KGIpKTsKICAgICAgICAgICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGFycmF5Q29weSA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhcnJheUNvcHkucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgICAgICAgICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb21wICE9PSAwKSByZXR1cm4gY29tcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiByZXZlcnNlQ29tcGFyYXRvcihjb21wLCBkZXNjZW5kaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb21wKGIsIGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIDogY29tcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY29tcGFyZSh2MSwgdjIpIHsKICAgICAgICAgICAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgICAgICAgICAgIHZhciB0MiA9IHR5cGVvZiB2MjsKICAgICAgICAgICAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgICAgICAgICAgICAgIGlmICh0MSA9PSAic3RyaW5nIikgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh0MSA9PSAic3RyaW5nIikgdjIgPSB2Mi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgICAgIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6YQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICAgICAqIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICAgICAqCiAgICAgKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICAgICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Im1vZGVsLiRzYXZlKCkiPlNhdmU8L2E+YAogICAgICovCiAgICB2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKCiAgICAgICAgICAgICAgICAvLyB0dXJuIDxhIGhyZWYgbmctY2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgc3R5bGFibGUgbGluayBpbiBJRQogICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICAgICAgICAgICAgICBpZiAoIWF0dHIuaHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCdocmVmJywgJycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCBhIGNvbW1lbnQgbm9kZSB0byBhbmNob3JzIHRvIHdvcmthcm91bmQgSUUgYnVnIHRoYXQgY2F1c2VzIGVsZW1lbnQgY29udGVudCB0byBiZSByZXNldAogICAgICAgICAgICAgICAgLy8gdG8gbmV3IGF0dHJpYnV0ZSBjb250ZW50IGlmIGF0dHJpYnV0ZSBpcyB1cGRhdGVkIHdpdGggdmFsdWUgY29udGFpbmluZyBAIGFuZCBlbGVtZW50IGFsc28KICAgICAgICAgICAgICAgIC8vIGNvbnRhaW5zIHZhbHVlIHdpdGggQAogICAgICAgICAgICAgICAgLy8gc2VlIGlzc3VlICMxOTQ5CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCdJRSBmaXgnKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIG5vIGhyZWYgdXJsLCB0aGVuIGRvbid0IG5hdmlnYXRlIGFueXdoZXJlLgogICAgICAgICAgICAgICAgICAgIGlmICghZWxlbWVudC5hdHRyKCdocmVmJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSHJlZgogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2Uge3toYXNofX0gaW4gYW4gaHJlZiBhdHRyaWJ1dGUgbWFrZXMKICAgICAqIHRoZSBwYWdlIG9wZW4gdG8gYSB3cm9uZyBVUkwsIGlmIHRoZSB1c2VyIGNsaWNrcyB0aGF0IGxpbmsgYmVmb3JlCiAgICAgKiBhbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSB7e2hhc2h9fSB3aXRoIGFjdHVhbCBVUkwsIHRoZQogICAgICogbGluayB3aWxsIGJlIGJyb2tlbiBhbmQgd2lsbCBtb3N0IGxpa2VseSByZXR1cm4gYSA0MDQgZXJyb3IuCiAgICAgKiBUaGUgYG5nSHJlZmAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICAgKgogICAgICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8YSBocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8YSBuZy1ocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IEEKICAgICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nSHJlZiBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSB1c2VzIGBsaW5rYCB2YXJpYWJsZSBpbnNpZGUgYGhyZWZgIGF0dHJpYnV0ZToKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJ2YWx1ZSIgLz48YnIgLz4KICAgICA8YSBpZD0ibGluay0xIiBocmVmIG5nLWNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nLWNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICA8YSBpZD0ibGluay0zIiBuZy1ocmVmPSIve3snMTIzJ319Ij5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNiIgbmctaHJlZj0ie3t2YWx1ZX19Ij5saW5rPC9hPiAobGluaywgY2hhbmdlIGxvY2F0aW9uKQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMScpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0xJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTInKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMycpLmF0dHIoJ2hyZWYnKSkudG9CZSgiLzEyMyIpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTMnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS53aW5kb3coKS5wYXRoKCkpLnRvRXF1YWwoJy8xMjMnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcgYW5kIG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay00JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTQnKS5hdHRyKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBubyBocmVmIGJ1dCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstNScpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay01JykuYXR0cignaHJlZicpKS50b0JlKHVuZGVmaW5lZCk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgb25seSBjaGFuZ2UgdXJsIHdoZW4gb25seSBuZy1ocmVmJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignNicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTYnKS5hdHRyKCdocmVmJykpLnRvQmUoJzYnKTsKCiAgICAgICAgICBlbGVtZW50KCcjbGluay02JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS51cmwoKSkudG9FcXVhbCgnLzYnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTcmMKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogICAgICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogICAgICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAgICAgKiBge3toYXNofX1gLiBUaGUgYG5nU3JjYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8aW1nIG5nLXNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTUcKICAgICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3JjIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRGlzYWJsZWQKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBtYXJrdXAgd2lsbCBtYWtlIHRoZSBidXR0b24gZW5hYmxlZCBvbiBDaHJvbWUvRmlyZWZveCBidXQgbm90IG9uIElFOCBhbmQgb2xkZXIgSUVzOgogICAgICogPHByZT4KICAgICAqIDxkaXYgbmctaW5pdD0ic2NvcGUgPSB7IGlzRGlzYWJsZWQ6IGZhbHNlIH0iPgogICAgICogIDxidXR0b24gZGlzYWJsZWQ9Int7c2NvcGUuaXNEaXNhYmxlZH19Ij5EaXNhYmxlZDwvYnV0dG9uPgogICAgICogPC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgZGlzYWJsZWQuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ0Rpc2FibGVkYCBkaXJlY3RpdmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2xpY2sgbWUgdG8gdG9nZ2xlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIDxidXR0b24gbmctbW9kZWw9ImJ1dHRvbiIgbmctZGlzYWJsZWQ9ImNoZWNrZWQiPkJ1dHRvbjwvYnV0dG9uPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykucHJvcCgnZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICogQGVsZW1lbnQgSU5QVVQKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEaXNhYmxlZCBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoZWNrZWQKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgY2hlY2tlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nQ2hlY2tlZGAgZGlyZWN0aXZlLgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2hlY2sgbWUgdG8gY2hlY2sgYm90aDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ibWFzdGVyIj48YnIvPgogICAgIDxpbnB1dCBpZD0iY2hlY2tTbGF2ZSIgdHlwZT0iY2hlY2tib3giIG5nLWNoZWNrZWQ9Im1hc3RlciI+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBib3RoIGNoZWNrQm94ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjY2hlY2tTbGF2ZScpLnByb3AoJ2NoZWNrZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnbWFzdGVyJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjY2hlY2tTbGF2ZScpLnByb3AoJ2NoZWNrZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICogQGVsZW1lbnQgSU5QVVQKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGVja2VkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTXVsdGlwbGUKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgbXVsdGlwbGUuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ011bHRpcGxlYCBkaXJlY3RpdmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPHNlbGVjdCBpZD0ic2VsZWN0IiBuZy1tdWx0aXBsZT0iY2hlY2tlZCI+CiAgICAgPG9wdGlvbj5NaXNrbzwvb3B0aW9uPgogICAgIDxvcHRpb24+SWdvcjwvb3B0aW9uPgogICAgIDxvcHRpb24+Vm9qdGE8L29wdGlvbj4KICAgICA8b3B0aW9uPkRpPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgbXVsdGlwbGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3NlbGVjdCcpLnByb3AoJ211bHRpcGxlJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3NlbGVjdCcpLnByb3AoJ211bHRpcGxlJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBTRUxFQ1QKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNdWx0aXBsZSBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlYWRvbmx5CiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHJlYWRvbmx5LgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlLgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1yZWFkb25seT0iY2hlY2tlZCIgdmFsdWU9IkknbSBBbmd1bGFyIi8+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDp0ZXh0JykucHJvcCgncmVhZG9ubHknKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTZWxlY3RlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBzZWxlY3RlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZWQgdGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBzZWxlY3Q6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InNlbGVjdGVkIj48YnIvPgogICAgIDxzZWxlY3Q+CiAgICAgPG9wdGlvbj5IZWxsbyE8L29wdGlvbj4KICAgICA8b3B0aW9uIGlkPSJncmVldCIgbmctc2VsZWN0ZWQ9InNlbGVjdGVkIj5HcmVldGluZ3MhPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgR3JlZXRpbmdzIScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ3NlbGVjdGVkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjZ3JlZXQnKS5wcm9wKCdzZWxlY3RlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBPUFRJT04KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIHZhciBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcyA9IHt9OwoKCi8vIGJvb2xlYW4gYXR0cnMgYXJlIGV2YWx1YXRlZAogICAgZm9yRWFjaChCT09MRUFOX0FUVFIsIGZ1bmN0aW9uIChwcm9wTmFtZSwgYXR0ck5hbWUpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZCA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIGF0dHJOYW1lKTsKICAgICAgICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlc1tub3JtYWxpemVkXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltub3JtYWxpemVkXSwgZnVuY3Rpb24gbmdCb29sZWFuQXR0cldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoYXR0ck5hbWUsICEhdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCgovLyBuZy1zcmMsIG5nLWhyZWYgYXJlIGludGVycG9sYXRlZAogICAgZm9yRWFjaChbJ3NyYycsICdocmVmJ10sIGZ1bmN0aW9uIChhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJpb3JpdHk6IDk5LCAvLyBpdCBuZWVkcyB0byBydW4gYWZ0ZXIgdGhlIGF0dHJpYnV0ZXMgYXJlIGludGVycG9sYXRlZAogICAgICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZShub3JtYWxpemVkLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGNhbGxpbmcgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdmb28nKSBkb2Vzbid0IGRvIGFueXRoaW5nLCBzbyB3ZSBuZWVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHNldCB0aGUgcHJvcGVydHkgYXMgd2VsbCB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIGVmZmVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtc2llKSBlbGVtZW50LnByb3AoYXR0ck5hbWUsIGF0dHJbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgogICAgdmFyIG51bGxGb3JtQ3RybCA9IHsKICAgICAgICAkYWRkQ29udHJvbDogbm9vcCwKICAgICAgICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAgICAgICAkc2V0VmFsaWRpdHk6IG5vb3AsCiAgICAgICAgJHNldERpcnR5OiBub29wCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICAgKiAgZm9ybXMsIHdoZXJlOgogICAgICoKICAgICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcykg4oCUIHN1Y2ggYXMgYHJlcXVpcmVkYCwgYHVybGAgb3IgYGVtYWlsYCksCiAgICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIHdpdGggZ2l2ZW4gZXJyb3IuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHN0YXRlIG9mIHRoZW0sCiAgICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICAgKgogICAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICAgKgogICAgICovCi8vYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICBGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJ107CiAgICBmdW5jdGlvbiBGb3JtQ29udHJvbGxlcihlbGVtZW50LCBhdHRycykgewogICAgICAgIHZhciBmb3JtID0gdGhpcywKICAgICAgICAgICAgcGFyZW50Rm9ybSA9IGVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICAgICAgICBlcnJvcnMgPSBmb3JtLiRlcnJvciA9IHt9OwoKICAgICAgICAvLyBpbml0IHN0YXRlCiAgICAgICAgZm9ybS4kbmFtZSA9IGF0dHJzLm5hbWU7CiAgICAgICAgZm9ybS4kZGlydHkgPSBmYWxzZTsKICAgICAgICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgZm9ybS4kdmFsaWQgPSB0cnVlOwogICAgICAgIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKCiAgICAgICAgcGFyZW50Rm9ybS4kYWRkQ29udHJvbChmb3JtKTsKCiAgICAgICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpOwogICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgIGZ1bmN0aW9uIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSkgewogICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgICAgICAgICBlbGVtZW50LgogICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoKGlzVmFsaWQgPyBJTlZBTElEX0NMQVNTIDogVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KS4KICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgfQoKICAgICAgICBmb3JtLiRhZGRDb250cm9sID0gZnVuY3Rpb24gKGNvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgIWZvcm0uaGFzT3duUHJvcGVydHkoY29udHJvbC4kbmFtZSkpIHsKICAgICAgICAgICAgICAgIGZvcm1bY29udHJvbC4kbmFtZV0gPSBjb250cm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9ybS4kcmVtb3ZlQ29udHJvbCA9IGZ1bmN0aW9uIChjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbiAocXVldWUsIHZhbGlkYXRpb25Ub2tlbikgewogICAgICAgICAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBjb250cm9sKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvblRva2VuLCBpc1ZhbGlkLCBjb250cm9sKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dOwoKICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHF1ZXVlLCBjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQtLTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgdHJ1ZSwgZm9ybSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocXVldWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXMocXVldWUsIGNvbnRyb2wpKSByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dID0gcXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIGZhbHNlLCBmb3JtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goY29udHJvbCk7CgogICAgICAgICAgICAgICAgZm9ybS4kdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGZvcm0uJGludmFsaWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH07CgogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0KICAgICAqIEByZXN0cmljdCBFQUMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogICAgICogZG9lcyBub3QgYWxsb3cgbmVzdGluZyBvZiBmb3JtIGVsZW1lbnRzLiBJdCBpcyB1c2VmdWwgdG8gbmVzdCBmb3JtcywgZm9yIGV4YW1wbGUgaWYgdGhlIHZhbGlkaXR5IG9mIGEKICAgICAqIHN1Yi1ncm91cCBvZiBjb250cm9scyBuZWVkcyB0byBiZSBkZXRlcm1pbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZXxuZ0Zvcm0gTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgICAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAgICAgKgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERpcmVjdGl2ZSB0aGF0IGluc3RhbnRpYXRlcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgICAqCiAgICAgKiBJZiBgbmFtZWAgYXR0cmlidXRlIGlzIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciBpcyBwdWJsaXNoZWQgb250byB0aGUgY3VycmVudCBzY29wZSB1bmRlcgogICAgICogdGhpcyBuYW1lLgogICAgICoKICAgICAqICMgQWxpYXM6IHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfQogICAgICoKICAgICAqIEluIGFuZ3VsYXIgZm9ybXMgY2FuIGJlIG5lc3RlZC4gVGhpcyBtZWFucyB0aGF0IHRoZSBvdXRlciBmb3JtIGlzIHZhbGlkIHdoZW4gYWxsIG9mIHRoZSBjaGlsZAogICAgICogZm9ybXMgYXJlIHZhbGlkIGFzIHdlbGwuIEhvd2V2ZXIgYnJvd3NlcnMgZG8gbm90IGFsbG93IG5lc3Rpbmcgb2YgYDxmb3JtPmAgZWxlbWVudHMsIGZvciB0aGlzCiAgICAgKiByZWFzb24gYW5ndWxhciBwcm92aWRlcyB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gYWxpYXMKICAgICAqIHdoaWNoIGJlaGF2ZXMgaWRlbnRpY2FsIHRvIGA8Zm9ybT5gIGJ1dCBhbGxvd3MgZm9ybSBuZXN0aW5nLgogICAgICoKICAgICAqCiAgICAgKiAjIENTUyBjbGFzc2VzCiAgICAgKiAgLSBgbmctdmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyB2YWxpZC4KICAgICAqICAtIGBuZy1pbnZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgICAqICAtIGBuZy1wcmlzdGluZWAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHByaXN0aW5lLgogICAgICogIC0gYG5nLWRpcnR5YCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgZGlydHkuCiAgICAgKgogICAgICoKICAgICAqICMgU3VibWl0dGluZyBhIGZvcm0gYW5kIHByZXZlbnRpbmcgZGVmYXVsdCBhY3Rpb24KICAgICAqCiAgICAgKiBTaW5jZSB0aGUgcm9sZSBvZiBmb3JtcyBpbiBjbGllbnQtc2lkZSBBbmd1bGFyIGFwcGxpY2F0aW9ucyBpcyBkaWZmZXJlbnQgdGhhbiBpbiBjbGFzc2ljYWwKICAgICAqIHJvdW5kdHJpcCBhcHBzLCBpdCBpcyBkZXNpcmFibGUgZm9yIHRoZSBicm93c2VyIG5vdCB0byB0cmFuc2xhdGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbnRvIGEgZnVsbAogICAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICAgKiB0byBoYW5kbGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbiBhcHBsaWNhdGlvbiBzcGVjaWZpYyB3YXkuCiAgICAgKgogICAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgICAqIGA8Zm9ybT5gIGVsZW1lbnQgaGFzIGFuIGBhY3Rpb25gIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAgICogYSBmb3JtIGlzIHN1Ym1pdHRlZDoKICAgICAqCiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmUgb24gdGhlIGZpcnN0CiAgICAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAgICAgKgogICAgICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgbmdTdWJtaXQgb3IgbmdDbGljayBkaXJlY3RpdmVzLiBUaGlzCiAgICAgKiBpcyBiZWNhdXNlIG9mIHRoZSBmb2xsb3dpbmcgZm9ybSBzdWJtaXNzaW9uIHJ1bGVzIGNvbWluZyBmcm9tIHRoZSBodG1sIHNwZWM6CiAgICAgKgogICAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICAgKiAoYG5nU3VibWl0YCkKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBoYXMgMisgaW5wdXQgZmllbGRzIGFuZCBubyBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuIGhpdHRpbmcgZW50ZXIKICAgICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgICAqIC0gaWYgYSBmb3JtIGhhcyBvbmUgb3IgbW9yZSBpbnB1dCBmaWVsZHMgYW5kIG9uZSBvciBtb3JlIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4KICAgICAqIGhpdHRpbmcgZW50ZXIgaW4gYW55IG9mIHRoZSBpbnB1dCBmaWVsZHMgd2lsbCB0cmlnZ2VyIHRoZSBjbGljayBoYW5kbGVyIG9uIHRoZSAqZmlyc3QqIGJ1dHRvbiBvcgogICAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnVzZXJUeXBlID0gJ2d1ZXN0JzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgPHR0PnVzZXJUeXBlID0ge3t1c2VyVHlwZX19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPC9mb3JtPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ3VzZXJUeXBlJykuZW50ZXIoJycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndXNlclR5cGUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGZvcm1EaXJlY3RpdmVGYWN0b3J5ID0gZnVuY3Rpb24gKGlzTmdGb3JtKSB7CiAgICAgICAgcmV0dXJuIFsnJHRpbWVvdXQnLCBmdW5jdGlvbiAoJHRpbWVvdXQpIHsKICAgICAgICAgICAgdmFyIGZvcm1EaXJlY3RpdmUgPSB7CiAgICAgICAgICAgICAgICBuYW1lOiAnZm9ybScsCiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogRm9ybUNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGZvcm1FbGVtZW50LCBhdHRyLCBjb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHIuYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgdXNlIGpxIGV2ZW50cyBiZWNhdXNlIGlmIGEgZm9ybSBpcyBkZXN0cm95ZWQgZHVyaW5nIHN1Ym1pc3Npb24gdGhlIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhY3Rpb24gaXMgbm90IHByZXZlbnRlZC4gc2VlICMxMjM4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJRSA5IGlzIG5vdCBhZmZlY3RlZCBiZWNhdXNlIGl0IGRvZXNuJ3QgZmlyZSBhIHN1Ym1pdCBldmVudCBhbmQgdHJ5IHRvIGRvIGEgZnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhZ2UgcmVsb2FkIGlmIHRoZSBmb3JtIHdhcyBkZXN0cm95ZWQgYnkgc3VibWlzc2lvbiBvZiB0aGUgZm9ybSB2aWEgYSBjbGljayBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gYSBidXR0b24gaW4gdGhlIGZvcm0uIExvb2tzIGxpa2UgYW4gSUU5IHNwZWNpZmljIGJ1Zy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHRMaXN0ZW5lciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vIElFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIgdGhlIHByZXZlbnREZWZhdWx0IGxpc3RlbmVyIHNvIHRoYXQgd2UgZG9uJ3Qgbm90IGxlYWsgbWVtb3J5IGJ1dCBpbiBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2F5IHRoYXQgd2lsbCBhY2hpZXZlIHRoZSBwcmV2ZW50aW9uIG9mIHRoZSBkZWZhdWx0IGFjdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Rm9ybUN0cmwgPSBmb3JtRWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpYXMgPSBhdHRyLm5hbWUgfHwgYXR0ci5uZ0Zvcm07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbYWxpYXNdID0gY29udHJvbGxlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRGb3JtQ3RybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXIsIG51bGxGb3JtQ3RybCk7IC8vc3RvcCBwcm9wYWdhdGluZyBjaGlsZCBkZXN0cnVjdGlvbiBoYW5kbGVycyB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGlzTmdGb3JtID8gZXh0ZW5kKGNvcHkoZm9ybURpcmVjdGl2ZSksIHtyZXN0cmljdDogJ0VBQyd9KSA6IGZvcm1EaXJlY3RpdmU7CiAgICAgICAgfV07CiAgICB9OwoKICAgIHZhciBmb3JtRGlyZWN0aXZlID0gZm9ybURpcmVjdGl2ZUZhY3RvcnkoKTsKICAgIHZhciBuZ0Zvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSh0cnVlKTsKCiAgICB2YXIgVVJMX1JFR0VYUCA9IC9eKGZ0cHxodHRwfGh0dHBzKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcUyspKDpbMC05XSspPyhcL3xcLyhbXHcjITouPys9JiVAIVwtXC9dKSk/JC87CiAgICB2YXIgRU1BSUxfUkVHRVhQID0gL15bQS1aYS16MC05Ll8lKy1dK0BbQS1aYS16MC05Li1dK1wuW0EtWmEtel17Miw0fSQvOwogICAgdmFyIE5VTUJFUl9SRUdFWFAgPSAvXlxzKihcLXxcKyk/KFxkK3woXGQqKFwuXGQqKSkpXHMqJC87CgogICAgdmFyIGlucHV0VHlwZSA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC50ZXh0CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTdGFuZGFyZCBIVE1MIHRleHQgaW5wdXQgd2l0aCBhbmd1bGFyIGRhdGEgYmluZGluZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdndWVzdCc7CiAgICAgICAgICAgICAkc2NvcGUud29yZCA9IC9eXHcqJC87CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgICAgIG5nLXBhdHRlcm49IndvcmQiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5wYXR0ZXJuIj4KICAgICAgICAgU2luZ2xlIHdvcmQgb25seSE8L3NwYW4+CgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbXVsdGkgd29yZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdoZWxsbyB3b3JsZCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd0ZXh0JzogdGV4dElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQubnVtYmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggbnVtYmVyIHZhbGlkYXRpb24gYW5kIHRyYW5zZm9ybWF0aW9uLiBTZXRzIHRoZSBgbnVtYmVyYCB2YWxpZGF0aW9uCiAgICAgICAgICogZXJyb3IgaWYgbm90IGEgdmFsaWQgbnVtYmVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtYXggU2V0cyB0aGUgYG1heGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgZ3JlYXRlciB0aGFuIGBtYXhgLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbHVlID0gMTI7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgTnVtYmVyOiA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgICAgICBtaW49IjAiIG1heD0iOTkiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5saXN0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGlzdC4kZXJyb3IubnVtYmVyIj4KICAgICAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgICAgIDx0dD52YWx1ZSA9IHt7dmFsdWV9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJzEyJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcxMjMnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnbnVtYmVyJzogbnVtYmVySW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC51cmwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgICAgICAgKiB2YWxpZCBVUkwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaHR0cDovL2dvb2dsZS5jb20nOwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnaHR0cDovL2dvb2dsZS5jb20nKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndXJsJzogdXJsSW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5lbWFpbAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgICAgICAgKiBhZGRyZXNzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdtZUBleGFtcGxlLmNvbSc7CiAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIEVtYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmVtYWlsIj4KICAgICAgICAgTm90IHZhbGlkIGVtYWlsITwvc3Bhbj4KICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5lbWFpbCA9IHt7ISFteUZvcm0uJGVycm9yLmVtYWlsfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnbWVAZXhhbXBsZS5jb20nKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgZW1haWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcigneHh4Jyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2VtYWlsJzogZW1haWxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBIVE1MIHJhZGlvIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUuY29sb3IgPSAnYmx1ZSc7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJyZWQiPiAgUmVkIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iZ3JlZW4iPiBHcmVlbiA8YnIvPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9ImJsdWUiPiBCbHVlIDxici8+CiAgICAgICAgIDx0dD5jb2xvciA9IHt7Y29sb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdibHVlJyk7CgogICAgICAgICAgICBpbnB1dCgnY29sb3InKS5zZWxlY3QoJ3JlZCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9FcXVhbCgncmVkJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ3JhZGlvJzogcmFkaW9JbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBIVE1MIGNoZWNrYm94LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nVHJ1ZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0ZhbHNlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBub3Qgc2VsZWN0ZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUxID0gdHJ1ZTsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTIgPSAnWUVTJwogICAgICAgICAgIH0KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgIFZhbHVlMTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUxIj4gPGJyLz4KICAgICAgICAgVmFsdWUyOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTIiCiAgICAgICAgIG5nLXRydWUtdmFsdWU9IllFUyIgbmctZmFsc2UtdmFsdWU9Ik5PIj4gPGJyLz4KICAgICAgICAgPHR0PnZhbHVlMSA9IHt7dmFsdWUxfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD52YWx1ZTIgPSB7e3ZhbHVlMn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTInKSkudG9FcXVhbCgnWUVTJyk7CgogICAgICAgICAgICBpbnB1dCgndmFsdWUxJykuY2hlY2soKTsKICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlMicpLmNoZWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTEnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdOTycpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAgICAgICAnaGlkZGVuJzogbm9vcCwKICAgICAgICAnYnV0dG9uJzogbm9vcCwKICAgICAgICAnc3VibWl0Jzogbm9vcCwKICAgICAgICAncmVzZXQnOiBub29wCiAgICB9OwoKCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogICAgfQoKCiAgICBmdW5jdGlvbiB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKCiAgICAgICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0cmltKGVsZW1lbnQudmFsKCkpOwoKICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAgICAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnaW5wdXQnLCBsaXN0ZW5lcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRpbWVvdXQ7CgogICAgICAgICAgICB2YXIgZGVmZXJMaXN0ZW5lciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdrZXlkb3duJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgICAgICAgICAgICAvLyBpZ25vcmUKICAgICAgICAgICAgICAgIC8vICAgIGNvbW1hbmQgICAgICAgICAgICBtb2RpZmllcnMgICAgICAgICAgICAgICAgICAgYXJyb3dzCiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGRlZmVyTGlzdGVuZXIoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2UsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogICAgICAgICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJ3Bhc3RlIGN1dCcsIGRlZmVyTGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50LnZhbChpc0VtcHR5KGN0cmwuJHZpZXdWYWx1ZSkgPyAnJyA6IGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gcGF0dGVybiB2YWxpZGF0b3IKICAgICAgICB2YXIgcGF0dGVybiA9IGF0dHIubmdQYXR0ZXJuLAogICAgICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yOwoKICAgICAgICB2YXIgdmFsaWRhdGUgPSBmdW5jdGlvbiAocmVnZXhwLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgcmVnZXhwLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3BhdHRlcm4nLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgaWYgKHBhdHRlcm4pIHsKICAgICAgICAgICAgaWYgKHBhdHRlcm4ubWF0Y2goL15cLyguKilcLyQvKSkgewogICAgICAgICAgICAgICAgcGF0dGVybiA9IG5ldyBSZWdFeHAocGF0dGVybi5zdWJzdHIoMSwgcGF0dGVybi5sZW5ndGggLSAyKSk7CiAgICAgICAgICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm4sIHZhbHVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGF0dGVybk9iaiA9IHNjb3BlLiRldmFsKHBhdHRlcm4pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBhdHRlcm5PYmogfHwgIXBhdHRlcm5PYmoudGVzdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4cGVjdGVkICcgKyBwYXR0ZXJuICsgJyB0byBiZSBhIFJlZ0V4cCBidXQgd2FzICcgKyBwYXR0ZXJuT2JqKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm5PYmosIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChwYXR0ZXJuVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gbWluIGxlbmd0aCB2YWxpZGF0b3IKICAgICAgICBpZiAoYXR0ci5uZ01pbmxlbmd0aCkgewogICAgICAgICAgICB2YXIgbWlubGVuZ3RoID0gaW50KGF0dHIubmdNaW5sZW5ndGgpOwogICAgICAgICAgICB2YXIgbWluTGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA8IG1pbmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW5sZW5ndGgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbmxlbmd0aCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIC8vIG1heCBsZW5ndGggdmFsaWRhdG9yCiAgICAgICAgaWYgKGF0dHIubmdNYXhsZW5ndGgpIHsKICAgICAgICAgICAgdmFyIG1heGxlbmd0aCA9IGludChhdHRyLm5nTWF4bGVuZ3RoKTsKICAgICAgICAgICAgdmFyIG1heExlbmd0aFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPiBtYXhsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4bGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICB2YXIgZW1wdHkgPSBpc0VtcHR5KHZhbHVlKTsKICAgICAgICAgICAgaWYgKGVtcHR5IHx8IE5VTUJFUl9SRUdFWFAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gJycgPyBudWxsIDogKGVtcHR5ID8gdmFsdWUgOiBwYXJzZUZsb2F0KHZhbHVlKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBpc0VtcHR5KHZhbHVlKSA/ICcnIDogJycgKyB2YWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGF0dHIubWluKSB7CiAgICAgICAgICAgIHZhciBtaW4gPSBwYXJzZUZsb2F0KGF0dHIubWluKTsKICAgICAgICAgICAgdmFyIG1pblZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA8IG1pbikgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW4nLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChhdHRyLm1heCkgewogICAgICAgICAgICB2YXIgbWF4ID0gcGFyc2VGbG9hdChhdHRyLm1heCk7CiAgICAgICAgICAgIHZhciBtYXhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUgPiBtYXgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4JywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgaXNOdW1iZXIodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHVybElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgdmFyIHVybFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgVVJMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3VybCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbWFpbElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICAgICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICAgICAgdmFyIGVtYWlsVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBFTUFJTF9SRUdFWFAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdlbWFpbCcsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChlbWFpbFZhbGlkYXRvcik7CiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgIH0KCiAgICBmdW5jdGlvbiByYWRpb0lucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgIC8vIG1ha2UgdGhlIG5hbWUgdW5pcXVlLCBpZiBub3QgZGVmaW5lZAogICAgICAgIGlmIChpc1VuZGVmaW5lZChhdHRyLm5hbWUpKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYXR0cignbmFtZScsIG5leHRVaWQoKSk7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoZWxlbWVudFswXS5jaGVja2VkKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gYXR0ci52YWx1ZTsKICAgICAgICAgICAgZWxlbWVudFswXS5jaGVja2VkID0gKHZhbHVlID09IGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgndmFsdWUnLCBjdHJsLiRyZW5kZXIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrYm94SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgdmFyIHRydWVWYWx1ZSA9IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgICAgICAgIGZhbHNlVmFsdWUgPSBhdHRyLm5nRmFsc2VWYWx1ZTsKCiAgICAgICAgaWYgKCFpc1N0cmluZyh0cnVlVmFsdWUpKSB0cnVlVmFsdWUgPSB0cnVlOwogICAgICAgIGlmICghaXNTdHJpbmcoZmFsc2VWYWx1ZSkpIGZhbHNlVmFsdWUgPSBmYWxzZTsKCiAgICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IHRydWVWYWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgICAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAgICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS51c2VyTmFtZS4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgICAgbmctbWlubGVuZ3RoPSIzIiBuZy1tYXhsZW5ndGg9IjEwIj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5tYXhsZW5ndGgiPgogICAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgICAgPC9mb3JtPgogICAgIDxocj4KICAgICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiRlcnJvciA9IHt7bXlGb3JtLnVzZXJOYW1lLiRlcnJvcn19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5tYXhsZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5tYXhsZW5ndGh9fTwvdHQ+PGJyPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eSB3aGVuIHJlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5uYW1lJykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSB2YWxpZCBpZiBlbXB0eSB3aGVuIG1pbiBsZW5ndGggaXMgc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJycpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoiIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3h4Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWlubGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpCiAgICAgICAgICAgIC50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSkudG9NYXRjaCgvbWF4bGVuZ3RoLyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBpbnB1dERpcmVjdGl2ZSA9IFsnJGJyb3dzZXInLCAnJHNuaWZmZXInLCBmdW5jdGlvbiAoJGJyb3dzZXIsICRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICBpZiAoY3RybCkgewogICAgICAgICAgICAgICAgICAgIChpbnB1dFR5cGVbbG93ZXJjYXNlKGF0dHIudHlwZSldIHx8IGlucHV0VHlwZS50ZXh0KShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICRicm93c2VyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICB2YXIgVkFMSURfQ0xBU1MgPSAnbmctdmFsaWQnLAogICAgICAgIElOVkFMSURfQ0xBU1MgPSAnbmctaW52YWxpZCcsCiAgICAgICAgUFJJU1RJTkVfQ0xBU1MgPSAnbmctcHJpc3RpbmUnLAogICAgICAgIERJUlRZX0NMQVNTID0gJ25nLWRpcnR5JzsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgKgogICAgICogQHByb3BlcnR5IHtzdHJpbmd9ICR2aWV3VmFsdWUgQWN0dWFsIHN0cmluZyB2YWx1ZSBpbiB0aGUgdmlldy4KICAgICAqIEBwcm9wZXJ0eSB7Kn0gJG1vZGVsVmFsdWUgVGhlIHZhbHVlIGluIHRoZSBtb2RlbCwgdGhhdCB0aGUgY29udHJvbCBpcyBib3VuZCB0by4KICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJHBhcnNlcnMgV2hlbmV2ZXIgdGhlIGNvbnRyb2wgcmVhZHMgdmFsdWUgZnJvbSB0aGUgRE9NLCBpdCBleGVjdXRlcwogICAgICogICAgIGFsbCBvZiB0aGVzZSBmdW5jdGlvbnMgdG8gc2FuaXRpemUgLyBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRlLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJGZvcm1hdHRlcnMgV2hlbmV2ZXIgdGhlIG1vZGVsIHZhbHVlIGNoYW5nZXMsIGl0IGV4ZWN1dGVzIGFsbCBvZgogICAgICogICAgIHRoZXNlIGZ1bmN0aW9ucyB0byBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRlLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSAkZXJyb3IgQW4gYmplY3QgaGFzaCB3aXRoIGFsbCBlcnJvcnMgYXMga2V5cy4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgdGhlcmUgaXMgbm8gZXJyb3IuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgQVBJIGZvciB0aGUgYG5nLW1vZGVsYCBkaXJlY3RpdmUuIFRoZSBjb250cm9sbGVyIGNvbnRhaW5zCiAgICAgKiBzZXJ2aWNlcyBmb3IgZGF0YS1iaW5kaW5nLCB2YWxpZGF0aW9uLCBDU1MgdXBkYXRlLCB2YWx1ZSBmb3JtYXR0aW5nIGFuZCBwYXJzaW5nLiBJdAogICAgICogc3BlY2lmaWNhbGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICAgICAqIERPTSBldmVudHMuIFRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIGlzIG1lYW50IHRvIGJlIGV4dGVuZGVkIGJ5IG90aGVyIGRpcmVjdGl2ZXMgd2hlcmUsIHRoZQogICAgICogZGlyZWN0aXZlIHByb3ZpZGVzIERPTSBtYW5pcHVsYXRpb24gYW5kIHRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIHByb3ZpZGVzIHRoZSBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCB3aXRoIGEgY3VzdG9tIGNvbnRyb2wgdG8gYWNoaWV2ZQogICAgICogZGF0YS1iaW5kaW5nLiBOb3RpY2UgaG93IGRpZmZlcmVudCBkaXJlY3RpdmVzIChgY29udGVudGVkaXRhYmxlYCwgYG5nLW1vZGVsYCwgYW5kIGByZXF1aXJlZGApCiAgICAgKiBjb2xsYWJvcmF0ZSB0b2dldGhlciB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIHJlc3VsdC4KICAgICAqCiAgICAgKiA8ZXhhbXBsZSBtb2R1bGU9ImN1c3RvbUNvbnRyb2wiPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgW2NvbnRlbnRlZGl0YWJsZV0gewogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIG1pbi1oZWlnaHQ6IDIwcHg7CiAgICAgIH0KCiAgICAgLm5nLWludmFsaWQgewogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJlZDsKICAgICAgfQoKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnY3VzdG9tQ29udHJvbCcsIFtdKS4KICAgICBkaXJlY3RpdmUoJ2NvbnRlbnRlZGl0YWJsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJywgLy8gb25seSBhY3RpdmF0ZSBvbiBlbGVtZW50IGF0dHJpYnV0ZQogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLCAvLyBnZXQgYSBob2xkIG9mIE5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgbmdNb2RlbCkgewogICAgICAgICAgICAgIGlmKCFuZ01vZGVsKSByZXR1cm47IC8vIGRvIG5vdGhpbmcgaWYgbm8gbmctbW9kZWwKCiAgICAgICAgICAgICAgLy8gU3BlY2lmeSBob3cgVUkgc2hvdWxkIGJlIHVwZGF0ZWQKICAgICAgICAgICAgICBuZ01vZGVsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbChuZ01vZGVsLiR2aWV3VmFsdWUgfHwgJycpOwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlIGV2ZW50cyB0byBlbmFibGUgYmluZGluZwogICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnYmx1ciBrZXl1cCBjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShyZWFkKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZWFkKCk7IC8vIGluaXRpYWxpemUKCiAgICAgICAgICAgICAgLy8gV3JpdGUgZGF0YSB0byB0aGUgbW9kZWwKICAgICAgICAgICAgICBmdW5jdGlvbiByZWFkKCkgewogICAgICAgICAgICAgICAgbmdNb2RlbC4kc2V0Vmlld1ZhbHVlKGVsZW1lbnQuaHRtbCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgICAgPGhyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idXNlckNvbnRlbnQiPjwvdGV4dGFyZWE+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNvbnRlbnRFZGl0YWJsZSA9IGVsZW1lbnQoJ1tjb250ZW50ZWRpdGFibGVdJyk7CgogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCdDaGFuZ2UgbWUhJyk7CiAgICAgICAgaW5wdXQoJ3VzZXJDb250ZW50JykuZW50ZXIoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICAqIDwvZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBOZ01vZGVsQ29udHJvbGxlciA9IFsnJHNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRhdHRycycsICckZWxlbWVudCcsICckcGFyc2UnLAogICAgICAgIGZ1bmN0aW9uICgkc2NvcGUsICRleGNlcHRpb25IYW5kbGVyLCAkYXR0ciwgJGVsZW1lbnQsICRwYXJzZSkgewogICAgICAgICAgICB0aGlzLiR2aWV3VmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRtb2RlbFZhbHVlID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy4kcGFyc2VycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRmb3JtYXR0ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy4kbmFtZSA9ICRhdHRyLm5hbWU7CgogICAgICAgICAgICB2YXIgbmdNb2RlbEdldCA9ICRwYXJzZSgkYXR0ci5uZ01vZGVsKSwKICAgICAgICAgICAgICAgIG5nTW9kZWxTZXQgPSBuZ01vZGVsR2V0LmFzc2lnbjsKCiAgICAgICAgICAgIGlmICghbmdNb2RlbFNldCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiArICRhdHRyLm5nTW9kZWwgKwogICAgICAgICAgICAgICAgICAgICcgKCcgKyBzdGFydGluZ1RhZygkZWxlbWVudCkgKyAnKScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRyZW5kZXIKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBDYWxsZWQgd2hlbiB0aGUgdmlldyBuZWVkcyB0byBiZSB1cGRhdGVkLiBJdCBpcyBleHBlY3RlZCB0aGF0IHRoZSB1c2VyIG9mIHRoZSBuZy1tb2RlbAogICAgICAgICAgICAgKiBkaXJlY3RpdmUgd2lsbCBpbXBsZW1lbnQgdGhpcyBtZXRob2QuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLiRyZW5kZXIgPSBub29wOwoKICAgICAgICAgICAgdmFyIHBhcmVudEZvcm0gPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckZm9ybUNvbnRyb2xsZXInKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgICAgICAkZXJyb3IgPSB0aGlzLiRlcnJvciA9IHt9OyAvLyBrZWVwIGludmFsaWQga2V5cyBoZXJlCgoKICAgICAgICAgICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAgICAgICAgICAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICAgICAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgICAgICAgICAgICAgJGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoKGlzVmFsaWQgPyBJTlZBTElEX0NMQVNTIDogVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KS4KICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcygoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENoYW5nZSB0aGUgdmFsaWRpdHkgc3RhdGUsIGFuZCBub3RpZmllcyB0aGUgZm9ybSB3aGVuIHRoZSBjb250cm9sIGNoYW5nZXMgdmFsaWRpdHkuIChpLmUuIGl0CiAgICAgICAgICAgICAqIGRvZXMgbm90IG5vdGlmeSBmb3JtIGlmIGdpdmVuIHZhbGlkYXRvciBpcyBhbHJlYWR5IG1hcmtlZCBhcyBpbnZhbGlkKS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBieSB2YWxpZGF0b3JzIC0gaS5lLiB0aGUgcGFyc2VyIG9yIGZvcm1hdHRlciBmdW5jdGlvbnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWxpZGF0aW9uRXJyb3JLZXkgTmFtZSBvZiB0aGUgdmFsaWRhdG9yLiB0aGUgYHZhbGlkYXRpb25FcnJvcktleWAgd2lsbCBhc3NpZ24KICAgICAgICAgICAgICogICAgICAgIHRvIGAkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XT1pc1ZhbGlkYCBzbyB0aGF0IGl0IGlzIGF2YWlsYWJsZSBmb3IgZGF0YS1iaW5kaW5nLgogICAgICAgICAgICAgKiAgICAgICAgVGhlIGB2YWxpZGF0aW9uRXJyb3JLZXlgIHNob3VsZCBiZSBpbiBjYW1lbENhc2UgYW5kIHdpbGwgZ2V0IGNvbnZlcnRlZCBpbnRvIGRhc2gtY2FzZQogICAgICAgICAgICAgKiAgICAgICAgZm9yIGNsYXNzIG5hbWUuIEV4YW1wbGU6IGBteUVycm9yYCB3aWxsIHJlc3VsdCBpbiBgbmctdmFsaWQtbXktZXJyb3JgIGFuZCBgbmctaW52YWxpZC1teS1lcnJvcmAKICAgICAgICAgICAgICogICAgICAgIGNsYXNzIGFuZCBjYW4gYmUgYm91bmQgdG8gYXMgIGB7e3NvbWVGb3JtLnNvbWVDb250cm9sLiRlcnJvci5teUVycm9yfX1gIC4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc1ZhbGlkIFdoZXRoZXIgdGhlIGN1cnJlbnQgc3RhdGUgaXMgdmFsaWQgKHRydWUpIG9yIGludmFsaWQgKGZhbHNlKS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24gKHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID09PSAhaXNWYWxpZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldKSBpbnZhbGlkQ291bnQtLTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQrKzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSA9ICFpc1ZhbGlkOwogICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KTsKCiAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQsIHRoaXMpOwogICAgICAgICAgICB9OwoKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFJlYWQgYSB2YWx1ZSBmcm9tIHZpZXcuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgZnJvbSB3aXRoaW4gYSBET00gZXZlbnQgaGFuZGxlci4KICAgICAgICAgICAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gb3IKICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fSBkaXJlY3RpdmVzIGNhbGwgaXQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0IGludGVybmFsbHkgY2FsbHMgYWxsIGBwYXJzZXJzYCBhbmQgaWYgcmVzdWx0ZWQgdmFsdWUgaXMgdmFsaWQsIHVwZGF0ZXMgdGhlIG1vZGVsIGFuZAogICAgICAgICAgICAgKiBjYWxscyBhbGwgcmVnaXN0ZXJlZCBjaGFuZ2UgbGlzdGVuZXJzLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVmFsdWUgZnJvbSB0aGUgdmlldy4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy4kdmlld1ZhbHVlID0gdmFsdWU7CgogICAgICAgICAgICAgICAgLy8gY2hhbmdlIHRvIGRpcnR5CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kcHJpc3RpbmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kcHJpc3RpbmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoRElSVFlfQ0xBU1MpOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yRWFjaCh0aGlzLiRwYXJzZXJzLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsU2V0KCRzY29wZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBtb2RlbCAtPiB2YWx1ZQogICAgICAgICAgICB2YXIgY3RybCA9IHRoaXM7CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nTW9kZWxXYXRjaCgpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5nTW9kZWxHZXQoJHNjb3BlKTsKCiAgICAgICAgICAgICAgICAvLyBpZiBzY29wZSBtb2RlbCB2YWx1ZSBhbmQgbmdNb2RlbCB2YWx1ZSBhcmUgb3V0IG9mIHN5bmMKICAgICAgICAgICAgICAgIGlmIChjdHJsLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgZm9ybWF0dGVycyA9IGN0cmwuJGZvcm1hdHRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIGlkeCA9IGZvcm1hdHRlcnMubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICBjdHJsLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGlkeC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm9ybWF0dGVyc1tpZHhdKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH1dOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElzIGRpcmVjdGl2ZSB0aGF0IHRlbGxzIEFuZ3VsYXIgdG8gZG8gdHdvLXdheSBkYXRhIGJpbmRpbmcuIEl0IHdvcmtzIHRvZ2V0aGVyIHdpdGggYGlucHV0YCwKICAgICAqIGBzZWxlY3RgLCBgdGV4dGFyZWFgLiBZb3UgY2FuIGVhc2lseSB3cml0ZSB5b3VyIG93biBkaXJlY3RpdmVzIHRvIHVzZSBgbmdNb2RlbGAgYXMgd2VsbC4KICAgICAqCiAgICAgKiBgbmdNb2RlbGAgaXMgcmVzcG9uc2libGUgZm9yOgogICAgICoKICAgICAqIC0gYmluZGluZyB0aGUgdmlldyBpbnRvIHRoZSBtb2RlbCwgd2hpY2ggb3RoZXIgZGlyZWN0aXZlcyBzdWNoIGFzIGBpbnB1dGAsIGB0ZXh0YXJlYWAgb3IgYHNlbGVjdGAKICAgICAqICAgcmVxdWlyZSwKICAgICAqIC0gcHJvdmlkaW5nIHZhbGlkYXRpb24gYmVoYXZpb3IgKGkuZS4gcmVxdWlyZWQsIG51bWJlciwgZW1haWwsIHVybCksCiAgICAgKiAtIGtlZXBpbmcgc3RhdGUgb2YgdGhlIGNvbnRyb2wgKHZhbGlkL2ludmFsaWQsIGRpcnR5L3ByaXN0aW5lLCB2YWxpZGF0aW9uIGVycm9ycyksCiAgICAgKiAtIHNldHRpbmcgcmVsYXRlZCBjc3MgY2xhc3Mgb250byB0aGUgZWxlbWVudCAoYG5nLXZhbGlkYCwgYG5nLWludmFsaWRgLCBgbmctZGlydHlgLCBgbmctcHJpc3RpbmVgKSwKICAgICAqIC0gcmVnaXN0ZXIgdGhlIGNvbnRyb2wgd2l0aCBwYXJlbnQge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19LgogICAgICoKICAgICAqIEZvciBiYXNpYyBleGFtcGxlcywgaG93IHRvIHVzZSBgbmdNb2RlbGAsIHNlZToKICAgICAqCiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQgdGV4dH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5jaGVja2JveCBjaGVja2JveH0KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5yYWRpbyByYWRpb30KICAgICAqICAgIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIgbnVtYmVyfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsIGVtYWlsfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnVybCB1cmx9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9CiAgICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnRleHRhcmVhIHRleHRhcmVhfQogICAgICoKICAgICAqLwogICAgdmFyIG5nTW9kZWxEaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogWyduZ01vZGVsJywgJ14/Zm9ybSddLAogICAgICAgICAgICBjb250cm9sbGVyOiBOZ01vZGVsQ29udHJvbGxlciwKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gbm90aWZ5IG90aGVycywgZXNwZWNpYWxseSBwYXJlbnQgZm9ybXMKCiAgICAgICAgICAgICAgICB2YXIgbW9kZWxDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgZm9ybUN0cmwgPSBjdHJsc1sxXSB8fCBudWxsRm9ybUN0cmw7CgogICAgICAgICAgICAgICAgZm9ybUN0cmwuJGFkZENvbnRyb2wobW9kZWxDdHJsKTsKCiAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoYW5nZQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV2YWx1YXRlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAgICoKICAgICAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxkb2M6ZXhhbXBsZT4KICAgICAqICAgPGRvYzpzb3VyY2U+CiAgICAgKiAgICAgPHNjcmlwdD4KICAgICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAqICAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwOwogKiAgICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAqICAgICAgICAgfTsKICogICAgICAgfQogICAgICogICAgIDwvc2NyaXB0PgogICAgICogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIG5nLWNoYW5nZT0iY2hhbmdlKCkiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTEiIC8+CiAgICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAgICAgKiAgICAgICA8bGFiZWwgZm9yPSJuZy1jaGFuZ2UtZXhhbXBsZTIiPkNvbmZpcm1lZDwvbGFiZWw+PGJyIC8+CiAgICAgKiAgICAgICBkZWJ1ZyA9IHt7Y29uZmlybWVkfX08YnIgLz4KICAgICAqICAgICAgIGNvdW50ZXIgPSB7e2NvdW50ZXJ9fQogICAgICogICAgIDwvZGl2PgogICAgICogICA8L2RvYzpzb3VyY2U+CiAgICAgKiAgIDxkb2M6c2NlbmFyaW8+CiAgICAgKiAgICAgaXQoJ3Nob3VsZCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIHZpZXcnLCBmdW5jdGlvbigpIHsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMCcpOwogKiAgICAgICBlbGVtZW50KCcjbmctY2hhbmdlLWV4YW1wbGUxJykuY2xpY2soKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMScpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICogICAgIH0pOwogICAgICoKICAgICAqICAgICBpdCgnc2hvdWxkIG5vdCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTInKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKiAgIDwvZG9jOnNjZW5hcmlvPgogICAgICogPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICBjdHJsLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5uZ0NoYW5nZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKCiAgICB2YXIgcmVxdWlyZWREaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmICghY3RybCkgcmV0dXJuOwogICAgICAgICAgICAgICAgYXR0ci5yZXF1aXJlZCA9IHRydWU7IC8vIGZvcmNlIHRydXRoeSBpbiBjYXNlIHdlIGFyZSBvbiBub24gaW5wdXQgZWxlbWVudAoKICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci5yZXF1aXJlZCAmJiAoaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPT09IGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnVuc2hpZnQodmFsaWRhdG9yKTsKCiAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3IoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTGlzdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGV4dCBpbnB1dCB0aGF0IGNvbnZlcnRzIGJldHdlZW4gY29tbWEtc2VwYXJhdGVkIHN0cmluZyBpbnRvIGFuIGFycmF5IG9mIHN0cmluZ3MuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdMaXN0IG9wdGlvbmFsIGRlbGltaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNwbGl0IHRoZSB2YWx1ZS4gSWYKICAgICAqICAgc3BlY2lmaWVkIGluIGZvcm0gYC9zb21ldGhpbmcvYCB0aGVuIHRoZSB2YWx1ZSB3aWxsIGJlIGNvbnZlcnRlZCBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWlza28nLCAndm9qdGEnXTsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5saXN0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgIDx0dD5uYW1lcyA9IHt7bmFtZXN9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbmFtZXMnKSkudG9FcXVhbCgnWyJpZ29yIiwibWlza28iLCJ2b2p0YSJdJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgnbmFtZXMnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbmFtZXMnKSkudG9FcXVhbCgnW10nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdMaXN0RGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvXC8oLiopXC8vLmV4ZWMoYXR0ci5uZ0xpc3QpLAogICAgICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9IG1hdGNoICYmIG5ldyBSZWdFeHAobWF0Y2hbMV0pIHx8IGF0dHIubmdMaXN0IHx8ICcsJzsKCiAgICAgICAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHZpZXdWYWx1ZS5zcGxpdChzZXBhcmF0b3IpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwoKICAgIHZhciBuZ1ZhbHVlRGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0cGwsIHRwbEF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdWYWx1ZSwgZnVuY3Rpb24gdmFsdWVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICAgICAqIHdpdGggdGhlIHZhbHVlIG9mIGEgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIHVwZGF0ZSB0aGUgdGV4dCBjb250ZW50IHdoZW4gdGhlIHZhbHVlIG9mIHRoYXQKICAgICAqIGV4cHJlc3Npb24gY2hhbmdlcy4KICAgICAqCiAgICAgKiBUeXBpY2FsbHksIHlvdSBkb24ndCB1c2UgYG5nQmluZGAgZGlyZWN0bHksIGJ1dCBpbnN0ZWFkIHlvdSB1c2UgdGhlIGRvdWJsZSBjdXJseSBtYXJrdXAgbGlrZQogICAgICogYHt7IGV4cHJlc3Npb24gfX1gIHdoaWNoIGlzIHNpbWlsYXIgYnV0IGxlc3MgdmVyYm9zZS4KICAgICAqCiAgICAgKiBPbmUgc2NlbmFyaW8gaW4gd2hpY2ggdGhlIHVzZSBvZiBgbmdCaW5kYCBpcyBwcmVmZXJyZWQgb3ZlciBge3sgZXhwcmVzc2lvbiB9fWAgYmluZGluZyBpcyB3aGVuCiAgICAgKiBpdCdzIGRlc2lyYWJsZSB0byBwdXQgYmluZGluZ3MgaW50byB0ZW1wbGF0ZSB0aGF0IGlzIG1vbWVudGFyaWx5IGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMKICAgICAqIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4gZWxlbWVudCBhdHRyaWJ1dGUsIGl0IG1ha2VzIHRoZQogICAgICogYmluZGluZ3MgaW52aXNpYmxlIHRvIHRoZSB1c2VyIHdoaWxlIHRoZSBwYWdlIGlzIGxvYWRpbmcuCiAgICAgKgogICAgICogQW4gYWx0ZXJuYXRpdmUgc29sdXRpb24gdG8gdGhpcyBwcm9ibGVtIHdvdWxkIGJlIHVzaW5nIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9IGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXaGlybGVkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnbmFtZScpLmVudGVyKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCd3b3JsZCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kKTsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0JpbmQsIGZ1bmN0aW9uIG5nQmluZFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnQudGV4dCh2YWx1ZSA9PSB1bmRlZmluZWQgPyAnJyA6IHZhbHVlKTsKICAgICAgICB9KTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmRUZW1wbGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAgICAgKiB0ZXh0IHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHRoZSB0ZW1wbGF0ZSBpbiBuZ0JpbmRUZW1wbGF0ZS4KICAgICAqIFVubGlrZSBuZ0JpbmQgdGhlIG5nQmluZFRlbXBsYXRlIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogICAgICogZXhwcmVzc2lvbnMuIChUaGlzIGlzIHJlcXVpcmVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogICAgICogY2FuIG5vdCBoYXZlIFNQQU4gZWxlbWVudHMgc3VjaCBhcyBUSVRMRSwgb3IgT1BUSU9OIHRvIG5hbWUgYSBmZXcuKQogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nQmluZFRlbXBsYXRlIHRlbXBsYXRlIG9mIGZvcm0KICAgICAqICAgPHR0Pnt7PC90dD4gPHR0PmV4cHJlc3Npb248L3R0PiA8dHQ+fX08L3R0PiB0byBldmFsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgd2F0Y2ggdGhlIGdyZWV0aW5nIGNoYW5nZS4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5zYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXb3JsZCc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFNhbHV0YXRpb246IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2FsdXRhdGlvbiI+PGJyPgogICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgIDxwcmUgbmctYmluZC10ZW1wbGF0ZT0ie3tzYWx1dGF0aW9ufX0ge3tuYW1lfX0hIj48L3ByZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ3NhbHV0YXRpb24nKSkuCiAgICAgICAgICAgdG9CZSgnSGVsbG8nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgdG9CZSgnV29ybGQnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3NhbHV0YXRpb24nKS5lbnRlcignR3JlZXRpbmdzJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3VzZXInKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ3NhbHV0YXRpb24nKSkuCiAgICAgICAgICAgdG9CZSgnR3JlZXRpbmdzJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLgogICAgICAgICAgIHRvQmUoJ3VzZXInKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgLy8gVE9ETzogbW92ZSB0aGlzIHRvIHNjZW5hcmlvIHJ1bm5lcgogICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci5uZ0JpbmRUZW1wbGF0ZSkpOwogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1iaW5kaW5nJykuZGF0YSgnJGJpbmRpbmcnLCBpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnbmdCaW5kVGVtcGxhdGUnLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dCh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH1dOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sVW5zYWZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgYmluZGluZyB0aGF0IHdpbGwgaW5uZXJIVE1MIHRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgYGV4cHJlc3Npb25gIGludG8gdGhlIGN1cnJlbnQKICAgICAqIGVsZW1lbnQuICpUaGUgaW5uZXJIVE1MLWVkIGNvbnRlbnQgd2lsbCBub3QgYmUgc2FuaXRpemVkISogWW91IHNob3VsZCB1c2UgdGhpcyBkaXJlY3RpdmUgb25seSBpZgogICAgICoge0BsaW5rIG5nU2FuaXRpemUuZGlyZWN0aXZlOm5nQmluZEh0bWwgbmdCaW5kSHRtbH0gZGlyZWN0aXZlIGlzIHRvbwogICAgICogcmVzdHJpY3RpdmUgYW5kIHdoZW4geW91IGFic29sdXRlbHkgdHJ1c3QgdGhlIHNvdXJjZSBvZiB0aGUgY29udGVudCB5b3UgYXJlIGJpbmRpbmcgdG8uCiAgICAgKgogICAgICogU2VlIHtAbGluayBuZ1Nhbml0aXplLiRzYW5pdGl6ZSAkc2FuaXRpemV9IGRvY3MgZm9yIGV4YW1wbGVzLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmRIdG1sVW5zYWZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogICAgICovCiAgICB2YXIgbmdCaW5kSHRtbFVuc2FmZURpcmVjdGl2ZSA9IFtmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1iaW5kaW5nJykuZGF0YSgnJGJpbmRpbmcnLCBhdHRyLm5nQmluZEh0bWxVbnNhZmUpOwogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0JpbmRIdG1sVW5zYWZlLCBmdW5jdGlvbiBuZ0JpbmRIdG1sVW5zYWZlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSB8fCAnJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9XTsKCiAgICBmdW5jdGlvbiBjbGFzc0RpcmVjdGl2ZShuYW1lLCBzZWxlY3RvcikgewogICAgICAgIG5hbWUgPSAnbmdDbGFzcycgKyBuYW1lOwogICAgICAgIHJldHVybiBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgdmFyIG9sZFZhbCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25hbWVdLCBuZ0NsYXNzV2F0Y2hBY3Rpb24sIHRydWUpOwoKICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnY2xhc3MnLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBuZ0NsYXNzID0gc2NvcGUuJGV2YWwoYXR0cltuYW1lXSk7CiAgICAgICAgICAgICAgICBuZ0NsYXNzV2F0Y2hBY3Rpb24obmdDbGFzcywgbmdDbGFzcyk7CiAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24gKCRpbmRleCwgb2xkJGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZCA9ICRpbmRleCAmIDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZCAhPT0gb2xkJGluZGV4ICYgMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3Moc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Moc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBuZ0NsYXNzV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09IHRydWUgfHwgc2NvcGUuJGluZGV4ICUgMiA9PT0gc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2xkVmFsICYmICFlcXVhbHMobmV3VmFsLCBvbGRWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKG9sZFZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvbGRWYWwgPSBjb3B5KG5ld1ZhbCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSAmJiAhaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc1ZhbCA9IG1hcChjbGFzc1ZhbCwgZnVuY3Rpb24gKHYsIGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHJldHVybiBrCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGlzQXJyYXkoY2xhc3NWYWwpID8gY2xhc3NWYWwuam9pbignICcpIDogY2xhc3NWYWwpOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgZnVuY3Rpb24gYWRkQ2xhc3MoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChjbGFzc1ZhbCkgJiYgIWlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgY2xhc3NWYWwgPSBtYXAoY2xhc3NWYWwsIGZ1bmN0aW9uICh2LCBrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSByZXR1cm4gawogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhpc0FycmF5KGNsYXNzVmFsKSA/IGNsYXNzVmFsLmpvaW4oJyAnKSA6IGNsYXNzVmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xhc3MKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDbGFzc2AgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIGNsYXNzIG9uIEhUTUwgZWxlbWVudCBkeW5hbWljYWxseSBieSBkYXRhYmluZGluZyBhbgogICAgICogZXhwcmVzc2lvbiB0aGF0IHJlcHJlc2VudHMgYWxsIGNsYXNzZXMgdG8gYmUgYWRkZWQuCiAgICAgKgogICAgICogVGhlIGRpcmVjdGl2ZSB3b24ndCBhZGQgZHVwbGljYXRlIGNsYXNzZXMgaWYgYSBwYXJ0aWN1bGFyIGNsYXNzIHdhcyBhbHJlYWR5IHNldC4KICAgICAqCiAgICAgKiBXaGVuIHRoZSBleHByZXNzaW9uIGNoYW5nZXMsIHRoZSBwcmV2aW91c2x5IGFkZGVkIGNsYXNzZXMgYXJlIHJlbW92ZWQgYW5kIG9ubHkgdGhlbiB0aGUKICAgICAqIG5ldyBjbGFzc2VzIGFyZSBhZGRlZC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzCiAgICAgKiAgIG5hbWVzLCBhbiBhcnJheSwgb3IgYSBtYXAgb2YgY2xhc3MgbmFtZXMgdG8gYm9vbGVhbiB2YWx1ZXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0ic2V0IiBuZy1jbGljaz0ibXlWYXI9J215LWNsYXNzJyI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlWYXI9JyciPgogICAgIDxicj4KICAgICA8c3BhbiBuZy1jbGFzcz0ibXlWYXIiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIC5teS1jbGFzcyB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLm5vdCgpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmZpcnN0JykuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmxhc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJycsIHRydWUpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xhc3NPZGQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IGl0IHdvcmtzIGluCiAgICAgKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2VzIGFmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICAgICAqCiAgICAgKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiBhIHNjb3BlIG9mIGFuCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc09kZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAge3tuYW1lfX0KICAgICA8L3NwYW4+CiAgICAgPC9saT4KICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIC5vZGQgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc09kZERpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdPZGQnLCAwKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzRXZlbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzRXZlbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUKICAgICAqICAgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAge3tuYW1lfX0gJm5ic3A7ICZuYnNwOyAmbmJzcDsKICAgICA8L3NwYW4+CiAgICAgPC9saT4KICAgICA8L29sPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIC5vZGQgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc0V2ZW5EaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnRXZlbicsIDEpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xvYWsKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGlzIHVzZWQgdG8gcHJldmVudCB0aGUgQW5ndWxhciBodG1sIHRlbXBsYXRlIGZyb20gYmVpbmcgYnJpZWZseQogICAgICogZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cyByYXcgKHVuY29tcGlsZWQpIGZvcm0gd2hpbGUgeW91ciBhcHBsaWNhdGlvbiBpcyBsb2FkaW5nLiBVc2UgdGhpcwogICAgICogZGlyZWN0aXZlIHRvIGF2b2lkIHRoZSB1bmRlc2lyYWJsZSBmbGlja2VyIGVmZmVjdCBjYXVzZWQgYnkgdGhlIGh0bWwgdGVtcGxhdGUgZGlzcGxheS4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIHRvIHRoZSBgPGJvZHk+YCBlbGVtZW50LCBidXQgdHlwaWNhbGx5IGEgZmluZS1ncmFpbmVkIGFwcGxpY2F0aW9uIGlzCiAgICAgKiBwcmVmZXJlZCBpbiBvcmRlciB0byBiZW5lZml0IGZyb20gcHJvZ3Jlc3NpdmUgcmVuZGVyaW5nIG9mIHRoZSBicm93c2VyIHZpZXcuCiAgICAgKgogICAgICogYG5nQ2xvYWtgIHdvcmtzIGluIGNvb3BlcmF0aW9uIHdpdGggYSBjc3MgcnVsZSB0aGF0IGlzIGVtYmVkZGVkIHdpdGhpbiBgYW5ndWxhci5qc2AgYW5kCiAgICAgKiAgYGFuZ3VsYXIubWluLmpzYCBmaWxlcy4gRm9sbG93aW5nIGlzIHRoZSBjc3MgcnVsZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICogICBkaXNwbGF5OiBub25lOwogKiB9CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBXaGVuIHRoaXMgY3NzIHJ1bGUgaXMgbG9hZGVkIGJ5IHRoZSBicm93c2VyLCBhbGwgaHRtbCBlbGVtZW50cyAoaW5jbHVkaW5nIHRoZWlyIGNoaWxkcmVuKSB0aGF0CiAgICAgKiBhcmUgdGFnZ2VkIHdpdGggdGhlIGBuZy1jbG9ha2AgZGlyZWN0aXZlIGFyZSBoaWRkZW4uIFdoZW4gQW5ndWxhciBjb21lcyBhY3Jvc3MgdGhpcyBkaXJlY3RpdmUKICAgICAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgd2hpY2gKICAgICAqIG1ha2VzIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAgICAgKgogICAgICogRm9yIHRoZSBiZXN0IHJlc3VsdCwgYGFuZ3VsYXIuanNgIHNjcmlwdCBtdXN0IGJlIGxvYWRlZCBpbiB0aGUgaGVhZCBzZWN0aW9uIG9mIHRoZSBodG1sIGZpbGU7CiAgICAgKiBhbHRlcm5hdGl2ZWx5LCB0aGUgY3NzIHJ1bGUgKGFib3ZlKSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogICAgICogYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICAgICAqIGNhbm5vdCBtYXRjaCB0aGUgYFtuZ1w6Y2xvYWtdYCBzZWxlY3Rvci4gVG8gd29yayBhcm91bmQgdGhpcyBsaW1pdGF0aW9uLCB5b3UgbXVzdCBhZGQgdGhlIGNzcwogICAgICogY2xhc3MgYG5nQ2xvYWtgIGluIGFkZGl0aW9uIHRvIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUxIiBuZy1jbG9haz57eyAnaGVsbG8nIH19PC9kaXY+CiAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIHRlbXBsYXRlIGRpcmVjdGl2ZSBhbmQgY3NzIGNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjdGVtcGxhdGUxJykuYXR0cignbmctY2xvYWsnKSkuCiAgICAgICAgICAgbm90KCkudG9CZURlZmluZWQoKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTInKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ0Nsb2FrRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgnbmdDbG9haycsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ25nLWNsb2FrJyk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDb250cm9sbGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIGFzc2lnbnMgYmVoYXZpb3IgdG8gYSBzY29wZS4gVGhpcyBpcyBhIGtleSBhc3BlY3Qgb2YgaG93IGFuZ3VsYXIKICAgICAqIHN1cHBvcnRzIHRoZSBwcmluY2lwbGVzIGJlaGluZCB0aGUgTW9kZWwtVmlldy1Db250cm9sbGVyIGRlc2lnbiBwYXR0ZXJuLgogICAgICoKICAgICAqIE1WQyBjb21wb25lbnRzIGluIGFuZ3VsYXI6CiAgICAgKgogICAgICogKiBNb2RlbCDigJQgVGhlIE1vZGVsIGlzIGRhdGEgaW4gc2NvcGUgcHJvcGVydGllczsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NLgogICAgICogKiBWaWV3IOKAlCBUaGUgdGVtcGxhdGUgKEhUTUwgd2l0aCBkYXRhIGJpbmRpbmdzKSBpcyByZW5kZXJlZCBpbnRvIHRoZSBWaWV3LgogICAgICogKiBDb250cm9sbGVyIOKAlCBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIHNwZWNpZmllcyBhIENvbnRyb2xsZXIgY2xhc3M7IHRoZSBjbGFzcyBoYXMKICAgICAqICAgbWV0aG9kcyB0aGF0IHR5cGljYWxseSBleHByZXNzIHRoZSBidXNpbmVzcyBsb2dpYyBiZWhpbmQgdGhlIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIE5vdGUgdGhhdCBhbiBhbHRlcm5hdGl2ZSB3YXkgdG8gZGVmaW5lIGNvbnRyb2xsZXJzIGlzIHZpYSB0aGUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb250cm9sbGVyIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAgICAgKiAgICAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gdGhhdCBvbiB0aGUgY3VycmVudCBzY29wZSBldmFsdWF0ZXMgdG8gYQogICAgICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAgICAgKiBncmVldGluZyBhcmUgbWV0aG9kcyBkZWNsYXJlZCBvbiB0aGUgY29udHJvbGxlciAoc2VlIHNvdXJjZSB0YWIpLiBUaGVzZSBtZXRob2RzIGNhbgogICAgICogZWFzaWx5IGJlIGNhbGxlZCBmcm9tIHRoZSBhbmd1bGFyIG1hcmt1cC4gTm90aWNlIHRoYXQgdGhlIHNjb3BlIGJlY29tZXMgdGhlIGB0aGlzYCBmb3IgdGhlCiAgICAgKiBjb250cm9sbGVyJ3MgaW5zdGFuY2UuIFRoaXMgYWxsb3dzIGZvciBlYXN5IGFjY2VzcyB0byB0aGUgdmlldyBkYXRhIGZyb20gdGhlIGNvbnRyb2xsZXIuIEFsc28KICAgICAqIG5vdGljZSB0aGF0IGFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5IHJlZmxlY3RlZCBpbiB0aGUgVmlldyB3aXRob3V0IHRoZSBuZWVkCiAgICAgKiBmb3IgYSBtYW51YWwgdXBkYXRlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcigkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgJHNjb3BlLmNvbnRhY3RzID0gWwogICAgICAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAgICAgICAgICAgIHt0eXBlOidlbWFpbCcsIHZhbHVlOidqb2huLnNtaXRoQGV4YW1wbGUub3JnJ30gXTsKCiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICB9OwoKICAgICAkc2NvcGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogICAgICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH07CgogICAgICRzY29wZS5jbGVhckNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0KSB7CiAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAgICAgICAgICB9OwogICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlciI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICAgQ29udGFjdDoKICAgICA8dWw+CiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICAgPG9wdGlvbj5lbWFpbDwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICA8L2xpPgogICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICA8L3VsPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgZGl2PjppbnB1dCcpLnZhbCgpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMSkgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMikgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwoKICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBhOmNvbnRhaW5zKCJjbGVhciIpJykuY2xpY2soKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3QgaW5wdXQnKS52YWwoKSkudG9CZSgnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3QgYTpjb250YWlucygiYWRkIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgICAgY29udHJvbGxlcjogJ0AnCiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ3NwCiAgICAgKiBAcHJpb3JpdHkgMTAwMAogICAgICoKICAgICAqIEBlbGVtZW50IGh0bWwKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICAgICAqCiAgICAgKiBUaGlzIGlzIG5lY2Vzc2FyeSB3aGVuIGRldmVsb3BpbmcgdGhpbmdzIGxpa2UgR29vZ2xlIENocm9tZSBFeHRlbnNpb25zLgogICAgICoKICAgICAqIENTUCBmb3JiaWRzIGFwcHMgdG8gdXNlIGBldmFsYCBvciBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyAoYW1vbmcgb3RoZXIgdGhpbmdzKS4KICAgICAqIEZvciB1cyB0byBiZSBjb21wYXRpYmxlLCB3ZSBqdXN0IG5lZWQgdG8gaW1wbGVtZW50IHRoZSAiZ2V0dGVyRm4iIGluICRwYXJzZSB3aXRob3V0IHZpb2xhdGluZwogICAgICogYW55IG9mIHRoZXNlIHJlc3RyaWN0aW9ucy4KICAgICAqCiAgICAgKiBBbmd1bGFySlMgdXNlcyBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyBhcyBhIHNwZWVkIG9wdGltaXphdGlvbi4gQnkgYXBwbHlpbmcgYG5nQ3NwYAogICAgICogaXQgaXMgYmUgcG9zc2libGUgdG8gb3B0IGludG8gdGhlIENTUCBjb21wYXRpYmxlIG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAgICAgKiBldmFsdWF0ZSBhbGwgZXhwcmVzc2lvbnMgdXAgdG8gMzAlIHNsb3dlciB0aGFuIGluIG5vbi1DU1AgbW9kZSwgYnV0IG5vIHNlY3VyaXR5IHZpb2xhdGlvbnMgd2lsbAogICAgICogYmUgcmFpc2VkLgogICAgICoKICAgICAqIEluIG9yZGVyIHRvIHVzZSB0aGlzIGZlYXR1cmUgcHV0IGBuZ0NzcGAgZGlyZWN0aXZlIG9uIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIGFwcGx5IHRoZSBgbmdDc3BgIGRpcmVjdGl2ZSB0byB0aGUgYGh0bWxgIHRhZy4KICAgICA8cHJlPgogICAgIDwhZG9jdHlwZSBodG1sPgogICAgIDxodG1sIG5nLWFwcCBuZy1jc3A+CiAgICAgLi4uCiAgICAgLi4uCiAgICAgPC9odG1sPgogICAgIDwvcHJlPgogICAgICovCgogICAgdmFyIG5nQ3NwRGlyZWN0aXZlID0gWyckc25pZmZlcicsIGZ1bmN0aW9uICgkc25pZmZlcikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkc25pZmZlci5jc3AgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ0NsaWNrIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbgogICAgICogZWxlbWVudCBpcyBjbGlja2VkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgICAgSW5jcmVtZW50CiAgICAgPC9idXR0b24+CiAgICAgY291bnQ6IHt7Y291bnR9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICAvKgogICAgICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAgICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKgogICAgICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICAgICAqLwogICAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgICBmb3JFYWNoKAogICAgICAgICdjbGljayBkYmxjbGljayBtb3VzZWRvd24gbW91c2V1cCBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2Vtb3ZlIG1vdXNlZW50ZXIgbW91c2VsZWF2ZScuc3BsaXQoJyAnKSwKICAgICAgICBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIG5hbWUpOwogICAgICAgICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24gKCRwYXJzZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRyW2RpcmVjdGl2ZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmJpbmQobG93ZXJjYXNlKG5hbWUpLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OiBldmVudH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH1dOwogICAgICAgIH0KICAgICk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEYmxjbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0RibGNsaWNrYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBkYmxjbGljayBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEYmxjbGljayB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBkYmxjbGljay4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlZG93bgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nTW91c2Vkb3duIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZG93biBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2Vkb3duLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2V1cAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2V1cCBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNldXAuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlb3ZlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VvdmVyIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlb3ZlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZW92ZXIuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWVudGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWVudGVyIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZW50ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VlbnRlci4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlbGVhdmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbGVhdmUgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VsZWF2ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWxlYXZlLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2Vtb3ZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW1vdmUgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vtb3ZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlbW92ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBmb3JtCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3VibWl0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2hlbGxvJzsKICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMudGV4dCkgewogICAgICAgICAgICAgIHRoaXMubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5nLXN1Ym1pdD0ic3VibWl0KCkiIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1siaGVsbG8iXScpOwogICAgICAgICBleHBlY3QoaW5wdXQoJ3RleHQnKS52YWwoKSkudG9CZSgnJyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGlnbm9yZSBlbXB0eSBzdHJpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdTdWJtaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgZWxlbWVudC5iaW5kKCdzdWJtaXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNjb3BlLiRhcHBseShhdHRycy5uZ1N1Ym1pdCk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEByZXN0cmljdCBFQ0EKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZldGNoZXMsIGNvbXBpbGVzIGFuZCBpbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50LgogICAgICoKICAgICAqIEtlZXAgaW4gbWluZCB0aGF0IFNhbWUgT3JpZ2luIFBvbGljeSBhcHBsaWVzIHRvIGluY2x1ZGVkIHJlc291cmNlcwogICAgICogKGUuZy4gbmdJbmNsdWRlIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvcgogICAgICogIGZpbGU6Ly8gYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMpLgogICAgICoKICAgICAqIEBzY29wZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0luY2x1ZGV8c3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICAgICAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gcXVvdGVzLCBlLmcuIGBzcmM9IidteVBhcnRpYWxUZW1wbGF0ZS5odG1sJyJgLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgbmV3IHBhcnRpYWwgaXMgbG9hZGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBXaGV0aGVyIGBuZ0luY2x1ZGVgIHNob3VsZCBjYWxsIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAgICoKICAgICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJ0ZW1wbGF0ZSIgbmctb3B0aW9ucz0idC5uYW1lIGZvciB0IGluIHRlbXBsYXRlcyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1pbmNsdWRlIHNyYz0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS50ZW1wbGF0ZXMgPQogICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30KICAgICAgICAgICwgeyBuYW1lOiAndGVtcGxhdGUyLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTIuaHRtbCd9IF07CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlID0gJHNjb3BlLnRlbXBsYXRlc1swXTsKICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTEuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbAogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMS5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLWluY2x1ZGVdJykudGV4dCgpKS4KICAgICAgICAgdG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJzEnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICBzZWxlY3QoJ3RlbXBsYXRlJykub3B0aW9uKCcnKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdJbmNsdWRlRGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckYW5jaG9yU2Nyb2xsJywgJyRjb21waWxlJywKICAgICAgICBmdW5jdGlvbiAoJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkYW5jaG9yU2Nyb2xsLCAkY29tcGlsZSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBzcmNFeHAgPSBhdHRyLm5nSW5jbHVkZSB8fCBhdHRyLnNyYywKICAgICAgICAgICAgICAgICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRyLmF1dG9zY3JvbGw7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhckNvbnRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHNyY0V4cCwgZnVuY3Rpb24gbmdJbmNsdWRlV2F0Y2hBY3Rpb24oc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGhpc0NoYW5nZUlkID0gKytjaGFuZ2VDb3VudGVyOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoc3JjLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuc3VjY2VzcyhmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCAhPT0gY2hhbmdlQ291bnRlcikgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkU2NvcGUpIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoY2hpbGRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZW1pdCgnJGluY2x1ZGVDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0luaXRgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgaW5pdGlhbGl6YXRpb24gdGFza3MgdG8gYmUgZXhlY3V0ZWQKICAgICAqICBiZWZvcmUgdGhlIHRlbXBsYXRlIGVudGVycyBleGVjdXRpb24gbW9kZSBkdXJpbmcgYm9vdHN0cmFwLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0luaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImdyZWV0aW5nPSdIZWxsbyc7IHBlcnNvbj0nV29ybGQnIj4KICAgICB7e2dyZWV0aW5nfX0ge3twZXJzb259fSEKICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGdyZWV0aW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdncmVldGluZycpKS50b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QoYmluZGluZygncGVyc29uJykpLnRvQmUoJ1dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdJbml0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHJzLm5nSW5pdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ05vbkJpbmRhYmxlCiAgICAgKiBAcHJpb3JpdHkgMTAwMAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU29tZXRpbWVzIGl0IGlzIG5lY2Vzc2FyeSB0byB3cml0ZSBjb2RlIHdoaWNoIGxvb2tzIGxpa2UgYmluZGluZ3MgYnV0IHdoaWNoIHNob3VsZCBiZSBsZWZ0IGFsb25lCiAgICAgKiBieSBhbmd1bGFyLiBVc2UgYG5nTm9uQmluZGFibGVgIHRvIG1ha2UgYW5ndWxhciBpZ25vcmUgYSBjaHVuayBvZiBIVE1MLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBJbiB0aGlzIGV4YW1wbGUgdGhlcmUgYXJlIHR3byBsb2NhdGlvbiB3aGVyZSBhIHNpbXBsZSBiaW5kaW5nIChge3t9fWApIGlzIHByZXNlbnQsIGJ1dCB0aGUgb25lCiAgICAgKiB3cmFwcGVkIGluIGBuZ05vbkJpbmRhYmxlYCBpcyBsZWZ0IGFsb25lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXY+Tm9ybWFsOiB7ezEgKyAyfX08L2Rpdj4KICAgICA8ZGl2IG5nLW5vbi1iaW5kYWJsZT5JZ25vcmVkOiB7ezEgKyAyfX08L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW5vbi1iaW5kYWJsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnMSArIDInKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnZGl2Omxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgIHRvTWF0Y2goLzEgXCsgMi8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nTm9uQmluZGFibGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7IHRlcm1pbmFsOiB0cnVlLCBwcmlvcml0eTogMTAwMCB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1BsdXJhbGl6ZQogICAgICogQHJlc3RyaWN0IEVBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdQbHVyYWxpemVgIGlzIGEgZGlyZWN0aXZlIHRoYXQgZGlzcGxheXMgbWVzc2FnZXMgYWNjb3JkaW5nIHRvIGVuLVVTIGxvY2FsaXphdGlvbiBydWxlcy4KICAgICAqIFRoZXNlIHJ1bGVzIGFyZSBidW5kbGVkIHdpdGggYW5ndWxhci5qcyBhbmQgdGhlIHJ1bGVzIGNhbiBiZSBvdmVycmlkZGVuCiAgICAgKiAoc2VlIHtAbGluayBndWlkZS9pMThuIEFuZ3VsYXIgaTE4bn0gZGV2IGd1aWRlKS4gWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBkaXJlY3RpdmUKICAgICAqIGJ5IHNwZWNpZnlpbmcgdGhlIG1hcHBpbmdzIGJldHdlZW4KICAgICAqIHtAbGluayBodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzfSBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogICAgICoKICAgICAqICMgUGx1cmFsIGNhdGVnb3JpZXMgYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcwogICAgICogVGhlcmUgYXJlIHR3bwogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogICAgICogcGx1cmFsIGNhdGVnb3JpZXN9IGluIEFuZ3VsYXIncyBkZWZhdWx0IGVuLVVTIGxvY2FsZTogIm9uZSIgYW5kICJvdGhlciIuCiAgICAgKgogICAgICogV2hpbGUgYSBwdXJhbCBjYXRlZ29yeSBtYXkgbWF0Y2ggbWFueSBudW1iZXJzIChmb3IgZXhhbXBsZSwgaW4gZW4tVVMgbG9jYWxlLCAib3RoZXIiIGNhbiBtYXRjaAogICAgICogYW55IG51bWJlciB0aGF0IGlzIG5vdCAxKSwgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgY2FuIG9ubHkgbWF0Y2ggb25lIG51bWJlci4gRm9yIGV4YW1wbGUsIHRoZQogICAgICogZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yICIzIiBtYXRjaGVzIHRoZSBudW1iZXIgMy4gWW91IHdpbGwgc2VlIHRoZSB1c2Ugb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCBsYXRlciBwYXJ0cyBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICAgKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogICAgICogQW5ndWxhciBleHByZXNzaW9ufTsgdGhlc2UgYXJlIGV2YWx1YXRlZCBvbiB0aGUgY3VycmVudCBzY29wZSBmb3IgaXRzIGJvdW5kIHZhbHVlLgogICAgICoKICAgICAqIFRoZSBgd2hlbmAgYXR0cmlidXRlIHNwZWNpZmllcyB0aGUgbWFwcGluZ3MgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcmllcyBhbmQgdGhlIGFjdHVhbAogICAgICogc3RyaW5nIHRvIGJlIGRpc3BsYXllZC4gVGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgc2hvdWxkIGJlIGEgSlNPTiBvYmplY3Qgc28gdGhhdCBBbmd1bGFyCiAgICAgKiBjYW4gaW50ZXJwcmV0IGl0IGNvcnJlY3RseS4KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICo8L3ByZT4KICAgICAqCiAgICAgKiBJbiB0aGUgZXhhbXBsZSwgYCIwOiBOb2JvZHkgaXMgdmlld2luZy4iYCBpcyBhbiBleHBsaWNpdCBudW1iZXIgcnVsZS4gSWYgeW91IGRpZCBub3QKICAgICAqIHNwZWNpZnkgdGhpcyBydWxlLCAwIHdvdWxkIGJlIG1hdGNoZWQgdG8gdGhlICJvdGhlciIgY2F0ZWdvcnkgYW5kICIwIHBlb3BsZSBhcmUgdmlld2luZyIKICAgICAqIHdvdWxkIGJlIHNob3duIGluc3RlYWQgb2YgIk5vYm9keSBpcyB2aWV3aW5nIi4gWW91IGNhbiBzcGVjaWZ5IGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGZvcgogICAgICogb3RoZXIgbnVtYmVycywgZm9yIGV4YW1wbGUgMTIsIHNvIHRoYXQgaW5zdGVhZCBvZiBzaG93aW5nICIxMiBwZW9wbGUgYXJlIHZpZXdpbmciLCB5b3UgY2FuCiAgICAgKiBzaG93ICJhIGRvemVuIHBlb3BsZSBhcmUgdmlld2luZyIuCiAgICAgKgogICAgICogWW91IGNhbiB1c2UgYSBzZXQgb2YgY2xvc2VkIGJyYWNlcyhge31gKSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgbnVtYmVyIHRoYXQgeW91IHdhbnQgc3Vic3RpdHV0ZWQKICAgICAqIGludG8gcGx1cmFsaXplZCBzdHJpbmdzLiBJbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwgQW5ndWxhciB3aWxsIHJlcGxhY2UgYHt9YCB3aXRoCiAgICAgKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICAgICAqIGZvciA8c3BhbiBuZy1ub24tYmluZGFibGU+e3tudW1iZXJFeHByZXNzaW9ufX08L3NwYW4+LgogICAgICoKICAgICAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICAgICAqIFRoZSBgb2Zmc2V0YCBhdHRyaWJ1dGUgYWxsb3dzIGZ1cnRoZXIgY3VzdG9taXphdGlvbiBvZiBwbHVyYWxpemVkIHRleHQsIHdoaWNoIGNhbiByZXN1bHQgaW4KICAgICAqIGEgYmV0dGVyIHVzZXIgZXhwZXJpZW5jZS4gRm9yIGV4YW1wbGUsIGluc3RlYWQgb2YgdGhlIG1lc3NhZ2UgIjQgcGVvcGxlIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLAogICAgICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogICAgICogVGhlIG9mZnNldCBhdHRyaWJ1dGUgYWxsb3dzIHlvdSB0byBvZmZzZXQgYSBudW1iZXIgYnkgYW55IGRlc2lyZWQgdmFsdWUuCiAgICAgKiBMZXQncyB0YWtlIGEgbG9vayBhdCBhbiBleGFtcGxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIgb2Zmc2V0PTIKICAgICAqICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIE5vdGljZSB0aGF0IHdlIGFyZSBzdGlsbCB1c2luZyB0d28gcGx1cmFsIGNhdGVnb3JpZXMob25lLCBvdGhlciksIGJ1dCB3ZSBhZGRlZAogICAgICogdGhyZWUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIDAsIDEgYW5kIDIuCiAgICAgKiBXaGVuIG9uZSBwZXJzb24sIHBlcmhhcHMgSm9obiwgdmlld3MgdGhlIGRvY3VtZW50LCAiSm9obiBpcyB2aWV3aW5nIiB3aWxsIGJlIHNob3duLgogICAgICogV2hlbiB0aHJlZSBwZW9wbGUgdmlldyB0aGUgZG9jdW1lbnQsIG5vIGV4cGxpY2l0IG51bWJlciBydWxlIGlzIGZvdW5kLCBzbwogICAgICogYW4gb2Zmc2V0IG9mIDIgaXMgdGFrZW4gb2ZmIDMsIGFuZCBBbmd1bGFyIHVzZXMgMSB0byBkZWNpZGUgdGhlIHBsdXJhbCBjYXRlZ29yeS4KICAgICAqIEluIHRoaXMgY2FzZSwgcGx1cmFsIGNhdGVnb3J5ICdvbmUnIGlzIG1hdGNoZWQgYW5kICJKb2huLCBNYXJyeSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZyIKICAgICAqIGlzIHNob3duLgogICAgICoKICAgICAqIE5vdGUgdGhhdCB3aGVuIHlvdSBzcGVjaWZ5IG9mZnNldHMsIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvcgogICAgICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICAgICAqIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvciAwLCAxLCAyIGFuZCAzLiBZb3UgbXVzdCBhbHNvIHByb3ZpZGUgcGx1cmFsIHN0cmluZ3MgZm9yCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllcyAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xleHByZXNzaW9ufSBjb3VudCBUaGUgdmFyaWFibGUgdG8gYmUgYm91bmRlZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb2Rpbmcgc3RyaW5ncy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjEgPSAnSWdvcic7CiAgICAgICAgICAgICRzY29wZS5wZXJzb24yID0gJ01pc2tvJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIHNpbXBsZSBwbHVyYWxpemF0aW9uIHJ1bGVzIGZvciBlbiBsb2NhbGUgLS0tPgogICAgIFdpdGhvdXQgT2Zmc2V0OgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT48YnI+CgogICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgIFdpdGggT2Zmc2V0KDIpOgogICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzEgcGVyc29uIGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yIGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzAnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ05vYm9keSBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgYW5kIE1pc2tvIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCczJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCczIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCc0IHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYmluZGVkIG5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignNCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjEnKS5lbnRlcignRGknKTsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb24yJykuZW50ZXIoJ1ZvanRhJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uICgkbG9jYWxlLCAkaW50ZXJwb2xhdGUpIHsKICAgICAgICB2YXIgQlJBQ0UgPSAve30vZzsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyRXhwID0gYXR0ci5jb3VudCwKICAgICAgICAgICAgICAgICAgICB3aGVuRXhwID0gZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIud2hlbiksIC8vIHRoaXMgaXMgYmVjYXVzZSB3ZSBoYXZlIHt7fX0gaW4gYXR0cnMKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSBhdHRyLm9mZnNldCB8fCAwLAogICAgICAgICAgICAgICAgICAgIHdoZW5zID0gc2NvcGUuJGV2YWwod2hlbkV4cCksCiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnMgPSB7fSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHdoZW5zLCBmdW5jdGlvbiAoZXhwcmVzc2lvbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnNba2V5XSA9CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCArIGVuZFN5bWJvbCkpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiBleHBsaWNpdCBudW1iZXIgcnVsZSBzdWNoIGFzIDEsIDIsIDMuLi4gaXMgZGVmaW5lZCwganVzdCB1c2UgaXQuIE90aGVyd2lzZSwKICAgICAgICAgICAgICAgICAgICAgICAgLy9jaGVjayBpdCBhZ2FpbnN0IHBsdXJhbGl6YXRpb24gcnVsZXMgaW4gJGxvY2FsZSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuc0V4cEZuc1t2YWx1ZV0oc2NvcGUsIGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGV4dChuZXdWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdSZXBlYXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAgICAgKiBpbnN0YW5jZSBnZXRzIGl0cyBvd24gc2NvcGUsIHdoZXJlIHRoZSBnaXZlbiBsb29wIHZhcmlhYmxlIGlzIHNldCB0byB0aGUgY3VycmVudCBjb2xsZWN0aW9uIGl0ZW0sCiAgICAgKiBhbmQgYCRpbmRleGAgaXMgc2V0IHRvIHRoZSBpdGVtIGluZGV4IG9yIGtleS4KICAgICAqCiAgICAgKiBTcGVjaWFsIHByb3BlcnRpZXMgYXJlIGV4cG9zZWQgb24gdGhlIGxvY2FsIHNjb3BlIG9mIGVhY2ggdGVtcGxhdGUgaW5zdGFuY2UsIGluY2x1ZGluZzoKICAgICAqCiAgICAgKiAgICogYCRpbmRleGAg4oCTIGB7bnVtYmVyfWAg4oCTIGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpCiAgICAgKiAgICogYCRmaXJzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGZpcnN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJG1pZGRsZWAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqICAgKiBgJGxhc3RgIOKAkyBge2Jvb2xlYW59YCDigJMgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4KICAgICAqCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUd28KICAgICAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICAgICAqCiAgICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogICAgICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYHRyYWNrIGluIGNkLnRyYWNrc2AuCiAgICAgKgogICAgICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogICAgICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgICAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBhZ2U6MjV9LCB7bmFtZTonTWFyeScsIGFnZToyOH1dIj4KICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyI+CiAgICAgW3t7JGluZGV4ICsgMX19XSB7e2ZyaWVuZC5uYW1lfX0gd2hvIGlzIHt7ZnJpZW5kLmFnZX19IHllYXJzIG9sZC4KICAgICA8L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1yZXBlYXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICB2YXIgciA9IHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLnJlcGVhdGVyKCd1bCBsaScpOwogICAgICAgICAgIGV4cGVjdChyLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgICAgZXhwZWN0KHIucm93KDApKS50b0VxdWFsKFsiMSIsIkpvaG4iLCIyNSJdKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMSkpLnRvRXF1YWwoWyIyIiwiTWFyeSIsIjI4Il0pOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdSZXBlYXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyLCBsaW5rZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgaXRlclN0YXJ0RWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBhdHRyLm5nUmVwZWF0OwogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKiguKylccytpblxzKyguKilccyokLyksCiAgICAgICAgICAgICAgICAgICAgbGhzLCByaHMsIHZhbHVlSWRlbnQsIGtleUlkZW50OwogICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBuZ1JlcGVhdCBpbiBmb3JtIG9mICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fJyBidXQgZ290ICciICsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiArICInLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGhzID0gbWF0Y2hbMV07CiAgICAgICAgICAgICAgICByaHMgPSBtYXRjaFsyXTsKICAgICAgICAgICAgICAgIG1hdGNoID0gbGhzLm1hdGNoKC9eKD86KFtcJFx3XSspfFwoKFtcJFx3XSspXHMqLFxzKihbXCRcd10rKVwpKSQvKTsKICAgICAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiJ2l0ZW0nIGluICdpdGVtIGluIGNvbGxlY3Rpb24nIHNob3VsZCBiZSBpZGVudGlmaWVyIG9yIChrZXksIHZhbHVlKSBidXQgZ290ICciICsKICAgICAgICAgICAgICAgICAgICAgICAgbGhzICsgIicuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZUlkZW50ID0gbWF0Y2hbM10gfHwgbWF0Y2hbMV07CiAgICAgICAgICAgICAgICBrZXlJZGVudCA9IG1hdGNoWzJdOwoKICAgICAgICAgICAgICAgIC8vIFN0b3JlIGEgbGlzdCBvZiBlbGVtZW50cyBmcm9tIHByZXZpb3VzIHJ1bi4gVGhpcyBpcyBhIGhhc2ggd2hlcmUga2V5IGlzIHRoZSBpdGVtIGZyb20gdGhlCiAgICAgICAgICAgICAgICAvLyBpdGVyYXRvciwgYW5kIHRoZSB2YWx1ZSBpcyBhbiBhcnJheSBvZiBvYmplY3RzIHdpdGggZm9sbG93aW5nIHByb3BlcnRpZXMuCiAgICAgICAgICAgICAgICAvLyAgIC0gc2NvcGU6IGJvdW5kIHNjb3BlCiAgICAgICAgICAgICAgICAvLyAgIC0gZWxlbWVudDogcHJldmlvdXMgZWxlbWVudC4KICAgICAgICAgICAgICAgIC8vICAgLSBpbmRleDogcG9zaXRpb24KICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgYW4gYXJyYXkgb2YgdGhlc2Ugb2JqZWN0cyBzaW5jZSB0aGUgc2FtZSBvYmplY3QgY2FuIGJlIHJldHVybmVkIGZyb20gdGhlIGl0ZXJhdG9yLgogICAgICAgICAgICAgICAgLy8gV2UgZXhwZWN0IHRoaXMgdG8gYmUgYSByYXJlIGNhc2UuCiAgICAgICAgICAgICAgICB2YXIgbGFzdE9yZGVyID0gbmV3IEhhc2hRdWV1ZU1hcCgpOwoKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ1JlcGVhdFdhdGNoKHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBzY29wZS4kZXZhbChyaHMpLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBpdGVyU3RhcnRFbGVtZW50LCAgICAgLy8gY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgbm9kZQogICAgICAgICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdE9yZGVyIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGxhc3RPcmRlciBvbiB0aGUgbmV4dCBpdGVyYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlciA9IG5ldyBIYXNoUXVldWVNYXAoKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlCb3VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDsgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpbmRleH0KCgogICAgICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBvYmplY3QsIGV4dHJhY3Qga2V5cywgc29ydCB0aGVtIGFuZCB1c2UgdG8gZGV0ZXJtaW5lIG9yZGVyIG9mIGl0ZXJhdGlvbiBvdmVyIG9iaiBwcm9wcwogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnNvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhcnJheSA9IGNvbGxlY3Rpb24gfHwgW107CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kID0gYXJyYXkubGVuZ3RoIC0gMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIG5vdCB1c2luZyBmb3JFYWNoIGZvciBwZXJmIHJlYXNvbnMgKHRyeWluZyB0byBhdm9pZCAjY2FsbCkKICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gYXJyYXkpID8gaW5kZXggOiBhcnJheVtpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IGxhc3RPcmRlci5zaGlmdCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhbHJlYWR5IHNlZW4gdGhpcyBvYmplY3QsIHRoZW4gd2UgbmVlZCB0byByZXVzZSB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc29jaWF0ZWQgc2NvcGUvZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IGxhc3Quc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0T3JkZXIucHVzaCh2YWx1ZSwgbGFzdCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSBsYXN0LmluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG8gbm90aGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGxhc3QuZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcgaXRlbSB3aGljaCBnb3QgbW92ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0LmluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtYXkgYmUgYSBub29wLCBpZiB0aGUgZWxlbWVudCBpcyBuZXh0LCBidXQgSSBkb24ndCBrbm93IG9mIGEgZ29vZCB3YXkgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmaWd1cmUgdGhpcyBvdXQsICBzaW5jZSBpdCB3b3VsZCByZXF1aXJlIGV4dHJhIERPTSBhY2Nlc3MsIHNvIGxldCdzIGp1c3QgaG9wZSB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGJyb3dzZXJzIHJlYWxpemVzIHRoYXQgaXQgaXMgbm9vcCwgYW5kIHRyZWF0cyBpdCBhcyBzdWNoLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihsYXN0LmVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGxhc3QuZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBpdGVtIHdoaWNoIHdlIGRvbid0IGtub3cgYWJvdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGVbdmFsdWVJZGVudF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleUlkZW50KSBjaGlsZFNjb3BlW2tleUlkZW50XSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kaW5kZXggPSBpbmRleDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGZpcnN0ID0gKGluZGV4ID09PSAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kbGFzdCA9IChpbmRleCA9PT0gYXJyYXlCb3VuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJG1pZGRsZSA9ICEoY2hpbGRTY29wZS4kZmlyc3QgfHwgY2hpbGRTY29wZS4kbGFzdCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtlcihjaGlsZFNjb3BlLCBmdW5jdGlvbiAoY2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IuYWZ0ZXIoY2xvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiAoY3Vyc29yID0gY2xvbmUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlci5wdXNoKHZhbHVlLCBsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvL3NocmluayBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGxhc3RPcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdE9yZGVyLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gbGFzdE9yZGVyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYXJyYXkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhcnJheS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxhc3RPcmRlciA9IG5leHRPcmRlcjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU2hvdwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1Nob3dgIGFuZCBgbmdIaWRlYCBkaXJlY3RpdmVzIHNob3cgb3IgaGlkZSBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogICAgICogY29uZGl0aW9uYWxseS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICAgICAqICAgICB0aGVuIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgU2hvdzogPHNwYW4gbmctc2hvdz0iY2hlY2tlZCI+SSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLjwvc3Bhbj4gPGJyLz4KICAgICBIaWRlOiA8c3BhbiBuZy1oaWRlPSJjaGVja2VkIj5JIGhpZGUgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCi8vVE9ETyhtaXNrbyk6IHJlZmFjdG9yIHRvIHJlbW92ZSBlbGVtZW50IGZyb20gdGhlIERPTQogICAgdmFyIG5nU2hvd0RpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU2hvdywgZnVuY3Rpb24gbmdTaG93V2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odmFsdWUpID8gJycgOiAnbm9uZScpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSGlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0hpZGVgIGFuZCBgbmdTaG93YCBkaXJlY3RpdmVzIGhpZGUgb3Igc2hvdyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogICAgICogY29uZGl0aW9uYWxseS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdIaWRlIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkgdGhlbgogICAgICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgU2hvdzogPHNwYW4gbmctc2hvdz0iY2hlY2tlZCI+SSBzaG93IHVwIHdoZW4geW91IGNoZWNrYm94IGlzIGNoZWNrZWQ/PC9zcGFuPiA8YnIvPgogICAgIEhpZGU6IDxzcGFuIG5nLWhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdSBjaGVja2JveCBpcyBjaGVja2VkPzwvc3Bhbj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CgogICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwovL1RPRE8obWlza28pOiByZWZhY3RvciB0byByZW1vdmUgZWxlbWVudCBmcm9tIHRoZSBET00KICAgIHZhciBuZ0hpZGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0hpZGUsIGZ1bmN0aW9uIG5nSGlkZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdkaXNwbGF5JywgdG9Cb29sZWFuKHZhbHVlKSA/ICdub25lJyA6ICcnKTsKICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3R5bGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdTdHlsZWAgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc2V0IENTUyBzdHlsZSBvbiBhbiBIVE1MIGVsZW1lbnQgY29uZGl0aW9uYWxseS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdHlsZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB3aGljaCBldmFscyB0byBhbgogICAgICogICAgICBvYmplY3Qgd2hvc2Uga2V5cyBhcmUgQ1NTIHN0eWxlIG5hbWVzIGFuZCB2YWx1ZXMgYXJlIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGZvciB0aG9zZSBDU1MKICAgICAqICAgICAga2V5cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVN0eWxlPXtjb2xvcjoncmVkJ30iPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15U3R5bGU9e30iPgogICAgIDxici8+CiAgICAgPHNwYW4gbmctc3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgIHNwYW4gewogICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN0eWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1zZXRdJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigyNTUsIDAsIDApJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b25bdmFsdWU9Y2xlYXJdJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigwLCAwLCAwKScpOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nU3R5bGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgICAgICAgICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24gKHZhbCwgc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNzcyhzdHlsZSwgJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld1N0eWxlcykgZWxlbWVudC5jc3MobmV3U3R5bGVzKTsKICAgICAgICB9LCB0cnVlKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3dpdGNoCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbmRpdGlvbmFsbHkgY2hhbmdlIHRoZSBET00gc3RydWN0dXJlLgogICAgICoKICAgICAqIEB1c2FnZQogICAgICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogICAgICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMSI+Li4uPC9BTlk+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L0FOWT4KICAgICAqICAgLi4uCiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLWRlZmF1bHQ+Li4uPC9BTlk+CiAgICAgKiA8L0FOWT4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBwYXJhbSB7Kn0gbmdTd2l0Y2h8b24gZXhwcmVzc2lvbiB0byBtYXRjaCBhZ2FpbnN0IDx0dD5uZy1zd2l0Y2gtd2hlbjwvdHQ+LgogICAgICogQHBhcmFtRGVzY3JpcHRpb24KICAgICAqIE9uIGNoaWxkIGVsbWVudHMgYWRkOgogICAgICoKICAgICAqICogYG5nU3dpdGNoV2hlbmA6IHRoZSBjYXNlIHN0YXRlbWVudCB0byBtYXRjaCBhZ2FpbnN0LiBJZiBtYXRjaCB0aGVuIHRoaXMKICAgICAqICAgY2FzZSB3aWxsIGJlIGRpc3BsYXllZC4KICAgICAqICogYG5nU3dpdGNoRGVmYXVsdGA6IHRoZSBkZWZhdWx0IGNhc2Ugd2hlbiBubyBvdGhlciBjYXNzZXMgbWF0Y2guCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUuaXRlbXMgPSBbJ3NldHRpbmdzJywgJ2hvbWUnLCAnb3RoZXInXTsKICAgICAgICAgICAgJHNjb3BlLnNlbGVjdGlvbiA9ICRzY29wZS5pdGVtc1swXTsKICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9InNlbGVjdGlvbiIgbmctb3B0aW9ucz0iaXRlbSBmb3IgaXRlbSBpbiBpdGVtcyI+CiAgICAgPC9zZWxlY3Q+CiAgICAgPHR0PnNlbGVjdGlvbj17e3NlbGVjdGlvbn19PC90dD4KICAgICA8aHIvPgogICAgIDxkaXYgbmctc3dpdGNoIG9uPSJzZWxlY3Rpb24iID4KICAgICA8ZGl2IG5nLXN3aXRjaC13aGVuPSJzZXR0aW5ncyI+U2V0dGluZ3MgRGl2PC9kaXY+CiAgICAgPHNwYW4gbmctc3dpdGNoLXdoZW49ImhvbWUiPkhvbWUgU3Bhbjwvc3Bhbj4KICAgICA8c3BhbiBuZy1zd2l0Y2gtZGVmYXVsdD5kZWZhdWx0PC9zcGFuPgogICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgc3RhcnQgaW4gc2V0dGluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9TZXR0aW5ncyBEaXYvKTsKICAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIGNoYW5nZSB0byBob21lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHNlbGVjdCgnc2VsZWN0aW9uJykub3B0aW9uKCdob21lJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvSG9tZSBTcGFuLyk7CiAgICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVhZmF1bHQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ290aGVyJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvZGVmYXVsdC8pOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBOR19TV0lUQ0ggPSAnbmctc3dpdGNoJzsKICAgIHZhciBuZ1N3aXRjaERpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgIHJlcXVpcmU6ICduZ1N3aXRjaCcsCiAgICAgICAgLy8gYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCBmdW5jdGlvbiBuZ1N3aXRjaENvbnRyb2xsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuY2FzZXMgPSB7fTsKICAgICAgICB9XSwKICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgdmFyIHdhdGNoRXhwciA9IGF0dHIubmdTd2l0Y2ggfHwgYXR0ci5vbiwKICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCwKICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGU7CgogICAgICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBzZWxlY3RlZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoc2VsZWN0ZWRUcmFuc2NsdWRlID0gY3RybC5jYXNlc1snIScgKyB2YWx1ZV0gfHwgY3RybC5jYXNlc1snPyddKSkgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIuY2hhbmdlKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZShzZWxlY3RlZFNjb3BlLCBmdW5jdGlvbiAoY2FzZUVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50ID0gY2FzZUVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGNhc2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgogICAgdmFyIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDUwMCwKICAgICAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gdHJhbnNjbHVkZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRycywgdHJhbnNjbHVkZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWyc/J10gPSB0cmFuc2NsdWRlOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nVHJhbnNjbHVkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSW5zZXJ0IHRoZSB0cmFuc2NsdWRlZCBET00gaGVyZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZSBtb2R1bGU9InRyYW5zY2x1ZGUiPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudGl0bGUgPSAnTG9yZW0gSXBzdW0nOwogICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgfQoKICAgICBhbmd1bGFyLm1vZHVsZSgndHJhbnNjbHVkZScsIFtdKQogICAgIC5kaXJlY3RpdmUoJ3BhbmUnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICAgICAgICAgc2NvcGU6ICdpc29sYXRlJywKICAgICAgICAgICAgICAgbG9jYWxzOiB7IHRpdGxlOidiaW5kJyB9LAogICAgICAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgc3R5bGU9ImJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOyI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiBncmF5Ij57e3RpdGxlfX08L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgICAgICB9OwogICAgICAgICB9KTsKICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCBuZy1tb2RlbD0idGl0bGUiPjxicj4KICAgICA8dGV4dGFyZWEgbmctbW9kZWw9InRleHQiPjwvdGV4dGFyZWE+IDxici8+CiAgICAgPHBhbmUgdGl0bGU9Int7dGl0bGV9fSI+e3t0ZXh0fX08L3BhbmU+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBoYXZlIHRyYW5zY2x1ZGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndGl0bGUnKS5lbnRlcignVElUTEUnKTsKICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ1RFWFQnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0aXRsZScpKS50b0VxdWFsKCdUSVRMRScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnVEVYVCcpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgbmdUcmFuc2NsdWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbnRyb2xsZXI6IFsnJHRyYW5zY2x1ZGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbiAoJHRyYW5zY2x1ZGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfV0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQHJlc3RyaWN0IEVDQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogIyBPdmVydmlldwogICAgICogYG5nVmlld2AgaXMgYSBkaXJlY3RpdmUgdGhhdCBjb21wbGVtZW50cyB0aGUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UgYnkKICAgICAqIGluY2x1ZGluZyB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb2YgdGhlIGN1cnJlbnQgcm91dGUgaW50byB0aGUgbWFpbiBsYXlvdXQgKGBpbmRleC5odG1sYCkgZmlsZS4KICAgICAqIEV2ZXJ5IHRpbWUgdGhlIGN1cnJlbnQgcm91dGUgY2hhbmdlcywgdGhlIGluY2x1ZGVkIHZpZXcgY2hhbmdlcyB3aXRoIGl0IGFjY29yZGluZyB0byB0aGUKICAgICAqIGNvbmZpZ3VyYXRpb24gb2YgdGhlIGAkcm91dGVgIHNlcnZpY2UuCiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG1vZHVsZT0ibmdWaWV3Ij4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik1haW5DbnRsIj4KICAgICBDaG9vc2U6CiAgICAgPGEgaHJlZj0iQm9vay9Nb2J5Ij5Nb2J5PC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9Nb2J5L2NoLzEiPk1vYnk6IENoMTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5Ij5HYXRzYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL0dhdHNieS9jaC80P2tleT12YWx1ZSI+R2F0c2J5OiBDaDQ8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL1NjYXJsZXQiPlNjYXJsZXQgTGV0dGVyPC9hPjxici8+CgogICAgIDxkaXYgbmctdmlldz48L2Rpdj4KICAgICA8aHIgLz4KCiAgICAgPHByZT4kbG9jYXRpb24ucGF0aCgpID0ge3skbG9jYXRpb24ucGF0aCgpfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsID0ge3skcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybH19PC9wcmU+CiAgICAgPHByZT4kcm91dGUuY3VycmVudC5wYXJhbXMgPSB7eyRyb3V0ZS5jdXJyZW50LnBhcmFtc319PC9wcmU+CiAgICAgPHByZT4kcm91dGUuY3VycmVudC5zY29wZS5uYW1lID0ge3skcm91dGUuY3VycmVudC5zY29wZS5uYW1lfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZVBhcmFtcyA9IHt7JHJvdXRlUGFyYW1zfX08L3ByZT4KICAgICA8L2Rpdj4KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9ImJvb2suaHRtbCI+CiAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iY2hhcHRlci5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgQ2hhcHRlciBJZDoge3twYXJhbXMuY2hhcHRlcklkfX0KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgYW5ndWxhci5tb2R1bGUoJ25nVmlldycsIFtdLCBmdW5jdGlvbigkcm91dGVQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIpIHsKICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQm9va0NudGwKICAgICAgICAgIH0pOwogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZC9jaC86Y2hhcHRlcklkJywgewogICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ2NoYXB0ZXIuaHRtbCcsCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBjb25maWd1cmUgaHRtbDUgdG8gZ2V0IGxpbmtzIHdvcmtpbmcgb24ganNmaWRkbGUKICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICB9KTsKCiAgICAgZnVuY3Rpb24gTWFpbkNudGwoJHNjb3BlLCAkcm91dGUsICRyb3V0ZVBhcmFtcywgJGxvY2F0aW9uKSB7CiAgICAgICAgICAkc2NvcGUuJHJvdXRlID0gJHJvdXRlOwogICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICRzY29wZS4kcm91dGVQYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQoKICAgICBmdW5jdGlvbiBCb29rQ250bCgkc2NvcGUsICRyb3V0ZVBhcmFtcykgewogICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIENoYXB0ZXJDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KICAgICA8L2ZpbGU+CgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGxvYWQgYW5kIGNvbXBpbGUgY29ycmVjdCB0ZW1wbGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgdmFyIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IENoYXB0ZXJDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9DaGFwdGVyIElkXDogMS8pOwoKICAgICAgICAgIGVsZW1lbnQoJ2E6Y29udGFpbnMoIlNjYXJsZXQiKScpLmNsaWNrKCk7CiAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL2NvbnRyb2xsZXJcOiBCb29rQ250bC8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0Jvb2sgSWRcOiBTY2FybGV0Lyk7CiAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nVmlldyMkdmlld0NvbnRlbnRMb2FkZWQKICAgICAqIEBldmVudE9mIG5nLmRpcmVjdGl2ZTpuZ1ZpZXcKICAgICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgY3VycmVudCBuZ1ZpZXcgc2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ1ZpZXcgY29udGVudCBpcyByZWxvYWRlZC4KICAgICAqLwogICAgdmFyIG5nVmlld0RpcmVjdGl2ZSA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJHJvdXRlJywgJyRhbmNob3JTY3JvbGwnLCAnJGNvbXBpbGUnLAogICAgICAgICckY29udHJvbGxlcicsCiAgICAgICAgZnVuY3Rpb24gKCRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHJvdXRlLCAkYW5jaG9yU2Nyb2xsLCAkY29tcGlsZSwgJGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICAgICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJyc7CgogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRvbignJHJvdXRlQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlKCk7CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95TGFzdFNjb3BlKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGVudCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzdHJveUxhc3RTY29wZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jYWxzID0gJHJvdXRlLmN1cnJlbnQgJiYgJHJvdXRlLmN1cnJlbnQubG9jYWxzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBsb2NhbHMgJiYgbG9jYWxzLiR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lMYXN0U2NvcGUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluayA9ICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9ICRyb3V0ZS5jdXJyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlID0gY3VycmVudC5zY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50LmNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMuJHNjb3BlID0gbGFzdFNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSAkY29udHJvbGxlcihjdXJyZW50LmNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGlsZHJlbigpLmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluayhsYXN0U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRlbWl0KCckdmlld0NvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZXZhbChvbmxvYWRFeHApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICRhbmNob3JTY3JvbGwgbWlnaHQgbGlzdGVuIG9uIGV2ZW50Li4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpzY3JpcHQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIExvYWQgY29udGVudCBvZiBhIHNjcmlwdCB0YWcsIHdpdGggdHlwZSBgdGV4dC9uZy10ZW1wbGF0ZWAsIGludG8gYCR0ZW1wbGF0ZUNhY2hlYCwgc28gdGhhdCB0aGUKICAgICAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IGBuZ0luY2x1ZGVgLCBgbmdWaWV3YCBvciBkaXJlY3RpdmUgdGVtcGxhdGVzLgogICAgICoKICAgICAqIEByZXN0cmljdCBFCiAgICAgKiBAcGFyYW0geyd0ZXh0L25nLXRlbXBsYXRlJ30gdHlwZSBtdXN0IGJlIHNldCB0byBgJ3RleHQvbmctdGVtcGxhdGUnYAogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9Ii90cGwuaHRtbCI+CiAgICAgQ29udGVudCBvZiB0aGUgdGVtcGxhdGUuCiAgICAgPC9zY3JpcHQ+CgogICAgIDxhIG5nLWNsaWNrPSJjdXJyZW50VHBsPScvdHBsLmh0bWwnIiBpZD0idHBsLWxpbmsiPkxvYWQgaW5saW5lZCB0ZW1wbGF0ZTwvYT4KICAgICA8ZGl2IGlkPSJ0cGwtY29udGVudCIgbmctaW5jbHVkZSBzcmM9ImN1cnJlbnRUcGwiPjwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZSBkZWZpbmVkIGluc2lkZSBzY3JpcHQgdGFnJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZWxlbWVudCgnI3RwbC1saW5rJykuY2xpY2soKTsKICAgICAgICBleHBlY3QoZWxlbWVudCgnI3RwbC1jb250ZW50JykudGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgc2NyaXB0RGlyZWN0aXZlID0gWyckdGVtcGxhdGVDYWNoZScsIGZ1bmN0aW9uICgkdGVtcGxhdGVDYWNoZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgaWYgKGF0dHIudHlwZSA9PSAndGV4dC9uZy10ZW1wbGF0ZScpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVVcmwgPSBhdHRyLmlkLAogICAgICAgICAgICAgICAgICAgIC8vIElFIGlzIG5vdCBjb25zaXN0ZW50LCBpbiBzY3JpcHRzIHdlIGhhdmUgdG8gcmVhZCAudGV4dCBidXQgaW4gb3RoZXIgbm9kZXMgd2UgaGF2ZSB0byByZWFkIC50ZXh0Q29udGVudAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZWxlbWVudFswXS50ZXh0OwoKICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGVVcmwsIHRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNlbGVjdAogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgYFNFTEVDVGAgZWxlbWVudCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLgogICAgICoKICAgICAqICMgYG5nT3B0aW9uc2AKICAgICAqCiAgICAgKiBPcHRpb25hbGx5IGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogICAgICogZWxlbWVudHMgZm9yIGEgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIGFuIGFycmF5IG9yIGFuIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZQogICAgICogYG5nT3B0aW9uc2AgZXhwcmVzc2lvbi4KICAgICAqy53LnQogICAgICogV2hlbiBhbiBpdGVtIGluIHRoZSBzZWxlY3QgbWVudSBpcyBzZWxlY3QsIHRoZSB2YWx1ZSBvZiBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogICAgICogcmVwcmVzZW50ZWQgYnkgdGhlIHNlbGVjdGVkIG9wdGlvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBpZGVudGlmaWVkIGJ5IHRoZSBgbmdNb2RlbGAKICAgICAqIGRpcmVjdGl2ZSBvZiB0aGUgcGFyZW50IHNlbGVjdCBlbGVtZW50LgogICAgICoKICAgICAqIE9wdGlvbmFsbHksIGEgc2luZ2xlIGhhcmQtY29kZWQgYDxvcHRpb24+YCBlbGVtZW50LCB3aXRoIHRoZSB2YWx1ZSBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nLCBjYW4KICAgICAqIGJlIG5lc3RlZCBpbnRvIHRoZSBgPHNlbGVjdD5gIGVsZW1lbnQuIFRoaXMgZWxlbWVudCB3aWxsIHRoZW4gcmVwcmVzZW50IGBudWxsYCBvciAibm90IHNlbGVjdGVkIgogICAgICogb3B0aW9uLiBTZWUgZXhhbXBsZSBiZWxvdyBmb3IgZGVtb25zdHJhdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBgbmdPcHRpb25zYCBwcm92aWRlcyBpdGVyYXRvciBmYWNpbGl0eSBmb3IgYDxvcHRpb24+YCBlbGVtZW50IHdoaWNoIHNob3VsZCBiZSB1c2VkIGluc3RlYWQKICAgICAqIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IHdoZW4geW91IHdhbnQgdGhlCiAgICAgKiBgc2VsZWN0YCBtb2RlbCB0byBiZSBib3VuZCB0byBhIG5vbi1zdHJpbmcgdmFsdWUuIFRoaXMgaXMgYmVjYXVzZSBhbiBvcHRpb24gZWxlbWVudCBjYW4gY3VycmVudGx5CiAgICAgKiBiZSBib3VuZCB0byBzdHJpbmcgdmFsdWVzIG9ubHkuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBUaGUgY29udHJvbCBpcyBjb25zaWRlcmVkIHZhbGlkIG9ubHkgaWYgdmFsdWUgaXMgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtjb21wcmVoZW5zaW9uX2V4cHJlc3Npb249fSBuZ09wdGlvbnMgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybXM6CiAgICAgKgogICAgICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAqIGZvciBvYmplY3QgZGF0YSBzb3VyY2VzOgogICAgICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yIChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogICAgICogICAgICAgICAqKmBmb3JgIGAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICAgKgogICAgICogV2hlcmU6CiAgICAgKgogICAgICogICAqIGBhcnJheWAgLyBgb2JqZWN0YDogYW4gZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gYXJyYXkgLyBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICAgICAqICAgICAgb2YgYG9iamVjdGAgZHVyaW5nIGl0ZXJhdGlvbi4KICAgICAqICAgKiBga2V5YDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBhIHByb3BlcnR5IG5hbWUgaW4gYG9iamVjdGAgZHVyaW5nIGl0ZXJhdGlvbi4KICAgICAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICAgICAqICAgICBgZXhwcmVzc2lvbmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUgYHZhbHVlYCB2YXJpYWJsZSAoZS5nLiBgdmFsdWUucHJvcGVydHlOYW1lYCkuCiAgICAgKiAgICogYHNlbGVjdGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIG9mIHRoZSBwYXJlbnQgYDxzZWxlY3Q+YAogICAgICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogICAgICogICAqIGBncm91cGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdXNlZCB0byBncm91cCBvcHRpb25zIHVzaW5nIHRoZSBgPG9wdGdyb3VwPmAKICAgICAqICAgICAgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBNeUNudHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmNvbG9ycyA9IFsKICAgICAgICAgICAge25hbWU6J2JsYWNrJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3doaXRlJywgc2hhZGU6J2xpZ2h0J30sCiAgICAgICAgICAgIHtuYW1lOidyZWQnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTonYmx1ZScsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid5ZWxsb3cnLCBzaGFkZTonbGlnaHQnfQogICAgICAgICAgXTsKICAgICAgICAgICRzY29wZS5jb2xvciA9ICRzY29wZS5jb2xvcnNbMl07IC8vIHJlZAogICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik15Q250cmwiPgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJjb2xvciBpbiBjb2xvcnMiPgogICAgIE5hbWU6IDxpbnB1dCBuZy1tb2RlbD0iY29sb3IubmFtZSI+CiAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5zcGxpY2UoJGluZGV4LCAxKSI+WDwvYT5dCiAgICAgPC9saT4KICAgICA8bGk+CiAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5wdXNoKHt9KSI+YWRkPC9hPl0KICAgICA8L2xpPgogICAgIDwvdWw+CiAgICAgPGhyLz4KICAgICBDb2xvciAobnVsbCBub3QgYWxsb3dlZCk6CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29sb3IiIG5nLW9wdGlvbnM9ImMubmFtZSBmb3IgYyBpbiBjb2xvcnMiPjwvc2VsZWN0Pjxicj4KCiAgICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgICAgPHNwYW4gIGNsYXNzPSJudWxsYWJsZSI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29sb3IiIG5nLW9wdGlvbnM9ImMubmFtZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgIDxvcHRpb24gdmFsdWU9IiI+LS0gY2hvc2UgY29sb3IgLS08L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L3NwYW4+PGJyLz4KCiAgICAgQ29sb3IgZ3JvdXBlZCBieSBzaGFkZToKICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGdyb3VwIGJ5IGMuc2hhZGUgZm9yIGMgaW4gY29sb3JzIj4KICAgICA8L3NlbGVjdD48YnIvPgoKCiAgICAgU2VsZWN0IDxhIGhyZWYgbmctY2xpY2s9ImNvbG9yPXtuYW1lOidub3QgaW4gbGlzdCd9Ij5ib2d1czwvYT4uPGJyPgogICAgIDxoci8+CiAgICAgQ3VycmVudGx5IHNlbGVjdGVkOiB7eyB7c2VsZWN0ZWRfY29sb3I6Y29sb3J9ICB9fQogICAgIDxkaXYgc3R5bGU9ImJvcmRlcjpzb2xpZCAxcHggYmxhY2s7IGhlaWdodDoyMHB4IgogICAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOmNvbG9yLm5hbWV9Ij4KICAgICA8L2Rpdj4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLW9wdGlvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdyZWQnKTsKICAgICAgICAgICBzZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcwJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgnYmxhY2snKTsKICAgICAgICAgICB1c2luZygnLm51bGxhYmxlJykuc2VsZWN0KCdjb2xvcicpLm9wdGlvbignJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgdmFyIG5nT3B0aW9uc0RpcmVjdGl2ZSA9IHZhbHVlRm4oeyB0ZXJtaW5hbDogdHJ1ZSB9KTsKICAgIHZhciBzZWxlY3REaXJlY3RpdmUgPSBbJyRjb21waWxlJywgJyRwYXJzZScsIGZ1bmN0aW9uICgkY29tcGlsZSwgJHBhcnNlKSB7CiAgICAgICAgLy8wMDAwMTExMTEwMDAwMDAwMDAwMDIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMzMzMzAwMDAwMDAwMDAwMDAwNDQ0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTU1NTAwMDAwMDA2NjY2NjY2NjY2NjY2NjY2NjAwMDAwMDAwMDAwMDAwMDc3NzcwCiAgICAgICAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooLio/KSg/OlxzK2FzXHMrKC4qPykpPyg/OlxzK2dyb3VwXHMrYnlccysoLiopKT9ccytmb3JccysoPzooW1wkXHddW1wkXHdcZF0qKXwoPzpcKFxzKihbXCRcd11bXCRcd1xkXSopXHMqLFxzKihbXCRcd11bXCRcd1xkXSopXHMqXCkpKVxzK2luXHMrKC4qKSQvLAogICAgICAgICAgICBudWxsTW9kZWxDdHJsID0geyRzZXRWaWV3VmFsdWU6IG5vb3B9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiBbJ3NlbGVjdCcsICc/bmdNb2RlbCddLAogICAgICAgICAgICBjb250cm9sbGVyOiBbJyRlbGVtZW50JywgJyRzY29wZScsICckYXR0cnMnLCBmdW5jdGlvbiAoJGVsZW1lbnQsICRzY29wZSwgJGF0dHJzKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc01hcCA9IHt9LAogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gbnVsbE1vZGVsQ3RybCwKICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb247CgoKICAgICAgICAgICAgICAgIHNlbGYuZGF0YWJvdW5kID0gJGF0dHJzLm5nTW9kZWw7CgoKICAgICAgICAgICAgICAgIHNlbGYuaW5pdCA9IGZ1bmN0aW9uIChuZ01vZGVsQ3RybF8sIG51bGxPcHRpb25fLCB1bmtub3duT3B0aW9uXykgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uID0gdW5rbm93bk9wdGlvbl87CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuYWRkT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc01hcFt2YWx1ZV0gPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKCiAgICAgICAgICAgICAgICBzZWxmLnJlbW92ZU9wdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc09wdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnNNYXBbdmFsdWVdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJVbmtub3duT3B0aW9uKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnByZXBlbmQodW5rbm93bk9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBzZWxmLmhhc09wdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zTWFwLmhhc093blByb3BlcnR5KHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBkaXNhYmxlIHVua25vd24gb3B0aW9uIHNvIHRoYXQgd2UgZG9uJ3QgZG8gd29yayB3aGVuIHRoZSB3aG9sZSBzZWxlY3QgaXMgYmVpbmcgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gbm9vcDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICAgIC8vIGlmIG5nTW9kZWwgaXMgbm90IGRlZmluZWQsIHdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcKICAgICAgICAgICAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsID0gY3RybHNbMV0sCiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBhdHRyLm11bHRpcGxlLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNFeHAgPSBhdHRyLm5nT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uID0gZmFsc2UsIC8vIGlmIGZhbHNlLCB1c2VyIHdpbGwgbm90IGJlIGFibGUgdG8gc2VsZWN0IGl0ICh1c2VkIGJ5IG5nT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiwKICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgICAgICAgICAgICBvcHRpb25UZW1wbGF0ZSA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSksCiAgICAgICAgICAgICAgICAgICAgb3B0R3JvdXBUZW1wbGF0ZSA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRncm91cCcpKSwKICAgICAgICAgICAgICAgICAgICB1bmtub3duT3B0aW9uID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKTsKCiAgICAgICAgICAgICAgICAvLyBmaW5kICJudWxsIiBvcHRpb24KICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSwgaWkgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuW2ldLnZhbHVlID09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uID0gbnVsbE9wdGlvbiA9IGNoaWxkcmVuLmVxKGkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5pbml0KG5nTW9kZWxDdHJsLCBudWxsT3B0aW9uLCB1bmtub3duT3B0aW9uKTsKCiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCB2YWxpZGF0b3IKICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSAmJiAoYXR0ci5yZXF1aXJlZCB8fCBhdHRyLm5nUmVxdWlyZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcXVpcmVkVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCAhYXR0ci5yZXF1aXJlZCB8fCAodmFsdWUgJiYgdmFsdWUubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kcGFyc2Vycy5wdXNoKHJlcXVpcmVkVmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kZm9ybWF0dGVycy51bnNoaWZ0KHJlcXVpcmVkVmFsaWRhdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkVmFsaWRhdG9yKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zRXhwKSBPcHRpb25zKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChtdWx0aXBsZSkgTXVsdGlwbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgU2luZ2xlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCwgc2VsZWN0Q3RybCk7CgoKICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2luZ2xlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBuZ01vZGVsQ3RybCwgc2VsZWN0Q3RybCkgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2aWV3VmFsdWUgPSBuZ01vZGVsQ3RybC4kdmlld1ZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdEN0cmwuaGFzT3B0aW9uKHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC52YWwodmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3VmFsdWUgPT09ICcnKSBlbXB0eU9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyB0byBtYWtlIElFOSBoYXBweQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkgJiYgZW1wdHlPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVuZGVyVW5rbm93bk9wdGlvbih2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE11bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zID0gbmV3IEhhc2hNYXAoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBpc0RlZmluZWQoaXRlbXMuZ2V0KG9wdGlvbi52YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byB3b3JrIG9mIGFuIGFycmF5LCBzbyB3ZSBuZWVkIHRvIHNlZSBpZiBhbnl0aGluZyB3YXMgaW5zZXJ0ZWQvcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZpZXcgPSBjb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKG9wdGlvbi52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBPcHRpb25zKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIShtYXRjaCA9IG9wdGlvbnNFeHAubWF0Y2goTkdfT1BUSU9OU19SRUdFWFApKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJFeHBlY3RlZCBuZ09wdGlvbnMgaW4gZm9ybSBvZiAnX3NlbGVjdF8gKGFzIF9sYWJlbF8pPyBmb3IgKF9rZXlfLCk/X3ZhbHVlXyBpbiBfY29sbGVjdGlvbl8nIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgZ290ICciICsgb3B0aW9uc0V4cCArICInLiIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BsYXlGbiA9ICRwYXJzZShtYXRjaFsyXSB8fCBtYXRjaFsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlTmFtZSA9IG1hdGNoWzRdIHx8IG1hdGNoWzZdLAogICAgICAgICAgICAgICAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwQnlGbiA9ICRwYXJzZShtYXRjaFszXSB8fCAnJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IG9mIGFycmF5IG9mIGV4aXN0aW5nIG9wdGlvbiBncm91cHMgaW4gRE9NLiBXZSB0cnkgdG8gcmV1c2UgdGhlc2UgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWz9dWzBdIGlzIHRoZSBwYXJlbnQ6IGVpdGhlciB0aGUgU0VMRUNUIG9yIE9QVEdST1VQIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2VsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOiAnJ30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG51bGxPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgZWxlbWVudCBzaW5jZSB0aGVyZSBtaWdodCBiZSBiaW5kaW5ncyBpbiBpdAogICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZShudWxsT3B0aW9uKShzY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGNsYXNzLCB3aGljaCBpcyBhZGRlZCBhdXRvbWF0aWNhbGx5IGJlY2F1c2Ugd2UgcmVjb21waWxlIHRoZSBlbGVtZW50IGFuZCBpdAogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWNvbWVzIHRoZSBjb21waWxhdGlvbiByb290CiAgICAgICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24ucmVtb3ZlQ2xhc3MoJ25nLXNjb3BlJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHJlbW92ZSBpdCBiZWZvcmUgY2FsbGluZyBzZWxlY3RFbGVtZW50Lmh0bWwoJycpIGJlY2F1c2Ugb3RoZXJ3aXNlIElFIHdpbGwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBsYWJlbCBmcm9tIHRoZSBlbGVtZW50LiB3dGY/CiAgICAgICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBjbGVhciBjb250ZW50cywgd2UnbGwgYWRkIHdoYXQncyBuZWVkZWQgYmFzZWQgb24gdGhlIG1vZGVsCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5odG1sKCcnKTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5iaW5kKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCBvcHRpb25FbGVtZW50LCBpbmRleCwgZ3JvdXBJbmRleCwgbGVuZ3RoLCBncm91cExlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMSwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChvcHRpb25FbGVtZW50ID0gb3B0aW9uR3JvdXBbaW5kZXhdLmVsZW1lbnQpWzBdLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gb3B0aW9uRWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2godmFsdWVGbihzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IHJlbmRlcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNhbid0IHdlIG9wdGltaXplIHRoaXMgPwogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChyZW5kZXIpOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cHMgPSB7Jyc6IFtdfSwgLy8gVGVtcG9yYXJ5IGxvY2F0aW9uIGZvciB0aGUgb3B0aW9uIGdyb3VwcyBiZWZvcmUgd2UgcmVuZGVyIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMgPSBbJyddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCwgZXhpc3RpbmdPcHRpb25zLCBleGlzdGluZ09wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5cyA9IGtleU5hbWUgPyBzb3J0ZWRLZXlzKHZhbHVlcykgOiB2YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cExlbmd0aCwgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCwgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBmYWxzZSwgLy8gbm90aGluZyBpcyBzZWxlY3RlZCB5ZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5TmFtZSA/IGxvY2Fsc1trZXlOYW1lXSA9IGtleXNbaW5kZXhdIDogaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gZ3JvdXBCeUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcy5wdXNoKG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IHNlbGVjdGVkU2V0LnJlbW92ZSh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKSAhPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gbW9kZWxWYWx1ZSA9PT0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IHNlbGVjdGVkU2V0IHx8IHNlbGVjdGVkOyAvLyBzZWUgaWYgYXQgbGVhc3Qgb25lIGl0ZW0gaXMgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gZGlzcGxheUZuKHNjb3BlLCBsb2NhbHMpOyAvLyB3aGF0IHdpbGwgYmUgc2VlbiBieSB0aGUgdXNlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBsYWJlbCA9PT0gdW5kZWZpbmVkID8gJycgOiBsYWJlbDsgLy8gZG9pbmcgZGlzcGxheUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnIG92ZXJ3cml0ZXMgemVybyB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBrZXlOYW1lID8ga2V5c1tpbmRleF0gOiBpbmRleCwgICAvLyBlaXRoZXIgdGhlIGluZGV4IGludG8gYXJyYXkgb3Iga2V5IGZyb20gb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbiB8fCBtb2RlbFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5zZXJ0IG51bGwgb3B0aW9uIGlmIHdlIGhhdmUgYSBwbGFjZWhvbGRlciwgb3IgdGhlIG1vZGVsIGlzIG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOiAnJywgbGFiZWw6ICcnLCBzZWxlY3RlZDogIXNlbGVjdGVkU2V0fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzZWxlY3RlZFNldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbiBjb3VsZCBub3QgYmUgZm91bmQsIHdlIGhhdmUgdG8gaW5zZXJ0IHRoZSB1bmRlZmluZWQgaXRlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6ICc/JywgbGFiZWw6ICcnLCBzZWxlY3RlZDogdHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byB1cGRhdGUgdGhlIGxpc3Qgb2YgRE9NIG5vZGVzIHRvIG1hdGNoIHRoZSBvcHRpb25Hcm91cHMgd2UgY29tcHV0ZWQgYWJvdmUKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cE5hbWVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjdXJyZW50IG9wdGlvbiBncm91cCBuYW1lIG9yICcnIGlmIG5vIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBvcHRpb25Hcm91cE5hbWVzW2dyb3VwSW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPD0gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZ3JvdyB0aGUgb3B0aW9uR3JvdXBzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG9wdEdyb3VwVGVtcGxhdGUuY2xvbmUoKS5hdHRyKCdsYWJlbCcsIG9wdGlvbkdyb3VwTmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25Hcm91cC5sYWJlbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gW2V4aXN0aW5nUGFyZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wdXNoKGV4aXN0aW5nT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQoZXhpc3RpbmdQYXJlbnQuZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gZXhpc3RpbmdPcHRpb25zWzBdOyAgLy8gZWl0aGVyIFNFTEVDVCAobm8gZ3JvdXApIG9yIE9QVEdST1VQIGVsZW1lbnQKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUGFyZW50LmxhYmVsICE9IG9wdGlvbkdyb3VwTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmF0dHIoJ2xhYmVsJywgZXhpc3RpbmdQYXJlbnQubGFiZWwgPSBvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IG51bGw7ICAvLyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMCwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGV4aXN0aW5nT3B0aW9uID0gZXhpc3RpbmdPcHRpb25zW2luZGV4ICsgMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldXNlIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZXhpc3RpbmdPcHRpb24uZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmxhYmVsICE9PSBvcHRpb24ubGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnRleHQoZXhpc3RpbmdPcHRpb24ubGFiZWwgPSBvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5pZCAhPT0gb3B0aW9uLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC52YWwoZXhpc3RpbmdPcHRpb24uaWQgPSBvcHRpb24uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxhc3RFbGVtZW50LnByb3AoJ3NlbGVjdGVkJykgcHJvdmlkZWQgYnkgalF1ZXJ5IGhhcyBzaWRlLWVmZmVjdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50WzBdLnNlbGVjdGVkICE9PSBvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgKGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkID0gb3B0aW9uLnNlbGVjdGVkKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBncm93IGVsZW1lbnRzCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBpdCdzIGEgbnVsbCBvcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5pZCA9PT0gJycgJiYgbnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHV0IGJhY2sgdGhlIHByZS1jb21waWxlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gbnVsbE9wdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGpRdWVyeSh2MS40LjIpIEJ1ZzogV2Ugc2hvdWxkIGJlIGFibGUgdG8gY2hhaW4gdGhlIG1ldGhvZCBjYWxscywgYnV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5IG9uIHNvbWUgYnJvd3NlciB0aGUgLnRleHQoKSByZXR1cm5zIGEgc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByYXRoZXIgdGhlbiB0aGUgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50ID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudmFsKG9wdGlvbi5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignc2VsZWN0ZWQnLCBvcHRpb24uc2VsZWN0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRleHQob3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnB1c2goZXhpc3RpbmdPcHRpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbi5sYWJlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBvcHRpb24uaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogb3B0aW9uLnNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFmdGVyKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGV4aXN0aW5nT3B0aW9ucy5sZW5ndGggPiBpbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wb3AoKS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVEdST1VQcyBmcm9tIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoID4gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uICgkaW50ZXJwb2xhdGUpIHsKICAgICAgICB2YXIgbnVsbFNlbGVjdEN0cmwgPSB7CiAgICAgICAgICAgIGFkZE9wdGlvbjogbm9vcCwKICAgICAgICAgICAgcmVtb3ZlT3B0aW9uOiBub29wCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChhdHRyLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQudGV4dCgpLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIGVsZW1lbnQudGV4dCgpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsTmFtZSA9ICckc2VsZWN0Q29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50KCksCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBwYXJlbnQuZGF0YShzZWxlY3RDdHJsTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5wYXJlbnQoKS5kYXRhKHNlbGVjdEN0cmxOYW1lKTsgLy8gaW4gY2FzZSB3ZSBhcmUgaW4gb3B0Z3JvdXAKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdEN0cmwgJiYgc2VsZWN0Q3RybC5kYXRhYm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIE9wZXJhIGRlZmF1bHRzIHRvIHRydWUgYW5kIGlmIG5vdCBvdmVycmlkZGVuIHRoaXMgbWVzc2VzIHVwIHRoZSByZXBlYXRlci4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0aGUgdmlldyB0byBkcml2ZSB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIG1vZGVsIGFueXdheS4KICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsID0gbnVsbFNlbGVjdEN0cmw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVXYXRjaEFjdGlvbihuZXdWYWwsIG9sZFZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VmFsICE9PSBvbGRWYWwpIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKG9sZFZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihuZXdWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVybWluYWw6IHRydWUKICAgIH0pOwoKICAgIC8qKgogICAgICogU2V0dXAgZmlsZSBmb3IgdGhlIFNjZW5hcmlvLgogICAgICogTXVzdCBiZSBmaXJzdCBpbiB0aGUgY29tcGlsYXRpb24vYm9vdHN0cmFwIGxpc3QuCiAgICAgKi8KCi8vIFB1YmxpYyBuYW1lc3BhY2UKICAgIGFuZ3VsYXIuc2NlbmFyaW8gPSBhbmd1bGFyLnNjZW5hcmlvIHx8IHt9OwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIG5ldyBvdXRwdXQgZm9ybWF0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSBuZXcgb3V0cHV0IGZvcm1hdAogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIpIHRoYXQgZ2VuZXJhdGVzIHRoZSBvdXRwdXQKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXQgPSBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCB8fCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgICAgICBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dFtuYW1lXSA9IGZuOwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBuZXcgRFNMIHN0YXRlbWVudC4gSWYgeW91ciBmYWN0b3J5IGZ1bmN0aW9uIHJldHVybnMgYSBGdXR1cmUKICAgICAqIGl0J3MgcmV0dXJuZWQsIG90aGVyd2lzZSB0aGUgcmVzdWx0IGlzIGFzc3VtZWQgdG8gYmUgYSBtYXAgb2YgZnVuY3Rpb25zCiAgICAgKiBmb3IgY2hhaW5pbmcuIENoYWluZWQgZnVuY3Rpb25zIGFyZSBzdWJqZWN0IHRvIHRoZSBzYW1lIHJ1bGVzLgogICAgICoKICAgICAqIE5vdGU6IEFsbCBmdW5jdGlvbnMgb24gdGhlIGNoYWluIGFyZSBib3VuZCB0byB0aGUgY2hhaW4gc2NvcGUgc28gdmFsdWVzCiAgICAgKiAgIHNldCBvbiAidGhpcyIgaW4geW91ciBzdGF0ZW1lbnQgZnVuY3Rpb24gYXJlIGF2YWlsYWJsZSBpbiB0aGUgY2hhaW5lZAogICAgICogICBmdW5jdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHN0YXRlbWVudAogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGYWN0b3J5IGZ1bmN0aW9uKCksIHJldHVybiBhIGZ1bmN0aW9uIGZvcgogICAgICogIHRoZSBzdGF0ZW1lbnQuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsID0gYW5ndWxhci5zY2VuYXJpby5kc2wgfHwgZnVuY3Rpb24gKG5hbWUsIGZuKSB7CiAgICAgICAgYW5ndWxhci5zY2VuYXJpby5kc2xbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVTdGF0ZW1lbnQoc3RhdGVtZW50LCBhcmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gc3RhdGVtZW50LmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbihyZXN1bHQpIHx8IHJlc3VsdCBpbnN0YW5jZW9mIGFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlKQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgY2hhaW4gPSBhbmd1bGFyLmV4dGVuZCh7fSwgcmVzdWx0KTsKICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChjaGFpbiwgZnVuY3Rpb24gKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW5bbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVN0YXRlbWVudC5jYWxsKHNlbGYsIHZhbHVlLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYWluW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4ZWN1dGVTdGF0ZW1lbnQuY2FsbCh0aGlzLCBzdGF0ZW1lbnQsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgbmV3IG1hdGNoZXIgZm9yIHVzZSB3aXRoIHRoZSBleHBlY3RzKCkgc3RhdGVtZW50LiBUaGUgdmFsdWUKICAgICAqIHRoaXMuYWN0dWFsIChsaWtlIGluIEphc21pbmUpIGlzIGF2YWlsYWJsZSBpbiB5b3VyIG1hdGNoZXIgdG8gY29tcGFyZQogICAgICogYWdhaW5zdC4gWW91ciBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGEgYm9vbGVhbi4gVGhlIGZ1dHVyZSBpcyBhdXRvbWF0aWNhbGx5CiAgICAgKiBjcmVhdGVkIGZvciB5b3UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1hdGNoZXIKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gVGhlIG1hdGNoaW5nIGZ1bmN0aW9uKGV4cGVjdGVkKS4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyID0gYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyIHx8IGZ1bmN0aW9uIChuYW1lLCBmbikgewogICAgICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcltuYW1lXSA9IGZ1bmN0aW9uIChleHBlY3RlZCkgewogICAgICAgICAgICB2YXIgcHJlZml4ID0gJ2V4cGVjdCAnICsgdGhpcy5mdXR1cmUubmFtZSArICcgJzsKICAgICAgICAgICAgaWYgKHRoaXMuaW52ZXJzZSkgewogICAgICAgICAgICAgICAgcHJlZml4ICs9ICdub3QgJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuYWRkRnV0dXJlKHByZWZpeCArIG5hbWUgKyAnICcgKyBhbmd1bGFyLnRvSnNvbihleHBlY3RlZCksCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZG9uZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICAgICAgICBzZWxmLmFjdHVhbCA9IHNlbGYuZnV0dXJlLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIGlmICgoc2VsZi5pbnZlcnNlICYmIGZuLmNhbGwoc2VsZiwgZXhwZWN0ZWQpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoIXNlbGYuaW52ZXJzZSAmJiAhZm4uY2FsbChzZWxmLCBleHBlY3RlZCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gJ2V4cGVjdGVkICcgKyBhbmd1bGFyLnRvSnNvbihleHBlY3RlZCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyBidXQgd2FzICcgKyBhbmd1bGFyLnRvSnNvbihzZWxmLmFjdHVhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRvbmUoZXJyb3IpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBJbml0aWFsaXplIHRoZSBzY2VuYXJpbyBydW5uZXIgYW5kIHJ1biAhCiAgICAgKgogICAgICogQWNjZXNzIGdsb2JhbCB3aW5kb3cgYW5kIGRvY3VtZW50IG9iamVjdAogICAgICogQWNjZXNzICRydW5uZXIgdGhyb3VnaCBjbG9zdXJlCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgQ29uZmlnIG9wdGlvbnMKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5zZXRVcEFuZFJ1biA9IGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICB2YXIgaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgICAgIHZhciBib2R5ID0gX2pRdWVyeShkb2N1bWVudC5ib2R5KTsKICAgICAgICB2YXIgb3V0cHV0ID0gW107CiAgICAgICAgdmFyIG9iak1vZGVsID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwoJHJ1bm5lcik7CgogICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLnNjZW5hcmlvX291dHB1dCkgewogICAgICAgICAgICBvdXRwdXQgPSBjb25maWcuc2NlbmFyaW9fb3V0cHV0LnNwbGl0KCcsJyk7CiAgICAgICAgfQoKICAgICAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5vdXRwdXQsIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgICAgICBpZiAoIW91dHB1dC5sZW5ndGggfHwgaW5kZXhPZihvdXRwdXQsIG5hbWUpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGJvZHkuYXBwZW5kKCc8ZGl2PjwvZGl2PicpLmZpbmQoJ2RpdjpsYXN0Jyk7CiAgICAgICAgICAgICAgICBjb250ZXh0LmF0dHIoJ2lkJywgbmFtZSk7CiAgICAgICAgICAgICAgICBmbi5jYWxsKHt9LCBjb250ZXh0LCAkcnVubmVyLCBvYmpNb2RlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKCEvXmh0dHAvLnRlc3QoaHJlZikgJiYgIS9eaHR0cHMvLnRlc3QoaHJlZikpIHsKICAgICAgICAgICAgYm9keS5hcHBlbmQoJzxwIGlkPSJzeXN0ZW0tZXJyb3IiPjwvcD4nKTsKICAgICAgICAgICAgYm9keS5maW5kKCcjc3lzdGVtLWVycm9yJykudGV4dCgKICAgICAgICAgICAgICAgICdTY2VuYXJpbyBydW5uZXIgbXVzdCBiZSBydW4gdXNpbmcgaHR0cCBvciBodHRwcy4gVGhlIHByb3RvY29sICcgKwogICAgICAgICAgICAgICAgICAgIGhyZWYuc3BsaXQoJzonKVswXSArICc6Ly8gaXMgbm90IHN1cHBvcnRlZC4nCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBhcHBGcmFtZSA9IGJvZHkuYXBwZW5kKCc8ZGl2IGlkPSJhcHBsaWNhdGlvbiI+PC9kaXY+JykuZmluZCgnI2FwcGxpY2F0aW9uJyk7CiAgICAgICAgdmFyIGFwcGxpY2F0aW9uID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24oYXBwRnJhbWUpOwoKICAgICAgICAkcnVubmVyLm9uKCdSdW5uZXJFbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGFwcEZyYW1lLmNzcygnZGlzcGxheScsICdub25lJyk7CiAgICAgICAgICAgIGFwcEZyYW1lLmZpbmQoJ2lmcmFtZScpLmF0dHIoJ3NyYycsICdhYm91dDpibGFuaycpOwogICAgICAgIH0pOwoKICAgICAgICAkcnVubmVyLm9uKCdSdW5uZXJFcnJvcicsIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICBpZiAod2luZG93LmNvbnNvbGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGZvcm1hdEV4Y2VwdGlvbihlcnJvcikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRG8gc29tZXRoaW5nIGZvciBJRQogICAgICAgICAgICAgICAgYWxlcnQoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgICRydW5uZXIucnVuKGFwcGxpY2F0aW9uKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyB0aHJvdWdoIGxpc3Qgd2l0aCBpdGVyYXRvciBmdW5jdGlvbiB0aGF0IG11c3QgY2FsbCB0aGUKICAgICAqIGNvbnRpbnVlRnVuY3Rpb24gdG8gY29udGludXRlIGl0ZXJhdGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBsaXN0IGxpc3QgdG8gaXRlcmF0ZSBvdmVyCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGl0ZXJhdG9yIENhbGxiYWNrIGZ1bmN0aW9uKHZhbHVlLCBjb250aW51ZUZ1bmN0aW9uKQogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBkb25lIENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yLCByZXN1bHQpIGNhbGxlZCB3aGVuCiAgICAgKiAgIGl0ZXJhdGlvbiBmaW5pc2hlcyBvciBhbiBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzeW5jRm9yRWFjaChsaXN0LCBpdGVyYXRvciwgZG9uZSkgewogICAgICAgIHZhciBpID0gMDsKCiAgICAgICAgZnVuY3Rpb24gbG9vcChlcnJvciwgaW5kZXgpIHsKICAgICAgICAgICAgaWYgKGluZGV4ICYmIGluZGV4ID4gaSkgewogICAgICAgICAgICAgICAgaSA9IGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlcnJvciB8fCBpID49IGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBkb25lKGVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IobGlzdFtpKytdLCBsb29wKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsb29wKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBGb3JtYXRzIGFuIGV4Y2VwdGlvbiBpbnRvIGEgc3RyaW5nIHdpdGggdGhlIHN0YWNrIHRyYWNlLCBidXQgbGltaXRzCiAgICAgKiB0byBhIHNwZWNpZmljIGxpbmUgbGVuZ3RoLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlcnJvciBUaGUgZXhjZXB0aW9uIHRvIGZvcm1hdCwgY2FuIGJlIGFueXRoaW5nIHRocm93YWJsZQogICAgICogQHBhcmFtIHtOdW1iZXI9fSBbbWF4U3RhY2tMaW5lcz01XSBtYXggbGluZXMgb2YgdGhlIHN0YWNrIHRyYWNlIHRvIGluY2x1ZGUKICAgICAqICBkZWZhdWx0IGlzIDUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvcm1hdEV4Y2VwdGlvbihlcnJvciwgbWF4U3RhY2tMaW5lcykgewogICAgICAgIG1heFN0YWNrTGluZXMgPSBtYXhTdGFja0xpbmVzIHx8IDU7CiAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnJvci50b1N0cmluZygpOwogICAgICAgIGlmIChlcnJvci5zdGFjaykgewogICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvci5zdGFjay5zcGxpdCgnXG4nKTsKICAgICAgICAgICAgaWYgKHN0YWNrWzBdLmluZGV4T2YobWVzc2FnZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBtYXhTdGFja0xpbmVzKys7CiAgICAgICAgICAgICAgICBzdGFjay51bnNoaWZ0KGVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1lc3NhZ2UgPSBzdGFjay5zbGljZSgwLCBtYXhTdGFja0xpbmVzKS5qb2luKCdcbicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGdldHMgdGhlIGZpbGUgbmFtZSBhbmQgbGluZSBudW1iZXIgZnJvbSBhCiAgICAgKiBsb2NhdGlvbiBpbiB0aGUgc3RhY2sgaWYgYXZhaWxhYmxlIGJhc2VkIG9uIHRoZSBjYWxsIHNpdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyByZXR1cm5zIGFub3RoZXIgZnVuY3Rpb24gYmVjYXVzZSBhY2Nlc3NpbmcgLnN0YWNrIGlzIHZlcnkKICAgICAqIGV4cGVuc2l2ZSBpbiBDaHJvbWUuCiAgICAgKgogICAgICogQHBhcmFtIHtOdW1iZXJ9IG9mZnNldCBOdW1iZXIgb2Ygc3RhY2sgbGluZXMgdG8gc2tpcAogICAgICovCiAgICBmdW5jdGlvbiBjYWxsZXJGaWxlKG9mZnNldCkgewogICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbGluZSA9IChlcnJvci5zdGFjayB8fCAnJykuc3BsaXQoJ1xuJylbb2Zmc2V0XTsKCiAgICAgICAgICAgIC8vIENsZWFuIHVwIHRoZSBzdGFjayB0cmFjZSBsaW5lCiAgICAgICAgICAgIGlmIChsaW5lKSB7CiAgICAgICAgICAgICAgICBpZiAobGluZS5pbmRleE9mKCdAJykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveAogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN1YnN0cmluZyhsaW5lLmluZGV4T2YoJ0AnKSArIDEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUKICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdWJzdHJpbmcobGluZS5pbmRleE9mKCcoJykgKyAxKS5yZXBsYWNlKCcpJywgJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbGluZSB8fCAnJzsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogVHJpZ2dlcnMgYSBicm93c2VyIGV2ZW50LiBBdHRlbXB0cyB0byBjaG9vc2UgdGhlIHJpZ2h0IGV2ZW50IGlmIG9uZSBpcwogICAgICogbm90IHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudCBFaXRoZXIgYSB3cmFwcGVkIGpRdWVyeS9qcUxpdGUgbm9kZSBvciBhIERPTUVsZW1lbnQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIE9wdGlvbmFsIGV2ZW50IHR5cGUuCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+PX0ga2V5cyBPcHRpb25hbCBsaXN0IG9mIHByZXNzZWQga2V5cwogICAgICogICAgICAgICh2YWxpZCB2YWx1ZXM6ICdhbHQnLCAnbWV0YScsICdzaGlmdCcsICdjdHJsJykKICAgICAqLwogICAgZnVuY3Rpb24gYnJvd3NlclRyaWdnZXIoZWxlbWVudCwgdHlwZSwga2V5cykgewogICAgICAgIGlmIChlbGVtZW50ICYmICFlbGVtZW50Lm5vZGVOYW1lKSBlbGVtZW50ID0gZWxlbWVudFswXTsKICAgICAgICBpZiAoIWVsZW1lbnQpIHJldHVybjsKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgdHlwZSA9IHsKICAgICAgICAgICAgICAgICd0ZXh0JzogJ2NoYW5nZScsCiAgICAgICAgICAgICAgICAndGV4dGFyZWEnOiAnY2hhbmdlJywKICAgICAgICAgICAgICAgICdoaWRkZW4nOiAnY2hhbmdlJywKICAgICAgICAgICAgICAgICdwYXNzd29yZCc6ICdjaGFuZ2UnLAogICAgICAgICAgICAgICAgJ2J1dHRvbic6ICdjbGljaycsCiAgICAgICAgICAgICAgICAnc3VibWl0JzogJ2NsaWNrJywKICAgICAgICAgICAgICAgICdyZXNldCc6ICdjbGljaycsCiAgICAgICAgICAgICAgICAnaW1hZ2UnOiAnY2xpY2snLAogICAgICAgICAgICAgICAgJ2NoZWNrYm94JzogJ2NsaWNrJywKICAgICAgICAgICAgICAgICdyYWRpbyc6ICdjbGljaycsCiAgICAgICAgICAgICAgICAnc2VsZWN0LW9uZSc6ICdjaGFuZ2UnLAogICAgICAgICAgICAgICAgJ3NlbGVjdC1tdWx0aXBsZSc6ICdjaGFuZ2UnCiAgICAgICAgICAgIH1bbG93ZXJjYXNlKGVsZW1lbnQudHlwZSldIHx8ICdjbGljayc7CiAgICAgICAgfQogICAgICAgIGlmIChsb3dlcmNhc2Uobm9kZU5hbWVfKGVsZW1lbnQpKSA9PSAnb3B0aW9uJykgewogICAgICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUudmFsdWUgPSBlbGVtZW50LnZhbHVlOwogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICB0eXBlID0gJ2NoYW5nZSc7CiAgICAgICAgfQoKICAgICAgICBrZXlzID0ga2V5cyB8fCBbXTsKICAgICAgICBmdW5jdGlvbiBwcmVzc2VkKGtleSkgewogICAgICAgICAgICByZXR1cm4gaW5kZXhPZihrZXlzLCBrZXkpICE9PSAtMTsKICAgICAgICB9CgogICAgICAgIGlmIChtc2llIDwgOSkgewogICAgICAgICAgICBzd2l0Y2ggKGVsZW1lbnQudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nOgogICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hlY2tlZCA9ICFlbGVtZW50LmNoZWNrZWQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gV1RGISEhIEVycm9yOiBVbnNwZWNpZmllZCBlcnJvci4KICAgICAgICAgICAgLy8gRG9uJ3Qga25vdyB3aHksIGJ1dCBzb21lIGVsZW1lbnRzIHdoZW4gZGV0YWNoZWQgc2VlbSB0byBiZSBpbiBpbmNvbnNpc3RlbnQgc3RhdGUgYW5kCiAgICAgICAgICAgIC8vIGNhbGxpbmcgLmZpcmVFdmVudCgpIG9uIHRoZW0gd2lsbCByZXN1bHQgaW4gdmVyeSB1bmhlbHBmdWwgZXJyb3IgKEVycm9yOiBVbnNwZWNpZmllZCBlcnJvcikKICAgICAgICAgICAgLy8gZm9yY2luZyB0aGUgYnJvd3NlciB0byBjb21wdXRlIHRoZSBlbGVtZW50IHBvc2l0aW9uIChieSByZWFkaW5nIGl0cyBDU1MpCiAgICAgICAgICAgIC8vIHB1dHMgdGhlIGVsZW1lbnQgaW4gY29uc2lzdGVudCBzdGF0ZS4KICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5wb3NMZWZ0OwoKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNyZWF0ZSBldmVudCBvYmplY3RzIHdpdGggcHJlc3NlZCBrZXlzIHRvIGdldCBpdCB3b3JraW5nIG9uIElFPDkKICAgICAgICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZmlyZUV2ZW50KCdvbicgKyB0eXBlKTsKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShlbGVtZW50LnR5cGUpID09ICdzdWJtaXQnKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChsb3dlcmNhc2UoZWxlbWVudC5ub2RlTmFtZSkgPT0gJ2Zvcm0nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZmlyZUV2ZW50KCdvbnN1Ym1pdCcpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBldm50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ01vdXNlRXZlbnRzJyksCiAgICAgICAgICAgICAgICBvcmlnaW5hbFByZXZlbnREZWZhdWx0ID0gZXZudC5wcmV2ZW50RGVmYXVsdCwKICAgICAgICAgICAgICAgIGlmcmFtZSA9IF9qUXVlcnkoJyNhcHBsaWNhdGlvbiBpZnJhbWUnKVswXSwKICAgICAgICAgICAgICAgIGFwcFdpbmRvdyA9IGlmcmFtZSA/IGlmcmFtZS5jb250ZW50V2luZG93IDogd2luZG93LAogICAgICAgICAgICAgICAgZmFrZVByb2Nlc3NEZWZhdWx0ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGZpbmFsUHJvY2Vzc0RlZmF1bHQsCiAgICAgICAgICAgICAgICBhbmd1bGFyID0gYXBwV2luZG93LmFuZ3VsYXIgfHwge307CgogICAgICAgICAgICAvLyBpZ29yOiB0ZW1wb3JhcnkgZml4IGZvciBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02ODQyMDgKICAgICAgICAgICAgYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSBmYWxzZTsKICAgICAgICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZha2VQcm9jZXNzRGVmYXVsdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsUHJldmVudERlZmF1bHQuYXBwbHkoZXZudCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGV2bnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAwLCAwLCAwLCAwLCAwLCBwcmVzc2VkKCdjdHJsJyksIHByZXNzZWQoJ2FsdCcpLAogICAgICAgICAgICAgICAgcHJlc3NlZCgnc2hpZnQnKSwgcHJlc3NlZCgnbWV0YScpLCAwLCBlbGVtZW50KTsKCiAgICAgICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldm50KTsKICAgICAgICAgICAgZmluYWxQcm9jZXNzRGVmYXVsdCA9ICEoYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gfHwgIWZha2VQcm9jZXNzRGVmYXVsdCk7CgogICAgICAgICAgICBkZWxldGUgYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J107CgogICAgICAgICAgICByZXR1cm4gZmluYWxQcm9jZXNzRGVmYXVsdDsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEb24ndCB1c2UgdGhlIGpRdWVyeSB0cmlnZ2VyIG1ldGhvZCBzaW5jZSBpdCB3b3JrcyBpbmNvcnJlY3RseS4KICAgICAqCiAgICAgKiBqUXVlcnkgbm90aWZpZXMgbGlzdGVuZXJzIGFuZCB0aGVuIGNoYW5nZXMgdGhlIHN0YXRlIG9mIGEgY2hlY2tib3ggYW5kCiAgICAgKiBkb2VzIG5vdCBjcmVhdGUgYSByZWFsIGJyb3dzZXIgZXZlbnQuIEEgcmVhbCBjbGljayBjaGFuZ2VzIHRoZSBzdGF0ZSBvZgogICAgICogdGhlIGNoZWNrYm94IGFuZCB0aGVuIG5vdGlmaWVzIGxpc3RlbmVycy4KICAgICAqCiAgICAgKiBUbyB3b3JrIGFyb3VuZCB0aGlzIHdlIGluc3RlYWQgdXNlIG91ciBvd24gaGFuZGxlciB0aGF0IGZpcmVzIGEgcmVhbCBldmVudC4KICAgICAqLwogICAgKGZ1bmN0aW9uIChmbikgewogICAgICAgIHZhciBwYXJlbnRUcmlnZ2VyID0gZm4udHJpZ2dlcjsKICAgICAgICBmbi50cmlnZ2VyID0gZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgaWYgKC8oY2xpY2t8Y2hhbmdlfGtleWRvd258Ymx1cnxpbnB1dCkvLnRlc3QodHlwZSkpIHsKICAgICAgICAgICAgICAgIHZhciBwcm9jZXNzRGVmYXVsdHMgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzRGVmYXVsdHMucHVzaChicm93c2VyVHJpZ2dlcihub2RlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIG5vdCBjb21wYXRpYmxlIHdpdGggalF1ZXJ5IC0gd2UgcmV0dXJuIGFuIGFycmF5IG9mIHJldHVybmVkIHZhbHVlcywKICAgICAgICAgICAgICAgIC8vIHNvIHRoYXQgc2NlbmFyaW8gcnVubmVyIGtub3cgd2hldGhlciBKUyBjb2RlIGhhcyBwcmV2ZW50RGVmYXVsdCgpIG9mIHRoZSBldmVudCBvciBub3QuLi4KICAgICAgICAgICAgICAgIHJldHVybiBwcm9jZXNzRGVmYXVsdHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgfSkoX2pRdWVyeS5mbik7CgogICAgLyoqCiAgICAgKiBGaW5kcyBhbGwgYmluZGluZ3Mgd2l0aCB0aGUgc3Vic3RyaW5nIG1hdGNoIG9mIG5hbWUgYW5kIHJldHVybnMgYW4KICAgICAqIGFycmF5IG9mIHRoZWlyIHZhbHVlcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYmluZEV4cCBUaGUgbmFtZSB0byBtYXRjaAogICAgICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59IFN0cmluZyBvZiBiaW5kaW5nIHZhbHVlcwogICAgICovCiAgICBfalF1ZXJ5LmZuLmJpbmRpbmdzID0gZnVuY3Rpb24gKHdpbmRvd0pxdWVyeSwgYmluZEV4cCkgewogICAgICAgIHZhciByZXN1bHQgPSBbXSwgbWF0Y2gsCiAgICAgICAgICAgIGJpbmRTZWxlY3RvciA9ICcubmctYmluZGluZzp2aXNpYmxlJzsKICAgICAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhiaW5kRXhwKSkgewogICAgICAgICAgICBiaW5kRXhwID0gYmluZEV4cC5yZXBsYWNlKC9ccy9nLCAnJyk7CiAgICAgICAgICAgIG1hdGNoID0gZnVuY3Rpb24gKGFjdHVhbEV4cCkgewogICAgICAgICAgICAgICAgaWYgKGFjdHVhbEV4cCkgewogICAgICAgICAgICAgICAgICAgIGFjdHVhbEV4cCA9IGFjdHVhbEV4cC5yZXBsYWNlKC9ccy9nLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdHVhbEV4cCA9PSBiaW5kRXhwKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0dWFsRXhwLmluZGV4T2YoYmluZEV4cCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsRXhwLmNoYXJBdChiaW5kRXhwLmxlbmd0aCkgPT0gJ3wnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoYmluZEV4cCkgewogICAgICAgICAgICBtYXRjaCA9IGZ1bmN0aW9uIChhY3R1YWxFeHApIHsKICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWxFeHAgJiYgYmluZEV4cC5leGVjKGFjdHVhbEV4cCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXRjaCA9IGZ1bmN0aW9uIChhY3R1YWxFeHApIHsKICAgICAgICAgICAgICAgIHJldHVybiAhIWFjdHVhbEV4cDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHRoaXMuZmluZChiaW5kU2VsZWN0b3IpOwogICAgICAgIGlmICh0aGlzLmlzKGJpbmRTZWxlY3RvcikpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gc2VsZWN0aW9uLmFkZCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHB1c2godmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdmFsdWUgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgIT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gYW5ndWxhci50b0pzb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKCcnICsgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgc2VsZWN0aW9uLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IHdpbmRvd0pxdWVyeSh0aGlzKSwKICAgICAgICAgICAgICAgIGJpbmRpbmc7CiAgICAgICAgICAgIGlmIChiaW5kaW5nID0gZWxlbWVudC5kYXRhKCckYmluZGluZycpKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJpbmRpbmcgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2goYmluZGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaChlbGVtZW50LnNjb3BlKCkuJGV2YWwoYmluZGluZykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFhbmd1bGFyLmlzQXJyYXkoYmluZGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZyA9IFtiaW5kaW5nXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZm5zLCBqID0gMCwgamogPSBiaW5kaW5nLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm5zID0gYmluZGluZ1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZucy5wYXJ0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm5zID0gZm5zLnBhcnRzOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm5zID0gW2Zuc107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgc2NvcGUsIGZuLCBpID0gMCwgaWkgPSBmbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKChmbiA9IGZuc1tpXSkuZXhwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1c2goZm4oc2NvcGUgPSBzY29wZSB8fCBlbGVtZW50LnNjb3BlKCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogUmVwcmVzZW50cyB0aGUgYXBwbGljYXRpb24gY3VycmVudGx5IGJlaW5nIHRlc3RlZCBhbmQgYWJzdHJhY3RzIHVzYWdlCiAgICAgKiBvZiBpZnJhbWVzIG9yIHNlcGFyYXRlIHdpbmRvd3MuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgalF1ZXJ5IHdyYXBwZXIgYXJvdW5kIEhUTUwgY29udGV4dC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbiA9IGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICBjb250ZXh0LmFwcGVuZCgKICAgICAgICAgICAgJzxoMj5DdXJyZW50IFVSTDogPGEgaHJlZj0iYWJvdXQ6YmxhbmsiPk5vbmU8L2E+PC9oMj4nICsKICAgICAgICAgICAgICAgICc8ZGl2IGlkPSJ0ZXN0LWZyYW1lcyI+PC9kaXY+JwogICAgICAgICk7CiAgICB9OwoKICAgIC8qKgogICAgICogR2V0cyB0aGUgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZnJhbWVzLiBEb24ndCB1c2UgdGhpcyBkaXJlY3RseSBiZWNhdXNlCiAgICAgKiBmcmFtZXMgbWF5IGdvIHN0YWxlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IGpRdWVyeSBjb2xsZWN0aW9uCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLmdldEZyYW1lXyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmZpbmQoJyN0ZXN0LWZyYW1lcyBpZnJhbWU6bGFzdCcpOwogICAgfTsKCiAgICAvKioKICAgICAqIEdldHMgdGhlIHdpbmRvdyBvZiB0aGUgdGVzdCBydW5uZXIgZnJhbWUuIEFsd2F5cyBmYXZvciBleGVjdXRlQWN0aW9uKCkKICAgICAqIGluc3RlYWQgb2YgdGhpcyBtZXRob2Qgc2luY2UgaXQgcHJldmVudHMgeW91IGZyb20gZ2V0dGluZyBhIHN0YWxlIHdpbmRvdy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHJldHVybiB7T2JqZWN0fSB0aGUgd2luZG93IG9mIHRoZSBmcmFtZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uLnByb3RvdHlwZS5nZXRXaW5kb3dfID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjb250ZW50V2luZG93ID0gdGhpcy5nZXRGcmFtZV8oKS5wcm9wKCdjb250ZW50V2luZG93Jyk7CiAgICAgICAgaWYgKCFjb250ZW50V2luZG93KQogICAgICAgICAgICB0aHJvdyAnRnJhbWUgd2luZG93IGlzIG5vdCBhY2Nlc3NpYmxlLic7CiAgICAgICAgcmV0dXJuIGNvbnRlbnRXaW5kb3c7CiAgICB9OwoKICAgIC8qKgogICAgICogQ2hhbmdlcyB0aGUgbG9jYXRpb24gb2YgdGhlIGZyYW1lLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIFVSTC4gSWYgaXQgYmVnaW5zIHdpdGggYSAjIHRoZW4gb25seSB0aGUKICAgICAqICAgaGFzaCBvZiB0aGUgcGFnZSBpcyBjaGFuZ2VkLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBsb2FkRm4gZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50KSBDYWxsZWQgd2hlbiBmcmFtZSBsb2Fkcy4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZXJyb3JGbiBmdW5jdGlvbihlcnJvcikgQ2FsbGVkIGlmIGFueSBlcnJvciB3aGVuIGxvYWRpbmcuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLm5hdmlnYXRlVG8gPSBmdW5jdGlvbiAodXJsLCBsb2FkRm4sIGVycm9yRm4pIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGZyYW1lID0gdGhpcy5nZXRGcmFtZV8oKTsKICAgICAgICAvL1RPRE8oZXNwcmVobik6IFJlZmFjdG9yIHRvIHVzZSByZXRocm93KCkKICAgICAgICBlcnJvckZuID0gZXJyb3JGbiB8fCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH07CiAgICAgICAgaWYgKHVybCA9PT0gJ2Fib3V0OmJsYW5rJykgewogICAgICAgICAgICBlcnJvckZuKCdTYW5kYm94IEVycm9yOiBOYXZpZ2F0aW5nIHRvIGFib3V0OmJsYW5rIGlzIG5vdCBhbGxvd2VkLicpOwogICAgICAgIH0gZWxzZSBpZiAodXJsLmNoYXJBdCgwKSA9PT0gJyMnKSB7CiAgICAgICAgICAgIHVybCA9IGZyYW1lLmF0dHIoJ3NyYycpLnNwbGl0KCcjJylbMF0gKyB1cmw7CiAgICAgICAgICAgIGZyYW1lLmF0dHIoJ3NyYycsIHVybCk7CiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUFjdGlvbihsb2FkRm4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZyYW1lLnJlbW92ZSgpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmluZCgnI3Rlc3QtZnJhbWVzJykuYXBwZW5kKCc8aWZyYW1lPicpOwogICAgICAgICAgICBmcmFtZSA9IHRoaXMuZ2V0RnJhbWVfKCk7CiAgICAgICAgICAgIGZyYW1lLmxvYWQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnJhbWUudW5iaW5kKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZXhlY3V0ZUFjdGlvbihsb2FkRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yRm4oZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLmF0dHIoJ3NyYycsIHVybCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY29udGV4dC5maW5kKCc+IGgyIGEnKS5hdHRyKCdocmVmJywgdXJsKS50ZXh0KHVybCk7CiAgICB9OwoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgYSBmdW5jdGlvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgdGVzdGVkIGFwcGxpY2F0aW9uLiBXaWxsIHdhaXQKICAgICAqIGZvciBhbGwgcGVuZGluZyBhbmd1bGFyIHhociByZXF1ZXN0cyBiZWZvcmUgZXhlY3V0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYWN0aW9uIFRoZSBjYWxsYmFjayB0byBleGVjdXRlLiBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpCiAgICAgKiAgJGRvY3VtZW50IGlzIGEgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLmV4ZWN1dGVBY3Rpb24gPSBmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciAkd2luZG93ID0gdGhpcy5nZXRXaW5kb3dfKCk7CiAgICAgICAgaWYgKCEkd2luZG93LmRvY3VtZW50KSB7CiAgICAgICAgICAgIHRocm93ICdTYW5kYm94IEVycm9yOiBBcHBsaWNhdGlvbiBkb2N1bWVudCBub3QgYWNjZXNzaWJsZS4nOwogICAgICAgIH0KICAgICAgICBpZiAoISR3aW5kb3cuYW5ndWxhcikgewogICAgICAgICAgICByZXR1cm4gYWN0aW9uLmNhbGwodGhpcywgJHdpbmRvdywgX2pRdWVyeSgkd2luZG93LmRvY3VtZW50KSk7CiAgICAgICAgfQogICAgICAgIGFuZ3VsYXJJbml0KCR3aW5kb3cuZG9jdW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciAkaW5qZWN0b3IgPSAkd2luZG93LmFuZ3VsYXIuZWxlbWVudChlbGVtZW50KS5pbmplY3RvcigpOwogICAgICAgICAgICB2YXIgJGVsZW1lbnQgPSBfalF1ZXJ5KGVsZW1lbnQpOwoKICAgICAgICAgICAgJGVsZW1lbnQuaW5qZWN0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbiAoJGJyb3dzZXIpIHsKICAgICAgICAgICAgICAgICRicm93c2VyLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGFjdGlvbi5jYWxsKHNlbGYsICR3aW5kb3csICRlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGUgcmVwcmVzZW50YXRpb24gb2YgZGVmaW5lIGJsb2Nrcy4gRG9uJ3QgdXNlZCBkaXJlY3RseSwgaW5zdGVhZCB1c2UKICAgICAqIGRlZmluZSgpIGluIHlvdXIgdGVzdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGRlc2NOYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyZW50IGRlc2NyaWJlIG9yIHVuZGVmaW5lZCBpZiB0aGUgcm9vdC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZSA9IGZ1bmN0aW9uIChkZXNjTmFtZSwgcGFyZW50KSB7CiAgICAgICAgdGhpcy5vbmx5ID0gcGFyZW50ICYmIHBhcmVudC5vbmx5OwogICAgICAgIHRoaXMuYmVmb3JlRWFjaEZucyA9IFtdOwogICAgICAgIHRoaXMuYWZ0ZXJFYWNoRm5zID0gW107CiAgICAgICAgdGhpcy5pdHMgPSBbXTsKICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgICAgdGhpcy5uYW1lID0gZGVzY05hbWU7CiAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgdGhpcy5pZCA9IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuaWQrKzsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbHMgYWxsIGJlZm9yZSBmdW5jdGlvbnMuCiAgICAgICAgICovCiAgICAgICAgdmFyIGJlZm9yZUVhY2hGbnMgPSB0aGlzLmJlZm9yZUVhY2hGbnM7CiAgICAgICAgdGhpcy5zZXR1cEJlZm9yZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnNldHVwQmVmb3JlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChiZWZvcmVFYWNoRm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxzIGFsbCBhZnRlciBmdW5jdGlvbnMuCiAgICAgICAgICovCiAgICAgICAgdmFyIGFmdGVyRWFjaEZucyA9IHRoaXMuYWZ0ZXJFYWNoRm5zOwogICAgICAgIHRoaXMuc2V0dXBBZnRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFmdGVyRWFjaEZucywgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICBmbi5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnNldHVwQWZ0ZXIuY2FsbCh0aGlzKTsKICAgICAgICB9OwogICAgfTsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBkZXNjcmliZSBibG9jawogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5pZCA9IDA7CgovLyBTaGFyZWQgVW5pcXVlIElEIGdlbmVyYXRvciBmb3IgZXZlcnkgaXQgKHNwZWMpCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnNwZWNJZCA9IDA7CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgYmxvY2sgdG8gZXhlY3V0ZSBiZWZvcmUgZWFjaCBpdCBvciBuZXN0ZWQgZGVzY3JpYmUuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5iZWZvcmVFYWNoID0gZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgICB0aGlzLmJlZm9yZUVhY2hGbnMucHVzaChib2R5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgYmxvY2sgdG8gZXhlY3V0ZSBhZnRlciBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmFmdGVyRWFjaCA9IGZ1bmN0aW9uIChib2R5KSB7CiAgICAgICAgdGhpcy5hZnRlckVhY2hGbnMucHVzaChib2R5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGRlc2NyaWJlIGJsb2NrIHRoYXQncyBhIGNoaWxkIG9mIHRoaXMgb25lLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrLiBBcHBlbmRlZCB0byB0aGUgcGFyZW50IGJsb2NrJ3MgbmFtZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuZGVzY3JpYmUgPSBmdW5jdGlvbiAobmFtZSwgYm9keSkgewogICAgICAgIHZhciBjaGlsZCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlKG5hbWUsIHRoaXMpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgICAgYm9keS5jYWxsKGNoaWxkKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTYW1lIGFzIGRlc2NyaWJlKCkgYnV0IG1ha2VzIGRkZXNjcmliZSBibG9ja3MgdGhlIG9ubHkgdG8gcnVuLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHRlc3QuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmRkZXNjcmliZSA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdmFyIGNoaWxkID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUobmFtZSwgdGhpcyk7CiAgICAgICAgY2hpbGQub25seSA9IHRydWU7CiAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICBib2R5LmNhbGwoY2hpbGQpOwogICAgfTsKCiAgICAvKioKICAgICAqIFVzZSB0byBkaXNhYmxlIGEgZGVzY3JpYmUgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhkZXNjcmliZSA9IGFuZ3VsYXIubm9vcDsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSB0ZXN0LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHRlc3QuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHZvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLml0ID0gZnVuY3Rpb24gKG5hbWUsIGJvZHkpIHsKICAgICAgICB0aGlzLml0cy5wdXNoKHsKICAgICAgICAgICAgaWQ6IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuc3BlY0lkKyssCiAgICAgICAgICAgIGRlZmluaXRpb246IHRoaXMsCiAgICAgICAgICAgIG9ubHk6IHRoaXMub25seSwKICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgYmVmb3JlOiB0aGlzLnNldHVwQmVmb3JlLAogICAgICAgICAgICBib2R5OiBib2R5LAogICAgICAgICAgICBhZnRlcjogdGhpcy5zZXR1cEFmdGVyCiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2FtZSBhcyBpdCgpIGJ1dCBtYWtlcyBpaXQgdGVzdHMgdGhlIG9ubHkgdGVzdCB0byBydW4uCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuaWl0ID0gZnVuY3Rpb24gKG5hbWUsIGJvZHkpIHsKICAgICAgICB0aGlzLml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5pdHNbdGhpcy5pdHMubGVuZ3RoIC0gMV0ub25seSA9IHRydWU7CiAgICB9OwoKICAgIC8qKgogICAgICogVXNlIHRvIGRpc2FibGUgYSB0ZXN0IGJsb2NrLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS54aXQgPSBhbmd1bGFyLm5vb3A7CgogICAgLyoqCiAgICAgKiBHZXRzIGFuIGFycmF5IG9mIGZ1bmN0aW9ucyByZXByZXNlbnRpbmcgYWxsIHRoZSB0ZXN0cyAocmVjdXJzaXZlbHkpLgogICAgICogdGhhdCBjYW4gYmUgZXhlY3V0ZWQgd2l0aCBTcGVjUnVubmVyJ3MuCiAgICAgKgogICAgICogQHJldHVybiB7QXJyYXk8T2JqZWN0Pn0gQXJyYXkgb2YgaXQgYmxvY2tzIHsKICogICBkZWZpbml0aW9uIDogT2JqZWN0IC8vIHBhcmVudCBEZXNjcmliZQogKiAgIG9ubHk6IGJvb2xlYW4KICogICBuYW1lOiBzdHJpbmcKICogICBiZWZvcmU6IEZ1bmN0aW9uCiAqICAgYm9keTogRnVuY3Rpb24KICogICBhZnRlcjogRnVuY3Rpb24KICogIH0KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuZ2V0U3BlY3MgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHNwZWNzID0gYXJndW1lbnRzWzBdIHx8IFtdOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgY2hpbGQuZ2V0U3BlY3Moc3BlY3MpOwogICAgICAgIH0pOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLml0cywgZnVuY3Rpb24gKGl0KSB7CiAgICAgICAgICAgIHNwZWNzLnB1c2goaXQpOwogICAgICAgIH0pOwogICAgICAgIHZhciBvbmx5ID0gW107CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNwZWNzLCBmdW5jdGlvbiAoaXQpIHsKICAgICAgICAgICAgaWYgKGl0Lm9ubHkpIHsKICAgICAgICAgICAgICAgIG9ubHkucHVzaChpdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gKG9ubHkubGVuZ3RoICYmIG9ubHkpIHx8IHNwZWNzOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgZnV0dXJlIGFjdGlvbiBpbiBhIHNwZWMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgb2YgdGhlIGZ1dHVyZSBhY3Rpb24KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZnV0dXJlIGNhbGxiYWNrKGVycm9yLCByZXN1bHQpCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IE9wdGlvbmFsLiBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGZpbGUvbGluZSBudW1iZXIuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlID0gZnVuY3Rpb24gKG5hbWUsIGJlaGF2aW9yLCBsaW5lKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLmJlaGF2aW9yID0gYmVoYXZpb3I7CiAgICAgICAgdGhpcy5mdWxmaWxsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLnZhbHVlID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMucGFyc2VyID0gYW5ndWxhci5pZGVudGl0eTsKICAgICAgICB0aGlzLmxpbmUgPSBsaW5lIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGJlaGF2aW9yIG9mIHRoZSBjbG9zdXJlLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZG9uZUZuIENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yLCByZXN1bHQpCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlLnByb3RvdHlwZS5leGVjdXRlID0gZnVuY3Rpb24gKGRvbmVGbikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB0aGlzLmJlaGF2aW9yKGZ1bmN0aW9uIChlcnJvciwgcmVzdWx0KSB7CiAgICAgICAgICAgIHNlbGYuZnVsZmlsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWxmLnBhcnNlcihyZXN1bHQpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnZhbHVlID0gZXJyb3IgfHwgcmVzdWx0OwogICAgICAgICAgICBkb25lRm4oZXJyb3IsIHJlc3VsdCk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29uZmlndXJlcyB0aGUgZnV0dXJlIHRvIGNvbnZlcnQgaXQncyBmaW5hbCB3aXRoIGEgZnVuY3Rpb24gZm4odmFsdWUpCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBmdW5jdGlvbih2YWx1ZSkgdGhhdCByZXR1cm5zIHRoZSBwYXJzZWQgdmFsdWUKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUucHJvdG90eXBlLnBhcnNlZFdpdGggPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICB0aGlzLnBhcnNlciA9IGZuOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvKioKICAgICAqIENvbmZpZ3VyZXMgdGhlIGZ1dHVyZSB0byBwYXJzZSBpdCdzIGZpbmFsIHZhbHVlIGZyb20gSlNPTgogICAgICogaW50byBvYmplY3RzLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUuZnJvbUpzb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLmZyb21Kc29uKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHZhbHVlIGZyb20gb2JqZWN0cwogICAgICogaW50byBKU09OLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUudG9Kc29uID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnBhcnNlZFdpdGgoYW5ndWxhci50b0pzb24pOwogICAgfTsKCiAgICAvKioKICAgICAqIE1haW50YWlucyBhbiBvYmplY3QgdHJlZSBmcm9tIHRoZSBydW5uZXIgZXZlbnRzLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBydW5uZXIgVGhlIHNjZW5hcmlvIFJ1bm5lciBpbnN0YW5jZSB0byBjb25uZWN0IHRvLgogICAgICoKICAgICAqIFRPRE8oZXNwcmVobik6IEV2ZXJ5IG91dHB1dCB0eXBlIGNyZWF0ZXMgb25lIG9mIHRoZXNlLCBidXQgd2UgcHJvYmFibHkKICAgICAqICB3YW50IG9uZSBnbG9iYWwgc2hhcmVkIGluc3RhbmNlLiBOZWVkIHRvIGhhbmRsZSBldmVudHMgYmV0dGVyIHRvbwogICAgICogIHNvIHRoZSBIVE1MIG91dHB1dCBkb2Vzbid0IG5lZWQgdG8gZG8gc3BlYyBtb2RlbC5nZXRTcGVjKHNwZWMuaWQpCiAgICAgKiAgc2lsbGluZXNzLgogICAgICoKICAgICAqIFRPRE8odm9qdGEpIHJlZmFjdG9yIG9uLCBlbWl0IG1ldGhvZHMgKGZyb20gYWxsIG9iamVjdHMpIC0gdXNlIGluaGVyaXRhbmNlCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwgPSBmdW5jdGlvbiAocnVubmVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLnNwZWNNYXAgPSB7fTsKICAgICAgICB0aGlzLmxpc3RlbmVycyA9IFtdOwogICAgICAgIHRoaXMudmFsdWUgPSB7CiAgICAgICAgICAgIG5hbWU6ICcnLAogICAgICAgICAgICBjaGlsZHJlbjoge30KICAgICAgICB9OwoKICAgICAgICBydW5uZXIub24oJ1NwZWNCZWdpbicsIGZ1bmN0aW9uIChzcGVjKSB7CiAgICAgICAgICAgIHZhciBibG9jayA9IHNlbGYudmFsdWUsCiAgICAgICAgICAgICAgICBkZWZpbml0aW9ucyA9IFtdOwoKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNlbGYuZ2V0RGVmaW5pdGlvblBhdGgoc3BlYyksIGZ1bmN0aW9uIChkZWYpIHsKICAgICAgICAgICAgICAgIGlmICghYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgICBpZDogZGVmLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBkZWYubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IHt9LAogICAgICAgICAgICAgICAgICAgICAgICBzcGVjczoge30KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYmxvY2sgPSBibG9jay5jaGlsZHJlbltkZWYubmFtZV07CiAgICAgICAgICAgICAgICBkZWZpbml0aW9ucy5wdXNoKGRlZi5uYW1lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgaXQgPSBzZWxmLnNwZWNNYXBbc3BlYy5pZF0gPQogICAgICAgICAgICAgICAgYmxvY2suc3BlY3Nbc3BlYy5uYW1lXSA9CiAgICAgICAgICAgICAgICAgICAgbmV3IGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYyhzcGVjLmlkLCBzcGVjLm5hbWUsIGRlZmluaXRpb25zKTsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3BlY0JlZ2luJywgaXQpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1NwZWNFcnJvcicsIGZ1bmN0aW9uIChzcGVjLCBlcnJvcikgewogICAgICAgICAgICB2YXIgaXQgPSBzZWxmLmdldFNwZWMoc3BlYy5pZCk7CiAgICAgICAgICAgIGl0LnN0YXR1cyA9ICdlcnJvcic7CiAgICAgICAgICAgIGl0LmVycm9yID0gZXJyb3I7CgogICAgICAgICAgICAvLyBmb3J3YXJkIHRoZSBldmVudAogICAgICAgICAgICBzZWxmLmVtaXQoJ1NwZWNFcnJvcicsIGl0LCBlcnJvcik7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3BlY0VuZCcsIGZ1bmN0aW9uIChzcGVjKSB7CiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKTsKICAgICAgICAgICAgY29tcGxldGUoaXQpOwoKICAgICAgICAgICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5lbWl0KCdTcGVjRW5kJywgaXQpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1N0ZXBCZWdpbicsIGZ1bmN0aW9uIChzcGVjLCBzdGVwKSB7CiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKTsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwKHN0ZXAubmFtZSk7CiAgICAgICAgICAgIGl0LnN0ZXBzLnB1c2goc3RlcCk7CgogICAgICAgICAgICAvLyBmb3J3YXJkIHRoZSBldmVudAogICAgICAgICAgICBzZWxmLmVtaXQoJ1N0ZXBCZWdpbicsIGl0LCBzdGVwKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRW5kJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICB2YXIgc3RlcCA9IGl0LmdldExhc3RTdGVwKCk7CiAgICAgICAgICAgIGlmIChzdGVwLm5hbWUgIT09IHN0ZXAubmFtZSkKICAgICAgICAgICAgICAgIHRocm93ICdFdmVudHMgZmlyZWQgaW4gdGhlIHdyb25nIG9yZGVyLiBTdGVwIG5hbWVzIGRvblwndCBtYXRjaC4nOwogICAgICAgICAgICBjb21wbGV0ZShzdGVwKTsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIGl0LCBzdGVwKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRmFpbHVyZScsIGZ1bmN0aW9uIChzcGVjLCBzdGVwLCBlcnJvcikgewogICAgICAgICAgICB2YXIgaXQgPSBzZWxmLmdldFNwZWMoc3BlYy5pZCksCiAgICAgICAgICAgICAgICBtb2RlbFN0ZXAgPSBpdC5nZXRMYXN0U3RlcCgpOwoKICAgICAgICAgICAgbW9kZWxTdGVwLnNldEVycm9yU3RhdHVzKCdmYWlsdXJlJywgZXJyb3IsIHN0ZXAubGluZSgpKTsKICAgICAgICAgICAgaXQuc2V0U3RhdHVzRnJvbVN0ZXAobW9kZWxTdGVwKTsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXAsIGVycm9yKSB7CiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKSwKICAgICAgICAgICAgICAgIG1vZGVsU3RlcCA9IGl0LmdldExhc3RTdGVwKCk7CgogICAgICAgICAgICBtb2RlbFN0ZXAuc2V0RXJyb3JTdGF0dXMoJ2Vycm9yJywgZXJyb3IsIHN0ZXAubGluZSgpKTsKICAgICAgICAgICAgaXQuc2V0U3RhdHVzRnJvbVN0ZXAobW9kZWxTdGVwKTsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVycm9yJywgaXQsIG1vZGVsU3RlcCwgZXJyb3IpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1J1bm5lckJlZ2luJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmVtaXQoJ1J1bm5lckJlZ2luJyk7CiAgICAgICAgfSk7CiAgICAgICAgcnVubmVyLm9uKCdSdW5uZXJFbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuZW1pdCgnUnVubmVyRW5kJyk7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlKGl0ZW0pIHsKICAgICAgICAgICAgaXRlbS5lbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIGl0ZW0uZHVyYXRpb24gPSBpdGVtLmVuZFRpbWUgLSBpdGVtLnN0YXJ0VGltZTsKICAgICAgICAgICAgaXRlbS5zdGF0dXMgPSBpdGVtLnN0YXR1cyB8fCAnc3VjY2Vzcyc7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEFkZHMgYSBsaXN0ZW5lciBmb3IgYW4gZXZlbnQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSBOYW1lIG9mIHRoZSBldmVudCB0byBhZGQgYSBoYW5kbGVyIGZvcgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBsaXN0ZW5lciBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gZXZlbnQgaXMgZmlyZWQKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSB0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdIHx8IFtdOwogICAgICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9OwoKICAgIC8qKgogICAgICogRW1pdHMgYW4gZXZlbnQgd2hpY2ggbm90aWZpZXMgbGlzdGVuZXJzIGFuZCBwYXNzZXMgZXh0cmEKICAgICAqIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmICh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIHBhdGggb2YgZGVmaW5pdGlvbiBkZXNjcmliZSBibG9ja3MgdGhhdCB3cmFwIGFyb3VuZAogICAgICogdGhpcyBzcGVjLgogICAgICoKICAgICAqIEBwYXJhbSBzcGVjIFNwZWMgdG8gY29tcHV0ZSB0aGUgcGF0aCBmb3IuCiAgICAgKiBAcmV0dXJuIHtBcnJheTxEZXNjcmliZT59IFRoZSBkZXNjcmliZSBibG9jayBwYXRoCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwucHJvdG90eXBlLmdldERlZmluaXRpb25QYXRoID0gZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICB2YXIgcGF0aCA9IFtdOwogICAgICAgIHZhciBjdXJyZW50RGVmaW5pdGlvbiA9IHNwZWMuZGVmaW5pdGlvbjsKICAgICAgICB3aGlsZSAoY3VycmVudERlZmluaXRpb24gJiYgY3VycmVudERlZmluaXRpb24ubmFtZSkgewogICAgICAgICAgICBwYXRoLnVuc2hpZnQoY3VycmVudERlZmluaXRpb24pOwogICAgICAgICAgICBjdXJyZW50RGVmaW5pdGlvbiA9IGN1cnJlbnREZWZpbml0aW9uLnBhcmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICB9OwoKICAgIC8qKgogICAgICogR2V0cyBhIHNwZWMgYnkgaWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IFRoZSBpZCBvZiB0aGUgc3BlYyB0byBnZXQgdGhlIG9iamVjdCBmb3IuCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IHRoZSBTcGVjIGluc3RhbmNlCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwucHJvdG90eXBlLmdldFNwZWMgPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zcGVjTWFwW2lkXTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBIHNpbmdsZSBpdCBibG9jay4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgSWQgb2YgdGhlIHNwZWMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHNwZWMKICAgICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPj19IGRlZmluaXRpb25OYW1lcyBMaXN0IG9mIGFsbCBkZXNjcmliZSBibG9jayBuYW1lcyB0aGF0IHdyYXAgdGhpcyBzcGVjCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYyA9IGZ1bmN0aW9uIChpZCwgbmFtZSwgZGVmaW5pdGlvbk5hbWVzKSB7CiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICB0aGlzLnN0ZXBzID0gW107CiAgICAgICAgdGhpcy5mdWxsRGVmaW5pdGlvbk5hbWUgPSAoZGVmaW5pdGlvbk5hbWVzIHx8IFtdKS5qb2luKCcgJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogQWRkcyBhIG5ldyBzdGVwIHRvIHRoZSBTcGVjLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwIE5hbWUgb2YgdGhlIHN0ZXAgKHJlYWxseSBuYW1lIG9mIHRoZSBmdXR1cmUpCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IHRoZSBhZGRlZCBzdGVwCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYy5wcm90b3R5cGUuYWRkU3RlcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdmFyIHN0ZXAgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwKG5hbWUpOwogICAgICAgIHRoaXMuc3RlcHMucHVzaChzdGVwKTsKICAgICAgICByZXR1cm4gc3RlcDsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBtb3N0IHJlY2VudCBzdGVwLgogICAgICoKICAgICAqIEByZXR1cm4ge09iamVjdH0gdGhlIHN0ZXAKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjLnByb3RvdHlwZS5nZXRMYXN0U3RlcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGVwc1t0aGlzLnN0ZXBzLmxlbmd0aCAtIDFdOwogICAgfTsKCiAgICAvKioKICAgICAqIFNldCBzdGF0dXMgb2YgdGhlIFNwZWMgZnJvbSBnaXZlbiBTdGVwCiAgICAgKgogICAgICogQHBhcmFtIHthbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXB9IHN0ZXAKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjLnByb3RvdHlwZS5zZXRTdGF0dXNGcm9tU3RlcCA9IGZ1bmN0aW9uIChzdGVwKSB7CiAgICAgICAgaWYgKCF0aGlzLnN0YXR1cyB8fCBzdGVwLnN0YXR1cyA9PSAnZXJyb3InKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gc3RlcC5zdGF0dXM7CiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBzdGVwLmVycm9yOwogICAgICAgICAgICB0aGlzLmxpbmUgPSBzdGVwLmxpbmU7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEEgc2luZ2xlIHN0ZXAgaW5zaWRlIGEgU3BlYy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RlcCBOYW1lIG9mIHRoZSBzdGVwCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfTsKCiAgICAvKioKICAgICAqIEhlbHBlciBtZXRob2QgZm9yIHNldHRpbmcgYWxsIGVycm9yIHN0YXR1cyByZWxhdGVkIHByb3BlcnRpZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RhdHVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXJyb3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsaW5lCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcC5wcm90b3R5cGUuc2V0RXJyb3JTdGF0dXMgPSBmdW5jdGlvbiAoc3RhdHVzLCBlcnJvciwgbGluZSkgewogICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgIHRoaXMuZXJyb3IgPSBlcnJvcjsKICAgICAgICB0aGlzLmxpbmUgPSBsaW5lOwogICAgfTsKCiAgICAvKioKICAgICAqIFJ1bm5lciBmb3Igc2NlbmFyaW9zCiAgICAgKgogICAgICogSGFzIHRvIGJlIGluaXRpYWxpemVkIGJlZm9yZSBhbnkgdGVzdCBpcyBsb2FkZWQsCiAgICAgKiBiZWNhdXNlIGl0IHB1Ymxpc2hlcyB0aGUgQVBJIGludG8gd2luZG93IChnbG9iYWwgc3BhY2UpLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lciA9IGZ1bmN0aW9uICgkd2luZG93KSB7CiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICAgICAgICB0aGlzLiR3aW5kb3cgPSAkd2luZG93OwogICAgICAgIHRoaXMucm9vdERlc2NyaWJlID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUoKTsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZSA9IHRoaXMucm9vdERlc2NyaWJlOwogICAgICAgIHRoaXMuYXBpID0gewogICAgICAgICAgICBpdDogdGhpcy5pdCwKICAgICAgICAgICAgaWl0OiB0aGlzLmlpdCwKICAgICAgICAgICAgeGl0OiBhbmd1bGFyLm5vb3AsCiAgICAgICAgICAgIGRlc2NyaWJlOiB0aGlzLmRlc2NyaWJlLAogICAgICAgICAgICBkZGVzY3JpYmU6IHRoaXMuZGRlc2NyaWJlLAogICAgICAgICAgICB4ZGVzY3JpYmU6IGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgYmVmb3JlRWFjaDogdGhpcy5iZWZvcmVFYWNoLAogICAgICAgICAgICBhZnRlckVhY2g6IHRoaXMuYWZ0ZXJFYWNoCiAgICAgICAgfTsKICAgICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5hcGksIGFuZ3VsYXIuYmluZCh0aGlzLCBmdW5jdGlvbiAoZm4sIGtleSkgewogICAgICAgICAgICB0aGlzLiR3aW5kb3dba2V5XSA9IGFuZ3VsYXIuYmluZCh0aGlzLCBmbik7CiAgICAgICAgfSkpOwogICAgfTsKCiAgICAvKioKICAgICAqIEVtaXRzIGFuIGV2ZW50IHdoaWNoIG5vdGlmaWVzIGxpc3RlbmVycyBhbmQgcGFzc2VzIGV4dHJhCiAgICAgKiBhcmd1bWVudHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSBOYW1lIG9mIHRoZSBldmVudCB0byBmaXJlLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICghdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQWRkcyBhIGxpc3RlbmVyIGZvciBhbiBldmVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudCB0byBhZGQgYSBoYW5kbGVyIGZvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGxpc3RlbmVyIFRoZSBmbiguLi4pIHRoYXQgdGFrZXMgdGhlIGV4dHJhIGFyZ3VtZW50cyBmcm9tIGVtaXQoKQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSB0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdIHx8IFtdOwogICAgICAgIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIGRlc2NyaWJlIGJsb2NrIG9mIGEgc3BlYy4KICAgICAqCiAgICAgKiBAc2VlIERlc2NyaWJlLmpzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jawogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZGVzY3JpYmUgPSBmdW5jdGlvbiAobmFtZSwgYm9keSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5kZXNjcmliZShuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnREZXNjcmliZSA9IHNlbGYuY3VycmVudERlc2NyaWJlOwogICAgICAgICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHRoaXM7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBib2R5LmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHBhcmVudERlc2NyaWJlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2FtZSBhcyBkZXNjcmliZSwgYnV0IG1ha2VzIGRkZXNjcmliZSB0aGUgb25seSBibG9ja3MgdG8gcnVuLgogICAgICoKICAgICAqIEBzZWUgRGVzY3JpYmUuanMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5kZGVzY3JpYmUgPSBmdW5jdGlvbiAobmFtZSwgYm9keSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5kZGVzY3JpYmUobmFtZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcGFyZW50RGVzY3JpYmUgPSBzZWxmLmN1cnJlbnREZXNjcmliZTsKICAgICAgICAgICAgc2VsZi5jdXJyZW50RGVzY3JpYmUgPSB0aGlzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYm9keS5jYWxsKHRoaXMpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50RGVzY3JpYmUgPSBwYXJlbnREZXNjcmliZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSB0ZXN0IGluIGEgZGVzY3JpYmUgYmxvY2sgb2YgYSBzcGVjLgogICAgICoKICAgICAqIEBzZWUgRGVzY3JpYmUuanMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5pdCA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdGhpcy5jdXJyZW50RGVzY3JpYmUuaXQobmFtZSwgYm9keSk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2FtZSBhcyBpdCwgYnV0IG1ha2VzIGlpdCB0ZXN0cyB0aGUgb25seSB0ZXN0cyB0byBydW4uCiAgICAgKgogICAgICogQHNlZSBEZXNjcmliZS5qcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2sKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLmlpdCA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdGhpcy5jdXJyZW50RGVzY3JpYmUuaWl0KG5hbWUsIGJvZHkpOwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYmVmb3JlIGVhY2ggaXQgYmxvY2sgaW4gdGhlIGRlc2NyaWJlCiAgICAgKiAoYW5kIGJlZm9yZSBhbGwgbmVzdGVkIGRlc2NyaWJlcykuCiAgICAgKgogICAgICogQHNlZSBEZXNjcmliZS5qcwogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gQ2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuYmVmb3JlRWFjaCA9IGZ1bmN0aW9uIChib2R5KSB7CiAgICAgICAgdGhpcy5jdXJyZW50RGVzY3JpYmUuYmVmb3JlRWFjaChib2R5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGFmdGVyIGVhY2ggaXQgYmxvY2sgaW4gdGhlIGRlc2NyaWJlCiAgICAgKiAoYW5kIGJlZm9yZSBhbGwgbmVzdGVkIGRlc2NyaWJlcykuCiAgICAgKgogICAgICogQHNlZSBEZXNjcmliZS5qcwogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gQ2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuYWZ0ZXJFYWNoID0gZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5hZnRlckVhY2goYm9keSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBzcGVjIHJ1bm5lci4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIHBhcmVudCBzY29wZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuY3JlYXRlU3BlY1J1bm5lcl8gPSBmdW5jdGlvbiAoc2NvcGUpIHsKICAgICAgICB2YXIgY2hpbGQgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgdmFyIENscyA9IGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lcjsKCiAgICAgICAgLy8gRXhwb3J0IGFsbCB0aGUgbWV0aG9kcyB0byBjaGlsZCBzY29wZSBtYW51YWxseSBhcyBub3cgd2UgZG9uJ3QgbWVzcyBjb250cm9sbGVycyB3aXRoIHNjb3BlcwogICAgICAgIC8vIFRPRE8odm9qdGEpOiByZWZhY3RvciBzY2VuYXJpbyBydW5uZXIgc28gdGhhdCB0aGVzZSBvYmplY3RzIGFyZSBub3QgdGlnaHRseSBjb3VwbGVkIGFzIGN1cnJlbnQKICAgICAgICBmb3IgKHZhciBuYW1lIGluIENscy5wcm90b3R5cGUpCiAgICAgICAgICAgIGNoaWxkW25hbWVdID0gYW5ndWxhci5iaW5kKGNoaWxkLCBDbHMucHJvdG90eXBlW25hbWVdKTsKCiAgICAgICAgQ2xzLmNhbGwoY2hpbGQpOwogICAgICAgIHJldHVybiBjaGlsZDsKICAgIH07CgogICAgLyoqCiAgICAgKiBSdW5zIGFsbCB0aGUgbG9hZGVkIHRlc3RzIHdpdGggdGhlIHNwZWNpZmllZCBydW5uZXIgY2xhc3Mgb24gdGhlCiAgICAgKiBwcm92aWRlZCBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb259IGFwcGxpY2F0aW9uIEFwcCB0byByZW1vdGUgY29udHJvbC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChhcHBsaWNhdGlvbikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgJHJvb3QgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSkuZ2V0KCckcm9vdFNjb3BlJyk7CiAgICAgICAgYW5ndWxhci5leHRlbmQoJHJvb3QsIHRoaXMpOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUsIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgICAgICAkcm9vdFtuYW1lXSA9IGFuZ3VsYXIuYmluZChzZWxmLCBmbik7CiAgICAgICAgfSk7CiAgICAgICAgJHJvb3QuYXBwbGljYXRpb24gPSBhcHBsaWNhdGlvbjsKICAgICAgICAkcm9vdC5lbWl0KCdSdW5uZXJCZWdpbicpOwogICAgICAgIGFzeW5jRm9yRWFjaCh0aGlzLnJvb3REZXNjcmliZS5nZXRTcGVjcygpLCBmdW5jdGlvbiAoc3BlYywgc3BlY0RvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBkc2xDYWNoZSA9IHt9OwogICAgICAgICAgICAgICAgdmFyIHJ1bm5lciA9IHNlbGYuY3JlYXRlU3BlY1J1bm5lcl8oJHJvb3QpOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFuZ3VsYXIuc2NlbmFyaW8uZHNsLCBmdW5jdGlvbiAoZm4sIGtleSkgewogICAgICAgICAgICAgICAgICAgIGRzbENhY2hlW2tleV0gPSBmbi5jYWxsKCRyb290KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFuZ3VsYXIuc2NlbmFyaW8uZHNsLCBmdW5jdGlvbiAoZm4sIGtleSkgewogICAgICAgICAgICAgICAgICAgIHNlbGYuJHdpbmRvd1trZXldID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluZSA9IGNhbGxlckZpbGUoMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9IHJ1bm5lci4kbmV3KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHRoZSBkc2wgYWNjZXNzaWJsZSBvbiB0aGUgY3VycmVudCBjaGFpbgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5kc2wgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGRzbENhY2hlLCBmdW5jdGlvbiAoZm4sIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuZHNsW2tleV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRzbENhY2hlW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1ha2UgdGhlc2UgbWV0aG9kcyB3b3JrIG9uIHRoZSBjdXJyZW50IGNoYWluCiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmFkZEZ1dHVyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmNhbGwoYXJndW1lbnRzLCBsaW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG90eXBlLmFkZEZ1dHVyZS5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYWRkRnV0dXJlQWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm90b3R5cGUuYWRkRnV0dXJlQWN0aW9uLmFwcGx5KHNjb3BlLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRzbFtrZXldLmFwcGx5KHNjb3BlLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJ1bm5lci5ydW4oc3BlYywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJ1bm5lci4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHNwZWNEb25lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmVtaXQoJ1J1bm5lckVycm9yJywgZXJyb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdSdW5uZXJFbmQnKTsKICAgICAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogVGhpcyBjbGFzcyBpcyB0aGUgInRoaXMiIG9mIHRoZSBpdC9iZWZvcmVFYWNoL2FmdGVyRWFjaCBtZXRob2QuCiAgICAgKiBSZXNwb25zaWJpbGl0aWVzOgogICAgICogICAtICJ0aGlzIiBmb3IgaXQvYmVmb3JlRWFjaC9hZnRlckVhY2gKICAgICAqICAgLSBrZWVwIHN0YXRlIGZvciBzaW5nbGUgaXQvYmVmb3JlRWFjaC9hZnRlckVhY2ggZXhlY3V0aW9uCiAgICAgKiAgIC0ga2VlcCB0cmFjayBvZiBhbGwgb2YgdGhlIGZ1dHVyZXMgdG8gZXhlY3V0ZQogICAgICogICAtIHJ1biBzaW5nbGUgc3BlYyAoZXhlY3V0ZSBlYWNoIGZ1dHVyZSkKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuZnV0dXJlcyA9IFtdOwogICAgICAgIHRoaXMuYWZ0ZXJJbmRleCA9IDA7CiAgICB9OwoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgYSBzcGVjIHdoaWNoIGlzIGFuIGl0IGJsb2NrIHdpdGggYXNzb2NpYXRlZCBiZWZvcmUvYWZ0ZXIgZnVuY3Rpb25zCiAgICAgKiBiYXNlZCBvbiB0aGUgZGVzY3JpYmUgbmVzdGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3BlYyBBIHNwZWMgb2JqZWN0CiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHNwZWNEb25lIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIHdoZW4gdGhlIHNwZWMgZmluc2hlcy4gRnVuY3Rpb24oZXJyb3IsIGluZGV4KQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChzcGVjLCBzcGVjRG9uZSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB0aGlzLnNwZWMgPSBzcGVjOwoKICAgICAgICB0aGlzLmVtaXQoJ1NwZWNCZWdpbicsIHNwZWMpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBzcGVjLmJlZm9yZS5jYWxsKHRoaXMpOwogICAgICAgICAgICBzcGVjLmJvZHkuY2FsbCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5hZnRlckluZGV4ID0gdGhpcy5mdXR1cmVzLmxlbmd0aDsKICAgICAgICAgICAgc3BlYy5hZnRlci5jYWxsKHRoaXMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdGhpcy5lbWl0KCdTcGVjRXJyb3InLCBzcGVjLCBlKTsKICAgICAgICAgICAgdGhpcy5lbWl0KCdTcGVjRW5kJywgc3BlYyk7CiAgICAgICAgICAgIHNwZWNEb25lKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBoYW5kbGVFcnJvciA9IGZ1bmN0aW9uIChlcnJvciwgZG9uZSkgewogICAgICAgICAgICBpZiAoc2VsZi5lcnJvcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgZG9uZShudWxsLCBzZWxmLmFmdGVySW5kZXgpOwogICAgICAgIH07CgogICAgICAgIGFzeW5jRm9yRWFjaCgKICAgICAgICAgICAgdGhpcy5mdXR1cmVzLAogICAgICAgICAgICBmdW5jdGlvbiAoZnV0dXJlLCBmdXR1cmVEb25lKSB7CiAgICAgICAgICAgICAgICBzZWxmLnN0ZXAgPSBmdXR1cmU7CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoJ1N0ZXBCZWdpbicsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZ1dHVyZS5leGVjdXRlKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBzcGVjLCBmdXR1cmUsIGVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IsIGZ1dHVyZURvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuJHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1dHVyZURvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRXJyb3InLCBzcGVjLCBmdXR1cmUsIGUpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgZnV0dXJlRG9uZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoZSkgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgc3BlYywgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoJ1NwZWNFbmQnLCBzcGVjKTsKICAgICAgICAgICAgICAgIC8vIENhbGwgZG9uZSBpbiBhIHRpbWVvdXQgc28gZXhjZXB0aW9ucyBkb24ndCByZWN1cnNpdmVseQogICAgICAgICAgICAgICAgLy8gY2FsbCB0aGlzIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBzZWxmLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc3BlY0RvbmUoKTsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBZGRzIGEgbmV3IGZ1dHVyZSBhY3Rpb24uCiAgICAgKgogICAgICogTm90ZTogRG8gbm90IHBhc3MgbGluZSBtYW51YWxseS4gSXQgaGFwcGVucyBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIucHJvdG90eXBlLmFkZEZ1dHVyZSA9IGZ1bmN0aW9uIChuYW1lLCBiZWhhdmlvciwgbGluZSkgewogICAgICAgIHZhciBmdXR1cmUgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUobmFtZSwgYW5ndWxhci5iaW5kKHRoaXMsIGJlaGF2aW9yKSwgbGluZSk7CiAgICAgICAgdGhpcy5mdXR1cmVzLnB1c2goZnV0dXJlKTsKICAgICAgICByZXR1cm4gZnV0dXJlOwogICAgfTsKCiAgICAvKioKICAgICAqIEFkZHMgYSBuZXcgZnV0dXJlIGFjdGlvbiB0byBiZSBleGVjdXRlZCBvbiB0aGUgYXBwbGljYXRpb24gd2luZG93LgogICAgICoKICAgICAqIE5vdGU6IERvIG5vdCBwYXNzIGxpbmUgbWFudWFsbHkuIEl0IGhhcHBlbnMgYXV0b21hdGljYWxseS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmdXR1cmUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYmVoYXZpb3IgQmVoYXZpb3Igb2YgdGhlIGZ1dHVyZQogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBsaW5lIGZuKCkgdGhhdCByZXR1cm5zIGZpbGUvbGluZSBudW1iZXIKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLnByb3RvdHlwZS5hZGRGdXR1cmVBY3Rpb24gPSBmdW5jdGlvbiAobmFtZSwgYmVoYXZpb3IsIGxpbmUpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIE5HID0gL1xbbmdcXFw6LzsKICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmUobmFtZSwgZnVuY3Rpb24gKGRvbmUpIHsKICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvbi5leGVjdXRlQWN0aW9uKGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQpIHsKCiAgICAgICAgICAgICAgICAvL1RPRE8oZXNwcmVobik6IFJlZmFjdG9yIHRoaXMgc28gaXQgZG9lc24ndCBuZWVkIHRvIGJlIGluIGhlcmUuCiAgICAgICAgICAgICAgICAkZG9jdW1lbnQuZWxlbWVudHMgPSBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSAoc2VsZi5zZWxlY3RvciB8fCAnJykgKyAnICcgKyAoc2VsZWN0b3IgfHwgJycpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gX2pRdWVyeS50cmltKHNlbGVjdG9yKSB8fCAnKic7CiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFyZ3MsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCckJyArIChpbmRleCArIDEpLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9ICRkb2N1bWVudC5maW5kKHNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IubWF0Y2goTkcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChbJ1tuZy0nLCAnW2RhdGEtbmctJywgJ1t4LW5nLSddLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuYWRkKHNlbGVjdG9yLnJlcGxhY2UoTkcsIHZhbHVlKSwgJGRvY3VtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnc2VsZWN0b3InLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1NlbGVjdG9yICcgKyBzZWxlY3RvciArICcgZGlkIG5vdCBtYXRjaCBhbnkgZWxlbWVudHMuJwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBiZWhhdmlvci5jYWxsKHNlbGYsICR3aW5kb3csICRkb2N1bWVudCwgZG9uZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGUudHlwZSAmJiBlLnR5cGUgPT09ICdzZWxlY3RvcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZShlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LCBsaW5lKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTaGFyZWQgRFNMIHN0YXRlbWVudHMgdGhhdCBhcmUgdXNlZnVsIHRvIGFsbCBzY2VuYXJpb3MuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgcGF1c2UoKSBwYXVzZXMgdW50aWwgeW91IGNhbGwgcmVzdW1lKCkgaW4gdGhlIGNvbnNvbGUKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ3BhdXNlJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgncGF1c2luZyBmb3IgeW91IHRvIHJlc3VtZScsIGZ1bmN0aW9uIChkb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ0ludGVyYWN0aXZlUGF1c2UnLCB0aGlzLnNwZWMsIHRoaXMuc3RlcCk7CiAgICAgICAgICAgICAgICB0aGlzLiR3aW5kb3cucmVzdW1lID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgc2xlZXAoc2Vjb25kcykgcGF1c2VzIHRoZSB0ZXN0IGZvciBzcGVjaWZpZWQgbnVtYmVyIG9mIHNlY29uZHMKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ3NsZWVwJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmUoJ3NsZWVwIGZvciAnICsgdGltZSArICcgc2Vjb25kcycsIGZ1bmN0aW9uIChkb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCB0aW1lICogMTAwMCk7CiAgICAgICAgICAgICAgICB9LCB0aW1lICogMTAwMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgYnJvd3NlcigpLm5hdmlnYXRlVG8odXJsKSBMb2FkcyB0aGUgdXJsIGludG8gdGhlIGZyYW1lCiAgICAgKiAgICBicm93c2VyKCkubmF2aWdhdGVUbyh1cmwsIGZuKSB3aGVyZSBmbih1cmwpIGlzIGNhbGxlZCBhbmQgcmV0dXJucyB0aGUgVVJMIHRvIG5hdmlnYXRlIHRvCiAgICAgKiAgICBicm93c2VyKCkucmVsb2FkKCkgcmVmcmVzaCB0aGUgcGFnZSAocmVsb2FkIHRoZSBzYW1lIFVSTCkKICAgICAqICAgIGJyb3dzZXIoKS53aW5kb3cuaHJlZigpIHdpbmRvdy5sb2NhdGlvbi5ocmVmCiAgICAgKiAgICBicm93c2VyKCkud2luZG93LnBhdGgoKSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUKICAgICAqICAgIGJyb3dzZXIoKS53aW5kb3cuc2VhcmNoKCkgd2luZG93LmxvY2F0aW9uLnNlYXJjaAogICAgICogICAgYnJvd3NlcigpLndpbmRvdy5oYXNoKCkgd2luZG93LmxvY2F0aW9uLmhhc2ggd2l0aG91dCAjIHByZWZpeAogICAgICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkudXJsKCkgc2VlIG5nLiRsb2NhdGlvbiN1cmwKICAgICAqICAgIGJyb3dzZXIoKS5sb2NhdGlvbigpLnBhdGgoKSBzZWUgbmcuJGxvY2F0aW9uI3BhdGgKICAgICAqICAgIGJyb3dzZXIoKS5sb2NhdGlvbigpLnNlYXJjaCgpIHNlZSBuZy4kbG9jYXRpb24jc2VhcmNoCiAgICAgKiAgICBicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkgc2VlIG5nLiRsb2NhdGlvbiNoYXNoCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdicm93c2VyJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGFpbiA9IHt9OwoKICAgICAgICBjaGFpbi5uYXZpZ2F0ZVRvID0gZnVuY3Rpb24gKHVybCwgZGVsZWdhdGUpIHsKICAgICAgICAgICAgdmFyIGFwcGxpY2F0aW9uID0gdGhpcy5hcHBsaWNhdGlvbjsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlKCJicm93c2VyIG5hdmlnYXRlIHRvICciICsgdXJsICsgIiciLCBmdW5jdGlvbiAoZG9uZSkgewogICAgICAgICAgICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgdXJsID0gZGVsZWdhdGUuY2FsbCh0aGlzLCB1cmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXBwbGljYXRpb24ubmF2aWdhdGVUbyh1cmwsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsIHVybCk7CiAgICAgICAgICAgICAgICB9LCBkb25lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4ucmVsb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXBwbGljYXRpb24gPSB0aGlzLmFwcGxpY2F0aW9uOwogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ2Jyb3dzZXIgcmVsb2FkJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdmFyIGhyZWYgPSAkd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbi5uYXZpZ2F0ZVRvKGhyZWYsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsIGhyZWYpOwogICAgICAgICAgICAgICAgfSwgZG9uZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGNoYWluLndpbmRvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFwaSA9IHt9OwoKICAgICAgICAgICAgYXBpLmhyZWYgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ3dpbmRvdy5sb2NhdGlvbi5ocmVmJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXBpLnBhdGggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ3dpbmRvdy5sb2NhdGlvbi5wYXRoJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwaS5zZWFyY2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ3dpbmRvdy5sb2NhdGlvbi5zZWFyY2gnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwaS5oYXNoID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCd3aW5kb3cubG9jYXRpb24uaGFzaCcsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICR3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGFwaTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5sb2NhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFwaSA9IHt9OwoKICAgICAgICAgICAgYXBpLnVybCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignJGxvY2F0aW9uLnVybCgpJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgJGRvY3VtZW50LmluamVjdG9yKCkuZ2V0KCckbG9jYXRpb24nKS51cmwoKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwaS5wYXRoID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCckbG9jYXRpb24ucGF0aCgpJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgJGRvY3VtZW50LmluamVjdG9yKCkuZ2V0KCckbG9jYXRpb24nKS5wYXRoKCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhcGkuc2VhcmNoID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCckbG9jYXRpb24uc2VhcmNoKCknLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuaW5qZWN0b3IoKS5nZXQoJyRsb2NhdGlvbicpLnNlYXJjaCgpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXBpLmhhc2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJyRsb2NhdGlvbi5oYXNoKCknLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuaW5qZWN0b3IoKS5nZXQoJyRsb2NhdGlvbicpLmhhc2goKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBhcGk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYWluOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgZXhwZWN0KGZ1dHVyZSkue21hdGNoZXJ9IHdoZXJlIG1hdGNoZXIgaXMgb25lIG9mIHRoZSBtYXRjaGVycyBkZWZpbmVkCiAgICAgKiAgICB3aXRoIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcgogICAgICoKICAgICAqIGV4LiBleHBlY3QoYmluZGluZygibmFtZSIpKS50b0VxdWFsKCJFbGxpb3R0IikKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ2V4cGVjdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2hhaW4gPSBhbmd1bGFyLmV4dGVuZCh7fSwgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKTsKCiAgICAgICAgY2hhaW4ubm90ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmludmVyc2UgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmdXR1cmUpIHsKICAgICAgICAgICAgdGhpcy5mdXR1cmUgPSBmdXR1cmU7CiAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBVc2FnZToKICAgICAqICAgIHVzaW5nKHNlbGVjdG9yLCBsYWJlbCkgc2NvcGVzIHRoZSBuZXh0IERTTCBlbGVtZW50IHNlbGVjdGlvbgogICAgICoKICAgICAqIGV4LgogICAgICogICB1c2luZygnI2ZvbycsICInRm9vJyB0ZXh0IGZpZWxkIikuaW5wdXQoJ2JhcicpCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsKCd1c2luZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGVjdG9yLCBsYWJlbCkgewogICAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gX2pRdWVyeS50cmltKCh0aGlzLnNlbGVjdG9yIHx8ICcnKSArICcgJyArIHNlbGVjdG9yKTsKICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNTdHJpbmcobGFiZWwpICYmIGxhYmVsLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbCA9IGxhYmVsICsgJyAoICcgKyB0aGlzLnNlbGVjdG9yICsgJyApJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubGFiZWwgPSB0aGlzLnNlbGVjdG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmRzbDsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBVc2FnZToKICAgICAqICAgIGJpbmRpbmcobmFtZSkgcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGZpcnN0IG1hdGNoaW5nIGJpbmRpbmcKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ2JpbmRpbmcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigic2VsZWN0IGJpbmRpbmcgJyIgKyBuYW1lICsgIiciLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gJGRvY3VtZW50LmVsZW1lbnRzKCkuYmluZGluZ3MoJHdpbmRvdy5hbmd1bGFyLmVsZW1lbnQsIG5hbWUpOwogICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoIkJpbmRpbmcgc2VsZWN0b3IgJyIgKyBuYW1lICsgIicgZGlkIG5vdCBtYXRjaC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgdmFsdWVzWzBdKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBpbnB1dChuYW1lKS5lbnRlcih2YWx1ZSkgZW50ZXJzIHZhbHVlIGluIGlucHV0IHdpdGggc3BlY2lmaWVkIG5hbWUKICAgICAqICAgIGlucHV0KG5hbWUpLmNoZWNrKCkgY2hlY2tzIGNoZWNrYm94CiAgICAgKiAgICBpbnB1dChuYW1lKS5zZWxlY3QodmFsdWUpIHNlbGVjdHMgdGhlIHJhZGlvIGJ1dHRvbiB3aXRoIHNwZWNpZmllZCBuYW1lL3ZhbHVlCiAgICAgKiAgICBpbnB1dChuYW1lKS52YWwoKSByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdpbnB1dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2hhaW4gPSB7fTsKICAgICAgICB2YXIgc3VwcG9ydElucHV0RXZlbnQgPSAnb25pbnB1dCcgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykgJiYgbXNpZSAhPSA5OwoKICAgICAgICBjaGFpbi5lbnRlciA9IGZ1bmN0aW9uICh2YWx1ZSwgZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJpbnB1dCAnIiArIHRoaXMubmFtZSArICInIGVudGVyICciICsgdmFsdWUgKyAiJyIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnW25nXFw6bW9kZWw9IiQxIl0nLCB0aGlzLm5hbWUpLmZpbHRlcignOmlucHV0Jyk7CiAgICAgICAgICAgICAgICBpbnB1dC52YWwodmFsdWUpOwogICAgICAgICAgICAgICAgaW5wdXQudHJpZ2dlcihldmVudCB8fCAoc3VwcG9ydElucHV0RXZlbnQgPyAnaW5wdXQnIDogJ2NoYW5nZScpKTsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4uY2hlY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigiY2hlY2tib3ggJyIgKyB0aGlzLm5hbWUgKyAiJyB0b2dnbGUiLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSAkZG9jdW1lbnQuZWxlbWVudHMoJ1tuZ1xcOm1vZGVsPSIkMSJdJywgdGhpcy5uYW1lKS5maWx0ZXIoJzpjaGVja2JveCcpOwogICAgICAgICAgICAgICAgaW5wdXQudHJpZ2dlcignY2xpY2snKTsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4uc2VsZWN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmFkaW8gYnV0dG9uICciICsgdGhpcy5uYW1lICsgIicgdG9nZ2xlICciICsgdmFsdWUgKyAiJyIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC4KICAgICAgICAgICAgICAgICAgICBlbGVtZW50cygnW25nXFw6bW9kZWw9IiQxIl1bdmFsdWU9IiQyIl0nLCB0aGlzLm5hbWUsIHZhbHVlKS5maWx0ZXIoJzpyYWRpbycpOwogICAgICAgICAgICAgICAgaW5wdXQudHJpZ2dlcignY2xpY2snKTsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4udmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJldHVybiBpbnB1dCB2YWwiLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSAkZG9jdW1lbnQuZWxlbWVudHMoJ1tuZ1xcOm1vZGVsPSIkMSJdJywgdGhpcy5uYW1lKS5maWx0ZXIoJzppbnB1dCcpOwogICAgICAgICAgICAgICAgZG9uZShudWxsLCBpbnB1dC52YWwoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgcmVwZWF0ZXIoJyNwcm9kdWN0cyB0YWJsZScsICdQcm9kdWN0IExpc3QnKS5jb3VudCgpIG51bWJlciBvZiByb3dzCiAgICAgKiAgICByZXBlYXRlcignI3Byb2R1Y3RzIHRhYmxlJywgJ1Byb2R1Y3QgTGlzdCcpLnJvdygxKSBhbGwgYmluZGluZ3MgaW4gcm93IGFzIGFuIGFycmF5CiAgICAgKiAgICByZXBlYXRlcignI3Byb2R1Y3RzIHRhYmxlJywgJ1Byb2R1Y3QgTGlzdCcpLmNvbHVtbigncHJvZHVjdC5uYW1lJykgYWxsIHZhbHVlcyBhY3Jvc3MgYWxsIHJvd3MgaW4gYW4gYXJyYXkKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ3JlcGVhdGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGFpbiA9IHt9OwoKICAgICAgICBjaGFpbi5jb3VudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyZXBlYXRlciAnIiArIHRoaXMubGFiZWwgKyAiJyBjb3VudCIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuZWxlbWVudHMoKS5sZW5ndGgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGNoYWluLmNvbHVtbiA9IGZ1bmN0aW9uIChiaW5kaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmVwZWF0ZXIgJyIgKyB0aGlzLmxhYmVsICsgIicgY29sdW1uICciICsgYmluZGluZyArICInIiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuZWxlbWVudHMoKS5iaW5kaW5ncygkd2luZG93LmFuZ3VsYXIuZWxlbWVudCwgYmluZGluZykpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5yb3cgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyZXBlYXRlciAnIiArIHRoaXMubGFiZWwgKyAiJyByb3cgJyIgKyBpbmRleCArICInIiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSAkZG9jdW1lbnQuZWxlbWVudHMoKS5zbGljZShpbmRleCwgaW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIGlmICghbWF0Y2hlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoJ3JvdyAnICsgaW5kZXggKyAnIG91dCBvZiBib3VuZHMnKTsKICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgbWF0Y2hlcy5iaW5kaW5ncygkd2luZG93LmFuZ3VsYXIuZWxlbWVudCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGVjdG9yLCBsYWJlbCkgewogICAgICAgICAgICB0aGlzLmRzbC51c2luZyhzZWxlY3RvciwgbGFiZWwpOwogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBzZWxlY3QobmFtZSkub3B0aW9uKCd2YWx1ZScpIHNlbGVjdCBvbmUgb3B0aW9uCiAgICAgKiAgICBzZWxlY3QobmFtZSkub3B0aW9ucygndmFsdWUxJywgJ3ZhbHVlMicsIC4uLikgc2VsZWN0IG9wdGlvbnMgZnJvbSBhIG11bHRpIHNlbGVjdAogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgnc2VsZWN0JywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGFpbiA9IHt9OwoKICAgICAgICBjaGFpbi5vcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJzZWxlY3QgJyIgKyB0aGlzLm5hbWUgKyAiJyBvcHRpb24gJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdmFyIHNlbGVjdCA9ICRkb2N1bWVudC5lbGVtZW50cygnc2VsZWN0W25nXFw6bW9kZWw9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IHNlbGVjdC5maW5kKCdvcHRpb25bdmFsdWU9IicgKyB2YWx1ZSArICciXScpOwogICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3QudmFsKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uID0gc2VsZWN0LmZpbmQoJ29wdGlvbjpjb250YWlucygiJyArIHZhbHVlICsgJyIpJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0LnZhbChvcHRpb24udmFsKCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGVjdC50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4ub3B0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJzZWxlY3QgJyIgKyB0aGlzLm5hbWUgKyAiJyBvcHRpb25zICciICsgdmFsdWVzICsgIiciLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbXVsdGlwbGVdW25nXFw6bW9kZWw9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICAgICAgICAgICAgc2VsZWN0LnZhbCh2YWx1ZXMpOwogICAgICAgICAgICAgICAgc2VsZWN0LnRyaWdnZXIoJ2NoYW5nZScpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgcmV0dXJuIGNoYWluOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLmNvdW50KCkgZ2V0IHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdGhhdCBtYXRjaCBzZWxlY3RvcgogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLmNsaWNrKCkgY2xpY2tzIGFuIGVsZW1lbnQKICAgICAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS5xdWVyeShmbikgZXhlY3V0ZXMgZm4oc2VsZWN0ZWRFbGVtZW50cywgZG9uZSkKICAgICAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS57bWV0aG9kfSgpIGdldHMgdGhlIHZhbHVlIChhcyBkZWZpbmVkIGJ5IGpRdWVyeSwgZXguIHZhbCkKICAgICAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS57bWV0aG9kfSh2YWx1ZSkgc2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gdmFsKQogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnttZXRob2R9KGtleSkgZ2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gYXR0cikKICAgICAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS57bWV0aG9kfShrZXksIHZhbHVlKSBzZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiBhdHRyKQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgnZWxlbWVudCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgS0VZX1ZBTFVFX01FVEhPRFMgPSBbJ2F0dHInLCAnY3NzJywgJ3Byb3AnXTsKICAgICAgICB2YXIgVkFMVUVfTUVUSE9EUyA9IFsKICAgICAgICAgICAgJ3ZhbCcsICd0ZXh0JywgJ2h0bWwnLCAnaGVpZ2h0JywgJ2lubmVySGVpZ2h0JywgJ291dGVySGVpZ2h0JywgJ3dpZHRoJywKICAgICAgICAgICAgJ2lubmVyV2lkdGgnLCAnb3V0ZXJXaWR0aCcsICdwb3NpdGlvbicsICdzY3JvbGxMZWZ0JywgJ3Njcm9sbFRvcCcsICdvZmZzZXQnCiAgICAgICAgXTsKICAgICAgICB2YXIgY2hhaW4gPSB7fTsKCiAgICAgICAgY2hhaW4uY291bnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBjb3VudCIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuZWxlbWVudHMoKS5sZW5ndGgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGNoYWluLmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgY2xpY2siLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudHMgPSAkZG9jdW1lbnQuZWxlbWVudHMoKTsKICAgICAgICAgICAgICAgIHZhciBocmVmID0gZWxlbWVudHMuYXR0cignaHJlZicpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50UHJvY2Vzc0RlZmF1bHQgPSBlbGVtZW50cy50cmlnZ2VyKCdjbGljaycpWzBdOwoKICAgICAgICAgICAgICAgIGlmIChocmVmICYmIGVsZW1lbnRzWzBdLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICdBJyAmJiBldmVudFByb2Nlc3NEZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvbi5uYXZpZ2F0ZVRvKGhyZWYsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICAgIH0sIGRvbmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGNoYWluLnF1ZXJ5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignZWxlbWVudCAnICsgdGhpcy5sYWJlbCArICcgY3VzdG9tIHF1ZXJ5JywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgZm4uY2FsbCh0aGlzLCAkZG9jdW1lbnQuZWxlbWVudHMoKSwgZG9uZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChLRVlfVkFMVUVfTUVUSE9EUywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgY2hhaW5bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgICAgIGZ1dHVyZU5hbWUgPSAoYXJncy5sZW5ndGggPT0gMSkKICAgICAgICAgICAgICAgICAgICAgICAgPyAiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBnZXQgIiArIG1ldGhvZE5hbWUgKyAiICciICsgbmFtZSArICInIgogICAgICAgICAgICAgICAgICAgICAgICA6ICJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIHNldCAiICsgbWV0aG9kTmFtZSArICIgJyIgKyBuYW1lICsgIicgdG8gIiArICInIiArIHZhbHVlICsgIiciOwoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbihmdXR1cmVOYW1lLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSAkZG9jdW1lbnQuZWxlbWVudHMoKTsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsIGVsZW1lbnRbbWV0aG9kTmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChWQUxVRV9NRVRIT0RTLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewogICAgICAgICAgICBjaGFpblttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgICAgICAgICAgZnV0dXJlTmFtZSA9IChhcmdzLmxlbmd0aCA9PSAwKQogICAgICAgICAgICAgICAgICAgICAgICA/ICJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInICIgKyBtZXRob2ROYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIDogZnV0dXJlTmFtZSA9ICJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIHNldCAiICsgbWV0aG9kTmFtZSArICIgdG8gJyIgKyB2YWx1ZSArICInIjsKCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oZnV0dXJlTmFtZSwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gJGRvY3VtZW50LmVsZW1lbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCBlbGVtZW50W21ldGhvZE5hbWVdLmFwcGx5KGVsZW1lbnQsIGFyZ3MpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGVjdG9yLCBsYWJlbCkgewogICAgICAgICAgICB0aGlzLmRzbC51c2luZyhzZWxlY3RvciwgbGFiZWwpOwogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogTWF0Y2hlcnMgZm9yIGltcGxlbWVudGluZyBzcGVjcy4gRm9sbG93cyB0aGUgSmFzbWluZSBzcGVjIGNvbnZlbnRpb25zLgogICAgICovCgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0VxdWFsJywgZnVuY3Rpb24gKGV4cGVjdGVkKSB7CiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKHRoaXMuYWN0dWFsLCBleHBlY3RlZCk7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmUnLCBmdW5jdGlvbiAoZXhwZWN0ZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5hY3R1YWwgPT09IGV4cGVjdGVkOwogICAgfSk7CgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlRGVmaW5lZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gYW5ndWxhci5pc0RlZmluZWQodGhpcy5hY3R1YWwpOwogICAgfSk7CgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlVHJ1dGh5JywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFjdHVhbDsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZUZhbHN5JywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAhdGhpcy5hY3R1YWw7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvTWF0Y2gnLCBmdW5jdGlvbiAoZXhwZWN0ZWQpIHsKICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChleHBlY3RlZCkudGVzdCh0aGlzLmFjdHVhbCk7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVOdWxsJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFjdHVhbCA9PT0gbnVsbDsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9Db250YWluJywgZnVuY3Rpb24gKGV4cGVjdGVkKSB7CiAgICAgICAgcmV0dXJuIGluY2x1ZGVzKHRoaXMuYWN0dWFsLCBleHBlY3RlZCk7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVMZXNzVGhhbicsIGZ1bmN0aW9uIChleHBlY3RlZCkgewogICAgICAgIHJldHVybiB0aGlzLmFjdHVhbCA8IGV4cGVjdGVkOwogICAgfSk7CgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlR3JlYXRlclRoYW4nLCBmdW5jdGlvbiAoZXhwZWN0ZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5hY3R1YWwgPiBleHBlY3RlZDsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNlciBJbnRlcmZhY2UgZm9yIHRoZSBTY2VuYXJpbyBSdW5uZXIuCiAgICAgKgogICAgICogVE9ETyhlc3ByZWhuKTogVGhpcyBzaG91bGQgYmUgcmVmYWN0b3JlZCBub3cgdGhhdCBPYmplY3RNb2RlbCBleGlzdHMKICAgICAqICB0byB1c2UgYW5ndWxhciBiaW5kaW5ncyBmb3IgdGhlIFVJLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCgnaHRtbCcsIGZ1bmN0aW9uIChjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgICAgICAgdmFyIHNwZWNVaU1hcCA9IHt9LAogICAgICAgICAgICBsYXN0U3RlcFVpTWFwID0ge307CgogICAgICAgIGNvbnRleHQuYXBwZW5kKAogICAgICAgICAgICAnPGRpdiBpZD0iaGVhZGVyIj4nICsKICAgICAgICAgICAgICAgICcgIDxoMT48c3BhbiBjbGFzcz0iYW5ndWxhciI+QW5ndWxhckpTPC9zcGFuPjogU2NlbmFyaW8gVGVzdCBSdW5uZXI8L2gxPicgKwogICAgICAgICAgICAgICAgJyAgPHVsIGlkPSJzdGF0dXMtbGVnZW5kIiBjbGFzcz0ic3RhdHVzLWRpc3BsYXkiPicgKwogICAgICAgICAgICAgICAgJyAgICA8bGkgY2xhc3M9InN0YXR1cy1lcnJvciI+MCBFcnJvcnM8L2xpPicgKwogICAgICAgICAgICAgICAgJyAgICA8bGkgY2xhc3M9InN0YXR1cy1mYWlsdXJlIj4wIEZhaWx1cmVzPC9saT4nICsKICAgICAgICAgICAgICAgICcgICAgPGxpIGNsYXNzPSJzdGF0dXMtc3VjY2VzcyI+MCBQYXNzZWQ8L2xpPicgKwogICAgICAgICAgICAgICAgJyAgPC91bD4nICsKICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICc8ZGl2IGlkPSJzcGVjcyI+JyArCiAgICAgICAgICAgICAgICAnICA8ZGl2IGNsYXNzPSJ0ZXN0LWNoaWxkcmVuIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgKTsKCiAgICAgICAgcnVubmVyLm9uKCdJbnRlcmFjdGl2ZVBhdXNlJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIHVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXTsKICAgICAgICAgICAgdWkuZmluZCgnLnRlc3QtdGl0bGUnKS4KICAgICAgICAgICAgICAgIGh0bWwoJ3BhdXNlZC4uLiA8YSBocmVmPSJqYXZhc2NyaXB0OnJlc3VtZSgpIj5yZXN1bWU8L2E+IHdoZW4gcmVhZHkuJyk7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3BlY0JlZ2luJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIHVpID0gZmluZENvbnRleHQoc3BlYyk7CiAgICAgICAgICAgIHVpLmZpbmQoJz4gLnRlc3RzJykuYXBwZW5kKAogICAgICAgICAgICAgICAgJzxsaSBjbGFzcz0ic3RhdHVzLXBlbmRpbmcgdGVzdC1pdCI+PC9saT4nCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHVpID0gdWkuZmluZCgnPiAudGVzdHMgbGk6bGFzdCcpOwogICAgICAgICAgICB1aS5hcHBlbmQoCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idGVzdC1pbmZvIj4nICsKICAgICAgICAgICAgICAgICAgICAnICA8cCBjbGFzcz0idGVzdC10aXRsZSI+JyArCiAgICAgICAgICAgICAgICAgICAgJyAgICA8c3BhbiBjbGFzcz0idGltZXItcmVzdWx0Ij48L3NwYW4+JyArCiAgICAgICAgICAgICAgICAgICAgJyAgICA8c3BhbiBjbGFzcz0idGVzdC1uYW1lIj48L3NwYW4+JyArCiAgICAgICAgICAgICAgICAgICAgJyAgPC9wPicgKwogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ic2Nyb2xscGFuZSI+JyArCiAgICAgICAgICAgICAgICAgICAgJyAgPG9sIGNsYXNzPSJ0ZXN0LWFjdGlvbnMiPjwvb2w+JyArCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdWkuZmluZCgnPiAudGVzdC1pbmZvIC50ZXN0LW5hbWUnKS50ZXh0KHNwZWMubmFtZSk7CiAgICAgICAgICAgIHVpLmZpbmQoJz4gLnRlc3QtaW5mbycpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBzY3JvbGxwYW5lID0gdWkuZmluZCgnPiAuc2Nyb2xscGFuZScpOwogICAgICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBzY3JvbGxwYW5lLmZpbmQoJz4gLnRlc3QtYWN0aW9ucycpOwogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBjb250ZXh0LmZpbmQoJz4gLnRlc3QtaW5mbyAudGVzdC1uYW1lJyk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9ucy5maW5kKCc6dmlzaWJsZScpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGFjdGlvbnMuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIG5hbWUucmVtb3ZlQ2xhc3MoJ29wZW4nKS5hZGRDbGFzcygnY2xvc2VkJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFjdGlvbnMuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsVG9wJywgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxIZWlnaHQnKSk7CiAgICAgICAgICAgICAgICAgICAgbmFtZS5yZW1vdmVDbGFzcygnY2xvc2VkJykuYWRkQ2xhc3MoJ29wZW4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzcGVjVWlNYXBbc3BlYy5pZF0gPSB1aTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTcGVjRXJyb3InLCBmdW5jdGlvbiAoc3BlYywgZXJyb3IpIHsKICAgICAgICAgICAgdmFyIHVpID0gc3BlY1VpTWFwW3NwZWMuaWRdOwogICAgICAgICAgICB1aS5hcHBlbmQoJzxwcmU+PC9wcmU+Jyk7CiAgICAgICAgICAgIHVpLmZpbmQoJz4gcHJlJykudGV4dChmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIHVpID0gc3BlY1VpTWFwW3NwZWMuaWRdOwogICAgICAgICAgICBzcGVjID0gbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKTsKICAgICAgICAgICAgdWkucmVtb3ZlQ2xhc3MoJ3N0YXR1cy1wZW5kaW5nJyk7CiAgICAgICAgICAgIHVpLmFkZENsYXNzKCdzdGF0dXMtJyArIHNwZWMuc3RhdHVzKTsKICAgICAgICAgICAgdWkuZmluZCgiPiAudGVzdC1pbmZvIC50aW1lci1yZXN1bHQiKS50ZXh0KHNwZWMuZHVyYXRpb24gKyAibXMiKTsKICAgICAgICAgICAgaWYgKHNwZWMuc3RhdHVzID09PSAnc3VjY2VzcycpIHsKICAgICAgICAgICAgICAgIHVpLmZpbmQoJz4gLnRlc3QtaW5mbyAudGVzdC1uYW1lJykuYWRkQ2xhc3MoJ2Nsb3NlZCcpOwogICAgICAgICAgICAgICAgdWkuZmluZCgnPiAuc2Nyb2xscGFuZSAudGVzdC1hY3Rpb25zJykuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZVRvdGFscyhzcGVjLnN0YXR1cyk7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3RlcEJlZ2luJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXApIHsKICAgICAgICAgICAgdmFyIHVpID0gc3BlY1VpTWFwW3NwZWMuaWRdOwogICAgICAgICAgICBzcGVjID0gbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKTsKICAgICAgICAgICAgc3RlcCA9IHNwZWMuZ2V0TGFzdFN0ZXAoKTsKICAgICAgICAgICAgdWkuZmluZCgnPiAuc2Nyb2xscGFuZSAudGVzdC1hY3Rpb25zJykuYXBwZW5kKCc8bGkgY2xhc3M9InN0YXR1cy1wZW5kaW5nIj48L2xpPicpOwogICAgICAgICAgICB2YXIgc3RlcFVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXSA9IHVpLmZpbmQoJz4gLnNjcm9sbHBhbmUgLnRlc3QtYWN0aW9ucyBsaTpsYXN0Jyk7CiAgICAgICAgICAgIHN0ZXBVaS5hcHBlbmQoCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idGltZXItcmVzdWx0Ij48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idGVzdC10aXRsZSI+PC9kaXY+JwogICAgICAgICAgICApOwogICAgICAgICAgICBzdGVwVWkuZmluZCgnPiAudGVzdC10aXRsZScpLnRleHQoc3RlcC5uYW1lKTsKICAgICAgICAgICAgdmFyIHNjcm9sbHBhbmUgPSBzdGVwVWkucGFyZW50cygnLnNjcm9sbHBhbmUnKTsKICAgICAgICAgICAgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxUb3AnLCBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbEhlaWdodCcpKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRmFpbHVyZScsIGZ1bmN0aW9uIChzcGVjLCBzdGVwLCBlcnJvcikgewogICAgICAgICAgICB2YXIgdWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgICAgICAgICBhZGRFcnJvcih1aSwgc3RlcC5saW5lLCBlcnJvcik7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXAsIGVycm9yKSB7CiAgICAgICAgICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIGFkZEVycm9yKHVpLCBzdGVwLmxpbmUsIGVycm9yKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRW5kJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXApIHsKICAgICAgICAgICAgdmFyIHN0ZXBVaSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIHNwZWMgPSBtb2RlbC5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICBzdGVwID0gc3BlYy5nZXRMYXN0U3RlcCgpOwogICAgICAgICAgICBzdGVwVWkuZmluZCgnLnRpbWVyLXJlc3VsdCcpLnRleHQoc3RlcC5kdXJhdGlvbiArICdtcycpOwogICAgICAgICAgICBzdGVwVWkucmVtb3ZlQ2xhc3MoJ3N0YXR1cy1wZW5kaW5nJyk7CiAgICAgICAgICAgIHN0ZXBVaS5hZGRDbGFzcygnc3RhdHVzLScgKyBzdGVwLnN0YXR1cyk7CiAgICAgICAgICAgIHZhciBzY3JvbGxwYW5lID0gc3BlY1VpTWFwW3NwZWMuaWRdLmZpbmQoJz4gLnNjcm9sbHBhbmUnKTsKICAgICAgICAgICAgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxUb3AnLCBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbEhlaWdodCcpKTsKICAgICAgICB9KTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRmluZHMgdGhlIGNvbnRleHQgb2YgYSBzcGVjIGJsb2NrIGRlZmluZWQgYnkgdGhlIHBhc3NlZCBkZWZpbml0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFRoZSBkZWZpbml0aW9uIGNyZWF0ZWQgYnkgdGhlIERlc2NyaWJlIG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBmaW5kQ29udGV4dChzcGVjKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q29udGV4dCA9IGNvbnRleHQuZmluZCgnI3NwZWNzJyk7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChtb2RlbC5nZXREZWZpbml0aW9uUGF0aChzcGVjKSwgZnVuY3Rpb24gKGRlZm4pIHsKICAgICAgICAgICAgICAgIHZhciBpZCA9ICdkZXNjcmliZS0nICsgZGVmbi5pZDsKICAgICAgICAgICAgICAgIGlmICghY29udGV4dC5maW5kKCcjJyArIGlkKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q29udGV4dC5maW5kKCc+IC50ZXN0LWNoaWxkcmVuJykuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idGVzdC1kZXNjcmliZSIgaWQ9IicgKyBpZCArICciPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAgPGgyPjwvaDI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnICA8ZGl2IGNsYXNzPSJ0ZXN0LWNoaWxkcmVuIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgIDx1bCBjbGFzcz0idGVzdHMiPjwvdWw+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JwogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5maW5kKCcjJyArIGlkKS5maW5kKCc+IGgyJykudGV4dCgnZGVzY3JpYmU6ICcgKyBkZWZuLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudENvbnRleHQgPSBjb250ZXh0LmZpbmQoJyMnICsgaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZmluZCgnI2Rlc2NyaWJlLScgKyBzcGVjLmRlZmluaXRpb24uaWQpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogVXBkYXRlcyB0aGUgdGVzdCBjb3VudGVyIGZvciB0aGUgc3RhdHVzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRoZSBzdGF0dXMuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVG90YWxzKHN0YXR1cykgewogICAgICAgICAgICB2YXIgbGVnZW5kID0gY29udGV4dC5maW5kKCcjc3RhdHVzLWxlZ2VuZCAuc3RhdHVzLScgKyBzdGF0dXMpOwogICAgICAgICAgICB2YXIgcGFydHMgPSBsZWdlbmQudGV4dCgpLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IChwYXJ0c1swXSAqIDEpICsgMTsKICAgICAgICAgICAgbGVnZW5kLnRleHQodmFsdWUgKyAnICcgKyBwYXJ0c1sxXSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBZGQgYW4gZXJyb3IgdG8gYSBzdGVwLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFRoZSBKUXVlcnkgd3JhcHBlZCBjb250ZXh0CiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbigpIHRoYXQgc2hvdWxkIHJldHVybiB0aGUgZmlsZS9saW5lIG51bWJlciBvZiB0aGUgZXJyb3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGhlIGVycm9yLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFkZEVycm9yKGNvbnRleHQsIGxpbmUsIGVycm9yKSB7CiAgICAgICAgICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUnKS5hcHBlbmQoJzxwcmU+PC9wcmU+Jyk7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gX2pRdWVyeS50cmltKGxpbmUoKSArICdcblxuJyArIGZvcm1hdEV4Y2VwdGlvbihlcnJvcikpOwogICAgICAgICAgICBjb250ZXh0LmZpbmQoJy50ZXN0LXRpdGxlIHByZTpsYXN0JykudGV4dChtZXNzYWdlKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBKU09OIG91dHB1dCBpbnRvIGEgY29udGV4dC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ2pzb24nLCBmdW5jdGlvbiAoY29udGV4dCwgcnVubmVyLCBtb2RlbCkgewogICAgICAgIG1vZGVsLm9uKCdSdW5uZXJFbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbnRleHQudGV4dChhbmd1bGFyLnRvSnNvbihtb2RlbC52YWx1ZSkpOwogICAgICAgIH0pOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBHZW5lcmF0ZXMgWE1MIG91dHB1dCBpbnRvIGEgY29udGV4dC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ3htbCcsIGZ1bmN0aW9uIChjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgICAgICAgdmFyICQgPSBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICByZXR1cm4gbmV3IGNvbnRleHQuaW5pdChhcmdzKTsKICAgICAgICB9OwogICAgICAgIG1vZGVsLm9uKCdSdW5uZXJFbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzY2VuYXJpbyA9ICQoJzxzY2VuYXJpbz48L3NjZW5hcmlvPicpOwogICAgICAgICAgICBjb250ZXh0LmFwcGVuZChzY2VuYXJpbyk7CiAgICAgICAgICAgIHNlcmlhbGl6ZVhtbChzY2VuYXJpbywgbW9kZWwudmFsdWUpOwogICAgICAgIH0pOwoKICAgICAgICAvKioKICAgICAgICAgKiBDb252ZXJ0IHRoZSB0cmVlIGludG8gWE1MLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgalF1ZXJ5IGNvbnRleHQgdG8gYWRkIHRoZSBYTUwgdG8uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRyZWUgbm9kZSB0byBzZXJpYWxpemUKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBzZXJpYWxpemVYbWwoY29udGV4dCwgdHJlZSkgewogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2godHJlZS5jaGlsZHJlbiwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVzY3JpYmVDb250ZXh0ID0gJCgnPGRlc2NyaWJlPjwvZGVzY3JpYmU+Jyk7CiAgICAgICAgICAgICAgICBkZXNjcmliZUNvbnRleHQuYXR0cignaWQnLCBjaGlsZC5pZCk7CiAgICAgICAgICAgICAgICBkZXNjcmliZUNvbnRleHQuYXR0cignbmFtZScsIGNoaWxkLm5hbWUpOwogICAgICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoZGVzY3JpYmVDb250ZXh0KTsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZVhtbChkZXNjcmliZUNvbnRleHQsIGNoaWxkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBpdHMgPSAkKCc8aXRzPjwvaXRzPicpOwogICAgICAgICAgICBjb250ZXh0LmFwcGVuZChpdHMpOwogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2godHJlZS5zcGVjcywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgICAgIHZhciBpdCA9ICQoJzxpdD48L2l0PicpOwogICAgICAgICAgICAgICAgaXQuYXR0cignaWQnLCBzcGVjLmlkKTsKICAgICAgICAgICAgICAgIGl0LmF0dHIoJ25hbWUnLCBzcGVjLm5hbWUpOwogICAgICAgICAgICAgICAgaXQuYXR0cignZHVyYXRpb24nLCBzcGVjLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIGl0LmF0dHIoJ3N0YXR1cycsIHNwZWMuc3RhdHVzKTsKICAgICAgICAgICAgICAgIGl0cy5hcHBlbmQoaXQpOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNwZWMuc3RlcHMsIGZ1bmN0aW9uIChzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ZXBDb250ZXh0ID0gJCgnPHN0ZXA+PC9zdGVwPicpOwogICAgICAgICAgICAgICAgICAgIHN0ZXBDb250ZXh0LmF0dHIoJ25hbWUnLCBzdGVwLm5hbWUpOwogICAgICAgICAgICAgICAgICAgIHN0ZXBDb250ZXh0LmF0dHIoJ2R1cmF0aW9uJywgc3RlcC5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgc3RlcENvbnRleHQuYXR0cignc3RhdHVzJywgc3RlcC5zdGF0dXMpOwogICAgICAgICAgICAgICAgICAgIGl0LmFwcGVuZChzdGVwQ29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZXAuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gJCgnPGVycm9yPjwvZXJyb3I+Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBDb250ZXh0LmFwcGVuZChlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnRleHQoZm9ybWF0RXhjZXB0aW9uKHN0ZXAuZXJyb3IpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZ2xvYmFsIHZhbHVlICRyZXN1bHQgd2l0aCB0aGUgcmVzdWx0IG9mIHRoZSBydW5uZXIuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0KCdvYmplY3QnLCBmdW5jdGlvbiAoY29udGV4dCwgcnVubmVyLCBtb2RlbCkgewogICAgICAgIHJ1bm5lci4kd2luZG93LiRyZXN1bHQgPSBtb2RlbC52YWx1ZTsKICAgIH0pOwoKICAgIGJpbmRKUXVlcnkoKTsKICAgIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKTsKCiAgICB2YXIgJHJ1bm5lciA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lcih3aW5kb3cpLAogICAgICAgIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JyksCiAgICAgICAgc2NyaXB0ID0gc2NyaXB0c1tzY3JpcHRzLmxlbmd0aCAtIDFdLAogICAgICAgIGNvbmZpZyA9IHt9OwoKICAgIGFuZ3VsYXIuZm9yRWFjaChzY3JpcHQuYXR0cmlidXRlcywgZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICB2YXIgbWF0Y2ggPSBhdHRyLm5hbWUubWF0Y2goL25nWzpcLV0oLiopLyk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGNvbmZpZ1ttYXRjaFsxXV0gPSBhdHRyLnZhbHVlIHx8IHRydWU7CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKGNvbmZpZy5hdXRvdGVzdCkgewogICAgICAgIEpRTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuKGNvbmZpZyk7CiAgICAgICAgfSk7CiAgICB9Cn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5maW5kKCdoZWFkJykuYXBwZW5kKCc8c3R5bGUgdHlwZT0idGV4dC9jc3MiPkBjaGFyc2V0ICJVVEYtOCI7XG5cbltuZ1xcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sXG4ubmctY2xvYWssIC54LW5nLWNsb2FrIHtcbiAgZGlzcGxheTogbm9uZTtcbn1cblxubmdcXDpmb3JtIHtcbiAgZGlzcGxheTogYmxvY2s7XG59XG48L3N0eWxlPicpOwphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04Ijtcbi8qIENTUyBEb2N1bWVudCAqL1xuXG4vKiogU3RydWN0dXJlICovXG5ib2R5IHtcbiAgZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmO1xuICBtYXJnaW46IDA7XG4gIGZvbnQtc2l6ZTogMTRweDtcbn1cblxuI3N5c3RlbS1lcnJvciB7XG4gIGZvbnQtc2l6ZTogMS41ZW07XG4gIHRleHQtYWxpZ246IGNlbnRlcjtcbn1cblxuI2pzb24sICN4bWwge1xuICBkaXNwbGF5OiBub25lO1xufVxuXG4jaGVhZGVyIHtcbiAgcG9zaXRpb246IGZpeGVkO1xuICB3aWR0aDogMTAwJTtcbn1cblxuI3NwZWNzIHtcbiAgcGFkZGluZy10b3A6IDUwcHg7XG59XG5cbiNoZWFkZXIgLmFuZ3VsYXIge1xuICBmb250LWZhbWlseTogQ291cmllciBOZXcsIG1vbm9zcGFjZTtcbiAgZm9udC13ZWlnaHQ6IGJvbGQ7XG59XG5cbiNoZWFkZXIgaDEge1xuICBmb250LXdlaWdodDogbm9ybWFsO1xuICBmbG9hdDogbGVmdDtcbiAgZm9udC1zaXplOiAzMHB4O1xuICBsaW5lLWhlaWdodDogMzBweDtcbiAgbWFyZ2luOiAwO1xuICBwYWRkaW5nOiAxMHB4IDEwcHg7XG4gIGhlaWdodDogMzBweDtcbn1cblxuI2FwcGxpY2F0aW9uIGgyLFxuI3NwZWNzIGgyIHtcbiAgbWFyZ2luOiAwO1xuICBwYWRkaW5nOiAwLjVlbTtcbiAgZm9udC1zaXplOiAxLjFlbTtcbn1cblxuI3N0YXR1cy1sZWdlbmQge1xuICBtYXJnaW4tdG9wOiAxMHB4O1xuICBtYXJnaW4tcmlnaHQ6IDEwcHg7XG59XG5cbiNoZWFkZXIsXG4jYXBwbGljYXRpb24sXG4udGVzdC1pbmZvLFxuLnRlc3QtYWN0aW9ucyBsaSB7XG4gIG92ZXJmbG93OiBoaWRkZW47XG59XG5cbiNhcHBsaWNhdGlvbiB7XG4gIG1hcmdpbjogMTBweDtcbn1cblxuI2FwcGxpY2F0aW9uIGlmcmFtZSB7XG4gIHdpZHRoOiAxMDAlO1xuICBoZWlnaHQ6IDc1OHB4O1xufVxuXG4jYXBwbGljYXRpb24gLnBvcG91dCB7XG4gIGZsb2F0OiByaWdodDtcbn1cblxuI2FwcGxpY2F0aW9uIGlmcmFtZSB7XG4gIGJvcmRlcjogbm9uZTtcbn1cblxuLnRlc3RzIGxpLFxuLnRlc3QtYWN0aW9ucyBsaSxcbi50ZXN0LWl0IGxpLFxuLnRlc3QtaXQgb2wsXG4uc3RhdHVzLWRpc3BsYXkge1xuICBsaXN0LXN0eWxlLXR5cGU6IG5vbmU7XG59XG5cbi50ZXN0cyxcbi50ZXN0LWl0IG9sLFxuLnN0YXR1cy1kaXNwbGF5IHtcbiAgbWFyZ2luOiAwO1xuICBwYWRkaW5nOiAwO1xufVxuXG4udGVzdC1pbmZvIHtcbiAgbWFyZ2luLWxlZnQ6IDFlbTtcbiAgbWFyZ2luLXRvcDogMC41ZW07XG4gIGJvcmRlci1yYWRpdXM6IDhweCAwIDAgOHB4O1xuICAtd2Via2l0LWJvcmRlci1yYWRpdXM6IDhweCAwIDAgOHB4O1xuICAtbW96LWJvcmRlci1yYWRpdXM6IDhweCAwIDAgOHB4O1xuICBjdXJzb3I6IHBvaW50ZXI7XG59XG5cbi50ZXN0LWluZm86aG92ZXIgLnRlc3QtbmFtZSB7XG4gIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lO1xufVxuXG4udGVzdC1pbmZvIC5jbG9zZWQ6YmVmb3JlIHtcbiAgY29udGVudDogXCdcXDI1YjhcXDAwQTBcJztcbn1cblxuLnRlc3QtaW5mbyAub3BlbjpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMjViZVxcMDBBMFwnO1xuICBmb250LXdlaWdodDogYm9sZDtcbn1cblxuLnRlc3QtaXQgb2wge1xuICBtYXJnaW4tbGVmdDogMi41ZW07XG59XG5cbi5zdGF0dXMtZGlzcGxheSxcbi5zdGF0dXMtZGlzcGxheSBsaSB7XG4gIGZsb2F0OiByaWdodDtcbn1cblxuLnN0YXR1cy1kaXNwbGF5IGxpIHtcbiAgcGFkZGluZzogNXB4IDEwcHg7XG59XG5cbi50aW1lci1yZXN1bHQsXG4udGVzdC10aXRsZSB7XG4gIGRpc3BsYXk6IGlubGluZS1ibG9jaztcbiAgbWFyZ2luOiAwO1xuICBwYWRkaW5nOiA0cHg7XG59XG5cbi50ZXN0LWFjdGlvbnMgLnRlc3QtdGl0bGUsXG4udGVzdC1hY3Rpb25zIC50ZXN0LXJlc3VsdCB7XG4gIGRpc3BsYXk6IHRhYmxlLWNlbGw7XG4gIHBhZGRpbmctbGVmdDogMC41ZW07XG4gIHBhZGRpbmctcmlnaHQ6IDAuNWVtO1xufVxuXG4udGVzdC1hY3Rpb25zIHtcbiAgZGlzcGxheTogdGFibGU7XG59XG5cbi50ZXN0LWFjdGlvbnMgbGkge1xuICBkaXNwbGF5OiB0YWJsZS1yb3c7XG59XG5cbi50aW1lci1yZXN1bHQge1xuICB3aWR0aDogNGVtO1xuICBwYWRkaW5nOiAwIDEwcHg7XG4gIHRleHQtYWxpZ246IHJpZ2h0O1xuICBmb250LWZhbWlseTogbW9ub3NwYWNlO1xufVxuXG4udGVzdC1pdCBwcmUsXG4udGVzdC1hY3Rpb25zIHByZSB7XG4gIGNsZWFyOiBsZWZ0O1xuICBjb2xvcjogYmxhY2s7XG4gIG1hcmdpbi1sZWZ0OiA2ZW07XG59XG5cbi50ZXN0LWRlc2NyaWJlIHtcbiAgcGFkZGluZy1ib3R0b206IDAuNWVtO1xufVxuXG4udGVzdC1kZXNjcmliZSAudGVzdC1kZXNjcmliZSB7XG4gIG1hcmdpbjogNXB4IDVweCAxMHB4IDJlbTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLXBlbmRpbmcgLnRlc3QtdGl0bGU6YmVmb3JlIHtcbiAgY29udGVudDogXCdcXDAwYmJcXDAwQTBcJztcbn1cblxuLnNjcm9sbHBhbmUge1xuICAgbWF4LWhlaWdodDogMjBlbTtcbiAgIG92ZXJmbG93OiBhdXRvO1xufVxuXG4vKiogQ29sb3JzICovXG5cbiNoZWFkZXIge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjRjJDMjAwO1xufVxuXG4jc3BlY3MgaDIge1xuICBib3JkZXItdG9wOiAycHggc29saWQgI0JBQkFEMTtcbn1cblxuI3NwZWNzIGgyLFxuI2FwcGxpY2F0aW9uIGgyIHtcbiAgYmFja2dyb3VuZC1jb2xvcjogI2VmZWZlZjtcbn1cblxuI2FwcGxpY2F0aW9uIHtcbiAgYm9yZGVyOiAxcHggc29saWQgI0JBQkFEMTtcbn1cblxuLnRlc3QtZGVzY3JpYmUgLnRlc3QtZGVzY3JpYmUge1xuICBib3JkZXItbGVmdDogMXB4IHNvbGlkICNCQUJBRDE7XG4gIGJvcmRlci1yaWdodDogMXB4IHNvbGlkICNCQUJBRDE7XG4gIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4uc3RhdHVzLWRpc3BsYXkge1xuICBib3JkZXI6IDFweCBzb2xpZCAjNzc3O1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgLnN0YXR1cy1wZW5kaW5nLFxuLnN0YXR1cy1wZW5kaW5nIC50ZXN0LWluZm8ge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjRjlFRUJDO1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgLnN0YXR1cy1zdWNjZXNzLFxuLnN0YXR1cy1zdWNjZXNzIC50ZXN0LWluZm8ge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjQjFEN0ExO1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgLnN0YXR1cy1mYWlsdXJlLFxuLnN0YXR1cy1mYWlsdXJlIC50ZXN0LWluZm8ge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjRkY4Mjg2O1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgLnN0YXR1cy1lcnJvcixcbi5zdGF0dXMtZXJyb3IgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6IGJsYWNrO1xuICBjb2xvcjogd2hpdGU7XG59XG5cbi50ZXN0LWFjdGlvbnMgLnN0YXR1cy1zdWNjZXNzIC50ZXN0LXRpdGxlIHtcbiAgY29sb3I6ICMzMEIzMEE7XG59XG5cbi50ZXN0LWFjdGlvbnMgLnN0YXR1cy1mYWlsdXJlIC50ZXN0LXRpdGxlIHtcbiAgY29sb3I6ICNERjAwMDA7XG59XG5cbi50ZXN0LWFjdGlvbnMgLnN0YXR1cy1lcnJvciAudGVzdC10aXRsZSB7XG4gIGNvbG9yOiBibGFjaztcbn1cblxuLnRlc3QtYWN0aW9ucyAudGltZXItcmVzdWx0IHtcbiAgY29sb3I6ICM4ODg7XG59XG48L3N0eWxlPicpOw==",
                "body": "LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuNy4yCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMSwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTEsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBXZWQgTWFyIDIxIDEyOjQ2OjM0IDIwMTIgLTA3MDAKICovCihmdW5jdGlvbiAod2luZG93LCB1bmRlZmluZWQpIHsKICAgICd1c2Ugc3RyaWN0JzsKCi8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKICAgIHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgICAgICBuYXZpZ2F0b3IgPSB3aW5kb3cubmF2aWdhdG9yLAogICAgICAgIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgdmFyIGpRdWVyeSA9IChmdW5jdGlvbiAoKSB7CgovLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQogICAgICAgIHZhciBqUXVlcnkgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdChzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeSk7CiAgICAgICAgICAgIH0sCgogICAgICAgIC8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQogICAgICAgICAgICBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeSwKCiAgICAgICAgLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgICAgICAgICAgXyQgPSB3aW5kb3cuJCwKCiAgICAgICAgLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCiAgICAgICAgICAgIHJvb3RqUXVlcnksCgogICAgICAgIC8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzIG9yIElEIHN0cmluZ3MKICAgICAgICAvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCiAgICAgICAgICAgIHF1aWNrRXhwciA9IC9eKD86W14jPF0qKDxbXHdcV10rPilbXj5dKiR8IyhbXHdcLV0qKSQpLywKCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBzdHJpbmcgaGFzIGEgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVyIGluIGl0CiAgICAgICAgICAgIHJub3R3aGl0ZSA9IC9cUy8sCgogICAgICAgIC8vIFVzZWQgZm9yIHRyaW1taW5nIHdoaXRlc3BhY2UKICAgICAgICAgICAgdHJpbUxlZnQgPSAvXlxzKy8sCiAgICAgICAgICAgIHRyaW1SaWdodCA9IC9ccyskLywKCiAgICAgICAgLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZwogICAgICAgICAgICByc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+KT8kLywKCiAgICAgICAgLy8gSlNPTiBSZWdFeHAKICAgICAgICAgICAgcnZhbGlkY2hhcnMgPSAvXltcXSw6e31cc10qJC8sCiAgICAgICAgICAgIHJ2YWxpZGVzY2FwZSA9IC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csCiAgICAgICAgICAgIHJ2YWxpZHRva2VucyA9IC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywKICAgICAgICAgICAgcnZhbGlkYnJhY2VzID0gLyg/Ol58OnwsKSg/OlxzKlxbKSsvZywKCiAgICAgICAgLy8gVXNlcmFnZW50IFJlZ0V4cAogICAgICAgICAgICByd2Via2l0ID0gLyh3ZWJraXQpWyBcL10oW1x3Ll0rKS8sCiAgICAgICAgICAgIHJvcGVyYSA9IC8ob3BlcmEpKD86Lip2ZXJzaW9uKT9bIFwvXShbXHcuXSspLywKICAgICAgICAgICAgcm1zaWUgPSAvKG1zaWUpIChbXHcuXSspLywKICAgICAgICAgICAgcm1vemlsbGEgPSAvKG1vemlsbGEpKD86Lio/IHJ2OihbXHcuXSspKT8vLAoKICAgICAgICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICAgICAgICAgICAgcmRhc2hBbHBoYSA9IC8tKFthLXpdfFswLTldKS9pZywKICAgICAgICAgICAgcm1zUHJlZml4ID0gL14tbXMtLywKCiAgICAgICAgLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQogICAgICAgICAgICBmY2FtZWxDYXNlID0gZnVuY3Rpb24gKGFsbCwgbGV0dGVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKCBsZXR0ZXIgKyAiIiApLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgIC8vIEtlZXAgYSBVc2VyQWdlbnQgc3RyaW5nIGZvciB1c2Ugd2l0aCBqUXVlcnkuYnJvd3NlcgogICAgICAgICAgICB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoKICAgICAgICAvLyBGb3IgbWF0Y2hpbmcgdGhlIGVuZ2luZSBhbmQgdmVyc2lvbiBvZiB0aGUgYnJvd3NlcgogICAgICAgICAgICBicm93c2VyTWF0Y2gsCgogICAgICAgIC8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQogICAgICAgICAgICByZWFkeUxpc3QsCgogICAgICAgIC8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyCiAgICAgICAgICAgIERPTUNvbnRlbnRMb2FkZWQsCgogICAgICAgIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKICAgICAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgICAgICBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgICAgICBwdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2gsCiAgICAgICAgICAgIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgICAgICB0cmltID0gU3RyaW5nLnByb3RvdHlwZS50cmltLAogICAgICAgICAgICBpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YsCgogICAgICAgIC8vIFtbQ2xhc3NdXSAtPiB0eXBlIHBhaXJzCiAgICAgICAgICAgIGNsYXNzMnR5cGUgPSB7fTsKCiAgICAgICAgalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgY29uc3RydWN0b3I6IGpRdWVyeSwKICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2gsIGVsZW0sIHJldCwgZG9jOwoKICAgICAgICAgICAgICAgIC8vIEhhbmRsZSAkKCIiKSwgJChudWxsKSwgb3IgJCh1bmRlZmluZWQpCiAgICAgICAgICAgICAgICBpZiAoIXNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5ub2RlVHlwZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVGhlIGJvZHkgZWxlbWVudCBvbmx5IGV4aXN0cyBvbmNlLCBvcHRpbWl6ZSBmaW5kaW5nIGl0CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICJib2R5IiAmJiAhY29udGV4dCAmJiBkb2N1bWVudC5ib2R5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpc1swXSA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIC8vIEFyZSB3ZSBkZWFsaW5nIHdpdGggSFRNTCBzdHJpbmcgb3IgYW4gSUQ/CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gIjwiICYmIHNlbGVjdG9yLmNoYXJBdChzZWxlY3Rvci5sZW5ndGggLSAxKSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gWyBudWxsLCBzZWxlY3RvciwgbnVsbCBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHF1aWNrRXhwci5leGVjKHNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFZlcmlmeSBhIG1hdGNoLCBhbmQgdGhhdCBubyBjb250ZXh0IHdhcyBzcGVjaWZpZWQgZm9yICNpZAogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSA/IGNvbnRleHRbMF0gOiBjb250ZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jID0gKCBjb250ZXh0ID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGEgc2luZ2xlIHN0cmluZyBpcyBwYXNzZWQgaW4gYW5kIGl0J3MgYSBzaW5nbGUgdGFnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBqdXN0IGRvIGEgY3JlYXRlRWxlbWVudCBhbmQgc2tpcCB0aGUgcmVzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gcnNpbmdsZVRhZy5leGVjKHNlbGVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gWyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHJldFsxXSkgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmZuLmF0dHIuY2FsbChzZWxlY3RvciwgY29udGV4dCwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gWyBkb2MuY3JlYXRlRWxlbWVudChyZXRbMV0pIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoWyBtYXRjaFsxXSBdLCBbIGRvYyBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9ICggcmV0LmNhY2hlYWJsZSA/IGpRdWVyeS5jbG9uZShyZXQuZnJhZ21lbnQpIDogcmV0LmZyYWdtZW50ICkuY2hpbGROb2RlczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm1lcmdlKHRoaXMsIHNlbGVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIQU5ETEU6ICQoIiNpZCIpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMl0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUgYW5kIE9wZXJhIHJldHVybiBpdGVtcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLmlkICE9PSBtYXRjaFsyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcm9vdGpRdWVyeS5maW5kKHNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgd2UgaW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1swXSA9IGVsZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoIGNvbnRleHQgfHwgcm9vdGpRdWVyeSApLmZpbmQoc2VsZWN0b3IpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSEFORExFOiAkKGZ1bmN0aW9uKQogICAgICAgICAgICAgICAgICAgIC8vIFNob3J0Y3V0IGZvciBkb2N1bWVudCByZWFkeQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChqUXVlcnkuaXNGdW5jdGlvbihzZWxlY3RvcikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcm9vdGpRdWVyeS5yZWFkeShzZWxlY3Rvcik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheShzZWxlY3RvciwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCiAgICAgICAgICAgIHNlbGVjdG9yOiAiIiwKCiAgICAgICAgICAgIC8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKICAgICAgICAgICAganF1ZXJ5OiAiMS43LjIiLAoKICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCiAgICAgICAgICAgIGxlbmd0aDogMCwKCiAgICAgICAgICAgIC8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgICAgICAgICAgIHNpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvQXJyYXk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzbGljZS5jYWxsKHRoaXMsIDApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgogICAgICAgICAgICAvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBudW0gPT0gbnVsbCA/CgogICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKICAgICAgICAgICAgICAgICAgICB0aGlzLnRvQXJyYXkoKSA6CgogICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAoIG51bSA8IDAgPyB0aGlzWyB0aGlzLmxlbmd0aCArIG51bSBdIDogdGhpc1sgbnVtIF0gKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKICAgICAgICAgICAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgICAgICAgICAgIHB1c2hTdGFjazogZnVuY3Rpb24gKGVsZW1zLCBuYW1lLCBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKICAgICAgICAgICAgICAgIHZhciByZXQgPSB0aGlzLmNvbnN0cnVjdG9yKCk7CgogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KGVsZW1zKSkgewogICAgICAgICAgICAgICAgICAgIHB1c2guYXBwbHkocmV0LCBlbGVtcyk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkubWVyZ2UocmV0LCBlbGVtcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKICAgICAgICAgICAgICAgIHJldC5wcmV2T2JqZWN0ID0gdGhpczsKCiAgICAgICAgICAgICAgICByZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsKCiAgICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gImZpbmQiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICggdGhpcy5zZWxlY3RvciA/ICIgIiA6ICIiICkgKyBzZWxlY3RvcjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgKyAiLiIgKyBuYW1lICsgIigiICsgc2VsZWN0b3IgKyAiKSI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgogICAgICAgICAgICAvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwogICAgICAgICAgICAvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaywgYXJncykgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5lYWNoKHRoaXMsIGNhbGxiYWNrLCBhcmdzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIC8vIEF0dGFjaCB0aGUgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICBqUXVlcnkuYmluZFJlYWR5KCk7CgogICAgICAgICAgICAgICAgLy8gQWRkIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgcmVhZHlMaXN0LmFkZChmbik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlcTogZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgIGkgPSAraTsKICAgICAgICAgICAgICAgIHJldHVybiBpID09PSAtMSA/CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGljZShpKSA6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGljZShpLCBpICsgMSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmaXJzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXEoMCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lcSgtMSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHNsaWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICAgICAgInNsaWNlIiwgc2xpY2UuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBtYXA6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbGVtLCBpLCBlbGVtKTsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGVuZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJldk9iamVjdCB8fCB0aGlzLmNvbnN0cnVjdG9yKG51bGwpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgICAgICAgICAvLyBCZWhhdmVzIGxpa2UgYW4gQXJyYXkncyBtZXRob2QsIG5vdCBsaWtlIGEgalF1ZXJ5IG1ldGhvZC4KICAgICAgICAgICAgcHVzaDogcHVzaCwKICAgICAgICAgICAgc29ydDogW10uc29ydCwKICAgICAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgICAgICB9OwoKLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgogICAgICAgIGpRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCiAgICAgICAgalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKICAgICAgICAgICAgICAgIHRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKICAgICAgICAgICAgICAgIGkgPSAxLAogICAgICAgICAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGRlZXAgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgZGVlcCA9IHRhcmdldDsKICAgICAgICAgICAgICAgIHRhcmdldCA9IGFyZ3VtZW50c1sxXSB8fCB7fTsKICAgICAgICAgICAgICAgIC8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgICAgICAgICAgIGkgPSAyOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCiAgICAgICAgICAgIGlmIChsZW5ndGggPT09IGkpIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IHRoaXM7CiAgICAgICAgICAgICAgICAtLWk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgICAgICAgIGlmICgob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNyYyA9IHRhcmdldFsgbmFtZSBdOwogICAgICAgICAgICAgICAgICAgICAgICBjb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ID09PSBjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWVwICYmIGNvcHkgJiYgKCBqUXVlcnkuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBqUXVlcnkuaXNBcnJheShjb3B5KSkgKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weUlzQXJyYXkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFsgbmFtZSBdID0gY29weTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9OwoKICAgICAgICBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICAgICAgbm9Db25mbGljdDogZnVuY3Rpb24gKGRlZXApIHsKICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuJCA9PT0galF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LiQgPSBfJDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gSXMgdGhlIERPTSByZWFkeSB0byBiZSB1c2VkPyBTZXQgdG8gdHJ1ZSBvbmNlIGl0IG9jY3Vycy4KICAgICAgICAgICAgaXNSZWFkeTogZmFsc2UsCgogICAgICAgICAgICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgICAgICAgICAgIC8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxCiAgICAgICAgICAgIHJlYWR5V2FpdDogMSwKCiAgICAgICAgICAgIC8vIEhvbGQgKG9yIHJlbGVhc2UpIHRoZSByZWFkeSBldmVudAogICAgICAgICAgICBob2xkUmVhZHk6IGZ1bmN0aW9uIChob2xkKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9sZCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZWFkeVdhaXQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlYWR5KHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQogICAgICAgICAgICByZWFkeTogZnVuY3Rpb24gKHdhaXQpIHsKICAgICAgICAgICAgICAgIC8vIEVpdGhlciBhIHJlbGVhc2VkIGhvbGQgb3IgYW4gRE9NcmVhZHkvbG9hZCBldmVudCBhbmQgbm90IHlldCByZWFkeQogICAgICAgICAgICAgICAgaWYgKCh3YWl0ID09PSB0cnVlICYmICEtLWpRdWVyeS5yZWFkeVdhaXQpIHx8ICh3YWl0ICE9PSB0cnVlICYmICFqUXVlcnkuaXNSZWFkeSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgYm9keSBleGlzdHMsIGF0IGxlYXN0LCBpbiBjYXNlIElFIGdldHMgYSBsaXR0bGUgb3ZlcnplYWxvdXMgKHRpY2tldCAjNTQ0MykuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb2N1bWVudC5ib2R5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGpRdWVyeS5yZWFkeSwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIC8vIElmIGEgbm9ybWFsIERPTSBSZWFkeSBldmVudCBmaXJlZCwgZGVjcmVtZW50LCBhbmQgd2FpdCBpZiBuZWVkIGJlCiAgICAgICAgICAgICAgICAgICAgaWYgKHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCiAgICAgICAgICAgICAgICAgICAgcmVhZHlMaXN0LmZpcmVXaXRoKGRvY3VtZW50LCBbIGpRdWVyeSBdKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCiAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5mbi50cmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkudHJpZ2dlcigicmVhZHkiKS5vZmYoInJlYWR5Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYmluZFJlYWR5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAocmVhZHlMaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlYWR5TGlzdCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5Iik7CgogICAgICAgICAgICAgICAgLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlCiAgICAgICAgICAgICAgICAvLyBicm93c2VyIGV2ZW50IGhhcyBhbHJlYWR5IG9jY3VycmVkLgogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChqUXVlcnkucmVhZHksIDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1vemlsbGEsIE9wZXJhIGFuZCB3ZWJraXQgbmlnaHRsaWVzIGN1cnJlbnRseSBzdXBwb3J0IHRoaXMgZXZlbnQKICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBET01Db250ZW50TG9hZGVkLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBqUXVlcnkucmVhZHksIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSBmaXJpbmcgYmVmb3JlIG9ubG9hZCwKICAgICAgICAgICAgICAgICAgICAvLyBtYXliZSBsYXRlIGJ1dCBzYWZlIGFsc28gZm9yIGlmcmFtZXMKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCk7CgogICAgICAgICAgICAgICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgICAgICAgICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBqUXVlcnkucmVhZHkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBJRSBhbmQgbm90IGEgZnJhbWUKICAgICAgICAgICAgICAgICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcGxldmVsID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGxldmVsID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwgJiYgdG9wbGV2ZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9TY3JvbGxDaGVjaygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFNlZSB0ZXN0L3VuaXQvY29yZS5qcyBmb3IgZGV0YWlscyBjb25jZXJuaW5nIGlzRnVuY3Rpb24uCiAgICAgICAgICAgIC8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKICAgICAgICAgICAgLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KICAgICAgICAgICAgaXNGdW5jdGlvbjogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc0FycmF5OiBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiYXJyYXkiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNXaW5kb3c6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT0gb2JqLndpbmRvdzsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlzTnVtZXJpYzogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG9iaikpICYmIGlzRmluaXRlKG9iaik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0eXBlOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqID09IG51bGwgPwogICAgICAgICAgICAgICAgICAgIFN0cmluZyhvYmopIDoKICAgICAgICAgICAgICAgICAgICBjbGFzczJ0eXBlWyB0b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIC8vIE11c3QgYmUgYW4gT2JqZWN0LgogICAgICAgICAgICAgICAgLy8gQmVjYXVzZSBvZiBJRSwgd2UgYWxzbyBoYXZlIHRvIGNoZWNrIHRoZSBwcmVzZW5jZSBvZiB0aGUgY29uc3RydWN0b3IgcHJvcGVydHkuCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAogICAgICAgICAgICAgICAgaWYgKCFvYmogfHwgalF1ZXJ5LnR5cGUob2JqKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IGpRdWVyeS5pc1dpbmRvdyhvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAogICAgICAgICAgICAgICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgJiYgIWhhc093bi5jYWxsKG9iaiwgImNvbnN0cnVjdG9yIikgJiYgIWhhc093bi5jYWxsKG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gT3duIHByb3BlcnRpZXMgYXJlIGVudW1lcmF0ZWQgZmlyc3RseSwgc28gdG8gc3BlZWQgdXAsCiAgICAgICAgICAgICAgICAvLyBpZiBsYXN0IG9uZSBpcyBvd24sIHRoZW4gYWxsIHByb3BlcnRpZXMgYXJlIG93bi4KCiAgICAgICAgICAgICAgICB2YXIga2V5OwogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093bi5jYWxsKG9iaiwga2V5KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwYXJzZUpTT046IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGEgIT09ICJzdHJpbmciIHx8ICFkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGxlYWRpbmcvdHJhaWxpbmcgd2hpdGVzcGFjZSBpcyByZW1vdmVkIChJRSBjYW4ndCBoYW5kbGUgaXQpCiAgICAgICAgICAgICAgICBkYXRhID0galF1ZXJ5LnRyaW0oZGF0YSk7CgogICAgICAgICAgICAgICAgLy8gQXR0ZW1wdCB0byBwYXJzZSB1c2luZyB0aGUgbmF0aXZlIEpTT04gcGFyc2VyIGZpcnN0CiAgICAgICAgICAgICAgICBpZiAod2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkpTT04ucGFyc2UoZGF0YSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBpbmNvbWluZyBkYXRhIGlzIGFjdHVhbCBKU09OCiAgICAgICAgICAgICAgICAvLyBMb2dpYyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9qc29uLm9yZy9qc29uMi5qcwogICAgICAgICAgICAgICAgaWYgKHJ2YWxpZGNoYXJzLnRlc3QoZGF0YS5yZXBsYWNlKHJ2YWxpZGVzY2FwZSwgIkAiKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKHJ2YWxpZHRva2VucywgIl0iKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKHJ2YWxpZGJyYWNlcywgIiIpKSkgewoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCBuZXcgRnVuY3Rpb24oInJldHVybiAiICsgZGF0YSkgKSgpOwoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGpRdWVyeS5lcnJvcigiSW52YWxpZCBKU09OOiAiICsgZGF0YSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIHhtbCBwYXJzaW5nCiAgICAgICAgICAgIHBhcnNlWE1MOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiB8fCAhZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHhtbCwgdG1wOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgeyAvLyBTdGFuZGFyZAogICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoZGF0YSwgInRleHQveG1sIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gSUUKICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sLmFzeW5jID0gImZhbHNlIjsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sLmxvYWRYTUwoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXJyb3IoIkludmFsaWQgWE1MOiAiICsgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4geG1sOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbm9vcDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKICAgICAgICAgICAgLy8gV29ya2Fyb3VuZHMgYmFzZWQgb24gZmluZGluZ3MgYnkgSmltIERyaXNjb2xsCiAgICAgICAgICAgIC8vIGh0dHA6Ly93ZWJsb2dzLmphdmEubmV0L2Jsb2cvZHJpc2NvbGwvYXJjaGl2ZS8yMDA5LzA5LzA4L2V2YWwtamF2YXNjcmlwdC1nbG9iYWwtY29udGV4dAogICAgICAgICAgICBnbG9iYWxFdmFsOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGRhdGEgJiYgcm5vdHdoaXRlLnRlc3QoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSB1c2UgZXhlY1NjcmlwdCBvbiBJbnRlcm5ldCBFeHBsb3JlcgogICAgICAgICAgICAgICAgICAgIC8vIFdlIHVzZSBhbiBhbm9ueW1vdXMgZnVuY3Rpb24gc28gdGhhdCBjb250ZXh0IGlzIHdpbmRvdwogICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGFuIGpRdWVyeSBpbiBGaXJlZm94CiAgICAgICAgICAgICAgICAgICAgKCB3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dbICJldmFsIiBdLmNhbGwod2luZG93LCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9ICkoZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBDb252ZXJ0IGRhc2hlZCB0byBjYW1lbENhc2U7IHVzZWQgYnkgdGhlIGNzcyBhbmQgZGF0YSBtb2R1bGVzCiAgICAgICAgICAgIC8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKICAgICAgICAgICAgY2FtZWxDYXNlOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2Uocm1zUHJlZml4LCAibXMtIikucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG5vZGVOYW1lOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSBuYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChvYmplY3QsIGNhbGxiYWNrLCBhcmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSwgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gb2JqZWN0Lmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBpc09iaiA9IGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGpRdWVyeS5pc0Z1bmN0aW9uKG9iamVjdCk7CgogICAgICAgICAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIG9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmFwcGx5KG9iamVjdFsgbmFtZSBdLCBhcmdzKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmFwcGx5KG9iamVjdFsgaSsrIF0sIGFyZ3MpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIG9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmNhbGwob2JqZWN0WyBuYW1lIF0sIG5hbWUsIG9iamVjdFsgbmFtZSBdKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmNhbGwob2JqZWN0WyBpIF0sIGksIG9iamVjdFsgaSsrIF0pID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCiAgICAgICAgICAgIHRyaW06IHRyaW0gPwogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGV4dCA9PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgIiIgOgogICAgICAgICAgICAgICAgICAgICAgICB0cmltLmNhbGwodGV4dCk7CiAgICAgICAgICAgICAgICB9IDoKCiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UgdXNlIG91ciBvd24gdHJpbW1pbmcgZnVuY3Rpb25hbGl0eQogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGV4dCA9PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgIiIgOgogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnRvU3RyaW5nKCkucmVwbGFjZSh0cmltTGVmdCwgIiIpLnJlcGxhY2UodHJpbVJpZ2h0LCAiIik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uIChhcnJheSwgcmVzdWx0cykgewogICAgICAgICAgICAgICAgdmFyIHJldCA9IHJlc3VsdHMgfHwgW107CgogICAgICAgICAgICAgICAgaWYgKGFycmF5ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgd2luZG93LCBzdHJpbmdzIChhbmQgZnVuY3Rpb25zKSBhbHNvIGhhdmUgJ2xlbmd0aCcKICAgICAgICAgICAgICAgICAgICAvLyBUd2Vha2VkIGxvZ2ljIHNsaWdodGx5IHRvIGhhbmRsZSBCbGFja2JlcnJ5IDQuNyBSZWdFeHAgaXNzdWVzICM2OTMwCiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBqUXVlcnkudHlwZShhcnJheSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChhcnJheS5sZW5ndGggPT0gbnVsbCB8fCB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlID09PSAiZnVuY3Rpb24iIHx8IHR5cGUgPT09ICJyZWdleHAiIHx8IGpRdWVyeS5pc1dpbmRvdyhhcnJheSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaC5jYWxsKHJldCwgYXJyYXkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5tZXJnZShyZXQsIGFycmF5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluQXJyYXk6IGZ1bmN0aW9uIChlbGVtLCBhcnJheSwgaSkgewogICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxlbiA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpID0gaSA/IGkgPCAwID8gTWF0aC5tYXgoMCwgbGVuICsgaSkgOiBpIDogMDsKCiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTa2lwIGFjY2Vzc2luZyBpbiBzcGFyc2UgYXJyYXlzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIGluIGFycmF5ICYmIGFycmF5WyBpIF0gPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG1lcmdlOiBmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSBmaXJzdC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaiA9IDA7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWNvbmQubGVuZ3RoID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGwgPSBzZWNvbmQubGVuZ3RoOyBqIDwgbDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChzZWNvbmRbal0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmaXJzdC5sZW5ndGggPSBpOwoKICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdyZXA6IGZ1bmN0aW9uIChlbGVtcywgY2FsbGJhY2ssIGludikgewogICAgICAgICAgICAgICAgdmFyIHJldCA9IFtdLCByZXRWYWw7CiAgICAgICAgICAgICAgICBpbnYgPSAhIWludjsKCiAgICAgICAgICAgICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAgICAgICAgICAgICAvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gISFjYWxsYmFjayhlbGVtc1sgaSBdLCBpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW52ICE9PSByZXRWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goZWxlbXNbIGkgXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgICAgICAgICAgbWFwOiBmdW5jdGlvbiAoZWxlbXMsIGNhbGxiYWNrLCBhcmcpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwga2V5LCByZXQgPSBbXSwKICAgICAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAvLyBqcXVlcnkgb2JqZWN0cyBhcmUgdHJlYXRlZCBhcyBhcnJheXMKICAgICAgICAgICAgICAgICAgICBpc0FycmF5ID0gZWxlbXMgaW5zdGFuY2VvZiBqUXVlcnkgfHwgbGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGxlbmd0aCA9PT0gIm51bWJlciIgJiYgKCAoIGxlbmd0aCA+IDAgJiYgZWxlbXNbIDAgXSAmJiBlbGVtc1sgbGVuZ3RoIC0gMSBdICkgfHwgbGVuZ3RoID09PSAwIHx8IGpRdWVyeS5pc0FycmF5KGVsZW1zKSApOwoKICAgICAgICAgICAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpcgogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbIGkgXSwgaSwgYXJnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBHbyB0aHJvdWdoIGV2ZXJ5IGtleSBvbiB0aGUgb2JqZWN0LAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBlbGVtcykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1zWyBrZXkgXSwga2V5LCBhcmcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldFsgcmV0Lmxlbmd0aCBdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgICAgICAgICAgICAgcmV0dXJuIHJldC5jb25jYXQuYXBwbHkoW10sIHJldCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKICAgICAgICAgICAgZ3VpZDogMSwKCiAgICAgICAgICAgIC8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQogICAgICAgICAgICAvLyBhcmd1bWVudHMuCiAgICAgICAgICAgIHByb3h5OiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gZm5bIGNvbnRleHQgXTsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gZm47CiAgICAgICAgICAgICAgICAgICAgZm4gPSB0bXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKICAgICAgICAgICAgICAgIC8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCiAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5pc0Z1bmN0aW9uKGZuKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2ltdWxhdGVkIGJpbmQKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLAogICAgICAgICAgICAgICAgICAgIHByb3h5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKICAgICAgICAgICAgICAgIHByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBwcm94eS5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgogICAgICAgICAgICAgICAgcmV0dXJuIHByb3h5OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gTXV0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyB0byBhIGNvbGxlY3Rpb24KICAgICAgICAgICAgLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCiAgICAgICAgICAgIGFjY2VzczogZnVuY3Rpb24gKGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcGFzcykgewogICAgICAgICAgICAgICAgdmFyIGV4ZWMsCiAgICAgICAgICAgICAgICAgICAgYnVsayA9IGtleSA9PSBudWxsLAogICAgICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICAgICAgICAgICAgICBpZiAoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuYWNjZXNzKGVsZW1zLCBmbiwgaSwga2V5W2ldLCAxLCBlbXB0eUdldCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjaGFpbmFibGUgPSAxOwoKICAgICAgICAgICAgICAgICAgICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT3B0aW9uYWxseSwgZnVuY3Rpb24gdmFsdWVzIGdldCBleGVjdXRlZCBpZiBleGVjIGlzIHRydWUKICAgICAgICAgICAgICAgICAgICBleGVjID0gcGFzcyA9PT0gdW5kZWZpbmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1bGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVsayBvcGVyYXRpb25zIG9ubHkgaXRlcmF0ZSB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4ZWMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWMgPSBmbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGVsZW0sIGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlYy5jYWxsKGpRdWVyeShlbGVtKSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UgdGhleSBydW4gYWdhaW5zdCB0aGUgZW50aXJlIHNldAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtcywgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oZWxlbXNbaV0sIGtleSwgZXhlYyA/IHZhbHVlLmNhbGwoZWxlbXNbaV0sIGksIGZuKGVsZW1zW2ldLCBrZXkpKSA6IHZhbHVlLCBwYXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2hhaW5hYmxlID0gMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gY2hhaW5hYmxlID8KICAgICAgICAgICAgICAgICAgICBlbGVtcyA6CgogICAgICAgICAgICAgICAgICAgIC8vIEdldHMKICAgICAgICAgICAgICAgICAgICBidWxrID8KICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtcykgOgogICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPyBmbihlbGVtc1swXSwga2V5KSA6IGVtcHR5R2V0OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbm93OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gVXNlIG9mIGpRdWVyeS5icm93c2VyIGlzIGZyb3duZWQgdXBvbi4KICAgICAgICAgICAgLy8gTW9yZSBkZXRhaWxzOiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1V0aWxpdGllcy9qUXVlcnkuYnJvd3NlcgogICAgICAgICAgICB1YU1hdGNoOiBmdW5jdGlvbiAodWEpIHsKICAgICAgICAgICAgICAgIHVhID0gdWEudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSByd2Via2l0LmV4ZWModWEpIHx8CiAgICAgICAgICAgICAgICAgICAgcm9wZXJhLmV4ZWModWEpIHx8CiAgICAgICAgICAgICAgICAgICAgcm1zaWUuZXhlYyh1YSkgfHwKICAgICAgICAgICAgICAgICAgICB1YS5pbmRleE9mKCJjb21wYXRpYmxlIikgPCAwICYmIHJtb3ppbGxhLmV4ZWModWEpIHx8CiAgICAgICAgICAgICAgICAgICAgW107CgogICAgICAgICAgICAgICAgcmV0dXJuIHsgYnJvd3NlcjogbWF0Y2hbMV0gfHwgIiIsIHZlcnNpb246IG1hdGNoWzJdIHx8ICIwIiB9OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3ViOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBqUXVlcnlTdWIoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGpRdWVyeVN1Yi5mbi5pbml0KHNlbGVjdG9yLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBqUXVlcnkuZXh0ZW5kKHRydWUsIGpRdWVyeVN1YiwgdGhpcyk7CiAgICAgICAgICAgICAgICBqUXVlcnlTdWIuc3VwZXJjbGFzcyA9IHRoaXM7CiAgICAgICAgICAgICAgICBqUXVlcnlTdWIuZm4gPSBqUXVlcnlTdWIucHJvdG90eXBlID0gdGhpcygpOwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLmZuLmNvbnN0cnVjdG9yID0galF1ZXJ5U3ViOwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLnN1YiA9IHRoaXMuc3ViOwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgJiYgY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSAmJiAhKGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnlTdWIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBqUXVlcnlTdWIoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LmZuLmluaXQuY2FsbCh0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcm9vdGpRdWVyeVN1Yik7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgalF1ZXJ5U3ViLmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5U3ViLmZuOwogICAgICAgICAgICAgICAgdmFyIHJvb3RqUXVlcnlTdWIgPSBqUXVlcnlTdWIoZG9jdW1lbnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeVN1YjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJyb3dzZXI6IHt9CiAgICAgICAgfSk7CgovLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXAKICAgICAgICBqUXVlcnkuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgICAgICAgICAgY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9KTsKCiAgICAgICAgYnJvd3Nlck1hdGNoID0galF1ZXJ5LnVhTWF0Y2godXNlckFnZW50KTsKICAgICAgICBpZiAoYnJvd3Nlck1hdGNoLmJyb3dzZXIpIHsKICAgICAgICAgICAgalF1ZXJ5LmJyb3dzZXJbIGJyb3dzZXJNYXRjaC5icm93c2VyIF0gPSB0cnVlOwogICAgICAgICAgICBqUXVlcnkuYnJvd3Nlci52ZXJzaW9uID0gYnJvd3Nlck1hdGNoLnZlcnNpb247CiAgICAgICAgfQoKLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5icm93c2VyLndlYmtpdCBpbnN0ZWFkCiAgICAgICAgaWYgKGpRdWVyeS5icm93c2VyLndlYmtpdCkgewogICAgICAgICAgICBqUXVlcnkuYnJvd3Nlci5zYWZhcmkgPSB0cnVlOwogICAgICAgIH0KCi8vIElFIGRvZXNuJ3QgbWF0Y2ggbm9uLWJyZWFraW5nIHNwYWNlcyB3aXRoIFxzCiAgICAgICAgaWYgKHJub3R3aGl0ZS50ZXN0KCJceEEwIikpIHsKICAgICAgICAgICAgdHJpbUxlZnQgPSAvXltcc1x4QTBdKy87CiAgICAgICAgICAgIHRyaW1SaWdodCA9IC9bXHNceEEwXSskLzsKICAgICAgICB9CgovLyBBbGwgalF1ZXJ5IG9iamVjdHMgc2hvdWxkIHBvaW50IGJhY2sgdG8gdGhlc2UKICAgICAgICByb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKCi8vIENsZWFudXAgZnVuY3Rpb25zIGZvciB0aGUgZG9jdW1lbnQgcmVhZHkgbWV0aG9kCiAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgRE9NQ29udGVudExvYWRlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBET01Db250ZW50TG9hZGVkLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBqUXVlcnkucmVhZHkoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICBET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCk7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlYWR5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKLy8gVGhlIERPTSByZWFkeSBjaGVjayBmb3IgSW50ZXJuZXQgRXhwbG9yZXIKICAgICAgICBmdW5jdGlvbiBkb1Njcm9sbENoZWNrKCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzUmVhZHkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKCJsZWZ0Iik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFuZCBleGVjdXRlIGFueSB3YWl0aW5nIGZ1bmN0aW9ucwogICAgICAgICAgICBqUXVlcnkucmVhZHkoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBqUXVlcnk7CgogICAgfSkoKTsKCgovLyBTdHJpbmcgdG8gT2JqZWN0IGZsYWdzIGZvcm1hdCBjYWNoZQogICAgdmFyIGZsYWdzQ2FjaGUgPSB7fTsKCi8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBmbGFncyBpbnRvIE9iamVjdC1mb3JtYXR0ZWQgb25lcyBhbmQgc3RvcmUgaW4gY2FjaGUKICAgIGZ1bmN0aW9uIGNyZWF0ZUZsYWdzKGZsYWdzKSB7CiAgICAgICAgdmFyIG9iamVjdCA9IGZsYWdzQ2FjaGVbIGZsYWdzIF0gPSB7fSwKICAgICAgICAgICAgaSwgbGVuZ3RoOwogICAgICAgIGZsYWdzID0gZmxhZ3Muc3BsaXQoL1xzKy8pOwogICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGZsYWdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdFsgZmxhZ3NbaV0gXSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoKICAgICAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICoKICAgICAqCWZsYWdzOglhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBmbGFncyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogICAgICoJCQl0aGUgY2FsbGJhY2sgbGlzdCBiZWhhdmVzCiAgICAgKgogICAgICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICAgICAqICJmaXJlZCIgbXVsdGlwbGUgdGltZXMuCiAgICAgKgogICAgICogUG9zc2libGUgZmxhZ3M6CiAgICAgKgogICAgICoJb25jZToJCQl3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAgICAgKgogICAgICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICAgICAqCQkJCQlhZnRlciB0aGUgbGlzdCBoYXMgYmVlbiBmaXJlZCByaWdodCBhd2F5IHdpdGggdGhlIGxhdGVzdCAibWVtb3JpemVkIgogICAgICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogICAgICoKICAgICAqCXVuaXF1ZToJCQl3aWxsIGVuc3VyZSBhIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UgKG5vIGR1cGxpY2F0ZSBpbiB0aGUgbGlzdCkKICAgICAqCiAgICAgKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAgICAgKgogICAgICovCiAgICBqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGZsYWdzKSB7CgogICAgICAgIC8vIENvbnZlcnQgZmxhZ3MgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQKICAgICAgICAvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCiAgICAgICAgZmxhZ3MgPSBmbGFncyA/ICggZmxhZ3NDYWNoZVsgZmxhZ3MgXSB8fCBjcmVhdGVGbGFncyhmbGFncykgKSA6IHt9OwoKICAgICAgICB2YXIgLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKICAgICAgICAgICAgbGlzdCA9IFtdLAogICAgICAgIC8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgICAgICAgICAgc3RhY2sgPSBbXSwKICAgICAgICAvLyBMYXN0IGZpcmUgdmFsdWUgKGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMpCiAgICAgICAgICAgIG1lbW9yeSwKICAgICAgICAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAogICAgICAgICAgICBmaXJlZCwKICAgICAgICAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCBpcyBjdXJyZW50bHkgZmlyaW5nCiAgICAgICAgICAgIGZpcmluZywKICAgICAgICAvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkKICAgICAgICAgICAgZmlyaW5nU3RhcnQsCiAgICAgICAgLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCiAgICAgICAgICAgIGZpcmluZ0xlbmd0aCwKICAgICAgICAvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSByZW1vdmUgaWYgbmVlZGVkKQogICAgICAgICAgICBmaXJpbmdJbmRleCwKICAgICAgICAvLyBBZGQgb25lIG9yIHNldmVyYWwgY2FsbGJhY2tzIHRvIHRoZSBsaXN0CiAgICAgICAgICAgIGFkZCA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgZWxlbSwKICAgICAgICAgICAgICAgICAgICB0eXBlLAogICAgICAgICAgICAgICAgICAgIGFjdHVhbDsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtID0gYXJnc1sgaSBdOwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSBqUXVlcnkudHlwZShlbGVtKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gImFycmF5IikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZChlbGVtKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWRkIGlmIG5vdCBpbiB1bmlxdWUgbW9kZSBhbmQgY2FsbGJhY2sgaXMgbm90IGluCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmxhZ3MudW5pcXVlIHx8ICFzZWxmLmhhcyhlbGVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICAgICAgICAgIGZpcmUgPSBmdW5jdGlvbiAoY29udGV4dCwgYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgICAgICAgICAgICBtZW1vcnkgPSAhZmxhZ3MubWVtb3J5IHx8IFsgY29udGV4dCwgYXJncyBdOwogICAgICAgICAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZmlyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4ID0gZmlyaW5nU3RhcnQgfHwgMDsKICAgICAgICAgICAgICAgIGZpcmluZ1N0YXJ0ID0gMDsKICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yICg7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAobGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseShjb250ZXh0LCBhcmdzKSA9PT0gZmFsc2UgJiYgZmxhZ3Muc3RvcE9uRmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtb3J5ID0gdHJ1ZTsgLy8gTWFyayBhcyBoYWx0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmlyaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgICAgICAgICAgIGlmICghZmxhZ3Mub25jZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2sgJiYgc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW1vcnkgPSBzdGFjay5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maXJlV2l0aChtZW1vcnlbIDAgXSwgbWVtb3J5WyAxIF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZW1vcnkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdAogICAgICAgICAgICBzZWxmID0gewogICAgICAgICAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgICAgICAgICAgYWRkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICBhZGQoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG8gd2UgbmVlZCB0byBhZGQgdGhlIGNhbGxiYWNrcyB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2l0aCBtZW1vcnksIGlmIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2hvdWxkIGNhbGwgcmlnaHQgYXdheSwgdW5sZXNzIHByZXZpb3VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmaXJpbmcgd2FzIGhhbHRlZCAoc3RvcE9uRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVtb3J5ICYmIG1lbW9yeSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyaW5nU3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJlKG1lbW9yeVsgMCBdLCBtZW1vcnlbIDEgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJbmRleCA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdMZW5ndGggPSBhcmdzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IGFyZ0luZGV4IDwgYXJnTGVuZ3RoOyBhcmdJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnc1sgYXJnSW5kZXggXSA9PT0gbGlzdFsgaSBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBmaXJpbmdJbmRleCBhbmQgZmlyaW5nTGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGZpcmluZ0xlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIDw9IGZpcmluZ0luZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpLS0sIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIHNvbWUgdW5pY2l0eSBwcm9wZXJ0eSB0aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG9ubHkgbmVlZCB0byBkbyB0aGlzIG9uY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLnVuaXF1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gQ29udHJvbCBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0CiAgICAgICAgICAgICAgICBoYXM6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4gPT09IGxpc3RbIGkgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgICAgICAgICAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQogICAgICAgICAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBJcyBpdCBkaXNhYmxlZD8KICAgICAgICAgICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFsaXN0OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKICAgICAgICAgICAgICAgIGxvY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjayA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAoIW1lbW9yeSB8fCBtZW1vcnkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8vIElzIGl0IGxvY2tlZD8KICAgICAgICAgICAgICAgIGxvY2tlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhc3RhY2s7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwogICAgICAgICAgICAgICAgZmlyZVdpdGg6IGZ1bmN0aW9uIChjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmxhZ3Mub25jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goWyBjb250ZXh0LCBhcmdzIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCEoIGZsYWdzLm9uY2UgJiYgbWVtb3J5ICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmUoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gQ2FsbCBhbGwgdGhlIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMKICAgICAgICAgICAgICAgIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpcmVXaXRoKHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCiAgICAgICAgICAgICAgICBmaXJlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhIWZpcmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICByZXR1cm4gc2VsZjsKICAgIH07CgoKICAgIHZhciAvLyBTdGF0aWMgcmVmZXJlbmNlIHRvIHNsaWNlCiAgICAgICAgc2xpY2VEZWZlcnJlZCA9IFtdLnNsaWNlOwoKICAgIGpRdWVyeS5leHRlbmQoewoKICAgICAgICBEZWZlcnJlZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgICAgICAgdmFyIGRvbmVMaXN0ID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgICAgICAgICAgIGZhaWxMaXN0ID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgICAgICAgICAgIHByb2dyZXNzTGlzdCA9IGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpLAogICAgICAgICAgICAgICAgc3RhdGUgPSAicGVuZGluZyIsCiAgICAgICAgICAgICAgICBsaXN0cyA9IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlOiBkb25lTGlzdCwKICAgICAgICAgICAgICAgICAgICByZWplY3Q6IGZhaWxMaXN0LAogICAgICAgICAgICAgICAgICAgIG5vdGlmeTogcHJvZ3Jlc3NMaXN0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcHJvbWlzZSA9IHsKICAgICAgICAgICAgICAgICAgICBkb25lOiBkb25lTGlzdC5hZGQsCiAgICAgICAgICAgICAgICAgICAgZmFpbDogZmFpbExpc3QuYWRkLAogICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBwcm9ncmVzc0xpc3QuYWRkLAoKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLy8gRGVwcmVjYXRlZAogICAgICAgICAgICAgICAgICAgIGlzUmVzb2x2ZWQ6IGRvbmVMaXN0LmZpcmVkLAogICAgICAgICAgICAgICAgICAgIGlzUmVqZWN0ZWQ6IGZhaWxMaXN0LmZpcmVkLAoKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAoZG9uZUNhbGxiYWNrcywgZmFpbENhbGxiYWNrcywgcHJvZ3Jlc3NDYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQuZG9uZShkb25lQ2FsbGJhY2tzKS5mYWlsKGZhaWxDYWxsYmFja3MpLnByb2dyZXNzKHByb2dyZXNzQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQuZG9uZS5hcHBseShkZWZlcnJlZCwgYXJndW1lbnRzKS5mYWlsLmFwcGx5KGRlZmVycmVkLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHBpcGU6IGZ1bmN0aW9uIChmbkRvbmUsIGZuRmFpbCwgZm5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uIChuZXdEZWZlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmVhY2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmU6IFsgZm5Eb25lLCAicmVzb2x2ZSIgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsOiBbIGZuRmFpbCwgInJlamVjdCIgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogWyBmblByb2dyZXNzLCAibm90aWZ5IiBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoaGFuZGxlciwgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IGRhdGFbIDAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gZGF0YVsgMSBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oZm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkWyBoYW5kbGVyIF0oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQgPSBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHJldHVybmVkLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQucHJvbWlzZSgpLnRoZW4obmV3RGVmZXIucmVzb2x2ZSwgbmV3RGVmZXIucmVqZWN0LCBuZXdEZWZlci5ub3RpZnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdEZWZlclsgYWN0aW9uICsgIldpdGgiIF0odGhpcyA9PT0gZGVmZXJyZWQgPyBuZXdEZWZlciA6IHRoaXMsIFsgcmV0dXJuZWQgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkWyBoYW5kbGVyIF0obmV3RGVmZXJbIGFjdGlvbiBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAogICAgICAgICAgICAgICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICAgICAgICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqWyBrZXkgXSA9IHByb21pc2VbIGtleSBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlZmVycmVkID0gcHJvbWlzZS5wcm9taXNlKHt9KSwKICAgICAgICAgICAgICAgIGtleTsKCiAgICAgICAgICAgIGZvciAoa2V5IGluIGxpc3RzKSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZFsga2V5IF0gPSBsaXN0c1sga2V5IF0uZmlyZTsKICAgICAgICAgICAgICAgIGRlZmVycmVkWyBrZXkgKyAiV2l0aCIgXSA9IGxpc3RzWyBrZXkgXS5maXJlV2l0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgICAgICAgIGRlZmVycmVkLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc3RhdGUgPSAicmVzb2x2ZWQiOwogICAgICAgICAgICB9LCBmYWlsTGlzdC5kaXNhYmxlLCBwcm9ncmVzc0xpc3QubG9jaykuZmFpbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSAicmVqZWN0ZWQiOwogICAgICAgICAgICAgICAgfSwgZG9uZUxpc3QuZGlzYWJsZSwgcHJvZ3Jlc3NMaXN0LmxvY2spOwoKICAgICAgICAgICAgLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQogICAgICAgICAgICBpZiAoZnVuYykgewogICAgICAgICAgICAgICAgZnVuYy5jYWxsKGRlZmVycmVkLCBkZWZlcnJlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFsbCBkb25lIQogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICAgICAgfSwKCiAgICAgICAgLy8gRGVmZXJyZWQgaGVscGVyCiAgICAgICAgd2hlbjogZnVuY3Rpb24gKGZpcnN0UGFyYW0pIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZURlZmVycmVkLmNhbGwoYXJndW1lbnRzLCAwKSwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICAgICAgICBwVmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCksCiAgICAgICAgICAgICAgICBjb3VudCA9IGxlbmd0aCwKICAgICAgICAgICAgICAgIHBDb3VudCA9IGxlbmd0aCwKICAgICAgICAgICAgICAgIGRlZmVycmVkID0gbGVuZ3RoIDw9IDEgJiYgZmlyc3RQYXJhbSAmJiBqUXVlcnkuaXNGdW5jdGlvbihmaXJzdFBhcmFtLnByb21pc2UpID8KICAgICAgICAgICAgICAgICAgICBmaXJzdFBhcmFtIDoKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlKCk7CgogICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlRnVuYyhpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBzbGljZURlZmVycmVkLmNhbGwoYXJndW1lbnRzLCAwKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIGlmICghKCAtLWNvdW50ICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZGVmZXJyZWQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHByb2dyZXNzRnVuYyhpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcFZhbHVlc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBzbGljZURlZmVycmVkLmNhbGwoYXJndW1lbnRzLCAwKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLm5vdGlmeVdpdGgocHJvbWlzZSwgcFZhbHVlcyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmdzWyBpIF0gJiYgYXJnc1sgaSBdLnByb21pc2UgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oYXJnc1sgaSBdLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbIGkgXS5wcm9taXNlKCkudGhlbihyZXNvbHZlRnVuYyhpKSwgZGVmZXJyZWQucmVqZWN0LCBwcm9ncmVzc0Z1bmMoaSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC0tY291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFjb3VudCkgewogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGRlZmVycmVkLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChkZWZlcnJlZCAhPT0gZmlyc3RQYXJhbSkgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZGVmZXJyZWQsIGxlbmd0aCA/IFsgZmlyc3RQYXJhbSBdIDogW10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH0KICAgIH0pOwoKCiAgICBqUXVlcnkuc3VwcG9ydCA9IChmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBzdXBwb3J0LAogICAgICAgICAgICBhbGwsCiAgICAgICAgICAgIGEsCiAgICAgICAgICAgIHNlbGVjdCwKICAgICAgICAgICAgb3B0LAogICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgZnJhZ21lbnQsCiAgICAgICAgICAgIHRkcywKICAgICAgICAgICAgZXZlbnRzLAogICAgICAgICAgICBldmVudE5hbWUsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGlzU3VwcG9ydGVkLAogICAgICAgICAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgICAgICAgZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAvLyBQcmVsaW1pbmFyeSB0ZXN0cwogICAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoImNsYXNzTmFtZSIsICJ0Iik7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICIgICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnIHN0eWxlPSd0b3A6MXB4O2Zsb2F0OmxlZnQ7b3BhY2l0eTouNTU7Jz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CgogICAgICAgIGFsbCA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpOwogICAgICAgIGEgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImEiKVsgMCBdOwoKICAgICAgICAvLyBDYW4ndCBnZXQgYmFzaWMgdGVzdCBzdXBwb3J0CiAgICAgICAgaWYgKCFhbGwgfHwgIWFsbC5sZW5ndGggfHwgIWEpIHsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gRmlyc3QgYmF0Y2ggb2Ygc3VwcG9ydHMgdGVzdHMKICAgICAgICBzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKICAgICAgICBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikpOwogICAgICAgIGlucHV0ID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpWyAwIF07CgogICAgICAgIHN1cHBvcnQgPSB7CiAgICAgICAgICAgIC8vIElFIHN0cmlwcyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiAuaW5uZXJIVE1MIGlzIHVzZWQKICAgICAgICAgICAgbGVhZGluZ1doaXRlc3BhY2U6ICggZGl2LmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDMgKSwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRib2R5IGVsZW1lbnRzIGFyZW4ndCBhdXRvbWF0aWNhbGx5IGluc2VydGVkCiAgICAgICAgICAgIC8vIElFIHdpbGwgaW5zZXJ0IHRoZW0gaW50byBlbXB0eSB0YWJsZXMKICAgICAgICAgICAgdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgbGluayBlbGVtZW50cyBnZXQgc2VyaWFsaXplZCBjb3JyZWN0bHkgYnkgaW5uZXJIVE1MCiAgICAgICAgICAgIC8vIFRoaXMgcmVxdWlyZXMgYSB3cmFwcGVyIGVsZW1lbnQgaW4gSUUKICAgICAgICAgICAgaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgogICAgICAgICAgICAvLyBHZXQgdGhlIHN0eWxlIGluZm9ybWF0aW9uIGZyb20gZ2V0QXR0cmlidXRlCiAgICAgICAgICAgIC8vIChJRSB1c2VzIC5jc3NUZXh0IGluc3RlYWQpCiAgICAgICAgICAgIHN0eWxlOiAvdG9wLy50ZXN0KGEuZ2V0QXR0cmlidXRlKCJzdHlsZSIpKSwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IFVSTHMgYXJlbid0IG1hbmlwdWxhdGVkCiAgICAgICAgICAgIC8vIChJRSBub3JtYWxpemVzIGl0IGJ5IGRlZmF1bHQpCiAgICAgICAgICAgIGhyZWZOb3JtYWxpemVkOiAoIGEuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIvYSIgKSwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGVsZW1lbnQgb3BhY2l0eSBleGlzdHMKICAgICAgICAgICAgLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCiAgICAgICAgICAgIC8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKICAgICAgICAgICAgb3BhY2l0eTogL14wLjU1Ly50ZXN0KGEuc3R5bGUub3BhY2l0eSksCgogICAgICAgICAgICAvLyBWZXJpZnkgc3R5bGUgZmxvYXQgZXhpc3RlbmNlCiAgICAgICAgICAgIC8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKICAgICAgICAgICAgY3NzRmxvYXQ6ICEhYS5zdHlsZS5jc3NGbG9hdCwKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGlmIG5vIHZhbHVlIGlzIHNwZWNpZmllZCBmb3IgYSBjaGVja2JveAogICAgICAgICAgICAvLyB0aGF0IGl0IGRlZmF1bHRzIHRvICJvbiIuCiAgICAgICAgICAgIC8vIChXZWJLaXQgZGVmYXVsdHMgdG8gIiIgaW5zdGVhZCkKICAgICAgICAgICAgY2hlY2tPbjogKCBpbnB1dC52YWx1ZSA9PT0gIm9uIiApLAoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgogICAgICAgICAgICAvLyAoV2ViS2l0IGRlZmF1bHRzIHRvIGZhbHNlIGluc3RlYWQgb2YgdHJ1ZSwgSUUgdG9vLCBpZiBpdCdzIGluIGFuIG9wdGdyb3VwKQogICAgICAgICAgICBvcHRTZWxlY3RlZDogb3B0LnNlbGVjdGVkLAoKICAgICAgICAgICAgLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKICAgICAgICAgICAgZ2V0U2V0QXR0cmlidXRlOiBkaXYuY2xhc3NOYW1lICE9PSAidCIsCgogICAgICAgICAgICAvLyBUZXN0cyBmb3IgZW5jdHlwZSBzdXBwb3J0IG9uIGEgZm9ybSgjNjc0MykKICAgICAgICAgICAgZW5jdHlwZTogISFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIikuZW5jdHlwZSwKCiAgICAgICAgICAgIC8vIE1ha2VzIHN1cmUgY2xvbmluZyBhbiBodG1sNSBlbGVtZW50IGRvZXMgbm90IGNhdXNlIHByb2JsZW1zCiAgICAgICAgICAgIC8vIFdoZXJlIG91dGVySFRNTCBpcyB1bmRlZmluZWQsIHRoaXMgc3RpbGwgd29ya3MKICAgICAgICAgICAgaHRtbDVDbG9uZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibmF2IikuY2xvbmVOb2RlKHRydWUpLm91dGVySFRNTCAhPT0gIjw6bmF2PjwvOm5hdj4iLAoKICAgICAgICAgICAgLy8gV2lsbCBiZSBkZWZpbmVkIGxhdGVyCiAgICAgICAgICAgIHN1Ym1pdEJ1YmJsZXM6IHRydWUsCiAgICAgICAgICAgIGNoYW5nZUJ1YmJsZXM6IHRydWUsCiAgICAgICAgICAgIGZvY3VzaW5CdWJibGVzOiBmYWxzZSwKICAgICAgICAgICAgZGVsZXRlRXhwYW5kbzogdHJ1ZSwKICAgICAgICAgICAgbm9DbG9uZUV2ZW50OiB0cnVlLAogICAgICAgICAgICBpbmxpbmVCbG9ja05lZWRzTGF5b3V0OiBmYWxzZSwKICAgICAgICAgICAgc2hyaW5rV3JhcEJsb2NrczogZmFsc2UsCiAgICAgICAgICAgIHJlbGlhYmxlTWFyZ2luUmlnaHQ6IHRydWUsCiAgICAgICAgICAgIHBpeGVsTWFyZ2luOiB0cnVlCiAgICAgICAgfTsKCiAgICAgICAgLy8galF1ZXJ5LmJveE1vZGVsIERFUFJFQ0FURUQgaW4gMS4zLCB1c2UgalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgaW5zdGVhZAogICAgICAgIGpRdWVyeS5ib3hNb2RlbCA9IHN1cHBvcnQuYm94TW9kZWwgPSAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PT0gIkNTUzFDb21wYXQiKTsKCiAgICAgICAgLy8gTWFrZSBzdXJlIGNoZWNrZWQgc3RhdHVzIGlzIHByb3Blcmx5IGNsb25lZAogICAgICAgIGlucHV0LmNoZWNrZWQgPSB0cnVlOwogICAgICAgIHN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSBpbnB1dC5jbG9uZU5vZGUodHJ1ZSkuY2hlY2tlZDsKCiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIG9wdGlvbnMgaW5zaWRlIGRpc2FibGVkIHNlbGVjdHMgYXJlbid0IG1hcmtlZCBhcyBkaXNhYmxlZAogICAgICAgIC8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKICAgICAgICBzZWxlY3QuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIHN1cHBvcnQub3B0RGlzYWJsZWQgPSAhb3B0LmRpc2FibGVkOwoKICAgICAgICAvLyBUZXN0IHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRlbGV0ZSBhbiBleHBhbmRvIGZyb20gYW4gZWxlbWVudAogICAgICAgIC8vIEZhaWxzIGluIEludGVybmV0IEV4cGxvcmVyCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVsZXRlIGRpdi50ZXN0OwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc3VwcG9ydC5kZWxldGVFeHBhbmRvID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWRpdi5hZGRFdmVudExpc3RlbmVyICYmIGRpdi5hdHRhY2hFdmVudCAmJiBkaXYuZmlyZUV2ZW50KSB7CiAgICAgICAgICAgIGRpdi5hdHRhY2hFdmVudCgib25jbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIENsb25pbmcgYSBub2RlIHNob3VsZG4ndCBjb3B5IG92ZXIgYW55CiAgICAgICAgICAgICAgICAvLyBib3VuZCBldmVudCBoYW5kbGVycyAoSUUgZG9lcyB0aGlzKQogICAgICAgICAgICAgICAgc3VwcG9ydC5ub0Nsb25lRXZlbnQgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRpdi5jbG9uZU5vZGUodHJ1ZSkuZmlyZUV2ZW50KCJvbmNsaWNrIik7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBpZiBhIHJhZGlvIG1haW50YWlucyBpdHMgdmFsdWUKICAgICAgICAvLyBhZnRlciBiZWluZyBhcHBlbmRlZCB0byB0aGUgRE9NCiAgICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgIGlucHV0LnZhbHVlID0gInQiOwogICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgidHlwZSIsICJyYWRpbyIpOwogICAgICAgIHN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7CgogICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgiY2hlY2tlZCIsICJjaGVja2VkIik7CgogICAgICAgIC8vICMxMTIxNyAtIFdlYktpdCBsb3NlcyBjaGVjayB3aGVuIHRoZSBuYW1lIGlzIGFmdGVyIHRoZSBjaGVja2VkIGF0dHJpYnV0ZQogICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgibmFtZSIsICJ0Iik7CgogICAgICAgIGRpdi5hcHBlbmRDaGlsZChpbnB1dCk7CiAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZGl2Lmxhc3RDaGlsZCk7CgogICAgICAgIC8vIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogICAgICAgIHN1cHBvcnQuY2hlY2tDbG9uZSA9IGZyYWdtZW50LmNsb25lTm9kZSh0cnVlKS5jbG9uZU5vZGUodHJ1ZSkubGFzdENoaWxkLmNoZWNrZWQ7CgogICAgICAgIC8vIENoZWNrIGlmIGEgZGlzY29ubmVjdGVkIGNoZWNrYm94IHdpbGwgcmV0YWluIGl0cyBjaGVja2VkCiAgICAgICAgLy8gdmFsdWUgb2YgdHJ1ZSBhZnRlciBhcHBlbmRlZCB0byB0aGUgRE9NIChJRTYvNykKICAgICAgICBzdXBwb3J0LmFwcGVuZENoZWNrZWQgPSBpbnB1dC5jaGVja2VkOwoKICAgICAgICBmcmFnbWVudC5yZW1vdmVDaGlsZChpbnB1dCk7CiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZGl2KTsKCiAgICAgICAgLy8gVGVjaG5pcXVlIGZyb20gSnVyaXkgWmF5dHNldgogICAgICAgIC8vIGh0dHA6Ly9wZXJmZWN0aW9ua2lsbHMuY29tL2RldGVjdGluZy1ldmVudC1zdXBwb3J0LXdpdGhvdXQtYnJvd3Nlci1zbmlmZmluZy8KICAgICAgICAvLyBXZSBvbmx5IGNhcmUgYWJvdXQgdGhlIGNhc2Ugd2hlcmUgbm9uLXN0YW5kYXJkIGV2ZW50IHN5c3RlbXMKICAgICAgICAvLyBhcmUgdXNlZCwgbmFtZWx5IGluIElFLiBTaG9ydC1jaXJjdWl0aW5nIGhlcmUgaGVscHMgdXMgdG8KICAgICAgICAvLyBhdm9pZCBhbiBldmFsIGNhbGwgKGluIHNldEF0dHJpYnV0ZSkgd2hpY2ggY2FuIGNhdXNlIENTUAogICAgICAgIC8vIHRvIGdvIGhheXdpcmUuIFNlZTogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQCiAgICAgICAgaWYgKGRpdi5hdHRhY2hFdmVudCkgewogICAgICAgICAgICBmb3IgKGkgaW4gewogICAgICAgICAgICAgICAgc3VibWl0OiAxLAogICAgICAgICAgICAgICAgY2hhbmdlOiAxLAogICAgICAgICAgICAgICAgZm9jdXNpbjogMQogICAgICAgICAgICB9KSB7CiAgICAgICAgICAgICAgICBldmVudE5hbWUgPSAib24iICsgaTsKICAgICAgICAgICAgICAgIGlzU3VwcG9ydGVkID0gKCBldmVudE5hbWUgaW4gZGl2ICk7CiAgICAgICAgICAgICAgICBpZiAoIWlzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgICAgICAgZGl2LnNldEF0dHJpYnV0ZShldmVudE5hbWUsICJyZXR1cm47Iik7CiAgICAgICAgICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSAoIHR5cGVvZiBkaXZbIGV2ZW50TmFtZSBdID09PSAiZnVuY3Rpb24iICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdXBwb3J0WyBpICsgIkJ1YmJsZXMiIF0gPSBpc1N1cHBvcnRlZDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnJhZ21lbnQucmVtb3ZlQ2hpbGQoZGl2KTsKCiAgICAgICAgLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRQogICAgICAgIGZyYWdtZW50ID0gc2VsZWN0ID0gb3B0ID0gZGl2ID0gaW5wdXQgPSBudWxsOwoKICAgICAgICAvLyBSdW4gdGVzdHMgdGhhdCBuZWVkIGEgYm9keSBhdCBkb2MgcmVhZHkKICAgICAgICBqUXVlcnkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY29udGFpbmVyLCBvdXRlciwgaW5uZXIsIHRhYmxlLCB0ZCwgb2Zmc2V0U3VwcG9ydCwKICAgICAgICAgICAgICAgIG1hcmdpbkRpdiwgY29uTWFyZ2luVG9wLCBzdHlsZSwgaHRtbCwgcG9zaXRpb25Ub3BMZWZ0V2lkdGhIZWlnaHQsCiAgICAgICAgICAgICAgICBwYWRkaW5nTWFyZ2luQm9yZGVyVmlzaWJpbGl0eSwgcGFkZGluZ01hcmdpbkJvcmRlciwKICAgICAgICAgICAgICAgIGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdOwoKICAgICAgICAgICAgaWYgKCFib2R5KSB7CiAgICAgICAgICAgICAgICAvLyBSZXR1cm4gZm9yIGZyYW1lc2V0IGRvY3MgdGhhdCBkb24ndCBoYXZlIGEgYm9keQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25NYXJnaW5Ub3AgPSAxOwogICAgICAgICAgICBwYWRkaW5nTWFyZ2luQm9yZGVyID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6IjsKICAgICAgICAgICAgcG9zaXRpb25Ub3BMZWZ0V2lkdGhIZWlnaHQgPSAicG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDowO3dpZHRoOjFweDtoZWlnaHQ6MXB4OyI7CiAgICAgICAgICAgIHBhZGRpbmdNYXJnaW5Cb3JkZXJWaXNpYmlsaXR5ID0gcGFkZGluZ01hcmdpbkJvcmRlciArICIwO3Zpc2liaWxpdHk6aGlkZGVuOyI7CiAgICAgICAgICAgIHN0eWxlID0gInN0eWxlPSciICsgcG9zaXRpb25Ub3BMZWZ0V2lkdGhIZWlnaHQgKyBwYWRkaW5nTWFyZ2luQm9yZGVyICsgIjVweCBzb2xpZCAjMDAwOyI7CiAgICAgICAgICAgIGh0bWwgPSAiPGRpdiAiICsgc3R5bGUgKyAiZGlzcGxheTpibG9jazsnPjxkaXYgc3R5bGU9JyIgKyBwYWRkaW5nTWFyZ2luQm9yZGVyICsgIjA7ZGlzcGxheTpibG9jaztvdmVyZmxvdzpoaWRkZW47Jz48L2Rpdj48L2Rpdj4iICsKICAgICAgICAgICAgICAgICI8dGFibGUgIiArIHN0eWxlICsgIicgY2VsbHBhZGRpbmc9JzAnIGNlbGxzcGFjaW5nPScwJz4iICsKICAgICAgICAgICAgICAgICI8dHI+PHRkPjwvdGQ+PC90cj48L3RhYmxlPiI7CgogICAgICAgICAgICBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSBwYWRkaW5nTWFyZ2luQm9yZGVyVmlzaWJpbGl0eSArICJ3aWR0aDowO2hlaWdodDowO3Bvc2l0aW9uOnN0YXRpYzt0b3A6MDttYXJnaW4tdG9wOiIgKyBjb25NYXJnaW5Ub3AgKyAicHgiOwogICAgICAgICAgICBib2R5Lmluc2VydEJlZm9yZShjb250YWluZXIsIGJvZHkuZmlyc3RDaGlsZCk7CgogICAgICAgICAgICAvLyBDb25zdHJ1Y3QgdGhlIHRlc3QgZWxlbWVudAogICAgICAgICAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGRpdik7CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodCB3aGVuIHRoZXkgYXJlIHNldAogICAgICAgICAgICAvLyB0byBkaXNwbGF5Om5vbmUgYW5kIHRoZXJlIGFyZSBzdGlsbCBvdGhlciB2aXNpYmxlIHRhYmxlIGNlbGxzIGluIGEKICAgICAgICAgICAgLy8gdGFibGUgcm93OyBpZiBzbywgb2Zmc2V0V2lkdGgvSGVpZ2h0IGFyZSBub3QgcmVsaWFibGUgZm9yIHVzZSB3aGVuCiAgICAgICAgICAgIC8vIGRldGVybWluaW5nIGlmIGFuIGVsZW1lbnQgaGFzIGJlZW4gaGlkZGVuIGRpcmVjdGx5IHVzaW5nCiAgICAgICAgICAgIC8vIGRpc3BsYXk6bm9uZSAoaXQgaXMgc3RpbGwgc2FmZSB0byB1c2Ugb2Zmc2V0cyBpZiBhIHBhcmVudCBlbGVtZW50IGlzCiAgICAgICAgICAgIC8vIGhpZGRlbjsgZG9uIHNhZmV0eSBnb2dnbGVzIGFuZCBzZWUgYnVnICM0NTEyIGZvciBtb3JlIGluZm9ybWF0aW9uKS4KICAgICAgICAgICAgLy8gKG9ubHkgSUUgOCBmYWlscyB0aGlzIHRlc3QpCiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPHRhYmxlPjx0cj48dGQgc3R5bGU9JyIgKyBwYWRkaW5nTWFyZ2luQm9yZGVyICsgIjA7ZGlzcGxheTpub25lJz48L3RkPjx0ZD50PC90ZD48L3RyPjwvdGFibGU+IjsKICAgICAgICAgICAgdGRzID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0ZCIpOwogICAgICAgICAgICBpc1N1cHBvcnRlZCA9ICggdGRzWyAwIF0ub2Zmc2V0SGVpZ2h0ID09PSAwICk7CgogICAgICAgICAgICB0ZHNbIDAgXS5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgICAgICAgIHRkc1sgMSBdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgogICAgICAgICAgICAvLyBDaGVjayBpZiBlbXB0eSB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodAogICAgICAgICAgICAvLyAoSUUgPD0gOCBmYWlsIHRoaXMgdGVzdCkKICAgICAgICAgICAgc3VwcG9ydC5yZWxpYWJsZUhpZGRlbk9mZnNldHMgPSBpc1N1cHBvcnRlZCAmJiAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOwoKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQogICAgICAgICAgICAvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuIEZvciBtb3JlCiAgICAgICAgICAgIC8vIGluZm8gc2VlIGJ1ZyAjMzMzMwogICAgICAgICAgICAvLyBGYWlscyBpbiBXZWJLaXQgYmVmb3JlIEZlYiAyMDExIG5pZ2h0bGllcwogICAgICAgICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgICAgICAgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgICAgICBtYXJnaW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICIwIjsKICAgICAgICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9ICIwIjsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS53aWR0aCA9ICIycHgiOwogICAgICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKG1hcmdpbkRpdik7CiAgICAgICAgICAgICAgICBzdXBwb3J0LnJlbGlhYmxlTWFyZ2luUmlnaHQgPQogICAgICAgICAgICAgICAgICAgICggcGFyc2VJbnQoKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShtYXJnaW5EaXYsIG51bGwpIHx8IHsgbWFyZ2luUmlnaHQ6IDAgfSApLm1hcmdpblJpZ2h0LCAxMCkgfHwgMCApID09PSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIGRpdi5zdHlsZS56b29tICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgbmF0aXZlbHkgYmxvY2stbGV2ZWwgZWxlbWVudHMgYWN0IGxpa2UgaW5saW5lLWJsb2NrCiAgICAgICAgICAgICAgICAvLyBlbGVtZW50cyB3aGVuIHNldHRpbmcgdGhlaXIgZGlzcGxheSB0byAnaW5saW5lJyBhbmQgZ2l2aW5nCiAgICAgICAgICAgICAgICAvLyB0aGVtIGxheW91dAogICAgICAgICAgICAgICAgLy8gKElFIDwgOCBkb2VzIHRoaXMpCiAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUud2lkdGggPSBkaXYuc3R5bGUucGFkZGluZyA9ICIxcHgiOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLmJvcmRlciA9IDA7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5kaXNwbGF5ID0gImlubGluZSI7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuem9vbSA9IDE7CiAgICAgICAgICAgICAgICBzdXBwb3J0LmlubGluZUJsb2NrTmVlZHNMYXlvdXQgPSAoIGRpdi5vZmZzZXRXaWR0aCA9PT0gMyApOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGVsZW1lbnRzIHdpdGggbGF5b3V0IHNocmluay13cmFwIHRoZWlyIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAvLyAoSUUgNiBkb2VzIHRoaXMpCiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUub3ZlcmZsb3cgPSAidmlzaWJsZSI7CiAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J3dpZHRoOjVweDsnPjwvZGl2PiI7CiAgICAgICAgICAgICAgICBzdXBwb3J0LnNocmlua1dyYXBCbG9ja3MgPSAoIGRpdi5vZmZzZXRXaWR0aCAhPT0gMyApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkaXYuc3R5bGUuY3NzVGV4dCA9IHBvc2l0aW9uVG9wTGVmdFdpZHRoSGVpZ2h0ICsgcGFkZGluZ01hcmdpbkJvcmRlclZpc2liaWxpdHk7CiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSBodG1sOwoKICAgICAgICAgICAgb3V0ZXIgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaW5uZXIgPSBvdXRlci5maXJzdENoaWxkOwogICAgICAgICAgICB0ZCA9IG91dGVyLm5leHRTaWJsaW5nLmZpcnN0Q2hpbGQuZmlyc3RDaGlsZDsKCiAgICAgICAgICAgIG9mZnNldFN1cHBvcnQgPSB7CiAgICAgICAgICAgICAgICBkb2VzTm90QWRkQm9yZGVyOiAoIGlubmVyLm9mZnNldFRvcCAhPT0gNSApLAogICAgICAgICAgICAgICAgZG9lc0FkZEJvcmRlckZvclRhYmxlQW5kQ2VsbHM6ICggdGQub2Zmc2V0VG9wID09PSA1ICkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlubmVyLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKICAgICAgICAgICAgaW5uZXIuc3R5bGUudG9wID0gIjIwcHgiOwoKICAgICAgICAgICAgLy8gc2FmYXJpIHN1YnRyYWN0cyBwYXJlbnQgYm9yZGVyIHdpZHRoIGhlcmUgd2hpY2ggaXMgNXB4CiAgICAgICAgICAgIG9mZnNldFN1cHBvcnQuZml4ZWRQb3NpdGlvbiA9ICggaW5uZXIub2Zmc2V0VG9wID09PSAyMCB8fCBpbm5lci5vZmZzZXRUb3AgPT09IDE1ICk7CiAgICAgICAgICAgIGlubmVyLnN0eWxlLnBvc2l0aW9uID0gaW5uZXIuc3R5bGUudG9wID0gIiI7CgogICAgICAgICAgICBvdXRlci5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICAgICAgICBvdXRlci5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgogICAgICAgICAgICBvZmZzZXRTdXBwb3J0LnN1YnRyYWN0c0JvcmRlckZvck92ZXJmbG93Tm90VmlzaWJsZSA9ICggaW5uZXIub2Zmc2V0VG9wID09PSAtNSApOwogICAgICAgICAgICBvZmZzZXRTdXBwb3J0LmRvZXNOb3RJbmNsdWRlTWFyZ2luSW5Cb2R5T2Zmc2V0ID0gKCBib2R5Lm9mZnNldFRvcCAhPT0gY29uTWFyZ2luVG9wICk7CgogICAgICAgICAgICBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5tYXJnaW5Ub3AgPSAiMSUiOwogICAgICAgICAgICAgICAgc3VwcG9ydC5waXhlbE1hcmdpbiA9ICggd2luZG93LmdldENvbXB1dGVkU3R5bGUoZGl2LCBudWxsKSB8fCB7IG1hcmdpblRvcDogMCB9ICkubWFyZ2luVG9wICE9PSAiMSUiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRhaW5lci5zdHlsZS56b29tICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLnpvb20gPSAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICBib2R5LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CiAgICAgICAgICAgIG1hcmdpbkRpdiA9IGRpdiA9IGNvbnRhaW5lciA9IG51bGw7CgogICAgICAgICAgICBqUXVlcnkuZXh0ZW5kKHN1cHBvcnQsIG9mZnNldFN1cHBvcnQpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gc3VwcG9ydDsKICAgIH0pKCk7CgoKICAgIHZhciByYnJhY2UgPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCiAgICAgICAgcm11bHRpRGFzaCA9IC8oW0EtWl0pL2c7CgogICAgalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgY2FjaGU6IHt9LAoKICAgICAgICAvLyBQbGVhc2UgdXNlIHdpdGggY2F1dGlvbgogICAgICAgIHV1aWQ6IDAsCgogICAgICAgIC8vIFVuaXF1ZSBmb3IgZWFjaCBjb3B5IG9mIGpRdWVyeSBvbiB0aGUgcGFnZQogICAgICAgIC8vIE5vbi1kaWdpdHMgcmVtb3ZlZCB0byBtYXRjaCByaW5saW5lalF1ZXJ5CiAgICAgICAgZXhwYW5kbzogImpRdWVyeSIgKyAoIGpRdWVyeS5mbi5qcXVlcnkgKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSgvXEQvZywgIiIpLAoKICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIHRocm93IHVuY2F0Y2hhYmxlIGV4Y2VwdGlvbnMgaWYgeW91CiAgICAgICAgLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCiAgICAgICAgbm9EYXRhOiB7CiAgICAgICAgICAgICJlbWJlZCI6IHRydWUsCiAgICAgICAgICAgIC8vIEJhbiBhbGwgb2JqZWN0cyBleGNlcHQgZm9yIEZsYXNoICh3aGljaCBoYW5kbGUgZXhwYW5kb3MpCiAgICAgICAgICAgICJvYmplY3QiOiAiY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIiwKICAgICAgICAgICAgImFwcGxldCI6IHRydWUKICAgICAgICB9LAoKICAgICAgICBoYXNEYXRhOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5ub2RlVHlwZSA/IGpRdWVyeS5jYWNoZVsgZWxlbVtqUXVlcnkuZXhwYW5kb10gXSA6IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CiAgICAgICAgICAgIHJldHVybiAhIWVsZW0gJiYgIWlzRW1wdHlEYXRhT2JqZWN0KGVsZW0pOwogICAgICAgIH0sCgogICAgICAgIGRhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8pIHsKICAgICAgICAgICAgaWYgKCFqUXVlcnkuYWNjZXB0RGF0YShlbGVtKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJpdmF0ZUNhY2hlLCB0aGlzQ2FjaGUsIHJldCwKICAgICAgICAgICAgICAgIGludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCiAgICAgICAgICAgICAgICBnZXRCeU5hbWUgPSB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIsCgogICAgICAgICAgICAvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNwogICAgICAgICAgICAvLyBjYW4ndCBHQyBvYmplY3QgcmVmZXJlbmNlcyBwcm9wZXJseSBhY3Jvc3MgdGhlIERPTS1KUyBib3VuZGFyeQogICAgICAgICAgICAgICAgaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCiAgICAgICAgICAgIC8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgdGhlIGdsb2JhbCBqUXVlcnkgY2FjaGU7IEpTIG9iamVjdCBkYXRhIGlzCiAgICAgICAgICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBvYmplY3Qgc28gR0MgY2FuIG9jY3VyIGF1dG9tYXRpY2FsbHkKICAgICAgICAgICAgICAgIGNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCiAgICAgICAgICAgIC8vIE9ubHkgZGVmaW5pbmcgYW4gSUQgZm9yIEpTIG9iamVjdHMgaWYgaXRzIGNhY2hlIGFscmVhZHkgZXhpc3RzIGFsbG93cwogICAgICAgICAgICAvLyB0aGUgY29kZSB0byBzaG9ydGN1dCBvbiB0aGUgc2FtZSBwYXRoIGFzIGEgRE9NIG5vZGUgd2l0aCBubyBjYWNoZQogICAgICAgICAgICAgICAgaWQgPSBpc05vZGUgPyBlbGVtWyBpbnRlcm5hbEtleSBdIDogZWxlbVsgaW50ZXJuYWxLZXkgXSAmJiBpbnRlcm5hbEtleSwKICAgICAgICAgICAgICAgIGlzRXZlbnRzID0gbmFtZSA9PT0gImV2ZW50cyI7CgogICAgICAgICAgICAvLyBBdm9pZCBkb2luZyBhbnkgbW9yZSB3b3JrIHRoYW4gd2UgbmVlZCB0byB3aGVuIHRyeWluZyB0byBnZXQgZGF0YSBvbiBhbgogICAgICAgICAgICAvLyBvYmplY3QgdGhhdCBoYXMgbm8gZGF0YSBhdCBhbGwKICAgICAgICAgICAgaWYgKCghaWQgfHwgIWNhY2hlW2lkXSB8fCAoIWlzRXZlbnRzICYmICFwdnQgJiYgIWNhY2hlW2lkXS5kYXRhKSkgJiYgZ2V0QnlOYW1lICYmIGRhdGEgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlkKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IERPTSBub2RlcyBuZWVkIGEgbmV3IHVuaXF1ZSBJRCBmb3IgZWFjaCBlbGVtZW50IHNpbmNlIHRoZWlyIGRhdGEKICAgICAgICAgICAgICAgIC8vIGVuZHMgdXAgaW4gdGhlIGdsb2JhbCBjYWNoZQogICAgICAgICAgICAgICAgaWYgKGlzTm9kZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1bIGludGVybmFsS2V5IF0gPSBpZCA9ICsralF1ZXJ5LnV1aWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlkID0gaW50ZXJuYWxLZXk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghY2FjaGVbIGlkIF0pIHsKICAgICAgICAgICAgICAgIGNhY2hlWyBpZCBdID0ge307CgogICAgICAgICAgICAgICAgLy8gQXZvaWRzIGV4cG9zaW5nIGpRdWVyeSBtZXRhZGF0YSBvbiBwbGFpbiBKUyBvYmplY3RzIHdoZW4gdGhlIG9iamVjdAogICAgICAgICAgICAgICAgLy8gaXMgc2VyaWFsaXplZCB1c2luZyBKU09OLnN0cmluZ2lmeQogICAgICAgICAgICAgICAgaWYgKCFpc05vZGUpIHsKICAgICAgICAgICAgICAgICAgICBjYWNoZVsgaWQgXS50b0pTT04gPSBqUXVlcnkubm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQW4gb2JqZWN0IGNhbiBiZSBwYXNzZWQgdG8galF1ZXJ5LmRhdGEgaW5zdGVhZCBvZiBhIGtleS92YWx1ZSBwYWlyOyB0aGlzIGdldHMKICAgICAgICAgICAgLy8gc2hhbGxvdyBjb3BpZWQgb3ZlciBvbnRvIHRoZSBleGlzdGluZyBjYWNoZQogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBuYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAocHZ0KSB7CiAgICAgICAgICAgICAgICAgICAgY2FjaGVbIGlkIF0gPSBqUXVlcnkuZXh0ZW5kKGNhY2hlWyBpZCBdLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2FjaGVbIGlkIF0uZGF0YSA9IGpRdWVyeS5leHRlbmQoY2FjaGVbIGlkIF0uZGF0YSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByaXZhdGVDYWNoZSA9IHRoaXNDYWNoZSA9IGNhY2hlWyBpZCBdOwoKICAgICAgICAgICAgLy8galF1ZXJ5IGRhdGEoKSBpcyBzdG9yZWQgaW4gYSBzZXBhcmF0ZSBvYmplY3QgaW5zaWRlIHRoZSBvYmplY3QncyBpbnRlcm5hbCBkYXRhCiAgICAgICAgICAgIC8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkCiAgICAgICAgICAgIC8vIGRhdGEuCiAgICAgICAgICAgIGlmICghcHZ0KSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXNDYWNoZS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc0NhY2hlLmRhdGEgPSB7fTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzQ2FjaGUgPSB0aGlzQ2FjaGUuZGF0YTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpIF0gPSBkYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVc2VycyBzaG91bGQgbm90IGF0dGVtcHQgdG8gaW5zcGVjdCB0aGUgaW50ZXJuYWwgZXZlbnRzIG9iamVjdCB1c2luZyBqUXVlcnkuZGF0YSwKICAgICAgICAgICAgLy8gaXQgaXMgdW5kb2N1bWVudGVkIGFuZCBzdWJqZWN0IHRvIGNoYW5nZS4gQnV0IGRvZXMgYW55b25lIGxpc3Rlbj8gTm8uCiAgICAgICAgICAgIGlmIChpc0V2ZW50cyAmJiAhdGhpc0NhY2hlWyBuYW1lIF0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcml2YXRlQ2FjaGUuZXZlbnRzOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcwogICAgICAgICAgICAvLyBJZiBhIGRhdGEgcHJvcGVydHkgd2FzIHNwZWNpZmllZAogICAgICAgICAgICBpZiAoZ2V0QnlOYW1lKSB7CgogICAgICAgICAgICAgICAgLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQogICAgICAgICAgICAgICAgcmV0ID0gdGhpc0NhY2hlWyBuYW1lIF07CgogICAgICAgICAgICAgICAgLy8gVGVzdCBmb3IgbnVsbHx1bmRlZmluZWQgcHJvcGVydHkgZGF0YQogICAgICAgICAgICAgICAgaWYgKHJldCA9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXQgPSB0aGlzQ2FjaGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHB2dCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLykgewogICAgICAgICAgICBpZiAoIWpRdWVyeS5hY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB0aGlzQ2FjaGUsIGksIGwsCgogICAgICAgICAgICAvLyBSZWZlcmVuY2UgdG8gaW50ZXJuYWwgZGF0YSBjYWNoZSBrZXkKICAgICAgICAgICAgICAgIGludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCgogICAgICAgICAgICAgICAgaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCiAgICAgICAgICAgIC8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLAoKICAgICAgICAgICAgLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICBpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBpbnRlcm5hbEtleTsKCiAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGFscmVhZHkgbm8gY2FjaGUgZW50cnkgZm9yIHRoaXMgb2JqZWN0LCB0aGVyZSBpcyBubwogICAgICAgICAgICAvLyBwdXJwb3NlIGluIGNvbnRpbnVpbmcKICAgICAgICAgICAgaWYgKCFjYWNoZVsgaWQgXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobmFtZSkgewoKICAgICAgICAgICAgICAgIHRoaXNDYWNoZSA9IHB2dCA/IGNhY2hlWyBpZCBdIDogY2FjaGVbIGlkIF0uZGF0YTsKCiAgICAgICAgICAgICAgICBpZiAodGhpc0NhY2hlKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBuYW1lcyBmb3IgZGF0YSBrZXlzCiAgICAgICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkuaXNBcnJheShuYW1lKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgaW4gdGhpc0NhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gWyBuYW1lIF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lIGluIHRoaXNDYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBbIG5hbWUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3BsaXQoIiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzQ2FjaGVbIG5hbWVbaV0gXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUKICAgICAgICAgICAgICAgICAgICAvLyBhbmQgbGV0IHRoZSBjYWNoZSBvYmplY3QgaXRzZWxmIGdldCBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBpZiAoISggcHZ0ID8gaXNFbXB0eURhdGFPYmplY3QgOiBqUXVlcnkuaXNFbXB0eU9iamVjdCApKHRoaXNDYWNoZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgICAgICAgIGlmICghcHZ0KSB7CiAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVbIGlkIF0uZGF0YTsKCiAgICAgICAgICAgICAgICAvLyBEb24ndCBkZXN0cm95IHRoZSBwYXJlbnQgY2FjaGUgdW5sZXNzIHRoZSBpbnRlcm5hbCBkYXRhIG9iamVjdAogICAgICAgICAgICAgICAgLy8gaGFkIGJlZW4gdGhlIG9ubHkgdGhpbmcgbGVmdCBpbiBpdAogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5RGF0YU9iamVjdChjYWNoZVsgaWQgXSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJyb3dzZXJzIHRoYXQgZmFpbCBleHBhbmRvIGRlbGV0aW9uIGFsc28gcmVmdXNlIHRvIGRlbGV0ZSBleHBhbmRvcyBvbgogICAgICAgICAgICAvLyB0aGUgd2luZG93LCBidXQgaXQgd2lsbCBhbGxvdyBpdCBvbiBhbGwgb3RoZXIgSlMgb2JqZWN0czsgb3RoZXIgYnJvd3NlcnMKICAgICAgICAgICAgLy8gZG9uJ3QgY2FyZQogICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBgY2FjaGVgIGlzIG5vdCBhIHdpbmRvdyBvYmplY3QgIzEwMDgwCiAgICAgICAgICAgIGlmIChqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvIHx8ICFjYWNoZS5zZXRJbnRlcnZhbCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGNhY2hlWyBpZCBdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FjaGVbIGlkIF0gPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXZSBkZXN0cm95ZWQgdGhlIGNhY2hlIGFuZCBuZWVkIHRvIGVsaW1pbmF0ZSB0aGUgZXhwYW5kbyBvbiB0aGUgbm9kZSB0byBhdm9pZAogICAgICAgICAgICAvLyBmYWxzZSBsb29rdXBzIGluIHRoZSBjYWNoZSBmb3IgZW50cmllcyB0aGF0IG5vIGxvbmdlciBleGlzdAogICAgICAgICAgICBpZiAoaXNOb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBJRSBkb2VzIG5vdCBhbGxvdyB1cyB0byBkZWxldGUgZXhwYW5kbyBwcm9wZXJ0aWVzIGZyb20gbm9kZXMsCiAgICAgICAgICAgICAgICAvLyBub3IgZG9lcyBpdCBoYXZlIGEgcmVtb3ZlQXR0cmlidXRlIGZ1bmN0aW9uIG9uIERvY3VtZW50IG5vZGVzOwogICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBoYW5kbGUgYWxsIG9mIHRoZXNlIGNhc2VzCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuZGVsZXRlRXhwYW5kbykgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtWyBpbnRlcm5hbEtleSBdOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLnJlbW92ZUF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGludGVybmFsS2V5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbVsgaW50ZXJuYWxLZXkgXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCiAgICAgICAgX2RhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGF0YShlbGVtLCBuYW1lLCBkYXRhLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAvLyBBIG1ldGhvZCBmb3IgZGV0ZXJtaW5pbmcgaWYgYSBET00gbm9kZSBjYW4gaGFuZGxlIHRoZSBkYXRhIGV4cGFuZG8KICAgICAgICBhY2NlcHREYXRhOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlTmFtZSkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0galF1ZXJ5Lm5vRGF0YVsgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEobWF0Y2ggPT09IHRydWUgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzaWQiKSAhPT0gbWF0Y2gpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9KTsKCiAgICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgICAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcGFydHMsIHBhcnQsIGF0dHIsIG5hbWUsIGwsCiAgICAgICAgICAgICAgICBlbGVtID0gdGhpc1swXSwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgZGF0YSA9IG51bGw7CgogICAgICAgICAgICAvLyBHZXRzIGFsbCB2YWx1ZXMKICAgICAgICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhID0galF1ZXJ5LmRhdGEoZWxlbSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxICYmICFqUXVlcnkuX2RhdGEoZWxlbSwgInBhcnNlZEF0dHJzIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IGVsZW0uYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsID0gYXR0ci5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyW2ldLm5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZigiZGF0YS0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUuc3Vic3RyaW5nKDUpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUF0dHIoZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoZWxlbSwgInBhcnNlZEF0dHJzIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXRzIG11bHRpcGxlIHZhbHVlcwogICAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kYXRhKHRoaXMsIGtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGFydHMgPSBrZXkuc3BsaXQoIi4iLCAyKTsKICAgICAgICAgICAgcGFydHNbMV0gPSBwYXJ0c1sxXSA/ICIuIiArIHBhcnRzWzFdIDogIiI7CiAgICAgICAgICAgIHBhcnQgPSBwYXJ0c1sxXSArICIhIjsKCiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMudHJpZ2dlckhhbmRsZXIoImdldERhdGEiICsgcGFydCwgWyBwYXJ0c1swXSBdKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZldGNoIGFueSBpbnRlcm5hbGx5IHN0b3JlZCBkYXRhIGZpcnN0CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBqUXVlcnkuZGF0YShlbGVtLCBrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YUF0dHIoZWxlbSwga2V5LCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhID09PSB1bmRlZmluZWQgJiYgcGFydHNbMV0gPwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEocGFydHNbMF0pIDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwYXJ0c1sxXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi50cmlnZ2VySGFuZGxlcigic2V0RGF0YSIgKyBwYXJ0LCBwYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRhdGEodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi50cmlnZ2VySGFuZGxlcigiY2hhbmdlRGF0YSIgKyBwYXJ0LCBwYXJ0cyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVEYXRhKHRoaXMsIGtleSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIGRhdGFBdHRyKGVsZW0sIGtleSwgZGF0YSkgewogICAgICAgIC8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKICAgICAgICAvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKICAgICAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKCiAgICAgICAgICAgIHZhciBuYW1lID0gImRhdGEtIiArIGtleS5yZXBsYWNlKHJtdWx0aURhc2gsICItJDEiKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgZGF0YSA9IGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhID09PSAibnVsbCIgPyBudWxsIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuaXNOdW1lcmljKGRhdGEpID8gK2RhdGEgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYnJhY2UudGVzdChkYXRhKSA/IGpRdWVyeS5wYXJzZUpTT04oZGF0YSkgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICAgICAgICAgIGpRdWVyeS5kYXRhKGVsZW0sIGtleSwgZGF0YSk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwogICAgZnVuY3Rpb24gaXNFbXB0eURhdGFPYmplY3Qob2JqKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBvYmopIHsKCiAgICAgICAgICAgIC8vIGlmIHRoZSBwdWJsaWMgZGF0YSBvYmplY3QgaXMgZW1wdHksIHRoZSBwcml2YXRlIGlzIHN0aWxsIGVtcHR5CiAgICAgICAgICAgIGlmIChuYW1lID09PSAiZGF0YSIgJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3Qob2JqW25hbWVdKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5hbWUgIT09ICJ0b0pTT04iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKCiAgICBmdW5jdGlvbiBoYW5kbGVRdWV1ZU1hcmtEZWZlcihlbGVtLCB0eXBlLCBzcmMpIHsKICAgICAgICB2YXIgZGVmZXJEYXRhS2V5ID0gdHlwZSArICJkZWZlciIsCiAgICAgICAgICAgIHF1ZXVlRGF0YUtleSA9IHR5cGUgKyAicXVldWUiLAogICAgICAgICAgICBtYXJrRGF0YUtleSA9IHR5cGUgKyAibWFyayIsCiAgICAgICAgICAgIGRlZmVyID0galF1ZXJ5Ll9kYXRhKGVsZW0sIGRlZmVyRGF0YUtleSk7CiAgICAgICAgaWYgKGRlZmVyICYmCiAgICAgICAgICAgICggc3JjID09PSAicXVldWUiIHx8ICFqUXVlcnkuX2RhdGEoZWxlbSwgcXVldWVEYXRhS2V5KSApICYmCiAgICAgICAgICAgICggc3JjID09PSAibWFyayIgfHwgIWpRdWVyeS5fZGF0YShlbGVtLCBtYXJrRGF0YUtleSkgKSkgewogICAgICAgICAgICAvLyBHaXZlIHJvb20gZm9yIGhhcmQtY29kZWQgY2FsbGJhY2tzIHRvIGZpcmUgZmlyc3QKICAgICAgICAgICAgLy8gYW5kIGV2ZW50dWFsbHkgbWFyay9xdWV1ZSBzb21ldGhpbmcgZWxzZSBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5Ll9kYXRhKGVsZW0sIHF1ZXVlRGF0YUtleSkgJiYgIWpRdWVyeS5fZGF0YShlbGVtLCBtYXJrRGF0YUtleSkpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCBkZWZlckRhdGFLZXksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGRlZmVyLmZpcmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfQogICAgfQoKICAgIGpRdWVyeS5leHRlbmQoewoKICAgICAgICBfbWFyazogZnVuY3Rpb24gKGVsZW0sIHR5cGUpIHsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAoIHR5cGUgfHwgImZ4IiApICsgIm1hcmsiOwogICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sIHR5cGUsIChqUXVlcnkuX2RhdGEoZWxlbSwgdHlwZSkgfHwgMCkgKyAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF91bm1hcms6IGZ1bmN0aW9uIChmb3JjZSwgZWxlbSwgdHlwZSkgewogICAgICAgICAgICBpZiAoZm9yY2UgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSBlbGVtOwogICAgICAgICAgICAgICAgZWxlbSA9IGZvcmNlOwogICAgICAgICAgICAgICAgZm9yY2UgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgICAgICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSB0eXBlICsgIm1hcmsiLAogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gZm9yY2UgPyAwIDogKCAoalF1ZXJ5Ll9kYXRhKGVsZW0sIGtleSkgfHwgMSkgLSAxICk7CiAgICAgICAgICAgICAgICBpZiAoY291bnQpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoZWxlbSwga2V5LCBjb3VudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVEYXRhKGVsZW0sIGtleSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlUXVldWVNYXJrRGVmZXIoZWxlbSwgdHlwZSwgIm1hcmsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgZGF0YSkgewogICAgICAgICAgICB2YXIgcTsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAoIHR5cGUgfHwgImZ4IiApICsgInF1ZXVlIjsKICAgICAgICAgICAgICAgIHEgPSBqUXVlcnkuX2RhdGEoZWxlbSwgdHlwZSk7CgogICAgICAgICAgICAgICAgLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAogICAgICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXEgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcSA9IGpRdWVyeS5fZGF0YShlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBxLnB1c2goZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHEgfHwgW107CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBkZXF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICAgICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwoKICAgICAgICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKGVsZW0sIHR5cGUpLAogICAgICAgICAgICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgaG9va3MgPSB7fTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgICAgICAgICAgaWYgKGZuID09PSAiaW5wcm9ncmVzcyIpIHsKICAgICAgICAgICAgICAgIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCiAgICAgICAgICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gImZ4IikgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlLnVuc2hpZnQoImlucHJvZ3Jlc3MiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoZWxlbSwgdHlwZSArICIucnVuIiwgaG9va3MpOwogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRlcXVldWUoZWxlbSwgdHlwZSk7CiAgICAgICAgICAgICAgICB9LCBob29rcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCB0eXBlICsgInF1ZXVlICIgKyB0eXBlICsgIi5ydW4iLCB0cnVlKTsKICAgICAgICAgICAgICAgIGhhbmRsZVF1ZXVlTWFya0RlZmVyKGVsZW0sIHR5cGUsICJxdWV1ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgcXVldWU6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgICAgICAgIHZhciBzZXR0ZXIgPSAyOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgZGF0YSA9IHR5cGU7CiAgICAgICAgICAgICAgICB0eXBlID0gImZ4IjsKICAgICAgICAgICAgICAgIHNldHRlci0tOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSh0aGlzWzBdLCB0eXBlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgICAgICAgICB0aGlzIDoKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKHRoaXMsIHR5cGUsIGRhdGEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gImZ4IiAmJiBxdWV1ZVswXSAhPT0gImlucHJvZ3Jlc3MiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVxdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCiAgICAgICAgLy8gaHR0cDovL2JsaW5kc2lnbmFscy5jb20vaW5kZXgucGhwLzIwMDkvMDcvanF1ZXJ5LWRlbGF5LwogICAgICAgIGRlbGF5OiBmdW5jdGlvbiAodGltZSwgdHlwZSkgewogICAgICAgICAgICB0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwogICAgICAgICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSwgZnVuY3Rpb24gKG5leHQsIGhvb2tzKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQobmV4dCwgdGltZSk7CiAgICAgICAgICAgICAgICBob29rcy5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgY2xlYXJRdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSB8fCAiZngiLCBbXSk7CiAgICAgICAgfSwKICAgICAgICAvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCiAgICAgICAgLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCiAgICAgICAgcHJvbWlzZTogZnVuY3Rpb24gKHR5cGUsIG9iamVjdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBvYmplY3QgPSB0eXBlOwogICAgICAgICAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICAgICAgICB2YXIgZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICAgIGVsZW1lbnRzID0gdGhpcywKICAgICAgICAgICAgICAgIGkgPSBlbGVtZW50cy5sZW5ndGgsCiAgICAgICAgICAgICAgICBjb3VudCA9IDEsCiAgICAgICAgICAgICAgICBkZWZlckRhdGFLZXkgPSB0eXBlICsgImRlZmVyIiwKICAgICAgICAgICAgICAgIHF1ZXVlRGF0YUtleSA9IHR5cGUgKyAicXVldWUiLAogICAgICAgICAgICAgICAgbWFya0RhdGFLZXkgPSB0eXBlICsgIm1hcmsiLAogICAgICAgICAgICAgICAgdG1wOwoKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZSgpIHsKICAgICAgICAgICAgICAgIGlmICghKCAtLWNvdW50ICkpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgWyBlbGVtZW50cyBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWYgKCggdG1wID0galF1ZXJ5LmRhdGEoZWxlbWVudHNbIGkgXSwgZGVmZXJEYXRhS2V5LCB1bmRlZmluZWQsIHRydWUpIHx8CiAgICAgICAgICAgICAgICAgICAgKCBqUXVlcnkuZGF0YShlbGVtZW50c1sgaSBdLCBxdWV1ZURhdGFLZXksIHVuZGVmaW5lZCwgdHJ1ZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRhdGEoZWxlbWVudHNbIGkgXSwgbWFya0RhdGFLZXksIHVuZGVmaW5lZCwgdHJ1ZSkgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZGF0YShlbGVtZW50c1sgaSBdLCBkZWZlckRhdGFLZXksIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksIHRydWUpICkpIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRtcC5hZGQocmVzb2x2ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZShvYmplY3QpOwogICAgICAgIH0KICAgIH0pOwoKCiAgICB2YXIgcmNsYXNzID0gL1tcblx0XHJdL2csCiAgICAgICAgcnNwYWNlID0gL1xzKy8sCiAgICAgICAgcnJldHVybiA9IC9cci9nLAogICAgICAgIHJ0eXBlID0gL14oPzpidXR0b258aW5wdXQpJC9pLAogICAgICAgIHJmb2N1c2FibGUgPSAvXig/OmJ1dHRvbnxpbnB1dHxvYmplY3R8c2VsZWN0fHRleHRhcmVhKSQvaSwKICAgICAgICByY2xpY2thYmxlID0gL15hKD86cmVhKT8kL2ksCiAgICAgICAgcmJvb2xlYW4gPSAvXig/OmF1dG9mb2N1c3xhdXRvcGxheXxhc3luY3xjaGVja2VkfGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkfHNlbGVjdGVkKSQvaSwKICAgICAgICBnZXRTZXRBdHRyaWJ1dGUgPSBqUXVlcnkuc3VwcG9ydC5nZXRTZXRBdHRyaWJ1dGUsCiAgICAgICAgbm9kZUhvb2ssIGJvb2xIb29rLCBmaXhTcGVjaWZpZWQ7CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgYXR0cjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHByb3A6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBqUXVlcnkucHJvcCwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVQcm9wOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIHRyeS9jYXRjaCBoYW5kbGVzIGNhc2VzIHdoZXJlIElFIGJhbGtzIChzdWNoIGFzIHJlbW92aW5nIGEgcHJvcGVydHkgb24gd2luZG93KQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB0aGlzWyBuYW1lIF0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbIG5hbWUgXTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICB2YXIgY2xhc3NOYW1lcywgaSwgbCwgZWxlbSwKICAgICAgICAgICAgICAgIHNldENsYXNzLCBjLCBjbDsKCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykuYWRkQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBjbGFzc05hbWVzID0gdmFsdWUuc3BsaXQocnNwYWNlKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtID0gdGhpc1sgaSBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVsZW0uY2xhc3NOYW1lICYmIGNsYXNzTmFtZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldENsYXNzID0gIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjID0gMCwgY2wgPSBjbGFzc05hbWVzLmxlbmd0aDsgYyA8IGNsOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIX5zZXRDbGFzcy5pbmRleE9mKCIgIiArIGNsYXNzTmFtZXNbIGMgXSArICIgIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0Q2xhc3MgKz0gY2xhc3NOYW1lc1sgYyBdICsgIiAiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oc2V0Q2xhc3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjbGFzc05hbWVzLCBpLCBsLCBlbGVtLCBjbGFzc05hbWUsIGMsIGNsOwoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaikgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjbGFzc05hbWVzID0gKCB2YWx1ZSB8fCAiIiApLnNwbGl0KHJzcGFjZSk7CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgZWxlbS5jbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UocmNsYXNzLCAiICIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjID0gMCwgY2wgPSBjbGFzc05hbWVzLmxlbmd0aDsgYyA8IGNsOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZSgiICIgKyBjbGFzc05hbWVzWyBjIF0gKyAiICIsICIgIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKGNsYXNzTmFtZSk7CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSwgc3RhdGVWYWwpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsCiAgICAgICAgICAgICAgICBpc0Jvb2wgPSB0eXBlb2Ygc3RhdGVWYWwgPT09ICJib29sZWFuIjsKCiAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykudG9nZ2xlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwogICAgICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmID0galF1ZXJ5KHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IHN0YXRlVmFsLAogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWVzID0gdmFsdWUuc3BsaXQocnNwYWNlKTsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGVyYXRlZCBsaXN0CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gaXNCb29sID8gc3RhdGUgOiAhc2VsZi5oYXNDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmWyBzdGF0ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEodGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0b2dnbGUgd2hvbGUgY2xhc3NOYW1lCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZSB8fCB2YWx1ZSA9PT0gZmFsc2UgPyAiIiA6IGpRdWVyeS5fZGF0YSh0aGlzLCAiX19jbGFzc05hbWVfXyIpIHx8ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBoYXNDbGFzczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIiwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgbCA9IHRoaXMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKGNsYXNzTmFtZSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCiAgICAgICAgICAgICAgICBlbGVtID0gdGhpc1swXTsKCiAgICAgICAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgInZhbHVlIikpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldCA9IGVsZW0udmFsdWU7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV0ID09PSAic3RyaW5nIiA/CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnJlcGxhY2UocnJldHVybiwgIiIpIDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9PSBudWxsID8gIiIgOiByZXQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIHZhbDsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbHVlLmNhbGwodGhpcywgaSwgc2VsZi52YWwoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRyZWF0IG51bGwvdW5kZWZpbmVkIGFzICIiOyBjb252ZXJ0IG51bWJlcnMgdG8gc3RyaW5nCiAgICAgICAgICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSAiIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gIiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpRdWVyeS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyB0aGlzLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKICAgICAgICAgICAgICAgIC8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCiAgICAgICAgICAgICAgICBpZiAoIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8IGhvb2tzLnNldCh0aGlzLCB2YWwsICJ2YWx1ZSIpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICB2YWxIb29rczogewogICAgICAgICAgICBvcHRpb246IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBhdHRyaWJ1dGVzLnZhbHVlIGlzIHVuZGVmaW5lZCBpbiBCbGFja2JlcnJ5IDQuNyBidXQKICAgICAgICAgICAgICAgICAgICAvLyB1c2VzIC52YWx1ZS4gU2VlICM2OTMyCiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IGVsZW0uYXR0cmlidXRlcy52YWx1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIXZhbCB8fCB2YWwuc3BlY2lmaWVkID8gZWxlbS52YWx1ZSA6IGVsZW0udGV4dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2VsZWN0OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlLCBpLCBtYXgsIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0gZWxlbS5vcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICBvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIjsKCiAgICAgICAgICAgICAgICAgICAgLy8gTm90aGluZyB3YXMgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwogICAgICAgICAgICAgICAgICAgIGkgPSBvbmUgPyBpbmRleCA6IDA7CiAgICAgICAgICAgICAgICAgICAgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zWyBpIF07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgJiYgKGpRdWVyeS5zdXBwb3J0Lm9wdERpc2FibGVkID8gIW9wdGlvbi5kaXNhYmxlZCA6IG9wdGlvbi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT09IG51bGwpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUob3B0aW9uLnBhcmVudE5vZGUsICJvcHRncm91cCIpKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5KG9wdGlvbikudmFsKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gRml4ZXMgQnVnICMyNTUxIC0tIHNlbGVjdC52YWwoKSBicm9rZW4gaW4gSUUgYWZ0ZXIgZm9ybS5yZXNldCgpCiAgICAgICAgICAgICAgICAgICAgaWYgKG9uZSAmJiAhdmFsdWVzLmxlbmd0aCAmJiBvcHRpb25zLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5KG9wdGlvbnNbIGluZGV4IF0pLnZhbCgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSh2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgIGpRdWVyeShlbGVtKS5maW5kKCJvcHRpb24iKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeSh0aGlzKS52YWwoKSwgdmFsdWVzKSA+PSAwOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhdHRyRm46IHsKICAgICAgICAgICAgdmFsOiB0cnVlLAogICAgICAgICAgICBjc3M6IHRydWUsCiAgICAgICAgICAgIGh0bWw6IHRydWUsCiAgICAgICAgICAgIHRleHQ6IHRydWUsCiAgICAgICAgICAgIGRhdGE6IHRydWUsCiAgICAgICAgICAgIHdpZHRoOiB0cnVlLAogICAgICAgICAgICBoZWlnaHQ6IHRydWUsCiAgICAgICAgICAgIG9mZnNldDogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIGF0dHI6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSwgcGFzcykgewogICAgICAgICAgICB2YXIgcmV0LCBob29rcywgbm90eG1sLAogICAgICAgICAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgICAgICAgLy8gZG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICAgICAgICBpZiAoIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBhc3MgJiYgbmFtZSBpbiBqUXVlcnkuYXR0ckZuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5KGVsZW0pWyBuYW1lIF0odmFsdWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAogICAgICAgICAgICBpZiAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5wcm9wKGVsZW0sIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKTsKCiAgICAgICAgICAgIC8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKICAgICAgICAgICAgLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAogICAgICAgICAgICBpZiAobm90eG1sKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gfHwgKCByYm9vbGVhbi50ZXN0KG5hbWUpID8gYm9vbEhvb2sgOiBub2RlSG9vayApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIG5vdHhtbCAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCAiIiArIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIG5vdHhtbCAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSk7CgogICAgICAgICAgICAgICAgLy8gTm9uLWV4aXN0ZW50IGF0dHJpYnV0ZXMgcmV0dXJuIG51bGwsIHdlIG5vcm1hbGl6ZSB0byB1bmRlZmluZWQKICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPwogICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCA6CiAgICAgICAgICAgICAgICAgICAgcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBwcm9wTmFtZSwgYXR0ck5hbWVzLCBuYW1lLCBsLCBpc0Jvb2wsCiAgICAgICAgICAgICAgICBpID0gMDsKCiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBhdHRyTmFtZXMgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLnNwbGl0KHJzcGFjZSk7CiAgICAgICAgICAgICAgICBsID0gYXR0ck5hbWVzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyTmFtZXNbIGkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcE5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzQm9vbCA9IHJib29sZWFuLnRlc3QobmFtZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgIzk2OTkgZm9yIGV4cGxhbmF0aW9uIG9mIHRoaXMgYXBwcm9hY2ggKHNldHRpbmcgZmlyc3QsIHRoZW4gcmVtb3ZhbCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG8gbm90IGRvIHRoaXMgZm9yIGJvb2xlYW4gYXR0cmlidXRlcyAoc2VlICMxMDg3MCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Jvb2wpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5hdHRyKGVsZW0sIG5hbWUsICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShnZXRTZXRBdHRyaWJ1dGUgPyBuYW1lIDogcHJvcE5hbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNCb29sICYmIHByb3BOYW1lIGluIGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1bIHByb3BOYW1lIF0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGF0dHJIb29rczogewogICAgICAgICAgICB0eXBlOiB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbid0IGFsbG93IHRoZSB0eXBlIHByb3BlcnR5IHRvIGJlIGNoYW5nZWQgKHNpbmNlIGl0IGNhdXNlcyBwcm9ibGVtcyBpbiBJRSkKICAgICAgICAgICAgICAgICAgICBpZiAocnR5cGUudGVzdChlbGVtLm5vZGVOYW1lKSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmVycm9yKCJ0eXBlIHByb3BlcnR5IGNhbid0IGJlIGNoYW5nZWQiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFqUXVlcnkuc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaW5wdXQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHZhbHVlIHRvIGl0J3MgZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgZm9yIGVsZW1lbnQgY3JlYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IGVsZW0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJ0eXBlIiwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIFVzZSB0aGUgdmFsdWUgcHJvcGVydHkgZm9yIGJhY2sgY29tcGF0CiAgICAgICAgICAgIC8vIFVzZSB0aGUgbm9kZUhvb2sgZm9yIGJ1dHRvbiBlbGVtZW50cyBpbiBJRTYvNyAoIzE5NTQpCiAgICAgICAgICAgIHZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVIb29rICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiYnV0dG9uIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVIb29rLmdldChlbGVtLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5hbWUgaW4gZWxlbSA/CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0udmFsdWUgOgogICAgICAgICAgICAgICAgICAgICAgICBudWxsOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVIb29rICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiYnV0dG9uIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVIb29rLnNldChlbGVtLCB2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIERvZXMgbm90IHJldHVybiBzbyB0aGF0IHNldEF0dHJpYnV0ZSBpcyBhbHNvIHVzZWQKICAgICAgICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcm9wRml4OiB7CiAgICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgICByZWFkb25seTogInJlYWRPbmx5IiwKICAgICAgICAgICAgImZvciI6ICJodG1sRm9yIiwKICAgICAgICAgICAgImNsYXNzIjogImNsYXNzTmFtZSIsCiAgICAgICAgICAgIG1heGxlbmd0aDogIm1heExlbmd0aCIsCiAgICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgICAgICAgICAgcm93c3BhbjogInJvd1NwYW4iLAogICAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICAgIGZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiLAogICAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiCiAgICAgICAgfSwKCiAgICAgICAgcHJvcDogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciByZXQsIGhvb2tzLCBub3R4bWwsCiAgICAgICAgICAgICAgICBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgogICAgICAgICAgICAvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgICAgICAgIGlmICghZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBub3R4bWwgPSBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pOwoKICAgICAgICAgICAgaWYgKG5vdHhtbCkgewogICAgICAgICAgICAgICAgLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwogICAgICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKICAgICAgICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnByb3BIb29rc1sgbmFtZSBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoIGVsZW1bIG5hbWUgXSA9IHZhbHVlICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtWyBuYW1lIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcm9wSG9va3M6IHsKICAgICAgICAgICAgdGFiSW5kZXg6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0CiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2ZsdWlkcHJvamVjdC5vcmcvYmxvZy8yMDA4LzAxLzA5L2dldHRpbmctc2V0dGluZy1hbmQtcmVtb3ZpbmctdGFiaW5kZXgtdmFsdWVzLXdpdGgtamF2YXNjcmlwdC8KICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlTm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgidGFiaW5kZXgiKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQgPwogICAgICAgICAgICAgICAgICAgICAgICBwYXJzZUludChhdHRyaWJ1dGVOb2RlLnZhbHVlLCAxMCkgOgogICAgICAgICAgICAgICAgICAgICAgICByZm9jdXNhYmxlLnRlc3QoZWxlbS5ub2RlTmFtZSkgfHwgcmNsaWNrYWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpICYmIGVsZW0uaHJlZiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKLy8gQWRkIHRoZSB0YWJJbmRleCBwcm9wSG9vayB0byBhdHRySG9va3MgZm9yIGJhY2stY29tcGF0IChkaWZmZXJlbnQgY2FzZSBpcyBpbnRlbnRpb25hbCkKICAgIGpRdWVyeS5hdHRySG9va3MudGFiaW5kZXggPSBqUXVlcnkucHJvcEhvb2tzLnRhYkluZGV4OwoKLy8gSG9vayBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgICBib29sSG9vayA9IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgICAgICAgIC8vIEFsaWduIGJvb2xlYW4gYXR0cmlidXRlcyB3aXRoIGNvcnJlc3BvbmRpbmcgcHJvcGVydGllcwogICAgICAgICAgICAvLyBGYWxsIGJhY2sgdG8gYXR0cmlidXRlIHByZXNlbmNlIHdoZXJlIHNvbWUgYm9vbGVhbnMgYXJlIG5vdCBzdXBwb3J0ZWQKICAgICAgICAgICAgdmFyIGF0dHJOb2RlLAogICAgICAgICAgICAgICAgcHJvcGVydHkgPSBqUXVlcnkucHJvcChlbGVtLCBuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5ID09PSB0cnVlIHx8IHR5cGVvZiBwcm9wZXJ0eSAhPT0gImJvb2xlYW4iICYmICggYXR0ck5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkgKSAmJiBhdHRyTm9kZS5ub2RlVmFsdWUgIT09IGZhbHNlID8KICAgICAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSA6CiAgICAgICAgICAgICAgICB1bmRlZmluZWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gdmFsdWUgaXMgdHJ1ZSBzaW5jZSB3ZSBrbm93IGF0IHRoaXMgcG9pbnQgaXQncyB0eXBlIGJvb2xlYW4gYW5kIG5vdCBmYWxzZQogICAgICAgICAgICAgICAgLy8gU2V0IGJvb2xlYW4gYXR0cmlidXRlcyB0byB0aGUgc2FtZSBuYW1lIGFuZCBzZXQgdGhlIERPTSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgcHJvcE5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAocHJvcE5hbWUgaW4gZWxlbSkgewogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc2V0IHRoZSBJREwgc3BlY2lmaWNhbGx5IGlmIGl0IGFscmVhZHkgZXhpc3RzIG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgZWxlbVsgcHJvcE5hbWUgXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgbmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICB9CiAgICB9OwoKLy8gSUU2LzcgZG8gbm90IHN1cHBvcnQgZ2V0dGluZy9zZXR0aW5nIHNvbWUgYXR0cmlidXRlcyB3aXRoIGdldC9zZXRBdHRyaWJ1dGUKICAgIGlmICghZ2V0U2V0QXR0cmlidXRlKSB7CgogICAgICAgIGZpeFNwZWNpZmllZCA9IHsKICAgICAgICAgICAgbmFtZTogdHJ1ZSwKICAgICAgICAgICAgaWQ6IHRydWUsCiAgICAgICAgICAgIGNvb3JkczogdHJ1ZQogICAgICAgIH07CgogICAgICAgIC8vIFVzZSB0aGlzIGZvciBhbnkgYXR0cmlidXRlIGluIElFNi83CiAgICAgICAgLy8gVGhpcyBmaXhlcyBhbG1vc3QgZXZlcnkgSUU2LzcgaXNzdWUKICAgICAgICBub2RlSG9vayA9IGpRdWVyeS52YWxIb29rcy5idXR0b24gPSB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciByZXQ7CiAgICAgICAgICAgICAgICByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0ICYmICggZml4U3BlY2lmaWVkWyBuYW1lIF0gPyByZXQubm9kZVZhbHVlICE9PSAiIiA6IHJldC5zcGVjaWZpZWQgKSA/CiAgICAgICAgICAgICAgICAgICAgcmV0Lm5vZGVWYWx1ZSA6CiAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBleGlzdGluZyBvciBjcmVhdGUgYSBuZXcgYXR0cmlidXRlIG5vZGUKICAgICAgICAgICAgICAgIHZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoIXJldCkgewogICAgICAgICAgICAgICAgICAgIHJldCA9IGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZU5vZGUocmV0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAoIHJldC5ub2RlVmFsdWUgPSB2YWx1ZSArICIiICk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBBcHBseSB0aGUgbm9kZUhvb2sgdG8gdGFiaW5kZXgKICAgICAgICBqUXVlcnkuYXR0ckhvb2tzLnRhYmluZGV4LnNldCA9IG5vZGVIb29rLnNldDsKCiAgICAgICAgLy8gU2V0IHdpZHRoIGFuZCBoZWlnaHQgdG8gYXV0byBpbnN0ZWFkIG9mIDAgb24gZW1wdHkgc3RyaW5nKCBCdWcgIzgxNTAgKQogICAgICAgIC8vIFRoaXMgaXMgZm9yIHJlbW92YWxzCiAgICAgICAgalF1ZXJ5LmVhY2goWyAid2lkdGgiLCAiaGVpZ2h0IiBdLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgICAgICAgICBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsICJhdXRvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBTZXQgY29udGVudGVkaXRhYmxlIHRvIGZhbHNlIG9uIHJlbW92YWxzKCMxMDQyOSkKICAgICAgICAvLyBTZXR0aW5nIHRvIGVtcHR5IHN0cmluZyB0aHJvd3MgYW4gZXJyb3IgYXMgYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIGpRdWVyeS5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewogICAgICAgICAgICBnZXQ6IG5vZGVIb29rLmdldCwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICJmYWxzZSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlSG9vay5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCgovLyBTb21lIGF0dHJpYnV0ZXMgcmVxdWlyZSBhIHNwZWNpYWwgY2FsbCBvbiBJRQogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5ocmVmTm9ybWFsaXplZCkgewogICAgICAgIGpRdWVyeS5lYWNoKFsgImhyZWYiLCAic3JjIiwgIndpZHRoIiwgImhlaWdodCIgXSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgICAgICAgICAgalF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV4dGVuZChqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0sIHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSwgMik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5zdHlsZSkgewogICAgICAgIGpRdWVyeS5hdHRySG9va3Muc3R5bGUgPSB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgIC8vIFJldHVybiB1bmRlZmluZWQgaW4gdGhlIGNhc2Ugb2YgZW1wdHkgc3RyaW5nCiAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdG8gbG93ZXJjYXNlIHNpbmNlIElFIHVwcGVyY2FzZXMgY3NzIHByb3BlcnR5IG5hbWVzCiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0LnRvTG93ZXJDYXNlKCkgfHwgdW5kZWZpbmVkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gIiIgKyB2YWx1ZSApOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCi8vIFNhZmFyaSBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CiAgICBpZiAoIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkKSB7CiAgICAgICAgalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IGpRdWVyeS5leHRlbmQoalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgaXQgYWxzbyB3b3JrcyB3aXRoIG9wdGdyb3Vwcywgc2VlICM1NzAxCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCi8vIElFNi83IGNhbGwgZW5jdHlwZSBlbmNvZGluZwogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5lbmN0eXBlKSB7CiAgICAgICAgalF1ZXJ5LnByb3BGaXguZW5jdHlwZSA9ICJlbmNvZGluZyI7CiAgICB9CgovLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5jaGVja09uKSB7CiAgICAgICAgalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGluIFdlYmtpdCAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9KTsKICAgIH0KICAgIGpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSBqUXVlcnkuZXh0ZW5kKGpRdWVyeS52YWxIb29rc1sgdGhpcyBdLCB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSkgPj0gMCApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKCgogICAgdmFyIHJmb3JtRWxlbXMgPSAvXig/OnRleHRhcmVhfGlucHV0fHNlbGVjdCkkL2ksCiAgICAgICAgcnR5cGVuYW1lc3BhY2UgPSAvXihbXlwuXSopPyg/OlwuKC4rKSk/JC8sCiAgICAgICAgcmhvdmVySGFjayA9IC8oPzpefFxzKWhvdmVyKFwuXFMrKT9cYi8sCiAgICAgICAgcmtleUV2ZW50ID0gL15rZXkvLAogICAgICAgIHJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxjb250ZXh0bWVudSl8Y2xpY2svLAogICAgICAgIHJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLAogICAgICAgIHJxdWlja0lzID0gL14oXHcqKSg/OiMoW1x3XC1dKykpPyg/OlwuKFtcd1wtXSspKT8kLywKICAgICAgICBxdWlja1BhcnNlID0gZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciBxdWljayA9IHJxdWlja0lzLmV4ZWMoc2VsZWN0b3IpOwogICAgICAgICAgICBpZiAocXVpY2spIHsKICAgICAgICAgICAgICAgIC8vICAgMCAgMSAgICAyICAgMwogICAgICAgICAgICAgICAgLy8gWyBfLCB0YWcsIGlkLCBjbGFzcyBdCiAgICAgICAgICAgICAgICBxdWlja1sxXSA9ICggcXVpY2tbMV0gfHwgIiIgKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgcXVpY2tbM10gPSBxdWlja1szXSAmJiBuZXcgUmVnRXhwKCIoPzpefFxccykiICsgcXVpY2tbM10gKyAiKD86XFxzfCQpIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1aWNrOwogICAgICAgIH0sCiAgICAgICAgcXVpY2tJcyA9IGZ1bmN0aW9uIChlbGVtLCBtKSB7CiAgICAgICAgICAgIHZhciBhdHRycyA9IGVsZW0uYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICghbVsxXSB8fCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG1bMV0pICYmCiAgICAgICAgICAgICAgICAgICAgKCFtWzJdIHx8IChhdHRycy5pZCB8fCB7fSkudmFsdWUgPT09IG1bMl0pICYmCiAgICAgICAgICAgICAgICAgICAgKCFtWzNdIHx8IG1bM10udGVzdCgoYXR0cnNbICJjbGFzcyIgXSB8fCB7fSkudmFsdWUpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICB9LAogICAgICAgIGhvdmVySGFjayA9IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC5zcGVjaWFsLmhvdmVyID8gZXZlbnRzIDogZXZlbnRzLnJlcGxhY2UocmhvdmVySGFjaywgIm1vdXNlZW50ZXIkMSBtb3VzZWxlYXZlJDEiKTsKICAgICAgICB9OwoKICAgIC8qCiAgICAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuCiAgICAgKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogICAgICovCiAgICBqUXVlcnkuZXZlbnQgPSB7CgogICAgICAgIGFkZDogZnVuY3Rpb24gKGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvcikgewoKICAgICAgICAgICAgdmFyIGVsZW1EYXRhLCBldmVudEhhbmRsZSwgZXZlbnRzLAogICAgICAgICAgICAgICAgdCwgdG5zLCB0eXBlLCBuYW1lc3BhY2VzLCBoYW5kbGVPYmosCiAgICAgICAgICAgICAgICBoYW5kbGVPYmpJbiwgcXVpY2ssIGhhbmRsZXJzLCBzcGVjaWFsOwoKICAgICAgICAgICAgLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChhbGxvdyBwbGFpbiBvYmplY3RzIHRobykKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhdHlwZXMgfHwgIWhhbmRsZXIgfHwgIShlbGVtRGF0YSA9IGpRdWVyeS5fZGF0YShlbGVtKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCiAgICAgICAgICAgIGlmIChoYW5kbGVyLmhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIGhhbmRsZU9iakluID0gaGFuZGxlcjsKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCiAgICAgICAgICAgIGlmICghaGFuZGxlci5ndWlkKSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CiAgICAgICAgICAgIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50czsKICAgICAgICAgICAgaWYgKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIGVsZW1EYXRhLmV2ZW50cyA9IGV2ZW50cyA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwogICAgICAgICAgICBpZiAoIWV2ZW50SGFuZGxlKSB7CiAgICAgICAgICAgICAgICBlbGVtRGF0YS5oYW5kbGUgPSBldmVudEhhbmRsZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmICghZSB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUpID8KICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KGV2ZW50SGFuZGxlLmVsZW0sIGFyZ3VtZW50cykgOgogICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgLy8gQWRkIGVsZW0gYXMgYSBwcm9wZXJ0eSBvZiB0aGUgaGFuZGxlIGZuIHRvIHByZXZlbnQgYSBtZW1vcnkgbGVhayB3aXRoIElFIG5vbi1uYXRpdmUgZXZlbnRzCiAgICAgICAgICAgICAgICBldmVudEhhbmRsZS5lbGVtID0gZWxlbTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgICAgICAgICAvLyBqUXVlcnkoLi4uKS5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CiAgICAgICAgICAgIHR5cGVzID0galF1ZXJ5LnRyaW0oaG92ZXJIYWNrKHR5cGVzKSkuc3BsaXQoIiAiKTsKICAgICAgICAgICAgZm9yICh0ID0gMDsgdCA8IHR5cGVzLmxlbmd0aDsgdCsrKSB7CgogICAgICAgICAgICAgICAgdG5zID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgICAgICAgICB0eXBlID0gdG5zWzFdOwogICAgICAgICAgICAgICAgbmFtZXNwYWNlcyA9ICggdG5zWzJdIHx8ICIiICkuc3BsaXQoIi4iKS5zb3J0KCk7CgogICAgICAgICAgICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgICAgICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCiAgICAgICAgICAgICAgICAvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKICAgICAgICAgICAgICAgIHR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCiAgICAgICAgICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCiAgICAgICAgICAgICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICAgICAgICAgICAgaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgICAgICBvcmlnVHlwZTogdG5zWzFdLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICAgICAgICAgICAgICBndWlkOiBoYW5kbGVyLmd1aWQsCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHNlbGVjdG9yLAogICAgICAgICAgICAgICAgICAgIHF1aWNrOiBzZWxlY3RvciAmJiBxdWlja1BhcnNlKHNlbGVjdG9yKSwKICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbigiLiIpCiAgICAgICAgICAgICAgICB9LCBoYW5kbGVPYmpJbik7CgogICAgICAgICAgICAgICAgLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKICAgICAgICAgICAgICAgIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF07CiAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyL2F0dGFjaEV2ZW50IGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKICAgICAgICAgICAgICAgICAgICBpZiAoIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQmluZCB0aGUgZ2xvYmFsIGV2ZW50IGhhbmRsZXIgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0uYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0uYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYXR0YWNoRXZlbnQoIm9uIiArIHR5cGUsIGV2ZW50SGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbC5hZGQpIHsKICAgICAgICAgICAgICAgICAgICBzcGVjaWFsLmFkZC5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CgogICAgICAgICAgICAgICAgICAgIGlmICghaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCkgewogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAogICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQogICAgICAgICAgICBlbGVtID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBnbG9iYWw6IHt9LAoKICAgICAgICAvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzKSB7CgogICAgICAgICAgICB2YXIgZWxlbURhdGEgPSBqUXVlcnkuaGFzRGF0YShlbGVtKSAmJiBqUXVlcnkuX2RhdGEoZWxlbSksCiAgICAgICAgICAgICAgICB0LCB0bnMsIHR5cGUsIG9yaWdUeXBlLCBuYW1lc3BhY2VzLCBvcmlnQ291bnQsCiAgICAgICAgICAgICAgICBqLCBldmVudHMsIHNwZWNpYWwsIGhhbmRsZSwgZXZlbnRUeXBlLCBoYW5kbGVPYmo7CgogICAgICAgICAgICBpZiAoIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCiAgICAgICAgICAgIHR5cGVzID0galF1ZXJ5LnRyaW0oaG92ZXJIYWNrKHR5cGVzIHx8ICIiKSkuc3BsaXQoIiAiKTsKICAgICAgICAgICAgZm9yICh0ID0gMDsgdCA8IHR5cGVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgICAgICAgICB0bnMgPSBydHlwZW5hbWVzcGFjZS5leGVjKHR5cGVzW3RdKSB8fCBbXTsKICAgICAgICAgICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRuc1sxXTsKICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMgPSB0bnNbMl07CgogICAgICAgICAgICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHR5cGUgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSArIHR5cGVzWyB0IF0sIGhhbmRsZXIsIHNlbGVjdG9yLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CiAgICAgICAgICAgICAgICB0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CiAgICAgICAgICAgICAgICBldmVudFR5cGUgPSBldmVudHNbIHR5cGUgXSB8fCBbXTsKICAgICAgICAgICAgICAgIG9yaWdDb3VudCA9IGV2ZW50VHlwZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2VzID0gbmFtZXNwYWNlcyA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5zcGxpdCgiLiIpLnNvcnQoKS5qb2luKCJcXC4oPzouKlxcLik/IikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzCiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZXZlbnRUeXBlLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqID0gZXZlbnRUeXBlWyBqIF07CgogICAgICAgICAgICAgICAgICAgIGlmICgoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAoICFuYW1lc3BhY2VzIHx8IG5hbWVzcGFjZXMudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSApICYmCiAgICAgICAgICAgICAgICAgICAgICAgICggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlLnNwbGljZShqLS0sIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZU9iai5zZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlLmRlbGVnYXRlQ291bnQtLTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbC5yZW1vdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpYWwucmVtb3ZlLmNhbGwoZWxlbSwgaGFuZGxlT2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIHdlIHJlbW92ZWQgc29tZXRoaW5nIGFuZCBubyBtb3JlIGhhbmRsZXJzIGV4aXN0CiAgICAgICAgICAgICAgICAvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKICAgICAgICAgICAgICAgIGlmIChldmVudFR5cGUubGVuZ3RoID09PSAwICYmIG9yaWdDb3VudCAhPT0gZXZlbnRUeXBlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3BlY2lhbC50ZWFyZG93biB8fCBzcGVjaWFsLnRlYXJkb3duLmNhbGwoZWxlbSwgbmFtZXNwYWNlcykgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudChlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRW1wdHlPYmplY3QoZXZlbnRzKSkgewogICAgICAgICAgICAgICAgaGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwogICAgICAgICAgICAgICAgaWYgKGhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZS5lbGVtID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQogICAgICAgICAgICAgICAgLy8gc28gdXNlIGl0IGluc3RlYWQgb2YgZGVsZXRlCiAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRGF0YShlbGVtLCBbICJldmVudHMiLCAiaGFuZGxlIiBdLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIEV2ZW50cyB0aGF0IGFyZSBzYWZlIHRvIHNob3J0LWNpcmN1aXQgaWYgbm8gaGFuZGxlcnMgYXJlIGF0dGFjaGVkLgogICAgICAgIC8vIE5hdGl2ZSBET00gZXZlbnRzIHNob3VsZCBub3QgYmUgYWRkZWQsIHRoZXkgbWF5IGhhdmUgaW5saW5lIGhhbmRsZXJzLgogICAgICAgIGN1c3RvbUV2ZW50OiB7CiAgICAgICAgICAgICJnZXREYXRhIjogdHJ1ZSwKICAgICAgICAgICAgInNldERhdGEiOiB0cnVlLAogICAgICAgICAgICAiY2hhbmdlRGF0YSI6IHRydWUKICAgICAgICB9LAoKICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycykgewogICAgICAgICAgICAvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICAgICAgICBpZiAoZWxlbSAmJiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFdmVudCBvYmplY3Qgb3IgZXZlbnQgdHlwZQogICAgICAgICAgICB2YXIgdHlwZSA9IGV2ZW50LnR5cGUgfHwgZXZlbnQsCiAgICAgICAgICAgICAgICBuYW1lc3BhY2VzID0gW10sCiAgICAgICAgICAgICAgICBjYWNoZSwgZXhjbHVzaXZlLCBpLCBjdXIsIG9sZCwgb250eXBlLCBzcGVjaWFsLCBoYW5kbGUsIGV2ZW50UGF0aCwgYnViYmxlVHlwZTsKCiAgICAgICAgICAgIC8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwogICAgICAgICAgICBpZiAocmZvY3VzTW9ycGgudGVzdCh0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGUuaW5kZXhPZigiISIpID49IDApIHsKICAgICAgICAgICAgICAgIC8vIEV4Y2x1c2l2ZSBldmVudHMgdHJpZ2dlciBvbmx5IGZvciB0aGUgZXhhY3QgZXZlbnQgKG5vIG5hbWVzcGFjZXMpCiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZS5zbGljZSgwLCAtMSk7CiAgICAgICAgICAgICAgICBleGNsdXNpdmUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZS5pbmRleE9mKCIuIikgPj0gMCkgewogICAgICAgICAgICAgICAgLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQogICAgICAgICAgICAgICAgbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKICAgICAgICAgICAgICAgIHR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2VzLnNvcnQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCghZWxlbSB8fCBqUXVlcnkuZXZlbnQuY3VzdG9tRXZlbnRbIHR5cGUgXSkgJiYgIWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSkgewogICAgICAgICAgICAgICAgLy8gTm8galF1ZXJ5IGhhbmRsZXJzIGZvciB0aGlzIGV2ZW50IHR5cGUsIGFuZCBpdCBjYW4ndCBoYXZlIGlubGluZSBoYW5kbGVycwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gRXZlbnQsIE9iamVjdCwgb3IganVzdCBhbiBldmVudCB0eXBlIHN0cmluZwogICAgICAgICAgICBldmVudCA9IHR5cGVvZiBldmVudCA9PT0gIm9iamVjdCIgPwogICAgICAgICAgICAgICAgLy8galF1ZXJ5LkV2ZW50IG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gPyBldmVudCA6CiAgICAgICAgICAgICAgICAgICAgLy8gT2JqZWN0IGxpdGVyYWwKICAgICAgICAgICAgICAgICAgICBuZXcgalF1ZXJ5LkV2ZW50KHR5cGUsIGV2ZW50KSA6CiAgICAgICAgICAgICAgICAvLyBKdXN0IHRoZSBldmVudCB0eXBlIChzdHJpbmcpCiAgICAgICAgICAgICAgICBuZXcgalF1ZXJ5LkV2ZW50KHR5cGUpOwoKICAgICAgICAgICAgZXZlbnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IHRydWU7CiAgICAgICAgICAgIGV2ZW50LmV4Y2x1c2l2ZSA9IGV4Y2x1c2l2ZTsKICAgICAgICAgICAgZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCIuIik7CiAgICAgICAgICAgIGV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLik/IikgKyAiKFxcLnwkKSIpIDogbnVsbDsKICAgICAgICAgICAgb250eXBlID0gdHlwZS5pbmRleE9mKCI6IikgPCAwID8gIm9uIiArIHR5cGUgOiAiIjsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBhIGdsb2JhbCB0cmlnZ2VyCiAgICAgICAgICAgIGlmICghZWxlbSkgewoKICAgICAgICAgICAgICAgIC8vIFRPRE86IFN0b3AgdGF1bnRpbmcgdGhlIGRhdGEgY2FjaGU7IHJlbW92ZSBnbG9iYWwgZXZlbnRzIGFuZCBhbHdheXMgYXR0YWNoIHRvIGRvY3VtZW50CiAgICAgICAgICAgICAgICBjYWNoZSA9IGpRdWVyeS5jYWNoZTsKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBjYWNoZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZVsgaSBdLmV2ZW50cyAmJiBjYWNoZVsgaSBdLmV2ZW50c1sgdHlwZSBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGV2ZW50LCBkYXRhLCBjYWNoZVsgaSBdLmhhbmRsZS5lbGVtLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAogICAgICAgICAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBlbGVtOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbG9uZSBhbnkgaW5jb21pbmcgZGF0YSBhbmQgcHJlcGVuZCB0aGUgZXZlbnQsIGNyZWF0aW5nIHRoZSBoYW5kbGVyIGFyZyBsaXN0CiAgICAgICAgICAgIGRhdGEgPSBkYXRhICE9IG51bGwgPyBqUXVlcnkubWFrZUFycmF5KGRhdGEpIDogW107CiAgICAgICAgICAgIGRhdGEudW5zaGlmdChldmVudCk7CgogICAgICAgICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwogICAgICAgICAgICBpZiAoc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCiAgICAgICAgICAgIC8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCiAgICAgICAgICAgIGV2ZW50UGF0aCA9IFsKICAgICAgICAgICAgICAgIFsgZWxlbSwgc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlIF0KICAgICAgICAgICAgXTsKICAgICAgICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewoKICAgICAgICAgICAgICAgIGJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwogICAgICAgICAgICAgICAgY3VyID0gcmZvY3VzTW9ycGgudGVzdChidWJibGVUeXBlICsgdHlwZSkgPyBlbGVtIDogZWxlbS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgb2xkID0gbnVsbDsKICAgICAgICAgICAgICAgIGZvciAoOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRQYXRoLnB1c2goWyBjdXIsIGJ1YmJsZVR5cGUgXSk7CiAgICAgICAgICAgICAgICAgICAgb2xkID0gY3VyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICAgICAgICAgICAgaWYgKG9sZCAmJiBvbGQgPT09IGVsZW0ub3duZXJEb2N1bWVudCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKFsgb2xkLmRlZmF1bHRWaWV3IHx8IG9sZC5wYXJlbnRXaW5kb3cgfHwgd2luZG93LCBidWJibGVUeXBlIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudFBhdGgubGVuZ3RoICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpOyBpKyspIHsKCiAgICAgICAgICAgICAgICBjdXIgPSBldmVudFBhdGhbaV1bMF07CiAgICAgICAgICAgICAgICBldmVudC50eXBlID0gZXZlbnRQYXRoW2ldWzFdOwoKICAgICAgICAgICAgICAgIGhhbmRsZSA9ICggalF1ZXJ5Ll9kYXRhKGN1ciwgImV2ZW50cyIpIHx8IHt9IClbIGV2ZW50LnR5cGUgXSAmJiBqUXVlcnkuX2RhdGEoY3VyLCAiaGFuZGxlIik7CiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlLmFwcGx5KGN1ciwgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgdGhpcyBpcyBhIGJhcmUgSlMgZnVuY3Rpb24gYW5kIG5vdCBhIGpRdWVyeSBoYW5kbGVyCiAgICAgICAgICAgICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKICAgICAgICAgICAgICAgIGlmIChoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoY3VyKSAmJiBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwoKICAgICAgICAgICAgLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwogICAgICAgICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKCiAgICAgICAgICAgICAgICBpZiAoKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoZWxlbS5vd25lckRvY3VtZW50LCBkYXRhKSA9PT0gZmFsc2UpICYmICEodHlwZSA9PT0gImNsaWNrIiAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImEiKSkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCBhIG5hdGl2ZSBET00gbWV0aG9kIG9uIHRoZSB0YXJnZXQgd2l0aCB0aGUgc2FtZSBuYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgIC8vIENhbid0IHVzZSBhbiAuaXNGdW5jdGlvbigpIGNoZWNrIGhlcmUgYmVjYXVzZSBJRTYvNyBmYWlscyB0aGF0IHRlc3QuCiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQogICAgICAgICAgICAgICAgICAgIC8vIElFPDkgZGllcyBvbiBmb2N1cy9ibHVyIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NikKICAgICAgICAgICAgICAgICAgICBpZiAob250eXBlICYmIGVsZW1bIHR5cGUgXSAmJiAoKHR5cGUgIT09ICJmb2N1cyIgJiYgdHlwZSAhPT0gImJsdXIiKSB8fCBldmVudC50YXJnZXQub2Zmc2V0V2lkdGggIT09IDApICYmICFqUXVlcnkuaXNXaW5kb3coZWxlbSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IHJlLXRyaWdnZXIgYW4gb25GT08gZXZlbnQgd2hlbiB3ZSBjYWxsIGl0cyBGT08oKSBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgb2xkID0gZWxlbVsgb250eXBlIF07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBvbnR5cGUgXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyB0eXBlIF0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1bIG9udHlwZSBdID0gb2xkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIGRpc3BhdGNoOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgICAgIC8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAogICAgICAgICAgICBldmVudCA9IGpRdWVyeS5ldmVudC5maXgoZXZlbnQgfHwgd2luZG93LmV2ZW50KTsKCiAgICAgICAgICAgIHZhciBoYW5kbGVycyA9ICggKGpRdWVyeS5fZGF0YSh0aGlzLCAiZXZlbnRzIikgfHwge30gKVsgZXZlbnQudHlwZSBdIHx8IFtdKSwKICAgICAgICAgICAgICAgIGRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAogICAgICAgICAgICAgICAgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSwKICAgICAgICAgICAgICAgIHJ1bl9hbGwgPSAhZXZlbnQuZXhjbHVzaXZlICYmICFldmVudC5uYW1lc3BhY2UsCiAgICAgICAgICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGV2ZW50LnR5cGUgXSB8fCB7fSwKICAgICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgaSwgaiwgY3VyLCBqcWN1ciwgcmV0LCBzZWxNYXRjaCwgbWF0Y2hlZCwgbWF0Y2hlcywgaGFuZGxlT2JqLCBzZWwsIHJlbGF0ZWQ7CgogICAgICAgICAgICAvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAogICAgICAgICAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICAgICAgICAgIGV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCiAgICAgICAgICAgIC8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKICAgICAgICAgICAgaWYgKHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGhhbmRsZXJzIHRoYXQgc2hvdWxkIHJ1biBpZiB0aGVyZSBhcmUgZGVsZWdhdGVkIGV2ZW50cwogICAgICAgICAgICAvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKICAgICAgICAgICAgaWYgKGRlbGVnYXRlQ291bnQgJiYgIShldmVudC5idXR0b24gJiYgZXZlbnQudHlwZSA9PT0gImNsaWNrIikpIHsKCiAgICAgICAgICAgICAgICAvLyBQcmVnZW5lcmF0ZSBhIHNpbmdsZSBqUXVlcnkgb2JqZWN0IGZvciByZXVzZSB3aXRoIC5pcygpCiAgICAgICAgICAgICAgICBqcWN1ciA9IGpRdWVyeSh0aGlzKTsKICAgICAgICAgICAgICAgIGpxY3VyLmNvbnRleHQgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpczsKCiAgICAgICAgICAgICAgICBmb3IgKGN1ciA9IGV2ZW50LnRhcmdldDsgY3VyICE9IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgcHJvY2VzcyBldmVudHMgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSkKICAgICAgICAgICAgICAgICAgICBpZiAoY3VyLmRpc2FibGVkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbE1hdGNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAganFjdXJbMF0gPSBjdXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3I7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbE1hdGNoWyBzZWwgXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsTWF0Y2hbIHNlbCBdID0gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmoucXVpY2sgPyBxdWlja0lzKGN1ciwgaGFuZGxlT2JqLnF1aWNrKSA6IGpxY3VyLmlzKHNlbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxNYXRjaFsgc2VsIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogY3VyLCBtYXRjaGVzOiBtYXRjaGVzIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCiAgICAgICAgICAgIGlmIChoYW5kbGVycy5sZW5ndGggPiBkZWxlZ2F0ZUNvdW50KSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IHRoaXMsIG1hdGNoZXM6IGhhbmRsZXJzLnNsaWNlKGRlbGVnYXRlQ291bnQpIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSdW4gZGVsZWdhdGVzIGZpcnN0OyB0aGV5IG1heSB3YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gYmVuZWF0aCB1cwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGFuZGxlclF1ZXVlLmxlbmd0aCAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTsgaSsrKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpIF07CiAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwoKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBtYXRjaGVkLm1hdGNoZXMubGVuZ3RoICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmogPSBtYXRjaGVkLm1hdGNoZXNbIGogXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlcmVkIGV2ZW50IG11c3QgZWl0aGVyIDEpIGJlIG5vbi1leGNsdXNpdmUgYW5kIGhhdmUgbm8gbmFtZXNwYWNlLCBvcgogICAgICAgICAgICAgICAgICAgIC8vIDIpIGhhdmUgbmFtZXNwYWNlKHMpIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLgogICAgICAgICAgICAgICAgICAgIGlmIChydW5fYWxsIHx8ICghZXZlbnQubmFtZXNwYWNlICYmICFoYW5kbGVPYmoubmFtZXNwYWNlKSB8fCBldmVudC5uYW1lc3BhY2VfcmUgJiYgZXZlbnQubmFtZXNwYWNlX3JlLnRlc3QoaGFuZGxlT2JqLm5hbWVzcGFjZSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gKCAoalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGhhbmRsZU9iai5vcmlnVHlwZSBdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGx5KG1hdGNoZWQuZWxlbSwgYXJncyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJlc3VsdCA9IHJldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQogICAgICAgICAgICBpZiAoc3BlY2lhbC5wb3N0RGlzcGF0Y2gpIHsKICAgICAgICAgICAgICAgIHNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIC8vIEluY2x1ZGVzIHNvbWUgZXZlbnQgcHJvcHMgc2hhcmVkIGJ5IEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50CiAgICAgICAgLy8gKioqIGF0dHJDaGFuZ2UgYXR0ck5hbWUgcmVsYXRlZE5vZGUgc3JjRWxlbWVudCAgYXJlIG5vdCBub3JtYWxpemVkLCBub24tVzNDLCBkZXByZWNhdGVkLCB3aWxsIGJlIHJlbW92ZWQgaW4gMS44ICoqKgogICAgICAgIHByb3BzOiAiYXR0ckNoYW5nZSBhdHRyTmFtZSByZWxhdGVkTm9kZSBzcmNFbGVtZW50IGFsdEtleSBidWJibGVzIGNhbmNlbGFibGUgY3RybEtleSBjdXJyZW50VGFyZ2V0IGV2ZW50UGhhc2UgbWV0YUtleSByZWxhdGVkVGFyZ2V0IHNoaWZ0S2V5IHRhcmdldCB0aW1lU3RhbXAgdmlldyB3aGljaCIuc3BsaXQoIiAiKSwKCiAgICAgICAgZml4SG9va3M6IHt9LAoKICAgICAgICBrZXlIb29rczogewogICAgICAgICAgICBwcm9wczogImNoYXIgY2hhckNvZGUga2V5IGtleUNvZGUiLnNwbGl0KCIgIiksCiAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKGV2ZW50LCBvcmlnaW5hbCkgewoKICAgICAgICAgICAgICAgIC8vIEFkZCB3aGljaCBmb3Iga2V5IGV2ZW50cwogICAgICAgICAgICAgICAgaWYgKGV2ZW50LndoaWNoID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC53aGljaCA9IG9yaWdpbmFsLmNoYXJDb2RlICE9IG51bGwgPyBvcmlnaW5hbC5jaGFyQ29kZSA6IG9yaWdpbmFsLmtleUNvZGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbW91c2VIb29rczogewogICAgICAgICAgICBwcm9wczogImJ1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBmcm9tRWxlbWVudCBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCIuc3BsaXQoIiAiKSwKICAgICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXZlbnQsIG9yaWdpbmFsKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnREb2MsIGRvYywgYm9keSwKICAgICAgICAgICAgICAgICAgICBidXR0b24gPSBvcmlnaW5hbC5idXR0b24sCiAgICAgICAgICAgICAgICAgICAgZnJvbUVsZW1lbnQgPSBvcmlnaW5hbC5mcm9tRWxlbWVudDsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiAoZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIGRvYyA9IGV2ZW50RG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICAgICAgICBib2R5ID0gZXZlbnREb2MuYm9keTsKCiAgICAgICAgICAgICAgICAgICAgZXZlbnQucGFnZVggPSBvcmlnaW5hbC5jbGllbnRYICsgKCBkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudExlZnQgfHwgYm9keSAmJiBib2R5LmNsaWVudExlZnQgfHwgMCApOwogICAgICAgICAgICAgICAgICAgIGV2ZW50LnBhZ2VZID0gb3JpZ2luYWwuY2xpZW50WSArICggZG9jICYmIGRvYy5zY3JvbGxUb3AgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50VG9wIHx8IGJvZHkgJiYgYm9keS5jbGllbnRUb3AgfHwgMCApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFkZCByZWxhdGVkVGFyZ2V0LCBpZiBuZWNlc3NhcnkKICAgICAgICAgICAgICAgIGlmICghZXZlbnQucmVsYXRlZFRhcmdldCAmJiBmcm9tRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tRWxlbWVudCA9PT0gZXZlbnQudGFyZ2V0ID8gb3JpZ2luYWwudG9FbGVtZW50IDogZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAogICAgICAgICAgICAgICAgLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKICAgICAgICAgICAgICAgIGlmICghZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZml4OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwogICAgICAgICAgICB2YXIgaSwgcHJvcCwKICAgICAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQgPSBldmVudCwKICAgICAgICAgICAgICAgIGZpeEhvb2sgPSBqUXVlcnkuZXZlbnQuZml4SG9va3NbIGV2ZW50LnR5cGUgXSB8fCB7fSwKICAgICAgICAgICAgICAgIGNvcHkgPSBmaXhIb29rLnByb3BzID8gdGhpcy5wcm9wcy5jb25jYXQoZml4SG9vay5wcm9wcykgOiB0aGlzLnByb3BzOwoKICAgICAgICAgICAgZXZlbnQgPSBqUXVlcnkuRXZlbnQob3JpZ2luYWxFdmVudCk7CgogICAgICAgICAgICBmb3IgKGkgPSBjb3B5Lmxlbmd0aDsgaTspIHsKICAgICAgICAgICAgICAgIHByb3AgPSBjb3B5WyAtLWkgXTsKICAgICAgICAgICAgICAgIGV2ZW50WyBwcm9wIF0gPSBvcmlnaW5hbEV2ZW50WyBwcm9wIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpeCB0YXJnZXQgcHJvcGVydHksIGlmIG5lY2Vzc2FyeSAoIzE5MjUsIElFIDYvNy84ICYgU2FmYXJpMikKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IG9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKCM1MDQsIFNhZmFyaSkKICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZvciBtb3VzZS9rZXkgZXZlbnRzOyBhZGQgbWV0YUtleSBpZiBpdCdzIG5vdCB0aGVyZSAoIzMzNjgsIElFNi83LzgpCiAgICAgICAgICAgIGlmIChldmVudC5tZXRhS2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGV2ZW50Lm1ldGFLZXkgPSBldmVudC5jdHJsS2V5OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlcihldmVudCwgb3JpZ2luYWxFdmVudCkgOiBldmVudDsKICAgICAgICB9LAoKICAgICAgICBzcGVjaWFsOiB7CiAgICAgICAgICAgIHJlYWR5OiB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhlIHJlYWR5IGV2ZW50IGlzIHNldHVwCiAgICAgICAgICAgICAgICBzZXR1cDogalF1ZXJ5LmJpbmRSZWFkeQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbG9hZDogewogICAgICAgICAgICAgICAgLy8gUHJldmVudCB0cmlnZ2VyZWQgaW1hZ2UubG9hZCBldmVudHMgZnJvbSBidWJibGluZyB0byB3aW5kb3cubG9hZAogICAgICAgICAgICAgICAgbm9CdWJibGU6IHRydWUKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZvY3VzOiB7CiAgICAgICAgICAgICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgogICAgICAgICAgICB9LAogICAgICAgICAgICBibHVyOiB7CiAgICAgICAgICAgICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJlZm9yZXVubG9hZDogewogICAgICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uIChkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIG9ubHkgd2FudCB0byBkbyB0aGlzIHNwZWNpYWwgY2FzZSBvbiB3aW5kb3dzCiAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc1dpbmRvdyh0aGlzKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uYmVmb3JldW5sb2FkID0gZXZlbnRIYW5kbGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub25iZWZvcmV1bmxvYWQgPT09IGV2ZW50SGFuZGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25iZWZvcmV1bmxvYWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNpbXVsYXRlOiBmdW5jdGlvbiAodHlwZSwgZWxlbSwgZXZlbnQsIGJ1YmJsZSkgewogICAgICAgICAgICAvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCiAgICAgICAgICAgIC8vIEZha2Ugb3JpZ2luYWxFdmVudCB0byBhdm9pZCBkb25vcidzIHN0b3BQcm9wYWdhdGlvbiwgYnV0IGlmIHRoZQogICAgICAgICAgICAvLyBzaW11bGF0ZWQgZXZlbnQgcHJldmVudHMgZGVmYXVsdCB0aGVuIHdlIGRvIHRoZSBzYW1lIG9uIHRoZSBkb25vci4KICAgICAgICAgICAgdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAogICAgICAgICAgICAgICAgbmV3IGpRdWVyeS5FdmVudCgpLAogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICB7IHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxFdmVudDoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGJ1YmJsZSkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoZSwgbnVsbCwgZWxlbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbChlbGVtLCBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgovLyBTb21lIHBsdWdpbnMgYXJlIHVzaW5nLCBidXQgaXQncyB1bmRvY3VtZW50ZWQvZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkLgovLyBUaGUgMS43IHNwZWNpYWwgZXZlbnQgaW50ZXJmYWNlIHNob3VsZCBwcm92aWRlIGFsbCB0aGUgaG9va3MgbmVlZGVkIG5vdy4KICAgIGpRdWVyeS5ldmVudC5oYW5kbGUgPSBqUXVlcnkuZXZlbnQuZGlzcGF0Y2g7CgogICAgalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA/CiAgICAgICAgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGhhbmRsZSkgewogICAgICAgICAgICBpZiAoZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IDoKICAgICAgICBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChlbGVtLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtLmRldGFjaEV2ZW50KCJvbiIgKyB0eXBlLCBoYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICBqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiAoc3JjLCBwcm9wcykgewogICAgICAgIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KHNyYywgcHJvcHMpOwogICAgICAgIH0KCiAgICAgICAgLy8gRXZlbnQgb2JqZWN0CiAgICAgICAgaWYgKHNyYyAmJiBzcmMudHlwZSkgewogICAgICAgICAgICB0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHNyYy50eXBlOwoKICAgICAgICAgICAgLy8gRXZlbnRzIGJ1YmJsaW5nIHVwIHRoZSBkb2N1bWVudCBtYXkgaGF2ZSBiZWVuIG1hcmtlZCBhcyBwcmV2ZW50ZWQKICAgICAgICAgICAgLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCiAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlIHx8CiAgICAgICAgICAgICAgICBzcmMuZ2V0UHJldmVudERlZmF1bHQgJiYgc3JjLmdldFByZXZlbnREZWZhdWx0KCkgKSA/IHJldHVyblRydWUgOiByZXR1cm5GYWxzZTsKCiAgICAgICAgICAgIC8vIEV2ZW50IHR5cGUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnR5cGUgPSBzcmM7CiAgICAgICAgfQoKICAgICAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgICAgIGlmIChwcm9wcykgewogICAgICAgICAgICBqUXVlcnkuZXh0ZW5kKHRoaXMsIHByb3BzKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCiAgICAgICAgdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBqUXVlcnkubm93KCk7CgogICAgICAgIC8vIE1hcmsgaXQgYXMgZml4ZWQKICAgICAgICB0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsKICAgIH07CgogICAgZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIHJldHVyblRydWUoKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCiAgICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsKCiAgICAgICAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICAgICAgICBpZiAoIWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgcHJldmVudERlZmF1bHQgZXhpc3RzIHJ1biBpdCBvbiB0aGUgb3JpZ2luYWwgZXZlbnQKICAgICAgICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgogICAgICAgICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgICAgICAgaWYgKCFlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gaWYgc3RvcFByb3BhZ2F0aW9uIGV4aXN0cyBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CiAgICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBvdGhlcndpc2Ugc2V0IHRoZSBjYW5jZWxCdWJibGUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIHRydWUgKElFKQogICAgICAgICAgICBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgfSwKICAgICAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICAgICAgICAgIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfSwKICAgICAgICBpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAogICAgICAgIGlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKICAgICAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UKICAgIH07CgovLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgICBtb3VzZWVudGVyOiAibW91c2VvdmVyIiwKICAgICAgICBtb3VzZWxlYXZlOiAibW91c2VvdXQiCiAgICB9LCBmdW5jdGlvbiAob3JpZywgZml4KSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKICAgICAgICAgICAgZGVsZWdhdGVUeXBlOiBmaXgsCiAgICAgICAgICAgIGJpbmRUeXBlOiBmaXgsCgogICAgICAgICAgICBoYW5kbGU6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gaGFuZGxlT2JqLnNlbGVjdG9yLAogICAgICAgICAgICAgICAgICAgIHJldDsKCiAgICAgICAgICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICAgICAgaWYgKCFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CiAgICAgICAgICAgICAgICAgICAgcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICBldmVudC50eXBlID0gZml4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KTsKCi8vIElFIHN1Ym1pdCBkZWxlZ2F0aW9uCiAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMpIHsKCiAgICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWwuc3VibWl0ID0gewogICAgICAgICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkubm9kZU5hbWUodGhpcywgImZvcm0iKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBMYXp5LWFkZCBhIHN1Ym1pdCBoYW5kbGVyIHdoZW4gYSBkZXNjZW5kYW50IGZvcm0gbWF5IHBvdGVudGlhbGx5IGJlIHN1Ym1pdHRlZAogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCAiY2xpY2suX3N1Ym1pdCBrZXlwcmVzcy5fc3VibWl0IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBOb2RlIG5hbWUgY2hlY2sgYXZvaWRzIGEgVk1MLXJlbGF0ZWQgY3Jhc2ggaW4gSUUgKCM5ODA3KQogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZS50YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0gPSBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImlucHV0IikgfHwgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJidXR0b24iKSA/IGVsZW0uZm9ybSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybSAmJiAhZm9ybS5fc3VibWl0X2F0dGFjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZm9ybSwgInN1Ym1pdC5fc3VibWl0IiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5fc3VibWl0X2J1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JtLl9zdWJtaXRfYXR0YWNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHVuZGVmaW5lZCBzaW5jZSB3ZSBkb24ndCBuZWVkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgLy8gSWYgZm9ybSB3YXMgc3VibWl0dGVkIGJ5IHRoZSB1c2VyLCBidWJibGUgdGhlIGV2ZW50IHVwIHRoZSB0cmVlCiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuX3N1Ym1pdF9idWJibGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNUcmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZSgic3VibWl0IiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgbmVlZCB0aGlzIGZvciBkZWxlZ2F0ZWQgZm9ybSBzdWJtaXQgZXZlbnRzCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Lm5vZGVOYW1lKHRoaXMsICJmb3JtIikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGRlbGVnYXRlZCBoYW5kbGVyczsgY2xlYW5EYXRhIGV2ZW50dWFsbHkgcmVhcHMgc3VibWl0IGhhbmRsZXJzIGF0dGFjaGVkIGFib3ZlCiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKHRoaXMsICIuX3N1Ym1pdCIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcykgewoKICAgICAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgogICAgICAgICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIGlmIChyZm9ybUVsZW1zLnRlc3QodGhpcy5ub2RlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJRSBkb2Vzbid0IGZpcmUgY2hhbmdlIG9uIGEgY2hlY2svcmFkaW8gdW50aWwgYmx1cjsgdHJpZ2dlciBpdCBvbiBjbGljawogICAgICAgICAgICAgICAgICAgIC8vIGFmdGVyIGEgcHJvcGVydHljaGFuZ2UuIEVhdCB0aGUgYmx1ci1jaGFuZ2UgaW4gc3BlY2lhbC5jaGFuZ2UuaGFuZGxlLgogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgc3RpbGwgZmlyZXMgb25jaGFuZ2UgYSBzZWNvbmQgdGltZSBmb3IgY2hlY2svcmFkaW8gYWZ0ZXIgYmx1ci4KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIikgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsICJwcm9wZXJ0eWNoYW5nZS5fY2hhbmdlIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2p1c3RfY2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fanVzdF9jaGFuZ2VkICYmICFldmVudC5pc1RyaWdnZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9qdXN0X2NoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuc2ltdWxhdGUoImNoYW5nZSIsIHRoaXMsIGV2ZW50LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIERlbGVnYXRlZCBldmVudDsgbGF6eS1hZGQgYSBjaGFuZ2UgaGFuZGxlciBvbiBkZXNjZW5kYW50IGlucHV0cwogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCAiYmVmb3JlYWN0aXZhdGUuX2NoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBlLnRhcmdldDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHJmb3JtRWxlbXMudGVzdChlbGVtLm5vZGVOYW1lKSAmJiAhZWxlbS5fY2hhbmdlX2F0dGFjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZWxlbSwgImNoYW5nZS5fY2hhbmdlIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1NpbXVsYXRlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCJjaGFuZ2UiLCB0aGlzLnBhcmVudE5vZGUsIGV2ZW50LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uX2NoYW5nZV9hdHRhY2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoYW5kbGU6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBldmVudC50YXJnZXQ7CgogICAgICAgICAgICAgICAgLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCiAgICAgICAgICAgICAgICBpZiAodGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSh0aGlzLCAiLl9jaGFuZ2UiKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gcmZvcm1FbGVtcy50ZXN0KHRoaXMubm9kZU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwogICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5mb2N1c2luQnViYmxlcykgewogICAgICAgIGpRdWVyeS5lYWNoKHsgZm9jdXM6ICJmb2N1c2luIiwgYmx1cjogImZvY3Vzb3V0IiB9LCBmdW5jdGlvbiAob3JpZywgZml4KSB7CgogICAgICAgICAgICAvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CiAgICAgICAgICAgIHZhciBhdHRhY2hlcyA9IDAsCiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KGV2ZW50KSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGZpeCBdID0gewogICAgICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0YWNoZXMrKyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICgtLWF0dGFjaGVzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIob3JpZywgaGFuZGxlciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgfQoKICAgIGpRdWVyeS5mbi5leHRlbmQoewoKICAgICAgICBvbjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIC8qSU5URVJOQUwqLyBvbmUpIHsKICAgICAgICAgICAgdmFyIG9yaWdGbiwgdHlwZTsKCiAgICAgICAgICAgIC8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciKSB7IC8vICYmIHNlbGVjdG9yICE9IG51bGwKICAgICAgICAgICAgICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uKHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1sgdHlwZSBdLCBvbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgLy8gKCB0eXBlcywgZm4gKQogICAgICAgICAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICAgICAgICAgIGRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIC8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCiAgICAgICAgICAgICAgICAgICAgZm4gPSBkYXRhOwogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vICggdHlwZXMsIGRhdGEsIGZuICkKICAgICAgICAgICAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHNlbGVjdG9yOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWZuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9uZSA9PT0gMSkgewogICAgICAgICAgICAgICAgb3JpZ0ZuID0gZm47CiAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwogICAgICAgICAgICAgICAgICAgIGpRdWVyeSgpLm9mZihldmVudCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCiAgICAgICAgICAgICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQodGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3Rvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgb25lOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxKTsKICAgICAgICB9LAogICAgICAgIG9mZjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZm4pIHsKICAgICAgICAgICAgaWYgKHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaikgewogICAgICAgICAgICAgICAgLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAogICAgICAgICAgICAgICAgdmFyIGhhbmRsZU9iaiA9IHR5cGVzLmhhbmRsZU9iajsKICAgICAgICAgICAgICAgIGpRdWVyeSh0eXBlcy5kZWxlZ2F0ZVRhcmdldCkub2ZmKAogICAgICAgICAgICAgICAgICAgIGhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLAogICAgICAgICAgICAgICAgICAgIGhhbmRsZU9iai5zZWxlY3RvciwKICAgICAgICAgICAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlcgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQogICAgICAgICAgICAgICAgZm9yICh2YXIgdHlwZSBpbiB0eXBlcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMub2ZmKHR5cGUsIHNlbGVjdG9yLCB0eXBlc1sgdHlwZSBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAvLyAoIHR5cGVzIFssIGZuXSApCiAgICAgICAgICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZuID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZm4gPSByZXR1cm5GYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUodGhpcywgdHlwZXMsIGZuLCBzZWxlY3Rvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIG51bGwsIGRhdGEsIGZuKTsKICAgICAgICB9LAogICAgICAgIHVuYmluZDogZnVuY3Rpb24gKHR5cGVzLCBmbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vZmYodHlwZXMsIG51bGwsIGZuKTsKICAgICAgICB9LAoKICAgICAgICBsaXZlOiBmdW5jdGlvbiAodHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgICAgICAgIGpRdWVyeSh0aGlzLmNvbnRleHQpLm9uKHR5cGVzLCB0aGlzLnNlbGVjdG9yLCBkYXRhLCBmbik7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgZGllOiBmdW5jdGlvbiAodHlwZXMsIGZuKSB7CiAgICAgICAgICAgIGpRdWVyeSh0aGlzLmNvbnRleHQpLm9mZih0eXBlcywgdGhpcy5zZWxlY3RvciB8fCAiKioiLCBmbik7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKTsKICAgICAgICB9LAogICAgICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGZuKSB7CiAgICAgICAgICAgIC8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT0gMSA/IHRoaXMub2ZmKHNlbGVjdG9yLCAiKioiKSA6IHRoaXMub2ZmKHR5cGVzLCBzZWxlY3RvciwgZm4pOwogICAgICAgIH0sCgogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpc1swXSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB0b2dnbGU6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAvLyBTYXZlIHJlZmVyZW5jZSB0byBhcmd1bWVudHMgZm9yIGFjY2VzcyBpbiBjbG9zdXJlCiAgICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKywKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgdG9nZ2xlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIEZpZ3VyZSBvdXQgd2hpY2ggZnVuY3Rpb24gdG8gZXhlY3V0ZQogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0VG9nZ2xlID0gKCBqUXVlcnkuX2RhdGEodGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCkgfHwgMCApICUgaTsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEodGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCwgbGFzdFRvZ2dsZSArIDEpOwoKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBjbGlja3Mgc3RvcAogICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgICAgIC8vIGFuZCBleGVjdXRlIHRoZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmdzWyBsYXN0VG9nZ2xlIF0uYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCBmYWxzZTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBsaW5rIGFsbCB0aGUgZnVuY3Rpb25zLCBzbyBhbnkgb2YgdGhlbSBjYW4gdW5iaW5kIHRoaXMgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICB0b2dnbGVyLmd1aWQgPSBndWlkOwogICAgICAgICAgICB3aGlsZSAoaSA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhcmdzWyBpKysgXS5ndWlkID0gZ3VpZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xpY2sodG9nZ2xlcik7CiAgICAgICAgfSwKCiAgICAgICAgaG92ZXI6IGZ1bmN0aW9uIChmbk92ZXIsIGZuT3V0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1vdXNlZW50ZXIoZm5PdmVyKS5tb3VzZWxlYXZlKGZuT3V0IHx8IGZuT3Zlcik7CiAgICAgICAgfQogICAgfSk7CgogICAgalF1ZXJ5LmVhY2goKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKICAgICAgICAibW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgIiArCiAgICAgICAgImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IgY29udGV4dG1lbnUiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiAoaSwgbmFtZSkgewoKICAgICAgICAvLyBIYW5kbGUgZXZlbnQgYmluZGluZwogICAgICAgIGpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24gKGRhdGEsIGZuKSB7CiAgICAgICAgICAgIGlmIChmbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8KICAgICAgICAgICAgICAgIHRoaXMub24obmFtZSwgbnVsbCwgZGF0YSwgZm4pIDoKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcihuYW1lKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoalF1ZXJ5LmF0dHJGbikgewogICAgICAgICAgICBqUXVlcnkuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJrZXlFdmVudC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5maXhIb29rc1sgbmFtZSBdID0galF1ZXJ5LmV2ZW50LmtleUhvb2tzOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJtb3VzZUV2ZW50LnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmZpeEhvb2tzWyBuYW1lIF0gPSBqUXVlcnkuZXZlbnQubW91c2VIb29rczsKICAgICAgICB9CiAgICB9KTsKCgogICAgLyohCiAgICAgKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZQogICAgICogIENvcHlyaWdodCAyMDExLCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAgICAgKiAgUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogICAgICogIE1vcmUgaW5mb3JtYXRpb246IGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAgICAgKi8KICAgIChmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBjaHVua2VyID0gLygoPzpcKCg/OlwoW14oKV0rXCl8W14oKV0rKStcKXxcWyg/OlxbW15cW1xdXSpcXXxbJyJdW14nIl0qWyciXXxbXlxbXF0nIl0rKStcXXxcXC58W14gPit+LChcW1xcXSspK3xbPit+XSkoXHMqLFxzKik/KCg/Oi58XHJ8XG4pKikvZywKICAgICAgICAgICAgZXhwYW5kbyA9ICJzaXpjYWNoZSIgKyAoTWF0aC5yYW5kb20oKSArICcnKS5yZXBsYWNlKCcuJywgJycpLAogICAgICAgICAgICBkb25lID0gMCwKICAgICAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgICAgICBoYXNEdXBsaWNhdGUgPSBmYWxzZSwKICAgICAgICAgICAgYmFzZUhhc0R1cGxpY2F0ZSA9IHRydWUsCiAgICAgICAgICAgIHJCYWNrc2xhc2ggPSAvXFwvZywKICAgICAgICAgICAgclJldHVybiA9IC9cclxuL2csCiAgICAgICAgICAgIHJOb25Xb3JkID0gL1xXLzsKCi8vIEhlcmUgd2UgY2hlY2sgaWYgdGhlIEphdmFTY3JpcHQgZW5naW5lIGlzIHVzaW5nIHNvbWUgc29ydCBvZgovLyBvcHRpbWl6YXRpb24gd2hlcmUgaXQgZG9lcyBub3QgYWx3YXlzIGNhbGwgb3VyIGNvbXBhcmlzaW9uCi8vIGZ1bmN0aW9uLiBJZiB0aGF0IGlzIHRoZSBjYXNlLCBkaXNjYXJkIHRoZSBoYXNEdXBsaWNhdGUgdmFsdWUuCi8vICAgVGh1cyBmYXIgdGhhdCBpbmNsdWRlcyBHb29nbGUgQ2hyb21lLgogICAgICAgIFswLCAwXS5zb3J0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYmFzZUhhc0R1cGxpY2F0ZSA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIFNpenpsZSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgogICAgICAgICAgICB2YXIgb3JpZ0NvbnRleHQgPSBjb250ZXh0OwoKICAgICAgICAgICAgaWYgKGNvbnRleHQubm9kZVR5cGUgIT09IDEgJiYgY29udGV4dC5ub2RlVHlwZSAhPT0gOSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXNlbGVjdG9yIHx8IHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbSwgc2V0LCBjaGVja1NldCwgZXh0cmEsIHJldCwgY3VyLCBwb3AsIGksCiAgICAgICAgICAgICAgICBwcnVuZSA9IHRydWUsCiAgICAgICAgICAgICAgICBjb250ZXh0WE1MID0gU2l6emxlLmlzWE1MKGNvbnRleHQpLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIHNvRmFyID0gc2VsZWN0b3I7CgogICAgICAgICAgICAvLyBSZXNldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNodW5rZXIgcmVnZXhwIChzdGFydCBmcm9tIGhlYWQpCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGNodW5rZXIuZXhlYygiIik7CiAgICAgICAgICAgICAgICBtID0gY2h1bmtlci5leGVjKHNvRmFyKTsKCiAgICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgICAgIHNvRmFyID0gbVszXTsKCiAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChtWzFdKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG1bMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmEgPSBtWzNdOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKG0pOwoKICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEgJiYgb3JpZ1BPUy5leGVjKHNlbGVjdG9yKSkgewoKICAgICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDIgJiYgRXhwci5yZWxhdGl2ZVsgcGFydHNbMF0gXSkgewogICAgICAgICAgICAgICAgICAgIHNldCA9IHBvc1Byb2Nlc3MocGFydHNbMF0gKyBwYXJ0c1sxXSwgY29udGV4dCwgc2VlZCk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXQgPSBFeHByLnJlbGF0aXZlWyBwYXJ0c1swXSBdID8KICAgICAgICAgICAgICAgICAgICAgICAgWyBjb250ZXh0IF0gOgogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUocGFydHMuc2hpZnQoKSwgY29udGV4dCk7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBwYXJ0cy5zaGlmdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEV4cHIucmVsYXRpdmVbIHNlbGVjdG9yIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yICs9IHBhcnRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHNldCA9IHBvc1Byb2Nlc3Moc2VsZWN0b3IsIHNldCwgc2VlZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRha2UgYSBzaG9ydGN1dCBhbmQgc2V0IHRoZSBjb250ZXh0IGlmIHRoZSByb290IHNlbGVjdG9yIGlzIGFuIElECiAgICAgICAgICAgICAgICAvLyAoYnV0IG5vdCBpZiBpdCdsbCBiZSBmYXN0ZXIgaWYgdGhlIGlubmVyIHNlbGVjdG9yIGlzIGFuIElEKQogICAgICAgICAgICAgICAgaWYgKCFzZWVkICYmIHBhcnRzLmxlbmd0aCA+IDEgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhY29udGV4dFhNTCAmJgogICAgICAgICAgICAgICAgICAgIEV4cHIubWF0Y2guSUQudGVzdChwYXJ0c1swXSkgJiYgIUV4cHIubWF0Y2guSUQudGVzdChwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXSkpIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gU2l6emxlLmZpbmQocGFydHMuc2hpZnQoKSwgY29udGV4dCwgY29udGV4dFhNTCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHJldC5leHByID8KICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlLmZpbHRlcihyZXQuZXhwciwgcmV0LnNldClbMF0gOgogICAgICAgICAgICAgICAgICAgICAgICByZXQuc2V0WzBdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0ID0gc2VlZCA/CiAgICAgICAgICAgICAgICAgICAgeyBleHByOiBwYXJ0cy5wb3AoKSwgc2V0OiBtYWtlQXJyYXkoc2VlZCkgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5maW5kKHBhcnRzLnBvcCgpLCBwYXJ0cy5sZW5ndGggPT09IDEgJiYgKHBhcnRzWzBdID09PSAifiIgfHwgcGFydHNbMF0gPT09ICIrIikgJiYgY29udGV4dC5wYXJlbnROb2RlID8gY29udGV4dC5wYXJlbnROb2RlIDogY29udGV4dCwgY29udGV4dFhNTCk7CgogICAgICAgICAgICAgICAgICAgIHNldCA9IHJldC5leHByID8KICAgICAgICAgICAgICAgICAgICAgICAgU2l6emxlLmZpbHRlcihyZXQuZXhwciwgcmV0LnNldCkgOgogICAgICAgICAgICAgICAgICAgICAgICByZXQuc2V0OwoKICAgICAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NldCA9IG1ha2VBcnJheShzZXQpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwcnVuZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXIgPSBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9wID0gY3VyOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFFeHByLnJlbGF0aXZlWyBjdXIgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3AgPSBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3AgPSBjb250ZXh0OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBFeHByLnJlbGF0aXZlWyBjdXIgXShjaGVja1NldCwgcG9wLCBjb250ZXh0WE1MKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1NldCA9IHBhcnRzID0gW107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghY2hlY2tTZXQpIHsKICAgICAgICAgICAgICAgIGNoZWNrU2V0ID0gc2V0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWNoZWNrU2V0KSB7CiAgICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IoY3VyIHx8IHNlbGVjdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRvU3RyaW5nLmNhbGwoY2hlY2tTZXQpID09PSAiW29iamVjdCBBcnJheV0iKSB7CiAgICAgICAgICAgICAgICBpZiAoIXBydW5lKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoLmFwcGx5KHJlc3VsdHMsIGNoZWNrU2V0KTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGNoZWNrU2V0W2ldICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tTZXRbaV0gJiYgKGNoZWNrU2V0W2ldID09PSB0cnVlIHx8IGNoZWNrU2V0W2ldLm5vZGVUeXBlID09PSAxICYmIFNpenpsZS5jb250YWlucyhjb250ZXh0LCBjaGVja1NldFtpXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goc2V0W2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGNoZWNrU2V0W2ldICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tTZXRbaV0gJiYgY2hlY2tTZXRbaV0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChzZXRbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1ha2VBcnJheShjaGVja1NldCwgcmVzdWx0cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChleHRyYSkgewogICAgICAgICAgICAgICAgU2l6emxlKGV4dHJhLCBvcmlnQ29udGV4dCwgcmVzdWx0cywgc2VlZCk7CiAgICAgICAgICAgICAgICBTaXp6bGUudW5pcXVlU29ydChyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfTsKCiAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiAocmVzdWx0cykgewogICAgICAgICAgICBpZiAoc29ydE9yZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNEdXBsaWNhdGUgPSBiYXNlSGFzRHVwbGljYXRlOwogICAgICAgICAgICAgICAgcmVzdWx0cy5zb3J0KHNvcnRPcmRlcik7CgogICAgICAgICAgICAgICAgaWYgKGhhc0R1cGxpY2F0ZSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0c1tpXSA9PT0gcmVzdWx0c1sgaSAtIDEgXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5zcGxpY2UoaS0tLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfTsKCiAgICAgICAgU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiAoZXhwciwgc2V0KSB7CiAgICAgICAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgc2V0KTsKICAgICAgICB9OwoKICAgICAgICBTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKG5vZGUsIGV4cHIpIHsKICAgICAgICAgICAgcmV0dXJuIFNpenpsZShleHByLCBudWxsLCBudWxsLCBbbm9kZV0pLmxlbmd0aCA+IDA7CiAgICAgICAgfTsKCiAgICAgICAgU2l6emxlLmZpbmQgPSBmdW5jdGlvbiAoZXhwciwgY29udGV4dCwgaXNYTUwpIHsKICAgICAgICAgICAgdmFyIHNldCwgaSwgbGVuLCBtYXRjaCwgdHlwZSwgbGVmdDsKCiAgICAgICAgICAgIGlmICghZXhwcikgewogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBFeHByLm9yZGVyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gRXhwci5vcmRlcltpXTsKCiAgICAgICAgICAgICAgICBpZiAoKG1hdGNoID0gRXhwci5sZWZ0TWF0Y2hbIHR5cGUgXS5leGVjKGV4cHIpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICBtYXRjaC5zcGxpY2UoMSwgMSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0LnN1YnN0cihsZWZ0Lmxlbmd0aCAtIDEpICE9PSAiXFwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoWzFdID0gKG1hdGNoWzFdIHx8ICIiKS5yZXBsYWNlKHJCYWNrc2xhc2gsICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0ID0gRXhwci5maW5kWyB0eXBlIF0obWF0Y2gsIGNvbnRleHQsIGlzWE1MKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwciA9IGV4cHIucmVwbGFjZShFeHByLm1hdGNoWyB0eXBlIF0sICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXNldCkgewogICAgICAgICAgICAgICAgc2V0ID0gdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiID8KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgOgogICAgICAgICAgICAgICAgICAgIFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4geyBzZXQ6IHNldCwgZXhwcjogZXhwciB9OwogICAgICAgIH07CgogICAgICAgIFNpenpsZS5maWx0ZXIgPSBmdW5jdGlvbiAoZXhwciwgc2V0LCBpbnBsYWNlLCBub3QpIHsKICAgICAgICAgICAgdmFyIG1hdGNoLCBhbnlGb3VuZCwKICAgICAgICAgICAgICAgIHR5cGUsIGZvdW5kLCBpdGVtLCBmaWx0ZXIsIGxlZnQsCiAgICAgICAgICAgICAgICBpLCBwYXNzLAogICAgICAgICAgICAgICAgb2xkID0gZXhwciwKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgICAgICAgY3VyTG9vcCA9IHNldCwKICAgICAgICAgICAgICAgIGlzWE1MRmlsdGVyID0gc2V0ICYmIHNldFswXSAmJiBTaXp6bGUuaXNYTUwoc2V0WzBdKTsKCiAgICAgICAgICAgIHdoaWxlIChleHByICYmIHNldC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAodHlwZSBpbiBFeHByLmZpbHRlcikgewogICAgICAgICAgICAgICAgICAgIGlmICgobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoZXhwcikpICE9IG51bGwgJiYgbWF0Y2hbMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyID0gRXhwci5maWx0ZXJbIHR5cGUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdCA9IG1hdGNoWzFdOwoKICAgICAgICAgICAgICAgICAgICAgICAgYW55Rm91bmQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLnNwbGljZSgxLCAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0LnN1YnN0cihsZWZ0Lmxlbmd0aCAtIDEpID09PSAiXFwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1ckxvb3AgPT09IHJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChFeHByLnByZUZpbHRlclsgdHlwZSBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IEV4cHIucHJlRmlsdGVyWyB0eXBlIF0obWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTEZpbHRlcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFueUZvdW5kID0gZm91bmQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyAoaXRlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gZmlsdGVyKGl0ZW0sIG1hdGNoLCBpLCBjdXJMb29wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcyA9IG5vdCBeIGZvdW5kOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucGxhY2UgJiYgZm91bmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnlGb3VuZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJMb29wW2ldID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW55Rm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyTG9vcCA9IHJlc3VsdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHByID0gZXhwci5yZXBsYWNlKEV4cHIubWF0Y2hbIHR5cGUgXSwgIiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYW55Rm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW1wcm9wZXIgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgaWYgKGV4cHIgPT09IG9sZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChhbnlGb3VuZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5lcnJvcihleHByKTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9sZCA9IGV4cHI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjdXJMb29wOwogICAgICAgIH07CgogICAgICAgIFNpenpsZS5lcnJvciA9IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyZWl2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogICAgICAgICAqIEBwYXJhbSB7QXJyYXl8RWxlbWVudH0gZWxlbQogICAgICAgICAqLwogICAgICAgIHZhciBnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgaSwgbm9kZSwKICAgICAgICAgICAgICAgIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgIHJldCA9ICIiOwoKICAgICAgICAgICAgaWYgKG5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXNlIHRleHRDb250ZW50IHx8IGlubmVyVGV4dCBmb3IgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLnRleHRDb250ZW50OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW0uaW5uZXJUZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXBsYWNlIElFJ3MgY2FycmlhZ2UgcmV0dXJucwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5pbm5lclRleHQucmVwbGFjZShyUmV0dXJuLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJhdmVyc2UgaXQncyBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gZ2V0VGV4dChlbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgLy8gSWYgbm8gbm9kZVR5cGUsIHRoaXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IChub2RlID0gZWxlbVtpXSk7IGkrKykgewogICAgICAgICAgICAgICAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgIT09IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9IGdldFRleHQobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewogICAgICAgICAgICBvcmRlcjogWyAiSUQiLCAiTkFNRSIsICJUQUciIF0sCgogICAgICAgICAgICBtYXRjaDogewogICAgICAgICAgICAgICAgSUQ6IC8jKCg/Oltcd1x1MDBjMC1cdUZGRkZcLV18XFwuKSspLywKICAgICAgICAgICAgICAgIENMQVNTOiAvXC4oKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKykvLAogICAgICAgICAgICAgICAgTkFNRTogL1xbbmFtZT1bJyJdKigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKVsnIl0qXF0vLAogICAgICAgICAgICAgICAgQVRUUjogL1xbXHMqKCg/Oltcd1x1MDBjMC1cdUZGRkZcLV18XFwuKSspXHMqKD86KFxTPz0pXHMqKD86KFsnIl0pKC4qPylcM3woIz8oPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikqKXwpfClccypcXS8sCiAgICAgICAgICAgICAgICBUQUc6IC9eKCg/Oltcd1x1MDBjMC1cdUZGRkZcKlwtXXxcXC4pKykvLAogICAgICAgICAgICAgICAgQ0hJTEQ6IC86KG9ubHl8bnRofGxhc3R8Zmlyc3QpLWNoaWxkKD86XChccyooZXZlbnxvZGR8KD86WytcLV0/XGQrfCg/OlsrXC1dP1xkKik/blxzKig/OlsrXC1dXHMqXGQrKT8pKVxzKlwpKT8vLAogICAgICAgICAgICAgICAgUE9TOiAvOihudGh8ZXF8Z3R8bHR8Zmlyc3R8bGFzdHxldmVufG9kZCkoPzpcKChcZCopXCkpPyg/PVteXC1dfCQpLywKICAgICAgICAgICAgICAgIFBTRVVETzogLzooKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKykoPzpcKChbJyJdPykoKD86XChbXlwpXStcKXxbXlwoXCldKikrKVwyXCkpPy8KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGxlZnRNYXRjaDoge30sCgogICAgICAgICAgICBhdHRyTWFwOiB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAiY2xhc3NOYW1lIiwKICAgICAgICAgICAgICAgICJmb3IiOiAiaHRtbEZvciIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGF0dHJIYW5kbGU6IHsKICAgICAgICAgICAgICAgIGhyZWY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdHlwZTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbGF0aXZlOiB7CiAgICAgICAgICAgICAgICAiKyI6IGZ1bmN0aW9uIChjaGVja1NldCwgcGFydCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc1BhcnRTdHIgPSB0eXBlb2YgcGFydCA9PT0gInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGlzVGFnID0gaXNQYXJ0U3RyICYmICFyTm9uV29yZC50ZXN0KHBhcnQpLAogICAgICAgICAgICAgICAgICAgICAgICBpc1BhcnRTdHJOb3RUYWcgPSBpc1BhcnRTdHIgJiYgIWlzVGFnOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNUYWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoLCBlbGVtOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZWxlbSA9IGNoZWNrU2V0W2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChlbGVtID0gZWxlbS5wcmV2aW91c1NpYmxpbmcpICYmIGVsZW0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NldFtpXSA9IGlzUGFydFN0ck5vdFRhZyB8fCBlbGVtICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gcGFydCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSB8fCBmYWxzZSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9PT0gcGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzUGFydFN0ck5vdFRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZmlsdGVyKHBhcnQsIGNoZWNrU2V0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICI+IjogZnVuY3Rpb24gKGNoZWNrU2V0LCBwYXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgICAgICAgICAgICAgIGlzUGFydFN0ciA9IHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBjaGVja1NldC5sZW5ndGg7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1BhcnRTdHIgJiYgIXJOb25Xb3JkLnRlc3QocGFydCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gY2hlY2tTZXRbaV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2V0W2ldID0gcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IHBhcnQgPyBwYXJlbnQgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGNoZWNrU2V0W2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXRbaV0gPSBpc1BhcnRTdHIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUgPT09IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1BhcnRTdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5maWx0ZXIocGFydCwgY2hlY2tTZXQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiIjogZnVuY3Rpb24gKGNoZWNrU2V0LCBwYXJ0LCBpc1hNTCkgewogICAgICAgICAgICAgICAgICAgIHZhciBub2RlQ2hlY2ssCiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmVOYW1lID0gZG9uZSsrLAogICAgICAgICAgICAgICAgICAgICAgICBjaGVja0ZuID0gZGlyQ2hlY2s7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gInN0cmluZyIgJiYgIXJOb25Xb3JkLnRlc3QocGFydCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUNoZWNrID0gcGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tGbiA9IGRpck5vZGVDaGVjazsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNoZWNrRm4oInBhcmVudE5vZGUiLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAifiI6IGZ1bmN0aW9uIChjaGVja1NldCwgcGFydCwgaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZUNoZWNrLAogICAgICAgICAgICAgICAgICAgICAgICBkb25lTmFtZSA9IGRvbmUrKywKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tGbiA9IGRpckNoZWNrOwoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcnQgPT09ICJzdHJpbmciICYmICFyTm9uV29yZC50ZXN0KHBhcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVDaGVjayA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRm4gPSBkaXJOb2RlQ2hlY2s7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjaGVja0ZuKCJwcmV2aW91c1NpYmxpbmciLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmluZDogewogICAgICAgICAgICAgICAgSUQ6IGZ1bmN0aW9uIChtYXRjaCwgY29udGV4dCwgaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAgICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgTkFNRTogZnVuY3Rpb24gKG1hdGNoLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZShtYXRjaFsxXSk7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHJlc3VsdHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0c1tpXS5nZXRBdHRyaWJ1dGUoIm5hbWUiKSA9PT0gbWF0Y2hbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaChyZXN1bHRzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgVEFHOiBmdW5jdGlvbiAobWF0Y2gsIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKG1hdGNoWzFdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHByZUZpbHRlcjogewogICAgICAgICAgICAgICAgQ0xBU1M6IGZ1bmN0aW9uIChtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSAiICIgKyBtYXRjaFsxXS5yZXBsYWNlKHJCYWNrc2xhc2gsICIiKSArICIgIjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdCBeIChlbGVtLmNsYXNzTmFtZSAmJiAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UoL1tcdFxuXHJdL2csICIgIikuaW5kZXhPZihtYXRjaCkgPj0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlucGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5wbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1ckxvb3BbaV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBJRDogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoWzFdLnJlcGxhY2UockJhY2tzbGFzaCwgIiIpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBUQUc6IGZ1bmN0aW9uIChtYXRjaCwgY3VyTG9vcCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaFsxXS5yZXBsYWNlKHJCYWNrc2xhc2gsICIiKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBDSElMRDogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzFdID09PSAibnRoIikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoWzJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFsyXSA9IG1hdGNoWzJdLnJlcGxhY2UoL15cK3xccyovZywgJycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyc2UgZXF1YXRpb25zIGxpa2UgJ2V2ZW4nLCAnb2RkJywgJzUnLCAnMm4nLCAnM24rMicsICc0bi0xJywgJy1uKzYnCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXN0ID0gLygtPykoXGQqKSg/Om4oWytcLV0/XGQqKSk/Ly5leGVjKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbMl0gPT09ICJldmVuIiAmJiAiMm4iIHx8IG1hdGNoWzJdID09PSAib2RkIiAmJiAiMm4rMSIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhL1xELy50ZXN0KG1hdGNoWzJdKSAmJiAiMG4rIiArIG1hdGNoWzJdIHx8IG1hdGNoWzJdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgbnVtYmVycyAoZmlyc3QpbisobGFzdCkgaW5jbHVkaW5nIGlmIHRoZXkgYXJlIG5lZ2F0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoWzJdID0gKHRlc3RbMV0gKyAodGVzdFsyXSB8fCAxKSkgLSAwOwogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFszXSA9IHRlc3RbM10gLSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogTW92ZSB0byBub3JtYWwgY2FjaGluZyBzeXN0ZW0KICAgICAgICAgICAgICAgICAgICBtYXRjaFswXSA9IGRvbmUrKzsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBBVFRSOiBmdW5jdGlvbiAobWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKHJCYWNrc2xhc2gsICIiKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1hNTCAmJiBFeHByLmF0dHJNYXBbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hbMV0gPSBFeHByLmF0dHJNYXBbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgaWYgYW4gdW4tcXVvdGVkIHZhbHVlIHdhcyB1c2VkCiAgICAgICAgICAgICAgICAgICAgbWF0Y2hbNF0gPSAoIG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiICkucmVwbGFjZShyQmFja3NsYXNoLCAiIik7CgogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFsyXSA9PT0gIn49IikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFs0XSA9ICIgIiArIG1hdGNoWzRdICsgIiAiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBQU0VVRE86IGZ1bmN0aW9uIChtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hbMV0gPT09ICJub3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGNvbXBsZXggZXhwcmVzc2lvbiwgb3IgYSBzaW1wbGUgb25lCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoIGNodW5rZXIuZXhlYyhtYXRjaFszXSkgfHwgIiIgKS5sZW5ndGggPiAxIHx8IC9eXHcvLnRlc3QobWF0Y2hbM10pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaFszXSA9IFNpenpsZShtYXRjaFszXSwgbnVsbCwgbnVsbCwgY3VyTG9vcCk7CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IFNpenpsZS5maWx0ZXIobWF0Y2hbM10sIGN1ckxvb3AsIGlucGxhY2UsIHRydWUgXiBub3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5wbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgcmV0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChFeHByLm1hdGNoLlBPUy50ZXN0KG1hdGNoWzBdKSB8fCBFeHByLm1hdGNoLkNISUxELnRlc3QobWF0Y2hbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBQT1M6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIG1hdGNoLnVuc2hpZnQodHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbHRlcnM6IHsKICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlICYmIGVsZW0udHlwZSAhPT0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBjaGVja2VkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmNoZWNrZWQgPT09IHRydWU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIC8vIEFjY2Vzc2luZyB0aGlzIHByb3BlcnR5IG1ha2VzIHNlbGVjdGVkLWJ5LWRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhZWxlbS5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBlbXB0eTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWVsZW0uZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAoZWxlbSwgaSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gISFTaXp6bGUobWF0Y2hbM10sIGVsZW0pLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgaGVhZGVyOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoL2hcZC9pKS50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICB0ZXh0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSwgdHlwZSA9IGVsZW0udHlwZTsKICAgICAgICAgICAgICAgICAgICAvLyBJRTYgYW5kIDcgd2lsbCBtYXAgZWxlbS50eXBlIHRvICd0ZXh0JyBmb3IgbmV3IEhUTUw1IHR5cGVzIChzZWFyY2gsIGV0YykKICAgICAgICAgICAgICAgICAgICAvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJ0ZXh0IiA9PT0gdHlwZSAmJiAoIGF0dHIgPT09IHR5cGUgfHwgYXR0ciA9PT0gbnVsbCApOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICByYWRpbzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJyYWRpbyIgPT09IGVsZW0udHlwZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgY2hlY2tib3g6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAiY2hlY2tib3giID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGZpbGU6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAiZmlsZSIgPT09IGVsZW0udHlwZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcGFzc3dvcmQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAicGFzc3dvcmQiID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHN1Ym1pdDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmICJzdWJtaXQiID09PSBlbGVtLnR5cGU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGltYWdlOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgImltYWdlIiA9PT0gZWxlbS50eXBlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICByZXNldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmICJyZXNldCIgPT09IGVsZW0udHlwZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgYnV0dG9uOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lID09PSAiaW5wdXQiICYmICJidXR0b24iID09PSBlbGVtLnR5cGUgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGlucHV0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaSkudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGVsZW0ub3duZXJEb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRGaWx0ZXJzOiB7CiAgICAgICAgICAgICAgICBmaXJzdDogZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaSA9PT0gMDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgbGFzdDogZnVuY3Rpb24gKGVsZW0sIGksIG1hdGNoLCBhcnJheSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpID09PSBhcnJheS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBldmVuOiBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpICUgMiA9PT0gMDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgb2RkOiBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpICUgMiA9PT0gMTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgbHQ6IGZ1bmN0aW9uIChlbGVtLCBpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpIDwgbWF0Y2hbM10gLSAwOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBndDogZnVuY3Rpb24gKGVsZW0sIGksIG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkgPiBtYXRjaFszXSAtIDA7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIG50aDogZnVuY3Rpb24gKGVsZW0sIGksIG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoWzNdIC0gMCA9PT0gaTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZXE6IGZ1bmN0aW9uIChlbGVtLCBpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaFszXSAtIDAgPT09IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZpbHRlcjogewogICAgICAgICAgICAgICAgUFNFVURPOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gsIGksIGFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyID0gRXhwci5maWx0ZXJzWyBuYW1lIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcihlbGVtLCBpLCBtYXRjaCwgYXJyYXkpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICJjb250YWlucyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoWyBlbGVtIF0pIHx8ICIiKS5pbmRleE9mKG1hdGNoWzNdKSA+PSAwOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICJub3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub3QgPSBtYXRjaFszXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBsID0gbm90Lmxlbmd0aDsgaiA8IGw7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdFtqXSA9PT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5lcnJvcihuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIENISUxEOiBmdW5jdGlvbiAoZWxlbSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3QsIGxhc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmVOYW1lLCBwYXJlbnQsIGNhY2hlLAogICAgICAgICAgICAgICAgICAgICAgICBjb3VudCwgZGlmZiwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9IG1hdGNoWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gZWxlbTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm9ubHkiOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJmaXJzdCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAiZmlyc3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGVsZW07CgogICAgICAgICAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImxhc3QiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibnRoIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gbWF0Y2hbM107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lTmFtZSA9IG1hdGNoWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQgJiYgKHBhcmVudFsgZXhwYW5kbyBdICE9PSBkb25lTmFtZSB8fCAhZWxlbS5ub2RlSW5kZXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG5vZGUgPSBwYXJlbnQuZmlyc3RDaGlsZDsgbm9kZTsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubm9kZUluZGV4ID0gKytjb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50WyBleHBhbmRvIF0gPSBkb25lTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmID0gZWxlbS5ub2RlSW5kZXggLSBsYXN0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkaWZmID09PSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBJRDogZnVuY3Rpb24gKGVsZW0sIG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IG1hdGNoOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBUQUc6IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAobWF0Y2ggPT09ICIqIiAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB8fCAhIWVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBtYXRjaDsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgQ0xBU1M6IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoIiAiICsgKGVsZW0uY2xhc3NOYW1lIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSArICIgIikKICAgICAgICAgICAgICAgICAgICAgICAgLmluZGV4T2YobWF0Y2gpID4gLTE7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIEFUVFI6IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gbWF0Y2hbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNpenpsZS5hdHRyID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNpenpsZS5hdHRyKGVsZW0sIG5hbWUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeHByLmF0dHJIYW5kbGVbIG5hbWUgXShlbGVtKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbVsgbmFtZSBdICE9IG51bGwgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBuYW1lIF0gOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZXN1bHQgKyAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9IG1hdGNoWzJdLAogICAgICAgICAgICAgICAgICAgICAgICBjaGVjayA9IG1hdGNoWzRdOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0ID09IG51bGwgPwogICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSAiIT0iIDoKICAgICAgICAgICAgICAgICAgICAgICAgIXR5cGUgJiYgU2l6emxlLmF0dHIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICE9IG51bGwgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIj0iID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PT0gY2hlY2sgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICIqPSIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIn49IiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIiAiICsgdmFsdWUgKyAiICIpLmluZGV4T2YoY2hlY2spID49IDAgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIWNoZWNrID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSAmJiByZXN1bHQgIT09IGZhbHNlIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSAiIT0iID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgIT09IGNoZWNrIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gIl49IiA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5pbmRleE9mKGNoZWNrKSA9PT0gMCA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSAiJD0iID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zdWJzdHIodmFsdWUubGVuZ3RoIC0gY2hlY2subGVuZ3RoKSA9PT0gY2hlY2sgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPT09ICJ8PSIgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PT0gY2hlY2sgfHwgdmFsdWUuc3Vic3RyKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIiA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBQT1M6IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCwgaSwgYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IG1hdGNoWzJdLAogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIgPSBFeHByLnNldEZpbHRlcnNbIG5hbWUgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlsdGVyKGVsZW0sIGksIG1hdGNoLCBhcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIG9yaWdQT1MgPSBFeHByLm1hdGNoLlBPUywKICAgICAgICAgICAgZmVzY2FwZSA9IGZ1bmN0aW9uIChhbGwsIG51bSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcXCIgKyAobnVtIC0gMCArIDEpOwogICAgICAgICAgICB9OwoKICAgICAgICBmb3IgKHZhciB0eXBlIGluIEV4cHIubWF0Y2gpIHsKICAgICAgICAgICAgRXhwci5tYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cChFeHByLm1hdGNoWyB0eXBlIF0uc291cmNlICsgKC8oPyFbXlxbXSpcXSkoPyFbXlwoXSpcKSkvLnNvdXJjZSkpOwogICAgICAgICAgICBFeHByLmxlZnRNYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cCgvKF4oPzoufFxyfFxuKSo/KS8uc291cmNlICsgRXhwci5tYXRjaFsgdHlwZSBdLnNvdXJjZS5yZXBsYWNlKC9cXChcZCspL2csIGZlc2NhcGUpKTsKICAgICAgICB9Ci8vIEV4cG9zZSBvcmlnUE9TCi8vICJnbG9iYWwiIGFzIGluIHJlZ2FyZGxlc3Mgb2YgcmVsYXRpb24gdG8gYnJhY2tldHMvcGFyZW5zCiAgICAgICAgRXhwci5tYXRjaC5nbG9iYWxQT1MgPSBvcmlnUE9TOwoKICAgICAgICB2YXIgbWFrZUFycmF5ID0gZnVuY3Rpb24gKGFycmF5LCByZXN1bHRzKSB7CiAgICAgICAgICAgIGFycmF5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJyYXksIDApOwoKICAgICAgICAgICAgaWYgKHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaC5hcHBseShyZXN1bHRzLCBhcnJheSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgIH07CgovLyBQZXJmb3JtIGEgc2ltcGxlIGNoZWNrIHRvIGRldGVybWluZSBpZiB0aGUgYnJvd3NlciBpcyBjYXBhYmxlIG9mCi8vIGNvbnZlcnRpbmcgYSBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBidWlsdGluIG1ldGhvZHMuCi8vIEFsc28gdmVyaWZpZXMgdGhhdCB0aGUgcmV0dXJuZWQgYXJyYXkgaG9sZHMgRE9NIG5vZGVzCi8vICh3aGljaCBpcyBub3QgdGhlIGNhc2UgaW4gdGhlIEJsYWNrYmVycnkgYnJvd3NlcikKICAgICAgICB0cnkgewogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2hpbGROb2RlcywgMClbMF0ubm9kZVR5cGU7CgovLyBQcm92aWRlIGEgZmFsbGJhY2sgbWV0aG9kIGlmIGl0IGRvZXMgbm90IHdvcmsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIG1ha2VBcnJheSA9IGZ1bmN0aW9uIChhcnJheSwgcmVzdWx0cykgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICAgICAgICAgIHJldCA9IHJlc3VsdHMgfHwgW107CgogICAgICAgICAgICAgICAgaWYgKHRvU3RyaW5nLmNhbGwoYXJyYXkpID09PSAiW29iamVjdCBBcnJheV0iKSB7CiAgICAgICAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkocmV0LCBhcnJheSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFycmF5Lmxlbmd0aCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goYXJyYXlbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBhcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaChhcnJheVtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHZhciBzb3J0T3JkZXIsIHNpYmxpbmdDaGVjazsKCiAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICBzb3J0T3JkZXIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgNCA/IC0xIDogMTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc29ydE9yZGVyID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIC8vIFRoZSBub2RlcyBhcmUgaWRlbnRpY2FsLCB3ZSBjYW4gZXhpdCBlYXJseQogICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBoYXNEdXBsaWNhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwoKICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byB1c2luZyBzb3VyY2VJbmRleCAoaW4gSUUpIGlmIGl0J3MgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYS5zb3VyY2VJbmRleCAmJiBiLnNvdXJjZUluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBhbCwgYmwsCiAgICAgICAgICAgICAgICAgICAgYXAgPSBbXSwKICAgICAgICAgICAgICAgICAgICBicCA9IFtdLAogICAgICAgICAgICAgICAgICAgIGF1cCA9IGEucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICBidXAgPSBiLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgY3VyID0gYXVwOwoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MgKG9yIGlkZW50aWNhbCkgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKICAgICAgICAgICAgICAgIGlmIChhdXAgPT09IGJ1cCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soYSwgYik7CgogICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIHBhcmVudHMgd2VyZSBmb3VuZCB0aGVuIHRoZSBub2RlcyBhcmUgZGlzY29ubmVjdGVkCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFhdXApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYnVwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHRoZXkncmUgc29tZXdoZXJlIGVsc2UgaW4gdGhlIHRyZWUgc28gd2UgbmVlZAogICAgICAgICAgICAgICAgLy8gdG8gYnVpbGQgdXAgYSBmdWxsIGxpc3Qgb2YgdGhlIHBhcmVudE5vZGVzIGZvciBjb21wYXJpc29uCiAgICAgICAgICAgICAgICB3aGlsZSAoY3VyKSB7CiAgICAgICAgICAgICAgICAgICAgYXAudW5zaGlmdChjdXIpOwogICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1ciA9IGJ1cDsKCiAgICAgICAgICAgICAgICB3aGlsZSAoY3VyKSB7CiAgICAgICAgICAgICAgICAgICAgYnAudW5zaGlmdChjdXIpOwogICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFsID0gYXAubGVuZ3RoOwogICAgICAgICAgICAgICAgYmwgPSBicC5sZW5ndGg7CgogICAgICAgICAgICAgICAgLy8gU3RhcnQgd2Fsa2luZyBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWwgJiYgaSA8IGJsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXBbaV0gIT09IGJwW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soYXBbaV0sIGJwW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gV2UgZW5kZWQgc29tZXBsYWNlIHVwIHRoZSB0cmVlIHNvIGRvIGEgc2libGluZyBjaGVjawogICAgICAgICAgICAgICAgcmV0dXJuIGkgPT09IGFsID8KICAgICAgICAgICAgICAgICAgICBzaWJsaW5nQ2hlY2soYSwgYnBbaV0sIC0xKSA6CiAgICAgICAgICAgICAgICAgICAgc2libGluZ0NoZWNrKGFwW2ldLCBiLCAxKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNpYmxpbmdDaGVjayA9IGZ1bmN0aW9uIChhLCBiLCByZXQpIHsKICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgY3VyID0gYS5uZXh0U2libGluZzsKCiAgICAgICAgICAgICAgICB3aGlsZSAoY3VyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1ciA9PT0gYikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjdXIgPSBjdXIubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZSB3aGVuCi8vIHF1ZXJ5aW5nIGJ5IGdldEVsZW1lbnRCeUlkIChhbmQgcHJvdmlkZSBhIHdvcmthcm91bmQpCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gV2UncmUgZ29pbmcgdG8gaW5qZWN0IGEgZmFrZSBpbnB1dCBlbGVtZW50IHdpdGggYSBzcGVjaWZpZWQgbmFtZQogICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAogICAgICAgICAgICAgICAgaWQgPSAic2NyaXB0IiArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgZm9ybS5pbm5lckhUTUwgPSAiPGEgbmFtZT0nIiArIGlkICsgIicvPiI7CgogICAgICAgICAgICAvLyBJbmplY3QgaXQgaW50byB0aGUgcm9vdCBlbGVtZW50LCBjaGVjayBpdHMgc3RhdHVzLCBhbmQgcmVtb3ZlIGl0IHF1aWNrbHkKICAgICAgICAgICAgcm9vdC5pbnNlcnRCZWZvcmUoZm9ybSwgcm9vdC5maXJzdENoaWxkKTsKCiAgICAgICAgICAgIC8vIFRoZSB3b3JrYXJvdW5kIGhhcyB0byBkbyBhZGRpdGlvbmFsIGNoZWNrcyBhZnRlciBhIGdldEVsZW1lbnRCeUlkCiAgICAgICAgICAgIC8vIFdoaWNoIHNsb3dzIHRoaW5ncyBkb3duIGZvciBvdGhlciBicm93c2VycyAoaGVuY2UgdGhlIGJyYW5jaGluZykKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSkgewogICAgICAgICAgICAgICAgRXhwci5maW5kLklEID0gZnVuY3Rpb24gKG1hdGNoLCBjb250ZXh0LCBpc1hNTCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgIWlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtYXRjaFsxXSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLmlkID09PSBtYXRjaFsxXSB8fCB0eXBlb2YgbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBtLmdldEF0dHJpYnV0ZU5vZGUoImlkIikubm9kZVZhbHVlID09PSBtYXRjaFsxXSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW21dIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBFeHByLmZpbHRlci5JRCA9IGZ1bmN0aW9uIChlbGVtLCBtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gInVuZGVmaW5lZCIgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBub2RlICYmIG5vZGUubm9kZVZhbHVlID09PSBtYXRjaDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJvb3QucmVtb3ZlQ2hpbGQoZm9ybSk7CgogICAgICAgICAgICAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQogICAgICAgICAgICByb290ID0gZm9ybSA9IG51bGw7CiAgICAgICAgfSkoKTsKCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHJldHVybnMgb25seSBlbGVtZW50cwogICAgICAgICAgICAvLyB3aGVuIGRvaW5nIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikKCiAgICAgICAgICAgIC8vIENyZWF0ZSBhIGZha2UgZWxlbWVudAogICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSk7CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgbm8gY29tbWVudHMgYXJlIGZvdW5kCiAgICAgICAgICAgIGlmIChkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBFeHByLmZpbmQuVEFHID0gZnVuY3Rpb24gKG1hdGNoLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKG1hdGNoWzFdKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFsxXSA9PT0gIioiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyByZXN1bHRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzW2ldLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wLnB1c2gocmVzdWx0c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSB0bXA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBhbiBhdHRyaWJ1dGUgcmV0dXJucyBub3JtYWxpemVkIGhyZWYgYXR0cmlidXRlcwogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoKICAgICAgICAgICAgaWYgKGRpdi5maXJzdENoaWxkICYmIHR5cGVvZiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICYmCiAgICAgICAgICAgICAgICBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSAhPT0gIiMiKSB7CgogICAgICAgICAgICAgICAgRXhwci5hdHRySGFuZGxlLmhyZWYgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIsIDIpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICAgICAgZGl2ID0gbnVsbDsKICAgICAgICB9KSgpOwoKICAgICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9sZFNpenpsZSA9IFNpenpsZSwKICAgICAgICAgICAgICAgICAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgICAgICAgICAgICAgICBpZCA9ICJfX3NpenpsZV9fIjsKCiAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxwIGNsYXNzPSdURVNUJz48L3A+IjsKCiAgICAgICAgICAgICAgICAvLyBTYWZhcmkgY2FuJ3QgaGFuZGxlIHVwcGVyY2FzZSBvciB1bmljb2RlIGNoYXJhY3RlcnMgd2hlbgogICAgICAgICAgICAgICAgLy8gaW4gcXVpcmtzIG1vZGUuCiAgICAgICAgICAgICAgICBpZiAoZGl2LnF1ZXJ5U2VsZWN0b3JBbGwgJiYgZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIi5URVNUIikubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIFNpenpsZSA9IGZ1bmN0aW9uIChxdWVyeSwgY29udGV4dCwgZXh0cmEsIHNlZWQpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCiAgICAgICAgICAgICAgICAgICAgLy8gT25seSB1c2UgcXVlcnlTZWxlY3RvckFsbCBvbiBub24tWE1MIGRvY3VtZW50cwogICAgICAgICAgICAgICAgICAgIC8vIChJRCBzZWxlY3RvcnMgZG9uJ3Qgd29yayBpbiBub24tSFRNTCBkb2N1bWVudHMpCiAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWVkICYmICFTaXp6bGUuaXNYTUwoY29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VlIGlmIHdlIGZpbmQgYSBzZWxlY3RvciB0byBzcGVlZCB1cAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvXihcdyskKXxeXC4oW1x3XC1dKyQpfF4jKFtcd1wtXSskKS8uZXhlYyhxdWVyeSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgKGNvbnRleHQubm9kZVR5cGUgPT09IDEgfHwgY29udGV4dC5ub2RlVHlwZSA9PT0gOSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUFycmF5KGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUocXVlcnkpLCBleHRyYSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoIi5DTEFTUyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzJdICYmIEV4cHIuZmluZC5DTEFTUyAmJiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUFycmF5KGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtYXRjaFsyXSksIGV4dHJhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNwZWVkLXVwOiBTaXp6bGUoImJvZHkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGJvZHkgZWxlbWVudCBvbmx5IGV4aXN0cyBvbmNlLCBvcHRpbWl6ZSBmaW5kaW5nIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVlcnkgPT09ICJib2R5IiAmJiBjb250ZXh0LmJvZHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUFycmF5KFsgY29udGV4dC5ib2R5IF0sIGV4dHJhKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2ggJiYgbWF0Y2hbM10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbM10pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFIGFuZCBPcGVyYSByZXR1cm4gaXRlbXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLmlkID09PSBtYXRjaFszXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShbIGVsZW0gXSwgZXh0cmEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlQXJyYXkoW10sIGV4dHJhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUFycmF5KGNvbnRleHQucXVlcnlTZWxlY3RvckFsbChxdWVyeSksIGV4dHJhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHFzYUVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHQubm9kZVR5cGUgPT09IDEgJiYgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBjb250ZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5pZCA9IG9sZCB8fCBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNQYXJlbnQgPSBjb250ZXh0LnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmVIaWVyYXJjaHlTZWxlY3RvciA9IC9eXHMqWyt+XS8udGVzdChxdWVyeSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFvbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnNldEF0dHJpYnV0ZSgiaWQiLCBuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuaWQgPSBuaWQucmVwbGFjZSgvJy9nLCAiXFwkJiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aXZlSGllcmFyY2h5U2VsZWN0b3IgJiYgaGFzUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVsYXRpdmVIaWVyYXJjaHlTZWxlY3RvciB8fCBoYXNQYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcnJheShjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIltpZD0nIiArIG5pZCArICInXSAiICsgcXVlcnkpLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHBzZXVkb0Vycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZENvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9sZFNpenpsZShxdWVyeSwgY29udGV4dCwgZXh0cmEsIHNlZWQpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9sZFNpenpsZSkgewogICAgICAgICAgICAgICAgICAgIFNpenpsZVsgcHJvcCBdID0gb2xkU2l6emxlWyBwcm9wIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICAgICAgICAgIGRpdiA9IG51bGw7CiAgICAgICAgICAgIH0pKCk7CiAgICAgICAgfQoKICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaHRtbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBodG1sLm1hdGNoZXNTZWxlY3RvciB8fCBodG1sLm1vek1hdGNoZXNTZWxlY3RvciB8fCBodG1sLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fCBodG1sLm1zTWF0Y2hlc1NlbGVjdG9yOwoKICAgICAgICAgICAgaWYgKG1hdGNoZXMpIHsKICAgICAgICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAgICAgICAgICAgLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSBmYWlscyB0aGlzKQogICAgICAgICAgICAgICAgdmFyIGRpc2Nvbm5lY3RlZE1hdGNoID0gIW1hdGNoZXMuY2FsbChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwgImRpdiIpLAogICAgICAgICAgICAgICAgICAgIHBzZXVkb1dvcmtzID0gZmFsc2U7CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAogICAgICAgICAgICAgICAgICAgIG1hdGNoZXMuY2FsbChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsICJbdGVzdCE9JyddOnNpenpsZSIpOwoKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHBzZXVkb0Vycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgcHNldWRvV29ya3MgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIFNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiAobm9kZSwgZXhwcikgewogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAogICAgICAgICAgICAgICAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UoL1w9XHMqKFteJyJcXV0qKVxzKlxdL2csICI9JyQxJ10iKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFTaXp6bGUuaXNYTUwobm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwc2V1ZG9Xb3JrcyB8fCAhRXhwci5tYXRjaC5QU0VVRE8udGVzdChleHByKSAmJiAhLyE9Ly50ZXN0KGV4cHIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IG1hdGNoZXMuY2FsbChub2RlLCBleHByKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQgfHwgIWRpc2Nvbm5lY3RlZE1hdGNoIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZyYWdtZW50IGluIElFIDksIHNvIGNoZWNrIGZvciB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZG9jdW1lbnQgJiYgbm9kZS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNpenpsZShleHByLCBudWxsLCBudWxsLCBbbm9kZV0pLmxlbmd0aCA+IDA7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfSkoKTsKCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSd0ZXN0IGUnPjwvZGl2PjxkaXYgY2xhc3M9J3Rlc3QnPjwvZGl2PiI7CgogICAgICAgICAgICAvLyBPcGVyYSBjYW4ndCBmaW5kIGEgc2Vjb25kIGNsYXNzbmFtZSAoaW4gOS42KQogICAgICAgICAgICAvLyBBbHNvLCBtYWtlIHN1cmUgdGhhdCBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGFjdHVhbGx5IGV4aXN0cwogICAgICAgICAgICBpZiAoIWRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNhZmFyaSBjYWNoZXMgY2xhc3MgYXR0cmlidXRlcywgZG9lc24ndCBjYXRjaCBjaGFuZ2VzIChpbiAzLjIpCiAgICAgICAgICAgIGRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwoKICAgICAgICAgICAgaWYgKGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEV4cHIub3JkZXIuc3BsaWNlKDEsIDAsICJDTEFTUyIpOwogICAgICAgICAgICBFeHByLmZpbmQuQ0xBU1MgPSBmdW5jdGlvbiAobWF0Y2gsIGNvbnRleHQsIGlzWE1MKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgIWlzWE1MKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQogICAgICAgICAgICBkaXYgPSBudWxsOwogICAgICAgIH0pKCk7CgogICAgICAgIGZ1bmN0aW9uIGRpck5vZGVDaGVjayhkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IGNoZWNrU2V0W2ldOwoKICAgICAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtW2Rpcl07CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtWyBleHBhbmRvIF0gPT09IGRvbmVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IGNoZWNrU2V0W2VsZW0uc2l6c2V0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1bIGV4cGFuZG8gXSA9IGRvbmVOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5zaXpzZXQgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBjdXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gZWxlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbVtkaXJdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2hlY2tTZXRbaV0gPSBtYXRjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGlyQ2hlY2soZGlyLCBjdXIsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBjaGVja1NldFtpXTsKCiAgICAgICAgICAgICAgICBpZiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICBlbGVtID0gZWxlbVtkaXJdOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbVsgZXhwYW5kbyBdID09PSBkb25lTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBleHBhbmRvIF0gPSBkb25lTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnNpenNldCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXIgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0gPT09IGN1cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFNpenpsZS5maWx0ZXIoY3VyLCBbZWxlbV0pLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IGVsZW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtW2Rpcl07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjaGVja1NldFtpXSA9IG1hdGNoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNvbnRhaW5zKSB7CiAgICAgICAgICAgIFNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYSAhPT0gYiAmJiAoYS5jb250YWlucyA/IGEuY29udGFpbnMoYikgOiB0cnVlKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhIShhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgMTYpOwogICAgICAgICAgICB9OwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CiAgICAgICAgICAgIC8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQogICAgICAgICAgICB2YXIgZG9jdW1lbnRFbGVtZW50ID0gKGVsZW0gPyBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSA6IDApLmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHZhciBwb3NQcm9jZXNzID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBzZWVkKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCwKICAgICAgICAgICAgICAgIHRtcFNldCA9IFtdLAogICAgICAgICAgICAgICAgbGF0ZXIgPSAiIiwKICAgICAgICAgICAgICAgIHJvb3QgPSBjb250ZXh0Lm5vZGVUeXBlID8gW2NvbnRleHRdIDogY29udGV4dDsKCiAgICAgICAgICAgIC8vIFBvc2l0aW9uIHNlbGVjdG9ycyBtdXN0IGJlIGRvbmUgYWZ0ZXIgdGhlIGZpbHRlcgogICAgICAgICAgICAvLyBBbmQgc28gbXVzdCA6bm90KHBvc2l0aW9uYWwpIHNvIHdlIG1vdmUgYWxsIFBTRVVET3MgdG8gdGhlIGVuZAogICAgICAgICAgICB3aGlsZSAoKG1hdGNoID0gRXhwci5tYXRjaC5QU0VVRE8uZXhlYyhzZWxlY3RvcikpKSB7CiAgICAgICAgICAgICAgICBsYXRlciArPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZShFeHByLm1hdGNoLlBTRVVETywgIiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZWxlY3RvciA9IEV4cHIucmVsYXRpdmVbc2VsZWN0b3JdID8gc2VsZWN0b3IgKyAiKiIgOiBzZWxlY3RvcjsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcm9vdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIFNpenpsZShzZWxlY3Rvciwgcm9vdFtpXSwgdG1wU2V0LCBzZWVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFNpenpsZS5maWx0ZXIobGF0ZXIsIHRtcFNldCk7CiAgICAgICAgfTsKCi8vIEVYUE9TRQovLyBPdmVycmlkZSBzaXp6bGUgYXR0cmlidXRlIHJldHJpZXZhbAogICAgICAgIFNpenpsZS5hdHRyID0galF1ZXJ5LmF0dHI7CiAgICAgICAgU2l6emxlLnNlbGVjdG9ycy5hdHRyTWFwID0ge307CiAgICAgICAgalF1ZXJ5LmZpbmQgPSBTaXp6bGU7CiAgICAgICAgalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwogICAgICAgIGpRdWVyeS5leHByWyI6Il0gPSBqUXVlcnkuZXhwci5maWx0ZXJzOwogICAgICAgIGpRdWVyeS51bmlxdWUgPSBTaXp6bGUudW5pcXVlU29ydDsKICAgICAgICBqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwogICAgICAgIGpRdWVyeS5pc1hNTERvYyA9IFNpenpsZS5pc1hNTDsKICAgICAgICBqUXVlcnkuY29udGFpbnMgPSBTaXp6bGUuY29udGFpbnM7CgoKICAgIH0pKCk7CgoKICAgIHZhciBydW50aWwgPSAvVW50aWwkLywKICAgICAgICBycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldlVudGlsfHByZXZBbGwpLywKICAgIC8vIE5vdGU6IFRoaXMgUmVnRXhwIHNob3VsZCBiZSBpbXByb3ZlZCwgb3IgbGlrZWx5IHB1bGxlZCBmcm9tIFNpenpsZQogICAgICAgIHJtdWx0aXNlbGVjdG9yID0gLywvLAogICAgICAgIGlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywKICAgICAgICBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKICAgICAgICBQT1MgPSBqUXVlcnkuZXhwci5tYXRjaC5nbG9iYWxQT1MsCiAgICAvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogICAgICAgIGd1YXJhbnRlZWRVbmlxdWUgPSB7CiAgICAgICAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICAgICAgICBjb250ZW50czogdHJ1ZSwKICAgICAgICAgICAgbmV4dDogdHJ1ZSwKICAgICAgICAgICAgcHJldjogdHJ1ZQogICAgICAgIH07CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgZmluZDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgIGksIGw7CgogICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeShzZWxlY3RvcikuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gc2VsZi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyhzZWxmWyBpIF0sIHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5wdXNoU3RhY2soIiIsICJmaW5kIiwgc2VsZWN0b3IpLAogICAgICAgICAgICAgICAgbGVuZ3RoLCBuLCByOwoKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggPSByZXQubGVuZ3RoOwogICAgICAgICAgICAgICAgalF1ZXJ5LmZpbmQoc2VsZWN0b3IsIHRoaXNbaV0sIHJldCk7CgogICAgICAgICAgICAgICAgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIHJlc3VsdHMgYXJlIHVuaXF1ZQogICAgICAgICAgICAgICAgICAgIGZvciAobiA9IGxlbmd0aDsgbiA8IHJldC5sZW5ndGg7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHIgPSAwOyByIDwgbGVuZ3RoOyByKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXRbcl0gPT09IHJldFtuXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldC5zcGxpY2Uobi0tLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICBoYXM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgICAgICAgdmFyIHRhcmdldHMgPSBqUXVlcnkodGFyZ2V0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGFyZ2V0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmNvbnRhaW5zKHRoaXMsIHRhcmdldHNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciwgZmFsc2UpLCAibm90Iiwgc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IsIHRydWUpLCAiZmlsdGVyIiwgc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIGlzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuICEhc2VsZWN0b3IgJiYgKAogICAgICAgICAgICAgICAgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiA/CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyBhIHBvc2l0aW9uYWwgc2VsZWN0b3IsIGNoZWNrIG1lbWJlcnNoaXAgaW4gdGhlIHJldHVybmVkIHNldAogICAgICAgICAgICAgICAgICAgIC8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KICAgICAgICAgICAgICAgICAgICBQT1MudGVzdChzZWxlY3RvcikgPwogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoc2VsZWN0b3IsIHRoaXMuY29udGV4dCkuaW5kZXgodGhpc1swXSkgPj0gMCA6CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIHRoaXMpLmxlbmd0aCA+IDAgOgogICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyKHNlbGVjdG9yKS5sZW5ndGggPiAwICk7CiAgICAgICAgfSwKCiAgICAgICAgY2xvc2VzdDogZnVuY3Rpb24gKHNlbGVjdG9ycywgY29udGV4dCkgewogICAgICAgICAgICB2YXIgcmV0ID0gW10sIGksIGwsIGN1ciA9IHRoaXNbMF07CgogICAgICAgICAgICAvLyBBcnJheSAoZGVwcmVjYXRlZCBhcyBvZiBqUXVlcnkgMS43KQogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkoc2VsZWN0b3JzKSkgewogICAgICAgICAgICAgICAgdmFyIGxldmVsID0gMTsKCiAgICAgICAgICAgICAgICB3aGlsZSAoY3VyICYmIGN1ci5vd25lckRvY3VtZW50ICYmIGN1ciAhPT0gY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWxlY3RvcnMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkoY3VyKS5pcyhzZWxlY3RvcnNbIGkgXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKHsgc2VsZWN0b3I6IHNlbGVjdG9yc1sgaSBdLCBlbGVtOiBjdXIsIGxldmVsOiBsZXZlbCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY3VyID0gY3VyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgbGV2ZWwrKzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdHJpbmcKICAgICAgICAgICAgdmFyIHBvcyA9IFBPUy50ZXN0KHNlbGVjdG9ycykgfHwgdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgPwogICAgICAgICAgICAgICAgalF1ZXJ5KHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQpIDoKICAgICAgICAgICAgICAgIDA7CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGN1ciA9IHRoaXNbaV07CgogICAgICAgICAgICAgICAgd2hpbGUgKGN1cikgewogICAgICAgICAgICAgICAgICAgIGlmIChwb3MgPyBwb3MuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaChjdXIpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VyID0gY3VyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY3VyIHx8ICFjdXIub3duZXJEb2N1bWVudCB8fCBjdXIgPT09IGNvbnRleHQgfHwgY3VyLm5vZGVUeXBlID09PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IHJldC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZShyZXQpIDogcmV0OwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHJldCwgImNsb3Nlc3QiLCBzZWxlY3RvcnMpOwogICAgICAgIH0sCgogICAgICAgIC8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KICAgICAgICAvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKICAgICAgICBpbmRleDogZnVuY3Rpb24gKGVsZW0pIHsKCiAgICAgICAgICAgIC8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CiAgICAgICAgICAgIGlmICghZWxlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSA/IHRoaXMucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpbmRleCBpbiBzZWxlY3RvcgogICAgICAgICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LmluQXJyYXkodGhpc1swXSwgalF1ZXJ5KGVsZW0pKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuaW5BcnJheSgKICAgICAgICAgICAgICAgIC8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAogICAgICAgICAgICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSwgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHNldCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPwogICAgICAgICAgICAgICAgICAgIGpRdWVyeShzZWxlY3RvciwgY29udGV4dCkgOgogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5tYWtlQXJyYXkoc2VsZWN0b3IgJiYgc2VsZWN0b3Iubm9kZVR5cGUgPyBbIHNlbGVjdG9yIF0gOiBzZWxlY3RvciksCiAgICAgICAgICAgICAgICBhbGwgPSBqUXVlcnkubWVyZ2UodGhpcy5nZXQoKSwgc2V0KTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhpc0Rpc2Nvbm5lY3RlZChzZXRbMF0pIHx8IGlzRGlzY29ubmVjdGVkKGFsbFswXSkgPwogICAgICAgICAgICAgICAgYWxsIDoKICAgICAgICAgICAgICAgIGpRdWVyeS51bmlxdWUoYWxsKSk7CiAgICAgICAgfSwKCiAgICAgICAgYW5kU2VsZjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGQodGhpcy5wcmV2T2JqZWN0KTsKICAgICAgICB9CiAgICB9KTsKCi8vIEEgcGFpbmZ1bGx5IHNpbXBsZSBjaGVjayB0byBzZWUgaWYgYW4gZWxlbWVudCBpcyBkaXNjb25uZWN0ZWQKLy8gZnJvbSBhIGRvY3VtZW50IChzaG91bGQgYmUgaW1wcm92ZWQsIHdoZXJlIGZlYXNpYmxlKS4KICAgIGZ1bmN0aW9uIGlzRGlzY29ubmVjdGVkKG5vZGUpIHsKICAgICAgICByZXR1cm4gIW5vZGUgfHwgIW5vZGUucGFyZW50Tm9kZSB8fCBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExOwogICAgfQoKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICAgICAgfSwKICAgICAgICBwYXJlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAicGFyZW50Tm9kZSIpOwogICAgICAgIH0sCiAgICAgICAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCk7CiAgICAgICAgfSwKICAgICAgICBuZXh0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm50aChlbGVtLCAyLCAibmV4dFNpYmxpbmciKTsKICAgICAgICB9LAogICAgICAgIHByZXY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkubnRoKGVsZW0sIDIsICJwcmV2aW91c1NpYmxpbmciKTsKICAgICAgICB9LAogICAgICAgIG5leHRBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgICAgIH0sCiAgICAgICAgcHJldkFsbDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgInByZXZpb3VzU2libGluZyIpOwogICAgICAgIH0sCiAgICAgICAgbmV4dFVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgIm5leHRTaWJsaW5nIiwgdW50aWwpOwogICAgICAgIH0sCiAgICAgICAgcHJldlVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsKTsKICAgICAgICB9LAogICAgICAgIHNpYmxpbmdzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtKTsKICAgICAgICB9LAogICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoZWxlbS5maXJzdENoaWxkKTsKICAgICAgICB9LAogICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJpZnJhbWUiKSA/CiAgICAgICAgICAgICAgICBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOgogICAgICAgICAgICAgICAgalF1ZXJ5Lm1ha2VBcnJheShlbGVtLmNoaWxkTm9kZXMpOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChuYW1lLCBmbikgewogICAgICAgIGpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24gKHVudGlsLCBzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgcmV0ID0galF1ZXJ5Lm1hcCh0aGlzLCBmbiwgdW50aWwpOwoKICAgICAgICAgICAgaWYgKCFydW50aWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgc2VsZWN0b3IgPSB1bnRpbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldCA9IGpRdWVyeS5maWx0ZXIoc2VsZWN0b3IsIHJldCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IHRoaXMubGVuZ3RoID4gMSAmJiAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdID8galF1ZXJ5LnVuaXF1ZShyZXQpIDogcmV0OwoKICAgICAgICAgICAgaWYgKCh0aGlzLmxlbmd0aCA+IDEgfHwgcm11bHRpc2VsZWN0b3IudGVzdChzZWxlY3RvcikpICYmIHJwYXJlbnRzcHJldi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXQgPSByZXQucmV2ZXJzZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socmV0LCBuYW1lLCBzbGljZS5jYWxsKGFyZ3VtZW50cykuam9pbigiLCIpKTsKICAgICAgICB9OwogICAgfSk7CgogICAgalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoZXhwciwgZWxlbXMsIG5vdCkgewogICAgICAgICAgICBpZiAobm90KSB7CiAgICAgICAgICAgICAgICBleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgPwogICAgICAgICAgICAgICAgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW1zWzBdLCBleHByKSA/IFsgZWxlbXNbMF0gXSA6IFtdIDoKICAgICAgICAgICAgICAgIGpRdWVyeS5maW5kLm1hdGNoZXMoZXhwciwgZWxlbXMpOwogICAgICAgIH0sCgogICAgICAgIGRpcjogZnVuY3Rpb24gKGVsZW0sIGRpciwgdW50aWwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoZWQgPSBbXSwKICAgICAgICAgICAgICAgIGN1ciA9IGVsZW1bIGRpciBdOwoKICAgICAgICAgICAgd2hpbGUgKGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDkgJiYgKHVudGlsID09PSB1bmRlZmluZWQgfHwgY3VyLm5vZGVUeXBlICE9PSAxIHx8ICFqUXVlcnkoY3VyKS5pcyh1bnRpbCkpKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGN1cik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXIgPSBjdXJbZGlyXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF0Y2hlZDsKICAgICAgICB9LAoKICAgICAgICBudGg6IGZ1bmN0aW9uIChjdXIsIHJlc3VsdCwgZGlyLCBlbGVtKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdCB8fCAxOwogICAgICAgICAgICB2YXIgbnVtID0gMDsKCiAgICAgICAgICAgIGZvciAoOyBjdXI7IGN1ciA9IGN1cltkaXJdKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlID09PSAxICYmICsrbnVtID09PSByZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGN1cjsKICAgICAgICB9LAoKICAgICAgICBzaWJsaW5nOiBmdW5jdGlvbiAobiwgZWxlbSkgewogICAgICAgICAgICB2YXIgciA9IFtdOwoKICAgICAgICAgICAgZm9yICg7IG47IG4gPSBuLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAobi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgci5wdXNoKG4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9CiAgICB9KTsKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CiAgICBmdW5jdGlvbiB3aW5ub3coZWxlbWVudHMsIHF1YWxpZmllciwga2VlcCkgewoKICAgICAgICAvLyBDYW4ndCBwYXNzIG51bGwgb3IgdW5kZWZpbmVkIHRvIGluZGV4T2YgaW4gRmlyZWZveCA0CiAgICAgICAgLy8gU2V0IHRvIDAgdG8gc2tpcCBzdHJpbmcgY2hlY2sKICAgICAgICBxdWFsaWZpZXIgPSBxdWFsaWZpZXIgfHwgMDsKCiAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHF1YWxpZmllcikpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgICAgICAgICAgdmFyIHJldFZhbCA9ICEhcXVhbGlmaWVyLmNhbGwoZWxlbSwgaSwgZWxlbSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0VmFsID09PSBrZWVwOwogICAgICAgICAgICB9KTsKCiAgICAgICAgfSBlbHNlIGlmIChxdWFsaWZpZXIubm9kZVR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgPT09IGtlZXA7CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBxdWFsaWZpZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGlzU2ltcGxlLnRlc3QocXVhbGlmaWVyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBmaWx0ZXJlZCwgIWtlZXApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcXVhbGlmaWVyID0galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGZpbHRlcmVkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgICAgICByZXR1cm4gKCBqUXVlcnkuaW5BcnJheShlbGVtLCBxdWFsaWZpZXIpID49IDAgKSA9PT0ga2VlcDsKICAgICAgICB9KTsKICAgIH0KCgogICAgZnVuY3Rpb24gY3JlYXRlU2FmZUZyYWdtZW50KGRvY3VtZW50KSB7CiAgICAgICAgdmFyIGxpc3QgPSBub2RlTmFtZXMuc3BsaXQoInwiKSwKICAgICAgICAgICAgc2FmZUZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgogICAgICAgIGlmIChzYWZlRnJhZy5jcmVhdGVFbGVtZW50KSB7CiAgICAgICAgICAgIHdoaWxlIChsaXN0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgc2FmZUZyYWcuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgICAgICBsaXN0LnBvcCgpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzYWZlRnJhZzsKICAgIH0KCiAgICB2YXIgbm9kZU5hbWVzID0gImFiYnJ8YXJ0aWNsZXxhc2lkZXxhdWRpb3xiZGl8Y2FudmFzfGRhdGF8ZGF0YWxpc3R8ZGV0YWlsc3xmaWdjYXB0aW9ufGZpZ3VyZXxmb290ZXJ8IiArCiAgICAgICAgICAgICJoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCiAgICAgICAgcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpcZCt8bnVsbCkiL2csCiAgICAgICAgcmxlYWRpbmdXaGl0ZXNwYWNlID0gL15ccysvLAogICAgICAgIHJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vaWcsCiAgICAgICAgcnRhZ05hbWUgPSAvPChbXHc6XSspLywKICAgICAgICBydGJvZHkgPSAvPHRib2R5L2ksCiAgICAgICAgcmh0bWwgPSAvPHwmIz9cdys7LywKICAgICAgICBybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZSkvaSwKICAgICAgICBybm9jYWNoZSA9IC88KD86c2NyaXB0fG9iamVjdHxlbWJlZHxvcHRpb258c3R5bGUpL2ksCiAgICAgICAgcm5vc2hpbWNhY2hlID0gbmV3IFJlZ0V4cCgiPCg/OiIgKyBub2RlTmFtZXMgKyAiKVtcXHMvPl0iLCAiaSIpLAogICAgLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAogICAgICAgIHJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCiAgICAgICAgcnNjcmlwdFR5cGUgPSAvXC8oamF2YXxlY21hKXNjcmlwdC9pLAogICAgICAgIHJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8XC1cLSkvLAogICAgICAgIHdyYXBNYXAgPSB7CiAgICAgICAgICAgIG9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCiAgICAgICAgICAgIGxlZ2VuZDogWyAxLCAiPGZpZWxkc2V0PiIsICI8L2ZpZWxkc2V0PiIgXSwKICAgICAgICAgICAgdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCiAgICAgICAgICAgIHRyOiBbIDIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+IiBdLAogICAgICAgICAgICB0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKICAgICAgICAgICAgY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAogICAgICAgICAgICBhcmVhOiBbIDEsICI8bWFwPiIsICI8L21hcD4iIF0sCiAgICAgICAgICAgIF9kZWZhdWx0OiBbIDAsICIiLCAiIiBdCiAgICAgICAgfSwKICAgICAgICBzYWZlRnJhZ21lbnQgPSBjcmVhdGVTYWZlRnJhZ21lbnQoZG9jdW1lbnQpOwoKICAgIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKICAgIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCi8vIElFIGNhbid0IHNlcmlhbGl6ZSA8bGluaz4gYW5kIDxzY3JpcHQ+IHRhZ3Mgbm9ybWFsbHkKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuaHRtbFNlcmlhbGl6ZSkgewogICAgICAgIHdyYXBNYXAuX2RlZmF1bHQgPSBbIDEsICJkaXY8ZGl2PiIsICI8L2Rpdj4iIF07CiAgICB9CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgdGV4dDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwogICAgICAgICAgICAgICAgICAgIGpRdWVyeS50ZXh0KHRoaXMpIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKCggdGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKS5jcmVhdGVUZXh0Tm9kZSh2YWx1ZSkpOwogICAgICAgICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICAgICAgfSwKCiAgICAgICAgd3JhcEFsbDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaHRtbC5jYWxsKHRoaXMsIGkpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpc1swXSkgewogICAgICAgICAgICAgICAgLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKICAgICAgICAgICAgICAgIHZhciB3cmFwID0galF1ZXJ5KGh0bWwsIHRoaXNbMF0ub3duZXJEb2N1bWVudCkuZXEoMCkuY2xvbmUodHJ1ZSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdyYXAubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChlbGVtLmZpcnN0Q2hpbGQgJiYgZWxlbS5maXJzdENoaWxkLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbTsKICAgICAgICAgICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgd3JhcElubmVyOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oaHRtbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykud3JhcElubmVyKGh0bWwuY2FsbCh0aGlzLCBpKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCiAgICAgICAgICAgICAgICBpZiAoY29udGVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNlbGYuYXBwZW5kKGh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICB3cmFwOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICAgICAgICB2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICB1bndyYXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5ub2RlTmFtZSh0aGlzLCAiYm9keSIpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlcGxhY2VXaXRoKHRoaXMuY2hpbGROb2Rlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLmVuZCgpOwogICAgICAgIH0sCgogICAgICAgIGFwcGVuZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQoZWxlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCB0cnVlLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydEJlZm9yZShlbGVtLCB0aGlzLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBiZWZvcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgc2V0ID0galF1ZXJ5LmNsZWFuKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBzZXQucHVzaC5hcHBseShzZXQsIHRoaXMudG9BcnJheSgpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhzZXQsICJiZWZvcmUiLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgc2V0ID0gdGhpcy5wdXNoU3RhY2sodGhpcywgImFmdGVyIiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHNldC5wdXNoLmFwcGx5KHNldCwgalF1ZXJ5LmNsZWFuKGFyZ3VtZW50cykpOwogICAgICAgICAgICAgICAgcmV0dXJuIHNldDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGtlZXBEYXRhIGlzIGZvciBpbnRlcm5hbCB1c2Ugb25seS0tZG8gbm90IGRvY3VtZW50CiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGtlZXBEYXRhKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvciB8fCBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCBbIGVsZW0gXSkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwRGF0YSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShbIGVsZW0gXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwogICAgICAgICAgICAgICAgd2hpbGUgKGVsZW0uZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQ2hpbGQoZWxlbS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uIChkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICAgICAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgICAgICAgICBkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5jbG9uZSh0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGh0bWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtID0gdGhpc1swXSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgICAgICBsID0gdGhpcy5sZW5ndGg7CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uaW5uZXJIVE1MLnJlcGxhY2UocmlubGluZWpRdWVyeSwgIiIpIDoKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KHZhbHVlKSAmJgogICAgICAgICAgICAgICAgICAgICggalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgfHwgIXJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KHZhbHVlKSApICYmICF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWModmFsdWUpIHx8IFsiIiwgIiJdIClbMV0udG9Mb3dlckNhc2UoKSBdKSB7CgogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShyeGh0bWxUYWcsICI8JDE+PC8kMj4iKTsKCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgICAgIH0sCgogICAgICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgZWxlbWVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NIGJlZm9yZSB0aGV5IGFyZSBpbnNlcnRlZAogICAgICAgICAgICAgICAgLy8gdGhpcyBjYW4gaGVscCBmaXggcmVwbGFjaW5nIGEgcGFyZW50IHdpdGggY2hpbGQgZWxlbWVudHMKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpLCBvbGQgPSBzZWxmLmh0bWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZXBsYWNlV2l0aCh2YWx1ZS5jYWxsKHRoaXMsIGksIG9sZCkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqUXVlcnkodmFsdWUpLmRldGFjaCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gdGhpcy5uZXh0U2libGluZywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlOwoKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykucmVtb3ZlKCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShuZXh0KS5iZWZvcmUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShwYXJlbnQpLmFwcGVuZCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGggPwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVzaFN0YWNrKGpRdWVyeShqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogdmFsdWUpLCAicmVwbGFjZVdpdGgiLCB2YWx1ZSkgOgogICAgICAgICAgICAgICAgICAgIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBkZXRhY2g6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmUoc2VsZWN0b3IsIHRydWUpOwogICAgICAgIH0sCgogICAgICAgIGRvbU1hbmlwOiBmdW5jdGlvbiAoYXJncywgdGFibGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciByZXN1bHRzLCBmaXJzdCwgZnJhZ21lbnQsIHBhcmVudCwKICAgICAgICAgICAgICAgIHZhbHVlID0gYXJnc1swXSwKICAgICAgICAgICAgICAgIHNjcmlwdHMgPSBbXTsKCiAgICAgICAgICAgIC8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdAogICAgICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LmNoZWNrQ2xvbmUgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMyAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHJjaGVja2VkLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykuZG9tTWFuaXAoYXJncywgdGFibGUsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgYXJnc1swXSA9IHZhbHVlLmNhbGwodGhpcywgaSwgdGFibGUgPyBzZWxmLmh0bWwoKSA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kb21NYW5pcChhcmdzLCB0YWJsZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgICAgICAgICBwYXJlbnQgPSB2YWx1ZSAmJiB2YWx1ZS5wYXJlbnROb2RlOwoKICAgICAgICAgICAgICAgIC8vIElmIHdlJ3JlIGluIGEgZnJhZ21lbnQsIGp1c3QgdXNlIHRoYXQgaW5zdGVhZCBvZiBidWlsZGluZyBhIG5ldyBvbmUKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuc3VwcG9ydC5wYXJlbnROb2RlICYmIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDExICYmIHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gdGhpcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0geyBmcmFnbWVudDogcGFyZW50IH07CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoYXJncywgdGhpcywgc2NyaXB0cyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnJhZ21lbnQgPSByZXN1bHRzLmZyYWdtZW50OwoKICAgICAgICAgICAgICAgIGlmIChmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gZnJhZ21lbnQgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGZpcnN0KSB7CiAgICAgICAgICAgICAgICAgICAgdGFibGUgPSB0YWJsZSAmJiBqUXVlcnkubm9kZU5hbWUoZmlyc3QsICJ0ciIpOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoLCBsYXN0SW5kZXggPSBsIC0gMTsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGUgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QodGhpc1tpXSwgZmlyc3QpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UgZG8gbm90IGxlYWsgbWVtb3J5IGJ5IGluYWR2ZXJ0ZW50bHkgZGlzY2FyZGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIG9yaWdpbmFsIGZyYWdtZW50ICh3aGljaCBtaWdodCBoYXZlIGF0dGFjaGVkIGRhdGEpIGluc3RlYWQgb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzaW5nIGl0OyBpbiBhZGRpdGlvbiwgdXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBvYmplY3QgZm9yIHRoZSBsYXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVtIGluc3RlYWQgb2YgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoQnVnICM4MDcwKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZyYWdtZW50cyBmcm9tIHRoZSBmcmFnbWVudCBjYWNoZSBtdXN0IGFsd2F5cyBiZSBjbG9uZWQgYW5kIG5ldmVyIHVzZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHBsYWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jYWNoZWFibGUgfHwgKCBsID4gMSAmJiBpIDwgbGFzdEluZGV4ICkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jbG9uZShmcmFnbWVudCwgdHJ1ZSwgdHJ1ZSkgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzY3JpcHRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHNjcmlwdHMsIGZ1bmN0aW9uIChpLCBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtLnNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBlbGVtLnNyYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJzY3JpcHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKCggZWxlbS50ZXh0IHx8IGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lckhUTUwgfHwgIiIgKS5yZXBsYWNlKHJjbGVhblNjcmlwdCwgIi8qJDAqLyIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHJvb3QoZWxlbSwgY3VyKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAidGFibGUiKSA/CiAgICAgICAgICAgIChlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8CiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpKSkgOgogICAgICAgICAgICBlbGVtOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KHNyYywgZGVzdCkgewoKICAgICAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5Lmhhc0RhdGEoc3JjKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdHlwZSwgaSwgbCwKICAgICAgICAgICAgb2xkRGF0YSA9IGpRdWVyeS5fZGF0YShzcmMpLAogICAgICAgICAgICBjdXJEYXRhID0galF1ZXJ5Ll9kYXRhKGRlc3QsIG9sZERhdGEpLAogICAgICAgICAgICBldmVudHMgPSBvbGREYXRhLmV2ZW50czsKCiAgICAgICAgaWYgKGV2ZW50cykgewogICAgICAgICAgICBkZWxldGUgY3VyRGF0YS5oYW5kbGU7CiAgICAgICAgICAgIGN1ckRhdGEuZXZlbnRzID0ge307CgogICAgICAgICAgICBmb3IgKHR5cGUgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAgICBpZiAoY3VyRGF0YS5kYXRhKSB7CiAgICAgICAgICAgIGN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoe30sIGN1ckRhdGEuZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNsb25lRml4QXR0cmlidXRlcyhzcmMsIGRlc3QpIHsKICAgICAgICB2YXIgbm9kZU5hbWU7CgogICAgICAgIC8vIFdlIGRvIG5vdCBuZWVkIHRvIGRvIGFueXRoaW5nIGZvciBub24tRWxlbWVudHMKICAgICAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBjbGVhckF0dHJpYnV0ZXMgcmVtb3ZlcyB0aGUgYXR0cmlidXRlcywgd2hpY2ggd2UgZG9uJ3Qgd2FudCwKICAgICAgICAvLyBidXQgYWxzbyByZW1vdmVzIHRoZSBhdHRhY2hFdmVudCBldmVudHMsIHdoaWNoIHdlICpkbyogd2FudAogICAgICAgIGlmIChkZXN0LmNsZWFyQXR0cmlidXRlcykgewogICAgICAgICAgICBkZXN0LmNsZWFyQXR0cmlidXRlcygpOwogICAgICAgIH0KCiAgICAgICAgLy8gbWVyZ2VBdHRyaWJ1dGVzLCBpbiBjb250cmFzdCwgb25seSBtZXJnZXMgYmFjayBvbiB0aGUKICAgICAgICAvLyBvcmlnaW5hbCBhdHRyaWJ1dGVzLCBub3QgdGhlIGV2ZW50cwogICAgICAgIGlmIChkZXN0Lm1lcmdlQXR0cmlidXRlcykgewogICAgICAgICAgICBkZXN0Lm1lcmdlQXR0cmlidXRlcyhzcmMpOwogICAgICAgIH0KCiAgICAgICAgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIC8vIElFNi04IGZhaWwgdG8gY2xvbmUgY2hpbGRyZW4gaW5zaWRlIG9iamVjdCBlbGVtZW50cyB0aGF0IHVzZQogICAgICAgIC8vIHRoZSBwcm9wcmlldGFyeSBjbGFzc2lkIGF0dHJpYnV0ZSB2YWx1ZSAocmF0aGVyIHRoYW4gdGhlIHR5cGUKICAgICAgICAvLyBhdHRyaWJ1dGUpIHRvIGlkZW50aWZ5IHRoZSB0eXBlIG9mIGNvbnRlbnQgdG8gZGlzcGxheQogICAgICAgIGlmIChub2RlTmFtZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZGVzdC5vdXRlckhUTUwgPSBzcmMub3V0ZXJIVE1MOwoKICAgICAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIChzcmMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBzcmMudHlwZSA9PT0gInJhZGlvIikpIHsKICAgICAgICAgICAgLy8gSUU2LTggZmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveAogICAgICAgICAgICAvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CiAgICAgICAgICAgIC8vIGEgY2hlY2tlZCBhcHBlYXJhbmNlIGlmIHRoZSBkZWZhdWx0Q2hlY2tlZCB2YWx1ZSBpc24ndCBhbHNvIHNldAogICAgICAgICAgICBpZiAoc3JjLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIGRlc3QuZGVmYXVsdENoZWNrZWQgPSBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKICAgICAgICAgICAgLy8gY2hlY2tib3gvcmFkaW8gYnV0dG9uIHRvIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mICJvbiIKICAgICAgICAgICAgaWYgKGRlc3QudmFsdWUgIT09IHNyYy52YWx1ZSkgewogICAgICAgICAgICAgICAgZGVzdC52YWx1ZSA9IHNyYy52YWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU2LTggZmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQKICAgICAgICAgICAgLy8gc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKICAgICAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAib3B0aW9uIikgewogICAgICAgICAgICBkZXN0LnNlbGVjdGVkID0gc3JjLmRlZmF1bHRTZWxlY3RlZDsKCiAgICAgICAgICAgIC8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4KICAgICAgICAgICAgLy8gY2xvbmluZyBvdGhlciB0eXBlcyBvZiBpbnB1dCBmaWVsZHMKICAgICAgICB9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiKSB7CiAgICAgICAgICAgIGRlc3QuZGVmYXVsdFZhbHVlID0gc3JjLmRlZmF1bHRWYWx1ZTsKCiAgICAgICAgICAgIC8vIElFIGJsYW5rcyBjb250ZW50cyB3aGVuIGNsb25pbmcgc2NyaXB0cwogICAgICAgIH0gZWxzZSBpZiAobm9kZU5hbWUgPT09ICJzY3JpcHQiICYmIGRlc3QudGV4dCAhPT0gc3JjLnRleHQpIHsKICAgICAgICAgICAgZGVzdC50ZXh0ID0gc3JjLnRleHQ7CiAgICAgICAgfQoKICAgICAgICAvLyBFdmVudCBkYXRhIGdldHMgcmVmZXJlbmNlZCBpbnN0ZWFkIG9mIGNvcGllZCBpZiB0aGUgZXhwYW5kbwogICAgICAgIC8vIGdldHMgY29waWVkIHRvbwogICAgICAgIGRlc3QucmVtb3ZlQXR0cmlidXRlKGpRdWVyeS5leHBhbmRvKTsKCiAgICAgICAgLy8gQ2xlYXIgZmxhZ3MgZm9yIGJ1YmJsaW5nIHNwZWNpYWwgY2hhbmdlL3N1Ym1pdCBldmVudHMsIHRoZXkgbXVzdAogICAgICAgIC8vIGJlIHJlYXR0YWNoZWQgd2hlbiB0aGUgbmV3bHkgY2xvbmVkIGV2ZW50cyBhcmUgZmlyc3QgYWN0aXZhdGVkCiAgICAgICAgZGVzdC5yZW1vdmVBdHRyaWJ1dGUoIl9zdWJtaXRfYXR0YWNoZWQiKTsKICAgICAgICBkZXN0LnJlbW92ZUF0dHJpYnV0ZSgiX2NoYW5nZV9hdHRhY2hlZCIpOwogICAgfQoKICAgIGpRdWVyeS5idWlsZEZyYWdtZW50ID0gZnVuY3Rpb24gKGFyZ3MsIG5vZGVzLCBzY3JpcHRzKSB7CiAgICAgICAgdmFyIGZyYWdtZW50LCBjYWNoZWFibGUsIGNhY2hlcmVzdWx0cywgZG9jLAogICAgICAgICAgICBmaXJzdCA9IGFyZ3NbIDAgXTsKCiAgICAgICAgLy8gbm9kZXMgbWF5IGNvbnRhaW4gZWl0aGVyIGFuIGV4cGxpY2l0IGRvY3VtZW50IG9iamVjdCwKICAgICAgICAvLyBhIGpRdWVyeSBjb2xsZWN0aW9uIG9yIGNvbnRleHQgb2JqZWN0LgogICAgICAgIC8vIElmIG5vZGVzWzBdIGNvbnRhaW5zIGEgdmFsaWQgb2JqZWN0IHRvIGFzc2lnbiB0byBkb2MKICAgICAgICBpZiAobm9kZXMgJiYgbm9kZXNbMF0pIHsKICAgICAgICAgICAgZG9jID0gbm9kZXNbMF0ub3duZXJEb2N1bWVudCB8fCBub2Rlc1swXTsKICAgICAgICB9CgogICAgICAgIC8vIEVuc3VyZSB0aGF0IGFuIGF0dHIgb2JqZWN0IGRvZXNuJ3QgaW5jb3JyZWN0bHkgc3RhbmQgaW4gYXMgYSBkb2N1bWVudCBvYmplY3QKICAgICAgICAvLyBDaHJvbWUgYW5kIEZpcmVmb3ggc2VlbSB0byBhbGxvdyB0aGlzIHRvIG9jY3VyIGFuZCB3aWxsIHRocm93IGV4Y2VwdGlvbgogICAgICAgIC8vIEZpeGVzICM4OTUwCiAgICAgICAgaWYgKCFkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCkgewogICAgICAgICAgICBkb2MgPSBkb2N1bWVudDsKICAgICAgICB9CgogICAgICAgIC8vIE9ubHkgY2FjaGUgInNtYWxsIiAoMS8yIEtCKSBIVE1MIHN0cmluZ3MgdGhhdCBhcmUgYXNzb2NpYXRlZCB3aXRoIHRoZSBtYWluIGRvY3VtZW50CiAgICAgICAgLy8gQ2xvbmluZyBvcHRpb25zIGxvc2VzIHRoZSBzZWxlY3RlZCBzdGF0ZSwgc28gZG9uJ3QgY2FjaGUgdGhlbQogICAgICAgIC8vIElFIDYgZG9lc24ndCBsaWtlIGl0IHdoZW4geW91IHB1dCA8b2JqZWN0PiBvciA8ZW1iZWQ+IGVsZW1lbnRzIGluIGEgZnJhZ21lbnQKICAgICAgICAvLyBBbHNvLCBXZWJLaXQgZG9lcyBub3QgY2xvbmUgJ2NoZWNrZWQnIGF0dHJpYnV0ZXMgb24gY2xvbmVOb2RlLCBzbyBkb24ndCBjYWNoZQogICAgICAgIC8vIExhc3RseSwgSUU2LDcsOCB3aWxsIG5vdCBjb3JyZWN0bHkgcmV1c2UgY2FjaGVkIGZyYWdtZW50cyB0aGF0IHdlcmUgY3JlYXRlZCBmcm9tIHVua25vd24gZWxlbXMgIzEwNTAxCiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAxICYmIHR5cGVvZiBmaXJzdCA9PT0gInN0cmluZyIgJiYgZmlyc3QubGVuZ3RoIDwgNTEyICYmIGRvYyA9PT0gZG9jdW1lbnQgJiYKICAgICAgICAgICAgZmlyc3QuY2hhckF0KDApID09PSAiPCIgJiYgIXJub2NhY2hlLnRlc3QoZmlyc3QpICYmCiAgICAgICAgICAgIChqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KGZpcnN0KSkgJiYKICAgICAgICAgICAgKGpRdWVyeS5zdXBwb3J0Lmh0bWw1Q2xvbmUgfHwgIXJub3NoaW1jYWNoZS50ZXN0KGZpcnN0KSkpIHsKCiAgICAgICAgICAgIGNhY2hlYWJsZSA9IHRydWU7CgogICAgICAgICAgICBjYWNoZXJlc3VsdHMgPSBqUXVlcnkuZnJhZ21lbnRzWyBmaXJzdCBdOwogICAgICAgICAgICBpZiAoY2FjaGVyZXN1bHRzICYmIGNhY2hlcmVzdWx0cyAhPT0gMSkgewogICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBjYWNoZXJlc3VsdHM7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghZnJhZ21lbnQpIHsKICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICBqUXVlcnkuY2xlYW4oYXJncywgZG9jLCBmcmFnbWVudCwgc2NyaXB0cyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2FjaGVhYmxlKSB7CiAgICAgICAgICAgIGpRdWVyeS5mcmFnbWVudHNbIGZpcnN0IF0gPSBjYWNoZXJlc3VsdHMgPyBmcmFnbWVudCA6IDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyBmcmFnbWVudDogZnJhZ21lbnQsIGNhY2hlYWJsZTogY2FjaGVhYmxlIH07CiAgICB9OwoKICAgIGpRdWVyeS5mcmFnbWVudHMgPSB7fTsKCiAgICBqUXVlcnkuZWFjaCh7CiAgICAgICAgYXBwZW5kVG86ICJhcHBlbmQiLAogICAgICAgIHByZXBlbmRUbzogInByZXBlbmQiLAogICAgICAgIGluc2VydEJlZm9yZTogImJlZm9yZSIsCiAgICAgICAgaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCiAgICAgICAgcmVwbGFjZUFsbDogInJlcGxhY2VXaXRoIgogICAgfSwgZnVuY3Rpb24gKG5hbWUsIG9yaWdpbmFsKSB7CiAgICAgICAgalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgdmFyIHJldCA9IFtdLAogICAgICAgICAgICAgICAgaW5zZXJ0ID0galF1ZXJ5KHNlbGVjdG9yKSwKICAgICAgICAgICAgICAgIHBhcmVudCA9IHRoaXMubGVuZ3RoID09PSAxICYmIHRoaXNbMF0ucGFyZW50Tm9kZTsKCiAgICAgICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlID09PSAxMSAmJiBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgaW5zZXJ0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgaW5zZXJ0WyBvcmlnaW5hbCBdKHRoaXNbMF0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBpbnNlcnQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1zID0gKCBpID4gMCA/IHRoaXMuY2xvbmUodHJ1ZSkgOiB0aGlzICkuZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KGluc2VydFtpXSlbIG9yaWdpbmFsIF0oZWxlbXMpOwogICAgICAgICAgICAgICAgICAgIHJldCA9IHJldC5jb25jYXQoZWxlbXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyZXQsIG5hbWUsIGluc2VydC5zZWxlY3Rvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSk7CgogICAgZnVuY3Rpb24gZ2V0QWxsKGVsZW0pIHsKICAgICAgICBpZiAodHlwZW9mIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIik7CgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW0ucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW0ucXVlcnlTZWxlY3RvckFsbCgiKiIpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgfQoKLy8gVXNlZCBpbiBjbGVhbiwgZml4ZXMgdGhlIGRlZmF1bHRDaGVja2VkIHByb3BlcnR5CiAgICBmdW5jdGlvbiBmaXhEZWZhdWx0Q2hlY2tlZChlbGVtKSB7CiAgICAgICAgaWYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpIHsKICAgICAgICAgICAgZWxlbS5kZWZhdWx0Q2hlY2tlZCA9IGVsZW0uY2hlY2tlZDsKICAgICAgICB9CiAgICB9CgovLyBGaW5kcyBhbGwgaW5wdXRzIGFuZCBwYXNzZXMgdGhlbSB0byBmaXhEZWZhdWx0Q2hlY2tlZAogICAgZnVuY3Rpb24gZmluZElucHV0cyhlbGVtKSB7CiAgICAgICAgdmFyIG5vZGVOYW1lID0gKCBlbGVtLm5vZGVOYW1lIHx8ICIiICkudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIpIHsKICAgICAgICAgICAgZml4RGVmYXVsdENoZWNrZWQoZWxlbSk7CiAgICAgICAgICAgIC8vIFNraXAgc2NyaXB0cywgZ2V0IG90aGVyIGNoaWxkcmVuCiAgICAgICAgfSBlbHNlIGlmIChub2RlTmFtZSAhPT0gInNjcmlwdCIgJiYgdHlwZW9mIGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGpRdWVyeS5ncmVwKGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IiksIGZpeERlZmF1bHRDaGVja2VkKTsKICAgICAgICB9CiAgICB9CgovLyBEZXJpdmVkIEZyb206IGh0dHA6Ly93d3cuaWVjc3MuY29tL3NoaW1wcm92ZS9qYXZhc2NyaXB0L3NoaW1wcm92ZS4xLTAtMS5qcwogICAgZnVuY3Rpb24gc2hpbUNsb25lTm9kZShlbGVtKSB7CiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHNhZmVGcmFnbWVudC5hcHBlbmRDaGlsZChkaXYpOwoKICAgICAgICBkaXYuaW5uZXJIVE1MID0gZWxlbS5vdXRlckhUTUw7CiAgICAgICAgcmV0dXJuIGRpdi5maXJzdENoaWxkOwogICAgfQoKICAgIGpRdWVyeS5leHRlbmQoewogICAgICAgIGNsb25lOiBmdW5jdGlvbiAoZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgICAgICAgdmFyIHNyY0VsZW1lbnRzLAogICAgICAgICAgICAgICAgZGVzdEVsZW1lbnRzLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgLy8gSUU8PTggZG9lcyBub3QgcHJvcGVybHkgY2xvbmUgZGV0YWNoZWQsIHVua25vd24gZWxlbWVudCBub2RlcwogICAgICAgICAgICAgICAgY2xvbmUgPSBqUXVlcnkuc3VwcG9ydC5odG1sNUNsb25lIHx8IGpRdWVyeS5pc1hNTERvYyhlbGVtKSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIjwiICsgZWxlbS5ub2RlTmFtZSArICI+IikgPwogICAgICAgICAgICAgICAgICAgIGVsZW0uY2xvbmVOb2RlKHRydWUpIDoKICAgICAgICAgICAgICAgICAgICBzaGltQ2xvbmVOb2RlKGVsZW0pOwoKICAgICAgICAgICAgaWYgKCghalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50IHx8ICFqUXVlcnkuc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCkgJiYKICAgICAgICAgICAgICAgIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgICAgICAgICAvLyBJRSBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KICAgICAgICAgICAgICAgIC8vIENhbGxpbmcgZGV0YWNoRXZlbnQgb24gdGhlIGNsb25lIHdpbGwgYWxzbyByZW1vdmUgdGhlIGV2ZW50cwogICAgICAgICAgICAgICAgLy8gZnJvbSB0aGUgb3JpZ2luYWwuIEluIG9yZGVyIHRvIGdldCBhcm91bmQgdGhpcywgd2UgdXNlIHNvbWUKICAgICAgICAgICAgICAgIC8vIHByb3ByaWV0YXJ5IG1ldGhvZHMgdG8gY2xlYXIgdGhlIGV2ZW50cy4gVGhhbmtzIHRvIE1vb1Rvb2xzCiAgICAgICAgICAgICAgICAvLyBndXlzIGZvciB0aGlzIGhvdG5lc3MuCgogICAgICAgICAgICAgICAgY2xvbmVGaXhBdHRyaWJ1dGVzKGVsZW0sIGNsb25lKTsKCiAgICAgICAgICAgICAgICAvLyBVc2luZyBTaXp6bGUgaGVyZSBpcyBjcmF6eSBzbG93LCBzbyB3ZSB1c2UgZ2V0RWxlbWVudHNCeVRhZ05hbWUgaW5zdGVhZAogICAgICAgICAgICAgICAgc3JjRWxlbWVudHMgPSBnZXRBbGwoZWxlbSk7CiAgICAgICAgICAgICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUpOwoKICAgICAgICAgICAgICAgIC8vIFdlaXJkIGl0ZXJhdGlvbiBiZWNhdXNlIElFIHdpbGwgcmVwbGFjZSB0aGUgbGVuZ3RoIHByb3BlcnR5CiAgICAgICAgICAgICAgICAvLyB3aXRoIGFuIGVsZW1lbnQgaWYgeW91IGFyZSBjbG9uaW5nIHRoZSBib2R5IGFuZCBvbmUgb2YgdGhlCiAgICAgICAgICAgICAgICAvLyBlbGVtZW50cyBvbiB0aGUgcGFnZSBoYXMgYSBuYW1lIG9yIGlkIG9mICJsZW5ndGgiCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBzcmNFbGVtZW50c1tpXTsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIGRlc3RpbmF0aW9uIG5vZGUgaXMgbm90IG51bGw7IEZpeGVzICM5NTg3CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3RFbGVtZW50c1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICBjbG9uZUZpeEF0dHJpYnV0ZXMoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCiAgICAgICAgICAgIGlmIChkYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICAgICAgICBjbG9uZUNvcHlFdmVudChlbGVtLCBjbG9uZSk7CgogICAgICAgICAgICAgICAgaWYgKGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgc3JjRWxlbWVudHMgPSBnZXRBbGwoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgc3JjRWxlbWVudHNbaV07ICsraSkgewogICAgICAgICAgICAgICAgICAgICAgICBjbG9uZUNvcHlFdmVudChzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNyY0VsZW1lbnRzID0gZGVzdEVsZW1lbnRzID0gbnVsbDsKCiAgICAgICAgICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgfSwKCiAgICAgICAgY2xlYW46IGZ1bmN0aW9uIChlbGVtcywgY29udGV4dCwgZnJhZ21lbnQsIHNjcmlwdHMpIHsKICAgICAgICAgICAgdmFyIGNoZWNrU2NyaXB0VHlwZSwgc2NyaXB0LCBqLAogICAgICAgICAgICAgICAgcmV0ID0gW107CgogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCiAgICAgICAgICAgIC8vICFjb250ZXh0LmNyZWF0ZUVsZW1lbnQgZmFpbHMgaW4gSUUgd2l0aCBhbiBlcnJvciBidXQgcmV0dXJucyB0eXBlb2YgJ29iamVjdCcKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmNyZWF0ZUVsZW1lbnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHRbMF0gJiYgY29udGV4dFswXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSArPSAiIjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWVsZW0pIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IGh0bWwgc3RyaW5nIGludG8gRE9NIG5vZGVzCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyaHRtbC50ZXN0KGVsZW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBjb250ZXh0LmNyZWF0ZVRleHROb2RlKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeCAiWEhUTUwiLXN0eWxlIHRhZ3MgaW4gYWxsIGJyb3dzZXJzCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtLnJlcGxhY2UocnhodG1sVGFnLCAiPCQxPjwvJDI+Iik7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhZyA9ICggcnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbIiIsICIiXSApWzFdLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcHRoID0gd3JhcFswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdiA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQ2hpbGROb2RlcyA9IHNhZmVGcmFnbWVudC5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIHdyYXBwZXIgZWxlbWVudCB0byB1bmtub3duIGVsZW1lbnQgc2FmZSBkb2MgZnJhZ21lbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgPT09IGRvY3VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIGZyYWdtZW50IHdlJ3ZlIGFscmVhZHkgY3JlYXRlZCBmb3IgdGhpcyBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUZyYWdtZW50LmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVc2UgYSBmcmFnbWVudCBjcmVhdGVkIHdpdGggdGhlIG93bmVyIGRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVTYWZlRnJhZ21lbnQoY29udGV4dCkuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwogICAgICAgICAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0gKyB3cmFwWzJdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdiA9IGRpdi5sYXN0Q2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5LnN1cHBvcnQudGJvZHkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdHJpbmcgd2FzIGEgPHRhYmxlPiwgKm1heSogaGF2ZSBzcHVyaW91cyA8dGJvZHk+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFzQm9keSA9IHJ0Ym9keS50ZXN0KGVsZW0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRib2R5ID0gdGFnID09PSAidGFibGUiICYmICFoYXNCb2R5ID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmZpcnN0Q2hpbGQgJiYgZGl2LmZpcnN0Q2hpbGQuY2hpbGROb2RlcyA6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JhcFsxXSA9PT0gIjx0YWJsZT4iICYmICFoYXNCb2R5ID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5jaGlsZE5vZGVzIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IHRib2R5Lmxlbmd0aCAtIDE7IGogPj0gMDsgLS1qKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5ub2RlTmFtZSh0Ym9keVsgaiBdLCAidGJvZHkiKSAmJiAhdGJvZHlbIGogXS5jaGlsZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Ym9keVsgaiBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGJvZHlbIGogXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJRSBjb21wbGV0ZWx5IGtpbGxzIGxlYWRpbmcgd2hpdGVzcGFjZSB3aGVuIGlubmVySFRNTCBpcyB1c2VkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5LnN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgJiYgcmxlYWRpbmdXaGl0ZXNwYWNlLnRlc3QoZWxlbSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5pbnNlcnRCZWZvcmUoY29udGV4dC5jcmVhdGVUZXh0Tm9kZShybGVhZGluZ1doaXRlc3BhY2UuZXhlYyhlbGVtKVswXSksIGRpdi5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGRpdi5jaGlsZE5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgZWxlbWVudHMgZnJvbSBEb2N1bWVudEZyYWdtZW50IChzYWZlRnJhZ21lbnQgb3Igb3RoZXJ3aXNlKQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0byBhdm9pZCBob2FyZGluZyBlbGVtZW50cy4gRml4ZXMgIzExMzU2CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRpdik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR3VhcmQgYWdhaW5zdCAtMSBpbmRleCBleGNlcHRpb25zIGluIEZGMy42CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2FmZUNoaWxkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZSA9IHNhZmVDaGlsZE5vZGVzWyBzYWZlQ2hpbGROb2Rlcy5sZW5ndGggLSAxIF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmUgJiYgcmVtb3ZlLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmVtb3ZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVzZXRzIGRlZmF1bHRDaGVja2VkIGZvciBhbnkgcmFkaW9zIGFuZCBjaGVja2JveGVzCiAgICAgICAgICAgICAgICAvLyBhYm91dCB0byBiZSBhcHBlbmRlZCB0byB0aGUgRE9NIGluIElFIDYvNyAoIzgwNjApCiAgICAgICAgICAgICAgICB2YXIgbGVuOwogICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkuc3VwcG9ydC5hcHBlbmRDaGVja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1bMF0gJiYgdHlwZW9mIChsZW4gPSBlbGVtLmxlbmd0aCkgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBsZW47IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluZElucHV0cyhlbGVtW2pdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRJbnB1dHMoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldCA9IGpRdWVyeS5tZXJnZShyZXQsIGVsZW0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgIGNoZWNrU2NyaXB0VHlwZSA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFlbGVtLnR5cGUgfHwgcnNjcmlwdFR5cGUudGVzdChlbGVtLnR5cGUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IHJldFtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0ID0gcmV0W2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChzY3JpcHRzICYmIGpRdWVyeS5ub2RlTmFtZShzY3JpcHQsICJzY3JpcHQiKSAmJiAoIXNjcmlwdC50eXBlIHx8IHJzY3JpcHRUeXBlLnRlc3Qoc2NyaXB0LnR5cGUpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRzLnB1c2goc2NyaXB0LnBhcmVudE5vZGUgPyBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpIDogc2NyaXB0KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmlwdC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpzVGFncyA9IGpRdWVyeS5ncmVwKHNjcmlwdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IiksIGNoZWNrU2NyaXB0VHlwZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnNwbGljZS5hcHBseShyZXQsIFtpICsgMSwgMF0uY29uY2F0KGpzVGFncykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0sCgogICAgICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgICAgICAgIHZhciBkYXRhLCBpZCwKICAgICAgICAgICAgICAgIGNhY2hlID0galF1ZXJ5LmNhY2hlLAogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsLAogICAgICAgICAgICAgICAgZGVsZXRlRXhwYW5kbyA9IGpRdWVyeS5zdXBwb3J0LmRlbGV0ZUV4cGFuZG87CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZCA9IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgogICAgICAgICAgICAgICAgaWYgKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGNhY2hlWyBpZCBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0eXBlIGluIGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbFsgdHlwZSBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZShlbGVtLCB0eXBlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOdWxsIHRoZSBET00gcmVmZXJlbmNlIHRvIGF2b2lkIElFNi83LzggbGVhayAoIzcwNTQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5oYW5kbGUuZWxlbSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVFeHBhbmRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0ucmVtb3ZlQXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGpRdWVyeS5leHBhbmRvKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVsgaWQgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKCiAgICB2YXIgcmFscGhhID0gL2FscGhhXChbXildKlwpL2ksCiAgICAgICAgcm9wYWNpdHkgPSAvb3BhY2l0eT0oW14pXSopLywKICAgIC8vIGZpeGVkIGZvciBJRTksIHNlZSAjODM0NgogICAgICAgIHJ1cHBlciA9IC8oW0EtWl18Xm1zKS9nLAogICAgICAgIHJudW0gPSAvXltcLStdPyg/OlxkKlwuKT9cZCskL2ksCiAgICAgICAgcm51bW5vbnB4ID0gL14tPyg/OlxkKlwuKT9cZCsoPyFweClbXlxkXHNdKyQvaSwKICAgICAgICBycmVsTnVtID0gL14oW1wtK10pPShbXC0rLlxkZV0rKS8sCiAgICAgICAgcm1hcmdpbiA9IC9ebWFyZ2luLywKCiAgICAgICAgY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCgogICAgLy8gb3JkZXIgaXMgaW1wb3J0YW50IQogICAgICAgIGNzc0V4cGFuZCA9IFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXSwKCiAgICAgICAgY3VyQ1NTLAoKICAgICAgICBnZXRDb21wdXRlZFN0eWxlLAogICAgICAgIGN1cnJlbnRTdHlsZTsKCiAgICBqUXVlcnkuZm4uY3NzID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5hY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8KICAgICAgICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lLCB2YWx1ZSkgOgogICAgICAgICAgICAgICAgalF1ZXJ5LmNzcyhlbGVtLCBuYW1lKTsKICAgICAgICB9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfTsKCiAgICBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICAvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKICAgICAgICAvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKICAgICAgICBjc3NIb29rczogewogICAgICAgICAgICBvcGFjaXR5OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gY3VyQ1NTKGVsZW0sICJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5zdHlsZS5vcGFjaXR5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIEV4Y2x1ZGUgdGhlIGZvbGxvd2luZyBjc3MgcHJvcGVydGllcyB0byBhZGQgcHgKICAgICAgICBjc3NOdW1iZXI6IHsKICAgICAgICAgICAgImZpbGxPcGFjaXR5IjogdHJ1ZSwKICAgICAgICAgICAgImZvbnRXZWlnaHQiOiB0cnVlLAogICAgICAgICAgICAibGluZUhlaWdodCI6IHRydWUsCiAgICAgICAgICAgICJvcGFjaXR5IjogdHJ1ZSwKICAgICAgICAgICAgIm9ycGhhbnMiOiB0cnVlLAogICAgICAgICAgICAid2lkb3dzIjogdHJ1ZSwKICAgICAgICAgICAgInpJbmRleCI6IHRydWUsCiAgICAgICAgICAgICJ6b29tIjogdHJ1ZQogICAgICAgIH0sCgogICAgICAgIC8vIEFkZCBpbiBwcm9wZXJ0aWVzIHdob3NlIG5hbWVzIHlvdSB3aXNoIHRvIGZpeCBiZWZvcmUKICAgICAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICAgICAgY3NzUHJvcHM6IHsKICAgICAgICAgICAgLy8gbm9ybWFsaXplIGZsb2F0IGNzcyBwcm9wZXJ0eQogICAgICAgICAgICAiZmxvYXQiOiBqUXVlcnkuc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKICAgICAgICB9LAoKICAgICAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgICAgIHN0eWxlOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhKSB7CiAgICAgICAgICAgIC8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICAgICAgICBpZiAoIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgICAgICAgICB2YXIgcmV0LCB0eXBlLCBvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZSksCiAgICAgICAgICAgICAgICBzdHlsZSA9IGVsZW0uc3R5bGUsIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCBvcmlnTmFtZTsKCiAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHJlbGF0aXZlIG51bWJlciBzdHJpbmdzICgrPSBvciAtPSkgdG8gcmVsYXRpdmUgbnVtYmVycy4gIzczNDUKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcnJlbE51bS5leGVjKHZhbHVlKSkpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICggKyggcmV0WzFdICsgMSkgKiArcmV0WzJdICkgKyBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgbmFtZSkpOwogICAgICAgICAgICAgICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAibnVtYmVyIjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBOYU4gYW5kIG51bGwgdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHR5cGUgPT09ICJudW1iZXIiICYmIGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAibnVtYmVyIiAmJiAhalF1ZXJ5LmNzc051bWJlclsgb3JpZ05hbWUgXSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlICs9ICJweCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlCiAgICAgICAgICAgICAgICBpZiAoIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXcmFwcGVkIHRvIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBlcnJvcnMgd2hlbiAnaW52YWxpZCcgdmFsdWVzIGFyZSBwcm92aWRlZAogICAgICAgICAgICAgICAgICAgIC8vIEZpeGVzIGJ1ZyAjNTUwOQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlWyBuYW1lIF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICAgICAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgZmFsc2UsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKICAgICAgICAgICAgICAgIHJldHVybiBzdHlsZVsgbmFtZSBdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZXh0cmEpIHsKICAgICAgICAgICAgdmFyIHJldCwgaG9va3M7CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZSk7CiAgICAgICAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF07CiAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG5hbWUgXSB8fCBuYW1lOwoKICAgICAgICAgICAgLy8gY3NzRmxvYXQgbmVlZHMgYSBzcGVjaWFsIHRyZWF0bWVudAogICAgICAgICAgICBpZiAobmFtZSA9PT0gImNzc0Zsb2F0IikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJmbG9hdCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgICAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIHRydWUsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKCiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAogICAgICAgICAgICB9IGVsc2UgaWYgKGN1ckNTUykgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1ckNTUyhlbGVtLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMKICAgICAgICBzd2FwOiBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIG9sZCA9IHt9LAogICAgICAgICAgICAgICAgcmV0LCBuYW1lOwoKICAgICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCiAgICAgICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKICAgICAgICAgICAgICAgIGVsZW0uc3R5bGVbIG5hbWUgXSA9IG9wdGlvbnNbIG5hbWUgXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0ID0gY2FsbGJhY2suY2FsbChlbGVtKTsKCiAgICAgICAgICAgIC8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwogICAgICAgICAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgfSk7CgovLyBERVBSRUNBVEVEIGluIDEuMywgVXNlIGpRdWVyeS5jc3MoKSBpbnN0ZWFkCiAgICBqUXVlcnkuY3VyQ1NTID0galF1ZXJ5LmNzczsKCiAgICBpZiAoZG9jdW1lbnQuZGVmYXVsdFZpZXcgJiYgZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgIGdldENvbXB1dGVkU3R5bGUgPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICAgICAgICB2YXIgcmV0LCBkZWZhdWx0VmlldywgY29tcHV0ZWRTdHlsZSwgd2lkdGgsCiAgICAgICAgICAgICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKHJ1cHBlciwgIi0kMSIpLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICBpZiAoKGRlZmF1bHRWaWV3ID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3KSAmJgogICAgICAgICAgICAgICAgKGNvbXB1dGVkU3R5bGUgPSBkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW0sIG51bGwpKSkgewoKICAgICAgICAgICAgICAgIHJldCA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKTsKICAgICAgICAgICAgICAgIGlmIChyZXQgPT09ICIiICYmICFqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZWxlbSkpIHsKICAgICAgICAgICAgICAgICAgICByZXQgPSBqUXVlcnkuc3R5bGUoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCiAgICAgICAgICAgIC8vIFdlYktpdCB1c2VzICJjb21wdXRlZCB2YWx1ZSAocGVyY2VudGFnZSBpZiBzcGVjaWZpZWQpIiBpbnN0ZWFkIG9mICJ1c2VkIHZhbHVlIiBmb3IgbWFyZ2lucwogICAgICAgICAgICAvLyB3aGljaCBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCiAgICAgICAgICAgIGlmICghalF1ZXJ5LnN1cHBvcnQucGl4ZWxNYXJnaW4gJiYgY29tcHV0ZWRTdHlsZSAmJiBybWFyZ2luLnRlc3QobmFtZSkgJiYgcm51bW5vbnB4LnRlc3QocmV0KSkgewogICAgICAgICAgICAgICAgd2lkdGggPSBzdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgICAgICAgICAgcmV0ID0gY29tcHV0ZWRTdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgIHN0eWxlLndpZHRoID0gd2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKICAgIH0KCiAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmN1cnJlbnRTdHlsZSkgewogICAgICAgIGN1cnJlbnRTdHlsZSA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgICAgICAgIHZhciBsZWZ0LCByc0xlZnQsIHVuY29tcHV0ZWQsCiAgICAgICAgICAgICAgICByZXQgPSBlbGVtLmN1cnJlbnRTdHlsZSAmJiBlbGVtLmN1cnJlbnRTdHlsZVsgbmFtZSBdLAogICAgICAgICAgICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlOwoKICAgICAgICAgICAgLy8gQXZvaWQgc2V0dGluZyByZXQgdG8gZW1wdHkgc3RyaW5nIGhlcmUKICAgICAgICAgICAgLy8gc28gd2UgZG9uJ3QgZGVmYXVsdCB0byBhdXRvCiAgICAgICAgICAgIGlmIChyZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiAodW5jb21wdXRlZCA9IHN0eWxlWyBuYW1lIF0pKSB7CiAgICAgICAgICAgICAgICByZXQgPSB1bmNvbXB1dGVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCiAgICAgICAgICAgIC8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCiAgICAgICAgICAgIC8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcgogICAgICAgICAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKICAgICAgICAgICAgaWYgKHJudW1ub25weC50ZXN0KHJldCkpIHsKCiAgICAgICAgICAgICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgICAgICAgICAgICAgICBsZWZ0ID0gc3R5bGUubGVmdDsKICAgICAgICAgICAgICAgIHJzTGVmdCA9IGVsZW0ucnVudGltZVN0eWxlICYmIGVsZW0ucnVudGltZVN0eWxlLmxlZnQ7CgogICAgICAgICAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICAgICAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICAgICAgICAgIGVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSBlbGVtLmN1cnJlbnRTdHlsZS5sZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGUubGVmdCA9IG5hbWUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6IHJldDsKICAgICAgICAgICAgICAgIHJldCA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgogICAgICAgICAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgICAgICAgICAgc3R5bGUubGVmdCA9IGxlZnQ7CiAgICAgICAgICAgICAgICBpZiAocnNMZWZ0KSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbS5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gIiIgPyAiYXV0byIgOiByZXQ7CiAgICAgICAgfTsKICAgIH0KCiAgICBjdXJDU1MgPSBnZXRDb21wdXRlZFN0eWxlIHx8IGN1cnJlbnRTdHlsZTsKCiAgICBmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKSB7CgogICAgICAgIC8vIFN0YXJ0IHdpdGggb2Zmc2V0IHByb3BlcnR5CiAgICAgICAgdmFyIHZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgIGkgPSBuYW1lID09PSAid2lkdGgiID8gMSA6IDAsCiAgICAgICAgICAgIGxlbiA9IDQ7CgogICAgICAgIGlmICh2YWwgPiAwKSB7CiAgICAgICAgICAgIGlmIChleHRyYSAhPT0gImJvcmRlciIpIHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWV4dHJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCAtPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgInBhZGRpbmciICsgY3NzRXhwYW5kWyBpIF0pKSB8fCAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZXh0cmEgPT09ICJtYXJnaW4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSkpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsIC09IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIikpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmFsICsgInB4IjsKICAgICAgICB9CgogICAgICAgIC8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQogICAgICAgIHZhbCA9IGN1ckNTUyhlbGVtLCBuYW1lKTsKICAgICAgICBpZiAodmFsIDwgMCB8fCB2YWwgPT0gbnVsbCkgewogICAgICAgICAgICB2YWwgPSBlbGVtLnN0eWxlWyBuYW1lIF07CiAgICAgICAgfQoKICAgICAgICAvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgogICAgICAgIGlmIChybnVtbm9ucHgudGVzdCh2YWwpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQoKICAgICAgICAvLyBOb3JtYWxpemUgIiIsIGF1dG8sIGFuZCBwcmVwYXJlIGZvciBleHRyYQogICAgICAgIHZhbCA9IHBhcnNlRmxvYXQodmFsKSB8fCAwOwoKICAgICAgICAvLyBBZGQgcGFkZGluZywgYm9yZGVyLCBtYXJnaW4KICAgICAgICBpZiAoZXh0cmEpIHsKICAgICAgICAgICAgZm9yICg7IGkgPCBsZW47IGkgKz0gMikgewogICAgICAgICAgICAgICAgdmFsICs9IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSkpIHx8IDA7CiAgICAgICAgICAgICAgICBpZiAoZXh0cmEgIT09ICJwYWRkaW5nIikgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIpKSB8fCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4dHJhID09PSAibWFyZ2luIikgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSkpIHx8IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWwgKyAicHgiOwogICAgfQoKICAgIGpRdWVyeS5lYWNoKFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgICAgICBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQsIGV4dHJhKSB7CiAgICAgICAgICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbS5vZmZzZXRXaWR0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5zd2FwKGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBybnVtLnRlc3QodmFsdWUpID8KICAgICAgICAgICAgICAgICAgICB2YWx1ZSArICJweCIgOgogICAgICAgICAgICAgICAgICAgIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGlmICghalF1ZXJ5LnN1cHBvcnQub3BhY2l0eSkgewogICAgICAgIGpRdWVyeS5jc3NIb29rcy5vcGFjaXR5ID0gewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgICAgICAgICAgICAgLy8gSUUgdXNlcyBmaWx0ZXJzIGZvciBvcGFjaXR5CiAgICAgICAgICAgICAgICByZXR1cm4gcm9wYWNpdHkudGVzdCgoY29tcHV0ZWQgJiYgZWxlbS5jdXJyZW50U3R5bGUgPyBlbGVtLmN1cnJlbnRTdHlsZS5maWx0ZXIgOiBlbGVtLnN0eWxlLmZpbHRlcikgfHwgIiIpID8KICAgICAgICAgICAgICAgICAgICAoIHBhcnNlRmxvYXQoUmVnRXhwLiQxKSAvIDEwMCApICsgIiIgOgogICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkID8gIjEiIDogIiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlID0gZWxlbS5zdHlsZSwKICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBlbGVtLmN1cnJlbnRTdHlsZSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0galF1ZXJ5LmlzTnVtZXJpYyh2YWx1ZSkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIgPSBjdXJyZW50U3R5bGUgJiYgY3VycmVudFN0eWxlLmZpbHRlciB8fCBzdHlsZS5maWx0ZXIgfHwgIiI7CgogICAgICAgICAgICAgICAgLy8gSUUgaGFzIHRyb3VibGUgd2l0aCBvcGFjaXR5IGlmIGl0IGRvZXMgbm90IGhhdmUgbGF5b3V0CiAgICAgICAgICAgICAgICAvLyBGb3JjZSBpdCBieSBzZXR0aW5nIHRoZSB6b29tIGxldmVsCiAgICAgICAgICAgICAgICBzdHlsZS56b29tID0gMTsKCiAgICAgICAgICAgICAgICAvLyBpZiBzZXR0aW5nIG9wYWNpdHkgdG8gMSwgYW5kIG5vIG90aGVyIGZpbHRlcnMgZXhpc3QgLSBhdHRlbXB0IHRvIHJlbW92ZSBmaWx0ZXIgYXR0cmlidXRlICM2NjUyCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPj0gMSAmJiBqUXVlcnkudHJpbShmaWx0ZXIucmVwbGFjZShyYWxwaGEsICIiKSkgPT09ICIiKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIFNldHRpbmcgc3R5bGUuZmlsdGVyIHRvIG51bGwsICIiICYgIiAiIHN0aWxsIGxlYXZlICJmaWx0ZXI6IiBpbiB0aGUgY3NzVGV4dAogICAgICAgICAgICAgICAgICAgIC8vIGlmICJmaWx0ZXI6IiBpcyBwcmVzZW50IGF0IGFsbCwgY2xlYXJUeXBlIGlzIGRpc2FibGVkLCB3ZSB3YW50IHRvIGF2b2lkIHRoaXMKICAgICAgICAgICAgICAgICAgICAvLyBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgaXMgSUUgT25seSwgYnV0IHNvIGFwcGFyZW50bHkgaXMgdGhpcyBjb2RlIHBhdGguLi4KICAgICAgICAgICAgICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoImZpbHRlciIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSB0aGVyZSBpcyBubyBmaWx0ZXIgc3R5bGUgYXBwbGllZCBpbiBhIGNzcyBydWxlLCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U3R5bGUgJiYgIWN1cnJlbnRTdHlsZS5maWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UsIHNldCBuZXcgZmlsdGVyIHZhbHVlcwogICAgICAgICAgICAgICAgc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoZmlsdGVyKSA/CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLnJlcGxhY2UocmFscGhhLCBvcGFjaXR5KSA6CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyICsgIiAiICsgb3BhY2l0eTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgalF1ZXJ5KGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBUaGlzIGhvb2sgY2Fubm90IGJlIGFkZGVkIHVudGlsIERPTSByZWFkeSBiZWNhdXNlIHRoZSBzdXBwb3J0IHRlc3QKICAgICAgICAvLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkKICAgICAgICBpZiAoIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlTWFyZ2luUmlnaHQpIHsKICAgICAgICAgICAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LnN3YXAoZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VyQ1NTKGVsZW0sICJtYXJnaW4tcmlnaHQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLnN0eWxlLm1hcmdpblJpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKGpRdWVyeS5leHByICYmIGpRdWVyeS5leHByLmZpbHRlcnMpIHsKICAgICAgICBqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciB3aWR0aCA9IGVsZW0ub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQgPSBlbGVtLm9mZnNldEhlaWdodDsKCiAgICAgICAgICAgIHJldHVybiAoIHdpZHRoID09PSAwICYmIGhlaWdodCA9PT0gMCApIHx8ICghalF1ZXJ5LnN1cHBvcnQucmVsaWFibGVIaWRkZW5PZmZzZXRzICYmICgoZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkpIHx8IGpRdWVyeS5jc3MoZWxlbSwgImRpc3BsYXkiKSkgPT09ICJub25lIik7CiAgICAgICAgfTsKCiAgICAgICAgalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuICFqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbihlbGVtKTsKICAgICAgICB9OwogICAgfQoKLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwogICAgalF1ZXJ5LmVhY2goewogICAgICAgIG1hcmdpbjogIiIsCiAgICAgICAgcGFkZGluZzogIiIsCiAgICAgICAgYm9yZGVyOiAiV2lkdGgiCiAgICB9LCBmdW5jdGlvbiAocHJlZml4LCBzdWZmaXgpIHsKCiAgICAgICAgalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsKICAgICAgICAgICAgZXhwYW5kOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBpLAoKICAgICAgICAgICAgICAgIC8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF0sCiAgICAgICAgICAgICAgICAgICAgZXhwYW5kZWQgPSB7fTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGFuZGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0pOwoKCiAgICB2YXIgcjIwID0gLyUyMC9nLAogICAgICAgIHJicmFja2V0ID0gL1xbXF0kLywKICAgICAgICByQ1JMRiA9IC9ccj9cbi9nLAogICAgICAgIHJoYXNoID0gLyMuKiQvLAogICAgICAgIHJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopXHI/JC9tZywgLy8gSUUgbGVhdmVzIGFuIFxyIGNoYXJhY3RlciBhdCBFT0wKICAgICAgICByaW5wdXQgPSAvXig/OmNvbG9yfGRhdGV8ZGF0ZXRpbWV8ZGF0ZXRpbWUtbG9jYWx8ZW1haWx8aGlkZGVufG1vbnRofG51bWJlcnxwYXNzd29yZHxyYW5nZXxzZWFyY2h8dGVsfHRleHR8dGltZXx1cmx8d2VlaykkL2ksCiAgICAvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KICAgICAgICBybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcFwtc3RvcmFnZXwuK1wtZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCiAgICAgICAgcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCiAgICAgICAgcnByb3RvY29sID0gL15cL1wvLywKICAgICAgICBycXVlcnkgPSAvXD8vLAogICAgICAgIHJzY3JpcHQgPSAvPHNjcmlwdFxiW148XSooPzooPyE8XC9zY3JpcHQ+KTxbXjxdKikqPFwvc2NyaXB0Pi9naSwKICAgICAgICByc2VsZWN0VGV4dGFyZWEgPSAvXig/OnNlbGVjdHx0ZXh0YXJlYSkvaSwKICAgICAgICByc3BhY2VzQWpheCA9IC9ccysvLAogICAgICAgIHJ0cyA9IC8oWz8mXSlfPVteJl0qLywKICAgICAgICBydXJsID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKSk/KT8vLAoKICAgIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKICAgICAgICBfbG9hZCA9IGpRdWVyeS5mbi5sb2FkLAoKICAgIC8qIFByZWZpbHRlcnMKICAgICAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCiAgICAgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgogICAgICogICAgLSBCRUZPUkUgYXNraW5nIGZvciBhIHRyYW5zcG9ydAogICAgICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQogICAgICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgICogNCkgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKICAgICAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAogICAgICovCiAgICAgICAgcHJlZmlsdGVycyA9IHt9LAoKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAgKi8KICAgICAgICB0cmFuc3BvcnRzID0ge30sCgogICAgLy8gRG9jdW1lbnQgbG9jYXRpb24KICAgICAgICBhamF4TG9jYXRpb24sCgogICAgLy8gRG9jdW1lbnQgbG9jYXRpb24gc2VnbWVudHMKICAgICAgICBhamF4TG9jUGFydHMsCgogICAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgICAgICAgYWxsVHlwZXMgPSBbIiovIl0gKyBbIioiXTsKCi8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCi8vIGEgZmllbGQgZnJvbSB3aW5kb3cubG9jYXRpb24gaWYgZG9jdW1lbnQuZG9tYWluIGhhcyBiZWVuIHNldAogICAgdHJ5IHsKICAgICAgICBhamF4TG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFVzZSB0aGUgaHJlZiBhdHRyaWJ1dGUgb2YgYW4gQSBlbGVtZW50CiAgICAgICAgLy8gc2luY2UgSUUgd2lsbCBtb2RpZnkgaXQgZ2l2ZW4gZG9jdW1lbnQubG9jYXRpb24KICAgICAgICBhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgYWpheExvY2F0aW9uLmhyZWYgPSAiIjsKICAgICAgICBhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKICAgIH0KCi8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cwogICAgYWpheExvY1BhcnRzID0gcnVybC5leGVjKGFqYXhMb2NhdGlvbi50b0xvd2VyQ2FzZSgpKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CiAgICBmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlKSB7CgogICAgICAgIC8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMpIHsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIGRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkuc3BsaXQocnNwYWNlc0FqYXgpLAogICAgICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IGRhdGFUeXBlcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGUsCiAgICAgICAgICAgICAgICAgICAgbGlzdCwKICAgICAgICAgICAgICAgICAgICBwbGFjZUJlZm9yZTsKCiAgICAgICAgICAgICAgICAvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZXNbIGkgXTsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBjb250cm9sIGlmIHdlJ3JlIGFza2VkIHRvIGFkZCBiZWZvcmUKICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZXhpc3RpbmcgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIHBsYWNlQmVmb3JlID0gL15cKy8udGVzdChkYXRhVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYWNlQmVmb3JlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGUuc3Vic3RyKDEpIHx8ICIqIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIHdlIGFkZCB0byB0aGUgc3RydWN0dXJlIGFjY29yZGluZ2x5CiAgICAgICAgICAgICAgICAgICAgbGlzdFsgcGxhY2VCZWZvcmUgPyAidW5zaGlmdCIgOiAicHVzaCIgXShmdW5jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKICAgIGZ1bmN0aW9uIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiwgZGF0YVR5cGUgLyogaW50ZXJuYWwgKi8sIGluc3BlY3RlZCAvKiBpbnRlcm5hbCAqLykgewoKICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG9wdGlvbnMuZGF0YVR5cGVzWyAwIF07CiAgICAgICAgaW5zcGVjdGVkID0gaW5zcGVjdGVkIHx8IHt9OwoKICAgICAgICBpbnNwZWN0ZWRbIGRhdGFUeXBlIF0gPSB0cnVlOwoKICAgICAgICB2YXIgbGlzdCA9IHN0cnVjdHVyZVsgZGF0YVR5cGUgXSwKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGxlbmd0aCA9IGxpc3QgPyBsaXN0Lmxlbmd0aCA6IDAsCiAgICAgICAgICAgIGV4ZWN1dGVPbmx5ID0gKCBzdHJ1Y3R1cmUgPT09IHByZWZpbHRlcnMgKSwKICAgICAgICAgICAgc2VsZWN0aW9uOwoKICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aCAmJiAoIGV4ZWN1dGVPbmx5IHx8ICFzZWxlY3Rpb24gKTsgaSsrKSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IGxpc3RbIGkgXShvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKTsKICAgICAgICAgICAgLy8gSWYgd2UgZ290IHJlZGlyZWN0ZWQgdG8gYW5vdGhlciBkYXRhVHlwZQogICAgICAgICAgICAvLyB3ZSB0cnkgdGhlcmUgaWYgZXhlY3V0aW5nIG9ubHkgYW5kIG5vdCBkb25lIGFscmVhZHkKICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3Rpb24gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoIWV4ZWN1dGVPbmx5IHx8IGluc3BlY3RlZFsgc2VsZWN0aW9uIF0pIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoc2VsZWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24gPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cygKICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSLCBzZWxlY3Rpb24sIGluc3BlY3RlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gSWYgd2UncmUgb25seSBleGVjdXRpbmcgb3Igbm90aGluZyB3YXMgc2VsZWN0ZWQKICAgICAgICAvLyB3ZSB0cnkgdGhlIGNhdGNoYWxsIGRhdGFUeXBlIGlmIG5vdCBkb25lIGFscmVhZHkKICAgICAgICBpZiAoKCBleGVjdXRlT25seSB8fCAhc2VsZWN0aW9uICkgJiYgIWluc3BlY3RlZFsgIioiIF0pIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoCiAgICAgICAgICAgICAgICBzdHJ1Y3R1cmUsIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIsICIqIiwgaW5zcGVjdGVkKTsKICAgICAgICB9CiAgICAgICAgLy8gdW5uZWNlc3Nhcnkgd2hlbiBvbmx5IGV4ZWN1dGluZyAocHJlZmlsdGVycykKICAgICAgICAvLyBidXQgaXQnbGwgYmUgaWdub3JlZCBieSB0aGUgY2FsbGVyIGluIHRoYXQgY2FzZQogICAgICAgIHJldHVybiBzZWxlY3Rpb247CiAgICB9CgovLyBBIHNwZWNpYWwgZXh0ZW5kIGZvciBhamF4IG9wdGlvbnMKLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpCi8vIEZpeGVzICM5ODg3CiAgICBmdW5jdGlvbiBhamF4RXh0ZW5kKHRhcmdldCwgc3JjKSB7CiAgICAgICAgdmFyIGtleSwgZGVlcCwKICAgICAgICAgICAgZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwogICAgICAgIGZvciAoa2V5IGluIHNyYykgewogICAgICAgICAgICBpZiAoc3JjWyBrZXkgXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAoIGZsYXRPcHRpb25zWyBrZXkgXSA/IHRhcmdldCA6ICggZGVlcCB8fCAoIGRlZXAgPSB7fSApICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgICAgIGpRdWVyeS5leHRlbmQodHJ1ZSwgdGFyZ2V0LCBkZWVwKTsKICAgICAgICB9CiAgICB9CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgbG9hZDogZnVuY3Rpb24gKHVybCwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodHlwZW9mIHVybCAhPT0gInN0cmluZyIgJiYgX2xvYWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfbG9hZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgICAgIC8vIERvbid0IGRvIGEgcmVxdWVzdCBpZiBubyBlbGVtZW50cyBhcmUgYmVpbmcgcmVxdWVzdGVkCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG9mZiA9IHVybC5pbmRleE9mKCIgIik7CiAgICAgICAgICAgIGlmIChvZmYgPj0gMCkgewogICAgICAgICAgICAgICAgdmFyIHNlbGVjdG9yID0gdXJsLnNsaWNlKG9mZiwgdXJsLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRGVmYXVsdCB0byBhIEdFVCByZXF1ZXN0CiAgICAgICAgICAgIHZhciB0eXBlID0gIkdFVCI7CgogICAgICAgICAgICAvLyBJZiB0aGUgc2Vjb25kIHBhcmFtZXRlciB3YXMgcHJvdmlkZWQKICAgICAgICAgICAgaWYgKHBhcmFtcykgewogICAgICAgICAgICAgICAgLy8gSWYgaXQncyBhIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ocGFyYW1zKSkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0galF1ZXJ5LnBhcmFtKHBhcmFtcywgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbCk7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJQT1NUIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgLy8gUmVxdWVzdCB0aGUgcmVtb3RlIGRvY3VtZW50CiAgICAgICAgICAgIGpRdWVyeS5hamF4KHsKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAiaHRtbCIsCiAgICAgICAgICAgICAgICBkYXRhOiBwYXJhbXMsCiAgICAgICAgICAgICAgICAvLyBDb21wbGV0ZSBjYWxsYmFjayAocmVzcG9uc2VUZXh0IGlzIHVzZWQgaW50ZXJuYWxseSkKICAgICAgICAgICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbiAoanFYSFIsIHN0YXR1cywgcmVzcG9uc2VUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3RvcmUgdGhlIHJlc3BvbnNlIGFzIHNwZWNpZmllZCBieSB0aGUganFYSFIgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VUZXh0ID0ganFYSFIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgICAgIC8vIElmIHN1Y2Nlc3NmdWwsIGluamVjdCB0aGUgSFRNTCBpbnRvIGFsbCB0aGUgbWF0Y2hlZCBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgIGlmIChqcVhIUi5pc1Jlc29sdmVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIzQ4MjU6IEdldCB0aGUgYWN0dWFsIHJlc3BvbnNlIGluIGNhc2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYSBkYXRhRmlsdGVyIGlzIHByZXNlbnQgaW4gYWpheFNldHRpbmdzCiAgICAgICAgICAgICAgICAgICAgICAgIGpxWEhSLmRvbmUoZnVuY3Rpb24gKHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlVGV4dCA9IHI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZWUgaWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaHRtbChzZWxlY3RvciA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSBkdW1teSBkaXYgdG8gaG9sZCB0aGUgcmVzdWx0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KCI8ZGl2PiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5qZWN0IHRoZSBjb250ZW50cyBvZiB0aGUgZG9jdW1lbnQgaW4sIHJlbW92aW5nIHRoZSBzY3JpcHRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gYXZvaWQgYW55ICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzIGluIElFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGVuZChyZXNwb25zZVRleHQucmVwbGFjZShyc2NyaXB0LCAiIikpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvY2F0ZSB0aGUgc3BlY2lmaWVkIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoc2VsZWN0b3IpIDoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QsIGp1c3QgaW5qZWN0IHRoZSBmdWxsIHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVhY2goY2FsbGJhY2ssIFsgcmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBzZXJpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgICAgIH0sCgogICAgICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkodGhpcy5lbGVtZW50cykgOiB0aGlzOwogICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSAmJiAhdGhpcy5kaXNhYmxlZCAmJgogICAgICAgICAgICAgICAgICAgICAgICAoIHRoaXMuY2hlY2tlZCB8fCByc2VsZWN0VGV4dGFyZWEudGVzdCh0aGlzLm5vZGVOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlucHV0LnRlc3QodGhpcy50eXBlKSApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGksIGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0galF1ZXJ5KHRoaXMpLnZhbCgpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsID09IG51bGwgPwogICAgICAgICAgICAgICAgICAgICAgICBudWxsIDoKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmlzQXJyYXkodmFsKSA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKHZhbCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAiXHJcbiIpIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSA6CiAgICAgICAgICAgICAgICAgICAgICAgIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UockNSTEYsICJcclxuIikgfTsKICAgICAgICAgICAgICAgIH0pLmdldCgpOwogICAgICAgIH0KICAgIH0pOwoKLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMKICAgIGpRdWVyeS5lYWNoKCJhamF4U3RhcnQgYWpheFN0b3AgYWpheENvbXBsZXRlIGFqYXhFcnJvciBhamF4U3VjY2VzcyBhamF4U2VuZCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKGksIG8pIHsKICAgICAgICBqUXVlcnkuZm5bIG8gXSA9IGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKG8sIGYpOwogICAgICAgIH07CiAgICB9KTsKCiAgICBqUXVlcnkuZWFjaChbICJnZXQiLCAicG9zdCIgXSwgZnVuY3Rpb24gKGksIG1ldGhvZCkgewogICAgICAgIGpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSkgewogICAgICAgICAgICAvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZAogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oZGF0YSkpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBkYXRhOwogICAgICAgICAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgICAgICAgICAgIHR5cGU6IG1ldGhvZCwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgZGF0YVR5cGU6IHR5cGUKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGpRdWVyeS5leHRlbmQoewoKICAgICAgICBnZXRTY3JpcHQ6IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIpOwogICAgICAgIH0sCgogICAgICAgIGdldEpTT046IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ3JlYXRlcyBhIGZ1bGwgZmxlZGdlZCBzZXR0aW5ncyBvYmplY3QgaW50byB0YXJnZXQKICAgICAgICAvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCiAgICAgICAgLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KICAgICAgICBhamF4U2V0dXA6IGZ1bmN0aW9uICh0YXJnZXQsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIGlmIChzZXR0aW5ncykgewogICAgICAgICAgICAgICAgLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKICAgICAgICAgICAgICAgIGFqYXhFeHRlbmQodGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgdGFyZ2V0ID0galF1ZXJ5LmFqYXhTZXR0aW5nczsKICAgICAgICAgICAgfQogICAgICAgICAgICBhamF4RXh0ZW5kKHRhcmdldCwgc2V0dGluZ3MpOwogICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0sCgogICAgICAgIGFqYXhTZXR0aW5nczogewogICAgICAgICAgICB1cmw6IGFqYXhMb2NhdGlvbiwKICAgICAgICAgICAgaXNMb2NhbDogcmxvY2FsUHJvdG9jb2wudGVzdChhamF4TG9jUGFydHNbIDEgXSksCiAgICAgICAgICAgIGdsb2JhbDogdHJ1ZSwKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKICAgICAgICAgICAgcHJvY2Vzc0RhdGE6IHRydWUsCiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICAvKgogICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgICBkYXRhVHlwZTogbnVsbCwKICAgICAgICAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICAgICAgICAgcGFzc3dvcmQ6IG51bGwsCiAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgICAgICAgICAgIGhlYWRlcnM6IHt9LAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIGFjY2VwdHM6IHsKICAgICAgICAgICAgICAgIHhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAogICAgICAgICAgICAgICAgaHRtbDogInRleHQvaHRtbCIsCiAgICAgICAgICAgICAgICB0ZXh0OiAidGV4dC9wbGFpbiIsCiAgICAgICAgICAgICAgICBqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IiwKICAgICAgICAgICAgICAgICIqIjogYWxsVHlwZXMKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgICAgICAgICB4bWw6IC94bWwvLAogICAgICAgICAgICAgICAgaHRtbDogL2h0bWwvLAogICAgICAgICAgICAgICAganNvbjogL2pzb24vCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZXNwb25zZUZpZWxkczogewogICAgICAgICAgICAgICAgeG1sOiAicmVzcG9uc2VYTUwiLAogICAgICAgICAgICAgICAgdGV4dDogInJlc3BvbnNlVGV4dCIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIExpc3Qgb2YgZGF0YSBjb252ZXJ0ZXJzCiAgICAgICAgICAgIC8vIDEpIGtleSBmb3JtYXQgaXMgInNvdXJjZV90eXBlIGRlc3RpbmF0aW9uX3R5cGUiIChhIHNpbmdsZSBzcGFjZSBpbi1iZXR3ZWVuKQogICAgICAgICAgICAvLyAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZCBmb3Igc291cmNlX3R5cGUKICAgICAgICAgICAgY29udmVydGVyczogewoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAogICAgICAgICAgICAgICAgIiogdGV4dCI6IHdpbmRvdy5TdHJpbmcsCgogICAgICAgICAgICAgICAgLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCiAgICAgICAgICAgICAgICAidGV4dCBodG1sIjogdHJ1ZSwKCiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSB0ZXh0IGFzIGEganNvbiBleHByZXNzaW9uCiAgICAgICAgICAgICAgICAidGV4dCBqc29uIjogalF1ZXJ5LnBhcnNlSlNPTiwKCiAgICAgICAgICAgICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAgICAgICAgICAgInRleHQgeG1sIjogalF1ZXJ5LnBhcnNlWE1MCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgogICAgICAgICAgICAvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCiAgICAgICAgICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAgICAgICAgIC8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQogICAgICAgICAgICBmbGF0T3B0aW9uczogewogICAgICAgICAgICAgICAgY29udGV4dDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVybDogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMpLAogICAgICAgIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzKSwKCiAgICAgICAgLy8gTWFpbiBtZXRob2QKICAgICAgICBhamF4OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CgogICAgICAgICAgICAvLyBJZiB1cmwgaXMgYW4gb2JqZWN0LCBzaW11bGF0ZSBwcmUtMS41IHNpZ25hdHVyZQogICAgICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgICAgICAgICAgICB1cmwgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICAgICAgdmFyIC8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QKICAgICAgICAgICAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKHt9LCBvcHRpb25zKSwKICAgICAgICAgICAgLy8gQ2FsbGJhY2tzIGNvbnRleHQKICAgICAgICAgICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAogICAgICAgICAgICAvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzCiAgICAgICAgICAgIC8vIEl0J3MgdGhlIGNhbGxiYWNrQ29udGV4dCBpZiBvbmUgd2FzIHByb3ZpZGVkIGluIHRoZSBvcHRpb25zCiAgICAgICAgICAgIC8vIGFuZCBpZiBpdCdzIGEgRE9NIG5vZGUgb3IgYSBqUXVlcnkgY29sbGVjdGlvbgogICAgICAgICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0ICE9PSBzICYmCiAgICAgICAgICAgICAgICAgICAgKCBjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICkgPwogICAgICAgICAgICAgICAgICAgIGpRdWVyeShjYWxsYmFja0NvbnRleHQpIDogalF1ZXJ5LmV2ZW50LAogICAgICAgICAgICAvLyBEZWZlcnJlZHMKICAgICAgICAgICAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgICAgICAgICBjb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKICAgICAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICAgICAgICAgIHN0YXR1c0NvZGUgPSBzLnN0YXR1c0NvZGUgfHwge30sCiAgICAgICAgICAgIC8vIGlmTW9kaWZpZWQga2V5CiAgICAgICAgICAgICAgICBpZk1vZGlmaWVkS2V5LAogICAgICAgICAgICAvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQogICAgICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwKICAgICAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzTmFtZXMgPSB7fSwKICAgICAgICAgICAgLy8gUmVzcG9uc2UgaGVhZGVycwogICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nLAogICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzLAogICAgICAgICAgICAvLyB0cmFuc3BvcnQKICAgICAgICAgICAgICAgIHRyYW5zcG9ydCwKICAgICAgICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgICAgICAgICAgIHRpbWVvdXRUaW1lciwKICAgICAgICAgICAgLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCiAgICAgICAgICAgICAgICBwYXJ0cywKICAgICAgICAgICAgLy8gVGhlIGpxWEhSIHN0YXRlCiAgICAgICAgICAgICAgICBzdGF0ZSA9IDAsCiAgICAgICAgICAgIC8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAogICAgICAgICAgICAgICAgZmlyZUdsb2JhbHMsCiAgICAgICAgICAgIC8vIExvb3AgdmFyaWFibGUKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgIC8vIEZha2UgeGhyCiAgICAgICAgICAgICAgICBqcVhIUiA9IHsKCiAgICAgICAgICAgICAgICAgICAgcmVhZHlTdGF0ZTogMCwKCiAgICAgICAgICAgICAgICAgICAgLy8gQ2FjaGVzIHRoZSBoZWFkZXIKICAgICAgICAgICAgICAgICAgICBzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdIHx8IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1sgbmFtZSBdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLy8gUmF3IHN0cmluZwogICAgICAgICAgICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8vIEJ1aWxkcyBoZWFkZXJzIGhhc2h0YWJsZSBpZiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICBnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKCBtYXRjaCA9IHJoZWFkZXJzLmV4ZWMocmVzcG9uc2VIZWFkZXJzU3RyaW5nKSApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1sgbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSBdID0gbWF0Y2hbIDIgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHJlc3BvbnNlSGVhZGVyc1sga2V5LnRvTG93ZXJDYXNlKCkgXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPT09IHVuZGVmaW5lZCA/IG51bGwgOiBtYXRjaDsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvLyBPdmVycmlkZXMgcmVzcG9uc2UgY29udGVudC10eXBlIGhlYWRlcgogICAgICAgICAgICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMubWltZVR5cGUgPSB0eXBlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8vIENhbmNlbCB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoc3RhdHVzVGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNUZXh0ID0gc3RhdHVzVGV4dCB8fCAiYWJvcnQiOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQuYWJvcnQoc3RhdHVzVGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgwLCBzdGF0dXNUZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQogICAgICAgICAgICAvLyBJdCBpcyBkZWZpbmVkIGhlcmUgYmVjYXVzZSBqc2xpbnQgY29tcGxhaW5zIGlmIGl0IGlzIGRlY2xhcmVkCiAgICAgICAgICAgIC8vIGF0IHRoZSBlbmQgb2YgdGhlIGZ1bmN0aW9uICh3aGljaCB3b3VsZCBiZSBtb3JlIGxvZ2ljYWwgYW5kIHJlYWRhYmxlKQogICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzKSB7CgogICAgICAgICAgICAgICAgLy8gQ2FsbGVkIG9uY2UKICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CiAgICAgICAgICAgICAgICBzdGF0ZSA9IDI7CgogICAgICAgICAgICAgICAgLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dFRpbWVyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgICAgICAgICAgLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKICAgICAgICAgICAgICAgIHRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAvLyBDYWNoZSByZXNwb25zZSBoZWFkZXJzCiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKICAgICAgICAgICAgICAgIC8vIFNldCByZWFkeVN0YXRlCiAgICAgICAgICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwoKICAgICAgICAgICAgICAgIHZhciBpc1N1Y2Nlc3MsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcywKICAgICAgICAgICAgICAgICAgICBlcnJvciwKICAgICAgICAgICAgICAgICAgICBzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dCwKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlc3BvbnNlcyA/IGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcykgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgbGFzdE1vZGlmaWVkLAogICAgICAgICAgICAgICAgICAgIGV0YWc7CgogICAgICAgICAgICAgICAgLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNCkgewoKICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICAgICAgICAgICAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoIGxhc3RNb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIikgKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdID0gbGFzdE1vZGlmaWVkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoIGV0YWcgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiRXRhZyIpICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0gPSBldGFnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBub3QgbW9kaWZpZWQKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzID09PSAzMDQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwogICAgICAgICAgICAgICAgICAgICAgICBpc1N1Y2Nlc3MgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBkYXRhCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gYWpheENvbnZlcnQocywgcmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJzdWNjZXNzIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzU3VjY2VzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgYSBwYXJzZXJlcnJvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJwYXJzZXJlcnJvciI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9IGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIGV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0CiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBzdGF0dXNUZXh0OwogICAgICAgICAgICAgICAgICAgIGlmICghc3RhdHVzVGV4dCB8fCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJlcnJvciI7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CiAgICAgICAgICAgICAgICBqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgICBqcVhIUi5zdGF0dXNUZXh0ID0gIiIgKyAoIG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCApOwoKICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MvRXJyb3IKICAgICAgICAgICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChjYWxsYmFja0NvbnRleHQsIFsgc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFIgXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwogICAgICAgICAgICAgICAganFYSFIuc3RhdHVzQ29kZShzdGF0dXNDb2RlKTsKICAgICAgICAgICAgICAgIHN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoImFqYXgiICsgKCBpc1N1Y2Nlc3MgPyAiU3VjY2VzcyIgOiAiRXJyb3IiICksCiAgICAgICAgICAgICAgICAgICAgICAgIFsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgICAgICAgICAgY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aChjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQgXSk7CgogICAgICAgICAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSk7CiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoIC0talF1ZXJ5LmFjdGl2ZSApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RvcCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXR0YWNoIGRlZmVycmVkcwogICAgICAgICAgICBkZWZlcnJlZC5wcm9taXNlKGpxWEhSKTsKICAgICAgICAgICAganFYSFIuc3VjY2VzcyA9IGpxWEhSLmRvbmU7CiAgICAgICAgICAgIGpxWEhSLmVycm9yID0ganFYSFIuZmFpbDsKICAgICAgICAgICAganFYSFIuY29tcGxldGUgPSBjb21wbGV0ZURlZmVycmVkLmFkZDsKCiAgICAgICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgICAgIGpxWEhSLnN0YXR1c0NvZGUgPSBmdW5jdGlvbiAobWFwKSB7CiAgICAgICAgICAgICAgICBpZiAobWFwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcDsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPCAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodG1wIGluIG1hcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVsgdG1wIF0gPSBbIHN0YXR1c0NvZGVbdG1wXSwgbWFwW3RtcF0gXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IG1hcFsganFYSFIuc3RhdHVzIF07CiAgICAgICAgICAgICAgICAgICAgICAgIGpxWEhSLnRoZW4odG1wLCB0bXApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gUmVtb3ZlIGhhc2ggY2hhcmFjdGVyICgjNzUzMTogYW5kIHN0cmluZyBwcm9tb3Rpb24pCiAgICAgICAgICAgIC8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpCiAgICAgICAgICAgIC8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQogICAgICAgICAgICBzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgKSArICIiICkucmVwbGFjZShyaGFzaCwgIiIpLnJlcGxhY2UocnByb3RvY29sLCBhamF4TG9jUGFydHNbIDEgXSArICIvLyIpOwoKICAgICAgICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICAgICAgICBzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKHMuZGF0YVR5cGUgfHwgIioiKS50b0xvd2VyQ2FzZSgpLnNwbGl0KHJzcGFjZXNBamF4KTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSBpZiBhIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyCiAgICAgICAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBhcnRzID0gcnVybC5leGVjKHMudXJsLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgogICAgICAgICAgICAgICAgICAgICggcGFydHNbIDEgXSAhPSBhamF4TG9jUGFydHNbIDEgXSB8fCBwYXJ0c1sgMiBdICE9IGFqYXhMb2NQYXJ0c1sgMiBdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICggcGFydHNbIDMgXSB8fCAoIHBhcnRzWyAxIF0gPT09ICJodHRwOiIgPyA4MCA6IDQ0MyApICkgIT0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSApCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgICAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcy5kYXRhID0galF1ZXJ5LnBhcmFtKHMuZGF0YSwgcy50cmFkaXRpb25hbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGx5IHByZWZpbHRlcnMKICAgICAgICAgICAgaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMocHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIpOwoKICAgICAgICAgICAgLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKICAgICAgICAgICAgaWYgKHN0YXRlID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCiAgICAgICAgICAgIGZpcmVHbG9iYWxzID0gcy5nbG9iYWw7CgogICAgICAgICAgICAvLyBVcHBlcmNhc2UgdGhlIHR5cGUKICAgICAgICAgICAgcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAogICAgICAgICAgICBzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KHMudHlwZSk7CgogICAgICAgICAgICAvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCiAgICAgICAgICAgIGlmIChmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDApIHsKICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKICAgICAgICAgICAgaWYgKCFzLmhhc0NvbnRlbnQpIHsKCiAgICAgICAgICAgICAgICAvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCiAgICAgICAgICAgICAgICBpZiAocy5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgcy51cmwgKz0gKCBycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YTsKICAgICAgICAgICAgICAgICAgICAvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHMuZGF0YTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHZXQgaWZNb2RpZmllZEtleSBiZWZvcmUgYWRkaW5nIHRoZSBhbnRpLWNhY2hlIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgaWZNb2RpZmllZEtleSA9IHMudXJsOwoKICAgICAgICAgICAgICAgIC8vIEFkZCBhbnRpLWNhY2hlIGluIHVybCBpZiBuZWVkZWQKICAgICAgICAgICAgICAgIGlmIChzLmNhY2hlID09PSBmYWxzZSkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgdHMgPSBqUXVlcnkubm93KCksCiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHJlcGxhY2luZyBfPSBpZiBpdCBpcyB0aGVyZQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBzLnVybC5yZXBsYWNlKHJ0cywgIiQxXz0iICsgdHMpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpZiBub3RoaW5nIHdhcyByZXBsYWNlZCwgYWRkIHRpbWVzdGFtcCB0byB0aGUgZW5kCiAgICAgICAgICAgICAgICAgICAgcy51cmwgPSByZXQgKyAoICggcmV0ID09PSBzLnVybCApID8gKCBycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyB0cyA6ICIiICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAogICAgICAgICAgICBpZiAocy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgICAgICAgICAgaWZNb2RpZmllZEtleSA9IGlmTW9kaWZpZWRLZXkgfHwgcy51cmw7CiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Lmxhc3RNb2RpZmllZFsgaWZNb2RpZmllZEtleSBdKSB7CiAgICAgICAgICAgICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBpZk1vZGlmaWVkS2V5IF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5ldGFnWyBpZk1vZGlmaWVkS2V5IF0pIHsKICAgICAgICAgICAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Ob25lLU1hdGNoIiwgalF1ZXJ5LmV0YWdbIGlmTW9kaWZpZWRLZXkgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKICAgICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigKICAgICAgICAgICAgICAgICJBY2NlcHQiLAogICAgICAgICAgICAgICAgcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gPwogICAgICAgICAgICAgICAgICAgIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSArICggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgogICAgICAgICAgICAgICAgICAgIHMuYWNjZXB0c1sgIioiIF0KICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgogICAgICAgICAgICBmb3IgKGkgaW4gcy5oZWFkZXJzKSB7CiAgICAgICAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKGksIHMuaGVhZGVyc1sgaSBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQWxsb3cgY3VzdG9tIGhlYWRlcnMvbWltZXR5cGVzIGFuZCBlYXJseSBhYm9ydAogICAgICAgICAgICBpZiAocy5iZWZvcmVTZW5kICYmICggcy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcykgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkpIHsKICAgICAgICAgICAgICAgIC8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgICAgICAgICAgZm9yIChpIGluIHsgc3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxIH0pIHsKICAgICAgICAgICAgICAgIGpxWEhSWyBpIF0oc1sgaSBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IHRyYW5zcG9ydAogICAgICAgICAgICB0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUik7CgogICAgICAgICAgICAvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKICAgICAgICAgICAgaWYgKCF0cmFuc3BvcnQpIHsKICAgICAgICAgICAgICAgIGRvbmUoLTEsICJObyBUcmFuc3BvcnQiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpxWEhSLnJlYWR5U3RhdGUgPSAxOwogICAgICAgICAgICAgICAgLy8gU2VuZCBnbG9iYWwgZXZlbnQKICAgICAgICAgICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4U2VuZCIsIFsganFYSFIsIHMgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBUaW1lb3V0CiAgICAgICAgICAgICAgICBpZiAocy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCJ0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICAgICAgfSwgcy50aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gMTsKICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQuc2VuZChyZXF1ZXN0SGVhZGVycywgZG9uZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA8IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgtMSwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKICAgICAgICAvLyBrZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKICAgICAgICBwYXJhbTogZnVuY3Rpb24gKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgICAgIHZhciBzID0gW10sCiAgICAgICAgICAgICAgICBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQogICAgICAgICAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIHNbIHMubGVuZ3RoIF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KICAgICAgICAgICAgaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgYW4gYXJyYXkgd2FzIHBhc3NlZCBpbiwgYXNzdW1lIHRoYXQgaXQgaXMgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cy4KICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KGEpIHx8ICggYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KGEpICkpIHsKICAgICAgICAgICAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICAgICAgICAgICAgalF1ZXJ5LmVhY2goYSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGFkZCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAgICAgICAgICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgICAgICAgICAgIGZvciAodmFyIHByZWZpeCBpbiBhKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICAgICAgcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UocjIwLCAiKyIpOwogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICAgICAgaWYgKGpRdWVyeS5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGpRdWVyeS5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmICh0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KHByZWZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgYWRkKHByZWZpeCwgdik7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBhcnJheSBpdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMKICAgICAgICAgICAgICAgICAgICAvLyBudW1lcmljIGluZGV4IHRvIHJlc29sdmUgZGVzZXJpYWxpemF0aW9uIGFtYmlndWl0eSBpc3N1ZXMuCiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKICAgICAgICAgICAgICAgICAgICAvLyBuZXN0ZWQgYXJyYXlzIHByb3Blcmx5LCBhbmQgYXR0ZW1wdGluZyB0byBkbyBzbyBtYXkgY2F1c2UKICAgICAgICAgICAgICAgICAgICAvLyBhIHNlcnZlciBlcnJvci4gUG9zc2libGUgZml4ZXMgYXJlIHRvIG1vZGlmeSByYWNrJ3MKICAgICAgICAgICAgICAgICAgICAvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKICAgICAgICAgICAgICAgICAgICAvLyB0byBmb3JjZSBhcnJheSBzZXJpYWxpemF0aW9uIHRvIGJlIHNoYWxsb3cuCiAgICAgICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgPyBpIDogIiIgKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9IGVsc2UgaWYgKCF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZShvYmopID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbIG5hbWUgXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgogICAgICAgICAgICBhZGQocHJlZml4LCBvYmopOwogICAgICAgIH0KICAgIH0KCi8vIFRoaXMgaXMgc3RpbGwgb24gdGhlIGpRdWVyeSBvYmplY3QuLi4gZm9yIG5vdwovLyBXYW50IHRvIG1vdmUgdGhpcyB0byBqUXVlcnkuYWpheCBzb21lIGRheQogICAgalF1ZXJ5LmV4dGVuZCh7CgogICAgICAgIC8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwogICAgICAgIGFjdGl2ZTogMCwKCiAgICAgICAgLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAogICAgICAgIGxhc3RNb2RpZmllZDoge30sCiAgICAgICAgZXRhZzoge30KCiAgICB9KTsKCiAgICAvKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAgICAgKiAtIHNldHMgYWxsIHJlc3BvbnNlWFhYIGZpZWxkcyBhY2NvcmRpbmdseQogICAgICogLSBmaW5kcyB0aGUgcmlnaHQgZGF0YVR5cGUgKG1lZGlhdGVzIGJldHdlZW4gY29udGVudC10eXBlIGFuZCBleHBlY3RlZCBkYXRhVHlwZSkKICAgICAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICAgICovCiAgICBmdW5jdGlvbiBhamF4SGFuZGxlUmVzcG9uc2VzKHMsIGpxWEhSLCByZXNwb25zZXMpIHsKCiAgICAgICAgdmFyIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgICAgICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMsCiAgICAgICAgICAgIHJlc3BvbnNlRmllbGRzID0gcy5yZXNwb25zZUZpZWxkcywKICAgICAgICAgICAgY3QsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGZpbmFsRGF0YVR5cGUsCiAgICAgICAgICAgIGZpcnN0RGF0YVR5cGU7CgogICAgICAgIC8vIEZpbGwgcmVzcG9uc2VYWFggZmllbGRzCiAgICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlRmllbGRzKSB7CiAgICAgICAgICAgIGlmICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgICAgICAgICAganFYSFJbIHJlc3BvbnNlRmllbGRzW3R5cGVdIF0gPSByZXNwb25zZXNbIHR5cGUgXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgICAgICB3aGlsZSAoZGF0YVR5cGVzWyAwIF0gPT09ICIqIikgewogICAgICAgICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGN0ID0gcy5taW1lVHlwZSB8fCBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQogICAgICAgIGlmIChjdCkgewogICAgICAgICAgICBmb3IgKHR5cGUgaW4gY29udGVudHMpIHsKICAgICAgICAgICAgICAgIGlmIChjb250ZW50c1sgdHlwZSBdICYmIGNvbnRlbnRzWyB0eXBlIF0udGVzdChjdCkpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0eXBlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGhhdmUgYSByZXNwb25zZSBmb3IgdGhlIGV4cGVjdGVkIGRhdGFUeXBlCiAgICAgICAgaWYgKGRhdGFUeXBlc1sgMCBdIGluIHJlc3BvbnNlcykgewogICAgICAgICAgICBmaW5hbERhdGFUeXBlID0gZGF0YVR5cGVzWyAwIF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwogICAgICAgICAgICBmb3IgKHR5cGUgaW4gcmVzcG9uc2VzKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRhdGFUeXBlc1sgMCBdIHx8IHMuY29udmVydGVyc1sgdHlwZSArICIgIiArIGRhdGFUeXBlc1swXSBdKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWZpcnN0RGF0YVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBPciBqdXN0IHVzZSBmaXJzdCBvbmUKICAgICAgICAgICAgZmluYWxEYXRhVHlwZSA9IGZpbmFsRGF0YVR5cGUgfHwgZmlyc3REYXRhVHlwZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHdlIGZvdW5kIGEgZGF0YVR5cGUKICAgICAgICAvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAogICAgICAgIC8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICAgICAgICBpZiAoZmluYWxEYXRhVHlwZSkgewogICAgICAgICAgICBpZiAoZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWyAwIF0pIHsKICAgICAgICAgICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KGZpbmFsRGF0YVR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKICAgICAgICB9CiAgICB9CgovLyBDaGFpbiBjb252ZXJzaW9ucyBnaXZlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIG9yaWdpbmFsIHJlc3BvbnNlCiAgICBmdW5jdGlvbiBhamF4Q29udmVydChzLCByZXNwb25zZSkgewoKICAgICAgICAvLyBBcHBseSB0aGUgZGF0YUZpbHRlciBpZiBwcm92aWRlZAogICAgICAgIGlmIChzLmRhdGFGaWx0ZXIpIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIocmVzcG9uc2UsIHMuZGF0YVR5cGUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLAogICAgICAgICAgICBjb252ZXJ0ZXJzID0ge30sCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgbGVuZ3RoID0gZGF0YVR5cGVzLmxlbmd0aCwKICAgICAgICAgICAgdG1wLAogICAgICAgIC8vIEN1cnJlbnQgYW5kIHByZXZpb3VzIGRhdGFUeXBlcwogICAgICAgICAgICBjdXJyZW50ID0gZGF0YVR5cGVzWyAwIF0sCiAgICAgICAgICAgIHByZXYsCiAgICAgICAgLy8gQ29udmVyc2lvbiBleHByZXNzaW9uCiAgICAgICAgICAgIGNvbnZlcnNpb24sCiAgICAgICAgLy8gQ29udmVyc2lvbiBmdW5jdGlvbgogICAgICAgICAgICBjb252LAogICAgICAgIC8vIENvbnZlcnNpb24gZnVuY3Rpb25zICh0cmFuc2l0aXZlIGNvbnZlcnNpb24pCiAgICAgICAgICAgIGNvbnYxLAogICAgICAgICAgICBjb252MjsKCiAgICAgICAgLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGNoYWluCiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAvLyBDcmVhdGUgY29udmVydGVycyBtYXAKICAgICAgICAgICAgLy8gd2l0aCBsb3dlcmNhc2VkIGtleXMKICAgICAgICAgICAgaWYgKGkgPT09IDEpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIHMuY29udmVydGVycykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdID0gcy5jb252ZXJ0ZXJzWyBrZXkgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdldCB0aGUgZGF0YVR5cGVzCiAgICAgICAgICAgIHByZXYgPSBjdXJyZW50OwogICAgICAgICAgICBjdXJyZW50ID0gZGF0YVR5cGVzWyBpIF07CgogICAgICAgICAgICAvLyBJZiBjdXJyZW50IGlzIGF1dG8gZGF0YVR5cGUsIHVwZGF0ZSBpdCB0byBwcmV2CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSAiKiIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwcmV2OwogICAgICAgICAgICAgICAgLy8gSWYgbm8gYXV0byBhbmQgZGF0YVR5cGVzIGFyZSBhY3R1YWxseSBkaWZmZXJlbnQKICAgICAgICAgICAgfSBlbHNlIGlmIChwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCkgewoKICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgY29udmVydGVyCiAgICAgICAgICAgICAgICBjb252ZXJzaW9uID0gcHJldiArICIgIiArIGN1cnJlbnQ7CiAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1sgY29udmVyc2lvbiBdIHx8IGNvbnZlcnRlcnNbICIqICIgKyBjdXJyZW50IF07CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gZGlyZWN0IGNvbnZlcnRlciwgc2VhcmNoIHRyYW5zaXRpdmVseQogICAgICAgICAgICAgICAgaWYgKCFjb252KSB7CiAgICAgICAgICAgICAgICAgICAgY29udjIgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb252MSBpbiBjb252ZXJ0ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IGNvbnYxLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBbIDAgXSA9PT0gcHJldiB8fCB0bXBbIDAgXSA9PT0gIioiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252MiA9IGNvbnZlcnRlcnNbIHRtcFsxXSArICIgIiArIGN1cnJlbnQgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb252MikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnYxID0gY29udmVydGVyc1sgY29udjEgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udjEgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udiA9IGNvbnYyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udjIgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udiA9IGNvbnYxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIHdlIGZvdW5kIG5vIGNvbnZlcnRlciwgZGlzcGF0Y2ggYW4gZXJyb3IKICAgICAgICAgICAgICAgIGlmICghKCBjb252IHx8IGNvbnYyICkpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZXJyb3IoIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgY29udmVyc2lvbi5yZXBsYWNlKCIgIiwgIiB0byAiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJZiBmb3VuZCBjb252ZXJ0ZXIgaXMgbm90IGFuIGVxdWl2YWxlbmNlCiAgICAgICAgICAgICAgICBpZiAoY29udiAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgd2l0aCAxIG9yIDIgY29udmVydGVycyBhY2NvcmRpbmdseQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gY29udiA/IGNvbnYocmVzcG9uc2UpIDogY29udjIoY29udjEocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICB9CgoKICAgIHZhciBqc2MgPSBqUXVlcnkubm93KCksCiAgICAgICAganNyZSA9IC8oXD0pXD8oJnwkKXxcP1w/L2k7CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgICBqUXVlcnkuYWpheFNldHVwKHsKICAgICAgICBqc29ucDogImNhbGxiYWNrIiwKICAgICAgICBqc29ucENhbGxiYWNrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZXhwYW5kbyArICJfIiArICgganNjKysgKTsKICAgICAgICB9CiAgICB9KTsKCi8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cwogICAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoImpzb24ganNvbnAiLCBmdW5jdGlvbiAocywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIpIHsKCiAgICAgICAgdmFyIGluc3BlY3REYXRhID0gKCB0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiApICYmIC9eYXBwbGljYXRpb25cL3hcLXd3d1wtZm9ybVwtdXJsZW5jb2RlZC8udGVzdChzLmNvbnRlbnRUeXBlKTsKCiAgICAgICAgaWYgKHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgfHwKICAgICAgICAgICAgcy5qc29ucCAhPT0gZmFsc2UgJiYgKCBqc3JlLnRlc3Qocy51cmwpIHx8CiAgICAgICAgICAgICAgICBpbnNwZWN0RGF0YSAmJiBqc3JlLnRlc3Qocy5kYXRhKSApKSB7CgogICAgICAgICAgICB2YXIgcmVzcG9uc2VDb250YWluZXIsCiAgICAgICAgICAgICAgICBqc29ucENhbGxiYWNrID0gcy5qc29ucENhbGxiYWNrID0KICAgICAgICAgICAgICAgICAgICBqUXVlcnkuaXNGdW5jdGlvbihzLmpzb25wQ2FsbGJhY2spID8gcy5qc29ucENhbGxiYWNrKCkgOiBzLmpzb25wQ2FsbGJhY2ssCiAgICAgICAgICAgICAgICBwcmV2aW91cyA9IHdpbmRvd1sganNvbnBDYWxsYmFjayBdLAogICAgICAgICAgICAgICAgdXJsID0gcy51cmwsCiAgICAgICAgICAgICAgICBkYXRhID0gcy5kYXRhLAogICAgICAgICAgICAgICAgcmVwbGFjZSA9ICIkMSIgKyBqc29ucENhbGxiYWNrICsgIiQyIjsKCiAgICAgICAgICAgIGlmIChzLmpzb25wICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoanNyZSwgcmVwbGFjZSk7CiAgICAgICAgICAgICAgICBpZiAocy51cmwgPT09IHVybCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbnNwZWN0RGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKGpzcmUsIHJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAocy5kYXRhID09PSBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFkZCBjYWxsYmFjayBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICB1cmwgKz0gKC9cPy8udGVzdCh1cmwpID8gIiYiIDogIj8iKSArIHMuanNvbnAgKyAiPSIgKyBqc29ucENhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcy51cmwgPSB1cmw7CiAgICAgICAgICAgIHMuZGF0YSA9IGRhdGE7CgogICAgICAgICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrCiAgICAgICAgICAgIHdpbmRvd1sganNvbnBDYWxsYmFjayBdID0gZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUNvbnRhaW5lciA9IFsgcmVzcG9uc2UgXTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIENsZWFuLXVwIGZ1bmN0aW9uCiAgICAgICAgICAgIGpxWEhSLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBTZXQgY2FsbGJhY2sgYmFjayB0byBwcmV2aW91cyB2YWx1ZQogICAgICAgICAgICAgICAgd2luZG93WyBqc29ucENhbGxiYWNrIF0gPSBwcmV2aW91czsKICAgICAgICAgICAgICAgIC8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlQ29udGFpbmVyICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHByZXZpb3VzKSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvd1sganNvbnBDYWxsYmFjayBdKHJlc3BvbnNlQ29udGFpbmVyWyAwIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KICAgICAgICAgICAgcy5jb252ZXJ0ZXJzWyJzY3JpcHQganNvbiJdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lcnJvcihqc29ucENhbGxiYWNrICsgIiB3YXMgbm90IGNhbGxlZCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBmb3JjZSBqc29uIGRhdGFUeXBlCiAgICAgICAgICAgIHMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgogICAgICAgICAgICAvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKICAgICAgICAgICAgcmV0dXJuICJzY3JpcHQiOwogICAgICAgIH0KICAgIH0pOwoKCi8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCiAgICBqUXVlcnkuYWpheFNldHVwKHsKICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgogICAgICAgIH0sCiAgICAgICAgY29udGVudHM6IHsKICAgICAgICAgICAgc2NyaXB0OiAvamF2YXNjcmlwdHxlY21hc2NyaXB0LwogICAgICAgIH0sCiAgICAgICAgY29udmVydGVyczogewogICAgICAgICAgICAidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwodGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBnbG9iYWwKICAgIGpRdWVyeS5hamF4UHJlZmlsdGVyKCJzY3JpcHQiLCBmdW5jdGlvbiAocykgewogICAgICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAocy5jcm9zc0RvbWFpbikgewogICAgICAgICAgICBzLnR5cGUgPSAiR0VUIjsKICAgICAgICAgICAgcy5nbG9iYWwgPSBmYWxzZTsKICAgICAgICB9CiAgICB9KTsKCi8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogICAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoInNjcmlwdCIsIGZ1bmN0aW9uIChzKSB7CgogICAgICAgIC8vIFRoaXMgdHJhbnNwb3J0IG9ubHkgZGVhbHMgd2l0aCBjcm9zcyBkb21haW4gcmVxdWVzdHMKICAgICAgICBpZiAocy5jcm9zc0RvbWFpbikgewoKICAgICAgICAgICAgdmFyIHNjcmlwdCwKICAgICAgICAgICAgICAgIGhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgcmV0dXJuIHsKCiAgICAgICAgICAgICAgICBzZW5kOiBmdW5jdGlvbiAoXywgY2FsbGJhY2spIHsKCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgogICAgICAgICAgICAgICAgICAgIHNjcmlwdC5hc3luYyA9ICJhc3luYyI7CgogICAgICAgICAgICAgICAgICAgIGlmIChzLnNjcmlwdENoYXJzZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0LmNoYXJzZXQgPSBzLnNjcmlwdENoYXJzZXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzY3JpcHQuc3JjID0gcy51cmw7CgogICAgICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBoYW5kbGVycyBmb3IgYWxsIGJyb3dzZXJzCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoXywgaXNBYm9ydCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQWJvcnQgfHwgIXNjcmlwdC5yZWFkeVN0YXRlIHx8IC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIG1lbW9yeSBsZWFrIGluIElFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBzY3JpcHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkICYmIHNjcmlwdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlcmVmZXJlbmNlIHRoZSBzY3JpcHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxsYmFjayBpZiBub3QgYWJvcnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNBYm9ydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKDIwMCwgInN1Y2Nlc3MiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgLy8gVXNlIGluc2VydEJlZm9yZSBpbnN0ZWFkIG9mIGFwcGVuZENoaWxkICB0byBjaXJjdW12ZW50IGFuIElFNiBidWcuCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBhcmlzZXMgd2hlbiBhIGJhc2Ugbm9kZSBpcyB1c2VkICgjMjcwOSBhbmQgIzQzNzgpLgogICAgICAgICAgICAgICAgICAgIGhlYWQuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgaGVhZC5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQoMCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKCiAgICB2YXIgLy8gIzUyODA6IEludGVybmV0IEV4cGxvcmVyIHdpbGwga2VlcCBjb25uZWN0aW9ucyBhbGl2ZSBpZiB3ZSBkb24ndCBhYm9ydCBvbiB1bmxvYWQKICAgICAgICB4aHJPblVubG9hZEFib3J0ID0gd2luZG93LkFjdGl2ZVhPYmplY3QgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIEFib3J0IGFsbCBwZW5kaW5nIHJlcXVlc3RzCiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB4aHJDYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgIHhockNhbGxiYWNrc1sga2V5IF0oMCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IDogZmFsc2UsCiAgICAgICAgeGhySWQgPSAwLAogICAgICAgIHhockNhbGxiYWNrczsKCi8vIEZ1bmN0aW9ucyB0byBjcmVhdGUgeGhycwogICAgZnVuY3Rpb24gY3JlYXRlU3RhbmRhcmRYSFIoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUFjdGl2ZVhIUigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICB9CgovLyBDcmVhdGUgdGhlIHJlcXVlc3Qgb2JqZWN0Ci8vIChUaGlzIGlzIHN0aWxsIGF0dGFjaGVkIHRvIGFqYXhTZXR0aW5ncyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gd2luZG93LkFjdGl2ZVhPYmplY3QgPwogICAgICAgIC8qIE1pY3Jvc29mdCBmYWlsZWQgdG8gcHJvcGVybHkKICAgICAgICAgKiBpbXBsZW1lbnQgdGhlIFhNTEh0dHBSZXF1ZXN0IGluIElFNyAoY2FuJ3QgcmVxdWVzdCBsb2NhbCBmaWxlcyksCiAgICAgICAgICogc28gd2UgdXNlIHRoZSBBY3RpdmVYT2JqZWN0IHdoZW4gaXQgaXMgYXZhaWxhYmxlCiAgICAgICAgICogQWRkaXRpb25hbGx5IFhNTEh0dHBSZXF1ZXN0IGNhbiBiZSBkaXNhYmxlZCBpbiBJRTcvSUU4IHNvCiAgICAgICAgICogd2UgbmVlZCBhIGZhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aGlzLmlzTG9jYWwgJiYgY3JlYXRlU3RhbmRhcmRYSFIoKSB8fCBjcmVhdGVBY3RpdmVYSFIoKTsKICAgICAgICB9IDoKICAgICAgICAvLyBGb3IgYWxsIG90aGVyIGJyb3dzZXJzLCB1c2UgdGhlIHN0YW5kYXJkIFhNTEh0dHBSZXF1ZXN0IG9iamVjdAogICAgICAgIGNyZWF0ZVN0YW5kYXJkWEhSOwoKLy8gRGV0ZXJtaW5lIHN1cHBvcnQgcHJvcGVydGllcwogICAgKGZ1bmN0aW9uICh4aHIpIHsKICAgICAgICBqUXVlcnkuZXh0ZW5kKGpRdWVyeS5zdXBwb3J0LCB7CiAgICAgICAgICAgIGFqYXg6ICEheGhyLAogICAgICAgICAgICBjb3JzOiAhIXhociAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhociApCiAgICAgICAgfSk7CiAgICB9KShqUXVlcnkuYWpheFNldHRpbmdzLnhocigpKTsKCi8vIENyZWF0ZSB0cmFuc3BvcnQgaWYgdGhlIGJyb3dzZXIgY2FuIHByb3ZpZGUgYW4geGhyCiAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuYWpheCkgewoKICAgICAgICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiAocykgewogICAgICAgICAgICAvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CiAgICAgICAgICAgIGlmICghcy5jcm9zc0RvbWFpbiB8fCBqUXVlcnkuc3VwcG9ydC5jb3JzKSB7CgogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwoKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBHZXQgYSBuZXcgeGhyCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4aHIgPSBzLnhocigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9wZW4gdGhlIHNvY2tldAogICAgICAgICAgICAgICAgICAgICAgICAvLyBQYXNzaW5nIG51bGwgdXNlcm5hbWUsIGdlbmVyYXRlcyBhIGxvZ2luIHBvcHVwIG9uIE9wZXJhICgjMjg2NSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMudXNlcm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5vcGVuKHMudHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLm9wZW4ocy50eXBlLCBzLnVybCwgcy5hc3luYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMueGhyRmllbGRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgaW4gcy54aHJGaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHJbIGkgXSA9IHMueGhyRmllbGRzWyBpIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKHMubWltZVR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBYLVJlcXVlc3RlZC1XaXRoIGhlYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIChpdCBjYW4gYWx3YXlzIGJlIHNldCBvbiBhIHBlci1yZXF1ZXN0IGJhc2lzIG9yIGV2ZW4gdXNpbmcgYWpheFNldHVwKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdID0gIlhNTEh0dHBSZXF1ZXN0IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmVlZCBhbiBleHRyYSB0cnkvY2F0Y2ggZm9yIGNyb3NzIGRvbWFpbiByZXF1ZXN0cyBpbiBGaXJlZm94IDMKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoaSwgaGVhZGVyc1sgaSBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEbyBzZW5kIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbiB3aGljaCBpcyBhY3R1YWxseQogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKICAgICAgICAgICAgICAgICAgICAgICAgeGhyLnNlbmQoKCBzLmhhc0NvbnRlbnQgJiYgcy5kYXRhICkgfHwgbnVsbCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBMaXN0ZW5lcgogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uIChfLCBpc0Fib3J0KSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNUZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggdGhyb3dzIGV4Y2VwdGlvbnMgd2hlbiBhY2Nlc3NpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb2YgYW4geGhyIHdoZW4gYSBuZXR3b3JrIGVycm9yIG9jY3VyZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9oZWxwZnVsLmtub2JzLWRpYWxzLmNvbS9pbmRleC5waHAvQ29tcG9uZW50X3JldHVybmVkX2ZhaWx1cmVfY29kZTpfMHg4MDA0MDExMV8oTlNfRVJST1JfTk9UX0FWQUlMQUJMRSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgJiYgKCBpc0Fib3J0IHx8IHhoci5yZWFkeVN0YXRlID09PSA0ICkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgY2FsbGVkIG9uY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEbyBub3Qga2VlcCBhcyBhY3RpdmUgYW55bW9yZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0galF1ZXJ5Lm5vb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyT25VbmxvYWRBYm9ydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB4aHJDYWxsYmFja3NbIGhhbmRsZSBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCdzIGFuIGFib3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Fib3J0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBYm9ydCBpdCBtYW51YWxseSBpZiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSAhPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0geGhyLnN0YXR1czsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9IHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0geGhyLnJlc3BvbnNlWE1MOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbnN0cnVjdCByZXNwb25zZSBsaXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeG1sICYmIHhtbC5kb2N1bWVudEVsZW1lbnQgLyogIzQ5NTggKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZXMueG1sID0geG1sOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU2LTkgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQgKCMxMTQyNikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VzLnRleHQgPSB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggdGhyb3dzIGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RhdHVzVGV4dCBmb3IgZmF1bHR5IGNyb3NzLWRvbWFpbiByZXF1ZXN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2Ugbm9ybWFsaXplIHdpdGggV2Via2l0IGdpdmluZyBhbiBlbXB0eSBzdGF0dXNUZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbHRlciBzdGF0dXMgZm9yIG5vbiBzdGFuZGFyZCBiZWhhdmlvcnMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmVxdWVzdCBpcyBsb2NhbCBhbmQgd2UgaGF2ZSBkYXRhOiBhc3N1bWUgYSBzdWNjZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAoc3VjY2VzcyB3aXRoIG5vIGRhdGEgd29uJ3QgZ2V0IG5vdGlmaWVkLCB0aGF0J3MgdGhlIGJlc3Qgd2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbiBkbyBnaXZlbiBjdXJyZW50IGltcGxlbWVudGF0aW9ucykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdHVzICYmIHMuaXNMb2NhbCAmJiAhcy5jcm9zc0RvbWFpbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlcy50ZXh0ID8gMjAwIDogNDA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIC0gIzE0NTA6IHNvbWV0aW1lcyByZXR1cm5zIDEyMjMgd2hlbiBpdCBzaG91bGQgYmUgMjA0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMTIyMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IDIwNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWJvcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGUoLTEsIGZpcmVmb3hBY2Nlc3NFeGNlcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIGNvbXBsZXRlIGlmIG5lZWRlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKHN0YXR1cywgc3RhdHVzVGV4dCwgcmVzcG9uc2VzLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIG9yIGl0J3MgaW4gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGhhcyBiZWVuIHJldHJpZXZlZCBkaXJlY3RseSAoSUU2ICYgSUU3KQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIG1hbnVhbGx5IGZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5hc3luYyB8fCB4aHIucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZSA9ICsreGhySWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyT25VbmxvYWRBYm9ydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgYWN0aXZlIHhocnMgY2FsbGJhY2tzIGxpc3QgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGF0dGFjaCB0aGUgdW5sb2FkIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXhockNhbGxiYWNrcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHJDYWxsYmFja3MgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHdpbmRvdykudW5sb2FkKHhock9uVW5sb2FkQWJvcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBZGQgdG8gbGlzdCBvZiBhY3RpdmUgeGhycyBjYWxsYmFja3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHJDYWxsYmFja3NbIGhhbmRsZSBdID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKCiAgICB2YXIgZWxlbWRpc3BsYXkgPSB7fSwKICAgICAgICBpZnJhbWUsIGlmcmFtZURvYywKICAgICAgICByZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKICAgICAgICByZnhudW0gPSAvXihbK1wtXT0pPyhbXGQrLlwtXSspKFthLXolXSopJC9pLAogICAgICAgIHRpbWVySWQsCiAgICAgICAgZnhBdHRycyA9IFsKICAgICAgICAgICAgLy8gaGVpZ2h0IGFuaW1hdGlvbnMKICAgICAgICAgICAgWyAiaGVpZ2h0IiwgIm1hcmdpblRvcCIsICJtYXJnaW5Cb3R0b20iLCAicGFkZGluZ1RvcCIsICJwYWRkaW5nQm90dG9tIiBdLAogICAgICAgICAgICAvLyB3aWR0aCBhbmltYXRpb25zCiAgICAgICAgICAgIFsgIndpZHRoIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiBdLAogICAgICAgICAgICAvLyBvcGFjaXR5IGFuaW1hdGlvbnMKICAgICAgICAgICAgWyAib3BhY2l0eSIgXQogICAgICAgIF0sCiAgICAgICAgZnhOb3c7CgogICAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAgICAgc2hvdzogZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBlbGVtLCBkaXNwbGF5OwoKICAgICAgICAgICAgaWYgKHNwZWVkIHx8IHNwZWVkID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRlKGdlbkZ4KCJzaG93IiwgMyksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHRoaXMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0uc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRoZSBpbmxpbmUgZGlzcGxheSBvZiB0aGlzIGVsZW1lbnQgdG8gbGVhcm4gaWYgaXQgaXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVpbmcgaGlkZGVuIGJ5IGNhc2NhZGVkIHJ1bGVzIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWpRdWVyeS5fZGF0YShlbGVtLCAib2xkZGlzcGxheSIpICYmIGRpc3BsYXkgPT09ICJub25lIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBzdWNoIGFuIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChkaXNwbGF5ID09PSAiIiAmJiBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IikgPT09ICJub25lIikgfHwgIWpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBlbGVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9kYXRhKGVsZW0sICJvbGRkaXNwbGF5IiwgZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCiAgICAgICAgICAgICAgICAvLyB0byBhdm9pZCB0aGUgY29uc3RhbnQgcmVmbG93CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbIGkgXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0uc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwbGF5ID09PSAiIiB8fCBkaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9IGpRdWVyeS5fZGF0YShlbGVtLCAib2xkZGlzcGxheSIpIHx8ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaGlkZTogZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChzcGVlZCB8fCBzcGVlZCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShnZW5GeCgiaGlkZSIsIDMpLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGVsZW0sIGRpc3BsYXksCiAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgaiA9IHRoaXMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0uc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSA9IGpRdWVyeS5jc3MoZWxlbSwgImRpc3BsYXkiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwbGF5ICE9PSAibm9uZSIgJiYgIWpRdWVyeS5fZGF0YShlbGVtLCAib2xkZGlzcGxheSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoZWxlbSwgIm9sZGRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGRpc3BsYXkgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKICAgICAgICAgICAgICAgIC8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1tpXS5zdHlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2F2ZSB0aGUgb2xkIHRvZ2dsZSBmdW5jdGlvbgogICAgICAgIF90b2dnbGU6IGpRdWVyeS5mbi50b2dnbGUsCgogICAgICAgIHRvZ2dsZTogZnVuY3Rpb24gKGZuLCBmbjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBib29sID0gdHlwZW9mIGZuID09PSAiYm9vbGVhbiI7CgogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oZm4pICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGZuMikpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3RvZ2dsZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChmbiA9PSBudWxsIHx8IGJvb2wpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gYm9vbCA/IGZuIDogalF1ZXJ5KHRoaXMpLmlzKCI6aGlkZGVuIik7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpWyBzdGF0ZSA/ICJzaG93IiA6ICJoaWRlIiBdKCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGUoZ2VuRngoInRvZ2dsZSIsIDMpLCBmbiwgZm4yLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGZhZGVUbzogZnVuY3Rpb24gKHNwZWVkLCB0bywgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXIoIjpoaWRkZW4iKS5jc3MoIm9wYWNpdHkiLCAwKS5zaG93KCkuZW5kKCkKICAgICAgICAgICAgICAgIC5hbmltYXRlKHtvcGFjaXR5OiB0b30sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICBhbmltYXRlOiBmdW5jdGlvbiAocHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIG9wdGFsbCA9IGpRdWVyeS5zcGVlZChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CgogICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRW1wdHlPYmplY3QocHJvcCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2gob3B0YWxsLmNvbXBsZXRlLCBbIGZhbHNlIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBEbyBub3QgY2hhbmdlIHJlZmVyZW5jZWQgcHJvcGVydGllcyBhcyBwZXItcHJvcGVydHkgZWFzaW5nIHdpbGwgYmUgbG9zdAogICAgICAgICAgICBwcm9wID0galF1ZXJ5LmV4dGVuZCh7fSwgcHJvcCk7CgogICAgICAgICAgICBmdW5jdGlvbiBkb0FuaW1hdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vIFhYWCAndGhpcycgZG9lcyBub3QgYWx3YXlzIGhhdmUgYSBub2RlTmFtZSB3aGVuIHJ1bm5pbmcgdGhlCiAgICAgICAgICAgICAgICAvLyB0ZXN0IHN1aXRlCgogICAgICAgICAgICAgICAgaWYgKG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX21hcmsodGhpcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG9wdCA9IGpRdWVyeS5leHRlbmQoe30sIG9wdGFsbCksCiAgICAgICAgICAgICAgICAgICAgaXNFbGVtZW50ID0gdGhpcy5ub2RlVHlwZSA9PT0gMSwKICAgICAgICAgICAgICAgICAgICBoaWRkZW4gPSBpc0VsZW1lbnQgJiYgalF1ZXJ5KHRoaXMpLmlzKCI6aGlkZGVuIiksCiAgICAgICAgICAgICAgICAgICAgbmFtZSwgdmFsLCBwLCBlLCBob29rcywgcmVwbGFjZSwKICAgICAgICAgICAgICAgICAgICBwYXJ0cywgc3RhcnQsIGVuZCwgdW5pdCwKICAgICAgICAgICAgICAgICAgICBtZXRob2Q7CgogICAgICAgICAgICAgICAgLy8gd2lsbCBzdG9yZSBwZXIgcHJvcGVydHkgZWFzaW5nIGFuZCBiZSB1c2VkIHRvIGRldGVybWluZSB3aGVuIGFuIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICAgICAgICAgb3B0LmFuaW1hdGVkUHJvcGVydGllcyA9IHt9OwoKICAgICAgICAgICAgICAgIC8vIGZpcnN0IHBhc3Mgb3ZlciBwcm9wZXJ0eXMgdG8gZXhwYW5kIC8gbm9ybWFsaXplCiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gcHJvcCkgewogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKHApOwogICAgICAgICAgICAgICAgICAgIGlmIChwICE9PSBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BbIG5hbWUgXSA9IHByb3BbIHAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHByb3BbIHAgXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgoIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gKSAmJiAiZXhwYW5kIiBpbiBob29rcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlID0gaG9va3MuZXhwYW5kKHByb3BbIG5hbWUgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwcm9wWyBuYW1lIF07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29udCBvdmVyd3JpdGUga2V5cyBhbHJlYWR5IHByZXNlbnQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsc28gLSByZXVzaW5nICdwJyBmcm9tIGFib3ZlIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgY29ycmVjdCAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChwIGluIHJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKCBwIGluIHByb3AgKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BbIHAgXSA9IHJlcGxhY2VbIHAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gcHJvcCkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHByb3BbIG5hbWUgXTsKICAgICAgICAgICAgICAgICAgICAvLyBlYXNpbmcgcmVzb2x1dGlvbjogcGVyIHByb3BlcnR5ID4gb3B0LnNwZWNpYWxFYXNpbmcgPiBvcHQuZWFzaW5nID4gJ3N3aW5nJyAoZGVmYXVsdCkKICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBvcHQuYW5pbWF0ZWRQcm9wZXJ0aWVzWyBuYW1lIF0gPSB2YWxbIDEgXTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gcHJvcFsgbmFtZSBdID0gdmFsWyAwIF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmFuaW1hdGVkUHJvcGVydGllc1sgbmFtZSBdID0gb3B0LnNwZWNpYWxFYXNpbmcgJiYgb3B0LnNwZWNpYWxFYXNpbmdbIG5hbWUgXSB8fCBvcHQuZWFzaW5nIHx8ICdzd2luZyc7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09PSAiaGlkZSIgJiYgaGlkZGVuIHx8IHZhbCA9PT0gInNob3ciICYmICFoaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdC5jb21wbGV0ZS5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRWxlbWVudCAmJiAoIG5hbWUgPT09ICJoZWlnaHQiIHx8IG5hbWUgPT09ICJ3aWR0aCIgKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBub3RoaW5nIHNuZWFrcyBvdXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGFuZ2UgdGhlIG92ZXJmbG93IGF0dHJpYnV0ZSB3aGVuIG92ZXJmbG93WCBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3ZlcmZsb3dZIGFyZSBzZXQgdG8gdGhlIHNhbWUgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgb3B0Lm92ZXJmbG93ID0gWyB0aGlzLnN0eWxlLm92ZXJmbG93LCB0aGlzLnN0eWxlLm92ZXJmbG93WCwgdGhpcy5zdHlsZS5vdmVyZmxvd1kgXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCBkaXNwbGF5IHByb3BlcnR5IHRvIGlubGluZS1ibG9jayBmb3IgaGVpZ2h0L3dpZHRoCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5jc3ModGhpcywgImRpc3BsYXkiKSA9PT0gImlubGluZSIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jc3ModGhpcywgImZsb2F0IikgPT09ICJub25lIikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlubGluZS1sZXZlbCBlbGVtZW50cyBhY2NlcHQgaW5saW5lLWJsb2NrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghalF1ZXJ5LnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBkZWZhdWx0RGlzcGxheSh0aGlzLm5vZGVOYW1lKSA9PT0gImlubGluZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUuem9vbSA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdC5vdmVyZmxvdyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAocCBpbiBwcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgZSA9IG5ldyBqUXVlcnkuZngodGhpcywgb3B0LCBwKTsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBwcm9wWyBwIF07CgogICAgICAgICAgICAgICAgICAgIGlmIChyZnh0eXBlcy50ZXN0KHZhbCkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYWNrcyB3aGV0aGVyIHRvIHNob3cgb3IgaGlkZSBiYXNlZCBvbiBwcml2YXRlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGEgYXR0YWNoZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kID0galF1ZXJ5Ll9kYXRhKHRoaXMsICJ0b2dnbGUiICsgcCkgfHwgKCB2YWwgPT09ICJ0b2dnbGUiID8gaGlkZGVuID8gInNob3ciIDogImhpZGUiIDogMCApOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEodGhpcywgInRvZ2dsZSIgKyBwLCBtZXRob2QgPT09ICJzaG93IiA/ICJoaWRlIiA6ICJzaG93Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlWyBtZXRob2QgXSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZVsgdmFsIF0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IHJmeG51bS5leGVjKHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZS5jdXIoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gcGFyc2VGbG9hdChwYXJ0c1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ID0gcGFydHNbM10gfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBwIF0gPyAiIiA6ICJweCIgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bml0ICE9PSAicHgiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKHRoaXMsIHAsIChlbmQgfHwgMSkgKyB1bml0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9ICggKGVuZCB8fCAxKSAvIGUuY3VyKCkgKSAqIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5zdHlsZSh0aGlzLCBwLCBzdGFydCArIHVuaXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnRzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gKCAocGFydHNbIDEgXSA9PT0gIi09IiA/IC0xIDogMSkgKiBlbmQgKSArIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuY3VzdG9tKHN0YXJ0LCBlbmQsIHVuaXQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuY3VzdG9tKHN0YXJ0LCB2YWwsICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBGb3IgSlMgc3RyaWN0IGNvbXBsaWFuY2UKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3B0YWxsLnF1ZXVlID09PSBmYWxzZSA/CiAgICAgICAgICAgICAgICB0aGlzLmVhY2goZG9BbmltYXRpb24pIDoKICAgICAgICAgICAgICAgIHRoaXMucXVldWUob3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbik7CiAgICAgICAgfSwKCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgZ290b0VuZCA9IGNsZWFyUXVldWU7CiAgICAgICAgICAgICAgICBjbGVhclF1ZXVlID0gdHlwZTsKICAgICAgICAgICAgICAgIHR5cGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMucXVldWUodHlwZSB8fCAiZngiLCBbXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4LAogICAgICAgICAgICAgICAgICAgIGhhZFRpbWVycyA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGpRdWVyeS5fZGF0YSh0aGlzKTsKCiAgICAgICAgICAgICAgICAvLyBjbGVhciBtYXJrZXIgY291bnRlcnMgaWYgd2Uga25vdyB0aGV5IHdvbid0IGJlCiAgICAgICAgICAgICAgICBpZiAoIWdvdG9FbmQpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX3VubWFyayh0cnVlLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzdG9wUXVldWUoZWxlbSwgZGF0YSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaG9va3MgPSBkYXRhWyBpbmRleCBdOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVEYXRhKGVsZW0sIGluZGV4LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBob29rcy5zdG9wKGdvdG9FbmQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIGluZGV4LmluZGV4T2YoIi5ydW4iKSA9PT0gaW5kZXgubGVuZ3RoIC0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFF1ZXVlKHRoaXMsIGRhdGEsIGluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YVsgaW5kZXggPSB0eXBlICsgIi5ydW4iIF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgc3RvcFF1ZXVlKHRoaXMsIGRhdGEsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb3RvRW5kKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yY2UgdGhlIG5leHQgc3RlcCB0byBiZSB0aGUgbGFzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzWyBpbmRleCBdKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzWyBpbmRleCBdLnNhdmVTdGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhZFRpbWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCiAgICAgICAgICAgICAgICAvLyB0aW1lcnMgY3VycmVudGx5IHdpbGwgY2FsbCB0aGVpciBjb21wbGV0ZSBjYWxsYmFja3MsIHdoaWNoIHdpbGwgZGVxdWV1ZQogICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgaWYgdGhleSB3ZXJlIGdvdG9FbmQKICAgICAgICAgICAgICAgIGlmICghKCBnb3RvRW5kICYmIGhhZFRpbWVycyApKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICB9KTsKCi8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKICAgIGZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewogICAgICAgIHNldFRpbWVvdXQoY2xlYXJGeE5vdywgMCk7CiAgICAgICAgcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhckZ4Tm93KCkgewogICAgICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogICAgfQoKLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KICAgIGZ1bmN0aW9uIGdlbkZ4KHR5cGUsIG51bSkgewogICAgICAgIHZhciBvYmogPSB7fTsKCiAgICAgICAgalF1ZXJ5LmVhY2goZnhBdHRycy5jb25jYXQuYXBwbHkoW10sIGZ4QXR0cnMuc2xpY2UoMCwgbnVtKSksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgb2JqWyB0aGlzIF0gPSB0eXBlOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwogICAgalF1ZXJ5LmVhY2goewogICAgICAgIHNsaWRlRG93bjogZ2VuRngoInNob3ciLCAxKSwKICAgICAgICBzbGlkZVVwOiBnZW5GeCgiaGlkZSIsIDEpLAogICAgICAgIHNsaWRlVG9nZ2xlOiBnZW5GeCgidG9nZ2xlIiwgMSksCiAgICAgICAgZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAogICAgICAgIGZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCiAgICAgICAgZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAidG9nZ2xlIiB9CiAgICB9LCBmdW5jdGlvbiAobmFtZSwgcHJvcHMpIHsKICAgICAgICBqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRlKHByb3BzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGpRdWVyeS5leHRlbmQoewogICAgICAgIHNwZWVkOiBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgZm4pIHsKICAgICAgICAgICAgdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKHt9LCBzcGVlZCkgOiB7CiAgICAgICAgICAgICAgICBjb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAogICAgICAgICAgICAgICAgICAgIGpRdWVyeS5pc0Z1bmN0aW9uKHNwZWVkKSAmJiBzcGVlZCwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBzcGVlZCwKICAgICAgICAgICAgICAgIGVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oZWFzaW5nKSAmJiBlYXNpbmcKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgogICAgICAgICAgICAgICAgb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgPyBqUXVlcnkuZnguc3BlZWRzWyBvcHQuZHVyYXRpb24gXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CgogICAgICAgICAgICAvLyBub3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgICAgICAgICAgIGlmIChvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIG9wdC5xdWV1ZSA9ICJmeCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFF1ZXVlaW5nCiAgICAgICAgICAgIG9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgogICAgICAgICAgICBvcHQuY29tcGxldGUgPSBmdW5jdGlvbiAobm9Vbm1hcmspIHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihvcHQub2xkKSkgewogICAgICAgICAgICAgICAgICAgIG9wdC5vbGQuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3B0LnF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgb3B0LnF1ZXVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9Vbm1hcmsgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll91bm1hcmsodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gb3B0OwogICAgICAgIH0sCgogICAgICAgIGVhc2luZzogewogICAgICAgICAgICBsaW5lYXI6IGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3dpbmc6IGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKCAtTWF0aC5jb3MocCAqIE1hdGguUEkpIC8gMiApICsgMC41OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGltZXJzOiBbXSwKCiAgICAgICAgZng6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBwcm9wKSB7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICAgIHRoaXMuZWxlbSA9IGVsZW07CiAgICAgICAgICAgIHRoaXMucHJvcCA9IHByb3A7CgogICAgICAgICAgICBvcHRpb25zLm9yaWcgPSBvcHRpb25zLm9yaWcgfHwge307CiAgICAgICAgfQoKICAgIH0pOwoKICAgIGpRdWVyeS5meC5wcm90b3R5cGUgPSB7CiAgICAgICAgLy8gU2ltcGxlIGZ1bmN0aW9uIGZvciBzZXR0aW5nIGEgc3R5bGUgdmFsdWUKICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zdGVwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAoIGpRdWVyeS5meC5zdGVwWyB0aGlzLnByb3AgXSB8fCBqUXVlcnkuZnguc3RlcC5fZGVmYXVsdCApKHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIC8vIEdldCB0aGUgY3VycmVudCBzaXplCiAgICAgICAgY3VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1bIHRoaXMucHJvcCBdICE9IG51bGwgJiYgKCF0aGlzLmVsZW0uc3R5bGUgfHwgdGhpcy5lbGVtLnN0eWxlWyB0aGlzLnByb3AgXSA9PSBudWxsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbVsgdGhpcy5wcm9wIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYXJzZWQsCiAgICAgICAgICAgICAgICByID0galF1ZXJ5LmNzcyh0aGlzLmVsZW0sIHRoaXMucHJvcCk7CiAgICAgICAgICAgIC8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMCwKICAgICAgICAgICAgLy8gY29tcGxleCB2YWx1ZXMgc3VjaCBhcyAicm90YXRlKDFyYWQpIiBhcmUgcmV0dXJuZWQgYXMgaXMsCiAgICAgICAgICAgIC8vIHNpbXBsZSB2YWx1ZXMgc3VjaCBhcyAiMTBweCIgYXJlIHBhcnNlZCB0byBGbG9hdC4KICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHBhcnNlZCA9IHBhcnNlRmxvYXQocikpID8gIXIgfHwgciA9PT0gImF1dG8iID8gMCA6IHIgOiBwYXJzZWQ7CiAgICAgICAgfSwKCiAgICAgICAgLy8gU3RhcnQgYW4gYW5pbWF0aW9uIGZyb20gb25lIG51bWJlciB0byBhbm90aGVyCiAgICAgICAgY3VzdG9tOiBmdW5jdGlvbiAoZnJvbSwgdG8sIHVuaXQpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgZnggPSBqUXVlcnkuZng7CgogICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCk7CiAgICAgICAgICAgIHRoaXMuZW5kID0gdG87CiAgICAgICAgICAgIHRoaXMubm93ID0gdGhpcy5zdGFydCA9IGZyb207CiAgICAgICAgICAgIHRoaXMucG9zID0gdGhpcy5zdGF0ZSA9IDA7CiAgICAgICAgICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgdGhpcy51bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgdGhpcy5wcm9wIF0gPyAiIiA6ICJweCIgKTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHQoZ290b0VuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuc3RlcChnb3RvRW5kKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdC5xdWV1ZSA9IHRoaXMub3B0aW9ucy5xdWV1ZTsKICAgICAgICAgICAgdC5lbGVtID0gdGhpcy5lbGVtOwogICAgICAgICAgICB0LnNhdmVTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuX2RhdGEoc2VsZi5lbGVtLCAiZnhzaG93IiArIHNlbGYucHJvcCkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuaGlkZSkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoc2VsZi5lbGVtLCAiZnhzaG93IiArIHNlbGYucHJvcCwgc2VsZi5zdGFydCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxmLm9wdGlvbnMuc2hvdykgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuX2RhdGEoc2VsZi5lbGVtLCAiZnhzaG93IiArIHNlbGYucHJvcCwgc2VsZi5lbmQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmICh0KCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKHQpICYmICF0aW1lcklkKSB7CiAgICAgICAgICAgICAgICB0aW1lcklkID0gc2V0SW50ZXJ2YWwoZngudGljaywgZnguaW50ZXJ2YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2ltcGxlICdzaG93JyBmdW5jdGlvbgogICAgICAgIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGRhdGFTaG93ID0galF1ZXJ5Ll9kYXRhKHRoaXMuZWxlbSwgImZ4c2hvdyIgKyB0aGlzLnByb3ApOwoKICAgICAgICAgICAgLy8gUmVtZW1iZXIgd2hlcmUgd2Ugc3RhcnRlZCwgc28gdGhhdCB3ZSBjYW4gZ28gYmFjayB0byBpdCBsYXRlcgogICAgICAgICAgICB0aGlzLm9wdGlvbnMub3JpZ1sgdGhpcy5wcm9wIF0gPSBkYXRhU2hvdyB8fCBqUXVlcnkuc3R5bGUodGhpcy5lbGVtLCB0aGlzLnByb3ApOwogICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2hvdyA9IHRydWU7CgogICAgICAgICAgICAvLyBCZWdpbiB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlIHN0YXJ0IGF0IGEgc21hbGwgd2lkdGgvaGVpZ2h0IHRvIGF2b2lkIGFueSBmbGFzaCBvZiBjb250ZW50CiAgICAgICAgICAgIGlmIChkYXRhU2hvdyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIHNob3cgaXMgcGlja2luZyB1cCB3aGVyZSBhIHByZXZpb3VzIGhpZGUgb3Igc2hvdyBsZWZ0IG9mZgogICAgICAgICAgICAgICAgdGhpcy5jdXN0b20odGhpcy5jdXIoKSwgZGF0YVNob3cpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jdXN0b20odGhpcy5wcm9wID09PSAid2lkdGgiIHx8IHRoaXMucHJvcCA9PT0gImhlaWdodCIgPyAxIDogMCwgdGhpcy5jdXIoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0YXJ0IGJ5IHNob3dpbmcgdGhlIGVsZW1lbnQKICAgICAgICAgICAgalF1ZXJ5KHRoaXMuZWxlbSkuc2hvdygpOwogICAgICAgIH0sCgogICAgICAgIC8vIFNpbXBsZSAnaGlkZScgZnVuY3Rpb24KICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9yaWdbIHRoaXMucHJvcCBdID0galF1ZXJ5Ll9kYXRhKHRoaXMuZWxlbSwgImZ4c2hvdyIgKyB0aGlzLnByb3ApIHx8IGpRdWVyeS5zdHlsZSh0aGlzLmVsZW0sIHRoaXMucHJvcCk7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5oaWRlID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIEJlZ2luIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgdGhpcy5jdXN0b20odGhpcy5jdXIoKSwgMCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gRWFjaCBzdGVwIG9mIGFuIGFuaW1hdGlvbgogICAgICAgIHN0ZXA6IGZ1bmN0aW9uIChnb3RvRW5kKSB7CiAgICAgICAgICAgIHZhciBwLCBuLCBjb21wbGV0ZSwKICAgICAgICAgICAgICAgIHQgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAogICAgICAgICAgICAgICAgZG9uZSA9IHRydWUsCiAgICAgICAgICAgICAgICBlbGVtID0gdGhpcy5lbGVtLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCiAgICAgICAgICAgIGlmIChnb3RvRW5kIHx8IHQgPj0gb3B0aW9ucy5kdXJhdGlvbiArIHRoaXMuc3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5vdyA9IHRoaXMuZW5kOwogICAgICAgICAgICAgICAgdGhpcy5wb3MgPSB0aGlzLnN0YXRlID0gMTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7CgogICAgICAgICAgICAgICAgb3B0aW9ucy5hbmltYXRlZFByb3BlcnRpZXNbIHRoaXMucHJvcCBdID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gb3B0aW9ucy5hbmltYXRlZFByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5hbmltYXRlZFByb3BlcnRpZXNbIHAgXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBkb25lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgdGhlIG92ZXJmbG93CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub3ZlcmZsb3cgIT0gbnVsbCAmJiAhalF1ZXJ5LnN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcykgewoKICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmVhY2goWyAiIiwgIlgiLCAiWSIgXSwgZnVuY3Rpb24gKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5zdHlsZVsgIm92ZXJmbG93IiArIHZhbHVlIF0gPSBvcHRpb25zLm92ZXJmbG93WyBpbmRleCBdOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEhpZGUgdGhlIGVsZW1lbnQgaWYgdGhlICJoaWRlIiBvcGVyYXRpb24gd2FzIGRvbmUKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5oaWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShlbGVtKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCB0aGUgcHJvcGVydGllcywgaWYgdGhlIGl0ZW0gaGFzIGJlZW4gaGlkZGVuIG9yIHNob3duCiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGlkZSB8fCBvcHRpb25zLnNob3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChwIGluIG9wdGlvbnMuYW5pbWF0ZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcCwgb3B0aW9ucy5vcmlnWyBwIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoZWxlbSwgImZ4c2hvdyIgKyBwLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRvZ2dsZSBkYXRhIGlzIG5vIGxvbmdlciBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVEYXRhKGVsZW0sICJ0b2dnbGUiICsgcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGUgdGhlIGNvbXBsZXRlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGV2ZW50IHRoYXQgdGhlIGNvbXBsZXRlIGZ1bmN0aW9uIHRocm93cyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgICAvLyB3ZSBtdXN0IGVuc3VyZSBpdCB3b24ndCBiZSBjYWxsZWQgdHdpY2UuICM1Njg0CgogICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGxldGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29tcGxldGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGUuY2FsbChlbGVtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGNsYXNzaWNhbCBlYXNpbmcgY2Fubm90IGJlIHVzZWQgd2l0aCBhbiBJbmZpbml0eSBkdXJhdGlvbgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZHVyYXRpb24gPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdyA9IHQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG4gPSB0IC0gdGhpcy5zdGFydFRpbWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IG4gLyBvcHRpb25zLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgICAgICAvLyBQZXJmb3JtIHRoZSBlYXNpbmcgZnVuY3Rpb24sIGRlZmF1bHRzIHRvIHN3aW5nCiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3MgPSBqUXVlcnkuZWFzaW5nWyBvcHRpb25zLmFuaW1hdGVkUHJvcGVydGllc1t0aGlzLnByb3BdIF0odGhpcy5zdGF0ZSwgbiwgMCwgMSwgb3B0aW9ucy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3cgPSB0aGlzLnN0YXJ0ICsgKCAodGhpcy5lbmQgLSB0aGlzLnN0YXJ0KSAqIHRoaXMucG9zICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtIHRoZSBuZXh0IHN0ZXAgb2YgdGhlIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfTsKCiAgICBqUXVlcnkuZXh0ZW5kKGpRdWVyeS5meCwgewogICAgICAgIHRpY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRpbWVyLAogICAgICAgICAgICAgICAgdGltZXJzID0galF1ZXJ5LnRpbWVycywKICAgICAgICAgICAgICAgIGkgPSAwOwoKICAgICAgICAgICAgZm9yICg7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRpbWVyID0gdGltZXJzWyBpIF07CiAgICAgICAgICAgICAgICAvLyBDaGVja3MgdGhlIHRpbWVyIGhhcyBub3QgYWxyZWFkeSBiZWVuIHJlbW92ZWQKICAgICAgICAgICAgICAgIGlmICghdGltZXIoKSAmJiB0aW1lcnNbIGkgXSA9PT0gdGltZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGktLSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGltZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmZ4LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGludGVydmFsOiAxMywKCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVySWQpOwogICAgICAgICAgICB0aW1lcklkID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBzcGVlZHM6IHsKICAgICAgICAgICAgc2xvdzogNjAwLAogICAgICAgICAgICBmYXN0OiAyMDAsCiAgICAgICAgICAgIC8vIERlZmF1bHQgc3BlZWQKICAgICAgICAgICAgX2RlZmF1bHQ6IDQwMAogICAgICAgIH0sCgogICAgICAgIHN0ZXA6IHsKICAgICAgICAgICAgb3BhY2l0eTogZnVuY3Rpb24gKGZ4KSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuc3R5bGUoZnguZWxlbSwgIm9wYWNpdHkiLCBmeC5ub3cpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIChmeCkgewogICAgICAgICAgICAgICAgaWYgKGZ4LmVsZW0uc3R5bGUgJiYgZnguZWxlbS5zdHlsZVsgZngucHJvcCBdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmeC5lbGVtLnN0eWxlWyBmeC5wcm9wIF0gPSBmeC5ub3cgKyBmeC51bml0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmeC5lbGVtWyBmeC5wcm9wIF0gPSBmeC5ub3c7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCi8vIEVuc3VyZSBwcm9wcyB0aGF0IGNhbid0IGJlIG5lZ2F0aXZlIGRvbid0IGdvIHRoZXJlIG9uIHVuZGVyc2hvb3QgZWFzaW5nCiAgICBqUXVlcnkuZWFjaChmeEF0dHJzLmNvbmNhdC5hcHBseShbXSwgZnhBdHRycyksIGZ1bmN0aW9uIChpLCBwcm9wKSB7CiAgICAgICAgLy8gZXhjbHVkZSBtYXJnaW5Ub3AsIG1hcmdpbkxlZnQsIG1hcmdpbkJvdHRvbSBhbmQgbWFyZ2luUmlnaHQgZnJvbSB0aGlzIGxpc3QKICAgICAgICBpZiAocHJvcC5pbmRleE9mKCJtYXJnaW4iKSkgewogICAgICAgICAgICBqUXVlcnkuZnguc3RlcFsgcHJvcCBdID0gZnVuY3Rpb24gKGZ4KSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuc3R5bGUoZnguZWxlbSwgcHJvcCwgTWF0aC5tYXgoMCwgZngubm93KSArIGZ4LnVuaXQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIGlmIChqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzKSB7CiAgICAgICAgalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGZuLmVsZW07CiAgICAgICAgICAgIH0pLmxlbmd0aDsKICAgICAgICB9OwogICAgfQoKLy8gVHJ5IHRvIHJlc3RvcmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CiAgICBmdW5jdGlvbiBkZWZhdWx0RGlzcGxheShub2RlTmFtZSkgewoKICAgICAgICBpZiAoIWVsZW1kaXNwbGF5WyBub2RlTmFtZSBdKSB7CgogICAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHksCiAgICAgICAgICAgICAgICBlbGVtID0galF1ZXJ5KCI8IiArIG5vZGVOYW1lICsgIj4iKS5hcHBlbmRUbyhib2R5KSwKICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBlbGVtLmNzcygiZGlzcGxheSIpOwogICAgICAgICAgICBlbGVtLnJlbW92ZSgpOwoKICAgICAgICAgICAgLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsCiAgICAgICAgICAgIC8vIGdldCBlbGVtZW50J3MgcmVhbCBkZWZhdWx0IGRpc3BsYXkgYnkgYXR0YWNoaW5nIGl0IHRvIGEgdGVtcCBpZnJhbWUKICAgICAgICAgICAgaWYgKGRpc3BsYXkgPT09ICJub25lIiB8fCBkaXNwbGF5ID09PSAiIikgewogICAgICAgICAgICAgICAgLy8gTm8gaWZyYW1lIHRvIHVzZSB5ZXQsIHNvIGNyZWF0ZSBpdAogICAgICAgICAgICAgICAgaWYgKCFpZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKTsKICAgICAgICAgICAgICAgICAgICBpZnJhbWUuZnJhbWVCb3JkZXIgPSBpZnJhbWUud2lkdGggPSBpZnJhbWUuaGVpZ2h0ID0gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKGlmcmFtZSk7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgY2FjaGVhYmxlIGNvcHkgb2YgdGhlIGlmcmFtZSBkb2N1bWVudCBvbiBmaXJzdCBjYWxsLgogICAgICAgICAgICAgICAgLy8gSUUgYW5kIE9wZXJhIHdpbGwgYWxsb3cgdXMgdG8gcmV1c2UgdGhlIGlmcmFtZURvYyB3aXRob3V0IHJlLXdyaXRpbmcgdGhlIGZha2UgSFRNTAogICAgICAgICAgICAgICAgLy8gZG9jdW1lbnQgdG8gaXQ7IFdlYktpdCAmIEZpcmVmb3ggd29uJ3QgYWxsb3cgcmV1c2luZyB0aGUgaWZyYW1lIGRvY3VtZW50LgogICAgICAgICAgICAgICAgaWYgKCFpZnJhbWVEb2MgfHwgIWlmcmFtZS5jcmVhdGVFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lRG9jID0gKCBpZnJhbWUuY29udGVudFdpbmRvdyB8fCBpZnJhbWUuY29udGVudERvY3VtZW50ICkuZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lRG9jLndyaXRlKCggalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgPyAiPCFkb2N0eXBlIGh0bWw+IiA6ICIiICkgKyAiPGh0bWw+PGJvZHk+Iik7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lRG9jLmNsb3NlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZWxlbSA9IGlmcmFtZURvYy5jcmVhdGVFbGVtZW50KG5vZGVOYW1lKTsKCiAgICAgICAgICAgICAgICBpZnJhbWVEb2MuYm9keS5hcHBlbmRDaGlsZChlbGVtKTsKCiAgICAgICAgICAgICAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpOwogICAgICAgICAgICAgICAgYm9keS5yZW1vdmVDaGlsZChpZnJhbWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9yZSB0aGUgY29ycmVjdCBkZWZhdWx0IGRpc3BsYXkKICAgICAgICAgICAgZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwogICAgfQoKCiAgICB2YXIgZ2V0T2Zmc2V0LAogICAgICAgIHJ0YWJsZSA9IC9edCg/OmFibGV8ZHxoKSQvaSwKICAgICAgICBycm9vdCA9IC9eKD86Ym9keXxodG1sKSQvaTsKCiAgICBpZiAoImdldEJvdW5kaW5nQ2xpZW50UmVjdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgICAgZ2V0T2Zmc2V0ID0gZnVuY3Rpb24gKGVsZW0sIGRvYywgZG9jRWxlbSwgYm94KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBib3ggPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgZGlzY29ubmVjdGVkIERPTSBub2RlCiAgICAgICAgICAgIGlmICghYm94IHx8ICFqUXVlcnkuY29udGFpbnMoZG9jRWxlbSwgZWxlbSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBib3ggPyB7IHRvcDogYm94LnRvcCwgbGVmdDogYm94LmxlZnQgfSA6IHsgdG9wOiAwLCBsZWZ0OiAwIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBib2R5ID0gZG9jLmJvZHksCiAgICAgICAgICAgICAgICB3aW4gPSBnZXRXaW5kb3coZG9jKSwKICAgICAgICAgICAgICAgIGNsaWVudFRvcCA9IGRvY0VsZW0uY2xpZW50VG9wIHx8IGJvZHkuY2xpZW50VG9wIHx8IDAsCiAgICAgICAgICAgICAgICBjbGllbnRMZWZ0ID0gZG9jRWxlbS5jbGllbnRMZWZ0IHx8IGJvZHkuY2xpZW50TGVmdCB8fCAwLAogICAgICAgICAgICAgICAgc2Nyb2xsVG9wID0gd2luLnBhZ2VZT2Zmc2V0IHx8IGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsICYmIGRvY0VsZW0uc2Nyb2xsVG9wIHx8IGJvZHkuc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHdpbi5wYWdlWE9mZnNldCB8fCBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCAmJiBkb2NFbGVtLnNjcm9sbExlZnQgfHwgYm9keS5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgdG9wID0gYm94LnRvcCArIHNjcm9sbFRvcCAtIGNsaWVudFRvcCwKICAgICAgICAgICAgICAgIGxlZnQgPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0OwoKICAgICAgICAgICAgcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKICAgICAgICB9OwoKICAgIH0gZWxzZSB7CiAgICAgICAgZ2V0T2Zmc2V0ID0gZnVuY3Rpb24gKGVsZW0sIGRvYywgZG9jRWxlbSkgewogICAgICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSwKICAgICAgICAgICAgICAgIG9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50LAogICAgICAgICAgICAgICAgcHJldk9mZnNldFBhcmVudCA9IGVsZW0sCiAgICAgICAgICAgICAgICBib2R5ID0gZG9jLmJvZHksCiAgICAgICAgICAgICAgICBkZWZhdWx0VmlldyA9IGRvYy5kZWZhdWx0VmlldywKICAgICAgICAgICAgICAgIHByZXZDb21wdXRlZFN0eWxlID0gZGVmYXVsdFZpZXcgPyBkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW0sIG51bGwpIDogZWxlbS5jdXJyZW50U3R5bGUsCiAgICAgICAgICAgICAgICB0b3AgPSBlbGVtLm9mZnNldFRvcCwKICAgICAgICAgICAgICAgIGxlZnQgPSBlbGVtLm9mZnNldExlZnQ7CgogICAgICAgICAgICB3aGlsZSAoKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0gIT09IGJvZHkgJiYgZWxlbSAhPT0gZG9jRWxlbSkgewogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5zdXBwb3J0LmZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb21wdXRlZFN0eWxlID0gZGVmYXVsdFZpZXcgPyBkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW0sIG51bGwpIDogZWxlbS5jdXJyZW50U3R5bGU7CiAgICAgICAgICAgICAgICB0b3AgLT0gZWxlbS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICBsZWZ0IC09IGVsZW0uc2Nyb2xsTGVmdDsKCiAgICAgICAgICAgICAgICBpZiAoZWxlbSA9PT0gb2Zmc2V0UGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdG9wICs9IGVsZW0ub2Zmc2V0VG9wOwogICAgICAgICAgICAgICAgICAgIGxlZnQgKz0gZWxlbS5vZmZzZXRMZWZ0OwoKICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuZG9lc05vdEFkZEJvcmRlciAmJiAhKGpRdWVyeS5zdXBwb3J0LmRvZXNBZGRCb3JkZXJGb3JUYWJsZUFuZENlbGxzICYmIHJ0YWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0b3AgKz0gcGFyc2VGbG9hdChjb21wdXRlZFN0eWxlLmJvcmRlclRvcFdpZHRoKSB8fCAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0ICs9IHBhcnNlRmxvYXQoY29tcHV0ZWRTdHlsZS5ib3JkZXJMZWZ0V2lkdGgpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwcmV2T2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgICAgICAgIG9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuc3VwcG9ydC5zdWJ0cmFjdHNCb3JkZXJGb3JPdmVyZmxvd05vdFZpc2libGUgJiYgY29tcHV0ZWRTdHlsZS5vdmVyZmxvdyAhPT0gInZpc2libGUiKSB7CiAgICAgICAgICAgICAgICAgICAgdG9wICs9IHBhcnNlRmxvYXQoY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCkgfHwgMDsKICAgICAgICAgICAgICAgICAgICBsZWZ0ICs9IHBhcnNlRmxvYXQoY29tcHV0ZWRTdHlsZS5ib3JkZXJMZWZ0V2lkdGgpIHx8IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcHJldkNvbXB1dGVkU3R5bGUgPSBjb21wdXRlZFN0eWxlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJzdGF0aWMiKSB7CiAgICAgICAgICAgICAgICB0b3AgKz0gYm9keS5vZmZzZXRUb3A7CiAgICAgICAgICAgICAgICBsZWZ0ICs9IGJvZHkub2Zmc2V0TGVmdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGpRdWVyeS5zdXBwb3J0LmZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIpIHsKICAgICAgICAgICAgICAgIHRvcCArPSBNYXRoLm1heChkb2NFbGVtLnNjcm9sbFRvcCwgYm9keS5zY3JvbGxUb3ApOwogICAgICAgICAgICAgICAgbGVmdCArPSBNYXRoLm1heChkb2NFbGVtLnNjcm9sbExlZnQsIGJvZHkuc2Nyb2xsTGVmdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH07CiAgICAgICAgfTsKICAgIH0KCiAgICBqUXVlcnkuZm4ub2Zmc2V0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KICAgICAgICAgICAgICAgIHRoaXMgOgogICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQodGhpcywgb3B0aW9ucywgaSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHZhciBlbGVtID0gdGhpc1swXSwKICAgICAgICAgICAgZG9jID0gZWxlbSAmJiBlbGVtLm93bmVyRG9jdW1lbnQ7CgogICAgICAgIGlmICghZG9jKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVsZW0gPT09IGRvYy5ib2R5KSB7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkub2Zmc2V0LmJvZHlPZmZzZXQoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0T2Zmc2V0KGVsZW0sIGRvYywgZG9jLmRvY3VtZW50RWxlbWVudCk7CiAgICB9OwoKICAgIGpRdWVyeS5vZmZzZXQgPSB7CgogICAgICAgIGJvZHlPZmZzZXQ6IGZ1bmN0aW9uIChib2R5KSB7CiAgICAgICAgICAgIHZhciB0b3AgPSBib2R5Lm9mZnNldFRvcCwKICAgICAgICAgICAgICAgIGxlZnQgPSBib2R5Lm9mZnNldExlZnQ7CgogICAgICAgICAgICBpZiAoalF1ZXJ5LnN1cHBvcnQuZG9lc05vdEluY2x1ZGVNYXJnaW5JbkJvZHlPZmZzZXQpIHsKICAgICAgICAgICAgICAgIHRvcCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoYm9keSwgIm1hcmdpblRvcCIpKSB8fCAwOwogICAgICAgICAgICAgICAgbGVmdCArPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoYm9keSwgIm1hcmdpbkxlZnQiKSkgfHwgMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKICAgICAgICB9LAoKICAgICAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgICAgICAgIHZhciBwb3NpdGlvbiA9IGpRdWVyeS5jc3MoZWxlbSwgInBvc2l0aW9uIik7CgogICAgICAgICAgICAvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCiAgICAgICAgICAgIGlmIChwb3NpdGlvbiA9PT0gInN0YXRpYyIpIHsKICAgICAgICAgICAgICAgIGVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY3VyRWxlbSA9IGpRdWVyeShlbGVtKSwKICAgICAgICAgICAgICAgIGN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCksCiAgICAgICAgICAgICAgICBjdXJDU1NUb3AgPSBqUXVlcnkuY3NzKGVsZW0sICJ0b3AiKSwKICAgICAgICAgICAgICAgIGN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKGVsZW0sICJsZWZ0IiksCiAgICAgICAgICAgICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJiBqUXVlcnkuaW5BcnJheSgiYXV0byIsIFtjdXJDU1NUb3AsIGN1ckNTU0xlZnRdKSA+IC0xLAogICAgICAgICAgICAgICAgcHJvcHMgPSB7fSwgY3VyUG9zaXRpb24gPSB7fSwgY3VyVG9wLCBjdXJMZWZ0OwoKICAgICAgICAgICAgLy8gbmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgICAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgICAgICAgICAgY3VyUG9zaXRpb24gPSBjdXJFbGVtLnBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICBjdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CiAgICAgICAgICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1clRvcCA9IHBhcnNlRmxvYXQoY3VyQ1NTVG9wKSB8fCAwOwogICAgICAgICAgICAgICAgY3VyTGVmdCA9IHBhcnNlRmxvYXQoY3VyQ1NTTGVmdCkgfHwgMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucy5jYWxsKGVsZW0sIGksIGN1ck9mZnNldCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLnRvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcm9wcy50b3AgPSAoIG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCApICsgY3VyVG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLmxlZnQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgidXNpbmciIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMudXNpbmcuY2FsbChlbGVtLCBwcm9wcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJFbGVtLmNzcyhwcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKCiAgICBqUXVlcnkuZm4uZXh0ZW5kKHsKCiAgICAgICAgcG9zaXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzWzBdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdLAoKICAgICAgICAgICAgLy8gR2V0ICpyZWFsKiBvZmZzZXRQYXJlbnQKICAgICAgICAgICAgICAgIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCksCgogICAgICAgICAgICAvLyBHZXQgY29ycmVjdCBvZmZzZXRzCiAgICAgICAgICAgICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpLAogICAgICAgICAgICAgICAgcGFyZW50T2Zmc2V0ID0gcnJvb3QudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCiAgICAgICAgICAgIC8vIFN1YnRyYWN0IGVsZW1lbnQgbWFyZ2lucwogICAgICAgICAgICAvLyBub3RlOiB3aGVuIGFuIGVsZW1lbnQgaGFzIG1hcmdpbjogYXV0byB0aGUgb2Zmc2V0TGVmdCBhbmQgbWFyZ2luTGVmdAogICAgICAgICAgICAvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMAogICAgICAgICAgICBvZmZzZXQudG9wIC09IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luVG9wIikpIHx8IDA7CiAgICAgICAgICAgIG9mZnNldC5sZWZ0IC09IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luTGVmdCIpKSB8fCAwOwoKICAgICAgICAgICAgLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCiAgICAgICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0gcGFyc2VGbG9hdChqUXVlcnkuY3NzKG9mZnNldFBhcmVudFswXSwgImJvcmRlclRvcFdpZHRoIikpIHx8IDA7CiAgICAgICAgICAgIHBhcmVudE9mZnNldC5sZWZ0ICs9IHBhcnNlRmxvYXQoalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJMZWZ0V2lkdGgiKSkgfHwgMDsKCiAgICAgICAgICAgIC8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdG9wOiBvZmZzZXQudG9wIC0gcGFyZW50T2Zmc2V0LnRvcCwKICAgICAgICAgICAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICBvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICAgICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiAoIXJyb290LnRlc3Qob2Zmc2V0UGFyZW50Lm5vZGVOYW1lKSAmJiBqUXVlcnkuY3NzKG9mZnNldFBhcmVudCwgInBvc2l0aW9uIikgPT09ICJzdGF0aWMiKSkgewogICAgICAgICAgICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKICAgIGpRdWVyeS5lYWNoKHtzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLCBzY3JvbGxUb3A6ICJwYWdlWU9mZnNldCJ9LCBmdW5jdGlvbiAobWV0aG9kLCBwcm9wKSB7CiAgICAgICAgdmFyIHRvcCA9IC9ZLy50ZXN0KHByb3ApOwoKICAgICAgICBqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbWV0aG9kLCB2YWwpIHsKICAgICAgICAgICAgICAgIHZhciB3aW4gPSBnZXRXaW5kb3coZWxlbSk7CgogICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdpbiA/IChwcm9wIGluIHdpbikgPyB3aW5bIHByb3AgXSA6CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsICYmIHdpbi5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbIG1ldGhvZCBdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW4uZG9jdW1lbnQuYm9keVsgbWV0aG9kIF0gOgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtWyBtZXRob2QgXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAod2luKSB7CiAgICAgICAgICAgICAgICAgICAgd2luLnNjcm9sbFRvKAogICAgICAgICAgICAgICAgICAgICAgICAhdG9wID8gdmFsIDogalF1ZXJ5KHdpbikuc2Nyb2xsTGVmdCgpLAogICAgICAgICAgICAgICAgICAgICAgICB0b3AgPyB2YWwgOiBqUXVlcnkod2luKS5zY3JvbGxUb3AoKQogICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbGVtWyBtZXRob2QgXSA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgbWV0aG9kLCB2YWwsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwpOwogICAgICAgIH07CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRXaW5kb3coZWxlbSkgewogICAgICAgIHJldHVybiBqUXVlcnkuaXNXaW5kb3coZWxlbSkgPwogICAgICAgICAgICBlbGVtIDoKICAgICAgICAgICAgZWxlbS5ub2RlVHlwZSA9PT0gOSA/CiAgICAgICAgICAgICAgICBlbGVtLmRlZmF1bHRWaWV3IHx8IGVsZW0ucGFyZW50V2luZG93IDoKICAgICAgICAgICAgICAgIGZhbHNlOwogICAgfQoKCi8vIENyZWF0ZSB3aWR0aCwgaGVpZ2h0LCBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwogICAgalF1ZXJ5LmVhY2goeyBIZWlnaHQ6ICJoZWlnaHQiLCBXaWR0aDogIndpZHRoIiB9LCBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgICAgIHZhciBjbGllbnRQcm9wID0gImNsaWVudCIgKyBuYW1lLAogICAgICAgICAgICBzY3JvbGxQcm9wID0gInNjcm9sbCIgKyBuYW1lLAogICAgICAgICAgICBvZmZzZXRQcm9wID0gIm9mZnNldCIgKyBuYW1lOwoKICAgICAgICAvLyBpbm5lckhlaWdodCBhbmQgaW5uZXJXaWR0aAogICAgICAgIGpRdWVyeS5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdOwogICAgICAgICAgICByZXR1cm4gZWxlbSA/CiAgICAgICAgICAgICAgICBlbGVtLnN0eWxlID8KICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgdHlwZSwgInBhZGRpbmciKSkgOgogICAgICAgICAgICAgICAgICAgIHRoaXNbIHR5cGUgXSgpIDoKICAgICAgICAgICAgICAgIG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgLy8gb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGgKICAgICAgICBqUXVlcnkuZm5bICJvdXRlciIgKyBuYW1lIF0gPSBmdW5jdGlvbiAobWFyZ2luKSB7CiAgICAgICAgICAgIHZhciBlbGVtID0gdGhpc1swXTsKICAgICAgICAgICAgcmV0dXJuIGVsZW0gPwogICAgICAgICAgICAgICAgZWxlbS5zdHlsZSA/CiAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChqUXVlcnkuY3NzKGVsZW0sIHR5cGUsIG1hcmdpbiA/ICJtYXJnaW4iIDogImJvcmRlciIpKSA6CiAgICAgICAgICAgICAgICAgICAgdGhpc1sgdHlwZSBdKCkgOgogICAgICAgICAgICAgICAgbnVsbDsKICAgICAgICB9OwoKICAgICAgICBqUXVlcnkuZm5bIHR5cGUgXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4galF1ZXJ5LmFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBkb2MsIGRvY0VsZW1Qcm9wLCBvcmlnLCByZXQ7CgogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAgICAgICAgIC8vIDNyZCBjb25kaXRpb24gYWxsb3dzIE5va2lhIHN1cHBvcnQsIGFzIGl0IHN1cHBvcnRzIHRoZSBkb2NFbGVtIHByb3AgYnV0IG5vdCBDU1MxQ29tcGF0CiAgICAgICAgICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudDsKICAgICAgICAgICAgICAgICAgICBkb2NFbGVtUHJvcCA9IGRvYy5kb2N1bWVudEVsZW1lbnRbIGNsaWVudFByb3AgXTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4galF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgZG9jRWxlbVByb3AgfHwKICAgICAgICAgICAgICAgICAgICAgICAgZG9jLmJvZHkgJiYgZG9jLmJvZHlbIGNsaWVudFByb3AgXSB8fCBkb2NFbGVtUHJvcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBHZXQgZG9jdW1lbnQgd2lkdGggb3IgaGVpZ2h0CiAgICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICAgICAgICAgIC8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXIKICAgICAgICAgICAgICAgICAgICBkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBhIHdpbmRvdyA+IGRvY3VtZW50LCBJRTYgcmVwb3J0cyBhIG9mZnNldFtXaWR0aC9IZWlnaHRdID4gY2xpZW50W1dpZHRoL0hlaWdodF0KICAgICAgICAgICAgICAgICAgICAvLyBzbyB3ZSBjYW4ndCB1c2UgbWF4LCBhcyBpdCdsbCBjaG9vc2UgdGhlIGluY29ycmVjdCBvZmZzZXRbV2lkdGgvSGVpZ2h0XQogICAgICAgICAgICAgICAgICAgIC8vIGluc3RlYWQgd2UgdXNlIHRoZSBjb3JyZWN0IGNsaWVudFtXaWR0aC9IZWlnaHRdCiAgICAgICAgICAgICAgICAgICAgLy8gc3VwcG9ydDpJRTYKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jWyBjbGllbnRQcm9wIF0gPj0gZG9jWyBzY3JvbGxQcm9wIF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY1sgY2xpZW50UHJvcCBdOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmJvZHlbIHNjcm9sbFByb3AgXSwgZG9jWyBzY3JvbGxQcm9wIF0sCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYm9keVsgb2Zmc2V0UHJvcCBdLCBkb2NbIG9mZnNldFByb3AgXQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBvcmlnID0galF1ZXJ5LmNzcyhlbGVtLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICByZXQgPSBwYXJzZUZsb2F0KG9yaWcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBqUXVlcnkuaXNOdW1lcmljKHJldCkgPyByZXQgOiBvcmlnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICBqUXVlcnkoZWxlbSkuY3NzKHR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSwgdHlwZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGgsIG51bGwpOwogICAgICAgIH07CiAgICB9KTsKCgovLyBFeHBvc2UgalF1ZXJ5IHRvIHRoZSBnbG9iYWwgb2JqZWN0CiAgICB3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CgovLyBFeHBvc2UgalF1ZXJ5IGFzIGFuIEFNRCBtb2R1bGUsIGJ1dCBvbmx5IGZvciBBTUQgbG9hZGVycyB0aGF0Ci8vIHVuZGVyc3RhbmQgdGhlIGlzc3VlcyB3aXRoIGxvYWRpbmcgbXVsdGlwbGUgdmVyc2lvbnMgb2YgalF1ZXJ5Ci8vIGluIGEgcGFnZSB0aGF0IGFsbCBtaWdodCBjYWxsIGRlZmluZSgpLiBUaGUgbG9hZGVyIHdpbGwgaW5kaWNhdGUKLy8gdGhleSBoYXZlIHNwZWNpYWwgYWxsb3dhbmNlcyBmb3IgbXVsdGlwbGUgalF1ZXJ5IHZlcnNpb25zIGJ5Ci8vIHNwZWNpZnlpbmcgZGVmaW5lLmFtZC5qUXVlcnkgPSB0cnVlLiBSZWdpc3RlciBhcyBhIG5hbWVkIG1vZHVsZSwKLy8gc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlciBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLAovLyBidXQgbm90IHVzZSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0IHVuZGVyc3RhbmRzIGFub255bW91cwovLyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdCB3YXkgdG8gcmVnaXN0ZXIuCi8vIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlIGRlcml2ZWQgZnJvbQovLyBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZSBmaWxlIG5hbWUuCi8vIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMgdG8gY2FsbAovLyBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSkgewogICAgICAgIGRlZmluZSgianF1ZXJ5IiwgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeTsKICAgICAgICB9KTsKICAgIH0KCgp9KSh3aW5kb3cpOwoKLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4wLjcKICogKGMpIDIwMTAtMjAxMiBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQpIHsKICAgIHZhciBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeS5ub0NvbmZsaWN0KHRydWUpOwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IExvd2VyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gdXBwZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsKICAgIH07CgoKICAgIHZhciBtYW51YWxMb3dlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7CiAgICAgICAgfSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW2Etel0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpOwogICAgICAgIH0pCiAgICAgICAgICAgIDogczsKICAgIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICAgIGlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICAgIH0KCgogICAgdmFyIC8qKiBob2xkcyBtYWpvciB2ZXJzaW9uIG51bWJlciBmb3IgSUUgb3IgTmFOIGZvciByZWFsIGJyb3dzZXJzICovCiAgICAgICAgICAgIG1zaWUgPSBpbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKSwKICAgICAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICAgICAgalF1ZXJ5LCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZwogICAgICAgIHNsaWNlID0gW10uc2xpY2UsCiAgICAgICAgcHVzaCA9IFtdLnB1c2gsCiAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoKICAgICAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgICAgICAgICBhbmd1bGFyID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCA9IFsnMCcsICcwJywgJzAnXTsKCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBvYmoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywgLi4uKQogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAvLyBXZSBoYXZlIG9uIG9iamVjdCB3aGljaCBoYXMgbGVuZ3RoIHByb3BlcnR5LiBTaG91bGQgd2UgdHJlYXQgaXQgYXMgYXJyYXk/CiAgICAgICAgaWYgKHR5cGVvZiBvYmouaGFzT3duUHJvcGVydHkgIT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgICB0eXBlb2Ygb2JqLmNvbnN0cnVjdG9yICE9ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBoZXJlIGZvciBJRTg6IGl0IGlzIGEgYm9ndXMgb2JqZWN0IHRyZWF0IGl0IGFzIGFycmF5OwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgSlFMaXRlIHx8ICAgICAgICAgICAgICAgICAgICAgIC8vIEpRTGl0ZQogICAgICAgICAgICAgICAgKGpRdWVyeSAmJiBvYmogaW5zdGFuY2VvZiBqUXVlcnkpIHx8ICAgICAgICAgIC8vIGpRdWVyeQogICAgICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChvYmopICE9PSAnW29iamVjdCBPYmplY3RdJyB8fCAgIC8vIHNvbWUgYnJvd3NlciBuYXRpdmUgb2JqZWN0CiAgICAgICAgICAgICAgICB0eXBlb2Ygb2JqLmNhbGxlZSA9PT0gJ2Z1bmN0aW9uJzsgICAgICAgICAgICAgIC8vIGFyZ3VtZW50cyAob24gSUU4IGxvb2tzIGxpa2UgcmVndWxhciBvYmopCiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgICAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5KWAsIHdoZXJlIGB2YWx1ZWAKICAgICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIHdhcyBwcmV2aW91c2x5IGtub3duIGFzIGBhbmd1bGFyLmZvcmVhY2hgLgogICAgICoKICAgICA8cHJlPgogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5OwogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPSAncHJvdG90eXBlJyAmJiBrZXkgIT0gJ2xlbmd0aCcgJiYga2V5ICE9ICduYW1lJyAmJiBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChvYmouZm9yRWFjaCAmJiBvYmouZm9yRWFjaCAhPT0gZm9yRWFjaCkgewogICAgICAgICAgICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleXMuc29ydCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvckVhY2hTb3J0ZWQob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciBrZXlzID0gc29ydGVkS2V5cyhvYmopOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzOwogICAgfQoKCiAgICAvKioKICAgICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBpdGVyYXRvckZuKGtleSwgdmFsdWUpCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZSAoaW5kZXgpIHsKICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAgICogQHBhcmFtIGggdGhlIGhhc2hrZXkgKCF0cnV0aHkgdG8gZGVsZXRlIHRoZSBoYXNoa2V5KQogICAgICovCiAgICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAgICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgICAgICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2V0SGFzaEtleShkc3QsIGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICAgICAgfSwge3Byb3RvdHlwZTogcGFyZW50fSkpKCksIGV4dHJhKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubm9vcAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgICAgPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CgogICAgbm9vcC4kaW5qZWN0ID0gW107CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlkZW50aXR5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGl0cyBmaXJzdCBhcmd1bWVudC4gVGhpcyBmdW5jdGlvbiBpcyB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAgICoKICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBpZGVudGl0eSgkKSB7CiAgICAgICAgcmV0dXJuICQ7CiAgICB9CgogICAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyB1bmRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIHVuZGVmaW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBkZWZpbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBkZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc09iamVjdAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAgICAgKiBjb25zaWRlcmVkIHRvIGJlIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogICAgICovCiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNTdHJpbmcKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBTdHJpbmdgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBTdHJpbmdgLgogICAgICovCiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZyc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzTnVtYmVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgTnVtYmVyYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgTnVtYmVyYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgRGF0ZV0nOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgQXJyYXldJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNGdW5jdGlvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogICAgICovCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nOwogICAgfQoKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAgICovCiAgICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdib29sZWFuJzsKICAgIH0KCgogICAgZnVuY3Rpb24gdHJpbSh2YWx1ZSkgewogICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0VsZW1lbnQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUgJiYKICAgICAgICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgICAgICAgICB8fCAobm9kZS5iaW5kICYmIG5vZGUuZmluZCkpOyAgLy8gd2UgaGF2ZSBhIGJpbmQgYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAgICovCiAgICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIG9ialsgaXRlbXNbaV0gXSA9IHRydWU7CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCgogICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50IDogZWxlbWVudFswXTsKICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcpCiAgICAgICAgICAgICAgICA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICBub2RlTmFtZV8gPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICAgICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzIGFuIG9iamVjdCBoYXMsIG9yCiAgICAgKiB0aGUgbGVuZ3RoIG9mIGEgc3RyaW5nLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBhbmd1bGFyLk9iamVjdH0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8c3RyaW5nfSBvYmogT2JqZWN0LCBhcnJheSwgb3Igc3RyaW5nIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNpemUob2JqLCBvd25Qcm9wc09ubHkpIHsKICAgICAgICB2YXIgc2l6ZSA9IDAsIGtleTsKCiAgICAgICAgaWYgKGlzQXJyYXkob2JqKSB8fCBpc1N0cmluZyhvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBvYmoubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgICAgICAgICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2l6ZTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5jbHVkZXMoYXJyYXksIG9iaikgewogICAgICAgIHJldHVybiBpbmRleE9mKGFycmF5LCBvYmopICE9IC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIG9iaikgewogICAgICAgIGlmIChhcnJheS5pbmRleE9mKSByZXR1cm4gYXJyYXkuaW5kZXhPZihvYmopOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogICAgICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgZnVuY3Rpb24gaXNMZWFmTm9kZShub2RlKSB7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJPUFRJT04iOgogICAgICAgICAgICAgICAgY2FzZSAiUFJFIjoKICAgICAgICAgICAgICAgIGNhc2UgIlRJVExFIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuY29weQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogICAgICoKICAgICAqICogSWYgbm8gZGVzdGluYXRpb24gaXMgc3VwcGxpZWQsIGEgY29weSBvZiB0aGUgb2JqZWN0IG9yIGFycmF5IGlzIGNyZWF0ZWQuCiAgICAgKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAgICAgKiAgIGFyZSBkZWxldGVkIGFuZCB0aGVuIGFsbCBlbGVtZW50cy9wcm9wZXJ0aWVzIGZyb20gdGhlIHNvdXJjZSBhcmUgY29waWVkIHRvIGl0LgogICAgICogKiBJZiAgYHNvdXJjZWAgaXMgbm90IGFuIG9iamVjdCBvciBhcnJheSwgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gc291cmNlIFRoZSBzb3VyY2UgdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAgICAgKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxBcnJheSk9fSBkZXN0aW5hdGlvbiBEZXN0aW5hdGlvbiBpbnRvIHdoaWNoIHRoZSBzb3VyY2UgaXMgY29waWVkLiBJZgogICAgICogICAgIHByb3ZpZGVkLCBtdXN0IGJlIG9mIHRoZSBzYW1lIHR5cGUgYXMgYHNvdXJjZWAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbikgewogICAgICAgIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgdGhyb3cgRXJyb3IoIkNhbid0IGNvcHkgV2luZG93IG9yIFNjb3BlIik7CiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IGVxdWl2YWxlbnQgb2JqZWN0cyBvciBhcnJheXMiKTsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24ucHVzaChjb3B5KHNvdXJjZVtpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IGNvcHkoc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0SGFzaEtleShkZXN0aW5hdGlvbiwgaCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICAgICAgICBpZiAoc3JjLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LnN1YnN0cigwLCAyKSAhPT0gJyQkJykgewogICAgICAgICAgICAgICAgZHN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRzdDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZXF1YWxzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgdHdvIG9iamVjdHMgb3IgdHdvIHZhbHVlcyBhcmUgZXF1aXZhbGVudC4gU3VwcG9ydHMgdmFsdWUgdHlwZXMsIGFycmF5cyBhbmQKICAgICAqIG9iamVjdHMuCiAgICAgKgogICAgICogVHdvIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgaWYgYXQgbGVhc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgdHJ1ZToKICAgICAqCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogICAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBvZiB0aGUgc2FtZSB0eXBlIGFuZCBhbGwgb2YgdGhlaXIgcHJvcGVydGllcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhc1NjcmlwdCwgTmFOID09IE5hTiA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byBOYU4gYXMgZXF1YWwpCiAgICAgKgogICAgICogRHVyaW5nIGEgcHJvcGVydHkgY29tcGFyaXNpb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgICAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICAgICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgIGlmICh0MSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChsZW5ndGggPSBvMS5sZW5ndGgpID09IG8yLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSA9IDA7IGtleSA8IGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2V5U2V0W2tleV0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbzJba2V5XSAhPT0gdW5kZWZpbmVkICYmICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5jYWxsKHNlbGYpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGluIElFLCBuYXRpdmUgbWV0aG9kcyBhcmUgbm90IGZ1bmN0aW9ucyBzbyB0aGV5IGNhbm5vdCBiZSBib3VuZCAobm90ZTogdGhleSBkb24ndCBuZWVkIHRvIGJlKQogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiB0b0pzb25SZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIHZhbCA9IHZhbHVlOwoKICAgICAgICBpZiAoL15cJCsvLnRlc3Qoa2V5KSkgewogICAgICAgICAgICB2YWwgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIGlmIChpc1dpbmRvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRXSU5ET1cnOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhbCA9ICckRE9DVU1FTlQnOwogICAgICAgIH0gZWxzZSBpZiAoaXNTY29wZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRTQ09QRSc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci50b0pzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2VyaWFsaXplcyBpbnB1dCBpbnRvIGEgSlNPTi1mb3JtYXR0ZWQgc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gSnNvbmlmaWVkIHN0cmluZyByZXByZXNlbnRpbmcgYG9iamAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvSnNvbihvYmosIHByZXR0eSkgewogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmZyb21Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlc2VyaWFsaXplcyBhIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZyb21Kc29uKGpzb24pIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcoanNvbikKICAgICAgICAgICAgPyBKU09OLnBhcnNlKGpzb24pCiAgICAgICAgICAgIDoganNvbjsKICAgIH0KCgogICAgZnVuY3Rpb24gdG9Cb29sZWFuKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgICAgICAgICAgdmFsdWUgPSAhKHYgPT0gJ2YnIHx8IHYgPT0gJzAnIHx8IHYgPT0gJ2ZhbHNlJyB8fCB2ID09ICdubycgfHwgdiA9PSAnbicgfHwgdiA9PSAnW10nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YXJ0aW5nVGFnKGVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpLmNsb25lKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gdHVybnMgb3V0IElFIGRvZXMgbm90IGxldCB5b3Ugc2V0IC5odG1sKCkgb24gZWxlbWVudHMgd2hpY2gKICAgICAgICAgICAgLy8gYXJlIG5vdCBhbGxvd2VkIHRvIGhhdmUgY2hpbGRyZW4uIFNvIHdlIGp1c3QgaWdub3JlIGl0LgogICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgICAgICAgICAgICBtYXRjaCgvXig8W14+XSs+KS8pWzFdLgogICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24gKG1hdGNoLCBub2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEByZXR1cm5zIE9iamVjdC48KHN0cmluZ3xib29sZWFuKT4KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgICAgICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKGtleVZhbHVlKSB7CiAgICAgICAgICAgIGlmIChrZXlWYWx1ZSkgewogICAgICAgICAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMV0pIDogdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7CiAgICB9CgoKICAgIC8qKgogICAgICogV2UgbmVlZCBvdXIgY3VzdG9tIG1ldGhvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICAgKiBzZWdtZW50czoKICAgICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICAgKiBtZXRob2QgYmVjdWFzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZW5jb2RlcyBzdHVmZiB0aGF0IGRvZXNuJ3QgaGF2ZSB0byBiZQogICAgICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICAgICAqICAgIHF1ZXJ5ICAgICAgID0gKiggcGNoYXIgLyAiLyIgLyAiPyIgKQogICAgICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICAgICAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlVXJpUXVlcnkodmFsLCBwY3RFbmNvZGVTcGFjZXMpIHsKICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkuCiAgICAgICAgICAgIHJlcGxhY2UoLyU0MC9naSwgJ0AnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICByZXBsYWNlKC8lMjQvZywgJyQnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJDL2dpLCAnLCcpLgogICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQXBwCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogICAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvIGF1dG8tYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLiBPbmx5CiAgICAgKiBvbmUgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZGlyZWN0aXZlCiAgICAgKiBkZXNpZ25hdGVzIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZAogICAgICogYXQgdGhlIHJvb3Qgb2YgdGhlIHBhZ2UuCiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUgYmVsb3cgaWYgdGhlIGBuZ0FwcGAgZGlyZWN0aXZlIHdvdWxkIG5vdCBiZSBwbGFjZWQKICAgICAqIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZSBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQKICAgICAqIGFuZCB0aGUgYHt7IDErMiB9fWAgd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICAgICAqCiAgICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0IHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBJIGNhbiBhZGQ6IDEgKyAyID0gIHt7IDErMiB9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICAgICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gKG1hdGNoWzJdIHx8ICcnKS5yZXBsYWNlKC9ccysvZywgJywnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIHJlc3VtZUJvb3RzdHJhcEludGVybmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwogICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbiAoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgICAgICAgfV0pOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgICAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICAgICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvcikgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH1dCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RvcjsKICAgICAgICB9OwoKICAgICAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICAgICAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH0KCiAgICAgICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgICAgIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24gKGV4dHJhTW9kdWxlcykgewogICAgICAgICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CgogICAgZnVuY3Rpb24gc25ha2VfY2FzZShuYW1lLCBzZXBhcmF0b3IpIHsKICAgICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uIChsZXR0ZXIsIHBvcykgewogICAgICAgICAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAgICAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICAgICAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgICAgIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogICAgICAgIGlmIChqUXVlcnkpIHsKICAgICAgICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICAgICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgICAgICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICAgICAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlKTsKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2VtcHR5Jyk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganFMaXRlID0gSlFMaXRlOwogICAgICAgIH0KICAgICAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgJyIgKyAobmFtZSB8fCAnPycpICsgIicgaXMgIiArIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgICAgICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgICAgICB9CgogICAgICAgIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAgICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGludGVyZmFjZQogICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEludGVyZmFjZSBmb3IgY29uZmlndXJpbmcgYW5ndWxhciB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30uCiAgICAgKi8KCiAgICBmdW5jdGlvbiBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpIHsKCiAgICAgICAgZnVuY3Rpb24gZW5zdXJlKG9iaiwgbmFtZSwgZmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVuc3VyZShlbnN1cmUod2luZG93LCAnYW5ndWxhcicsIE9iamVjdCksICdtb2R1bGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZyBhbmQgcmVnaXN0ZXJpbmcgQW5ndWxhciBtb2R1bGVzLiBBbGwKICAgICAgICAgICAgICogbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIyBNb2R1bGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsb2NhdGlvbiBvZiBzZXJ2aWNlcywgZGlyZWN0aXZlcywgZmlsdGVycywgYW5kIGNvbmZpZ3VyYXRpb24gaW5mb3JtYXRpb24uIE1vZHVsZQogICAgICAgICAgICAgKiBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICAgICAgICogbXlNb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGVuIHlvdSBjYW4gY3JlYXRlIGFuIGluamVjdG9yIGFuZCBsb2FkIHlvdXIgbW9kdWxlcyBsaWtlIHRoaXM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIHZhciBpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZycsICdNeU1vZHVsZSddKQogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSG93ZXZlciBpdCdzIG1vcmUgbGlrZWx5IHRoYXQgeW91J2xsIGp1c3QgdXNlCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPj19IHJlcXVpcmVzIElmIHNwZWNpZmllZCB0aGVuIG5ldyBtb2R1bGUgaXMgYmVpbmcgY3JlYXRlZC4gSWYgdW5zcGVjaWZpZWQgdGhlbiB0aGUKICAgICAgICAgICAgICogICAgICAgIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gbW9kdWxlOiAnICsgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gTGlzdCBvZiBtb2R1bGUgbmFtZXMgd2hpY2ggbXVzdCBiZSBsb2FkZWQgYmVmb3JlIHRoaXMgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgZmlsdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBpbnZva2VMYXRlcignJGZpbHRlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGNvbnRyb2xsZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IGludm9rZUxhdGVyKCckY29udHJvbGxlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGRpcmVjdGl2ZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcnVuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbml0aWFsaXphdGlvbkZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBhZnRlciBpbmplY3RvciBjcmVhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogICAgVXNlZnVsIGZvciBhcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIHNob3VsZCBiZSBwZXJmb3JtZWQgd2hlbiB0aGUgaW5qZWN0b3IgaXMgZG9uZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBsb2FkaW5nIGFsbCBtb2R1bGVzLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcnVuOiBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7YW5ndWxhci5Nb2R1bGV9CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgICAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogICAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgICAqLwogICAgdmFyIHZlcnNpb24gPSB7CiAgICAgICAgZnVsbDogJzEuMC43JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAwLAogICAgICAgIGRvdDogNywKICAgICAgICBjb2RlTmFtZTogJ21vbm9jaHJvbWF0aWMtcmFpbmJvdycKICAgIH07CgoKICAgIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKSB7CiAgICAgICAgZXh0ZW5kKGFuZ3VsYXIsIHsKICAgICAgICAgICAgJ2Jvb3RzdHJhcCc6IGJvb3RzdHJhcCwKICAgICAgICAgICAgJ2NvcHknOiBjb3B5LAogICAgICAgICAgICAnZXh0ZW5kJzogZXh0ZW5kLAogICAgICAgICAgICAnZXF1YWxzJzogZXF1YWxzLAogICAgICAgICAgICAnZWxlbWVudCc6IGpxTGl0ZSwKICAgICAgICAgICAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICAgICAgICAgICAnaW5qZWN0b3InOiBjcmVhdGVJbmplY3RvciwKICAgICAgICAgICAgJ25vb3AnOiBub29wLAogICAgICAgICAgICAnYmluZCc6IGJpbmQsCiAgICAgICAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAgICAgICAnaWRlbnRpdHknOiBpZGVudGl0eSwKICAgICAgICAgICAgJ2lzVW5kZWZpbmVkJzogaXNVbmRlZmluZWQsCiAgICAgICAgICAgICdpc0RlZmluZWQnOiBpc0RlZmluZWQsCiAgICAgICAgICAgICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICAgICAgICAgICAnaXNGdW5jdGlvbic6IGlzRnVuY3Rpb24sCiAgICAgICAgICAgICdpc09iamVjdCc6IGlzT2JqZWN0LAogICAgICAgICAgICAnaXNOdW1iZXInOiBpc051bWJlciwKICAgICAgICAgICAgJ2lzRWxlbWVudCc6IGlzRWxlbWVudCwKICAgICAgICAgICAgJ2lzQXJyYXknOiBpc0FycmF5LAogICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICdpc0RhdGUnOiBpc0RhdGUsCiAgICAgICAgICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAgICAgICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAgICAgICAgICdjYWxsYmFja3MnOiB7Y291bnRlcjogMH0KICAgICAgICB9KTsKCiAgICAgICAgYW5ndWxhck1vZHVsZSA9IHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJywgW10pLnByb3ZpZGVyKCckbG9jYWxlJywgJExvY2FsZVByb3ZpZGVyKTsKICAgICAgICB9CgogICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgICAgICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKCckY29tcGlsZScsICRDb21waWxlUHJvdmlkZXIpLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGE6IGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtOiBmb3JtRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uOiBvcHRpb25EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRIdG1sVW5zYWZlOiBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRUZW1wbGF0ZTogbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NFdmVuOiBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzc09kZDogbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDc3A6IG5nQ3NwRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0Nsb2FrOiBuZ0Nsb2FrRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NvbnRyb2xsZXI6IG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSGlkZTogbmdIaWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdJbml0OiBuZ0luaXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nTm9uQmluZGFibGU6IG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdSZXBlYXQ6IG5nUmVwZWF0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1Nob3c6IG5nU2hvd0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTdWJtaXQ6IG5nU3VibWl0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmlldzogbmdWaWV3RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZTogJFJvdXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiAkUm91dGVQYXJhbXNQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUgcHJvdmlkZXMgdGhlIGZvbGxvd2luZyBtZXRob2RzOgogICAgICoKICAgICAqIC0gW2FkZENsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZGRDbGFzcy8pCiAgICAgKiAtIFthZnRlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogICAgICogLSBbYXBwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hcHBlbmQvKQogICAgICogLSBbYXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXR0ci8pCiAgICAgKiAtIFtiaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICAgICAqIC0gW2NoaWxkcmVuKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW2Nsb25lKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAgICAgKiAtIFtjb250ZW50cygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogICAgICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogICAgICogLSBbZGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAgICAgKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAgICogLSBbZmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICAgKiAtIFtoYXNDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAgICogLSBbaHRtbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICAgKiAtIFtuZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbcGFyZW50KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtwcmVwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcmVwZW5kLykKICAgICAqIC0gW3Byb3AoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogICAgICogLSBbcmVhZHkoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlYWR5LykKICAgICAqIC0gW3JlbW92ZSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlLykKICAgICAqIC0gW3JlbW92ZUF0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogICAgICogLSBbcmVtb3ZlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUNsYXNzLykKICAgICAqIC0gW3JlbW92ZURhdGEoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZURhdGEvKQogICAgICogLSBbcmVwbGFjZVdpdGgoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICAgICAqIC0gW3RleHQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RleHQvKQogICAgICogLSBbdG9nZ2xlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RvZ2dsZUNsYXNzLykKICAgICAqIC0gW3RyaWdnZXJIYW5kbGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gRG9lc24ndCBwYXNzIG5hdGl2ZSBldmVudCBvYmplY3RzIHRvIGhhbmRsZXJzLgogICAgICogLSBbdW5iaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS91bmJpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAgICogLSBbdmFsKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS92YWwvKQogICAgICogLSBbd3JhcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAgICAgKgogICAgICogIyMgSW4gYWRkdGlvbiB0byB0aGUgYWJvdmUsIEFuZ3VsYXIgcHJvdmlkZXMgYWRkaXRpb25hbCBtZXRob2RzIHRvIGJvdGggalF1ZXJ5IGFuZCBqUXVlcnkgbGl0ZToKICAgICAqCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICAgICAgOiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwogICAgICAgIH0pLAogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcgogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKICAgICAgICB9KTsKCiAgICBmdW5jdGlvbiBqcU5leHRJZCgpIHsKICAgICAgICByZXR1cm4gKytqcUlkOwogICAgfQoKCiAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgIHZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwoKICAgIC8qKgogICAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgICAqLwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCxmdW5jdGlvbiAoXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyAgSW4gY29uanVuY3Rpb24gd2l0aCBiaW5kSlF1ZXJ5IGludGVyY2VwdHMgYWxsIGpRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyBhCi8vICRkZXN0cm95IGV2ZW50IG9uIGFsbCBET00gbm9kZXMgYmVpbmcgcmVtb3ZlZC4KLy8KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgICAgICBvcmlnaW5hbEpxRm4gPSBvcmlnaW5hbEpxRm4uJG9yaWdpbmFsIHx8IG9yaWdpbmFsSnFGbjsKICAgICAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICAgICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBhdGNoKCkgewogICAgICAgICAgICB2YXIgbGlzdCA9IFt0aGlzXSwKICAgICAgICAgICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICAgICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICAgICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbiwKICAgICAgICAgICAgICAgIGZucywgZXZlbnRzOwoKICAgICAgICAgICAgd2hpbGUgKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBzZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBmb3IgKHNldEluZGV4ID0gMCwgc2V0TGVuZ3RoID0gc2V0Lmxlbmd0aDsgc2V0SW5kZXggPCBzZXRMZW5ndGg7IHNldEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgIGlmIChmaXJlRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50cmlnZ2VySGFuZGxlcignJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSAhZmlyZUV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgZnVuY3Rpb24gSlFMaXRlKGVsZW1lbnQpIHsKICAgICAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEpRTGl0ZSkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEpRTGl0ZSkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3NlbGVjdG9ycyBub3QgaW1wbGVtZW50ZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IEpRTGl0ZShlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSkgewogICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgdGhlIE5vU2NvcGUgZWxlbWVudHMgaGVyZToKICAgICAgICAgICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTMzODk3KFZTLjg1KS5hc3B4CiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPGRpdj4mIzE2MDs8L2Rpdj4nICsgZWxlbWVudDsgLy8gSUUgaW5zYW5pdHkgdG8gbWFrZSBOb1Njb3BlIGVsZW1lbnRzIHdvcmshCiAgICAgICAgICAgIGRpdi5yZW1vdmVDaGlsZChkaXYuZmlyc3RDaGlsZCk7IC8vIHJlbW92ZSB0aGUgc3VwZXJmbHVvdXMgZGl2CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGRpdi5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsgLy8gZGV0YWNoIHRoZSBlbGVtZW50cyBmcm9tIHRoZSB0ZW1wb3JhcnkgRE9NIGRpdi4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBKUUxpdGVBZGROb2Rlcyh0aGlzLCBlbGVtZW50KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ2xvbmUoZWxlbWVudCkgewogICAgICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVEZWFsb2MoZWxlbWVudCkgewogICAgICAgIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkcmVuW2ldKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlVW5iaW5kKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgICAgIGhhbmRsZSA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJyk7CgogICAgICAgIGlmICghaGFuZGxlKSByZXR1cm47IC8vbm8gbGlzdGVuZXJzIHJlZ2lzdGVyZWQKCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUpKSB7CiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRIYW5kbGVyLCB0eXBlKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChmbikpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudHNbdHlwZV0pOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGV2ZW50c1t0eXBlXSwgZm4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgICAgICAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICBpZiAoZXhwYW5kb1N0b3JlLmhhbmRsZSkgewogICAgICAgICAgICAgICAgZXhwYW5kb1N0b3JlLmV2ZW50cy4kZGVzdHJveSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgIEpRTGl0ZVVuYmluZChlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgICAgICAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWQgfHwgLTFdOwoKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICBpZiAoIWV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cGFuZG9TdG9yZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmVba2V5XTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlRGF0YShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGRhdGEgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnKSwKICAgICAgICAgICAgaXNTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpLAogICAgICAgICAgICBrZXlEZWZpbmVkID0gIWlzU2V0dGVyICYmIGlzRGVmaW5lZChrZXkpLAogICAgICAgICAgICBpc1NpbXBsZUdldHRlciA9IGtleURlZmluZWQgJiYgIWlzT2JqZWN0KGtleSk7CgogICAgICAgIGlmICghZGF0YSAmJiAhaXNTaW1wbGVHZXR0ZXIpIHsKICAgICAgICAgICAgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJywgZGF0YSA9IHt9KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1NldHRlcikgewogICAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoa2V5RGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgY3JlYXRlIGRhdGEgaW4gdGhpcyBjYXNlLgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhICYmIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGRhdGEsIGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgIHJldHVybiAoKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS4KICAgICAgICAgICAgaW5kZXhPZigiICIgKyBzZWxlY3RvciArICIgIikgPiAtMSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoY3NzQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbSgKICAgICAgICAgICAgICAgICAgICAoIiAiICsgZWxlbWVudC5jbGFzc05hbWUgKyAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgiICIgKyB0cmltKGNzc0NsYXNzKSArICIgIiwgIiAiKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBpZiAoIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIGNzc0NsYXNzKSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbShlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIHRyaW0oY3NzQ2xhc3MpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZE5vZGVzKHJvb3QsIGVsZW1lbnRzKSB7CiAgICAgICAgaWYgKGVsZW1lbnRzKSB7CiAgICAgICAgICAgIGVsZW1lbnRzID0gKCFlbGVtZW50cy5ub2RlTmFtZSAmJiBpc0RlZmluZWQoZWxlbWVudHMubGVuZ3RoKSAmJiAhaXNXaW5kb3coZWxlbWVudHMpKQogICAgICAgICAgICAgICAgPyBlbGVtZW50cwogICAgICAgICAgICAgICAgOiBbIGVsZW1lbnRzIF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHJvb3QucHVzaChlbGVtZW50c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ29udHJvbGxlcihlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyQnICsgKG5hbWUgfHwgJ25nQ29udHJvbGxlcicgKSArICdDb250cm9sbGVyJyk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICAgIC8vIGlmIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50IG9iamVjdCB3b3JrIHdpdGggdGhlIGh0bWwgZWxlbWVudCBpbnN0ZWFkCiAgICAgICAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgICAgICAgaWYgKGVsZW1lbnRbMF0ubm9kZVR5cGUgPT0gOSkgewogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWUpKSByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICAgICAgICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgICAgICAgICAgICBmaXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJpbmQoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsgLy8gd29ya3MgZm9yIG1vZGVybiBicm93c2VycyBhbmQgSUU5CiAgICAgICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAgICAgSlFMaXRlKHdpbmRvdykuYmluZCgnbG9hZCcsIHRyaWdnZXIpOyAvLyBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkIGZvciBvdGhlcnMKICAgICAgICB9LAogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKHRoaXMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKCcnICsgZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgICAgIH0sCgogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwdXNoOiBwdXNoLAogICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgIH07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBCT09MRUFOX0FUVFIgPSB7fTsKICAgIGZvckVhY2goJ211bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZE9ubHkscmVxdWlyZWQnLnNwbGl0KCcsJyksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIEJPT0xFQU5fQVRUUltsb3dlcmNhc2UodmFsdWUpXSA9IHZhbHVlOwogICAgfSk7CiAgICB2YXIgQk9PTEVBTl9FTEVNRU5UUyA9IHt9OwogICAgZm9yRWFjaCgnaW5wdXQsc2VsZWN0LG9wdGlvbix0ZXh0YXJlYSxidXR0b24sZm9ybScuc3BsaXQoJywnKSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckc2NvcGUnKTsKICAgICAgICB9LAoKICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVDb250cm9sbGVyLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycpIHZhbCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhdHRyOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpIHx8IG5vb3ApLnNwZWNpZmllZCkKICAgICAgICAgICAgICAgICAgICAgICAgPyBsb3dlcmNhc2VkTmFtZQogICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgICAgICAgICAgIC8vIHNvbWUgZWxlbWVudHMgKGUuZy4gRG9jdW1lbnQpIGRvbid0IGhhdmUgZ2V0IGF0dHJpYnV0ZSwgc28gcmV0dXJuIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByb3A6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB0ZXh0OiBleHRlbmQoKG1zaWUgPCA5KQogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICovKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVyVGV4dDsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVWYWx1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICB9LCB7JGR2OiAnJ30pLAoKICAgICAgICB2YWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgaHRtbDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAgICAgKi8KICAgICAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKGFyZzEsIGFyZzIpIHsKICAgICAgICAgICAgdmFyIGksIGtleTsKCiAgICAgICAgICAgIC8vIEpRTGl0ZUhhc0NsYXNzIGhhcyBvbmx5IHR3byBhcmd1bWVudHMsIGJ1dCBpcyBhIGdldHRlci1vbmx5IGZuLCBzbyB3ZSBuZWVkIHRvIHNwZWNpYWwtY2FzZSBpdAogICAgICAgICAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgICAgICAgICAgaWYgKCgoZm4ubGVuZ3RoID09IDIgJiYgKGZuICE9PSBKUUxpdGVIYXNDbGFzcyAmJiBmbiAhPT0gSlFMaXRlQ29udHJvbGxlcikpID8gYXJnMSA6IGFyZzIpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4gPT09IEpRTGl0ZURhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwga2V5LCBhcmcxW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSByZWFkLCBzbyByZWFkIHRoZSBmaXJzdCBjaGlsZC4KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbih0aGlzWzBdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBzbyBhcHBseSB0byBhbGwgY2hpbGRyZW4KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi4kZHY7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpIHsKICAgICAgICB2YXIgZXZlbnRIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHByZXZlbnQuY2FsbChldmVudCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV0sIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgICAgICAgICAgLy8gYXMgdGhleSB3b3VsZCBjYXVzZSBtZW1vcnkgbGVha3MgaW4gSUU4LgogICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgYmluZDogZnVuY3Rpb24gYmluZEZuKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgICAgIGlmICghZXZlbnRzKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRvd24gPSBhLm5vZGVUeXBlID09PSA5ID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMoYnVwKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYnVwKSAmIDE2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiID09PSBhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZTogIm1vdXNlb3V0IiwgbW91c2VlbnRlcjogIm1vdXNlb3ZlciJ9CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRGbihlbGVtZW50LCBldmVudG1hcFt0eXBlXSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0LCB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV2ZW50Rm5zLnB1c2goZm4pOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICB1bmJpbmQ6IEpRTGl0ZVVuYmluZCwKCiAgICAgICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uIChlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgICAgICAgICB2YXIgaW5kZXgsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0sCgogICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOwogICAgICAgIH0sCgogICAgICAgIGFwcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyYXA6IGZ1bmN0aW9uIChlbGVtZW50LCB3cmFwTm9kZSkgewogICAgICAgICAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSlbMF07CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcE5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdyYXBOb2RlLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uIChlbGVtZW50LCBuZXdFbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5ld0VsZW1lbnQpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBKUUxpdGVBZGRDbGFzcywKICAgICAgICByZW1vdmVDbGFzczogSlFMaXRlUmVtb3ZlQ2xhc3MsCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZGl0aW9uKSkgewogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoY29uZGl0aW9uID8gSlFMaXRlQWRkQ2xhc3MgOiBKUUxpdGVSZW1vdmVDbGFzcykoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIHBhcmVudDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBuZXh0OiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0sCgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgY2xvbmU6IEpRTGl0ZUNsb25lLAoKICAgICAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50TmFtZSkgewogICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSAoSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSB8fCB7fSlbZXZlbnROYW1lXTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRGbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGZuLCBuYW1lKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8gdGhpcyA6IHZhbHVlOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KSB7CiAgICAgICAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwogICAgfQoKICAgIEhhc2hNYXAucHJvdG90eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICAgICAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgICAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqLwogICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqIEByZXR1cm5zIHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgICAgICAgKiBAcGFyYW0ga2V5CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBBIG1hcCB3aGVyZSBtdWx0aXBsZSB2YWx1ZXMgY2FuIGJlIGFkZGVkIHRvIHRoZSBzYW1lIGtleSBzdWNoIHRoYXQgdGhleSBmb3JtIGEgcXVldWUuCiAgICAgKiBAcmV0dXJucyB7SGFzaFF1ZXVlTWFwfQogICAgICovCiAgICBmdW5jdGlvbiBIYXNoUXVldWVNYXAoKSB7CiAgICB9CgogICAgSGFzaFF1ZXVlTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHB1c2gsIGJ1dCB1c2luZyBhbiBhcnJheSBhcyB0aGUgdmFsdWUgZm9yIHRoZSBoYXNoCiAgICAgICAgICovCiAgICAgICAgcHVzaDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSBbdmFsdWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHNoaWZ0LCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHNoaWZ0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiByZXR1cm4gdGhlIGZpcnN0IGl0ZW0gd2l0aG91dCBkZWxldGluZyBpdAogICAgICAgICAqLwogICAgICAgIHBlZWs6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhbiBpbmplY3RvciBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAgICAgKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogICAgICoKCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHlwaWNhbCB1c2FnZQogICAgICogPHByZT4KICAgICAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICAgKgogICAgICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICAgICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICAgKiBAbmFtZSBBVVRPCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbXBsaWNpdCBtb2R1bGUgd2hpY2ggZ2V0cyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIGVhY2gge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKi8KCiAgICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICAgIHZhciBGTl9BUkdfU1BMSVQgPSAvLC87CiAgICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICAgIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CgogICAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgICAgICB2YXIgJGluamVjdCwKICAgICAgICAgICAgZm5UZXh0LAogICAgICAgICAgICBhcmdEZWNsLAogICAgICAgICAgICBsYXN0OwoKICAgICAgICBpZiAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICAgICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICAgICAgICAgIGFyZy5yZXBsYWNlKEZOX0FSRywgZnVuY3Rpb24gKGFsbCwgdW5kZXJzY29yZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZuLiRpbmplY3QgPSAkaW5qZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGZuKSkgewogICAgICAgICAgICBsYXN0ID0gZm4ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm5bbGFzdF0sICdmbicpOwogICAgICAgICAgICAkaW5qZWN0ID0gZm4uc2xpY2UoMCwgbGFzdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sICdmbicsIHRydWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGluamVjdDsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgICAqIGFuZCBsb2FkIG1vZHVsZXMuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkudG9CZSgkaW5qZWN0b3IpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogICAgICoKICAgICAqIEphdmFTY3JpcHQgZG9lcyBub3QgaGF2ZSBhbm5vdGF0aW9ucywgYW5kIGFubm90YXRpb25zIGFyZSBuZWVkZWQgZm9yIGRlcGVuZGVuY3kgaW5qZWN0aW9uLiBUaGUKICAgICAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oc2VydmljZUEpe30pOwogICAgICoKICAgICAqICAgLy8gYW5ub3RhdGVkCiAgICAgKiAgIGZ1bmN0aW9uIGV4cGxpY2l0KHNlcnZpY2VBKSB7fTsKICAgICAqICAgZXhwbGljaXQuJGluamVjdCA9IFsnc2VydmljZUEnXTsKICAgICAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAgICAgKgogICAgICogICAvLyBpbmxpbmUKICAgICAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMjIEluZmVyZW5jZQogICAgICoKICAgICAqIEluIEphdmFTY3JpcHQgY2FsbGluZyBgdG9TdHJpbmcoKWAgb24gYSBmdW5jdGlvbiByZXR1cm5zIHRoZSBmdW5jdGlvbiBkZWZpbml0aW9uLiBUaGUgZGVmaW5pdGlvbiBjYW4gdGhlbiBiZQogICAgICogcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGggbWluaWZpY2F0aW9uLCBhbmQgb2JmdXNjYXRpb24KICAgICAqIHRvb2xzIHNpbmNlIHRoZXNlIHRvb2xzIGNoYW5nZSB0aGUgYXJndW1lbnQgbmFtZXMuCiAgICAgKgogICAgICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICAgICAqIEJ5IGFkZGluZyBhIGAkaW5qZWN0YCBwcm9wZXJ0eSBvbnRvIGEgZnVuY3Rpb24gdGhlIGluamVjdGlvbiBwYXJhbWV0ZXJzIGNhbiBiZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogIyMgSW5saW5lCiAgICAgKiBBcyBhbiBhcnJheSBvZiBpbmplY3Rpb24gbmFtZXMsIHdoZXJlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IGlzIHRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNnZXQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJuIGFuIGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm4geyp9IFRoZSBpbnN0YW5jZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjaW52b2tlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZSB0aGUgbWV0aG9kIGFuZCBzdXBwbHkgdGhlIG1ldGhvZCBhcmd1bWVudHMgZnJvbSB0aGUgYCRpbmplY3RvcmAuCiAgICAgKgogICAgICogQHBhcmFtIHshZnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIFRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY29tZSBmb3JtIHRoZSBmdW5jdGlvbiBhbm5vdGF0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBzZWxmIFRoZSBgdGhpc2AgZm9yIHRoZSBpbnZva2VkIG1ldGhvZC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGUgaW52b2tlZCBgZm5gIGZ1bmN0aW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBKUyB0eXBlLiBUaGUgbWV0aG9kIHRha2VzIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gaW52b2tlcyB0aGUgbmV3IG9wZXJhdG9yIGFuZCBzdXBwbGllcwogICAgICogYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUgY29uc3RydWN0b3IgYW5ub3RhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gbmV3IGluc3RhbmNlIG9mIGBUeXBlYC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjYW5ub3RhdGUKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBzZXJ2aWNlIG5hbWVzIHdoaWNoIHRoZSBmdW5jdGlvbiBpcyByZXF1ZXN0aW5nIGZvciBpbmplY3Rpb24uIFRoaXMgQVBJIGlzIHVzZWQgYnkgdGhlIGluamVjdG9yCiAgICAgKiB0byBkZXRlcm1pbmUgd2hpY2ggc2VydmljZXMgbmVlZCB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbiB3aGVuIHRoZSBmdW5jdGlvbiBpcyBpbnZva2VkLiBUaGVyZSBhcmUgdGhyZWUKICAgICAqIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkIGRlcGVuZGVuY2llcy4KICAgICAqCiAgICAgKiAjIEFyZ3VtZW50IG5hbWVzCiAgICAgKgogICAgICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZSBieSBjb252ZXJ0aW5nCiAgICAgKiB0aGUgZnVuY3Rpb24gaW50byBhIHN0cmluZyB1c2luZyBgdG9TdHJpbmcoKWAgbWV0aG9kIGFuZCBleHRyYWN0aW5nIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIEdpdmVuCiAgICAgKiAgIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRyb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAgICoKICAgICAqICAgLy8gVGhlbgogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCB3b3JrIHdpdGggY29kZSBtaW5maWNhdGlvbiAvIG9iZnVzY2F0aW9uLiBGb3IgdGhpcyByZWFzb24gdGhlIGZvbGxvd2luZyBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMKICAgICAqIGFyZSBzdXBwb3J0ZWQuCiAgICAgKgogICAgICogIyBUaGUgYCRpbmplY3RgIHByb3BlcnR5CiAgICAgKgogICAgICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncyByZXByZXNlbnQgbmFtZXMgb2YKICAgICAqIHNlcnZpY2VzIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgdmFyIE15Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRTY29wZSwgb2JmdXNjYXRlZFJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAgICAgKiAgIC8vIERlZmluZSBmdW5jdGlvbiBkZXBlbmRlbmNpZXMKICAgICAqICAgTXlDb250cm9sbGVyLiRpbmplY3QgPSBbJyRzY29wZScsICckcm91dGUnXTsKICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBUaGUgYXJyYXkgbm90YXRpb24KICAgICAqCiAgICAgKiBJdCBpcyBvZnRlbiBkZXNpcmFibGUgdG8gaW5saW5lIEluamVjdGVkIGZ1bmN0aW9ucyBhbmQgdGhhdCdzIHdoZW4gc2V0dGluZyB0aGUgYCRpbmplY3RgIHByb3BlcnR5IGlzIHZlcnkKICAgICAqIGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMKICAgICAqIG1pbmlmaWNhdGlvbiBpcyBhIGJldHRlciBjaG9pY2U6CiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gV2Ugd2lzaCB0byB3cml0ZSB0aGlzIChub3QgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24gc2FmZSkKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlLCAkcm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICAgICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH07CiAgICAgKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKHRtcEZuKTsKICAgICAqCiAgICAgKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAgICAgKiAgIGluamVjdG9yLmludm9rZShbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZDb21waWxlLCBvYmZSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH1dKTsKICAgICAqCiAgICAgKiAgIC8vIFRoZXJlZm9yZQogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoCiAgICAgKiAgICAgIFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZnVzXyRjb21waWxlLCBvYmZ1c18kcm9vdFNjb3BlKSB7fV0pCiAgICAgKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8gYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZAogICAgICogICBhYm92ZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IFRoZSBuYW1lcyBvZiB0aGUgc2VydmljZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIHJlcXVpcmVzLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSBgJHByb3ZpZGVgIHRvIHJlZ2lzdGVyIG5ldyBwcm92aWRlcnMgd2l0aCB0aGUgYCRpbmplY3RvcmAuIFRoZSBwcm92aWRlcnMgYXJlIHRoZSBmYWN0b3JpZXMgZm9yIHRoZSBpbnN0YW5jZS4KICAgICAqIFRoZSBwcm92aWRlcnMgc2hhcmUgdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5zdGFuY2UgdGhleSBjcmVhdGUgd2l0aCBgUHJvdmlkZXJgIHN1ZmZpeGVkIHRvIHRoZW0uCiAgICAgKgogICAgICogQSBwcm92aWRlciBpcyBhbiBvYmplY3Qgd2l0aCBhIGAkZ2V0KClgIG1ldGhvZC4gVGhlIGluamVjdG9yIGNhbGxzIHRoZSBgJGdldGAgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAgICogYSBzZXJ2aWNlLiBUaGUgUHJvdmlkZXIgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIHdvdWxkIGFsbG93IGZvciBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlci4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBmdW5jdGlvbiBHcmVldFByb3ZpZGVyKCkgewogKiAgICAgdmFyIHNhbHV0YXRpb24gPSAnSGVsbG8nOwogKgogKiAgICAgdGhpcy5zYWx1dGF0aW9uID0gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICBzYWx1dGF0aW9uID0gdGV4dDsKICogICAgIH07CiAqCiAqICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAqICAgICAgICAgcmV0dXJuIHNhbHV0YXRpb24gKyAnICcgKyBuYW1lICsgJyEnOwogKiAgICAgICB9OwogKiAgICAgfTsKICogICB9CiAgICAgKgogICAgICogICBkZXNjcmliZSgnR3JlZXRlcicsIGZ1bmN0aW9uKCl7CiAqCiAqICAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbigkcHJvdmlkZSkgewogKiAgICAgICAkcHJvdmlkZS5wcm92aWRlcignZ3JlZXQnLCBHcmVldFByb3ZpZGVyKTsKICogICAgIH0pKTsKICoKICogICAgIGl0KCdzaG91bGQgZ3JlZXQnLCBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICogICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0hlbGxvIGFuZ3VsYXIhJyk7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGFsbG93IGNvbmZpZ3VyYXRpb24gb2Ygc2FsdXRhdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgICAgICBtb2R1bGUoZnVuY3Rpb24oZ3JlZXRQcm92aWRlcikgewogKiAgICAgICAgIGdyZWV0UHJvdmlkZXIuc2FsdXRhdGlvbignQWhvaicpOwogKiAgICAgICB9KTsKICogICAgICAgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0Fob2ogYW5ndWxhciEnKTsKICogICAgICAgfSk7CiAqICAgICB9KTsKICogPC9wcmU+CiAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNwcm92aWRlcgogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFJlZ2lzdGVyIGEgcHJvdmlkZXIgZm9yIGEgc2VydmljZS4gVGhlIHByb3ZpZGVycyBjYW4gYmUgcmV0cmlldmVkIGFuZCBjYW4gaGF2ZSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuIE5PVEU6IHRoZSBwcm92aWRlciB3aWxsIGJlIGF2YWlsYWJsZSB1bmRlciBgbmFtZSArICdQcm92aWRlcidgIGtleS4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogdGhlbiBpdCBzaG91bGQgaGF2ZSBhIGAkZ2V0YCBtZXRob2QuIFRoZSBgJGdldGAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB1c2luZwogICAgICogICAgICAgICAgICAgICB7QGxpbmsgQVVUTy4kaW5qZWN0b3IjaW52b2tlICRpbmplY3Rvci5pbnZva2UoKX0gd2hlbiBhbiBpbnN0YW5jZSBuZWVkcyB0byBiZSBjcmVhdGVkLgogICAgICogICAtIGBDb25zdHJ1Y3RvcmA6IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBwcm92aWRlciB3aWxsIGJlIGNyZWF0ZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlICRpbmplY3Rvci5pbnN0YW50aWF0ZSgpfSwgdGhlbiB0cmVhdGVkIGFzIGBvYmplY3RgLgogICAgICoKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNmYWN0b3J5CiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiBvbmx5IGAkZ2V0YCBtZXRob2QgaXMgcmVxdWlyZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSAkZ2V0Rm4gVGhlICRnZXRGbiBmb3IgdGhlIGluc3RhbmNlIGNyZWF0aW9uLiBJbnRlcm5hbGx5IHRoaXMgaXMgYSBzaG9ydCBoYW5kIGZvcgogICAgICogYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3NlcnZpY2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNob3J0IGhhbmQgZm9yIHJlZ2lzdGVyaW5nIHNlcnZpY2Ugb2YgZ2l2ZW4gY2xhc3MuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3ZhbHVlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiB0aGUgYCRnZXRgIG1ldGhvZCBpcyBhIGNvbnN0YW50LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNjb25zdGFudAogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgY29uc3RhbnQgdmFsdWUsIGJ1dCB1bmxpa2Uge0BsaW5rIEFVVE8uJHByb3ZpZGUjdmFsdWUgdmFsdWV9IGl0IGNhbiBiZSBpbmplY3RlZAogICAgICogaW50byBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChvdGhlciBtb2R1bGVzKSBhbmQgaXQgaXMgbm90IGludGVyY2VwdGFibGUgYnkKICAgICAqIHtAbGluayBBVVRPLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBjb25zdGFudC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIGNvbnN0YW50IHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBEZWNvcmF0aW9uIG9mIHNlcnZpY2UsIGFsbG93cyB0aGUgZGVjb3JhdG9yIHRvIGludGVyY2VwdCB0aGUgc2VydmljZSBpbnN0YW5jZSBjcmVhdGlvbi4gVGhlCiAgICAgKiByZXR1cm5lZCBpbnN0YW5jZSBtYXkgYmUgdGhlIG9yaWdpbmFsIGluc3RhbmNlLCBvciBhIG5ldyBpbnN0YW5jZSB3aGljaCBkZWxlZ2F0ZXMgdG8gdGhlCiAgICAgKiBvcmlnaW5hbCBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc2VydmljZSB0byBkZWNvcmF0ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZGVjb3JhdG9yIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlIHNlcnZpY2UgbmVlZHMgdG8gYmUKICAgICAqICAgIGluc3RhbnRpYXRlZC4gVGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCB1c2luZyB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZQogICAgICogICAgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLiBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogICAgICoKICAgICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAgICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogICAgICovCgoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICAgICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgICAgICAgIHBhdGggPSBbXSwKICAgICAgICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm92aWRlckluamVjdG9yID0gY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5rbm93biBwcm92aWRlcjogIiArIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGluc3RhbmNlQ2FjaGUgPSB7fSwKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3RvciA9IChpbnN0YW5jZUNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGluc3RhbmNlQ2FjaGUsIGZ1bmN0aW9uIChzZXJ2aWNlbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VuYW1lICsgcHJvdmlkZXJTdWZmaXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShwcm92aWRlci4kZ2V0LCBwcm92aWRlcik7CiAgICAgICAgICAgICAgICB9KSk7CgoKICAgICAgICBmb3JFYWNoKGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyAkcHJvdmlkZXIKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgZnVuY3Rpb24gc3VwcG9ydE9iamVjdChkZWxlZ2F0ZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvdmlkZXIgJyArIG5hbWUgKyAnIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgWyckaW5qZWN0b3InLCBmdW5jdGlvbiAoJGluamVjdG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWx1ZSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgICAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgICAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTW9kdWxlIExvYWRpbmcKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobG9hZGVkTW9kdWxlcy5nZXQobW9kdWxlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgIHJ1bkJsb2NrcyA9IHJ1bkJsb2Nrcy5jb25jYXQobG9hZE1vZHVsZXMobW9kdWxlRm4ucmVxdWlyZXMpKS5jb25jYXQobW9kdWxlRm4uX3J1bkJsb2Nrcyk7CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gaW52b2tlQXJnc1swXSA9PSAnJGluamVjdG9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHByb3ZpZGVySW5qZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgbW9kdWxlOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBTdHJpbmcobW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2VOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdTZXJ2aWNlIG5hbWUgZXhwZWN0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdDaXJjdWxhciBkZXBlbmRlbmN5OiAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsIGksCiAgICAgICAgICAgICAgICAgICAga2V5OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGxvY2Fsc1trZXldCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWZuLiRpbmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgd2UgbXVzdCBiZSBhbiBhcnJheS4KICAgICAgICAgICAgICAgICAgICBmbiA9IGZuW2xlbmd0aF07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8vIFBlcmZvcm1hbmNlIG9wdGltaXphdGlvbjogaHR0cDovL2pzcGVyZi5jb20vYXBwbHktdnMtY2FsbC12cy1pbnZva2UKICAgICAgICAgICAgICAgIHN3aXRjaCAoc2VsZiA/IC0xIDogYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICAwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAxOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDY6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA3OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgODoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddLCBhcmdzWzhdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSwgYXJnc1s5XSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShUeXBlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgICAgICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgICAgICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRhbmNob3JTY3JvbGwKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHRvIHJlbGF0ZWQgZWxlbWVudCwKICAgICAqIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAqIHtAbGluayBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCBIdG1sNSBzcGVjfS4KICAgICAqCiAgICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgICAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICAgICAqLwogICAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgICAgICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uICgkd2luZG93LCAkbG9jYXRpb24sICRyb290U2NvcGUpIHsKICAgICAgICAgICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKCiAgICAgICAgICAgIC8vIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgZmlyc3QgYW5jaG9yIGZyb20gYSBOb2RlTGlzdAogICAgICAgICAgICAvLyBjYW4ndCB1c2UgZmlsdGVyLmZpbHRlciwgYXMgaXQgYWNjZXB0cyBvbmx5IGluc3RhbmNlcyBvZiBBcnJheQogICAgICAgICAgICAvLyBhbmQgSUUgY2FuJ3QgY29udmVydCBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBbXS5zbGljZQogICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogdXNlIGZpbHRlciBpZiB3ZSBjaGFuZ2UgaXQgdG8gYWNjZXB0IGxpc3RzIGFzIHdlbGwKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGxpc3QsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAgICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAgICAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG9lcyBub3Qgc2Nyb2xsIHdoZW4gdXNlciBjbGlja3Mgb24gYW5jaG9yIGxpbmsgdGhhdCBpcyBjdXJyZW50bHkgb24KICAgICAgICAgICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkbG9jYXRpb24uaGFzaCgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbDsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIG9iamVjdCBoYXMgdHdvIGdvYWxzOgogICAgICoKICAgICAqIC0gaGlkZSBhbGwgdGhlIGdsb2JhbCBzdGF0ZSBpbiB0aGUgYnJvd3NlciBjYXVzZWQgYnkgdGhlIHdpbmRvdyBvYmplY3QKICAgICAqIC0gYWJzdHJhY3QgYXdheSBhbGwgdGhlIGJyb3dzZXIgc3BlY2lmaWMgZmVhdHVyZXMgYW5kIGluY29uc2lzdGVuY2llcwogICAgICoKICAgICAqIEZvciB0ZXN0cyB3ZSBwcm92aWRlIHtAbGluayBuZ01vY2suJGJyb3dzZXIgbW9jayBpbXBsZW1lbnRhdGlvbn0gb2YgdGhlIGAkYnJvd3NlcmAKICAgICAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICAgICAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICAgICAqLwogICAgLyoqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkb2N1bWVudCBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRzbmlmZmVyICRzbmlmZmVyIHNlcnZpY2UKICAgICAqLwogICAgZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgICAgICAgIGhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeSwKICAgICAgICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0LAogICAgICAgICAgICBjbGVhclRpbWVvdXQgPSB3aW5kb3cuY2xlYXJUaW1lb3V0LAogICAgICAgICAgICBwZW5kaW5nRGVmZXJJZHMgPSB7fTsKCiAgICAgICAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICAgICAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzID0gW107CgogICAgICAgIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgICAgICAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgICAgICAgc2VsZi4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgICAgICAgKiBjb3VudGVyLiBJZiB0aGUgY291bnRlciByZWFjaGVzIDAsIGFsbCB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AgYXJlIGV4ZWN1dGVkLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIE5vdGU6IHRoaXMgbWV0aG9kIGlzIHVzZWQgb25seSBieSBzY2VuYXJpbyBydW5uZXIKICAgICAgICAgKiBUT0RPKHZvanRhKTogcHJlZml4IHRoaXMgbWV0aG9kIHdpdGggJCQgPwogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIG5vIG91dHN0YW5kaW5nIHJlcXVlc3QKICAgICAgICAgKi8KICAgICAgICBzZWxmLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uIChwb2xsRm4pIHsKICAgICAgICAgICAgICAgIHBvbGxGbigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gUG9sbCBXYXRjaGVyIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgICAgICAgcG9sbFRpbWVvdXQ7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2FkZFBvbGxGbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICAgICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQocG9sbFRpbWVvdXQpKSBzdGFydFBvbGxlcigxMDAsIHNldFRpbWVvdXQpOwogICAgICAgICAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGludGVydmFsIEhvdyBvZnRlbiBzaG91bGQgYnJvd3NlciBjYWxsIHBvbGwgZnVuY3Rpb25zIChtcykKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHNldFRpbWVvdXQgUmVmZXJlbmNlIHRvIGEgcmVhbCBvciBmYWtlIGBzZXRUaW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbmZpZ3VyZXMgdGhlIHBvbGxlciB0byBydW4gaW4gdGhlIHNwZWNpZmllZCBpbnRlcnZhbHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQKICAgICAgICAgKiBzZXRUaW1lb3V0IGZuIGFuZCBraWNrcyBpdCBvZmYuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gc3RhcnRQb2xsZXIoaW50ZXJ2YWwsIHNldFRpbWVvdXQpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbiAocG9sbEZuKSB7CiAgICAgICAgICAgICAgICAgICAgcG9sbEZuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBVUkwgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR0VUVEVSOgogICAgICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICAgICAqCiAgICAgICAgICogU0VUVEVSOgogICAgICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICAgICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAgICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAgICAgKi8KICAgICAgICBzZWxmLnVybCA9IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgLy8gc2V0dGVyCiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICAgICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgICAgICAgICAvLyBnZXR0ZXIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICAgICAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csICInIik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgICAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgICAgICAgZnVuY3Rpb24gZmlyZVVybENoYW5nZSgpIHsKICAgICAgICAgICAgaWYgKGxhc3RCcm93c2VyVXJsID09IHNlbGYudXJsKCkpIHJldHVybjsKCiAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gc2VsZi51cmwoKTsKICAgICAgICAgICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgbGlzdGVuZXIoc2VsZi51cmwoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjb25VcmxDaGFuZ2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAVE9ETyh2b2p0YSk6IHJlZmFjdG9yIHRvIHVzZSBub2RlJ3Mgc3ludGF4IGZvciBldmVudHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQsIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG9ubHkgY2FsbGVkIHdoZW4gdGhlIHVybCBpcyBjaGFuZ2VkIGJ5IG91dHNpZGUgb2YgYW5ndWxhcjoKICAgICAgICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICAgICAgICogLSB1c2VyIGNsaWNrcyBvbiBoaXN0b3J5IChmb3J3YXJkL2JhY2spIGJ1dHRvbgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG5vdCBjYWxsZWQgd2hlbiB1cmwgaXMgY2hhbmdlZCBieSAkYnJvd3Nlci51cmwoKSBtZXRob2QKICAgICAgICAgKgogICAgICAgICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICAgICAgICovCiAgICAgICAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAgICAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAgICAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAgICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIHBvbGxpbmcKICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTWlzYyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nPX0KICAgICAgICAgKi8KICAgICAgICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgICAgICAgICAgcmV0dXJuIGhyZWYgPyBocmVmLnJlcGxhY2UoL15odHRwcz9cOlwvXC9bXlwvXSovLCAnJykgOiAnJzsKICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIENvb2tpZXMgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICB2YXIgbGFzdENvb2tpZXMgPSB7fTsKICAgICAgICB2YXIgbGFzdENvb2tpZVN0cmluZyA9ICcnOwogICAgICAgIHZhciBjb29raWVQYXRoID0gc2VsZi5iYXNlSHJlZigpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNjb29raWVzCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQ29va2llIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIENva2tpZSB2YWx1ZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhlIGNvb2tpZXMgbWV0aG9kIHByb3ZpZGVzIGEgJ3ByaXZhdGUnIGxvdyBsZXZlbCBhY2Nlc3MgdG8gYnJvd3NlciBjb29raWVzLgogICAgICAgICAqIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5LCB1c2UgdGhlICRjb29raWUgc2VydmljZSBpbnN0ZWFkLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZXMgdmFyeSBkZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50cyB0aGF0IHRoZSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIGFzIGZvbGxvd3M6CiAgICAgICAgICogPHVsPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMoKSAtPiBoYXNoIG9mIGFsbCBjb29raWVzLCB0aGlzIGlzIE5PVCBhIGNvcHkgb2YgdGhlIGludGVybmFsIHN0YXRlLCBzbyBkbyBub3QgbW9kaWZ5IGl0PC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llPC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdCB3YXkpPC9saT4KICAgICAgICAgKiA8L3VsPgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgICAgICAgKi8KICAgICAgICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNvb2tpZUxlbmd0aCwgY29va2llQXJyYXksIGNvb2tpZSwgaSwgaW5kZXg7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtwYXRoPSIgKyBjb29raWVQYXRoICsgIjtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggPSAocmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgJz0nICsgZXNjYXBlKHZhbHVlKSArICc7cGF0aD0nICsgY29va2llUGF0aCkubGVuZ3RoICsgMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBlciBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyMTA5LnR4dCBicm93c2VyIG11c3QgYWxsb3cgYXQgbWluaW11bToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDIwIGNvb2tpZXMgcGVyIHVuaXF1ZSBkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSA0MDk2IGJ5dGVzIHBlciBjb29raWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciICsgbmFtZSArICInIHBvc3NpYmx5IG5vdCBzZXQgb3Igb3ZlcmZsb3dlZCBiZWNhdXNlIGl0IHdhcyB0b28gbGFyZ2UgKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgICAgICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcmVkLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25pb3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAgICAgICAqCiAgICAgICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAgICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAgICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24gKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyLmRlZmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgZGVmZXJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVseSBjYW5jZWxlZC4KICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyLmNhbmNlbCA9IGZ1bmN0aW9uIChkZWZlcklkKSB7CiAgICAgICAgICAgIGlmIChwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF0pIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgICAgICAgICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgIH0KCiAgICBmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkd2luZG93LCAkbG9nLCAkc25pZmZlciwgJGRvY3VtZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJyb3dzZXIoJHdpbmRvdywgJGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcik7CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmFjdG9yeSB0aGF0IGNvbnN0cnVjdHMgY2FjaGUgb2JqZWN0cy4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICAgKgogICAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlLgogICAgICogLSBge3sqfX1gIGBnZXQoe3N0cmluZ30ga2V5KWAg4oCUIFJldHVybnMgY2FjaGVkIHZhbHVlIGZvciBga2V5YCBvciB1bmRlZmluZWQgZm9yIGNhY2hlIG1pc3MuCiAgICAgKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZUFsbCgpYCDigJQgUmVtb3ZlcyBhbGwgY2FjaGVkIHZhbHVlcy4KICAgICAqIC0gYHt2b2lkfWAgYGRlc3Ryb3koKWAg4oCUIFJlbW92ZXMgcmVmZXJlbmNlcyB0byB0aGlzIGNhY2hlIGZyb20gJGNhY2hlRmFjdG9yeS4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDYWNoZUZhY3RvcnlQcm92aWRlcigpIHsKCiAgICAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY2FjaGVzID0ge307CgogICAgICAgICAgICBmdW5jdGlvbiBjYWNoZUZhY3RvcnkoY2FjaGVJZCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKGNhY2hlSWQgaW4gY2FjaGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ2NhY2hlSWQgJyArIGNhY2hlSWQgKyAnIHRha2VuJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHNpemUgPSAwLAogICAgICAgICAgICAgICAgICAgIHN0YXRzID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7aWQ6IGNhY2hlSWR9KSwKICAgICAgICAgICAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICAgICAgICAgICAgY2FwYWNpdHkgPSAob3B0aW9ucyAmJiBvcHRpb25zLmNhcGFjaXR5KSB8fCBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSB7fSwKICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc3RhbGVFbmQgPSBudWxsOwoKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF0gPSB7CgogICAgICAgICAgICAgICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubiwgbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBpbmZvOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGNhY2hlRmFjdG9yeS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSB7fTsKICAgICAgICAgICAgICAgIGZvckVhY2goY2FjaGVzLCBmdW5jdGlvbiAoY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24gKGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF07CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHRlbXBsYXRlQ2FjaGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENhY2hlIHVzZWQgZm9yIHN0b3JpbmcgaHRtbCB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbiAoJGNhY2hlRmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgndGVtcGxhdGVzJyk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyogISBWQVJJQUJMRS9GVU5DVElPTiBOQU1JTkcgQ09OVkVOVElPTlMgVEhBVCBBUFBMWSBUTyBUSElTIEZJTEUhCiAgICAgKgogICAgICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogICAgICoKICAgICAqIC0gIm5vZGUiIC0gRE9NIE5vZGUKICAgICAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogICAgICogLSAiJG5vZGUiIG9yICIkZWxlbWVudCIgLSBqcUxpdGUtd3JhcHBlZCBub2RlIG9yIGVsZW1lbnQKICAgICAqCiAgICAgKgogICAgICogQ29tcGlsZXIgcmVsYXRlZCBzdHVmZjoKICAgICAqCiAgICAgKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICAgICAqIC0gIm5vZGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUKICAgICAqIC0gImNoaWxkTGlua0ZuIiAtICBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBjaGlsZCBub2RlcyBvZiBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAgICAgKi8KCgogICAgdmFyIE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gPSAnTm9uLWFzc2lnbmFibGUgbW9kZWwgZXhwcmVzc2lvbjogJzsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbXBpbGVzIGEgcGllY2Ugb2YgSFRNTCBzdHJpbmcgb3IgRE9NIGludG8gYSB0ZW1wbGF0ZSBhbmQgcHJvZHVjZXMgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2hpY2gKICAgICAqIGNhbiB0aGVuIGJlIHVzZWQgdG8gbGluayB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gYW5kIHRoZSB0ZW1wbGF0ZSB0b2dldGhlci4KICAgICAqCiAgICAgKiBUaGUgY29tcGlsYXRpb24gaXMgYSBwcm9jZXNzIG9mIHdhbGtpbmcgdGhlIERPTSB0cmVlIGFuZCB0cnlpbmcgdG8gbWF0Y2ggRE9NIGVsZW1lbnRzIHRvCiAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uIEZvciBlYWNoIG1hdGNoIGl0CiAgICAgKiBleGVjdXRlcyBjb3JyZXNwb25kaW5nIHRlbXBsYXRlIGZ1bmN0aW9uIGFuZCBjb2xsZWN0cyB0aGUKICAgICAqIGluc3RhbmNlIGZ1bmN0aW9ucyBpbnRvIGEgc2luZ2xlIHRlbXBsYXRlIGZ1bmN0aW9uIHdoaWNoIGlzIHRoZW4gcmV0dXJuZWQuCiAgICAgKgogICAgICogVGhlIHRlbXBsYXRlIGZ1bmN0aW9uIGNhbiB0aGVuIGJlIHVzZWQgb25jZSB0byBwcm9kdWNlIHRoZSB2aWV3IG9yIGFzIGl0IGlzIHRoZSBjYXNlIHdpdGgKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgcmVwZWF0ZXJ9IG1hbnktdGltZXMsIGluIHdoaWNoCiAgICAgKiBjYXNlIGVhY2ggY2FsbCByZXN1bHRzIGluIGEgdmlldyB0aGF0IGlzIGEgRE9NIGNsb25lIG9mIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZS4KICAgICAqCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0iY29tcGlsZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICAvLyBkZWNsYXJlIGEgbmV3IG1vZHVsZSwgYW5kIGluamVjdCB0aGUgJGNvbXBpbGVQcm92aWRlcgogICAgIGFuZ3VsYXIubW9kdWxlKCdjb21waWxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0iaHRtbCI+PC90ZXh0YXJlYT4gPGJyPgogICAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBhdXRvIGNvbXBpbGUnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIGlucHV0KCdodG1sJykuZW50ZXIoJ3t7bmFtZX19IScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJ2Rpdltjb21waWxlXScpLnRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgoKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoZW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICAgICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZVssIGNsb25lQXR0YWNoRm5dKX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICAgKgogICAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgICAqICAgICAgICAgICAgICAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAgICogICAgICAgICAgICAgICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgICAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICAgKgogICAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAgICoKICAgICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwgZWxlbWVudAogICAgICogcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICAgKgogICAgICogLSBJZiB5b3UgYXJlIG5vdCBhc2tpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdG8gY2xvbmUgdGhlIHRlbXBsYXRlLCBjcmVhdGUgdGhlIERPTSBlbGVtZW50KHMpCiAgICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPHA+e3t0b3RhbH19PC9wPicpKHNjb3BlKTsKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgdGVtcGxhdGVIVE1MID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgICAqCiAgICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUhUTUwpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIC8vbm93IHdlIGhhdmUgcmVmZXJlbmNlIHRvIHRoZSBjbG9uZWQgRE9NIHZpYSBgY2xvbmVgCiAgICAgKiAgIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgaW5mb3JtYXRpb24gb24gaG93IHRoZSBjb21waWxlciB3b3Jrcywgc2VlIHRoZQogICAgICoge0BsaW5rIGd1aWRlL2NvbXBpbGVyIEFuZ3VsYXIgSFRNTCBDb21waWxlcn0gc2VjdGlvbiBvZiB0aGUgRGV2ZWxvcGVyIEd1aWRlLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICovCiAgICAkQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CiAgICBmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgICAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdcLV9dKylccysoLiopJC8sCiAgICAgICAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd1wtX10rKSg/Olw6KFteO10rKSk/Oz8pLywKICAgICAgICAgICAgTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiA9ICdUZW1wbGF0ZSBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB3YXM6ICcsCiAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfGZpbGUpOi87CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmVzIHdpdGggdGhlIGNvbXBpbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UuIChpZSA8Y29kZT5uZ0JpbmQ8L2NvZGU+IHdoaWNoIHdpbGwgbWF0Y2ggYXMKICAgICAgICAgKiAgICAgICAgICAgICAgICA8Y29kZT5uZy1iaW5kPC9jb2RlPikuCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBBbiBpbmplY3RhYmxlIGRpcmVjdGl2ZSBmYWN0cm95IGZ1bmN0aW9uLiBTZWUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZX0gZm9yIG1vcmUKICAgICAgICAgKiAgICAgICAgICAgICAgICBpbmZvLgogICAgICAgICAqIEByZXR1cm5zIHtuZy4kY29tcGlsZVByb3ZpZGVyfSBTZWxmIGZvciBjaGFpbmluZy4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmRpcmVjdGl2ZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5hbWUpKSB7CiAgICAgICAgICAgICAgICBhc3NlcnRBcmcoZGlyZWN0aXZlRmFjdG9yeSwgJ2RpcmVjdGl2ZScpOwogICAgICAgICAgICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24gKGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlID0gJGluamVjdG9yLmludm9rZShkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0geyBjb21waWxlOiB2YWx1ZUZuKGRpcmVjdGl2ZSkgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlyZWN0aXZlLmNvbXBpbGUgJiYgZGlyZWN0aXZlLmxpbmspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5IHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZSB8fCAoZGlyZWN0aXZlLmNvbnRyb2xsZXIgJiYgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0EnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI3VybFNhbml0aXphdGlvbldoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgICAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICAgICAqCiAgICAgICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8gYW4KICAgICAgICAgKiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIHJlZ3VsYXIKICAgICAgICAgKiBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSB0aGUKICAgICAgICAgKiBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpdCBpcyB3cml0dGVuIGludG8gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAgICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICAgICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMudXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHJlZ2V4cCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsKICAgICAgICAgICAgJyRpbmplY3RvcicsICckaW50ZXJwb2xhdGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJHBhcnNlJywKICAgICAgICAgICAgJyRjb250cm9sbGVyJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGludGVycG9sYXRlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcGFyc2UsICRjb250cm9sbGVyLCAkcm9vdFNjb3BlLCAkZG9jdW1lbnQpIHsKCiAgICAgICAgICAgICAgICB2YXIgQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBBdHRyaWJ1dGVzLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgICAgICAqICAgICBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTmFtZV8odGhpcy4kJGVsZW1lbnRbMF0pID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbk5vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhyZWYgcHJvcGVydHkgYWx3YXlzIHJldHVybnMgbm9ybWFsaXplZCBhYnNvbHV0ZSB1cmwsIHNvIHdlIGNhbiBtYXRjaCBhZ2FpbnN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxTYW5pdGl6YXRpb25Ob2RlLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vcm1hbGl6ZWRWYWwubWF0Y2godXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIE9ic2VydmUgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiBUaGUgb2JzZXJ2ZXIgd2lsbCBuZXZlciBiZSBjYWxsZWQsIGlmIGdpdmVuIGF0dHJpYnV0ZSBpcyBub3QgaW50ZXJwb2xhdGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigqKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgYXR0cmlidXRlIHZhbHVlIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCopfSB0aGUgYGZuYCBGdW5jdGlvbiBwYXNzZWQgaW4uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9ic2VydmU6IGZ1bmN0aW9uIChrZXksIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycyA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sID09ICd9fScpCiAgICAgICAgICAgICAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1x7L2csIHN0YXJ0U3ltYm9sKS5yZXBsYWNlKC99fS9nLCBlbmRTeW1ib2wpOwogICAgICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHJldHVybiBjb21waWxlOwoKICAgICAgICAgICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISgkY29tcGlsZU5vZGVzIGluc3RhbmNlb2YganFMaXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBqcXVlcnkgYWx3YXlzIHJld3JhcHMsIHdoZXJlYXMgd2UgbmVlZCB0byBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgc2VsZWN0b3Igc28gdGhhdCB3ZSBjYW4gbW9kaWZ5IGl0LgogICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBXZSBjYW4gbm90IGNvbXBpbGUgdG9wIGxldmVsIHRleHQgZWxlbWVudHMgc2luY2UgdGV4dCBub2RlcyBjYW4gYmUgbWVyZ2VkIGFuZCB3ZSB3aWxsCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCgkY29tcGlsZU5vZGVzLCBmdW5jdGlvbiAobm9kZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMyAvKiB0ZXh0IG5vZGUgKi8gJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmcoc2NvcGUsICdzY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHNvbWV0aW1lcyBjaGFuZ2VzIHRoZSBzdHJ1Y3R1cmUgb2YgdGhlIERPTS4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRsaW5rTm9kZSA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IEpRTGl0ZVByb3RvdHlwZS5jbG9uZS5jYWxsKCRjb21waWxlTm9kZXMpIC8vIElNUE9SVEFOVCEhIQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXR0YWNoIHNjb3BlIG9ubHkgdG8gbm9uLXRleHQgbm9kZXMuCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9ICRsaW5rTm9kZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEgLyogZWxlbWVudCAqLyB8fCBub2RlLm5vZGVUeXBlID09IDkgLyogZG9jdW1lbnQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbGlua05vZGUuZXEoaSkuZGF0YSgnJHNjb3BlJywgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkbGlua05vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcG9zaXRlTGlua0ZuKSBjb21wb3NpdGVMaW5rRm4oc2NvcGUsICRsaW5rTm9kZSwgJGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRsaW5rTm9kZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHdyb25nTW9kZShsb2NhbE5hbWUsIG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5zdXBwb3J0ZWQgJyIgKyBtb2RlICsgIicgZm9yICciICsgbG9jYWxOYW1lICsgIicuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlLCBzaW5jZSBpdCBtZWFucyB0aGF0IHdlIGFyZSB0cnlpbmcgdG8gc2V0IGNsYXNzIG9uCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNWRyBlbGVtZW50LCB3aGVyZSBjbGFzcyBuYW1lIGlzIHJlYWQtb25seS4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAqIGZvciBhIHBhcnRpY3VsYXIgbm9kZSBhcmUgY29sbGVjdGVkIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhlIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9ucyByZXR1cm4gdmFsdWVzIC0gdGhlIGxpbmtpbmcgZnVuY3Rpb25zIC0gYXJlIGNvbWJpbmVkIGludG8gYSBjb21wb3NpdGUgbGlua2luZwogICAgICAgICAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZUxpc3R9IG5vZGVMaXN0IGFuIGFycmF5IG9mIG5vZGVzIG9yIE5vZGVMaXN0IHRvIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnQ9fSAkcm9vdEVsZW1lbnQgSWYgdGhlIG5vZGVMaXN0IGlzIHRoZSByb290IG9mIHRoZSBjb21waWxhdGlvbiB0cmVlIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBuZWVkZWQgc28gdGhhdCB0aGUganFMaXRlIGNvbGxlY3Rpb24gaXRlbXMgY2FuIGJlIHJlcGxhY2VkIHdpdGggd2lkZ2V0cy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4IGRpcmVjdGl2ZSBwcmlvcml0eQogICAgICAgICAgICAgICAgICogQHJldHVybnMgez9mdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlTm9kZXMobm9kZUxpc3QsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBkaXJlY3RpdmVzLCBhdHRycywgbGlua0ZuRm91bmQ7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbnMucHVzaChjaGlsZExpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiwgaSwgaWksIG47CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gbm9kZUxpc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG4gPSAwLCBpaSA9IGxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuID0gbGlua0Zuc1tpKytdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4uc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoaXNPYmplY3Qobm9kZUxpbmtGbi5zY29wZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUobm9kZSkuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IG5vZGVMaW5rRm4udHJhbnNjbHVkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRUcmFuc2NsdWRlRm4gfHwgKCFib3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAodHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjbG9uZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZVNjb3BlLCBjbG9uZUZuKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmQoJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlU2NvcGUsIHRyYW5zY2x1ZGVTY29wZS4kZGVzdHJveSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAgICAgICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IC8qIEVsZW1lbnQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKS50b0xvd2VyQ2FzZSgpKSwgJ0UnLCBtYXhQcmlvcml0eSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSAwLCBqaiA9IG5BdHRycyAmJiBuQXR0cnMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIgPSBuQXR0cnNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQgY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMgb24gaXQuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sIGpxQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIHByZXZlbnQgZnVydGhlciBwcm9jZXNzaW5nIG9mIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBuZXdTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCB0cmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9PSAnZWxlbWVudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKyB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBqcUxpdGUoJHRlbXBsYXRlWzBdKSwgY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShKUUxpdGVDbG9uZShjb21waWxlTm9kZSkpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOyAvLyBjbGVhciBjb250ZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRlbm9ybWFsaXplVGVtcGxhdGUoZGlyZWN0aXZlVmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJpbShkaXJlY3RpdmVWYWx1ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiArIGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gc3BsaXQgaXQgaW50byB0d28gcGFydHMsIHRob3NlIHRoYXQgd2VyZSBhbHJlYWR5IGFwcGxpZWQgYW5kIHRob3NlIHRoYXQgd2VyZW4ndAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlLCBhZGQgdGhlbSB0byB0aGUgc2Vjb25kIGdyb3VwIGFuZCBzb3J0IHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGFwcGVuZCB0aGUgc2Vjb25kIGdyb3VwIHdpdGggbmV3IGRpcmVjdGl2ZXMgdG8gdGhlIGZpcnN0IGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zcGxpY2UoaSArIDEsIGRpcmVjdGl2ZXMubGVuZ3RoIC0gKGkgKyAxKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUZW1wbGF0ZUF0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcy5zcGxpY2UoaSwgZGlyZWN0aXZlcy5sZW5ndGggLSBpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgZGlyZWN0aXZlLnJlcGxhY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkaXJlY3RpdmUuY29tcGlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBkaXJlY3RpdmUuY29tcGlsZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaW5rRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRMaW5rRm5zKGxpbmtGbi5wcmUsIGxpbmtGbi5wb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4udGVybWluYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IE1hdGgubWF4KHRlcm1pbmFsUHJpb3JpdHksIGRpcmVjdGl2ZS5wcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnNjb3BlID0gbmV3U2NvcGVEaXJlY3RpdmUgJiYgbmV3U2NvcGVEaXJlY3RpdmUuc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gdHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gbWlnaHQgYmUgbm9ybWFsIG9yIGRlbGF5ZWQgbm9kZUxpbmtGbiBkZXBlbmRpbmcgb24gaWYgdGVtcGxhdGVVcmwgaXMgcHJlc2VudAogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlTGlua0ZuOwoKICAgICAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRMaW5rRm5zKHByZSwgcG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3QucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMucHVzaChwb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgodmFsdWUgPSByZXF1aXJlLmNoYXJBdCgwKSkgPT0gJ14nIHx8IHZhbHVlID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ14nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBvcHRpb25hbCB8fCB2YWx1ZSA9PSAnPyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlICYmICFvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJObyBjb250cm9sbGVyOiAiICsgcmVxdWlyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocmVxdWlyZSwgZnVuY3Rpb24gKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSlccyooXHcqKVxzKiQvOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlLiRwYXJlbnQgfHwgc2NvcGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uIChkZWZpbml0b24sIHNjb3BlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IG1hdGNoWzJdIHx8IHNjb3BlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0LCBwYXJlbnRTZXQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGNoYW5nZSwgb3Igd2Ugd2lsbCB0aHJvdyB0aGlzIGV4Y2VwdGlvbiBvbiBldmVyeSAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiArIGF0dHJzW2F0dHJOYW1lXSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgKGRpcmVjdGl2ZTogJyArIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lICsgJyknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBwYXJlbnRWYWx1ZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gc2NvcGVbc2NvcGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgb3V0IG9mIHN5bmMgYW5kIG5lZWQgdG8gY29weQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNoYW5nZWQgYW5kIGl0IGhhcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgcGFyZW50IGNhbiBiZSBhc3NpZ25lZCB0aGVuIGRvIHNvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTZXQocGFyZW50U2NvcGUsIHBhcmVudFZhbHVlID0gbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHBhcmVudFNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCBpc29sYXRlIHNjb3BlIGRlZmluaXRpb24gZm9yIGRpcmVjdGl2ZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSArICc6ICcgKyBkZWZpbml0b24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyRGlyZWN0aXZlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChjb250cm9sbGVyRGlyZWN0aXZlcywgZnVuY3Rpb24gKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IGJvdW5kVHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcHJlTGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVDVVJTSU9OCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gcG9zdExpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBwb3N0TGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCBkZWNvcmF0ZXMgaXQgd2l0aCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIHByb3BlciBwYXJhbWV0ZXJzLiBXZQogICAgICAgICAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAgICAgICAgICogICBTdHJpbmcgY29udGFpbmluZyBhbnkgb2YgdGhlc2VzIGNoYXJhY3RlcnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICAgICAgICAgKiAgICogYEEnOiBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgICAqICAgKiBgQ2A6IGNsYXNzCiAgICAgICAgICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgYWRkZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtYXhQcmlvcml0eSA9PT0gdW5kZWZpbmVkIHx8IG1heFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QuaW5kZXhPZihsb2NhdGlvbikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdERpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAgICAgICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBuZXcgYXR0cmlidXRlcyBvbiB0aGUgb2xkIGF0dHJzIG9iamVjdAogICAgICAgICAgICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsICRlbGVtZW50LmF0dHIoJ3N0eWxlJykgKyAnOycgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0cltrZXldID0gc3JjQXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdEF0dHJzLCAkcm9vdEVsZW1lbnQsIHJlcGxhY2UsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsgdHJpbShjb250ZW50KSArICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SICsgY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wVGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIGRpcmVjdGl2ZXMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMudW5zaGlmdChkZXJpdmVkU3luY0RpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpbmtRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1Jvb3RFbGVtZW50ID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBjb21waWxlTm9kZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9IEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgobGlua1Jvb3RFbGVtZW50LCBqcUxpdGUoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSksIGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbiAocmVzcG9uc2UsIGNvZGUsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHRlbXBsYXRlOiAnICsgY29uZmlnLnVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlua1F1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHJvb3RFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5wcmlvcml0eSAtIGEucHJpb3JpdHk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFzc2VydE5vRHVwbGljYXRlKHdoYXQsIHByZXZpb3VzRGlyZWN0aXZlLCBkaXJlY3RpdmUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ011bHRpcGxlIGRpcmVjdGl2ZXMgWycgKyBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lICsgJywgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUubmFtZSArICddIGFza2luZyBmb3IgJyArIHdoYXQgKyAnIG9uOiAnICsgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh0ZXh0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHBhcmVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goaW50ZXJwb2xhdGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbMF0ubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHZhbHVlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gYXR0ckludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGludGVycG9sYXRlIGNsYXNzZXMgYWdhaW4sIGluIHRoZSBjYXNlIHRoZSBlbGVtZW50IHdhcyByZXBsYWNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB0aGVyZWZvcmUgdGhlIHR3byBjbGFzcyBhdHRycyBnb3QgbWVyZ2VkIC0gd2Ugd2FudCB0byBpbnRlcnBvbGF0ZSB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyW25hbWVdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCQkb2JzZXJ2ZXJzW25hbWVdIHx8ICgkJG9ic2VydmVyc1tuYW1lXSA9IFtdKSkuJCRpbnRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIGEgc3BlY2lhbCBqcUxpdGUucmVwbGFjZVdpdGgsIHdoaWNoIGNhbiByZXBsYWNlIGl0ZW1zIHdoaWNoCiAgICAgICAgICAgICAgICAgKiBoYXZlIG5vIHBhcmVudHMsIHByb3ZpZGVkIHRoYXQgdGhlIGNvbnRhaW5pbmcganFMaXRlIGNvbGxlY3Rpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtKcUxpdGU9fSAkcm9vdEVsZW1lbnQgVGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZS4gVXNlZCBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgICAgICAgICAgICAgKiAgICBpbiB0aGUgcm9vdCBvZiB0aGUgdHJlZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlfSAkZWxlbWVudCBUaGUganFMaXRlIGVsZW1lbnQgd2hpY2ggd2UgYXJlIGdvaW5nIHRvIHJlcGxhY2UuIFdlIGtlZXAgdGhlIHNoZWxsLAogICAgICAgICAgICAgICAgICogICAgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZX0gbmV3Tm9kZSBUaGUgbmV3IERPTSBub2RlLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsICRlbGVtZW50LCBuZXdOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZE5vZGUgPSAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkTm9kZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgICBpLCBpaTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50W2ldID09IG9sZE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSBuZXdOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IG9sZE5vZGVbanFMaXRlLmV4cGFuZG9dOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaVJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4KICAgICAqLwoKCiAgICAvKioKICAgICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAgICovCgogICAgZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLCAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICB9CgogICAgZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwgLyogTm9kZSAqLyBub2RlLCAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LCAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogICAgICogY29udHJvbGxlcnMuCiAgICAgKgogICAgICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogICAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICAgICAgICB2YXIgY29udHJvbGxlcnMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbnRyb2xsZXJQcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAgICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAgICAgICAqLwogICAgICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbiAobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlcnMsIG5hbWUpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sbGVyc1tuYW1lXSA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJGluamVjdG9yLCAkd2luZG93KSB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGNvbnN0cnVjdG9yIElmIGNhbGxlZCB3aXRoIGEgZnVuY3Rpb24gdGhlbiBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgdGhlCiAgICAgICAgICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICAgICAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgICAgICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGB3aW5kb3dbY29uc3RydWN0b3JdYCBvbiB0aGUgZ2xvYmFsIGB3aW5kb3dgIG9iamVjdAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIEluamVjdGlvbiBsb2NhbHMgZm9yIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gSW5zdGFuY2Ugb2YgZ2l2ZW4gY29udHJvbGxlci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIGAkY29udHJvbGxlcmAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgaW5zdGFudGlhdGluZyBjb250cm9sbGVycy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQncyBqdXN0IGEgc2ltcGxlIGNhbGwgdG8ge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0sIGJ1dCBleHRyYWN0ZWQgaW50bwogICAgICAgICAgICAgKiBhIHNlcnZpY2UsIHNvIHRoYXQgb25lIGNhbiBvdmVycmlkZSB0aGlzIHNlcnZpY2Ugd2l0aCB7QGxpbmsgaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTY0OTc4OAogICAgICAgICAgICAgKiBCQyB2ZXJzaW9ufS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoY29uc3RydWN0b3IsIGxvY2FscykgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGNvbnN0cnVjdG9yKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIG5hbWUsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBuYW1lLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oY29uc3RydWN0b3IsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IsIGxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZG9jdW1lbnQKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogICAgICogZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKHdpbmRvdykgewogICAgICAgICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRleGNlcHRpb25IYW5kbGVyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICAgKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICAgICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICAgKgogICAgICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICAgICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICAgICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbiAoJGxvZykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IuYXBwbHkoJGxvZywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRJbnRlcnBvbGF0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBzdGFydFN5bWJvbCA9ICd7eyc7CiAgICAgICAgdmFyIGVuZFN5bWJvbCA9ICd9fSc7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgc3RhcnRpbmcgc3ltYm9sIHRvLgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgZW5kaW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuZW5kU3ltYm9sID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICAgICAgICAgIGVuZFN5bWJvbExlbmd0aCA9IGVuZFN5bWJvbC5sZW5ndGg7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJlcXVpcmVzICRwYXJzZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQ29tcGlsZXMgYSBzdHJpbmcgd2l0aCBtYXJrdXAgaW50byBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBUaGlzIHNlcnZpY2UgaXMgdXNlZCBieSB0aGUKICAgICAgICAgICAgICogSFRNTCB7QGxpbmsgbmcuJGNvbXBpbGUgJGNvbXBpbGV9IHNlcnZpY2UgZm9yIGRhdGEgYmluZGluZy4gU2VlCiAgICAgICAgICAgICAqIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciAkaW50ZXJwb2xhdGVQcm92aWRlcn0gZm9yIGNvbmZpZ3VyaW5nIHRoZQogICAgICAgICAgICAgKiBpbnRlcnBvbGF0aW9uIG1hcmt1cC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgIDxwcmU+CiAgICAgICAgICAgICB2YXIgJGludGVycG9sYXRlID0gLi4uOyAvLyBpbmplY3RlZAogICAgICAgICAgICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgnSGVsbG8ge3tuYW1lfX0hJyk7CiAgICAgICAgICAgICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgICAgICAgICA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG11c3RIYXZlRXhwcmVzc2lvbiBpZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBpbnRlcnBvbGF0aW9uIHN0cmluZyBtdXN0IGhhdmUKICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiBpbiBvcmRlciB0byByZXR1cm4gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gU3RyaW5ncyB3aXRoIG5vCiAgICAgICAgICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0KX0gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlIGludGVycG9sYXRlZAogICAgICAgICAgICAgKiAgICBzdHJpbmcuIFRoZSBmdW5jdGlvbiBoYXMgdGhlc2UgcGFyYW1ldGVyczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGA6IGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncyBhcmUgZXZhbHVhdGVkCiAgICAgICAgICAgICAqICAgICAgYWdhaW5zdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uICRpbnRlcnBvbGF0ZSh0ZXh0LCBtdXN0SGF2ZUV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4LAogICAgICAgICAgICAgICAgICAgIGVuZEluZGV4LAogICAgICAgICAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRleHQubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBmbiwKICAgICAgICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgICAgICAgY29uY2F0ID0gW107CgogICAgICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uIHx8IGhhc0ludGVycG9sYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBjb25jYXQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbGVuZ3RoLCBwYXJ0OyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFydCAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmNhdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI2VuZFN5bWJvbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkaW50ZXJwb2xhdGU7CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFVSTF9NQVRDSCA9IC9eKFteOl0rKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcez9bXHdcLi1dKlx9PykoOihbMC05XSspKT8oXC9bXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIFBBVEhfTUFUQ0ggPSAvXihbXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIEhBU0hfTUFUQ0ggPSBQQVRIX01BVENILAogICAgICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzogMjF9OwoKCiAgICAvKioKICAgICAqIEVuY29kZSBwYXRoIHVzaW5nIGVuY29kZVVyaVNlZ21lbnQsIGlnbm9yaW5nIGZvcndhcmQgc2xhc2hlcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFBhdGggdG8gZW5jb2RlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICAgICAgICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJyksCiAgICAgICAgICAgIGkgPSBzZWdtZW50cy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBlbmNvZGVVcmlTZWdtZW50KHNlZ21lbnRzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWF0Y2hVcmwodXJsLCBvYmopIHsKICAgICAgICB2YXIgbWF0Y2ggPSBVUkxfTUFUQ0guZXhlYyh1cmwpOwoKICAgICAgICBtYXRjaCA9IHsKICAgICAgICAgICAgcHJvdG9jb2w6IG1hdGNoWzFdLAogICAgICAgICAgICBob3N0OiBtYXRjaFszXSwKICAgICAgICAgICAgcG9ydDogaW50KG1hdGNoWzVdKSB8fCBERUZBVUxUX1BPUlRTW21hdGNoWzFdXSB8fCBudWxsLAogICAgICAgICAgICBwYXRoOiBtYXRjaFs2XSB8fCAnLycsCiAgICAgICAgICAgIHNlYXJjaDogbWF0Y2hbOF0sCiAgICAgICAgICAgIGhhc2g6IG1hdGNoWzEwXQogICAgICAgIH07CgogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgb2JqLiQkcHJvdG9jb2wgPSBtYXRjaC5wcm90b2NvbDsKICAgICAgICAgICAgb2JqLiQkaG9zdCA9IG1hdGNoLmhvc3Q7CiAgICAgICAgICAgIG9iai4kJHBvcnQgPSBtYXRjaC5wb3J0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChwcm90b2NvbCwgaG9zdCwgcG9ydCkgewogICAgICAgIHJldHVybiBwcm90b2NvbCArICc6Ly8nICsgaG9zdCArIChwb3J0ID09IERFRkFVTFRfUE9SVFNbcHJvdG9jb2xdID8gJycgOiAnOicgKyBwb3J0KTsKICAgIH0KCgogICAgZnVuY3Rpb24gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSB7CiAgICAgICAgcmV0dXJuIGJhc2VQYXRoLnN1YnN0cigwLCBiYXNlUGF0aC5sYXN0SW5kZXhPZignLycpKTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSHRtbDVVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaHRtbDUgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSAhPSBiYXNlUGF0aCB8fCBpc1VuZGVmaW5lZChtYXRjaC5oYXNoKSB8fAogICAgICAgICAgICBtYXRjaC5oYXNoLmluZGV4T2YoaGFzaFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICAgICAgLy8gY29udmVydCBoYXNoYmFuZyB1cmwgLT4gaHRtbDUgdXJsCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpICsgbWF0Y2guaGFzaC5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSGFzaGJhbmdVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaGFzaGJhbmcgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSA9PSBiYXNlUGF0aCAmJiAhaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgJiYKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaHRtbDUgdXJsIC0+IGhhc2hiYW5nIHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSBtYXRjaC5zZWFyY2ggJiYgJz8nICsgbWF0Y2guc2VhcmNoIHx8ICcnLAogICAgICAgICAgICAgICAgaGFzaCA9IG1hdGNoLmhhc2ggJiYgJyMnICsgbWF0Y2guaGFzaCB8fCAnJywKICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpLAogICAgICAgICAgICAgICAgcGF0aCA9IG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKTsKCiAgICAgICAgICAgIGlmIChtYXRjaC5wYXRoLmluZGV4T2YocGF0aFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIHVybCArICciLCBtaXNzaW5nIHBhdGggcHJlZml4ICInICsgcGF0aFByZWZpeCArICciICEnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArIGJhc2VQYXRoICsKICAgICAgICAgICAgICAgICcjJyArIGhhc2hQcmVmaXggKyBwYXRoICsgc2VhcmNoICsgaGFzaDsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25VcmwgcmVwcmVzZW50cyBhbiB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIVE1MNSB1cmwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoUHJlZml4CiAgICAgKi8KICAgIGZ1bmN0aW9uIExvY2F0aW9uVXJsKHVybCwgcGF0aFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4IHx8ICcnOwoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZSBnaXZlbiBodG1sNSAocmVndWxhcikgdXJsIHN0cmluZyBpbnRvIHByb3BlcnRpZXMKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3QWJzb2x1dGVVcmwgSFRNTDUgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAobmV3QWJzb2x1dGVVcmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwobmV3QWJzb2x1dGVVcmwsIHRoaXMpOwoKICAgICAgICAgICAgaWYgKG1hdGNoLnBhdGguaW5kZXhPZihwYXRoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgbmV3QWJzb2x1dGVVcmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2guaGFzaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICAgICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICAgICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgICAgICAgdGhpcy4kJGFic1VybCA9IGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KHRoaXMuJCRwcm90b2NvbCwgdGhpcy4kJGhvc3QsIHRoaXMuJCRwb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgdGhpcy4kJHVybDsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGRpc2FibGVkIG9yIG5vdCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTGVnYWN5IHVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHZhciBiYXNlUGF0aDsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCwgdGhpcyk7CgoKICAgICAgICAgICAgaWYgKG1hdGNoLmhhc2ggJiYgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBoYXNoIHByZWZpeCAiJyArIGhhc2hQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJhc2VQYXRoID0gbWF0Y2gucGF0aCArIChtYXRjaC5zZWFyY2ggPyAnPycgKyBtYXRjaC5zZWFyY2ggOiAnJyk7CiAgICAgICAgICAgIG1hdGNoID0gSEFTSF9NQVRDSC5leGVjKChtYXRjaC5oYXNoIHx8ICcnKS5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkcGF0aCA9IChtYXRjaFsxXS5jaGFyQXQoMCkgPT0gJy8nID8gJycgOiAnLycpICsgZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoWzNdKTsKICAgICAgICAgICAgdGhpcy4kJGhhc2ggPSBtYXRjaFs1XSAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbNV0pIHx8ICcnOwoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydCh0aGlzLiQkcHJvdG9jb2wsIHRoaXMuJCRob3N0LCB0aGlzLiQkcG9ydCkgKwogICAgICAgICAgICAgICAgYmFzZVBhdGggKyAodGhpcy4kJHVybCA/ICcjJyArIGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsIDogJycpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24gKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZiAoYWJzb2x1dGVMaW5rVXJsLmluZGV4T2YoYXBwQmFzZVVybCkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFic29sdXRlTGlua1VybDsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHRoaXMuJCRwYXJzZSh1cmwpOwogICAgfQoKCiAgICBMb2NhdGlvblVybC5wcm90b3R5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICoge0BsaW5rIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IFJGQyAzOTg2fS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgKi8KICAgICAgICBhYnNVcmw6IGxvY2F0aW9uR2V0dGVyKCckJGFic1VybCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICAgICAgICovCiAgICAgICAgdXJsOiBmdW5jdGlvbiAodXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB0aGlzLnBhdGgoZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKSk7CiAgICAgICAgICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgICAgICAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycsIHJlcGxhY2UpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAgICAgICAqLwogICAgICAgIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI2hvc3QKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqLwogICAgICAgIGhvc3Q6IGxvY2F0aW9uR2V0dGVyKCckJGhvc3QnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwb3J0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcG9ydCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge051bWJlcn0gcG9ydAogICAgICAgICAqLwogICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwYXRoCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAgICAgICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhdGggTmV3IHBhdGgKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgICAgICAgKi8KICAgICAgICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdDxzdHJpbmcsc3RyaW5nPj19IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvciBoYXNoIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZywgdGhlbiBgcGFyYW1WYWx1ZWAgd2lsbCBvdmVycmlkZSBvbmx5IGEKICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHNlYXJjaAogICAgICAgICAqLwogICAgICAgIHNlYXJjaDogZnVuY3Rpb24gKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoc2VhcmNoKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkc2VhcmNoOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChwYXJhbVZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy4kJHNlYXJjaFtzZWFyY2hdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoW3NlYXJjaF0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IGlzU3RyaW5nKHNlYXJjaCkgPyBwYXJzZUtleVZhbHVlKHNlYXJjaCkgOiBzZWFyY2g7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jaGFzaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGhhc2ggTmV3IGhhc2ggZnJhZ21lbnQKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgICAgICAgKi8KICAgICAgICBoYXNoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRoYXNoJywgaWRlbnRpdHkpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3JlcGxhY2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAgICAgICAqLwogICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9OwoKICAgIExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvblVybC5wcm90b3R5cGUpOwoKICAgIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCwgYmFzZUV4dHJhKSB7CiAgICAgICAgTG9jYXRpb25IYXNoYmFuZ1VybC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZVVybCArIGJhc2VFeHRyYSArICcjJyArIGhhc2hQcmVmaXggKyBhYnNvbHV0ZUxpbmtVcmwuc3Vic3RyKGFwcEJhc2VVcmwubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybC5wcm90b3R5cGUgPSBpbmhlcml0KExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKCiAgICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gcHJlcHJvY2Vzcyh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbgogICAgICoKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogICAgICoge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3dpbmRvdy5sb2NhdGlvbiB3aW5kb3cubG9jYXRpb259KSBhbmQgbWFrZXMgdGhlIFVSTAogICAgICogYXZhaWxhYmxlIHRvIHlvdXIgYXBwbGljYXRpb24uIENoYW5nZXMgdG8gdGhlIFVSTCBpbiB0aGUgYWRkcmVzcyBiYXIgYXJlIHJlZmxlY3RlZCBpbnRvCiAgICAgKiAkbG9jYXRpb24gc2VydmljZSBhbmQgY2hhbmdlcyB0byAkbG9jYXRpb24gYXJlIHJlZmxlY3RlZCBpbnRvIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLgogICAgICoKICAgICAqICoqVGhlICRsb2NhdGlvbiBzZXJ2aWNlOioqCiAgICAgKgogICAgICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogICAgICogICAtIFdhdGNoIGFuZCBvYnNlcnZlIHRoZSBVUkwuCiAgICAgKiAgIC0gQ2hhbmdlIHRoZSBVUkwuCiAgICAgKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogICAgICogICAtIENoYW5nZXMgdGhlIGFkZHJlc3MgYmFyLgogICAgICogICAtIENsaWNrcyB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiAob3IgY2xpY2tzIGEgSGlzdG9yeSBsaW5rKS4KICAgICAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogICAgICogLSBSZXByZXNlbnRzIHRoZSBVUkwgb2JqZWN0IGFzIGEgc2V0IG9mIG1ldGhvZHMgKHByb3RvY29sLCBob3N0LCBwb3J0LCBwYXRoLCBzZWFyY2gsIGhhc2gpLgogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnNlcnZpY2VzLiRsb2NhdGlvbiBEZXZlbG9wZXIgR3VpZGU6IEFuZ3VsYXIKICAgICAqIFNlcnZpY2VzOiBVc2luZyAkbG9jYXRpb259CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICAgICAqLwogICAgZnVuY3Rpb24gJExvY2F0aW9uUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbiAocHJlZml4KSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocHJlZml4KSkgewogICAgICAgICAgICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhc2hQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNodG1sNU1vZGUKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1vZGUgVXNlIEhUTUw1IHN0cmF0ZWd5IGlmIGF2YWlsYWJsZS4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAgICAgICAqLwogICAgICAgIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24gKG1vZGUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChtb2RlKSkgewogICAgICAgICAgICAgICAgaHRtbDVNb2RlID0gbW9kZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw1TW9kZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckc25pZmZlcicsICckcm9vdEVsZW1lbnQnLAogICAgICAgICAgICBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGJyb3dzZXIsICRzbmlmZmVyLCAkcm9vdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciAkbG9jYXRpb24sCiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGgsCiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCwKICAgICAgICAgICAgICAgICAgICBpbml0VXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybFBhcnRzID0gbWF0Y2hVcmwoaW5pdFVybCksCiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybDsKCiAgICAgICAgICAgICAgICBpZiAoaHRtbDVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGggPSAkYnJvd3Nlci5iYXNlSHJlZigpIHx8ICcvJzsKICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKTsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggKyAnLyc7CgogICAgICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvblVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0h0bWw1VXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0hhc2hiYW5nVXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VQYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCArIDEpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmwgPQogICAgICAgICAgICAgICAgICAgICAgICBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChpbml0VXJsUGFydHMucHJvdG9jb2wsIGluaXRVcmxQYXJ0cy5ob3N0LCBpbml0VXJsUGFydHMucG9ydCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5wYXRoIHx8ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaW5pdFVybFBhcnRzLnNlYXJjaCA/ICgnPycgKyBpbml0VXJsUGFydHMuc2VhcmNoKSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ1VybChpbml0VXJsLCBoYXNoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGVBcHBVcmwoYWJzSHJlZik7CgogICAgICAgICAgICAgICAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdFVybCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgICAgICAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24gKG5ld1VybCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgbmV3VXJsLCAkbG9jYXRpb24uYWJzVXJsKCkpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGxvY2F0aW9uLmFic1VybCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG5ld1VybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlIGJyb3dzZXIKICAgICAgICAgICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMDsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uICRsb2NhdGlvbldhdGNoKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlcGxhY2UgPSAkbG9jYXRpb24uJCRyZXBsYWNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWNoYW5nZUNvdW50ZXIgfHwgb2xkVXJsICE9ICRsb2NhdGlvbi5hYnNVcmwoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2cKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgICAqCiAgICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICBNZXNzYWdlOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNsb2cKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIGxvZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2luZm8KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZXJyb3IKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wOwoKICAgICAgICAgICAgICAgIGlmIChsb2dGbi5hcHBseSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goZm9ybWF0RXJyb3IoYXJnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9nRm4uYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgICAgICAgICAgICAvLyBvciB3ZSBhcmUgSUUgd2hlcmUgY29uc29sZS5sb2cgZG9lc24ndCBoYXZlIGFwcGx5IHNvIHdlIGxvZyBhdCBsZWFzdCBmaXJzdCAyIGFyZ3MKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJnMSwgYXJnMikgewogICAgICAgICAgICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIE9QRVJBVE9SUyA9IHsKICAgICAgICAnbnVsbCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgICAndHJ1ZSc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAnZmFsc2UnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHVuZGVmaW5lZDogbm9vcCwKICAgICAgICAnKyc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgYSA9IGEoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgYiA9IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0RlZmluZWQoYikgPyBiIDogdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJy0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIHJldHVybiAoaXNEZWZpbmVkKGEpID8gYSA6IDApIC0gKGlzRGVmaW5lZChiKSA/IGIgOiAwKTsKICAgICAgICB9LAogICAgICAgICcqJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICogYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJy8nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgLyBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAlIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICdeJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpIF4gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJz0nOiBub29wLAogICAgICAgICc9PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA9PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnIT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgIT0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJzwnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA+IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICc8PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA8PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPj0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPj0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyYmJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICYmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICd8fCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSB8fCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhfGI7fSwKICAgICAgICAnfCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgfSwKICAgICAgICAnISc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEpIHsKICAgICAgICAgICAgcmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBFU0NBUEUgPSB7Im4iOiAiXG4iLCAiZiI6ICJcZiIsICJyIjogIlxyIiwgInQiOiAiXHQiLCAidiI6ICJcdiIsICInIjogIiciLCAnIic6ICciJ307CgogICAgZnVuY3Rpb24gbGV4KHRleHQsIGNzcCkgewogICAgICAgIHZhciB0b2tlbnMgPSBbXSwKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAganNvbiA9IFtdLAogICAgICAgICAgICBjaCwKICAgICAgICAgICAgbGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBpZiAoaXMoJyJcJycpKSB7CiAgICAgICAgICAgICAgICByZWFkU3RyaW5nKGNoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihjaCkgfHwgaXMoJy4nKSAmJiBpc051bWJlcihwZWVrKCkpKSB7CiAgICAgICAgICAgICAgICByZWFkTnVtYmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNJZGVudChjaCkpIHsKICAgICAgICAgICAgICAgIHJlYWRJZGVudCgpOwogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllcnMgY2FuIG9ubHkgYmUgaWYgdGhlIHByZWNlZGluZyBjaGFyIHdhcyBhIHsgb3IgLAogICAgICAgICAgICAgICAgaWYgKHdhcygneywnKSAmJiBqc29uWzBdID09ICd7JyAmJgogICAgICAgICAgICAgICAgICAgICh0b2tlbiA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4uanNvbiA9IHRva2VuLnRleHQuaW5kZXhPZignLicpID09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzKCcoKXt9W10uLDs6JykpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogY2gsCiAgICAgICAgICAgICAgICAgICAganNvbjogKHdhcygnOlssJykgJiYgaXMoJ3tbJykpIHx8IGlzKCd9XTosJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGlzKCd7WycpKSBqc29uLnVuc2hpZnQoY2gpOwogICAgICAgICAgICAgICAgaWYgKGlzKCd9XScpKSBqc29uLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjaDIgPSBjaCArIHBlZWsoKSwKICAgICAgICAgICAgICAgICAgICBmbiA9IE9QRVJBVE9SU1tjaF0sCiAgICAgICAgICAgICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgICAgICAgICBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OiBpbmRleCwgdGV4dDogY2gyLCBmbjogZm4yfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IGluZGV4LCB0ZXh0OiBjaCwgZm46IGZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0Q2ggPSBjaDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuczsKCiAgICAgICAgZnVuY3Rpb24gaXMoY2hhcnMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLmluZGV4T2YoY2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2FzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGxhc3RDaCkgIT0gLTE7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKCkgewogICAgICAgICAgICByZXR1cm4gaW5kZXggKyAxIDwgdGV4dC5sZW5ndGggPyB0ZXh0LmNoYXJBdChpbmRleCArIDEpIDogZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc051bWJlcihjaCkgewogICAgICAgICAgICByZXR1cm4gJzAnIDw9IGNoICYmIGNoIDw9ICc5JzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzV2hpdGVzcGFjZShjaCkgewogICAgICAgICAgICByZXR1cm4gY2ggPT0gJyAnIHx8IGNoID09ICdccicgfHwgY2ggPT0gJ1x0JyB8fAogICAgICAgICAgICAgICAgY2ggPT0gJ1xuJyB8fCBjaCA9PSAnXHYnIHx8IGNoID09ICdcdTAwQTAnOyAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNJZGVudChjaCkgewogICAgICAgICAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAgICAgJ18nID09IGNoIHx8IGNoID09ICckJzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRXhwT3BlcmF0b3IoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICctJyB8fCBjaCA9PSAnKycgfHwgaXNOdW1iZXIoY2gpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJMZXhlciBFcnJvcjogIiArIGVycm9yICsgIiBhdCBjb2x1bW4iICsKICAgICAgICAgICAgICAgIChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAiLSIgKyBpbmRleCArICIgWyIgKyB0ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKSArICJdIgogICAgICAgICAgICAgICAgICAgIDogIiAiICsgZW5kKSArCiAgICAgICAgICAgICAgICAiIGluIGV4cHJlc3Npb24gWyIgKyB0ZXh0ICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkTnVtYmVyKCkgewogICAgICAgICAgICB2YXIgbnVtYmVyID0gIiI7CiAgICAgICAgICAgIHZhciBzdGFydCA9IGluZGV4OwogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIGNoID0gbG93ZXJjYXNlKHRleHQuY2hhckF0KGluZGV4KSk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBlZWtDaCA9IHBlZWsoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIGlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBwZWVrQ2ggJiYgaXNOdW1iZXIocGVla0NoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCFwZWVrQ2ggfHwgIWlzTnVtYmVyKHBlZWtDaCkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBudW1iZXIgPSAxICogbnVtYmVyOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IHN0YXJ0LCB0ZXh0OiBudW1iZXIsIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXI7CiAgICAgICAgICAgICAgICB9fSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkSWRlbnQoKSB7CiAgICAgICAgICAgIHZhciBpZGVudCA9ICIiLAogICAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleCwKICAgICAgICAgICAgICAgIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzSWRlbnQoY2gpIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicpIGxhc3REb3QgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgICAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgICAgICAgICBwZWVrSW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgICAgICAgdGV4dDogaWRlbnQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgICAgICAgICB0b2tlbi5mbiA9IHRva2VuLmpzb24gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCBjc3ApOwogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnLicsCiAgICAgICAgICAgICAgICAgICAganNvbjogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZFN0cmluZyhxdW90ZSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiOwogICAgICAgICAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICAgICAgICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ3UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZXggPSB0ZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGluZGV4ICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09IHF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dFcnJvcigiVW50ZXJtaW5hdGVkIHF1b3RlIiwgc3RhcnQpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gcGFyc2VyKHRleHQsIGpzb24sICRmaWx0ZXIsIGNzcCkgewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHRyYSBsZXZlbCBvZiBhbGlhc2luZyBpcyBoZXJlLCBqdXN0IGluIGNhc2UgdGhlIGxleGVyIG1pc3NlcyBzb21ldGhpbmcsIHNvIHRoYXQKICAgICAgICAgICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgICAgICAgICAgYXNzaWdubWVudCA9IGxvZ2ljYWxPUjsKICAgICAgICAgICAgZnVuY3Rpb25DYWxsID0KICAgICAgICAgICAgICAgIGZpZWxkQWNjZXNzID0KICAgICAgICAgICAgICAgICAgICBvYmplY3RJbmRleCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckNoYWluID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHt0ZXh0OiB0ZXh0LCBpbmRleDogMH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFsdWUgPSBwcmltYXJ5KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnRzKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93RXJyb3IoImlzIGFuIHVuZXhwZWN0ZWQgdG9rZW4iLCB0b2tlbnNbMF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihtc2csIHRva2VuKSB7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJTeW50YXggRXJyb3I6IFRva2VuICciICsgdG9rZW4udGV4dCArCiAgICAgICAgICAgICAgICAiJyAiICsgbXNnICsgIiBhdCBjb2x1bW4gIiArCiAgICAgICAgICAgICAgICAodG9rZW4uaW5kZXggKyAxKSArICIgb2YgdGhlIGV4cHJlc3Npb24gWyIgKwogICAgICAgICAgICAgICAgdGV4dCArICJdIHN0YXJ0aW5nIGF0IFsiICsgdGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246ICIgKyB0ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1swXTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBlZWsoZTEsIGUyLCBlMywgZTQpIHsKICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnNbMF07CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgICAgICAgICAgICBpZiAodCA9PSBlMSB8fCB0ID09IGUyIHx8IHQgPT0gZTMgfHwgdCA9PSBlNCB8fAogICAgICAgICAgICAgICAgICAgICghZTEgJiYgIWUyICYmICFlMyAmJiAhZTQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cGVjdChlMSwgZTIsIGUzLCBlNCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBwZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgICAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgICAgICBpZiAoanNvbiAmJiAhdG9rZW4uanNvbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdG9rZW5zLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3VtZShlMSkgewogICAgICAgICAgICBpZiAoIWV4cGVjdChlMSkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbIiArIGUxICsgIl0iLCBwZWVrKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeUZuKGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluYXJ5Rm4obGVmdCwgZm4sIHJpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGF0ZW1lbnRzKCkgewogICAgICAgICAgICB2YXIgc3RhdGVtZW50cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWx0ZXIoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICAgICAgICB2YXIgZm4gPSAkZmlsdGVyKHRva2VuLnRleHQpOwogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwcmVzc2lvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9hc3NpZ25tZW50KCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGxvZ2ljYWxPUigpOwogICAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPScpKSkgewogICAgICAgICAgICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImltcGxpZXMgYXNzaWdubWVudCBidXQgWyIgKwogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnN1YnN0cmluZygwLCB0b2tlbi5pbmRleCkgKyAiXSBjYW4gbm90IGJlIGFzc2lnbmVkIHRvIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmlnaHQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxPUigpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsQU5EKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJ3x8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9naWNhbEFORCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBlcXVhbGl0eSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJyYmJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGxvZ2ljYWxBTkQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBlcXVhbGl0eSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSByZWxhdGlvbmFsKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPT0nLCAnIT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCAnLScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBtdWx0aXBsaWNhdGl2ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG11bHRpcGxpY2F0aXZlKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHVuYXJ5KCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKCh0b2tlbiA9IGV4cGVjdCgnKicsICcvJywgJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgICAgICAgIHdoaWxlICgobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSU1QT1NTSUJMRSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpZWxkQWNjZXNzKG9iamVjdCkgewogICAgICAgICAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIGNzcCk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2NvcGUsIGxvY2Fscywgc2VsZikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9vYmplY3RJbmRleChvYmopIHsKICAgICAgICAgICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCgKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICB2LCBwOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgdiA9IG9baV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHYgJiYgdi50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSB2OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgnJCR2JyBpbiB2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmooc2VsZiwgbG9jYWxzKVtpbmRleEZuKHNlbGYsIGxvY2FscyldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKICAgICAgICAgICAgICAgIC8vIElFIHN0dXBpZGl0eSEKICAgICAgICAgICAgICAgIHJldHVybiBmblB0ci5hcHBseQogICAgICAgICAgICAgICAgICAgID8gZm5QdHIuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgICAgICAgICAgICA6IGZuUHRyKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogICAgICAgIGZ1bmN0aW9uIGFycmF5RGVjbGFyYXRpb24oKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICddJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChleHByZXNzaW9uKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50Rm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb2JqZWN0KCkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVzID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICd9JykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3VtZSgnfScpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHNldHRlcihvYmosIHBhdGgsIHNldFZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LnNoaWZ0KCk7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICAgICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgICB9CiAgICAgICAgb2JqW2VsZW1lbnQuc2hpZnQoKV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2VzaWJsZSBmcm9tIHRoZSBvYmplY3QgYnkgcGF0aC4gQW55IHVuZGVmaW5lZCB0cmF2ZXJzYWxzIGFyZSBpZ25vcmVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIHN0YXJ0aW5nIG9iamVjdAogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggcGF0aCB0byB0cmF2ZXJzZQogICAgICogQHBhcmFtIHtib29sZWFuPXRydWV9IGJpbmRGblRvU2NvcGUKICAgICAqIEByZXR1cm5zIHZhbHVlIGFzIGFjY2VzYmlsZSBieSBwYXRoCiAgICAgKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICB2YXIgZ2V0dGVyRm5DYWNoZSA9IHt9OwoKICAgIC8qKgogICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlICJCbGFjayBIb2xlIiB2YXJpYW50IGZyb206CiAgICAgKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9wYXRoLWV2YWx1YXRpb24tc2ltcGxpZmllZC83CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgaWYgKHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkxIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkzIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXk0IHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3ApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbigKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXQogICAgICAgICAgICAgICAgICAgICkoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB2YWw7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjb2RlID0gJ3ZhciBsLCBmbiwgcDtcbic7CiAgICAgICAgICAgIGZvckVhY2gocGF0aEtleXMsIGZ1bmN0aW9uIChrZXksIGluZGV4KSB7CiAgICAgICAgICAgICAgICBjb2RlICs9ICdpZihzID09PSBudWxsIHx8IHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgICAgICAgICAnbD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ3M9JyArIChpbmRleAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHA9cztcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXSA9IGZuOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHBhcnNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgICAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAgICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICAgKgogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHRpcGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqCiAgICAgKiAgICBUaGUgcmV0dXJuIGZ1bmN0aW9uIGFsc28gaGFzIGFuIGBhc3NpZ25gIHByb3BlcnR5LCBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB3aGljaAogICAgICogICAgYWxsb3dzIG9uZSB0byBzZXQgdmFsdWVzIHRvIGV4cHJlc3Npb25zLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNhY2hlID0ge307CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckZmlsdGVyJywgJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXhwKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHApIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGUuaGFzT3duUHJvcGVydHkoZXhwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjYWNoZVtleHBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNhY2hlW2V4cF0gPSBwYXJzZXIoZXhwLCBmYWxzZSwgJGZpbHRlciwgJHNuaWZmZXIuY3NwKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHA7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJHEKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogICAgICoKICAgICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgICAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICAgICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAgICoKICAgICAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICAgICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgc2NvcGVgIGFyZQogICAgICogICAvLyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICAgICAqCiAgICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIC8vIHNpbmNlIHRoaXMgZm4gZXhlY3V0ZXMgYXN5bmMgaW4gYSBmdXR1cmUgdHVybiBvZiB0aGUgZXZlbnQgbG9vcCwgd2UgbmVlZCB0byB3cmFwCiAqICAgICAgIC8vIG91ciBjb2RlIGludG8gYW4gJGFwcGx5IGNhbGwgc28gdGhhdCB0aGUgbW9kZWwgY2hhbmdlcyBhcmUgcHJvcGVybHkgb2JzZXJ2ZWQuCiAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0pOwogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAgICAgKgogICAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAgICogY29tZXMgaW4gdGhlIHdheSBvZgogICAgICogW2d1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kKS4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgICAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAgICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIERlZmVycmVkIEFQSQogICAgICoKICAgICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAgICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24gb2YgdGhlIHRhc2suCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAgICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAgICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAgICAgKgogICAgICogKipQcm9wZXJ0aWVzKioKICAgICAqCiAgICAgKiAtIHByb21pc2Ug4oCTIGB7UHJvbWlzZX1gIOKAkyBwcm9taXNlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWZlcnJlZC4KICAgICAqCiAgICAgKgogICAgICogIyBUaGUgUHJvbWlzZSBBUEkKICAgICAqCiAgICAgKiBBIG5ldyBwcm9taXNlIGluc3RhbmNlIGlzIGNyZWF0ZWQgd2hlbiBhIGRlZmVycmVkIGluc3RhbmNlIGlzIGNyZWF0ZWQgYW5kIGNhbiBiZSByZXRyaWV2ZWQgYnkKICAgICAqIGNhbGxpbmcgYGRlZmVycmVkLnByb21pc2VgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBwcm9taXNlIG9iamVjdCBpcyB0byBhbGxvdyBmb3IgaW50ZXJlc3RlZCBwYXJ0aWVzIHRvIGdldCBhY2Nlc3MgdG8gdGhlIHJlc3VsdAogICAgICogb2YgdGhlIGRlZmVycmVkIHRhc2sgd2hlbiBpdCBjb21wbGV0ZXMuCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yIHdpbGwgYmUgcmVzb2x2ZWQKICAgICAqICAgb3IgcmVqZWN0ZWQgY2FsbHMgb25lIG9mIHRoZSBzdWNjZXNzIG9yIGVycm9yIGNhbGxiYWNrcyBhc3luY2hyb25vdXNseSBhcyBzb29uIGFzIHRoZSByZXN1bHQKICAgICAqICAgaXMgYXZhaWxhYmxlLiBUaGUgY2FsbGJhY2tzIGFyZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCB0aGUgcmVzdWx0IG9yIHJlamVjdGlvbiByZWFzb24uCiAgICAgKgogICAgICogICBUaGlzIG1ldGhvZCAqcmV0dXJucyBhIG5ldyBwcm9taXNlKiB3aGljaCBpcyByZXNvbHZlZCBvciByZWplY3RlZCB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICAgICAqICAgYHN1Y2Nlc3NDYWxsYmFja2Agb3IgYGVycm9yQ2FsbGJhY2tgLgogICAgICoKICAgICAqCiAgICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICAgKgogICAgICogQmVjYXVzZSBjYWxsaW5nIGB0aGVuYCBhcGkgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkgcG9zc2libGUKICAgICAqIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlIHdpbGwgYmUKICAgICAqICAgLy8gdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgYXBpcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICogCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICogCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogICAgICAgIH1dOwogICAgfQoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICAgKiAgICAgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiBxRmFjdG9yeShuZXh0VGljaywgZXhjZXB0aW9uSGFuZGxlcikgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBkZWZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50aGVuKGNhbGxiYWNrWzBdLCBjYWxsYmFja1sxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlamVjdChyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgIHByb21pc2U6IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFja10pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgICAgICB9OwoKCiAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudGhlbikgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjcmVqZWN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAgICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICAgICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAgICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgICAgICogYHJlamVjdGAuCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAqICAgICByZXR1cm4gcmVzdWx0OwogICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgKiAgICAgfQogICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICogICB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgICAgICAgKiB0aGUgcHJvbWlzZSBjb21lcyBmcm9tIGEgc291cmNlIHRoYXQgY2FuJ3QgYmUgdHJ1c3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIG9mIHRoZSBwYXNzZWQgdmFsdWUgb3IgcHJvbWlzZQogICAgICAgICAqLwogICAgICAgIHZhciB3aGVuID0gZnVuY3Rpb24gKHZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUocmVmKHZhbHVlKS50aGVuKHdyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2spKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHdyYXBwZWRFcnJiYWNrKHJlYXNvbikpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgIH07CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0Q2FsbGJhY2sodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGRlZmF1bHRFcnJiYWNrKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjYWxsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ29tYmluZXMgbXVsdGlwbGUgcHJvbWlzZXMgaW50byBhIHNpbmdsZSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiBhbGwgb2YgdGhlIGlucHV0CiAgICAgICAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheS48UHJvbWlzZT59IHByb21pc2VzIEFuIGFycmF5IG9mIHByb21pc2VzLgogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkgb2YgdmFsdWVzLAogICAgICAgICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5LiBJZiBhbnkgb2YKICAgICAgICAgKiAgIHRoZSBwcm9taXNlcyBpcyByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLCB0aGlzIHJlc3VsdGluZyBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUKICAgICAgICAgKiAgIHNhbWUgcmVqZWN0aW9uLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFsbChwcm9taXNlcykgewogICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBkZWZlcigpLAogICAgICAgICAgICAgICAgY291bnRlciA9IHByb21pc2VzLmxlbmd0aCwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKCiAgICAgICAgICAgIGlmIChjb3VudGVyKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbiAocHJvbWlzZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IGluIHJlc3VsdHMpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCBpbiByZXN1bHRzKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRlZmVyOiBkZWZlciwKICAgICAgICAgICAgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgIHdoZW46IHdoZW4sCiAgICAgICAgICAgIGFsbDogYWxsCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyByb3V0ZXMuIFNlZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gZm9yIGFuIGV4YW1wbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciByb3V0ZXMgPSB7fTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLnBhdGhgKS4gSWYgYCRsb2NhdGlvbi5wYXRoYAogICAgICAgICAqICAgIGNvbnRhaW5zIHJlZHVuZGFudCB0cmFpbGluZyBzbGFzaCBvciBpcyBtaXNzaW5nIG9uZSwgdGhlIHJvdXRlIHdpbGwgc3RpbGwgbWF0Y2ggYW5kIHRoZQogICAgICAgICAqICAgIGAkbG9jYXRpb24ucGF0aGAgd2lsbCBiZSB1cGRhdGVkIHRvIGFkZCBvciBkcm9wIHRoZSB0cmFpbGluZyBzbGFzaCB0byBleGFjdGx5IG1hdGNoIHRoZQogICAgICAgICAqICAgIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiAgICBgcGF0aGAgY2FuIGNvbnRhaW4gbmFtZWQgZ3JvdXBzIHN0YXJ0aW5nIHdpdGggYSBjb2xvbiAoYDpuYW1lYCkuIEFsbCBjaGFyYWN0ZXJzIHVwIHRvIHRoZQogICAgICAgICAqICAgIG5leHQgc2xhc2ggYXJlIG1hdGNoZWQgYW5kIHN0b3JlZCBpbiBgJHJvdXRlUGFyYW1zYCB1bmRlciB0aGUgZ2l2ZW4gYG5hbWVgIHdoZW4gdGhlIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2hlcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSByb3V0ZSBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAgb24gcm91dGUKICAgICAgICAgKiAgICBtYXRjaC4KICAgICAgICAgKgogICAgICAgICAqICAgIE9iamVjdCBwcm9wZXJ0aWVzOgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgY29udHJvbGxlcmAg4oCTIGB7KHN0cmluZ3xmdW5jdGlvbigpPX1gIOKAkyBDb250cm9sbGVyIGZuIHRoYXQgc2hvdWxkIGJlIGFzc29jaWF0ZWQgd2l0aCBuZXdseQogICAgICAgICAqICAgICAgY3JlYXRlZCBzY29wZSBvciB0aGUgbmFtZSBvZiBhIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyIHJlZ2lzdGVyZWQgY29udHJvbGxlcn0KICAgICAgICAgKiAgICAgIGlmIHBhc3NlZCBhcyBhIHN0cmluZy4KICAgICAgICAgKiAgICAtIGB0ZW1wbGF0ZWAg4oCTIGB7c3RyaW5nPX1gIOKAkyAgaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IG9yCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBuZ0luY2x1ZGV9IGRpcmVjdGl2ZXMuCiAgICAgICAgICogICAgICB0aGlzIHByb3BlcnR5IHRha2VzIHByZWNlZGVuY2Ugb3ZlciBgdGVtcGxhdGVVcmxgLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlVXJsYCDigJMgYHtzdHJpbmc9fWAg4oCTIHBhdGggdG8gYW4gaHRtbCB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9LgogICAgICAgICAqICAgIC0gYHJlc29sdmVgIC0gYHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24+PX1gIC0gQW4gb3B0aW9uYWwgbWFwIG9mIGRlcGVuZGVuY2llcyB3aGljaCBzaG91bGQKICAgICAgICAgKiAgICAgIGJlIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuIElmIGFueSBvZiB0aGVzZSBkZXBlbmRlbmNpZXMgYXJlIHByb21pc2VzLCB0aGV5IHdpbGwgYmUKICAgICAgICAgKiAgICAgIHJlc29sdmVkIGFuZCBjb252ZXJ0ZWQgdG8gYSB2YWx1ZSBiZWZvcmUgdGhlIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkIGFuZCB0aGUKICAgICAgICAgKiAgICAgIGAkcm91dGVDaGFuZ2VTdWNjZXNzYCBldmVudCBpcyBmaXJlZC4gVGhlIG1hcCBvYmplY3QgaXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYGtleWAg4oCTIGB7c3RyaW5nfWA6IGEgbmFtZSBvZiBhIGRlcGVuZGVuY3kgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4KICAgICAgICAgKiAgICAgIC0gYGZhY3RvcnlgIC0gYHtzdHJpbmd8ZnVuY3Rpb259YDogSWYgYHN0cmluZ2AgdGhlbiBpdCBpcyBhbiBhbGlhcyBmb3IgYSBzZXJ2aWNlLgogICAgICAgICAqICAgICAgICBPdGhlcndpc2UgaWYgZnVuY3Rpb24sIHRoZW4gaXQgaXMge0BsaW5rIGFwaS9BVVRPLiRpbmplY3RvciNpbnZva2UgaW5qZWN0ZWR9CiAgICAgICAgICogICAgICAgIGFuZCB0aGUgcmV0dXJuIHZhbHVlIGlzIHRyZWF0ZWQgYXMgdGhlIGRlcGVuZGVuY3kuIElmIHRoZSByZXN1bHQgaXMgYSBwcm9taXNlLCBpdCBpcyByZXNvbHZlZAogICAgICAgICAqICAgICAgICBiZWZvcmUgaXRzIHZhbHVlIGlzIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGByZWRpcmVjdFRvYCDigJMgeyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSDigJMgdmFsdWUgdG8gdXBkYXRlCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gcGF0aCB3aXRoIGFuZCB0cmlnZ2VyIHJvdXRlIHJlZGlyZWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogICAgICBJZiBgcmVkaXJlY3RUb2AgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3QuPHN0cmluZz59YCAtIHJvdXRlIHBhcmFtZXRlcnMgZXh0cmFjdGVkIGZyb20gdGhlIGN1cnJlbnQKICAgICAgICAgKiAgICAgICAgYCRsb2NhdGlvbi5wYXRoKClgIGJ5IGFwcGx5aW5nIHRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlVXJsLgogICAgICAgICAqICAgICAgLSBge3N0cmluZ31gIC0gY3VycmVudCBgJGxvY2F0aW9uLnBhdGgoKWAKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3R9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5zZWFyY2goKWAKICAgICAgICAgKgogICAgICAgICAqICAgICAgVGhlIGN1c3RvbSBgcmVkaXJlY3RUb2AgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgc3RyaW5nIHdoaWNoIHdpbGwgYmUgdXNlZAogICAgICAgICAqICAgICAgdG8gdXBkYXRlIGAkbG9jYXRpb24ucGF0aCgpYCBhbmQgYCRsb2NhdGlvbi5zZWFyY2goKWAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBbcmVsb2FkT25TZWFyY2g9dHJ1ZV1gIC0ge2Jvb2xlYW49fSAtIHJlbG9hZCByb3V0ZSB3aGVuIG9ubHkgJGxvY2F0aW9uLnNlYXJjaCgpCiAgICAgICAgICogICAgY2hhbmdlcy4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgdGhlIG9wdGlvbiBpcyBzZXQgdG8gYGZhbHNlYCBhbmQgdXJsIGluIHRoZSBicm93c2VyIGNoYW5nZXMsIHRoZW4KICAgICAgICAgKiAgICAgIGAkcm91dGVVcGRhdGVgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoZSByb290IHNjb3BlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIG5ldyByb3V0ZSBkZWZpbml0aW9uIHRvIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMud2hlbiA9IGZ1bmN0aW9uIChwYXRoLCByb3V0ZSkgewogICAgICAgICAgICByb3V0ZXNbcGF0aF0gPSBleHRlbmQoe3JlbG9hZE9uU2VhcmNoOiB0cnVlfSwgcm91dGUpOwoKICAgICAgICAgICAgLy8gY3JlYXRlIHJlZGlyZWN0aW9uIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICAgICAgICAgIGlmIChwYXRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVkaXJlY3RQYXRoID0gKHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PSAnLycpCiAgICAgICAgICAgICAgICAgICAgPyBwYXRoLnN1YnN0cigwLCBwYXRoLmxlbmd0aCAtIDEpCiAgICAgICAgICAgICAgICAgICAgOiBwYXRoICsgJy8nOwoKICAgICAgICAgICAgICAgIHJvdXRlc1tyZWRpcmVjdFBhdGhdID0ge3JlZGlyZWN0VG86IHBhdGh9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlUHJvdmlkZXIjb3RoZXJ3aXNlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHJvdXRlIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgb24gcm91dGUgY2hhbmdlIHdoZW4gbm8gb3RoZXIgcm91dGUgZGVmaW5pdGlvbgogICAgICAgICAqIGlzIG1hdGNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YC4KICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBzZWxmCiAgICAgICAgICovCiAgICAgICAgdGhpcy5vdGhlcndpc2UgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMud2hlbihudWxsLCBwYXJhbXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRsb2NhdGlvbicsICckcm91dGVQYXJhbXMnLCAnJHEnLCAnJGluamVjdG9yJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRsb2NhdGlvbiwgJHJvdXRlUGFyYW1zLCAkcSwgJGluamVjdG9yLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjdXJyZW50IFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogVGhlIHJvdXRlIGRlZmluaXRpb24gY29udGFpbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtIGBjb250cm9sbGVyYDogVGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgYXMgZGVmaW5lIGluIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gYGxvY2Fsc2A6IEEgbWFwIG9mIGxvY2FscyB3aGljaCBpcyB1c2VkIGJ5IHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlcn0gc2VydmljZSBmb3IKICAgICAgICAgICAgICAgICAqICAgICBjb250cm9sbGVyIGluc3RhbnRpYXRpb24uIFRoZSBgbG9jYWxzYCBjb250YWluCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgYHJlc29sdmVgIG1hcC4gQWRkaXRpb25hbGx5IHRoZSBgbG9jYWxzYCBhbHNvIGNvbnRhaW46CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgIC0gYCRzY29wZWAgLSBUaGUgY3VycmVudCByb3V0ZSBzY29wZS4KICAgICAgICAgICAgICAgICAqICAgICAtIGAkdGVtcGxhdGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSByb3V0ZXMgQXJyYXkgb2YgYWxsIGNvbmZpZ3VyZWQgcm91dGVzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogSXMgdXNlZCBmb3IgZGVlcC1saW5raW5nIFVSTHMgdG8gY29udHJvbGxlcnMgYW5kIHZpZXdzIChIVE1MIHBhcnRpYWxzKS4KICAgICAgICAgICAgICAgICAqIEl0IHdhdGNoZXMgYCRsb2NhdGlvbi51cmwoKWAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgcGF0aCB0byBhbiBleGlzdGluZyByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFlvdSBjYW4gZGVmaW5lIHJvdXRlcyB0aHJvdWdoIHtAbGluayBuZy4kcm91dGVQcm92aWRlciAkcm91dGVQcm92aWRlcn0ncyBBUEkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgaXMgdHlwaWNhbGx5IHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmUgYW5kIHRoZSB7QGxpbmsgbmcuJHJvdXRlUGFyYW1zICRyb3V0ZVBhcmFtc30gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgY2hhbmdpbmcgdGhlIFVSTCBoYXNoIGNhdXNlcyB0aGUgYCRyb3V0ZWAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZQogICAgICAgICAgICAgICAgIFVSTCwgYW5kIHRoZSBgbmdWaWV3YCBwdWxscyBpbiB0aGUgcGFydGlhbC4KCiAgICAgICAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZXhhbXBsZSBpcyB1c2luZyB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBpbmxpbmVkIHRlbXBsYXRlc30KICAgICAgICAgICAgICAgICB0byBnZXQgaXQgd29ya2luZyBvbiBqc2ZpZGRsZSBhcyB3ZWxsLgoKICAgICAgICAgICAgICAgICA8ZXhhbXBsZSBtb2R1bGU9Im5nVmlldyI+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICAgICAgICAgQ2hvb3NlOgogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieS9jaC8xIj5Nb2J5OiBDaDE8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL0dhdHNieSI+R2F0c2J5PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9TY2FybGV0Ij5TY2FybGV0IExldHRlcjwvYT48YnIvPgoKICAgICAgICAgICAgICAgICA8ZGl2IG5nLXZpZXc+PC9kaXY+CiAgICAgICAgICAgICAgICAgPGhyIC8+CgogICAgICAgICAgICAgICAgIDxwcmU+JGxvY2F0aW9uLnBhdGgoKSA9IHt7JGxvY2F0aW9uLnBhdGgoKX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybCA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmx9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQucGFyYW1zID0ge3skcm91dGUuY3VycmVudC5wYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZSA9IHt7JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGVQYXJhbXMgPSB7eyRyb3V0ZVBhcmFtc319PC9wcmU+CiAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJib29rLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImNoYXB0ZXIuaHRtbCI+CiAgICAgICAgICAgICAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICAgICAgICAgICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgICAgICAgICAgICAgIENoYXB0ZXIgSWQ6IHt7cGFyYW1zLmNoYXB0ZXJJZH19CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnLCBbXSwgZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEJvb2tDbnRsLAogICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAvLyBJIHdpbGwgY2F1c2UgYSAxIHNlY29uZCBkZWxheQogICAgICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oJHEsICR0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgdmFyIGRlbGF5ID0gJHEuZGVmZXIoKTsKICAgICAgICAgICAgICAgICAkdGltZW91dChkZWxheS5yZXNvbHZlLCAxMDAwKTsKICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkucHJvbWlzZTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0pOwogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQvY2gvOmNoYXB0ZXJJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICAgfSk7CgogICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE1haW5DbnRsKCRzY29wZSwgJHJvdXRlLCAkcm91dGVQYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlUGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgIHZhciBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQ2hhcHRlciBJZFw6IDEvKTsKCiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgICBzbGVlcCgyKTsgLy8gcHJvbWlzZXMgYXJlIG5vdCBwYXJ0IG9mIHNjZW5hcmlvIHdhaXRpbmcKICAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQm9va0NudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlU3RhcnQKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSByb3V0ZSBjaGFuZ2UuIEF0IHRoaXMgIHBvaW50IHRoZSByb3V0ZSBzZXJ2aWNlcyBzdGFydHMKICAgICAgICAgICAgICAgICAqIHJlc29sdmluZyBhbGwgb2YgdGhlIGRlcGVuZGVuY2llcyBuZWVkZWQgZm9yIHRoZSByb3V0ZSBjaGFuZ2UgdG8gb2NjdXJzLgogICAgICAgICAgICAgICAgICogVHlwaWNhbGx5IHRoaXMgaW52b2x2ZXMgZmV0Y2hpbmcgdGhlIHZpZXcgdGVtcGxhdGUgYXMgd2VsbCBhcyBhbnkgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICAgKiBkZWZpbmVkIGluIGByZXNvbHZlYCByb3V0ZSBwcm9wZXJ0eS4gT25jZSAgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgKiBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgaXMgZmlyZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gbmV4dCBGdXR1cmUgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSBjdXJyZW50IEN1cnJlbnQgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIHJvdXRlIGRlcGVuZGVuY2llcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IGxpc3RlbnMgZm9yIHRoZSBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAqIHRvIGluc3RhbnRpYXRlIHRoZSBjb250cm9sbGVyIGFuZCByZW5kZXIgdGhlIHZpZXcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZXxVbmRlZmluZWR9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLCBvciB1bmRlZmluZWQgaWYgY3VycmVudCBpcyBmaXJzdCByb3V0ZSBlbnRlcmVkLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VFcnJvcgogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIGlmIGFueSBvZiB0aGUgcmVzb2x2ZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcHJldmlvdXMgUHJldmlvdXMgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSByZWplY3Rpb24gUmVqZWN0aW9uIG9mIHRoZSBwcm9taXNlLiBVc3VhbGx5IHRoZSBlcnJvciBvZiB0aGUgZmFpbGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZVVwZGF0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgYHJlbG9hZE9uU2VhcmNoYCBwcm9wZXJ0eSBoYXMgYmVlbiBzZXQgdG8gZmFsc2UsIGFuZCB3ZSBhcmUgcmV1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogaW5zdGFuY2Ugb2YgdGhlIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgZm9yY2VSZWxvYWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAkcm91dGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlczogcm91dGVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlI3JlbG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBDYXVzZXMgYCRyb3V0ZWAgc2VydmljZSB0byByZWxvYWQgdGhlIGN1cnJlbnQgcm91dGUgZXZlbiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gaGFzbid0IGNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEFzIGEgcmVzdWx0IG9mIHRoYXQsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30KICAgICAgICAgICAgICAgICAgICAgICAgICogY3JlYXRlcyBuZXcgc2NvcGUsIHJlaW5zdGFudGlhdGVzIHRoZSBjb250cm9sbGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmModXBkYXRlUm91dGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZVJvdXRlKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvdXRlOwoKICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gb24ge3N0cmluZ30gY3VycmVudCB1cmwKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB3aGVuIHtzdHJpbmd9IHJvdXRlIHdoZW4gdGVtcGxhdGUgdG8gbWF0Y2ggdGhlIHVybCBhZ2FpbnN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHs/T2JqZWN0fQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzd2l0Y2hSb3V0ZU1hdGNoZXIob24sIHdoZW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiB0aGlzIGNvZGUgaXMgY29udm9sdXRlZCBhbmQgaW5lZmZpY2llbnQsIHdlIHNob3VsZCBjb25zdHJ1Y3QgdGhlIHJvdXRlIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gICByZWdleCBvbmx5IG9uY2UgYW5kIHRoZW4gcmV1c2UgaXQKCiAgICAgICAgICAgICAgICAgICAgLy8gRXNjYXBlIHJlZ2V4cCBzcGVjaWFsIGNoYXJhY3RlcnMuCiAgICAgICAgICAgICAgICAgICAgd2hlbiA9ICdeJyArIHdoZW4ucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICJcXCQmIikgKyAnJCc7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ2V4ID0gJycsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBkc3QgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlID0gLzooXHcrKS9nLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbU1hdGNoLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChwYXJhbU1hdGNoID0gcmUuZXhlYyh3aGVuKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBlYWNoIDpwYXJhbSBpbiBgd2hlbmAgYW5kIHJlcGxhY2UgaXQgd2l0aCBhIGNhcHR1cmluZyBncm91cC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIGFsbCBvdGhlciBzZWN0aW9ucyBvZiB3aGVuIHVuY2hhbmdlZC4KICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gd2hlbi5zbGljZShsYXN0TWF0Y2hlZEluZGV4LCBwYXJhbU1hdGNoLmluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gJyhbXlxcL10qKSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtTWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gcmUubGFzdEluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgdHJhaWxpbmcgcGF0aCBwYXJ0LgogICAgICAgICAgICAgICAgICAgIHJlZ2V4ICs9IHdoZW4uc3Vic3RyKGxhc3RNYXRjaGVkSW5kZXgpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBvbi5tYXRjaChuZXcgUmVnRXhwKHJlZ2V4KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAobmFtZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFtuYW1lXSA9IG1hdGNoW2luZGV4ICsgMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBkc3QgOiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gcGFyc2VSb3V0ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gJHJvdXRlLmN1cnJlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIGxhc3QgJiYgbmV4dC4kJHJvdXRlID09PSBsYXN0LiQkcm91dGUKICAgICAgICAgICAgICAgICAgICAgICAgJiYgZXF1YWxzKG5leHQucGF0aFBhcmFtcywgbGFzdC5wYXRoUGFyYW1zKSAmJiAhbmV4dC5yZWxvYWRPblNlYXJjaCAmJiAhZm9yY2VSZWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdC5wYXJhbXMgPSBuZXh0LnBhcmFtczsKICAgICAgICAgICAgICAgICAgICAgICAgY29weShsYXN0LnBhcmFtcywgJHJvdXRlUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVVcGRhdGUnLCBsYXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQgfHwgbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN0YXJ0JywgbmV4dCwgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb3V0ZS5jdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0LnJlZGlyZWN0VG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobmV4dC5yZWRpcmVjdFRvKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChpbnRlcnBvbGF0ZShuZXh0LnJlZGlyZWN0VG8sIG5leHQucGFyYW1zKSkuc2VhcmNoKG5leHQucGFyYW1zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24udXJsKG5leHQucmVkaXJlY3RUbyhuZXh0LnBhdGhQYXJhbXMsICRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJHEud2hlbihuZXh0KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXh0LnJlc29sdmUgfHwge30sIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGlzU3RyaW5nKHZhbHVlKSA/ICRpbmplY3Rvci5nZXQodmFsdWUpIDogJGluamVjdG9yLmludm9rZSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSA9IG5leHQudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlID0gbmV4dC50ZW1wbGF0ZVVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gJGh0dHAuZ2V0KHRlbXBsYXRlLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaCgnJHRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxLmFsbCh2YWx1ZXMpLnRoZW4oZnVuY3Rpb24gKHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNba2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZ0ZXIgcm91dGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5sb2NhbHMgPSBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3B5KG5leHQucGFyYW1zLCAkcm91dGVQYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3VjY2VzcycsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICRyb3V0ZS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlRXJyb3InLCBuZXh0LCBsYXN0LCBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHRoZSBjdXJyZW50IGFjdGl2ZSByb3V0ZSwgYnkgbWF0Y2hpbmcgaXQgYWdhaW5zdCB0aGUgVVJMCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlUm91dGUoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWF0Y2ggYSByb3V0ZQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbXMsIG1hdGNoOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2gocm91dGVzLCBmdW5jdGlvbiAocm91dGUsIHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCAmJiAocGFyYW1zID0gc3dpdGNoUm91dGVNYXRjaGVyKCRsb2NhdGlvbi5wYXRoKCksIHBhdGgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBleHRlbmQoe30sICRsb2NhdGlvbi5zZWFyY2goKSwgcGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUGFyYW1zOiBwYXJhbXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLiQkcm91dGUgPSByb3V0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIE5vIHJvdXRlIG1hdGNoZWQ7IGZhbGxiYWNrIHRvICJvdGhlcndpc2UiIHJvdXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoIHx8IHJvdXRlc1tudWxsXSAmJiBpbmhlcml0KHJvdXRlc1tudWxsXSwge3BhcmFtczoge30sIHBhdGhQYXJhbXM6IHt9fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBpbnRlcnBvbGF0aW9uIG9mIHRoZSByZWRpcmVjdCBwYXRoIHdpdGggdGhlIHBhcmFtZXRycwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbnRlcnBvbGF0ZShzdHJpbmcsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKChzdHJpbmcgfHwgJycpLnNwbGl0KCc6JyksIGZ1bmN0aW9uIChzZWdtZW50LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlZ21lbnRNYXRjaCA9IHNlZ21lbnQubWF0Y2goLyhcdyspKC4qKS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHNlZ21lbnRNYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBhcmFtc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnRNYXRjaFsyXSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVBhcmFtcwogICAgICogQHJlcXVpcmVzICRyb3V0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3VycmVudCBzZXQgb2Ygcm91dGUgcGFyYW1ldGVycy4gVGhlIHJvdXRlIHBhcmFtZXRlcnMgYXJlIGEgY29tYmluYXRpb24gb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gYHNlYXJjaCgpYCwgYW5kIGBwYXRoKClgLiBUaGUgYHBhdGhgIHBhcmFtZXRlcnMKICAgICAqIGFyZSBleHRyYWN0ZWQgd2hlbiB0aGUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IHBhdGggaXMgbWF0Y2hlZC4KICAgICAqCiAgICAgKiBJbiBjYXNlIG9mIHBhcmFtZXRlciBuYW1lIGNvbGxpc2lvbiwgYHBhdGhgIHBhcmFtcyB0YWtlIHByZWNlZGVuY2Ugb3ZlciBgc2VhcmNoYCBwYXJhbXMuCiAgICAgKgogICAgICogVGhlIHNlcnZpY2UgZ3VhcmFudGVlcyB0aGF0IHRoZSBpZGVudGl0eSBvZiB0aGUgYCRyb3V0ZVBhcmFtc2Agb2JqZWN0IHdpbGwgcmVtYWluIHVuY2hhbmdlZAogICAgICogKGJ1dCBpdHMgcHJvcGVydGllcyB3aWxsIGxpa2VseSBjaGFuZ2UpIGV2ZW4gd2hlbiBhIHJvdXRlIGNoYW5nZSBvY2N1cnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAgLy8gR2l2ZW46CiAgICAgKiAgLy8gVVJMOiBodHRwOi8vc2VydmVyLmNvbS9pbmRleC5odG1sIy9DaGFwdGVyLzEvU2VjdGlvbi8yP3NlYXJjaD1tb2J5CiAgICAgKiAgLy8gUm91dGU6IC9DaGFwdGVyLzpjaGFwdGVySWQvU2VjdGlvbi86c2VjdGlvbklkCiAgICAgKiAgLy8KICAgICAqICAvLyBUaGVuCiAgICAgKiAgJHJvdXRlUGFyYW1zID09PiB7Y2hhcHRlcklkOjEsIHNlY3Rpb25JZDoyLCBzZWFyY2g6J21vYnknfQogICAgICogPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVBhcmFtc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4oe30pOwogICAgfQoKICAgIC8qKgogICAgICogREVTSUdOIE5PVEVTCiAgICAgKgogICAgICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogICAgICoKICAgICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICAgKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAgICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogICAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAgICoKICAgICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgICAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAoc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgICAqCiAgICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICAgKgogICAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICAgKiBhcmUgZXhwZW5zaXZlIHRvIGNvbnN0cnVjdC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICAgKiBhc3N1bWluZyB0aGF0IHRoZSBtb2RlbCBpcyB1bnN0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBjaGlsZCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGFuZCBwcm92aWRlCiAgICAgKiBldmVudCBwcm9jZXNzaW5nIGxpZmUtY3ljbGUuIFNlZSB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgVFRMID0gMTA7CgogICAgICAgIHRoaXMuZGlnZXN0VHRsID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBUVEwgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gVFRMOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRwYXJzZScsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyLCAkcGFyc2UpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQSByb290IHNjb3BlIGNhbiBiZSByZXRyaWV2ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlICRyb290U2NvcGV9IGtleSBmcm9tIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRuZXcgJG5ldygpfSBtZXRob2QuIChNb3N0IHNjb3BlcyBhcmUgY3JlYXRlZCBhdXRvbWF0aWNhbGx5IHdoZW4KICAgICAgICAgICAgICAgICAqIGNvbXBpbGVkIEhUTUwgdGVtcGxhdGUgaXMgZXhlY3V0ZWQuKQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgc2NvcGUgc25pcHBldCB0byBzaG93IGhvdyB5b3UgY2FuIGludGVyYWN0IHdpdGggdGhlIHNjb3BlLgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSkuaW52b2tlKGZ1bmN0aW9uKCRyb290U2NvcGUpIHsKICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcoKTsKICAgICAgICAgICBzY29wZS5zYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ1dvcmxkJzsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CgogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgc2NvcGUuZ3JlZXRpbmcgPSBzY29wZS5zYWx1dGF0aW9uICsgJyAnICsgc2NvcGUubmFtZSArICchJzsKICAgICAgICAgICB9KTsgLy8gaW5pdGlhbGl6ZSB0aGUgd2F0Y2gKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdNaXNrbyc7CiAgICAgICAgICAgLy8gc3RpbGwgb2xkIHZhbHVlLCBzaW5jZSB3YXRjaGVzIGhhdmUgbm90IGJlZW4gY2FsbGVkIHlldAogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCh1bmRlZmluZWQpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7IC8vIGZpcmUgYWxsICB0aGUgd2F0Y2hlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCgnSGVsbG8gTWlza28hJyk7CiAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgICAgICAgICAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgICAgICAgICAgcGFyZW50LnNhbHV0YXRpb24gPSAiSGVsbG8iOwogICAgICAgICAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgICAgICAgICBjaGlsZC5zYWx1dGF0aW9uID0gIldlbGNvbWUiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKCk+PX0gcHJvdmlkZXJzIE1hcCBvZiBzZXJ2aWNlIGZhY3Rvcnkgd2hpY2ggbmVlZCB0byBiZSBwcm92aWRlZAogICAgICAgICAgICAgICAgICogICAgIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsICo+PX0gaW5zdGFuY2VDYWNoZSBQcm92aWRlcyBwcmUtaW5zdGFudGlhdGVkIHNlcnZpY2VzIHdoaWNoIHNob3VsZAogICAgICAgICAgICAgICAgICogICAgIGFwcGVuZC9vdmVycmlkZSBzZXJ2aWNlcyBwcm92aWRlZCBieSBgcHJvdmlkZXJzYC4gVGhpcyBpcyBoYW5keSB3aGVuIHVuaXQtdGVzdGluZyBhbmQgaGF2aW5nCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBOZXdseSBjcmVhdGVkIHNjb3BlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHBoYXNlID0gdGhpcy4kcGFyZW50ID0gdGhpcy4kJHdhdGNoZXJzID0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzWyd0aGlzJ10gPSB0aGlzLiRyb290ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgICAgICAgICAqLwoKCiAgICAgICAgICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24gKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIENoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihpc29sYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmVtb3ZlIGF0IHNvbWUgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdBUEktQ0hBTkdFOiBVc2UgJGNvbnRyb2xsZXIgdG8gaW5zdGFudGlhdGUgY29udHJvbGxlcnMuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcm9vdCA9IHRoaXMuJHJvb3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07IC8vIHNob3VsZCBiZSBhbm9ueW1vdXM7IFRoaXMgaXMgc28gdGhhdCB3aGVuIHRoZSBtaW5pZmllciBtdW5nZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBuYW1lIGl0IGRvZXMgbm90IGJlY29tZSByYW5kb20gc2V0IG9mIGNoYXJzLiBUaGVzZSB3aWxsIHRoZW4gc2hvdyB1cCBhcyBjbGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmFtZSBpbiB0aGUgZGVidWdnZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZC5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgQ2hpbGQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFsndGhpcyddID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRwYXJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCR3YXRjaGVycyA9IGNoaWxkLiQkbmV4dFNpYmxpbmcgPSBjaGlsZC4kJGNoaWxkSGVhZCA9IGNoaWxkLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICogICBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB3aGljaCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0KICAgICAgICAgICAgICAgICAgICAgKiAgIHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICAgICAgICAgICAqICAgc2VlIGJlbG93KS4gVGhlIGluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yIGxhdGVyIGNvbXBhcmlzb24sIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gSXQgYWxzbyBtZWFucyB0aGF0IHdhdGNoaW5nIGNvbXBsZXggb3B0aW9ucyB3aWxsCiAgICAgICAgICAgICAgICAgICAgICogICBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4gVGhpcwogICAgICAgICAgICAgICAgICAgICAqICAgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEgY2hhbmdlIGlzCiAgICAgICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAvLyBsZXQncyBhc3N1bWUgdGhhdCBzY29wZSB3YXMgZGVwZW5kZW5jeSBpbmplY3RlZCBhcyB0aGUgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7IHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKX0gd2F0Y2hFeHByZXNzaW9uIEV4cHJlc3Npb24gdGhhdCBpcyBldmFsdWF0ZWQgb24gZWFjaAogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEEgY2hhbmdlIGluIHRoZSByZXR1cm4gdmFsdWUgdHJpZ2dlcnMgYQogICAgICAgICAgICAgICAgICAgICAqICAgIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGBzY29wZWAgYXMgYSBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpPX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSByZXR1cm4gdmFsdWUgb2YKICAgICAgICAgICAgICAgICAgICAgKiAgIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZXMgYXMgcGFyYW1ldGVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9iamVjdEVxdWFsaXR5IENvbXBhcmUgb2JqZWN0IGZvciBlcXVhbGl0eSByYXRoZXIgdGhhbiBmb3IgcmVmZXJlbmNlLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHdhdGNoOiBmdW5jdGlvbiAod2F0Y2hFeHAsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0ID0gY29tcGlsZVRvRm4od2F0Y2hFeHAsICd3YXRjaCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlciA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSB1c2VyIHBhc3Mgc3RyaW5nLCB3ZSBuZWVkIHRvIGNvbXBpbGUgaXQsIGRvIHdlIHJlYWxseSBuZWVkIHRoaXMgPwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuRm4gPSBjb21waWxlVG9GbihsaXN0ZW5lciB8fCBub29wLCAnbGlzdGVuZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIuZm4gPSBmdW5jdGlvbiAobmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHdoaWxlIGxvb3AgcmVhZHMgaW4gcmV2ZXJzZSBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZSB0aGUgbW9kZWwsIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICogZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUgbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93CiAgICAgICAgICAgICAgICAgICAgICogYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFVzdWFsbHkgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAgICAgICAgICAgICAgICogSW5zdGVhZCBhIGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluIGEKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gIHdpdGgge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgICAgICAgICAgICAgICAqIHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFlvdSBtYXkgaGF2ZSBhIG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCBmcm9tIHdpdGhpbiB1bml0LXRlc3RzLCB0byBzaW11bGF0ZSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBsaWZlLWN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2c7CgogICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlID0gY3VycmVudC4kJGFzeW5jUXVldWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LiRldmFsKGFzeW5jUXVldWUuc2hpZnQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgod2F0Y2hlcnMgPSBjdXJyZW50LiQkd2F0Y2hlcnMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2Nlc3Mgb3VyIHdhdGNoZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1vc3QgY29tbW9uIHdhdGNoZXMgYXJlIG9uIHByaW1pdGl2ZXMsIGluIHdoaWNoIGNhc2Ugd2UgY2FuIHNob3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2lyY3VpdCBpdCB3aXRoID09PSBvcGVyYXRvciwgb25seSB3aGVuID09PSBmYWlscyBkbyB3ZSB1c2UgLmVxdWFscwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmICEod2F0Y2guZXEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlcXVhbHModmFsdWUsIGxhc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBpc05hTih2YWx1ZSkgJiYgaXNOYU4obGFzdCkpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmxhc3QgPSB3YXRjaC5lcSA/IGNvcHkodmFsdWUpIDogdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmZuKHZhbHVlLCAoKGxhc3QgPT09IGluaXRXYXRjaFZhbCkgPyB2YWx1ZSA6IGxhc3QpLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCA9IDQgLSB0dGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdhdGNoTG9nW2xvZ0lkeF0pIHdhdGNoTG9nW2xvZ0lkeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZm46ICcgKyAod2F0Y2guZXhwLm5hbWUgfHwgd2F0Y2guZXhwLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB3YXRjaC5leHA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nW2xvZ0lkeF0ucHVzaChsb2dNc2cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fCAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlydHkgJiYgISh0dGwtLSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoVFRMICsgJyAkZGlnZXN0KCkgaXRlcmF0aW9ucyByZWFjaGVkLiBBYm9ydGluZyFcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnV2F0Y2hlcnMgZmlyZWQgaW4gdGhlIGxhc3QgNSBpdGVyYXRpb25zOiAnICsgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUmVtb3ZlcyB0aGUgY3VycmVudCBzY29wZSAoYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4pIGZyb20gdGhlIHBhcmVudCBzY29wZS4gUmVtb3ZhbCBpbXBsaWVzCiAgICAgICAgICAgICAgICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICAgICAgICAgICAgICAgKiBwcm9wYWdhdGUgdG8gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4gUmVtb3ZhbCBhbHNvIGltcGxpZXMgdGhhdCB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICAgICAqIHNjb3BlIGlzIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRkZXN0cm95KClgIGlzIHVzdWFsbHkgdXNlZCBieSBkaXJlY3RpdmVzIHN1Y2ggYXMKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSBmb3IgbWFuYWdpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSnVzdCBiZWZvcmUgYSBzY29wZSBpcyBkZXN0cm95ZWQgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAgICAgICAgICAgICAgICogQXBwbGljYXRpb24gY29kZSBjYW4gcmVnaXN0ZXIgYSBgJGRlc3Ryb3lgIGV2ZW50IGhhbmRsZXIgdGhhdCB3aWxsIGdpdmUgaXQgY2hhbmNlIHRvCiAgICAgICAgICAgICAgICAgICAgICogcGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgZGVzdHJveSB0aGUgcm9vdCBzY29wZSBvciBhIHNjb3BlIHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUgPT0gdGhpcyB8fCB0aGlzLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRicm9hZGNhc3QoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZEhlYWQgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRUYWlsID0gdGhpcy4kJHByZXZTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJHByZXZTaWJsaW5nKSB0aGlzLiQkcHJldlNpYmxpbmcuJCRuZXh0U2libGluZyA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRuZXh0U2libGluZykgdGhpcy4kJG5leHRTaWJsaW5nLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmc7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGJvZ3VzIGNvZGUgdGhhdCB3b3JrcyBhcm91bmQgQ2hyb21lJ3MgR0MgbGVhawogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzEzMTMjaXNzdWVjb21tZW50LTEwMzc4NDUxCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZEhlYWQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgYGV4cHJlc3Npb25gIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybmluZyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbiB0aGUKICAgICAgICAgICAgICAgICAgICAgKiBleHByZXNzaW9uIGFyZSBwcm9wYWdhdGVkICh1bmNhdWdodCkuIFRoaXMgaXMgdXNlZnVsIHdoZW4gZXZhbHVhdGluZyBBbmd1bGFyIGV4cHJlc3Npb25zLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYiA9IDI7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoZnVuY3Rpb24oc2NvcGUpeyByZXR1cm4gc2NvcGUuYSArIHNjb3BlLmI7IH0pKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbDogZnVuY3Rpb24gKGV4cHIsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIG9uIHRoZSBjdXJyZW50IHNjb3BlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBgJGV2YWxBc3luY2AgbWFrZXMgbm8gZ3VhcmFudGVlcyBhcyB0byB3aGVuIHRoZSBgZXhwcmVzc2lvbmAgd2lsbCBiZSBleGVjdXRlZCwgb25seSB0aGF0OgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGl0IHdpbGwgZXhlY3V0ZSBpbiB0aGUgY3VycmVudCBzY3JpcHQgZXhlY3V0aW9uIGNvbnRleHQgKGJlZm9yZSBhbnkgRE9NIHJlbmRlcmluZykuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyCiAgICAgICAgICAgICAgICAgICAgICogICAgIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKGV4cHIpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIgZnJhbWV3b3JrLgogICAgICAgICAgICAgICAgICAgICAqIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUtY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKiBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKiAyLiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAqICAgIHdhcyBleGVjdXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRldmFsKGV4cHIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIExpc3RlbnMgb24gZXZlbnRzIG9mIGEgZ2l2ZW4gdHlwZS4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRlbWl0ICRlbWl0fSBmb3IgZGlzY3Vzc2lvbiBvZgogICAgICAgICAgICAgICAgICAgICAqIGV2ZW50IGxpZmUgY3ljbGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZm9ybWF0IGlzOiBgZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pYC4gVGhlIGBldmVudGAgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICogcGFzc2VkIGludG8gdGhlIGxpc3RlbmVyIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHRhcmdldFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIG9uIHdoaWNoIHRoZSBldmVudCB3YXMgYCRlbWl0YC1lZCBvciBgJGJyb2FkY2FzdGAtZWQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgY3VycmVudCBzY29wZSB3aGljaCBpcyBoYW5kbGluZyB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBuYW1lYCAtIGB7c3RyaW5nfWA6IE5hbWUgb2YgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgc3RvcFByb3BhZ2F0aW9uYCAtIGB7ZnVuY3Rpb249fWA6IGNhbGxpbmcgYHN0b3BQcm9wYWdhdGlvbmAgZnVuY3Rpb24gd2lsbCBjYW5jZWwgZnVydGhlciBldmVudAogICAgICAgICAgICAgICAgICAgICAqICAgICBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBwcmV2ZW50RGVmYXVsdGAgLSBge2Z1bmN0aW9ufWA6IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0YCBzZXRzIGBkZWZhdWx0UHJldmVudGVkYCBmbGFnIHRvIHRydWUuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gbGlzdGVuIG9uLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkb246IGZ1bmN0aW9uIChuYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZWRMaXN0ZW5lcnMgPSB0aGlzLiQkbGlzdGVuZXJzW25hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZAogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzIGNhbmNlbHMgaXQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRlbWl0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW1wdHkgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG5hbWVkTGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhdmVyc2UgdXB3YXJkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBzY29wZS4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCBkb3dud2FyZHMgdG8gYWxsIGNoaWxkIHNjb3BlcyAoYW5kIHRoZWlyIGNoaWxkcmVuKSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRicm9hZGNhc3RgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0IG5vdGlmaWVkLgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyd2FyZHMsIHRoZSBldmVudCBwcm9wYWdhdGVzIHRvIGFsbCBkaXJlY3QgYW5kIGluZGlyZWN0IHNjb3BlcyBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiBjYWxscyBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IGNhbm5vdCBiZSBjYW5jZWxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFueSBleGNlcHRpb24gZW1taXRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgICAgICAgICAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gYnJvYWRjYXN0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYnJvYWRjYXN0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyICRyb290U2NvcGUgPSBuZXcgU2NvcGUoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJHJvb3RTY29wZS4kJHBoYXNlICsgJyBhbHJlYWR5IGluIHByb2dyZXNzJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICAgICAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogISEhIFRoaXMgaXMgYW4gdW5kb2N1bWVudGVkICJwcml2YXRlIiBzZXJ2aWNlICEhIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGlzdG9yeSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaHRtbDUgaGlzdG9yeSBhcGkgPwogICAgICogQHByb3BlcnR5IHtib29sZWFufSBoYXNoY2hhbmdlIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBoYXNoY2hhbmdlIGV2ZW50ID8KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoaXMgaXMgdmVyeSBzaW1wbGUgaW1wbGVtZW50YXRpb24gb2YgdGVzdGluZyBicm93c2VyJ3MgZmVhdHVyZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRTbmlmZmVyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgICAgICAgICAgYW5kcm9pZCA9IGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpKSwKICAgICAgICAgICAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAoISR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8ICR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNyksCiAgICAgICAgICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSUU5IGltcGxlbWVudHMgJ2lucHV0JyBldmVudCBpdCdzIHNvIGZ1YmFyZWQgdGhhdCB3ZSByYXRoZXIgcHJldGVuZCB0aGF0IGl0IGRvZXNuJ3QgaGF2ZQogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBJbiBwYXJ0aWN1bGFyIHRoZSBldmVudCBpcyBub3QgZmlyZWQgd2hlbiBiYWNrc3BhY2Ugb3IgZGVsZXRlIGtleSBhcmUgcHJlc3NlZCBvcgogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gY3V0IG9wZXJhdGlvbiBpcyBwZXJmb3JtZWQuCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50ID09ICdpbnB1dCcgJiYgbXNpZSA9PSA5KSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudFN1cHBvcnRbZXZlbnRdKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGl2RWxtID0gJHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTdXBwb3J0W2V2ZW50XSA9ICdvbicgKyBldmVudCBpbiBkaXZFbG07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnRTdXBwb3J0W2V2ZW50XTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiBjdXJyZW50bHkgdGhlcmUgaXMgbm8gd2F5IHRvIGZlYXR1cmUgZGV0ZWN0IENTUCB3aXRob3V0IHRyaWdnZXJpbmcgYWxlcnRzCiAgICAgICAgICAgICAgICBjc3A6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICAgICAqIGlzIGdsb2JhbGx5IGF2YWlsYWJsZSBpbiBKYXZhU2NyaXB0LCBpdCBjYXVzZXMgdGVzdGFiaWxpdHkgcHJvYmxlbXMsIGJlY2F1c2UKICAgICAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogICAgICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogICAgICoKICAgICAqIEFsbCBleHByZXNzaW9ucyBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byBjdXJyZW50IHNjb3BlIHNvIHRoZXkgZG9uJ3QKICAgICAqIHN1ZmZlciBmcm9tIHdpbmRvdyBnbG9iYWxpdHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICRzY29wZS4kd2luZG93ID0gJHdpbmRvdzsKICAgICAgICAgICAkc2NvcGUuZ3JlZXRpbmcgPSAnSGVsbG8sIFdvcmxkISc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJHdpbmRvdy5hbGVydChncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBkaXNwbGF5IHRoZSBncmVldGluZyBpbiB0aGUgaW5wdXQgYm94JywgZnVuY3Rpb24oKSB7CiAgICAgICBpbnB1dCgnZ3JlZXRpbmcnKS5lbnRlcignSGVsbG8sIEUyRSBUZXN0cycpOwogICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgLy8gZWxlbWVudCgnOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHdpbmRvdyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQYXJzZSBoZWFkZXJzIGludG8ga2V5IHZhbHVlIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBQYXJzZWQgaGVhZGVycyBhcyBrZXkgdmFsdWUgb2JqZWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgICAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgICAgICAgaWYgKCFoZWFkZXJzKSByZXR1cm4gcGFyc2VkOwoKICAgICAgICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAgICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAgICAgKgogICAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICAgKiBAc2VlIHBhcnNlSGVhZGVycwogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAgICAgKgogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICAgKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFoZWFkZXJzT2JqKSBoZWFkZXJzT2JqID0gcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9ufEFycmF5LjxmdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogICAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBkYXRhID0gZm4oZGF0YSwgaGVhZGVycyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkYXRhOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgICAgICAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwogICAgfQoKCiAgICBmdW5jdGlvbiAkSHR0cFByb3ZpZGVyKCkgewogICAgICAgIHZhciBKU09OX1NUQVJUID0gL15ccyooXFt8XHtbXlx7XSkvLAogICAgICAgICAgICBKU09OX0VORCA9IC9bXH1cXV1ccyokLywKICAgICAgICAgICAgUFJPVEVDVElPTl9QUkVGSVggPSAvXlwpXF1cfScsP1xuLzsKCiAgICAgICAgdmFyICRjb25maWcgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gaW5jb21pbmcgcmVzcG9uc2UgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogW2Z1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKEpTT05fU1RBUlQudGVzdChkYXRhKSAmJiBKU09OX0VORC50ZXN0KGRhdGEpKQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gZnJvbUpzb24oZGF0YSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IFtmdW5jdGlvbiAoZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBjb21tb246IHsKICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicsCiAgICAgICAgICAgICAgICAgICAgJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J30sCiAgICAgICAgICAgICAgICBwdXQ6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgcHJvdmlkZXJSZXNwb25zZUludGVyY2VwdG9ycyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyksCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uIChpbnRlcmNlcHRvcikgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSW50ZXJjZXB0b3JzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGlzU3RyaW5nKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGh0dHBCYWNrZW5kCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkY2FjaGVGYWN0b3J5CiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRxCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgY29yZSBBbmd1bGFyIHNlcnZpY2UgdGhhdCBmYWNpbGl0YXRlcyBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZQogICAgICAgICAgICAgICAgICogSFRUUCBzZXJ2ZXJzIHZpYSB0aGUgYnJvd3NlcidzIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3R9IG9iamVjdCBvciB2aWEge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciB1bml0IHRlc3RpbmcgYXBwbGljYXRpb25zIHRoYXQgdXNlIGAkaHR0cGAgc2VydmljZSwgc2VlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCAkaHR0cEJhY2tlbmQgbW9ja30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGEgaGlnaGVyIGxldmVsIG9mIGFic3RyYWN0aW9uLCBwbGVhc2UgY2hlY2sgb3V0IHRoZSB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UKICAgICAgICAgICAgICAgICAqICRyZXNvdXJjZX0gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgQVBJIGlzIGJhc2VkIG9uIHRoZSB7QGxpbmsgbmcuJHEgZGVmZXJyZWQvcHJvbWlzZSBBUElzfSBleHBvc2VkIGJ5CiAgICAgICAgICAgICAgICAgKiB0aGUgJHEgc2VydmljZS4gV2hpbGUgZm9yIHNpbXBsZSB1c2FnZSBwYXR0ZXJucyB0aGlzIGRvZXNuJ3QgbWF0dGVyIG11Y2gsIGZvciBhZHZhbmNlZCB1c2FnZQogICAgICAgICAgICAgICAgICogaXQgaXMgaW1wb3J0YW50IHRvIGZhbWlsaWFyaXplIHlvdXJzZWxmIHdpdGggdGhlc2UgQVBJcyBhbmQgdGhlIGd1YXJhbnRlZXMgdGhleSBwcm92aWRlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEdlbmVyYWwgdXNhZ2UKICAgICAgICAgICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAgICAgICAgICAgICAqIHRoYXQgaXMgdXNlZCB0byBnZW5lcmF0ZSBhbiBIVFRQIHJlcXVlc3QgYW5kIHJldHVybnMgIGEge0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgICAgICAgICAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAoe21ldGhvZDogJ0dFVCcsIHVybDogJy9zb21lVXJsJ30pLgogICAgICAgICAgICAgICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICAgICAgICAgICAgICogICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyBjYWxsZWQgYXN5bmNocm9ub3VzbHkgaWYgYW4gZXJyb3Igb2NjdXJzCiAgICAgKiAgICAgICAvLyBvciBzZXJ2ZXIgcmV0dXJucyByZXNwb25zZSB3aXRoIGFuIGVycm9yIHN0YXR1cy4KICAgICAqICAgICB9KTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIHRoZSByZXR1cm5lZCB2YWx1ZSBvZiBjYWxsaW5nIHRoZSAkaHR0cCBmdW5jdGlvbiBpcyBhIGBwcm9taXNlYCwgeW91IGNhbiBhbHNvIHVzZQogICAgICAgICAgICAgICAgICogdGhlIGB0aGVuYCBtZXRob2QgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzLCBhbmQgdGhlc2UgY2FsbGJhY2tzIHdpbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCDigJMKICAgICAgICAgICAgICAgICAqIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3BvbnNlLiBTZWUgdGhlIEFQSSBzaWduYXR1cmUgYW5kIHR5cGUgaW5mbyBiZWxvdyBmb3IgbW9yZQogICAgICAgICAgICAgICAgICogZGV0YWlscy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBIHJlc3BvbnNlIHN0YXR1cyBjb2RlIGJldHdlZW4gMjAwIGFuZCAyOTkgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3Mgc3RhdHVzIGFuZAogICAgICAgICAgICAgICAgICogd2lsbCByZXN1bHQgaW4gdGhlIHN1Y2Nlc3MgY2FsbGJhY2sgYmVpbmcgY2FsbGVkLiBOb3RlIHRoYXQgaWYgdGhlIHJlc3BvbnNlIGlzIGEgcmVkaXJlY3QsCiAgICAgICAgICAgICAgICAgKiBYTUxIdHRwUmVxdWVzdCB3aWxsIHRyYW5zcGFyZW50bHkgZm9sbG93IGl0LCBtZWFuaW5nIHRoYXQgdGhlIGVycm9yIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgZm9yIHN1Y2ggcmVzcG9uc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIGFsbCBpbnZvY2F0aW9ucyBvZiB0aGUgJGh0dHAgc2VydmljZSByZXF1aXJlIHBhc3NpbmcgaW4gYW4gSFRUUCBtZXRob2QgYW5kIFVSTCwgYW5kCiAgICAgICAgICAgICAgICAgKiBQT1NUL1BVVCByZXF1ZXN0cyByZXF1aXJlIHJlcXVlc3QgZGF0YSB0byBiZSBwcm92aWRlZCBhcyB3ZWxsLCBzaG9ydGN1dCBtZXRob2RzCiAgICAgICAgICAgICAgICAgKiB3ZXJlIGNyZWF0ZWQ6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAuZ2V0KCcvc29tZVVybCcpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZ2V0ICRodHRwLmdldH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3B1dCAkaHR0cC5wdXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAgICAgICAgICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICogb2JqZWN0LCB3aGljaCBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICAgICAgICAgICAgICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICogLyAqYAogICAgICAgICAgICAgICAgICogICAtIGBYLVJlcXVlc3RlZC1XaXRoOiBYTUxIdHRwUmVxdWVzdGAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICAgICAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0WydNeS1IZWFkZXInXT0ndmFsdWUnYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBZGRpdGlvbmFsbHksIHRoZSBkZWZhdWx0cyBjYW4gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogZmFzaGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAgICAgICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0IGludG8KICAgICAgICAgICAgICAgICAqICAgSlNPTiBmb3JtYXQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICAgICAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbgogICAgICAgICAgICAgICAgICogYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUgYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vcgogICAgICAgICAgICAgICAgICogYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byBgJGh0dHBgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBlbmFibGUgY2FjaGluZywgc2V0IHRoZSBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYHRydWVgLiBXaGVuIHRoZSBjYWNoZSBpcwogICAgICAgICAgICAgICAgICogZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiBsb2NhbCBjYWNoZS4gTmV4dCB0aW1lIHRoZQogICAgICAgICAgICAgICAgICogcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQgZXZlbiBpZiB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gY2FjaGUsIGRlbGl2ZXJ5IG9mIHRoZSBkYXRhIGlzIGFzeW5jaHJvbm91cyBpbgogICAgICAgICAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSWYgdGhlcmUgYXJlIG11bHRpcGxlIEdFVCByZXF1ZXN0cyBmb3IgdGhlIHNhbWUgVVJMIHRoYXQgc2hvdWxkIGJlIGNhY2hlZCB1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJlZm9yZSB5b3Ugc3RhcnQgY3JlYXRpbmcgaW50ZXJjZXB0b3JzLCBiZSBzdXJlIHRvIHVuZGVyc3RhbmQgdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIHB1cnBvc2VzIG9mIGdsb2JhbCBlcnJvciBoYW5kbGluZywgYXV0aGVudGljYXRpb24gb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAgICAgICAgICAgICAqIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nIG9mIHJlY2VpdmVkIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlIGFibGUgdG8gaW50ZXJjZXB0CiAgICAgICAgICAgICAgICAgKiByZXNwb25zZXMgZm9yIGh0dHAgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAgICAgICAgICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIHJlc3BvbnNlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgICAgICAgICAgICAgKiBwcm9taXNlIGFwaXN9IHRvIGZ1bGZpbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSBpbnRlcmNlcHRvcnMgYXJlIHNlcnZpY2UgZmFjdG9yaWVzIHRoYXQgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgJGh0dHBQcm92aWRlciBieQogICAgICAgICAgICAgICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLnJlc3BvbnNlSW50ZXJjZXB0b3JzYCBhcnJheS4gVGhlIGZhY3RvcnkgaXMgY2FsbGVkIGFuZAogICAgICAgICAgICAgICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yICDigJQgYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiB0YWtlcyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBhbmQgcmV0dXJucyB0aGUgb3JpZ2luYWwgb3IgYSBuZXcgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgKiAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICAgICAgICAgICAgICAgICAqICAgSlNPTiB2dWxuZXJhYmlsaXR5fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgICAgICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiBKU09OIHZ1bG5lcmFiaWxpdHl9IGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0gcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgYXV0b21hdGljYWxseSBzdHJpcCB0aGUgcHJlZml4IGJlZm9yZSBwcm9jZXNzaW5nIGl0IGFzIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICldfScsCiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0gaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAgICAgICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAgICAgICAgICAgICAqIGNhbGxlZCBgWFNSRi1UT0tFTmAgYW5kIHNldHMgaXQgYXMgdGhlIEhUVFAgaGVhZGVyIGBYLVhTUkYtVE9LRU5gLiBTaW5jZSBvbmx5IEphdmFTY3JpcHQgdGhhdAogICAgICAgICAgICAgICAgICogcnVucyBvbiB5b3VyIGRvbWFpbiBjb3VsZCByZWFkIHRoZSBjb29raWUsIHlvdXIgc2VydmVyIGNhbiBiZSBhc3N1cmVkIHRoYXQgdGhlIFhIUiBjYW1lIGZyb20KICAgICAgICAgICAgICAgICAqIEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICAgICAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAgICAgICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbSBtYWtpbmcKICAgICAgICAgICAgICAgICAqIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzIGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBjb29raWUgd2l0aCBhIHtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpIHNhbHR9IGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBPYmplY3QgZGVzY3JpYmluZyB0aGUgcmVxdWVzdCB0byBiZSBtYWRlIGFuZCBob3cgaXQgc2hvdWxkIGJlCiAgICAgICAgICAgICAgICAgKiAgICBwcm9jZXNzZWQuIFRoZSBvYmplY3QgaGFzIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgIC0gKiptZXRob2QqKiDigJMgYHtzdHJpbmd9YCDigJMgSFRUUCBtZXRob2QgKGUuZy4gJ0dFVCcsICdQT1NUJywgZXRjKQogICAgICAgICAgICAgICAgICogICAgLSAqKnVybCoqIOKAkyBge3N0cmluZ31gIOKAkyBBYnNvbHV0ZSBvciByZWxhdGl2ZSBVUkwgb2YgdGhlIHJlc291cmNlIHRoYXQgaXMgYmVpbmcgcmVxdWVzdGVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKnBhcmFtcyoqIOKAkyBge09iamVjdC48c3RyaW5nfE9iamVjdD59YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aGljaCB3aWxsIGJlIHR1cm5lZCB0bwogICAgICAgICAgICAgICAgICogICAgICBgP2tleTE9dmFsdWUxJmtleTI9dmFsdWUyYCBhZnRlciB0aGUgdXJsLiBJZiB0aGUgdmFsdWUgaXMgbm90IGEgc3RyaW5nLCBpdCB3aWxsIGJlIEpTT05pZmllZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBEYXRhIHRvIGJlIHNlbnQgYXMgdGhlIHJlcXVlc3QgbWVzc2FnZSBkYXRhLgogICAgICAgICAgICAgICAgICogICAgLSAqKmhlYWRlcnMqKiDigJMgYHtPYmplY3R9YCDigJMgTWFwIG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgICAgICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICAgICAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAgICAgICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IFJldHVybnMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gb2JqZWN0IHdpdGggdGhlCiAgICAgICAgICAgICAgICAgKiAgIHN0YW5kYXJkIGB0aGVuYCBtZXRob2QgYW5kIHR3byBodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4gVGhlIGB0aGVuYAogICAgICAgICAgICAgICAgICogICBtZXRob2QgdGFrZXMgdHdvIGFyZ3VtZW50cyBhIHN1Y2Nlc3MgYW5kIGFuIGVycm9yIGNhbGxiYWNrIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdpdGggYQogICAgICAgICAgICAgICAgICogICByZXNwb25zZSBvYmplY3QuIFRoZSBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAgbWV0aG9kcyB0YWtlIGEgc2luZ2xlIGFyZ3VtZW50IC0gYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3Qgc3VjY2VlZHMgb3IgZmFpbHMgcmVzcGVjdGl2ZWx5LiBUaGUgYXJndW1lbnRzIHBhc3NlZCBpbnRvCiAgICAgICAgICAgICAgICAgKiAgIHRoZXNlIGZ1bmN0aW9ucyBhcmUgZGVzdHJ1Y3R1cmVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXNwb25zZSBvYmplY3QgcGFzc2VkIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiAgIGB0aGVuYCBtZXRob2QuIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgVGhlIHJlc3BvbnNlIGJvZHkgdHJhbnNmb3JtZWQgd2l0aCB0aGUgdHJhbnNmb3JtIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAgICAgICAgICAgICAqICAgLSAqKmhlYWRlcnMqKiDigJMgYHtmdW5jdGlvbihbaGVhZGVyTmFtZV0pfWAg4oCTIEhlYWRlciBnZXR0ZXIgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcGVuZGluZ1JlcXVlc3RzIEFycmF5IG9mIGNvbmZpZyBvYmplY3RzIGZvciBjdXJyZW50bHkgcGVuZGluZwogICAgICAgICAgICAgICAgICogICByZXF1ZXN0cy4gVGhpcyBpcyBwcmltYXJpbHkgbWVhbnQgdG8gYmUgdXNlZCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIDxleGFtcGxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRmV0Y2hDdHJsIj4KICAgICAgICAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICAgICAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgPG9wdGlvbj5KU09OUDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+U2FtcGxlIEpTT05QPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+SW52YWxpZCBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCByZXNwb25zZSBkYXRhOiB7e2RhdGF9fTwvcHJlPgogICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEZldGNoQ3RybCgkc2NvcGUsICRodHRwLCAkdGVtcGxhdGVDYWNoZSkgewogICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gJ0dFVCc7CiAgICAgICAgICAgICRzY29wZS51cmwgPSAnaHR0cC1oZWxsby5odG1sJzsKCiAgICAgICAgICAgICRzY29wZS5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS5jb2RlID0gbnVsbDsKICAgICAgICAgICAgICAkc2NvcGUucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgICAkaHR0cCh7bWV0aG9kOiAkc2NvcGUubWV0aG9kLCB1cmw6ICRzY29wZS51cmwsIGNhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhIHx8ICJSZXF1ZXN0IGZhaWxlZCI7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAgICAgICAgICRzY29wZS5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICAgJHNjb3BlLnVybCA9IHVybDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICAgICAgICAgICAgICAgICBIZWxsbywgJGh0dHAhCiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBHRVQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBhIEpTT05QIHJlcXVlc3QgdG8gYW5ndWxhcmpzLm9yZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgSlNPTlAiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJJbnZhbGlkIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcwJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvQmUoJ1JlcXVlc3QgZmFpbGVkJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPC9leGFtcGxlPgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAkaHR0cChjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcubWV0aG9kID0gdXBwZXJjYXNlKGNvbmZpZy5tZXRob2QpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVxdWVzdCB8fCAkY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BUcmFuc2Zvcm1GbiA9IGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSB8fCAkY29uZmlnLnRyYW5zZm9ybVJlc3BvbnNlLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gJGNvbmZpZy5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHsnWC1YU1JGLVRPS0VOJzogJGJyb3dzZXIuY29va2llcygpWydYU1JGLVRPS0VOJ119LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVycy5jb21tb24sIGRlZkhlYWRlcnNbbG93ZXJjYXNlKGNvbmZpZy5tZXRob2QpXSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICAgICAgICAgICAgICByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihyZXFIZWFkZXJzKSwgcmVxVHJhbnNmb3JtRm4pLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZXFIZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycyk7CgoKICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2Zvcm0gZnV0dXJlIHJlc3BvbnNlCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBhcHBseSBpbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlSW50ZXJjZXB0b3JzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGludGVyY2VwdG9yKHByb21pc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5lcnJvciA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFrZSBhIGNvcHkgc2luY2UgdGhlIHJlc3BvbnNlIG11c3QgYmUgY2FjaGVhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCByZXNwVHJhbnNmb3JtRm4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGlzU3VjY2VzcyhyZXNwb25zZS5zdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZXNwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRxLnJlamVjdChyZXNwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNnZXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWxldGUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYERFTEVURWAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNoZWFkCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2pzb25wCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3Bvc3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcHV0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMgYXMgd2VsbCBhcyByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICRodHRwLmRlZmF1bHRzID0gJGNvbmZpZzsKCgogICAgICAgICAgICAgICAgcmV0dXJuICRodHRwOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAgICAgICAgICogJGh0dHBCYWNrZW5kLCAkY29uZmlnLCAkbG9nLCAkcm9vdFNjb3BlLCBkZWZhdWx0Q2FjaGUsICRodHRwLnBlbmRpbmdSZXF1ZXN0cwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCwKICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAgICAgICAgICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5wdXNoKGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwoKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jYWNoZSAmJiBjb25maWcubWV0aG9kID09ICdHRVQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlID0gaXNPYmplY3QoY29uZmlnLmNhY2hlKSA/IGNvbmZpZy5jYWNoZSA6IGRlZmF1bHRDYWNoZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRSZXNwID0gY2FjaGUuZ2V0KHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBjb3B5KGNhY2hlZFJlc3BbMl0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwLCAyMDAsIHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgICAgICAgICAgICAgICBpZiAoIWNhY2hlZFJlc3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAgICAgICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIFJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IE1hdGgubWF4KHN0YXR1cywgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAoaXNTdWNjZXNzKHN0YXR1cykgPyBkZWZlcnJlZC5yZXNvbHZlIDogZGVmZXJyZWQucmVqZWN0KSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiByZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogaGVhZGVyc0dldHRlcihoZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBlbmRpbmdSZXEoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBpbmRleE9mKCRodHRwLnBlbmRpbmdSZXF1ZXN0cywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiB1cmw7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjYuMCIpOwogICAgICAgIH0gY2F0Y2ggKGUxKSB7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuMy4wIik7CiAgICAgICAgfSBjYXRjaCAoZTIpIHsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUCIpOwogICAgICAgIH0gY2F0Y2ggKGUzKSB7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgWE1MSHR0cFJlcXVlc3QuIik7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRodHRwQmFja2VuZAogICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRkb2N1bWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogICAgICogWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IG9yIEpTT05QIGFuZCBkZWFscyB3aXRoIGJyb3dzZXIgaW5jb21wYXRpYmlsaXRpZXMuCiAgICAgKgogICAgICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogICAgICoge0BsaW5rIG5nLiRodHRwICRodHRwfSBvciB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UgJHJlc291cmNlfS4KICAgICAqCiAgICAgKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAgICAgKiAkaHR0cEJhY2tlbmR9IHdoaWNoIGNhbiBiZSB0cmFpbmVkIHdpdGggcmVzcG9uc2VzLgogICAgICovCiAgICBmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24gKCRicm93c2VyLCAkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLAogICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLCAkd2luZG93LmxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoJzonLCAnJykpOwogICAgICAgIH1dOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQsIGxvY2F0aW9uUHJvdG9jb2wpIHsKICAgICAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1ldGhvZCwgdXJsLCBwb3N0LCBjYWxsYmFjaywgaGVhZGVycywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqc29ucFJlcSh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsICdhbmd1bGFyLmNhbGxiYWNrcy4nICsgY2FsbGJhY2tJZCksCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgMjAwLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2NhbGxiYWNrSWRdOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYSFIoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdmFyIHN0YXR1czsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgICAgICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIG9uY2UgRmlyZWZveCAyMSBnZXRzIHJlbGVhc2VkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWdpbjogd29ya2Fyb3VuZCB0byBvdmVyY29tZSBGaXJlZm94IENPUlMgaHR0cCByZXNwb25zZSBoZWFkZXJzIGJ1ZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MDg3MzUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCBhbHJlYWR5IHBhdGNoZWQgaW4gbmlnaHRseS4gU2hvdWxkIGxhbmQgaW4gRmlyZWZveCAyMS4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENPUlMgInNpbXBsZSByZXNwb25zZSBoZWFkZXJzIiBodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGVIZWFkZXJzID0gWyJDYWNoZS1Db250cm9sIiwgIkNvbnRlbnQtTGFuZ3VhZ2UiLCAiQ29udGVudC1UeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRXhwaXJlcyIsICJMYXN0LU1vZGlmaWVkIiwgIlByYWdtYSJdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNpbXBsZUhlYWRlcnMsIGZ1bmN0aW9uIChoZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzICs9IGhlYWRlciArICI6ICIgKyB2YWx1ZSArICJcbiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5kIG9mIHRoZSB3b3JrYXJvdW5kLgoKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMgfHwgeGhyLnN0YXR1cywgeGhyLnJlc3BvbnNlVGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgeGhyLnNlbmQocG9zdCB8fCAnJyk7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXJEZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZykgewogICAgICAgICAgICAgICAgLy8gVVJMX01BVENIIGlzIGRlZmluZWQgaW4gc3JjL3NlcnZpY2UvbG9jYXRpb24uanMKICAgICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9ICh1cmwubWF0Y2goVVJMX01BVENIKSB8fCBbJycsIGxvY2F0aW9uUHJvdG9jb2xdKVsxXTsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CgogICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIGRvbmVXcmFwcGVyKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZVdyYXBwZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAkbG9jYWxlIHNlcnZpY2UgcHJvdmlkZXMgbG9jYWxpemF0aW9uIHJ1bGVzIGZvciB2YXJpb3VzIEFuZ3VsYXIgY29tcG9uZW50cy4gQXMgb2YgcmlnaHQgbm93IHRoZQogICAgICogb25seSBwdWJsaWMgYXBpIGlzOgogICAgICoKICAgICAqICogYGlkYCDigJMgYHtzdHJpbmd9YCDigJMgbG9jYWxlIGlkIGZvcm1hdHRlZCBhcyBgbGFuZ3VhZ2VJZC1jb3VudHJ5SWRgIChlLmcuIGBlbi11c2ApCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpZDogJ2VuLXVzJywKCiAgICAgICAgICAgICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIERFQ0lNQUxfU0VQOiAnLicsCiAgICAgICAgICAgICAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgICAgICAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgICAgICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB7IC8vQ3VycmVuY3kgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1ByZTogJyhcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBDVVJSRU5DWV9TWU06ICckJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBEQVRFVElNRV9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgTU9OVEg6ICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVE1PTlRIOiAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgQU1QTVM6IFsnQU0nLCAnUE0nXSwKICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICAgICAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICAgICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkYnJvd3NlciwgJHEsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRUaW1lb3V0YC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgd3JhcHBlZCBpbnRvIGEgdHJ5L2NhdGNoCiAgICAgICAgICAgICAgICAgKiBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhIHRpbWVvdXQgZnVuY3Rpb24gaXMgYSBwcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIHdoZW4KICAgICAgICAgICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGNhbmNlbCBhIHRpbWVvdXQgcmVxdWVzdCwgY2FsbCBgJHRpbWVvdXQuY2FuY2VsKHByb21pc2UpYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiR0aW1lb3V0IGAkdGltZW91dC5mbHVzaCgpYH0gdG8KICAgICAgICAgICAgICAgICAqIHN5bmNocm9ub3VzbHkgZmx1c2ggdGhlIHF1ZXVlIG9mIGRlZmVycmVkIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdob3NlIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVsYXllZC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIERlbGF5IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgaW52b2tlIGBmbmAgd2l0aGluIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5fSBibG9jay4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQuIFRoZSB2YWx1ZSB0aGlzCiAgICAgICAgICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQsIGNsZWFudXA7CgogICAgICAgICAgICAgICAgICAgIHRpbWVvdXRJZCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgICAgICAgICAgIGNsZWFudXAgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbdGltZW91dElkXSA9IGRlZmVycmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihjbGVhbnVwLCBjbGVhbnVwKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dCNjYW5jZWwKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAgICAgICAqIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgICAgICAqICAgY2FuY2VsZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHRpbWVvdXQuY2FuY2VsID0gZnVuY3Rpb24gKHByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXhlIHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uICgkaW5qZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH1dOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICAgICAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmZpbHRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICAgKiAgIGBhcnJheWAuCiAgICAgKgogICAgICogICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgLSBgc3RyaW5nYDogUHJlZGljYXRlIHRoYXQgcmVzdWx0cyBpbiBhIHN1YnN0cmluZyBtYXRjaCB1c2luZyB0aGUgdmFsdWUgb2YgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgc3RyaW5nLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICAgICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogICAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgICAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogICAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAgICogICAgIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UgZWxlbWVudHMgdGhhdAogICAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDxocj4KICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2giPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCdtJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSk7CgogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0pvaG4nLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcnJheSwgZXhwcmVzc2lvbikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIHZhciBwcmVkaWNhdGVzID0gW107CiAgICAgICAgICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmICghcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgaWYgKHRleHQuY2hhckF0KDApID09PSAnIScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIXNlYXJjaChvYmosIHRleHQuc3Vic3RyKDEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIG9iaikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnJyArIG9iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBzZWFyY2gob2JqW29iaktleV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImFycmF5IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHskOiBleHByZXNzaW9ufTsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJycgKyBleHByZXNzaW9uW2tleV0pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZXh0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnICsgZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpjdXJyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgZGVmYXVsdCBjdXJyZW5jeSBzeW1ib2wgKCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5fX08YnI+CiAgICAgY3VzdG9tIGN1cnJlbmN5IGlkZW50aWZpZXIgKFVTRCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIn19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeToiVVNEJCInKSkudG9CZSgnVVNEJDEsMjM0LjU2Jyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnYW1vdW50JykuZW50ZXIoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBjdXJyZW5jeUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgICBmdW5jdGlvbiBjdXJyZW5jeUZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYW1vdW50LCBjdXJyZW5jeVN5bWJvbCkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY3VycmVuY3lTeW1ib2wpKSBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgICAgICAgICByZXR1cm4gZm9ybWF0TnVtYmVyKGFtb3VudCwgZm9ybWF0cy5QQVRURVJOU1sxXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsIDIpLgogICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOm51bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICAgKgogICAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICAgICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gW2ZyYWN0aW9uU2l6ZT0yXSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IHt7dmFsIHwgbnVtYmVyfX08YnI+CiAgICAgTm8gZnJhY3Rpb25zOiB7e3ZhbCB8IG51bWJlcjowfX08YnI+CiAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMSwyMzUnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMSwyMzQuNTY3OScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCd2YWwnKS5lbnRlcignMzM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTMsMzc0LjMzMzAnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCgogICAgbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgICAgZnJhY3Rpb25TaXplKTsKICAgICAgICB9OwogICAgfQoKICAgIHZhciBERUNJTUFMX1NFUCA9ICcuJzsKCiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSkgJSBncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSkgJSBsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgICAgICAgICB3aGlsZSAoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvbiArPSAnMCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfQoKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgICAgIHZhciBuZWcgPSAnJzsKICAgICAgICBpZiAobnVtIDwgMCkgewogICAgICAgICAgICBuZWcgPSAnLSc7CiAgICAgICAgICAgIG51bSA9IC1udW07CiAgICAgICAgfQogICAgICAgIG51bSA9ICcnICsgbnVtOwogICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgICAgICAgaWYgKHRyaW0pCiAgICAgICAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICAgICAgcmV0dXJuIG5lZyArIG51bTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIGlmIChvZmZzZXQgPiAwIHx8IHZhbHVlID4gLW9mZnNldCkKICAgICAgICAgICAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIpIHZhbHVlID0gMTI7CiAgICAgICAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIHZhciBnZXQgPSB1cHBlcmNhc2Uoc2hvcnRGb3JtID8gKCdTSE9SVCcgKyBuYW1lKSA6IG5hbWUpOwoKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgICAgICAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICB2YXIgcGFkZGVkWm9uZSA9ICh6b25lID49IDApID8gIisiIDogIiI7CgogICAgICAgIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgICAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICAgICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgICB9CgogICAgZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgICB9CgogICAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgICAgICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICAgICAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgICAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICAgICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgICAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgICAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICAgICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgICAgIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICAgICAgIEVFRTogZGF0ZVN0ckdldHRlcignRGF5JywgdHJ1ZSksCiAgICAgICAgYTogYW1wbUdldHRlciwKICAgICAgICBaOiB0aW1lWm9uZUdldHRlcgogICAgfTsKCiAgICB2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkUnXSspfCg/OicoPzpbXiddfCcnKSonKXwoPzpFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFopKSguKikvLAogICAgICAgIE5VTUJFUl9TVFJJTkcgPSAvXlxkKyQvOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmRhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGVsZW1lbnRzOgogICAgICoKICAgICAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogICAgICogICAqIGAneXknYDogMiBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBwYWRkZWQgKDAwLTk5KS4gKGUuZy4gQUQgMjAwMSA9PiAwMSwgQUQgMjAxMCA9PiAxMCkKICAgICAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAgICAgKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAgICAgKiAgICogYCdNTU0nYDogTW9udGggaW4geWVhciAoSmFuLURlYykKICAgICAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAgICAgKiAgICogYCdkZCdgOiBEYXkgaW4gbW9udGgsIHBhZGRlZCAoMDEtMzEpCiAgICAgKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICAgICAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICAgICAqICAgKiBgJ0VFRSdgOiBEYXkgaW4gV2VlaywgKFN1bi1TYXQpCiAgICAgKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICAgICAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAgICAgKiAgICogYCdoaCdgOiBIb3VyIGluIGFtL3BtLCBwYWRkZWQgKDAxLTEyKQogICAgICogICAqIGAnaCdgOiBIb3VyIGluIGFtL3BtLCAoMS0xMikKICAgICAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogICAgICogICAqIGAnbSdgOiBNaW51dGUgaW4gaG91ciAoMC01OSkKICAgICAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAgICAgKiAgICogYCdhJ2A6IGFtL3BtIG1hcmtlcgogICAgICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtKzEyMDApCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogICAgICogICB7QGxpbmsgZ3VpZGUvaTE4biBsb2NhbGl6YWJsZSBmb3JtYXRzfToKICAgICAqCiAgICAgKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICAgICAqICAgICAoZS5nLiBTZXAgMywgMjAxMCAxMjowNTowOCBwbSkKICAgICAqICAgKiBgJ3Nob3J0J2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXkgaDptbSBhJ2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gOS8zLzEwIDEyOjA1IHBtKQogICAgICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICAgICAqICAgICAoZS5nLiBGcmlkYXksIFNlcHRlbWJlciAzLCAyMDEwKQogICAgICogICAqIGAnbG9uZ0RhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcHRlbWJlciAzLCAyMDEwCiAgICAgKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogICAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgcG0pCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAgICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IHNpbmdsZSBxdW90ZSwgdXNlIHR3byBzaW5nbGUgcXVvdGVzIGluIGEgc2VxdWVuY2UKICAgICAqICAgKGUuZy4gYCJoIG8nJ2Nsb2NrImApLgogICAgICoKICAgICAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogICAgICogICAgbnVtYmVyKSBvciB2YXJpb3VzIElTTyA4NjAxIGRhdGV0aW1lIHN0cmluZyBmb3JtYXRzIChlLmcuIHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWiBhbmQgaXRzCiAgICAgKiAgICBzaG9ydGVyIHZlcnNpb25zIGxpa2UgeXl5eS1NTS1kZFRISDptbVosIHl5eXktTU0tZGQgb3IgeXl5eU1NZGRUSEhtbXNzWikuIElmIG5vIHRpbWV6b25lIGlzCiAgICAgKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGZvcm1hdCBGb3JtYXR0aW5nIHJ1bGVzIChzZWUgRGVzY3JpcHRpb24pLiBJZiBub3Qgc3BlY2lmaWVkLAogICAgICogICAgYG1lZGl1bURhdGVgIGlzIHVzZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgc3RyaW5nIG9yIHRoZSBpbnB1dCBpZiBpbnB1dCBpcyBub3QgcmVjb2duaXplZCBhcyBkYXRlL21pbGxpcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08YnI+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAge3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PGJyPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+OgogICAgIHt7JzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PGJyPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZm9ybWF0IGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gKFwtfFwrKT9cZHs0fS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS4KICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBkYXRlRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgICAgICAgdmFyIFJfSVNPODYwMV9TVFIgPSAvXihcZHs0fSktPyhcZFxkKS0/KFxkXGQpKD86VChcZFxkKSg/Ojo/KFxkXGQpKD86Oj8oXGRcZCkoPzpcLihcZCspKT8pPyk/KFp8KFsrLV0pKFxkXGQpOj8oXGRcZCkpPyk/JC87CgogICAgICAgIGZ1bmN0aW9uIGpzb25TdHJpbmdUb0RhdGUoc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSAwOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoWzldKSB7CiAgICAgICAgICAgICAgICAgICAgdHpIb3VyID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTBdKTsKICAgICAgICAgICAgICAgICAgICB0ek1pbiA9IGludChtYXRjaFs5XSArIG1hdGNoWzExXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKGludChtYXRjaFsxXSksIGludChtYXRjaFsyXSkgLSAxLCBpbnQobWF0Y2hbM10pKTsKICAgICAgICAgICAgICAgIGRhdGUuc2V0VVRDSG91cnMoaW50KG1hdGNoWzRdIHx8IDApIC0gdHpIb3VyLCBpbnQobWF0Y2hbNV0gfHwgMCkgLSB0ek1pbiwgaW50KG1hdGNoWzZdIHx8IDApLCBpbnQobWF0Y2hbN10gfHwgMCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdCkgewogICAgICAgICAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIGZuLCBtYXRjaDsKCiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgICAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgICAgICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgICAgICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgICAgOiB2YWx1ZS5yZXBsYWNlKC8oXid8JyQpL2csICcnKS5yZXBsYWNlKC8nJy9nLCAiJyIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiB0ZXh0OwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBBbGxvd3MgeW91IHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG9iamVjdCBpbnRvIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAgICAgKiAgIHRoZSBiaW5kaW5nIGlzIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIEpTT04uCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEpTT04gc3RyaW5nLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZToKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHByZT57eyB7J25hbWUnOid2YWx1ZSd9IHwganNvbiB9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJ7J25hbWUnOid2YWx1ZSd9IikpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBqc29uRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICovCiAgICB2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjp1cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICovCiAgICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bGltaXRUbwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBhcyBzcGVjaWZpZWQgYnkgdGhlCiAgICAgKiB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkuIElmIHRoZSBgbGltaXRgIG51bWJlciBpcwogICAgICogICAgIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUKICAgICAqICAgICBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN1Yi1hcnJheSBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5IGhhZCBsZXNzIHRoYW4gYGxpbWl0YAogICAgICogICAgIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxpbWl0ID0gMzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGltaXQiPgogICAgIDxwPk91dHB1dDoge3sgbnVtYmVycyB8IGxpbWl0VG86bGltaXQgfX08L3A+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGxpbWl0KSB7CiAgICAgICAgICAgIGlmICghKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGxpbWl0ID0gaW50KGxpbWl0KTsKICAgICAgICAgICAgdmFyIG91dCA9IFtdLAogICAgICAgICAgICAgICAgaSwgbjsKCiAgICAgICAgICAgIC8vIGNoZWNrIHRoYXQgYXJyYXkgaXMgaXRlcmFibGUKICAgICAgICAgICAgaWYgKCFhcnJheSB8fCAhKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKQogICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKCiAgICAgICAgICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgICAgICAgICBpZiAobGltaXQgPiBhcnJheS5sZW5ndGgpCiAgICAgICAgICAgICAgICBsaW1pdCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgZWxzZSBpZiAobGltaXQgPCAtYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSAtYXJyYXkubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBuID0gbGltaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpID0gYXJyYXkubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgICAgICAgICBuID0gYXJyYXkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2goYXJyYXlbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOm9yZGVyQnkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdG9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPn0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogICAgICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogICAgICoKICAgICAqICAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAgLSBgZnVuY3Rpb25gOiBHZXR0ZXIgZnVuY3Rpb24uIFRoZSByZXN1bHQgb2YgdGhpcyBmdW5jdGlvbiB3aWxsIGJlIHNvcnRlZCB1c2luZyB0aGUKICAgICAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvci4KICAgICAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJwogICAgICogICAgICB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkICduYW1lJy4gT3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbAogICAgICogICAgICBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZyBzb3J0IG9yZGVyIChmb3IgZXhhbXBsZSwgK25hbWUgb3IgLW5hbWUpLgogICAgICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgICAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXZlcnNlIFJldmVyc2UgdGhlIG9yZGVyIHRoZSBhcnJheS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAkc2NvcGUucHJlZGljYXRlID0gJy1hZ2UnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgICAgPGhyLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZT0nJyI+dW5zb3J0ZWQ8L2E+IF0KICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgPHRyPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnbmFtZSc7IHJldmVyc2U9ZmFsc2UiPk5hbWU8L2E+CiAgICAgKDxhIGhyZWYgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgPC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgIDwvdHI+CiAgICAgPC90YWJsZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGJlIHJldmVyc2Ugb3JkZXJlZCBieSBhZ2VkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwcmVkaWNhdGUnKSkudG9CZSgnLWFnZScpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMjknLCAnMjEnLCAnMTknLCAnMTAnXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKdWxpZScsICdNaWtlJywgJ01hcnknLCAnSm9obiddKTsKICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHJlb3JkZXIgdGhlIHRhYmxlIHdoZW4gdXNlciBzZWxlY3RzIGRpZmZlcmVudCBwcmVkaWNhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiTmFtZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0pvaG4nLCAnSnVsaWUnLCAnTWFyeScsICdNaWtlJ10pOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMTAnLCAnMjknLCAnMTknLCAnMjEnXSk7CgogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5waG9uZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnNTU1LTk4NzYnLCAnNTU1LTg3NjUnLCAnNTU1LTU2NzgnLCAnNTU1LTQzMjEnLCAnNTU1LTEyMTInXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdKdWxpZScsICdBZGFtJywgJ01pa2UnLCAnSm9obiddKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIG9yZGVyQnlGaWx0ZXIuJGluamVjdCA9IFsnJHBhcnNlJ107CiAgICBmdW5jdGlvbiBvcmRlckJ5RmlsdGVyKCRwYXJzZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGUgOiBbc29ydFByZWRpY2F0ZV07CiAgICAgICAgICAgIHNvcnRQcmVkaWNhdGUgPSBtYXAoc29ydFByZWRpY2F0ZSwgZnVuY3Rpb24gKHByZWRpY2F0ZSkgewogICAgICAgICAgICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLCBnZXQoYikpOwogICAgICAgICAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgYXJyYXlDb3B5ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJhdG9yKG8xLCBvMikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0Jvb2xlYW4oZGVzY2VuZGluZykKICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXAoYiwgYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgOiBjb21wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2MikgewogICAgICAgICAgICAgICAgdmFyIHQxID0gdHlwZW9mIHYxOwogICAgICAgICAgICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICAgICAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MSA9IHYxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYxID09PSB2MikgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYxIDwgdjIgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0MSA8IHQyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5nRGlyZWN0aXZlKGRpcmVjdGl2ZSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgZGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbGluazogZGlyZWN0aXZlCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBQyc7CiAgICAgICAgcmV0dXJuIHZhbHVlRm4oZGlyZWN0aXZlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTphCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTW9kaWZpZXMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgaHRtbCBBIHRhZywgc28gdGhhdCB0aGUgZGVmYXVsdCBhY3Rpb24gaXMgcHJldmVudGVkIHdoZW4gaHJlZgogICAgICogYXR0cmlidXRlIGlzIGVtcHR5LgogICAgICoKICAgICAqIFRoZSByZWFzb25pbmcgZm9yIHRoaXMgY2hhbmdlIGlzIHRvIGFsbG93IGVhc3kgY3JlYXRpb24gb2YgYWN0aW9uIGxpbmtzIHdpdGggYG5nQ2xpY2tgIGRpcmVjdGl2ZQogICAgICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAgICAgKiBgPGEgaHJlZj0iIiBuZy1jbGljaz0ibW9kZWwuJHNhdmUoKSI+U2F2ZTwvYT5gCiAgICAgKi8KICAgIHZhciBodG1sQW5jaG9yRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAgICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgICAgICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgICAgICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgICAgICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoJ2hyZWYnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIcmVmCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogICAgICogdGhlIHBhZ2Ugb3BlbiB0byBhIHdyb25nIFVSTCwgaWYgdGhlIHVzZXIgY2xpY2tzIHRoYXQgbGluayBiZWZvcmUKICAgICAqIGFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIHt7aGFzaH19IHdpdGggYWN0dWFsIFVSTCwgdGhlCiAgICAgKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICAgICAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgQQogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVGhpcyBleGFtcGxlIHVzZXMgYGxpbmtgIHZhcmlhYmxlIGluc2lkZSBgaHJlZmAgYXR0cmlidXRlOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0xJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTEnKS5hdHRyKCdocmVmJykpLnRvQmUoIiIpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMicpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0yJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0zJykuYXR0cignaHJlZicpKS50b0JlKCIvMTIzIik7CgogICAgICAgICAgZWxlbWVudCgnI2xpbmstMycpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoYnJvd3NlcigpLndpbmRvdygpLnBhdGgoKSkudG9FcXVhbCgnLzEyMycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nLWhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgnNicpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLnVybCgpKS50b0VxdWFsKCcvNicpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NyYwogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IElNRwogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEaXNhYmxlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAgICAgKiA8cHJlPgogICAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICAgKiA8L2Rpdj4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBkaXNhYmxlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nRGlzYWJsZWRgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hlY2tlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBjaGVja2VkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdtYXN0ZXInKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNdWx0aXBsZQogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nTXVsdGlwbGVgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICA8c2VsZWN0IGlkPSJzZWxlY3QiIG5nLW11bHRpcGxlPSJjaGVja2VkIj4KICAgICA8b3B0aW9uPk1pc2tvPC9vcHRpb24+CiAgICAgPG9wdGlvbj5JZ29yPC9vcHRpb24+CiAgICAgPG9wdGlvbj5Wb2p0YTwvb3B0aW9uPgogICAgIDxvcHRpb24+RGk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBtdWx0aXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IFNFTEVDVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ011bHRpcGxlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUmVhZG9ubHkKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NlbGVjdGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHNlbGVjdGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlZCB0aGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgICAgPHNlbGVjdD4KICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnc2VsZWN0ZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IE9QVElPTgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24gKHByb3BOYW1lLCBhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0pOwoKCi8vIG5nLXNyYywgbmctaHJlZiBhcmUgaW50ZXJwb2xhdGVkCiAgICBmb3JFYWNoKFsnc3JjJywgJ2hyZWYnXSwgZnVuY3Rpb24gKGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIGVsZW1lbnQucHJvcChhdHRyTmFtZSwgYXR0clthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCiAgICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgICAgICRhZGRDb250cm9sOiBub29wLAogICAgICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICAgICAkc2V0RGlydHk6IG5vb3AKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybSB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgY29udGFpbmluZyBjb250cm9sIG9yIGZvcm0gaXMgaW52YWxpZC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIElzIGFuIG9iamVjdCBoYXNoLCBjb250YWluaW5nIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgY29udHJvbHMgb3IKICAgICAqICBmb3Jtcywgd2hlcmU6CiAgICAgKgogICAgICogIC0ga2V5cyBhcmUgdmFsaWRhdGlvbiB0b2tlbnMgKGVycm9yIG5hbWVzKSDigJQgc3VjaCBhcyBgcmVxdWlyZWRgLCBgdXJsYCBvciBgZW1haWxgKSwKICAgICAqICAtIHZhbHVlcyBhcmUgYXJyYXlzIG9mIGNvbnRyb2xzIG9yIGZvcm1zIHRoYXQgYXJlIGludmFsaWQgd2l0aCBnaXZlbiBlcnJvci4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIGBGb3JtQ29udHJvbGxlcmAga2VlcHMgdHJhY2sgb2YgYWxsIGl0cyBjb250cm9scyBhbmQgbmVzdGVkIGZvcm1zIGFzIHdlbGwgYXMgc3RhdGUgb2YgdGhlbSwKICAgICAqIHN1Y2ggYXMgYmVpbmcgdmFsaWQvaW52YWxpZCBvciBkaXJ0eS9wcmlzdGluZS4KICAgICAqCiAgICAgKiBFYWNoIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfSBkaXJlY3RpdmUgY3JlYXRlcyBhbiBpbnN0YW5jZQogICAgICogb2YgYEZvcm1Db250cm9sbGVyYC4KICAgICAqCiAgICAgKi8KLy9hc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgIEZvcm1Db250cm9sbGVyLiRpbmplY3QgPSBbJyRlbGVtZW50JywgJyRhdHRycycsICckc2NvcGUnXTsKICAgIGZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLAogICAgICAgICAgICBwYXJlbnRGb3JtID0gZWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgIGVycm9ycyA9IGZvcm0uJGVycm9yID0ge307CgogICAgICAgIC8vIGluaXQgc3RhdGUKICAgICAgICBmb3JtLiRuYW1lID0gYXR0cnMubmFtZTsKICAgICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgICAgICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgIGVsZW1lbnQuCiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgYWRkQ2xhc3MoKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICAgICAgICB9CgogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICBpZiAoY29udHJvbC4kbmFtZSAmJiAhZm9ybS5oYXNPd25Qcm9wZXJ0eShjb250cm9sLiRuYW1lKSkgewogICAgICAgICAgICAgICAgZm9ybVtjb250cm9sLiRuYW1lXSA9IGNvbnRyb2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRyZW1vdmVDb250cm9sID0gZnVuY3Rpb24gKGNvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgZm9ybVtjb250cm9sLiRuYW1lXSA9PT0gY29udHJvbCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uIChxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgICAgICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSA9IGZ1bmN0aW9uICh2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXREaXJ0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoRElSVFlfQ0xBU1MpOwogICAgICAgICAgICBmb3JtLiRkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIGZvcm0uJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgfTsKCiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRm9ybQogICAgICogQHJlc3RyaWN0IEVBQwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTmVzdGFibGUgYWxpYXMgb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGBmb3JtYH0gZGlyZWN0aXZlLiBIVE1MCiAgICAgKiBkb2VzIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGZvcm0gZWxlbWVudHMuIEl0IGlzIHVzZWZ1bCB0byBuZXN0IGZvcm1zLCBmb3IgZXhhbXBsZSBpZiB0aGUgdmFsaWRpdHkgb2YgYQogICAgICogc3ViLWdyb3VwIG9mIGNvbnRyb2xzIG5lZWRzIHRvIGJlIGRldGVybWluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lfG5nRm9ybSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGlyZWN0aXZlIHRoYXQgaW5zdGFudGlhdGVzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogICAgICoKICAgICAqIElmIGBuYW1lYCBhdHRyaWJ1dGUgaXMgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIGlzIHB1Ymxpc2hlZCBvbnRvIHRoZSBjdXJyZW50IHNjb3BlIHVuZGVyCiAgICAgKiB0aGlzIG5hbWUuCiAgICAgKgogICAgICogIyBBbGlhczoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9CiAgICAgKgogICAgICogSW4gYW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICAgKiBmb3JtcyBhcmUgdmFsaWQgYXMgd2VsbC4gSG93ZXZlciBicm93c2VycyBkbyBub3QgYWxsb3cgbmVzdGluZyBvZiBgPGZvcm0+YCBlbGVtZW50cywgZm9yIHRoaXMKICAgICAqIHJlYXNvbiBhbmd1bGFyIHByb3ZpZGVzIHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfSBhbGlhcwogICAgICogd2hpY2ggYmVoYXZlcyBpZGVudGljYWwgdG8gYDxmb3JtPmAgYnV0IGFsbG93cyBmb3JtIG5lc3RpbmcuCiAgICAgKgogICAgICoKICAgICAqICMgQ1NTIGNsYXNzZXMKICAgICAqICAtIGBuZy12YWxpZGAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogICAgICogIC0gYG5nLWludmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBpbnZhbGlkLgogICAgICogIC0gYG5nLXByaXN0aW5lYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICAgKiAgLSBgbmctZGlydHlgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICAgICAqCiAgICAgKgogICAgICogIyBTdWJtaXR0aW5nIGEgZm9ybSBhbmQgcHJldmVudGluZyBkZWZhdWx0IGFjdGlvbgogICAgICoKICAgICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAgICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAgICAgKiBwYWdlIHJlbG9hZCB0aGF0IHNlbmRzIHRoZSBkYXRhIHRvIHRoZSBzZXJ2ZXIuIEluc3RlYWQgc29tZSBqYXZhc2NyaXB0IGxvZ2ljIHNob3VsZCBiZSB0cmlnZ2VyZWQKICAgICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheS4KICAgICAqCiAgICAgKiBGb3IgdGhpcyByZWFzb24sIEFuZ3VsYXIgcHJldmVudHMgdGhlIGRlZmF1bHQgYWN0aW9uIChmb3JtIHN1Ym1pc3Npb24gdG8gdGhlIHNlcnZlcikgdW5sZXNzIHRoZQogICAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBvbmUgb2YgdGhlIGZvbGxvd2luZyB0d28gd2F5cyB0byBzcGVjaWZ5IHdoYXQgamF2YXNjcmlwdCBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB3aGVuCiAgICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAgICoKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdCBuZ1N1Ym1pdH0gZGlyZWN0aXZlIG9uIHRoZSBmb3JtIGVsZW1lbnQKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgICAqCiAgICAgKiBUbyBwcmV2ZW50IGRvdWJsZSBleGVjdXRpb24gb2YgdGhlIGhhbmRsZXIsIHVzZSBvbmx5IG9uZSBvZiBuZ1N1Ym1pdCBvciBuZ0NsaWNrIGRpcmVjdGl2ZXMuIFRoaXMKICAgICAqIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgY29taW5nIGZyb20gdGhlIGh0bWwgc3BlYzoKICAgICAqCiAgICAgKiAtIElmIGEgZm9ybSBoYXMgb25seSBvbmUgaW5wdXQgZmllbGQgdGhlbiBoaXR0aW5nIGVudGVyIGluIHRoaXMgZmllbGQgdHJpZ2dlcnMgZm9ybSBzdWJtaXQKICAgICAqIChgbmdTdWJtaXRgKQogICAgICogLSBpZiBhIGZvcm0gaGFzIGhhcyAyKyBpbnB1dCBmaWVsZHMgYW5kIG5vIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4gaGl0dGluZyBlbnRlcgogICAgICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogICAgICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogICAgICogaGl0dGluZyBlbnRlciBpbiBhbnkgb2YgdGhlIGlucHV0IGZpZWxkcyB3aWxsIHRyaWdnZXIgdGhlIGNsaWNrIGhhbmRsZXIgb24gdGhlICpmaXJzdCogYnV0dG9uIG9yCiAgICAgKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+UmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgndXNlclR5cGUnKS5lbnRlcignJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgZm9ybURpcmVjdGl2ZUZhY3RvcnkgPSBmdW5jdGlvbiAoaXNOZ0Zvcm0pIHsKICAgICAgICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uICgkdGltZW91dCkgewogICAgICAgICAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6ICdmb3JtJywKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBGb3JtQ29udHJvbGxlciwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIChzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdW5yZWdpc3RlciB0aGUgcHJldmVudERlZmF1bHQgbGlzdGVuZXIgc28gdGhhdCB3ZSBkb24ndCBub3QgbGVhayBtZW1vcnkgYnV0IGluIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3YXkgdGhhdCB3aWxsIGFjaGlldmUgdGhlIHByZXZlbnRpb24gb2YgdGhlIGRlZmF1bHQgYWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm1DdHJsLiRyZW1vdmVDb250cm9sKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW2FsaWFzXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlciwgbnVsbEZvcm1DdHJsKTsgLy9zdG9wIHByb3BhZ2F0aW5nIGNoaWxkIGRlc3RydWN0aW9uIGhhbmRsZXJzIHVwd2FyZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gaXNOZ0Zvcm0gPyBleHRlbmQoY29weShmb3JtRGlyZWN0aXZlKSwge3Jlc3RyaWN0OiAnRUFDJ30pIDogZm9ybURpcmVjdGl2ZTsKICAgICAgICB9XTsKICAgIH07CgogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogICAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAgIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICAgIHZhciBFTUFJTF9SRUdFWFAgPSAvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDR9JC87CiAgICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgICB2YXIgaW5wdXRUeXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2d1ZXN0JzsKICAgICAgICAgICAgICRzY29wZS53b3JkID0gL15cdyokLzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBTaW5nbGUgd29yZDogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIKICAgICAgICAgbmctcGF0dGVybj0id29yZCIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnBhdHRlcm4iPgogICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2hlbGxvIHdvcmxkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ3RleHQnOiB0ZXh0SW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBudW1iZXIgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIFNldHMgdGhlIGBudW1iZXJgIHZhbGlkYXRpb24KICAgICAgICAgKiBlcnJvciBpZiBub3QgYSB2YWxpZCBudW1iZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgIG1pbj0iMCIgbWF4PSI5OSIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5saXN0LiRlcnJvci5udW1iZXIiPgogICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnMTInKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJzEyMycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdudW1iZXInOiBudW1iZXJJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnVybAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIFVSTCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgdXJsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgY29udGVudCBpcyBub3QgYQogICAgICAgICAqIHZhbGlkIFVSTC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVVJMOiA8aW5wdXQgdHlwZT0idXJsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci51cmwiPgogICAgICAgICBOb3QgdmFsaWQgdXJsITwvc3Bhbj4KICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci51cmwgPSB7eyEhbXlGb3JtLiRlcnJvci51cmx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdodHRwOi8vZ29vZ2xlLmNvbScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgdXJsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3h4eCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAgICAgICAqIGFkZHJlc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQucmFkaW8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvcn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbG9yJykpLnRvRXF1YWwoJ2JsdWUnKTsKCiAgICAgICAgICAgIGlucHV0KCdjb2xvcicpLnNlbGVjdCgncmVkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdZRVMnKTsKCiAgICAgICAgICAgIGlucHV0KCd2YWx1ZTEnKS5jaGVjaygpOwogICAgICAgICAgICBpbnB1dCgndmFsdWUyJykuY2hlY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgICAgICdoaWRkZW4nOiBub29wLAogICAgICAgICdidXR0b24nOiBub29wLAogICAgICAgICdzdWJtaXQnOiBub29wLAogICAgICAgICdyZXNldCc6IG5vb3AKICAgIH07CgoKICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRyaW0oZWxlbWVudC52YWwoKSk7CgogICAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBpZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgImlucHV0IiBldmVudCwgd2UgYXJlIGZpbmUgLSBleGNlcHQgb24gSUU5IHdoaWNoIGRvZXNuJ3QgZmlyZSB0aGUKICAgICAgICAvLyBpbnB1dCBldmVudCBvbiBiYWNrc3BhY2UsIGRlbGV0ZSBvciBjdXQKICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ2lucHV0JykpIHsKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdpbnB1dCcsIGxpc3RlbmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdGltZW91dDsKCiAgICAgICAgICAgIHZhciBkZWZlckxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAgICAgICAgIC8vIGlnbm9yZQogICAgICAgICAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgICAgICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NoYW5nZScsIGxpc3RlbmVyKTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgbW9kaWZpZXMgaW5wdXQgdmFsdWUgdXNpbmcgY29udGV4dCBtZW51IGluIElFLCB3ZSBuZWVkICJwYXN0ZSIgYW5kICJjdXQiIGV2ZW50cyB0byBjYXRjaCBpdAogICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ3Bhc3RlJykpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQudmFsKGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgICAgIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3I7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uIChyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAocGF0dGVybikgewogICAgICAgICAgICBpZiAocGF0dGVybi5tYXRjaCgvXlwvKC4qKVwvJC8pKSB7CiAgICAgICAgICAgICAgICBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnN1YnN0cigxLCBwYXR0ZXJuLmxlbmd0aCAtIDIpKTsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybiwgdmFsdWUpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGF0dGVybk9iaiB8fCAhcGF0dGVybk9iai50ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdHRlcm4gKyAnIHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgJyArIHBhdHRlcm5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoIDwgbWlubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbmxlbmd0aCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gbWF4IGxlbmd0aCB2YWxpZGF0b3IKICAgICAgICBpZiAoYXR0ci5uZ01heGxlbmd0aCkgewogICAgICAgICAgICB2YXIgbWF4bGVuZ3RoID0gaW50KGF0dHIubmdNYXhsZW5ndGgpOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA+IG1heGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heGxlbmd0aCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbnVtYmVySW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGlzRW1wdHkodmFsdWUpOwogICAgICAgICAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzRW1wdHkodmFsdWUpID8gJycgOiAnJyArIHZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoYXR0ci5taW4pIHsKICAgICAgICAgICAgdmFyIG1pbiA9IHBhcnNlRmxvYXQoYXR0ci5taW4pOwogICAgICAgICAgICB2YXIgbWluVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlIDwgbWluKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWluJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGF0dHIubWF4KSB7CiAgICAgICAgICAgIHZhciBtYXggPSBwYXJzZUZsb2F0KGF0dHIubWF4KTsKICAgICAgICAgICAgdmFyIG1heFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBpc051bWJlcih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXJsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgdXJsVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgZW1haWxWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGVsZW1lbnRbMF0uY2hlY2tlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZVZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnRleHRhcmVhCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCB0ZXh0YXJlYSBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gVGhlIGRhdGEtYmluZGluZyBhbmQgdmFsaWRhdGlvbgogICAgICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQKICAgICAqIEByZXN0cmljdCBFCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVE1MIGlucHV0IGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBJbnB1dCBjb250cm9sIGZvbGxvd3MgSFRNTDUgaW5wdXQgdHlwZXMKICAgICAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nUmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBpZiBzZXQgdG8gdHJ1ZQogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgVXNlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiIG5nLW1vZGVsPSJ1c2VyLm5hbWUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLnVzZXJOYW1lLiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICAgIFRvbyBzaG9ydCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1heGxlbmd0aCI+CiAgICAgVG9vIGxvbmchPC9zcGFuPjxicj4KICAgICA8L2Zvcm0+CiAgICAgPGhyPgogICAgIDx0dD51c2VyID0ge3t1c2VyfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kdmFsaWQgPSB7e215Rm9ybS51c2VyTmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiR2YWxpZCA9IHt7bXlGb3JtLmxhc3ROYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kZXJyb3IgPSB7e215Rm9ybS5sYXN0TmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5taW5sZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5taW5sZW5ndGh9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLm5hbWUnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbGVzcyB0aGFuIHJlcXVpcmVkIG1pbiBsZW5ndGgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcigneHgnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9taW5sZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3NvbWUgcmlkaWN1bG91c2x5IGxvbmcgbmFtZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkKICAgICAgICAgICAgLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9tYXhsZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICAgICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgICAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICAgICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogICAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBXaGVuZXZlciB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00sIGl0IGV4ZWN1dGVzCiAgICAgKiAgICAgYWxsIG9mIHRoZXNlIGZ1bmN0aW9ucyB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBXaGVuZXZlciB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcywgaXQgZXhlY3V0ZXMgYWxsIG9mCiAgICAgKiAgICAgdGhlc2UgZnVuY3Rpb25zIHRvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBiamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbCB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgZXJyb3Igb24gdGhlIGNvbnRyb2wuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGUsIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICAgKiBzcGVjaWZpY2FsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAgICogRE9NIGV2ZW50cy4gVGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgaXMgbWVhbnQgdG8gYmUgZXh0ZW5kZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGVyZSwgdGhlCiAgICAgKiBkaXJlY3RpdmUgcHJvdmlkZXMgRE9NIG1hbmlwdWxhdGlvbiBhbmQgdGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgdGhlIGRhdGEtYmluZGluZy4KICAgICAqCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAgICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIDxleGFtcGxlIG1vZHVsZT0iY3VzdG9tQ29udHJvbCI+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICBbY29udGVudGVkaXRhYmxlXSB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgbWluLWhlaWdodDogMjBweDsKICAgICAgfQoKICAgICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGFuZ3VsYXIubW9kdWxlKCdjdXN0b21Db250cm9sJywgW10pLgogICAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0EnLCAvLyBvbmx5IGFjdGl2YXRlIG9uIGVsZW1lbnQgYXR0cmlidXRlCiAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBuZ01vZGVsKSB7CiAgICAgICAgICAgICAgaWYoIW5nTW9kZWwpIHJldHVybjsgLy8gZG8gbm90aGluZyBpZiBubyBuZy1tb2RlbAoKICAgICAgICAgICAgICAvLyBTcGVjaWZ5IGhvdyBVSSBzaG91bGQgYmUgdXBkYXRlZAogICAgICAgICAgICAgIG5nTW9kZWwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJyk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdibHVyIGtleXVwIGNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlYWQoKTsgLy8gaW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAvLyBXcml0ZSBkYXRhIHRvIHRoZSBtb2RlbAogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoKSB7CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoZWxlbWVudC5odG1sKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICA8ZGl2IGNvbnRlbnRlZGl0YWJsZQogICAgIG5hbWU9Im15V2lkZ2V0IiBuZy1tb2RlbD0idXNlckNvbnRlbnQiCiAgICAgcmVxdWlyZWQ+Q2hhbmdlIG1lITwvZGl2PgogICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICA8aHI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGRhdGEtYmluZCBhbmQgYmVjb21lIGludmFsaWQnLCBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudEVkaXRhYmxlID0gZWxlbWVudCgnW2NvbnRlbnRlZGl0YWJsZV0nKTsKCiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJ0NoYW5nZSBtZSEnKTsKICAgICAgICBpbnB1dCgndXNlckNvbnRlbnQnKS5lbnRlcignJyk7CiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUucHJvcCgnY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLWludmFsaWQtcmVxdWlyZWQvKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgICogPC9leGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIE5nTW9kZWxDb250cm9sbGVyID0gWyckc2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGF0dHJzJywgJyRlbGVtZW50JywgJyRwYXJzZScsCiAgICAgICAgZnVuY3Rpb24gKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlKSB7CiAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgICAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgICAgICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICAgICAgICAgICAgaWYgKCFuZ01vZGVsU2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgJGF0dHIubmdNb2RlbCArCiAgICAgICAgICAgICAgICAgICAgJyAoJyArIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSArICcpJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgICAgICAkZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0Vmlld1ZhbHVlCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmVhZCBhIHZhbHVlIGZyb20gdmlldy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBmcm9tIHdpdGhpbiBhIERPTSBldmVudCBoYW5kbGVyLgogICAgICAgICAgICAgKiBGb3IgZXhhbXBsZSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fSBvcgogICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9IGRpcmVjdGl2ZXMgY2FsbCBpdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQgaW50ZXJuYWxseSBjYWxscyBhbGwgYHBhcnNlcnNgIGFuZCBpZiByZXN1bHRlZCB2YWx1ZSBpcyB2YWxpZCwgdXBkYXRlcyB0aGUgbW9kZWwgYW5kCiAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR2aWV3VmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBjaGFuZ2UgdG8gZGlydHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRwcmlzdGluZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKFBSSVNUSU5FX0NMQVNTKS5hZGRDbGFzcyhESVJUWV9DTEFTUyk7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3JFYWNoKHRoaXMuJHBhcnNlcnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxTZXQoJHNjb3BlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIG1vZGVsIC0+IHZhbHVlCiAgICAgICAgICAgIHZhciBjdHJsID0gdGhpczsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdNb2RlbFdhdGNoKCkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbmdNb2RlbEdldCgkc2NvcGUpOwoKICAgICAgICAgICAgICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgICAgICAgICAgICAgaWYgKGN0cmwuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBmb3JtYXR0ZXJzID0gY3RybC4kZm9ybWF0dGVycywKICAgICAgICAgICAgICAgICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaWR4LS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kdmlld1ZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwKICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSXMgZGlyZWN0aXZlIHRoYXQgdGVsbHMgQW5ndWxhciB0byBkbyB0d28td2F5IGRhdGEgYmluZGluZy4gSXQgd29ya3MgdG9nZXRoZXIgd2l0aCBgaW5wdXRgLAogICAgICogYHNlbGVjdGAsIGB0ZXh0YXJlYWAuIFlvdSBjYW4gZWFzaWx5IHdyaXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMgdG8gdXNlIGBuZ01vZGVsYCBhcyB3ZWxsLgogICAgICoKICAgICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICAgKgogICAgICogLSBiaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAgICogICByZXF1aXJlLAogICAgICogLSBwcm92aWRpbmcgdmFsaWRhdGlvbiBiZWhhdmlvciAoaS5lLiByZXF1aXJlZCwgbnVtYmVyLCBlbWFpbCwgdXJsKSwKICAgICAqIC0ga2VlcGluZyBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKSwKICAgICAqIC0gc2V0dGluZyByZWxhdGVkIGNzcyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApLAogICAgICogLSByZWdpc3RlciB0aGUgY29udHJvbCB3aXRoIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICAgKgogICAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAgICoKICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dCB0ZXh0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94IGNoZWNrYm94fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvIHJhZGlvfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlciBudW1iZXJ9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQuZW1haWwgZW1haWx9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudXJsIHVybH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICAgKgogICAgICovCiAgICB2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybUN0cmwuJHJlbW92ZUNvbnRyb2wobW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hhbmdlCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHVzZXIgY2hhbmdlcyB0aGUgaW5wdXQuCiAgICAgKiBUaGUgZXhwcmVzc2lvbiBpcyBub3QgZXZhbHVhdGVkIHdoZW4gdGhlIHZhbHVlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSB0aGUgbW9kZWwuCiAgICAgKgogICAgICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPGRvYzpleGFtcGxlPgogICAgICogICA8ZG9jOnNvdXJjZT4KICAgICAqICAgICA8c2NyaXB0PgogICAgICogICAgICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICogICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7CiAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICB9OwogKiAgICAgICB9CiAgICAgKiAgICAgPC9zY3JpcHQ+CiAgICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICAgICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgICAqICAgICAgIGRlYnVnID0ge3tjb25maXJtZWR9fTxiciAvPgogICAgICogICAgICAgY291bnRlciA9IHt7Y291bnRlcn19CiAgICAgKiAgICAgPC9kaXY+CiAgICAgKiAgIDwvZG9jOnNvdXJjZT4KICAgICAqICAgPGRvYzpzY2VuYXJpbz4KICAgICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTEnKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcxJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMicpLmNsaWNrKCk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudGVyJykpLnRvRXF1YWwoJzAnKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbmZpcm1lZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAqICAgICB9KTsKICAgICAqICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgKiA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKICAgIHZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIChpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA9PT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdMaXN0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBjb21tYS1zZXBhcmF0ZWQgc3RyaW5nIGludG8gYW4gYXJyYXkgb2Ygc3RyaW5ncy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAgICogICBzcGVjaWZpZWQgaW4gZm9ybSBgL3NvbWV0aGluZy9gIHRoZW4gdGhlIHZhbHVlIHdpbGwgYmUgY29udmVydGVkIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtaXNrbycsICd2b2p0YSddOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHR0Pm5hbWVzID0ge3tuYW1lc319PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5uYW1lc0lucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbImlnb3IiLCJtaXNrbyIsInZvanRhIl0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCduYW1lcycpLmVudGVyKCcnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbXScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0xpc3REaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgICAgICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uICh2aWV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CgogICAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKHRwbCwgdHBsQXR0cikgewogICAgICAgICAgICAgICAgaWYgKENPTlNUQU5UX1ZBTFVFX1JFR0VYUC50ZXN0KHRwbEF0dHIubmdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogICAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAgICoKICAgICAqIE9uZSBzY2VuYXJpbyBpbiB3aGljaCB0aGUgdXNlIG9mIGBuZ0JpbmRgIGlzIHByZWZlcnJlZCBvdmVyIGB7eyBleHByZXNzaW9uIH19YCBiaW5kaW5nIGlzIHdoZW4KICAgICAqIGl0J3MgZGVzaXJhYmxlIHRvIHB1dCBiaW5kaW5ncyBpbnRvIHRlbXBsYXRlIHRoYXQgaXMgbW9tZW50YXJpbHkgZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cwogICAgICogcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlCiAgICAgKiBiaW5kaW5ncyBpbnZpc2libGUgdG8gdGhlIHVzZXIgd2hpbGUgdGhlIHBhZ2UgaXMgbG9hZGluZy4KICAgICAqCiAgICAgKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30gZGlyZWN0aXZlLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBFbnRlciBhIG5hbWUgaW4gdGhlIExpdmUgUHJldmlldyB0ZXh0IGJveDsgdGhlIGdyZWV0aW5nIGJlbG93IHRoZSB0ZXh0IGJveCBjaGFuZ2VzIGluc3RhbnRseS4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1doaXJsZWQnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICBIZWxsbyA8c3BhbiBuZy1iaW5kPSJuYW1lIj48L3NwYW4+IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCdXaGlybGVkJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3dvcmxkJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdCaW5kRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZFRlbXBsYXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICAgICAqIHRleHQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIHRlbXBsYXRlIGluIG5nQmluZFRlbXBsYXRlLgogICAgICogVW5saWtlIG5nQmluZCB0aGUgbmdCaW5kVGVtcGxhdGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAgICAgKiBleHByZXNzaW9ucy4gKFRoaXMgaXMgcmVxdWlyZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAgICAgKiBjYW4gbm90IGhhdmUgU1BBTiBlbGVtZW50cyBzdWNoIGFzIFRJVExFLCBvciBPUFRJT04gdG8gbmFtZSBhIGZldy4pCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1dvcmxkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS4KICAgICAgICAgICB0b0JlKCdXb3JsZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnc2FsdXRhdGlvbicpLmVudGVyKCdHcmVldGluZ3MnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcigndXNlcicpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdHcmVldGluZ3MnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgdG9CZSgndXNlcicpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWxVbnNhZmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAgICogZWxlbWVudC4gKlRoZSBpbm5lckhUTUwtZWQgY29udGVudCB3aWxsIG5vdCBiZSBzYW5pdGl6ZWQhKiBZb3Ugc2hvdWxkIHVzZSB0aGlzIGRpcmVjdGl2ZSBvbmx5IGlmCiAgICAgKiB7QGxpbmsgbmdTYW5pdGl6ZS5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgaXMgdG9vCiAgICAgKiByZXN0cmljdGl2ZSBhbmQgd2hlbiB5b3UgYWJzb2x1dGVseSB0cnVzdCB0aGUgc291cmNlIG9mIHRoZSBjb250ZW50IHlvdSBhcmUgYmluZGluZyB0by4KICAgICAqCiAgICAgKiBTZWUge0BsaW5rIG5nU2FuaXRpemUuJHNhbml0aXplICRzYW5pdGl6ZX0gZG9jcyBmb3IgZXhhbXBsZXMuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWxVbnNhZmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKi8KICAgIHZhciBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbFVuc2FmZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWxVbnNhZmUsIGZ1bmN0aW9uIG5nQmluZEh0bWxVbnNhZmVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgb2xkVmFsID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdjbGFzcycsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIG5nQ2xhc3MgPSBzY29wZS4kZXZhbChhdHRyW25hbWVdKTsKICAgICAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihuZ0NsYXNzLCBuZ0NsYXNzKTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgaWYgKG5hbWUgIT09ICduZ0NsYXNzJykgewogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCckaW5kZXgnLCBmdW5jdGlvbiAoJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kICE9PSBvbGQkaW5kZXggJiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsIG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Mob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MobmV3VmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9sZFZhbCA9IGNvcHkobmV3VmFsKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNsYXNzKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoY2xhc3NWYWwpICYmICFpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzVmFsID0gbWFwKGNsYXNzVmFsLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgcmV0dXJuIGsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoaXNBcnJheShjbGFzc1ZhbCkgPyBjbGFzc1ZhbC5qb2luKCcgJykgOiBjbGFzc1ZhbCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSAmJiAhaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc1ZhbCA9IG1hcChjbGFzc1ZhbCwgZnVuY3Rpb24gKHYsIGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHJldHVybiBrCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGlzQXJyYXkoY2xhc3NWYWwpID8gY2xhc3NWYWwuam9pbignICcpIDogY2xhc3NWYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzYCBhbGxvd3MgeW91IHRvIHNldCBDU1MgY2xhc3Mgb24gSFRNTCBlbGVtZW50IGR5bmFtaWNhbGx5IGJ5IGRhdGFiaW5kaW5nIGFuCiAgICAgKiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICAgICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgICAgPGJyPgogICAgIDxzcGFuIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm15LWNsYXNzIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246Zmlyc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246bGFzdCcpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzc09kZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fQogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xhc3NFdmVuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogICAgICogICByZXN1bHQgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbG9hawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAgICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0eXBpY2FsbHkgYSBmaW5lLWdyYWluZWQgYXBwbGljYXRpb24gaXMKICAgICAqIHByZWZlcmVkIGluIG9yZGVyIHRvIGJlbmVmaXQgZnJvbSBwcm9ncmVzc2l2ZSByZW5kZXJpbmcgb2YgdGhlIGJyb3dzZXIgdmlldy4KICAgICAqCiAgICAgKiBgbmdDbG9ha2Agd29ya3MgaW4gY29vcGVyYXRpb24gd2l0aCBhIGNzcyBydWxlIHRoYXQgaXMgZW1iZWRkZWQgd2l0aGluIGBhbmd1bGFyLmpzYCBhbmQKICAgICAqICBgYW5ndWxhci5taW4uanNgIGZpbGVzLiBGb2xsb3dpbmcgaXMgdGhlIGNzcyBydWxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiBbbmdcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sIC5uZy1jbG9haywgLngtbmctY2xvYWsgewogKiAgIGRpc3BsYXk6IG5vbmU7CiAqIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICAgICAqIGFyZSB0YWdnZWQgd2l0aCB0aGUgYG5nLWNsb2FrYCBkaXJlY3RpdmUgYXJlIGhpZGRlbi4gV2hlbiBBbmd1bGFyIGNvbWVzIGFjcm9zcyB0aGlzIGRpcmVjdGl2ZQogICAgICogZHVyaW5nIHRoZSBjb21waWxhdGlvbiBvZiB0aGUgdGVtcGxhdGUgaXQgZGVsZXRlcyB0aGUgYG5nQ2xvYWtgIGVsZW1lbnQgYXR0cmlidXRlLCB3aGljaAogICAgICogbWFrZXMgdGhlIGNvbXBpbGVkIGVsZW1lbnQgdmlzaWJsZS4KICAgICAqCiAgICAgKiBGb3IgdGhlIGJlc3QgcmVzdWx0LCBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwgZmlsZTsKICAgICAqIGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSAoYWJvdmUpIG11c3QgYmUgaW5jbHVkZWQgaW4gdGhlIGV4dGVybmFsIHN0eWxlc2hlZXQgb2YgdGhlCiAgICAgKiBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBMZWdhY3kgYnJvd3NlcnMsIGxpa2UgSUU3LCBkbyBub3QgcHJvdmlkZSBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VwcG9ydCAoYWRkZWQgaW4gQ1NTIDIuMSkgc28gdGhleQogICAgICogY2Fubm90IG1hdGNoIHRoZSBgW25nXDpjbG9ha11gIHNlbGVjdG9yLiBUbyB3b3JrIGFyb3VuZCB0aGlzIGxpbWl0YXRpb24sIHlvdSBtdXN0IGFkZCB0aGUgY3NzCiAgICAgKiBjbGFzcyBgbmdDbG9ha2AgaW4gYWRkaXRpb24gdG8gYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcyBzaG93biBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTEnKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3RlbXBsYXRlMicpLmF0dHIoJ25nLWNsb2FrJykpLgogICAgICAgICAgIG5vdCgpLnRvQmVEZWZpbmVkKCk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIG5nQ2xvYWtEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAgICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAgICAgKgogICAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgICAqCiAgICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgZGF0YSBpbiBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICAgKiAqIENvbnRyb2xsZXIg4oCUIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogICAgICogICBtZXRob2RzIHRoYXQgdHlwaWNhbGx5IGV4cHJlc3MgdGhlIGJ1c2luZXNzIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICAgICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAgICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBOb3RpY2UgdGhhdCB0aGUgc2NvcGUgYmVjb21lcyB0aGUgYHRoaXNgIGZvciB0aGUKICAgICAqIGNvbnRyb2xsZXIncyBpbnN0YW5jZS4gVGhpcyBhbGxvd3MgZm9yIGVhc3kgYWNjZXNzIHRvIHRoZSB2aWV3IGRhdGEgZnJvbSB0aGUgY29udHJvbGxlci4gQWxzbwogICAgICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICAgICAqIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAgICAgICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAgICAgICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICAgICAgICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwoKICAgICAkc2NvcGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICBhbGVydCh0aGlzLm5hbWUpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogICAgIH07CgogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogICAgICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICAgICAgICAgIH07CiAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyIj4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICBDb250YWN0OgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJjbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0icmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogICAgIDwvbGk+CiAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY+OmlucHV0JykudmFsKCkpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgyKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBpbnB1dCcpLnZhbCgpKS50b0JlKCcnKTsKCiAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBhOmNvbnRhaW5zKCJhZGQiKScpLmNsaWNrKCk7CiAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgzKSBpbnB1dCcpLnZhbCgpKQogICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUgPSBbZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgICBjb250cm9sbGVyOiAnQCcKICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDc3AKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGVsZW1lbnQgaHRtbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICAgKgogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICoKICAgICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBCeSBhcHBseWluZyBgbmdDc3BgCiAgICAgKiBpdCBpcyBiZSBwb3NzaWJsZSB0byBvcHQgaW50byB0aGUgQ1NQIGNvbXBhdGlibGUgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICAgICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICAgKiBiZSByYWlzZWQuCiAgICAgKgogICAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgIDxwcmU+CiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICRzbmlmZmVyLmNzcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nQ2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICAgKiBlbGVtZW50IGlzIGNsaWNrZWQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICBJbmNyZW1lbnQKICAgICA8L2J1dHRvbj4KICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnY291bnQnKSkudG9CZSgnMCcpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzEnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIC8qCiAgICAgKiBBIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyBjcmVhdGlvbiBvZiBjdXN0b20gb25jbGljayBoYW5kbGVycyB0aGF0IGFyZSBkZWZpbmVkIGFzIGFuZ3VsYXIKICAgICAqIGV4cHJlc3Npb25zIGFuZCBhcmUgY29tcGlsZWQgYW5kIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS4KICAgICAqCiAgICAgKiBFdmVudHMgdGhhdCBhcmUgaGFuZGxlZCB2aWEgdGhlc2UgaGFuZGxlciBhcmUgYWx3YXlzIGNvbmZpZ3VyZWQgbm90IHRvIHByb3BhZ2F0ZSBmdXJ0aGVyLgogICAgICovCiAgICB2YXIgbmdFdmVudERpcmVjdGl2ZXMgPSB7fTsKICAgIGZvckVhY2goCiAgICAgICAgJ2NsaWNrIGRibGNsaWNrIG1vdXNlZG93biBtb3VzZXVwIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZW1vdmUgbW91c2VlbnRlciBtb3VzZWxlYXZlJy5zcGxpdCgnICcpLAogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgbmFtZSk7CiAgICAgICAgICAgIG5nRXZlbnREaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZChsb3dlcmNhc2UobmFtZSksIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6IGV2ZW50fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfV07CiAgICAgICAgfQogICAgKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0RibGNsaWNrCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nRGJsY2xpY2tgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGRibGNsaWNrIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0RibGNsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGRibGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2Vkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWRvd24uIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZXVwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2V1cC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VvdmVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW92ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VvdmVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlb3Zlci4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlZW50ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZW50ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VlbnRlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWVudGVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VsZWF2ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlbGVhdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW1vdmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbW92ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW1vdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2Vtb3ZlLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3VibWl0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAgICAgKgogICAgICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICAgICAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgJHNjb3BlLnN1Ym1pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy50ZXh0KSB7CiAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICB0aGlzLnRleHQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idGV4dCIgbmFtZT0idGV4dCIgLz4KICAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiBpZD0ic3VibWl0IiB2YWx1ZT0iU3VibWl0IiAvPgogICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbXScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICAgIGV4cGVjdChpbnB1dCgndGV4dCcpLnZhbCgpKS50b0JlKCcnKTsKICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbImhlbGxvIl0nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1N1Ym1pdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICBlbGVtZW50LmJpbmQoJ3N1Ym1pdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGF0dHJzLm5nU3VibWl0KTsKICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQHJlc3RyaWN0IEVDQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmV0Y2hlcywgY29tcGlsZXMgYW5kIGluY2x1ZGVzIGFuIGV4dGVybmFsIEhUTUwgZnJhZ21lbnQuCiAgICAgKgogICAgICogS2VlcCBpbiBtaW5kIHRoYXQgU2FtZSBPcmlnaW4gUG9saWN5IGFwcGxpZXMgdG8gaW5jbHVkZWQgcmVzb3VyY2VzCiAgICAgKiAoZS5nLiBuZ0luY2x1ZGUgd29uJ3Qgd29yayBmb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzIG9uIGFsbCBicm93c2VycyBhbmQgZm9yCiAgICAgKiAgZmlsZTovLyBhY2Nlc3Mgb24gc29tZSBicm93c2VycykuCiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nSW5jbHVkZXxzcmMgYW5ndWxhciBleHByZXNzaW9uIGV2YWx1YXRpbmcgdG8gVVJMLiBJZiB0aGUgc291cmNlIGlzIGEgc3RyaW5nIGNvbnN0YW50LAogICAgICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBuZXcgcGFydGlhbCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICAgICAqICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbH0gdG8gc2Nyb2xsIHRoZSB2aWV3cG9ydCBhZnRlciB0aGUgY29udGVudCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gSWYgdGhlIGF0dHJpYnV0ZSBpcyBzZXQgd2l0aG91dCB2YWx1ZSwgZW5hYmxlIHNjcm9sbGluZy4KICAgICAqICAgICAgICAgICAgICAgICAgLSBPdGhlcndpc2UgZW5hYmxlIHNjcm9sbGluZyBvbmx5IGlmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnV0aHkgdmFsdWUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICB1cmwgb2YgdGhlIHRlbXBsYXRlOiA8dHQ+e3t0ZW1wbGF0ZS51cmx9fTwvdHQ+CiAgICAgPGhyLz4KICAgICA8ZGl2IG5nLWluY2x1ZGUgc3JjPSJ0ZW1wbGF0ZS51cmwiPjwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICBbIHsgbmFtZTogJ3RlbXBsYXRlMS5odG1sJywgdXJsOiAndGVtcGxhdGUxLmh0bWwnfQogICAgICAgICAgLCB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMS5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMi5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUxLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMS5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgc2VsZWN0KCd0ZW1wbGF0ZScpLm9wdGlvbignMScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkuCiAgICAgICAgIHRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwvKTsKICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gYmxhbmsnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJycpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkudG9FcXVhbCgnJyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50TG9hZGVkCiAgICAgKiBAZXZlbnRPZiBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlCiAgICAgKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIGN1cnJlbnQgbmdJbmNsdWRlIHNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVsb2FkZWQuCiAgICAgKi8KICAgIHZhciBuZ0luY2x1ZGVEaXJlY3RpdmUgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRhbmNob3JTY3JvbGwnLCAnJGNvbXBpbGUnLAogICAgICAgIGZ1bmN0aW9uICgkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsZWFyQ29udGVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goc3JjRXhwLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTY29wZSkgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShjaGlsZFNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgKCFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkID09PSBjaGFuZ2VDb3VudGVyKSBjbGVhckNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbml0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSW5pdGAgZGlyZWN0aXZlIHNwZWNpZmllcyBpbml0aWFsaXphdGlvbiB0YXNrcyB0byBiZSBleGVjdXRlZAogICAgICogIGJlZm9yZSB0aGUgdGVtcGxhdGUgZW50ZXJzIGV4ZWN1dGlvbiBtb2RlIGR1cmluZyBib290c3RyYXAuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSW5pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZ3JlZXRpbmc9J0hlbGxvJzsgcGVyc29uPSdXb3JsZCciPgogICAgIHt7Z3JlZXRpbmd9fSB7e3BlcnNvbn19IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgZ3JlZXRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2dyZWV0aW5nJykpLnRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZXJzb24nKSkudG9CZSgnV29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICAgICAqIGJ5IGFuZ3VsYXIuIFVzZSBgbmdOb25CaW5kYWJsZWAgdG8gbWFrZSBhbmd1bGFyIGlnbm9yZSBhIGNodW5rIG9mIEhUTUwuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICAgICAqIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgIDxkaXYgbmctbm9uLWJpbmRhYmxlPklnbm9yZWQ6IHt7MSArIDJ9fTwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctbm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCcxICsgMicpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCdkaXY6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgdG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsgdGVybWluYWw6IHRydWUsIHByaW9yaXR5OiAxMDAwIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUGx1cmFsaXplCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICMgT3ZlcnZpZXcKICAgICAqIGBuZ1BsdXJhbGl6ZWAgaXMgYSBkaXJlY3RpdmUgdGhhdCBkaXNwbGF5cyBtZXNzYWdlcyBhY2NvcmRpbmcgdG8gZW4tVVMgbG9jYWxpemF0aW9uIHJ1bGVzLgogICAgICogVGhlc2UgcnVsZXMgYXJlIGJ1bmRsZWQgd2l0aCBhbmd1bGFyLmpzIGFuZCB0aGUgcnVsZXMgY2FuIGJlIG92ZXJyaWRkZW4KICAgICAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogICAgICogYnkgc3BlY2lmeWluZyB0aGUgbWFwcGluZ3MgYmV0d2VlbgogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogICAgICogcGx1cmFsIGNhdGVnb3JpZXN9IGFuZCB0aGUgc3RyaW5ncyB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKgogICAgICogIyBQbHVyYWwgY2F0ZWdvcmllcyBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzCiAgICAgKiBUaGVyZSBhcmUgdHdvCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllc30gaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBXaGlsZSBhIHB1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBZb3Ugd2lsbCBzZWUgdGhlIHVzZSBvZiBwbHVyYWwgY2F0ZWdvcmllcwogICAgICogYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcyB0aHJvdWdob3V0IGxhdGVyIHBhcnRzIG9mIHRoaXMgZG9jdW1lbnRhdGlvbi4KICAgICAqCiAgICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplCiAgICAgKiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGJ5IHByb3ZpZGluZyAyIGF0dHJpYnV0ZXM6IGBjb3VudGAgYW5kIGB3aGVuYC4KICAgICAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGF0dHJpYnV0ZSwgYG9mZnNldGAuCiAgICAgKgogICAgICogVGhlIHZhbHVlIG9mIHRoZSBgY291bnRgIGF0dHJpYnV0ZSBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uCiAgICAgKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICAgKgogICAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdCBzbyB0aGF0IEFuZ3VsYXIKICAgICAqIGNhbiBpbnRlcnByZXQgaXQgY29ycmVjdGx5LgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY29uZmlndXJlIG5nUGx1cmFsaXplOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICogPC9uZy1wbHVyYWxpemU+CiAgICAgKjwvcHJlPgogICAgICoKICAgICAqIEluIHRoZSBleGFtcGxlLCBgIjA6IE5vYm9keSBpcyB2aWV3aW5nLiJgIGlzIGFuIGV4cGxpY2l0IG51bWJlciBydWxlLiBJZiB5b3UgZGlkIG5vdAogICAgICogc3BlY2lmeSB0aGlzIHJ1bGUsIDAgd291bGQgYmUgbWF0Y2hlZCB0byB0aGUgIm90aGVyIiBjYXRlZ29yeSBhbmQgIjAgcGVvcGxlIGFyZSB2aWV3aW5nIgogICAgICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAgICAgKiBvdGhlciBudW1iZXJzLCBmb3IgZXhhbXBsZSAxMiwgc28gdGhhdCBpbnN0ZWFkIG9mIHNob3dpbmcgIjEyIHBlb3BsZSBhcmUgdmlld2luZyIsIHlvdSBjYW4KICAgICAqIHNob3cgImEgZG96ZW4gcGVvcGxlIGFyZSB2aWV3aW5nIi4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBhIHNldCBvZiBjbG9zZWQgYnJhY2VzKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogICAgICogaW50byBwbHVyYWxpemVkIHN0cmluZ3MuIEluIHRoZSBwcmV2aW91cyBleGFtcGxlLCBBbmd1bGFyIHdpbGwgcmVwbGFjZSBge31gIHdpdGgKICAgICAqIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT5ge3twZXJzb25Db3VudH19YDwvc3Bhbj4uIFRoZSBjbG9zZWQgYnJhY2VzIGB7fWAgaXMgYSBwbGFjZWhvbGRlcgogICAgICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZSB3aXRoIG9mZnNldAogICAgICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogICAgICogYSBiZXR0ZXIgdXNlciBleHBlcmllbmNlLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiB0aGUgbWVzc2FnZSAiNCBwZW9wbGUgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIsCiAgICAgKiB5b3UgbWlnaHQgZGlzcGxheSAiSm9obiwgS2F0ZSBhbmQgMiBvdGhlcnMgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIuCiAgICAgKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICAgICAqIExldCdzIHRha2UgYSBsb29rIGF0IGFuIGV4YW1wbGU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAgICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICAgKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAgICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAgICogaXMgc2hvd24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICAgKiBudW1iZXJzIGZyb20gMCB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBvZmZzZXQuIElmIHlvdSB1c2UgYW4gb2Zmc2V0IG9mIDMsIGZvciBleGFtcGxlLAogICAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZGVkIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvZGluZyBzdHJpbmdzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAkc2NvcGUucGVyc29uQ291bnQgPSAxOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgUGVyc29uIDE6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24xIiB2YWx1ZT0iSWdvciIgLz48YnIvPgogICAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgICAgTnVtYmVyIG9mIFBlb3BsZTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbkNvdW50IiB2YWx1ZT0iMSIgLz48YnIvPgoKICAgICA8IS0tLSBFeGFtcGxlIHdpdGggc2ltcGxlIHBsdXJhbGl6YXRpb24gcnVsZXMgZm9yIGVuIGxvY2FsZSAtLS0+CiAgICAgV2l0aG91dCBPZmZzZXQ6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPjxicj4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIG9mZnNldCAtLS0+CiAgICAgV2l0aCBPZmZzZXQoMik6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgc2hvdyBjb3JyZWN0IHBsdXJhbGl6ZWQgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignMCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzMnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHNob3cgZGF0YS1iaW5kZWQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uMScpLmVudGVyKCdEaScpOwogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjInKS5lbnRlcignVm9qdGEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgdG9CZSgnRGksIFZvanRhIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBCUkFDRSA9IC97fS9nOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJFeHAgPSBhdHRyLmNvdW50LAogICAgICAgICAgICAgICAgICAgIHdoZW5FeHAgPSBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci53aGVuKSwgLy8gdGhpcyBpcyBiZWNhdXNlIHdlIGhhdmUge3t9fSBpbiBhdHRycwogICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGF0dHIub2Zmc2V0IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgd2hlbnMgPSBzY29wZS4kZXZhbCh3aGVuRXhwKSwKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZucyA9IHt9LAogICAgICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpOwoKICAgICAgICAgICAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgICAgICAgICAgICAgJGludGVycG9sYXRlKGV4cHJlc3Npb24ucmVwbGFjZShCUkFDRSwgc3RhcnRTeW1ib2wgKyBudW1iZXJFeHAgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICAgICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAgICoKICAgICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAgICoKICAgICAqICAgKiBgJGluZGV4YCDigJMgYHtudW1iZXJ9YCDigJMgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkKICAgICAqICAgKiBgJGZpcnN0YCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbWlkZGxlYCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbGFzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFR3bwogICAgICogICBmb3JtYXRzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOgogICAgICoKICAgICAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgaXMgYSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAgICAgKgogICAgICogICAgIEZvciBleGFtcGxlOiBgdHJhY2sgaW4gY2QudHJhY2tzYC4KICAgICAqCiAgICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICAgKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBpbml0aWFsaXplcyB0aGUgc2NvcGUgdG8gYSBsaXN0IG9mIG5hbWVzIGFuZAogICAgICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIGFnZToyNX0sIHtuYW1lOidNYXJ5JywgYWdlOjI4fV0iPgogICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXJlcGVhdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIHZhciByID0gdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykucmVwZWF0ZXIoJ3VsIGxpJyk7CiAgICAgICAgICAgZXhwZWN0KHIuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMCkpLnRvRXF1YWwoWyIxIiwiSm9obiIsIjI1Il0pOwogICAgICAgICAgIGV4cGVjdChyLnJvdygxKSkudG9FcXVhbChbIjIiLCJNYXJ5IiwiMjgiXSk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBpdGVyU3RhcnRFbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IGF0dHIubmdSZXBlYXQ7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKC9eXHMqKC4rKVxzK2luXHMrKC4qKVxzKiQvKSwKICAgICAgICAgICAgICAgICAgICBsaHMsIHJocywgdmFsdWVJZGVudCwga2V5SWRlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIG5nUmVwZWF0IGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uICsgIicuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaHMgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgbWF0Y2ggPSBsaHMubWF0Y2goL14oPzooW1wkXHddKyl8XCgoW1wkXHddKylccyosXHMqKFtcJFx3XSspXCkpJC8pOwogICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCInaXRlbScgaW4gJ2l0ZW0gaW4gY29sbGVjdGlvbicgc2hvdWxkIGJlIGlkZW50aWZpZXIgb3IgKGtleSwgdmFsdWUpIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBsaHMgKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlSWRlbnQgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIGtleUlkZW50ID0gbWF0Y2hbMl07CgogICAgICAgICAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAgICAgICAgIC8vIGl0ZXJhdG9yLCBhbmQgdGhlIHZhbHVlIGlzIGFuIGFycmF5IG9mIG9iamVjdHMgd2l0aCBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgICAgICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAgICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgICAgICAgICAgLy8gICAtIGluZGV4OiBwb3NpdGlvbgogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCBhbiBhcnJheSBvZiB0aGVzZSBvYmplY3RzIHNpbmNlIHRoZSBzYW1lIG9iamVjdCBjYW4gYmUgcmV0dXJuZWQgZnJvbSB0aGUgaXRlcmF0b3IuCiAgICAgICAgICAgICAgICAvLyBXZSBleHBlY3QgdGhpcyB0byBiZSBhIHJhcmUgY2FzZS4KICAgICAgICAgICAgICAgIHZhciBsYXN0T3JkZXIgPSBuZXcgSGFzaFF1ZXVlTWFwKCk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUmVwZWF0V2F0Y2goc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXgsIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHNjb3BlLiRldmFsKHJocyksCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGl0ZXJTdGFydEVsZW1lbnQsICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgICAgICAgLy8gU2FtZSBhcyBsYXN0T3JkZXIgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdE9yZGVyIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyID0gbmV3IEhhc2hRdWV1ZU1hcCgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCAvLyBrZXkvdmFsdWUgb2YgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0OyAgICAgICAvLyBsYXN0IG9iamVjdCBpbmZvcm1hdGlvbiB7c2NvcGUsIGVsZW1lbnQsIGluZGV4fQoKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG9iamVjdCwgZXh0cmFjdCBrZXlzLCBzb3J0IHRoZW0gYW5kIHVzZSB0byBkZXRlcm1pbmUgb3JkZXIgb2YgaXRlcmF0aW9uIG92ZXIgb2JqIHByb3BzCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkuc29ydCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gY29sbGVjdGlvbiB8fCBbXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGFycmF5Qm91bmQgPSBhcnJheS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgbm90IHVzaW5nIGZvckVhY2ggZm9yIHBlcmYgcmVhc29ucyAodHJ5aW5nIHRvIGF2b2lkICNjYWxsKQogICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBhcnJheSkgPyBpbmRleCA6IGFycmF5W2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gbGFzdE9yZGVyLnNoaWZ0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzb2NpYXRlZCBzY29wZS9lbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbGFzdC5zY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlci5wdXNoKHZhbHVlLCBsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IGxhc3QuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleGlzdGluZyBpdGVtIHdoaWNoIGdvdCBtb3ZlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1heSBiZSBhIG5vb3AsIGlmIHRoZSBlbGVtZW50IGlzIG5leHQsIGJ1dCBJIGRvbid0IGtub3cgb2YgYSBnb29kIHdheSB0bwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpZ3VyZSB0aGlzIG91dCwgIHNpbmNlIGl0IHdvdWxkIHJlcXVpcmUgZXh0cmEgRE9NIGFjY2Vzcywgc28gbGV0J3MganVzdCBob3BlIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgYnJvd3NlcnMgcmVhbGl6ZXMgdGhhdCBpdCBpcyBub29wLCBhbmQgdHJlYXRzIGl0IGFzIHN1Y2guCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmFmdGVyKGxhc3QuZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmV3IGl0ZW0gd2hpY2ggd2UgZG9uJ3Qga25vdyBhYm91dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnQpIGNoaWxkU2NvcGVba2V5SWRlbnRdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRpbmRleCA9IGluZGV4OwoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSBhcnJheUJvdW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kbWlkZGxlID0gIShjaGlsZFNjb3BlLiRmaXJzdCB8fCBjaGlsZFNjb3BlLiRsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua2VyKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGNoaWxkU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IChjdXJzb3IgPSBjbG9uZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vc2hyaW5rIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbGFzdE9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0T3JkZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBsYXN0T3JkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChhcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFycmF5LnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGFzdE9yZGVyID0gbmV4dE9yZGVyOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTaG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGRpcmVjdGl2ZXMgc2hvdyBvciBoaWRlIGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Nob3cgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeQogICAgICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPiA8YnIvPgogICAgIEhpZGU6IDxzcGFuIG5nLWhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwoKICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KLy9UT0RPKG1pc2tvKTogcmVmYWN0b3IgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSB0aGUgRE9NCiAgICB2YXIgbmdTaG93RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICBlbGVtZW50LmNzcygnZGlzcGxheScsIHRvQm9vbGVhbih2YWx1ZSkgPyAnJyA6ICdub25lJyk7CiAgICAgICAgfSk7CiAgICB9KTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIaWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSGlkZWAgYW5kIGBuZ1Nob3dgIGRpcmVjdGl2ZXMgaGlkZSBvciBzaG93IGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICAgKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+IDxici8+CiAgICAgSGlkZTogPHNwYW4gbmctaGlkZT0iY2hlY2tlZCI+SSBoaWRlIHdoZW4geW91IGNoZWNrYm94IGlzIGNoZWNrZWQ/PC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCi8vVE9ETyhtaXNrbyk6IHJlZmFjdG9yIHRvIHJlbW92ZSBlbGVtZW50IGZyb20gdGhlIERPTQogICAgdmFyIG5nSGlkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odmFsdWUpID8gJ25vbmUnIDogJycpOwogICAgICAgIH0pOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTdHlsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAgICAgKiAgICAgIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogICAgICogICAgICBrZXlzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlTdHlsZT17fSI+CiAgICAgPGJyLz4KICAgICA8c3BhbiBuZy1zdHlsZT0ibXlTdHlsZSI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPHByZT5teVN0eWxlPXt7bXlTdHlsZX19PC9wcmU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigwLCAwLCAwKScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPXNldF0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDI1NSwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1jbGVhcl0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdTdHlsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU3R5bGUsIGZ1bmN0aW9uIG5nU3R5bGVXYXRjaEFjdGlvbihuZXdTdHlsZXMsIG9sZFN0eWxlcykgewogICAgICAgICAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gob2xkU3R5bGVzLCBmdW5jdGlvbiAodmFsLCBzdHlsZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY3NzKHN0eWxlLCAnJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3U3R5bGVzKSBlbGVtZW50LmNzcyhuZXdTdHlsZXMpOwogICAgICAgIH0sIHRydWUpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29uZGl0aW9uYWxseSBjaGFuZ2UgdGhlIERPTSBzdHJ1Y3R1cmUuCiAgICAgKgogICAgICogQHVzYWdlCiAgICAgKiA8QU5ZIG5nLXN3aXRjaD0iZXhwcmVzc2lvbiI+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTIiPi4uLjwvQU5ZPgogICAgICogICAuLi4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgICAqIDwvQU5ZPgogICAgICoKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAgICAgKiBAcGFyYW1EZXNjcmlwdGlvbgogICAgICogT24gY2hpbGQgZWxtZW50cyBhZGQ6CiAgICAgKgogICAgICogKiBgbmdTd2l0Y2hXaGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogICAgICogICBjYXNlIHdpbGwgYmUgZGlzcGxheWVkLgogICAgICogKiBgbmdTd2l0Y2hEZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc3NlcyBtYXRjaC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0ic2VsZWN0aW9uIiBuZy1vcHRpb25zPSJpdGVtIGZvciBpdGVtIGluIGl0ZW1zIj4KICAgICA8L3NlbGVjdD4KICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1zd2l0Y2ggb249InNlbGVjdGlvbiIgPgogICAgIDxkaXYgbmctc3dpdGNoLXdoZW49InNldHRpbmdzIj5TZXR0aW5ncyBEaXY8L2Rpdj4KICAgICA8c3BhbiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9zcGFuPgogICAgIDxzcGFuIG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L3NwYW4+CiAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ2hvbWUnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHNlbGVjdCBkZWFmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIE5HX1NXSVRDSCA9ICduZy1zd2l0Y2gnOwogICAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgICAgcmVxdWlyZTogJ25nU3dpdGNoJywKICAgICAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsIGZ1bmN0aW9uIG5nU3dpdGNoQ29udHJvbGxlcigpIHsKICAgICAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICAgIH1dLAogICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICB2YXIgd2F0Y2hFeHByID0gYXR0ci5uZ1N3aXRjaCB8fCBhdHRyLm9uLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LAogICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZTsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaEV4cHIsIGZ1bmN0aW9uIG5nU3dpdGNoV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCA9IHNlbGVjdGVkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGUgPSBjdHJsLmNhc2VzWychJyArIHZhbHVlXSB8fCBjdHJsLmNhc2VzWyc/J10pKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uIChjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBjYXNlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRycywgdHJhbnNjbHVkZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gPSB0cmFuc2NsdWRlOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiA1MDAsCiAgICAgICAgcmVxdWlyZTogJ15uZ1N3aXRjaCcsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGN0cmwuY2FzZXNbJz8nXSA9IHRyYW5zY2x1ZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnNlcnQgdGhlIHRyYW5zY2x1ZGVkIERPTSBoZXJlLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0idHJhbnNjbHVkZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnTmVxdWUgcG9ycm8gcXVpc3F1YW0gZXN0IHF1aSBkb2xvcmVtIGlwc3VtIHF1aWEgZG9sb3IuLi4nOwogICAgICAgICB9CgogICAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlJywgW10pCiAgICAgLmRpcmVjdGl2ZSgncGFuZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgICAgICBzY29wZTogJ2lzb2xhdGUnLAogICAgICAgICAgICAgICBsb2NhbHM6IHsgdGl0bGU6J2JpbmQnIH0sCiAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGdyYXkiPnt7dGl0bGV9fTwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgIH07CiAgICAgICAgIH0pOwogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICA8cGFuZSB0aXRsZT0ie3t0aXRsZX19Ij57e3RleHR9fTwvcGFuZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGhhdmUgdHJhbnNjbHVkZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd0aXRsZScpLmVudGVyKCdUSVRMRScpOwogICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignVEVYVCcpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RpdGxlJykpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29udHJvbGxlcjogWyckdHJhbnNjbHVkZScsICckZWxlbWVudCcsIGZ1bmN0aW9uICgkdHJhbnNjbHVkZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHRyYW5zY2x1ZGUoZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3CiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdWaWV3YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGNvbXBsZW1lbnRzIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZSBieQogICAgICogaW5jbHVkaW5nIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvZiB0aGUgY3VycmVudCByb3V0ZSBpbnRvIHRoZSBtYWluIGxheW91dCAoYGluZGV4Lmh0bWxgKSBmaWxlLgogICAgICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogICAgICogY29uZmlndXJhdGlvbiBvZiB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgIENob29zZToKICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgIDxociAvPgoKICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdib29rLmh0bWwnLAogICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bAogICAgICAgICAgfSk7CiAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQ2hhcHRlckNudGwKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpOwogICAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAkc2NvcGUuJGxvY2F0aW9uID0gJGxvY2F0aW9uOwogICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJCb29rQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KCiAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCdhOmNvbnRhaW5zKCJNb2J5OiBDaDEiKScpLmNsaWNrKCk7CiAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9Cb29rIElkXDogTW9ieS8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3IyR2aWV3Q29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nVmlldyBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nVmlldyBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdWaWV3RGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcm91dGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsCiAgICAgICAgJyRjb250cm9sbGVyJywKICAgICAgICBmdW5jdGlvbiAoJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcm91dGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlLCAkY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJzsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJG9uKCckcm91dGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUoKTsKCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lMYXN0U2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0U2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJDb250ZW50KCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95TGFzdFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSAkcm91dGUuY3VycmVudCAmJiAkcm91dGUuY3VycmVudC5sb2NhbHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGxvY2FscyAmJiBsb2NhbHMuJHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdHJveUxhc3RTY29wZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gJHJvdXRlLmN1cnJlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUgPSBjdXJyZW50LnNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGUgPSBsYXN0U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGN1cnJlbnQuY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxhc3RTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGVtaXQoJyR2aWV3Q29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gJGFuY2hvclNjcm9sbCBtaWdodCBsaXN0ZW4gb24gZXZlbnQuLi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNjcmlwdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTG9hZCBjb250ZW50IG9mIGEgc2NyaXB0IHRhZywgd2l0aCB0eXBlIGB0ZXh0L25nLXRlbXBsYXRlYCwgaW50byBgJHRlbXBsYXRlQ2FjaGVgLCBzbyB0aGF0IHRoZQogICAgICogdGVtcGxhdGUgY2FuIGJlIHVzZWQgYnkgYG5nSW5jbHVkZWAsIGBuZ1ZpZXdgIG9yIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogQHJlc3RyaWN0IEUKICAgICAqIEBwYXJhbSB7J3RleHQvbmctdGVtcGxhdGUnfSB0eXBlIG11c3QgYmUgc2V0IHRvIGAndGV4dC9uZy10ZW1wbGF0ZSdgCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0iL3RwbC5odG1sIj4KICAgICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgICA8L3NjcmlwdD4KCiAgICAgPGEgbmctY2xpY2s9ImN1cnJlbnRUcGw9Jy90cGwuaHRtbCciIGlkPSJ0cGwtbGluayI+TG9hZCBpbmxpbmVkIHRlbXBsYXRlPC9hPgogICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KCcjdHBsLWxpbmsnKS5jbGljaygpOwogICAgICAgIGV4cGVjdChlbGVtZW50KCcjdHBsLWNvbnRlbnQnKS50ZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24gKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2VsZWN0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogIyBgbmdPcHRpb25zYAogICAgICoKICAgICAqIE9wdGlvbmFsbHkgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAgICAgKiBlbGVtZW50cyBmb3IgYSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgYW4gYXJyYXkgb3IgYW4gb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICAgKiBgbmdPcHRpb25zYCBleHByZXNzaW9uLgogICAgICrLncudCiAgICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIHNlbGVjdCBtZW51IGlzIHNlbGVjdCwgdGhlIHZhbHVlIG9mIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICAgKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogICAgICogZGlyZWN0aXZlIG9mIHRoZSBwYXJlbnQgc2VsZWN0IGVsZW1lbnQuCiAgICAgKgogICAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAgICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAgICoKICAgICAqIE5vdGU6IGBuZ09wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogICAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBjdXJyZW50bHkKICAgICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgb25seS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICAgICAqCiAgICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICAgKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqCiAgICAgKiBXaGVyZToKICAgICAqCiAgICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAgICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAgICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICAgKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogICAgICogICAgICBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIE15Q250cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgJHNjb3BlLmNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbG9yIGluIGNvbG9ycyI+CiAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnNwbGljZSgkaW5kZXgsIDEpIj5YPC9hPl0KICAgICA8L2xpPgogICAgIDxsaT4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8aHIvPgogICAgIENvbG9yIChudWxsIG5vdCBhbGxvd2VkKToKICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+PC9zZWxlY3Q+PGJyPgoKICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDwvc3Bhbj48YnIvPgoKICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZ3JvdXAgYnkgYy5zaGFkZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICBTZWxlY3QgPGEgaHJlZiBuZy1jbGljaz0iY29sb3I9e25hbWU6J25vdCBpbiBsaXN0J30iPmJvZ3VzPC9hPi48YnI+CiAgICAgPGhyLz4KICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpjb2xvcn0gIH19CiAgICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgICAgbmctc3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6Y29sb3IubmFtZX0iPgogICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIHNlbGVjdCgnY29sb3InKS5vcHRpb24oJzAnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdudWxsJyk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICB2YXIgbmdPcHRpb25zRGlyZWN0aXZlID0gdmFsdWVGbih7IHRlcm1pbmFsOiB0cnVlIH0pOwogICAgdmFyIHNlbGVjdERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCAnJHBhcnNlJywgZnVuY3Rpb24gKCRjb21waWxlLCAkcGFyc2UpIHsKICAgICAgICAvLzAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3NzAKICAgICAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKiguKj8pKD86XHMrYXNccysoLio/KSk/KD86XHMrZ3JvdXBccytieVxzKyguKikpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd1xkXSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XGRdKilccyosXHMqKFtcJFx3XVtcJFx3XGRdKilccypcKSkpXHMraW5ccysoLiopJC8sCiAgICAgICAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uICgkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICAgICAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgICAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgICAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAgICAgICAgIC8vIHRvIGNyZWF0ZSBpdCBpbiA8c2VsZWN0PiBhbmQgSUUgYmFyZnMgb3RoZXJ3aXNlLgogICAgICAgICAgICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgICAgICAgICAgICBvcHRHcm91cFRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgIC8vIGZpbmQgIm51bGwiIG9wdGlvbgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpLCBpaSA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW1wdHlPcHRpb24gPSBudWxsT3B0aW9uID0gY2hpbGRyZW4uZXEoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlICYmIChhdHRyLnJlcXVpcmVkIHx8IGF0dHIubmdSZXF1aXJlZCkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZWRWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsICFhdHRyLnJlcXVpcmVkIHx8ICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRwYXJzZXJzLnB1c2gocmVxdWlyZWRWYWxpZGF0b3IpOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRmb3JtYXR0ZXJzLnVuc2hpZnQocmVxdWlyZWRWYWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRWYWxpZGF0b3IobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNFeHApIE9wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlKSBNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFZpZXc7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHNlbGVjdE11bHRpcGxlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKGxhc3RWaWV3LCBjdHJsLiR2aWV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmlldyA9IGNvcHkoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYmluZCgnY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2gob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE9wdGlvbnMoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgICAgICAgICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIG5nT3B0aW9ucyBpbiBmb3JtIG9mICdfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCBnb3QgJyIgKyBvcHRpb25zRXhwICsgIicuIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6ICcnfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuaHRtbCgnJykgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGxhYmVsIGZyb20gdGhlIGVsZW1lbnQuIHd0Zj8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gcmVuZGVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogY2FuJ3Qgd2Ugb3B0aW1pemUgdGhpcyA/CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHJlbmRlcik7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbkdyb3VwcyA9IHsnJzogW119LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IHZhbHVlc1trZXlOYW1lID8gbG9jYWxzW2tleU5hbWVdID0ga2V5c1tpbmRleF0gOiBpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWRTZXQucmVtb3ZlKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4LCAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6ICcnLCBsYWJlbDogJycsIHNlbGVjdGVkOiAhc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDogJz8nLCBsYWJlbDogJycsIHNlbGVjdGVkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uR3JvdXBbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZXhpc3RpbmdPcHRpb24gPSBleGlzdGluZ09wdGlvbnNbaW5kZXggKyAxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdPcHRpb25zLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnBvcCgpLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUR1JPVVBzIGZyb20gc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wb3AoKVswXS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIG9wdGlvbkRpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgICAgICAgICAgYWRkT3B0aW9uOiBub29wLAogICAgICAgICAgICByZW1vdmVPcHRpb246IG5vb3AKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC50ZXh0KCksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgZWxlbWVudC50ZXh0KCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIHN0eWxlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0ZXJtaW5hbDogdHJ1ZQogICAgfSk7CgogICAgLyoqCiAgICAgKiBTZXR1cCBmaWxlIGZvciB0aGUgU2NlbmFyaW8uCiAgICAgKiBNdXN0IGJlIGZpcnN0IGluIHRoZSBjb21waWxhdGlvbi9ib290c3RyYXAgbGlzdC4KICAgICAqLwoKLy8gUHVibGljIG5hbWVzcGFjZQogICAgYW5ndWxhci5zY2VuYXJpbyA9IGFuZ3VsYXIuc2NlbmFyaW8gfHwge307CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgbmV3IG91dHB1dCBmb3JtYXQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIG5ldyBvdXRwdXQgZm9ybWF0CiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIGZ1bmN0aW9uKGNvbnRleHQsIHJ1bm5lcikgdGhhdCBnZW5lcmF0ZXMgdGhlIG91dHB1dAogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCA9IGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0IHx8IGZ1bmN0aW9uIChuYW1lLCBmbikgewogICAgICAgIGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0W25hbWVdID0gZm47CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIG5ldyBEU0wgc3RhdGVtZW50LiBJZiB5b3VyIGZhY3RvcnkgZnVuY3Rpb24gcmV0dXJucyBhIEZ1dHVyZQogICAgICogaXQncyByZXR1cm5lZCwgb3RoZXJ3aXNlIHRoZSByZXN1bHQgaXMgYXNzdW1lZCB0byBiZSBhIG1hcCBvZiBmdW5jdGlvbnMKICAgICAqIGZvciBjaGFpbmluZy4gQ2hhaW5lZCBmdW5jdGlvbnMgYXJlIHN1YmplY3QgdG8gdGhlIHNhbWUgcnVsZXMuCiAgICAgKgogICAgICogTm90ZTogQWxsIGZ1bmN0aW9ucyBvbiB0aGUgY2hhaW4gYXJlIGJvdW5kIHRvIHRoZSBjaGFpbiBzY29wZSBzbyB2YWx1ZXMKICAgICAqICAgc2V0IG9uICJ0aGlzIiBpbiB5b3VyIHN0YXRlbWVudCBmdW5jdGlvbiBhcmUgYXZhaWxhYmxlIGluIHRoZSBjaGFpbmVkCiAgICAgKiAgIGZ1bmN0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc3RhdGVtZW50CiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZhY3RvcnkgZnVuY3Rpb24oKSwgcmV0dXJuIGEgZnVuY3Rpb24gZm9yCiAgICAgKiAgdGhlIHN0YXRlbWVudC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2wgPSBhbmd1bGFyLnNjZW5hcmlvLmRzbCB8fCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgICAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbFtuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVN0YXRlbWVudChzdGF0ZW1lbnQsIGFyZ3MpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBzdGF0ZW1lbnQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHJlc3VsdCkgfHwgcmVzdWx0IGluc3RhbmNlb2YgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgIHZhciBjaGFpbiA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCByZXN1bHQpOwogICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGNoYWluLCBmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFpbltuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleGVjdXRlU3RhdGVtZW50LmNhbGwoc2VsZiwgdmFsdWUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW5bbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVN0YXRlbWVudC5jYWxsKHRoaXMsIHN0YXRlbWVudCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBuZXcgbWF0Y2hlciBmb3IgdXNlIHdpdGggdGhlIGV4cGVjdHMoKSBzdGF0ZW1lbnQuIFRoZSB2YWx1ZQogICAgICogdGhpcy5hY3R1YWwgKGxpa2UgaW4gSmFzbWluZSkgaXMgYXZhaWxhYmxlIGluIHlvdXIgbWF0Y2hlciB0byBjb21wYXJlCiAgICAgKiBhZ2FpbnN0LiBZb3VyIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYSBib29sZWFuLiBUaGUgZnV0dXJlIGlzIGF1dG9tYXRpY2FsbHkKICAgICAqIGNyZWF0ZWQgZm9yIHlvdS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWF0Y2hlcgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBUaGUgbWF0Y2hpbmcgZnVuY3Rpb24oZXhwZWN0ZWQpLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIgPSBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIgfHwgZnVuY3Rpb24gKG5hbWUsIGZuKSB7CiAgICAgICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyW25hbWVdID0gZnVuY3Rpb24gKGV4cGVjdGVkKSB7CiAgICAgICAgICAgIHZhciBwcmVmaXggPSAnZXhwZWN0ICcgKyB0aGlzLmZ1dHVyZS5uYW1lICsgJyAnOwogICAgICAgICAgICBpZiAodGhpcy5pbnZlcnNlKSB7CiAgICAgICAgICAgICAgICBwcmVmaXggKz0gJ25vdCAnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdGhpcy5hZGRGdXR1cmUocHJlZml4ICsgbmFtZSArICcgJyArIGFuZ3VsYXIudG9Kc29uKGV4cGVjdGVkKSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICAgICAgICAgIHNlbGYuYWN0dWFsID0gc2VsZi5mdXR1cmUudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKChzZWxmLmludmVyc2UgJiYgZm4uY2FsbChzZWxmLCBleHBlY3RlZCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICghc2VsZi5pbnZlcnNlICYmICFmbi5jYWxsKHNlbGYsIGV4cGVjdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSAnZXhwZWN0ZWQgJyArIGFuZ3VsYXIudG9Kc29uKGV4cGVjdGVkKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIGJ1dCB3YXMgJyArIGFuZ3VsYXIudG9Kc29uKHNlbGYuYWN0dWFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZG9uZShlcnJvcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIEluaXRpYWxpemUgdGhlIHNjZW5hcmlvIHJ1bm5lciBhbmQgcnVuICEKICAgICAqCiAgICAgKiBBY2Nlc3MgZ2xvYmFsIHdpbmRvdyBhbmQgZG9jdW1lbnQgb2JqZWN0CiAgICAgKiBBY2Nlc3MgJHJ1bm5lciB0aHJvdWdoIGNsb3N1cmUKICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBDb25maWcgb3B0aW9ucwogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuID0gZnVuY3Rpb24gKGNvbmZpZykgewogICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgdmFyIGJvZHkgPSBfalF1ZXJ5KGRvY3VtZW50LmJvZHkpOwogICAgICAgIHZhciBvdXRwdXQgPSBbXTsKICAgICAgICB2YXIgb2JqTW9kZWwgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCgkcnVubmVyKTsKCiAgICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuc2NlbmFyaW9fb3V0cHV0KSB7CiAgICAgICAgICAgIG91dHB1dCA9IGNvbmZpZy5zY2VuYXJpb19vdXRwdXQuc3BsaXQoJywnKTsKICAgICAgICB9CgogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCwgZnVuY3Rpb24gKGZuLCBuYW1lKSB7CiAgICAgICAgICAgIGlmICghb3V0cHV0Lmxlbmd0aCB8fCBpbmRleE9mKG91dHB1dCwgbmFtZSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gYm9keS5hcHBlbmQoJzxkaXY+PC9kaXY+JykuZmluZCgnZGl2Omxhc3QnKTsKICAgICAgICAgICAgICAgIGNvbnRleHQuYXR0cignaWQnLCBuYW1lKTsKICAgICAgICAgICAgICAgIGZuLmNhbGwoe30sIGNvbnRleHQsICRydW5uZXIsIG9iak1vZGVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBpZiAoIS9eaHR0cC8udGVzdChocmVmKSAmJiAhL15odHRwcy8udGVzdChocmVmKSkgewogICAgICAgICAgICBib2R5LmFwcGVuZCgnPHAgaWQ9InN5c3RlbS1lcnJvciI+PC9wPicpOwogICAgICAgICAgICBib2R5LmZpbmQoJyNzeXN0ZW0tZXJyb3InKS50ZXh0KAogICAgICAgICAgICAgICAgJ1NjZW5hcmlvIHJ1bm5lciBtdXN0IGJlIHJ1biB1c2luZyBodHRwIG9yIGh0dHBzLiBUaGUgcHJvdG9jb2wgJyArCiAgICAgICAgICAgICAgICAgICAgaHJlZi5zcGxpdCgnOicpWzBdICsgJzovLyBpcyBub3Qgc3VwcG9ydGVkLicKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGFwcEZyYW1lID0gYm9keS5hcHBlbmQoJzxkaXYgaWQ9ImFwcGxpY2F0aW9uIj48L2Rpdj4nKS5maW5kKCcjYXBwbGljYXRpb24nKTsKICAgICAgICB2YXIgYXBwbGljYXRpb24gPSBuZXcgYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbihhcHBGcmFtZSk7CgogICAgICAgICRydW5uZXIub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYXBwRnJhbWUuY3NzKCdkaXNwbGF5JywgJ25vbmUnKTsKICAgICAgICAgICAgYXBwRnJhbWUuZmluZCgnaWZyYW1lJykuYXR0cignc3JjJywgJ2Fib3V0OmJsYW5rJyk7CiAgICAgICAgfSk7CgogICAgICAgICRydW5uZXIub24oJ1J1bm5lckVycm9yJywgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgIGlmICh3aW5kb3cuY29uc29sZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZm9ybWF0RXhjZXB0aW9uKGVycm9yKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBEbyBzb21ldGhpbmcgZm9yIElFCiAgICAgICAgICAgICAgICBhbGVydChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgJHJ1bm5lci5ydW4oYXBwbGljYXRpb24pOwogICAgfTsKCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIHRocm91Z2ggbGlzdCB3aXRoIGl0ZXJhdG9yIGZ1bmN0aW9uIHRoYXQgbXVzdCBjYWxsIHRoZQogICAgICogY29udGludWVGdW5jdGlvbiB0byBjb250aW51dGUgaXRlcmF0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGxpc3QgbGlzdCB0byBpdGVyYXRlIG92ZXIKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaXRlcmF0b3IgQ2FsbGJhY2sgZnVuY3Rpb24odmFsdWUsIGNvbnRpbnVlRnVuY3Rpb24pCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRvbmUgQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkgY2FsbGVkIHdoZW4KICAgICAqICAgaXRlcmF0aW9uIGZpbmlzaGVzIG9yIGFuIGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgZnVuY3Rpb24gYXN5bmNGb3JFYWNoKGxpc3QsIGl0ZXJhdG9yLCBkb25lKSB7CiAgICAgICAgdmFyIGkgPSAwOwoKICAgICAgICBmdW5jdGlvbiBsb29wKGVycm9yLCBpbmRleCkgewogICAgICAgICAgICBpZiAoaW5kZXggJiYgaW5kZXggPiBpKSB7CiAgICAgICAgICAgICAgICBpID0gaW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVycm9yIHx8IGkgPj0gbGlzdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGRvbmUoZXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvcihsaXN0W2krK10sIGxvb3ApOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxvb3AoKTsKICAgIH0KCiAgICAvKioKICAgICAqIEZvcm1hdHMgYW4gZXhjZXB0aW9uIGludG8gYSBzdHJpbmcgd2l0aCB0aGUgc3RhY2sgdHJhY2UsIGJ1dCBsaW1pdHMKICAgICAqIHRvIGEgc3BlY2lmaWMgbGluZSBsZW5ndGguCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGVycm9yIFRoZSBleGNlcHRpb24gdG8gZm9ybWF0LCBjYW4gYmUgYW55dGhpbmcgdGhyb3dhYmxlCiAgICAgKiBAcGFyYW0ge051bWJlcj19IFttYXhTdGFja0xpbmVzPTVdIG1heCBsaW5lcyBvZiB0aGUgc3RhY2sgdHJhY2UgdG8gaW5jbHVkZQogICAgICogIGRlZmF1bHQgaXMgNS4KICAgICAqLwogICAgZnVuY3Rpb24gZm9ybWF0RXhjZXB0aW9uKGVycm9yLCBtYXhTdGFja0xpbmVzKSB7CiAgICAgICAgbWF4U3RhY2tMaW5lcyA9IG1heFN0YWNrTGluZXMgfHwgNTsKICAgICAgICB2YXIgbWVzc2FnZSA9IGVycm9yLnRvU3RyaW5nKCk7CiAgICAgICAgaWYgKGVycm9yLnN0YWNrKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9yLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgICBpZiAoc3RhY2tbMF0uaW5kZXhPZihtZXNzYWdlKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIG1heFN0YWNrTGluZXMrKzsKICAgICAgICAgICAgICAgIHN0YWNrLnVuc2hpZnQoZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWVzc2FnZSA9IHN0YWNrLnNsaWNlKDAsIG1heFN0YWNrTGluZXMpLmpvaW4oJ1xuJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgZ2V0cyB0aGUgZmlsZSBuYW1lIGFuZCBsaW5lIG51bWJlciBmcm9tIGEKICAgICAqIGxvY2F0aW9uIGluIHRoZSBzdGFjayBpZiBhdmFpbGFibGUgYmFzZWQgb24gdGhlIGNhbGwgc2l0ZS4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIHJldHVybnMgYW5vdGhlciBmdW5jdGlvbiBiZWNhdXNlIGFjY2Vzc2luZyAuc3RhY2sgaXMgdmVyeQogICAgICogZXhwZW5zaXZlIGluIENocm9tZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0IE51bWJlciBvZiBzdGFjayBsaW5lcyB0byBza2lwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbGxlckZpbGUob2Zmc2V0KSB7CiAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBsaW5lID0gKGVycm9yLnN0YWNrIHx8ICcnKS5zcGxpdCgnXG4nKVtvZmZzZXRdOwoKICAgICAgICAgICAgLy8gQ2xlYW4gdXAgdGhlIHN0YWNrIHRyYWNlIGxpbmUKICAgICAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgICAgICAgIGlmIChsaW5lLmluZGV4T2YoJ0AnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAvLyBGaXJlZm94CiAgICAgICAgICAgICAgICAgICAgbGluZSA9IGxpbmUuc3Vic3RyaW5nKGxpbmUuaW5kZXhPZignQCcpICsgMSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENocm9tZQogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN1YnN0cmluZyhsaW5lLmluZGV4T2YoJygnKSArIDEpLnJlcGxhY2UoJyknLCAnJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBsaW5lIHx8ICcnOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBUcmlnZ2VycyBhIGJyb3dzZXIgZXZlbnQuIEF0dGVtcHRzIHRvIGNob29zZSB0aGUgcmlnaHQgZXZlbnQgaWYgb25lIGlzCiAgICAgKiBub3Qgc3BlY2lmaWVkLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlbGVtZW50IEVpdGhlciBhIHdyYXBwZWQgalF1ZXJ5L2pxTGl0ZSBub2RlIG9yIGEgRE9NRWxlbWVudAogICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgT3B0aW9uYWwgZXZlbnQgdHlwZS4KICAgICAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz49fSBrZXlzIE9wdGlvbmFsIGxpc3Qgb2YgcHJlc3NlZCBrZXlzCiAgICAgKiAgICAgICAgKHZhbGlkIHZhbHVlczogJ2FsdCcsICdtZXRhJywgJ3NoaWZ0JywgJ2N0cmwnKQogICAgICovCiAgICBmdW5jdGlvbiBicm93c2VyVHJpZ2dlcihlbGVtZW50LCB0eXBlLCBrZXlzKSB7CiAgICAgICAgaWYgKGVsZW1lbnQgJiYgIWVsZW1lbnQubm9kZU5hbWUpIGVsZW1lbnQgPSBlbGVtZW50WzBdOwogICAgICAgIGlmICghZWxlbWVudCkgcmV0dXJuOwogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICB0eXBlID0gewogICAgICAgICAgICAgICAgJ3RleHQnOiAnY2hhbmdlJywKICAgICAgICAgICAgICAgICd0ZXh0YXJlYSc6ICdjaGFuZ2UnLAogICAgICAgICAgICAgICAgJ2hpZGRlbic6ICdjaGFuZ2UnLAogICAgICAgICAgICAgICAgJ3Bhc3N3b3JkJzogJ2NoYW5nZScsCiAgICAgICAgICAgICAgICAnYnV0dG9uJzogJ2NsaWNrJywKICAgICAgICAgICAgICAgICdzdWJtaXQnOiAnY2xpY2snLAogICAgICAgICAgICAgICAgJ3Jlc2V0JzogJ2NsaWNrJywKICAgICAgICAgICAgICAgICdpbWFnZSc6ICdjbGljaycsCiAgICAgICAgICAgICAgICAnY2hlY2tib3gnOiAnY2xpY2snLAogICAgICAgICAgICAgICAgJ3JhZGlvJzogJ2NsaWNrJywKICAgICAgICAgICAgICAgICdzZWxlY3Qtb25lJzogJ2NoYW5nZScsCiAgICAgICAgICAgICAgICAnc2VsZWN0LW11bHRpcGxlJzogJ2NoYW5nZScKICAgICAgICAgICAgfVtsb3dlcmNhc2UoZWxlbWVudC50eXBlKV0gfHwgJ2NsaWNrJzsKICAgICAgICB9CiAgICAgICAgaWYgKGxvd2VyY2FzZShub2RlTmFtZV8oZWxlbWVudCkpID09ICdvcHRpb24nKSB7CiAgICAgICAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS52YWx1ZSA9IGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIHR5cGUgPSAnY2hhbmdlJzsKICAgICAgICB9CgogICAgICAgIGtleXMgPSBrZXlzIHx8IFtdOwogICAgICAgIGZ1bmN0aW9uIHByZXNzZWQoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBpbmRleE9mKGtleXMsIGtleSkgIT09IC0xOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgICAgICAgIHN3aXRjaCAoZWxlbWVudC50eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdyYWRpbyc6CiAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCc6CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gIWVsZW1lbnQuY2hlY2tlZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBXVEYhISEgRXJyb3I6IFVuc3BlY2lmaWVkIGVycm9yLgogICAgICAgICAgICAvLyBEb24ndCBrbm93IHdoeSwgYnV0IHNvbWUgZWxlbWVudHMgd2hlbiBkZXRhY2hlZCBzZWVtIHRvIGJlIGluIGluY29uc2lzdGVudCBzdGF0ZSBhbmQKICAgICAgICAgICAgLy8gY2FsbGluZyAuZmlyZUV2ZW50KCkgb24gdGhlbSB3aWxsIHJlc3VsdCBpbiB2ZXJ5IHVuaGVscGZ1bCBlcnJvciAoRXJyb3I6IFVuc3BlY2lmaWVkIGVycm9yKQogICAgICAgICAgICAvLyBmb3JjaW5nIHRoZSBicm93c2VyIHRvIGNvbXB1dGUgdGhlIGVsZW1lbnQgcG9zaXRpb24gKGJ5IHJlYWRpbmcgaXRzIENTUykKICAgICAgICAgICAgLy8gcHV0cyB0aGUgZWxlbWVudCBpbiBjb25zaXN0ZW50IHN0YXRlLgogICAgICAgICAgICBlbGVtZW50LnN0eWxlLnBvc0xlZnQ7CgogICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogY3JlYXRlIGV2ZW50IG9iamVjdHMgd2l0aCBwcmVzc2VkIGtleXMgdG8gZ2V0IGl0IHdvcmtpbmcgb24gSUU8OQogICAgICAgICAgICB2YXIgcmV0ID0gZWxlbWVudC5maXJlRXZlbnQoJ29uJyArIHR5cGUpOwogICAgICAgICAgICBpZiAobG93ZXJjYXNlKGVsZW1lbnQudHlwZSkgPT0gJ3N1Ym1pdCcpIHsKICAgICAgICAgICAgICAgIHdoaWxlIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShlbGVtZW50Lm5vZGVOYW1lKSA9PSAnZm9ybScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoJ29uc3VibWl0Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGV2bnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnTW91c2VFdmVudHMnKSwKICAgICAgICAgICAgICAgIG9yaWdpbmFsUHJldmVudERlZmF1bHQgPSBldm50LnByZXZlbnREZWZhdWx0LAogICAgICAgICAgICAgICAgaWZyYW1lID0gX2pRdWVyeSgnI2FwcGxpY2F0aW9uIGlmcmFtZScpWzBdLAogICAgICAgICAgICAgICAgYXBwV2luZG93ID0gaWZyYW1lID8gaWZyYW1lLmNvbnRlbnRXaW5kb3cgOiB3aW5kb3csCiAgICAgICAgICAgICAgICBmYWtlUHJvY2Vzc0RlZmF1bHQgPSB0cnVlLAogICAgICAgICAgICAgICAgZmluYWxQcm9jZXNzRGVmYXVsdCwKICAgICAgICAgICAgICAgIGFuZ3VsYXIgPSBhcHBXaW5kb3cuYW5ndWxhciB8fCB7fTsKCiAgICAgICAgICAgIC8vIGlnb3I6IHRlbXBvcmFyeSBmaXggZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY4NDIwOAogICAgICAgICAgICBhbmd1bGFyWydmZi02ODQyMDgtcHJldmVudERlZmF1bHQnXSA9IGZhbHNlOwogICAgICAgICAgICBldm50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZmFrZVByb2Nlc3NEZWZhdWx0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxQcmV2ZW50RGVmYXVsdC5hcHBseShldm50LCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZXZudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIHByZXNzZWQoJ2N0cmwnKSwgcHJlc3NlZCgnYWx0JyksCiAgICAgICAgICAgICAgICBwcmVzc2VkKCdzaGlmdCcpLCBwcmVzc2VkKCdtZXRhJyksIDAsIGVsZW1lbnQpOwoKICAgICAgICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2bnQpOwogICAgICAgICAgICBmaW5hbFByb2Nlc3NEZWZhdWx0ID0gIShhbmd1bGFyWydmZi02ODQyMDgtcHJldmVudERlZmF1bHQnXSB8fCAhZmFrZVByb2Nlc3NEZWZhdWx0KTsKCiAgICAgICAgICAgIGRlbGV0ZSBhbmd1bGFyWydmZi02ODQyMDgtcHJldmVudERlZmF1bHQnXTsKCiAgICAgICAgICAgIHJldHVybiBmaW5hbFByb2Nlc3NEZWZhdWx0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERvbid0IHVzZSB0aGUgalF1ZXJ5IHRyaWdnZXIgbWV0aG9kIHNpbmNlIGl0IHdvcmtzIGluY29ycmVjdGx5LgogICAgICoKICAgICAqIGpRdWVyeSBub3RpZmllcyBsaXN0ZW5lcnMgYW5kIHRoZW4gY2hhbmdlcyB0aGUgc3RhdGUgb2YgYSBjaGVja2JveCBhbmQKICAgICAqIGRvZXMgbm90IGNyZWF0ZSBhIHJlYWwgYnJvd3NlciBldmVudC4gQSByZWFsIGNsaWNrIGNoYW5nZXMgdGhlIHN0YXRlIG9mCiAgICAgKiB0aGUgY2hlY2tib3ggYW5kIHRoZW4gbm90aWZpZXMgbGlzdGVuZXJzLgogICAgICoKICAgICAqIFRvIHdvcmsgYXJvdW5kIHRoaXMgd2UgaW5zdGVhZCB1c2Ugb3VyIG93biBoYW5kbGVyIHRoYXQgZmlyZXMgYSByZWFsIGV2ZW50LgogICAgICovCiAgICAoZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgdmFyIHBhcmVudFRyaWdnZXIgPSBmbi50cmlnZ2VyOwogICAgICAgIGZuLnRyaWdnZXIgPSBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICBpZiAoLyhjbGlja3xjaGFuZ2V8a2V5ZG93bnxibHVyfGlucHV0KS8udGVzdCh0eXBlKSkgewogICAgICAgICAgICAgICAgdmFyIHByb2Nlc3NEZWZhdWx0cyA9IFtdOwogICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgbm9kZSkgewogICAgICAgICAgICAgICAgICAgIHByb2Nlc3NEZWZhdWx0cy5wdXNoKGJyb3dzZXJUcmlnZ2VyKG5vZGUsIHR5cGUpKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgbm90IGNvbXBhdGlibGUgd2l0aCBqUXVlcnkgLSB3ZSByZXR1cm4gYW4gYXJyYXkgb2YgcmV0dXJuZWQgdmFsdWVzLAogICAgICAgICAgICAgICAgLy8gc28gdGhhdCBzY2VuYXJpbyBydW5uZXIga25vdyB3aGV0aGVyIEpTIGNvZGUgaGFzIHByZXZlbnREZWZhdWx0KCkgb2YgdGhlIGV2ZW50IG9yIG5vdC4uLgogICAgICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NEZWZhdWx0czsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFyZW50VHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICB9KShfalF1ZXJ5LmZuKTsKCiAgICAvKioKICAgICAqIEZpbmRzIGFsbCBiaW5kaW5ncyB3aXRoIHRoZSBzdWJzdHJpbmcgbWF0Y2ggb2YgbmFtZSBhbmQgcmV0dXJucyBhbgogICAgICogYXJyYXkgb2YgdGhlaXIgdmFsdWVzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBiaW5kRXhwIFRoZSBuYW1lIHRvIG1hdGNoCiAgICAgKiBAcmV0dXJuIHtBcnJheS48c3RyaW5nPn0gU3RyaW5nIG9mIGJpbmRpbmcgdmFsdWVzCiAgICAgKi8KICAgIF9qUXVlcnkuZm4uYmluZGluZ3MgPSBmdW5jdGlvbiAod2luZG93SnF1ZXJ5LCBiaW5kRXhwKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCBtYXRjaCwKICAgICAgICAgICAgYmluZFNlbGVjdG9yID0gJy5uZy1iaW5kaW5nOnZpc2libGUnOwogICAgICAgIGlmIChhbmd1bGFyLmlzU3RyaW5nKGJpbmRFeHApKSB7CiAgICAgICAgICAgIGJpbmRFeHAgPSBiaW5kRXhwLnJlcGxhY2UoL1xzL2csICcnKTsKICAgICAgICAgICAgbWF0Y2ggPSBmdW5jdGlvbiAoYWN0dWFsRXhwKSB7CiAgICAgICAgICAgICAgICBpZiAoYWN0dWFsRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0dWFsRXhwID0gYWN0dWFsRXhwLnJlcGxhY2UoL1xzL2csICcnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0dWFsRXhwID09IGJpbmRFeHApIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3R1YWxFeHAuaW5kZXhPZihiaW5kRXhwKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWxFeHAuY2hhckF0KGJpbmRFeHAubGVuZ3RoKSA9PSAnfCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChiaW5kRXhwKSB7CiAgICAgICAgICAgIG1hdGNoID0gZnVuY3Rpb24gKGFjdHVhbEV4cCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbEV4cCAmJiBiaW5kRXhwLmV4ZWMoYWN0dWFsRXhwKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hdGNoID0gZnVuY3Rpb24gKGFjdHVhbEV4cCkgewogICAgICAgICAgICAgICAgcmV0dXJuICEhYWN0dWFsRXhwOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5maW5kKGJpbmRTZWxlY3Rvcik7CiAgICAgICAgaWYgKHRoaXMuaXMoYmluZFNlbGVjdG9yKSkgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBzZWxlY3Rpb24uYWRkKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHVzaCh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9ICcnOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdmFsdWUgPSBhbmd1bGFyLnRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0LnB1c2goJycgKyB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBzZWxlY3Rpb24uZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gd2luZG93SnF1ZXJ5KHRoaXMpLAogICAgICAgICAgICAgICAgYmluZGluZzsKICAgICAgICAgICAgaWYgKGJpbmRpbmcgPSBlbGVtZW50LmRhdGEoJyRiaW5kaW5nJykpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYmluZGluZyA9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaChiaW5kaW5nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwdXNoKGVsZW1lbnQuc2NvcGUoKS4kZXZhbChiaW5kaW5nKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWFuZ3VsYXIuaXNBcnJheShiaW5kaW5nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nID0gW2JpbmRpbmddOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBmbnMsIGogPSAwLCBqaiA9IGJpbmRpbmcubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICBmbnMgPSBiaW5kaW5nW2pdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm5zLnBhcnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbnMgPSBmbnMucGFydHM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbnMgPSBbZm5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBzY29wZSwgZm4sIGkgPSAwLCBpaSA9IGZucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2goKGZuID0gZm5zW2ldKS5leHApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaChmbihzY29wZSA9IHNjb3BlIHx8IGVsZW1lbnQuc2NvcGUoKSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZXByZXNlbnRzIHRoZSBhcHBsaWNhdGlvbiBjdXJyZW50bHkgYmVpbmcgdGVzdGVkIGFuZCBhYnN0cmFjdHMgdXNhZ2UKICAgICAqIG9mIGlmcmFtZXMgb3Igc2VwYXJhdGUgd2luZG93cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCBqUXVlcnkgd3JhcHBlciBhcm91bmQgSFRNTCBjb250ZXh0LgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uID0gZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgIGNvbnRleHQuYXBwZW5kKAogICAgICAgICAgICAnPGgyPkN1cnJlbnQgVVJMOiA8YSBocmVmPSJhYm91dDpibGFuayI+Tm9uZTwvYT48L2gyPicgKwogICAgICAgICAgICAgICAgJzxkaXYgaWQ9InRlc3QtZnJhbWVzIj48L2Rpdj4nCiAgICAgICAgKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBqUXVlcnkgY29sbGVjdGlvbiBvZiBmcmFtZXMuIERvbid0IHVzZSB0aGlzIGRpcmVjdGx5IGJlY2F1c2UKICAgICAqIGZyYW1lcyBtYXkgZ28gc3RhbGUuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEByZXR1cm4ge09iamVjdH0galF1ZXJ5IGNvbGxlY3Rpb24KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZ2V0RnJhbWVfID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuZmluZCgnI3Rlc3QtZnJhbWVzIGlmcmFtZTpsYXN0Jyk7CiAgICB9OwoKICAgIC8qKgogICAgICogR2V0cyB0aGUgd2luZG93IG9mIHRoZSB0ZXN0IHJ1bm5lciBmcmFtZS4gQWx3YXlzIGZhdm9yIGV4ZWN1dGVBY3Rpb24oKQogICAgICogaW5zdGVhZCBvZiB0aGlzIG1ldGhvZCBzaW5jZSBpdCBwcmV2ZW50cyB5b3UgZnJvbSBnZXR0aW5nIGEgc3RhbGUgd2luZG93LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IHRoZSB3aW5kb3cgb2YgdGhlIGZyYW1lCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLmdldFdpbmRvd18gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNvbnRlbnRXaW5kb3cgPSB0aGlzLmdldEZyYW1lXygpLnByb3AoJ2NvbnRlbnRXaW5kb3cnKTsKICAgICAgICBpZiAoIWNvbnRlbnRXaW5kb3cpCiAgICAgICAgICAgIHRocm93ICdGcmFtZSB3aW5kb3cgaXMgbm90IGFjY2Vzc2libGUuJzsKICAgICAgICByZXR1cm4gY29udGVudFdpbmRvdzsKICAgIH07CgogICAgLyoqCiAgICAgKiBDaGFuZ2VzIHRoZSBsb2NhdGlvbiBvZiB0aGUgZnJhbWUuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgVVJMLiBJZiBpdCBiZWdpbnMgd2l0aCBhICMgdGhlbiBvbmx5IHRoZQogICAgICogICBoYXNoIG9mIHRoZSBwYWdlIGlzIGNoYW5nZWQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGxvYWRGbiBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpIENhbGxlZCB3aGVuIGZyYW1lIGxvYWRzLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBlcnJvckZuIGZ1bmN0aW9uKGVycm9yKSBDYWxsZWQgaWYgYW55IGVycm9yIHdoZW4gbG9hZGluZy4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGVUbyA9IGZ1bmN0aW9uICh1cmwsIGxvYWRGbiwgZXJyb3JGbikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgZnJhbWUgPSB0aGlzLmdldEZyYW1lXygpOwogICAgICAgIC8vVE9ETyhlc3ByZWhuKTogUmVmYWN0b3IgdG8gdXNlIHJldGhyb3coKQogICAgICAgIGVycm9yRm4gPSBlcnJvckZuIHx8IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfTsKICAgICAgICBpZiAodXJsID09PSAnYWJvdXQ6YmxhbmsnKSB7CiAgICAgICAgICAgIGVycm9yRm4oJ1NhbmRib3ggRXJyb3I6IE5hdmlnYXRpbmcgdG8gYWJvdXQ6YmxhbmsgaXMgbm90IGFsbG93ZWQuJyk7CiAgICAgICAgfSBlbHNlIGlmICh1cmwuY2hhckF0KDApID09PSAnIycpIHsKICAgICAgICAgICAgdXJsID0gZnJhbWUuYXR0cignc3JjJykuc3BsaXQoJyMnKVswXSArIHVybDsKICAgICAgICAgICAgZnJhbWUuYXR0cignc3JjJywgdXJsKTsKICAgICAgICAgICAgdGhpcy5leGVjdXRlQWN0aW9uKGxvYWRGbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWUucmVtb3ZlKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maW5kKCcjdGVzdC1mcmFtZXMnKS5hcHBlbmQoJzxpZnJhbWU+Jyk7CiAgICAgICAgICAgIGZyYW1lID0gdGhpcy5nZXRGcmFtZV8oKTsKICAgICAgICAgICAgZnJhbWUubG9hZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmcmFtZS51bmJpbmQoKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5leGVjdXRlQWN0aW9uKGxvYWRGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JGbihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkuYXR0cignc3JjJywgdXJsKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbmQoJz4gaDIgYScpLmF0dHIoJ2hyZWYnLCB1cmwpLnRleHQodXJsKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyBhIGZ1bmN0aW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSB0ZXN0ZWQgYXBwbGljYXRpb24uIFdpbGwgd2FpdAogICAgICogZm9yIGFsbCBwZW5kaW5nIGFuZ3VsYXIgeGhyIHJlcXVlc3RzIGJlZm9yZSBleGVjdXRpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBhY3Rpb24gVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUuIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkKICAgICAqICAkZG9jdW1lbnQgaXMgYSBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZXhlY3V0ZUFjdGlvbiA9IGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyICR3aW5kb3cgPSB0aGlzLmdldFdpbmRvd18oKTsKICAgICAgICBpZiAoISR3aW5kb3cuZG9jdW1lbnQpIHsKICAgICAgICAgICAgdGhyb3cgJ1NhbmRib3ggRXJyb3I6IEFwcGxpY2F0aW9uIGRvY3VtZW50IG5vdCBhY2Nlc3NpYmxlLic7CiAgICAgICAgfQogICAgICAgIGlmICghJHdpbmRvdy5hbmd1bGFyKSB7CiAgICAgICAgICAgIHJldHVybiBhY3Rpb24uY2FsbCh0aGlzLCAkd2luZG93LCBfalF1ZXJ5KCR3aW5kb3cuZG9jdW1lbnQpKTsKICAgICAgICB9CiAgICAgICAgYW5ndWxhckluaXQoJHdpbmRvdy5kb2N1bWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyICRpbmplY3RvciA9ICR3aW5kb3cuYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpLmluamVjdG9yKCk7CiAgICAgICAgICAgIHZhciAkZWxlbWVudCA9IF9qUXVlcnkoZWxlbWVudCk7CgogICAgICAgICAgICAkZWxlbWVudC5pbmplY3RvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3I7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uICgkYnJvd3NlcikgewogICAgICAgICAgICAgICAgJGJyb3dzZXIubm90aWZ5V2hlbk5vT3V0c3RhbmRpbmdSZXF1ZXN0cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmNhbGwoc2VsZiwgJHdpbmRvdywgJGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIFRoZSByZXByZXNlbnRhdGlvbiBvZiBkZWZpbmUgYmxvY2tzLiBEb24ndCB1c2VkIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZQogICAgICogZGVmaW5lKCkgaW4geW91ciB0ZXN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGVzY05hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnQgZGVzY3JpYmUgb3IgdW5kZWZpbmVkIGlmIHRoZSByb290LgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlID0gZnVuY3Rpb24gKGRlc2NOYW1lLCBwYXJlbnQpIHsKICAgICAgICB0aGlzLm9ubHkgPSBwYXJlbnQgJiYgcGFyZW50Lm9ubHk7CiAgICAgICAgdGhpcy5iZWZvcmVFYWNoRm5zID0gW107CiAgICAgICAgdGhpcy5hZnRlckVhY2hGbnMgPSBbXTsKICAgICAgICB0aGlzLml0cyA9IFtdOwogICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgICAgICB0aGlzLm5hbWUgPSBkZXNjTmFtZTsKICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICB0aGlzLmlkID0gYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5pZCsrOwoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxscyBhbGwgYmVmb3JlIGZ1bmN0aW9ucy4KICAgICAgICAgKi8KICAgICAgICB2YXIgYmVmb3JlRWFjaEZucyA9IHRoaXMuYmVmb3JlRWFjaEZuczsKICAgICAgICB0aGlzLnNldHVwQmVmb3JlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQuc2V0dXBCZWZvcmUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGJlZm9yZUVhY2hGbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbHMgYWxsIGFmdGVyIGZ1bmN0aW9ucy4KICAgICAgICAgKi8KICAgICAgICB2YXIgYWZ0ZXJFYWNoRm5zID0gdGhpcy5hZnRlckVhY2hGbnM7CiAgICAgICAgdGhpcy5zZXR1cEFmdGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goYWZ0ZXJFYWNoRm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQuc2V0dXBBZnRlci5jYWxsKHRoaXMpOwogICAgICAgIH07CiAgICB9OwoKLy8gU2hhcmVkIFVuaXF1ZSBJRCBnZW5lcmF0b3IgZm9yIGV2ZXJ5IGRlc2NyaWJlIGJsb2NrCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLmlkID0gMDsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBpdCAoc3BlYykKICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuc3BlY0lkID0gMDsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBibG9jayB0byBleGVjdXRlIGJlZm9yZSBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmJlZm9yZUVhY2ggPSBmdW5jdGlvbiAoYm9keSkgewogICAgICAgIHRoaXMuYmVmb3JlRWFjaEZucy5wdXNoKGJvZHkpOwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBibG9jayB0byBleGVjdXRlIGFmdGVyIGVhY2ggaXQgb3IgbmVzdGVkIGRlc2NyaWJlLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuYWZ0ZXJFYWNoID0gZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgICB0aGlzLmFmdGVyRWFjaEZucy5wdXNoKGJvZHkpOwogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgZGVzY3JpYmUgYmxvY2sgdGhhdCdzIGEgY2hpbGQgb2YgdGhpcyBvbmUuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgYmxvY2suIEFwcGVuZGVkIHRvIHRoZSBwYXJlbnQgYmxvY2sncyBuYW1lLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5kZXNjcmliZSA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdmFyIGNoaWxkID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUobmFtZSwgdGhpcyk7CiAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICBib2R5LmNhbGwoY2hpbGQpOwogICAgfTsKCiAgICAvKioKICAgICAqIFNhbWUgYXMgZGVzY3JpYmUoKSBidXQgbWFrZXMgZGRlc2NyaWJlIGJsb2NrcyB0aGUgb25seSB0byBydW4uCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuZGRlc2NyaWJlID0gZnVuY3Rpb24gKG5hbWUsIGJvZHkpIHsKICAgICAgICB2YXIgY2hpbGQgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZShuYW1lLCB0aGlzKTsKICAgICAgICBjaGlsZC5vbmx5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgIGJvZHkuY2FsbChjaGlsZCk7CiAgICB9OwoKICAgIC8qKgogICAgICogVXNlIHRvIGRpc2FibGUgYSBkZXNjcmliZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUueGRlc2NyaWJlID0gYW5ndWxhci5ub29wOwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIHRlc3QuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gdm9keSBCb2R5IG9mIHRoZSBibG9jay4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuaXQgPSBmdW5jdGlvbiAobmFtZSwgYm9keSkgewogICAgICAgIHRoaXMuaXRzLnB1c2goewogICAgICAgICAgICBpZDogYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5zcGVjSWQrKywKICAgICAgICAgICAgZGVmaW5pdGlvbjogdGhpcywKICAgICAgICAgICAgb25seTogdGhpcy5vbmx5LAogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICBiZWZvcmU6IHRoaXMuc2V0dXBCZWZvcmUsCiAgICAgICAgICAgIGJvZHk6IGJvZHksCiAgICAgICAgICAgIGFmdGVyOiB0aGlzLnNldHVwQWZ0ZXIKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTYW1lIGFzIGl0KCkgYnV0IG1ha2VzIGlpdCB0ZXN0cyB0aGUgb25seSB0ZXN0IHRvIHJ1bi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSB0ZXN0LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5paXQgPSBmdW5jdGlvbiAobmFtZSwgYm9keSkgewogICAgICAgIHRoaXMuaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB0aGlzLml0c1t0aGlzLml0cy5sZW5ndGggLSAxXS5vbmx5ID0gdHJ1ZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBVc2UgdG8gZGlzYWJsZSBhIHRlc3QgYmxvY2suCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhpdCA9IGFuZ3VsYXIubm9vcDsKCiAgICAvKioKICAgICAqIEdldHMgYW4gYXJyYXkgb2YgZnVuY3Rpb25zIHJlcHJlc2VudGluZyBhbGwgdGhlIHRlc3RzIChyZWN1cnNpdmVseSkuCiAgICAgKiB0aGF0IGNhbiBiZSBleGVjdXRlZCB3aXRoIFNwZWNSdW5uZXIncy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtBcnJheTxPYmplY3Q+fSBBcnJheSBvZiBpdCBibG9ja3MgewogKiAgIGRlZmluaXRpb24gOiBPYmplY3QgLy8gcGFyZW50IERlc2NyaWJlCiAqICAgb25seTogYm9vbGVhbgogKiAgIG5hbWU6IHN0cmluZwogKiAgIGJlZm9yZTogRnVuY3Rpb24KICogICBib2R5OiBGdW5jdGlvbgogKiAgIGFmdGVyOiBGdW5jdGlvbgogKiAgfQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5nZXRTcGVjcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc3BlY3MgPSBhcmd1bWVudHNbMF0gfHwgW107CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICBjaGlsZC5nZXRTcGVjcyhzcGVjcyk7CiAgICAgICAgfSk7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuaXRzLCBmdW5jdGlvbiAoaXQpIHsKICAgICAgICAgICAgc3BlY3MucHVzaChpdCk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIG9ubHkgPSBbXTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goc3BlY3MsIGZ1bmN0aW9uIChpdCkgewogICAgICAgICAgICBpZiAoaXQub25seSkgewogICAgICAgICAgICAgICAgb25seS5wdXNoKGl0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiAob25seS5sZW5ndGggJiYgb25seSkgfHwgc3BlY3M7CiAgICB9OwoKICAgIC8qKgogICAgICogQSBmdXR1cmUgYWN0aW9uIGluIGEgc3BlYy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBvZiB0aGUgZnV0dXJlIGFjdGlvbgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmdXR1cmUgY2FsbGJhY2soZXJyb3IsIHJlc3VsdCkKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gT3B0aW9uYWwuIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgZmlsZS9saW5lIG51bWJlci4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUgPSBmdW5jdGlvbiAobmFtZSwgYmVoYXZpb3IsIGxpbmUpIHsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuYmVoYXZpb3IgPSBiZWhhdmlvcjsKICAgICAgICB0aGlzLmZ1bGZpbGxlZCA9IGZhbHNlOwogICAgICAgIHRoaXMudmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5wYXJzZXIgPSBhbmd1bGFyLmlkZW50aXR5OwogICAgICAgIHRoaXMubGluZSA9IGxpbmUgfHwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyB0aGUgYmVoYXZpb3Igb2YgdGhlIGNsb3N1cmUuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBkb25lRm4gQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUucHJvdG90eXBlLmV4ZWN1dGUgPSBmdW5jdGlvbiAoZG9uZUZuKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHRoaXMuYmVoYXZpb3IoZnVuY3Rpb24gKGVycm9yLCByZXN1bHQpIHsKICAgICAgICAgICAgc2VsZi5mdWxmaWxsZWQgPSB0cnVlOwogICAgICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYucGFyc2VyKHJlc3VsdCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYudmFsdWUgPSBlcnJvciB8fCByZXN1bHQ7CiAgICAgICAgICAgIGRvbmVGbihlcnJvciwgcmVzdWx0KTsKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHdpdGggYSBmdW5jdGlvbiBmbih2YWx1ZSkKICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIGZ1bmN0aW9uKHZhbHVlKSB0aGF0IHJldHVybnMgdGhlIHBhcnNlZCB2YWx1ZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUucGFyc2VkV2l0aCA9IGZ1bmN0aW9uIChmbikgewogICAgICAgIHRoaXMucGFyc2VyID0gZm47CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29uZmlndXJlcyB0aGUgZnV0dXJlIHRvIHBhcnNlIGl0J3MgZmluYWwgdmFsdWUgZnJvbSBKU09OCiAgICAgKiBpbnRvIG9iamVjdHMuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlLnByb3RvdHlwZS5mcm9tSnNvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5wYXJzZWRXaXRoKGFuZ3VsYXIuZnJvbUpzb24pOwogICAgfTsKCiAgICAvKioKICAgICAqIENvbmZpZ3VyZXMgdGhlIGZ1dHVyZSB0byBjb252ZXJ0IGl0J3MgZmluYWwgdmFsdWUgZnJvbSBvYmplY3RzCiAgICAgKiBpbnRvIEpTT04uCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlLnByb3RvdHlwZS50b0pzb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLnRvSnNvbik7CiAgICB9OwoKICAgIC8qKgogICAgICogTWFpbnRhaW5zIGFuIG9iamVjdCB0cmVlIGZyb20gdGhlIHJ1bm5lciBldmVudHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHJ1bm5lciBUaGUgc2NlbmFyaW8gUnVubmVyIGluc3RhbmNlIHRvIGNvbm5lY3QgdG8uCiAgICAgKgogICAgICogVE9ETyhlc3ByZWhuKTogRXZlcnkgb3V0cHV0IHR5cGUgY3JlYXRlcyBvbmUgb2YgdGhlc2UsIGJ1dCB3ZSBwcm9iYWJseQogICAgICogIHdhbnQgb25lIGdsb2JhbCBzaGFyZWQgaW5zdGFuY2UuIE5lZWQgdG8gaGFuZGxlIGV2ZW50cyBiZXR0ZXIgdG9vCiAgICAgKiAgc28gdGhlIEhUTUwgb3V0cHV0IGRvZXNuJ3QgbmVlZCB0byBkbyBzcGVjIG1vZGVsLmdldFNwZWMoc3BlYy5pZCkKICAgICAqICBzaWxsaW5lc3MuCiAgICAgKgogICAgICogVE9ETyh2b2p0YSkgcmVmYWN0b3Igb24sIGVtaXQgbWV0aG9kcyAoZnJvbSBhbGwgb2JqZWN0cykgLSB1c2UgaW5oZXJpdGFuY2UKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCA9IGZ1bmN0aW9uIChydW5uZXIpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuc3BlY01hcCA9IHt9OwogICAgICAgIHRoaXMubGlzdGVuZXJzID0gW107CiAgICAgICAgdGhpcy52YWx1ZSA9IHsKICAgICAgICAgICAgbmFtZTogJycsCiAgICAgICAgICAgIGNoaWxkcmVuOiB7fQogICAgICAgIH07CgogICAgICAgIHJ1bm5lci5vbignU3BlY0JlZ2luJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIGJsb2NrID0gc2VsZi52YWx1ZSwKICAgICAgICAgICAgICAgIGRlZmluaXRpb25zID0gW107CgogICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goc2VsZi5nZXREZWZpbml0aW9uUGF0aChzcGVjKSwgZnVuY3Rpb24gKGRlZikgewogICAgICAgICAgICAgICAgaWYgKCFibG9jay5jaGlsZHJlbltkZWYubmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5jaGlsZHJlbltkZWYubmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkZWYuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGRlZi5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNzOiB7fQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9jayA9IGJsb2NrLmNoaWxkcmVuW2RlZi5uYW1lXTsKICAgICAgICAgICAgICAgIGRlZmluaXRpb25zLnB1c2goZGVmLm5hbWUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuc3BlY01hcFtzcGVjLmlkXSA9CiAgICAgICAgICAgICAgICBibG9jay5zcGVjc1tzcGVjLm5hbWVdID0KICAgICAgICAgICAgICAgICAgICBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjKHNwZWMuaWQsIHNwZWMubmFtZSwgZGVmaW5pdGlvbnMpOwoKICAgICAgICAgICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5lbWl0KCdTcGVjQmVnaW4nLCBpdCk7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3BlY0Vycm9yJywgZnVuY3Rpb24gKHNwZWMsIGVycm9yKSB7CiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKTsKICAgICAgICAgICAgaXQuc3RhdHVzID0gJ2Vycm9yJzsKICAgICAgICAgICAgaXQuZXJyb3IgPSBlcnJvcjsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgaXQsIGVycm9yKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24gKHNwZWMpIHsKICAgICAgICAgICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICBjb21wbGV0ZShpdCk7CgogICAgICAgICAgICAvLyBmb3J3YXJkIHRoZSBldmVudAogICAgICAgICAgICBzZWxmLmVtaXQoJ1NwZWNFbmQnLCBpdCk7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignU3RlcEJlZ2luJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXApIHsKICAgICAgICAgICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAoc3RlcC5uYW1lKTsKICAgICAgICAgICAgaXQuc3RlcHMucHVzaChzdGVwKTsKCiAgICAgICAgICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEJlZ2luJywgaXQsIHN0ZXApOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1N0ZXBFbmQnLCBmdW5jdGlvbiAoc3BlYykgewogICAgICAgICAgICB2YXIgaXQgPSBzZWxmLmdldFNwZWMoc3BlYy5pZCk7CiAgICAgICAgICAgIHZhciBzdGVwID0gaXQuZ2V0TGFzdFN0ZXAoKTsKICAgICAgICAgICAgaWYgKHN0ZXAubmFtZSAhPT0gc3RlcC5uYW1lKQogICAgICAgICAgICAgICAgdGhyb3cgJ0V2ZW50cyBmaXJlZCBpbiB0aGUgd3Jvbmcgb3JkZXIuIFN0ZXAgbmFtZXMgZG9uXCd0IG1hdGNoLic7CiAgICAgICAgICAgIGNvbXBsZXRlKHN0ZXApOwoKICAgICAgICAgICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgaXQsIHN0ZXApOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1N0ZXBGYWlsdXJlJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXAsIGVycm9yKSB7CiAgICAgICAgICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKSwKICAgICAgICAgICAgICAgIG1vZGVsU3RlcCA9IGl0LmdldExhc3RTdGVwKCk7CgogICAgICAgICAgICBtb2RlbFN0ZXAuc2V0RXJyb3JTdGF0dXMoJ2ZhaWx1cmUnLCBlcnJvciwgc3RlcC5saW5lKCkpOwogICAgICAgICAgICBpdC5zZXRTdGF0dXNGcm9tU3RlcChtb2RlbFN0ZXApOwoKICAgICAgICAgICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRmFpbHVyZScsIGl0LCBtb2RlbFN0ZXAsIGVycm9yKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRXJyb3InLCBmdW5jdGlvbiAoc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgICAgICAgICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpLAogICAgICAgICAgICAgICAgbW9kZWxTdGVwID0gaXQuZ2V0TGFzdFN0ZXAoKTsKCiAgICAgICAgICAgIG1vZGVsU3RlcC5zZXRFcnJvclN0YXR1cygnZXJyb3InLCBlcnJvciwgc3RlcC5saW5lKCkpOwogICAgICAgICAgICBpdC5zZXRTdGF0dXNGcm9tU3RlcChtb2RlbFN0ZXApOwoKICAgICAgICAgICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRXJyb3InLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgICAgICAgfSk7CgogICAgICAgIHJ1bm5lci5vbignUnVubmVyQmVnaW4nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuZW1pdCgnUnVubmVyQmVnaW4nKTsKICAgICAgICB9KTsKICAgICAgICBydW5uZXIub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5lbWl0KCdSdW5uZXJFbmQnKTsKICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGUoaXRlbSkgewogICAgICAgICAgICBpdGVtLmVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgICAgaXRlbS5kdXJhdGlvbiA9IGl0ZW0uZW5kVGltZSAtIGl0ZW0uc3RhcnRUaW1lOwogICAgICAgICAgICBpdGVtLnN0YXR1cyA9IGl0ZW0uc3RhdHVzIHx8ICdzdWNjZXNzJzsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQWRkcyBhIGxpc3RlbmVyIGZvciBhbiBldmVudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGFkZCBhIGhhbmRsZXIgZm9yCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGxpc3RlbmVyIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBldmVudCBpcyBmaXJlZAogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW107CiAgICAgICAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBFbWl0cyBhbiBldmVudCB3aGljaCBub3RpZmllcyBsaXN0ZW5lcnMgYW5kIHBhc3NlcyBleHRyYQogICAgICogYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgTmFtZSBvZiB0aGUgZXZlbnQgdG8gZmlyZS4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICAgICAgICBldmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0sIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBDb21wdXRlcyB0aGUgcGF0aCBvZiBkZWZpbml0aW9uIGRlc2NyaWJlIGJsb2NrcyB0aGF0IHdyYXAgYXJvdW5kCiAgICAgKiB0aGlzIHNwZWMuCiAgICAgKgogICAgICogQHBhcmFtIHNwZWMgU3BlYyB0byBjb21wdXRlIHRoZSBwYXRoIGZvci4KICAgICAqIEByZXR1cm4ge0FycmF5PERlc2NyaWJlPn0gVGhlIGRlc2NyaWJlIGJsb2NrIHBhdGgKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUuZ2V0RGVmaW5pdGlvblBhdGggPSBmdW5jdGlvbiAoc3BlYykgewogICAgICAgIHZhciBwYXRoID0gW107CiAgICAgICAgdmFyIGN1cnJlbnREZWZpbml0aW9uID0gc3BlYy5kZWZpbml0aW9uOwogICAgICAgIHdoaWxlIChjdXJyZW50RGVmaW5pdGlvbiAmJiBjdXJyZW50RGVmaW5pdGlvbi5uYW1lKSB7CiAgICAgICAgICAgIHBhdGgudW5zaGlmdChjdXJyZW50RGVmaW5pdGlvbik7CiAgICAgICAgICAgIGN1cnJlbnREZWZpbml0aW9uID0gY3VycmVudERlZmluaXRpb24ucGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGF0aDsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXRzIGEgc3BlYyBieSBpZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gVGhlIGlkIG9mIHRoZSBzcGVjIHRvIGdldCB0aGUgb2JqZWN0IGZvci4KICAgICAqIEByZXR1cm4ge09iamVjdH0gdGhlIFNwZWMgaW5zdGFuY2UKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUuZ2V0U3BlYyA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgIHJldHVybiB0aGlzLnNwZWNNYXBbaWRdOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgc2luZ2xlIGl0IGJsb2NrLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBJZCBvZiB0aGUgc3BlYwogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgc3BlYwogICAgICogQHBhcmFtIHtBcnJheTxzdHJpbmc+PX0gZGVmaW5pdGlvbk5hbWVzIExpc3Qgb2YgYWxsIGRlc2NyaWJlIGJsb2NrIG5hbWVzIHRoYXQgd3JhcCB0aGlzIHNwZWMKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjID0gZnVuY3Rpb24gKGlkLCBuYW1lLCBkZWZpbml0aW9uTmFtZXMpIHsKICAgICAgICB0aGlzLmlkID0gaWQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHRoaXMuc3RlcHMgPSBbXTsKICAgICAgICB0aGlzLmZ1bGxEZWZpbml0aW9uTmFtZSA9IChkZWZpbml0aW9uTmFtZXMgfHwgW10pLmpvaW4oJyAnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBZGRzIGEgbmV3IHN0ZXAgdG8gdGhlIFNwZWMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0ZXAgTmFtZSBvZiB0aGUgc3RlcCAocmVhbGx5IG5hbWUgb2YgdGhlIGZ1dHVyZSkKICAgICAqIEByZXR1cm4ge09iamVjdH0gdGhlIGFkZGVkIHN0ZXAKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjLnByb3RvdHlwZS5hZGRTdGVwID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgc3RlcCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAobmFtZSk7CiAgICAgICAgdGhpcy5zdGVwcy5wdXNoKHN0ZXApOwogICAgICAgIHJldHVybiBzdGVwOwogICAgfTsKCiAgICAvKioKICAgICAqIEdldHMgdGhlIG1vc3QgcmVjZW50IHN0ZXAuCiAgICAgKgogICAgICogQHJldHVybiB7T2JqZWN0fSB0aGUgc3RlcAogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlNwZWMucHJvdG90eXBlLmdldExhc3RTdGVwID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0ZXBzW3RoaXMuc3RlcHMubGVuZ3RoIC0gMV07CiAgICB9OwoKICAgIC8qKgogICAgICogU2V0IHN0YXR1cyBvZiB0aGUgU3BlYyBmcm9tIGdpdmVuIFN0ZXAKICAgICAqCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcH0gc3RlcAogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlNwZWMucHJvdG90eXBlLnNldFN0YXR1c0Zyb21TdGVwID0gZnVuY3Rpb24gKHN0ZXApIHsKICAgICAgICBpZiAoIXRoaXMuc3RhdHVzIHx8IHN0ZXAuc3RhdHVzID09ICdlcnJvcicpIHsKICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGVwLnN0YXR1czsKICAgICAgICAgICAgdGhpcy5lcnJvciA9IHN0ZXAuZXJyb3I7CiAgICAgICAgICAgIHRoaXMubGluZSA9IHN0ZXAubGluZTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQSBzaW5nbGUgc3RlcCBpbnNpZGUgYSBTcGVjLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwIE5hbWUgb2YgdGhlIHN0ZXAKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9OwoKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCBmb3Igc2V0dGluZyBhbGwgZXJyb3Igc3RhdHVzIHJlbGF0ZWQgcHJvcGVydGllcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0dXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlcnJvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGxpbmUKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwLnByb3RvdHlwZS5zZXRFcnJvclN0YXR1cyA9IGZ1bmN0aW9uIChzdGF0dXMsIGVycm9yLCBsaW5lKSB7CiAgICAgICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgdGhpcy5lcnJvciA9IGVycm9yOwogICAgICAgIHRoaXMubGluZSA9IGxpbmU7CiAgICB9OwoKICAgIC8qKgogICAgICogUnVubmVyIGZvciBzY2VuYXJpb3MKICAgICAqCiAgICAgKiBIYXMgdG8gYmUgaW5pdGlhbGl6ZWQgYmVmb3JlIGFueSB0ZXN0IGlzIGxvYWRlZCwKICAgICAqIGJlY2F1c2UgaXQgcHVibGlzaGVzIHRoZSBBUEkgaW50byB3aW5kb3cgKGdsb2JhbCBzcGFjZSkuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyID0gZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICB0aGlzLmxpc3RlbmVycyA9IFtdOwogICAgICAgIHRoaXMuJHdpbmRvdyA9ICR3aW5kb3c7CiAgICAgICAgdGhpcy5yb290RGVzY3JpYmUgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZSgpOwogICAgICAgIHRoaXMuY3VycmVudERlc2NyaWJlID0gdGhpcy5yb290RGVzY3JpYmU7CiAgICAgICAgdGhpcy5hcGkgPSB7CiAgICAgICAgICAgIGl0OiB0aGlzLml0LAogICAgICAgICAgICBpaXQ6IHRoaXMuaWl0LAogICAgICAgICAgICB4aXQ6IGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgZGVzY3JpYmU6IHRoaXMuZGVzY3JpYmUsCiAgICAgICAgICAgIGRkZXNjcmliZTogdGhpcy5kZGVzY3JpYmUsCiAgICAgICAgICAgIHhkZXNjcmliZTogYW5ndWxhci5ub29wLAogICAgICAgICAgICBiZWZvcmVFYWNoOiB0aGlzLmJlZm9yZUVhY2gsCiAgICAgICAgICAgIGFmdGVyRWFjaDogdGhpcy5hZnRlckVhY2gKICAgICAgICB9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmFwaSwgYW5ndWxhci5iaW5kKHRoaXMsIGZ1bmN0aW9uIChmbiwga2V5KSB7CiAgICAgICAgICAgIHRoaXMuJHdpbmRvd1trZXldID0gYW5ndWxhci5iaW5kKHRoaXMsIGZuKTsKICAgICAgICB9KSk7CiAgICB9OwoKICAgIC8qKgogICAgICogRW1pdHMgYW4gZXZlbnQgd2hpY2ggbm90aWZpZXMgbGlzdGVuZXJzIGFuZCBwYXNzZXMgZXh0cmEKICAgICAqIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKCF0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0sIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBZGRzIGEgbGlzdGVuZXIgZm9yIGFuIGV2ZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRvIGFkZCBhIGhhbmRsZXIgZm9yCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGlzdGVuZXIgVGhlIGZuKC4uLikgdGhhdCB0YWtlcyB0aGUgZXh0cmEgYXJndW1lbnRzIGZyb20gZW1pdCgpCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW107CiAgICAgICAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgZGVzY3JpYmUgYmxvY2sgb2YgYSBzcGVjLgogICAgICoKICAgICAqIEBzZWUgRGVzY3JpYmUuanMKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5kZXNjcmliZSA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHRoaXMuY3VycmVudERlc2NyaWJlLmRlc2NyaWJlKG5hbWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBhcmVudERlc2NyaWJlID0gc2VsZi5jdXJyZW50RGVzY3JpYmU7CiAgICAgICAgICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gdGhpczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGJvZHkuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gcGFyZW50RGVzY3JpYmU7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTYW1lIGFzIGRlc2NyaWJlLCBidXQgbWFrZXMgZGRlc2NyaWJlIHRoZSBvbmx5IGJsb2NrcyB0byBydW4uCiAgICAgKgogICAgICogQHNlZSBEZXNjcmliZS5qcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2sKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLmRkZXNjcmliZSA9IGZ1bmN0aW9uIChuYW1lLCBib2R5KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHRoaXMuY3VycmVudERlc2NyaWJlLmRkZXNjcmliZShuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnREZXNjcmliZSA9IHNlbGYuY3VycmVudERlc2NyaWJlOwogICAgICAgICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHRoaXM7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBib2R5LmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHBhcmVudERlc2NyaWJlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIHRlc3QgaW4gYSBkZXNjcmliZSBibG9jayBvZiBhIHNwZWMuCiAgICAgKgogICAgICogQHNlZSBEZXNjcmliZS5qcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJvZHkgQm9keSBvZiB0aGUgYmxvY2sKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLml0ID0gZnVuY3Rpb24gKG5hbWUsIGJvZHkpIHsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5pdChuYW1lLCBib2R5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTYW1lIGFzIGl0LCBidXQgbWFrZXMgaWl0IHRlc3RzIHRoZSBvbmx5IHRlc3RzIHRvIHJ1bi4KICAgICAqCiAgICAgKiBAc2VlIERlc2NyaWJlLmpzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gYm9keSBCb2R5IG9mIHRoZSBibG9jawogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuaWl0ID0gZnVuY3Rpb24gKG5hbWUsIGJvZHkpIHsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5paXQobmFtZSwgYm9keSk7CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmaW5lcyBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBiZWZvcmUgZWFjaCBpdCBibG9jayBpbiB0aGUgZGVzY3JpYmUKICAgICAqIChhbmQgYmVmb3JlIGFsbCBuZXN0ZWQgZGVzY3JpYmVzKS4KICAgICAqCiAgICAgKiBAc2VlIERlc2NyaWJlLmpzCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBDYWxsYmFjayB0byBleGVjdXRlCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5iZWZvcmVFYWNoID0gZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgICB0aGlzLmN1cnJlbnREZXNjcmliZS5iZWZvcmVFYWNoKGJvZHkpOwogICAgfTsKCiAgICAvKioKICAgICAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgZWFjaCBpdCBibG9jayBpbiB0aGUgZGVzY3JpYmUKICAgICAqIChhbmQgYmVmb3JlIGFsbCBuZXN0ZWQgZGVzY3JpYmVzKS4KICAgICAqCiAgICAgKiBAc2VlIERlc2NyaWJlLmpzCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBDYWxsYmFjayB0byBleGVjdXRlCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5hZnRlckVhY2ggPSBmdW5jdGlvbiAoYm9keSkgewogICAgICAgIHRoaXMuY3VycmVudERlc2NyaWJlLmFmdGVyRWFjaChib2R5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHNwZWMgcnVubmVyLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgcGFyZW50IHNjb3BlCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5jcmVhdGVTcGVjUnVubmVyXyA9IGZ1bmN0aW9uIChzY29wZSkgewogICAgICAgIHZhciBjaGlsZCA9IHNjb3BlLiRuZXcoKTsKICAgICAgICB2YXIgQ2xzID0gYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyOwoKICAgICAgICAvLyBFeHBvcnQgYWxsIHRoZSBtZXRob2RzIHRvIGNoaWxkIHNjb3BlIG1hbnVhbGx5IGFzIG5vdyB3ZSBkb24ndCBtZXNzIGNvbnRyb2xsZXJzIHdpdGggc2NvcGVzCiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJlZmFjdG9yIHNjZW5hcmlvIHJ1bm5lciBzbyB0aGF0IHRoZXNlIG9iamVjdHMgYXJlIG5vdCB0aWdodGx5IGNvdXBsZWQgYXMgY3VycmVudAogICAgICAgIGZvciAodmFyIG5hbWUgaW4gQ2xzLnByb3RvdHlwZSkKICAgICAgICAgICAgY2hpbGRbbmFtZV0gPSBhbmd1bGFyLmJpbmQoY2hpbGQsIENscy5wcm90b3R5cGVbbmFtZV0pOwoKICAgICAgICBDbHMuY2FsbChjaGlsZCk7CiAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgfTsKCiAgICAvKioKICAgICAqIFJ1bnMgYWxsIHRoZSBsb2FkZWQgdGVzdHMgd2l0aCB0aGUgc3BlY2lmaWVkIHJ1bm5lciBjbGFzcyBvbiB0aGUKICAgICAqIHByb3ZpZGVkIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7YW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbn0gYXBwbGljYXRpb24gQXBwIHRvIHJlbW90ZSBjb250cm9sLgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciAkcm9vdCA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZyddKS5nZXQoJyRyb290U2NvcGUnKTsKICAgICAgICBhbmd1bGFyLmV4dGVuZCgkcm9vdCwgdGhpcyk7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZSwgZnVuY3Rpb24gKGZuLCBuYW1lKSB7CiAgICAgICAgICAgICRyb290W25hbWVdID0gYW5ndWxhci5iaW5kKHNlbGYsIGZuKTsKICAgICAgICB9KTsKICAgICAgICAkcm9vdC5hcHBsaWNhdGlvbiA9IGFwcGxpY2F0aW9uOwogICAgICAgICRyb290LmVtaXQoJ1J1bm5lckJlZ2luJyk7CiAgICAgICAgYXN5bmNGb3JFYWNoKHRoaXMucm9vdERlc2NyaWJlLmdldFNwZWNzKCksIGZ1bmN0aW9uIChzcGVjLCBzcGVjRG9uZSkgewogICAgICAgICAgICAgICAgdmFyIGRzbENhY2hlID0ge307CiAgICAgICAgICAgICAgICB2YXIgcnVubmVyID0gc2VsZi5jcmVhdGVTcGVjUnVubmVyXygkcm9vdCk7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uIChmbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZHNsQ2FjaGVba2V5XSA9IGZuLmNhbGwoJHJvb3QpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uIChmbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi4kd2luZG93W2tleV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5lID0gY2FsbGVyRmlsZSgzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gcnVubmVyLiRuZXcoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1ha2UgdGhlIGRzbCBhY2Nlc3NpYmxlIG9uIHRoZSBjdXJyZW50IGNoYWluCiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmRzbCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goZHNsQ2FjaGUsIGZ1bmN0aW9uIChmbiwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5kc2xba2V5XSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZHNsQ2FjaGVba2V5XS5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSB0aGVzZSBtZXRob2RzIHdvcmsgb24gdGhlIGN1cnJlbnQgY2hhaW4KICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYWRkRnV0dXJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm90b3R5cGUuYWRkRnV0dXJlLmFwcGx5KHNjb3BlLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5hZGRGdXR1cmVBY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5jYWxsKGFyZ3VtZW50cywgbGluZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvdHlwZS5hZGRGdXR1cmVBY3Rpb24uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZHNsW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcnVubmVyLnJ1bihzcGVjLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcnVubmVyLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgc3BlY0RvbmUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnUnVubmVyRXJyb3InLCBlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoJ1J1bm5lckVuZCcpOwogICAgICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGlzIGNsYXNzIGlzIHRoZSAidGhpcyIgb2YgdGhlIGl0L2JlZm9yZUVhY2gvYWZ0ZXJFYWNoIG1ldGhvZC4KICAgICAqIFJlc3BvbnNpYmlsaXRpZXM6CiAgICAgKiAgIC0gInRoaXMiIGZvciBpdC9iZWZvcmVFYWNoL2FmdGVyRWFjaAogICAgICogICAtIGtlZXAgc3RhdGUgZm9yIHNpbmdsZSBpdC9iZWZvcmVFYWNoL2FmdGVyRWFjaCBleGVjdXRpb24KICAgICAqICAgLSBrZWVwIHRyYWNrIG9mIGFsbCBvZiB0aGUgZnV0dXJlcyB0byBleGVjdXRlCiAgICAgKiAgIC0gcnVuIHNpbmdsZSBzcGVjIChleGVjdXRlIGVhY2ggZnV0dXJlKQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5mdXR1cmVzID0gW107CiAgICAgICAgdGhpcy5hZnRlckluZGV4ID0gMDsKICAgIH07CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyBhIHNwZWMgd2hpY2ggaXMgYW4gaXQgYmxvY2sgd2l0aCBhc3NvY2lhdGVkIGJlZm9yZS9hZnRlciBmdW5jdGlvbnMKICAgICAqIGJhc2VkIG9uIHRoZSBkZXNjcmliZSBuZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzcGVjIEEgc3BlYyBvYmplY3QKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gc3BlY0RvbmUgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgd2hlbiB0aGUgc3BlYyBmaW5zaGVzLiBGdW5jdGlvbihlcnJvciwgaW5kZXgpCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKHNwZWMsIHNwZWNEb25lKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHRoaXMuc3BlYyA9IHNwZWM7CgogICAgICAgIHRoaXMuZW1pdCgnU3BlY0JlZ2luJywgc3BlYyk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNwZWMuYmVmb3JlLmNhbGwodGhpcyk7CiAgICAgICAgICAgIHNwZWMuYm9keS5jYWxsKHRoaXMpOwogICAgICAgICAgICB0aGlzLmFmdGVySW5kZXggPSB0aGlzLmZ1dHVyZXMubGVuZ3RoOwogICAgICAgICAgICBzcGVjLmFmdGVyLmNhbGwodGhpcyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmVtaXQoJ1NwZWNFcnJvcicsIHNwZWMsIGUpOwogICAgICAgICAgICB0aGlzLmVtaXQoJ1NwZWNFbmQnLCBzcGVjKTsKICAgICAgICAgICAgc3BlY0RvbmUoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhhbmRsZUVycm9yID0gZnVuY3Rpb24gKGVycm9yLCBkb25lKSB7CiAgICAgICAgICAgIGlmIChzZWxmLmVycm9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuZXJyb3IgPSB0cnVlOwogICAgICAgICAgICBkb25lKG51bGwsIHNlbGYuYWZ0ZXJJbmRleCk7CiAgICAgICAgfTsKCiAgICAgICAgYXN5bmNGb3JFYWNoKAogICAgICAgICAgICB0aGlzLmZ1dHVyZXMsCiAgICAgICAgICAgIGZ1bmN0aW9uIChmdXR1cmUsIGZ1dHVyZURvbmUpIHsKICAgICAgICAgICAgICAgIHNlbGYuc3RlcCA9IGZ1dHVyZTsKICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEJlZ2luJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnV0dXJlLmV4ZWN1dGUoZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRmFpbHVyZScsIHNwZWMsIGZ1dHVyZSwgZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciwgZnV0dXJlRG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi4kd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnV0dXJlRG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmVtaXQoJ1N0ZXBFcnJvcicsIHNwZWMsIGZ1dHVyZSwgZSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcihlLCBmdXR1cmVEb25lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmIChlKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbWl0KCdTcGVjRXJyb3InLCBzcGVjLCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuZW1pdCgnU3BlY0VuZCcsIHNwZWMpOwogICAgICAgICAgICAgICAgLy8gQ2FsbCBkb25lIGluIGEgdGltZW91dCBzbyBleGNlcHRpb25zIGRvbid0IHJlY3Vyc2l2ZWx5CiAgICAgICAgICAgICAgICAvLyBjYWxsIHRoaXMgZnVuY3Rpb24KICAgICAgICAgICAgICAgIHNlbGYuJHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBzcGVjRG9uZSgpOwogICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICApOwogICAgfTsKCiAgICAvKioKICAgICAqIEFkZHMgYSBuZXcgZnV0dXJlIGFjdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBEbyBub3QgcGFzcyBsaW5lIG1hbnVhbGx5LiBJdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZnV0dXJlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGJlaGF2aW9yIEJlaGF2aW9yIG9mIHRoZSBmdXR1cmUKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gbGluZSBmbigpIHRoYXQgcmV0dXJucyBmaWxlL2xpbmUgbnVtYmVyCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci5wcm90b3R5cGUuYWRkRnV0dXJlID0gZnVuY3Rpb24gKG5hbWUsIGJlaGF2aW9yLCBsaW5lKSB7CiAgICAgICAgdmFyIGZ1dHVyZSA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZShuYW1lLCBhbmd1bGFyLmJpbmQodGhpcywgYmVoYXZpb3IpLCBsaW5lKTsKICAgICAgICB0aGlzLmZ1dHVyZXMucHVzaChmdXR1cmUpOwogICAgICAgIHJldHVybiBmdXR1cmU7CiAgICB9OwoKICAgIC8qKgogICAgICogQWRkcyBhIG5ldyBmdXR1cmUgYWN0aW9uIHRvIGJlIGV4ZWN1dGVkIG9uIHRoZSBhcHBsaWNhdGlvbiB3aW5kb3cuCiAgICAgKgogICAgICogTm90ZTogRG8gbm90IHBhc3MgbGluZSBtYW51YWxseS4gSXQgaGFwcGVucyBhdXRvbWF0aWNhbGx5LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIucHJvdG90eXBlLmFkZEZ1dHVyZUFjdGlvbiA9IGZ1bmN0aW9uIChuYW1lLCBiZWhhdmlvciwgbGluZSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgTkcgPSAvXFtuZ1xcXDovOwogICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZShuYW1lLCBmdW5jdGlvbiAoZG9uZSkgewogICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLmV4ZWN1dGVBY3Rpb24oZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCkgewoKICAgICAgICAgICAgICAgIC8vVE9ETyhlc3ByZWhuKTogUmVmYWN0b3IgdGhpcyBzbyBpdCBkb2Vzbid0IG5lZWQgdG8gYmUgaW4gaGVyZS4KICAgICAgICAgICAgICAgICRkb2N1bWVudC5lbGVtZW50cyA9IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IChzZWxmLnNlbGVjdG9yIHx8ICcnKSArICcgJyArIChzZWxlY3RvciB8fCAnJyk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBfalF1ZXJ5LnRyaW0oc2VsZWN0b3IpIHx8ICcqJzsKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goYXJncywgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoJyQnICsgKGluZGV4ICsgMSksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gJGRvY3VtZW50LmZpbmQoc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5tYXRjaChORykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsnW25nLScsICdbZGF0YS1uZy0nLCAnW3gtbmctJ10sIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5hZGQoc2VsZWN0b3IucmVwbGFjZShORywgdmFsdWUpLCAkZG9jdW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzZWxlY3RvcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnU2VsZWN0b3IgJyArIHNlbGVjdG9yICsgJyBkaWQgbm90IG1hdGNoIGFueSBlbGVtZW50cy4nCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGJlaGF2aW9yLmNhbGwoc2VsZiwgJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZS50eXBlICYmIGUudHlwZSA9PT0gJ3NlbGVjdG9yJykgewogICAgICAgICAgICAgICAgICAgICAgICBkb25lKGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sIGxpbmUpOwogICAgfTsKCiAgICAvKioKICAgICAqIFNoYXJlZCBEU0wgc3RhdGVtZW50cyB0aGF0IGFyZSB1c2VmdWwgdG8gYWxsIHNjZW5hcmlvcy4KICAgICAqLwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBwYXVzZSgpIHBhdXNlcyB1bnRpbCB5b3UgY2FsbCByZXN1bWUoKSBpbiB0aGUgY29uc29sZQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgncGF1c2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlKCdwYXVzaW5nIGZvciB5b3UgdG8gcmVzdW1lJywgZnVuY3Rpb24gKGRvbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnSW50ZXJhY3RpdmVQYXVzZScsIHRoaXMuc3BlYywgdGhpcy5zdGVwKTsKICAgICAgICAgICAgICAgIHRoaXMuJHdpbmRvdy5yZXN1bWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBzbGVlcChzZWNvbmRzKSBwYXVzZXMgdGhlIHRlc3QgZm9yIHNwZWNpZmllZCBudW1iZXIgb2Ygc2Vjb25kcwogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgnc2xlZXAnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgnc2xlZXAgZm9yICcgKyB0aW1lICsgJyBzZWNvbmRzJywgZnVuY3Rpb24gKGRvbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsIHRpbWUgKiAxMDAwKTsKICAgICAgICAgICAgICAgIH0sIHRpbWUgKiAxMDAwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBicm93c2VyKCkubmF2aWdhdGVUbyh1cmwpIExvYWRzIHRoZSB1cmwgaW50byB0aGUgZnJhbWUKICAgICAqICAgIGJyb3dzZXIoKS5uYXZpZ2F0ZVRvKHVybCwgZm4pIHdoZXJlIGZuKHVybCkgaXMgY2FsbGVkIGFuZCByZXR1cm5zIHRoZSBVUkwgdG8gbmF2aWdhdGUgdG8KICAgICAqICAgIGJyb3dzZXIoKS5yZWxvYWQoKSByZWZyZXNoIHRoZSBwYWdlIChyZWxvYWQgdGhlIHNhbWUgVVJMKQogICAgICogICAgYnJvd3NlcigpLndpbmRvdy5ocmVmKCkgd2luZG93LmxvY2F0aW9uLmhyZWYKICAgICAqICAgIGJyb3dzZXIoKS53aW5kb3cucGF0aCgpIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZQogICAgICogICAgYnJvd3NlcigpLndpbmRvdy5zZWFyY2goKSB3aW5kb3cubG9jYXRpb24uc2VhcmNoCiAgICAgKiAgICBicm93c2VyKCkud2luZG93Lmhhc2goKSB3aW5kb3cubG9jYXRpb24uaGFzaCB3aXRob3V0ICMgcHJlZml4CiAgICAgKiAgICBicm93c2VyKCkubG9jYXRpb24oKS51cmwoKSBzZWUgbmcuJGxvY2F0aW9uI3VybAogICAgICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkucGF0aCgpIHNlZSBuZy4kbG9jYXRpb24jcGF0aAogICAgICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuc2VhcmNoKCkgc2VlIG5nLiRsb2NhdGlvbiNzZWFyY2gKICAgICAqICAgIGJyb3dzZXIoKS5sb2NhdGlvbigpLmhhc2goKSBzZWUgbmcuJGxvY2F0aW9uI2hhc2gKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ2Jyb3dzZXInLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNoYWluID0ge307CgogICAgICAgIGNoYWluLm5hdmlnYXRlVG8gPSBmdW5jdGlvbiAodXJsLCBkZWxlZ2F0ZSkgewogICAgICAgICAgICB2YXIgYXBwbGljYXRpb24gPSB0aGlzLmFwcGxpY2F0aW9uOwogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmUoImJyb3dzZXIgbmF2aWdhdGUgdG8gJyIgKyB1cmwgKyAiJyIsIGZ1bmN0aW9uIChkb25lKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVsZWdhdGUpIHsKICAgICAgICAgICAgICAgICAgICB1cmwgPSBkZWxlZ2F0ZS5jYWxsKHRoaXMsIHVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbi5uYXZpZ2F0ZVRvKHVybCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgdXJsKTsKICAgICAgICAgICAgICAgIH0sIGRvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5yZWxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhcHBsaWNhdGlvbiA9IHRoaXMuYXBwbGljYXRpb247CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignYnJvd3NlciByZWxvYWQnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9ICR3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uLm5hdmlnYXRlVG8oaHJlZiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgaHJlZik7CiAgICAgICAgICAgICAgICB9LCBkb25lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4ud2luZG93ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXBpID0ge307CgogICAgICAgICAgICBhcGkuaHJlZiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignd2luZG93LmxvY2F0aW9uLmhyZWYnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhcGkucGF0aCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignd2luZG93LmxvY2F0aW9uLnBhdGgnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXBpLnNlYXJjaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignd2luZG93LmxvY2F0aW9uLnNlYXJjaCcsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICR3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXBpLmhhc2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ3dpbmRvdy5sb2NhdGlvbi5oYXNoJywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoJyMnLCAnJykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gYXBpOwogICAgICAgIH07CgogICAgICAgIGNoYWluLmxvY2F0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXBpID0ge307CgogICAgICAgICAgICBhcGkudXJsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCckbG9jYXRpb24udXJsKCknLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuaW5qZWN0b3IoKS5nZXQoJyRsb2NhdGlvbicpLnVybCgpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYXBpLnBhdGggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJyRsb2NhdGlvbi5wYXRoKCknLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAkZG9jdW1lbnQuaW5qZWN0b3IoKS5nZXQoJyRsb2NhdGlvbicpLnBhdGgoKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFwaS5zZWFyY2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oJyRsb2NhdGlvbi5zZWFyY2goKScsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5pbmplY3RvcigpLmdldCgnJGxvY2F0aW9uJykuc2VhcmNoKCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhcGkuaGFzaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignJGxvY2F0aW9uLmhhc2goKScsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5pbmplY3RvcigpLmdldCgnJGxvY2F0aW9uJykuaGFzaCgpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGFwaTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBleHBlY3QoZnV0dXJlKS57bWF0Y2hlcn0gd2hlcmUgbWF0Y2hlciBpcyBvbmUgb2YgdGhlIG1hdGNoZXJzIGRlZmluZWQKICAgICAqICAgIHdpdGggYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyCiAgICAgKgogICAgICogZXguIGV4cGVjdChiaW5kaW5nKCJuYW1lIikpLnRvRXF1YWwoIkVsbGlvdHQiKQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgnZXhwZWN0JywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGFpbiA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIpOwoKICAgICAgICBjaGFpbi5ub3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuaW52ZXJzZSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGZ1dHVyZSkgewogICAgICAgICAgICB0aGlzLmZ1dHVyZSA9IGZ1dHVyZTsKICAgICAgICAgICAgcmV0dXJuIGNoYWluOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgdXNpbmcoc2VsZWN0b3IsIGxhYmVsKSBzY29wZXMgdGhlIG5leHQgRFNMIGVsZW1lbnQgc2VsZWN0aW9uCiAgICAgKgogICAgICogZXguCiAgICAgKiAgIHVzaW5nKCcjZm9vJywgIidGb28nIHRleHQgZmllbGQiKS5pbnB1dCgnYmFyJykKICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ3VzaW5nJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZWN0b3IsIGxhYmVsKSB7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0b3IgPSBfalF1ZXJ5LnRyaW0oKHRoaXMuc2VsZWN0b3IgfHwgJycpICsgJyAnICsgc2VsZWN0b3IpOwogICAgICAgICAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhsYWJlbCkgJiYgbGFiZWwubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhYmVsID0gbGFiZWwgKyAnICggJyArIHRoaXMuc2VsZWN0b3IgKyAnICknOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbCA9IHRoaXMuc2VsZWN0b3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZHNsOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIFVzYWdlOgogICAgICogICAgYmluZGluZyhuYW1lKSByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgbWF0Y2hpbmcgYmluZGluZwogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgnYmluZGluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJzZWxlY3QgYmluZGluZyAnIiArIG5hbWUgKyAiJyIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSAkZG9jdW1lbnQuZWxlbWVudHMoKS5iaW5kaW5ncygkd2luZG93LmFuZ3VsYXIuZWxlbWVudCwgbmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgiQmluZGluZyBzZWxlY3RvciAnIiArIG5hbWUgKyAiJyBkaWQgbm90IG1hdGNoLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZG9uZShudWxsLCB2YWx1ZXNbMF0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBVc2FnZToKICAgICAqICAgIGlucHV0KG5hbWUpLmVudGVyKHZhbHVlKSBlbnRlcnMgdmFsdWUgaW4gaW5wdXQgd2l0aCBzcGVjaWZpZWQgbmFtZQogICAgICogICAgaW5wdXQobmFtZSkuY2hlY2soKSBjaGVja3MgY2hlY2tib3gKICAgICAqICAgIGlucHV0KG5hbWUpLnNlbGVjdCh2YWx1ZSkgc2VsZWN0cyB0aGUgcmFkaW8gYnV0dG9uIHdpdGggc3BlY2lmaWVkIG5hbWUvdmFsdWUKICAgICAqICAgIGlucHV0KG5hbWUpLnZhbCgpIHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dC4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5kc2woJ2lucHV0JywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaGFpbiA9IHt9OwogICAgICAgIHZhciBzdXBwb3J0SW5wdXRFdmVudCA9ICdvbmlucHV0JyBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSAmJiBtc2llICE9IDk7CgogICAgICAgIGNoYWluLmVudGVyID0gZnVuY3Rpb24gKHZhbHVlLCBldmVudCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImlucHV0ICciICsgdGhpcy5uYW1lICsgIicgZW50ZXIgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdbbmdcXDptb2RlbD0iJDEiXScsIHRoaXMubmFtZSkuZmlsdGVyKCc6aW5wdXQnKTsKICAgICAgICAgICAgICAgIGlucHV0LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBpbnB1dC50cmlnZ2VyKGV2ZW50IHx8IChzdXBwb3J0SW5wdXRFdmVudCA/ICdpbnB1dCcgOiAnY2hhbmdlJykpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5jaGVjayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJjaGVja2JveCAnIiArIHRoaXMubmFtZSArICInIHRvZ2dsZSIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnW25nXFw6bW9kZWw9IiQxIl0nLCB0aGlzLm5hbWUpLmZpbHRlcignOmNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5zZWxlY3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyYWRpbyBidXR0b24gJyIgKyB0aGlzLm5hbWUgKyAiJyB0b2dnbGUgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJGRvY3VtZW50LgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRzKCdbbmdcXDptb2RlbD0iJDEiXVt2YWx1ZT0iJDIiXScsIHRoaXMubmFtZSwgdmFsdWUpLmZpbHRlcignOnJhZGlvJyk7CiAgICAgICAgICAgICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi52YWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmV0dXJuIGlucHV0IHZhbCIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnW25nXFw6bW9kZWw9IiQxIl0nLCB0aGlzLm5hbWUpLmZpbHRlcignOmlucHV0Jyk7CiAgICAgICAgICAgICAgICBkb25lKG51bGwsIGlucHV0LnZhbCgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICB9OwogICAgfSk7CgoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICByZXBlYXRlcignI3Byb2R1Y3RzIHRhYmxlJywgJ1Byb2R1Y3QgTGlzdCcpLmNvdW50KCkgbnVtYmVyIG9mIHJvd3MKICAgICAqICAgIHJlcGVhdGVyKCcjcHJvZHVjdHMgdGFibGUnLCAnUHJvZHVjdCBMaXN0Jykucm93KDEpIGFsbCBiaW5kaW5ncyBpbiByb3cgYXMgYW4gYXJyYXkKICAgICAqICAgIHJlcGVhdGVyKCcjcHJvZHVjdHMgdGFibGUnLCAnUHJvZHVjdCBMaXN0JykuY29sdW1uKCdwcm9kdWN0Lm5hbWUnKSBhbGwgdmFsdWVzIGFjcm9zcyBhbGwgcm93cyBpbiBhbiBhcnJheQogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLmRzbCgncmVwZWF0ZXInLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNoYWluID0ge307CgogICAgICAgIGNoYWluLmNvdW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIGNvdW50IiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4uY29sdW1uID0gZnVuY3Rpb24gKGJpbmRpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyZXBlYXRlciAnIiArIHRoaXMubGFiZWwgKyAiJyBjb2x1bW4gJyIgKyBiaW5kaW5nICsgIiciLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmJpbmRpbmdzKCR3aW5kb3cuYW5ndWxhci5lbGVtZW50LCBiaW5kaW5nKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGNoYWluLnJvdyA9IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIHJvdyAnIiArIGluZGV4ICsgIiciLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9ICRkb2N1bWVudC5lbGVtZW50cygpLnNsaWNlKGluZGV4LCBpbmRleCArIDEpOwogICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgncm93ICcgKyBpbmRleCArICcgb3V0IG9mIGJvdW5kcycpOwogICAgICAgICAgICAgICAgZG9uZShudWxsLCBtYXRjaGVzLmJpbmRpbmdzKCR3aW5kb3cuYW5ndWxhci5lbGVtZW50KSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZWN0b3IsIGxhYmVsKSB7CiAgICAgICAgICAgIHRoaXMuZHNsLnVzaW5nKHNlbGVjdG9yLCBsYWJlbCk7CiAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBVc2FnZToKICAgICAqICAgIHNlbGVjdChuYW1lKS5vcHRpb24oJ3ZhbHVlJykgc2VsZWN0IG9uZSBvcHRpb24KICAgICAqICAgIHNlbGVjdChuYW1lKS5vcHRpb25zKCd2YWx1ZTEnLCAndmFsdWUyJywgLi4uKSBzZWxlY3Qgb3B0aW9ucyBmcm9tIGEgbXVsdGkgc2VsZWN0CiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdzZWxlY3QnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNoYWluID0ge307CgogICAgICAgIGNoYWluLm9wdGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInNlbGVjdCAnIiArIHRoaXMubmFtZSArICInIG9wdGlvbiAnIiArIHZhbHVlICsgIiciLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbmdcXDptb2RlbD0iJDEiXScsIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgICB2YXIgb3B0aW9uID0gc2VsZWN0LmZpbmQoJ29wdGlvblt2YWx1ZT0iJyArIHZhbHVlICsgJyJdJyk7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdC52YWwodmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBzZWxlY3QuZmluZCgnb3B0aW9uOmNvbnRhaW5zKCInICsgdmFsdWUgKyAnIiknKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QudmFsKG9wdGlvbi52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZWN0LnRyaWdnZXIoJ2NoYW5nZScpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBjaGFpbi5vcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWVzID0gYXJndW1lbnRzOwogICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInNlbGVjdCAnIiArIHRoaXMubmFtZSArICInIG9wdGlvbnMgJyIgKyB2YWx1ZXMgKyAiJyIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxlY3QgPSAkZG9jdW1lbnQuZWxlbWVudHMoJ3NlbGVjdFttdWx0aXBsZV1bbmdcXDptb2RlbD0iJDEiXScsIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgICBzZWxlY3QudmFsKHZhbHVlcyk7CiAgICAgICAgICAgICAgICBzZWxlY3QudHJpZ2dlcignY2hhbmdlJyk7CiAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICByZXR1cm4gY2hhaW47CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8qKgogICAgICogVXNhZ2U6CiAgICAgKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkuY291bnQoKSBnZXQgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0aGF0IG1hdGNoIHNlbGVjdG9yCiAgICAgKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkuY2xpY2soKSBjbGlja3MgYW4gZWxlbWVudAogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnF1ZXJ5KGZuKSBleGVjdXRlcyBmbihzZWxlY3RlZEVsZW1lbnRzLCBkb25lKQogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnttZXRob2R9KCkgZ2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gdmFsKQogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnttZXRob2R9KHZhbHVlKSBzZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiB2YWwpCiAgICAgKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oa2V5KSBnZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiBhdHRyKQogICAgICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnttZXRob2R9KGtleSwgdmFsdWUpIHNldHMgdGhlIHZhbHVlIChhcyBkZWZpbmVkIGJ5IGpRdWVyeSwgZXguIGF0dHIpCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdlbGVtZW50JywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBLRVlfVkFMVUVfTUVUSE9EUyA9IFsnYXR0cicsICdjc3MnLCAncHJvcCddOwogICAgICAgIHZhciBWQUxVRV9NRVRIT0RTID0gWwogICAgICAgICAgICAndmFsJywgJ3RleHQnLCAnaHRtbCcsICdoZWlnaHQnLCAnaW5uZXJIZWlnaHQnLCAnb3V0ZXJIZWlnaHQnLCAnd2lkdGgnLAogICAgICAgICAgICAnaW5uZXJXaWR0aCcsICdvdXRlcldpZHRoJywgJ3Bvc2l0aW9uJywgJ3Njcm9sbExlZnQnLCAnc2Nyb2xsVG9wJywgJ29mZnNldCcKICAgICAgICBdOwogICAgICAgIHZhciBjaGFpbiA9IHt9OwoKICAgICAgICBjaGFpbi5jb3VudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIGNvdW50IiwgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZShudWxsLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBjbGljayIsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50cyA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICAgICAgICAgICAgdmFyIGhyZWYgPSBlbGVtZW50cy5hdHRyKCdocmVmJyk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRQcm9jZXNzRGVmYXVsdCA9IGVsZW1lbnRzLnRyaWdnZXIoJ2NsaWNrJylbMF07CgogICAgICAgICAgICAgICAgaWYgKGhyZWYgJiYgZWxlbWVudHNbMF0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gJ0EnICYmIGV2ZW50UHJvY2Vzc0RlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLm5hdmlnYXRlVG8oaHJlZiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZG9uZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgY2hhaW4ucXVlcnkgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdlbGVtZW50ICcgKyB0aGlzLmxhYmVsICsgJyBjdXN0b20gcXVlcnknLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICBmbi5jYWxsKHRoaXMsICRkb2N1bWVudC5lbGVtZW50cygpLCBkb25lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKEtFWV9WQUxVRV9NRVRIT0RTLCBmdW5jdGlvbiAobWV0aG9kTmFtZSkgewogICAgICAgICAgICBjaGFpblttZXRob2ROYW1lXSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgICAgICAgICAgZnV0dXJlTmFtZSA9IChhcmdzLmxlbmd0aCA9PSAxKQogICAgICAgICAgICAgICAgICAgICAgICA/ICJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIGdldCAiICsgbWV0aG9kTmFtZSArICIgJyIgKyBuYW1lICsgIiciCiAgICAgICAgICAgICAgICAgICAgICAgIDogImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgc2V0ICIgKyBtZXRob2ROYW1lICsgIiAnIiArIG5hbWUgKyAiJyB0byAiICsgIiciICsgdmFsdWUgKyAiJyI7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKGZ1dHVyZU5hbWUsIGZ1bmN0aW9uICgkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgZWxlbWVudFttZXRob2ROYW1lXS5hcHBseShlbGVtZW50LCBhcmdzKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICAgICAgYW5ndWxhci5mb3JFYWNoKFZBTFVFX01FVEhPRFMsIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICAgICAgICAgIGNoYWluW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICAgICAgICBmdXR1cmVOYW1lID0gKGFyZ3MubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICAgICAgICAgID8gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgIiArIG1ldGhvZE5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgOiBmdXR1cmVOYW1lID0gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgc2V0ICIgKyBtZXRob2ROYW1lICsgIiB0byAnIiArIHZhbHVlICsgIiciOwoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbihmdXR1cmVOYW1lLCBmdW5jdGlvbiAoJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSAkZG9jdW1lbnQuZWxlbWVudHMoKTsKICAgICAgICAgICAgICAgICAgICBkb25lKG51bGwsIGVsZW1lbnRbbWV0aG9kTmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZWN0b3IsIGxhYmVsKSB7CiAgICAgICAgICAgIHRoaXMuZHNsLnVzaW5nKHNlbGVjdG9yLCBsYWJlbCk7CiAgICAgICAgICAgIHJldHVybiBjaGFpbjsKICAgICAgICB9OwogICAgfSk7CgogICAgLyoqCiAgICAgKiBNYXRjaGVycyBmb3IgaW1wbGVtZW50aW5nIHNwZWNzLiBGb2xsb3dzIHRoZSBKYXNtaW5lIHNwZWMgY29udmVudGlvbnMuCiAgICAgKi8KCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvRXF1YWwnLCBmdW5jdGlvbiAoZXhwZWN0ZWQpIHsKICAgICAgICByZXR1cm4gYW5ndWxhci5lcXVhbHModGhpcy5hY3R1YWwsIGV4cGVjdGVkKTsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZScsIGZ1bmN0aW9uIChleHBlY3RlZCkgewogICAgICAgIHJldHVybiB0aGlzLmFjdHVhbCA9PT0gZXhwZWN0ZWQ7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVEZWZpbmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBhbmd1bGFyLmlzRGVmaW5lZCh0aGlzLmFjdHVhbCk7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVUcnV0aHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0dWFsOwogICAgfSk7CgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlRmFsc3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICF0aGlzLmFjdHVhbDsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9NYXRjaCcsIGZ1bmN0aW9uIChleHBlY3RlZCkgewogICAgICAgIHJldHVybiBuZXcgUmVnRXhwKGV4cGVjdGVkKS50ZXN0KHRoaXMuYWN0dWFsKTsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZU51bGwnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0dWFsID09PSBudWxsOwogICAgfSk7CgogICAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0NvbnRhaW4nLCBmdW5jdGlvbiAoZXhwZWN0ZWQpIHsKICAgICAgICByZXR1cm4gaW5jbHVkZXModGhpcy5hY3R1YWwsIGV4cGVjdGVkKTsKICAgIH0pOwoKICAgIGFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZUxlc3NUaGFuJywgZnVuY3Rpb24gKGV4cGVjdGVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0dWFsIDwgZXhwZWN0ZWQ7CiAgICB9KTsKCiAgICBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVHcmVhdGVyVGhhbicsIGZ1bmN0aW9uIChleHBlY3RlZCkgewogICAgICAgIHJldHVybiB0aGlzLmFjdHVhbCA+IGV4cGVjdGVkOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBVc2VyIEludGVyZmFjZSBmb3IgdGhlIFNjZW5hcmlvIFJ1bm5lci4KICAgICAqCiAgICAgKiBUT0RPKGVzcHJlaG4pOiBUaGlzIHNob3VsZCBiZSByZWZhY3RvcmVkIG5vdyB0aGF0IE9iamVjdE1vZGVsIGV4aXN0cwogICAgICogIHRvIHVzZSBhbmd1bGFyIGJpbmRpbmdzIGZvciB0aGUgVUkuCiAgICAgKi8KICAgIGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0KCdodG1sJywgZnVuY3Rpb24gKGNvbnRleHQsIHJ1bm5lciwgbW9kZWwpIHsKICAgICAgICB2YXIgc3BlY1VpTWFwID0ge30sCiAgICAgICAgICAgIGxhc3RTdGVwVWlNYXAgPSB7fTsKCiAgICAgICAgY29udGV4dC5hcHBlbmQoCiAgICAgICAgICAgICc8ZGl2IGlkPSJoZWFkZXIiPicgKwogICAgICAgICAgICAgICAgJyAgPGgxPjxzcGFuIGNsYXNzPSJhbmd1bGFyIj5Bbmd1bGFySlM8L3NwYW4+OiBTY2VuYXJpbyBUZXN0IFJ1bm5lcjwvaDE+JyArCiAgICAgICAgICAgICAgICAnICA8dWwgaWQ9InN0YXR1cy1sZWdlbmQiIGNsYXNzPSJzdGF0dXMtZGlzcGxheSI+JyArCiAgICAgICAgICAgICAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWVycm9yIj4wIEVycm9yczwvbGk+JyArCiAgICAgICAgICAgICAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWZhaWx1cmUiPjAgRmFpbHVyZXM8L2xpPicgKwogICAgICAgICAgICAgICAgJyAgICA8bGkgY2xhc3M9InN0YXR1cy1zdWNjZXNzIj4wIFBhc3NlZDwvbGk+JyArCiAgICAgICAgICAgICAgICAnICA8L3VsPicgKwogICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgJzxkaXYgaWQ9InNwZWNzIj4nICsKICAgICAgICAgICAgICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICApOwoKICAgICAgICBydW5uZXIub24oJ0ludGVyYWN0aXZlUGF1c2UnLCBmdW5jdGlvbiAoc3BlYykgewogICAgICAgICAgICB2YXIgdWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgICAgICAgICB1aS5maW5kKCcudGVzdC10aXRsZScpLgogICAgICAgICAgICAgICAgaHRtbCgncGF1c2VkLi4uIDxhIGhyZWY9ImphdmFzY3JpcHQ6cmVzdW1lKCkiPnJlc3VtZTwvYT4gd2hlbiByZWFkeS4nKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTcGVjQmVnaW4nLCBmdW5jdGlvbiAoc3BlYykgewogICAgICAgICAgICB2YXIgdWkgPSBmaW5kQ29udGV4dChzcGVjKTsKICAgICAgICAgICAgdWkuZmluZCgnPiAudGVzdHMnKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAnPGxpIGNsYXNzPSJzdGF0dXMtcGVuZGluZyB0ZXN0LWl0Ij48L2xpPicKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdWkgPSB1aS5maW5kKCc+IC50ZXN0cyBsaTpsYXN0Jyk7CiAgICAgICAgICAgIHVpLmFwcGVuZCgKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXN0LWluZm8iPicgKwogICAgICAgICAgICAgICAgICAgICcgIDxwIGNsYXNzPSJ0ZXN0LXRpdGxlIj4nICsKICAgICAgICAgICAgICAgICAgICAnICAgIDxzcGFuIGNsYXNzPSJ0aW1lci1yZXN1bHQiPjwvc3Bhbj4nICsKICAgICAgICAgICAgICAgICAgICAnICAgIDxzcGFuIGNsYXNzPSJ0ZXN0LW5hbWUiPjwvc3Bhbj4nICsKICAgICAgICAgICAgICAgICAgICAnICA8L3A+JyArCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJzY3JvbGxwYW5lIj4nICsKICAgICAgICAgICAgICAgICAgICAnICA8b2wgY2xhc3M9InRlc3QtYWN0aW9ucyI+PC9vbD4nICsKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JwogICAgICAgICAgICApOwogICAgICAgICAgICB1aS5maW5kKCc+IC50ZXN0LWluZm8gLnRlc3QtbmFtZScpLnRleHQoc3BlYy5uYW1lKTsKICAgICAgICAgICAgdWkuZmluZCgnPiAudGVzdC1pbmZvJykuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHNjcm9sbHBhbmUgPSB1aS5maW5kKCc+IC5zY3JvbGxwYW5lJyk7CiAgICAgICAgICAgICAgICB2YXIgYWN0aW9ucyA9IHNjcm9sbHBhbmUuZmluZCgnPiAudGVzdC1hY3Rpb25zJyk7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGNvbnRleHQuZmluZCgnPiAudGVzdC1pbmZvIC50ZXN0LW5hbWUnKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zLmZpbmQoJzp2aXNpYmxlJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9ucy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgbmFtZS5yZW1vdmVDbGFzcygnb3BlbicpLmFkZENsYXNzKCdjbG9zZWQnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9ucy5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxUb3AnLCBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbEhlaWdodCcpKTsKICAgICAgICAgICAgICAgICAgICBuYW1lLnJlbW92ZUNsYXNzKCdjbG9zZWQnKS5hZGRDbGFzcygnb3BlbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNwZWNVaU1hcFtzcGVjLmlkXSA9IHVpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1NwZWNFcnJvcicsIGZ1bmN0aW9uIChzcGVjLCBlcnJvcikgewogICAgICAgICAgICB2YXIgdWkgPSBzcGVjVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIHVpLmFwcGVuZCgnPHByZT48L3ByZT4nKTsKICAgICAgICAgICAgdWkuZmluZCgnPiBwcmUnKS50ZXh0KGZvcm1hdEV4Y2VwdGlvbihlcnJvcikpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1NwZWNFbmQnLCBmdW5jdGlvbiAoc3BlYykgewogICAgICAgICAgICB2YXIgdWkgPSBzcGVjVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIHNwZWMgPSBtb2RlbC5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICB1aS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgICAgICAgICAgdWkuYWRkQ2xhc3MoJ3N0YXR1cy0nICsgc3BlYy5zdGF0dXMpOwogICAgICAgICAgICB1aS5maW5kKCI+IC50ZXN0LWluZm8gLnRpbWVyLXJlc3VsdCIpLnRleHQoc3BlYy5kdXJhdGlvbiArICJtcyIpOwogICAgICAgICAgICBpZiAoc3BlYy5zdGF0dXMgPT09ICdzdWNjZXNzJykgewogICAgICAgICAgICAgICAgdWkuZmluZCgnPiAudGVzdC1pbmZvIC50ZXN0LW5hbWUnKS5hZGRDbGFzcygnY2xvc2VkJyk7CiAgICAgICAgICAgICAgICB1aS5maW5kKCc+IC5zY3JvbGxwYW5lIC50ZXN0LWFjdGlvbnMnKS5oaWRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlVG90YWxzKHNwZWMuc3RhdHVzKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwQmVnaW4nLCBmdW5jdGlvbiAoc3BlYywgc3RlcCkgewogICAgICAgICAgICB2YXIgdWkgPSBzcGVjVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIHNwZWMgPSBtb2RlbC5nZXRTcGVjKHNwZWMuaWQpOwogICAgICAgICAgICBzdGVwID0gc3BlYy5nZXRMYXN0U3RlcCgpOwogICAgICAgICAgICB1aS5maW5kKCc+IC5zY3JvbGxwYW5lIC50ZXN0LWFjdGlvbnMnKS5hcHBlbmQoJzxsaSBjbGFzcz0ic3RhdHVzLXBlbmRpbmciPjwvbGk+Jyk7CiAgICAgICAgICAgIHZhciBzdGVwVWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdID0gdWkuZmluZCgnPiAuc2Nyb2xscGFuZSAudGVzdC1hY3Rpb25zIGxpOmxhc3QnKTsKICAgICAgICAgICAgc3RlcFVpLmFwcGVuZCgKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0aW1lci1yZXN1bHQiPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXN0LXRpdGxlIj48L2Rpdj4nCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHN0ZXBVaS5maW5kKCc+IC50ZXN0LXRpdGxlJykudGV4dChzdGVwLm5hbWUpOwogICAgICAgICAgICB2YXIgc2Nyb2xscGFuZSA9IHN0ZXBVaS5wYXJlbnRzKCcuc2Nyb2xscGFuZScpOwogICAgICAgICAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1N0ZXBGYWlsdXJlJywgZnVuY3Rpb24gKHNwZWMsIHN0ZXAsIGVycm9yKSB7CiAgICAgICAgICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICAgICAgICAgIGFkZEVycm9yKHVpLCBzdGVwLmxpbmUsIGVycm9yKTsKICAgICAgICB9KTsKCiAgICAgICAgcnVubmVyLm9uKCdTdGVwRXJyb3InLCBmdW5jdGlvbiAoc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgICAgICAgICAgdmFyIHVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXTsKICAgICAgICAgICAgYWRkRXJyb3IodWksIHN0ZXAubGluZSwgZXJyb3IpOwogICAgICAgIH0pOwoKICAgICAgICBydW5uZXIub24oJ1N0ZXBFbmQnLCBmdW5jdGlvbiAoc3BlYywgc3RlcCkgewogICAgICAgICAgICB2YXIgc3RlcFVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXTsKICAgICAgICAgICAgc3BlYyA9IG1vZGVsLmdldFNwZWMoc3BlYy5pZCk7CiAgICAgICAgICAgIHN0ZXAgPSBzcGVjLmdldExhc3RTdGVwKCk7CiAgICAgICAgICAgIHN0ZXBVaS5maW5kKCcudGltZXItcmVzdWx0JykudGV4dChzdGVwLmR1cmF0aW9uICsgJ21zJyk7CiAgICAgICAgICAgIHN0ZXBVaS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgICAgICAgICAgc3RlcFVpLmFkZENsYXNzKCdzdGF0dXMtJyArIHN0ZXAuc3RhdHVzKTsKICAgICAgICAgICAgdmFyIHNjcm9sbHBhbmUgPSBzcGVjVWlNYXBbc3BlYy5pZF0uZmluZCgnPiAuc2Nyb2xscGFuZScpOwogICAgICAgICAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogICAgICAgIH0pOwoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB0aGUgY29udGV4dCBvZiBhIHNwZWMgYmxvY2sgZGVmaW5lZCBieSB0aGUgcGFzc2VkIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIGRlZmluaXRpb24gY3JlYXRlZCBieSB0aGUgRGVzY3JpYmUgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGZpbmRDb250ZXh0KHNwZWMpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb250ZXh0ID0gY29udGV4dC5maW5kKCcjc3BlY3MnKTsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKG1vZGVsLmdldERlZmluaXRpb25QYXRoKHNwZWMpLCBmdW5jdGlvbiAoZGVmbikgewogICAgICAgICAgICAgICAgdmFyIGlkID0gJ2Rlc2NyaWJlLScgKyBkZWZuLmlkOwogICAgICAgICAgICAgICAgaWYgKCFjb250ZXh0LmZpbmQoJyMnICsgaWQpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb250ZXh0LmZpbmQoJz4gLnRlc3QtY2hpbGRyZW4nKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXN0LWRlc2NyaWJlIiBpZD0iJyArIGlkICsgJyI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnICA8aDI+PC9oMj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAgPHVsIGNsYXNzPSJ0ZXN0cyI+PC91bD4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmZpbmQoJyMnICsgaWQpLmZpbmQoJz4gaDInKS50ZXh0KCdkZXNjcmliZTogJyArIGRlZm4ubmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Q29udGV4dCA9IGNvbnRleHQuZmluZCgnIycgKyBpZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY29udGV4dC5maW5kKCcjZGVzY3JpYmUtJyArIHNwZWMuZGVmaW5pdGlvbi5pZCk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBVcGRhdGVzIHRoZSB0ZXN0IGNvdW50ZXIgZm9yIHRoZSBzdGF0dXMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGhlIHN0YXR1cy4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUb3RhbHMoc3RhdHVzKSB7CiAgICAgICAgICAgIHZhciBsZWdlbmQgPSBjb250ZXh0LmZpbmQoJyNzdGF0dXMtbGVnZW5kIC5zdGF0dXMtJyArIHN0YXR1cyk7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IGxlZ2VuZC50ZXh0KCkuc3BsaXQoJyAnKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gKHBhcnRzWzBdICogMSkgKyAxOwogICAgICAgICAgICBsZWdlbmQudGV4dCh2YWx1ZSArICcgJyArIHBhcnRzWzFdKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEFkZCBhbiBlcnJvciB0byBhIHN0ZXAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIEpRdWVyeSB3cmFwcGVkIGNvbnRleHQKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuKCkgdGhhdCBzaG91bGQgcmV0dXJuIHRoZSBmaWxlL2xpbmUgbnVtYmVyIG9mIHRoZSBlcnJvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0aGUgZXJyb3IuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWRkRXJyb3IoY29udGV4dCwgbGluZSwgZXJyb3IpIHsKICAgICAgICAgICAgY29udGV4dC5maW5kKCcudGVzdC10aXRsZScpLmFwcGVuZCgnPHByZT48L3ByZT4nKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBfalF1ZXJ5LnRyaW0obGluZSgpICsgJ1xuXG4nICsgZm9ybWF0RXhjZXB0aW9uKGVycm9yKSk7CiAgICAgICAgICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUgcHJlOmxhc3QnKS50ZXh0KG1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogR2VuZXJhdGVzIEpTT04gb3V0cHV0IGludG8gYSBjb250ZXh0LgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCgnanNvbicsIGZ1bmN0aW9uIChjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgICAgICAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29udGV4dC50ZXh0KGFuZ3VsYXIudG9Kc29uKG1vZGVsLnZhbHVlKSk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBYTUwgb3V0cHV0IGludG8gYSBjb250ZXh0LgogICAgICovCiAgICBhbmd1bGFyLnNjZW5hcmlvLm91dHB1dCgneG1sJywgZnVuY3Rpb24gKGNvbnRleHQsIHJ1bm5lciwgbW9kZWwpIHsKICAgICAgICB2YXIgJCA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgY29udGV4dC5pbml0KGFyZ3MpOwogICAgICAgIH07CiAgICAgICAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNjZW5hcmlvID0gJCgnPHNjZW5hcmlvPjwvc2NlbmFyaW8+Jyk7CiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKHNjZW5hcmlvKTsKICAgICAgICAgICAgc2VyaWFsaXplWG1sKHNjZW5hcmlvLCBtb2RlbC52YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8qKgogICAgICAgICAqIENvbnZlcnQgdGhlIHRyZWUgaW50byBYTUwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCBqUXVlcnkgY29udGV4dCB0byBhZGQgdGhlIFhNTCB0by4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdHJlZSBub2RlIHRvIHNlcmlhbGl6ZQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHNlcmlhbGl6ZVhtbChjb250ZXh0LCB0cmVlKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0cmVlLmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgIHZhciBkZXNjcmliZUNvbnRleHQgPSAkKCc8ZGVzY3JpYmU+PC9kZXNjcmliZT4nKTsKICAgICAgICAgICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCdpZCcsIGNoaWxkLmlkKTsKICAgICAgICAgICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCduYW1lJywgY2hpbGQubmFtZSk7CiAgICAgICAgICAgICAgICBjb250ZXh0LmFwcGVuZChkZXNjcmliZUNvbnRleHQpOwogICAgICAgICAgICAgICAgc2VyaWFsaXplWG1sKGRlc2NyaWJlQ29udGV4dCwgY2hpbGQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGl0cyA9ICQoJzxpdHM+PC9pdHM+Jyk7CiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKGl0cyk7CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0cmVlLnNwZWNzLCBmdW5jdGlvbiAoc3BlYykgewogICAgICAgICAgICAgICAgdmFyIGl0ID0gJCgnPGl0PjwvaXQ+Jyk7CiAgICAgICAgICAgICAgICBpdC5hdHRyKCdpZCcsIHNwZWMuaWQpOwogICAgICAgICAgICAgICAgaXQuYXR0cignbmFtZScsIHNwZWMubmFtZSk7CiAgICAgICAgICAgICAgICBpdC5hdHRyKCdkdXJhdGlvbicsIHNwZWMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgaXQuYXR0cignc3RhdHVzJywgc3BlYy5zdGF0dXMpOwogICAgICAgICAgICAgICAgaXRzLmFwcGVuZChpdCk7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goc3BlYy5zdGVwcywgZnVuY3Rpb24gKHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcENvbnRleHQgPSAkKCc8c3RlcD48L3N0ZXA+Jyk7CiAgICAgICAgICAgICAgICAgICAgc3RlcENvbnRleHQuYXR0cignbmFtZScsIHN0ZXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgc3RlcENvbnRleHQuYXR0cignZHVyYXRpb24nLCBzdGVwLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICBzdGVwQ29udGV4dC5hdHRyKCdzdGF0dXMnLCBzdGVwLnN0YXR1cyk7CiAgICAgICAgICAgICAgICAgICAgaXQuYXBwZW5kKHN0ZXBDb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RlcC5lcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSAkKCc8ZXJyb3I+PC9lcnJvcj4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcENvbnRleHQuYXBwZW5kKGVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IudGV4dChmb3JtYXRFeGNlcHRpb24oc3RlcC5lcnJvcikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBnbG9iYWwgdmFsdWUgJHJlc3VsdCB3aXRoIHRoZSByZXN1bHQgb2YgdGhlIHJ1bm5lci4KICAgICAqLwogICAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ29iamVjdCcsIGZ1bmN0aW9uIChjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgICAgICAgcnVubmVyLiR3aW5kb3cuJHJlc3VsdCA9IG1vZGVsLnZhbHVlOwogICAgfSk7CgogICAgYmluZEpRdWVyeSgpOwogICAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICAgIHZhciAkcnVubmVyID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyKHdpbmRvdyksCiAgICAgICAgc2NyaXB0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKSwKICAgICAgICBzY3JpcHQgPSBzY3JpcHRzW3NjcmlwdHMubGVuZ3RoIC0gMV0sCiAgICAgICAgY29uZmlnID0ge307CgogICAgYW5ndWxhci5mb3JFYWNoKHNjcmlwdC5hdHRyaWJ1dGVzLCBmdW5jdGlvbiAoYXR0cikgewogICAgICAgIHZhciBtYXRjaCA9IGF0dHIubmFtZS5tYXRjaCgvbmdbOlwtXSguKikvKTsKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgY29uZmlnW21hdGNoWzFdXSA9IGF0dHIudmFsdWUgfHwgdHJ1ZTsKICAgICAgICB9CiAgICB9KTsKCiAgICBpZiAoY29uZmlnLmF1dG90ZXN0KSB7CiAgICAgICAgSlFMaXRlKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGFuZ3VsYXIuc2NlbmFyaW8uc2V0VXBBbmRSdW4oY29uZmlnKTsKICAgICAgICB9KTsKICAgIH0KfSkod2luZG93LCBkb2N1bWVudCk7Cgphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtcblxuW25nXFw6Y2xvYWtdLCBbbmctY2xvYWtdLCBbZGF0YS1uZy1jbG9ha10sIFt4LW5nLWNsb2FrXSxcbi5uZy1jbG9haywgLngtbmctY2xvYWsge1xuICBkaXNwbGF5OiBub25lO1xufVxuXG5uZ1xcOmZvcm0ge1xuICBkaXNwbGF5OiBibG9jaztcbn1cbjwvc3R5bGU+Jyk7CmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLmFwcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1xuLyogQ1NTIERvY3VtZW50ICovXG5cbi8qKiBTdHJ1Y3R1cmUgKi9cbmJvZHkge1xuICBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7XG4gIG1hcmdpbjogMDtcbiAgZm9udC1zaXplOiAxNHB4O1xufVxuXG4jc3lzdGVtLWVycm9yIHtcbiAgZm9udC1zaXplOiAxLjVlbTtcbiAgdGV4dC1hbGlnbjogY2VudGVyO1xufVxuXG4janNvbiwgI3htbCB7XG4gIGRpc3BsYXk6IG5vbmU7XG59XG5cbiNoZWFkZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIHdpZHRoOiAxMDAlO1xufVxuXG4jc3BlY3Mge1xuICBwYWRkaW5nLXRvcDogNTBweDtcbn1cblxuI2hlYWRlciAuYW5ndWxhciB7XG4gIGZvbnQtZmFtaWx5OiBDb3VyaWVyIE5ldywgbW9ub3NwYWNlO1xuICBmb250LXdlaWdodDogYm9sZDtcbn1cblxuI2hlYWRlciBoMSB7XG4gIGZvbnQtd2VpZ2h0OiBub3JtYWw7XG4gIGZsb2F0OiBsZWZ0O1xuICBmb250LXNpemU6IDMwcHg7XG4gIGxpbmUtaGVpZ2h0OiAzMHB4O1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDEwcHggMTBweDtcbiAgaGVpZ2h0OiAzMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaDIsXG4jc3BlY3MgaDIge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDAuNWVtO1xuICBmb250LXNpemU6IDEuMWVtO1xufVxuXG4jc3RhdHVzLWxlZ2VuZCB7XG4gIG1hcmdpbi10b3A6IDEwcHg7XG4gIG1hcmdpbi1yaWdodDogMTBweDtcbn1cblxuI2hlYWRlcixcbiNhcHBsaWNhdGlvbixcbi50ZXN0LWluZm8sXG4udGVzdC1hY3Rpb25zIGxpIHtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbn1cblxuI2FwcGxpY2F0aW9uIHtcbiAgbWFyZ2luOiAxMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgd2lkdGg6IDEwMCU7XG4gIGhlaWdodDogNzU4cHg7XG59XG5cbiNhcHBsaWNhdGlvbiAucG9wb3V0IHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgYm9yZGVyOiBub25lO1xufVxuXG4udGVzdHMgbGksXG4udGVzdC1hY3Rpb25zIGxpLFxuLnRlc3QtaXQgbGksXG4udGVzdC1pdCBvbCxcbi5zdGF0dXMtZGlzcGxheSB7XG4gIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTtcbn1cblxuLnRlc3RzLFxuLnRlc3QtaXQgb2wsXG4uc3RhdHVzLWRpc3BsYXkge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDA7XG59XG5cbi50ZXN0LWluZm8ge1xuICBtYXJnaW4tbGVmdDogMWVtO1xuICBtYXJnaW4tdG9wOiAwLjVlbTtcbiAgYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC13ZWJraXQtYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC1tb3otYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIGN1cnNvcjogcG9pbnRlcjtcbn1cblxuLnRlc3QtaW5mbzpob3ZlciAudGVzdC1uYW1lIHtcbiAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7XG59XG5cbi50ZXN0LWluZm8gLmNsb3NlZDpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMjViOFxcMDBBMFwnO1xufVxuXG4udGVzdC1pbmZvIC5vcGVuOmJlZm9yZSB7XG4gIGNvbnRlbnQ6IFwnXFwyNWJlXFwwMEEwXCc7XG4gIGZvbnQtd2VpZ2h0OiBib2xkO1xufVxuXG4udGVzdC1pdCBvbCB7XG4gIG1hcmdpbi1sZWZ0OiAyLjVlbTtcbn1cblxuLnN0YXR1cy1kaXNwbGF5LFxuLnN0YXR1cy1kaXNwbGF5IGxpIHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgbGkge1xuICBwYWRkaW5nOiA1cHggMTBweDtcbn1cblxuLnRpbWVyLXJlc3VsdCxcbi50ZXN0LXRpdGxlIHtcbiAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDRweDtcbn1cblxuLnRlc3QtYWN0aW9ucyAudGVzdC10aXRsZSxcbi50ZXN0LWFjdGlvbnMgLnRlc3QtcmVzdWx0IHtcbiAgZGlzcGxheTogdGFibGUtY2VsbDtcbiAgcGFkZGluZy1sZWZ0OiAwLjVlbTtcbiAgcGFkZGluZy1yaWdodDogMC41ZW07XG59XG5cbi50ZXN0LWFjdGlvbnMge1xuICBkaXNwbGF5OiB0YWJsZTtcbn1cblxuLnRlc3QtYWN0aW9ucyBsaSB7XG4gIGRpc3BsYXk6IHRhYmxlLXJvdztcbn1cblxuLnRpbWVyLXJlc3VsdCB7XG4gIHdpZHRoOiA0ZW07XG4gIHBhZGRpbmc6IDAgMTBweDtcbiAgdGV4dC1hbGlnbjogcmlnaHQ7XG4gIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7XG59XG5cbi50ZXN0LWl0IHByZSxcbi50ZXN0LWFjdGlvbnMgcHJlIHtcbiAgY2xlYXI6IGxlZnQ7XG4gIGNvbG9yOiBibGFjaztcbiAgbWFyZ2luLWxlZnQ6IDZlbTtcbn1cblxuLnRlc3QtZGVzY3JpYmUge1xuICBwYWRkaW5nLWJvdHRvbTogMC41ZW07XG59XG5cbi50ZXN0LWRlc2NyaWJlIC50ZXN0LWRlc2NyaWJlIHtcbiAgbWFyZ2luOiA1cHggNXB4IDEwcHggMmVtO1xufVxuXG4udGVzdC1hY3Rpb25zIC5zdGF0dXMtcGVuZGluZyAudGVzdC10aXRsZTpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMDBiYlxcMDBBMFwnO1xufVxuXG4uc2Nyb2xscGFuZSB7XG4gICBtYXgtaGVpZ2h0OiAyMGVtO1xuICAgb3ZlcmZsb3c6IGF1dG87XG59XG5cbi8qKiBDb2xvcnMgKi9cblxuI2hlYWRlciB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGMkMyMDA7XG59XG5cbiNzcGVjcyBoMiB7XG4gIGJvcmRlci10b3A6IDJweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4jc3BlY3MgaDIsXG4jYXBwbGljYXRpb24gaDIge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjZWZlZmVmO1xufVxuXG4jYXBwbGljYXRpb24ge1xuICBib3JkZXI6IDFweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4udGVzdC1kZXNjcmliZSAudGVzdC1kZXNjcmliZSB7XG4gIGJvcmRlci1sZWZ0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNCQUJBRDE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSB7XG4gIGJvcmRlcjogMXB4IHNvbGlkICM3Nzc7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXBlbmRpbmcsXG4uc3RhdHVzLXBlbmRpbmcgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGOUVFQkM7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXN1Y2Nlc3MsXG4uc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNCMUQ3QTE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWZhaWx1cmUsXG4uc3RhdHVzLWZhaWx1cmUgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGRjgyODY7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWVycm9yLFxuLnN0YXR1cy1lcnJvciAudGVzdC1pbmZvIHtcbiAgYmFja2dyb3VuZC1jb2xvcjogYmxhY2s7XG4gIGNvbG9yOiB3aGl0ZTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogIzMwQjMwQTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWZhaWx1cmUgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogI0RGMDAwMDtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWVycm9yIC50ZXN0LXRpdGxlIHtcbiAgY29sb3I6IGJsYWNrO1xufVxuXG4udGVzdC1hY3Rpb25zIC50aW1lci1yZXN1bHQge1xuICBjb2xvcjogIzg4ODtcbn1cbjwvc3R5bGU+Jyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:47:59 GMT",
                    "Content-Length": "1029081",
                    "Date": "Fri, 07 Nov 2014 19:48:00 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}