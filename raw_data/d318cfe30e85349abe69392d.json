{
    "url": "http://localhost:9999/cubing/tnoodle/mootools/WebContent/mootools/mootools-core-1.4.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/cubing/tnoodle/mootools/WebContent/mootools/mootools-core-1.4.2.js",
                "path": "/cubing/tnoodle/mootools/WebContent/mootools/mootools-core-1.4.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jdWJpbmcvdG5vb2RsZS9tb290b29scy9XZWJDb250ZW50L21vb3Rvb2xzL21vb3Rvb2xzLWNvcmUtMS40LjIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQ3NjAzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDIwOjI1OjE2IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAyMDoyNToxNSBHTVQNCg0KLy8gQkxXLURVQ1BIQU0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzkxZDdmMDAzNTZkY2Q0MmIyY2U4ZTU2ZDE3NzE0NTE4CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS40LjInLAoJYnVpbGQ6ICc1NTJkZmQ0NzA0ZmNjZmZlZDQ0NGUwMjExYzUwODMxYTJiZmUyMDlmJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5ICE9IG51bGwpIHJldHVybiBpdGVtLiRmYW1pbHkoKTsKCglpZiAoaXRlbS5ub2RlTmFtZSl7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMSkgcmV0dXJuICdlbGVtZW50JzsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAzKSByZXR1cm4gKC9cUy8pLnRlc3QoaXRlbS5ub2RlVmFsdWUpID8gJ3RleHRub2RlJyA6ICd3aGl0ZXNwYWNlJzsKCX0gZWxzZSBpZiAodHlwZW9mIGl0ZW0ubGVuZ3RoID09ICdudW1iZXInKXsKCQlpZiAoaXRlbS5jYWxsZWUpIHJldHVybiAnYXJndW1lbnRzJzsKCQlpZiAoJ2l0ZW0nIGluIGl0ZW0pIHJldHVybiAnY29sbGVjdGlvbic7Cgl9CgoJcmV0dXJuIHR5cGVvZiBpdGVtOwp9OwoKdmFyIGluc3RhbmNlT2YgPSB0aGlzLmluc3RhbmNlT2YgPSBmdW5jdGlvbihpdGVtLCBvYmplY3QpewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJdmFyIGNvbnN0cnVjdG9yID0gaXRlbS4kY29uc3RydWN0b3IgfHwgaXRlbS5jb25zdHJ1Y3RvcjsKCXdoaWxlIChjb25zdHJ1Y3Rvcil7CgkJaWYgKGNvbnN0cnVjdG9yID09PSBvYmplY3QpIHJldHVybiB0cnVlOwoJCWNvbnN0cnVjdG9yID0gY29uc3RydWN0b3IucGFyZW50OwoJfQoJcmV0dXJuIGl0ZW0gaW5zdGFuY2VvZiBvYmplY3Q7Cn07CgovLyBGdW5jdGlvbiBvdmVybG9hZGluZwoKdmFyIEZ1bmN0aW9uID0gdGhpcy5GdW5jdGlvbjsKCnZhciBlbnVtZXJhYmxlcyA9IHRydWU7CmZvciAodmFyIGkgaW4ge3RvU3RyaW5nOiAxfSkgZW51bWVyYWJsZXMgPSBudWxsOwppZiAoZW51bWVyYWJsZXMpIGVudW1lcmFibGVzID0gWydoYXNPd25Qcm9wZXJ0eScsICd2YWx1ZU9mJywgJ2lzUHJvdG90eXBlT2YnLCAncHJvcGVydHlJc0VudW1lcmFibGUnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9TdHJpbmcnLCAnY29uc3RydWN0b3InXTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZFNldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSwgYil7CgkJaWYgKGEgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgkJaWYgKHVzZVBsdXJhbCB8fCB0eXBlb2YgYSAhPSAnc3RyaW5nJyl7CgkJCWZvciAodmFyIGsgaW4gYSkgc2VsZi5jYWxsKHRoaXMsIGssIGFba10pOwoJCQlpZiAoZW51bWVyYWJsZXMpIGZvciAodmFyIGkgPSBlbnVtZXJhYmxlcy5sZW5ndGg7IGktLTspewoJCQkJayA9IGVudW1lcmFibGVzW2ldOwoJCQkJaWYgKGEuaGFzT3duUHJvcGVydHkoaykpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuY2FsbCh0aGlzLCBhLCBiKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLm92ZXJsb2FkR2V0dGVyID0gZnVuY3Rpb24odXNlUGx1cmFsKXsKCXZhciBzZWxmID0gdGhpczsKCXJldHVybiBmdW5jdGlvbihhKXsKCQl2YXIgYXJncywgcmVzdWx0OwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWlmIChhcmdzKXsKCQkJcmVzdWx0ID0ge307CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgcmVzdWx0W2FyZ3NbaV1dID0gc2VsZi5jYWxsKHRoaXMsIGFyZ3NbaV0pOwoJCX0gZWxzZSB7CgkJCXJlc3VsdCA9IHNlbGYuY2FsbCh0aGlzLCBhKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cn07CgpGdW5jdGlvbi5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSl7Cgl0aGlzW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKRnVuY3Rpb24ucHJvdG90eXBlLmltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpcy5wcm90b3R5cGVba2V5XSA9IHZhbHVlOwp9Lm92ZXJsb2FkU2V0dGVyKCk7CgovLyBGcm9tCgp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgpGdW5jdGlvbi5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKHR5cGVPZihpdGVtKSA9PSAnZnVuY3Rpb24nKSA/IGl0ZW0gOiBmdW5jdGlvbigpewoJCXJldHVybiBpdGVtOwoJfTsKfTsKCkFycmF5LmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBbXTsKCXJldHVybiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkgJiYgdHlwZW9mIGl0ZW0gIT0gJ3N0cmluZycpID8gKHR5cGVPZihpdGVtKSA9PSAnYXJyYXknKSA/IGl0ZW0gOiBzbGljZS5jYWxsKGl0ZW0pIDogW2l0ZW1dOwp9OwoKTnVtYmVyLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXZhciBudW1iZXIgPSBwYXJzZUZsb2F0KGl0ZW0pOwoJcmV0dXJuIGlzRmluaXRlKG51bWJlcikgPyBudW1iZXIgOiBudWxsOwp9OwoKU3RyaW5nLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtICsgJyc7Cn07CgovLyBoaWRlLCBwcm90ZWN0CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWhpZGU6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kaGlkZGVuID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJvdGVjdDogZnVuY3Rpb24oKXsKCQl0aGlzLiRwcm90ZWN0ZWQgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBUeXBlCgp2YXIgVHlwZSA9IHRoaXMuVHlwZSA9IGZ1bmN0aW9uKG5hbWUsIG9iamVjdCl7CglpZiAobmFtZSl7CgkJdmFyIGxvd2VyID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCXZhciB0eXBlQ2hlY2sgPSBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gbG93ZXIpOwoJCX07CgoJCVR5cGVbJ2lzJyArIG5hbWVdID0gdHlwZUNoZWNrOwoJCWlmIChvYmplY3QgIT0gbnVsbCl7CgkJCW9iamVjdC5wcm90b3R5cGUuJGZhbWlseSA9IChmdW5jdGlvbigpewoJCQkJcmV0dXJuIGxvd2VyOwoJCQl9KS5oaWRlKCk7CgkJCQoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwp9OwoKVHlwZS5pbXBsZW1lbnQoewoKCWltcGxlbWVudDogaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCksCgoJZXh0ZW5kOiBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKSwKCglhbGlhczogZnVuY3Rpb24obmFtZSwgZXhpc3RpbmcpewoJCWltcGxlbWVudC5jYWxsKHRoaXMsIG5hbWUsIHRoaXMucHJvdG90eXBlW2V4aXN0aW5nXSk7Cgl9Lm92ZXJsb2FkU2V0dGVyKCksCgoJbWlycm9yOiBmdW5jdGlvbihob29rKXsKCQlob29rc09mKHRoaXMpLnB1c2goaG9vayk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCm5ldyBUeXBlKCdUeXBlJywgVHlwZSk7CgovLyBEZWZhdWx0IFR5cGVzCgp2YXIgZm9yY2UgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QsIG1ldGhvZHMpewoJdmFyIGlzVHlwZSA9IChvYmplY3QgIT0gT2JqZWN0KSwKCQlwcm90b3R5cGUgPSBvYmplY3QucHJvdG90eXBlOwoKCWlmIChpc1R5cGUpIG9iamVjdCA9IG5ldyBUeXBlKG5hbWUsIG9iamVjdCk7CgoJZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGtleSA9IG1ldGhvZHNbaV0sCgkJCWdlbmVyaWMgPSBvYmplY3Rba2V5XSwKCQkJcHJvdG8gPSBwcm90b3R5cGVba2V5XTsKCgkJaWYgKGdlbmVyaWMpIGdlbmVyaWMucHJvdGVjdCgpOwoKCQlpZiAoaXNUeXBlICYmIHByb3RvKXsKCQkJZGVsZXRlIHByb3RvdHlwZVtrZXldOwoJCQlwcm90b3R5cGVba2V5XSA9IHByb3RvLnByb3RlY3QoKTsKCQl9Cgl9CgoJaWYgKGlzVHlwZSkgb2JqZWN0LmltcGxlbWVudChwcm90b3R5cGUpOwoKCXJldHVybiBmb3JjZTsKfTsKCmZvcmNlKCdTdHJpbmcnLCBTdHJpbmcsIFsKCSdjaGFyQXQnLCAnY2hhckNvZGVBdCcsICdjb25jYXQnLCAnaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdtYXRjaCcsICdxdW90ZScsICdyZXBsYWNlJywgJ3NlYXJjaCcsCgknc2xpY2UnLCAnc3BsaXQnLCAnc3Vic3RyJywgJ3N1YnN0cmluZycsICd0cmltJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7Ck9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJLyo8IUVTNT4qLwoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGggPj4+IDA7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBUeXBlLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpIHsKCnZhciBfa2V5cyA9IHt9OwoKdmFyIERPTUV2ZW50ID0gdGhpcy5ET01FdmVudCA9IG5ldyBUeXBlKCdET01FdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy5ldmVudCA9IGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdGhpcy5zaGlmdCA9IGV2ZW50LnNoaWZ0S2V5OwoJdGhpcy5jb250cm9sID0gZXZlbnQuY3RybEtleTsKCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJdGhpcy5tZXRhID0gZXZlbnQubWV0YUtleTsKCXZhciB0eXBlID0gdGhpcy50eXBlID0gZXZlbnQudHlwZTsKCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJdGhpcy50YXJnZXQgPSBkb2N1bWVudC5pZCh0YXJnZXQpOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpID09IDApewoJCXZhciBjb2RlID0gdGhpcy5jb2RlID0gKGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGUpOwoJCXRoaXMua2V5ID0gX2tleXNbY29kZV07CgkJLy8gVE9ETyAtIHdoeSBpcyB0aGlzIGlmIHN0YXRlbWVudCBoZXJlPwoJCS8vaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJaWYgKGNvZGUgPiAxMTEgJiYgY29kZSA8IDEyNCkgdGhpcy5rZXkgPSAnZicgKyAoY29kZSAtIDExMSk7CgkJCWVsc2UgaWYgKGNvZGUgPiA5NSAmJiBjb2RlIDwgMTA2KSB0aGlzLmtleSA9IGNvZGUgLSA5NjsKCQkvL30KCQkvLyBUT0RPIC0gd2hhdCdzIHRoZSByaWdodCBzb2x1dGlvbiBmb3IgdGhlIHdpbiBrZXlzPwoJCXZhciBXSU5MID0gOTE7CgkJdmFyIFdJTlIgPSA5MjsKCQl2YXIgTVVURSA9IDE3MjsKCQl2YXIgUExBWV9QQVVTRSA9IDE3OTsKCQlpZiAoY29kZSA9PSBXSU5MIHx8IGNvZGUgPT0gV0lOUiB8fCAoY29kZSA+PSBNVVRFICYmIGNvZGUgPD0gUExBWV9QQVVTRSkpIHsKCQkJY29kZSA9IDA7CgkJfQoJCXZhciBzcGVjaWFsS2V5cyA9IHsKCQkJMTA2OiAnKicsCgkJCTEwNzogJysnLAoJCQkxMDk6ICctJywKCQkJMTEwOiAnLicsCgkJCTExMTogJy8nLAoJCX07CgkJaWYgKGNvZGUgaW4gc3BlY2lhbEtleXMpIHsKCQkJdGhpcy5rZXkgPSBzcGVjaWFsS2V5c1tjb2RlXTsKCQl9CgoJCWlmICh0aGlzLmtleSA9PSBudWxsKSB0aGlzLmtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZSA9PSAnY2xpY2snIHx8IHR5cGUgPT0gJ2RibGNsaWNrJyB8fCB0eXBlID09ICdjb250ZXh0bWVudScgfHwgdHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUuaW5kZXhPZignbW91c2UnKSA9PSAwKXsKCQl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJdGhpcy5wYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJdGhpcy5jbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUgPT0gJ21vdXNld2hlZWwnKQoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCgkJdGhpcy5yaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMgfHwgZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICh0eXBlID09ICdtb3VzZW92ZXInIHx8IHR5cGUgPT0gJ21vdXNlb3V0Jyl7CgkJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQl0aGlzLnJlbGF0ZWRUYXJnZXQgPSBkb2N1bWVudC5pZChyZWxhdGVkKTsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZigndG91Y2gnKSA9PSAwIHx8IHR5cGUuaW5kZXhPZignZ2VzdHVyZScpID09IDApewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQl0aGlzLnBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJdGhpcy5jbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCWlmICghdGhpcy5jbGllbnQpIHRoaXMuY2xpZW50ID0ge307CglpZiAoIXRoaXMucGFnZSkgdGhpcy5wYWdlID0ge307Cn0pOwoKRE9NRXZlbnQuaW1wbGVtZW50KHsKCglzdG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnByZXZlbnREZWZhdWx0KCkuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KSB0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJZWxzZSB0aGlzLmV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkRPTUV2ZW50LmRlZmluZUtleSA9IGZ1bmN0aW9uKGNvZGUsIGtleSl7Cglfa2V5c1tjb2RlXSA9IGtleTsKCXJldHVybiB0aGlzOwp9OwoKRE9NRXZlbnQuZGVmaW5lS2V5cyA9IERPTUV2ZW50LmRlZmluZUtleS5vdmVybG9hZFNldHRlcih0cnVlKTsKCkRPTUV2ZW50LmRlZmluZUtleXMoewoJJzM4JzogJ3VwJywgJzQwJzogJ2Rvd24nLCAnMzcnOiAnbGVmdCcsICczOSc6ICdyaWdodCcsCgknMjcnOiAnZXNjJywgJzMyJzogJ3NwYWNlJywgJzgnOiAnYmFja3NwYWNlJywgJzknOiAndGFiJywKCSc0Nic6ICdkZWxldGUnLCAnMTMnOiAnZW50ZXInCn0pOwoKfSkoKTsKCgoKCgoKLyoKLS0tCgpuYW1lOiBDbGFzcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiBmb3IgZWFzaWx5IGNyZWF0aW5nLCBleHRlbmRpbmcsIGFuZCBpbXBsZW1lbnRpbmcgcmV1c2FibGUgQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyXQoKcHJvdmlkZXM6IENsYXNzCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIENsYXNzID0gdGhpcy5DbGFzcyA9IG5ldyBUeXBlKCdDbGFzcycsIGZ1bmN0aW9uKHBhcmFtcyl7CglpZiAoaW5zdGFuY2VPZihwYXJhbXMsIEZ1bmN0aW9uKSkgcGFyYW1zID0ge2luaXRpYWxpemU6IHBhcmFtc307CgoJdmFyIG5ld0NsYXNzID0gZnVuY3Rpb24oKXsKCQlyZXNldCh0aGlzKTsKCQlpZiAobmV3Q2xhc3MuJHByb3RvdHlwaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLiRjYWxsZXIgPSBudWxsOwoJCXZhciB2YWx1ZSA9ICh0aGlzLmluaXRpYWxpemUpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IHRoaXMuY2FsbGVyID0gbnVsbDsKCQlyZXR1cm4gdmFsdWU7Cgl9LmV4dGVuZCh0aGlzKS5pbXBsZW1lbnQocGFyYW1zKTsKCgluZXdDbGFzcy4kY29uc3RydWN0b3IgPSBDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS4kY29uc3RydWN0b3IgPSBuZXdDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS5wYXJlbnQgPSBwYXJlbnQ7CgoJcmV0dXJuIG5ld0NsYXNzOwp9KTsKCnZhciBwYXJlbnQgPSBmdW5jdGlvbigpewoJaWYgKCF0aGlzLiRjYWxsZXIpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAicGFyZW50IiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJdmFyIG5hbWUgPSB0aGlzLiRjYWxsZXIuJG5hbWUsCgkJcGFyZW50ID0gdGhpcy4kY2FsbGVyLiRvd25lci5wYXJlbnQsCgkJcHJldmlvdXMgPSAocGFyZW50KSA/IHBhcmVudC5wcm90b3R5cGVbbmFtZV0gOiBudWxsOwoJaWYgKCFwcmV2aW91cykgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsgbmFtZSArICciIGhhcyBubyBwYXJlbnQuJyk7CglyZXR1cm4gcHJldmlvdXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCnZhciByZXNldCA9IGZ1bmN0aW9uKG9iamVjdCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQl2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQlGLnByb3RvdHlwZSA9IHZhbHVlOwoJCQkJb2JqZWN0W2tleV0gPSByZXNldChuZXcgRik7CgkJCWJyZWFrOwoJCQljYXNlICdhcnJheSc6IG9iamVjdFtrZXldID0gdmFsdWUuY2xvbmUoKTsgYnJlYWs7CgkJfQoJfQoJcmV0dXJuIG9iamVjdDsKfTsKCnZhciB3cmFwID0gZnVuY3Rpb24oc2VsZiwga2V5LCBtZXRob2QpewoJaWYgKG1ldGhvZC4kb3JpZ2luKSBtZXRob2QgPSBtZXRob2QuJG9yaWdpbjsKCXZhciB3cmFwcGVyID0gZnVuY3Rpb24oKXsKCQlpZiAobWV0aG9kLiRwcm90ZWN0ZWQgJiYgdGhpcy4kY2FsbGVyID09IG51bGwpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIGtleSArICciIGNhbm5vdCBiZSBjYWxsZWQuJyk7CgkJdmFyIGNhbGxlciA9IHRoaXMuY2FsbGVyLCBjdXJyZW50ID0gdGhpcy4kY2FsbGVyOwoJCXRoaXMuY2FsbGVyID0gY3VycmVudDsgdGhpcy4kY2FsbGVyID0gd3JhcHBlcjsKCQl2YXIgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJdGhpcy4kY2FsbGVyID0gY3VycmVudDsgdGhpcy5jYWxsZXIgPSBjYWxsZXI7CgkJcmV0dXJuIHJlc3VsdDsKCX0uZXh0ZW5kKHskb3duZXI6IHNlbGYsICRvcmlnaW46IG1ldGhvZCwgJG5hbWU6IGtleX0pOwoJcmV0dXJuIHdyYXBwZXI7Cn07Cgp2YXIgaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgcmV0YWluKXsKCWlmIChDbGFzcy5NdXRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKXsKCQl2YWx1ZSA9IENsYXNzLk11dGF0b3JzW2tleV0uY2FsbCh0aGlzLCB2YWx1ZSk7CgkJaWYgKHZhbHVlID09IG51bGwpIHJldHVybiB0aGlzOwoJfQoKCWlmICh0eXBlT2YodmFsdWUpID09ICdmdW5jdGlvbicpewoJCWlmICh2YWx1ZS4kaGlkZGVuKSByZXR1cm4gdGhpczsKCQl0aGlzLnByb3RvdHlwZVtrZXldID0gKHJldGFpbikgPyB2YWx1ZSA6IHdyYXAodGhpcywga2V5LCB2YWx1ZSk7Cgl9IGVsc2UgewoJCU9iamVjdC5tZXJnZSh0aGlzLnByb3RvdHlwZSwga2V5LCB2YWx1ZSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbihrbGFzcyl7CglrbGFzcy4kcHJvdG90eXBpbmcgPSB0cnVlOwoJdmFyIHByb3RvID0gbmV3IGtsYXNzOwoJZGVsZXRlIGtsYXNzLiRwcm90b3R5cGluZzsKCXJldHVybiBwcm90bzsKfTsKCkNsYXNzLmltcGxlbWVudCgnaW1wbGVtZW50JywgaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCkpOwoKQ2xhc3MuTXV0YXRvcnMgPSB7CgoJRXh0ZW5kczogZnVuY3Rpb24ocGFyZW50KXsKCQl0aGlzLnBhcmVudCA9IHBhcmVudDsKCQl0aGlzLnByb3RvdHlwZSA9IGdldEluc3RhbmNlKHBhcmVudCk7Cgl9LAoKCUltcGxlbWVudHM6IGZ1bmN0aW9uKGl0ZW1zKXsKCQlBcnJheS5mcm9tKGl0ZW1zKS5lYWNoKGZ1bmN0aW9uKGl0ZW0pewoJCQl2YXIgaW5zdGFuY2UgPSBuZXcgaXRlbTsKCQkJZm9yICh2YXIga2V5IGluIGluc3RhbmNlKSBpbXBsZW1lbnQuY2FsbCh0aGlzLCBrZXksIGluc3RhbmNlW2tleV0sIHRydWUpOwoJCX0sIHRoaXMpOwoJfQp9OwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IENsYXNzLkV4dHJhcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIFV0aWxpdHkgQ2xhc3NlcyB0aGF0IGNhbiBiZSBpbXBsZW1lbnRlZCBpbnRvIHlvdXIgb3duIENsYXNzZXMgdG8gZWFzZSB0aGUgZXhlY3V0aW9uIG9mIG1hbnkgY29tbW9uIHRhc2tzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogQ2xhc3MKCnByb3ZpZGVzOiBbQ2xhc3MuRXh0cmFzLCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuQ2hhaW4gPSBuZXcgQ2xhc3MoewoKCSRjaGFpbjogW10sCgoJY2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uYXBwZW5kKEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbGxDaGFpbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMuJGNoYWluLmxlbmd0aCkgPyB0aGlzLiRjaGFpbi5zaGlmdCgpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBmYWxzZTsKCX0sCgoJY2xlYXJDaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5lbXB0eSgpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgcmVtb3ZlT24gPSBmdW5jdGlvbihzdHJpbmcpewoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9eb24oW0EtWl0pLywgZnVuY3Rpb24oZnVsbCwgZmlyc3QpewoJCXJldHVybiBmaXJzdC50b0xvd2VyQ2FzZSgpOwoJfSk7Cn07Cgp0aGlzLkV2ZW50cyA9IG5ldyBDbGFzcyh7CgoJJGV2ZW50czoge30sCgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuLCBpbnRlcm5hbCl7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoKCQkKCgkJdGhpcy4kZXZlbnRzW3R5cGVdID0gKHRoaXMuJGV2ZW50c1t0eXBlXSB8fCBbXSkuaW5jbHVkZShmbik7CgkJaWYgKGludGVybmFsKSBmbi5pbnRlcm5hbCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciB0eXBlIGluIGV2ZW50cykgdGhpcy5hZGRFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJZXZlbnRzLmVhY2goZnVuY3Rpb24oZm4pewoJCQlpZiAoZGVsYXkpIGZuLmRlbGF5KGRlbGF5LCB0aGlzLCBhcmdzKTsKCQkJZWxzZSBmbi5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB7CgkJCQlpZiAoaSBpbiBmbnMpIHsKCQkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnRoaXMuT3B0aW9ucyA9IG5ldyBDbGFzcyh7CgoJc2V0T3B0aW9uczogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IE9iamVjdC5tZXJnZS5hcHBseShudWxsLCBbe30sIHRoaXMub3B0aW9uc10uYXBwZW5kKGFyZ3VtZW50cykpOwoJCWlmICh0aGlzLmFkZEV2ZW50KSBmb3IgKHZhciBvcHRpb24gaW4gb3B0aW9ucyl7CgkJCWlmICh0eXBlT2Yob3B0aW9uc1tvcHRpb25dKSAhPSAnZnVuY3Rpb24nIHx8ICEoL15vbltBLVpdLykudGVzdChvcHRpb24pKSBjb250aW51ZTsKCQkJdGhpcy5hZGRFdmVudChvcHRpb24sIG9wdGlvbnNbb3B0aW9uXSk7CgkJCWRlbGV0ZSBvcHRpb25zW29wdGlvbl07CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQpuYW1lOiBTbGljay5QYXJzZXIKZGVzY3JpcHRpb246IFN0YW5kYWxvbmUgQ1NTMyBTZWxlY3RvciBwYXJzZXIKcHJvdmlkZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBwYXJzZWQsCglzZXBhcmF0b3JJbmRleCwKCWNvbWJpbmF0b3JJbmRleCwKCXJldmVyc2VkLAoJY2FjaGUgPSB7fSwKCXJldmVyc2VDYWNoZSA9IHt9LAoJcmVVbmVzY2FwZSA9IC9cXC9nOwoKdmFyIHBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgaXNSZXZlcnNlZCl7CglpZiAoZXhwcmVzc2lvbiA9PSBudWxsKSByZXR1cm4gbnVsbDsKCWlmIChleHByZXNzaW9uLlNsaWNrID09PSB0cnVlKSByZXR1cm4gZXhwcmVzc2lvbjsKCWV4cHJlc3Npb24gPSAoJycgKyBleHByZXNzaW9uKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJcmV2ZXJzZWQgPSAhIWlzUmV2ZXJzZWQ7Cgl2YXIgY3VycmVudENhY2hlID0gKHJldmVyc2VkKSA/IHJldmVyc2VDYWNoZSA6IGNhY2hlOwoJaWYgKGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSkgcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXTsKCXBhcnNlZCA9IHsKCQlTbGljazogdHJ1ZSwKCQlleHByZXNzaW9uczogW10sCgkJcmF3OiBleHByZXNzaW9uLAoJCXJldmVyc2U6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7CgkJfQoJfTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtwYXJzZWQucmF3XSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJcmV0dXJuICdcXCcgKyBtYXRjaDsKCX0pOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXwoOispKDx1bmljb2RlPispKD86XFwoKD86KD86KFtcIiddKShbXlxcMTNdKilcXDEzKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspKVxcKSk/KSIKCS5yZXBsYWNlKC88Y29tYmluYXRvcj4vLCAnWycgKyBlc2NhcGVSZWdFeHAoIj4rfmAhQCQlXiY9e31cXDs8LyIpICsgJ10nKQoJLnJlcGxhY2UoLzx1bmljb2RlPi9nLCAnKD86W1xcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKCS5yZXBsYWNlKC88dW5pY29kZTE+L2csICcoPzpbOlxcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKKTsKCmZ1bmN0aW9uIHBhcnNlcigKCXJhd01hdGNoLAoKCXNlcGFyYXRvciwKCWNvbWJpbmF0b3IsCgljb21iaW5hdG9yQ2hpbGRyZW4sCgoJdGFnTmFtZSwKCWlkLAoJY2xhc3NOYW1lLAoKCWF0dHJpYnV0ZUtleSwKCWF0dHJpYnV0ZU9wZXJhdG9yLAoJYXR0cmlidXRlUXVvdGUsCglhdHRyaWJ1dGVWYWx1ZSwKCglwc2V1ZG9NYXJrZXIsCglwc2V1ZG9DbGFzcywKCXBzZXVkb1F1b3RlLAoJcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZSwKCXBzZXVkb0NsYXNzVmFsdWUKKXsKCWlmIChzZXBhcmF0b3IgfHwgc2VwYXJhdG9ySW5kZXggPT09IC0xKXsKCQlwYXJzZWQuZXhwcmVzc2lvbnNbKytzZXBhcmF0b3JJbmRleF0gPSBbXTsKCQljb21iaW5hdG9ySW5kZXggPSAtMTsKCQlpZiAoc2VwYXJhdG9yKSByZXR1cm4gJyc7Cgl9CgoJaWYgKGNvbWJpbmF0b3IgfHwgY29tYmluYXRvckNoaWxkcmVuIHx8IGNvbWJpbmF0b3JJbmRleCA9PT0gLTEpewoJCWNvbWJpbmF0b3IgPSBjb21iaW5hdG9yIHx8ICcgJzsKCQl2YXIgY3VycmVudFNlcGFyYXRvciA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF07CgkJaWYgKHJldmVyc2VkICYmIGN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XSkKCQkJY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdLnJldmVyc2VDb21iaW5hdG9yID0gcmV2ZXJzZUNvbWJpbmF0b3IoY29tYmluYXRvcik7CgkJY3VycmVudFNlcGFyYXRvclsrK2NvbWJpbmF0b3JJbmRleF0gPSB7Y29tYmluYXRvcjogY29tYmluYXRvciwgdGFnOiAnKid9OwoJfQoKCXZhciBjdXJyZW50UGFyc2VkID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XVtjb21iaW5hdG9ySW5kZXhdOwoKCWlmICh0YWdOYW1lKXsKCQljdXJyZW50UGFyc2VkLnRhZyA9IHRhZ05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChpZCl7CgkJY3VycmVudFBhcnNlZC5pZCA9IGlkLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoY2xhc3NOYW1lKXsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc0xpc3QpIGN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0ID0gW107CgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzZXMpIGN1cnJlbnRQYXJzZWQuY2xhc3NlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0LnB1c2goY2xhc3NOYW1lKTsKCQljdXJyZW50UGFyc2VkLmNsYXNzZXMucHVzaCh7CgkJCXZhbHVlOiBjbGFzc05hbWUsCgkJCXJlZ2V4cDogbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBlc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArICcoXFxzfCQpJykKCQl9KTsKCgl9IGVsc2UgaWYgKHBzZXVkb0NsYXNzKXsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSB8fCBwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlOwoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlID8gcHNldWRvQ2xhc3NWYWx1ZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSA6IG51bGw7CgoJCWlmICghY3VycmVudFBhcnNlZC5wc2V1ZG9zKSBjdXJyZW50UGFyc2VkLnBzZXVkb3MgPSBbXTsKCQljdXJyZW50UGFyc2VkLnBzZXVkb3MucHVzaCh7CgkJCWtleTogcHNldWRvQ2xhc3MucmVwbGFjZShyZVVuZXNjYXBlLCAnJyksCgkJCXZhbHVlOiBwc2V1ZG9DbGFzc1ZhbHVlLAoJCQl0eXBlOiBwc2V1ZG9NYXJrZXIubGVuZ3RoID09IDEgPyAnY2xhc3MnIDogJ2VsZW1lbnQnCgkJfSk7CgoJfSBlbHNlIGlmIChhdHRyaWJ1dGVLZXkpewoJCWF0dHJpYnV0ZUtleSA9IGF0dHJpYnV0ZUtleS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCQlhdHRyaWJ1dGVWYWx1ZSA9IChhdHRyaWJ1dGVWYWx1ZSB8fCAnJykucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCXZhciB0ZXN0LCByZWdleHA7CgoJCXN3aXRjaCAoYXR0cmlidXRlT3BlcmF0b3IpewoJCQljYXNlICdePScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgICAgICAgICAgICApOyBicmVhazsKCQkJY2FzZSAnJD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgICAgICBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnJCcgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJ349JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICcoXnxcXHMpJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyhcXHN8JCknICk7IGJyZWFrOwoJCQljYXNlICd8PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoLXwkKScgICApOyBicmVhazsKCQkJY2FzZSAgJz0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSA9PSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyo9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuaW5kZXhPZihhdHRyaWJ1dGVWYWx1ZSkgPiAtMTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyE9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgIT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQlkZWZhdWx0ICAgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuICEhdmFsdWU7CgkJCX07CgkJfQoKCQlpZiAoYXR0cmlidXRlVmFsdWUgPT0gJycgJiYgKC9eWyokXl09JC8pLnRlc3QoYXR0cmlidXRlT3BlcmF0b3IpKSB0ZXN0ID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCWlmICghdGVzdCkgdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlICYmIHJlZ2V4cC50ZXN0KHZhbHVlKTsKCQl9OwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcykgY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzID0gW107CgkJY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzLnB1c2goewoJCQlrZXk6IGF0dHJpYnV0ZUtleSwKCQkJb3BlcmF0b3I6IGF0dHJpYnV0ZU9wZXJhdG9yLAoJCQl2YWx1ZTogYXR0cmlidXRlVmFsdWUsCgkJCXRlc3Q6IHRlc3QKCQl9KTsKCgl9CgoJcmV0dXJuICcnOwp9OwoKLy8gU2xpY2sgTlMKCnZhciBTbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7CglyZXR1cm4gcGFyc2UoZXhwcmVzc2lvbik7Cn07CgpTbGljay5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCWZlYXR1cmVzLmNvbnRhaW5zID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5jb250YWlucykpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50CgkJCQl8fCBxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0KCQkJCS8vVE9ETzogb25seSBza2lwIHdoZW4gZXhwcmVzc2lvbiBpcyBhY3R1YWxseSBtaXhlZCBjYXNlCgkJCQl8fCB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJCQkJfHwgKHRoaXMuYnJva2VuQ2hlY2tlZFFTQSAmJiBleHByZXNzaW9uLmluZGV4T2YoJzpjaGVja2VkJykgPiAtMSkKCQkJCXx8ICh0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkKCQkJCXx8ICghY29udGV4dElzRG9jdW1lbnQgLy9BYm9ydCB3aGVuICFjb250ZXh0SXNEb2N1bWVudCBhbmQuLi4KCQkJCQkvLyAgdGhlcmUgYXJlIG11bHRpcGxlIGV4cHJlc3Npb25zIGluIHRoZSBzZWxlY3RvcgoJCQkJCS8vICBzaW5jZSB3ZSBjdXJyZW50bHkgb25seSBmaXggbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EgZm9yIHNpbmdsZSBleHByZXNzaW9uIHNlbGVjdG9ycwoJCQkJCSYmIGV4cHJlc3Npb24uaW5kZXhPZignLCcpID4gLTEKCQkJCSkKCQkJCXx8IFNsaWNrLmRpc2FibGVRU0EKCQkJKSBicmVhayBxdWVyeVNlbGVjdG9yOwoKCQkJdmFyIF9leHByZXNzaW9uID0gZXhwcmVzc2lvbiwgX2NvbnRleHQgPSBjb250ZXh0OwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBfY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJyksIHNsaWNraWQgPSAnc2xpY2tpZF9fJzsKCQkJCV9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBzbGlja2lkKTsKCQkJCV9leHByZXNzaW9uID0gJyMnICsgc2xpY2tpZCArICcgJyArIF9leHByZXNzaW9uOwoJCQkJY29udGV4dCA9IF9jb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXRyeSB7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3IoX2V4cHJlc3Npb24pIHx8IG51bGw7CgkJCQllbHNlIG5vZGVzID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKF9leHByZXNzaW9uKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0gPSAxOwoJCQkJYnJlYWsgcXVlcnlTZWxlY3RvcjsKCQkJfSBmaW5hbGx5IHsKCQkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJCWlmIChjdXJyZW50SWQpIF9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBjdXJyZW50SWQpOwoJCQkJCWVsc2UgX2NvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJCWNvbnRleHQgPSBfY29udGV4dDsKCQkJCX0KCQkJfQoKCQkJaWYgKHRoaXMuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAobm9kZS5ub2RlTmFtZSA+ICdAJyAmJiAhKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCX0gZWxzZSBmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfQoKCQkJaWYgKGhhc090aGVycykgdGhpcy5zb3J0KGZvdW5kKTsKCQkJcmV0dXJuIGZvdW5kOwoKCQl9CgkJLyo8L3F1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghaGFzT3RoZXJzICYmIChmaXJzdCB8fCAocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSkpKSA/IHRoaXMucHVzaEFycmF5IDogdGhpcy5wdXNoVUlEOwoKCWlmIChmb3VuZCA9PSBudWxsKSBmb3VuZCA9IFtdOwoKCS8vIGRlZmF1bHQgZW5naW5lCgoJdmFyIGosIG0sIG47Cgl2YXIgY29tYmluYXRvciwgdGFnLCBpZCwgY2xhc3NMaXN0LCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zOwoJdmFyIGN1cnJlbnRJdGVtcywgY3VycmVudEV4cHJlc3Npb24sIGN1cnJlbnRCaXQsIGxhc3RCaXQsIGV4cHJlc3Npb25zID0gcGFyc2VkLmV4cHJlc3Npb25zOwoKCXNlYXJjaDogZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspIGZvciAoaiA9IDA7IChjdXJyZW50Qml0ID0gY3VycmVudEV4cHJlc3Npb25bal0pOyBqKyspewoKCQljb21iaW5hdG9yID0gJ2NvbWJpbmF0b3I6JyArIGN1cnJlbnRCaXQuY29tYmluYXRvcjsKCQlpZiAoIXRoaXNbY29tYmluYXRvcl0pIGNvbnRpbnVlIHNlYXJjaDsKCgkJdGFnICAgICAgICA9ICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gY3VycmVudEJpdC50YWcgOiBjdXJyZW50Qml0LnRhZy50b1VwcGVyQ2FzZSgpOwoJCWlkICAgICAgICAgPSBjdXJyZW50Qml0LmlkOwoJCWNsYXNzTGlzdCAgPSBjdXJyZW50Qml0LmNsYXNzTGlzdDsKCQljbGFzc2VzICAgID0gY3VycmVudEJpdC5jbGFzc2VzOwoJCWF0dHJpYnV0ZXMgPSBjdXJyZW50Qml0LmF0dHJpYnV0ZXM7CgkJcHNldWRvcyAgICA9IGN1cnJlbnRCaXQucHNldWRvczsKCQlsYXN0Qml0ICAgID0gKGogPT09IChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggLSAxKSk7CgoJCXRoaXMuYml0VW5pcXVlcyA9IHt9OwoKCQlpZiAobGFzdEJpdCl7CgkJCXRoaXMudW5pcXVlcyA9IHVuaXF1ZXM7CgkJCXRoaXMuZm91bmQgPSBmb3VuZDsKCQl9IGVsc2UgewoJCQl0aGlzLnVuaXF1ZXMgPSB7fTsKCQkJdGhpcy5mb3VuZCA9IFtdOwoJCX0KCgkJaWYgKGogPT09IDApewoJCQl0aGlzW2NvbWJpbmF0b3JdKGNvbnRleHQsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0ICYmIGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCX0gZWxzZSB7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0KSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKyl7CgkJCQl0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJCWlmIChmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQkJfSBlbHNlIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKSB0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQl9CgoJCWN1cnJlbnRJdGVtcyA9IHRoaXMuZm91bmQ7Cgl9CgoJLy8gc2hvdWxkIHNvcnQgaWYgdGhlcmUgYXJlIG5vZGVzIGluIGFwcGVuZCBhbmQgaWYgeW91IHBhc3MgbXVsdGlwbGUgZXhwcmVzc2lvbnMuCglpZiAoaGFzT3RoZXJzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljay11bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPSBub2RlTmFtZSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfSBlbHNlIHsKCQkJCWRvIHsKCQkJCQlpZiAoZWwubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfQoJCX0KCQlhcmd1bWVudCA9IGFyZ3VtZW50IHx8ICduJzsKCQl2YXIgcGFyc2VkID0gdGhpcy5jYWNoZU5USFthcmd1bWVudF0gfHwgdGhpcy5wYXJzZU5USEFyZ3VtZW50KGFyZ3VtZW50KTsKCQlpZiAoIXBhcnNlZCkgcmV0dXJuIGZhbHNlOwoJCXZhciBhID0gcGFyc2VkLmEsIGIgPSBwYXJzZWQuYiwgcG9zID0gdGhpc1twb3NpdGlvbnNdW3VpZF07CgkJaWYgKGEgPT0gMCkgcmV0dXJuIGIgPT0gcG9zOwoJCWlmIChhID4gMCl7CgkJCWlmIChwb3MgPCBiKSByZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaWYgKGIgPCBwb3MpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuICgocG9zIC0gYikgJSBhKSA9PSAwOwoJfTsKfTsKCi8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLy8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5wdXNoQXJyYXkgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpIHRoaXMuZm91bmQucHVzaChub2RlKTsKfTsKCmxvY2FsLnB1c2hVSUQgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCWlmICghdGhpcy51bmlxdWVzW3VpZF0gJiYgdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpKXsKCQl0aGlzLnVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwoJfQp9OwoKbG9jYWwubWF0Y2hOb2RlID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvci5jYWxsKG5vZGUsIHNlbGVjdG9yLnJlcGxhY2UoL1xbKFtePV0rKT1ccyooW14nIlxdXSs/KVxzKlxdL2csICdbJDE9IiQyIl0nKSk7CgkJfSBjYXRjaChtYXRjaEVycm9yKSB7fQoJfQoKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCBub2RlLmNsYXNzTmFtZTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghaXRlbSl7CgkJCQkJLy8gaWYgdGhlIGNvbnRleHQgaXMgaW4gdGhlIGRvbSB3ZSByZXR1cm4sIGVsc2Ugd2Ugd2lsbCB0cnkgR0VCVE4sIGJyZWFraW5nIHRoZSBnZXRCeUlkIGxhYmVsCgkJCQkJaWYgKHRoaXMuY29udGFpbnModGhpcy5yb290LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKTsKCX0sCgoJJysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJ14nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZmlyc3QgY2hpbGQKCQlub2RlID0gbm9kZS5maXJzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknKysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nIGFuZCBwcmV2aW91cyBzaWJsaW5nCgkJdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknfn4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncyBhbmQgcHJldmlvdXMgc2libGluZ3MKCQl0aGlzWydjb21iaW5hdG9yOn4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiF+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGFsbCBwYXJlbnQgbm9kZXMgdXAgdG8gZG9jdW1lbnQKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSBpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknIT4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IHBhcmVudCAob25lIGxldmVsKQoJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyErJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJyF+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfQoKfTsKCmZvciAodmFyIGMgaW4gY29tYmluYXRvcnMpIGxvY2FsWydjb21iaW5hdG9yOicgKyBjXSA9IGNvbWJpbmF0b3JzW2NdOwoKdmFyIHBzZXVkb3MgPSB7CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLwoKCSdlbXB0eSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKCQlyZXR1cm4gIShjaGlsZCAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxKSAmJiAhKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmxlbmd0aDsKCX0sCgoJJ25vdCc6IGZ1bmN0aW9uKG5vZGUsIGV4cHJlc3Npb24pewoJCXJldHVybiAhdGhpcy5tYXRjaE5vZGUobm9kZSwgZXhwcmVzc2lvbik7Cgl9LAoKCSdjb250YWlucyc6IGZ1bmN0aW9uKG5vZGUsIHRleHQpewoJCXJldHVybiAobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykuaW5kZXhPZih0ZXh0KSA+IC0xOwoJfSwKCgknZmlyc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybicpOwoJfSwKCgknb2RkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4rMScpOwoJfSwKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvKjxvZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZmlyc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZSwgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuICFub2RlLmRpc2FibGVkOwoJfSwKCgknZGlzYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2NoZWNrZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5jaGVja2VkIHx8IG5vZGUuc2VsZWN0ZWQ7Cgl9LAoKCSdmb2N1cyc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzLmlzSFRNTERvY3VtZW50ICYmIHRoaXMuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gbm9kZSAmJiAobm9kZS5ocmVmIHx8IG5vZGUudHlwZSB8fCB0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCAndGFiaW5kZXgnKSk7Cgl9LAoKCSdyb290JzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlID09PSB0aGlzLnJvb3QpOwoJfSwKCgknc2VsZWN0ZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5zZWxlY3RlZDsKCX0KCgkvKjwvcHNldWRvLXNlbGVjdG9ycz4qLwp9OwoKZm9yICh2YXIgcCBpbiBwc2V1ZG9zKSBsb2NhbFsncHNldWRvOicgKyBwXSA9IHBzZXVkb3NbcF07CgovLyBhdHRyaWJ1dGVzIG1ldGhvZHMKCnZhciBhdHRyaWJ1dGVHZXR0ZXJzID0gbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9LAoKCSdtYXhsZW5ndGgnOiBmdW5jdGlvbigpewoJCXZhciBhdHRyaWJ1dGVOb2RlID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdtYXhMZW5ndGgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfQoKfTsKCmF0dHJpYnV0ZUdldHRlcnMuTUFYTEVOR1RIID0gYXR0cmlidXRlR2V0dGVycy5tYXhMZW5ndGggPSBhdHRyaWJ1dGVHZXR0ZXJzLm1heGxlbmd0aDsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjYnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKU2xpY2suaGFzQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5oYXNBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE9iamVjdCwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIENocm9tZUVsZW1lbnQgPSBFbGVtZW50Oy8vIFRPRE8gLSBqZmx5CnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgYXR0ciwgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYoQ2hyb21lRWxlbWVudCkgewoJRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCA9IENocm9tZUVsZW1lbnQuQUxMT1dfS0VZQk9BUkRfSU5QVVQ7Ly8gVE9ETyAtIGpmbHkKfQoKCmlmIChCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoJLy8gSUU4IGFuZCBJRTkgcmVxdWlyZSB0aGUgd3JhcHBpbmcuCglFbGVtZW50LnByb3RvdHlwZS5fZmlyZUV2ZW50ID0gKGZ1bmN0aW9uKGZpcmVFdmVudCl7CgkJcmV0dXJuIGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJcmV0dXJuIGZpcmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGV2ZW50KTsKCQl9OwoJfSkoRWxlbWVudC5wcm90b3R5cGUuZmlyZUV2ZW50KTsKfQoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307CgoKCnZhciBJRnJhbWUgPSBuZXcgVHlwZSgnSUZyYW1lJywgZnVuY3Rpb24oKXsKCXZhciBwYXJhbXMgPSBBcnJheS5saW5rKGFyZ3VtZW50cywgewoJCXByb3BlcnRpZXM6IFR5cGUuaXNPYmplY3QsCgkJaWZyYW1lOiBmdW5jdGlvbihvYmopewoJCQlyZXR1cm4gKG9iaiAhPSBudWxsKTsKCQl9Cgl9KTsKCgl2YXIgcHJvcHMgPSBwYXJhbXMucHJvcGVydGllcyB8fCB7fSwgaWZyYW1lOwoJaWYgKHBhcmFtcy5pZnJhbWUpIGlmcmFtZSA9IGRvY3VtZW50LmlkKHBhcmFtcy5pZnJhbWUpOwoJdmFyIG9ubG9hZCA9IHByb3BzLm9ubG9hZCB8fCBmdW5jdGlvbigpe307CglkZWxldGUgcHJvcHMub25sb2FkOwoJcHJvcHMuaWQgPSBwcm9wcy5uYW1lID0gW3Byb3BzLmlkLCBwcm9wcy5uYW1lLCBpZnJhbWUgPyAoaWZyYW1lLmlkIHx8IGlmcmFtZS5uYW1lKSA6ICdJRnJhbWVfJyArIFN0cmluZy51bmlxdWVJRCgpXS5waWNrKCk7CglpZnJhbWUgPSBuZXcgRWxlbWVudChpZnJhbWUgfHwgJ2lmcmFtZScsIHByb3BzKTsKCgl2YXIgb25Mb2FkID0gZnVuY3Rpb24oKXsKCQlvbmxvYWQuY2FsbChpZnJhbWUuY29udGVudFdpbmRvdyk7Cgl9OwoKCWlmICh3aW5kb3cuZnJhbWVzW3Byb3BzLmlkXSkgb25Mb2FkKCk7CgllbHNlIGlmcmFtZS5hZGRMaXN0ZW5lcignbG9hZCcsIG9uTG9hZCk7CglyZXR1cm4gaWZyYW1lOwp9KTsKCnZhciBFbGVtZW50cyA9IHRoaXMuRWxlbWVudHMgPSBmdW5jdGlvbihub2Rlcyl7CglpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoKXsKCQl2YXIgdW5pcXVlcyA9IHt9LCBub2RlOwoJCWZvciAodmFyIGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQl2YXIgdWlkID0gU2xpY2sudWlkT2Yobm9kZSk7CgkJCWlmICghdW5pcXVlc1t1aWRdKXsKCQkJCXVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCQl0aGlzLnB1c2gobm9kZSk7CgkJCX0KCQl9Cgl9Cn07CgpFbGVtZW50cy5wcm90b3R5cGUgPSB7bGVuZ3RoOiAwfTsKRWxlbWVudHMucGFyZW50ID0gQXJyYXk7CgpuZXcgVHlwZSgnRWxlbWVudHMnLCBFbGVtZW50cykuaW1wbGVtZW50KHsKCglmaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlciwgYmluZCl7CgkJaWYgKCFmaWx0ZXIpIHJldHVybiB0aGlzOwoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZmlsdGVyKHRoaXMsICh0eXBlT2YoZmlsdGVyKSA9PSAnc3RyaW5nJykgPyBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0ubWF0Y2goZmlsdGVyKTsKCQl9IDogZmlsdGVyLCBiaW5kKSk7Cgl9LnByb3RlY3QoKSwKCglwdXNoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSB0aGlzW2xlbmd0aCsrXSA9IGl0ZW07CgkJfQoJCXJldHVybiAodGhpcy5sZW5ndGggPSBsZW5ndGgpOwoJfS5wcm90ZWN0KCksCgoJdW5zaGlmdDogZnVuY3Rpb24oKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSBpdGVtcy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gQXJyYXkucHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgaXRlbXMpOwoJfS5wcm90ZWN0KCksCgoJY29uY2F0OiBmdW5jdGlvbigpewoJCXZhciBuZXdFbGVtZW50cyA9IG5ldyBFbGVtZW50cyh0aGlzKTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGFyZ3VtZW50c1tpXTsKCQkJaWYgKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pKSBuZXdFbGVtZW50cy5hcHBlbmQoaXRlbSk7CgkJCWVsc2UgbmV3RWxlbWVudHMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIG5ld0VsZW1lbnRzOwoJfS5wcm90ZWN0KCksCgoJYXBwZW5kOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGNvbGxlY3Rpb24ubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLnB1c2goY29sbGVjdGlvbltpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl3aGlsZSAodGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzWy0tdGhpcy5sZW5ndGhdOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCkKCn0pOwoKCgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7Cgl2YXIgcmVzdWx0ID0gc3BsaWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl3aGlsZSAobGVuZ3RoID49IHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1tsZW5ndGgtLV07CglyZXR1cm4gcmVzdWx0Owp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCl7CgpTbGljay51aWRPZih3aW5kb3cpOwpTbGljay51aWRPZihkb2N1bWVudCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCVNsaWNrLnVpZE9mKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQllbC5fZmlyZUV2ZW50ID0gZWwuZmlyZUV2ZW50OwoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVuaXF1ZU51bWJlcikgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7Cgp2YXIgY29udGFpbnMgPSB7Y29udGFpbnM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJcmV0dXJuIFNsaWNrLmNvbnRhaW5zKHRoaXMsIGVsZW1lbnQpOwp9fTsKCmlmICghZG9jdW1lbnQuY29udGFpbnMpIERvY3VtZW50LmltcGxlbWVudChjb250YWlucyk7CmlmICghZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykuY29udGFpbnMpIEVsZW1lbnQuaW1wbGVtZW50KGNvbnRhaW5zKTsKCgoKLy8gdHJlZSB3YWxraW5nCgp2YXIgaW5qZWN0Q29tYmluYXRvciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpewoJaWYgKCFleHByZXNzaW9uKSByZXR1cm4gY29tYmluYXRvcjsKCglleHByZXNzaW9uID0gT2JqZWN0LmNsb25lKFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pKTsKCgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsgaS0tOykKCQlleHByZXNzaW9uc1tpXVswXS5jb21iaW5hdG9yID0gY29tYmluYXRvcjsKCglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldE5leHQ6ICd+JywKCWdldFByZXZpb3VzOiAnIX4nLAoJZ2V0UGFyZW50OiAnIScKfSwgZnVuY3Rpb24oY29tYmluYXRvciwgbWV0aG9kKXsKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZCwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIHRoaXMuZ2V0RWxlbWVudChpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldEFsbE5leHQ6ICd+JywKCWdldEFsbFByZXZpb3VzOiAnIX4nLAoJZ2V0U2libGluZ3M6ICd+ficsCglnZXRDaGlsZHJlbjogJz4nLAoJZ2V0UGFyZW50czogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnRzKGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgY29tYmluYXRvcikpOwoJfSk7Cn0pOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldEZpcnN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSlbMF0pOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSkuZ2V0TGFzdCgpKTsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm93bmVyRG9jdW1lbnQud2luZG93OwoJfSwKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50OwoJfSwKCglnZXRFbGVtZW50QnlJZDogZnVuY3Rpb24oaWQpewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsICcjJyArICgnJyArIGlkKS5yZXBsYWNlKC8oXFcpL2csICdcXCQxJykpKTsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKCgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgoKCi8vIGdldFByb3BlcnR5IC8gc2V0UHJvcGVydHkKCnZhciBwcm9wZXJ0eUdldHRlcnMgPSB7fSwgcHJvcGVydHlTZXR0ZXJzID0ge307CgovLyBwcm9wZXJ0aWVzCgp2YXIgcHJvcGVydGllcyA9IHt9OwpBcnJheS5mb3JFYWNoKFsKCSd0eXBlJywgJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsCgknZnJhbWVCb3JkZXInLCAncm93U3BhbicsICd0YWJJbmRleCcsICd1c2VNYXAnCl0sIGZ1bmN0aW9uKHByb3BlcnR5KXsKCXByb3BlcnRpZXNbcHJvcGVydHkudG9Mb3dlckNhc2UoKV0gPSBwcm9wZXJ0eTsKfSk7CgpPYmplY3QuYXBwZW5kKHByb3BlcnRpZXMsIHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCc6ICd0ZXh0Q29udGVudCc7Cgl9KSgpCn0pOwoKT2JqZWN0LmZvckVhY2gocHJvcGVydGllcywgZnVuY3Rpb24ocmVhbCwga2V5KXsKCXByb3BlcnR5U2V0dGVyc1trZXldID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGVbcmVhbF0gPSB2YWx1ZTsKCX07Cglwcm9wZXJ0eUdldHRlcnNba2V5XSA9IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlW3JlYWxdOwoJfTsKfSk7CgovLyBCb29sZWFucwoKdmFyIGJvb2xzID0gWwoJJ2NvbXBhY3QnLCAnbm93cmFwJywgJ2lzbWFwJywgJ2RlY2xhcmUnLCAnbm9zaGFkZScsICdjaGVja2VkJywKCSdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsICdub3Jlc2l6ZScsCgknZGVmZXInLCAnZGVmYXVsdENoZWNrZWQnLCAnYXV0b2ZvY3VzJywgJ2NvbnRyb2xzJywgJ2F1dG9wbGF5JywKCSdsb29wJwpdOwoKdmFyIGJvb2xlYW5zID0ge307CkFycmF5LmZvckVhY2goYm9vbHMsIGZ1bmN0aW9uKGJvb2wpewoJdmFyIGxvd2VyID0gYm9vbC50b0xvd2VyQ2FzZSgpOwoJYm9vbGVhbnNbbG93ZXJdID0gYm9vbDsKCXByb3BlcnR5U2V0dGVyc1tsb3dlcl0gPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZVtib29sXSA9ICEhdmFsdWU7Cgl9OwoJcHJvcGVydHlHZXR0ZXJzW2xvd2VyXSA9IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhIW5vZGVbYm9vbF07Cgl9Owp9KTsKCi8vIFNwZWNpYWwgY2FzZXMKCk9iamVjdC5hcHBlbmQocHJvcGVydHlTZXR0ZXJzLCB7CgoJJ2NsYXNzJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCSgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lID0gKHZhbHVlIHx8ICcnKSA6IG5vZGUuc2V0QXR0cmlidXRlKCdjbGFzcycsIHZhbHVlKTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkoJ2h0bWxGb3InIGluIG5vZGUpID8gbm9kZS5odG1sRm9yID0gdmFsdWUgOiBub2RlLnNldEF0dHJpYnV0ZSgnZm9yJywgdmFsdWUpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKG5vZGUuc3R5bGUpID8gbm9kZS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgOiBub2RlLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCB2YWx1ZSk7Cgl9LAoKCSd2YWx1ZSc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlLnZhbHVlID0gdmFsdWUgfHwgJyc7Cgl9Cgp9KTsKCnByb3BlcnR5R2V0dGVyc1snY2xhc3MnXSA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuICgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lIHx8IG51bGwgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKfTsKCi8qIDx3ZWJraXQ+ICovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwovLyBJRSBzZXRzIHR5cGUgYXMgcmVhZG9ubHkgYW5kIHRocm93cwp0cnkgeyBlbC50eXBlID0gJ2J1dHRvbic7IH0gY2F0Y2goZSl7fQppZiAoZWwudHlwZSAhPSAnYnV0dG9uJykgcHJvcGVydHlTZXR0ZXJzLnR5cGUgPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7Cglub2RlLnNldEF0dHJpYnV0ZSgndHlwZScsIHZhbHVlKTsKfTsKLyogPC93ZWJraXQ+ICovCgovKiBnZXRQcm9wZXJ0eSwgc2V0UHJvcGVydHkgKi8KCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXZhciBzZXR0ZXIgPSBwcm9wZXJ0eVNldHRlcnNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKCQlpZiAoc2V0dGVyKXsKCQkJc2V0dGVyKHRoaXMsIHZhbHVlKTsKCQl9IGVsc2UgewoJCQlpZiAodmFsdWUgPT0gbnVsbCkgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CgkJCWVsc2UgdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0UHJvcGVydGllczogZnVuY3Rpb24oYXR0cmlidXRlcyl7CgkJZm9yICh2YXIgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHRoaXMuc2V0UHJvcGVydHkoYXR0cmlidXRlLCBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJdmFyIGdldHRlciA9IHByb3BlcnR5R2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChnZXR0ZXIpIHJldHVybiBnZXR0ZXIodGhpcyk7CgkJdmFyIHJlc3VsdCA9IFNsaWNrLmdldEF0dHJpYnV0ZSh0aGlzLCBuYW1lKTsKCQlyZXR1cm4gKCFyZXN1bHQgJiYgIVNsaWNrLmhhc0F0dHJpYnV0ZSh0aGlzLCBuYW1lKSkgPyBudWxsIDogcmVzdWx0OwoJfSwKCglnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCXZhciBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwoJCXJldHVybiBhcmdzLm1hcCh0aGlzLmdldFByb3BlcnR5LCB0aGlzKS5hc3NvY2lhdGUoYXJncyk7Cgl9LAoKCXJlbW92ZVByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gdGhpcy5zZXRQcm9wZXJ0eShuYW1lLCBudWxsKTsKCX0sCgoJcmVtb3ZlUHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlBcnJheS5lYWNoKGFyZ3VtZW50cywgdGhpcy5yZW1vdmVQcm9wZXJ0eSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY2xlYW4oKS5jb250YWlucyhjbGFzc05hbWUsICcgJyk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZm9yY2UpewoJCWlmIChmb3JjZSA9PSBudWxsKSBmb3JjZSA9ICF0aGlzLmhhc0NsYXNzKGNsYXNzTmFtZSk7CgkJcmV0dXJuIChmb3JjZSkgPyB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSkgOiB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7Cgl9LAoKCWFkb3B0OiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnQgPSB0aGlzLCBmcmFnbWVudCwgZWxlbWVudHMgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyksIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCQlpZiAobGVuZ3RoID4gMSkgcGFyZW50ID0gZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnRzW2ldLCB0cnVlKTsKCQkJaWYgKGVsZW1lbnQpIHBhcmVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKCQl9CgoJCWlmIChmcmFnbWVudCkgdGhpcy5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCXJldHVybiB0aGlzOwoJfSwKCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0LCB3aGVyZSl7CgkJcmV0dXJuIHRoaXMuZ3JhYih0aGlzLmdldERvY3VtZW50KCkubmV3VGV4dE5vZGUodGV4dCksIHdoZXJlKTsKCX0sCgoJZ3JhYjogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbCl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcywgZWwpOwoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwczogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9IGRvY3VtZW50LmlkKGVsLCB0cnVlKTsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlcyhlbCkuZ3JhYihlbCwgd2hlcmUpOwoJfSwKCglnZXRTZWxlY3RlZDogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdGVkSW5kZXg7IC8vIFNhZmFyaSAzLjIuMQoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZnJvbSh0aGlzLm9wdGlvbnMpLmZpbHRlcihmdW5jdGlvbihvcHRpb24pewoJCQlyZXR1cm4gb3B0aW9uLnNlbGVjdGVkOwoJCX0pKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEVsZW1lbnRzKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgdHlwZSA9IGVsLnR5cGU7CgkJCWlmICghZWwubmFtZSB8fCBlbC5kaXNhYmxlZCB8fCB0eXBlID09ICdzdWJtaXQnIHx8IHR5cGUgPT0gJ3Jlc2V0JyB8fCB0eXBlID09ICdmaWxlJyB8fCB0eXBlID09ICdpbWFnZScpIHJldHVybjsKCgkJCXZhciB2YWx1ZSA9IChlbC5nZXQoJ3RhZycpID09ICdzZWxlY3QnKSA/IGVsLmdldFNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKG9wdCl7CgkJCQkvLyBJRQoJCQkJcmV0dXJuIGRvY3VtZW50LmlkKG9wdCkuZ2V0KCd2YWx1ZScpOwoJCQl9KSA6ICgodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgJiYgIWVsLmNoZWNrZWQpID8gbnVsbCA6IGVsLmdldCgndmFsdWUnKTsKCgkJCUFycmF5LmZyb20odmFsdWUpLmVhY2goZnVuY3Rpb24odmFsKXsKCQkJCWlmICh0eXBlb2YgdmFsICE9ICd1bmRlZmluZWQnKSBxdWVyeVN0cmluZy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChlbC5uYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgZm9ybVByb3BzID0ge2lucHV0OiAnY2hlY2tlZCcsIG9wdGlvbjogJ3NlbGVjdGVkJywgdGV4dGFyZWE6ICd2YWx1ZSd9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCl7CgkJdmFyIGNoaWxkcmVuID0gY2xlYW4odGhpcykuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlBcnJheS5lYWNoKGNoaWxkcmVuLCBjbGVhbik7CgkJRWxlbWVudC5kaXNwb3NlKHRoaXMpOwoJCXJldHVybiBudWxsOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlBcnJheS5mcm9tKHRoaXMuY2hpbGROb2RlcykuZWFjaChFbGVtZW50LmRpc3Bvc2UpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5wYXJlbnROb2RlKSA/IHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKSA6IHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cywga2VlcGlkKXsKCQljb250ZW50cyA9IGNvbnRlbnRzICE9PSBmYWxzZTsKCQl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGNlID0gW2Nsb25lXSwgdGUgPSBbdGhpc10sIGk7CgoJCWlmIChjb250ZW50cyl7CgkJCWNlLmFwcGVuZChBcnJheS5mcm9tKGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpKTsKCQkJdGUuYXBwZW5kKEFycmF5LmZyb20odGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJfQoKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspewoJCQl2YXIgbm9kZSA9IGNlW2ldLCBlbGVtZW50ID0gdGVbaV07CgkJCWlmICgha2VlcGlkKSBub2RlLnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKCQkJLyo8bHRJRTk+Ki8KCQkJaWYgKG5vZGUuY2xlYXJBdHRyaWJ1dGVzKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQkvKjwvbHRJRTk+Ki8KCQkJdmFyIHByb3AgPSBmb3JtUHJvcHNbZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCldOwoJCQlpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKCQl9CgoJCS8qPGx0SUU5PiovCgkJaWYgKEJyb3dzZXIuaWUpewoJCQl2YXIgY28gPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksIHRvID0gdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CgkJCWZvciAoaSA9IGNvLmxlbmd0aDsgaS0tOykgY29baV0ub3V0ZXJIVE1MID0gdG9baV0ub3V0ZXJIVE1MOwoJCX0KCQkvKjwvbHRJRTk+Ki8KCQlyZXR1cm4gZG9jdW1lbnQuaWQoY2xvbmUpOwoJfQoKfSk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFtTbGljay51aWRPZih0aGlzKV0gPSB0aGlzOwoJCX0KCQlpZiAodGhpcy5hZGRFdmVudExpc3RlbmVyKSB0aGlzLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKSB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmV0cmlldmU6IGZ1bmN0aW9uKHByb3BlcnR5LCBkZmx0KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KFNsaWNrLnVpZE9mKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJZGVsZXRlIHN0b3JhZ2VbcHJvcGVydHldOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKjxsdElFOT4qLwppZiAod2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbigpewoJT2JqZWN0LmVhY2goY29sbGVjdGVkLCBjbGVhbik7CglpZiAod2luZG93LkNvbGxlY3RHYXJiYWdlKSBDb2xsZWN0R2FyYmFnZSgpOwp9KTsKLyo8L2x0SUU5PiovCgpFbGVtZW50LlByb3BlcnRpZXMgPSB7fTsKCgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCi8qPCF3ZWJraXQ+Ki8KRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCS8qPGx0SUU5PiovCgkvLyB0ZWNobmlxdWUgYnkgamRiYXJsZXR0IC0gaHR0cDovL2pkYmFydGxldHQuY29tL2lubmVyc2hpdi8KCXdyYXBwZXIuaW5uZXJIVE1MID0gJzxuYXY+PC9uYXY+JzsKCXZhciBIVE1MNVRlc3QgPSB3cmFwcGVyLmNoaWxkTm9kZXMubGVuZ3RoID09IDE7CglpZiAoIUhUTUw1VGVzdCl7CgkJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIGwgPSB0YWdzLmxlbmd0aDsKCQl3aGlsZSAobC0tKSBmcmFnbWVudC5jcmVhdGVFbGVtZW50KHRhZ3NbbF0pOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJfQoJLyo8L2x0SUU5PiovCgoJdmFyIGh0bWwgPSB7CgkJc2V0OiBmdW5jdGlvbihodG1sKXsKCQkJaWYgKHR5cGVPZihodG1sKSA9PSAnYXJyYXknKSBodG1sID0gaHRtbC5qb2luKCcnKTsKCgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQkvKjxsdElFOT4qLwoJCQlpZiAoIXdyYXAgJiYgIUhUTUw1VGVzdCkgd3JhcCA9IFswLCAnJywgJyddOwoJCQkvKjwvbHRJRTk+Ki8KCQkJaWYgKHdyYXApewoJCQkJdmFyIGZpcnN0ID0gd3JhcHBlcjsKCQkJCWZpcnN0LmlubmVySFRNTCA9IHdyYXBbMV0gKyBodG1sICsgd3JhcFsyXTsKCQkJCWZvciAodmFyIGkgPSB3cmFwWzBdOyBpLS07KSBmaXJzdCA9IGZpcnN0LmZpcnN0Q2hpbGQ7CgkJCQl0aGlzLmVtcHR5KCkuYWRvcHQoZmlyc3QuY2hpbGROb2Rlcyk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmlubmVySFRNTCA9IGh0bWw7CgkJCX0KCQl9Cgl9OwoKCWh0bWwuZXJhc2UgPSBodG1sLnNldDsKCglyZXR1cm4gaHRtbDsKfSkoKTsKLyo8LyF3ZWJraXQ+Ki8KCi8qPGx0SUU5PiovCnZhciB0ZXN0Rm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2Zvcm0nKTsKdGVzdEZvcm0uaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbj5zPC9vcHRpb24+PC9zZWxlY3Q+JzsKCmlmICh0ZXN0Rm9ybS5maXJzdENoaWxkLnZhbHVlICE9ICdzJykgRWxlbWVudC5Qcm9wZXJ0aWVzLnZhbHVlID0gewoKCXNldDogZnVuY3Rpb24odmFsdWUpewoJCXZhciB0YWcgPSB0aGlzLmdldCgndGFnJyk7CgkJaWYgKHRhZyAhPSAnc2VsZWN0JykgcmV0dXJuIHRoaXMuc2V0UHJvcGVydHkoJ3ZhbHVlJywgdmFsdWUpOwoJCXZhciBvcHRpb25zID0gdGhpcy5nZXRFbGVtZW50cygnb3B0aW9uJyk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvcHRpb25zLmxlbmd0aDsgaSsrKXsKCQkJdmFyIG9wdGlvbiA9IG9wdGlvbnNbaV0sCgkJCQlhdHRyID0gb3B0aW9uLmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJyksCgkJCQlvcHRpb25WYWx1ZSA9IChhdHRyICYmIGF0dHIuc3BlY2lmaWVkKSA/IG9wdGlvbi52YWx1ZSA6IG9wdGlvbi5nZXQoJ3RleHQnKTsKCQkJaWYgKG9wdGlvblZhbHVlID09IHZhbHVlKSByZXR1cm4gb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTsKCQl9Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9uID0gdGhpcywgdGFnID0gb3B0aW9uLmdldCgndGFnJyk7CgoJCWlmICh0YWcgIT0gJ3NlbGVjdCcgJiYgdGFnICE9ICdvcHRpb24nKSByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eSgndmFsdWUnKTsKCgkJaWYgKHRhZyA9PSAnc2VsZWN0JyAmJiAhKG9wdGlvbiA9IG9wdGlvbi5nZXRTZWxlY3RlZCgpWzBdKSkgcmV0dXJuICcnOwoKCQl2YXIgYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpOwoJCXJldHVybiAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7Cgl9Cgp9OwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwppZiAoZWwuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKSkgRWxlbWVudC5Qcm9wZXJ0aWVzLmlkID0gewoJc2V0OiBmdW5jdGlvbihpZCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9IGlkOwoJfSwKCWdldDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5pZCB8fCBudWxsOwoJfSwKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuaWQgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykudmFsdWUgPSAnJzsKCX0KfTsKLyo8L0lFPiovCgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKSwKCWhhc0ZpbHRlciA9IChodG1sLnN0eWxlLmZpbHRlciAhPSBudWxsKSwKCXJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldFZpc2liaWxpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWVsZW1lbnQuc3RvcmUoJyRvcGFjaXR5Jywgb3BhY2l0eSk7CgllbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSBvcGFjaXR5ID4gMCA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwp9OwoKdmFyIHNldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJZWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gb3BhY2l0eTsKfSA6IChoYXNGaWx0ZXIgPyBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCW9wYWNpdHkgPSAob3BhY2l0eSAqIDEwMCkubGltaXQoMCwgMTAwKS5yb3VuZCgpOwoJb3BhY2l0eSA9IChvcGFjaXR5ID09IDEwMCkgPyAnJyA6ICdhbHBoYShvcGFjaXR5PScgKyBvcGFjaXR5ICsgJyknOwoJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgllbGVtZW50LnN0eWxlLmZpbHRlciA9IHJlQWxwaGEudGVzdChmaWx0ZXIpID8gZmlsdGVyLnJlcGxhY2UocmVBbHBoYSwgb3BhY2l0eSkgOiBmaWx0ZXIgKyBvcGFjaXR5Owp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlzZXRPcGFjaXR5KHRoaXMsIHBhcnNlRmxvYXQodmFsdWUpKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJaWYgKHByb3BlcnR5ID09ICdvcGFjaXR5JykgcmV0dXJuIGdldE9wYWNpdHkodGhpcyk7CgkJcHJvcGVydHkgPSAocHJvcGVydHkgPT0gJ2Zsb2F0JyA/IGZsb2F0TmFtZSA6IHByb3BlcnR5KS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKCgoKCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cywgaWYgbmVjZXNzYXJ5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50LCB0eXBlKSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlpZiAoY3VzdG9tLmJhc2UpIHJlYWxUeXBlID0gRnVuY3Rpb24uZnJvbShjdXN0b20uYmFzZSkuY2FsbCh0aGlzLCB0eXBlKTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IERPTUV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuLCBhcmd1bWVudHNbMl0pOwoJCX0KCQlldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZGVmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBsaXN0ID0gZXZlbnRzW3R5cGVdOwoJCXZhciBpbmRleCA9IGxpc3Qua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAoaW5kZXggPT0gLTEpIHJldHVybiB0aGlzOwoJCXZhciB2YWx1ZSA9IGxpc3QudmFsdWVzW2luZGV4XTsKCQlkZWxldGUgbGlzdC5rZXlzW2luZGV4XTsKCQlkZWxldGUgbGlzdC52YWx1ZXNbaW5kZXhdOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vblJlbW92ZSkgY3VzdG9tLm9uUmVtb3ZlLmNhbGwodGhpcywgZm4sIHR5cGUpOwoJCQlpZiAoY3VzdG9tLmJhc2UpIHR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIHBhc3RlOiAyLCBpbnB1dDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07CgpFbGVtZW50LkV2ZW50cyA9IHttb3VzZXdoZWVsOiB7CgliYXNlOiAoQnJvd3Nlci5maXJlZm94KSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKfX07CgppZiAoJ29ubW91c2VlbnRlcicgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KXsKCUVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlZW50ZXIgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50cy5tb3VzZWxlYXZlID0gMjsKfSBlbHNlIHsKCXZhciBjaGVjayA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CgkJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkJaWYgKCFyZWxhdGVkKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWVudGVyID0gewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07CgoJRWxlbWVudC5FdmVudHMubW91c2VsZWF2ZSA9IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07Cn0KCi8qPGx0SUU5PiovCmlmICghd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpewoJRWxlbWVudC5OYXRpdmVFdmVudHMucHJvcGVydHljaGFuZ2UgPSAyOwoJRWxlbWVudC5FdmVudHMuY2hhbmdlID0gewoJCWJhc2U6IGZ1bmN0aW9uKCl7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoJCQlyZXR1cm4gKHRoaXMuZ2V0KCd0YWcnKSA9PSAnaW5wdXQnICYmICh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSkgPyAncHJvcGVydHljaGFuZ2UnIDogJ2NoYW5nZScKCQl9LAoJCWNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gISEodGhpcy50eXBlICE9ICdyYWRpbycgfHwgdGhpcy5jaGVja2VkKTsKCQl9Cgl9Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9LCBzZWxlY3RvclRlc3QgPSBuZXcgUmVnRXhwKCdeJyArIHNlbGVjdG9yLmVzY2FwZVJlZ0V4cCgpICsgJyQnKTsKCQlBcnJheS5lYWNoKGRvY3VtZW50LnN0eWxlU2hlZXRzLCBmdW5jdGlvbihzaGVldCwgail7CgkJCXZhciBocmVmID0gc2hlZXQuaHJlZjsKCQkJaWYgKGhyZWYgJiYgaHJlZi5jb250YWlucygnOi8vJykgJiYgIWhyZWYuY29udGFpbnMoZG9jdW1lbnQuZG9tYWluKSkgcmV0dXJuOwoJCQl2YXIgcnVsZXMgPSBzaGVldC5ydWxlcyB8fCBzaGVldC5jc3NSdWxlczsKCQkJQXJyYXkuZWFjaChydWxlcywgZnVuY3Rpb24ocnVsZSwgaSl7CgkJCQlpZiAoIXJ1bGUuc3R5bGUpIHJldHVybjsKCQkJCXZhciBzZWxlY3RvclRleHQgPSAocnVsZS5zZWxlY3RvclRleHQpID8gcnVsZS5zZWxlY3RvclRleHQucmVwbGFjZSgvXlx3Ky8sIGZ1bmN0aW9uKG0pewoJCQkJCXJldHVybiBtLnRvTG93ZXJDYXNlKCk7CgkJCQl9KSA6IG51bGw7CgkJCQlpZiAoIXNlbGVjdG9yVGV4dCB8fCAhc2VsZWN0b3JUZXN0LnRlc3Qoc2VsZWN0b3JUZXh0KSkgcmV0dXJuOwoJCQkJT2JqZWN0LmVhY2goRWxlbWVudC5TdHlsZXMsIGZ1bmN0aW9uKHZhbHVlLCBzdHlsZSl7CgkJCQkJaWYgKCFydWxlLnN0eWxlW3N0eWxlXSB8fCBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmV0dXJuOwoJCQkJCXZhbHVlID0gU3RyaW5nKHJ1bGUuc3R5bGVbc3R5bGVdKTsKCQkJCQl0b1tzdHlsZV0gPSAoKC9ecmdiLykudGVzdCh2YWx1ZSkpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKCgoKLyoKLS0tCgpuYW1lOiBGeC5Ud2VlbgoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgQ1NTIHByb3BlcnR5IGZvciBhbiBlbGVtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogW0Z4LlR3ZWVuLCBFbGVtZW50LmZhZGUsIEVsZW1lbnQuaGlnaGxpZ2h0XQoKLi4uCiovCgpGeC5Ud2VlbiA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogRnguQ1NTLAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9IHRoaXMuc3ViamVjdCA9IGRvY3VtZW50LmlkKGVsZW1lbnQpOwoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJfSwKCglzZXQ6IGZ1bmN0aW9uKHByb3BlcnR5LCBub3cpewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCQlub3cgPSBwcm9wZXJ0eTsKCQkJcHJvcGVydHkgPSB0aGlzLnByb3BlcnR5IHx8IHRoaXMub3B0aW9ucy5wcm9wZXJ0eTsKCQl9CgkJdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwcm9wZXJ0eSwgbm93LCB0aGlzLm9wdGlvbnMudW5pdCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0eSwgZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0eSwgZnJvbSwgdG8pKSByZXR1cm4gdGhpczsKCQl2YXIgYXJncyA9IEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKTsKCQl0aGlzLnByb3BlcnR5ID0gdGhpcy5vcHRpb25zLnByb3BlcnR5IHx8IGFyZ3Muc2hpZnQoKTsKCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgdGhpcy5wcm9wZXJ0eSwgYXJncyk7CgkJcmV0dXJuIHRoaXMucGFyZW50KHBhcnNlZC5mcm9tLCBwYXJzZWQudG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMudHdlZW4gPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgndHdlZW4nKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHR3ZWVuID0gdGhpcy5yZXRyaWV2ZSgndHdlZW4nKTsKCQlpZiAoIXR3ZWVuKXsKCQkJdHdlZW4gPSBuZXcgRnguVHdlZW4odGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ3R3ZWVuJywgdHdlZW4pOwoJCX0KCQlyZXR1cm4gdHdlZW47Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXR3ZWVuOiBmdW5jdGlvbihwcm9wZXJ0eSwgZnJvbSwgdG8pewoJCXRoaXMuZ2V0KCd0d2VlbicpLnN0YXJ0KHByb3BlcnR5LCBmcm9tLCB0byk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZhZGU6IGZ1bmN0aW9uKGhvdyl7CgkJdmFyIGZhZGUgPSB0aGlzLmdldCgndHdlZW4nKSwgbWV0aG9kLCB0bywgdG9nZ2xlOwoJCWlmIChob3cgPT0gbnVsbCkgaG93ID0gJ3RvZ2dsZSc7CgkJc3dpdGNoIChob3cpewoJCQljYXNlICdpbic6IG1ldGhvZCA9ICdzdGFydCc7IHRvID0gMTsgYnJlYWs7CgkJCWNhc2UgJ291dCc6IG1ldGhvZCA9ICdzdGFydCc7IHRvID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBtZXRob2QgPSAnc2V0JzsgdG8gPSAxOyBicmVhazsKCQkJY2FzZSAnaGlkZSc6IG1ldGhvZCA9ICdzZXQnOyB0byA9IDA7IGJyZWFrOwoJCQljYXNlICd0b2dnbGUnOgoJCQkJdmFyIGZsYWcgPSB0aGlzLnJldHJpZXZlKCdmYWRlOmZsYWcnLCB0aGlzLmdldFN0eWxlKCdvcGFjaXR5JykgPT0gMSk7CgkJCQltZXRob2QgPSAnc3RhcnQnOwoJCQkJdG8gPSBmbGFnID8gMCA6IDE7CgkJCQl0aGlzLnN0b3JlKCdmYWRlOmZsYWcnLCAhZmxhZyk7CgkJCQl0b2dnbGUgPSB0cnVlOwoJCQlicmVhazsKCQkJZGVmYXVsdDogbWV0aG9kID0gJ3N0YXJ0JzsgdG8gPSBob3c7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJZmFkZVttZXRob2RdKCdvcGFjaXR5JywgdG8pOwoJCWlmIChtZXRob2QgPT0gJ3NldCcgfHwgdG8gIT0gMCkgdGhpcy5zZXRTdHlsZSgndmlzaWJpbGl0eScsIHRvID09IDAgPyAnaGlkZGVuJyA6ICd2aXNpYmxlJyk7CgkJZWxzZSBmYWRlLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgndmlzaWJpbGl0eScsICdoaWRkZW4nKTsKCQkJdGhpcy5jYWxsQ2hhaW4oKTsKCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGlnaGxpZ2h0OiBmdW5jdGlvbihzdGFydCwgZW5kKXsKCQlpZiAoIWVuZCl7CgkJCWVuZCA9IHRoaXMucmV0cmlldmUoJ2hpZ2hsaWdodDpvcmlnaW5hbCcsIHRoaXMuZ2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InKSk7CgkJCWVuZCA9IChlbmQgPT0gJ3RyYW5zcGFyZW50JykgPyAnI2ZmZicgOiBlbmQ7CgkJfQoJCXZhciB0d2VlbiA9IHRoaXMuZ2V0KCd0d2VlbicpOwoJCXR3ZWVuLnN0YXJ0KCdiYWNrZ3JvdW5kLWNvbG9yJywgc3RhcnQgfHwgJyNmZmZmODgnLCBlbmQpLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnKSk7CgkJCXR3ZWVuLmNhbGxDaGFpbigpOwoJCX0uYmluZCh0aGlzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4LlRyYW5zaXRpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgYSBzZXQgb2YgYWR2YW5jZWQgdHJhbnNpdGlvbnMgdG8gYmUgdXNlZCB3aXRoIGFueSBvZiB0aGUgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVhc2luZyBFcXVhdGlvbnMgYnkgUm9iZXJ0IFBlbm5lciwgPGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcvPiwgbW9kaWZpZWQgYW5kIG9wdGltaXplZCB0byBiZSB1c2VkIHdpdGggTW9vVG9vbHMuCgpyZXF1aXJlczogRngKCnByb3ZpZGVzOiBGeC5UcmFuc2l0aW9ucwoKLi4uCiovCgpGeC5pbXBsZW1lbnQoewoKCWdldFRyYW5zaXRpb246IGZ1bmN0aW9uKCl7CgkJdmFyIHRyYW5zID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gfHwgRnguVHJhbnNpdGlvbnMuU2luZS5lYXNlSW5PdXQ7CgkJaWYgKHR5cGVvZiB0cmFucyA9PSAnc3RyaW5nJyl7CgkJCXZhciBkYXRhID0gdHJhbnMuc3BsaXQoJzonKTsKCQkJdHJhbnMgPSBGeC5UcmFuc2l0aW9uczsKCQkJdHJhbnMgPSB0cmFuc1tkYXRhWzBdXSB8fCB0cmFuc1tkYXRhWzBdLmNhcGl0YWxpemUoKV07CgkJCWlmIChkYXRhWzFdKSB0cmFucyA9IHRyYW5zWydlYXNlJyArIGRhdGFbMV0uY2FwaXRhbGl6ZSgpICsgKGRhdGFbMl0gPyBkYXRhWzJdLmNhcGl0YWxpemUoKSA6ICcnKV07CgkJfQoJCXJldHVybiB0cmFuczsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBBcnJheS5mcm9tKHBhcmFtcyk7Cgl2YXIgZWFzZUluID0gZnVuY3Rpb24ocG9zKXsKCQlyZXR1cm4gdHJhbnNpdGlvbihwb3MsIHBhcmFtcyk7Cgl9OwoJcmV0dXJuIE9iamVjdC5hcHBlbmQoZWFzZUluLCB7CgkJZWFzZUluOiBlYXNlSW4sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSA/IHRyYW5zaXRpb24oMiAqIHBvcywgcGFyYW1zKSA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSkgLyAyOwoJCX0KCX0pOwp9OwoKRnguVHJhbnNpdGlvbnMgPSB7CgoJbGluZWFyOiBmdW5jdGlvbih6ZXJvKXsKCQlyZXR1cm4gemVybzsKCX0KCn07CgoKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdAoKZGVzY3JpcHRpb246IFBvd2VyZnVsIGFsbCBwdXJwb3NlIFJlcXVlc3QgQ2xhc3MuIFVzZXMgWE1MSFRUUFJlcXVlc3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbT2JqZWN0LCBFbGVtZW50LCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IFJlcXVlc3QKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZW1wdHkgPSBmdW5jdGlvbigpe30sCglwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoKCWxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdsb2Fkc3RhcnQnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzZW5kOiBmdW5jdGlvbihvcHRpb25zKXsKCQlpZiAoIXRoaXMuY2hlY2sob3B0aW9ucykpIHJldHVybiB0aGlzOwoKCQl0aGlzLm9wdGlvbnMuaXNTdWNjZXNzID0gdGhpcy5vcHRpb25zLmlzU3VjY2VzcyB8fCB0aGlzLmlzU3VjY2VzczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQl2YXIgdHlwZSA9IHR5cGVPZihvcHRpb25zKTsKCQlpZiAodHlwZSA9PSAnc3RyaW5nJyB8fCB0eXBlID09ICdlbGVtZW50Jykgb3B0aW9ucyA9IHtkYXRhOiBvcHRpb25zfTsKCgkJdmFyIG9sZCA9IHRoaXMub3B0aW9uczsKCQlvcHRpb25zID0gT2JqZWN0LmFwcGVuZCh7ZGF0YTogb2xkLmRhdGEsIHVybDogb2xkLnVybCwgbWV0aG9kOiBvbGQubWV0aG9kfSwgb3B0aW9ucyk7CgkJdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsIHVybCA9IFN0cmluZyhvcHRpb25zLnVybCksIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kLnRvTG93ZXJDYXNlKCk7CgoJCXN3aXRjaCAodHlwZU9mKGRhdGEpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGRhdGEgPSBkb2N1bWVudC5pZChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzogZGF0YSA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKGRhdGEpOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpewoJCQl2YXIgZm9ybWF0ID0gJ2Zvcm1hdD0nICsgdGhpcy5vcHRpb25zLmZvcm1hdDsKCQkJZGF0YSA9IChkYXRhKSA/IGZvcm1hdCArICcmJyArIGRhdGEgOiBmb3JtYXQ7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmVtdWxhdGlvbiAmJiAhWydnZXQnLCAncG9zdCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2Q7CgkJCWRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2Q7CgkJCW1ldGhvZCA9ICdwb3N0JzsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiBbJ3Bvc3QnLCAncHV0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuaGVhZGVyc1snQ29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nOwoJCX0KCgkJaWYgKCF1cmwpIHVybCA9IGRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lOwoKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQllbHNlIGlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cyhvcHRpb25zLmZpbHRlciB8fCAnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50czsKCQlpZiAob3B0aW9ucy51cGRhdGUpewoJCQl2YXIgdXBkYXRlID0gZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgdXBkYXRlLmFkb3B0KHJlc3BvbnNlLmVsZW1lbnRzKTsKCQkJZWxzZSB1cGRhdGUuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJfSBlbHNlIGlmIChvcHRpb25zLmFwcGVuZCl7CgkJCXZhciBhcHBlbmQgPSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UuZWxlbWVudHMucmV2ZXJzZSgpLmluamVjdChhcHBlbmQpOwoJCQllbHNlIGFwcGVuZC5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCX0KCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWVBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKCgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdCwgRWxlbWVudF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgp2YXIgU3dpZmYgPSBuZXcgQ2xhc3MoewoKICAgIEltcGxlbWVudHM6IE9wdGlvbnMsCgogICAgb3B0aW9uczogewogICAgICAgIGlkOiBudWxsLAogICAgICAgIGhlaWdodDogMSwKICAgICAgICB3aWR0aDogMSwKICAgICAgICBjb250YWluZXI6IG51bGwsCiAgICAgICAgcHJvcGVydGllczoge30sCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIHF1YWxpdHk6ICdoaWdoJywKICAgICAgICAgICAgYWxsb3dTY3JpcHRBY2Nlc3M6ICdhbHdheXMnLAogICAgICAgICAgICB3TW9kZTogJ3dpbmRvdycsCiAgICAgICAgICAgIHN3TGl2ZUNvbm5lY3Q6IHRydWUKICAgICAgICB9LAogICAgICAgIGNhbGxCYWNrczoge30sCiAgICAgICAgdmFyczoge30KICAgIH0sCgogICAgdG9FbGVtZW50OiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLm9iamVjdDsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ocGF0aCwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5pbnN0YW5jZSA9ICdTd2lmZl8nICsgU3RyaW5nLnVuaXF1ZUlEKCk7CiAgICAgICAgdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwogICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgdmFyIGlkID0gdGhpcy5pZCA9IG9wdGlvbnMuaWQgfHwgdGhpcy5pbnN0YW5jZTsKICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuaWQob3B0aW9ucy5jb250YWluZXIpOwoKICAgICAgICBTd2lmZi5DYWxsQmFja3NbdGhpcy5pbnN0YW5jZV0gPSB7fTsKCiAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnMucGFyYW1zLCB2YXJzID0gb3B0aW9ucy52YXJzLCBjYWxsQmFja3MgPSBvcHRpb25zLmNhbGxCYWNrczsKICAgICAgICB2YXIgcHJvcGVydGllcyA9IE9iamVjdC5hcHBlbmQoe2hlaWdodDogb3B0aW9ucy5oZWlnaHQsIHdpZHRoOiBvcHRpb25zLndpZHRofSwgb3B0aW9ucy5wcm9wZXJ0aWVzKTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBmb3IgKHZhciBjYWxsQmFjayBpbiBjYWxsQmFja3MpewogICAgICAgICAgICBTd2lmZi5DYWxsQmFja3NbdGhpcy5pbnN0YW5jZV1bY2FsbEJhY2tdID0gKGZ1bmN0aW9uKG9wdGlvbil7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uLmFwcGx5KHNlbGYub2JqZWN0LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkoY2FsbEJhY2tzW2NhbGxCYWNrXSk7CiAgICAgICAgICAgIHZhcnNbY2FsbEJhY2tdID0gJ1N3aWZmLkNhbGxCYWNrcy4nICsgdGhpcy5pbnN0YW5jZSArICcuJyArIGNhbGxCYWNrOwogICAgICAgIH0KCiAgICAgICAgcGFyYW1zLmZsYXNoVmFycyA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKHZhcnMpOwogICAgICAgIGlmIChCcm93c2VyLmllKXsKICAgICAgICAgICAgcHJvcGVydGllcy5jbGFzc2lkID0gJ2Nsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCc7CiAgICAgICAgICAgIHBhcmFtcy5tb3ZpZSA9IHBhdGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvcGVydGllcy50eXBlID0gJ2FwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoJzsKICAgICAgICB9CiAgICAgICAgcHJvcGVydGllcy5kYXRhID0gcGF0aDsKCiAgICAgICAgdmFyIGJ1aWxkID0gJzxvYmplY3QgaWQ9IicgKyBpZCArICciJzsKICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eSBpbiBwcm9wZXJ0aWVzKSBidWlsZCArPSAnICcgKyBwcm9wZXJ0eSArICc9IicgKyBwcm9wZXJ0aWVzW3Byb3BlcnR5XSArICciJzsKICAgICAgICBidWlsZCArPSAnPic7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKXsKICAgICAgICAgICAgaWYgKHBhcmFtc1twYXJhbV0pIGJ1aWxkICs9ICc8cGFyYW0gbmFtZT0iJyArIHBhcmFtICsgJyIgdmFsdWU9IicgKyBwYXJhbXNbcGFyYW1dICsgJyIgLz4nOwogICAgICAgIH0KICAgICAgICBidWlsZCArPSAnPC9vYmplY3Q+JzsKICAgICAgICB0aGlzLm9iamVjdCA9ICgoY29udGFpbmVyKSA/IGNvbnRhaW5lci5lbXB0eSgpIDogbmV3IEVsZW1lbnQoJ2RpdicpKS5zZXQoJ2h0bWwnLCBidWlsZCkuZmlyc3RDaGlsZDsKICAgIH0sCgogICAgcmVwbGFjZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKTsKICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMudG9FbGVtZW50KCksIGVsZW1lbnQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgICBkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVtb3RlOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5hcHBlbmQoYXJndW1lbnRzKSk7CiAgICB9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7CiAgICB2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwogICAgcmV0dXJuIGV2YWwocnMpOwp9OwoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovKjxsdElFOD4qLwovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCi8vIHRlc3RFbGVtZW50LmRvU2Nyb2xsKCkgdGhyb3dzIHdoZW4gdGhlIERPTSBpcyBub3QgcmVhZHksIG9ubHkgaW4gdGhlIHRvcCB3aW5kb3cKdmFyIGRvU2Nyb2xsV29ya3MgPSBmdW5jdGlvbigpewoJdHJ5IHsKCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCXJldHVybiB0cnVlOwoJfSBjYXRjaCAoZSl7fQoJcmV0dXJuIGZhbHNlOwp9OwovLyBJZiBkb1Njcm9sbCB3b3JrcyBhbHJlYWR5LCBpdCBjYW4ndCBiZSB1c2VkIHRvIGRldGVybWluZSBkb21yZWFkeQovLyAgIGUuZy4gaW4gYW4gaWZyYW1lCmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhZG9TY3JvbGxXb3JrcygpKXsKCWNoZWNrcy5wdXNoKGRvU2Nyb2xsV29ya3MpOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KLyo8L2x0SUU4PiovCgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoK",
                "body": "Ly8gQkxXLURVQ1BIQU0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzkxZDdmMDAzNTZkY2Q0MmIyY2U4ZTU2ZDE3NzE0NTE4CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS40LjInLAoJYnVpbGQ6ICc1NTJkZmQ0NzA0ZmNjZmZlZDQ0NGUwMjExYzUwODMxYTJiZmUyMDlmJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5ICE9IG51bGwpIHJldHVybiBpdGVtLiRmYW1pbHkoKTsKCglpZiAoaXRlbS5ub2RlTmFtZSl7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMSkgcmV0dXJuICdlbGVtZW50JzsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAzKSByZXR1cm4gKC9cUy8pLnRlc3QoaXRlbS5ub2RlVmFsdWUpID8gJ3RleHRub2RlJyA6ICd3aGl0ZXNwYWNlJzsKCX0gZWxzZSBpZiAodHlwZW9mIGl0ZW0ubGVuZ3RoID09ICdudW1iZXInKXsKCQlpZiAoaXRlbS5jYWxsZWUpIHJldHVybiAnYXJndW1lbnRzJzsKCQlpZiAoJ2l0ZW0nIGluIGl0ZW0pIHJldHVybiAnY29sbGVjdGlvbic7Cgl9CgoJcmV0dXJuIHR5cGVvZiBpdGVtOwp9OwoKdmFyIGluc3RhbmNlT2YgPSB0aGlzLmluc3RhbmNlT2YgPSBmdW5jdGlvbihpdGVtLCBvYmplY3QpewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwoJdmFyIGNvbnN0cnVjdG9yID0gaXRlbS4kY29uc3RydWN0b3IgfHwgaXRlbS5jb25zdHJ1Y3RvcjsKCXdoaWxlIChjb25zdHJ1Y3Rvcil7CgkJaWYgKGNvbnN0cnVjdG9yID09PSBvYmplY3QpIHJldHVybiB0cnVlOwoJCWNvbnN0cnVjdG9yID0gY29uc3RydWN0b3IucGFyZW50OwoJfQoJcmV0dXJuIGl0ZW0gaW5zdGFuY2VvZiBvYmplY3Q7Cn07CgovLyBGdW5jdGlvbiBvdmVybG9hZGluZwoKdmFyIEZ1bmN0aW9uID0gdGhpcy5GdW5jdGlvbjsKCnZhciBlbnVtZXJhYmxlcyA9IHRydWU7CmZvciAodmFyIGkgaW4ge3RvU3RyaW5nOiAxfSkgZW51bWVyYWJsZXMgPSBudWxsOwppZiAoZW51bWVyYWJsZXMpIGVudW1lcmFibGVzID0gWydoYXNPd25Qcm9wZXJ0eScsICd2YWx1ZU9mJywgJ2lzUHJvdG90eXBlT2YnLCAncHJvcGVydHlJc0VudW1lcmFibGUnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9TdHJpbmcnLCAnY29uc3RydWN0b3InXTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZFNldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSwgYil7CgkJaWYgKGEgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgkJaWYgKHVzZVBsdXJhbCB8fCB0eXBlb2YgYSAhPSAnc3RyaW5nJyl7CgkJCWZvciAodmFyIGsgaW4gYSkgc2VsZi5jYWxsKHRoaXMsIGssIGFba10pOwoJCQlpZiAoZW51bWVyYWJsZXMpIGZvciAodmFyIGkgPSBlbnVtZXJhYmxlcy5sZW5ndGg7IGktLTspewoJCQkJayA9IGVudW1lcmFibGVzW2ldOwoJCQkJaWYgKGEuaGFzT3duUHJvcGVydHkoaykpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuY2FsbCh0aGlzLCBhLCBiKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLm92ZXJsb2FkR2V0dGVyID0gZnVuY3Rpb24odXNlUGx1cmFsKXsKCXZhciBzZWxmID0gdGhpczsKCXJldHVybiBmdW5jdGlvbihhKXsKCQl2YXIgYXJncywgcmVzdWx0OwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWlmIChhcmdzKXsKCQkJcmVzdWx0ID0ge307CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgcmVzdWx0W2FyZ3NbaV1dID0gc2VsZi5jYWxsKHRoaXMsIGFyZ3NbaV0pOwoJCX0gZWxzZSB7CgkJCXJlc3VsdCA9IHNlbGYuY2FsbCh0aGlzLCBhKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cn07CgpGdW5jdGlvbi5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSl7Cgl0aGlzW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKRnVuY3Rpb24ucHJvdG90eXBlLmltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpcy5wcm90b3R5cGVba2V5XSA9IHZhbHVlOwp9Lm92ZXJsb2FkU2V0dGVyKCk7CgovLyBGcm9tCgp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgpGdW5jdGlvbi5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKHR5cGVPZihpdGVtKSA9PSAnZnVuY3Rpb24nKSA/IGl0ZW0gOiBmdW5jdGlvbigpewoJCXJldHVybiBpdGVtOwoJfTsKfTsKCkFycmF5LmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBbXTsKCXJldHVybiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkgJiYgdHlwZW9mIGl0ZW0gIT0gJ3N0cmluZycpID8gKHR5cGVPZihpdGVtKSA9PSAnYXJyYXknKSA/IGl0ZW0gOiBzbGljZS5jYWxsKGl0ZW0pIDogW2l0ZW1dOwp9OwoKTnVtYmVyLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXZhciBudW1iZXIgPSBwYXJzZUZsb2F0KGl0ZW0pOwoJcmV0dXJuIGlzRmluaXRlKG51bWJlcikgPyBudW1iZXIgOiBudWxsOwp9OwoKU3RyaW5nLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtICsgJyc7Cn07CgovLyBoaWRlLCBwcm90ZWN0CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWhpZGU6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kaGlkZGVuID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJvdGVjdDogZnVuY3Rpb24oKXsKCQl0aGlzLiRwcm90ZWN0ZWQgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBUeXBlCgp2YXIgVHlwZSA9IHRoaXMuVHlwZSA9IGZ1bmN0aW9uKG5hbWUsIG9iamVjdCl7CglpZiAobmFtZSl7CgkJdmFyIGxvd2VyID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCXZhciB0eXBlQ2hlY2sgPSBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gbG93ZXIpOwoJCX07CgoJCVR5cGVbJ2lzJyArIG5hbWVdID0gdHlwZUNoZWNrOwoJCWlmIChvYmplY3QgIT0gbnVsbCl7CgkJCW9iamVjdC5wcm90b3R5cGUuJGZhbWlseSA9IChmdW5jdGlvbigpewoJCQkJcmV0dXJuIGxvd2VyOwoJCQl9KS5oaWRlKCk7CgkJCQoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwp9OwoKVHlwZS5pbXBsZW1lbnQoewoKCWltcGxlbWVudDogaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCksCgoJZXh0ZW5kOiBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKSwKCglhbGlhczogZnVuY3Rpb24obmFtZSwgZXhpc3RpbmcpewoJCWltcGxlbWVudC5jYWxsKHRoaXMsIG5hbWUsIHRoaXMucHJvdG90eXBlW2V4aXN0aW5nXSk7Cgl9Lm92ZXJsb2FkU2V0dGVyKCksCgoJbWlycm9yOiBmdW5jdGlvbihob29rKXsKCQlob29rc09mKHRoaXMpLnB1c2goaG9vayk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCm5ldyBUeXBlKCdUeXBlJywgVHlwZSk7CgovLyBEZWZhdWx0IFR5cGVzCgp2YXIgZm9yY2UgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QsIG1ldGhvZHMpewoJdmFyIGlzVHlwZSA9IChvYmplY3QgIT0gT2JqZWN0KSwKCQlwcm90b3R5cGUgPSBvYmplY3QucHJvdG90eXBlOwoKCWlmIChpc1R5cGUpIG9iamVjdCA9IG5ldyBUeXBlKG5hbWUsIG9iamVjdCk7CgoJZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGtleSA9IG1ldGhvZHNbaV0sCgkJCWdlbmVyaWMgPSBvYmplY3Rba2V5XSwKCQkJcHJvdG8gPSBwcm90b3R5cGVba2V5XTsKCgkJaWYgKGdlbmVyaWMpIGdlbmVyaWMucHJvdGVjdCgpOwoKCQlpZiAoaXNUeXBlICYmIHByb3RvKXsKCQkJZGVsZXRlIHByb3RvdHlwZVtrZXldOwoJCQlwcm90b3R5cGVba2V5XSA9IHByb3RvLnByb3RlY3QoKTsKCQl9Cgl9CgoJaWYgKGlzVHlwZSkgb2JqZWN0LmltcGxlbWVudChwcm90b3R5cGUpOwoKCXJldHVybiBmb3JjZTsKfTsKCmZvcmNlKCdTdHJpbmcnLCBTdHJpbmcsIFsKCSdjaGFyQXQnLCAnY2hhckNvZGVBdCcsICdjb25jYXQnLCAnaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdtYXRjaCcsICdxdW90ZScsICdyZXBsYWNlJywgJ3NlYXJjaCcsCgknc2xpY2UnLCAnc3BsaXQnLCAnc3Vic3RyJywgJ3N1YnN0cmluZycsICd0cmltJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7Ck9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJLyo8IUVTNT4qLwoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGggPj4+IDA7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKCgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBUeXBlLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpIHsKCnZhciBfa2V5cyA9IHt9OwoKdmFyIERPTUV2ZW50ID0gdGhpcy5ET01FdmVudCA9IG5ldyBUeXBlKCdET01FdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy5ldmVudCA9IGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdGhpcy5zaGlmdCA9IGV2ZW50LnNoaWZ0S2V5OwoJdGhpcy5jb250cm9sID0gZXZlbnQuY3RybEtleTsKCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJdGhpcy5tZXRhID0gZXZlbnQubWV0YUtleTsKCXZhciB0eXBlID0gdGhpcy50eXBlID0gZXZlbnQudHlwZTsKCXZhciB0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCXdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09IDMpIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJdGhpcy50YXJnZXQgPSBkb2N1bWVudC5pZCh0YXJnZXQpOwoKCWlmICh0eXBlLmluZGV4T2YoJ2tleScpID09IDApewoJCXZhciBjb2RlID0gdGhpcy5jb2RlID0gKGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGUpOwoJCXRoaXMua2V5ID0gX2tleXNbY29kZV07CgkJLy8gVE9ETyAtIHdoeSBpcyB0aGlzIGlmIHN0YXRlbWVudCBoZXJlPwoJCS8vaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJaWYgKGNvZGUgPiAxMTEgJiYgY29kZSA8IDEyNCkgdGhpcy5rZXkgPSAnZicgKyAoY29kZSAtIDExMSk7CgkJCWVsc2UgaWYgKGNvZGUgPiA5NSAmJiBjb2RlIDwgMTA2KSB0aGlzLmtleSA9IGNvZGUgLSA5NjsKCQkvL30KCQkvLyBUT0RPIC0gd2hhdCdzIHRoZSByaWdodCBzb2x1dGlvbiBmb3IgdGhlIHdpbiBrZXlzPwoJCXZhciBXSU5MID0gOTE7CgkJdmFyIFdJTlIgPSA5MjsKCQl2YXIgTVVURSA9IDE3MjsKCQl2YXIgUExBWV9QQVVTRSA9IDE3OTsKCQlpZiAoY29kZSA9PSBXSU5MIHx8IGNvZGUgPT0gV0lOUiB8fCAoY29kZSA+PSBNVVRFICYmIGNvZGUgPD0gUExBWV9QQVVTRSkpIHsKCQkJY29kZSA9IDA7CgkJfQoJCXZhciBzcGVjaWFsS2V5cyA9IHsKCQkJMTA2OiAnKicsCgkJCTEwNzogJysnLAoJCQkxMDk6ICctJywKCQkJMTEwOiAnLicsCgkJCTExMTogJy8nLAoJCX07CgkJaWYgKGNvZGUgaW4gc3BlY2lhbEtleXMpIHsKCQkJdGhpcy5rZXkgPSBzcGVjaWFsS2V5c1tjb2RlXTsKCQl9CgoJCWlmICh0aGlzLmtleSA9PSBudWxsKSB0aGlzLmtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZSA9PSAnY2xpY2snIHx8IHR5cGUgPT0gJ2RibGNsaWNrJyB8fCB0eXBlID09ICdjb250ZXh0bWVudScgfHwgdHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUuaW5kZXhPZignbW91c2UnKSA9PSAwKXsKCQl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJdGhpcy5wYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJdGhpcy5jbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUgPT0gJ21vdXNld2hlZWwnKQoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCgkJdGhpcy5yaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMgfHwgZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICh0eXBlID09ICdtb3VzZW92ZXInIHx8IHR5cGUgPT0gJ21vdXNlb3V0Jyl7CgkJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQl0aGlzLnJlbGF0ZWRUYXJnZXQgPSBkb2N1bWVudC5pZChyZWxhdGVkKTsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZigndG91Y2gnKSA9PSAwIHx8IHR5cGUuaW5kZXhPZignZ2VzdHVyZScpID09IDApewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQl0aGlzLnBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJdGhpcy5jbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCWlmICghdGhpcy5jbGllbnQpIHRoaXMuY2xpZW50ID0ge307CglpZiAoIXRoaXMucGFnZSkgdGhpcy5wYWdlID0ge307Cn0pOwoKRE9NRXZlbnQuaW1wbGVtZW50KHsKCglzdG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnByZXZlbnREZWZhdWx0KCkuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KSB0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJZWxzZSB0aGlzLmV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkRPTUV2ZW50LmRlZmluZUtleSA9IGZ1bmN0aW9uKGNvZGUsIGtleSl7Cglfa2V5c1tjb2RlXSA9IGtleTsKCXJldHVybiB0aGlzOwp9OwoKRE9NRXZlbnQuZGVmaW5lS2V5cyA9IERPTUV2ZW50LmRlZmluZUtleS5vdmVybG9hZFNldHRlcih0cnVlKTsKCkRPTUV2ZW50LmRlZmluZUtleXMoewoJJzM4JzogJ3VwJywgJzQwJzogJ2Rvd24nLCAnMzcnOiAnbGVmdCcsICczOSc6ICdyaWdodCcsCgknMjcnOiAnZXNjJywgJzMyJzogJ3NwYWNlJywgJzgnOiAnYmFja3NwYWNlJywgJzknOiAndGFiJywKCSc0Nic6ICdkZWxldGUnLCAnMTMnOiAnZW50ZXInCn0pOwoKfSkoKTsKCgoKCgoKLyoKLS0tCgpuYW1lOiBDbGFzcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiBmb3IgZWFzaWx5IGNyZWF0aW5nLCBleHRlbmRpbmcsIGFuZCBpbXBsZW1lbnRpbmcgcmV1c2FibGUgQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyXQoKcHJvdmlkZXM6IENsYXNzCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIENsYXNzID0gdGhpcy5DbGFzcyA9IG5ldyBUeXBlKCdDbGFzcycsIGZ1bmN0aW9uKHBhcmFtcyl7CglpZiAoaW5zdGFuY2VPZihwYXJhbXMsIEZ1bmN0aW9uKSkgcGFyYW1zID0ge2luaXRpYWxpemU6IHBhcmFtc307CgoJdmFyIG5ld0NsYXNzID0gZnVuY3Rpb24oKXsKCQlyZXNldCh0aGlzKTsKCQlpZiAobmV3Q2xhc3MuJHByb3RvdHlwaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLiRjYWxsZXIgPSBudWxsOwoJCXZhciB2YWx1ZSA9ICh0aGlzLmluaXRpYWxpemUpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IHRoaXMuY2FsbGVyID0gbnVsbDsKCQlyZXR1cm4gdmFsdWU7Cgl9LmV4dGVuZCh0aGlzKS5pbXBsZW1lbnQocGFyYW1zKTsKCgluZXdDbGFzcy4kY29uc3RydWN0b3IgPSBDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS4kY29uc3RydWN0b3IgPSBuZXdDbGFzczsKCW5ld0NsYXNzLnByb3RvdHlwZS5wYXJlbnQgPSBwYXJlbnQ7CgoJcmV0dXJuIG5ld0NsYXNzOwp9KTsKCnZhciBwYXJlbnQgPSBmdW5jdGlvbigpewoJaWYgKCF0aGlzLiRjYWxsZXIpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAicGFyZW50IiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJdmFyIG5hbWUgPSB0aGlzLiRjYWxsZXIuJG5hbWUsCgkJcGFyZW50ID0gdGhpcy4kY2FsbGVyLiRvd25lci5wYXJlbnQsCgkJcHJldmlvdXMgPSAocGFyZW50KSA/IHBhcmVudC5wcm90b3R5cGVbbmFtZV0gOiBudWxsOwoJaWYgKCFwcmV2aW91cykgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsgbmFtZSArICciIGhhcyBubyBwYXJlbnQuJyk7CglyZXR1cm4gcHJldmlvdXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCnZhciByZXNldCA9IGZ1bmN0aW9uKG9iamVjdCl7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQl2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQlGLnByb3RvdHlwZSA9IHZhbHVlOwoJCQkJb2JqZWN0W2tleV0gPSByZXNldChuZXcgRik7CgkJCWJyZWFrOwoJCQljYXNlICdhcnJheSc6IG9iamVjdFtrZXldID0gdmFsdWUuY2xvbmUoKTsgYnJlYWs7CgkJfQoJfQoJcmV0dXJuIG9iamVjdDsKfTsKCnZhciB3cmFwID0gZnVuY3Rpb24oc2VsZiwga2V5LCBtZXRob2QpewoJaWYgKG1ldGhvZC4kb3JpZ2luKSBtZXRob2QgPSBtZXRob2QuJG9yaWdpbjsKCXZhciB3cmFwcGVyID0gZnVuY3Rpb24oKXsKCQlpZiAobWV0aG9kLiRwcm90ZWN0ZWQgJiYgdGhpcy4kY2FsbGVyID09IG51bGwpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIGtleSArICciIGNhbm5vdCBiZSBjYWxsZWQuJyk7CgkJdmFyIGNhbGxlciA9IHRoaXMuY2FsbGVyLCBjdXJyZW50ID0gdGhpcy4kY2FsbGVyOwoJCXRoaXMuY2FsbGVyID0gY3VycmVudDsgdGhpcy4kY2FsbGVyID0gd3JhcHBlcjsKCQl2YXIgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJdGhpcy4kY2FsbGVyID0gY3VycmVudDsgdGhpcy5jYWxsZXIgPSBjYWxsZXI7CgkJcmV0dXJuIHJlc3VsdDsKCX0uZXh0ZW5kKHskb3duZXI6IHNlbGYsICRvcmlnaW46IG1ldGhvZCwgJG5hbWU6IGtleX0pOwoJcmV0dXJuIHdyYXBwZXI7Cn07Cgp2YXIgaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgcmV0YWluKXsKCWlmIChDbGFzcy5NdXRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKXsKCQl2YWx1ZSA9IENsYXNzLk11dGF0b3JzW2tleV0uY2FsbCh0aGlzLCB2YWx1ZSk7CgkJaWYgKHZhbHVlID09IG51bGwpIHJldHVybiB0aGlzOwoJfQoKCWlmICh0eXBlT2YodmFsdWUpID09ICdmdW5jdGlvbicpewoJCWlmICh2YWx1ZS4kaGlkZGVuKSByZXR1cm4gdGhpczsKCQl0aGlzLnByb3RvdHlwZVtrZXldID0gKHJldGFpbikgPyB2YWx1ZSA6IHdyYXAodGhpcywga2V5LCB2YWx1ZSk7Cgl9IGVsc2UgewoJCU9iamVjdC5tZXJnZSh0aGlzLnByb3RvdHlwZSwga2V5LCB2YWx1ZSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbihrbGFzcyl7CglrbGFzcy4kcHJvdG90eXBpbmcgPSB0cnVlOwoJdmFyIHByb3RvID0gbmV3IGtsYXNzOwoJZGVsZXRlIGtsYXNzLiRwcm90b3R5cGluZzsKCXJldHVybiBwcm90bzsKfTsKCkNsYXNzLmltcGxlbWVudCgnaW1wbGVtZW50JywgaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCkpOwoKQ2xhc3MuTXV0YXRvcnMgPSB7CgoJRXh0ZW5kczogZnVuY3Rpb24ocGFyZW50KXsKCQl0aGlzLnBhcmVudCA9IHBhcmVudDsKCQl0aGlzLnByb3RvdHlwZSA9IGdldEluc3RhbmNlKHBhcmVudCk7Cgl9LAoKCUltcGxlbWVudHM6IGZ1bmN0aW9uKGl0ZW1zKXsKCQlBcnJheS5mcm9tKGl0ZW1zKS5lYWNoKGZ1bmN0aW9uKGl0ZW0pewoJCQl2YXIgaW5zdGFuY2UgPSBuZXcgaXRlbTsKCQkJZm9yICh2YXIga2V5IGluIGluc3RhbmNlKSBpbXBsZW1lbnQuY2FsbCh0aGlzLCBrZXksIGluc3RhbmNlW2tleV0sIHRydWUpOwoJCX0sIHRoaXMpOwoJfQp9OwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IENsYXNzLkV4dHJhcwoKZGVzY3JpcHRpb246IENvbnRhaW5zIFV0aWxpdHkgQ2xhc3NlcyB0aGF0IGNhbiBiZSBpbXBsZW1lbnRlZCBpbnRvIHlvdXIgb3duIENsYXNzZXMgdG8gZWFzZSB0aGUgZXhlY3V0aW9uIG9mIG1hbnkgY29tbW9uIHRhc2tzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogQ2xhc3MKCnByb3ZpZGVzOiBbQ2xhc3MuRXh0cmFzLCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuQ2hhaW4gPSBuZXcgQ2xhc3MoewoKCSRjaGFpbjogW10sCgoJY2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uYXBwZW5kKEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbGxDaGFpbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMuJGNoYWluLmxlbmd0aCkgPyB0aGlzLiRjaGFpbi5zaGlmdCgpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBmYWxzZTsKCX0sCgoJY2xlYXJDaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5lbXB0eSgpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgcmVtb3ZlT24gPSBmdW5jdGlvbihzdHJpbmcpewoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9eb24oW0EtWl0pLywgZnVuY3Rpb24oZnVsbCwgZmlyc3QpewoJCXJldHVybiBmaXJzdC50b0xvd2VyQ2FzZSgpOwoJfSk7Cn07Cgp0aGlzLkV2ZW50cyA9IG5ldyBDbGFzcyh7CgoJJGV2ZW50czoge30sCgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuLCBpbnRlcm5hbCl7CgkJdHlwZSA9IHJlbW92ZU9uKHR5cGUpOwoKCQkKCgkJdGhpcy4kZXZlbnRzW3R5cGVdID0gKHRoaXMuJGV2ZW50c1t0eXBlXSB8fCBbXSkuaW5jbHVkZShmbik7CgkJaWYgKGludGVybmFsKSBmbi5pbnRlcm5hbCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciB0eXBlIGluIGV2ZW50cykgdGhpcy5hZGRFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJZXZlbnRzLmVhY2goZnVuY3Rpb24oZm4pewoJCQlpZiAoZGVsYXkpIGZuLmRlbGF5KGRlbGF5LCB0aGlzLCBhcmdzKTsKCQkJZWxzZSBmbi5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB7CgkJCQlpZiAoaSBpbiBmbnMpIHsKCQkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnRoaXMuT3B0aW9ucyA9IG5ldyBDbGFzcyh7CgoJc2V0T3B0aW9uczogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyA9IE9iamVjdC5tZXJnZS5hcHBseShudWxsLCBbe30sIHRoaXMub3B0aW9uc10uYXBwZW5kKGFyZ3VtZW50cykpOwoJCWlmICh0aGlzLmFkZEV2ZW50KSBmb3IgKHZhciBvcHRpb24gaW4gb3B0aW9ucyl7CgkJCWlmICh0eXBlT2Yob3B0aW9uc1tvcHRpb25dKSAhPSAnZnVuY3Rpb24nIHx8ICEoL15vbltBLVpdLykudGVzdChvcHRpb24pKSBjb250aW51ZTsKCQkJdGhpcy5hZGRFdmVudChvcHRpb24sIG9wdGlvbnNbb3B0aW9uXSk7CgkJCWRlbGV0ZSBvcHRpb25zW29wdGlvbl07CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQpuYW1lOiBTbGljay5QYXJzZXIKZGVzY3JpcHRpb246IFN0YW5kYWxvbmUgQ1NTMyBTZWxlY3RvciBwYXJzZXIKcHJvdmlkZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBwYXJzZWQsCglzZXBhcmF0b3JJbmRleCwKCWNvbWJpbmF0b3JJbmRleCwKCXJldmVyc2VkLAoJY2FjaGUgPSB7fSwKCXJldmVyc2VDYWNoZSA9IHt9LAoJcmVVbmVzY2FwZSA9IC9cXC9nOwoKdmFyIHBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgaXNSZXZlcnNlZCl7CglpZiAoZXhwcmVzc2lvbiA9PSBudWxsKSByZXR1cm4gbnVsbDsKCWlmIChleHByZXNzaW9uLlNsaWNrID09PSB0cnVlKSByZXR1cm4gZXhwcmVzc2lvbjsKCWV4cHJlc3Npb24gPSAoJycgKyBleHByZXNzaW9uKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJcmV2ZXJzZWQgPSAhIWlzUmV2ZXJzZWQ7Cgl2YXIgY3VycmVudENhY2hlID0gKHJldmVyc2VkKSA/IHJldmVyc2VDYWNoZSA6IGNhY2hlOwoJaWYgKGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSkgcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXTsKCXBhcnNlZCA9IHsKCQlTbGljazogdHJ1ZSwKCQlleHByZXNzaW9uczogW10sCgkJcmF3OiBleHByZXNzaW9uLAoJCXJldmVyc2U6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7CgkJfQoJfTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtwYXJzZWQucmF3XSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJcmV0dXJuICdcXCcgKyBtYXRjaDsKCX0pOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXwoOispKDx1bmljb2RlPispKD86XFwoKD86KD86KFtcIiddKShbXlxcMTNdKilcXDEzKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspKVxcKSk/KSIKCS5yZXBsYWNlKC88Y29tYmluYXRvcj4vLCAnWycgKyBlc2NhcGVSZWdFeHAoIj4rfmAhQCQlXiY9e31cXDs8LyIpICsgJ10nKQoJLnJlcGxhY2UoLzx1bmljb2RlPi9nLCAnKD86W1xcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKCS5yZXBsYWNlKC88dW5pY29kZTE+L2csICcoPzpbOlxcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKKTsKCmZ1bmN0aW9uIHBhcnNlcigKCXJhd01hdGNoLAoKCXNlcGFyYXRvciwKCWNvbWJpbmF0b3IsCgljb21iaW5hdG9yQ2hpbGRyZW4sCgoJdGFnTmFtZSwKCWlkLAoJY2xhc3NOYW1lLAoKCWF0dHJpYnV0ZUtleSwKCWF0dHJpYnV0ZU9wZXJhdG9yLAoJYXR0cmlidXRlUXVvdGUsCglhdHRyaWJ1dGVWYWx1ZSwKCglwc2V1ZG9NYXJrZXIsCglwc2V1ZG9DbGFzcywKCXBzZXVkb1F1b3RlLAoJcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZSwKCXBzZXVkb0NsYXNzVmFsdWUKKXsKCWlmIChzZXBhcmF0b3IgfHwgc2VwYXJhdG9ySW5kZXggPT09IC0xKXsKCQlwYXJzZWQuZXhwcmVzc2lvbnNbKytzZXBhcmF0b3JJbmRleF0gPSBbXTsKCQljb21iaW5hdG9ySW5kZXggPSAtMTsKCQlpZiAoc2VwYXJhdG9yKSByZXR1cm4gJyc7Cgl9CgoJaWYgKGNvbWJpbmF0b3IgfHwgY29tYmluYXRvckNoaWxkcmVuIHx8IGNvbWJpbmF0b3JJbmRleCA9PT0gLTEpewoJCWNvbWJpbmF0b3IgPSBjb21iaW5hdG9yIHx8ICcgJzsKCQl2YXIgY3VycmVudFNlcGFyYXRvciA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF07CgkJaWYgKHJldmVyc2VkICYmIGN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XSkKCQkJY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdLnJldmVyc2VDb21iaW5hdG9yID0gcmV2ZXJzZUNvbWJpbmF0b3IoY29tYmluYXRvcik7CgkJY3VycmVudFNlcGFyYXRvclsrK2NvbWJpbmF0b3JJbmRleF0gPSB7Y29tYmluYXRvcjogY29tYmluYXRvciwgdGFnOiAnKid9OwoJfQoKCXZhciBjdXJyZW50UGFyc2VkID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XVtjb21iaW5hdG9ySW5kZXhdOwoKCWlmICh0YWdOYW1lKXsKCQljdXJyZW50UGFyc2VkLnRhZyA9IHRhZ05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChpZCl7CgkJY3VycmVudFBhcnNlZC5pZCA9IGlkLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoY2xhc3NOYW1lKXsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc0xpc3QpIGN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0ID0gW107CgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzZXMpIGN1cnJlbnRQYXJzZWQuY2xhc3NlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0LnB1c2goY2xhc3NOYW1lKTsKCQljdXJyZW50UGFyc2VkLmNsYXNzZXMucHVzaCh7CgkJCXZhbHVlOiBjbGFzc05hbWUsCgkJCXJlZ2V4cDogbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBlc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArICcoXFxzfCQpJykKCQl9KTsKCgl9IGVsc2UgaWYgKHBzZXVkb0NsYXNzKXsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSB8fCBwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlOwoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlID8gcHNldWRvQ2xhc3NWYWx1ZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSA6IG51bGw7CgoJCWlmICghY3VycmVudFBhcnNlZC5wc2V1ZG9zKSBjdXJyZW50UGFyc2VkLnBzZXVkb3MgPSBbXTsKCQljdXJyZW50UGFyc2VkLnBzZXVkb3MucHVzaCh7CgkJCWtleTogcHNldWRvQ2xhc3MucmVwbGFjZShyZVVuZXNjYXBlLCAnJyksCgkJCXZhbHVlOiBwc2V1ZG9DbGFzc1ZhbHVlLAoJCQl0eXBlOiBwc2V1ZG9NYXJrZXIubGVuZ3RoID09IDEgPyAnY2xhc3MnIDogJ2VsZW1lbnQnCgkJfSk7CgoJfSBlbHNlIGlmIChhdHRyaWJ1dGVLZXkpewoJCWF0dHJpYnV0ZUtleSA9IGF0dHJpYnV0ZUtleS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCQlhdHRyaWJ1dGVWYWx1ZSA9IChhdHRyaWJ1dGVWYWx1ZSB8fCAnJykucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCXZhciB0ZXN0LCByZWdleHA7CgoJCXN3aXRjaCAoYXR0cmlidXRlT3BlcmF0b3IpewoJCQljYXNlICdePScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgICAgICAgICAgICApOyBicmVhazsKCQkJY2FzZSAnJD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgICAgICBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnJCcgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJ349JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICcoXnxcXHMpJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyhcXHN8JCknICk7IGJyZWFrOwoJCQljYXNlICd8PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoLXwkKScgICApOyBicmVhazsKCQkJY2FzZSAgJz0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSA9PSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyo9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuaW5kZXhPZihhdHRyaWJ1dGVWYWx1ZSkgPiAtMTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyE9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgIT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQlkZWZhdWx0ICAgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuICEhdmFsdWU7CgkJCX07CgkJfQoKCQlpZiAoYXR0cmlidXRlVmFsdWUgPT0gJycgJiYgKC9eWyokXl09JC8pLnRlc3QoYXR0cmlidXRlT3BlcmF0b3IpKSB0ZXN0ID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCWlmICghdGVzdCkgdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlICYmIHJlZ2V4cC50ZXN0KHZhbHVlKTsKCQl9OwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcykgY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzID0gW107CgkJY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzLnB1c2goewoJCQlrZXk6IGF0dHJpYnV0ZUtleSwKCQkJb3BlcmF0b3I6IGF0dHJpYnV0ZU9wZXJhdG9yLAoJCQl2YWx1ZTogYXR0cmlidXRlVmFsdWUsCgkJCXRlc3Q6IHRlc3QKCQl9KTsKCgl9CgoJcmV0dXJuICcnOwp9OwoKLy8gU2xpY2sgTlMKCnZhciBTbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7CglyZXR1cm4gcGFyc2UoZXhwcmVzc2lvbik7Cn07CgpTbGljay5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgl2YXIgdGVzdFJvb3QgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gfHwgcm9vdDsKCXRlc3RSb290LmFwcGVuZENoaWxkKHRlc3ROb2RlKTsKCgkvLyBvbiBub24tSFRNTCBkb2N1bWVudHMgaW5uZXJIVE1MIGFuZCBnZXRFbGVtZW50c0J5SWQgZG9lc250IHdvcmsgcHJvcGVybHkKCXRyeSB7CgkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGlkPSInK2lkKyciPjwvYT4nOwoJCWZlYXR1cmVzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKGZlYXR1cmVzLmlzSFRNTERvY3VtZW50KXsKCgkJdGVzdE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMSk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJfSBjYXRjaChlKXt9OwoKCQlmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlIG5hbWUgaW5zdGVhZCBvZiBqdXN0IGlkIGZvciBnZXRFbGVtZW50c0J5SWQgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIG5hbWU9IicrIGlkICsnIj48L2E+PGIgaWQ9IicrIGlkICsnIj48L2I+JzsKCQkJZmVhdHVyZXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCWlmICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKXsKCgkJCS8vIFNhZmFyaSAzLjIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYWNoZXMgcmVzdWx0cwoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQkJdGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aDsKCQkJCXRlc3ROb2RlLmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gJ2InOwoJCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBPcGVyYSA5LjYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBkb2VzbnQgZGV0ZWN0cyB0aGUgY2xhc3MgaWYgaXRzIG5vdCB0aGUgZmlyc3Qgb25lCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImEiPjwvYT48YSBjbGFzcz0iZiBiIGEiPjwvYT4nOwoJCQkJYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ04gPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYScpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJZmVhdHVyZXMuYnJva2VuR0VCQ04gPSBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOOwoJCX0KCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCWZlYXR1cmVzLmNvbnRhaW5zID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5jb250YWlucykpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50CgkJCQl8fCBxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0KCQkJCS8vVE9ETzogb25seSBza2lwIHdoZW4gZXhwcmVzc2lvbiBpcyBhY3R1YWxseSBtaXhlZCBjYXNlCgkJCQl8fCB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJCQkJfHwgKHRoaXMuYnJva2VuQ2hlY2tlZFFTQSAmJiBleHByZXNzaW9uLmluZGV4T2YoJzpjaGVja2VkJykgPiAtMSkKCQkJCXx8ICh0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkKCQkJCXx8ICghY29udGV4dElzRG9jdW1lbnQgLy9BYm9ydCB3aGVuICFjb250ZXh0SXNEb2N1bWVudCBhbmQuLi4KCQkJCQkvLyAgdGhlcmUgYXJlIG11bHRpcGxlIGV4cHJlc3Npb25zIGluIHRoZSBzZWxlY3RvcgoJCQkJCS8vICBzaW5jZSB3ZSBjdXJyZW50bHkgb25seSBmaXggbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EgZm9yIHNpbmdsZSBleHByZXNzaW9uIHNlbGVjdG9ycwoJCQkJCSYmIGV4cHJlc3Npb24uaW5kZXhPZignLCcpID4gLTEKCQkJCSkKCQkJCXx8IFNsaWNrLmRpc2FibGVRU0EKCQkJKSBicmVhayBxdWVyeVNlbGVjdG9yOwoKCQkJdmFyIF9leHByZXNzaW9uID0gZXhwcmVzc2lvbiwgX2NvbnRleHQgPSBjb250ZXh0OwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBfY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJyksIHNsaWNraWQgPSAnc2xpY2tpZF9fJzsKCQkJCV9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBzbGlja2lkKTsKCQkJCV9leHByZXNzaW9uID0gJyMnICsgc2xpY2tpZCArICcgJyArIF9leHByZXNzaW9uOwoJCQkJY29udGV4dCA9IF9jb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXRyeSB7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3IoX2V4cHJlc3Npb24pIHx8IG51bGw7CgkJCQllbHNlIG5vZGVzID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKF9leHByZXNzaW9uKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0gPSAxOwoJCQkJYnJlYWsgcXVlcnlTZWxlY3RvcjsKCQkJfSBmaW5hbGx5IHsKCQkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJCWlmIChjdXJyZW50SWQpIF9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBjdXJyZW50SWQpOwoJCQkJCWVsc2UgX2NvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJCWNvbnRleHQgPSBfY29udGV4dDsKCQkJCX0KCQkJfQoKCQkJaWYgKHRoaXMuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAobm9kZS5ub2RlTmFtZSA+ICdAJyAmJiAhKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCX0gZWxzZSBmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfQoKCQkJaWYgKGhhc090aGVycykgdGhpcy5zb3J0KGZvdW5kKTsKCQkJcmV0dXJuIGZvdW5kOwoKCQl9CgkJLyo8L3F1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghaGFzT3RoZXJzICYmIChmaXJzdCB8fCAocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSkpKSA/IHRoaXMucHVzaEFycmF5IDogdGhpcy5wdXNoVUlEOwoKCWlmIChmb3VuZCA9PSBudWxsKSBmb3VuZCA9IFtdOwoKCS8vIGRlZmF1bHQgZW5naW5lCgoJdmFyIGosIG0sIG47Cgl2YXIgY29tYmluYXRvciwgdGFnLCBpZCwgY2xhc3NMaXN0LCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zOwoJdmFyIGN1cnJlbnRJdGVtcywgY3VycmVudEV4cHJlc3Npb24sIGN1cnJlbnRCaXQsIGxhc3RCaXQsIGV4cHJlc3Npb25zID0gcGFyc2VkLmV4cHJlc3Npb25zOwoKCXNlYXJjaDogZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspIGZvciAoaiA9IDA7IChjdXJyZW50Qml0ID0gY3VycmVudEV4cHJlc3Npb25bal0pOyBqKyspewoKCQljb21iaW5hdG9yID0gJ2NvbWJpbmF0b3I6JyArIGN1cnJlbnRCaXQuY29tYmluYXRvcjsKCQlpZiAoIXRoaXNbY29tYmluYXRvcl0pIGNvbnRpbnVlIHNlYXJjaDsKCgkJdGFnICAgICAgICA9ICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gY3VycmVudEJpdC50YWcgOiBjdXJyZW50Qml0LnRhZy50b1VwcGVyQ2FzZSgpOwoJCWlkICAgICAgICAgPSBjdXJyZW50Qml0LmlkOwoJCWNsYXNzTGlzdCAgPSBjdXJyZW50Qml0LmNsYXNzTGlzdDsKCQljbGFzc2VzICAgID0gY3VycmVudEJpdC5jbGFzc2VzOwoJCWF0dHJpYnV0ZXMgPSBjdXJyZW50Qml0LmF0dHJpYnV0ZXM7CgkJcHNldWRvcyAgICA9IGN1cnJlbnRCaXQucHNldWRvczsKCQlsYXN0Qml0ICAgID0gKGogPT09IChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggLSAxKSk7CgoJCXRoaXMuYml0VW5pcXVlcyA9IHt9OwoKCQlpZiAobGFzdEJpdCl7CgkJCXRoaXMudW5pcXVlcyA9IHVuaXF1ZXM7CgkJCXRoaXMuZm91bmQgPSBmb3VuZDsKCQl9IGVsc2UgewoJCQl0aGlzLnVuaXF1ZXMgPSB7fTsKCQkJdGhpcy5mb3VuZCA9IFtdOwoJCX0KCgkJaWYgKGogPT09IDApewoJCQl0aGlzW2NvbWJpbmF0b3JdKGNvbnRleHQsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0ICYmIGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCX0gZWxzZSB7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0KSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKyl7CgkJCQl0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJCWlmIChmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQkJfSBlbHNlIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKSB0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQl9CgoJCWN1cnJlbnRJdGVtcyA9IHRoaXMuZm91bmQ7Cgl9CgoJLy8gc2hvdWxkIHNvcnQgaWYgdGhlcmUgYXJlIG5vZGVzIGluIGFwcGVuZCBhbmQgaWYgeW91IHBhc3MgbXVsdGlwbGUgZXhwcmVzc2lvbnMuCglpZiAoaGFzT3RoZXJzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljay11bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPSBub2RlTmFtZSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfSBlbHNlIHsKCQkJCWRvIHsKCQkJCQlpZiAoZWwubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfQoJCX0KCQlhcmd1bWVudCA9IGFyZ3VtZW50IHx8ICduJzsKCQl2YXIgcGFyc2VkID0gdGhpcy5jYWNoZU5USFthcmd1bWVudF0gfHwgdGhpcy5wYXJzZU5USEFyZ3VtZW50KGFyZ3VtZW50KTsKCQlpZiAoIXBhcnNlZCkgcmV0dXJuIGZhbHNlOwoJCXZhciBhID0gcGFyc2VkLmEsIGIgPSBwYXJzZWQuYiwgcG9zID0gdGhpc1twb3NpdGlvbnNdW3VpZF07CgkJaWYgKGEgPT0gMCkgcmV0dXJuIGIgPT0gcG9zOwoJCWlmIChhID4gMCl7CgkJCWlmIChwb3MgPCBiKSByZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaWYgKGIgPCBwb3MpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuICgocG9zIC0gYikgJSBhKSA9PSAwOwoJfTsKfTsKCi8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLy8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5wdXNoQXJyYXkgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpIHRoaXMuZm91bmQucHVzaChub2RlKTsKfTsKCmxvY2FsLnB1c2hVSUQgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCWlmICghdGhpcy51bmlxdWVzW3VpZF0gJiYgdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpKXsKCQl0aGlzLnVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwoJfQp9OwoKbG9jYWwubWF0Y2hOb2RlID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvci5jYWxsKG5vZGUsIHNlbGVjdG9yLnJlcGxhY2UoL1xbKFtePV0rKT1ccyooW14nIlxdXSs/KVxzKlxdL2csICdbJDE9IiQyIl0nKSk7CgkJfSBjYXRjaChtYXRjaEVycm9yKSB7fQoJfQoKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCBub2RlLmNsYXNzTmFtZTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghaXRlbSl7CgkJCQkJLy8gaWYgdGhlIGNvbnRleHQgaXMgaW4gdGhlIGRvbSB3ZSByZXR1cm4sIGVsc2Ugd2Ugd2lsbCB0cnkgR0VCVE4sIGJyZWFraW5nIHRoZSBnZXRCeUlkIGxhYmVsCgkJCQkJaWYgKHRoaXMuY29udGFpbnModGhpcy5yb290LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKTsKCX0sCgoJJysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJ14nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZmlyc3QgY2hpbGQKCQlub2RlID0gbm9kZS5maXJzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknKysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nIGFuZCBwcmV2aW91cyBzaWJsaW5nCgkJdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknfn4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncyBhbmQgcHJldmlvdXMgc2libGluZ3MKCQl0aGlzWydjb21iaW5hdG9yOn4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiF+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGFsbCBwYXJlbnQgbm9kZXMgdXAgdG8gZG9jdW1lbnQKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSBpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknIT4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IHBhcmVudCAob25lIGxldmVsKQoJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyErJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJyF+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfQoKfTsKCmZvciAodmFyIGMgaW4gY29tYmluYXRvcnMpIGxvY2FsWydjb21iaW5hdG9yOicgKyBjXSA9IGNvbWJpbmF0b3JzW2NdOwoKdmFyIHBzZXVkb3MgPSB7CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLwoKCSdlbXB0eSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKCQlyZXR1cm4gIShjaGlsZCAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxKSAmJiAhKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmxlbmd0aDsKCX0sCgoJJ25vdCc6IGZ1bmN0aW9uKG5vZGUsIGV4cHJlc3Npb24pewoJCXJldHVybiAhdGhpcy5tYXRjaE5vZGUobm9kZSwgZXhwcmVzc2lvbik7Cgl9LAoKCSdjb250YWlucyc6IGZ1bmN0aW9uKG5vZGUsIHRleHQpewoJCXJldHVybiAobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykuaW5kZXhPZih0ZXh0KSA+IC0xOwoJfSwKCgknZmlyc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybicpOwoJfSwKCgknb2RkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4rMScpOwoJfSwKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvKjxvZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZmlyc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZSwgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuICFub2RlLmRpc2FibGVkOwoJfSwKCgknZGlzYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2NoZWNrZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5jaGVja2VkIHx8IG5vZGUuc2VsZWN0ZWQ7Cgl9LAoKCSdmb2N1cyc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzLmlzSFRNTERvY3VtZW50ICYmIHRoaXMuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gbm9kZSAmJiAobm9kZS5ocmVmIHx8IG5vZGUudHlwZSB8fCB0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCAndGFiaW5kZXgnKSk7Cgl9LAoKCSdyb290JzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlID09PSB0aGlzLnJvb3QpOwoJfSwKCgknc2VsZWN0ZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5zZWxlY3RlZDsKCX0KCgkvKjwvcHNldWRvLXNlbGVjdG9ycz4qLwp9OwoKZm9yICh2YXIgcCBpbiBwc2V1ZG9zKSBsb2NhbFsncHNldWRvOicgKyBwXSA9IHBzZXVkb3NbcF07CgovLyBhdHRyaWJ1dGVzIG1ldGhvZHMKCnZhciBhdHRyaWJ1dGVHZXR0ZXJzID0gbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9LAoKCSdtYXhsZW5ndGgnOiBmdW5jdGlvbigpewoJCXZhciBhdHRyaWJ1dGVOb2RlID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdtYXhMZW5ndGgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfQoKfTsKCmF0dHJpYnV0ZUdldHRlcnMuTUFYTEVOR1RIID0gYXR0cmlidXRlR2V0dGVycy5tYXhMZW5ndGggPSBhdHRyaWJ1dGVHZXR0ZXJzLm1heGxlbmd0aDsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjYnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKU2xpY2suaGFzQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5oYXNBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE9iamVjdCwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIENocm9tZUVsZW1lbnQgPSBFbGVtZW50Oy8vIFRPRE8gLSBqZmx5CnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgYXR0ciwgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYoQ2hyb21lRWxlbWVudCkgewoJRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCA9IENocm9tZUVsZW1lbnQuQUxMT1dfS0VZQk9BUkRfSU5QVVQ7Ly8gVE9ETyAtIGpmbHkKfQoKCmlmIChCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoJLy8gSUU4IGFuZCBJRTkgcmVxdWlyZSB0aGUgd3JhcHBpbmcuCglFbGVtZW50LnByb3RvdHlwZS5fZmlyZUV2ZW50ID0gKGZ1bmN0aW9uKGZpcmVFdmVudCl7CgkJcmV0dXJuIGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJcmV0dXJuIGZpcmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGV2ZW50KTsKCQl9OwoJfSkoRWxlbWVudC5wcm90b3R5cGUuZmlyZUV2ZW50KTsKfQoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307CgoKCnZhciBJRnJhbWUgPSBuZXcgVHlwZSgnSUZyYW1lJywgZnVuY3Rpb24oKXsKCXZhciBwYXJhbXMgPSBBcnJheS5saW5rKGFyZ3VtZW50cywgewoJCXByb3BlcnRpZXM6IFR5cGUuaXNPYmplY3QsCgkJaWZyYW1lOiBmdW5jdGlvbihvYmopewoJCQlyZXR1cm4gKG9iaiAhPSBudWxsKTsKCQl9Cgl9KTsKCgl2YXIgcHJvcHMgPSBwYXJhbXMucHJvcGVydGllcyB8fCB7fSwgaWZyYW1lOwoJaWYgKHBhcmFtcy5pZnJhbWUpIGlmcmFtZSA9IGRvY3VtZW50LmlkKHBhcmFtcy5pZnJhbWUpOwoJdmFyIG9ubG9hZCA9IHByb3BzLm9ubG9hZCB8fCBmdW5jdGlvbigpe307CglkZWxldGUgcHJvcHMub25sb2FkOwoJcHJvcHMuaWQgPSBwcm9wcy5uYW1lID0gW3Byb3BzLmlkLCBwcm9wcy5uYW1lLCBpZnJhbWUgPyAoaWZyYW1lLmlkIHx8IGlmcmFtZS5uYW1lKSA6ICdJRnJhbWVfJyArIFN0cmluZy51bmlxdWVJRCgpXS5waWNrKCk7CglpZnJhbWUgPSBuZXcgRWxlbWVudChpZnJhbWUgfHwgJ2lmcmFtZScsIHByb3BzKTsKCgl2YXIgb25Mb2FkID0gZnVuY3Rpb24oKXsKCQlvbmxvYWQuY2FsbChpZnJhbWUuY29udGVudFdpbmRvdyk7Cgl9OwoKCWlmICh3aW5kb3cuZnJhbWVzW3Byb3BzLmlkXSkgb25Mb2FkKCk7CgllbHNlIGlmcmFtZS5hZGRMaXN0ZW5lcignbG9hZCcsIG9uTG9hZCk7CglyZXR1cm4gaWZyYW1lOwp9KTsKCnZhciBFbGVtZW50cyA9IHRoaXMuRWxlbWVudHMgPSBmdW5jdGlvbihub2Rlcyl7CglpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoKXsKCQl2YXIgdW5pcXVlcyA9IHt9LCBub2RlOwoJCWZvciAodmFyIGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQl2YXIgdWlkID0gU2xpY2sudWlkT2Yobm9kZSk7CgkJCWlmICghdW5pcXVlc1t1aWRdKXsKCQkJCXVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCQl0aGlzLnB1c2gobm9kZSk7CgkJCX0KCQl9Cgl9Cn07CgpFbGVtZW50cy5wcm90b3R5cGUgPSB7bGVuZ3RoOiAwfTsKRWxlbWVudHMucGFyZW50ID0gQXJyYXk7CgpuZXcgVHlwZSgnRWxlbWVudHMnLCBFbGVtZW50cykuaW1wbGVtZW50KHsKCglmaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlciwgYmluZCl7CgkJaWYgKCFmaWx0ZXIpIHJldHVybiB0aGlzOwoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZmlsdGVyKHRoaXMsICh0eXBlT2YoZmlsdGVyKSA9PSAnc3RyaW5nJykgPyBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0ubWF0Y2goZmlsdGVyKTsKCQl9IDogZmlsdGVyLCBiaW5kKSk7Cgl9LnByb3RlY3QoKSwKCglwdXNoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSB0aGlzW2xlbmd0aCsrXSA9IGl0ZW07CgkJfQoJCXJldHVybiAodGhpcy5sZW5ndGggPSBsZW5ndGgpOwoJfS5wcm90ZWN0KCksCgoJdW5zaGlmdDogZnVuY3Rpb24oKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSBpdGVtcy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gQXJyYXkucHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgaXRlbXMpOwoJfS5wcm90ZWN0KCksCgoJY29uY2F0OiBmdW5jdGlvbigpewoJCXZhciBuZXdFbGVtZW50cyA9IG5ldyBFbGVtZW50cyh0aGlzKTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGFyZ3VtZW50c1tpXTsKCQkJaWYgKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pKSBuZXdFbGVtZW50cy5hcHBlbmQoaXRlbSk7CgkJCWVsc2UgbmV3RWxlbWVudHMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIG5ld0VsZW1lbnRzOwoJfS5wcm90ZWN0KCksCgoJYXBwZW5kOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGNvbGxlY3Rpb24ubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLnB1c2goY29sbGVjdGlvbltpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl3aGlsZSAodGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzWy0tdGhpcy5sZW5ndGhdOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCkKCn0pOwoKCgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7Cgl2YXIgcmVzdWx0ID0gc3BsaWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl3aGlsZSAobGVuZ3RoID49IHRoaXMubGVuZ3RoKSBkZWxldGUgdGhpc1tsZW5ndGgtLV07CglyZXR1cm4gcmVzdWx0Owp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKKGZ1bmN0aW9uKCl7CgpTbGljay51aWRPZih3aW5kb3cpOwpTbGljay51aWRPZihkb2N1bWVudCk7CgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld1RleHROb2RlOiBmdW5jdGlvbih0ZXh0KXsKCQlyZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53aW5kb3c7Cgl9LAoKCWlkOiAoZnVuY3Rpb24oKXsKCgkJdmFyIHR5cGVzID0gewoKCQkJc3RyaW5nOiBmdW5jdGlvbihpZCwgbm9jYXNoLCBkb2MpewoJCQkJaWQgPSBTbGljay5maW5kKGRvYywgJyMnICsgaWQucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKTsKCQkJCXJldHVybiAoaWQpID8gdHlwZXMuZWxlbWVudChpZCwgbm9jYXNoKSA6IG51bGw7CgkJCX0sCgoJCQllbGVtZW50OiBmdW5jdGlvbihlbCwgbm9jYXNoKXsKCQkJCVNsaWNrLnVpZE9mKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQllbC5fZmlyZUV2ZW50ID0gZWwuZmlyZUV2ZW50OwoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVuaXF1ZU51bWJlcikgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7Cgp2YXIgY29udGFpbnMgPSB7Y29udGFpbnM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJcmV0dXJuIFNsaWNrLmNvbnRhaW5zKHRoaXMsIGVsZW1lbnQpOwp9fTsKCmlmICghZG9jdW1lbnQuY29udGFpbnMpIERvY3VtZW50LmltcGxlbWVudChjb250YWlucyk7CmlmICghZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykuY29udGFpbnMpIEVsZW1lbnQuaW1wbGVtZW50KGNvbnRhaW5zKTsKCgoKLy8gdHJlZSB3YWxraW5nCgp2YXIgaW5qZWN0Q29tYmluYXRvciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpewoJaWYgKCFleHByZXNzaW9uKSByZXR1cm4gY29tYmluYXRvcjsKCglleHByZXNzaW9uID0gT2JqZWN0LmNsb25lKFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pKTsKCgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IGV4cHJlc3Npb25zLmxlbmd0aDsgaS0tOykKCQlleHByZXNzaW9uc1tpXVswXS5jb21iaW5hdG9yID0gY29tYmluYXRvcjsKCglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldE5leHQ6ICd+JywKCWdldFByZXZpb3VzOiAnIX4nLAoJZ2V0UGFyZW50OiAnIScKfSwgZnVuY3Rpb24oY29tYmluYXRvciwgbWV0aG9kKXsKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZCwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIHRoaXMuZ2V0RWxlbWVudChpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCk9iamVjdC5mb3JFYWNoKHsKCWdldEFsbE5leHQ6ICd+JywKCWdldEFsbFByZXZpb3VzOiAnIX4nLAoJZ2V0U2libGluZ3M6ICd+ficsCglnZXRDaGlsZHJlbjogJz4nLAoJZ2V0UGFyZW50czogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnRzKGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgY29tYmluYXRvcikpOwoJfSk7Cn0pOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldEZpcnN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSlbMF0pOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suc2VhcmNoKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJz4nKSkuZ2V0TGFzdCgpKTsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm93bmVyRG9jdW1lbnQud2luZG93OwoJfSwKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50OwoJfSwKCglnZXRFbGVtZW50QnlJZDogZnVuY3Rpb24oaWQpewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsICcjJyArICgnJyArIGlkKS5yZXBsYWNlKC8oXFcpL2csICdcXCQxJykpKTsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKCgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgoKCi8vIGdldFByb3BlcnR5IC8gc2V0UHJvcGVydHkKCnZhciBwcm9wZXJ0eUdldHRlcnMgPSB7fSwgcHJvcGVydHlTZXR0ZXJzID0ge307CgovLyBwcm9wZXJ0aWVzCgp2YXIgcHJvcGVydGllcyA9IHt9OwpBcnJheS5mb3JFYWNoKFsKCSd0eXBlJywgJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsCgknZnJhbWVCb3JkZXInLCAncm93U3BhbicsICd0YWJJbmRleCcsICd1c2VNYXAnCl0sIGZ1bmN0aW9uKHByb3BlcnR5KXsKCXByb3BlcnRpZXNbcHJvcGVydHkudG9Mb3dlckNhc2UoKV0gPSBwcm9wZXJ0eTsKfSk7CgpPYmplY3QuYXBwZW5kKHByb3BlcnRpZXMsIHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLnRleHRDb250ZW50ID09IG51bGwpID8gJ2lubmVyVGV4dCc6ICd0ZXh0Q29udGVudCc7Cgl9KSgpCn0pOwoKT2JqZWN0LmZvckVhY2gocHJvcGVydGllcywgZnVuY3Rpb24ocmVhbCwga2V5KXsKCXByb3BlcnR5U2V0dGVyc1trZXldID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGVbcmVhbF0gPSB2YWx1ZTsKCX07Cglwcm9wZXJ0eUdldHRlcnNba2V5XSA9IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlW3JlYWxdOwoJfTsKfSk7CgovLyBCb29sZWFucwoKdmFyIGJvb2xzID0gWwoJJ2NvbXBhY3QnLCAnbm93cmFwJywgJ2lzbWFwJywgJ2RlY2xhcmUnLCAnbm9zaGFkZScsICdjaGVja2VkJywKCSdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsICdub3Jlc2l6ZScsCgknZGVmZXInLCAnZGVmYXVsdENoZWNrZWQnLCAnYXV0b2ZvY3VzJywgJ2NvbnRyb2xzJywgJ2F1dG9wbGF5JywKCSdsb29wJwpdOwoKdmFyIGJvb2xlYW5zID0ge307CkFycmF5LmZvckVhY2goYm9vbHMsIGZ1bmN0aW9uKGJvb2wpewoJdmFyIGxvd2VyID0gYm9vbC50b0xvd2VyQ2FzZSgpOwoJYm9vbGVhbnNbbG93ZXJdID0gYm9vbDsKCXByb3BlcnR5U2V0dGVyc1tsb3dlcl0gPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZVtib29sXSA9ICEhdmFsdWU7Cgl9OwoJcHJvcGVydHlHZXR0ZXJzW2xvd2VyXSA9IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhIW5vZGVbYm9vbF07Cgl9Owp9KTsKCi8vIFNwZWNpYWwgY2FzZXMKCk9iamVjdC5hcHBlbmQocHJvcGVydHlTZXR0ZXJzLCB7CgoJJ2NsYXNzJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCSgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lID0gKHZhbHVlIHx8ICcnKSA6IG5vZGUuc2V0QXR0cmlidXRlKCdjbGFzcycsIHZhbHVlKTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkoJ2h0bWxGb3InIGluIG5vZGUpID8gbm9kZS5odG1sRm9yID0gdmFsdWUgOiBub2RlLnNldEF0dHJpYnV0ZSgnZm9yJywgdmFsdWUpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKG5vZGUuc3R5bGUpID8gbm9kZS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgOiBub2RlLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCB2YWx1ZSk7Cgl9LAoKCSd2YWx1ZSc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlLnZhbHVlID0gdmFsdWUgfHwgJyc7Cgl9Cgp9KTsKCnByb3BlcnR5R2V0dGVyc1snY2xhc3MnXSA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuICgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lIHx8IG51bGwgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKfTsKCi8qIDx3ZWJraXQ+ICovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwovLyBJRSBzZXRzIHR5cGUgYXMgcmVhZG9ubHkgYW5kIHRocm93cwp0cnkgeyBlbC50eXBlID0gJ2J1dHRvbic7IH0gY2F0Y2goZSl7fQppZiAoZWwudHlwZSAhPSAnYnV0dG9uJykgcHJvcGVydHlTZXR0ZXJzLnR5cGUgPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7Cglub2RlLnNldEF0dHJpYnV0ZSgndHlwZScsIHZhbHVlKTsKfTsKLyogPC93ZWJraXQ+ICovCgovKiBnZXRQcm9wZXJ0eSwgc2V0UHJvcGVydHkgKi8KCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXZhciBzZXR0ZXIgPSBwcm9wZXJ0eVNldHRlcnNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKCQlpZiAoc2V0dGVyKXsKCQkJc2V0dGVyKHRoaXMsIHZhbHVlKTsKCQl9IGVsc2UgewoJCQlpZiAodmFsdWUgPT0gbnVsbCkgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CgkJCWVsc2UgdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0UHJvcGVydGllczogZnVuY3Rpb24oYXR0cmlidXRlcyl7CgkJZm9yICh2YXIgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHRoaXMuc2V0UHJvcGVydHkoYXR0cmlidXRlLCBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24obmFtZSl7CgkJdmFyIGdldHRlciA9IHByb3BlcnR5R2V0dGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwoJCWlmIChnZXR0ZXIpIHJldHVybiBnZXR0ZXIodGhpcyk7CgkJdmFyIHJlc3VsdCA9IFNsaWNrLmdldEF0dHJpYnV0ZSh0aGlzLCBuYW1lKTsKCQlyZXR1cm4gKCFyZXN1bHQgJiYgIVNsaWNrLmhhc0F0dHJpYnV0ZSh0aGlzLCBuYW1lKSkgPyBudWxsIDogcmVzdWx0OwoJfSwKCglnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCXZhciBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwoJCXJldHVybiBhcmdzLm1hcCh0aGlzLmdldFByb3BlcnR5LCB0aGlzKS5hc3NvY2lhdGUoYXJncyk7Cgl9LAoKCXJlbW92ZVByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gdGhpcy5zZXRQcm9wZXJ0eShuYW1lLCBudWxsKTsKCX0sCgoJcmVtb3ZlUHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlBcnJheS5lYWNoKGFyZ3VtZW50cywgdGhpcy5yZW1vdmVQcm9wZXJ0eSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY2xlYW4oKS5jb250YWlucyhjbGFzc05hbWUsICcgJyk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZm9yY2UpewoJCWlmIChmb3JjZSA9PSBudWxsKSBmb3JjZSA9ICF0aGlzLmhhc0NsYXNzKGNsYXNzTmFtZSk7CgkJcmV0dXJuIChmb3JjZSkgPyB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSkgOiB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7Cgl9LAoKCWFkb3B0OiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnQgPSB0aGlzLCBmcmFnbWVudCwgZWxlbWVudHMgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyksIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCQlpZiAobGVuZ3RoID4gMSkgcGFyZW50ID0gZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnRzW2ldLCB0cnVlKTsKCQkJaWYgKGVsZW1lbnQpIHBhcmVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKCQl9CgoJCWlmIChmcmFnbWVudCkgdGhpcy5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCXJldHVybiB0aGlzOwoJfSwKCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0LCB3aGVyZSl7CgkJcmV0dXJuIHRoaXMuZ3JhYih0aGlzLmdldERvY3VtZW50KCkubmV3VGV4dE5vZGUodGV4dCksIHdoZXJlKTsKCX0sCgoJZ3JhYjogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbCl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcywgZWwpOwoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwczogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9IGRvY3VtZW50LmlkKGVsLCB0cnVlKTsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlcyhlbCkuZ3JhYihlbCwgd2hlcmUpOwoJfSwKCglnZXRTZWxlY3RlZDogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdGVkSW5kZXg7IC8vIFNhZmFyaSAzLjIuMQoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZnJvbSh0aGlzLm9wdGlvbnMpLmZpbHRlcihmdW5jdGlvbihvcHRpb24pewoJCQlyZXR1cm4gb3B0aW9uLnNlbGVjdGVkOwoJCX0pKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEVsZW1lbnRzKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgdHlwZSA9IGVsLnR5cGU7CgkJCWlmICghZWwubmFtZSB8fCBlbC5kaXNhYmxlZCB8fCB0eXBlID09ICdzdWJtaXQnIHx8IHR5cGUgPT0gJ3Jlc2V0JyB8fCB0eXBlID09ICdmaWxlJyB8fCB0eXBlID09ICdpbWFnZScpIHJldHVybjsKCgkJCXZhciB2YWx1ZSA9IChlbC5nZXQoJ3RhZycpID09ICdzZWxlY3QnKSA/IGVsLmdldFNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKG9wdCl7CgkJCQkvLyBJRQoJCQkJcmV0dXJuIGRvY3VtZW50LmlkKG9wdCkuZ2V0KCd2YWx1ZScpOwoJCQl9KSA6ICgodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgJiYgIWVsLmNoZWNrZWQpID8gbnVsbCA6IGVsLmdldCgndmFsdWUnKTsKCgkJCUFycmF5LmZyb20odmFsdWUpLmVhY2goZnVuY3Rpb24odmFsKXsKCQkJCWlmICh0eXBlb2YgdmFsICE9ICd1bmRlZmluZWQnKSBxdWVyeVN0cmluZy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChlbC5uYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgZm9ybVByb3BzID0ge2lucHV0OiAnY2hlY2tlZCcsIG9wdGlvbjogJ3NlbGVjdGVkJywgdGV4dGFyZWE6ICd2YWx1ZSd9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCl7CgkJdmFyIGNoaWxkcmVuID0gY2xlYW4odGhpcykuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlBcnJheS5lYWNoKGNoaWxkcmVuLCBjbGVhbik7CgkJRWxlbWVudC5kaXNwb3NlKHRoaXMpOwoJCXJldHVybiBudWxsOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlBcnJheS5mcm9tKHRoaXMuY2hpbGROb2RlcykuZWFjaChFbGVtZW50LmRpc3Bvc2UpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5wYXJlbnROb2RlKSA/IHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKSA6IHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cywga2VlcGlkKXsKCQljb250ZW50cyA9IGNvbnRlbnRzICE9PSBmYWxzZTsKCQl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGNlID0gW2Nsb25lXSwgdGUgPSBbdGhpc10sIGk7CgoJCWlmIChjb250ZW50cyl7CgkJCWNlLmFwcGVuZChBcnJheS5mcm9tKGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpKTsKCQkJdGUuYXBwZW5kKEFycmF5LmZyb20odGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJfQoKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspewoJCQl2YXIgbm9kZSA9IGNlW2ldLCBlbGVtZW50ID0gdGVbaV07CgkJCWlmICgha2VlcGlkKSBub2RlLnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKCQkJLyo8bHRJRTk+Ki8KCQkJaWYgKG5vZGUuY2xlYXJBdHRyaWJ1dGVzKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQkvKjwvbHRJRTk+Ki8KCQkJdmFyIHByb3AgPSBmb3JtUHJvcHNbZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCldOwoJCQlpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKCQl9CgoJCS8qPGx0SUU5PiovCgkJaWYgKEJyb3dzZXIuaWUpewoJCQl2YXIgY28gPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksIHRvID0gdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CgkJCWZvciAoaSA9IGNvLmxlbmd0aDsgaS0tOykgY29baV0ub3V0ZXJIVE1MID0gdG9baV0ub3V0ZXJIVE1MOwoJCX0KCQkvKjwvbHRJRTk+Ki8KCQlyZXR1cm4gZG9jdW1lbnQuaWQoY2xvbmUpOwoJfQoKfSk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFtTbGljay51aWRPZih0aGlzKV0gPSB0aGlzOwoJCX0KCQlpZiAodGhpcy5hZGRFdmVudExpc3RlbmVyKSB0aGlzLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKSB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmV0cmlldmU6IGZ1bmN0aW9uKHByb3BlcnR5LCBkZmx0KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KFNsaWNrLnVpZE9mKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJZGVsZXRlIHN0b3JhZ2VbcHJvcGVydHldOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKjxsdElFOT4qLwppZiAod2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbigpewoJT2JqZWN0LmVhY2goY29sbGVjdGVkLCBjbGVhbik7CglpZiAod2luZG93LkNvbGxlY3RHYXJiYWdlKSBDb2xsZWN0R2FyYmFnZSgpOwp9KTsKLyo8L2x0SUU5PiovCgpFbGVtZW50LlByb3BlcnRpZXMgPSB7fTsKCgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCi8qPCF3ZWJraXQ+Ki8KRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCS8qPGx0SUU5PiovCgkvLyB0ZWNobmlxdWUgYnkgamRiYXJsZXR0IC0gaHR0cDovL2pkYmFydGxldHQuY29tL2lubmVyc2hpdi8KCXdyYXBwZXIuaW5uZXJIVE1MID0gJzxuYXY+PC9uYXY+JzsKCXZhciBIVE1MNVRlc3QgPSB3cmFwcGVyLmNoaWxkTm9kZXMubGVuZ3RoID09IDE7CglpZiAoIUhUTUw1VGVzdCl7CgkJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIGwgPSB0YWdzLmxlbmd0aDsKCQl3aGlsZSAobC0tKSBmcmFnbWVudC5jcmVhdGVFbGVtZW50KHRhZ3NbbF0pOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJfQoJLyo8L2x0SUU5PiovCgoJdmFyIGh0bWwgPSB7CgkJc2V0OiBmdW5jdGlvbihodG1sKXsKCQkJaWYgKHR5cGVPZihodG1sKSA9PSAnYXJyYXknKSBodG1sID0gaHRtbC5qb2luKCcnKTsKCgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQkvKjxsdElFOT4qLwoJCQlpZiAoIXdyYXAgJiYgIUhUTUw1VGVzdCkgd3JhcCA9IFswLCAnJywgJyddOwoJCQkvKjwvbHRJRTk+Ki8KCQkJaWYgKHdyYXApewoJCQkJdmFyIGZpcnN0ID0gd3JhcHBlcjsKCQkJCWZpcnN0LmlubmVySFRNTCA9IHdyYXBbMV0gKyBodG1sICsgd3JhcFsyXTsKCQkJCWZvciAodmFyIGkgPSB3cmFwWzBdOyBpLS07KSBmaXJzdCA9IGZpcnN0LmZpcnN0Q2hpbGQ7CgkJCQl0aGlzLmVtcHR5KCkuYWRvcHQoZmlyc3QuY2hpbGROb2Rlcyk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmlubmVySFRNTCA9IGh0bWw7CgkJCX0KCQl9Cgl9OwoKCWh0bWwuZXJhc2UgPSBodG1sLnNldDsKCglyZXR1cm4gaHRtbDsKfSkoKTsKLyo8LyF3ZWJraXQ+Ki8KCi8qPGx0SUU5PiovCnZhciB0ZXN0Rm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2Zvcm0nKTsKdGVzdEZvcm0uaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbj5zPC9vcHRpb24+PC9zZWxlY3Q+JzsKCmlmICh0ZXN0Rm9ybS5maXJzdENoaWxkLnZhbHVlICE9ICdzJykgRWxlbWVudC5Qcm9wZXJ0aWVzLnZhbHVlID0gewoKCXNldDogZnVuY3Rpb24odmFsdWUpewoJCXZhciB0YWcgPSB0aGlzLmdldCgndGFnJyk7CgkJaWYgKHRhZyAhPSAnc2VsZWN0JykgcmV0dXJuIHRoaXMuc2V0UHJvcGVydHkoJ3ZhbHVlJywgdmFsdWUpOwoJCXZhciBvcHRpb25zID0gdGhpcy5nZXRFbGVtZW50cygnb3B0aW9uJyk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvcHRpb25zLmxlbmd0aDsgaSsrKXsKCQkJdmFyIG9wdGlvbiA9IG9wdGlvbnNbaV0sCgkJCQlhdHRyID0gb3B0aW9uLmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJyksCgkJCQlvcHRpb25WYWx1ZSA9IChhdHRyICYmIGF0dHIuc3BlY2lmaWVkKSA/IG9wdGlvbi52YWx1ZSA6IG9wdGlvbi5nZXQoJ3RleHQnKTsKCQkJaWYgKG9wdGlvblZhbHVlID09IHZhbHVlKSByZXR1cm4gb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTsKCQl9Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9uID0gdGhpcywgdGFnID0gb3B0aW9uLmdldCgndGFnJyk7CgoJCWlmICh0YWcgIT0gJ3NlbGVjdCcgJiYgdGFnICE9ICdvcHRpb24nKSByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eSgndmFsdWUnKTsKCgkJaWYgKHRhZyA9PSAnc2VsZWN0JyAmJiAhKG9wdGlvbiA9IG9wdGlvbi5nZXRTZWxlY3RlZCgpWzBdKSkgcmV0dXJuICcnOwoKCQl2YXIgYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpOwoJCXJldHVybiAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7Cgl9Cgp9OwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwppZiAoZWwuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKSkgRWxlbWVudC5Qcm9wZXJ0aWVzLmlkID0gewoJc2V0OiBmdW5jdGlvbihpZCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9IGlkOwoJfSwKCWdldDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5pZCB8fCBudWxsOwoJfSwKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuaWQgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykudmFsdWUgPSAnJzsKCX0KfTsKLyo8L0lFPiovCgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKSwKCWhhc0ZpbHRlciA9IChodG1sLnN0eWxlLmZpbHRlciAhPSBudWxsKSwKCXJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldFZpc2liaWxpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWVsZW1lbnQuc3RvcmUoJyRvcGFjaXR5Jywgb3BhY2l0eSk7CgllbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSBvcGFjaXR5ID4gMCA/ICd2aXNpYmxlJyA6ICdoaWRkZW4nOwp9OwoKdmFyIHNldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJZWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gb3BhY2l0eTsKfSA6IChoYXNGaWx0ZXIgPyBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCW9wYWNpdHkgPSAob3BhY2l0eSAqIDEwMCkubGltaXQoMCwgMTAwKS5yb3VuZCgpOwoJb3BhY2l0eSA9IChvcGFjaXR5ID09IDEwMCkgPyAnJyA6ICdhbHBoYShvcGFjaXR5PScgKyBvcGFjaXR5ICsgJyknOwoJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgllbGVtZW50LnN0eWxlLmZpbHRlciA9IHJlQWxwaGEudGVzdChmaWx0ZXIpID8gZmlsdGVyLnJlcGxhY2UocmVBbHBoYSwgb3BhY2l0eSkgOiBmaWx0ZXIgKyBvcGFjaXR5Owp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlzZXRPcGFjaXR5KHRoaXMsIHBhcnNlRmxvYXQodmFsdWUpKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJaWYgKHByb3BlcnR5ID09ICdvcGFjaXR5JykgcmV0dXJuIGdldE9wYWNpdHkodGhpcyk7CgkJcHJvcGVydHkgPSAocHJvcGVydHkgPT0gJ2Zsb2F0JyA/IGZsb2F0TmFtZSA6IHByb3BlcnR5KS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKCgoKCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cywgaWYgbmVjZXNzYXJ5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50LCB0eXBlKSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlpZiAoY3VzdG9tLmJhc2UpIHJlYWxUeXBlID0gRnVuY3Rpb24uZnJvbShjdXN0b20uYmFzZSkuY2FsbCh0aGlzLCB0eXBlKTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IERPTUV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuLCBhcmd1bWVudHNbMl0pOwoJCX0KCQlldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZGVmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBsaXN0ID0gZXZlbnRzW3R5cGVdOwoJCXZhciBpbmRleCA9IGxpc3Qua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAoaW5kZXggPT0gLTEpIHJldHVybiB0aGlzOwoJCXZhciB2YWx1ZSA9IGxpc3QudmFsdWVzW2luZGV4XTsKCQlkZWxldGUgbGlzdC5rZXlzW2luZGV4XTsKCQlkZWxldGUgbGlzdC52YWx1ZXNbaW5kZXhdOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vblJlbW92ZSkgY3VzdG9tLm9uUmVtb3ZlLmNhbGwodGhpcywgZm4sIHR5cGUpOwoJCQlpZiAoY3VzdG9tLmJhc2UpIHR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIHBhc3RlOiAyLCBpbnB1dDogMiwgLy9mb3JtIGVsZW1lbnRzCglsb2FkOiAyLCB1bmxvYWQ6IDEsIGJlZm9yZXVubG9hZDogMiwgcmVzaXplOiAxLCBtb3ZlOiAxLCBET01Db250ZW50TG9hZGVkOiAxLCByZWFkeXN0YXRlY2hhbmdlOiAxLCAvL3dpbmRvdwoJZXJyb3I6IDEsIGFib3J0OiAxLCBzY3JvbGw6IDEgLy9taXNjCn07CgpFbGVtZW50LkV2ZW50cyA9IHttb3VzZXdoZWVsOiB7CgliYXNlOiAoQnJvd3Nlci5maXJlZm94KSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKfX07CgppZiAoJ29ubW91c2VlbnRlcicgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KXsKCUVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlZW50ZXIgPSBFbGVtZW50Lk5hdGl2ZUV2ZW50cy5tb3VzZWxlYXZlID0gMjsKfSBlbHNlIHsKCXZhciBjaGVjayA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CgkJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkJaWYgKCFyZWxhdGVkKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIChyZWxhdGVkICE9IHRoaXMgJiYgcmVsYXRlZC5wcmVmaXggIT0gJ3h1bCcgJiYgdHlwZU9mKHRoaXMpICE9ICdkb2N1bWVudCcgJiYgIXRoaXMuY29udGFpbnMocmVsYXRlZCkpOwoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWVudGVyID0gewoJCWJhc2U6ICdtb3VzZW92ZXInLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07CgoJRWxlbWVudC5FdmVudHMubW91c2VsZWF2ZSA9IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX07Cn0KCi8qPGx0SUU5PiovCmlmICghd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpewoJRWxlbWVudC5OYXRpdmVFdmVudHMucHJvcGVydHljaGFuZ2UgPSAyOwoJRWxlbWVudC5FdmVudHMuY2hhbmdlID0gewoJCWJhc2U6IGZ1bmN0aW9uKCl7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoJCQlyZXR1cm4gKHRoaXMuZ2V0KCd0YWcnKSA9PSAnaW5wdXQnICYmICh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSkgPyAncHJvcGVydHljaGFuZ2UnIDogJ2NoYW5nZScKCQl9LAoJCWNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gISEodGhpcy50eXBlICE9ICdyYWRpbycgfHwgdGhpcy5jaGVja2VkKTsKCQl9Cgl9Cn0KLyo8L2x0SUU5PiovCgoKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9LCBzZWxlY3RvclRlc3QgPSBuZXcgUmVnRXhwKCdeJyArIHNlbGVjdG9yLmVzY2FwZVJlZ0V4cCgpICsgJyQnKTsKCQlBcnJheS5lYWNoKGRvY3VtZW50LnN0eWxlU2hlZXRzLCBmdW5jdGlvbihzaGVldCwgail7CgkJCXZhciBocmVmID0gc2hlZXQuaHJlZjsKCQkJaWYgKGhyZWYgJiYgaHJlZi5jb250YWlucygnOi8vJykgJiYgIWhyZWYuY29udGFpbnMoZG9jdW1lbnQuZG9tYWluKSkgcmV0dXJuOwoJCQl2YXIgcnVsZXMgPSBzaGVldC5ydWxlcyB8fCBzaGVldC5jc3NSdWxlczsKCQkJQXJyYXkuZWFjaChydWxlcywgZnVuY3Rpb24ocnVsZSwgaSl7CgkJCQlpZiAoIXJ1bGUuc3R5bGUpIHJldHVybjsKCQkJCXZhciBzZWxlY3RvclRleHQgPSAocnVsZS5zZWxlY3RvclRleHQpID8gcnVsZS5zZWxlY3RvclRleHQucmVwbGFjZSgvXlx3Ky8sIGZ1bmN0aW9uKG0pewoJCQkJCXJldHVybiBtLnRvTG93ZXJDYXNlKCk7CgkJCQl9KSA6IG51bGw7CgkJCQlpZiAoIXNlbGVjdG9yVGV4dCB8fCAhc2VsZWN0b3JUZXN0LnRlc3Qoc2VsZWN0b3JUZXh0KSkgcmV0dXJuOwoJCQkJT2JqZWN0LmVhY2goRWxlbWVudC5TdHlsZXMsIGZ1bmN0aW9uKHZhbHVlLCBzdHlsZSl7CgkJCQkJaWYgKCFydWxlLnN0eWxlW3N0eWxlXSB8fCBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmV0dXJuOwoJCQkJCXZhbHVlID0gU3RyaW5nKHJ1bGUuc3R5bGVbc3R5bGVdKTsKCQkJCQl0b1tzdHlsZV0gPSAoKC9ecmdiLykudGVzdCh2YWx1ZSkpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKCgoKLyoKLS0tCgpuYW1lOiBGeC5Ud2VlbgoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgQ1NTIHByb3BlcnR5IGZvciBhbiBlbGVtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogW0Z4LlR3ZWVuLCBFbGVtZW50LmZhZGUsIEVsZW1lbnQuaGlnaGxpZ2h0XQoKLi4uCiovCgpGeC5Ud2VlbiA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogRnguQ1NTLAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9IHRoaXMuc3ViamVjdCA9IGRvY3VtZW50LmlkKGVsZW1lbnQpOwoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJfSwKCglzZXQ6IGZ1bmN0aW9uKHByb3BlcnR5LCBub3cpewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCQlub3cgPSBwcm9wZXJ0eTsKCQkJcHJvcGVydHkgPSB0aGlzLnByb3BlcnR5IHx8IHRoaXMub3B0aW9ucy5wcm9wZXJ0eTsKCQl9CgkJdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwcm9wZXJ0eSwgbm93LCB0aGlzLm9wdGlvbnMudW5pdCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0eSwgZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0eSwgZnJvbSwgdG8pKSByZXR1cm4gdGhpczsKCQl2YXIgYXJncyA9IEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKTsKCQl0aGlzLnByb3BlcnR5ID0gdGhpcy5vcHRpb25zLnByb3BlcnR5IHx8IGFyZ3Muc2hpZnQoKTsKCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgdGhpcy5wcm9wZXJ0eSwgYXJncyk7CgkJcmV0dXJuIHRoaXMucGFyZW50KHBhcnNlZC5mcm9tLCBwYXJzZWQudG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMudHdlZW4gPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgndHdlZW4nKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHR3ZWVuID0gdGhpcy5yZXRyaWV2ZSgndHdlZW4nKTsKCQlpZiAoIXR3ZWVuKXsKCQkJdHdlZW4gPSBuZXcgRnguVHdlZW4odGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ3R3ZWVuJywgdHdlZW4pOwoJCX0KCQlyZXR1cm4gdHdlZW47Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXR3ZWVuOiBmdW5jdGlvbihwcm9wZXJ0eSwgZnJvbSwgdG8pewoJCXRoaXMuZ2V0KCd0d2VlbicpLnN0YXJ0KHByb3BlcnR5LCBmcm9tLCB0byk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZhZGU6IGZ1bmN0aW9uKGhvdyl7CgkJdmFyIGZhZGUgPSB0aGlzLmdldCgndHdlZW4nKSwgbWV0aG9kLCB0bywgdG9nZ2xlOwoJCWlmIChob3cgPT0gbnVsbCkgaG93ID0gJ3RvZ2dsZSc7CgkJc3dpdGNoIChob3cpewoJCQljYXNlICdpbic6IG1ldGhvZCA9ICdzdGFydCc7IHRvID0gMTsgYnJlYWs7CgkJCWNhc2UgJ291dCc6IG1ldGhvZCA9ICdzdGFydCc7IHRvID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBtZXRob2QgPSAnc2V0JzsgdG8gPSAxOyBicmVhazsKCQkJY2FzZSAnaGlkZSc6IG1ldGhvZCA9ICdzZXQnOyB0byA9IDA7IGJyZWFrOwoJCQljYXNlICd0b2dnbGUnOgoJCQkJdmFyIGZsYWcgPSB0aGlzLnJldHJpZXZlKCdmYWRlOmZsYWcnLCB0aGlzLmdldFN0eWxlKCdvcGFjaXR5JykgPT0gMSk7CgkJCQltZXRob2QgPSAnc3RhcnQnOwoJCQkJdG8gPSBmbGFnID8gMCA6IDE7CgkJCQl0aGlzLnN0b3JlKCdmYWRlOmZsYWcnLCAhZmxhZyk7CgkJCQl0b2dnbGUgPSB0cnVlOwoJCQlicmVhazsKCQkJZGVmYXVsdDogbWV0aG9kID0gJ3N0YXJ0JzsgdG8gPSBob3c7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJZmFkZVttZXRob2RdKCdvcGFjaXR5JywgdG8pOwoJCWlmIChtZXRob2QgPT0gJ3NldCcgfHwgdG8gIT0gMCkgdGhpcy5zZXRTdHlsZSgndmlzaWJpbGl0eScsIHRvID09IDAgPyAnaGlkZGVuJyA6ICd2aXNpYmxlJyk7CgkJZWxzZSBmYWRlLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgndmlzaWJpbGl0eScsICdoaWRkZW4nKTsKCQkJdGhpcy5jYWxsQ2hhaW4oKTsKCQl9KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGlnaGxpZ2h0OiBmdW5jdGlvbihzdGFydCwgZW5kKXsKCQlpZiAoIWVuZCl7CgkJCWVuZCA9IHRoaXMucmV0cmlldmUoJ2hpZ2hsaWdodDpvcmlnaW5hbCcsIHRoaXMuZ2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InKSk7CgkJCWVuZCA9IChlbmQgPT0gJ3RyYW5zcGFyZW50JykgPyAnI2ZmZicgOiBlbmQ7CgkJfQoJCXZhciB0d2VlbiA9IHRoaXMuZ2V0KCd0d2VlbicpOwoJCXR3ZWVuLnN0YXJ0KCdiYWNrZ3JvdW5kLWNvbG9yJywgc3RhcnQgfHwgJyNmZmZmODgnLCBlbmQpLmNoYWluKGZ1bmN0aW9uKCl7CgkJCXRoaXMuc2V0U3R5bGUoJ2JhY2tncm91bmQtY29sb3InLCB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnKSk7CgkJCXR3ZWVuLmNhbGxDaGFpbigpOwoJCX0uYmluZCh0aGlzKSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4Lk1vcnBoCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGVzLCBlZmZlY3QgdG8gdHJhbnNpdGlvbiBhbnkgbnVtYmVyIG9mIENTUyBwcm9wZXJ0aWVzIGZvciBhbiBlbGVtZW50IHVzaW5nIGFuIG9iamVjdCBvZiBydWxlcywgb3IgQ1NTIGJhc2VkIHNlbGVjdG9yIHJ1bGVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRnguQ1NTCgpwcm92aWRlczogRnguTW9ycGgKCi4uLgoqLwoKRnguTW9ycGggPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCWlmICh0eXBlb2Ygbm93ID09ICdzdHJpbmcnKSBub3cgPSB0aGlzLnNlYXJjaChub3cpOwoJCWZvciAodmFyIHAgaW4gbm93KSB0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHAsIG5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBub3cgPSB7fTsKCQlmb3IgKHZhciBwIGluIGZyb20pIG5vd1twXSA9IHRoaXMucGFyZW50KGZyb21bcF0sIHRvW3BdLCBkZWx0YSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCWlmICghdGhpcy5jaGVjayhwcm9wZXJ0aWVzKSkgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzID09ICdzdHJpbmcnKSBwcm9wZXJ0aWVzID0gdGhpcy5zZWFyY2gocHJvcGVydGllcyk7CgkJdmFyIGZyb20gPSB7fSwgdG8gPSB7fTsKCQlmb3IgKHZhciBwIGluIHByb3BlcnRpZXMpewoJCQl2YXIgcGFyc2VkID0gdGhpcy5wcmVwYXJlKHRoaXMuZWxlbWVudCwgcCwgcHJvcGVydGllc1twXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChmcm9tLCB0byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5tb3JwaCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCdtb3JwaCcpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgbW9ycGggPSB0aGlzLnJldHJpZXZlKCdtb3JwaCcpOwoJCWlmICghbW9ycGgpewoJCQltb3JwaCA9IG5ldyBGeC5Nb3JwaCh0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgnbW9ycGgnLCBtb3JwaCk7CgkJfQoJCXJldHVybiBtb3JwaDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbW9ycGg6IGZ1bmN0aW9uKHByb3BzKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5zdGFydChwcm9wcyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4LlRyYW5zaXRpb25zCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgYSBzZXQgb2YgYWR2YW5jZWQgdHJhbnNpdGlvbnMgdG8gYmUgdXNlZCB3aXRoIGFueSBvZiB0aGUgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVhc2luZyBFcXVhdGlvbnMgYnkgUm9iZXJ0IFBlbm5lciwgPGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcvPiwgbW9kaWZpZWQgYW5kIG9wdGltaXplZCB0byBiZSB1c2VkIHdpdGggTW9vVG9vbHMuCgpyZXF1aXJlczogRngKCnByb3ZpZGVzOiBGeC5UcmFuc2l0aW9ucwoKLi4uCiovCgpGeC5pbXBsZW1lbnQoewoKCWdldFRyYW5zaXRpb246IGZ1bmN0aW9uKCl7CgkJdmFyIHRyYW5zID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gfHwgRnguVHJhbnNpdGlvbnMuU2luZS5lYXNlSW5PdXQ7CgkJaWYgKHR5cGVvZiB0cmFucyA9PSAnc3RyaW5nJyl7CgkJCXZhciBkYXRhID0gdHJhbnMuc3BsaXQoJzonKTsKCQkJdHJhbnMgPSBGeC5UcmFuc2l0aW9uczsKCQkJdHJhbnMgPSB0cmFuc1tkYXRhWzBdXSB8fCB0cmFuc1tkYXRhWzBdLmNhcGl0YWxpemUoKV07CgkJCWlmIChkYXRhWzFdKSB0cmFucyA9IHRyYW5zWydlYXNlJyArIGRhdGFbMV0uY2FwaXRhbGl6ZSgpICsgKGRhdGFbMl0gPyBkYXRhWzJdLmNhcGl0YWxpemUoKSA6ICcnKV07CgkJfQoJCXJldHVybiB0cmFuczsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBBcnJheS5mcm9tKHBhcmFtcyk7Cgl2YXIgZWFzZUluID0gZnVuY3Rpb24ocG9zKXsKCQlyZXR1cm4gdHJhbnNpdGlvbihwb3MsIHBhcmFtcyk7Cgl9OwoJcmV0dXJuIE9iamVjdC5hcHBlbmQoZWFzZUluLCB7CgkJZWFzZUluOiBlYXNlSW4sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSA/IHRyYW5zaXRpb24oMiAqIHBvcywgcGFyYW1zKSA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSkgLyAyOwoJCX0KCX0pOwp9OwoKRnguVHJhbnNpdGlvbnMgPSB7CgoJbGluZWFyOiBmdW5jdGlvbih6ZXJvKXsKCQlyZXR1cm4gemVybzsKCX0KCn07CgoKCkZ4LlRyYW5zaXRpb25zLmV4dGVuZCA9IGZ1bmN0aW9uKHRyYW5zaXRpb25zKXsKCWZvciAodmFyIHRyYW5zaXRpb24gaW4gdHJhbnNpdGlvbnMpIEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24odHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0pOwp9OwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kKHsKCglQb3c6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdyhwLCB4ICYmIHhbMF0gfHwgNik7Cgl9LAoKCUV4cG86IGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdygyLCA4ICogKHAgLSAxKSk7Cgl9LAoKCUNpcmM6IGZ1bmN0aW9uKHApewoJCXJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHApKTsKCX0sCgoJU2luZTogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyhwICogTWF0aC5QSSAvIDIpOwoJfSwKCglCYWNrOiBmdW5jdGlvbihwLCB4KXsKCQl4ID0geCAmJiB4WzBdIHx8IDEuNjE4OwoJCXJldHVybiBNYXRoLnBvdyhwLCAyKSAqICgoeCArIDEpICogcCAtIHgpOwoJfSwKCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IGIgKiBiIC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMik7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHggJiYgeFswXSB8fCAxKSAvIDMpOwoJfQoKfSk7CgpbJ1F1YWQnLCAnQ3ViaWMnLCAnUXVhcnQnLCAnUXVpbnQnXS5lYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24sIGkpewoJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbihmdW5jdGlvbihwKXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgaSArIDIpOwoJfSk7Cn0pOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdAoKZGVzY3JpcHRpb246IFBvd2VyZnVsIGFsbCBwdXJwb3NlIFJlcXVlc3QgQ2xhc3MuIFVzZXMgWE1MSFRUUFJlcXVlc3QuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbT2JqZWN0LCBFbGVtZW50LCBDaGFpbiwgRXZlbnRzLCBPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IFJlcXVlc3QKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZW1wdHkgPSBmdW5jdGlvbigpe30sCglwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoKCWxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdsb2Fkc3RhcnQnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzZW5kOiBmdW5jdGlvbihvcHRpb25zKXsKCQlpZiAoIXRoaXMuY2hlY2sob3B0aW9ucykpIHJldHVybiB0aGlzOwoKCQl0aGlzLm9wdGlvbnMuaXNTdWNjZXNzID0gdGhpcy5vcHRpb25zLmlzU3VjY2VzcyB8fCB0aGlzLmlzU3VjY2VzczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQl2YXIgdHlwZSA9IHR5cGVPZihvcHRpb25zKTsKCQlpZiAodHlwZSA9PSAnc3RyaW5nJyB8fCB0eXBlID09ICdlbGVtZW50Jykgb3B0aW9ucyA9IHtkYXRhOiBvcHRpb25zfTsKCgkJdmFyIG9sZCA9IHRoaXMub3B0aW9uczsKCQlvcHRpb25zID0gT2JqZWN0LmFwcGVuZCh7ZGF0YTogb2xkLmRhdGEsIHVybDogb2xkLnVybCwgbWV0aG9kOiBvbGQubWV0aG9kfSwgb3B0aW9ucyk7CgkJdmFyIGRhdGEgPSBvcHRpb25zLmRhdGEsIHVybCA9IFN0cmluZyhvcHRpb25zLnVybCksIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kLnRvTG93ZXJDYXNlKCk7CgoJCXN3aXRjaCAodHlwZU9mKGRhdGEpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGRhdGEgPSBkb2N1bWVudC5pZChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzogZGF0YSA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKGRhdGEpOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpewoJCQl2YXIgZm9ybWF0ID0gJ2Zvcm1hdD0nICsgdGhpcy5vcHRpb25zLmZvcm1hdDsKCQkJZGF0YSA9IChkYXRhKSA/IGZvcm1hdCArICcmJyArIGRhdGEgOiBmb3JtYXQ7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmVtdWxhdGlvbiAmJiAhWydnZXQnLCAncG9zdCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2Q7CgkJCWRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2Q7CgkJCW1ldGhvZCA9ICdwb3N0JzsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiBbJ3Bvc3QnLCAncHV0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuaGVhZGVyc1snQ29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nOwoJCX0KCgkJaWYgKCF1cmwpIHVybCA9IGRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lOwoKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQllbHNlIGlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLmZpcmVFdmVudCgnY2FuY2VsJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciBtZXRob2RzID0ge307ClsnZ2V0JywgJ3Bvc3QnLCAncHV0JywgJ2RlbGV0ZScsICdHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJ10uZWFjaChmdW5jdGlvbihtZXRob2QpewoJbWV0aG9kc1ttZXRob2RdID0gZnVuY3Rpb24oZGF0YSl7CgkJdmFyIG9iamVjdCA9IHsKCQkJbWV0aG9kOiBtZXRob2QKCQl9OwoJCWlmIChkYXRhICE9IG51bGwpIG9iamVjdC5kYXRhID0gZGF0YTsKCQlyZXR1cm4gdGhpcy5zZW5kKG9iamVjdCk7Cgl9Owp9KTsKClJlcXVlc3QuaW1wbGVtZW50KG1ldGhvZHMpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnNlbmQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgc2VuZCA9IHRoaXMuZ2V0KCdzZW5kJykuY2FuY2VsKCk7CgkJc2VuZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHNlbmQgPSB0aGlzLnJldHJpZXZlKCdzZW5kJyk7CgkJaWYgKCFzZW5kKXsKCQkJc2VuZCA9IG5ldyBSZXF1ZXN0KHsKCQkJCWRhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCBtZXRob2Q6IHRoaXMuZ2V0KCdtZXRob2QnKSB8fCAncG9zdCcsIHVybDogdGhpcy5nZXQoJ2FjdGlvbicpCgkJCX0pOwoJCQl0aGlzLnN0b3JlKCdzZW5kJywgc2VuZCk7CgkJfQoJCXJldHVybiBzZW5kOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzZW5kOiBmdW5jdGlvbih1cmwpewoJCXZhciBzZW5kZXIgPSB0aGlzLmdldCgnc2VuZCcpOwoJCXNlbmRlci5zZW5kKHtkYXRhOiB0aGlzLCB1cmw6IHVybCB8fCBzZW5kZXIub3B0aW9ucy51cmx9KTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cyhvcHRpb25zLmZpbHRlciB8fCAnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50czsKCQlpZiAob3B0aW9ucy51cGRhdGUpewoJCQl2YXIgdXBkYXRlID0gZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgdXBkYXRlLmFkb3B0KHJlc3BvbnNlLmVsZW1lbnRzKTsKCQkJZWxzZSB1cGRhdGUuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJfSBlbHNlIGlmIChvcHRpb25zLmFwcGVuZCl7CgkJCXZhciBhcHBlbmQgPSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCk7CgkJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UuZWxlbWVudHMucmV2ZXJzZSgpLmluamVjdChhcHBlbmQpOwoJCQllbHNlIGFwcGVuZC5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCX0KCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBKU09OCgpkZXNjcmlwdGlvbjogSlNPTiBlbmNvZGVyIGFuZCBkZWNvZGVyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpTZWVBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKCgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdCwgRWxlbWVudF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgp2YXIgU3dpZmYgPSBuZXcgQ2xhc3MoewoKICAgIEltcGxlbWVudHM6IE9wdGlvbnMsCgogICAgb3B0aW9uczogewogICAgICAgIGlkOiBudWxsLAogICAgICAgIGhlaWdodDogMSwKICAgICAgICB3aWR0aDogMSwKICAgICAgICBjb250YWluZXI6IG51bGwsCiAgICAgICAgcHJvcGVydGllczoge30sCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIHF1YWxpdHk6ICdoaWdoJywKICAgICAgICAgICAgYWxsb3dTY3JpcHRBY2Nlc3M6ICdhbHdheXMnLAogICAgICAgICAgICB3TW9kZTogJ3dpbmRvdycsCiAgICAgICAgICAgIHN3TGl2ZUNvbm5lY3Q6IHRydWUKICAgICAgICB9LAogICAgICAgIGNhbGxCYWNrczoge30sCiAgICAgICAgdmFyczoge30KICAgIH0sCgogICAgdG9FbGVtZW50OiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLm9iamVjdDsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ocGF0aCwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5pbnN0YW5jZSA9ICdTd2lmZl8nICsgU3RyaW5nLnVuaXF1ZUlEKCk7CiAgICAgICAgdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwogICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgdmFyIGlkID0gdGhpcy5pZCA9IG9wdGlvbnMuaWQgfHwgdGhpcy5pbnN0YW5jZTsKICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuaWQob3B0aW9ucy5jb250YWluZXIpOwoKICAgICAgICBTd2lmZi5DYWxsQmFja3NbdGhpcy5pbnN0YW5jZV0gPSB7fTsKCiAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnMucGFyYW1zLCB2YXJzID0gb3B0aW9ucy52YXJzLCBjYWxsQmFja3MgPSBvcHRpb25zLmNhbGxCYWNrczsKICAgICAgICB2YXIgcHJvcGVydGllcyA9IE9iamVjdC5hcHBlbmQoe2hlaWdodDogb3B0aW9ucy5oZWlnaHQsIHdpZHRoOiBvcHRpb25zLndpZHRofSwgb3B0aW9ucy5wcm9wZXJ0aWVzKTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBmb3IgKHZhciBjYWxsQmFjayBpbiBjYWxsQmFja3MpewogICAgICAgICAgICBTd2lmZi5DYWxsQmFja3NbdGhpcy5pbnN0YW5jZV1bY2FsbEJhY2tdID0gKGZ1bmN0aW9uKG9wdGlvbil7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uLmFwcGx5KHNlbGYub2JqZWN0LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkoY2FsbEJhY2tzW2NhbGxCYWNrXSk7CiAgICAgICAgICAgIHZhcnNbY2FsbEJhY2tdID0gJ1N3aWZmLkNhbGxCYWNrcy4nICsgdGhpcy5pbnN0YW5jZSArICcuJyArIGNhbGxCYWNrOwogICAgICAgIH0KCiAgICAgICAgcGFyYW1zLmZsYXNoVmFycyA9IE9iamVjdC50b1F1ZXJ5U3RyaW5nKHZhcnMpOwogICAgICAgIGlmIChCcm93c2VyLmllKXsKICAgICAgICAgICAgcHJvcGVydGllcy5jbGFzc2lkID0gJ2Nsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCc7CiAgICAgICAgICAgIHBhcmFtcy5tb3ZpZSA9IHBhdGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvcGVydGllcy50eXBlID0gJ2FwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoJzsKICAgICAgICB9CiAgICAgICAgcHJvcGVydGllcy5kYXRhID0gcGF0aDsKCiAgICAgICAgdmFyIGJ1aWxkID0gJzxvYmplY3QgaWQ9IicgKyBpZCArICciJzsKICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eSBpbiBwcm9wZXJ0aWVzKSBidWlsZCArPSAnICcgKyBwcm9wZXJ0eSArICc9IicgKyBwcm9wZXJ0aWVzW3Byb3BlcnR5XSArICciJzsKICAgICAgICBidWlsZCArPSAnPic7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKXsKICAgICAgICAgICAgaWYgKHBhcmFtc1twYXJhbV0pIGJ1aWxkICs9ICc8cGFyYW0gbmFtZT0iJyArIHBhcmFtICsgJyIgdmFsdWU9IicgKyBwYXJhbXNbcGFyYW1dICsgJyIgLz4nOwogICAgICAgIH0KICAgICAgICBidWlsZCArPSAnPC9vYmplY3Q+JzsKICAgICAgICB0aGlzLm9iamVjdCA9ICgoY29udGFpbmVyKSA/IGNvbnRhaW5lci5lbXB0eSgpIDogbmV3IEVsZW1lbnQoJ2RpdicpKS5zZXQoJ2h0bWwnLCBidWlsZCkuZmlyc3RDaGlsZDsKICAgIH0sCgogICAgcmVwbGFjZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKTsKICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMudG9FbGVtZW50KCksIGVsZW1lbnQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgICBkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVtb3RlOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5hcHBlbmQoYXJndW1lbnRzKSk7CiAgICB9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7CiAgICB2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwogICAgcmV0dXJuIGV2YWwocnMpOwp9OwoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovKjxsdElFOD4qLwovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCi8vIHRlc3RFbGVtZW50LmRvU2Nyb2xsKCkgdGhyb3dzIHdoZW4gdGhlIERPTSBpcyBub3QgcmVhZHksIG9ubHkgaW4gdGhlIHRvcCB3aW5kb3cKdmFyIGRvU2Nyb2xsV29ya3MgPSBmdW5jdGlvbigpewoJdHJ5IHsKCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCXJldHVybiB0cnVlOwoJfSBjYXRjaCAoZSl7fQoJcmV0dXJuIGZhbHNlOwp9OwovLyBJZiBkb1Njcm9sbCB3b3JrcyBhbHJlYWR5LCBpdCBjYW4ndCBiZSB1c2VkIHRvIGRldGVybWluZSBkb21yZWFkeQovLyAgIGUuZy4gaW4gYW4gaWZyYW1lCmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhZG9TY3JvbGxXb3JrcygpKXsKCWNoZWNrcy5wdXNoKGRvU2Nyb2xsV29ya3MpOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KLyo8L2x0SUU4PiovCgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:25:15 GMT",
                    "Content-Length": "147603",
                    "Date": "Sat, 08 Nov 2014 20:25:16 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}