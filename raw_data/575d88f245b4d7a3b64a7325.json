{
    "url": "http://localhost:9999/nickradford/Smart-Table/smart-table-module/lib/angular/angular.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/nickradford/Smart-Table/smart-table-module/lib/angular/angular.js",
                "path": "/nickradford/Smart-Table/smart-table-module/lib/angular/angular.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uaWNrcmFkZm9yZC9TbWFydC1UYWJsZS9zbWFydC10YWJsZS1tb2R1bGUvbGliL2FuZ3VsYXIvYW5ndWxhci5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTk5ODkzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDE5OjQ4OjAwIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAxOTo0Nzo1OSBHTVQNCg0KLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4wLjcKICogKGMpIDIwMTAtMjAxMiBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogICAgJ3VzZSBzdHJpY3QnOwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IExvd2VyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gdXBwZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsKICAgIH07CgoKICAgIHZhciBtYW51YWxMb3dlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7CiAgICAgICAgfSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW2Etel0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpOwogICAgICAgIH0pCiAgICAgICAgICAgIDogczsKICAgIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICAgIGlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICAgIH0KCgogICAgdmFyIC8qKiBob2xkcyBtYWpvciB2ZXJzaW9uIG51bWJlciBmb3IgSUUgb3IgTmFOIGZvciByZWFsIGJyb3dzZXJzICovCiAgICAgICAgICAgIG1zaWUgPSBpbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKSwKICAgICAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICAgICAgalF1ZXJ5LCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZwogICAgICAgIHNsaWNlID0gW10uc2xpY2UsCiAgICAgICAgcHVzaCA9IFtdLnB1c2gsCiAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoKICAgICAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgICAgICAgICBhbmd1bGFyID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCA9IFsnMCcsICcwJywgJzAnXTsKCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBvYmoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywgLi4uKQogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAvLyBXZSBoYXZlIG9uIG9iamVjdCB3aGljaCBoYXMgbGVuZ3RoIHByb3BlcnR5LiBTaG91bGQgd2UgdHJlYXQgaXQgYXMgYXJyYXk/CiAgICAgICAgaWYgKHR5cGVvZiBvYmouaGFzT3duUHJvcGVydHkgIT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgICB0eXBlb2Ygb2JqLmNvbnN0cnVjdG9yICE9ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBoZXJlIGZvciBJRTg6IGl0IGlzIGEgYm9ndXMgb2JqZWN0IHRyZWF0IGl0IGFzIGFycmF5OwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgSlFMaXRlIHx8ICAgICAgICAgICAgICAgICAgICAgIC8vIEpRTGl0ZQogICAgICAgICAgICAgICAgKGpRdWVyeSAmJiBvYmogaW5zdGFuY2VvZiBqUXVlcnkpIHx8ICAgICAgICAgIC8vIGpRdWVyeQogICAgICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChvYmopICE9PSAnW29iamVjdCBPYmplY3RdJyB8fCAgIC8vIHNvbWUgYnJvd3NlciBuYXRpdmUgb2JqZWN0CiAgICAgICAgICAgICAgICB0eXBlb2Ygb2JqLmNhbGxlZSA9PT0gJ2Z1bmN0aW9uJzsgICAgICAgICAgICAgIC8vIGFyZ3VtZW50cyAob24gSUU4IGxvb2tzIGxpa2UgcmVndWxhciBvYmopCiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgICAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5KWAsIHdoZXJlIGB2YWx1ZWAKICAgICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIHdhcyBwcmV2aW91c2x5IGtub3duIGFzIGBhbmd1bGFyLmZvcmVhY2hgLgogICAgICoKICAgICA8cHJlPgogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5OwogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPSAncHJvdG90eXBlJyAmJiBrZXkgIT0gJ2xlbmd0aCcgJiYga2V5ICE9ICduYW1lJyAmJiBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChvYmouZm9yRWFjaCAmJiBvYmouZm9yRWFjaCAhPT0gZm9yRWFjaCkgewogICAgICAgICAgICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleXMuc29ydCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvckVhY2hTb3J0ZWQob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciBrZXlzID0gc29ydGVkS2V5cyhvYmopOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzOwogICAgfQoKCiAgICAvKioKICAgICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBpdGVyYXRvckZuKGtleSwgdmFsdWUpCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZSAoaW5kZXgpIHsKICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAgICogQHBhcmFtIGggdGhlIGhhc2hrZXkgKCF0cnV0aHkgdG8gZGVsZXRlIHRoZSBoYXNoa2V5KQogICAgICovCiAgICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAgICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgICAgICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2V0SGFzaEtleShkc3QsIGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICAgICAgfSwge3Byb3RvdHlwZTogcGFyZW50fSkpKCksIGV4dHJhKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubm9vcAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgICAgPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CgogICAgbm9vcC4kaW5qZWN0ID0gW107CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlkZW50aXR5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGl0cyBmaXJzdCBhcmd1bWVudC4gVGhpcyBmdW5jdGlvbiBpcyB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAgICoKICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBpZGVudGl0eSgkKSB7CiAgICAgICAgcmV0dXJuICQ7CiAgICB9CgogICAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyB1bmRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIHVuZGVmaW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBkZWZpbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBkZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc09iamVjdAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAgICAgKiBjb25zaWRlcmVkIHRvIGJlIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogICAgICovCiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNTdHJpbmcKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBTdHJpbmdgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBTdHJpbmdgLgogICAgICovCiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZyc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzTnVtYmVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgTnVtYmVyYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgTnVtYmVyYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgRGF0ZV0nOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgQXJyYXldJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNGdW5jdGlvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogICAgICovCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nOwogICAgfQoKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAgICovCiAgICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdib29sZWFuJzsKICAgIH0KCgogICAgZnVuY3Rpb24gdHJpbSh2YWx1ZSkgewogICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0VsZW1lbnQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUgJiYKICAgICAgICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgICAgICAgICB8fCAobm9kZS5iaW5kICYmIG5vZGUuZmluZCkpOyAgLy8gd2UgaGF2ZSBhIGJpbmQgYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAgICovCiAgICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIG9ialsgaXRlbXNbaV0gXSA9IHRydWU7CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCgogICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50IDogZWxlbWVudFswXTsKICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcpCiAgICAgICAgICAgICAgICA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICBub2RlTmFtZV8gPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICAgICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzIGFuIG9iamVjdCBoYXMsIG9yCiAgICAgKiB0aGUgbGVuZ3RoIG9mIGEgc3RyaW5nLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBhbmd1bGFyLk9iamVjdH0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8c3RyaW5nfSBvYmogT2JqZWN0LCBhcnJheSwgb3Igc3RyaW5nIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNpemUob2JqLCBvd25Qcm9wc09ubHkpIHsKICAgICAgICB2YXIgc2l6ZSA9IDAsIGtleTsKCiAgICAgICAgaWYgKGlzQXJyYXkob2JqKSB8fCBpc1N0cmluZyhvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBvYmoubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgICAgICAgICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2l6ZTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5jbHVkZXMoYXJyYXksIG9iaikgewogICAgICAgIHJldHVybiBpbmRleE9mKGFycmF5LCBvYmopICE9IC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIG9iaikgewogICAgICAgIGlmIChhcnJheS5pbmRleE9mKSByZXR1cm4gYXJyYXkuaW5kZXhPZihvYmopOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogICAgICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgZnVuY3Rpb24gaXNMZWFmTm9kZShub2RlKSB7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJPUFRJT04iOgogICAgICAgICAgICAgICAgY2FzZSAiUFJFIjoKICAgICAgICAgICAgICAgIGNhc2UgIlRJVExFIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuY29weQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogICAgICoKICAgICAqICogSWYgbm8gZGVzdGluYXRpb24gaXMgc3VwcGxpZWQsIGEgY29weSBvZiB0aGUgb2JqZWN0IG9yIGFycmF5IGlzIGNyZWF0ZWQuCiAgICAgKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAgICAgKiAgIGFyZSBkZWxldGVkIGFuZCB0aGVuIGFsbCBlbGVtZW50cy9wcm9wZXJ0aWVzIGZyb20gdGhlIHNvdXJjZSBhcmUgY29waWVkIHRvIGl0LgogICAgICogKiBJZiAgYHNvdXJjZWAgaXMgbm90IGFuIG9iamVjdCBvciBhcnJheSwgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gc291cmNlIFRoZSBzb3VyY2UgdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAgICAgKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxBcnJheSk9fSBkZXN0aW5hdGlvbiBEZXN0aW5hdGlvbiBpbnRvIHdoaWNoIHRoZSBzb3VyY2UgaXMgY29waWVkLiBJZgogICAgICogICAgIHByb3ZpZGVkLCBtdXN0IGJlIG9mIHRoZSBzYW1lIHR5cGUgYXMgYHNvdXJjZWAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbikgewogICAgICAgIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgdGhyb3cgRXJyb3IoIkNhbid0IGNvcHkgV2luZG93IG9yIFNjb3BlIik7CiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IGVxdWl2YWxlbnQgb2JqZWN0cyBvciBhcnJheXMiKTsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24ucHVzaChjb3B5KHNvdXJjZVtpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IGNvcHkoc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0SGFzaEtleShkZXN0aW5hdGlvbiwgaCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICAgICAgICBpZiAoc3JjLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LnN1YnN0cigwLCAyKSAhPT0gJyQkJykgewogICAgICAgICAgICAgICAgZHN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRzdDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZXF1YWxzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgdHdvIG9iamVjdHMgb3IgdHdvIHZhbHVlcyBhcmUgZXF1aXZhbGVudC4gU3VwcG9ydHMgdmFsdWUgdHlwZXMsIGFycmF5cyBhbmQKICAgICAqIG9iamVjdHMuCiAgICAgKgogICAgICogVHdvIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgaWYgYXQgbGVhc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgdHJ1ZToKICAgICAqCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogICAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBvZiB0aGUgc2FtZSB0eXBlIGFuZCBhbGwgb2YgdGhlaXIgcHJvcGVydGllcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhc1NjcmlwdCwgTmFOID09IE5hTiA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byBOYU4gYXMgZXF1YWwpCiAgICAgKgogICAgICogRHVyaW5nIGEgcHJvcGVydHkgY29tcGFyaXNpb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgICAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICAgICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgIGlmICh0MSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChsZW5ndGggPSBvMS5sZW5ndGgpID09IG8yLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSA9IDA7IGtleSA8IGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2V5U2V0W2tleV0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbzJba2V5XSAhPT0gdW5kZWZpbmVkICYmICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5jYWxsKHNlbGYpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGluIElFLCBuYXRpdmUgbWV0aG9kcyBhcmUgbm90IGZ1bmN0aW9ucyBzbyB0aGV5IGNhbm5vdCBiZSBib3VuZCAobm90ZTogdGhleSBkb24ndCBuZWVkIHRvIGJlKQogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiB0b0pzb25SZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIHZhbCA9IHZhbHVlOwoKICAgICAgICBpZiAoL15cJCsvLnRlc3Qoa2V5KSkgewogICAgICAgICAgICB2YWwgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIGlmIChpc1dpbmRvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRXSU5ET1cnOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhbCA9ICckRE9DVU1FTlQnOwogICAgICAgIH0gZWxzZSBpZiAoaXNTY29wZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRTQ09QRSc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci50b0pzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2VyaWFsaXplcyBpbnB1dCBpbnRvIGEgSlNPTi1mb3JtYXR0ZWQgc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gSnNvbmlmaWVkIHN0cmluZyByZXByZXNlbnRpbmcgYG9iamAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvSnNvbihvYmosIHByZXR0eSkgewogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmZyb21Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlc2VyaWFsaXplcyBhIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZyb21Kc29uKGpzb24pIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcoanNvbikKICAgICAgICAgICAgPyBKU09OLnBhcnNlKGpzb24pCiAgICAgICAgICAgIDoganNvbjsKICAgIH0KCgogICAgZnVuY3Rpb24gdG9Cb29sZWFuKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgICAgICAgICAgdmFsdWUgPSAhKHYgPT0gJ2YnIHx8IHYgPT0gJzAnIHx8IHYgPT0gJ2ZhbHNlJyB8fCB2ID09ICdubycgfHwgdiA9PSAnbicgfHwgdiA9PSAnW10nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YXJ0aW5nVGFnKGVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpLmNsb25lKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gdHVybnMgb3V0IElFIGRvZXMgbm90IGxldCB5b3Ugc2V0IC5odG1sKCkgb24gZWxlbWVudHMgd2hpY2gKICAgICAgICAgICAgLy8gYXJlIG5vdCBhbGxvd2VkIHRvIGhhdmUgY2hpbGRyZW4uIFNvIHdlIGp1c3QgaWdub3JlIGl0LgogICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgICAgICAgICAgICBtYXRjaCgvXig8W14+XSs+KS8pWzFdLgogICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24gKG1hdGNoLCBub2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEByZXR1cm5zIE9iamVjdC48KHN0cmluZ3xib29sZWFuKT4KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgICAgICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKGtleVZhbHVlKSB7CiAgICAgICAgICAgIGlmIChrZXlWYWx1ZSkgewogICAgICAgICAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMV0pIDogdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7CiAgICB9CgoKICAgIC8qKgogICAgICogV2UgbmVlZCBvdXIgY3VzdG9tIG1ldGhvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICAgKiBzZWdtZW50czoKICAgICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICAgKiBtZXRob2QgYmVjdWFzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZW5jb2RlcyBzdHVmZiB0aGF0IGRvZXNuJ3QgaGF2ZSB0byBiZQogICAgICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICAgICAqICAgIHF1ZXJ5ICAgICAgID0gKiggcGNoYXIgLyAiLyIgLyAiPyIgKQogICAgICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICAgICAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlVXJpUXVlcnkodmFsLCBwY3RFbmNvZGVTcGFjZXMpIHsKICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkuCiAgICAgICAgICAgIHJlcGxhY2UoLyU0MC9naSwgJ0AnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICByZXBsYWNlKC8lMjQvZywgJyQnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJDL2dpLCAnLCcpLgogICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQXBwCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogICAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvIGF1dG8tYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLiBPbmx5CiAgICAgKiBvbmUgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZGlyZWN0aXZlCiAgICAgKiBkZXNpZ25hdGVzIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZAogICAgICogYXQgdGhlIHJvb3Qgb2YgdGhlIHBhZ2UuCiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUgYmVsb3cgaWYgdGhlIGBuZ0FwcGAgZGlyZWN0aXZlIHdvdWxkIG5vdCBiZSBwbGFjZWQKICAgICAqIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZSBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQKICAgICAqIGFuZCB0aGUgYHt7IDErMiB9fWAgd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICAgICAqCiAgICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0IHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBJIGNhbiBhZGQ6IDEgKyAyID0gIHt7IDErMiB9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICAgICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gKG1hdGNoWzJdIHx8ICcnKS5yZXBsYWNlKC9ccysvZywgJywnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIHJlc3VtZUJvb3RzdHJhcEludGVybmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwogICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbiAoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgICAgICAgfV0pOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgICAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICAgICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvcikgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH1dCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RvcjsKICAgICAgICB9OwoKICAgICAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICAgICAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH0KCiAgICAgICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgICAgIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24gKGV4dHJhTW9kdWxlcykgewogICAgICAgICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CgogICAgZnVuY3Rpb24gc25ha2VfY2FzZShuYW1lLCBzZXBhcmF0b3IpIHsKICAgICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uIChsZXR0ZXIsIHBvcykgewogICAgICAgICAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAgICAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICAgICAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgICAgIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogICAgICAgIGlmIChqUXVlcnkpIHsKICAgICAgICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICAgICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgICAgICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICAgICAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlKTsKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2VtcHR5Jyk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganFMaXRlID0gSlFMaXRlOwogICAgICAgIH0KICAgICAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgJyIgKyAobmFtZSB8fCAnPycpICsgIicgaXMgIiArIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgICAgICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgICAgICB9CgogICAgICAgIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAgICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGludGVyZmFjZQogICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEludGVyZmFjZSBmb3IgY29uZmlndXJpbmcgYW5ndWxhciB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30uCiAgICAgKi8KCiAgICBmdW5jdGlvbiBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpIHsKCiAgICAgICAgZnVuY3Rpb24gZW5zdXJlKG9iaiwgbmFtZSwgZmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVuc3VyZShlbnN1cmUod2luZG93LCAnYW5ndWxhcicsIE9iamVjdCksICdtb2R1bGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZyBhbmQgcmVnaXN0ZXJpbmcgQW5ndWxhciBtb2R1bGVzLiBBbGwKICAgICAgICAgICAgICogbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIyBNb2R1bGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsb2NhdGlvbiBvZiBzZXJ2aWNlcywgZGlyZWN0aXZlcywgZmlsdGVycywgYW5kIGNvbmZpZ3VyYXRpb24gaW5mb3JtYXRpb24uIE1vZHVsZQogICAgICAgICAgICAgKiBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICAgICAgICogbXlNb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGVuIHlvdSBjYW4gY3JlYXRlIGFuIGluamVjdG9yIGFuZCBsb2FkIHlvdXIgbW9kdWxlcyBsaWtlIHRoaXM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIHZhciBpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZycsICdNeU1vZHVsZSddKQogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSG93ZXZlciBpdCdzIG1vcmUgbGlrZWx5IHRoYXQgeW91J2xsIGp1c3QgdXNlCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPj19IHJlcXVpcmVzIElmIHNwZWNpZmllZCB0aGVuIG5ldyBtb2R1bGUgaXMgYmVpbmcgY3JlYXRlZC4gSWYgdW5zcGVjaWZpZWQgdGhlbiB0aGUKICAgICAgICAgICAgICogICAgICAgIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gbW9kdWxlOiAnICsgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gTGlzdCBvZiBtb2R1bGUgbmFtZXMgd2hpY2ggbXVzdCBiZSBsb2FkZWQgYmVmb3JlIHRoaXMgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgZmlsdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBpbnZva2VMYXRlcignJGZpbHRlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGNvbnRyb2xsZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IGludm9rZUxhdGVyKCckY29udHJvbGxlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGRpcmVjdGl2ZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcnVuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbml0aWFsaXphdGlvbkZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBhZnRlciBpbmplY3RvciBjcmVhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogICAgVXNlZnVsIGZvciBhcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIHNob3VsZCBiZSBwZXJmb3JtZWQgd2hlbiB0aGUgaW5qZWN0b3IgaXMgZG9uZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBsb2FkaW5nIGFsbCBtb2R1bGVzLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcnVuOiBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7YW5ndWxhci5Nb2R1bGV9CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgICAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogICAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgICAqLwogICAgdmFyIHZlcnNpb24gPSB7CiAgICAgICAgZnVsbDogJzEuMC43JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAwLAogICAgICAgIGRvdDogNywKICAgICAgICBjb2RlTmFtZTogJ21vbm9jaHJvbWF0aWMtcmFpbmJvdycKICAgIH07CgoKICAgIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKSB7CiAgICAgICAgZXh0ZW5kKGFuZ3VsYXIsIHsKICAgICAgICAgICAgJ2Jvb3RzdHJhcCc6IGJvb3RzdHJhcCwKICAgICAgICAgICAgJ2NvcHknOiBjb3B5LAogICAgICAgICAgICAnZXh0ZW5kJzogZXh0ZW5kLAogICAgICAgICAgICAnZXF1YWxzJzogZXF1YWxzLAogICAgICAgICAgICAnZWxlbWVudCc6IGpxTGl0ZSwKICAgICAgICAgICAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICAgICAgICAgICAnaW5qZWN0b3InOiBjcmVhdGVJbmplY3RvciwKICAgICAgICAgICAgJ25vb3AnOiBub29wLAogICAgICAgICAgICAnYmluZCc6IGJpbmQsCiAgICAgICAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAgICAgICAnaWRlbnRpdHknOiBpZGVudGl0eSwKICAgICAgICAgICAgJ2lzVW5kZWZpbmVkJzogaXNVbmRlZmluZWQsCiAgICAgICAgICAgICdpc0RlZmluZWQnOiBpc0RlZmluZWQsCiAgICAgICAgICAgICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICAgICAgICAgICAnaXNGdW5jdGlvbic6IGlzRnVuY3Rpb24sCiAgICAgICAgICAgICdpc09iamVjdCc6IGlzT2JqZWN0LAogICAgICAgICAgICAnaXNOdW1iZXInOiBpc051bWJlciwKICAgICAgICAgICAgJ2lzRWxlbWVudCc6IGlzRWxlbWVudCwKICAgICAgICAgICAgJ2lzQXJyYXknOiBpc0FycmF5LAogICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICdpc0RhdGUnOiBpc0RhdGUsCiAgICAgICAgICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAgICAgICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAgICAgICAgICdjYWxsYmFja3MnOiB7Y291bnRlcjogMH0KICAgICAgICB9KTsKCiAgICAgICAgYW5ndWxhck1vZHVsZSA9IHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJywgW10pLnByb3ZpZGVyKCckbG9jYWxlJywgJExvY2FsZVByb3ZpZGVyKTsKICAgICAgICB9CgogICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgICAgICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKCckY29tcGlsZScsICRDb21waWxlUHJvdmlkZXIpLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGE6IGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtOiBmb3JtRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uOiBvcHRpb25EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRIdG1sVW5zYWZlOiBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRUZW1wbGF0ZTogbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NFdmVuOiBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzc09kZDogbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDc3A6IG5nQ3NwRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0Nsb2FrOiBuZ0Nsb2FrRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NvbnRyb2xsZXI6IG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSGlkZTogbmdIaWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdJbml0OiBuZ0luaXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nTm9uQmluZGFibGU6IG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdSZXBlYXQ6IG5nUmVwZWF0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1Nob3c6IG5nU2hvd0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTdWJtaXQ6IG5nU3VibWl0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmlldzogbmdWaWV3RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZTogJFJvdXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiAkUm91dGVQYXJhbXNQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUgcHJvdmlkZXMgdGhlIGZvbGxvd2luZyBtZXRob2RzOgogICAgICoKICAgICAqIC0gW2FkZENsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZGRDbGFzcy8pCiAgICAgKiAtIFthZnRlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogICAgICogLSBbYXBwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hcHBlbmQvKQogICAgICogLSBbYXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXR0ci8pCiAgICAgKiAtIFtiaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICAgICAqIC0gW2NoaWxkcmVuKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW2Nsb25lKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAgICAgKiAtIFtjb250ZW50cygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogICAgICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogICAgICogLSBbZGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAgICAgKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAgICogLSBbZmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICAgKiAtIFtoYXNDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAgICogLSBbaHRtbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICAgKiAtIFtuZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbcGFyZW50KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtwcmVwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcmVwZW5kLykKICAgICAqIC0gW3Byb3AoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogICAgICogLSBbcmVhZHkoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlYWR5LykKICAgICAqIC0gW3JlbW92ZSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlLykKICAgICAqIC0gW3JlbW92ZUF0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogICAgICogLSBbcmVtb3ZlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUNsYXNzLykKICAgICAqIC0gW3JlbW92ZURhdGEoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZURhdGEvKQogICAgICogLSBbcmVwbGFjZVdpdGgoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICAgICAqIC0gW3RleHQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RleHQvKQogICAgICogLSBbdG9nZ2xlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RvZ2dsZUNsYXNzLykKICAgICAqIC0gW3RyaWdnZXJIYW5kbGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gRG9lc24ndCBwYXNzIG5hdGl2ZSBldmVudCBvYmplY3RzIHRvIGhhbmRsZXJzLgogICAgICogLSBbdW5iaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS91bmJpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAgICogLSBbdmFsKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS92YWwvKQogICAgICogLSBbd3JhcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAgICAgKgogICAgICogIyMgSW4gYWRkdGlvbiB0byB0aGUgYWJvdmUsIEFuZ3VsYXIgcHJvdmlkZXMgYWRkaXRpb25hbCBtZXRob2RzIHRvIGJvdGggalF1ZXJ5IGFuZCBqUXVlcnkgbGl0ZToKICAgICAqCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICAgICAgOiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwogICAgICAgIH0pLAogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcgogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKICAgICAgICB9KTsKCiAgICBmdW5jdGlvbiBqcU5leHRJZCgpIHsKICAgICAgICByZXR1cm4gKytqcUlkOwogICAgfQoKCiAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgIHZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwoKICAgIC8qKgogICAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgICAqLwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCxmdW5jdGlvbiAoXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyAgSW4gY29uanVuY3Rpb24gd2l0aCBiaW5kSlF1ZXJ5IGludGVyY2VwdHMgYWxsIGpRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyBhCi8vICRkZXN0cm95IGV2ZW50IG9uIGFsbCBET00gbm9kZXMgYmVpbmcgcmVtb3ZlZC4KLy8KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgICAgICBvcmlnaW5hbEpxRm4gPSBvcmlnaW5hbEpxRm4uJG9yaWdpbmFsIHx8IG9yaWdpbmFsSnFGbjsKICAgICAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICAgICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBhdGNoKCkgewogICAgICAgICAgICB2YXIgbGlzdCA9IFt0aGlzXSwKICAgICAgICAgICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICAgICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICAgICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbiwKICAgICAgICAgICAgICAgIGZucywgZXZlbnRzOwoKICAgICAgICAgICAgd2hpbGUgKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBzZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBmb3IgKHNldEluZGV4ID0gMCwgc2V0TGVuZ3RoID0gc2V0Lmxlbmd0aDsgc2V0SW5kZXggPCBzZXRMZW5ndGg7IHNldEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgIGlmIChmaXJlRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50cmlnZ2VySGFuZGxlcignJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSAhZmlyZUV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgZnVuY3Rpb24gSlFMaXRlKGVsZW1lbnQpIHsKICAgICAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEpRTGl0ZSkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEpRTGl0ZSkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3NlbGVjdG9ycyBub3QgaW1wbGVtZW50ZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IEpRTGl0ZShlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSkgewogICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgdGhlIE5vU2NvcGUgZWxlbWVudHMgaGVyZToKICAgICAgICAgICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTMzODk3KFZTLjg1KS5hc3B4CiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPGRpdj4mIzE2MDs8L2Rpdj4nICsgZWxlbWVudDsgLy8gSUUgaW5zYW5pdHkgdG8gbWFrZSBOb1Njb3BlIGVsZW1lbnRzIHdvcmshCiAgICAgICAgICAgIGRpdi5yZW1vdmVDaGlsZChkaXYuZmlyc3RDaGlsZCk7IC8vIHJlbW92ZSB0aGUgc3VwZXJmbHVvdXMgZGl2CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGRpdi5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsgLy8gZGV0YWNoIHRoZSBlbGVtZW50cyBmcm9tIHRoZSB0ZW1wb3JhcnkgRE9NIGRpdi4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBKUUxpdGVBZGROb2Rlcyh0aGlzLCBlbGVtZW50KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ2xvbmUoZWxlbWVudCkgewogICAgICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVEZWFsb2MoZWxlbWVudCkgewogICAgICAgIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkcmVuW2ldKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlVW5iaW5kKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgICAgIGhhbmRsZSA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJyk7CgogICAgICAgIGlmICghaGFuZGxlKSByZXR1cm47IC8vbm8gbGlzdGVuZXJzIHJlZ2lzdGVyZWQKCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUpKSB7CiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRIYW5kbGVyLCB0eXBlKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChmbikpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudHNbdHlwZV0pOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGV2ZW50c1t0eXBlXSwgZm4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgICAgICAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICBpZiAoZXhwYW5kb1N0b3JlLmhhbmRsZSkgewogICAgICAgICAgICAgICAgZXhwYW5kb1N0b3JlLmV2ZW50cy4kZGVzdHJveSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgIEpRTGl0ZVVuYmluZChlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgICAgICAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWQgfHwgLTFdOwoKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICBpZiAoIWV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cGFuZG9TdG9yZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmVba2V5XTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlRGF0YShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGRhdGEgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnKSwKICAgICAgICAgICAgaXNTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpLAogICAgICAgICAgICBrZXlEZWZpbmVkID0gIWlzU2V0dGVyICYmIGlzRGVmaW5lZChrZXkpLAogICAgICAgICAgICBpc1NpbXBsZUdldHRlciA9IGtleURlZmluZWQgJiYgIWlzT2JqZWN0KGtleSk7CgogICAgICAgIGlmICghZGF0YSAmJiAhaXNTaW1wbGVHZXR0ZXIpIHsKICAgICAgICAgICAgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJywgZGF0YSA9IHt9KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1NldHRlcikgewogICAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoa2V5RGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgY3JlYXRlIGRhdGEgaW4gdGhpcyBjYXNlLgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhICYmIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGRhdGEsIGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgIHJldHVybiAoKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS4KICAgICAgICAgICAgaW5kZXhPZigiICIgKyBzZWxlY3RvciArICIgIikgPiAtMSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoY3NzQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbSgKICAgICAgICAgICAgICAgICAgICAoIiAiICsgZWxlbWVudC5jbGFzc05hbWUgKyAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgiICIgKyB0cmltKGNzc0NsYXNzKSArICIgIiwgIiAiKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBpZiAoIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIGNzc0NsYXNzKSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbShlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIHRyaW0oY3NzQ2xhc3MpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZE5vZGVzKHJvb3QsIGVsZW1lbnRzKSB7CiAgICAgICAgaWYgKGVsZW1lbnRzKSB7CiAgICAgICAgICAgIGVsZW1lbnRzID0gKCFlbGVtZW50cy5ub2RlTmFtZSAmJiBpc0RlZmluZWQoZWxlbWVudHMubGVuZ3RoKSAmJiAhaXNXaW5kb3coZWxlbWVudHMpKQogICAgICAgICAgICAgICAgPyBlbGVtZW50cwogICAgICAgICAgICAgICAgOiBbIGVsZW1lbnRzIF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHJvb3QucHVzaChlbGVtZW50c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ29udHJvbGxlcihlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyQnICsgKG5hbWUgfHwgJ25nQ29udHJvbGxlcicgKSArICdDb250cm9sbGVyJyk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICAgIC8vIGlmIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50IG9iamVjdCB3b3JrIHdpdGggdGhlIGh0bWwgZWxlbWVudCBpbnN0ZWFkCiAgICAgICAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgICAgICAgaWYgKGVsZW1lbnRbMF0ubm9kZVR5cGUgPT0gOSkgewogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWUpKSByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICAgICAgICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgICAgICAgICAgICBmaXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJpbmQoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsgLy8gd29ya3MgZm9yIG1vZGVybiBicm93c2VycyBhbmQgSUU5CiAgICAgICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAgICAgSlFMaXRlKHdpbmRvdykuYmluZCgnbG9hZCcsIHRyaWdnZXIpOyAvLyBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkIGZvciBvdGhlcnMKICAgICAgICB9LAogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKHRoaXMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKCcnICsgZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgICAgIH0sCgogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwdXNoOiBwdXNoLAogICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgIH07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBCT09MRUFOX0FUVFIgPSB7fTsKICAgIGZvckVhY2goJ211bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZE9ubHkscmVxdWlyZWQnLnNwbGl0KCcsJyksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIEJPT0xFQU5fQVRUUltsb3dlcmNhc2UodmFsdWUpXSA9IHZhbHVlOwogICAgfSk7CiAgICB2YXIgQk9PTEVBTl9FTEVNRU5UUyA9IHt9OwogICAgZm9yRWFjaCgnaW5wdXQsc2VsZWN0LG9wdGlvbix0ZXh0YXJlYSxidXR0b24sZm9ybScuc3BsaXQoJywnKSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckc2NvcGUnKTsKICAgICAgICB9LAoKICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVDb250cm9sbGVyLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycpIHZhbCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhdHRyOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpIHx8IG5vb3ApLnNwZWNpZmllZCkKICAgICAgICAgICAgICAgICAgICAgICAgPyBsb3dlcmNhc2VkTmFtZQogICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgICAgICAgICAgIC8vIHNvbWUgZWxlbWVudHMgKGUuZy4gRG9jdW1lbnQpIGRvbid0IGhhdmUgZ2V0IGF0dHJpYnV0ZSwgc28gcmV0dXJuIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByb3A6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB0ZXh0OiBleHRlbmQoKG1zaWUgPCA5KQogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICovKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVyVGV4dDsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVWYWx1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICB9LCB7JGR2OiAnJ30pLAoKICAgICAgICB2YWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgaHRtbDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAgICAgKi8KICAgICAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKGFyZzEsIGFyZzIpIHsKICAgICAgICAgICAgdmFyIGksIGtleTsKCiAgICAgICAgICAgIC8vIEpRTGl0ZUhhc0NsYXNzIGhhcyBvbmx5IHR3byBhcmd1bWVudHMsIGJ1dCBpcyBhIGdldHRlci1vbmx5IGZuLCBzbyB3ZSBuZWVkIHRvIHNwZWNpYWwtY2FzZSBpdAogICAgICAgICAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgICAgICAgICAgaWYgKCgoZm4ubGVuZ3RoID09IDIgJiYgKGZuICE9PSBKUUxpdGVIYXNDbGFzcyAmJiBmbiAhPT0gSlFMaXRlQ29udHJvbGxlcikpID8gYXJnMSA6IGFyZzIpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4gPT09IEpRTGl0ZURhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwga2V5LCBhcmcxW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSByZWFkLCBzbyByZWFkIHRoZSBmaXJzdCBjaGlsZC4KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbih0aGlzWzBdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBzbyBhcHBseSB0byBhbGwgY2hpbGRyZW4KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi4kZHY7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpIHsKICAgICAgICB2YXIgZXZlbnRIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHByZXZlbnQuY2FsbChldmVudCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV0sIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgICAgICAgICAgLy8gYXMgdGhleSB3b3VsZCBjYXVzZSBtZW1vcnkgbGVha3MgaW4gSUU4LgogICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgYmluZDogZnVuY3Rpb24gYmluZEZuKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgICAgIGlmICghZXZlbnRzKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRvd24gPSBhLm5vZGVUeXBlID09PSA5ID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMoYnVwKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYnVwKSAmIDE2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiID09PSBhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZTogIm1vdXNlb3V0IiwgbW91c2VlbnRlcjogIm1vdXNlb3ZlciJ9CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRGbihlbGVtZW50LCBldmVudG1hcFt0eXBlXSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0LCB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV2ZW50Rm5zLnB1c2goZm4pOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICB1bmJpbmQ6IEpRTGl0ZVVuYmluZCwKCiAgICAgICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uIChlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgICAgICAgICB2YXIgaW5kZXgsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0sCgogICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOwogICAgICAgIH0sCgogICAgICAgIGFwcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyYXA6IGZ1bmN0aW9uIChlbGVtZW50LCB3cmFwTm9kZSkgewogICAgICAgICAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSlbMF07CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcE5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdyYXBOb2RlLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uIChlbGVtZW50LCBuZXdFbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5ld0VsZW1lbnQpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBKUUxpdGVBZGRDbGFzcywKICAgICAgICByZW1vdmVDbGFzczogSlFMaXRlUmVtb3ZlQ2xhc3MsCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZGl0aW9uKSkgewogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoY29uZGl0aW9uID8gSlFMaXRlQWRkQ2xhc3MgOiBKUUxpdGVSZW1vdmVDbGFzcykoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIHBhcmVudDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBuZXh0OiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0sCgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgY2xvbmU6IEpRTGl0ZUNsb25lLAoKICAgICAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50TmFtZSkgewogICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSAoSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSB8fCB7fSlbZXZlbnROYW1lXTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRGbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGZuLCBuYW1lKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8gdGhpcyA6IHZhbHVlOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KSB7CiAgICAgICAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwogICAgfQoKICAgIEhhc2hNYXAucHJvdG90eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICAgICAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgICAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqLwogICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqIEByZXR1cm5zIHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgICAgICAgKiBAcGFyYW0ga2V5CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBBIG1hcCB3aGVyZSBtdWx0aXBsZSB2YWx1ZXMgY2FuIGJlIGFkZGVkIHRvIHRoZSBzYW1lIGtleSBzdWNoIHRoYXQgdGhleSBmb3JtIGEgcXVldWUuCiAgICAgKiBAcmV0dXJucyB7SGFzaFF1ZXVlTWFwfQogICAgICovCiAgICBmdW5jdGlvbiBIYXNoUXVldWVNYXAoKSB7CiAgICB9CgogICAgSGFzaFF1ZXVlTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHB1c2gsIGJ1dCB1c2luZyBhbiBhcnJheSBhcyB0aGUgdmFsdWUgZm9yIHRoZSBoYXNoCiAgICAgICAgICovCiAgICAgICAgcHVzaDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSBbdmFsdWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHNoaWZ0LCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHNoaWZ0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiByZXR1cm4gdGhlIGZpcnN0IGl0ZW0gd2l0aG91dCBkZWxldGluZyBpdAogICAgICAgICAqLwogICAgICAgIHBlZWs6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhbiBpbmplY3RvciBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAgICAgKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogICAgICoKCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHlwaWNhbCB1c2FnZQogICAgICogPHByZT4KICAgICAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICAgKgogICAgICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICAgICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICAgKiBAbmFtZSBBVVRPCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbXBsaWNpdCBtb2R1bGUgd2hpY2ggZ2V0cyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIGVhY2gge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKi8KCiAgICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICAgIHZhciBGTl9BUkdfU1BMSVQgPSAvLC87CiAgICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICAgIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CgogICAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgICAgICB2YXIgJGluamVjdCwKICAgICAgICAgICAgZm5UZXh0LAogICAgICAgICAgICBhcmdEZWNsLAogICAgICAgICAgICBsYXN0OwoKICAgICAgICBpZiAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICAgICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICAgICAgICAgIGFyZy5yZXBsYWNlKEZOX0FSRywgZnVuY3Rpb24gKGFsbCwgdW5kZXJzY29yZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZuLiRpbmplY3QgPSAkaW5qZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGZuKSkgewogICAgICAgICAgICBsYXN0ID0gZm4ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm5bbGFzdF0sICdmbicpOwogICAgICAgICAgICAkaW5qZWN0ID0gZm4uc2xpY2UoMCwgbGFzdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sICdmbicsIHRydWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGluamVjdDsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgICAqIGFuZCBsb2FkIG1vZHVsZXMuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkudG9CZSgkaW5qZWN0b3IpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogICAgICoKICAgICAqIEphdmFTY3JpcHQgZG9lcyBub3QgaGF2ZSBhbm5vdGF0aW9ucywgYW5kIGFubm90YXRpb25zIGFyZSBuZWVkZWQgZm9yIGRlcGVuZGVuY3kgaW5qZWN0aW9uLiBUaGUKICAgICAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oc2VydmljZUEpe30pOwogICAgICoKICAgICAqICAgLy8gYW5ub3RhdGVkCiAgICAgKiAgIGZ1bmN0aW9uIGV4cGxpY2l0KHNlcnZpY2VBKSB7fTsKICAgICAqICAgZXhwbGljaXQuJGluamVjdCA9IFsnc2VydmljZUEnXTsKICAgICAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAgICAgKgogICAgICogICAvLyBpbmxpbmUKICAgICAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMjIEluZmVyZW5jZQogICAgICoKICAgICAqIEluIEphdmFTY3JpcHQgY2FsbGluZyBgdG9TdHJpbmcoKWAgb24gYSBmdW5jdGlvbiByZXR1cm5zIHRoZSBmdW5jdGlvbiBkZWZpbml0aW9uLiBUaGUgZGVmaW5pdGlvbiBjYW4gdGhlbiBiZQogICAgICogcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGggbWluaWZpY2F0aW9uLCBhbmQgb2JmdXNjYXRpb24KICAgICAqIHRvb2xzIHNpbmNlIHRoZXNlIHRvb2xzIGNoYW5nZSB0aGUgYXJndW1lbnQgbmFtZXMuCiAgICAgKgogICAgICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICAgICAqIEJ5IGFkZGluZyBhIGAkaW5qZWN0YCBwcm9wZXJ0eSBvbnRvIGEgZnVuY3Rpb24gdGhlIGluamVjdGlvbiBwYXJhbWV0ZXJzIGNhbiBiZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogIyMgSW5saW5lCiAgICAgKiBBcyBhbiBhcnJheSBvZiBpbmplY3Rpb24gbmFtZXMsIHdoZXJlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IGlzIHRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNnZXQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJuIGFuIGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm4geyp9IFRoZSBpbnN0YW5jZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjaW52b2tlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZSB0aGUgbWV0aG9kIGFuZCBzdXBwbHkgdGhlIG1ldGhvZCBhcmd1bWVudHMgZnJvbSB0aGUgYCRpbmplY3RvcmAuCiAgICAgKgogICAgICogQHBhcmFtIHshZnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIFRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY29tZSBmb3JtIHRoZSBmdW5jdGlvbiBhbm5vdGF0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBzZWxmIFRoZSBgdGhpc2AgZm9yIHRoZSBpbnZva2VkIG1ldGhvZC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGUgaW52b2tlZCBgZm5gIGZ1bmN0aW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBKUyB0eXBlLiBUaGUgbWV0aG9kIHRha2VzIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gaW52b2tlcyB0aGUgbmV3IG9wZXJhdG9yIGFuZCBzdXBwbGllcwogICAgICogYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUgY29uc3RydWN0b3IgYW5ub3RhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gbmV3IGluc3RhbmNlIG9mIGBUeXBlYC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjYW5ub3RhdGUKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBzZXJ2aWNlIG5hbWVzIHdoaWNoIHRoZSBmdW5jdGlvbiBpcyByZXF1ZXN0aW5nIGZvciBpbmplY3Rpb24uIFRoaXMgQVBJIGlzIHVzZWQgYnkgdGhlIGluamVjdG9yCiAgICAgKiB0byBkZXRlcm1pbmUgd2hpY2ggc2VydmljZXMgbmVlZCB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbiB3aGVuIHRoZSBmdW5jdGlvbiBpcyBpbnZva2VkLiBUaGVyZSBhcmUgdGhyZWUKICAgICAqIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkIGRlcGVuZGVuY2llcy4KICAgICAqCiAgICAgKiAjIEFyZ3VtZW50IG5hbWVzCiAgICAgKgogICAgICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZSBieSBjb252ZXJ0aW5nCiAgICAgKiB0aGUgZnVuY3Rpb24gaW50byBhIHN0cmluZyB1c2luZyBgdG9TdHJpbmcoKWAgbWV0aG9kIGFuZCBleHRyYWN0aW5nIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIEdpdmVuCiAgICAgKiAgIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRyb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAgICoKICAgICAqICAgLy8gVGhlbgogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCB3b3JrIHdpdGggY29kZSBtaW5maWNhdGlvbiAvIG9iZnVzY2F0aW9uLiBGb3IgdGhpcyByZWFzb24gdGhlIGZvbGxvd2luZyBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMKICAgICAqIGFyZSBzdXBwb3J0ZWQuCiAgICAgKgogICAgICogIyBUaGUgYCRpbmplY3RgIHByb3BlcnR5CiAgICAgKgogICAgICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncyByZXByZXNlbnQgbmFtZXMgb2YKICAgICAqIHNlcnZpY2VzIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgdmFyIE15Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRTY29wZSwgb2JmdXNjYXRlZFJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAgICAgKiAgIC8vIERlZmluZSBmdW5jdGlvbiBkZXBlbmRlbmNpZXMKICAgICAqICAgTXlDb250cm9sbGVyLiRpbmplY3QgPSBbJyRzY29wZScsICckcm91dGUnXTsKICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBUaGUgYXJyYXkgbm90YXRpb24KICAgICAqCiAgICAgKiBJdCBpcyBvZnRlbiBkZXNpcmFibGUgdG8gaW5saW5lIEluamVjdGVkIGZ1bmN0aW9ucyBhbmQgdGhhdCdzIHdoZW4gc2V0dGluZyB0aGUgYCRpbmplY3RgIHByb3BlcnR5IGlzIHZlcnkKICAgICAqIGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMKICAgICAqIG1pbmlmaWNhdGlvbiBpcyBhIGJldHRlciBjaG9pY2U6CiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gV2Ugd2lzaCB0byB3cml0ZSB0aGlzIChub3QgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24gc2FmZSkKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlLCAkcm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICAgICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH07CiAgICAgKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKHRtcEZuKTsKICAgICAqCiAgICAgKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAgICAgKiAgIGluamVjdG9yLmludm9rZShbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZDb21waWxlLCBvYmZSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH1dKTsKICAgICAqCiAgICAgKiAgIC8vIFRoZXJlZm9yZQogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoCiAgICAgKiAgICAgIFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZnVzXyRjb21waWxlLCBvYmZ1c18kcm9vdFNjb3BlKSB7fV0pCiAgICAgKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8gYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZAogICAgICogICBhYm92ZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IFRoZSBuYW1lcyBvZiB0aGUgc2VydmljZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIHJlcXVpcmVzLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSBgJHByb3ZpZGVgIHRvIHJlZ2lzdGVyIG5ldyBwcm92aWRlcnMgd2l0aCB0aGUgYCRpbmplY3RvcmAuIFRoZSBwcm92aWRlcnMgYXJlIHRoZSBmYWN0b3JpZXMgZm9yIHRoZSBpbnN0YW5jZS4KICAgICAqIFRoZSBwcm92aWRlcnMgc2hhcmUgdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5zdGFuY2UgdGhleSBjcmVhdGUgd2l0aCBgUHJvdmlkZXJgIHN1ZmZpeGVkIHRvIHRoZW0uCiAgICAgKgogICAgICogQSBwcm92aWRlciBpcyBhbiBvYmplY3Qgd2l0aCBhIGAkZ2V0KClgIG1ldGhvZC4gVGhlIGluamVjdG9yIGNhbGxzIHRoZSBgJGdldGAgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAgICogYSBzZXJ2aWNlLiBUaGUgUHJvdmlkZXIgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIHdvdWxkIGFsbG93IGZvciBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlci4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBmdW5jdGlvbiBHcmVldFByb3ZpZGVyKCkgewogKiAgICAgdmFyIHNhbHV0YXRpb24gPSAnSGVsbG8nOwogKgogKiAgICAgdGhpcy5zYWx1dGF0aW9uID0gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICBzYWx1dGF0aW9uID0gdGV4dDsKICogICAgIH07CiAqCiAqICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAqICAgICAgICAgcmV0dXJuIHNhbHV0YXRpb24gKyAnICcgKyBuYW1lICsgJyEnOwogKiAgICAgICB9OwogKiAgICAgfTsKICogICB9CiAgICAgKgogICAgICogICBkZXNjcmliZSgnR3JlZXRlcicsIGZ1bmN0aW9uKCl7CiAqCiAqICAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbigkcHJvdmlkZSkgewogKiAgICAgICAkcHJvdmlkZS5wcm92aWRlcignZ3JlZXQnLCBHcmVldFByb3ZpZGVyKTsKICogICAgIH0pKTsKICoKICogICAgIGl0KCdzaG91bGQgZ3JlZXQnLCBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICogICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0hlbGxvIGFuZ3VsYXIhJyk7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGFsbG93IGNvbmZpZ3VyYXRpb24gb2Ygc2FsdXRhdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgICAgICBtb2R1bGUoZnVuY3Rpb24oZ3JlZXRQcm92aWRlcikgewogKiAgICAgICAgIGdyZWV0UHJvdmlkZXIuc2FsdXRhdGlvbignQWhvaicpOwogKiAgICAgICB9KTsKICogICAgICAgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0Fob2ogYW5ndWxhciEnKTsKICogICAgICAgfSk7CiAqICAgICB9KTsKICogPC9wcmU+CiAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNwcm92aWRlcgogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFJlZ2lzdGVyIGEgcHJvdmlkZXIgZm9yIGEgc2VydmljZS4gVGhlIHByb3ZpZGVycyBjYW4gYmUgcmV0cmlldmVkIGFuZCBjYW4gaGF2ZSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuIE5PVEU6IHRoZSBwcm92aWRlciB3aWxsIGJlIGF2YWlsYWJsZSB1bmRlciBgbmFtZSArICdQcm92aWRlcidgIGtleS4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogdGhlbiBpdCBzaG91bGQgaGF2ZSBhIGAkZ2V0YCBtZXRob2QuIFRoZSBgJGdldGAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB1c2luZwogICAgICogICAgICAgICAgICAgICB7QGxpbmsgQVVUTy4kaW5qZWN0b3IjaW52b2tlICRpbmplY3Rvci5pbnZva2UoKX0gd2hlbiBhbiBpbnN0YW5jZSBuZWVkcyB0byBiZSBjcmVhdGVkLgogICAgICogICAtIGBDb25zdHJ1Y3RvcmA6IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBwcm92aWRlciB3aWxsIGJlIGNyZWF0ZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlICRpbmplY3Rvci5pbnN0YW50aWF0ZSgpfSwgdGhlbiB0cmVhdGVkIGFzIGBvYmplY3RgLgogICAgICoKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNmYWN0b3J5CiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiBvbmx5IGAkZ2V0YCBtZXRob2QgaXMgcmVxdWlyZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSAkZ2V0Rm4gVGhlICRnZXRGbiBmb3IgdGhlIGluc3RhbmNlIGNyZWF0aW9uLiBJbnRlcm5hbGx5IHRoaXMgaXMgYSBzaG9ydCBoYW5kIGZvcgogICAgICogYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3NlcnZpY2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNob3J0IGhhbmQgZm9yIHJlZ2lzdGVyaW5nIHNlcnZpY2Ugb2YgZ2l2ZW4gY2xhc3MuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3ZhbHVlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiB0aGUgYCRnZXRgIG1ldGhvZCBpcyBhIGNvbnN0YW50LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNjb25zdGFudAogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgY29uc3RhbnQgdmFsdWUsIGJ1dCB1bmxpa2Uge0BsaW5rIEFVVE8uJHByb3ZpZGUjdmFsdWUgdmFsdWV9IGl0IGNhbiBiZSBpbmplY3RlZAogICAgICogaW50byBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChvdGhlciBtb2R1bGVzKSBhbmQgaXQgaXMgbm90IGludGVyY2VwdGFibGUgYnkKICAgICAqIHtAbGluayBBVVRPLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBjb25zdGFudC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIGNvbnN0YW50IHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBEZWNvcmF0aW9uIG9mIHNlcnZpY2UsIGFsbG93cyB0aGUgZGVjb3JhdG9yIHRvIGludGVyY2VwdCB0aGUgc2VydmljZSBpbnN0YW5jZSBjcmVhdGlvbi4gVGhlCiAgICAgKiByZXR1cm5lZCBpbnN0YW5jZSBtYXkgYmUgdGhlIG9yaWdpbmFsIGluc3RhbmNlLCBvciBhIG5ldyBpbnN0YW5jZSB3aGljaCBkZWxlZ2F0ZXMgdG8gdGhlCiAgICAgKiBvcmlnaW5hbCBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc2VydmljZSB0byBkZWNvcmF0ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZGVjb3JhdG9yIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlIHNlcnZpY2UgbmVlZHMgdG8gYmUKICAgICAqICAgIGluc3RhbnRpYXRlZC4gVGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCB1c2luZyB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZQogICAgICogICAgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLiBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogICAgICoKICAgICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAgICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogICAgICovCgoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICAgICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgICAgICAgIHBhdGggPSBbXSwKICAgICAgICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm92aWRlckluamVjdG9yID0gY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5rbm93biBwcm92aWRlcjogIiArIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGluc3RhbmNlQ2FjaGUgPSB7fSwKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3RvciA9IChpbnN0YW5jZUNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGluc3RhbmNlQ2FjaGUsIGZ1bmN0aW9uIChzZXJ2aWNlbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VuYW1lICsgcHJvdmlkZXJTdWZmaXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShwcm92aWRlci4kZ2V0LCBwcm92aWRlcik7CiAgICAgICAgICAgICAgICB9KSk7CgoKICAgICAgICBmb3JFYWNoKGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyAkcHJvdmlkZXIKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgZnVuY3Rpb24gc3VwcG9ydE9iamVjdChkZWxlZ2F0ZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvdmlkZXIgJyArIG5hbWUgKyAnIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgWyckaW5qZWN0b3InLCBmdW5jdGlvbiAoJGluamVjdG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWx1ZSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgICAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgICAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTW9kdWxlIExvYWRpbmcKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobG9hZGVkTW9kdWxlcy5nZXQobW9kdWxlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgIHJ1bkJsb2NrcyA9IHJ1bkJsb2Nrcy5jb25jYXQobG9hZE1vZHVsZXMobW9kdWxlRm4ucmVxdWlyZXMpKS5jb25jYXQobW9kdWxlRm4uX3J1bkJsb2Nrcyk7CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gaW52b2tlQXJnc1swXSA9PSAnJGluamVjdG9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHByb3ZpZGVySW5qZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgbW9kdWxlOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBTdHJpbmcobW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2VOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdTZXJ2aWNlIG5hbWUgZXhwZWN0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdDaXJjdWxhciBkZXBlbmRlbmN5OiAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsIGksCiAgICAgICAgICAgICAgICAgICAga2V5OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGxvY2Fsc1trZXldCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWZuLiRpbmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgd2UgbXVzdCBiZSBhbiBhcnJheS4KICAgICAgICAgICAgICAgICAgICBmbiA9IGZuW2xlbmd0aF07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8vIFBlcmZvcm1hbmNlIG9wdGltaXphdGlvbjogaHR0cDovL2pzcGVyZi5jb20vYXBwbHktdnMtY2FsbC12cy1pbnZva2UKICAgICAgICAgICAgICAgIHN3aXRjaCAoc2VsZiA/IC0xIDogYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICAwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAxOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDY6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA3OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgODoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddLCBhcmdzWzhdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSwgYXJnc1s5XSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShUeXBlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgICAgICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgICAgICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRhbmNob3JTY3JvbGwKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHRvIHJlbGF0ZWQgZWxlbWVudCwKICAgICAqIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAqIHtAbGluayBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCBIdG1sNSBzcGVjfS4KICAgICAqCiAgICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgICAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICAgICAqLwogICAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgICAgICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uICgkd2luZG93LCAkbG9jYXRpb24sICRyb290U2NvcGUpIHsKICAgICAgICAgICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKCiAgICAgICAgICAgIC8vIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgZmlyc3QgYW5jaG9yIGZyb20gYSBOb2RlTGlzdAogICAgICAgICAgICAvLyBjYW4ndCB1c2UgZmlsdGVyLmZpbHRlciwgYXMgaXQgYWNjZXB0cyBvbmx5IGluc3RhbmNlcyBvZiBBcnJheQogICAgICAgICAgICAvLyBhbmQgSUUgY2FuJ3QgY29udmVydCBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBbXS5zbGljZQogICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogdXNlIGZpbHRlciBpZiB3ZSBjaGFuZ2UgaXQgdG8gYWNjZXB0IGxpc3RzIGFzIHdlbGwKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGxpc3QsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAgICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAgICAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG9lcyBub3Qgc2Nyb2xsIHdoZW4gdXNlciBjbGlja3Mgb24gYW5jaG9yIGxpbmsgdGhhdCBpcyBjdXJyZW50bHkgb24KICAgICAgICAgICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkbG9jYXRpb24uaGFzaCgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbDsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIG9iamVjdCBoYXMgdHdvIGdvYWxzOgogICAgICoKICAgICAqIC0gaGlkZSBhbGwgdGhlIGdsb2JhbCBzdGF0ZSBpbiB0aGUgYnJvd3NlciBjYXVzZWQgYnkgdGhlIHdpbmRvdyBvYmplY3QKICAgICAqIC0gYWJzdHJhY3QgYXdheSBhbGwgdGhlIGJyb3dzZXIgc3BlY2lmaWMgZmVhdHVyZXMgYW5kIGluY29uc2lzdGVuY2llcwogICAgICoKICAgICAqIEZvciB0ZXN0cyB3ZSBwcm92aWRlIHtAbGluayBuZ01vY2suJGJyb3dzZXIgbW9jayBpbXBsZW1lbnRhdGlvbn0gb2YgdGhlIGAkYnJvd3NlcmAKICAgICAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICAgICAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICAgICAqLwogICAgLyoqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkb2N1bWVudCBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRzbmlmZmVyICRzbmlmZmVyIHNlcnZpY2UKICAgICAqLwogICAgZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgICAgICAgIGhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeSwKICAgICAgICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0LAogICAgICAgICAgICBjbGVhclRpbWVvdXQgPSB3aW5kb3cuY2xlYXJUaW1lb3V0LAogICAgICAgICAgICBwZW5kaW5nRGVmZXJJZHMgPSB7fTsKCiAgICAgICAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICAgICAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzID0gW107CgogICAgICAgIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgICAgICAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgICAgICAgc2VsZi4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgICAgICAgKiBjb3VudGVyLiBJZiB0aGUgY291bnRlciByZWFjaGVzIDAsIGFsbCB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AgYXJlIGV4ZWN1dGVkLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIE5vdGU6IHRoaXMgbWV0aG9kIGlzIHVzZWQgb25seSBieSBzY2VuYXJpbyBydW5uZXIKICAgICAgICAgKiBUT0RPKHZvanRhKTogcHJlZml4IHRoaXMgbWV0aG9kIHdpdGggJCQgPwogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIG5vIG91dHN0YW5kaW5nIHJlcXVlc3QKICAgICAgICAgKi8KICAgICAgICBzZWxmLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uIChwb2xsRm4pIHsKICAgICAgICAgICAgICAgIHBvbGxGbigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gUG9sbCBXYXRjaGVyIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgICAgICAgcG9sbFRpbWVvdXQ7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2FkZFBvbGxGbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICAgICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQocG9sbFRpbWVvdXQpKSBzdGFydFBvbGxlcigxMDAsIHNldFRpbWVvdXQpOwogICAgICAgICAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGludGVydmFsIEhvdyBvZnRlbiBzaG91bGQgYnJvd3NlciBjYWxsIHBvbGwgZnVuY3Rpb25zIChtcykKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHNldFRpbWVvdXQgUmVmZXJlbmNlIHRvIGEgcmVhbCBvciBmYWtlIGBzZXRUaW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbmZpZ3VyZXMgdGhlIHBvbGxlciB0byBydW4gaW4gdGhlIHNwZWNpZmllZCBpbnRlcnZhbHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQKICAgICAgICAgKiBzZXRUaW1lb3V0IGZuIGFuZCBraWNrcyBpdCBvZmYuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gc3RhcnRQb2xsZXIoaW50ZXJ2YWwsIHNldFRpbWVvdXQpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbiAocG9sbEZuKSB7CiAgICAgICAgICAgICAgICAgICAgcG9sbEZuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBVUkwgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR0VUVEVSOgogICAgICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICAgICAqCiAgICAgICAgICogU0VUVEVSOgogICAgICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICAgICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAgICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAgICAgKi8KICAgICAgICBzZWxmLnVybCA9IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgLy8gc2V0dGVyCiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICAgICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgICAgICAgICAvLyBnZXR0ZXIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICAgICAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csICInIik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgICAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgICAgICAgZnVuY3Rpb24gZmlyZVVybENoYW5nZSgpIHsKICAgICAgICAgICAgaWYgKGxhc3RCcm93c2VyVXJsID09IHNlbGYudXJsKCkpIHJldHVybjsKCiAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gc2VsZi51cmwoKTsKICAgICAgICAgICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgbGlzdGVuZXIoc2VsZi51cmwoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjb25VcmxDaGFuZ2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAVE9ETyh2b2p0YSk6IHJlZmFjdG9yIHRvIHVzZSBub2RlJ3Mgc3ludGF4IGZvciBldmVudHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQsIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG9ubHkgY2FsbGVkIHdoZW4gdGhlIHVybCBpcyBjaGFuZ2VkIGJ5IG91dHNpZGUgb2YgYW5ndWxhcjoKICAgICAgICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICAgICAgICogLSB1c2VyIGNsaWNrcyBvbiBoaXN0b3J5IChmb3J3YXJkL2JhY2spIGJ1dHRvbgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG5vdCBjYWxsZWQgd2hlbiB1cmwgaXMgY2hhbmdlZCBieSAkYnJvd3Nlci51cmwoKSBtZXRob2QKICAgICAgICAgKgogICAgICAgICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICAgICAgICovCiAgICAgICAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAgICAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAgICAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAgICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIHBvbGxpbmcKICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTWlzYyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nPX0KICAgICAgICAgKi8KICAgICAgICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgICAgICAgICAgcmV0dXJuIGhyZWYgPyBocmVmLnJlcGxhY2UoL15odHRwcz9cOlwvXC9bXlwvXSovLCAnJykgOiAnJzsKICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIENvb2tpZXMgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICB2YXIgbGFzdENvb2tpZXMgPSB7fTsKICAgICAgICB2YXIgbGFzdENvb2tpZVN0cmluZyA9ICcnOwogICAgICAgIHZhciBjb29raWVQYXRoID0gc2VsZi5iYXNlSHJlZigpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNjb29raWVzCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQ29va2llIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIENva2tpZSB2YWx1ZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhlIGNvb2tpZXMgbWV0aG9kIHByb3ZpZGVzIGEgJ3ByaXZhdGUnIGxvdyBsZXZlbCBhY2Nlc3MgdG8gYnJvd3NlciBjb29raWVzLgogICAgICAgICAqIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5LCB1c2UgdGhlICRjb29raWUgc2VydmljZSBpbnN0ZWFkLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZXMgdmFyeSBkZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50cyB0aGF0IHRoZSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIGFzIGZvbGxvd3M6CiAgICAgICAgICogPHVsPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMoKSAtPiBoYXNoIG9mIGFsbCBjb29raWVzLCB0aGlzIGlzIE5PVCBhIGNvcHkgb2YgdGhlIGludGVybmFsIHN0YXRlLCBzbyBkbyBub3QgbW9kaWZ5IGl0PC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llPC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdCB3YXkpPC9saT4KICAgICAgICAgKiA8L3VsPgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgICAgICAgKi8KICAgICAgICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNvb2tpZUxlbmd0aCwgY29va2llQXJyYXksIGNvb2tpZSwgaSwgaW5kZXg7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtwYXRoPSIgKyBjb29raWVQYXRoICsgIjtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggPSAocmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgJz0nICsgZXNjYXBlKHZhbHVlKSArICc7cGF0aD0nICsgY29va2llUGF0aCkubGVuZ3RoICsgMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBlciBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyMTA5LnR4dCBicm93c2VyIG11c3QgYWxsb3cgYXQgbWluaW11bToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDIwIGNvb2tpZXMgcGVyIHVuaXF1ZSBkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSA0MDk2IGJ5dGVzIHBlciBjb29raWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciICsgbmFtZSArICInIHBvc3NpYmx5IG5vdCBzZXQgb3Igb3ZlcmZsb3dlZCBiZWNhdXNlIGl0IHdhcyB0b28gbGFyZ2UgKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgICAgICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcmVkLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25pb3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAgICAgICAqCiAgICAgICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAgICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAgICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24gKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyLmRlZmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgZGVmZXJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVseSBjYW5jZWxlZC4KICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyLmNhbmNlbCA9IGZ1bmN0aW9uIChkZWZlcklkKSB7CiAgICAgICAgICAgIGlmIChwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF0pIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgICAgICAgICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgIH0KCiAgICBmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkd2luZG93LCAkbG9nLCAkc25pZmZlciwgJGRvY3VtZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJyb3dzZXIoJHdpbmRvdywgJGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcik7CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmFjdG9yeSB0aGF0IGNvbnN0cnVjdHMgY2FjaGUgb2JqZWN0cy4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICAgKgogICAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlLgogICAgICogLSBge3sqfX1gIGBnZXQoe3N0cmluZ30ga2V5KWAg4oCUIFJldHVybnMgY2FjaGVkIHZhbHVlIGZvciBga2V5YCBvciB1bmRlZmluZWQgZm9yIGNhY2hlIG1pc3MuCiAgICAgKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZUFsbCgpYCDigJQgUmVtb3ZlcyBhbGwgY2FjaGVkIHZhbHVlcy4KICAgICAqIC0gYHt2b2lkfWAgYGRlc3Ryb3koKWAg4oCUIFJlbW92ZXMgcmVmZXJlbmNlcyB0byB0aGlzIGNhY2hlIGZyb20gJGNhY2hlRmFjdG9yeS4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDYWNoZUZhY3RvcnlQcm92aWRlcigpIHsKCiAgICAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY2FjaGVzID0ge307CgogICAgICAgICAgICBmdW5jdGlvbiBjYWNoZUZhY3RvcnkoY2FjaGVJZCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKGNhY2hlSWQgaW4gY2FjaGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ2NhY2hlSWQgJyArIGNhY2hlSWQgKyAnIHRha2VuJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHNpemUgPSAwLAogICAgICAgICAgICAgICAgICAgIHN0YXRzID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7aWQ6IGNhY2hlSWR9KSwKICAgICAgICAgICAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICAgICAgICAgICAgY2FwYWNpdHkgPSAob3B0aW9ucyAmJiBvcHRpb25zLmNhcGFjaXR5KSB8fCBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSB7fSwKICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc3RhbGVFbmQgPSBudWxsOwoKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF0gPSB7CgogICAgICAgICAgICAgICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubiwgbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBpbmZvOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGNhY2hlRmFjdG9yeS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSB7fTsKICAgICAgICAgICAgICAgIGZvckVhY2goY2FjaGVzLCBmdW5jdGlvbiAoY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24gKGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF07CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHRlbXBsYXRlQ2FjaGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENhY2hlIHVzZWQgZm9yIHN0b3JpbmcgaHRtbCB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbiAoJGNhY2hlRmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgndGVtcGxhdGVzJyk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyogISBWQVJJQUJMRS9GVU5DVElPTiBOQU1JTkcgQ09OVkVOVElPTlMgVEhBVCBBUFBMWSBUTyBUSElTIEZJTEUhCiAgICAgKgogICAgICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogICAgICoKICAgICAqIC0gIm5vZGUiIC0gRE9NIE5vZGUKICAgICAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogICAgICogLSAiJG5vZGUiIG9yICIkZWxlbWVudCIgLSBqcUxpdGUtd3JhcHBlZCBub2RlIG9yIGVsZW1lbnQKICAgICAqCiAgICAgKgogICAgICogQ29tcGlsZXIgcmVsYXRlZCBzdHVmZjoKICAgICAqCiAgICAgKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICAgICAqIC0gIm5vZGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUKICAgICAqIC0gImNoaWxkTGlua0ZuIiAtICBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBjaGlsZCBub2RlcyBvZiBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAgICAgKi8KCgogICAgdmFyIE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gPSAnTm9uLWFzc2lnbmFibGUgbW9kZWwgZXhwcmVzc2lvbjogJzsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbXBpbGVzIGEgcGllY2Ugb2YgSFRNTCBzdHJpbmcgb3IgRE9NIGludG8gYSB0ZW1wbGF0ZSBhbmQgcHJvZHVjZXMgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2hpY2gKICAgICAqIGNhbiB0aGVuIGJlIHVzZWQgdG8gbGluayB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gYW5kIHRoZSB0ZW1wbGF0ZSB0b2dldGhlci4KICAgICAqCiAgICAgKiBUaGUgY29tcGlsYXRpb24gaXMgYSBwcm9jZXNzIG9mIHdhbGtpbmcgdGhlIERPTSB0cmVlIGFuZCB0cnlpbmcgdG8gbWF0Y2ggRE9NIGVsZW1lbnRzIHRvCiAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uIEZvciBlYWNoIG1hdGNoIGl0CiAgICAgKiBleGVjdXRlcyBjb3JyZXNwb25kaW5nIHRlbXBsYXRlIGZ1bmN0aW9uIGFuZCBjb2xsZWN0cyB0aGUKICAgICAqIGluc3RhbmNlIGZ1bmN0aW9ucyBpbnRvIGEgc2luZ2xlIHRlbXBsYXRlIGZ1bmN0aW9uIHdoaWNoIGlzIHRoZW4gcmV0dXJuZWQuCiAgICAgKgogICAgICogVGhlIHRlbXBsYXRlIGZ1bmN0aW9uIGNhbiB0aGVuIGJlIHVzZWQgb25jZSB0byBwcm9kdWNlIHRoZSB2aWV3IG9yIGFzIGl0IGlzIHRoZSBjYXNlIHdpdGgKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgcmVwZWF0ZXJ9IG1hbnktdGltZXMsIGluIHdoaWNoCiAgICAgKiBjYXNlIGVhY2ggY2FsbCByZXN1bHRzIGluIGEgdmlldyB0aGF0IGlzIGEgRE9NIGNsb25lIG9mIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZS4KICAgICAqCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0iY29tcGlsZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICAvLyBkZWNsYXJlIGEgbmV3IG1vZHVsZSwgYW5kIGluamVjdCB0aGUgJGNvbXBpbGVQcm92aWRlcgogICAgIGFuZ3VsYXIubW9kdWxlKCdjb21waWxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0iaHRtbCI+PC90ZXh0YXJlYT4gPGJyPgogICAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBhdXRvIGNvbXBpbGUnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIGlucHV0KCdodG1sJykuZW50ZXIoJ3t7bmFtZX19IScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJ2Rpdltjb21waWxlXScpLnRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgoKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoZW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICAgICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZVssIGNsb25lQXR0YWNoRm5dKX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICAgKgogICAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgICAqICAgICAgICAgICAgICAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAgICogICAgICAgICAgICAgICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgICAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICAgKgogICAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAgICoKICAgICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwgZWxlbWVudAogICAgICogcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICAgKgogICAgICogLSBJZiB5b3UgYXJlIG5vdCBhc2tpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdG8gY2xvbmUgdGhlIHRlbXBsYXRlLCBjcmVhdGUgdGhlIERPTSBlbGVtZW50KHMpCiAgICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPHA+e3t0b3RhbH19PC9wPicpKHNjb3BlKTsKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgdGVtcGxhdGVIVE1MID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgICAqCiAgICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUhUTUwpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIC8vbm93IHdlIGhhdmUgcmVmZXJlbmNlIHRvIHRoZSBjbG9uZWQgRE9NIHZpYSBgY2xvbmVgCiAgICAgKiAgIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgaW5mb3JtYXRpb24gb24gaG93IHRoZSBjb21waWxlciB3b3Jrcywgc2VlIHRoZQogICAgICoge0BsaW5rIGd1aWRlL2NvbXBpbGVyIEFuZ3VsYXIgSFRNTCBDb21waWxlcn0gc2VjdGlvbiBvZiB0aGUgRGV2ZWxvcGVyIEd1aWRlLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICovCiAgICAkQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CiAgICBmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgICAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdcLV9dKylccysoLiopJC8sCiAgICAgICAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd1wtX10rKSg/Olw6KFteO10rKSk/Oz8pLywKICAgICAgICAgICAgTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiA9ICdUZW1wbGF0ZSBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB3YXM6ICcsCiAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfGZpbGUpOi87CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmVzIHdpdGggdGhlIGNvbXBpbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UuIChpZSA8Y29kZT5uZ0JpbmQ8L2NvZGU+IHdoaWNoIHdpbGwgbWF0Y2ggYXMKICAgICAgICAgKiAgICAgICAgICAgICAgICA8Y29kZT5uZy1iaW5kPC9jb2RlPikuCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBBbiBpbmplY3RhYmxlIGRpcmVjdGl2ZSBmYWN0cm95IGZ1bmN0aW9uLiBTZWUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZX0gZm9yIG1vcmUKICAgICAgICAgKiAgICAgICAgICAgICAgICBpbmZvLgogICAgICAgICAqIEByZXR1cm5zIHtuZy4kY29tcGlsZVByb3ZpZGVyfSBTZWxmIGZvciBjaGFpbmluZy4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmRpcmVjdGl2ZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5hbWUpKSB7CiAgICAgICAgICAgICAgICBhc3NlcnRBcmcoZGlyZWN0aXZlRmFjdG9yeSwgJ2RpcmVjdGl2ZScpOwogICAgICAgICAgICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24gKGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlID0gJGluamVjdG9yLmludm9rZShkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0geyBjb21waWxlOiB2YWx1ZUZuKGRpcmVjdGl2ZSkgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlyZWN0aXZlLmNvbXBpbGUgJiYgZGlyZWN0aXZlLmxpbmspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5IHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZSB8fCAoZGlyZWN0aXZlLmNvbnRyb2xsZXIgJiYgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0EnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI3VybFNhbml0aXphdGlvbldoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgICAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICAgICAqCiAgICAgICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8gYW4KICAgICAgICAgKiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIHJlZ3VsYXIKICAgICAgICAgKiBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSB0aGUKICAgICAgICAgKiBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpdCBpcyB3cml0dGVuIGludG8gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAgICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICAgICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMudXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHJlZ2V4cCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsKICAgICAgICAgICAgJyRpbmplY3RvcicsICckaW50ZXJwb2xhdGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJHBhcnNlJywKICAgICAgICAgICAgJyRjb250cm9sbGVyJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGludGVycG9sYXRlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcGFyc2UsICRjb250cm9sbGVyLCAkcm9vdFNjb3BlLCAkZG9jdW1lbnQpIHsKCiAgICAgICAgICAgICAgICB2YXIgQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBBdHRyaWJ1dGVzLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgICAgICAqICAgICBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTmFtZV8odGhpcy4kJGVsZW1lbnRbMF0pID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbk5vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhyZWYgcHJvcGVydHkgYWx3YXlzIHJldHVybnMgbm9ybWFsaXplZCBhYnNvbHV0ZSB1cmwsIHNvIHdlIGNhbiBtYXRjaCBhZ2FpbnN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxTYW5pdGl6YXRpb25Ob2RlLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vcm1hbGl6ZWRWYWwubWF0Y2godXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIE9ic2VydmUgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiBUaGUgb2JzZXJ2ZXIgd2lsbCBuZXZlciBiZSBjYWxsZWQsIGlmIGdpdmVuIGF0dHJpYnV0ZSBpcyBub3QgaW50ZXJwb2xhdGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigqKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgYXR0cmlidXRlIHZhbHVlIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCopfSB0aGUgYGZuYCBGdW5jdGlvbiBwYXNzZWQgaW4uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9ic2VydmU6IGZ1bmN0aW9uIChrZXksIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycyA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sID09ICd9fScpCiAgICAgICAgICAgICAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1x7L2csIHN0YXJ0U3ltYm9sKS5yZXBsYWNlKC99fS9nLCBlbmRTeW1ib2wpOwogICAgICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHJldHVybiBjb21waWxlOwoKICAgICAgICAgICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISgkY29tcGlsZU5vZGVzIGluc3RhbmNlb2YganFMaXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBqcXVlcnkgYWx3YXlzIHJld3JhcHMsIHdoZXJlYXMgd2UgbmVlZCB0byBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgc2VsZWN0b3Igc28gdGhhdCB3ZSBjYW4gbW9kaWZ5IGl0LgogICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBXZSBjYW4gbm90IGNvbXBpbGUgdG9wIGxldmVsIHRleHQgZWxlbWVudHMgc2luY2UgdGV4dCBub2RlcyBjYW4gYmUgbWVyZ2VkIGFuZCB3ZSB3aWxsCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCgkY29tcGlsZU5vZGVzLCBmdW5jdGlvbiAobm9kZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMyAvKiB0ZXh0IG5vZGUgKi8gJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmcoc2NvcGUsICdzY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHNvbWV0aW1lcyBjaGFuZ2VzIHRoZSBzdHJ1Y3R1cmUgb2YgdGhlIERPTS4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRsaW5rTm9kZSA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IEpRTGl0ZVByb3RvdHlwZS5jbG9uZS5jYWxsKCRjb21waWxlTm9kZXMpIC8vIElNUE9SVEFOVCEhIQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXR0YWNoIHNjb3BlIG9ubHkgdG8gbm9uLXRleHQgbm9kZXMuCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9ICRsaW5rTm9kZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEgLyogZWxlbWVudCAqLyB8fCBub2RlLm5vZGVUeXBlID09IDkgLyogZG9jdW1lbnQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbGlua05vZGUuZXEoaSkuZGF0YSgnJHNjb3BlJywgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkbGlua05vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcG9zaXRlTGlua0ZuKSBjb21wb3NpdGVMaW5rRm4oc2NvcGUsICRsaW5rTm9kZSwgJGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRsaW5rTm9kZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHdyb25nTW9kZShsb2NhbE5hbWUsIG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5zdXBwb3J0ZWQgJyIgKyBtb2RlICsgIicgZm9yICciICsgbG9jYWxOYW1lICsgIicuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlLCBzaW5jZSBpdCBtZWFucyB0aGF0IHdlIGFyZSB0cnlpbmcgdG8gc2V0IGNsYXNzIG9uCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNWRyBlbGVtZW50LCB3aGVyZSBjbGFzcyBuYW1lIGlzIHJlYWQtb25seS4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAqIGZvciBhIHBhcnRpY3VsYXIgbm9kZSBhcmUgY29sbGVjdGVkIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhlIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9ucyByZXR1cm4gdmFsdWVzIC0gdGhlIGxpbmtpbmcgZnVuY3Rpb25zIC0gYXJlIGNvbWJpbmVkIGludG8gYSBjb21wb3NpdGUgbGlua2luZwogICAgICAgICAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZUxpc3R9IG5vZGVMaXN0IGFuIGFycmF5IG9mIG5vZGVzIG9yIE5vZGVMaXN0IHRvIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnQ9fSAkcm9vdEVsZW1lbnQgSWYgdGhlIG5vZGVMaXN0IGlzIHRoZSByb290IG9mIHRoZSBjb21waWxhdGlvbiB0cmVlIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBuZWVkZWQgc28gdGhhdCB0aGUganFMaXRlIGNvbGxlY3Rpb24gaXRlbXMgY2FuIGJlIHJlcGxhY2VkIHdpdGggd2lkZ2V0cy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4IGRpcmVjdGl2ZSBwcmlvcml0eQogICAgICAgICAgICAgICAgICogQHJldHVybnMgez9mdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlTm9kZXMobm9kZUxpc3QsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBkaXJlY3RpdmVzLCBhdHRycywgbGlua0ZuRm91bmQ7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbnMucHVzaChjaGlsZExpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiwgaSwgaWksIG47CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gbm9kZUxpc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG4gPSAwLCBpaSA9IGxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuID0gbGlua0Zuc1tpKytdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4uc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoaXNPYmplY3Qobm9kZUxpbmtGbi5zY29wZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUobm9kZSkuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IG5vZGVMaW5rRm4udHJhbnNjbHVkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRUcmFuc2NsdWRlRm4gfHwgKCFib3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAodHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjbG9uZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZVNjb3BlLCBjbG9uZUZuKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmQoJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlU2NvcGUsIHRyYW5zY2x1ZGVTY29wZS4kZGVzdHJveSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAgICAgICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IC8qIEVsZW1lbnQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKS50b0xvd2VyQ2FzZSgpKSwgJ0UnLCBtYXhQcmlvcml0eSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSAwLCBqaiA9IG5BdHRycyAmJiBuQXR0cnMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIgPSBuQXR0cnNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQgY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMgb24gaXQuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sIGpxQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIHByZXZlbnQgZnVydGhlciBwcm9jZXNzaW5nIG9mIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBuZXdTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCB0cmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9PSAnZWxlbWVudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKyB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBqcUxpdGUoJHRlbXBsYXRlWzBdKSwgY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShKUUxpdGVDbG9uZShjb21waWxlTm9kZSkpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOyAvLyBjbGVhciBjb250ZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRlbm9ybWFsaXplVGVtcGxhdGUoZGlyZWN0aXZlVmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJpbShkaXJlY3RpdmVWYWx1ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiArIGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gc3BsaXQgaXQgaW50byB0d28gcGFydHMsIHRob3NlIHRoYXQgd2VyZSBhbHJlYWR5IGFwcGxpZWQgYW5kIHRob3NlIHRoYXQgd2VyZW4ndAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlLCBhZGQgdGhlbSB0byB0aGUgc2Vjb25kIGdyb3VwIGFuZCBzb3J0IHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGFwcGVuZCB0aGUgc2Vjb25kIGdyb3VwIHdpdGggbmV3IGRpcmVjdGl2ZXMgdG8gdGhlIGZpcnN0IGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zcGxpY2UoaSArIDEsIGRpcmVjdGl2ZXMubGVuZ3RoIC0gKGkgKyAxKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUZW1wbGF0ZUF0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcy5zcGxpY2UoaSwgZGlyZWN0aXZlcy5sZW5ndGggLSBpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgZGlyZWN0aXZlLnJlcGxhY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkaXJlY3RpdmUuY29tcGlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBkaXJlY3RpdmUuY29tcGlsZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaW5rRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRMaW5rRm5zKGxpbmtGbi5wcmUsIGxpbmtGbi5wb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4udGVybWluYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IE1hdGgubWF4KHRlcm1pbmFsUHJpb3JpdHksIGRpcmVjdGl2ZS5wcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnNjb3BlID0gbmV3U2NvcGVEaXJlY3RpdmUgJiYgbmV3U2NvcGVEaXJlY3RpdmUuc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gdHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gbWlnaHQgYmUgbm9ybWFsIG9yIGRlbGF5ZWQgbm9kZUxpbmtGbiBkZXBlbmRpbmcgb24gaWYgdGVtcGxhdGVVcmwgaXMgcHJlc2VudAogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlTGlua0ZuOwoKICAgICAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRMaW5rRm5zKHByZSwgcG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3QucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMucHVzaChwb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgodmFsdWUgPSByZXF1aXJlLmNoYXJBdCgwKSkgPT0gJ14nIHx8IHZhbHVlID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ14nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBvcHRpb25hbCB8fCB2YWx1ZSA9PSAnPyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlICYmICFvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJObyBjb250cm9sbGVyOiAiICsgcmVxdWlyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocmVxdWlyZSwgZnVuY3Rpb24gKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSlccyooXHcqKVxzKiQvOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlLiRwYXJlbnQgfHwgc2NvcGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uIChkZWZpbml0b24sIHNjb3BlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IG1hdGNoWzJdIHx8IHNjb3BlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0LCBwYXJlbnRTZXQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGNoYW5nZSwgb3Igd2Ugd2lsbCB0aHJvdyB0aGlzIGV4Y2VwdGlvbiBvbiBldmVyeSAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiArIGF0dHJzW2F0dHJOYW1lXSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgKGRpcmVjdGl2ZTogJyArIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lICsgJyknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBwYXJlbnRWYWx1ZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gc2NvcGVbc2NvcGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgb3V0IG9mIHN5bmMgYW5kIG5lZWQgdG8gY29weQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNoYW5nZWQgYW5kIGl0IGhhcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgcGFyZW50IGNhbiBiZSBhc3NpZ25lZCB0aGVuIGRvIHNvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTZXQocGFyZW50U2NvcGUsIHBhcmVudFZhbHVlID0gbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHBhcmVudFNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCBpc29sYXRlIHNjb3BlIGRlZmluaXRpb24gZm9yIGRpcmVjdGl2ZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSArICc6ICcgKyBkZWZpbml0b24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyRGlyZWN0aXZlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChjb250cm9sbGVyRGlyZWN0aXZlcywgZnVuY3Rpb24gKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IGJvdW5kVHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcHJlTGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVDVVJTSU9OCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gcG9zdExpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBwb3N0TGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCBkZWNvcmF0ZXMgaXQgd2l0aCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIHByb3BlciBwYXJhbWV0ZXJzLiBXZQogICAgICAgICAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAgICAgICAgICogICBTdHJpbmcgY29udGFpbmluZyBhbnkgb2YgdGhlc2VzIGNoYXJhY3RlcnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICAgICAgICAgKiAgICogYEEnOiBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgICAqICAgKiBgQ2A6IGNsYXNzCiAgICAgICAgICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgYWRkZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtYXhQcmlvcml0eSA9PT0gdW5kZWZpbmVkIHx8IG1heFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QuaW5kZXhPZihsb2NhdGlvbikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdERpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAgICAgICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBuZXcgYXR0cmlidXRlcyBvbiB0aGUgb2xkIGF0dHJzIG9iamVjdAogICAgICAgICAgICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsICRlbGVtZW50LmF0dHIoJ3N0eWxlJykgKyAnOycgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0cltrZXldID0gc3JjQXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdEF0dHJzLCAkcm9vdEVsZW1lbnQsIHJlcGxhY2UsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsgdHJpbShjb250ZW50KSArICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SICsgY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wVGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIGRpcmVjdGl2ZXMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMudW5zaGlmdChkZXJpdmVkU3luY0RpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpbmtRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1Jvb3RFbGVtZW50ID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBjb21waWxlTm9kZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9IEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgobGlua1Jvb3RFbGVtZW50LCBqcUxpdGUoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSksIGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbiAocmVzcG9uc2UsIGNvZGUsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHRlbXBsYXRlOiAnICsgY29uZmlnLnVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlua1F1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHJvb3RFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5wcmlvcml0eSAtIGEucHJpb3JpdHk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFzc2VydE5vRHVwbGljYXRlKHdoYXQsIHByZXZpb3VzRGlyZWN0aXZlLCBkaXJlY3RpdmUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ011bHRpcGxlIGRpcmVjdGl2ZXMgWycgKyBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lICsgJywgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUubmFtZSArICddIGFza2luZyBmb3IgJyArIHdoYXQgKyAnIG9uOiAnICsgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh0ZXh0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHBhcmVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goaW50ZXJwb2xhdGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbMF0ubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHZhbHVlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gYXR0ckludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGludGVycG9sYXRlIGNsYXNzZXMgYWdhaW4sIGluIHRoZSBjYXNlIHRoZSBlbGVtZW50IHdhcyByZXBsYWNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB0aGVyZWZvcmUgdGhlIHR3byBjbGFzcyBhdHRycyBnb3QgbWVyZ2VkIC0gd2Ugd2FudCB0byBpbnRlcnBvbGF0ZSB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyW25hbWVdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCQkb2JzZXJ2ZXJzW25hbWVdIHx8ICgkJG9ic2VydmVyc1tuYW1lXSA9IFtdKSkuJCRpbnRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIGEgc3BlY2lhbCBqcUxpdGUucmVwbGFjZVdpdGgsIHdoaWNoIGNhbiByZXBsYWNlIGl0ZW1zIHdoaWNoCiAgICAgICAgICAgICAgICAgKiBoYXZlIG5vIHBhcmVudHMsIHByb3ZpZGVkIHRoYXQgdGhlIGNvbnRhaW5pbmcganFMaXRlIGNvbGxlY3Rpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtKcUxpdGU9fSAkcm9vdEVsZW1lbnQgVGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZS4gVXNlZCBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgICAgICAgICAgICAgKiAgICBpbiB0aGUgcm9vdCBvZiB0aGUgdHJlZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlfSAkZWxlbWVudCBUaGUganFMaXRlIGVsZW1lbnQgd2hpY2ggd2UgYXJlIGdvaW5nIHRvIHJlcGxhY2UuIFdlIGtlZXAgdGhlIHNoZWxsLAogICAgICAgICAgICAgICAgICogICAgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZX0gbmV3Tm9kZSBUaGUgbmV3IERPTSBub2RlLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsICRlbGVtZW50LCBuZXdOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZE5vZGUgPSAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkTm9kZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgICBpLCBpaTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50W2ldID09IG9sZE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSBuZXdOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IG9sZE5vZGVbanFMaXRlLmV4cGFuZG9dOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaVJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4KICAgICAqLwoKCiAgICAvKioKICAgICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAgICovCgogICAgZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLCAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICB9CgogICAgZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwgLyogTm9kZSAqLyBub2RlLCAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LCAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogICAgICogY29udHJvbGxlcnMuCiAgICAgKgogICAgICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogICAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICAgICAgICB2YXIgY29udHJvbGxlcnMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbnRyb2xsZXJQcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAgICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAgICAgICAqLwogICAgICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbiAobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlcnMsIG5hbWUpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sbGVyc1tuYW1lXSA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJGluamVjdG9yLCAkd2luZG93KSB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGNvbnN0cnVjdG9yIElmIGNhbGxlZCB3aXRoIGEgZnVuY3Rpb24gdGhlbiBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgdGhlCiAgICAgICAgICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICAgICAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgICAgICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGB3aW5kb3dbY29uc3RydWN0b3JdYCBvbiB0aGUgZ2xvYmFsIGB3aW5kb3dgIG9iamVjdAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIEluamVjdGlvbiBsb2NhbHMgZm9yIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gSW5zdGFuY2Ugb2YgZ2l2ZW4gY29udHJvbGxlci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIGAkY29udHJvbGxlcmAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgaW5zdGFudGlhdGluZyBjb250cm9sbGVycy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQncyBqdXN0IGEgc2ltcGxlIGNhbGwgdG8ge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0sIGJ1dCBleHRyYWN0ZWQgaW50bwogICAgICAgICAgICAgKiBhIHNlcnZpY2UsIHNvIHRoYXQgb25lIGNhbiBvdmVycmlkZSB0aGlzIHNlcnZpY2Ugd2l0aCB7QGxpbmsgaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTY0OTc4OAogICAgICAgICAgICAgKiBCQyB2ZXJzaW9ufS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoY29uc3RydWN0b3IsIGxvY2FscykgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGNvbnN0cnVjdG9yKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIG5hbWUsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBuYW1lLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oY29uc3RydWN0b3IsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IsIGxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZG9jdW1lbnQKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogICAgICogZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKHdpbmRvdykgewogICAgICAgICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRleGNlcHRpb25IYW5kbGVyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICAgKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICAgICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICAgKgogICAgICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICAgICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICAgICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbiAoJGxvZykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IuYXBwbHkoJGxvZywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRJbnRlcnBvbGF0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBzdGFydFN5bWJvbCA9ICd7eyc7CiAgICAgICAgdmFyIGVuZFN5bWJvbCA9ICd9fSc7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgc3RhcnRpbmcgc3ltYm9sIHRvLgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgZW5kaW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuZW5kU3ltYm9sID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICAgICAgICAgIGVuZFN5bWJvbExlbmd0aCA9IGVuZFN5bWJvbC5sZW5ndGg7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJlcXVpcmVzICRwYXJzZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQ29tcGlsZXMgYSBzdHJpbmcgd2l0aCBtYXJrdXAgaW50byBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBUaGlzIHNlcnZpY2UgaXMgdXNlZCBieSB0aGUKICAgICAgICAgICAgICogSFRNTCB7QGxpbmsgbmcuJGNvbXBpbGUgJGNvbXBpbGV9IHNlcnZpY2UgZm9yIGRhdGEgYmluZGluZy4gU2VlCiAgICAgICAgICAgICAqIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciAkaW50ZXJwb2xhdGVQcm92aWRlcn0gZm9yIGNvbmZpZ3VyaW5nIHRoZQogICAgICAgICAgICAgKiBpbnRlcnBvbGF0aW9uIG1hcmt1cC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgIDxwcmU+CiAgICAgICAgICAgICB2YXIgJGludGVycG9sYXRlID0gLi4uOyAvLyBpbmplY3RlZAogICAgICAgICAgICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgnSGVsbG8ge3tuYW1lfX0hJyk7CiAgICAgICAgICAgICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgICAgICAgICA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG11c3RIYXZlRXhwcmVzc2lvbiBpZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBpbnRlcnBvbGF0aW9uIHN0cmluZyBtdXN0IGhhdmUKICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiBpbiBvcmRlciB0byByZXR1cm4gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gU3RyaW5ncyB3aXRoIG5vCiAgICAgICAgICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0KX0gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlIGludGVycG9sYXRlZAogICAgICAgICAgICAgKiAgICBzdHJpbmcuIFRoZSBmdW5jdGlvbiBoYXMgdGhlc2UgcGFyYW1ldGVyczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGA6IGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncyBhcmUgZXZhbHVhdGVkCiAgICAgICAgICAgICAqICAgICAgYWdhaW5zdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uICRpbnRlcnBvbGF0ZSh0ZXh0LCBtdXN0SGF2ZUV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4LAogICAgICAgICAgICAgICAgICAgIGVuZEluZGV4LAogICAgICAgICAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRleHQubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBmbiwKICAgICAgICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgICAgICAgY29uY2F0ID0gW107CgogICAgICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uIHx8IGhhc0ludGVycG9sYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBjb25jYXQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbGVuZ3RoLCBwYXJ0OyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFydCAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmNhdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI2VuZFN5bWJvbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkaW50ZXJwb2xhdGU7CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFVSTF9NQVRDSCA9IC9eKFteOl0rKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcez9bXHdcLi1dKlx9PykoOihbMC05XSspKT8oXC9bXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIFBBVEhfTUFUQ0ggPSAvXihbXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIEhBU0hfTUFUQ0ggPSBQQVRIX01BVENILAogICAgICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzogMjF9OwoKCiAgICAvKioKICAgICAqIEVuY29kZSBwYXRoIHVzaW5nIGVuY29kZVVyaVNlZ21lbnQsIGlnbm9yaW5nIGZvcndhcmQgc2xhc2hlcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFBhdGggdG8gZW5jb2RlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICAgICAgICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJyksCiAgICAgICAgICAgIGkgPSBzZWdtZW50cy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBlbmNvZGVVcmlTZWdtZW50KHNlZ21lbnRzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWF0Y2hVcmwodXJsLCBvYmopIHsKICAgICAgICB2YXIgbWF0Y2ggPSBVUkxfTUFUQ0guZXhlYyh1cmwpOwoKICAgICAgICBtYXRjaCA9IHsKICAgICAgICAgICAgcHJvdG9jb2w6IG1hdGNoWzFdLAogICAgICAgICAgICBob3N0OiBtYXRjaFszXSwKICAgICAgICAgICAgcG9ydDogaW50KG1hdGNoWzVdKSB8fCBERUZBVUxUX1BPUlRTW21hdGNoWzFdXSB8fCBudWxsLAogICAgICAgICAgICBwYXRoOiBtYXRjaFs2XSB8fCAnLycsCiAgICAgICAgICAgIHNlYXJjaDogbWF0Y2hbOF0sCiAgICAgICAgICAgIGhhc2g6IG1hdGNoWzEwXQogICAgICAgIH07CgogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgb2JqLiQkcHJvdG9jb2wgPSBtYXRjaC5wcm90b2NvbDsKICAgICAgICAgICAgb2JqLiQkaG9zdCA9IG1hdGNoLmhvc3Q7CiAgICAgICAgICAgIG9iai4kJHBvcnQgPSBtYXRjaC5wb3J0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChwcm90b2NvbCwgaG9zdCwgcG9ydCkgewogICAgICAgIHJldHVybiBwcm90b2NvbCArICc6Ly8nICsgaG9zdCArIChwb3J0ID09IERFRkFVTFRfUE9SVFNbcHJvdG9jb2xdID8gJycgOiAnOicgKyBwb3J0KTsKICAgIH0KCgogICAgZnVuY3Rpb24gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSB7CiAgICAgICAgcmV0dXJuIGJhc2VQYXRoLnN1YnN0cigwLCBiYXNlUGF0aC5sYXN0SW5kZXhPZignLycpKTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSHRtbDVVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaHRtbDUgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSAhPSBiYXNlUGF0aCB8fCBpc1VuZGVmaW5lZChtYXRjaC5oYXNoKSB8fAogICAgICAgICAgICBtYXRjaC5oYXNoLmluZGV4T2YoaGFzaFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICAgICAgLy8gY29udmVydCBoYXNoYmFuZyB1cmwgLT4gaHRtbDUgdXJsCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpICsgbWF0Y2guaGFzaC5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSGFzaGJhbmdVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaGFzaGJhbmcgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSA9PSBiYXNlUGF0aCAmJiAhaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgJiYKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaHRtbDUgdXJsIC0+IGhhc2hiYW5nIHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSBtYXRjaC5zZWFyY2ggJiYgJz8nICsgbWF0Y2guc2VhcmNoIHx8ICcnLAogICAgICAgICAgICAgICAgaGFzaCA9IG1hdGNoLmhhc2ggJiYgJyMnICsgbWF0Y2guaGFzaCB8fCAnJywKICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpLAogICAgICAgICAgICAgICAgcGF0aCA9IG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKTsKCiAgICAgICAgICAgIGlmIChtYXRjaC5wYXRoLmluZGV4T2YocGF0aFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIHVybCArICciLCBtaXNzaW5nIHBhdGggcHJlZml4ICInICsgcGF0aFByZWZpeCArICciICEnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArIGJhc2VQYXRoICsKICAgICAgICAgICAgICAgICcjJyArIGhhc2hQcmVmaXggKyBwYXRoICsgc2VhcmNoICsgaGFzaDsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25VcmwgcmVwcmVzZW50cyBhbiB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIVE1MNSB1cmwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoUHJlZml4CiAgICAgKi8KICAgIGZ1bmN0aW9uIExvY2F0aW9uVXJsKHVybCwgcGF0aFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4IHx8ICcnOwoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZSBnaXZlbiBodG1sNSAocmVndWxhcikgdXJsIHN0cmluZyBpbnRvIHByb3BlcnRpZXMKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3QWJzb2x1dGVVcmwgSFRNTDUgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAobmV3QWJzb2x1dGVVcmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwobmV3QWJzb2x1dGVVcmwsIHRoaXMpOwoKICAgICAgICAgICAgaWYgKG1hdGNoLnBhdGguaW5kZXhPZihwYXRoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgbmV3QWJzb2x1dGVVcmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2guaGFzaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICAgICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICAgICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgICAgICAgdGhpcy4kJGFic1VybCA9IGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KHRoaXMuJCRwcm90b2NvbCwgdGhpcy4kJGhvc3QsIHRoaXMuJCRwb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgdGhpcy4kJHVybDsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGRpc2FibGVkIG9yIG5vdCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTGVnYWN5IHVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHZhciBiYXNlUGF0aDsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCwgdGhpcyk7CgoKICAgICAgICAgICAgaWYgKG1hdGNoLmhhc2ggJiYgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBoYXNoIHByZWZpeCAiJyArIGhhc2hQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJhc2VQYXRoID0gbWF0Y2gucGF0aCArIChtYXRjaC5zZWFyY2ggPyAnPycgKyBtYXRjaC5zZWFyY2ggOiAnJyk7CiAgICAgICAgICAgIG1hdGNoID0gSEFTSF9NQVRDSC5leGVjKChtYXRjaC5oYXNoIHx8ICcnKS5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkcGF0aCA9IChtYXRjaFsxXS5jaGFyQXQoMCkgPT0gJy8nID8gJycgOiAnLycpICsgZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoWzNdKTsKICAgICAgICAgICAgdGhpcy4kJGhhc2ggPSBtYXRjaFs1XSAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbNV0pIHx8ICcnOwoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydCh0aGlzLiQkcHJvdG9jb2wsIHRoaXMuJCRob3N0LCB0aGlzLiQkcG9ydCkgKwogICAgICAgICAgICAgICAgYmFzZVBhdGggKyAodGhpcy4kJHVybCA/ICcjJyArIGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsIDogJycpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24gKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZiAoYWJzb2x1dGVMaW5rVXJsLmluZGV4T2YoYXBwQmFzZVVybCkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFic29sdXRlTGlua1VybDsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHRoaXMuJCRwYXJzZSh1cmwpOwogICAgfQoKCiAgICBMb2NhdGlvblVybC5wcm90b3R5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICoge0BsaW5rIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IFJGQyAzOTg2fS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgKi8KICAgICAgICBhYnNVcmw6IGxvY2F0aW9uR2V0dGVyKCckJGFic1VybCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICAgICAgICovCiAgICAgICAgdXJsOiBmdW5jdGlvbiAodXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB0aGlzLnBhdGgoZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKSk7CiAgICAgICAgICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgICAgICAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycsIHJlcGxhY2UpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAgICAgICAqLwogICAgICAgIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI2hvc3QKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqLwogICAgICAgIGhvc3Q6IGxvY2F0aW9uR2V0dGVyKCckJGhvc3QnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwb3J0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcG9ydCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge051bWJlcn0gcG9ydAogICAgICAgICAqLwogICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwYXRoCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAgICAgICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhdGggTmV3IHBhdGgKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgICAgICAgKi8KICAgICAgICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdDxzdHJpbmcsc3RyaW5nPj19IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvciBoYXNoIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZywgdGhlbiBgcGFyYW1WYWx1ZWAgd2lsbCBvdmVycmlkZSBvbmx5IGEKICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHNlYXJjaAogICAgICAgICAqLwogICAgICAgIHNlYXJjaDogZnVuY3Rpb24gKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoc2VhcmNoKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkc2VhcmNoOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChwYXJhbVZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy4kJHNlYXJjaFtzZWFyY2hdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoW3NlYXJjaF0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IGlzU3RyaW5nKHNlYXJjaCkgPyBwYXJzZUtleVZhbHVlKHNlYXJjaCkgOiBzZWFyY2g7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jaGFzaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGhhc2ggTmV3IGhhc2ggZnJhZ21lbnQKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgICAgICAgKi8KICAgICAgICBoYXNoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRoYXNoJywgaWRlbnRpdHkpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3JlcGxhY2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAgICAgICAqLwogICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9OwoKICAgIExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvblVybC5wcm90b3R5cGUpOwoKICAgIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCwgYmFzZUV4dHJhKSB7CiAgICAgICAgTG9jYXRpb25IYXNoYmFuZ1VybC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZVVybCArIGJhc2VFeHRyYSArICcjJyArIGhhc2hQcmVmaXggKyBhYnNvbHV0ZUxpbmtVcmwuc3Vic3RyKGFwcEJhc2VVcmwubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybC5wcm90b3R5cGUgPSBpbmhlcml0KExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKCiAgICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gcHJlcHJvY2Vzcyh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbgogICAgICoKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogICAgICoge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3dpbmRvdy5sb2NhdGlvbiB3aW5kb3cubG9jYXRpb259KSBhbmQgbWFrZXMgdGhlIFVSTAogICAgICogYXZhaWxhYmxlIHRvIHlvdXIgYXBwbGljYXRpb24uIENoYW5nZXMgdG8gdGhlIFVSTCBpbiB0aGUgYWRkcmVzcyBiYXIgYXJlIHJlZmxlY3RlZCBpbnRvCiAgICAgKiAkbG9jYXRpb24gc2VydmljZSBhbmQgY2hhbmdlcyB0byAkbG9jYXRpb24gYXJlIHJlZmxlY3RlZCBpbnRvIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLgogICAgICoKICAgICAqICoqVGhlICRsb2NhdGlvbiBzZXJ2aWNlOioqCiAgICAgKgogICAgICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogICAgICogICAtIFdhdGNoIGFuZCBvYnNlcnZlIHRoZSBVUkwuCiAgICAgKiAgIC0gQ2hhbmdlIHRoZSBVUkwuCiAgICAgKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogICAgICogICAtIENoYW5nZXMgdGhlIGFkZHJlc3MgYmFyLgogICAgICogICAtIENsaWNrcyB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiAob3IgY2xpY2tzIGEgSGlzdG9yeSBsaW5rKS4KICAgICAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogICAgICogLSBSZXByZXNlbnRzIHRoZSBVUkwgb2JqZWN0IGFzIGEgc2V0IG9mIG1ldGhvZHMgKHByb3RvY29sLCBob3N0LCBwb3J0LCBwYXRoLCBzZWFyY2gsIGhhc2gpLgogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnNlcnZpY2VzLiRsb2NhdGlvbiBEZXZlbG9wZXIgR3VpZGU6IEFuZ3VsYXIKICAgICAqIFNlcnZpY2VzOiBVc2luZyAkbG9jYXRpb259CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICAgICAqLwogICAgZnVuY3Rpb24gJExvY2F0aW9uUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbiAocHJlZml4KSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocHJlZml4KSkgewogICAgICAgICAgICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhc2hQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNodG1sNU1vZGUKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1vZGUgVXNlIEhUTUw1IHN0cmF0ZWd5IGlmIGF2YWlsYWJsZS4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAgICAgICAqLwogICAgICAgIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24gKG1vZGUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChtb2RlKSkgewogICAgICAgICAgICAgICAgaHRtbDVNb2RlID0gbW9kZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw1TW9kZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckc25pZmZlcicsICckcm9vdEVsZW1lbnQnLAogICAgICAgICAgICBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGJyb3dzZXIsICRzbmlmZmVyLCAkcm9vdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciAkbG9jYXRpb24sCiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGgsCiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCwKICAgICAgICAgICAgICAgICAgICBpbml0VXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybFBhcnRzID0gbWF0Y2hVcmwoaW5pdFVybCksCiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybDsKCiAgICAgICAgICAgICAgICBpZiAoaHRtbDVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGggPSAkYnJvd3Nlci5iYXNlSHJlZigpIHx8ICcvJzsKICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKTsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggKyAnLyc7CgogICAgICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvblVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0h0bWw1VXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0hhc2hiYW5nVXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VQYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCArIDEpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmwgPQogICAgICAgICAgICAgICAgICAgICAgICBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChpbml0VXJsUGFydHMucHJvdG9jb2wsIGluaXRVcmxQYXJ0cy5ob3N0LCBpbml0VXJsUGFydHMucG9ydCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5wYXRoIHx8ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaW5pdFVybFBhcnRzLnNlYXJjaCA/ICgnPycgKyBpbml0VXJsUGFydHMuc2VhcmNoKSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ1VybChpbml0VXJsLCBoYXNoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGVBcHBVcmwoYWJzSHJlZik7CgogICAgICAgICAgICAgICAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdFVybCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgICAgICAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24gKG5ld1VybCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgbmV3VXJsLCAkbG9jYXRpb24uYWJzVXJsKCkpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGxvY2F0aW9uLmFic1VybCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG5ld1VybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlIGJyb3dzZXIKICAgICAgICAgICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMDsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uICRsb2NhdGlvbldhdGNoKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlcGxhY2UgPSAkbG9jYXRpb24uJCRyZXBsYWNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWNoYW5nZUNvdW50ZXIgfHwgb2xkVXJsICE9ICRsb2NhdGlvbi5hYnNVcmwoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2cKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgICAqCiAgICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICBNZXNzYWdlOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNsb2cKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIGxvZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2luZm8KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZXJyb3IKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wOwoKICAgICAgICAgICAgICAgIGlmIChsb2dGbi5hcHBseSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goZm9ybWF0RXJyb3IoYXJnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9nRm4uYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgICAgICAgICAgICAvLyBvciB3ZSBhcmUgSUUgd2hlcmUgY29uc29sZS5sb2cgZG9lc24ndCBoYXZlIGFwcGx5IHNvIHdlIGxvZyBhdCBsZWFzdCBmaXJzdCAyIGFyZ3MKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJnMSwgYXJnMikgewogICAgICAgICAgICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIE9QRVJBVE9SUyA9IHsKICAgICAgICAnbnVsbCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgICAndHJ1ZSc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAnZmFsc2UnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHVuZGVmaW5lZDogbm9vcCwKICAgICAgICAnKyc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgYSA9IGEoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgYiA9IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0RlZmluZWQoYikgPyBiIDogdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJy0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIHJldHVybiAoaXNEZWZpbmVkKGEpID8gYSA6IDApIC0gKGlzRGVmaW5lZChiKSA/IGIgOiAwKTsKICAgICAgICB9LAogICAgICAgICcqJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICogYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJy8nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgLyBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAlIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICdeJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpIF4gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJz0nOiBub29wLAogICAgICAgICc9PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA9PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnIT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgIT0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJzwnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA+IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICc8PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA8PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPj0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPj0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyYmJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICYmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICd8fCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSB8fCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhfGI7fSwKICAgICAgICAnfCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgfSwKICAgICAgICAnISc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEpIHsKICAgICAgICAgICAgcmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBFU0NBUEUgPSB7Im4iOiAiXG4iLCAiZiI6ICJcZiIsICJyIjogIlxyIiwgInQiOiAiXHQiLCAidiI6ICJcdiIsICInIjogIiciLCAnIic6ICciJ307CgogICAgZnVuY3Rpb24gbGV4KHRleHQsIGNzcCkgewogICAgICAgIHZhciB0b2tlbnMgPSBbXSwKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAganNvbiA9IFtdLAogICAgICAgICAgICBjaCwKICAgICAgICAgICAgbGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBpZiAoaXMoJyJcJycpKSB7CiAgICAgICAgICAgICAgICByZWFkU3RyaW5nKGNoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihjaCkgfHwgaXMoJy4nKSAmJiBpc051bWJlcihwZWVrKCkpKSB7CiAgICAgICAgICAgICAgICByZWFkTnVtYmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNJZGVudChjaCkpIHsKICAgICAgICAgICAgICAgIHJlYWRJZGVudCgpOwogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllcnMgY2FuIG9ubHkgYmUgaWYgdGhlIHByZWNlZGluZyBjaGFyIHdhcyBhIHsgb3IgLAogICAgICAgICAgICAgICAgaWYgKHdhcygneywnKSAmJiBqc29uWzBdID09ICd7JyAmJgogICAgICAgICAgICAgICAgICAgICh0b2tlbiA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4uanNvbiA9IHRva2VuLnRleHQuaW5kZXhPZignLicpID09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzKCcoKXt9W10uLDs6JykpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogY2gsCiAgICAgICAgICAgICAgICAgICAganNvbjogKHdhcygnOlssJykgJiYgaXMoJ3tbJykpIHx8IGlzKCd9XTosJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGlzKCd7WycpKSBqc29uLnVuc2hpZnQoY2gpOwogICAgICAgICAgICAgICAgaWYgKGlzKCd9XScpKSBqc29uLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjaDIgPSBjaCArIHBlZWsoKSwKICAgICAgICAgICAgICAgICAgICBmbiA9IE9QRVJBVE9SU1tjaF0sCiAgICAgICAgICAgICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgICAgICAgICBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OiBpbmRleCwgdGV4dDogY2gyLCBmbjogZm4yfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IGluZGV4LCB0ZXh0OiBjaCwgZm46IGZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0Q2ggPSBjaDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuczsKCiAgICAgICAgZnVuY3Rpb24gaXMoY2hhcnMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLmluZGV4T2YoY2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2FzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGxhc3RDaCkgIT0gLTE7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKCkgewogICAgICAgICAgICByZXR1cm4gaW5kZXggKyAxIDwgdGV4dC5sZW5ndGggPyB0ZXh0LmNoYXJBdChpbmRleCArIDEpIDogZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc051bWJlcihjaCkgewogICAgICAgICAgICByZXR1cm4gJzAnIDw9IGNoICYmIGNoIDw9ICc5JzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzV2hpdGVzcGFjZShjaCkgewogICAgICAgICAgICByZXR1cm4gY2ggPT0gJyAnIHx8IGNoID09ICdccicgfHwgY2ggPT0gJ1x0JyB8fAogICAgICAgICAgICAgICAgY2ggPT0gJ1xuJyB8fCBjaCA9PSAnXHYnIHx8IGNoID09ICdcdTAwQTAnOyAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNJZGVudChjaCkgewogICAgICAgICAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAgICAgJ18nID09IGNoIHx8IGNoID09ICckJzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRXhwT3BlcmF0b3IoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICctJyB8fCBjaCA9PSAnKycgfHwgaXNOdW1iZXIoY2gpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJMZXhlciBFcnJvcjogIiArIGVycm9yICsgIiBhdCBjb2x1bW4iICsKICAgICAgICAgICAgICAgIChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAiLSIgKyBpbmRleCArICIgWyIgKyB0ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKSArICJdIgogICAgICAgICAgICAgICAgICAgIDogIiAiICsgZW5kKSArCiAgICAgICAgICAgICAgICAiIGluIGV4cHJlc3Npb24gWyIgKyB0ZXh0ICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkTnVtYmVyKCkgewogICAgICAgICAgICB2YXIgbnVtYmVyID0gIiI7CiAgICAgICAgICAgIHZhciBzdGFydCA9IGluZGV4OwogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIGNoID0gbG93ZXJjYXNlKHRleHQuY2hhckF0KGluZGV4KSk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBlZWtDaCA9IHBlZWsoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIGlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBwZWVrQ2ggJiYgaXNOdW1iZXIocGVla0NoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCFwZWVrQ2ggfHwgIWlzTnVtYmVyKHBlZWtDaCkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBudW1iZXIgPSAxICogbnVtYmVyOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IHN0YXJ0LCB0ZXh0OiBudW1iZXIsIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXI7CiAgICAgICAgICAgICAgICB9fSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkSWRlbnQoKSB7CiAgICAgICAgICAgIHZhciBpZGVudCA9ICIiLAogICAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleCwKICAgICAgICAgICAgICAgIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzSWRlbnQoY2gpIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicpIGxhc3REb3QgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgICAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgICAgICAgICBwZWVrSW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgICAgICAgdGV4dDogaWRlbnQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgICAgICAgICB0b2tlbi5mbiA9IHRva2VuLmpzb24gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCBjc3ApOwogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnLicsCiAgICAgICAgICAgICAgICAgICAganNvbjogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZFN0cmluZyhxdW90ZSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiOwogICAgICAgICAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICAgICAgICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ3UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZXggPSB0ZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGluZGV4ICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09IHF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dFcnJvcigiVW50ZXJtaW5hdGVkIHF1b3RlIiwgc3RhcnQpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gcGFyc2VyKHRleHQsIGpzb24sICRmaWx0ZXIsIGNzcCkgewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHRyYSBsZXZlbCBvZiBhbGlhc2luZyBpcyBoZXJlLCBqdXN0IGluIGNhc2UgdGhlIGxleGVyIG1pc3NlcyBzb21ldGhpbmcsIHNvIHRoYXQKICAgICAgICAgICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgICAgICAgICAgYXNzaWdubWVudCA9IGxvZ2ljYWxPUjsKICAgICAgICAgICAgZnVuY3Rpb25DYWxsID0KICAgICAgICAgICAgICAgIGZpZWxkQWNjZXNzID0KICAgICAgICAgICAgICAgICAgICBvYmplY3RJbmRleCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckNoYWluID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHt0ZXh0OiB0ZXh0LCBpbmRleDogMH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFsdWUgPSBwcmltYXJ5KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnRzKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93RXJyb3IoImlzIGFuIHVuZXhwZWN0ZWQgdG9rZW4iLCB0b2tlbnNbMF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihtc2csIHRva2VuKSB7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJTeW50YXggRXJyb3I6IFRva2VuICciICsgdG9rZW4udGV4dCArCiAgICAgICAgICAgICAgICAiJyAiICsgbXNnICsgIiBhdCBjb2x1bW4gIiArCiAgICAgICAgICAgICAgICAodG9rZW4uaW5kZXggKyAxKSArICIgb2YgdGhlIGV4cHJlc3Npb24gWyIgKwogICAgICAgICAgICAgICAgdGV4dCArICJdIHN0YXJ0aW5nIGF0IFsiICsgdGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246ICIgKyB0ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1swXTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBlZWsoZTEsIGUyLCBlMywgZTQpIHsKICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnNbMF07CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgICAgICAgICAgICBpZiAodCA9PSBlMSB8fCB0ID09IGUyIHx8IHQgPT0gZTMgfHwgdCA9PSBlNCB8fAogICAgICAgICAgICAgICAgICAgICghZTEgJiYgIWUyICYmICFlMyAmJiAhZTQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cGVjdChlMSwgZTIsIGUzLCBlNCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBwZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgICAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgICAgICBpZiAoanNvbiAmJiAhdG9rZW4uanNvbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdG9rZW5zLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3VtZShlMSkgewogICAgICAgICAgICBpZiAoIWV4cGVjdChlMSkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbIiArIGUxICsgIl0iLCBwZWVrKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeUZuKGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluYXJ5Rm4obGVmdCwgZm4sIHJpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGF0ZW1lbnRzKCkgewogICAgICAgICAgICB2YXIgc3RhdGVtZW50cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWx0ZXIoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICAgICAgICB2YXIgZm4gPSAkZmlsdGVyKHRva2VuLnRleHQpOwogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwcmVzc2lvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9hc3NpZ25tZW50KCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGxvZ2ljYWxPUigpOwogICAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPScpKSkgewogICAgICAgICAgICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImltcGxpZXMgYXNzaWdubWVudCBidXQgWyIgKwogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnN1YnN0cmluZygwLCB0b2tlbi5pbmRleCkgKyAiXSBjYW4gbm90IGJlIGFzc2lnbmVkIHRvIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmlnaHQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxPUigpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsQU5EKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJ3x8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9naWNhbEFORCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBlcXVhbGl0eSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJyYmJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGxvZ2ljYWxBTkQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBlcXVhbGl0eSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSByZWxhdGlvbmFsKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPT0nLCAnIT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCAnLScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBtdWx0aXBsaWNhdGl2ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG11bHRpcGxpY2F0aXZlKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHVuYXJ5KCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKCh0b2tlbiA9IGV4cGVjdCgnKicsICcvJywgJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgICAgICAgIHdoaWxlICgobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSU1QT1NTSUJMRSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpZWxkQWNjZXNzKG9iamVjdCkgewogICAgICAgICAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIGNzcCk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2NvcGUsIGxvY2Fscywgc2VsZikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9vYmplY3RJbmRleChvYmopIHsKICAgICAgICAgICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCgKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICB2LCBwOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgdiA9IG9baV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHYgJiYgdi50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSB2OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgnJCR2JyBpbiB2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmooc2VsZiwgbG9jYWxzKVtpbmRleEZuKHNlbGYsIGxvY2FscyldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKICAgICAgICAgICAgICAgIC8vIElFIHN0dXBpZGl0eSEKICAgICAgICAgICAgICAgIHJldHVybiBmblB0ci5hcHBseQogICAgICAgICAgICAgICAgICAgID8gZm5QdHIuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgICAgICAgICAgICA6IGZuUHRyKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogICAgICAgIGZ1bmN0aW9uIGFycmF5RGVjbGFyYXRpb24oKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICddJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChleHByZXNzaW9uKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50Rm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb2JqZWN0KCkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVzID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICd9JykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3VtZSgnfScpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHNldHRlcihvYmosIHBhdGgsIHNldFZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LnNoaWZ0KCk7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICAgICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgICB9CiAgICAgICAgb2JqW2VsZW1lbnQuc2hpZnQoKV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2VzaWJsZSBmcm9tIHRoZSBvYmplY3QgYnkgcGF0aC4gQW55IHVuZGVmaW5lZCB0cmF2ZXJzYWxzIGFyZSBpZ25vcmVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIHN0YXJ0aW5nIG9iamVjdAogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggcGF0aCB0byB0cmF2ZXJzZQogICAgICogQHBhcmFtIHtib29sZWFuPXRydWV9IGJpbmRGblRvU2NvcGUKICAgICAqIEByZXR1cm5zIHZhbHVlIGFzIGFjY2VzYmlsZSBieSBwYXRoCiAgICAgKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICB2YXIgZ2V0dGVyRm5DYWNoZSA9IHt9OwoKICAgIC8qKgogICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlICJCbGFjayBIb2xlIiB2YXJpYW50IGZyb206CiAgICAgKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9wYXRoLWV2YWx1YXRpb24tc2ltcGxpZmllZC83CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgaWYgKHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkxIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkzIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXk0IHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3ApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbigKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXQogICAgICAgICAgICAgICAgICAgICkoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB2YWw7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjb2RlID0gJ3ZhciBsLCBmbiwgcDtcbic7CiAgICAgICAgICAgIGZvckVhY2gocGF0aEtleXMsIGZ1bmN0aW9uIChrZXksIGluZGV4KSB7CiAgICAgICAgICAgICAgICBjb2RlICs9ICdpZihzID09PSBudWxsIHx8IHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgICAgICAgICAnbD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ3M9JyArIChpbmRleAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHA9cztcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXSA9IGZuOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHBhcnNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgICAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAgICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICAgKgogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHRpcGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqCiAgICAgKiAgICBUaGUgcmV0dXJuIGZ1bmN0aW9uIGFsc28gaGFzIGFuIGBhc3NpZ25gIHByb3BlcnR5LCBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB3aGljaAogICAgICogICAgYWxsb3dzIG9uZSB0byBzZXQgdmFsdWVzIHRvIGV4cHJlc3Npb25zLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNhY2hlID0ge307CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckZmlsdGVyJywgJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXhwKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHApIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGUuaGFzT3duUHJvcGVydHkoZXhwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjYWNoZVtleHBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNhY2hlW2V4cF0gPSBwYXJzZXIoZXhwLCBmYWxzZSwgJGZpbHRlciwgJHNuaWZmZXIuY3NwKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHA7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJHEKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogICAgICoKICAgICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgICAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICAgICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAgICoKICAgICAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICAgICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgc2NvcGVgIGFyZQogICAgICogICAvLyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICAgICAqCiAgICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIC8vIHNpbmNlIHRoaXMgZm4gZXhlY3V0ZXMgYXN5bmMgaW4gYSBmdXR1cmUgdHVybiBvZiB0aGUgZXZlbnQgbG9vcCwgd2UgbmVlZCB0byB3cmFwCiAqICAgICAgIC8vIG91ciBjb2RlIGludG8gYW4gJGFwcGx5IGNhbGwgc28gdGhhdCB0aGUgbW9kZWwgY2hhbmdlcyBhcmUgcHJvcGVybHkgb2JzZXJ2ZWQuCiAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0pOwogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAgICAgKgogICAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAgICogY29tZXMgaW4gdGhlIHdheSBvZgogICAgICogW2d1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kKS4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgICAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAgICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIERlZmVycmVkIEFQSQogICAgICoKICAgICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAgICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24gb2YgdGhlIHRhc2suCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAgICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAgICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAgICAgKgogICAgICogKipQcm9wZXJ0aWVzKioKICAgICAqCiAgICAgKiAtIHByb21pc2Ug4oCTIGB7UHJvbWlzZX1gIOKAkyBwcm9taXNlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWZlcnJlZC4KICAgICAqCiAgICAgKgogICAgICogIyBUaGUgUHJvbWlzZSBBUEkKICAgICAqCiAgICAgKiBBIG5ldyBwcm9taXNlIGluc3RhbmNlIGlzIGNyZWF0ZWQgd2hlbiBhIGRlZmVycmVkIGluc3RhbmNlIGlzIGNyZWF0ZWQgYW5kIGNhbiBiZSByZXRyaWV2ZWQgYnkKICAgICAqIGNhbGxpbmcgYGRlZmVycmVkLnByb21pc2VgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBwcm9taXNlIG9iamVjdCBpcyB0byBhbGxvdyBmb3IgaW50ZXJlc3RlZCBwYXJ0aWVzIHRvIGdldCBhY2Nlc3MgdG8gdGhlIHJlc3VsdAogICAgICogb2YgdGhlIGRlZmVycmVkIHRhc2sgd2hlbiBpdCBjb21wbGV0ZXMuCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yIHdpbGwgYmUgcmVzb2x2ZWQKICAgICAqICAgb3IgcmVqZWN0ZWQgY2FsbHMgb25lIG9mIHRoZSBzdWNjZXNzIG9yIGVycm9yIGNhbGxiYWNrcyBhc3luY2hyb25vdXNseSBhcyBzb29uIGFzIHRoZSByZXN1bHQKICAgICAqICAgaXMgYXZhaWxhYmxlLiBUaGUgY2FsbGJhY2tzIGFyZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCB0aGUgcmVzdWx0IG9yIHJlamVjdGlvbiByZWFzb24uCiAgICAgKgogICAgICogICBUaGlzIG1ldGhvZCAqcmV0dXJucyBhIG5ldyBwcm9taXNlKiB3aGljaCBpcyByZXNvbHZlZCBvciByZWplY3RlZCB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICAgICAqICAgYHN1Y2Nlc3NDYWxsYmFja2Agb3IgYGVycm9yQ2FsbGJhY2tgLgogICAgICoKICAgICAqCiAgICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICAgKgogICAgICogQmVjYXVzZSBjYWxsaW5nIGB0aGVuYCBhcGkgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkgcG9zc2libGUKICAgICAqIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlIHdpbGwgYmUKICAgICAqICAgLy8gdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgYXBpcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICogCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICogCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogICAgICAgIH1dOwogICAgfQoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICAgKiAgICAgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiBxRmFjdG9yeShuZXh0VGljaywgZXhjZXB0aW9uSGFuZGxlcikgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBkZWZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50aGVuKGNhbGxiYWNrWzBdLCBjYWxsYmFja1sxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlamVjdChyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgIHByb21pc2U6IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFja10pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgICAgICB9OwoKCiAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudGhlbikgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjcmVqZWN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAgICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICAgICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAgICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgICAgICogYHJlamVjdGAuCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAqICAgICByZXR1cm4gcmVzdWx0OwogICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgKiAgICAgfQogICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICogICB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgICAgICAgKiB0aGUgcHJvbWlzZSBjb21lcyBmcm9tIGEgc291cmNlIHRoYXQgY2FuJ3QgYmUgdHJ1c3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIG9mIHRoZSBwYXNzZWQgdmFsdWUgb3IgcHJvbWlzZQogICAgICAgICAqLwogICAgICAgIHZhciB3aGVuID0gZnVuY3Rpb24gKHZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUocmVmKHZhbHVlKS50aGVuKHdyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2spKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHdyYXBwZWRFcnJiYWNrKHJlYXNvbikpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgIH07CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0Q2FsbGJhY2sodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGRlZmF1bHRFcnJiYWNrKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjYWxsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ29tYmluZXMgbXVsdGlwbGUgcHJvbWlzZXMgaW50byBhIHNpbmdsZSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiBhbGwgb2YgdGhlIGlucHV0CiAgICAgICAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheS48UHJvbWlzZT59IHByb21pc2VzIEFuIGFycmF5IG9mIHByb21pc2VzLgogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkgb2YgdmFsdWVzLAogICAgICAgICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5LiBJZiBhbnkgb2YKICAgICAgICAgKiAgIHRoZSBwcm9taXNlcyBpcyByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLCB0aGlzIHJlc3VsdGluZyBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUKICAgICAgICAgKiAgIHNhbWUgcmVqZWN0aW9uLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFsbChwcm9taXNlcykgewogICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBkZWZlcigpLAogICAgICAgICAgICAgICAgY291bnRlciA9IHByb21pc2VzLmxlbmd0aCwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKCiAgICAgICAgICAgIGlmIChjb3VudGVyKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbiAocHJvbWlzZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IGluIHJlc3VsdHMpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCBpbiByZXN1bHRzKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRlZmVyOiBkZWZlciwKICAgICAgICAgICAgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgIHdoZW46IHdoZW4sCiAgICAgICAgICAgIGFsbDogYWxsCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyByb3V0ZXMuIFNlZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gZm9yIGFuIGV4YW1wbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciByb3V0ZXMgPSB7fTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLnBhdGhgKS4gSWYgYCRsb2NhdGlvbi5wYXRoYAogICAgICAgICAqICAgIGNvbnRhaW5zIHJlZHVuZGFudCB0cmFpbGluZyBzbGFzaCBvciBpcyBtaXNzaW5nIG9uZSwgdGhlIHJvdXRlIHdpbGwgc3RpbGwgbWF0Y2ggYW5kIHRoZQogICAgICAgICAqICAgIGAkbG9jYXRpb24ucGF0aGAgd2lsbCBiZSB1cGRhdGVkIHRvIGFkZCBvciBkcm9wIHRoZSB0cmFpbGluZyBzbGFzaCB0byBleGFjdGx5IG1hdGNoIHRoZQogICAgICAgICAqICAgIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiAgICBgcGF0aGAgY2FuIGNvbnRhaW4gbmFtZWQgZ3JvdXBzIHN0YXJ0aW5nIHdpdGggYSBjb2xvbiAoYDpuYW1lYCkuIEFsbCBjaGFyYWN0ZXJzIHVwIHRvIHRoZQogICAgICAgICAqICAgIG5leHQgc2xhc2ggYXJlIG1hdGNoZWQgYW5kIHN0b3JlZCBpbiBgJHJvdXRlUGFyYW1zYCB1bmRlciB0aGUgZ2l2ZW4gYG5hbWVgIHdoZW4gdGhlIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2hlcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSByb3V0ZSBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAgb24gcm91dGUKICAgICAgICAgKiAgICBtYXRjaC4KICAgICAgICAgKgogICAgICAgICAqICAgIE9iamVjdCBwcm9wZXJ0aWVzOgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgY29udHJvbGxlcmAg4oCTIGB7KHN0cmluZ3xmdW5jdGlvbigpPX1gIOKAkyBDb250cm9sbGVyIGZuIHRoYXQgc2hvdWxkIGJlIGFzc29jaWF0ZWQgd2l0aCBuZXdseQogICAgICAgICAqICAgICAgY3JlYXRlZCBzY29wZSBvciB0aGUgbmFtZSBvZiBhIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyIHJlZ2lzdGVyZWQgY29udHJvbGxlcn0KICAgICAgICAgKiAgICAgIGlmIHBhc3NlZCBhcyBhIHN0cmluZy4KICAgICAgICAgKiAgICAtIGB0ZW1wbGF0ZWAg4oCTIGB7c3RyaW5nPX1gIOKAkyAgaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IG9yCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBuZ0luY2x1ZGV9IGRpcmVjdGl2ZXMuCiAgICAgICAgICogICAgICB0aGlzIHByb3BlcnR5IHRha2VzIHByZWNlZGVuY2Ugb3ZlciBgdGVtcGxhdGVVcmxgLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlVXJsYCDigJMgYHtzdHJpbmc9fWAg4oCTIHBhdGggdG8gYW4gaHRtbCB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9LgogICAgICAgICAqICAgIC0gYHJlc29sdmVgIC0gYHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24+PX1gIC0gQW4gb3B0aW9uYWwgbWFwIG9mIGRlcGVuZGVuY2llcyB3aGljaCBzaG91bGQKICAgICAgICAgKiAgICAgIGJlIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuIElmIGFueSBvZiB0aGVzZSBkZXBlbmRlbmNpZXMgYXJlIHByb21pc2VzLCB0aGV5IHdpbGwgYmUKICAgICAgICAgKiAgICAgIHJlc29sdmVkIGFuZCBjb252ZXJ0ZWQgdG8gYSB2YWx1ZSBiZWZvcmUgdGhlIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkIGFuZCB0aGUKICAgICAgICAgKiAgICAgIGAkcm91dGVDaGFuZ2VTdWNjZXNzYCBldmVudCBpcyBmaXJlZC4gVGhlIG1hcCBvYmplY3QgaXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYGtleWAg4oCTIGB7c3RyaW5nfWA6IGEgbmFtZSBvZiBhIGRlcGVuZGVuY3kgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4KICAgICAgICAgKiAgICAgIC0gYGZhY3RvcnlgIC0gYHtzdHJpbmd8ZnVuY3Rpb259YDogSWYgYHN0cmluZ2AgdGhlbiBpdCBpcyBhbiBhbGlhcyBmb3IgYSBzZXJ2aWNlLgogICAgICAgICAqICAgICAgICBPdGhlcndpc2UgaWYgZnVuY3Rpb24sIHRoZW4gaXQgaXMge0BsaW5rIGFwaS9BVVRPLiRpbmplY3RvciNpbnZva2UgaW5qZWN0ZWR9CiAgICAgICAgICogICAgICAgIGFuZCB0aGUgcmV0dXJuIHZhbHVlIGlzIHRyZWF0ZWQgYXMgdGhlIGRlcGVuZGVuY3kuIElmIHRoZSByZXN1bHQgaXMgYSBwcm9taXNlLCBpdCBpcyByZXNvbHZlZAogICAgICAgICAqICAgICAgICBiZWZvcmUgaXRzIHZhbHVlIGlzIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGByZWRpcmVjdFRvYCDigJMgeyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSDigJMgdmFsdWUgdG8gdXBkYXRlCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gcGF0aCB3aXRoIGFuZCB0cmlnZ2VyIHJvdXRlIHJlZGlyZWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogICAgICBJZiBgcmVkaXJlY3RUb2AgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3QuPHN0cmluZz59YCAtIHJvdXRlIHBhcmFtZXRlcnMgZXh0cmFjdGVkIGZyb20gdGhlIGN1cnJlbnQKICAgICAgICAgKiAgICAgICAgYCRsb2NhdGlvbi5wYXRoKClgIGJ5IGFwcGx5aW5nIHRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlVXJsLgogICAgICAgICAqICAgICAgLSBge3N0cmluZ31gIC0gY3VycmVudCBgJGxvY2F0aW9uLnBhdGgoKWAKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3R9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5zZWFyY2goKWAKICAgICAgICAgKgogICAgICAgICAqICAgICAgVGhlIGN1c3RvbSBgcmVkaXJlY3RUb2AgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgc3RyaW5nIHdoaWNoIHdpbGwgYmUgdXNlZAogICAgICAgICAqICAgICAgdG8gdXBkYXRlIGAkbG9jYXRpb24ucGF0aCgpYCBhbmQgYCRsb2NhdGlvbi5zZWFyY2goKWAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBbcmVsb2FkT25TZWFyY2g9dHJ1ZV1gIC0ge2Jvb2xlYW49fSAtIHJlbG9hZCByb3V0ZSB3aGVuIG9ubHkgJGxvY2F0aW9uLnNlYXJjaCgpCiAgICAgICAgICogICAgY2hhbmdlcy4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgdGhlIG9wdGlvbiBpcyBzZXQgdG8gYGZhbHNlYCBhbmQgdXJsIGluIHRoZSBicm93c2VyIGNoYW5nZXMsIHRoZW4KICAgICAgICAgKiAgICAgIGAkcm91dGVVcGRhdGVgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoZSByb290IHNjb3BlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIG5ldyByb3V0ZSBkZWZpbml0aW9uIHRvIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMud2hlbiA9IGZ1bmN0aW9uIChwYXRoLCByb3V0ZSkgewogICAgICAgICAgICByb3V0ZXNbcGF0aF0gPSBleHRlbmQoe3JlbG9hZE9uU2VhcmNoOiB0cnVlfSwgcm91dGUpOwoKICAgICAgICAgICAgLy8gY3JlYXRlIHJlZGlyZWN0aW9uIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICAgICAgICAgIGlmIChwYXRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVkaXJlY3RQYXRoID0gKHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PSAnLycpCiAgICAgICAgICAgICAgICAgICAgPyBwYXRoLnN1YnN0cigwLCBwYXRoLmxlbmd0aCAtIDEpCiAgICAgICAgICAgICAgICAgICAgOiBwYXRoICsgJy8nOwoKICAgICAgICAgICAgICAgIHJvdXRlc1tyZWRpcmVjdFBhdGhdID0ge3JlZGlyZWN0VG86IHBhdGh9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlUHJvdmlkZXIjb3RoZXJ3aXNlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHJvdXRlIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgb24gcm91dGUgY2hhbmdlIHdoZW4gbm8gb3RoZXIgcm91dGUgZGVmaW5pdGlvbgogICAgICAgICAqIGlzIG1hdGNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YC4KICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBzZWxmCiAgICAgICAgICovCiAgICAgICAgdGhpcy5vdGhlcndpc2UgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMud2hlbihudWxsLCBwYXJhbXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRsb2NhdGlvbicsICckcm91dGVQYXJhbXMnLCAnJHEnLCAnJGluamVjdG9yJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRsb2NhdGlvbiwgJHJvdXRlUGFyYW1zLCAkcSwgJGluamVjdG9yLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjdXJyZW50IFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogVGhlIHJvdXRlIGRlZmluaXRpb24gY29udGFpbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtIGBjb250cm9sbGVyYDogVGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgYXMgZGVmaW5lIGluIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gYGxvY2Fsc2A6IEEgbWFwIG9mIGxvY2FscyB3aGljaCBpcyB1c2VkIGJ5IHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlcn0gc2VydmljZSBmb3IKICAgICAgICAgICAgICAgICAqICAgICBjb250cm9sbGVyIGluc3RhbnRpYXRpb24uIFRoZSBgbG9jYWxzYCBjb250YWluCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgYHJlc29sdmVgIG1hcC4gQWRkaXRpb25hbGx5IHRoZSBgbG9jYWxzYCBhbHNvIGNvbnRhaW46CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgIC0gYCRzY29wZWAgLSBUaGUgY3VycmVudCByb3V0ZSBzY29wZS4KICAgICAgICAgICAgICAgICAqICAgICAtIGAkdGVtcGxhdGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSByb3V0ZXMgQXJyYXkgb2YgYWxsIGNvbmZpZ3VyZWQgcm91dGVzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogSXMgdXNlZCBmb3IgZGVlcC1saW5raW5nIFVSTHMgdG8gY29udHJvbGxlcnMgYW5kIHZpZXdzIChIVE1MIHBhcnRpYWxzKS4KICAgICAgICAgICAgICAgICAqIEl0IHdhdGNoZXMgYCRsb2NhdGlvbi51cmwoKWAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgcGF0aCB0byBhbiBleGlzdGluZyByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFlvdSBjYW4gZGVmaW5lIHJvdXRlcyB0aHJvdWdoIHtAbGluayBuZy4kcm91dGVQcm92aWRlciAkcm91dGVQcm92aWRlcn0ncyBBUEkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgaXMgdHlwaWNhbGx5IHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmUgYW5kIHRoZSB7QGxpbmsgbmcuJHJvdXRlUGFyYW1zICRyb3V0ZVBhcmFtc30gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgY2hhbmdpbmcgdGhlIFVSTCBoYXNoIGNhdXNlcyB0aGUgYCRyb3V0ZWAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZQogICAgICAgICAgICAgICAgIFVSTCwgYW5kIHRoZSBgbmdWaWV3YCBwdWxscyBpbiB0aGUgcGFydGlhbC4KCiAgICAgICAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZXhhbXBsZSBpcyB1c2luZyB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBpbmxpbmVkIHRlbXBsYXRlc30KICAgICAgICAgICAgICAgICB0byBnZXQgaXQgd29ya2luZyBvbiBqc2ZpZGRsZSBhcyB3ZWxsLgoKICAgICAgICAgICAgICAgICA8ZXhhbXBsZSBtb2R1bGU9Im5nVmlldyI+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICAgICAgICAgQ2hvb3NlOgogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieS9jaC8xIj5Nb2J5OiBDaDE8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL0dhdHNieSI+R2F0c2J5PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9TY2FybGV0Ij5TY2FybGV0IExldHRlcjwvYT48YnIvPgoKICAgICAgICAgICAgICAgICA8ZGl2IG5nLXZpZXc+PC9kaXY+CiAgICAgICAgICAgICAgICAgPGhyIC8+CgogICAgICAgICAgICAgICAgIDxwcmU+JGxvY2F0aW9uLnBhdGgoKSA9IHt7JGxvY2F0aW9uLnBhdGgoKX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybCA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmx9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQucGFyYW1zID0ge3skcm91dGUuY3VycmVudC5wYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZSA9IHt7JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGVQYXJhbXMgPSB7eyRyb3V0ZVBhcmFtc319PC9wcmU+CiAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJib29rLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImNoYXB0ZXIuaHRtbCI+CiAgICAgICAgICAgICAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICAgICAgICAgICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgICAgICAgICAgICAgIENoYXB0ZXIgSWQ6IHt7cGFyYW1zLmNoYXB0ZXJJZH19CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnLCBbXSwgZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEJvb2tDbnRsLAogICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAvLyBJIHdpbGwgY2F1c2UgYSAxIHNlY29uZCBkZWxheQogICAgICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oJHEsICR0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgdmFyIGRlbGF5ID0gJHEuZGVmZXIoKTsKICAgICAgICAgICAgICAgICAkdGltZW91dChkZWxheS5yZXNvbHZlLCAxMDAwKTsKICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkucHJvbWlzZTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0pOwogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQvY2gvOmNoYXB0ZXJJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICAgfSk7CgogICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE1haW5DbnRsKCRzY29wZSwgJHJvdXRlLCAkcm91dGVQYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlUGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgIHZhciBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQ2hhcHRlciBJZFw6IDEvKTsKCiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgICBzbGVlcCgyKTsgLy8gcHJvbWlzZXMgYXJlIG5vdCBwYXJ0IG9mIHNjZW5hcmlvIHdhaXRpbmcKICAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQm9va0NudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlU3RhcnQKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSByb3V0ZSBjaGFuZ2UuIEF0IHRoaXMgIHBvaW50IHRoZSByb3V0ZSBzZXJ2aWNlcyBzdGFydHMKICAgICAgICAgICAgICAgICAqIHJlc29sdmluZyBhbGwgb2YgdGhlIGRlcGVuZGVuY2llcyBuZWVkZWQgZm9yIHRoZSByb3V0ZSBjaGFuZ2UgdG8gb2NjdXJzLgogICAgICAgICAgICAgICAgICogVHlwaWNhbGx5IHRoaXMgaW52b2x2ZXMgZmV0Y2hpbmcgdGhlIHZpZXcgdGVtcGxhdGUgYXMgd2VsbCBhcyBhbnkgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICAgKiBkZWZpbmVkIGluIGByZXNvbHZlYCByb3V0ZSBwcm9wZXJ0eS4gT25jZSAgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgKiBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgaXMgZmlyZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gbmV4dCBGdXR1cmUgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSBjdXJyZW50IEN1cnJlbnQgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIHJvdXRlIGRlcGVuZGVuY2llcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IGxpc3RlbnMgZm9yIHRoZSBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAqIHRvIGluc3RhbnRpYXRlIHRoZSBjb250cm9sbGVyIGFuZCByZW5kZXIgdGhlIHZpZXcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZXxVbmRlZmluZWR9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLCBvciB1bmRlZmluZWQgaWYgY3VycmVudCBpcyBmaXJzdCByb3V0ZSBlbnRlcmVkLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VFcnJvcgogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIGlmIGFueSBvZiB0aGUgcmVzb2x2ZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcHJldmlvdXMgUHJldmlvdXMgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSByZWplY3Rpb24gUmVqZWN0aW9uIG9mIHRoZSBwcm9taXNlLiBVc3VhbGx5IHRoZSBlcnJvciBvZiB0aGUgZmFpbGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZVVwZGF0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgYHJlbG9hZE9uU2VhcmNoYCBwcm9wZXJ0eSBoYXMgYmVlbiBzZXQgdG8gZmFsc2UsIGFuZCB3ZSBhcmUgcmV1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogaW5zdGFuY2Ugb2YgdGhlIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgZm9yY2VSZWxvYWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAkcm91dGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlczogcm91dGVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlI3JlbG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBDYXVzZXMgYCRyb3V0ZWAgc2VydmljZSB0byByZWxvYWQgdGhlIGN1cnJlbnQgcm91dGUgZXZlbiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gaGFzbid0IGNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEFzIGEgcmVzdWx0IG9mIHRoYXQsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30KICAgICAgICAgICAgICAgICAgICAgICAgICogY3JlYXRlcyBuZXcgc2NvcGUsIHJlaW5zdGFudGlhdGVzIHRoZSBjb250cm9sbGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmModXBkYXRlUm91dGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZVJvdXRlKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvdXRlOwoKICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gb24ge3N0cmluZ30gY3VycmVudCB1cmwKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB3aGVuIHtzdHJpbmd9IHJvdXRlIHdoZW4gdGVtcGxhdGUgdG8gbWF0Y2ggdGhlIHVybCBhZ2FpbnN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHs/T2JqZWN0fQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzd2l0Y2hSb3V0ZU1hdGNoZXIob24sIHdoZW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiB0aGlzIGNvZGUgaXMgY29udm9sdXRlZCBhbmQgaW5lZmZpY2llbnQsIHdlIHNob3VsZCBjb25zdHJ1Y3QgdGhlIHJvdXRlIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gICByZWdleCBvbmx5IG9uY2UgYW5kIHRoZW4gcmV1c2UgaXQKCiAgICAgICAgICAgICAgICAgICAgLy8gRXNjYXBlIHJlZ2V4cCBzcGVjaWFsIGNoYXJhY3RlcnMuCiAgICAgICAgICAgICAgICAgICAgd2hlbiA9ICdeJyArIHdoZW4ucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICJcXCQmIikgKyAnJCc7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ2V4ID0gJycsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBkc3QgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlID0gLzooXHcrKS9nLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbU1hdGNoLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChwYXJhbU1hdGNoID0gcmUuZXhlYyh3aGVuKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBlYWNoIDpwYXJhbSBpbiBgd2hlbmAgYW5kIHJlcGxhY2UgaXQgd2l0aCBhIGNhcHR1cmluZyBncm91cC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIGFsbCBvdGhlciBzZWN0aW9ucyBvZiB3aGVuIHVuY2hhbmdlZC4KICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gd2hlbi5zbGljZShsYXN0TWF0Y2hlZEluZGV4LCBwYXJhbU1hdGNoLmluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gJyhbXlxcL10qKSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtTWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gcmUubGFzdEluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgdHJhaWxpbmcgcGF0aCBwYXJ0LgogICAgICAgICAgICAgICAgICAgIHJlZ2V4ICs9IHdoZW4uc3Vic3RyKGxhc3RNYXRjaGVkSW5kZXgpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBvbi5tYXRjaChuZXcgUmVnRXhwKHJlZ2V4KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAobmFtZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFtuYW1lXSA9IG1hdGNoW2luZGV4ICsgMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBkc3QgOiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gcGFyc2VSb3V0ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gJHJvdXRlLmN1cnJlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIGxhc3QgJiYgbmV4dC4kJHJvdXRlID09PSBsYXN0LiQkcm91dGUKICAgICAgICAgICAgICAgICAgICAgICAgJiYgZXF1YWxzKG5leHQucGF0aFBhcmFtcywgbGFzdC5wYXRoUGFyYW1zKSAmJiAhbmV4dC5yZWxvYWRPblNlYXJjaCAmJiAhZm9yY2VSZWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdC5wYXJhbXMgPSBuZXh0LnBhcmFtczsKICAgICAgICAgICAgICAgICAgICAgICAgY29weShsYXN0LnBhcmFtcywgJHJvdXRlUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVVcGRhdGUnLCBsYXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQgfHwgbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN0YXJ0JywgbmV4dCwgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb3V0ZS5jdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0LnJlZGlyZWN0VG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobmV4dC5yZWRpcmVjdFRvKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChpbnRlcnBvbGF0ZShuZXh0LnJlZGlyZWN0VG8sIG5leHQucGFyYW1zKSkuc2VhcmNoKG5leHQucGFyYW1zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24udXJsKG5leHQucmVkaXJlY3RUbyhuZXh0LnBhdGhQYXJhbXMsICRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJHEud2hlbihuZXh0KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXh0LnJlc29sdmUgfHwge30sIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGlzU3RyaW5nKHZhbHVlKSA/ICRpbmplY3Rvci5nZXQodmFsdWUpIDogJGluamVjdG9yLmludm9rZSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSA9IG5leHQudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlID0gbmV4dC50ZW1wbGF0ZVVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gJGh0dHAuZ2V0KHRlbXBsYXRlLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaCgnJHRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxLmFsbCh2YWx1ZXMpLnRoZW4oZnVuY3Rpb24gKHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNba2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZ0ZXIgcm91dGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5sb2NhbHMgPSBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3B5KG5leHQucGFyYW1zLCAkcm91dGVQYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3VjY2VzcycsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICRyb3V0ZS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlRXJyb3InLCBuZXh0LCBsYXN0LCBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHRoZSBjdXJyZW50IGFjdGl2ZSByb3V0ZSwgYnkgbWF0Y2hpbmcgaXQgYWdhaW5zdCB0aGUgVVJMCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlUm91dGUoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWF0Y2ggYSByb3V0ZQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbXMsIG1hdGNoOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2gocm91dGVzLCBmdW5jdGlvbiAocm91dGUsIHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCAmJiAocGFyYW1zID0gc3dpdGNoUm91dGVNYXRjaGVyKCRsb2NhdGlvbi5wYXRoKCksIHBhdGgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBleHRlbmQoe30sICRsb2NhdGlvbi5zZWFyY2goKSwgcGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUGFyYW1zOiBwYXJhbXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLiQkcm91dGUgPSByb3V0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIE5vIHJvdXRlIG1hdGNoZWQ7IGZhbGxiYWNrIHRvICJvdGhlcndpc2UiIHJvdXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoIHx8IHJvdXRlc1tudWxsXSAmJiBpbmhlcml0KHJvdXRlc1tudWxsXSwge3BhcmFtczoge30sIHBhdGhQYXJhbXM6IHt9fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBpbnRlcnBvbGF0aW9uIG9mIHRoZSByZWRpcmVjdCBwYXRoIHdpdGggdGhlIHBhcmFtZXRycwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbnRlcnBvbGF0ZShzdHJpbmcsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKChzdHJpbmcgfHwgJycpLnNwbGl0KCc6JyksIGZ1bmN0aW9uIChzZWdtZW50LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlZ21lbnRNYXRjaCA9IHNlZ21lbnQubWF0Y2goLyhcdyspKC4qKS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHNlZ21lbnRNYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBhcmFtc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnRNYXRjaFsyXSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVBhcmFtcwogICAgICogQHJlcXVpcmVzICRyb3V0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3VycmVudCBzZXQgb2Ygcm91dGUgcGFyYW1ldGVycy4gVGhlIHJvdXRlIHBhcmFtZXRlcnMgYXJlIGEgY29tYmluYXRpb24gb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gYHNlYXJjaCgpYCwgYW5kIGBwYXRoKClgLiBUaGUgYHBhdGhgIHBhcmFtZXRlcnMKICAgICAqIGFyZSBleHRyYWN0ZWQgd2hlbiB0aGUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IHBhdGggaXMgbWF0Y2hlZC4KICAgICAqCiAgICAgKiBJbiBjYXNlIG9mIHBhcmFtZXRlciBuYW1lIGNvbGxpc2lvbiwgYHBhdGhgIHBhcmFtcyB0YWtlIHByZWNlZGVuY2Ugb3ZlciBgc2VhcmNoYCBwYXJhbXMuCiAgICAgKgogICAgICogVGhlIHNlcnZpY2UgZ3VhcmFudGVlcyB0aGF0IHRoZSBpZGVudGl0eSBvZiB0aGUgYCRyb3V0ZVBhcmFtc2Agb2JqZWN0IHdpbGwgcmVtYWluIHVuY2hhbmdlZAogICAgICogKGJ1dCBpdHMgcHJvcGVydGllcyB3aWxsIGxpa2VseSBjaGFuZ2UpIGV2ZW4gd2hlbiBhIHJvdXRlIGNoYW5nZSBvY2N1cnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAgLy8gR2l2ZW46CiAgICAgKiAgLy8gVVJMOiBodHRwOi8vc2VydmVyLmNvbS9pbmRleC5odG1sIy9DaGFwdGVyLzEvU2VjdGlvbi8yP3NlYXJjaD1tb2J5CiAgICAgKiAgLy8gUm91dGU6IC9DaGFwdGVyLzpjaGFwdGVySWQvU2VjdGlvbi86c2VjdGlvbklkCiAgICAgKiAgLy8KICAgICAqICAvLyBUaGVuCiAgICAgKiAgJHJvdXRlUGFyYW1zID09PiB7Y2hhcHRlcklkOjEsIHNlY3Rpb25JZDoyLCBzZWFyY2g6J21vYnknfQogICAgICogPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVBhcmFtc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4oe30pOwogICAgfQoKICAgIC8qKgogICAgICogREVTSUdOIE5PVEVTCiAgICAgKgogICAgICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogICAgICoKICAgICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICAgKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAgICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogICAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAgICoKICAgICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgICAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAoc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgICAqCiAgICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICAgKgogICAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICAgKiBhcmUgZXhwZW5zaXZlIHRvIGNvbnN0cnVjdC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICAgKiBhc3N1bWluZyB0aGF0IHRoZSBtb2RlbCBpcyB1bnN0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBjaGlsZCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGFuZCBwcm92aWRlCiAgICAgKiBldmVudCBwcm9jZXNzaW5nIGxpZmUtY3ljbGUuIFNlZSB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgVFRMID0gMTA7CgogICAgICAgIHRoaXMuZGlnZXN0VHRsID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBUVEwgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gVFRMOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRwYXJzZScsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyLCAkcGFyc2UpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQSByb290IHNjb3BlIGNhbiBiZSByZXRyaWV2ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlICRyb290U2NvcGV9IGtleSBmcm9tIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRuZXcgJG5ldygpfSBtZXRob2QuIChNb3N0IHNjb3BlcyBhcmUgY3JlYXRlZCBhdXRvbWF0aWNhbGx5IHdoZW4KICAgICAgICAgICAgICAgICAqIGNvbXBpbGVkIEhUTUwgdGVtcGxhdGUgaXMgZXhlY3V0ZWQuKQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgc2NvcGUgc25pcHBldCB0byBzaG93IGhvdyB5b3UgY2FuIGludGVyYWN0IHdpdGggdGhlIHNjb3BlLgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSkuaW52b2tlKGZ1bmN0aW9uKCRyb290U2NvcGUpIHsKICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcoKTsKICAgICAgICAgICBzY29wZS5zYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ1dvcmxkJzsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CgogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgc2NvcGUuZ3JlZXRpbmcgPSBzY29wZS5zYWx1dGF0aW9uICsgJyAnICsgc2NvcGUubmFtZSArICchJzsKICAgICAgICAgICB9KTsgLy8gaW5pdGlhbGl6ZSB0aGUgd2F0Y2gKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdNaXNrbyc7CiAgICAgICAgICAgLy8gc3RpbGwgb2xkIHZhbHVlLCBzaW5jZSB3YXRjaGVzIGhhdmUgbm90IGJlZW4gY2FsbGVkIHlldAogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCh1bmRlZmluZWQpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7IC8vIGZpcmUgYWxsICB0aGUgd2F0Y2hlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCgnSGVsbG8gTWlza28hJyk7CiAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgICAgICAgICAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgICAgICAgICAgcGFyZW50LnNhbHV0YXRpb24gPSAiSGVsbG8iOwogICAgICAgICAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgICAgICAgICBjaGlsZC5zYWx1dGF0aW9uID0gIldlbGNvbWUiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKCk+PX0gcHJvdmlkZXJzIE1hcCBvZiBzZXJ2aWNlIGZhY3Rvcnkgd2hpY2ggbmVlZCB0byBiZSBwcm92aWRlZAogICAgICAgICAgICAgICAgICogICAgIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsICo+PX0gaW5zdGFuY2VDYWNoZSBQcm92aWRlcyBwcmUtaW5zdGFudGlhdGVkIHNlcnZpY2VzIHdoaWNoIHNob3VsZAogICAgICAgICAgICAgICAgICogICAgIGFwcGVuZC9vdmVycmlkZSBzZXJ2aWNlcyBwcm92aWRlZCBieSBgcHJvdmlkZXJzYC4gVGhpcyBpcyBoYW5keSB3aGVuIHVuaXQtdGVzdGluZyBhbmQgaGF2aW5nCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBOZXdseSBjcmVhdGVkIHNjb3BlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHBoYXNlID0gdGhpcy4kcGFyZW50ID0gdGhpcy4kJHdhdGNoZXJzID0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzWyd0aGlzJ10gPSB0aGlzLiRyb290ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgICAgICAgICAqLwoKCiAgICAgICAgICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24gKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIENoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihpc29sYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmVtb3ZlIGF0IHNvbWUgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdBUEktQ0hBTkdFOiBVc2UgJGNvbnRyb2xsZXIgdG8gaW5zdGFudGlhdGUgY29udHJvbGxlcnMuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcm9vdCA9IHRoaXMuJHJvb3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07IC8vIHNob3VsZCBiZSBhbm9ueW1vdXM7IFRoaXMgaXMgc28gdGhhdCB3aGVuIHRoZSBtaW5pZmllciBtdW5nZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBuYW1lIGl0IGRvZXMgbm90IGJlY29tZSByYW5kb20gc2V0IG9mIGNoYXJzLiBUaGVzZSB3aWxsIHRoZW4gc2hvdyB1cCBhcyBjbGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmFtZSBpbiB0aGUgZGVidWdnZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZC5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgQ2hpbGQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFsndGhpcyddID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRwYXJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCR3YXRjaGVycyA9IGNoaWxkLiQkbmV4dFNpYmxpbmcgPSBjaGlsZC4kJGNoaWxkSGVhZCA9IGNoaWxkLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICogICBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB3aGljaCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0KICAgICAgICAgICAgICAgICAgICAgKiAgIHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICAgICAgICAgICAqICAgc2VlIGJlbG93KS4gVGhlIGluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yIGxhdGVyIGNvbXBhcmlzb24sIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gSXQgYWxzbyBtZWFucyB0aGF0IHdhdGNoaW5nIGNvbXBsZXggb3B0aW9ucyB3aWxsCiAgICAgICAgICAgICAgICAgICAgICogICBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4gVGhpcwogICAgICAgICAgICAgICAgICAgICAqICAgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEgY2hhbmdlIGlzCiAgICAgICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAvLyBsZXQncyBhc3N1bWUgdGhhdCBzY29wZSB3YXMgZGVwZW5kZW5jeSBpbmplY3RlZCBhcyB0aGUgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7IHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKX0gd2F0Y2hFeHByZXNzaW9uIEV4cHJlc3Npb24gdGhhdCBpcyBldmFsdWF0ZWQgb24gZWFjaAogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEEgY2hhbmdlIGluIHRoZSByZXR1cm4gdmFsdWUgdHJpZ2dlcnMgYQogICAgICAgICAgICAgICAgICAgICAqICAgIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGBzY29wZWAgYXMgYSBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpPX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSByZXR1cm4gdmFsdWUgb2YKICAgICAgICAgICAgICAgICAgICAgKiAgIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZXMgYXMgcGFyYW1ldGVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9iamVjdEVxdWFsaXR5IENvbXBhcmUgb2JqZWN0IGZvciBlcXVhbGl0eSByYXRoZXIgdGhhbiBmb3IgcmVmZXJlbmNlLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHdhdGNoOiBmdW5jdGlvbiAod2F0Y2hFeHAsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0ID0gY29tcGlsZVRvRm4od2F0Y2hFeHAsICd3YXRjaCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlciA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSB1c2VyIHBhc3Mgc3RyaW5nLCB3ZSBuZWVkIHRvIGNvbXBpbGUgaXQsIGRvIHdlIHJlYWxseSBuZWVkIHRoaXMgPwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuRm4gPSBjb21waWxlVG9GbihsaXN0ZW5lciB8fCBub29wLCAnbGlzdGVuZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIuZm4gPSBmdW5jdGlvbiAobmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHdoaWxlIGxvb3AgcmVhZHMgaW4gcmV2ZXJzZSBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZSB0aGUgbW9kZWwsIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICogZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUgbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93CiAgICAgICAgICAgICAgICAgICAgICogYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFVzdWFsbHkgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAgICAgICAgICAgICAgICogSW5zdGVhZCBhIGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluIGEKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gIHdpdGgge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgICAgICAgICAgICAgICAqIHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFlvdSBtYXkgaGF2ZSBhIG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCBmcm9tIHdpdGhpbiB1bml0LXRlc3RzLCB0byBzaW11bGF0ZSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBsaWZlLWN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2c7CgogICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlID0gY3VycmVudC4kJGFzeW5jUXVldWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LiRldmFsKGFzeW5jUXVldWUuc2hpZnQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgod2F0Y2hlcnMgPSBjdXJyZW50LiQkd2F0Y2hlcnMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2Nlc3Mgb3VyIHdhdGNoZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1vc3QgY29tbW9uIHdhdGNoZXMgYXJlIG9uIHByaW1pdGl2ZXMsIGluIHdoaWNoIGNhc2Ugd2UgY2FuIHNob3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2lyY3VpdCBpdCB3aXRoID09PSBvcGVyYXRvciwgb25seSB3aGVuID09PSBmYWlscyBkbyB3ZSB1c2UgLmVxdWFscwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmICEod2F0Y2guZXEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlcXVhbHModmFsdWUsIGxhc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBpc05hTih2YWx1ZSkgJiYgaXNOYU4obGFzdCkpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmxhc3QgPSB3YXRjaC5lcSA/IGNvcHkodmFsdWUpIDogdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmZuKHZhbHVlLCAoKGxhc3QgPT09IGluaXRXYXRjaFZhbCkgPyB2YWx1ZSA6IGxhc3QpLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCA9IDQgLSB0dGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdhdGNoTG9nW2xvZ0lkeF0pIHdhdGNoTG9nW2xvZ0lkeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZm46ICcgKyAod2F0Y2guZXhwLm5hbWUgfHwgd2F0Y2guZXhwLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB3YXRjaC5leHA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nW2xvZ0lkeF0ucHVzaChsb2dNc2cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fCAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlydHkgJiYgISh0dGwtLSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoVFRMICsgJyAkZGlnZXN0KCkgaXRlcmF0aW9ucyByZWFjaGVkLiBBYm9ydGluZyFcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnV2F0Y2hlcnMgZmlyZWQgaW4gdGhlIGxhc3QgNSBpdGVyYXRpb25zOiAnICsgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUmVtb3ZlcyB0aGUgY3VycmVudCBzY29wZSAoYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4pIGZyb20gdGhlIHBhcmVudCBzY29wZS4gUmVtb3ZhbCBpbXBsaWVzCiAgICAgICAgICAgICAgICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICAgICAgICAgICAgICAgKiBwcm9wYWdhdGUgdG8gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4gUmVtb3ZhbCBhbHNvIGltcGxpZXMgdGhhdCB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICAgICAqIHNjb3BlIGlzIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRkZXN0cm95KClgIGlzIHVzdWFsbHkgdXNlZCBieSBkaXJlY3RpdmVzIHN1Y2ggYXMKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSBmb3IgbWFuYWdpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSnVzdCBiZWZvcmUgYSBzY29wZSBpcyBkZXN0cm95ZWQgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAgICAgICAgICAgICAgICogQXBwbGljYXRpb24gY29kZSBjYW4gcmVnaXN0ZXIgYSBgJGRlc3Ryb3lgIGV2ZW50IGhhbmRsZXIgdGhhdCB3aWxsIGdpdmUgaXQgY2hhbmNlIHRvCiAgICAgICAgICAgICAgICAgICAgICogcGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgZGVzdHJveSB0aGUgcm9vdCBzY29wZSBvciBhIHNjb3BlIHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUgPT0gdGhpcyB8fCB0aGlzLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRicm9hZGNhc3QoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZEhlYWQgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRUYWlsID0gdGhpcy4kJHByZXZTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJHByZXZTaWJsaW5nKSB0aGlzLiQkcHJldlNpYmxpbmcuJCRuZXh0U2libGluZyA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRuZXh0U2libGluZykgdGhpcy4kJG5leHRTaWJsaW5nLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmc7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGJvZ3VzIGNvZGUgdGhhdCB3b3JrcyBhcm91bmQgQ2hyb21lJ3MgR0MgbGVhawogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzEzMTMjaXNzdWVjb21tZW50LTEwMzc4NDUxCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZEhlYWQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgYGV4cHJlc3Npb25gIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybmluZyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbiB0aGUKICAgICAgICAgICAgICAgICAgICAgKiBleHByZXNzaW9uIGFyZSBwcm9wYWdhdGVkICh1bmNhdWdodCkuIFRoaXMgaXMgdXNlZnVsIHdoZW4gZXZhbHVhdGluZyBBbmd1bGFyIGV4cHJlc3Npb25zLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYiA9IDI7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoZnVuY3Rpb24oc2NvcGUpeyByZXR1cm4gc2NvcGUuYSArIHNjb3BlLmI7IH0pKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbDogZnVuY3Rpb24gKGV4cHIsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIG9uIHRoZSBjdXJyZW50IHNjb3BlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBgJGV2YWxBc3luY2AgbWFrZXMgbm8gZ3VhcmFudGVlcyBhcyB0byB3aGVuIHRoZSBgZXhwcmVzc2lvbmAgd2lsbCBiZSBleGVjdXRlZCwgb25seSB0aGF0OgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGl0IHdpbGwgZXhlY3V0ZSBpbiB0aGUgY3VycmVudCBzY3JpcHQgZXhlY3V0aW9uIGNvbnRleHQgKGJlZm9yZSBhbnkgRE9NIHJlbmRlcmluZykuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyCiAgICAgICAgICAgICAgICAgICAgICogICAgIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKGV4cHIpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIgZnJhbWV3b3JrLgogICAgICAgICAgICAgICAgICAgICAqIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUtY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKiBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKiAyLiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAqICAgIHdhcyBleGVjdXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRldmFsKGV4cHIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIExpc3RlbnMgb24gZXZlbnRzIG9mIGEgZ2l2ZW4gdHlwZS4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRlbWl0ICRlbWl0fSBmb3IgZGlzY3Vzc2lvbiBvZgogICAgICAgICAgICAgICAgICAgICAqIGV2ZW50IGxpZmUgY3ljbGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZm9ybWF0IGlzOiBgZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pYC4gVGhlIGBldmVudGAgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICogcGFzc2VkIGludG8gdGhlIGxpc3RlbmVyIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHRhcmdldFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIG9uIHdoaWNoIHRoZSBldmVudCB3YXMgYCRlbWl0YC1lZCBvciBgJGJyb2FkY2FzdGAtZWQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgY3VycmVudCBzY29wZSB3aGljaCBpcyBoYW5kbGluZyB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBuYW1lYCAtIGB7c3RyaW5nfWA6IE5hbWUgb2YgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgc3RvcFByb3BhZ2F0aW9uYCAtIGB7ZnVuY3Rpb249fWA6IGNhbGxpbmcgYHN0b3BQcm9wYWdhdGlvbmAgZnVuY3Rpb24gd2lsbCBjYW5jZWwgZnVydGhlciBldmVudAogICAgICAgICAgICAgICAgICAgICAqICAgICBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBwcmV2ZW50RGVmYXVsdGAgLSBge2Z1bmN0aW9ufWA6IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0YCBzZXRzIGBkZWZhdWx0UHJldmVudGVkYCBmbGFnIHRvIHRydWUuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gbGlzdGVuIG9uLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkb246IGZ1bmN0aW9uIChuYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZWRMaXN0ZW5lcnMgPSB0aGlzLiQkbGlzdGVuZXJzW25hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZAogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzIGNhbmNlbHMgaXQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRlbWl0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW1wdHkgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG5hbWVkTGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhdmVyc2UgdXB3YXJkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBzY29wZS4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCBkb3dud2FyZHMgdG8gYWxsIGNoaWxkIHNjb3BlcyAoYW5kIHRoZWlyIGNoaWxkcmVuKSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRicm9hZGNhc3RgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0IG5vdGlmaWVkLgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyd2FyZHMsIHRoZSBldmVudCBwcm9wYWdhdGVzIHRvIGFsbCBkaXJlY3QgYW5kIGluZGlyZWN0IHNjb3BlcyBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiBjYWxscyBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IGNhbm5vdCBiZSBjYW5jZWxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFueSBleGNlcHRpb24gZW1taXRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgICAgICAgICAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gYnJvYWRjYXN0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYnJvYWRjYXN0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyICRyb290U2NvcGUgPSBuZXcgU2NvcGUoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJHJvb3RTY29wZS4kJHBoYXNlICsgJyBhbHJlYWR5IGluIHByb2dyZXNzJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICAgICAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogISEhIFRoaXMgaXMgYW4gdW5kb2N1bWVudGVkICJwcml2YXRlIiBzZXJ2aWNlICEhIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGlzdG9yeSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaHRtbDUgaGlzdG9yeSBhcGkgPwogICAgICogQHByb3BlcnR5IHtib29sZWFufSBoYXNoY2hhbmdlIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBoYXNoY2hhbmdlIGV2ZW50ID8KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoaXMgaXMgdmVyeSBzaW1wbGUgaW1wbGVtZW50YXRpb24gb2YgdGVzdGluZyBicm93c2VyJ3MgZmVhdHVyZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRTbmlmZmVyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgICAgICAgICAgYW5kcm9pZCA9IGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpKSwKICAgICAgICAgICAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAoISR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8ICR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNyksCiAgICAgICAgICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSUU5IGltcGxlbWVudHMgJ2lucHV0JyBldmVudCBpdCdzIHNvIGZ1YmFyZWQgdGhhdCB3ZSByYXRoZXIgcHJldGVuZCB0aGF0IGl0IGRvZXNuJ3QgaGF2ZQogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBJbiBwYXJ0aWN1bGFyIHRoZSBldmVudCBpcyBub3QgZmlyZWQgd2hlbiBiYWNrc3BhY2Ugb3IgZGVsZXRlIGtleSBhcmUgcHJlc3NlZCBvcgogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gY3V0IG9wZXJhdGlvbiBpcyBwZXJmb3JtZWQuCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50ID09ICdpbnB1dCcgJiYgbXNpZSA9PSA5KSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudFN1cHBvcnRbZXZlbnRdKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGl2RWxtID0gJHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTdXBwb3J0W2V2ZW50XSA9ICdvbicgKyBldmVudCBpbiBkaXZFbG07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnRTdXBwb3J0W2V2ZW50XTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiBjdXJyZW50bHkgdGhlcmUgaXMgbm8gd2F5IHRvIGZlYXR1cmUgZGV0ZWN0IENTUCB3aXRob3V0IHRyaWdnZXJpbmcgYWxlcnRzCiAgICAgICAgICAgICAgICBjc3A6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICAgICAqIGlzIGdsb2JhbGx5IGF2YWlsYWJsZSBpbiBKYXZhU2NyaXB0LCBpdCBjYXVzZXMgdGVzdGFiaWxpdHkgcHJvYmxlbXMsIGJlY2F1c2UKICAgICAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogICAgICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogICAgICoKICAgICAqIEFsbCBleHByZXNzaW9ucyBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byBjdXJyZW50IHNjb3BlIHNvIHRoZXkgZG9uJ3QKICAgICAqIHN1ZmZlciBmcm9tIHdpbmRvdyBnbG9iYWxpdHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICRzY29wZS4kd2luZG93ID0gJHdpbmRvdzsKICAgICAgICAgICAkc2NvcGUuZ3JlZXRpbmcgPSAnSGVsbG8sIFdvcmxkISc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJHdpbmRvdy5hbGVydChncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBkaXNwbGF5IHRoZSBncmVldGluZyBpbiB0aGUgaW5wdXQgYm94JywgZnVuY3Rpb24oKSB7CiAgICAgICBpbnB1dCgnZ3JlZXRpbmcnKS5lbnRlcignSGVsbG8sIEUyRSBUZXN0cycpOwogICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgLy8gZWxlbWVudCgnOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHdpbmRvdyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQYXJzZSBoZWFkZXJzIGludG8ga2V5IHZhbHVlIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBQYXJzZWQgaGVhZGVycyBhcyBrZXkgdmFsdWUgb2JqZWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgICAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgICAgICAgaWYgKCFoZWFkZXJzKSByZXR1cm4gcGFyc2VkOwoKICAgICAgICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAgICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAgICAgKgogICAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICAgKiBAc2VlIHBhcnNlSGVhZGVycwogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAgICAgKgogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICAgKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFoZWFkZXJzT2JqKSBoZWFkZXJzT2JqID0gcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9ufEFycmF5LjxmdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogICAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBkYXRhID0gZm4oZGF0YSwgaGVhZGVycyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkYXRhOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgICAgICAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwogICAgfQoKCiAgICBmdW5jdGlvbiAkSHR0cFByb3ZpZGVyKCkgewogICAgICAgIHZhciBKU09OX1NUQVJUID0gL15ccyooXFt8XHtbXlx7XSkvLAogICAgICAgICAgICBKU09OX0VORCA9IC9bXH1cXV1ccyokLywKICAgICAgICAgICAgUFJPVEVDVElPTl9QUkVGSVggPSAvXlwpXF1cfScsP1xuLzsKCiAgICAgICAgdmFyICRjb25maWcgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gaW5jb21pbmcgcmVzcG9uc2UgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogW2Z1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKEpTT05fU1RBUlQudGVzdChkYXRhKSAmJiBKU09OX0VORC50ZXN0KGRhdGEpKQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gZnJvbUpzb24oZGF0YSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IFtmdW5jdGlvbiAoZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBjb21tb246IHsKICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicsCiAgICAgICAgICAgICAgICAgICAgJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J30sCiAgICAgICAgICAgICAgICBwdXQ6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgcHJvdmlkZXJSZXNwb25zZUludGVyY2VwdG9ycyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyksCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uIChpbnRlcmNlcHRvcikgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSW50ZXJjZXB0b3JzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGlzU3RyaW5nKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGh0dHBCYWNrZW5kCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkY2FjaGVGYWN0b3J5CiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRxCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgY29yZSBBbmd1bGFyIHNlcnZpY2UgdGhhdCBmYWNpbGl0YXRlcyBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZQogICAgICAgICAgICAgICAgICogSFRUUCBzZXJ2ZXJzIHZpYSB0aGUgYnJvd3NlcidzIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3R9IG9iamVjdCBvciB2aWEge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciB1bml0IHRlc3RpbmcgYXBwbGljYXRpb25zIHRoYXQgdXNlIGAkaHR0cGAgc2VydmljZSwgc2VlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCAkaHR0cEJhY2tlbmQgbW9ja30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGEgaGlnaGVyIGxldmVsIG9mIGFic3RyYWN0aW9uLCBwbGVhc2UgY2hlY2sgb3V0IHRoZSB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UKICAgICAgICAgICAgICAgICAqICRyZXNvdXJjZX0gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgQVBJIGlzIGJhc2VkIG9uIHRoZSB7QGxpbmsgbmcuJHEgZGVmZXJyZWQvcHJvbWlzZSBBUElzfSBleHBvc2VkIGJ5CiAgICAgICAgICAgICAgICAgKiB0aGUgJHEgc2VydmljZS4gV2hpbGUgZm9yIHNpbXBsZSB1c2FnZSBwYXR0ZXJucyB0aGlzIGRvZXNuJ3QgbWF0dGVyIG11Y2gsIGZvciBhZHZhbmNlZCB1c2FnZQogICAgICAgICAgICAgICAgICogaXQgaXMgaW1wb3J0YW50IHRvIGZhbWlsaWFyaXplIHlvdXJzZWxmIHdpdGggdGhlc2UgQVBJcyBhbmQgdGhlIGd1YXJhbnRlZXMgdGhleSBwcm92aWRlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEdlbmVyYWwgdXNhZ2UKICAgICAgICAgICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAgICAgICAgICAgICAqIHRoYXQgaXMgdXNlZCB0byBnZW5lcmF0ZSBhbiBIVFRQIHJlcXVlc3QgYW5kIHJldHVybnMgIGEge0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgICAgICAgICAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAoe21ldGhvZDogJ0dFVCcsIHVybDogJy9zb21lVXJsJ30pLgogICAgICAgICAgICAgICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICAgICAgICAgICAgICogICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyBjYWxsZWQgYXN5bmNocm9ub3VzbHkgaWYgYW4gZXJyb3Igb2NjdXJzCiAgICAgKiAgICAgICAvLyBvciBzZXJ2ZXIgcmV0dXJucyByZXNwb25zZSB3aXRoIGFuIGVycm9yIHN0YXR1cy4KICAgICAqICAgICB9KTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIHRoZSByZXR1cm5lZCB2YWx1ZSBvZiBjYWxsaW5nIHRoZSAkaHR0cCBmdW5jdGlvbiBpcyBhIGBwcm9taXNlYCwgeW91IGNhbiBhbHNvIHVzZQogICAgICAgICAgICAgICAgICogdGhlIGB0aGVuYCBtZXRob2QgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzLCBhbmQgdGhlc2UgY2FsbGJhY2tzIHdpbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCDigJMKICAgICAgICAgICAgICAgICAqIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3BvbnNlLiBTZWUgdGhlIEFQSSBzaWduYXR1cmUgYW5kIHR5cGUgaW5mbyBiZWxvdyBmb3IgbW9yZQogICAgICAgICAgICAgICAgICogZGV0YWlscy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBIHJlc3BvbnNlIHN0YXR1cyBjb2RlIGJldHdlZW4gMjAwIGFuZCAyOTkgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3Mgc3RhdHVzIGFuZAogICAgICAgICAgICAgICAgICogd2lsbCByZXN1bHQgaW4gdGhlIHN1Y2Nlc3MgY2FsbGJhY2sgYmVpbmcgY2FsbGVkLiBOb3RlIHRoYXQgaWYgdGhlIHJlc3BvbnNlIGlzIGEgcmVkaXJlY3QsCiAgICAgICAgICAgICAgICAgKiBYTUxIdHRwUmVxdWVzdCB3aWxsIHRyYW5zcGFyZW50bHkgZm9sbG93IGl0LCBtZWFuaW5nIHRoYXQgdGhlIGVycm9yIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgZm9yIHN1Y2ggcmVzcG9uc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIGFsbCBpbnZvY2F0aW9ucyBvZiB0aGUgJGh0dHAgc2VydmljZSByZXF1aXJlIHBhc3NpbmcgaW4gYW4gSFRUUCBtZXRob2QgYW5kIFVSTCwgYW5kCiAgICAgICAgICAgICAgICAgKiBQT1NUL1BVVCByZXF1ZXN0cyByZXF1aXJlIHJlcXVlc3QgZGF0YSB0byBiZSBwcm92aWRlZCBhcyB3ZWxsLCBzaG9ydGN1dCBtZXRob2RzCiAgICAgICAgICAgICAgICAgKiB3ZXJlIGNyZWF0ZWQ6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAuZ2V0KCcvc29tZVVybCcpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZ2V0ICRodHRwLmdldH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3B1dCAkaHR0cC5wdXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAgICAgICAgICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICogb2JqZWN0LCB3aGljaCBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICAgICAgICAgICAgICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICogLyAqYAogICAgICAgICAgICAgICAgICogICAtIGBYLVJlcXVlc3RlZC1XaXRoOiBYTUxIdHRwUmVxdWVzdGAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICAgICAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0WydNeS1IZWFkZXInXT0ndmFsdWUnYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBZGRpdGlvbmFsbHksIHRoZSBkZWZhdWx0cyBjYW4gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogZmFzaGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAgICAgICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0IGludG8KICAgICAgICAgICAgICAgICAqICAgSlNPTiBmb3JtYXQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICAgICAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbgogICAgICAgICAgICAgICAgICogYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUgYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vcgogICAgICAgICAgICAgICAgICogYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byBgJGh0dHBgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBlbmFibGUgY2FjaGluZywgc2V0IHRoZSBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYHRydWVgLiBXaGVuIHRoZSBjYWNoZSBpcwogICAgICAgICAgICAgICAgICogZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiBsb2NhbCBjYWNoZS4gTmV4dCB0aW1lIHRoZQogICAgICAgICAgICAgICAgICogcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQgZXZlbiBpZiB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gY2FjaGUsIGRlbGl2ZXJ5IG9mIHRoZSBkYXRhIGlzIGFzeW5jaHJvbm91cyBpbgogICAgICAgICAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSWYgdGhlcmUgYXJlIG11bHRpcGxlIEdFVCByZXF1ZXN0cyBmb3IgdGhlIHNhbWUgVVJMIHRoYXQgc2hvdWxkIGJlIGNhY2hlZCB1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJlZm9yZSB5b3Ugc3RhcnQgY3JlYXRpbmcgaW50ZXJjZXB0b3JzLCBiZSBzdXJlIHRvIHVuZGVyc3RhbmQgdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIHB1cnBvc2VzIG9mIGdsb2JhbCBlcnJvciBoYW5kbGluZywgYXV0aGVudGljYXRpb24gb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAgICAgICAgICAgICAqIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nIG9mIHJlY2VpdmVkIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlIGFibGUgdG8gaW50ZXJjZXB0CiAgICAgICAgICAgICAgICAgKiByZXNwb25zZXMgZm9yIGh0dHAgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAgICAgICAgICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIHJlc3BvbnNlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgICAgICAgICAgICAgKiBwcm9taXNlIGFwaXN9IHRvIGZ1bGZpbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSBpbnRlcmNlcHRvcnMgYXJlIHNlcnZpY2UgZmFjdG9yaWVzIHRoYXQgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgJGh0dHBQcm92aWRlciBieQogICAgICAgICAgICAgICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLnJlc3BvbnNlSW50ZXJjZXB0b3JzYCBhcnJheS4gVGhlIGZhY3RvcnkgaXMgY2FsbGVkIGFuZAogICAgICAgICAgICAgICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yICDigJQgYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiB0YWtlcyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBhbmQgcmV0dXJucyB0aGUgb3JpZ2luYWwgb3IgYSBuZXcgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgKiAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICAgICAgICAgICAgICAgICAqICAgSlNPTiB2dWxuZXJhYmlsaXR5fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgICAgICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiBKU09OIHZ1bG5lcmFiaWxpdHl9IGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0gcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgYXV0b21hdGljYWxseSBzdHJpcCB0aGUgcHJlZml4IGJlZm9yZSBwcm9jZXNzaW5nIGl0IGFzIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICldfScsCiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0gaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAgICAgICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAgICAgICAgICAgICAqIGNhbGxlZCBgWFNSRi1UT0tFTmAgYW5kIHNldHMgaXQgYXMgdGhlIEhUVFAgaGVhZGVyIGBYLVhTUkYtVE9LRU5gLiBTaW5jZSBvbmx5IEphdmFTY3JpcHQgdGhhdAogICAgICAgICAgICAgICAgICogcnVucyBvbiB5b3VyIGRvbWFpbiBjb3VsZCByZWFkIHRoZSBjb29raWUsIHlvdXIgc2VydmVyIGNhbiBiZSBhc3N1cmVkIHRoYXQgdGhlIFhIUiBjYW1lIGZyb20KICAgICAgICAgICAgICAgICAqIEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICAgICAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAgICAgICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbSBtYWtpbmcKICAgICAgICAgICAgICAgICAqIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzIGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBjb29raWUgd2l0aCBhIHtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpIHNhbHR9IGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBPYmplY3QgZGVzY3JpYmluZyB0aGUgcmVxdWVzdCB0byBiZSBtYWRlIGFuZCBob3cgaXQgc2hvdWxkIGJlCiAgICAgICAgICAgICAgICAgKiAgICBwcm9jZXNzZWQuIFRoZSBvYmplY3QgaGFzIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgIC0gKiptZXRob2QqKiDigJMgYHtzdHJpbmd9YCDigJMgSFRUUCBtZXRob2QgKGUuZy4gJ0dFVCcsICdQT1NUJywgZXRjKQogICAgICAgICAgICAgICAgICogICAgLSAqKnVybCoqIOKAkyBge3N0cmluZ31gIOKAkyBBYnNvbHV0ZSBvciByZWxhdGl2ZSBVUkwgb2YgdGhlIHJlc291cmNlIHRoYXQgaXMgYmVpbmcgcmVxdWVzdGVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKnBhcmFtcyoqIOKAkyBge09iamVjdC48c3RyaW5nfE9iamVjdD59YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aGljaCB3aWxsIGJlIHR1cm5lZCB0bwogICAgICAgICAgICAgICAgICogICAgICBgP2tleTE9dmFsdWUxJmtleTI9dmFsdWUyYCBhZnRlciB0aGUgdXJsLiBJZiB0aGUgdmFsdWUgaXMgbm90IGEgc3RyaW5nLCBpdCB3aWxsIGJlIEpTT05pZmllZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBEYXRhIHRvIGJlIHNlbnQgYXMgdGhlIHJlcXVlc3QgbWVzc2FnZSBkYXRhLgogICAgICAgICAgICAgICAgICogICAgLSAqKmhlYWRlcnMqKiDigJMgYHtPYmplY3R9YCDigJMgTWFwIG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgICAgICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICAgICAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAgICAgICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IFJldHVybnMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gb2JqZWN0IHdpdGggdGhlCiAgICAgICAgICAgICAgICAgKiAgIHN0YW5kYXJkIGB0aGVuYCBtZXRob2QgYW5kIHR3byBodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4gVGhlIGB0aGVuYAogICAgICAgICAgICAgICAgICogICBtZXRob2QgdGFrZXMgdHdvIGFyZ3VtZW50cyBhIHN1Y2Nlc3MgYW5kIGFuIGVycm9yIGNhbGxiYWNrIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdpdGggYQogICAgICAgICAgICAgICAgICogICByZXNwb25zZSBvYmplY3QuIFRoZSBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAgbWV0aG9kcyB0YWtlIGEgc2luZ2xlIGFyZ3VtZW50IC0gYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3Qgc3VjY2VlZHMgb3IgZmFpbHMgcmVzcGVjdGl2ZWx5LiBUaGUgYXJndW1lbnRzIHBhc3NlZCBpbnRvCiAgICAgICAgICAgICAgICAgKiAgIHRoZXNlIGZ1bmN0aW9ucyBhcmUgZGVzdHJ1Y3R1cmVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXNwb25zZSBvYmplY3QgcGFzc2VkIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiAgIGB0aGVuYCBtZXRob2QuIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgVGhlIHJlc3BvbnNlIGJvZHkgdHJhbnNmb3JtZWQgd2l0aCB0aGUgdHJhbnNmb3JtIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAgICAgICAgICAgICAqICAgLSAqKmhlYWRlcnMqKiDigJMgYHtmdW5jdGlvbihbaGVhZGVyTmFtZV0pfWAg4oCTIEhlYWRlciBnZXR0ZXIgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcGVuZGluZ1JlcXVlc3RzIEFycmF5IG9mIGNvbmZpZyBvYmplY3RzIGZvciBjdXJyZW50bHkgcGVuZGluZwogICAgICAgICAgICAgICAgICogICByZXF1ZXN0cy4gVGhpcyBpcyBwcmltYXJpbHkgbWVhbnQgdG8gYmUgdXNlZCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIDxleGFtcGxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRmV0Y2hDdHJsIj4KICAgICAgICAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICAgICAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgPG9wdGlvbj5KU09OUDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+U2FtcGxlIEpTT05QPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+SW52YWxpZCBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCByZXNwb25zZSBkYXRhOiB7e2RhdGF9fTwvcHJlPgogICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEZldGNoQ3RybCgkc2NvcGUsICRodHRwLCAkdGVtcGxhdGVDYWNoZSkgewogICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gJ0dFVCc7CiAgICAgICAgICAgICRzY29wZS51cmwgPSAnaHR0cC1oZWxsby5odG1sJzsKCiAgICAgICAgICAgICRzY29wZS5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS5jb2RlID0gbnVsbDsKICAgICAgICAgICAgICAkc2NvcGUucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgICAkaHR0cCh7bWV0aG9kOiAkc2NvcGUubWV0aG9kLCB1cmw6ICRzY29wZS51cmwsIGNhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhIHx8ICJSZXF1ZXN0IGZhaWxlZCI7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAgICAgICAgICRzY29wZS5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICAgJHNjb3BlLnVybCA9IHVybDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICAgICAgICAgICAgICAgICBIZWxsbywgJGh0dHAhCiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBHRVQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBhIEpTT05QIHJlcXVlc3QgdG8gYW5ndWxhcmpzLm9yZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgSlNPTlAiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJJbnZhbGlkIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcwJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvQmUoJ1JlcXVlc3QgZmFpbGVkJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPC9leGFtcGxlPgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAkaHR0cChjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcubWV0aG9kID0gdXBwZXJjYXNlKGNvbmZpZy5tZXRob2QpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVxdWVzdCB8fCAkY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BUcmFuc2Zvcm1GbiA9IGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSB8fCAkY29uZmlnLnRyYW5zZm9ybVJlc3BvbnNlLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gJGNvbmZpZy5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHsnWC1YU1JGLVRPS0VOJzogJGJyb3dzZXIuY29va2llcygpWydYU1JGLVRPS0VOJ119LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVycy5jb21tb24sIGRlZkhlYWRlcnNbbG93ZXJjYXNlKGNvbmZpZy5tZXRob2QpXSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICAgICAgICAgICAgICByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihyZXFIZWFkZXJzKSwgcmVxVHJhbnNmb3JtRm4pLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZXFIZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycyk7CgoKICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2Zvcm0gZnV0dXJlIHJlc3BvbnNlCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBhcHBseSBpbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlSW50ZXJjZXB0b3JzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGludGVyY2VwdG9yKHByb21pc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5lcnJvciA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFrZSBhIGNvcHkgc2luY2UgdGhlIHJlc3BvbnNlIG11c3QgYmUgY2FjaGVhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCByZXNwVHJhbnNmb3JtRm4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGlzU3VjY2VzcyhyZXNwb25zZS5zdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZXNwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRxLnJlamVjdChyZXNwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNnZXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWxldGUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYERFTEVURWAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNoZWFkCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2pzb25wCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3Bvc3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcHV0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMgYXMgd2VsbCBhcyByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICRodHRwLmRlZmF1bHRzID0gJGNvbmZpZzsKCgogICAgICAgICAgICAgICAgcmV0dXJuICRodHRwOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAgICAgICAgICogJGh0dHBCYWNrZW5kLCAkY29uZmlnLCAkbG9nLCAkcm9vdFNjb3BlLCBkZWZhdWx0Q2FjaGUsICRodHRwLnBlbmRpbmdSZXF1ZXN0cwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCwKICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAgICAgICAgICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5wdXNoKGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwoKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jYWNoZSAmJiBjb25maWcubWV0aG9kID09ICdHRVQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlID0gaXNPYmplY3QoY29uZmlnLmNhY2hlKSA/IGNvbmZpZy5jYWNoZSA6IGRlZmF1bHRDYWNoZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRSZXNwID0gY2FjaGUuZ2V0KHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBjb3B5KGNhY2hlZFJlc3BbMl0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwLCAyMDAsIHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgICAgICAgICAgICAgICBpZiAoIWNhY2hlZFJlc3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAgICAgICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIFJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IE1hdGgubWF4KHN0YXR1cywgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAoaXNTdWNjZXNzKHN0YXR1cykgPyBkZWZlcnJlZC5yZXNvbHZlIDogZGVmZXJyZWQucmVqZWN0KSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiByZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogaGVhZGVyc0dldHRlcihoZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBlbmRpbmdSZXEoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBpbmRleE9mKCRodHRwLnBlbmRpbmdSZXF1ZXN0cywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiB1cmw7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjYuMCIpOwogICAgICAgIH0gY2F0Y2ggKGUxKSB7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuMy4wIik7CiAgICAgICAgfSBjYXRjaCAoZTIpIHsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUCIpOwogICAgICAgIH0gY2F0Y2ggKGUzKSB7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgWE1MSHR0cFJlcXVlc3QuIik7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRodHRwQmFja2VuZAogICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRkb2N1bWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogICAgICogWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IG9yIEpTT05QIGFuZCBkZWFscyB3aXRoIGJyb3dzZXIgaW5jb21wYXRpYmlsaXRpZXMuCiAgICAgKgogICAgICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogICAgICoge0BsaW5rIG5nLiRodHRwICRodHRwfSBvciB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UgJHJlc291cmNlfS4KICAgICAqCiAgICAgKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAgICAgKiAkaHR0cEJhY2tlbmR9IHdoaWNoIGNhbiBiZSB0cmFpbmVkIHdpdGggcmVzcG9uc2VzLgogICAgICovCiAgICBmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24gKCRicm93c2VyLCAkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLAogICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLCAkd2luZG93LmxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoJzonLCAnJykpOwogICAgICAgIH1dOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQsIGxvY2F0aW9uUHJvdG9jb2wpIHsKICAgICAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1ldGhvZCwgdXJsLCBwb3N0LCBjYWxsYmFjaywgaGVhZGVycywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqc29ucFJlcSh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsICdhbmd1bGFyLmNhbGxiYWNrcy4nICsgY2FsbGJhY2tJZCksCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgMjAwLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2NhbGxiYWNrSWRdOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYSFIoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdmFyIHN0YXR1czsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgICAgICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIG9uY2UgRmlyZWZveCAyMSBnZXRzIHJlbGVhc2VkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWdpbjogd29ya2Fyb3VuZCB0byBvdmVyY29tZSBGaXJlZm94IENPUlMgaHR0cCByZXNwb25zZSBoZWFkZXJzIGJ1ZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MDg3MzUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCBhbHJlYWR5IHBhdGNoZWQgaW4gbmlnaHRseS4gU2hvdWxkIGxhbmQgaW4gRmlyZWZveCAyMS4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENPUlMgInNpbXBsZSByZXNwb25zZSBoZWFkZXJzIiBodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGVIZWFkZXJzID0gWyJDYWNoZS1Db250cm9sIiwgIkNvbnRlbnQtTGFuZ3VhZ2UiLCAiQ29udGVudC1UeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRXhwaXJlcyIsICJMYXN0LU1vZGlmaWVkIiwgIlByYWdtYSJdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNpbXBsZUhlYWRlcnMsIGZ1bmN0aW9uIChoZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzICs9IGhlYWRlciArICI6ICIgKyB2YWx1ZSArICJcbiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5kIG9mIHRoZSB3b3JrYXJvdW5kLgoKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMgfHwgeGhyLnN0YXR1cywgeGhyLnJlc3BvbnNlVGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgeGhyLnNlbmQocG9zdCB8fCAnJyk7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXJEZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZykgewogICAgICAgICAgICAgICAgLy8gVVJMX01BVENIIGlzIGRlZmluZWQgaW4gc3JjL3NlcnZpY2UvbG9jYXRpb24uanMKICAgICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9ICh1cmwubWF0Y2goVVJMX01BVENIKSB8fCBbJycsIGxvY2F0aW9uUHJvdG9jb2xdKVsxXTsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CgogICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIGRvbmVXcmFwcGVyKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZVdyYXBwZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAkbG9jYWxlIHNlcnZpY2UgcHJvdmlkZXMgbG9jYWxpemF0aW9uIHJ1bGVzIGZvciB2YXJpb3VzIEFuZ3VsYXIgY29tcG9uZW50cy4gQXMgb2YgcmlnaHQgbm93IHRoZQogICAgICogb25seSBwdWJsaWMgYXBpIGlzOgogICAgICoKICAgICAqICogYGlkYCDigJMgYHtzdHJpbmd9YCDigJMgbG9jYWxlIGlkIGZvcm1hdHRlZCBhcyBgbGFuZ3VhZ2VJZC1jb3VudHJ5SWRgIChlLmcuIGBlbi11c2ApCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpZDogJ2VuLXVzJywKCiAgICAgICAgICAgICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIERFQ0lNQUxfU0VQOiAnLicsCiAgICAgICAgICAgICAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgICAgICAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgICAgICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB7IC8vQ3VycmVuY3kgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1ByZTogJyhcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBDVVJSRU5DWV9TWU06ICckJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBEQVRFVElNRV9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgTU9OVEg6ICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVE1PTlRIOiAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgQU1QTVM6IFsnQU0nLCAnUE0nXSwKICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICAgICAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICAgICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkYnJvd3NlciwgJHEsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRUaW1lb3V0YC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgd3JhcHBlZCBpbnRvIGEgdHJ5L2NhdGNoCiAgICAgICAgICAgICAgICAgKiBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhIHRpbWVvdXQgZnVuY3Rpb24gaXMgYSBwcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIHdoZW4KICAgICAgICAgICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGNhbmNlbCBhIHRpbWVvdXQgcmVxdWVzdCwgY2FsbCBgJHRpbWVvdXQuY2FuY2VsKHByb21pc2UpYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiR0aW1lb3V0IGAkdGltZW91dC5mbHVzaCgpYH0gdG8KICAgICAgICAgICAgICAgICAqIHN5bmNocm9ub3VzbHkgZmx1c2ggdGhlIHF1ZXVlIG9mIGRlZmVycmVkIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdob3NlIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVsYXllZC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIERlbGF5IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgaW52b2tlIGBmbmAgd2l0aGluIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5fSBibG9jay4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQuIFRoZSB2YWx1ZSB0aGlzCiAgICAgICAgICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQsIGNsZWFudXA7CgogICAgICAgICAgICAgICAgICAgIHRpbWVvdXRJZCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgICAgICAgICAgIGNsZWFudXAgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbdGltZW91dElkXSA9IGRlZmVycmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihjbGVhbnVwLCBjbGVhbnVwKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dCNjYW5jZWwKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAgICAgICAqIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgICAgICAqICAgY2FuY2VsZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHRpbWVvdXQuY2FuY2VsID0gZnVuY3Rpb24gKHByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXhlIHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uICgkaW5qZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH1dOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICAgICAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmZpbHRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICAgKiAgIGBhcnJheWAuCiAgICAgKgogICAgICogICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgLSBgc3RyaW5nYDogUHJlZGljYXRlIHRoYXQgcmVzdWx0cyBpbiBhIHN1YnN0cmluZyBtYXRjaCB1c2luZyB0aGUgdmFsdWUgb2YgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgc3RyaW5nLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICAgICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogICAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgICAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogICAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAgICogICAgIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UgZWxlbWVudHMgdGhhdAogICAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDxocj4KICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2giPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCdtJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSk7CgogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0pvaG4nLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcnJheSwgZXhwcmVzc2lvbikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIHZhciBwcmVkaWNhdGVzID0gW107CiAgICAgICAgICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmICghcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgaWYgKHRleHQuY2hhckF0KDApID09PSAnIScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIXNlYXJjaChvYmosIHRleHQuc3Vic3RyKDEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIG9iaikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnJyArIG9iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBzZWFyY2gob2JqW29iaktleV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImFycmF5IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHskOiBleHByZXNzaW9ufTsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJycgKyBleHByZXNzaW9uW2tleV0pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZXh0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnICsgZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpjdXJyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgZGVmYXVsdCBjdXJyZW5jeSBzeW1ib2wgKCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5fX08YnI+CiAgICAgY3VzdG9tIGN1cnJlbmN5IGlkZW50aWZpZXIgKFVTRCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIn19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeToiVVNEJCInKSkudG9CZSgnVVNEJDEsMjM0LjU2Jyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnYW1vdW50JykuZW50ZXIoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBjdXJyZW5jeUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgICBmdW5jdGlvbiBjdXJyZW5jeUZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYW1vdW50LCBjdXJyZW5jeVN5bWJvbCkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY3VycmVuY3lTeW1ib2wpKSBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgICAgICAgICByZXR1cm4gZm9ybWF0TnVtYmVyKGFtb3VudCwgZm9ybWF0cy5QQVRURVJOU1sxXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsIDIpLgogICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOm51bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICAgKgogICAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICAgICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gW2ZyYWN0aW9uU2l6ZT0yXSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IHt7dmFsIHwgbnVtYmVyfX08YnI+CiAgICAgTm8gZnJhY3Rpb25zOiB7e3ZhbCB8IG51bWJlcjowfX08YnI+CiAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMSwyMzUnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMSwyMzQuNTY3OScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCd2YWwnKS5lbnRlcignMzM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTMsMzc0LjMzMzAnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCgogICAgbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgICAgZnJhY3Rpb25TaXplKTsKICAgICAgICB9OwogICAgfQoKICAgIHZhciBERUNJTUFMX1NFUCA9ICcuJzsKCiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSkgJSBncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSkgJSBsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgICAgICAgICB3aGlsZSAoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvbiArPSAnMCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfQoKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgICAgIHZhciBuZWcgPSAnJzsKICAgICAgICBpZiAobnVtIDwgMCkgewogICAgICAgICAgICBuZWcgPSAnLSc7CiAgICAgICAgICAgIG51bSA9IC1udW07CiAgICAgICAgfQogICAgICAgIG51bSA9ICcnICsgbnVtOwogICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgICAgICAgaWYgKHRyaW0pCiAgICAgICAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICAgICAgcmV0dXJuIG5lZyArIG51bTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIGlmIChvZmZzZXQgPiAwIHx8IHZhbHVlID4gLW9mZnNldCkKICAgICAgICAgICAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIpIHZhbHVlID0gMTI7CiAgICAgICAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIHZhciBnZXQgPSB1cHBlcmNhc2Uoc2hvcnRGb3JtID8gKCdTSE9SVCcgKyBuYW1lKSA6IG5hbWUpOwoKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgICAgICAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICB2YXIgcGFkZGVkWm9uZSA9ICh6b25lID49IDApID8gIisiIDogIiI7CgogICAgICAgIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgICAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICAgICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgICB9CgogICAgZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgICB9CgogICAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgICAgICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICAgICAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgICAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICAgICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgICAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgICAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICAgICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgICAgIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICAgICAgIEVFRTogZGF0ZVN0ckdldHRlcignRGF5JywgdHJ1ZSksCiAgICAgICAgYTogYW1wbUdldHRlciwKICAgICAgICBaOiB0aW1lWm9uZUdldHRlcgogICAgfTsKCiAgICB2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkUnXSspfCg/OicoPzpbXiddfCcnKSonKXwoPzpFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFopKSguKikvLAogICAgICAgIE5VTUJFUl9TVFJJTkcgPSAvXlxkKyQvOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmRhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGVsZW1lbnRzOgogICAgICoKICAgICAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogICAgICogICAqIGAneXknYDogMiBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBwYWRkZWQgKDAwLTk5KS4gKGUuZy4gQUQgMjAwMSA9PiAwMSwgQUQgMjAxMCA9PiAxMCkKICAgICAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAgICAgKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAgICAgKiAgICogYCdNTU0nYDogTW9udGggaW4geWVhciAoSmFuLURlYykKICAgICAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAgICAgKiAgICogYCdkZCdgOiBEYXkgaW4gbW9udGgsIHBhZGRlZCAoMDEtMzEpCiAgICAgKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICAgICAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICAgICAqICAgKiBgJ0VFRSdgOiBEYXkgaW4gV2VlaywgKFN1bi1TYXQpCiAgICAgKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICAgICAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAgICAgKiAgICogYCdoaCdgOiBIb3VyIGluIGFtL3BtLCBwYWRkZWQgKDAxLTEyKQogICAgICogICAqIGAnaCdgOiBIb3VyIGluIGFtL3BtLCAoMS0xMikKICAgICAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogICAgICogICAqIGAnbSdgOiBNaW51dGUgaW4gaG91ciAoMC01OSkKICAgICAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAgICAgKiAgICogYCdhJ2A6IGFtL3BtIG1hcmtlcgogICAgICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtKzEyMDApCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogICAgICogICB7QGxpbmsgZ3VpZGUvaTE4biBsb2NhbGl6YWJsZSBmb3JtYXRzfToKICAgICAqCiAgICAgKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICAgICAqICAgICAoZS5nLiBTZXAgMywgMjAxMCAxMjowNTowOCBwbSkKICAgICAqICAgKiBgJ3Nob3J0J2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXkgaDptbSBhJ2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gOS8zLzEwIDEyOjA1IHBtKQogICAgICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICAgICAqICAgICAoZS5nLiBGcmlkYXksIFNlcHRlbWJlciAzLCAyMDEwKQogICAgICogICAqIGAnbG9uZ0RhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcHRlbWJlciAzLCAyMDEwCiAgICAgKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogICAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgcG0pCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAgICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IHNpbmdsZSBxdW90ZSwgdXNlIHR3byBzaW5nbGUgcXVvdGVzIGluIGEgc2VxdWVuY2UKICAgICAqICAgKGUuZy4gYCJoIG8nJ2Nsb2NrImApLgogICAgICoKICAgICAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogICAgICogICAgbnVtYmVyKSBvciB2YXJpb3VzIElTTyA4NjAxIGRhdGV0aW1lIHN0cmluZyBmb3JtYXRzIChlLmcuIHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWiBhbmQgaXRzCiAgICAgKiAgICBzaG9ydGVyIHZlcnNpb25zIGxpa2UgeXl5eS1NTS1kZFRISDptbVosIHl5eXktTU0tZGQgb3IgeXl5eU1NZGRUSEhtbXNzWikuIElmIG5vIHRpbWV6b25lIGlzCiAgICAgKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGZvcm1hdCBGb3JtYXR0aW5nIHJ1bGVzIChzZWUgRGVzY3JpcHRpb24pLiBJZiBub3Qgc3BlY2lmaWVkLAogICAgICogICAgYG1lZGl1bURhdGVgIGlzIHVzZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgc3RyaW5nIG9yIHRoZSBpbnB1dCBpZiBpbnB1dCBpcyBub3QgcmVjb2duaXplZCBhcyBkYXRlL21pbGxpcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08YnI+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAge3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PGJyPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+OgogICAgIHt7JzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PGJyPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZm9ybWF0IGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gKFwtfFwrKT9cZHs0fS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS4KICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBkYXRlRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgICAgICAgdmFyIFJfSVNPODYwMV9TVFIgPSAvXihcZHs0fSktPyhcZFxkKS0/KFxkXGQpKD86VChcZFxkKSg/Ojo/KFxkXGQpKD86Oj8oXGRcZCkoPzpcLihcZCspKT8pPyk/KFp8KFsrLV0pKFxkXGQpOj8oXGRcZCkpPyk/JC87CgogICAgICAgIGZ1bmN0aW9uIGpzb25TdHJpbmdUb0RhdGUoc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSAwOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoWzldKSB7CiAgICAgICAgICAgICAgICAgICAgdHpIb3VyID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTBdKTsKICAgICAgICAgICAgICAgICAgICB0ek1pbiA9IGludChtYXRjaFs5XSArIG1hdGNoWzExXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKGludChtYXRjaFsxXSksIGludChtYXRjaFsyXSkgLSAxLCBpbnQobWF0Y2hbM10pKTsKICAgICAgICAgICAgICAgIGRhdGUuc2V0VVRDSG91cnMoaW50KG1hdGNoWzRdIHx8IDApIC0gdHpIb3VyLCBpbnQobWF0Y2hbNV0gfHwgMCkgLSB0ek1pbiwgaW50KG1hdGNoWzZdIHx8IDApLCBpbnQobWF0Y2hbN10gfHwgMCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdCkgewogICAgICAgICAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIGZuLCBtYXRjaDsKCiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgICAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgICAgICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgICAgICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgICAgOiB2YWx1ZS5yZXBsYWNlKC8oXid8JyQpL2csICcnKS5yZXBsYWNlKC8nJy9nLCAiJyIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiB0ZXh0OwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBBbGxvd3MgeW91IHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG9iamVjdCBpbnRvIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAgICAgKiAgIHRoZSBiaW5kaW5nIGlzIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIEpTT04uCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEpTT04gc3RyaW5nLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZToKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHByZT57eyB7J25hbWUnOid2YWx1ZSd9IHwganNvbiB9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJ7J25hbWUnOid2YWx1ZSd9IikpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBqc29uRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICovCiAgICB2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjp1cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICovCiAgICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bGltaXRUbwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBhcyBzcGVjaWZpZWQgYnkgdGhlCiAgICAgKiB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkuIElmIHRoZSBgbGltaXRgIG51bWJlciBpcwogICAgICogICAgIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUKICAgICAqICAgICBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN1Yi1hcnJheSBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5IGhhZCBsZXNzIHRoYW4gYGxpbWl0YAogICAgICogICAgIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxpbWl0ID0gMzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGltaXQiPgogICAgIDxwPk91dHB1dDoge3sgbnVtYmVycyB8IGxpbWl0VG86bGltaXQgfX08L3A+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGxpbWl0KSB7CiAgICAgICAgICAgIGlmICghKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGxpbWl0ID0gaW50KGxpbWl0KTsKICAgICAgICAgICAgdmFyIG91dCA9IFtdLAogICAgICAgICAgICAgICAgaSwgbjsKCiAgICAgICAgICAgIC8vIGNoZWNrIHRoYXQgYXJyYXkgaXMgaXRlcmFibGUKICAgICAgICAgICAgaWYgKCFhcnJheSB8fCAhKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKQogICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKCiAgICAgICAgICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgICAgICAgICBpZiAobGltaXQgPiBhcnJheS5sZW5ndGgpCiAgICAgICAgICAgICAgICBsaW1pdCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgZWxzZSBpZiAobGltaXQgPCAtYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSAtYXJyYXkubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBuID0gbGltaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpID0gYXJyYXkubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgICAgICAgICBuID0gYXJyYXkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2goYXJyYXlbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOm9yZGVyQnkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdG9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPn0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogICAgICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogICAgICoKICAgICAqICAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAgLSBgZnVuY3Rpb25gOiBHZXR0ZXIgZnVuY3Rpb24uIFRoZSByZXN1bHQgb2YgdGhpcyBmdW5jdGlvbiB3aWxsIGJlIHNvcnRlZCB1c2luZyB0aGUKICAgICAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvci4KICAgICAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJwogICAgICogICAgICB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkICduYW1lJy4gT3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbAogICAgICogICAgICBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZyBzb3J0IG9yZGVyIChmb3IgZXhhbXBsZSwgK25hbWUgb3IgLW5hbWUpLgogICAgICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgICAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXZlcnNlIFJldmVyc2UgdGhlIG9yZGVyIHRoZSBhcnJheS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAkc2NvcGUucHJlZGljYXRlID0gJy1hZ2UnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgICAgPGhyLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZT0nJyI+dW5zb3J0ZWQ8L2E+IF0KICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgPHRyPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnbmFtZSc7IHJldmVyc2U9ZmFsc2UiPk5hbWU8L2E+CiAgICAgKDxhIGhyZWYgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgPC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgIDwvdHI+CiAgICAgPC90YWJsZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGJlIHJldmVyc2Ugb3JkZXJlZCBieSBhZ2VkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwcmVkaWNhdGUnKSkudG9CZSgnLWFnZScpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMjknLCAnMjEnLCAnMTknLCAnMTAnXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKdWxpZScsICdNaWtlJywgJ01hcnknLCAnSm9obiddKTsKICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHJlb3JkZXIgdGhlIHRhYmxlIHdoZW4gdXNlciBzZWxlY3RzIGRpZmZlcmVudCBwcmVkaWNhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiTmFtZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0pvaG4nLCAnSnVsaWUnLCAnTWFyeScsICdNaWtlJ10pOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMTAnLCAnMjknLCAnMTknLCAnMjEnXSk7CgogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5waG9uZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnNTU1LTk4NzYnLCAnNTU1LTg3NjUnLCAnNTU1LTU2NzgnLCAnNTU1LTQzMjEnLCAnNTU1LTEyMTInXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdKdWxpZScsICdBZGFtJywgJ01pa2UnLCAnSm9obiddKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIG9yZGVyQnlGaWx0ZXIuJGluamVjdCA9IFsnJHBhcnNlJ107CiAgICBmdW5jdGlvbiBvcmRlckJ5RmlsdGVyKCRwYXJzZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGUgOiBbc29ydFByZWRpY2F0ZV07CiAgICAgICAgICAgIHNvcnRQcmVkaWNhdGUgPSBtYXAoc29ydFByZWRpY2F0ZSwgZnVuY3Rpb24gKHByZWRpY2F0ZSkgewogICAgICAgICAgICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLCBnZXQoYikpOwogICAgICAgICAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgYXJyYXlDb3B5ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJhdG9yKG8xLCBvMikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0Jvb2xlYW4oZGVzY2VuZGluZykKICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXAoYiwgYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgOiBjb21wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2MikgewogICAgICAgICAgICAgICAgdmFyIHQxID0gdHlwZW9mIHYxOwogICAgICAgICAgICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICAgICAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MSA9IHYxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYxID09PSB2MikgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYxIDwgdjIgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0MSA8IHQyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5nRGlyZWN0aXZlKGRpcmVjdGl2ZSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgZGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbGluazogZGlyZWN0aXZlCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBQyc7CiAgICAgICAgcmV0dXJuIHZhbHVlRm4oZGlyZWN0aXZlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTphCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTW9kaWZpZXMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgaHRtbCBBIHRhZywgc28gdGhhdCB0aGUgZGVmYXVsdCBhY3Rpb24gaXMgcHJldmVudGVkIHdoZW4gaHJlZgogICAgICogYXR0cmlidXRlIGlzIGVtcHR5LgogICAgICoKICAgICAqIFRoZSByZWFzb25pbmcgZm9yIHRoaXMgY2hhbmdlIGlzIHRvIGFsbG93IGVhc3kgY3JlYXRpb24gb2YgYWN0aW9uIGxpbmtzIHdpdGggYG5nQ2xpY2tgIGRpcmVjdGl2ZQogICAgICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAgICAgKiBgPGEgaHJlZj0iIiBuZy1jbGljaz0ibW9kZWwuJHNhdmUoKSI+U2F2ZTwvYT5gCiAgICAgKi8KICAgIHZhciBodG1sQW5jaG9yRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAgICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgICAgICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgICAgICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgICAgICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoJ2hyZWYnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIcmVmCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogICAgICogdGhlIHBhZ2Ugb3BlbiB0byBhIHdyb25nIFVSTCwgaWYgdGhlIHVzZXIgY2xpY2tzIHRoYXQgbGluayBiZWZvcmUKICAgICAqIGFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIHt7aGFzaH19IHdpdGggYWN0dWFsIFVSTCwgdGhlCiAgICAgKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICAgICAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgQQogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVGhpcyBleGFtcGxlIHVzZXMgYGxpbmtgIHZhcmlhYmxlIGluc2lkZSBgaHJlZmAgYXR0cmlidXRlOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0xJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTEnKS5hdHRyKCdocmVmJykpLnRvQmUoIiIpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMicpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0yJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0zJykuYXR0cignaHJlZicpKS50b0JlKCIvMTIzIik7CgogICAgICAgICAgZWxlbWVudCgnI2xpbmstMycpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoYnJvd3NlcigpLndpbmRvdygpLnBhdGgoKSkudG9FcXVhbCgnLzEyMycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nLWhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgnNicpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLnVybCgpKS50b0VxdWFsKCcvNicpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NyYwogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IElNRwogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEaXNhYmxlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAgICAgKiA8cHJlPgogICAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICAgKiA8L2Rpdj4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBkaXNhYmxlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nRGlzYWJsZWRgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hlY2tlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBjaGVja2VkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdtYXN0ZXInKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNdWx0aXBsZQogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nTXVsdGlwbGVgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICA8c2VsZWN0IGlkPSJzZWxlY3QiIG5nLW11bHRpcGxlPSJjaGVja2VkIj4KICAgICA8b3B0aW9uPk1pc2tvPC9vcHRpb24+CiAgICAgPG9wdGlvbj5JZ29yPC9vcHRpb24+CiAgICAgPG9wdGlvbj5Wb2p0YTwvb3B0aW9uPgogICAgIDxvcHRpb24+RGk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBtdWx0aXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IFNFTEVDVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ011bHRpcGxlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUmVhZG9ubHkKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NlbGVjdGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHNlbGVjdGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlZCB0aGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgICAgPHNlbGVjdD4KICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnc2VsZWN0ZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IE9QVElPTgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24gKHByb3BOYW1lLCBhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0pOwoKCi8vIG5nLXNyYywgbmctaHJlZiBhcmUgaW50ZXJwb2xhdGVkCiAgICBmb3JFYWNoKFsnc3JjJywgJ2hyZWYnXSwgZnVuY3Rpb24gKGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIGVsZW1lbnQucHJvcChhdHRyTmFtZSwgYXR0clthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCiAgICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgICAgICRhZGRDb250cm9sOiBub29wLAogICAgICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICAgICAkc2V0RGlydHk6IG5vb3AKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybSB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgY29udGFpbmluZyBjb250cm9sIG9yIGZvcm0gaXMgaW52YWxpZC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIElzIGFuIG9iamVjdCBoYXNoLCBjb250YWluaW5nIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgY29udHJvbHMgb3IKICAgICAqICBmb3Jtcywgd2hlcmU6CiAgICAgKgogICAgICogIC0ga2V5cyBhcmUgdmFsaWRhdGlvbiB0b2tlbnMgKGVycm9yIG5hbWVzKSDigJQgc3VjaCBhcyBgcmVxdWlyZWRgLCBgdXJsYCBvciBgZW1haWxgKSwKICAgICAqICAtIHZhbHVlcyBhcmUgYXJyYXlzIG9mIGNvbnRyb2xzIG9yIGZvcm1zIHRoYXQgYXJlIGludmFsaWQgd2l0aCBnaXZlbiBlcnJvci4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIGBGb3JtQ29udHJvbGxlcmAga2VlcHMgdHJhY2sgb2YgYWxsIGl0cyBjb250cm9scyBhbmQgbmVzdGVkIGZvcm1zIGFzIHdlbGwgYXMgc3RhdGUgb2YgdGhlbSwKICAgICAqIHN1Y2ggYXMgYmVpbmcgdmFsaWQvaW52YWxpZCBvciBkaXJ0eS9wcmlzdGluZS4KICAgICAqCiAgICAgKiBFYWNoIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfSBkaXJlY3RpdmUgY3JlYXRlcyBhbiBpbnN0YW5jZQogICAgICogb2YgYEZvcm1Db250cm9sbGVyYC4KICAgICAqCiAgICAgKi8KLy9hc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgIEZvcm1Db250cm9sbGVyLiRpbmplY3QgPSBbJyRlbGVtZW50JywgJyRhdHRycycsICckc2NvcGUnXTsKICAgIGZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLAogICAgICAgICAgICBwYXJlbnRGb3JtID0gZWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgIGVycm9ycyA9IGZvcm0uJGVycm9yID0ge307CgogICAgICAgIC8vIGluaXQgc3RhdGUKICAgICAgICBmb3JtLiRuYW1lID0gYXR0cnMubmFtZTsKICAgICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgICAgICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgIGVsZW1lbnQuCiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgYWRkQ2xhc3MoKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICAgICAgICB9CgogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICBpZiAoY29udHJvbC4kbmFtZSAmJiAhZm9ybS5oYXNPd25Qcm9wZXJ0eShjb250cm9sLiRuYW1lKSkgewogICAgICAgICAgICAgICAgZm9ybVtjb250cm9sLiRuYW1lXSA9IGNvbnRyb2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRyZW1vdmVDb250cm9sID0gZnVuY3Rpb24gKGNvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgZm9ybVtjb250cm9sLiRuYW1lXSA9PT0gY29udHJvbCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uIChxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgICAgICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSA9IGZ1bmN0aW9uICh2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXREaXJ0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoRElSVFlfQ0xBU1MpOwogICAgICAgICAgICBmb3JtLiRkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIGZvcm0uJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgfTsKCiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRm9ybQogICAgICogQHJlc3RyaWN0IEVBQwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTmVzdGFibGUgYWxpYXMgb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGBmb3JtYH0gZGlyZWN0aXZlLiBIVE1MCiAgICAgKiBkb2VzIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGZvcm0gZWxlbWVudHMuIEl0IGlzIHVzZWZ1bCB0byBuZXN0IGZvcm1zLCBmb3IgZXhhbXBsZSBpZiB0aGUgdmFsaWRpdHkgb2YgYQogICAgICogc3ViLWdyb3VwIG9mIGNvbnRyb2xzIG5lZWRzIHRvIGJlIGRldGVybWluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lfG5nRm9ybSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGlyZWN0aXZlIHRoYXQgaW5zdGFudGlhdGVzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogICAgICoKICAgICAqIElmIGBuYW1lYCBhdHRyaWJ1dGUgaXMgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIGlzIHB1Ymxpc2hlZCBvbnRvIHRoZSBjdXJyZW50IHNjb3BlIHVuZGVyCiAgICAgKiB0aGlzIG5hbWUuCiAgICAgKgogICAgICogIyBBbGlhczoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9CiAgICAgKgogICAgICogSW4gYW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICAgKiBmb3JtcyBhcmUgdmFsaWQgYXMgd2VsbC4gSG93ZXZlciBicm93c2VycyBkbyBub3QgYWxsb3cgbmVzdGluZyBvZiBgPGZvcm0+YCBlbGVtZW50cywgZm9yIHRoaXMKICAgICAqIHJlYXNvbiBhbmd1bGFyIHByb3ZpZGVzIHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfSBhbGlhcwogICAgICogd2hpY2ggYmVoYXZlcyBpZGVudGljYWwgdG8gYDxmb3JtPmAgYnV0IGFsbG93cyBmb3JtIG5lc3RpbmcuCiAgICAgKgogICAgICoKICAgICAqICMgQ1NTIGNsYXNzZXMKICAgICAqICAtIGBuZy12YWxpZGAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogICAgICogIC0gYG5nLWludmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBpbnZhbGlkLgogICAgICogIC0gYG5nLXByaXN0aW5lYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICAgKiAgLSBgbmctZGlydHlgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICAgICAqCiAgICAgKgogICAgICogIyBTdWJtaXR0aW5nIGEgZm9ybSBhbmQgcHJldmVudGluZyBkZWZhdWx0IGFjdGlvbgogICAgICoKICAgICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAgICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAgICAgKiBwYWdlIHJlbG9hZCB0aGF0IHNlbmRzIHRoZSBkYXRhIHRvIHRoZSBzZXJ2ZXIuIEluc3RlYWQgc29tZSBqYXZhc2NyaXB0IGxvZ2ljIHNob3VsZCBiZSB0cmlnZ2VyZWQKICAgICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheS4KICAgICAqCiAgICAgKiBGb3IgdGhpcyByZWFzb24sIEFuZ3VsYXIgcHJldmVudHMgdGhlIGRlZmF1bHQgYWN0aW9uIChmb3JtIHN1Ym1pc3Npb24gdG8gdGhlIHNlcnZlcikgdW5sZXNzIHRoZQogICAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBvbmUgb2YgdGhlIGZvbGxvd2luZyB0d28gd2F5cyB0byBzcGVjaWZ5IHdoYXQgamF2YXNjcmlwdCBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB3aGVuCiAgICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAgICoKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdCBuZ1N1Ym1pdH0gZGlyZWN0aXZlIG9uIHRoZSBmb3JtIGVsZW1lbnQKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgICAqCiAgICAgKiBUbyBwcmV2ZW50IGRvdWJsZSBleGVjdXRpb24gb2YgdGhlIGhhbmRsZXIsIHVzZSBvbmx5IG9uZSBvZiBuZ1N1Ym1pdCBvciBuZ0NsaWNrIGRpcmVjdGl2ZXMuIFRoaXMKICAgICAqIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgY29taW5nIGZyb20gdGhlIGh0bWwgc3BlYzoKICAgICAqCiAgICAgKiAtIElmIGEgZm9ybSBoYXMgb25seSBvbmUgaW5wdXQgZmllbGQgdGhlbiBoaXR0aW5nIGVudGVyIGluIHRoaXMgZmllbGQgdHJpZ2dlcnMgZm9ybSBzdWJtaXQKICAgICAqIChgbmdTdWJtaXRgKQogICAgICogLSBpZiBhIGZvcm0gaGFzIGhhcyAyKyBpbnB1dCBmaWVsZHMgYW5kIG5vIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4gaGl0dGluZyBlbnRlcgogICAgICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogICAgICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogICAgICogaGl0dGluZyBlbnRlciBpbiBhbnkgb2YgdGhlIGlucHV0IGZpZWxkcyB3aWxsIHRyaWdnZXIgdGhlIGNsaWNrIGhhbmRsZXIgb24gdGhlICpmaXJzdCogYnV0dG9uIG9yCiAgICAgKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+UmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgndXNlclR5cGUnKS5lbnRlcignJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgZm9ybURpcmVjdGl2ZUZhY3RvcnkgPSBmdW5jdGlvbiAoaXNOZ0Zvcm0pIHsKICAgICAgICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uICgkdGltZW91dCkgewogICAgICAgICAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6ICdmb3JtJywKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBGb3JtQ29udHJvbGxlciwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIChzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdW5yZWdpc3RlciB0aGUgcHJldmVudERlZmF1bHQgbGlzdGVuZXIgc28gdGhhdCB3ZSBkb24ndCBub3QgbGVhayBtZW1vcnkgYnV0IGluIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3YXkgdGhhdCB3aWxsIGFjaGlldmUgdGhlIHByZXZlbnRpb24gb2YgdGhlIGRlZmF1bHQgYWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm1DdHJsLiRyZW1vdmVDb250cm9sKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW2FsaWFzXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlciwgbnVsbEZvcm1DdHJsKTsgLy9zdG9wIHByb3BhZ2F0aW5nIGNoaWxkIGRlc3RydWN0aW9uIGhhbmRsZXJzIHVwd2FyZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gaXNOZ0Zvcm0gPyBleHRlbmQoY29weShmb3JtRGlyZWN0aXZlKSwge3Jlc3RyaWN0OiAnRUFDJ30pIDogZm9ybURpcmVjdGl2ZTsKICAgICAgICB9XTsKICAgIH07CgogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogICAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAgIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICAgIHZhciBFTUFJTF9SRUdFWFAgPSAvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDR9JC87CiAgICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgICB2YXIgaW5wdXRUeXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2d1ZXN0JzsKICAgICAgICAgICAgICRzY29wZS53b3JkID0gL15cdyokLzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBTaW5nbGUgd29yZDogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIKICAgICAgICAgbmctcGF0dGVybj0id29yZCIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnBhdHRlcm4iPgogICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2hlbGxvIHdvcmxkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ3RleHQnOiB0ZXh0SW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBudW1iZXIgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIFNldHMgdGhlIGBudW1iZXJgIHZhbGlkYXRpb24KICAgICAgICAgKiBlcnJvciBpZiBub3QgYSB2YWxpZCBudW1iZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgIG1pbj0iMCIgbWF4PSI5OSIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5saXN0LiRlcnJvci5udW1iZXIiPgogICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnMTInKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJzEyMycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdudW1iZXInOiBudW1iZXJJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnVybAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIFVSTCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgdXJsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgY29udGVudCBpcyBub3QgYQogICAgICAgICAqIHZhbGlkIFVSTC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVVJMOiA8aW5wdXQgdHlwZT0idXJsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci51cmwiPgogICAgICAgICBOb3QgdmFsaWQgdXJsITwvc3Bhbj4KICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci51cmwgPSB7eyEhbXlGb3JtLiRlcnJvci51cmx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdodHRwOi8vZ29vZ2xlLmNvbScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgdXJsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3h4eCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAgICAgICAqIGFkZHJlc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQucmFkaW8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvcn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbG9yJykpLnRvRXF1YWwoJ2JsdWUnKTsKCiAgICAgICAgICAgIGlucHV0KCdjb2xvcicpLnNlbGVjdCgncmVkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdZRVMnKTsKCiAgICAgICAgICAgIGlucHV0KCd2YWx1ZTEnKS5jaGVjaygpOwogICAgICAgICAgICBpbnB1dCgndmFsdWUyJykuY2hlY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgICAgICdoaWRkZW4nOiBub29wLAogICAgICAgICdidXR0b24nOiBub29wLAogICAgICAgICdzdWJtaXQnOiBub29wLAogICAgICAgICdyZXNldCc6IG5vb3AKICAgIH07CgoKICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRyaW0oZWxlbWVudC52YWwoKSk7CgogICAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBpZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgImlucHV0IiBldmVudCwgd2UgYXJlIGZpbmUgLSBleGNlcHQgb24gSUU5IHdoaWNoIGRvZXNuJ3QgZmlyZSB0aGUKICAgICAgICAvLyBpbnB1dCBldmVudCBvbiBiYWNrc3BhY2UsIGRlbGV0ZSBvciBjdXQKICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ2lucHV0JykpIHsKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdpbnB1dCcsIGxpc3RlbmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdGltZW91dDsKCiAgICAgICAgICAgIHZhciBkZWZlckxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAgICAgICAgIC8vIGlnbm9yZQogICAgICAgICAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgICAgICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NoYW5nZScsIGxpc3RlbmVyKTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgbW9kaWZpZXMgaW5wdXQgdmFsdWUgdXNpbmcgY29udGV4dCBtZW51IGluIElFLCB3ZSBuZWVkICJwYXN0ZSIgYW5kICJjdXQiIGV2ZW50cyB0byBjYXRjaCBpdAogICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ3Bhc3RlJykpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQudmFsKGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgICAgIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3I7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uIChyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAocGF0dGVybikgewogICAgICAgICAgICBpZiAocGF0dGVybi5tYXRjaCgvXlwvKC4qKVwvJC8pKSB7CiAgICAgICAgICAgICAgICBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnN1YnN0cigxLCBwYXR0ZXJuLmxlbmd0aCAtIDIpKTsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybiwgdmFsdWUpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGF0dGVybk9iaiB8fCAhcGF0dGVybk9iai50ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdHRlcm4gKyAnIHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgJyArIHBhdHRlcm5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoIDwgbWlubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbmxlbmd0aCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gbWF4IGxlbmd0aCB2YWxpZGF0b3IKICAgICAgICBpZiAoYXR0ci5uZ01heGxlbmd0aCkgewogICAgICAgICAgICB2YXIgbWF4bGVuZ3RoID0gaW50KGF0dHIubmdNYXhsZW5ndGgpOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA+IG1heGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heGxlbmd0aCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbnVtYmVySW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGlzRW1wdHkodmFsdWUpOwogICAgICAgICAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzRW1wdHkodmFsdWUpID8gJycgOiAnJyArIHZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoYXR0ci5taW4pIHsKICAgICAgICAgICAgdmFyIG1pbiA9IHBhcnNlRmxvYXQoYXR0ci5taW4pOwogICAgICAgICAgICB2YXIgbWluVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlIDwgbWluKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWluJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGF0dHIubWF4KSB7CiAgICAgICAgICAgIHZhciBtYXggPSBwYXJzZUZsb2F0KGF0dHIubWF4KTsKICAgICAgICAgICAgdmFyIG1heFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBpc051bWJlcih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXJsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgdXJsVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgZW1haWxWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGVsZW1lbnRbMF0uY2hlY2tlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZVZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnRleHRhcmVhCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCB0ZXh0YXJlYSBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gVGhlIGRhdGEtYmluZGluZyBhbmQgdmFsaWRhdGlvbgogICAgICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQKICAgICAqIEByZXN0cmljdCBFCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVE1MIGlucHV0IGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBJbnB1dCBjb250cm9sIGZvbGxvd3MgSFRNTDUgaW5wdXQgdHlwZXMKICAgICAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nUmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBpZiBzZXQgdG8gdHJ1ZQogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgVXNlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiIG5nLW1vZGVsPSJ1c2VyLm5hbWUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLnVzZXJOYW1lLiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICAgIFRvbyBzaG9ydCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1heGxlbmd0aCI+CiAgICAgVG9vIGxvbmchPC9zcGFuPjxicj4KICAgICA8L2Zvcm0+CiAgICAgPGhyPgogICAgIDx0dD51c2VyID0ge3t1c2VyfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kdmFsaWQgPSB7e215Rm9ybS51c2VyTmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiR2YWxpZCA9IHt7bXlGb3JtLmxhc3ROYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kZXJyb3IgPSB7e215Rm9ybS5sYXN0TmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5taW5sZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5taW5sZW5ndGh9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLm5hbWUnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbGVzcyB0aGFuIHJlcXVpcmVkIG1pbiBsZW5ndGgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcigneHgnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9taW5sZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3NvbWUgcmlkaWN1bG91c2x5IGxvbmcgbmFtZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkKICAgICAgICAgICAgLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9tYXhsZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICAgICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgICAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICAgICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogICAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBXaGVuZXZlciB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00sIGl0IGV4ZWN1dGVzCiAgICAgKiAgICAgYWxsIG9mIHRoZXNlIGZ1bmN0aW9ucyB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBXaGVuZXZlciB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcywgaXQgZXhlY3V0ZXMgYWxsIG9mCiAgICAgKiAgICAgdGhlc2UgZnVuY3Rpb25zIHRvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBiamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbCB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgZXJyb3Igb24gdGhlIGNvbnRyb2wuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGUsIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICAgKiBzcGVjaWZpY2FsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAgICogRE9NIGV2ZW50cy4gVGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgaXMgbWVhbnQgdG8gYmUgZXh0ZW5kZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGVyZSwgdGhlCiAgICAgKiBkaXJlY3RpdmUgcHJvdmlkZXMgRE9NIG1hbmlwdWxhdGlvbiBhbmQgdGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgdGhlIGRhdGEtYmluZGluZy4KICAgICAqCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAgICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIDxleGFtcGxlIG1vZHVsZT0iY3VzdG9tQ29udHJvbCI+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICBbY29udGVudGVkaXRhYmxlXSB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgbWluLWhlaWdodDogMjBweDsKICAgICAgfQoKICAgICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGFuZ3VsYXIubW9kdWxlKCdjdXN0b21Db250cm9sJywgW10pLgogICAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0EnLCAvLyBvbmx5IGFjdGl2YXRlIG9uIGVsZW1lbnQgYXR0cmlidXRlCiAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBuZ01vZGVsKSB7CiAgICAgICAgICAgICAgaWYoIW5nTW9kZWwpIHJldHVybjsgLy8gZG8gbm90aGluZyBpZiBubyBuZy1tb2RlbAoKICAgICAgICAgICAgICAvLyBTcGVjaWZ5IGhvdyBVSSBzaG91bGQgYmUgdXBkYXRlZAogICAgICAgICAgICAgIG5nTW9kZWwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJyk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdibHVyIGtleXVwIGNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlYWQoKTsgLy8gaW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAvLyBXcml0ZSBkYXRhIHRvIHRoZSBtb2RlbAogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoKSB7CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoZWxlbWVudC5odG1sKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICA8ZGl2IGNvbnRlbnRlZGl0YWJsZQogICAgIG5hbWU9Im15V2lkZ2V0IiBuZy1tb2RlbD0idXNlckNvbnRlbnQiCiAgICAgcmVxdWlyZWQ+Q2hhbmdlIG1lITwvZGl2PgogICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICA8aHI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGRhdGEtYmluZCBhbmQgYmVjb21lIGludmFsaWQnLCBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudEVkaXRhYmxlID0gZWxlbWVudCgnW2NvbnRlbnRlZGl0YWJsZV0nKTsKCiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJ0NoYW5nZSBtZSEnKTsKICAgICAgICBpbnB1dCgndXNlckNvbnRlbnQnKS5lbnRlcignJyk7CiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUucHJvcCgnY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLWludmFsaWQtcmVxdWlyZWQvKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgICogPC9leGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIE5nTW9kZWxDb250cm9sbGVyID0gWyckc2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGF0dHJzJywgJyRlbGVtZW50JywgJyRwYXJzZScsCiAgICAgICAgZnVuY3Rpb24gKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlKSB7CiAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgICAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgICAgICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICAgICAgICAgICAgaWYgKCFuZ01vZGVsU2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgJGF0dHIubmdNb2RlbCArCiAgICAgICAgICAgICAgICAgICAgJyAoJyArIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSArICcpJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgICAgICAkZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0Vmlld1ZhbHVlCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmVhZCBhIHZhbHVlIGZyb20gdmlldy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBmcm9tIHdpdGhpbiBhIERPTSBldmVudCBoYW5kbGVyLgogICAgICAgICAgICAgKiBGb3IgZXhhbXBsZSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fSBvcgogICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9IGRpcmVjdGl2ZXMgY2FsbCBpdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQgaW50ZXJuYWxseSBjYWxscyBhbGwgYHBhcnNlcnNgIGFuZCBpZiByZXN1bHRlZCB2YWx1ZSBpcyB2YWxpZCwgdXBkYXRlcyB0aGUgbW9kZWwgYW5kCiAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR2aWV3VmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBjaGFuZ2UgdG8gZGlydHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRwcmlzdGluZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKFBSSVNUSU5FX0NMQVNTKS5hZGRDbGFzcyhESVJUWV9DTEFTUyk7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3JFYWNoKHRoaXMuJHBhcnNlcnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxTZXQoJHNjb3BlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIG1vZGVsIC0+IHZhbHVlCiAgICAgICAgICAgIHZhciBjdHJsID0gdGhpczsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdNb2RlbFdhdGNoKCkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbmdNb2RlbEdldCgkc2NvcGUpOwoKICAgICAgICAgICAgICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgICAgICAgICAgICAgaWYgKGN0cmwuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBmb3JtYXR0ZXJzID0gY3RybC4kZm9ybWF0dGVycywKICAgICAgICAgICAgICAgICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaWR4LS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kdmlld1ZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwKICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSXMgZGlyZWN0aXZlIHRoYXQgdGVsbHMgQW5ndWxhciB0byBkbyB0d28td2F5IGRhdGEgYmluZGluZy4gSXQgd29ya3MgdG9nZXRoZXIgd2l0aCBgaW5wdXRgLAogICAgICogYHNlbGVjdGAsIGB0ZXh0YXJlYWAuIFlvdSBjYW4gZWFzaWx5IHdyaXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMgdG8gdXNlIGBuZ01vZGVsYCBhcyB3ZWxsLgogICAgICoKICAgICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICAgKgogICAgICogLSBiaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAgICogICByZXF1aXJlLAogICAgICogLSBwcm92aWRpbmcgdmFsaWRhdGlvbiBiZWhhdmlvciAoaS5lLiByZXF1aXJlZCwgbnVtYmVyLCBlbWFpbCwgdXJsKSwKICAgICAqIC0ga2VlcGluZyBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKSwKICAgICAqIC0gc2V0dGluZyByZWxhdGVkIGNzcyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApLAogICAgICogLSByZWdpc3RlciB0aGUgY29udHJvbCB3aXRoIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICAgKgogICAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAgICoKICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dCB0ZXh0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94IGNoZWNrYm94fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvIHJhZGlvfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlciBudW1iZXJ9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQuZW1haWwgZW1haWx9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudXJsIHVybH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICAgKgogICAgICovCiAgICB2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybUN0cmwuJHJlbW92ZUNvbnRyb2wobW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hhbmdlCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHVzZXIgY2hhbmdlcyB0aGUgaW5wdXQuCiAgICAgKiBUaGUgZXhwcmVzc2lvbiBpcyBub3QgZXZhbHVhdGVkIHdoZW4gdGhlIHZhbHVlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSB0aGUgbW9kZWwuCiAgICAgKgogICAgICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPGRvYzpleGFtcGxlPgogICAgICogICA8ZG9jOnNvdXJjZT4KICAgICAqICAgICA8c2NyaXB0PgogICAgICogICAgICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICogICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7CiAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICB9OwogKiAgICAgICB9CiAgICAgKiAgICAgPC9zY3JpcHQ+CiAgICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICAgICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgICAqICAgICAgIGRlYnVnID0ge3tjb25maXJtZWR9fTxiciAvPgogICAgICogICAgICAgY291bnRlciA9IHt7Y291bnRlcn19CiAgICAgKiAgICAgPC9kaXY+CiAgICAgKiAgIDwvZG9jOnNvdXJjZT4KICAgICAqICAgPGRvYzpzY2VuYXJpbz4KICAgICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTEnKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcxJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMicpLmNsaWNrKCk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudGVyJykpLnRvRXF1YWwoJzAnKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbmZpcm1lZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAqICAgICB9KTsKICAgICAqICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgKiA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKICAgIHZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIChpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA9PT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdMaXN0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBjb21tYS1zZXBhcmF0ZWQgc3RyaW5nIGludG8gYW4gYXJyYXkgb2Ygc3RyaW5ncy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAgICogICBzcGVjaWZpZWQgaW4gZm9ybSBgL3NvbWV0aGluZy9gIHRoZW4gdGhlIHZhbHVlIHdpbGwgYmUgY29udmVydGVkIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtaXNrbycsICd2b2p0YSddOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHR0Pm5hbWVzID0ge3tuYW1lc319PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5uYW1lc0lucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbImlnb3IiLCJtaXNrbyIsInZvanRhIl0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCduYW1lcycpLmVudGVyKCcnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbXScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0xpc3REaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgICAgICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uICh2aWV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CgogICAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKHRwbCwgdHBsQXR0cikgewogICAgICAgICAgICAgICAgaWYgKENPTlNUQU5UX1ZBTFVFX1JFR0VYUC50ZXN0KHRwbEF0dHIubmdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogICAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAgICoKICAgICAqIE9uZSBzY2VuYXJpbyBpbiB3aGljaCB0aGUgdXNlIG9mIGBuZ0JpbmRgIGlzIHByZWZlcnJlZCBvdmVyIGB7eyBleHByZXNzaW9uIH19YCBiaW5kaW5nIGlzIHdoZW4KICAgICAqIGl0J3MgZGVzaXJhYmxlIHRvIHB1dCBiaW5kaW5ncyBpbnRvIHRlbXBsYXRlIHRoYXQgaXMgbW9tZW50YXJpbHkgZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cwogICAgICogcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlCiAgICAgKiBiaW5kaW5ncyBpbnZpc2libGUgdG8gdGhlIHVzZXIgd2hpbGUgdGhlIHBhZ2UgaXMgbG9hZGluZy4KICAgICAqCiAgICAgKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30gZGlyZWN0aXZlLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBFbnRlciBhIG5hbWUgaW4gdGhlIExpdmUgUHJldmlldyB0ZXh0IGJveDsgdGhlIGdyZWV0aW5nIGJlbG93IHRoZSB0ZXh0IGJveCBjaGFuZ2VzIGluc3RhbnRseS4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1doaXJsZWQnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICBIZWxsbyA8c3BhbiBuZy1iaW5kPSJuYW1lIj48L3NwYW4+IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCdXaGlybGVkJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3dvcmxkJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdCaW5kRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZFRlbXBsYXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICAgICAqIHRleHQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIHRlbXBsYXRlIGluIG5nQmluZFRlbXBsYXRlLgogICAgICogVW5saWtlIG5nQmluZCB0aGUgbmdCaW5kVGVtcGxhdGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAgICAgKiBleHByZXNzaW9ucy4gKFRoaXMgaXMgcmVxdWlyZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAgICAgKiBjYW4gbm90IGhhdmUgU1BBTiBlbGVtZW50cyBzdWNoIGFzIFRJVExFLCBvciBPUFRJT04gdG8gbmFtZSBhIGZldy4pCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1dvcmxkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS4KICAgICAgICAgICB0b0JlKCdXb3JsZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnc2FsdXRhdGlvbicpLmVudGVyKCdHcmVldGluZ3MnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcigndXNlcicpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdHcmVldGluZ3MnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgdG9CZSgndXNlcicpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWxVbnNhZmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAgICogZWxlbWVudC4gKlRoZSBpbm5lckhUTUwtZWQgY29udGVudCB3aWxsIG5vdCBiZSBzYW5pdGl6ZWQhKiBZb3Ugc2hvdWxkIHVzZSB0aGlzIGRpcmVjdGl2ZSBvbmx5IGlmCiAgICAgKiB7QGxpbmsgbmdTYW5pdGl6ZS5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgaXMgdG9vCiAgICAgKiByZXN0cmljdGl2ZSBhbmQgd2hlbiB5b3UgYWJzb2x1dGVseSB0cnVzdCB0aGUgc291cmNlIG9mIHRoZSBjb250ZW50IHlvdSBhcmUgYmluZGluZyB0by4KICAgICAqCiAgICAgKiBTZWUge0BsaW5rIG5nU2FuaXRpemUuJHNhbml0aXplICRzYW5pdGl6ZX0gZG9jcyBmb3IgZXhhbXBsZXMuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWxVbnNhZmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKi8KICAgIHZhciBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbFVuc2FmZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWxVbnNhZmUsIGZ1bmN0aW9uIG5nQmluZEh0bWxVbnNhZmVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgb2xkVmFsID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdjbGFzcycsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIG5nQ2xhc3MgPSBzY29wZS4kZXZhbChhdHRyW25hbWVdKTsKICAgICAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihuZ0NsYXNzLCBuZ0NsYXNzKTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgaWYgKG5hbWUgIT09ICduZ0NsYXNzJykgewogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCckaW5kZXgnLCBmdW5jdGlvbiAoJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kICE9PSBvbGQkaW5kZXggJiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsIG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Mob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MobmV3VmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9sZFZhbCA9IGNvcHkobmV3VmFsKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNsYXNzKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoY2xhc3NWYWwpICYmICFpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzVmFsID0gbWFwKGNsYXNzVmFsLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgcmV0dXJuIGsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoaXNBcnJheShjbGFzc1ZhbCkgPyBjbGFzc1ZhbC5qb2luKCcgJykgOiBjbGFzc1ZhbCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSAmJiAhaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc1ZhbCA9IG1hcChjbGFzc1ZhbCwgZnVuY3Rpb24gKHYsIGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHJldHVybiBrCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGlzQXJyYXkoY2xhc3NWYWwpID8gY2xhc3NWYWwuam9pbignICcpIDogY2xhc3NWYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzYCBhbGxvd3MgeW91IHRvIHNldCBDU1MgY2xhc3Mgb24gSFRNTCBlbGVtZW50IGR5bmFtaWNhbGx5IGJ5IGRhdGFiaW5kaW5nIGFuCiAgICAgKiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICAgICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgICAgPGJyPgogICAgIDxzcGFuIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm15LWNsYXNzIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246Zmlyc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246bGFzdCcpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzc09kZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fQogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xhc3NFdmVuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogICAgICogICByZXN1bHQgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbG9hawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAgICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0eXBpY2FsbHkgYSBmaW5lLWdyYWluZWQgYXBwbGljYXRpb24gaXMKICAgICAqIHByZWZlcmVkIGluIG9yZGVyIHRvIGJlbmVmaXQgZnJvbSBwcm9ncmVzc2l2ZSByZW5kZXJpbmcgb2YgdGhlIGJyb3dzZXIgdmlldy4KICAgICAqCiAgICAgKiBgbmdDbG9ha2Agd29ya3MgaW4gY29vcGVyYXRpb24gd2l0aCBhIGNzcyBydWxlIHRoYXQgaXMgZW1iZWRkZWQgd2l0aGluIGBhbmd1bGFyLmpzYCBhbmQKICAgICAqICBgYW5ndWxhci5taW4uanNgIGZpbGVzLiBGb2xsb3dpbmcgaXMgdGhlIGNzcyBydWxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiBbbmdcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sIC5uZy1jbG9haywgLngtbmctY2xvYWsgewogKiAgIGRpc3BsYXk6IG5vbmU7CiAqIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICAgICAqIGFyZSB0YWdnZWQgd2l0aCB0aGUgYG5nLWNsb2FrYCBkaXJlY3RpdmUgYXJlIGhpZGRlbi4gV2hlbiBBbmd1bGFyIGNvbWVzIGFjcm9zcyB0aGlzIGRpcmVjdGl2ZQogICAgICogZHVyaW5nIHRoZSBjb21waWxhdGlvbiBvZiB0aGUgdGVtcGxhdGUgaXQgZGVsZXRlcyB0aGUgYG5nQ2xvYWtgIGVsZW1lbnQgYXR0cmlidXRlLCB3aGljaAogICAgICogbWFrZXMgdGhlIGNvbXBpbGVkIGVsZW1lbnQgdmlzaWJsZS4KICAgICAqCiAgICAgKiBGb3IgdGhlIGJlc3QgcmVzdWx0LCBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwgZmlsZTsKICAgICAqIGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSAoYWJvdmUpIG11c3QgYmUgaW5jbHVkZWQgaW4gdGhlIGV4dGVybmFsIHN0eWxlc2hlZXQgb2YgdGhlCiAgICAgKiBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBMZWdhY3kgYnJvd3NlcnMsIGxpa2UgSUU3LCBkbyBub3QgcHJvdmlkZSBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VwcG9ydCAoYWRkZWQgaW4gQ1NTIDIuMSkgc28gdGhleQogICAgICogY2Fubm90IG1hdGNoIHRoZSBgW25nXDpjbG9ha11gIHNlbGVjdG9yLiBUbyB3b3JrIGFyb3VuZCB0aGlzIGxpbWl0YXRpb24sIHlvdSBtdXN0IGFkZCB0aGUgY3NzCiAgICAgKiBjbGFzcyBgbmdDbG9ha2AgaW4gYWRkaXRpb24gdG8gYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcyBzaG93biBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTEnKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3RlbXBsYXRlMicpLmF0dHIoJ25nLWNsb2FrJykpLgogICAgICAgICAgIG5vdCgpLnRvQmVEZWZpbmVkKCk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIG5nQ2xvYWtEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAgICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAgICAgKgogICAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgICAqCiAgICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgZGF0YSBpbiBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICAgKiAqIENvbnRyb2xsZXIg4oCUIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogICAgICogICBtZXRob2RzIHRoYXQgdHlwaWNhbGx5IGV4cHJlc3MgdGhlIGJ1c2luZXNzIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICAgICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAgICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBOb3RpY2UgdGhhdCB0aGUgc2NvcGUgYmVjb21lcyB0aGUgYHRoaXNgIGZvciB0aGUKICAgICAqIGNvbnRyb2xsZXIncyBpbnN0YW5jZS4gVGhpcyBhbGxvd3MgZm9yIGVhc3kgYWNjZXNzIHRvIHRoZSB2aWV3IGRhdGEgZnJvbSB0aGUgY29udHJvbGxlci4gQWxzbwogICAgICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICAgICAqIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAgICAgICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAgICAgICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICAgICAgICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwoKICAgICAkc2NvcGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICBhbGVydCh0aGlzLm5hbWUpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogICAgIH07CgogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogICAgICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICAgICAgICAgIH07CiAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyIj4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICBDb250YWN0OgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJjbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0icmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogICAgIDwvbGk+CiAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY+OmlucHV0JykudmFsKCkpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgyKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBpbnB1dCcpLnZhbCgpKS50b0JlKCcnKTsKCiAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBhOmNvbnRhaW5zKCJhZGQiKScpLmNsaWNrKCk7CiAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgzKSBpbnB1dCcpLnZhbCgpKQogICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUgPSBbZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgICBjb250cm9sbGVyOiAnQCcKICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDc3AKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGVsZW1lbnQgaHRtbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICAgKgogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICoKICAgICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBCeSBhcHBseWluZyBgbmdDc3BgCiAgICAgKiBpdCBpcyBiZSBwb3NzaWJsZSB0byBvcHQgaW50byB0aGUgQ1NQIGNvbXBhdGlibGUgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICAgICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICAgKiBiZSByYWlzZWQuCiAgICAgKgogICAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgIDxwcmU+CiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICRzbmlmZmVyLmNzcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nQ2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICAgKiBlbGVtZW50IGlzIGNsaWNrZWQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICBJbmNyZW1lbnQKICAgICA8L2J1dHRvbj4KICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnY291bnQnKSkudG9CZSgnMCcpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzEnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIC8qCiAgICAgKiBBIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyBjcmVhdGlvbiBvZiBjdXN0b20gb25jbGljayBoYW5kbGVycyB0aGF0IGFyZSBkZWZpbmVkIGFzIGFuZ3VsYXIKICAgICAqIGV4cHJlc3Npb25zIGFuZCBhcmUgY29tcGlsZWQgYW5kIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS4KICAgICAqCiAgICAgKiBFdmVudHMgdGhhdCBhcmUgaGFuZGxlZCB2aWEgdGhlc2UgaGFuZGxlciBhcmUgYWx3YXlzIGNvbmZpZ3VyZWQgbm90IHRvIHByb3BhZ2F0ZSBmdXJ0aGVyLgogICAgICovCiAgICB2YXIgbmdFdmVudERpcmVjdGl2ZXMgPSB7fTsKICAgIGZvckVhY2goCiAgICAgICAgJ2NsaWNrIGRibGNsaWNrIG1vdXNlZG93biBtb3VzZXVwIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZW1vdmUgbW91c2VlbnRlciBtb3VzZWxlYXZlJy5zcGxpdCgnICcpLAogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgbmFtZSk7CiAgICAgICAgICAgIG5nRXZlbnREaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZChsb3dlcmNhc2UobmFtZSksIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6IGV2ZW50fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfV07CiAgICAgICAgfQogICAgKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0RibGNsaWNrCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nRGJsY2xpY2tgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGRibGNsaWNrIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0RibGNsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGRibGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2Vkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWRvd24uIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZXVwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2V1cC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VvdmVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW92ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VvdmVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlb3Zlci4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlZW50ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZW50ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VlbnRlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWVudGVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VsZWF2ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlbGVhdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW1vdmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbW92ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW1vdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2Vtb3ZlLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3VibWl0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAgICAgKgogICAgICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICAgICAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgJHNjb3BlLnN1Ym1pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy50ZXh0KSB7CiAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICB0aGlzLnRleHQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idGV4dCIgbmFtZT0idGV4dCIgLz4KICAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiBpZD0ic3VibWl0IiB2YWx1ZT0iU3VibWl0IiAvPgogICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbXScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICAgIGV4cGVjdChpbnB1dCgndGV4dCcpLnZhbCgpKS50b0JlKCcnKTsKICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbImhlbGxvIl0nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1N1Ym1pdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICBlbGVtZW50LmJpbmQoJ3N1Ym1pdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGF0dHJzLm5nU3VibWl0KTsKICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQHJlc3RyaWN0IEVDQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmV0Y2hlcywgY29tcGlsZXMgYW5kIGluY2x1ZGVzIGFuIGV4dGVybmFsIEhUTUwgZnJhZ21lbnQuCiAgICAgKgogICAgICogS2VlcCBpbiBtaW5kIHRoYXQgU2FtZSBPcmlnaW4gUG9saWN5IGFwcGxpZXMgdG8gaW5jbHVkZWQgcmVzb3VyY2VzCiAgICAgKiAoZS5nLiBuZ0luY2x1ZGUgd29uJ3Qgd29yayBmb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzIG9uIGFsbCBicm93c2VycyBhbmQgZm9yCiAgICAgKiAgZmlsZTovLyBhY2Nlc3Mgb24gc29tZSBicm93c2VycykuCiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nSW5jbHVkZXxzcmMgYW5ndWxhciBleHByZXNzaW9uIGV2YWx1YXRpbmcgdG8gVVJMLiBJZiB0aGUgc291cmNlIGlzIGEgc3RyaW5nIGNvbnN0YW50LAogICAgICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBuZXcgcGFydGlhbCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICAgICAqICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbH0gdG8gc2Nyb2xsIHRoZSB2aWV3cG9ydCBhZnRlciB0aGUgY29udGVudCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gSWYgdGhlIGF0dHJpYnV0ZSBpcyBzZXQgd2l0aG91dCB2YWx1ZSwgZW5hYmxlIHNjcm9sbGluZy4KICAgICAqICAgICAgICAgICAgICAgICAgLSBPdGhlcndpc2UgZW5hYmxlIHNjcm9sbGluZyBvbmx5IGlmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnV0aHkgdmFsdWUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICB1cmwgb2YgdGhlIHRlbXBsYXRlOiA8dHQ+e3t0ZW1wbGF0ZS51cmx9fTwvdHQ+CiAgICAgPGhyLz4KICAgICA8ZGl2IG5nLWluY2x1ZGUgc3JjPSJ0ZW1wbGF0ZS51cmwiPjwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICBbIHsgbmFtZTogJ3RlbXBsYXRlMS5odG1sJywgdXJsOiAndGVtcGxhdGUxLmh0bWwnfQogICAgICAgICAgLCB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMS5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMi5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUxLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMS5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgc2VsZWN0KCd0ZW1wbGF0ZScpLm9wdGlvbignMScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkuCiAgICAgICAgIHRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwvKTsKICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gYmxhbmsnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJycpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkudG9FcXVhbCgnJyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50TG9hZGVkCiAgICAgKiBAZXZlbnRPZiBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlCiAgICAgKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIGN1cnJlbnQgbmdJbmNsdWRlIHNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVsb2FkZWQuCiAgICAgKi8KICAgIHZhciBuZ0luY2x1ZGVEaXJlY3RpdmUgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRhbmNob3JTY3JvbGwnLCAnJGNvbXBpbGUnLAogICAgICAgIGZ1bmN0aW9uICgkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsZWFyQ29udGVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goc3JjRXhwLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTY29wZSkgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShjaGlsZFNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgKCFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkID09PSBjaGFuZ2VDb3VudGVyKSBjbGVhckNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbml0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSW5pdGAgZGlyZWN0aXZlIHNwZWNpZmllcyBpbml0aWFsaXphdGlvbiB0YXNrcyB0byBiZSBleGVjdXRlZAogICAgICogIGJlZm9yZSB0aGUgdGVtcGxhdGUgZW50ZXJzIGV4ZWN1dGlvbiBtb2RlIGR1cmluZyBib290c3RyYXAuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSW5pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZ3JlZXRpbmc9J0hlbGxvJzsgcGVyc29uPSdXb3JsZCciPgogICAgIHt7Z3JlZXRpbmd9fSB7e3BlcnNvbn19IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgZ3JlZXRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2dyZWV0aW5nJykpLnRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZXJzb24nKSkudG9CZSgnV29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICAgICAqIGJ5IGFuZ3VsYXIuIFVzZSBgbmdOb25CaW5kYWJsZWAgdG8gbWFrZSBhbmd1bGFyIGlnbm9yZSBhIGNodW5rIG9mIEhUTUwuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICAgICAqIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgIDxkaXYgbmctbm9uLWJpbmRhYmxlPklnbm9yZWQ6IHt7MSArIDJ9fTwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctbm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCcxICsgMicpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCdkaXY6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgdG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsgdGVybWluYWw6IHRydWUsIHByaW9yaXR5OiAxMDAwIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUGx1cmFsaXplCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICMgT3ZlcnZpZXcKICAgICAqIGBuZ1BsdXJhbGl6ZWAgaXMgYSBkaXJlY3RpdmUgdGhhdCBkaXNwbGF5cyBtZXNzYWdlcyBhY2NvcmRpbmcgdG8gZW4tVVMgbG9jYWxpemF0aW9uIHJ1bGVzLgogICAgICogVGhlc2UgcnVsZXMgYXJlIGJ1bmRsZWQgd2l0aCBhbmd1bGFyLmpzIGFuZCB0aGUgcnVsZXMgY2FuIGJlIG92ZXJyaWRkZW4KICAgICAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogICAgICogYnkgc3BlY2lmeWluZyB0aGUgbWFwcGluZ3MgYmV0d2VlbgogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogICAgICogcGx1cmFsIGNhdGVnb3JpZXN9IGFuZCB0aGUgc3RyaW5ncyB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKgogICAgICogIyBQbHVyYWwgY2F0ZWdvcmllcyBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzCiAgICAgKiBUaGVyZSBhcmUgdHdvCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllc30gaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBXaGlsZSBhIHB1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBZb3Ugd2lsbCBzZWUgdGhlIHVzZSBvZiBwbHVyYWwgY2F0ZWdvcmllcwogICAgICogYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcyB0aHJvdWdob3V0IGxhdGVyIHBhcnRzIG9mIHRoaXMgZG9jdW1lbnRhdGlvbi4KICAgICAqCiAgICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplCiAgICAgKiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGJ5IHByb3ZpZGluZyAyIGF0dHJpYnV0ZXM6IGBjb3VudGAgYW5kIGB3aGVuYC4KICAgICAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGF0dHJpYnV0ZSwgYG9mZnNldGAuCiAgICAgKgogICAgICogVGhlIHZhbHVlIG9mIHRoZSBgY291bnRgIGF0dHJpYnV0ZSBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uCiAgICAgKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICAgKgogICAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdCBzbyB0aGF0IEFuZ3VsYXIKICAgICAqIGNhbiBpbnRlcnByZXQgaXQgY29ycmVjdGx5LgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY29uZmlndXJlIG5nUGx1cmFsaXplOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICogPC9uZy1wbHVyYWxpemU+CiAgICAgKjwvcHJlPgogICAgICoKICAgICAqIEluIHRoZSBleGFtcGxlLCBgIjA6IE5vYm9keSBpcyB2aWV3aW5nLiJgIGlzIGFuIGV4cGxpY2l0IG51bWJlciBydWxlLiBJZiB5b3UgZGlkIG5vdAogICAgICogc3BlY2lmeSB0aGlzIHJ1bGUsIDAgd291bGQgYmUgbWF0Y2hlZCB0byB0aGUgIm90aGVyIiBjYXRlZ29yeSBhbmQgIjAgcGVvcGxlIGFyZSB2aWV3aW5nIgogICAgICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAgICAgKiBvdGhlciBudW1iZXJzLCBmb3IgZXhhbXBsZSAxMiwgc28gdGhhdCBpbnN0ZWFkIG9mIHNob3dpbmcgIjEyIHBlb3BsZSBhcmUgdmlld2luZyIsIHlvdSBjYW4KICAgICAqIHNob3cgImEgZG96ZW4gcGVvcGxlIGFyZSB2aWV3aW5nIi4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBhIHNldCBvZiBjbG9zZWQgYnJhY2VzKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogICAgICogaW50byBwbHVyYWxpemVkIHN0cmluZ3MuIEluIHRoZSBwcmV2aW91cyBleGFtcGxlLCBBbmd1bGFyIHdpbGwgcmVwbGFjZSBge31gIHdpdGgKICAgICAqIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT5ge3twZXJzb25Db3VudH19YDwvc3Bhbj4uIFRoZSBjbG9zZWQgYnJhY2VzIGB7fWAgaXMgYSBwbGFjZWhvbGRlcgogICAgICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZSB3aXRoIG9mZnNldAogICAgICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogICAgICogYSBiZXR0ZXIgdXNlciBleHBlcmllbmNlLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiB0aGUgbWVzc2FnZSAiNCBwZW9wbGUgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIsCiAgICAgKiB5b3UgbWlnaHQgZGlzcGxheSAiSm9obiwgS2F0ZSBhbmQgMiBvdGhlcnMgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIuCiAgICAgKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICAgICAqIExldCdzIHRha2UgYSBsb29rIGF0IGFuIGV4YW1wbGU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAgICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICAgKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAgICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAgICogaXMgc2hvd24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICAgKiBudW1iZXJzIGZyb20gMCB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBvZmZzZXQuIElmIHlvdSB1c2UgYW4gb2Zmc2V0IG9mIDMsIGZvciBleGFtcGxlLAogICAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZGVkIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvZGluZyBzdHJpbmdzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAkc2NvcGUucGVyc29uQ291bnQgPSAxOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgUGVyc29uIDE6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24xIiB2YWx1ZT0iSWdvciIgLz48YnIvPgogICAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgICAgTnVtYmVyIG9mIFBlb3BsZTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbkNvdW50IiB2YWx1ZT0iMSIgLz48YnIvPgoKICAgICA8IS0tLSBFeGFtcGxlIHdpdGggc2ltcGxlIHBsdXJhbGl6YXRpb24gcnVsZXMgZm9yIGVuIGxvY2FsZSAtLS0+CiAgICAgV2l0aG91dCBPZmZzZXQ6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPjxicj4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIG9mZnNldCAtLS0+CiAgICAgV2l0aCBPZmZzZXQoMik6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgc2hvdyBjb3JyZWN0IHBsdXJhbGl6ZWQgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignMCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzMnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHNob3cgZGF0YS1iaW5kZWQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uMScpLmVudGVyKCdEaScpOwogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjInKS5lbnRlcignVm9qdGEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgdG9CZSgnRGksIFZvanRhIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBCUkFDRSA9IC97fS9nOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJFeHAgPSBhdHRyLmNvdW50LAogICAgICAgICAgICAgICAgICAgIHdoZW5FeHAgPSBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci53aGVuKSwgLy8gdGhpcyBpcyBiZWNhdXNlIHdlIGhhdmUge3t9fSBpbiBhdHRycwogICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGF0dHIub2Zmc2V0IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgd2hlbnMgPSBzY29wZS4kZXZhbCh3aGVuRXhwKSwKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZucyA9IHt9LAogICAgICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpOwoKICAgICAgICAgICAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgICAgICAgICAgICAgJGludGVycG9sYXRlKGV4cHJlc3Npb24ucmVwbGFjZShCUkFDRSwgc3RhcnRTeW1ib2wgKyBudW1iZXJFeHAgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICAgICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAgICoKICAgICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAgICoKICAgICAqICAgKiBgJGluZGV4YCDigJMgYHtudW1iZXJ9YCDigJMgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkKICAgICAqICAgKiBgJGZpcnN0YCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbWlkZGxlYCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbGFzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFR3bwogICAgICogICBmb3JtYXRzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOgogICAgICoKICAgICAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgaXMgYSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAgICAgKgogICAgICogICAgIEZvciBleGFtcGxlOiBgdHJhY2sgaW4gY2QudHJhY2tzYC4KICAgICAqCiAgICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICAgKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBpbml0aWFsaXplcyB0aGUgc2NvcGUgdG8gYSBsaXN0IG9mIG5hbWVzIGFuZAogICAgICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIGFnZToyNX0sIHtuYW1lOidNYXJ5JywgYWdlOjI4fV0iPgogICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXJlcGVhdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIHZhciByID0gdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykucmVwZWF0ZXIoJ3VsIGxpJyk7CiAgICAgICAgICAgZXhwZWN0KHIuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMCkpLnRvRXF1YWwoWyIxIiwiSm9obiIsIjI1Il0pOwogICAgICAgICAgIGV4cGVjdChyLnJvdygxKSkudG9FcXVhbChbIjIiLCJNYXJ5IiwiMjgiXSk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBpdGVyU3RhcnRFbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IGF0dHIubmdSZXBlYXQ7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKC9eXHMqKC4rKVxzK2luXHMrKC4qKVxzKiQvKSwKICAgICAgICAgICAgICAgICAgICBsaHMsIHJocywgdmFsdWVJZGVudCwga2V5SWRlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIG5nUmVwZWF0IGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uICsgIicuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaHMgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgbWF0Y2ggPSBsaHMubWF0Y2goL14oPzooW1wkXHddKyl8XCgoW1wkXHddKylccyosXHMqKFtcJFx3XSspXCkpJC8pOwogICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCInaXRlbScgaW4gJ2l0ZW0gaW4gY29sbGVjdGlvbicgc2hvdWxkIGJlIGlkZW50aWZpZXIgb3IgKGtleSwgdmFsdWUpIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBsaHMgKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlSWRlbnQgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIGtleUlkZW50ID0gbWF0Y2hbMl07CgogICAgICAgICAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAgICAgICAgIC8vIGl0ZXJhdG9yLCBhbmQgdGhlIHZhbHVlIGlzIGFuIGFycmF5IG9mIG9iamVjdHMgd2l0aCBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgICAgICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAgICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgICAgICAgICAgLy8gICAtIGluZGV4OiBwb3NpdGlvbgogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCBhbiBhcnJheSBvZiB0aGVzZSBvYmplY3RzIHNpbmNlIHRoZSBzYW1lIG9iamVjdCBjYW4gYmUgcmV0dXJuZWQgZnJvbSB0aGUgaXRlcmF0b3IuCiAgICAgICAgICAgICAgICAvLyBXZSBleHBlY3QgdGhpcyB0byBiZSBhIHJhcmUgY2FzZS4KICAgICAgICAgICAgICAgIHZhciBsYXN0T3JkZXIgPSBuZXcgSGFzaFF1ZXVlTWFwKCk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUmVwZWF0V2F0Y2goc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXgsIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHNjb3BlLiRldmFsKHJocyksCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGl0ZXJTdGFydEVsZW1lbnQsICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgICAgICAgLy8gU2FtZSBhcyBsYXN0T3JkZXIgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdE9yZGVyIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyID0gbmV3IEhhc2hRdWV1ZU1hcCgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCAvLyBrZXkvdmFsdWUgb2YgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0OyAgICAgICAvLyBsYXN0IG9iamVjdCBpbmZvcm1hdGlvbiB7c2NvcGUsIGVsZW1lbnQsIGluZGV4fQoKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG9iamVjdCwgZXh0cmFjdCBrZXlzLCBzb3J0IHRoZW0gYW5kIHVzZSB0byBkZXRlcm1pbmUgb3JkZXIgb2YgaXRlcmF0aW9uIG92ZXIgb2JqIHByb3BzCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkuc29ydCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gY29sbGVjdGlvbiB8fCBbXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGFycmF5Qm91bmQgPSBhcnJheS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgbm90IHVzaW5nIGZvckVhY2ggZm9yIHBlcmYgcmVhc29ucyAodHJ5aW5nIHRvIGF2b2lkICNjYWxsKQogICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBhcnJheSkgPyBpbmRleCA6IGFycmF5W2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gbGFzdE9yZGVyLnNoaWZ0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzb2NpYXRlZCBzY29wZS9lbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbGFzdC5zY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlci5wdXNoKHZhbHVlLCBsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IGxhc3QuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleGlzdGluZyBpdGVtIHdoaWNoIGdvdCBtb3ZlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1heSBiZSBhIG5vb3AsIGlmIHRoZSBlbGVtZW50IGlzIG5leHQsIGJ1dCBJIGRvbid0IGtub3cgb2YgYSBnb29kIHdheSB0bwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpZ3VyZSB0aGlzIG91dCwgIHNpbmNlIGl0IHdvdWxkIHJlcXVpcmUgZXh0cmEgRE9NIGFjY2Vzcywgc28gbGV0J3MganVzdCBob3BlIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgYnJvd3NlcnMgcmVhbGl6ZXMgdGhhdCBpdCBpcyBub29wLCBhbmQgdHJlYXRzIGl0IGFzIHN1Y2guCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmFmdGVyKGxhc3QuZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmV3IGl0ZW0gd2hpY2ggd2UgZG9uJ3Qga25vdyBhYm91dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnQpIGNoaWxkU2NvcGVba2V5SWRlbnRdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRpbmRleCA9IGluZGV4OwoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSBhcnJheUJvdW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kbWlkZGxlID0gIShjaGlsZFNjb3BlLiRmaXJzdCB8fCBjaGlsZFNjb3BlLiRsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua2VyKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGNoaWxkU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IChjdXJzb3IgPSBjbG9uZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vc2hyaW5rIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbGFzdE9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0T3JkZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBsYXN0T3JkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChhcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFycmF5LnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGFzdE9yZGVyID0gbmV4dE9yZGVyOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTaG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGRpcmVjdGl2ZXMgc2hvdyBvciBoaWRlIGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Nob3cgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeQogICAgICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPiA8YnIvPgogICAgIEhpZGU6IDxzcGFuIG5nLWhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwoKICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KLy9UT0RPKG1pc2tvKTogcmVmYWN0b3IgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSB0aGUgRE9NCiAgICB2YXIgbmdTaG93RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICBlbGVtZW50LmNzcygnZGlzcGxheScsIHRvQm9vbGVhbih2YWx1ZSkgPyAnJyA6ICdub25lJyk7CiAgICAgICAgfSk7CiAgICB9KTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIaWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSGlkZWAgYW5kIGBuZ1Nob3dgIGRpcmVjdGl2ZXMgaGlkZSBvciBzaG93IGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICAgKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+IDxici8+CiAgICAgSGlkZTogPHNwYW4gbmctaGlkZT0iY2hlY2tlZCI+SSBoaWRlIHdoZW4geW91IGNoZWNrYm94IGlzIGNoZWNrZWQ/PC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCi8vVE9ETyhtaXNrbyk6IHJlZmFjdG9yIHRvIHJlbW92ZSBlbGVtZW50IGZyb20gdGhlIERPTQogICAgdmFyIG5nSGlkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odmFsdWUpID8gJ25vbmUnIDogJycpOwogICAgICAgIH0pOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTdHlsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAgICAgKiAgICAgIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogICAgICogICAgICBrZXlzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlTdHlsZT17fSI+CiAgICAgPGJyLz4KICAgICA8c3BhbiBuZy1zdHlsZT0ibXlTdHlsZSI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPHByZT5teVN0eWxlPXt7bXlTdHlsZX19PC9wcmU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigwLCAwLCAwKScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPXNldF0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDI1NSwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1jbGVhcl0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdTdHlsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU3R5bGUsIGZ1bmN0aW9uIG5nU3R5bGVXYXRjaEFjdGlvbihuZXdTdHlsZXMsIG9sZFN0eWxlcykgewogICAgICAgICAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gob2xkU3R5bGVzLCBmdW5jdGlvbiAodmFsLCBzdHlsZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY3NzKHN0eWxlLCAnJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3U3R5bGVzKSBlbGVtZW50LmNzcyhuZXdTdHlsZXMpOwogICAgICAgIH0sIHRydWUpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29uZGl0aW9uYWxseSBjaGFuZ2UgdGhlIERPTSBzdHJ1Y3R1cmUuCiAgICAgKgogICAgICogQHVzYWdlCiAgICAgKiA8QU5ZIG5nLXN3aXRjaD0iZXhwcmVzc2lvbiI+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTIiPi4uLjwvQU5ZPgogICAgICogICAuLi4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgICAqIDwvQU5ZPgogICAgICoKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAgICAgKiBAcGFyYW1EZXNjcmlwdGlvbgogICAgICogT24gY2hpbGQgZWxtZW50cyBhZGQ6CiAgICAgKgogICAgICogKiBgbmdTd2l0Y2hXaGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogICAgICogICBjYXNlIHdpbGwgYmUgZGlzcGxheWVkLgogICAgICogKiBgbmdTd2l0Y2hEZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc3NlcyBtYXRjaC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0ic2VsZWN0aW9uIiBuZy1vcHRpb25zPSJpdGVtIGZvciBpdGVtIGluIGl0ZW1zIj4KICAgICA8L3NlbGVjdD4KICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1zd2l0Y2ggb249InNlbGVjdGlvbiIgPgogICAgIDxkaXYgbmctc3dpdGNoLXdoZW49InNldHRpbmdzIj5TZXR0aW5ncyBEaXY8L2Rpdj4KICAgICA8c3BhbiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9zcGFuPgogICAgIDxzcGFuIG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L3NwYW4+CiAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ2hvbWUnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHNlbGVjdCBkZWFmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIE5HX1NXSVRDSCA9ICduZy1zd2l0Y2gnOwogICAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgICAgcmVxdWlyZTogJ25nU3dpdGNoJywKICAgICAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsIGZ1bmN0aW9uIG5nU3dpdGNoQ29udHJvbGxlcigpIHsKICAgICAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICAgIH1dLAogICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICB2YXIgd2F0Y2hFeHByID0gYXR0ci5uZ1N3aXRjaCB8fCBhdHRyLm9uLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LAogICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZTsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaEV4cHIsIGZ1bmN0aW9uIG5nU3dpdGNoV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCA9IHNlbGVjdGVkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGUgPSBjdHJsLmNhc2VzWychJyArIHZhbHVlXSB8fCBjdHJsLmNhc2VzWyc/J10pKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uIChjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBjYXNlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRycywgdHJhbnNjbHVkZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gPSB0cmFuc2NsdWRlOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiA1MDAsCiAgICAgICAgcmVxdWlyZTogJ15uZ1N3aXRjaCcsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGN0cmwuY2FzZXNbJz8nXSA9IHRyYW5zY2x1ZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnNlcnQgdGhlIHRyYW5zY2x1ZGVkIERPTSBoZXJlLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0idHJhbnNjbHVkZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnTmVxdWUgcG9ycm8gcXVpc3F1YW0gZXN0IHF1aSBkb2xvcmVtIGlwc3VtIHF1aWEgZG9sb3IuLi4nOwogICAgICAgICB9CgogICAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlJywgW10pCiAgICAgLmRpcmVjdGl2ZSgncGFuZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgICAgICBzY29wZTogJ2lzb2xhdGUnLAogICAgICAgICAgICAgICBsb2NhbHM6IHsgdGl0bGU6J2JpbmQnIH0sCiAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGdyYXkiPnt7dGl0bGV9fTwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgIH07CiAgICAgICAgIH0pOwogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICA8cGFuZSB0aXRsZT0ie3t0aXRsZX19Ij57e3RleHR9fTwvcGFuZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGhhdmUgdHJhbnNjbHVkZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd0aXRsZScpLmVudGVyKCdUSVRMRScpOwogICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignVEVYVCcpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RpdGxlJykpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29udHJvbGxlcjogWyckdHJhbnNjbHVkZScsICckZWxlbWVudCcsIGZ1bmN0aW9uICgkdHJhbnNjbHVkZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHRyYW5zY2x1ZGUoZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3CiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdWaWV3YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGNvbXBsZW1lbnRzIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZSBieQogICAgICogaW5jbHVkaW5nIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvZiB0aGUgY3VycmVudCByb3V0ZSBpbnRvIHRoZSBtYWluIGxheW91dCAoYGluZGV4Lmh0bWxgKSBmaWxlLgogICAgICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogICAgICogY29uZmlndXJhdGlvbiBvZiB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgIENob29zZToKICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgIDxociAvPgoKICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdib29rLmh0bWwnLAogICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bAogICAgICAgICAgfSk7CiAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQ2hhcHRlckNudGwKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpOwogICAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAkc2NvcGUuJGxvY2F0aW9uID0gJGxvY2F0aW9uOwogICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJCb29rQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KCiAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCdhOmNvbnRhaW5zKCJNb2J5OiBDaDEiKScpLmNsaWNrKCk7CiAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9Cb29rIElkXDogTW9ieS8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3IyR2aWV3Q29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nVmlldyBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nVmlldyBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdWaWV3RGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcm91dGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsCiAgICAgICAgJyRjb250cm9sbGVyJywKICAgICAgICBmdW5jdGlvbiAoJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcm91dGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlLCAkY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJzsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJG9uKCckcm91dGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUoKTsKCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lMYXN0U2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0U2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJDb250ZW50KCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95TGFzdFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSAkcm91dGUuY3VycmVudCAmJiAkcm91dGUuY3VycmVudC5sb2NhbHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGxvY2FscyAmJiBsb2NhbHMuJHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdHJveUxhc3RTY29wZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gJHJvdXRlLmN1cnJlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUgPSBjdXJyZW50LnNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGUgPSBsYXN0U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGN1cnJlbnQuY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxhc3RTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGVtaXQoJyR2aWV3Q29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gJGFuY2hvclNjcm9sbCBtaWdodCBsaXN0ZW4gb24gZXZlbnQuLi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNjcmlwdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTG9hZCBjb250ZW50IG9mIGEgc2NyaXB0IHRhZywgd2l0aCB0eXBlIGB0ZXh0L25nLXRlbXBsYXRlYCwgaW50byBgJHRlbXBsYXRlQ2FjaGVgLCBzbyB0aGF0IHRoZQogICAgICogdGVtcGxhdGUgY2FuIGJlIHVzZWQgYnkgYG5nSW5jbHVkZWAsIGBuZ1ZpZXdgIG9yIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogQHJlc3RyaWN0IEUKICAgICAqIEBwYXJhbSB7J3RleHQvbmctdGVtcGxhdGUnfSB0eXBlIG11c3QgYmUgc2V0IHRvIGAndGV4dC9uZy10ZW1wbGF0ZSdgCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0iL3RwbC5odG1sIj4KICAgICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgICA8L3NjcmlwdD4KCiAgICAgPGEgbmctY2xpY2s9ImN1cnJlbnRUcGw9Jy90cGwuaHRtbCciIGlkPSJ0cGwtbGluayI+TG9hZCBpbmxpbmVkIHRlbXBsYXRlPC9hPgogICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KCcjdHBsLWxpbmsnKS5jbGljaygpOwogICAgICAgIGV4cGVjdChlbGVtZW50KCcjdHBsLWNvbnRlbnQnKS50ZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24gKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2VsZWN0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogIyBgbmdPcHRpb25zYAogICAgICoKICAgICAqIE9wdGlvbmFsbHkgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAgICAgKiBlbGVtZW50cyBmb3IgYSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgYW4gYXJyYXkgb3IgYW4gb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICAgKiBgbmdPcHRpb25zYCBleHByZXNzaW9uLgogICAgICrLncudCiAgICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIHNlbGVjdCBtZW51IGlzIHNlbGVjdCwgdGhlIHZhbHVlIG9mIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICAgKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogICAgICogZGlyZWN0aXZlIG9mIHRoZSBwYXJlbnQgc2VsZWN0IGVsZW1lbnQuCiAgICAgKgogICAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAgICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAgICoKICAgICAqIE5vdGU6IGBuZ09wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogICAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBjdXJyZW50bHkKICAgICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgb25seS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICAgICAqCiAgICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICAgKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqCiAgICAgKiBXaGVyZToKICAgICAqCiAgICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAgICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAgICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICAgKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogICAgICogICAgICBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIE15Q250cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgJHNjb3BlLmNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbG9yIGluIGNvbG9ycyI+CiAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnNwbGljZSgkaW5kZXgsIDEpIj5YPC9hPl0KICAgICA8L2xpPgogICAgIDxsaT4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8aHIvPgogICAgIENvbG9yIChudWxsIG5vdCBhbGxvd2VkKToKICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+PC9zZWxlY3Q+PGJyPgoKICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDwvc3Bhbj48YnIvPgoKICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZ3JvdXAgYnkgYy5zaGFkZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICBTZWxlY3QgPGEgaHJlZiBuZy1jbGljaz0iY29sb3I9e25hbWU6J25vdCBpbiBsaXN0J30iPmJvZ3VzPC9hPi48YnI+CiAgICAgPGhyLz4KICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpjb2xvcn0gIH19CiAgICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgICAgbmctc3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6Y29sb3IubmFtZX0iPgogICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIHNlbGVjdCgnY29sb3InKS5vcHRpb24oJzAnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdudWxsJyk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICB2YXIgbmdPcHRpb25zRGlyZWN0aXZlID0gdmFsdWVGbih7IHRlcm1pbmFsOiB0cnVlIH0pOwogICAgdmFyIHNlbGVjdERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCAnJHBhcnNlJywgZnVuY3Rpb24gKCRjb21waWxlLCAkcGFyc2UpIHsKICAgICAgICAvLzAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3NzAKICAgICAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKiguKj8pKD86XHMrYXNccysoLio/KSk/KD86XHMrZ3JvdXBccytieVxzKyguKikpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd1xkXSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XGRdKilccyosXHMqKFtcJFx3XVtcJFx3XGRdKilccypcKSkpXHMraW5ccysoLiopJC8sCiAgICAgICAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uICgkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICAgICAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgICAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgICAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAgICAgICAgIC8vIHRvIGNyZWF0ZSBpdCBpbiA8c2VsZWN0PiBhbmQgSUUgYmFyZnMgb3RoZXJ3aXNlLgogICAgICAgICAgICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgICAgICAgICAgICBvcHRHcm91cFRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgIC8vIGZpbmQgIm51bGwiIG9wdGlvbgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpLCBpaSA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW1wdHlPcHRpb24gPSBudWxsT3B0aW9uID0gY2hpbGRyZW4uZXEoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlICYmIChhdHRyLnJlcXVpcmVkIHx8IGF0dHIubmdSZXF1aXJlZCkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZWRWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsICFhdHRyLnJlcXVpcmVkIHx8ICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRwYXJzZXJzLnB1c2gocmVxdWlyZWRWYWxpZGF0b3IpOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRmb3JtYXR0ZXJzLnVuc2hpZnQocmVxdWlyZWRWYWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRWYWxpZGF0b3IobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNFeHApIE9wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlKSBNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFZpZXc7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHNlbGVjdE11bHRpcGxlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKGxhc3RWaWV3LCBjdHJsLiR2aWV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmlldyA9IGNvcHkoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYmluZCgnY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2gob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE9wdGlvbnMoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgICAgICAgICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIG5nT3B0aW9ucyBpbiBmb3JtIG9mICdfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCBnb3QgJyIgKyBvcHRpb25zRXhwICsgIicuIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6ICcnfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuaHRtbCgnJykgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGxhYmVsIGZyb20gdGhlIGVsZW1lbnQuIHd0Zj8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gcmVuZGVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogY2FuJ3Qgd2Ugb3B0aW1pemUgdGhpcyA/CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHJlbmRlcik7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbkdyb3VwcyA9IHsnJzogW119LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IHZhbHVlc1trZXlOYW1lID8gbG9jYWxzW2tleU5hbWVdID0ga2V5c1tpbmRleF0gOiBpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWRTZXQucmVtb3ZlKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4LCAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6ICcnLCBsYWJlbDogJycsIHNlbGVjdGVkOiAhc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDogJz8nLCBsYWJlbDogJycsIHNlbGVjdGVkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uR3JvdXBbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZXhpc3RpbmdPcHRpb24gPSBleGlzdGluZ09wdGlvbnNbaW5kZXggKyAxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdPcHRpb25zLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnBvcCgpLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUR1JPVVBzIGZyb20gc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wb3AoKVswXS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIG9wdGlvbkRpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgICAgICAgICAgYWRkT3B0aW9uOiBub29wLAogICAgICAgICAgICByZW1vdmVPcHRpb246IG5vb3AKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC50ZXh0KCksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgZWxlbWVudC50ZXh0KCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIHN0eWxlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0ZXJtaW5hbDogdHJ1ZQogICAgfSk7CgogICAgLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKICAgIC8vYnV0IHdlIHdpbGwgcmViaW5kIG9uIGJvb3RzdHJhcCBhZ2Fpbi4KICAgIGJpbmRKUXVlcnkoKTsKCiAgICBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcik7CgogICAganFMaXRlKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9ha3tkaXNwbGF5Om5vbmU7fW5nXFw6Zm9ybXtkaXNwbGF5OmJsb2NrO308L3N0eWxlPicpOw==",
                "body": "LyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4wLjcKICogKGMpIDIwMTAtMjAxMiBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogICAgJ3VzZSBzdHJpY3QnOwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IExvd2VyY2FzZWQgc3RyaW5nLgogICAgICovCiAgICB2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gdXBwZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsKICAgIH07CgoKICAgIHZhciBtYW51YWxMb3dlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7CiAgICAgICAgfSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW2Etel0vZywgZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpOwogICAgICAgIH0pCiAgICAgICAgICAgIDogczsKICAgIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICAgIGlmICgnaScgIT09ICdJJy50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICAgIH0KCgogICAgdmFyIC8qKiBob2xkcyBtYWpvciB2ZXJzaW9uIG51bWJlciBmb3IgSUUgb3IgTmFOIGZvciByZWFsIGJyb3dzZXJzICovCiAgICAgICAgICAgIG1zaWUgPSBpbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKSwKICAgICAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICAgICAgalF1ZXJ5LCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZwogICAgICAgIHNsaWNlID0gW10uc2xpY2UsCiAgICAgICAgcHVzaCA9IFtdLnB1c2gsCiAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoKICAgICAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgICAgICAgICBhbmd1bGFyID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCA9IFsnMCcsICcwJywgJzAnXTsKCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBvYmoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywgLi4uKQogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAvLyBXZSBoYXZlIG9uIG9iamVjdCB3aGljaCBoYXMgbGVuZ3RoIHByb3BlcnR5LiBTaG91bGQgd2UgdHJlYXQgaXQgYXMgYXJyYXk/CiAgICAgICAgaWYgKHR5cGVvZiBvYmouaGFzT3duUHJvcGVydHkgIT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgICB0eXBlb2Ygb2JqLmNvbnN0cnVjdG9yICE9ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBoZXJlIGZvciBJRTg6IGl0IGlzIGEgYm9ndXMgb2JqZWN0IHRyZWF0IGl0IGFzIGFycmF5OwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgSlFMaXRlIHx8ICAgICAgICAgICAgICAgICAgICAgIC8vIEpRTGl0ZQogICAgICAgICAgICAgICAgKGpRdWVyeSAmJiBvYmogaW5zdGFuY2VvZiBqUXVlcnkpIHx8ICAgICAgICAgIC8vIGpRdWVyeQogICAgICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChvYmopICE9PSAnW29iamVjdCBPYmplY3RdJyB8fCAgIC8vIHNvbWUgYnJvd3NlciBuYXRpdmUgb2JqZWN0CiAgICAgICAgICAgICAgICB0eXBlb2Ygb2JqLmNhbGxlZSA9PT0gJ2Z1bmN0aW9uJzsgICAgICAgICAgICAgIC8vIGFyZ3VtZW50cyAob24gSUU4IGxvb2tzIGxpa2UgcmVndWxhciBvYmopCiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgICAqIG9iamVjdCBvciBhbiBhcnJheS4gVGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gaXMgaW52b2tlZCB3aXRoIGBpdGVyYXRvcih2YWx1ZSwga2V5KWAsIHdoZXJlIGB2YWx1ZWAKICAgICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIHdhcyBwcmV2aW91c2x5IGtub3duIGFzIGBhbmd1bGFyLmZvcmVhY2hgLgogICAgICoKICAgICA8cHJlPgogICAgIHZhciB2YWx1ZXMgPSB7bmFtZTogJ21pc2tvJywgZ2VuZGVyOiAnbWFsZSd9OwogICAgIHZhciBsb2cgPSBbXTsKICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgIHRoaXMucHVzaChrZXkgKyAnOiAnICsgdmFsdWUpOwogICAgIH0sIGxvZyk7CiAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGl0ZXJhdG9yIEl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIga2V5OwogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPSAncHJvdG90eXBlJyAmJiBrZXkgIT0gJ2xlbmd0aCcgJiYga2V5ICE9ICduYW1lJyAmJiBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChvYmouZm9yRWFjaCAmJiBvYmouZm9yRWFjaCAhPT0gZm9yRWFjaCkgewogICAgICAgICAgICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleXMuc29ydCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvckVhY2hTb3J0ZWQob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciBrZXlzID0gc29ydGVkS2V5cyhvYmopOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrZXlzOwogICAgfQoKCiAgICAvKioKICAgICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCosIHN0cmluZyl9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBpdGVyYXRvckZuKGtleSwgdmFsdWUpCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZSAoaW5kZXgpIHsKICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAgICogQHBhcmFtIGggdGhlIGhhc2hrZXkgKCF0cnV0aHkgdG8gZGVsZXRlIHRoZSBoYXNoa2V5KQogICAgICovCiAgICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAgICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgICAgICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2V0SGFzaEtleShkc3QsIGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICAgICAgfSwge3Byb3RvdHlwZTogcGFyZW50fSkpKCksIGV4dHJhKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIubm9vcAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgICAgPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CgogICAgbm9vcC4kaW5qZWN0ID0gW107CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlkZW50aXR5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGl0cyBmaXJzdCBhcmd1bWVudC4gVGhpcyBmdW5jdGlvbiBpcyB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAgICoKICAgICA8cHJlPgogICAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgaWRlbnRpdHkpKHZhbHVlKTsKICAgICB9OwogICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBpZGVudGl0eSgkKSB7CiAgICAgICAgcmV0dXJuICQ7CiAgICB9CgogICAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyB1bmRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIHVuZGVmaW5lZC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBkZWZpbmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBkZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICd1bmRlZmluZWQnOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc09iamVjdAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAgICAgKiBjb25zaWRlcmVkIHRvIGJlIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogICAgICovCiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNTdHJpbmcKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBTdHJpbmdgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBTdHJpbmdgLgogICAgICovCiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZyc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzTnVtYmVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgTnVtYmVyYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgTnVtYmVyYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0RhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgRGF0ZV0nOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgewogICAgICAgIHJldHVybiB0b1N0cmluZy5hcHBseSh2YWx1ZSkgPT0gJ1tvYmplY3QgQXJyYXldJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNGdW5jdGlvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogICAgICovCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nOwogICAgfQoKCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAgICovCiAgICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai5kb2N1bWVudCAmJiBvYmoubG9jYXRpb24gJiYgb2JqLmFsZXJ0ICYmIG9iai5zZXRJbnRlcnZhbDsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzRmlsZShvYmopIHsKICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdib29sZWFuJzsKICAgIH0KCgogICAgZnVuY3Rpb24gdHJpbSh2YWx1ZSkgewogICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0VsZW1lbnQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUgJiYKICAgICAgICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgICAgICAgICB8fCAobm9kZS5iaW5kICYmIG5vZGUuZmluZCkpOyAgLy8gd2UgaGF2ZSBhIGJpbmQgYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAgICovCiAgICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIG9ialsgaXRlbXNbaV0gXSA9IHRydWU7CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCgogICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgICAgbm9kZU5hbWVfID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50IDogZWxlbWVudFswXTsKICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcpCiAgICAgICAgICAgICAgICA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICBub2RlTmFtZV8gPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9CgoKICAgIGZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICAgICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzIGFuIG9iamVjdCBoYXMsIG9yCiAgICAgKiB0aGUgbGVuZ3RoIG9mIGEgc3RyaW5nLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBhbmd1bGFyLk9iamVjdH0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8c3RyaW5nfSBvYmogT2JqZWN0LCBhcnJheSwgb3Igc3RyaW5nIHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNpemUob2JqLCBvd25Qcm9wc09ubHkpIHsKICAgICAgICB2YXIgc2l6ZSA9IDAsIGtleTsKCiAgICAgICAgaWYgKGlzQXJyYXkob2JqKSB8fCBpc1N0cmluZyhvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBvYmoubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgICAgICAgICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2l6ZTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5jbHVkZXMoYXJyYXksIG9iaikgewogICAgICAgIHJldHVybiBpbmRleE9mKGFycmF5LCBvYmopICE9IC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIG9iaikgewogICAgICAgIGlmIChhcnJheS5pbmRleE9mKSByZXR1cm4gYXJyYXkuaW5kZXhPZihvYmopOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIGZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogICAgICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkKICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgZnVuY3Rpb24gaXNMZWFmTm9kZShub2RlKSB7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJPUFRJT04iOgogICAgICAgICAgICAgICAgY2FzZSAiUFJFIjoKICAgICAgICAgICAgICAgIGNhc2UgIlRJVExFIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuY29weQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogICAgICoKICAgICAqICogSWYgbm8gZGVzdGluYXRpb24gaXMgc3VwcGxpZWQsIGEgY29weSBvZiB0aGUgb2JqZWN0IG9yIGFycmF5IGlzIGNyZWF0ZWQuCiAgICAgKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAgICAgKiAgIGFyZSBkZWxldGVkIGFuZCB0aGVuIGFsbCBlbGVtZW50cy9wcm9wZXJ0aWVzIGZyb20gdGhlIHNvdXJjZSBhcmUgY29waWVkIHRvIGl0LgogICAgICogKiBJZiAgYHNvdXJjZWAgaXMgbm90IGFuIG9iamVjdCBvciBhcnJheSwgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gc291cmNlIFRoZSBzb3VyY2UgdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAgICAgKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxBcnJheSk9fSBkZXN0aW5hdGlvbiBEZXN0aW5hdGlvbiBpbnRvIHdoaWNoIHRoZSBzb3VyY2UgaXMgY29waWVkLiBJZgogICAgICogICAgIHByb3ZpZGVkLCBtdXN0IGJlIG9mIHRoZSBzYW1lIHR5cGUgYXMgYHNvdXJjZWAuCiAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbikgewogICAgICAgIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgdGhyb3cgRXJyb3IoIkNhbid0IGNvcHkgV2luZG93IG9yIFNjb3BlIik7CiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IEVycm9yKCJDYW4ndCBjb3B5IGVxdWl2YWxlbnQgb2JqZWN0cyBvciBhcnJheXMiKTsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24ucHVzaChjb3B5KHNvdXJjZVtpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IGNvcHkoc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0SGFzaEtleShkZXN0aW5hdGlvbiwgaCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICAgICAgICBpZiAoc3JjLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LnN1YnN0cigwLCAyKSAhPT0gJyQkJykgewogICAgICAgICAgICAgICAgZHN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRzdDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZXF1YWxzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgdHdvIG9iamVjdHMgb3IgdHdvIHZhbHVlcyBhcmUgZXF1aXZhbGVudC4gU3VwcG9ydHMgdmFsdWUgdHlwZXMsIGFycmF5cyBhbmQKICAgICAqIG9iamVjdHMuCiAgICAgKgogICAgICogVHdvIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgaWYgYXQgbGVhc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgdHJ1ZToKICAgICAqCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgcGFzcyBgPT09YCBjb21wYXJpc29uLgogICAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBvZiB0aGUgc2FtZSB0eXBlIGFuZCBhbGwgb2YgdGhlaXIgcHJvcGVydGllcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhc1NjcmlwdCwgTmFOID09IE5hTiA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byBOYU4gYXMgZXF1YWwpCiAgICAgKgogICAgICogRHVyaW5nIGEgcHJvcGVydHkgY29tcGFyaXNpb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgICAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICAgICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgIGlmICh0MSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChsZW5ndGggPSBvMS5sZW5ndGgpID09IG8yLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSA9IDA7IGtleSA8IGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG8yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2V5U2V0W2tleV0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbzJba2V5XSAhPT0gdW5kZWZpbmVkICYmICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5jYWxsKHNlbGYpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGluIElFLCBuYXRpdmUgbWV0aG9kcyBhcmUgbm90IGZ1bmN0aW9ucyBzbyB0aGV5IGNhbm5vdCBiZSBib3VuZCAobm90ZTogdGhleSBkb24ndCBuZWVkIHRvIGJlKQogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogICAgfQoKCiAgICBmdW5jdGlvbiB0b0pzb25SZXBsYWNlcihrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIHZhbCA9IHZhbHVlOwoKICAgICAgICBpZiAoL15cJCsvLnRlc3Qoa2V5KSkgewogICAgICAgICAgICB2YWwgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIGlmIChpc1dpbmRvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRXSU5ET1cnOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhbCA9ICckRE9DVU1FTlQnOwogICAgICAgIH0gZWxzZSBpZiAoaXNTY29wZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdmFsID0gJyRTQ09QRSc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci50b0pzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2VyaWFsaXplcyBpbnB1dCBpbnRvIGEgSlNPTi1mb3JtYXR0ZWQgc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcHJldHR5IElmIHNldCB0byB0cnVlLCB0aGUgSlNPTiBvdXRwdXQgd2lsbCBjb250YWluIG5ld2xpbmVzIGFuZCB3aGl0ZXNwYWNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gSnNvbmlmaWVkIHN0cmluZyByZXByZXNlbnRpbmcgYG9iamAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvSnNvbihvYmosIHByZXR0eSkgewogICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmZyb21Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlc2VyaWFsaXplcyBhIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogICAgICogQHJldHVybnMge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZyb21Kc29uKGpzb24pIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcoanNvbikKICAgICAgICAgICAgPyBKU09OLnBhcnNlKGpzb24pCiAgICAgICAgICAgIDoganNvbjsKICAgIH0KCgogICAgZnVuY3Rpb24gdG9Cb29sZWFuKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgICAgICAgICAgdmFsdWUgPSAhKHYgPT0gJ2YnIHx8IHYgPT0gJzAnIHx8IHYgPT0gJ2ZhbHNlJyB8fCB2ID09ICdubycgfHwgdiA9PSAnbicgfHwgdiA9PSAnW10nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGVsZW1lbnQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YXJ0aW5nVGFnKGVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpLmNsb25lKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gdHVybnMgb3V0IElFIGRvZXMgbm90IGxldCB5b3Ugc2V0IC5odG1sKCkgb24gZWxlbWVudHMgd2hpY2gKICAgICAgICAgICAgLy8gYXJlIG5vdCBhbGxvd2VkIHRvIGhhdmUgY2hpbGRyZW4uIFNvIHdlIGp1c3QgaWdub3JlIGl0LgogICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgICAgICAgICAgICBtYXRjaCgvXig8W14+XSs+KS8pWzFdLgogICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24gKG1hdGNoLCBub2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzwnICsgbG93ZXJjYXNlKG5vZGVOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEByZXR1cm5zIE9iamVjdC48KHN0cmluZ3xib29sZWFuKT4KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgICAgICBmb3JFYWNoKChrZXlWYWx1ZSB8fCAiIikuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKGtleVZhbHVlKSB7CiAgICAgICAgICAgIGlmIChrZXlWYWx1ZSkgewogICAgICAgICAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMF0pOwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IGRlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMV0pIDogdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7CiAgICB9CgoKICAgIC8qKgogICAgICogV2UgbmVlZCBvdXIgY3VzdG9tIG1ldGhvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICAgKiBzZWdtZW50czoKICAgICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICAgKiBtZXRob2QgYmVjdWFzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFncmVzc2l2ZSBhbmQgZW5jb2RlcyBzdHVmZiB0aGF0IGRvZXNuJ3QgaGF2ZSB0byBiZQogICAgICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICAgICAqICAgIHF1ZXJ5ICAgICAgID0gKiggcGNoYXIgLyAiLyIgLyAiPyIgKQogICAgICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICAgICAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlVXJpUXVlcnkodmFsLCBwY3RFbmNvZGVTcGFjZXMpIHsKICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkuCiAgICAgICAgICAgIHJlcGxhY2UoLyU0MC9naSwgJ0AnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICByZXBsYWNlKC8lMjQvZywgJyQnKS4KICAgICAgICAgICAgcmVwbGFjZSgvJTJDL2dpLCAnLCcpLgogICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQXBwCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogICAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvIGF1dG8tYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLiBPbmx5CiAgICAgKiBvbmUgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZGlyZWN0aXZlCiAgICAgKiBkZXNpZ25hdGVzIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZAogICAgICogYXQgdGhlIHJvb3Qgb2YgdGhlIHBhZ2UuCiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUgYmVsb3cgaWYgdGhlIGBuZ0FwcGAgZGlyZWN0aXZlIHdvdWxkIG5vdCBiZSBwbGFjZWQKICAgICAqIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZSBkb2N1bWVudCB3b3VsZCBub3QgYmUgY29tcGlsZWQKICAgICAqIGFuZCB0aGUgYHt7IDErMiB9fWAgd291bGQgbm90IGJlIHJlc29sdmVkIHRvIGAzYC4KICAgICAqCiAgICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0IHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICAgKgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBJIGNhbiBhZGQ6IDEgKyAyID0gIHt7IDErMiB9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICAgICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gKG1hdGNoWzJdIHx8ICcnKS5yZXBsYWNlKC9ccysvZywgJywnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIHJlc3VtZUJvb3RzdHJhcEludGVybmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwogICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbiAoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgICAgICAgfV0pOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgICAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICAgICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvcikgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH1dCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RvcjsKICAgICAgICB9OwoKICAgICAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICAgICAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH0KCiAgICAgICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgICAgIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24gKGV4dHJhTW9kdWxlcykgewogICAgICAgICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXN1bWVCb290c3RyYXBJbnRlcm5hbCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CgogICAgZnVuY3Rpb24gc25ha2VfY2FzZShuYW1lLCBzZXBhcmF0b3IpIHsKICAgICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uIChsZXR0ZXIsIHBvcykgewogICAgICAgICAgICByZXR1cm4gKHBvcyA/IHNlcGFyYXRvciA6ICcnKSArIGxldHRlci50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAgICAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICAgICAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgICAgIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogICAgICAgIGlmIChqUXVlcnkpIHsKICAgICAgICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICAgICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgICAgICAgICBzY29wZTogSlFMaXRlUHJvdG90eXBlLnNjb3BlLAogICAgICAgICAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBpbmplY3RvcjogSlFMaXRlUHJvdG90eXBlLmluamVjdG9yLAogICAgICAgICAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlKTsKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2VtcHR5Jyk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganFMaXRlID0gSlFMaXRlOwogICAgICAgIH0KICAgICAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgICB9CgogICAgLyoqCiAgICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgJyIgKyAobmFtZSB8fCAnPycpICsgIicgaXMgIiArIChyZWFzb24gfHwgInJlcXVpcmVkIikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2VydEFyZ0ZuKGFyZywgbmFtZSwgYWNjZXB0QXJyYXlBbm5vdGF0aW9uKSB7CiAgICAgICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgICAgICB9CgogICAgICAgIGFzc2VydEFyZyhpc0Z1bmN0aW9uKGFyZyksIG5hbWUsICdub3QgYSBmdW5jdGlvbiwgZ290ICcgKwogICAgICAgICAgICAoYXJnICYmIHR5cGVvZiBhcmcgPT0gJ29iamVjdCcgPyBhcmcuY29uc3RydWN0b3IubmFtZSB8fCAnT2JqZWN0JyA6IHR5cGVvZiBhcmcpKTsKICAgICAgICByZXR1cm4gYXJnOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGludGVyZmFjZQogICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEludGVyZmFjZSBmb3IgY29uZmlndXJpbmcgYW5ndWxhciB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30uCiAgICAgKi8KCiAgICBmdW5jdGlvbiBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpIHsKCiAgICAgICAgZnVuY3Rpb24gZW5zdXJlKG9iaiwgbmFtZSwgZmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGVuc3VyZShlbnN1cmUod2luZG93LCAnYW5ndWxhcicsIE9iamVjdCksICdtb2R1bGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZSBgYW5ndWxhci5tb2R1bGVgIGlzIGEgZ2xvYmFsIHBsYWNlIGZvciBjcmVhdGluZyBhbmQgcmVnaXN0ZXJpbmcgQW5ndWxhciBtb2R1bGVzLiBBbGwKICAgICAgICAgICAgICogbW9kdWxlcyAoYW5ndWxhciBjb3JlIG9yIDNyZCBwYXJ0eSkgdGhhdCBzaG91bGQgYmUgYXZhaWxhYmxlIHRvIGFuIGFwcGxpY2F0aW9uIG11c3QgYmUKICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB1c2luZyB0aGlzIG1lY2hhbmlzbS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogIyBNb2R1bGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsb2NhdGlvbiBvZiBzZXJ2aWNlcywgZGlyZWN0aXZlcywgZmlsdGVycywgYW5kIGNvbmZpZ3VyYXRpb24gaW5mb3JtYXRpb24uIE1vZHVsZQogICAgICAgICAgICAgKiBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICAgICAgICogbXlNb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGVuIHlvdSBjYW4gY3JlYXRlIGFuIGluamVjdG9yIGFuZCBsb2FkIHlvdXIgbW9kdWxlcyBsaWtlIHRoaXM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIHZhciBpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZycsICdNeU1vZHVsZSddKQogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSG93ZXZlciBpdCdzIG1vcmUgbGlrZWx5IHRoYXQgeW91J2xsIGp1c3QgdXNlCiAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9IG9yCiAgICAgICAgICAgICAqIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0gdG8gc2ltcGxpZnkgdGhpcyBwcm9jZXNzIGZvciB5b3UuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7IXN0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIGNyZWF0ZSBvciByZXRyaWV2ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPj19IHJlcXVpcmVzIElmIHNwZWNpZmllZCB0aGVuIG5ldyBtb2R1bGUgaXMgYmVpbmcgY3JlYXRlZC4gSWYgdW5zcGVjaWZpZWQgdGhlbiB0aGUKICAgICAgICAgICAgICogICAgICAgIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVuc3VyZShtb2R1bGVzLCBuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gbW9kdWxlOiAnICsgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gTGlzdCBvZiBtb2R1bGUgbmFtZXMgd2hpY2ggbXVzdCBiZSBsb2FkZWQgYmVmb3JlIHRoaXMgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgZmlsdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyOiBpbnZva2VMYXRlcignJGZpbHRlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGNvbnRyb2xsZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IGludm9rZUxhdGVyKCckY29udHJvbGxlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGRpcmVjdGl2ZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcnVuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbml0aWFsaXphdGlvbkZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBhZnRlciBpbmplY3RvciBjcmVhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogICAgVXNlZnVsIGZvciBhcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIHNob3VsZCBiZSBwZXJmb3JtZWQgd2hlbiB0aGUgaW5qZWN0b3IgaXMgZG9uZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBsb2FkaW5nIGFsbCBtb2R1bGVzLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcnVuOiBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdmlkZXIKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7YW5ndWxhci5Nb2R1bGV9CiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKgogICAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgICAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgTWlub3IgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjkiLgogICAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgICAqLwogICAgdmFyIHZlcnNpb24gPSB7CiAgICAgICAgZnVsbDogJzEuMC43JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAwLAogICAgICAgIGRvdDogNywKICAgICAgICBjb2RlTmFtZTogJ21vbm9jaHJvbWF0aWMtcmFpbmJvdycKICAgIH07CgoKICAgIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKSB7CiAgICAgICAgZXh0ZW5kKGFuZ3VsYXIsIHsKICAgICAgICAgICAgJ2Jvb3RzdHJhcCc6IGJvb3RzdHJhcCwKICAgICAgICAgICAgJ2NvcHknOiBjb3B5LAogICAgICAgICAgICAnZXh0ZW5kJzogZXh0ZW5kLAogICAgICAgICAgICAnZXF1YWxzJzogZXF1YWxzLAogICAgICAgICAgICAnZWxlbWVudCc6IGpxTGl0ZSwKICAgICAgICAgICAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICAgICAgICAgICAnaW5qZWN0b3InOiBjcmVhdGVJbmplY3RvciwKICAgICAgICAgICAgJ25vb3AnOiBub29wLAogICAgICAgICAgICAnYmluZCc6IGJpbmQsCiAgICAgICAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAgICAgICAnaWRlbnRpdHknOiBpZGVudGl0eSwKICAgICAgICAgICAgJ2lzVW5kZWZpbmVkJzogaXNVbmRlZmluZWQsCiAgICAgICAgICAgICdpc0RlZmluZWQnOiBpc0RlZmluZWQsCiAgICAgICAgICAgICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICAgICAgICAgICAnaXNGdW5jdGlvbic6IGlzRnVuY3Rpb24sCiAgICAgICAgICAgICdpc09iamVjdCc6IGlzT2JqZWN0LAogICAgICAgICAgICAnaXNOdW1iZXInOiBpc051bWJlciwKICAgICAgICAgICAgJ2lzRWxlbWVudCc6IGlzRWxlbWVudCwKICAgICAgICAgICAgJ2lzQXJyYXknOiBpc0FycmF5LAogICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICdpc0RhdGUnOiBpc0RhdGUsCiAgICAgICAgICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAgICAgICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAgICAgICAgICdjYWxsYmFja3MnOiB7Y291bnRlcjogMH0KICAgICAgICB9KTsKCiAgICAgICAgYW5ndWxhck1vZHVsZSA9IHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nTG9jYWxlJywgW10pLnByb3ZpZGVyKCckbG9jYWxlJywgJExvY2FsZVByb3ZpZGVyKTsKICAgICAgICB9CgogICAgICAgIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgICAgICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKCckY29tcGlsZScsICRDb21waWxlUHJvdmlkZXIpLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGE6IGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtOiBmb3JtRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uOiBvcHRpb25EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRIdG1sVW5zYWZlOiBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0JpbmRUZW1wbGF0ZTogbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NFdmVuOiBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDbGFzc09kZDogbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdDc3A6IG5nQ3NwRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0Nsb2FrOiBuZ0Nsb2FrRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0NvbnRyb2xsZXI6IG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nSGlkZTogbmdIaWRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdJbml0OiBuZ0luaXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nTm9uQmluZGFibGU6IG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdSZXBlYXQ6IG5nUmVwZWF0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1Nob3c6IG5nU2hvd0RpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdTdWJtaXQ6IG5nU3VibWl0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N0eWxlOiBuZ1N0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nU3dpdGNoV2hlbjogbmdTd2l0Y2hXaGVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaERlZmF1bHQ6IG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nVmlldzogbmdWaWV3RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyOiAkQ29udHJvbGxlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlcjogJEZpbHRlclByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb246ICRMb2NhdGlvblByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAgICRyb3V0ZTogJFJvdXRlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiAkUm91dGVQYXJhbXNQcm92aWRlciwKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUgcHJvdmlkZXMgdGhlIGZvbGxvd2luZyBtZXRob2RzOgogICAgICoKICAgICAqIC0gW2FkZENsYXNzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZGRDbGFzcy8pCiAgICAgKiAtIFthZnRlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogICAgICogLSBbYXBwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hcHBlbmQvKQogICAgICogLSBbYXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXR0ci8pCiAgICAgKiAtIFtiaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMKICAgICAqIC0gW2NoaWxkcmVuKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW2Nsb25lKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAgICAgKiAtIFtjb250ZW50cygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogICAgICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogICAgICogLSBbZGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAgICAgKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAgICogLSBbZmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICAgKiAtIFtoYXNDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAgICogLSBbaHRtbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICAgKiAtIFtuZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbcGFyZW50KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICAgKiAtIFtwcmVwZW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcmVwZW5kLykKICAgICAqIC0gW3Byb3AoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogICAgICogLSBbcmVhZHkoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlYWR5LykKICAgICAqIC0gW3JlbW92ZSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlLykKICAgICAqIC0gW3JlbW92ZUF0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogICAgICogLSBbcmVtb3ZlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUNsYXNzLykKICAgICAqIC0gW3JlbW92ZURhdGEoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZURhdGEvKQogICAgICogLSBbcmVwbGFjZVdpdGgoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICAgICAqIC0gW3RleHQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RleHQvKQogICAgICogLSBbdG9nZ2xlQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RvZ2dsZUNsYXNzLykKICAgICAqIC0gW3RyaWdnZXJIYW5kbGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gRG9lc24ndCBwYXNzIG5hdGl2ZSBldmVudCBvYmplY3RzIHRvIGhhbmRsZXJzLgogICAgICogLSBbdW5iaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS91bmJpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAgICogLSBbdmFsKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS92YWwvKQogICAgICogLSBbd3JhcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAgICAgKgogICAgICogIyMgSW4gYWRkdGlvbiB0byB0aGUgYWJvdmUsIEFuZ3VsYXIgcHJvdmlkZXMgYWRkaXRpb25hbCBtZXRob2RzIHRvIGJvdGggalF1ZXJ5IGFuZCBqUXVlcnkgbGl0ZToKICAgICAqCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICAgID8gZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICAgICAgOiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwogICAgICAgIH0pLAogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcgogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIGVsZW1lbnQuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKICAgICAgICB9KTsKCiAgICBmdW5jdGlvbiBqcU5leHRJZCgpIHsKICAgICAgICByZXR1cm4gKytqcUlkOwogICAgfQoKCiAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgIHZhciBNT1pfSEFDS19SRUdFWFAgPSAvXm1veihbQS1aXSkvOwoKICAgIC8qKgogICAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgICAqLwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCxmdW5jdGlvbiAoXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyAgSW4gY29uanVuY3Rpb24gd2l0aCBiaW5kSlF1ZXJ5IGludGVyY2VwdHMgYWxsIGpRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyBhCi8vICRkZXN0cm95IGV2ZW50IG9uIGFsbCBET00gbm9kZXMgYmVpbmcgcmVtb3ZlZC4KLy8KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgICAgICBvcmlnaW5hbEpxRm4gPSBvcmlnaW5hbEpxRm4uJG9yaWdpbmFsIHx8IG9yaWdpbmFsSnFGbjsKICAgICAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICAgICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBhdGNoKCkgewogICAgICAgICAgICB2YXIgbGlzdCA9IFt0aGlzXSwKICAgICAgICAgICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICAgICAgICAgIHNldCwgc2V0SW5kZXgsIHNldExlbmd0aCwKICAgICAgICAgICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbiwKICAgICAgICAgICAgICAgIGZucywgZXZlbnRzOwoKICAgICAgICAgICAgd2hpbGUgKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBzZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBmb3IgKHNldEluZGV4ID0gMCwgc2V0TGVuZ3RoID0gc2V0Lmxlbmd0aDsgc2V0SW5kZXggPCBzZXRMZW5ndGg7IHNldEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgIGlmIChmaXJlRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50cmlnZ2VySGFuZGxlcignJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSAhZmlyZUV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChqUXVlcnkoY2hpbGRyZW5bY2hpbGRJbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgZnVuY3Rpb24gSlFMaXRlKGVsZW1lbnQpIHsKICAgICAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEpRTGl0ZSkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEpRTGl0ZSkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3NlbGVjdG9ycyBub3QgaW1wbGVtZW50ZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IEpRTGl0ZShlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSkgewogICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgdGhlIE5vU2NvcGUgZWxlbWVudHMgaGVyZToKICAgICAgICAgICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTMzODk3KFZTLjg1KS5hc3B4CiAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPGRpdj4mIzE2MDs8L2Rpdj4nICsgZWxlbWVudDsgLy8gSUUgaW5zYW5pdHkgdG8gbWFrZSBOb1Njb3BlIGVsZW1lbnRzIHdvcmshCiAgICAgICAgICAgIGRpdi5yZW1vdmVDaGlsZChkaXYuZmlyc3RDaGlsZCk7IC8vIHJlbW92ZSB0aGUgc3VwZXJmbHVvdXMgZGl2CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGRpdi5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsgLy8gZGV0YWNoIHRoZSBlbGVtZW50cyBmcm9tIHRoZSB0ZW1wb3JhcnkgRE9NIGRpdi4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBKUUxpdGVBZGROb2Rlcyh0aGlzLCBlbGVtZW50KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ2xvbmUoZWxlbWVudCkgewogICAgICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVEZWFsb2MoZWxlbWVudCkgewogICAgICAgIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkcmVuW2ldKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlVW5iaW5kKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgICAgIGhhbmRsZSA9IEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJyk7CgogICAgICAgIGlmICghaGFuZGxlKSByZXR1cm47IC8vbm8gbGlzdGVuZXJzIHJlZ2lzdGVyZWQKCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUpKSB7CiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRIYW5kbGVyLCB0eXBlKSB7CiAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChmbikpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudHNbdHlwZV0pOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGV2ZW50c1t0eXBlXSwgZm4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZURhdGEoZWxlbWVudCkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgICAgICAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICBpZiAoZXhwYW5kb1N0b3JlLmhhbmRsZSkgewogICAgICAgICAgICAgICAgZXhwYW5kb1N0b3JlLmV2ZW50cy4kZGVzdHJveSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAgICAgICAgICAgIEpRTGl0ZVVuYmluZChlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgICAgICAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWQgfHwgLTFdOwoKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICBpZiAoIWV4cGFuZG9TdG9yZSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cGFuZG9TdG9yZVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmVba2V5XTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlRGF0YShlbGVtZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGRhdGEgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnKSwKICAgICAgICAgICAgaXNTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpLAogICAgICAgICAgICBrZXlEZWZpbmVkID0gIWlzU2V0dGVyICYmIGlzRGVmaW5lZChrZXkpLAogICAgICAgICAgICBpc1NpbXBsZUdldHRlciA9IGtleURlZmluZWQgJiYgIWlzT2JqZWN0KGtleSk7CgogICAgICAgIGlmICghZGF0YSAmJiAhaXNTaW1wbGVHZXR0ZXIpIHsKICAgICAgICAgICAgSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJywgZGF0YSA9IHt9KTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1NldHRlcikgewogICAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoa2V5RGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKGlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgY3JlYXRlIGRhdGEgaW4gdGhpcyBjYXNlLgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhICYmIGRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGRhdGEsIGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgIHJldHVybiAoKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS4KICAgICAgICAgICAgaW5kZXhPZigiICIgKyBzZWxlY3RvciArICIgIikgPiAtMSk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoY3NzQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbSgKICAgICAgICAgICAgICAgICAgICAoIiAiICsgZWxlbWVudC5jbGFzc05hbWUgKyAiICIpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgiICIgKyB0cmltKGNzc0NsYXNzKSArICIgIiwgIiAiKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBpZiAoIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIGNzc0NsYXNzKSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdHJpbShlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIHRyaW0oY3NzQ2xhc3MpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUFkZE5vZGVzKHJvb3QsIGVsZW1lbnRzKSB7CiAgICAgICAgaWYgKGVsZW1lbnRzKSB7CiAgICAgICAgICAgIGVsZW1lbnRzID0gKCFlbGVtZW50cy5ub2RlTmFtZSAmJiBpc0RlZmluZWQoZWxlbWVudHMubGVuZ3RoKSAmJiAhaXNXaW5kb3coZWxlbWVudHMpKQogICAgICAgICAgICAgICAgPyBlbGVtZW50cwogICAgICAgICAgICAgICAgOiBbIGVsZW1lbnRzIF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHJvb3QucHVzaChlbGVtZW50c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQ29udHJvbGxlcihlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyQnICsgKG5hbWUgfHwgJ25nQ29udHJvbGxlcicgKSArICdDb250cm9sbGVyJyk7CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICAgIC8vIGlmIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50IG9iamVjdCB3b3JrIHdpdGggdGhlIGh0bWwgZWxlbWVudCBpbnN0ZWFkCiAgICAgICAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgICAgICAgaWYgKGVsZW1lbnRbMF0ubm9kZVR5cGUgPT0gOSkgewogICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5maW5kKCdodG1sJyk7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWUpKSByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBKUUxpdGVQcm90b3R5cGUgPSBKUUxpdGUucHJvdG90eXBlID0gewogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICAgICAgICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgICAgICAgICAgICBmaXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJpbmQoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsgLy8gd29ya3MgZm9yIG1vZGVybiBicm93c2VycyBhbmQgSUU5CiAgICAgICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAgICAgSlFMaXRlKHdpbmRvdykuYmluZCgnbG9hZCcsIHRyaWdnZXIpOyAvLyBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkIGZvciBvdGhlcnMKICAgICAgICB9LAogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKHRoaXMsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKCcnICsgZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgICAgIH0sCgogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwdXNoOiBwdXNoLAogICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgIH07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBCT09MRUFOX0FUVFIgPSB7fTsKICAgIGZvckVhY2goJ211bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZE9ubHkscmVxdWlyZWQnLnNwbGl0KCcsJyksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIEJPT0xFQU5fQVRUUltsb3dlcmNhc2UodmFsdWUpXSA9IHZhbHVlOwogICAgfSk7CiAgICB2YXIgQk9PTEVBTl9FTEVNRU5UUyA9IHt9OwogICAgZm9yRWFjaCgnaW5wdXQsc2VsZWN0LG9wdGlvbix0ZXh0YXJlYSxidXR0b24sZm9ybScuc3BsaXQoJywnKSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckc2NvcGUnKTsKICAgICAgICB9LAoKICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVDb250cm9sbGVyLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycpIHZhbCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBhdHRyOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChlbGVtZW50W25hbWVdIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChlbGVtZW50LmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKG5hbWUpIHx8IG5vb3ApLnNwZWNpZmllZCkKICAgICAgICAgICAgICAgICAgICAgICAgPyBsb3dlcmNhc2VkTmFtZQogICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgICAgICAgICAgIC8vIHNvbWUgZWxlbWVudHMgKGUuZy4gRG9jdW1lbnQpIGRvbid0IGhhdmUgZ2V0IGF0dHJpYnV0ZSwgc28gcmV0dXJuIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICAgICAgICAgICAgcmV0dXJuIHJldCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByb3A6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB0ZXh0OiBleHRlbmQoKG1zaWUgPCA5KQogICAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICovKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVyVGV4dDsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVWYWx1ZTsKICAgICAgICAgICAgICAgIGVsZW1lbnQubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICB9LCB7JGR2OiAnJ30pLAoKICAgICAgICB2YWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgaHRtbDogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIEpRTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAgICAgKi8KICAgICAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKGFyZzEsIGFyZzIpIHsKICAgICAgICAgICAgdmFyIGksIGtleTsKCiAgICAgICAgICAgIC8vIEpRTGl0ZUhhc0NsYXNzIGhhcyBvbmx5IHR3byBhcmd1bWVudHMsIGJ1dCBpcyBhIGdldHRlci1vbmx5IGZuLCBzbyB3ZSBuZWVkIHRvIHNwZWNpYWwtY2FzZSBpdAogICAgICAgICAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgICAgICAgICAgaWYgKCgoZm4ubGVuZ3RoID09IDIgJiYgKGZuICE9PSBKUUxpdGVIYXNDbGFzcyAmJiBmbiAhPT0gSlFMaXRlQ29udHJvbGxlcikpID8gYXJnMSA6IGFyZzIpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4gPT09IEpRTGl0ZURhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwga2V5LCBhcmcxW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSByZWFkLCBzbyByZWFkIHRoZSBmaXJzdCBjaGlsZC4KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbih0aGlzWzBdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBzbyBhcHBseSB0byBhbGwgY2hpbGRyZW4KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi4kZHY7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudHMpIHsKICAgICAgICB2YXIgZXZlbnRIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50LCB0eXBlKSB7CiAgICAgICAgICAgIGlmICghZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudC5kZWZhdWx0UHJldmVudGVkKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHByZXZlbnQuY2FsbChldmVudCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV0sIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBldmVudCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIG1vbmtleS1wYXRjaGVkIG1ldGhvZHMgKElFKSwKICAgICAgICAgICAgLy8gYXMgdGhleSB3b3VsZCBjYXVzZSBtZW1vcnkgbGVha3MgaW4gSUU4LgogICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudEhhbmRsZXIuZWxlbSA9IGVsZW1lbnQ7CiAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgYmluZDogZnVuY3Rpb24gYmluZEZuKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgICAgIGlmICghZXZlbnRzKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRvd24gPSBhLm5vZGVUeXBlID09PSA5ID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMoYnVwKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYnVwKSAmIDE2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiID09PSBhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZTogIm1vdXNlb3V0IiwgbW91c2VlbnRlcjogIm1vdXNlb3ZlciJ9CiAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRGbihlbGVtZW50LCBldmVudG1hcFt0eXBlXSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0LCB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBoYW5kbGUpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGV2ZW50Rm5zLnB1c2goZm4pOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICB1bmJpbmQ6IEpRTGl0ZVVuYmluZCwKCiAgICAgICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uIChlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgICAgICAgICB2YXIgaW5kZXgsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0sCgogICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOwogICAgICAgIH0sCgogICAgICAgIGFwcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyYXA6IGZ1bmN0aW9uIChlbGVtZW50LCB3cmFwTm9kZSkgewogICAgICAgICAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSlbMF07CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcE5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdyYXBOb2RlLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uIChlbGVtZW50LCBuZXdFbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5ld0VsZW1lbnQpLCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFkZENsYXNzOiBKUUxpdGVBZGRDbGFzcywKICAgICAgICByZW1vdmVDbGFzczogSlFMaXRlUmVtb3ZlQ2xhc3MsCgogICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZGl0aW9uKSkgewogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoY29uZGl0aW9uID8gSlFMaXRlQWRkQ2xhc3MgOiBKUUxpdGVSZW1vdmVDbGFzcykoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgIH0sCgogICAgICAgIHBhcmVudDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICBuZXh0OiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxtOwogICAgICAgIH0sCgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgY2xvbmU6IEpRTGl0ZUNsb25lLAoKICAgICAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50TmFtZSkgewogICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSAoSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSB8fCB7fSlbZXZlbnROYW1lXTsKCiAgICAgICAgICAgIGZvckVhY2goZXZlbnRGbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgZm4uY2FsbChlbGVtZW50LCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGZuLCBuYW1lKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModmFsdWUsIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gdW5kZWZpbmVkID8gdGhpcyA6IHZhbHVlOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KSB7CiAgICAgICAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwogICAgfQoKICAgIEhhc2hNYXAucHJvdG90eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICAgICAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgICAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAgICAgICAqLwogICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpc1toYXNoS2V5KGtleSldID0gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGtleQogICAgICAgICAqIEByZXR1cm5zIHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICAgICAqLwogICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgICAgICAgKiBAcGFyYW0ga2V5CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBBIG1hcCB3aGVyZSBtdWx0aXBsZSB2YWx1ZXMgY2FuIGJlIGFkZGVkIHRvIHRoZSBzYW1lIGtleSBzdWNoIHRoYXQgdGhleSBmb3JtIGEgcXVldWUuCiAgICAgKiBAcmV0dXJucyB7SGFzaFF1ZXVlTWFwfQogICAgICovCiAgICBmdW5jdGlvbiBIYXNoUXVldWVNYXAoKSB7CiAgICB9CgogICAgSGFzaFF1ZXVlTWFwLnByb3RvdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHB1c2gsIGJ1dCB1c2luZyBhbiBhcnJheSBhcyB0aGUgdmFsdWUgZm9yIHRoZSBoYXNoCiAgICAgICAgICovCiAgICAgICAgcHVzaDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSBbdmFsdWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTYW1lIGFzIGFycmF5IHNoaWZ0LCBidXQgdXNpbmcgYW4gYXJyYXkgYXMgdGhlIHZhbHVlIGZvciB0aGUgaGFzaAogICAgICAgICAqLwogICAgICAgIHNoaWZ0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiByZXR1cm4gdGhlIGZpcnN0IGl0ZW0gd2l0aG91dCBkZWxldGluZyBpdAogICAgICAgICAqLwogICAgICAgIHBlZWs6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gdGhpc1toYXNoS2V5KGtleSldOwogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnJheVswXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhbiBpbmplY3RvciBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAgICAgKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogICAgICoKCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHlwaWNhbCB1c2FnZQogICAgICogPHByZT4KICAgICAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICAgKgogICAgICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICAgICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICAgKiBAbmFtZSBBVVRPCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbXBsaWNpdCBtb2R1bGUgd2hpY2ggZ2V0cyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIGVhY2gge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKi8KCiAgICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICAgIHZhciBGTl9BUkdfU1BMSVQgPSAvLC87CiAgICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICAgIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CgogICAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgICAgICB2YXIgJGluamVjdCwKICAgICAgICAgICAgZm5UZXh0LAogICAgICAgICAgICBhcmdEZWNsLAogICAgICAgICAgICBsYXN0OwoKICAgICAgICBpZiAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgaWYgKCEoJGluamVjdCA9IGZuLiRpbmplY3QpKSB7CiAgICAgICAgICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICAgICAgICAgIGFyZy5yZXBsYWNlKEZOX0FSRywgZnVuY3Rpb24gKGFsbCwgdW5kZXJzY29yZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZuLiRpbmplY3QgPSAkaW5qZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGZuKSkgewogICAgICAgICAgICBsYXN0ID0gZm4ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm5bbGFzdF0sICdmbicpOwogICAgICAgICAgICAkaW5qZWN0ID0gZm4uc2xpY2UoMCwgbGFzdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sICdmbicsIHRydWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGluamVjdDsKICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgICAqIGFuZCBsb2FkIG1vZHVsZXMuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkudG9CZSgkaW5qZWN0b3IpOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogICAgICoKICAgICAqIEphdmFTY3JpcHQgZG9lcyBub3QgaGF2ZSBhbm5vdGF0aW9ucywgYW5kIGFubm90YXRpb25zIGFyZSBuZWVkZWQgZm9yIGRlcGVuZGVuY3kgaW5qZWN0aW9uLiBUaGUKICAgICAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAgICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oc2VydmljZUEpe30pOwogICAgICoKICAgICAqICAgLy8gYW5ub3RhdGVkCiAgICAgKiAgIGZ1bmN0aW9uIGV4cGxpY2l0KHNlcnZpY2VBKSB7fTsKICAgICAqICAgZXhwbGljaXQuJGluamVjdCA9IFsnc2VydmljZUEnXTsKICAgICAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAgICAgKgogICAgICogICAvLyBpbmxpbmUKICAgICAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMjIEluZmVyZW5jZQogICAgICoKICAgICAqIEluIEphdmFTY3JpcHQgY2FsbGluZyBgdG9TdHJpbmcoKWAgb24gYSBmdW5jdGlvbiByZXR1cm5zIHRoZSBmdW5jdGlvbiBkZWZpbml0aW9uLiBUaGUgZGVmaW5pdGlvbiBjYW4gdGhlbiBiZQogICAgICogcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGggbWluaWZpY2F0aW9uLCBhbmQgb2JmdXNjYXRpb24KICAgICAqIHRvb2xzIHNpbmNlIHRoZXNlIHRvb2xzIGNoYW5nZSB0aGUgYXJndW1lbnQgbmFtZXMuCiAgICAgKgogICAgICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICAgICAqIEJ5IGFkZGluZyBhIGAkaW5qZWN0YCBwcm9wZXJ0eSBvbnRvIGEgZnVuY3Rpb24gdGhlIGluamVjdGlvbiBwYXJhbWV0ZXJzIGNhbiBiZSBzcGVjaWZpZWQuCiAgICAgKgogICAgICogIyMgSW5saW5lCiAgICAgKiBBcyBhbiBhcnJheSBvZiBpbmplY3Rpb24gbmFtZXMsIHdoZXJlIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5IGlzIHRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNnZXQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJuIGFuIGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm4geyp9IFRoZSBpbnN0YW5jZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjaW52b2tlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEludm9rZSB0aGUgbWV0aG9kIGFuZCBzdXBwbHkgdGhlIG1ldGhvZCBhcmd1bWVudHMgZnJvbSB0aGUgYCRpbmplY3RvcmAuCiAgICAgKgogICAgICogQHBhcmFtIHshZnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIFRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY29tZSBmb3JtIHRoZSBmdW5jdGlvbiBhbm5vdGF0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBzZWxmIFRoZSBgdGhpc2AgZm9yIHRoZSBpbnZva2VkIG1ldGhvZC4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGUgaW52b2tlZCBgZm5gIGZ1bmN0aW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBKUyB0eXBlLiBUaGUgbWV0aG9kIHRha2VzIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gaW52b2tlcyB0aGUgbmV3IG9wZXJhdG9yIGFuZCBzdXBwbGllcwogICAgICogYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUgY29uc3RydWN0b3IgYW5ub3RhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcyBvYmplY3QgZmlyc3QsIGJlZm9yZQogICAgICogICB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gbmV3IGluc3RhbmNlIG9mIGBUeXBlYC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IjYW5ub3RhdGUKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBhbiBhcnJheSBvZiBzZXJ2aWNlIG5hbWVzIHdoaWNoIHRoZSBmdW5jdGlvbiBpcyByZXF1ZXN0aW5nIGZvciBpbmplY3Rpb24uIFRoaXMgQVBJIGlzIHVzZWQgYnkgdGhlIGluamVjdG9yCiAgICAgKiB0byBkZXRlcm1pbmUgd2hpY2ggc2VydmljZXMgbmVlZCB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbiB3aGVuIHRoZSBmdW5jdGlvbiBpcyBpbnZva2VkLiBUaGVyZSBhcmUgdGhyZWUKICAgICAqIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkIGRlcGVuZGVuY2llcy4KICAgICAqCiAgICAgKiAjIEFyZ3VtZW50IG5hbWVzCiAgICAgKgogICAgICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZSBieSBjb252ZXJ0aW5nCiAgICAgKiB0aGUgZnVuY3Rpb24gaW50byBhIHN0cmluZyB1c2luZyBgdG9TdHJpbmcoKWAgbWV0aG9kIGFuZCBleHRyYWN0aW5nIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIEdpdmVuCiAgICAgKiAgIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRyb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAgICoKICAgICAqICAgLy8gVGhlbgogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCB3b3JrIHdpdGggY29kZSBtaW5maWNhdGlvbiAvIG9iZnVzY2F0aW9uLiBGb3IgdGhpcyByZWFzb24gdGhlIGZvbGxvd2luZyBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMKICAgICAqIGFyZSBzdXBwb3J0ZWQuCiAgICAgKgogICAgICogIyBUaGUgYCRpbmplY3RgIHByb3BlcnR5CiAgICAgKgogICAgICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncyByZXByZXNlbnQgbmFtZXMgb2YKICAgICAqIHNlcnZpY2VzIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgdmFyIE15Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9iZnVzY2F0ZWRTY29wZSwgb2JmdXNjYXRlZFJvdXRlKSB7CiAqICAgICAvLyAuLi4KICogICB9CiAgICAgKiAgIC8vIERlZmluZSBmdW5jdGlvbiBkZXBlbmRlbmNpZXMKICAgICAqICAgTXlDb250cm9sbGVyLiRpbmplY3QgPSBbJyRzY29wZScsICckcm91dGUnXTsKICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyBUaGUgYXJyYXkgbm90YXRpb24KICAgICAqCiAgICAgKiBJdCBpcyBvZnRlbiBkZXNpcmFibGUgdG8gaW5saW5lIEluamVjdGVkIGZ1bmN0aW9ucyBhbmQgdGhhdCdzIHdoZW4gc2V0dGluZyB0aGUgYCRpbmplY3RgIHByb3BlcnR5IGlzIHZlcnkKICAgICAqIGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluIGEgd2F5IHRoYXQgc3Vydml2ZXMKICAgICAqIG1pbmlmaWNhdGlvbiBpcyBhIGJldHRlciBjaG9pY2U6CiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gV2Ugd2lzaCB0byB3cml0ZSB0aGlzIChub3QgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24gc2FmZSkKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlLCAkcm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICAgICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH07CiAgICAgKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKHRtcEZuKTsKICAgICAqCiAgICAgKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAgICAgKiAgIGluamVjdG9yLmludm9rZShbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZDb21waWxlLCBvYmZSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH1dKTsKICAgICAqCiAgICAgKiAgIC8vIFRoZXJlZm9yZQogICAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoCiAgICAgKiAgICAgIFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZnVzXyRjb21waWxlLCBvYmZ1c18kcm9vdFNjb3BlKSB7fV0pCiAgICAgKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8gYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZAogICAgICogICBhYm92ZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IFRoZSBuYW1lcyBvZiB0aGUgc2VydmljZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIHJlcXVpcmVzLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSBgJHByb3ZpZGVgIHRvIHJlZ2lzdGVyIG5ldyBwcm92aWRlcnMgd2l0aCB0aGUgYCRpbmplY3RvcmAuIFRoZSBwcm92aWRlcnMgYXJlIHRoZSBmYWN0b3JpZXMgZm9yIHRoZSBpbnN0YW5jZS4KICAgICAqIFRoZSBwcm92aWRlcnMgc2hhcmUgdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5zdGFuY2UgdGhleSBjcmVhdGUgd2l0aCBgUHJvdmlkZXJgIHN1ZmZpeGVkIHRvIHRoZW0uCiAgICAgKgogICAgICogQSBwcm92aWRlciBpcyBhbiBvYmplY3Qgd2l0aCBhIGAkZ2V0KClgIG1ldGhvZC4gVGhlIGluamVjdG9yIGNhbGxzIHRoZSBgJGdldGAgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAgICogYSBzZXJ2aWNlLiBUaGUgUHJvdmlkZXIgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIHdvdWxkIGFsbG93IGZvciBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlci4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBmdW5jdGlvbiBHcmVldFByb3ZpZGVyKCkgewogKiAgICAgdmFyIHNhbHV0YXRpb24gPSAnSGVsbG8nOwogKgogKiAgICAgdGhpcy5zYWx1dGF0aW9uID0gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICBzYWx1dGF0aW9uID0gdGV4dDsKICogICAgIH07CiAqCiAqICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAqICAgICAgICAgcmV0dXJuIHNhbHV0YXRpb24gKyAnICcgKyBuYW1lICsgJyEnOwogKiAgICAgICB9OwogKiAgICAgfTsKICogICB9CiAgICAgKgogICAgICogICBkZXNjcmliZSgnR3JlZXRlcicsIGZ1bmN0aW9uKCl7CiAqCiAqICAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbigkcHJvdmlkZSkgewogKiAgICAgICAkcHJvdmlkZS5wcm92aWRlcignZ3JlZXQnLCBHcmVldFByb3ZpZGVyKTsKICogICAgIH0pKTsKICoKICogICAgIGl0KCdzaG91bGQgZ3JlZXQnLCBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICogICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0hlbGxvIGFuZ3VsYXIhJyk7CiAqICAgICB9KSk7CiAqCiAqICAgICBpdCgnc2hvdWxkIGFsbG93IGNvbmZpZ3VyYXRpb24gb2Ygc2FsdXRhdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgICAgICBtb2R1bGUoZnVuY3Rpb24oZ3JlZXRQcm92aWRlcikgewogKiAgICAgICAgIGdyZWV0UHJvdmlkZXIuc2FsdXRhdGlvbignQWhvaicpOwogKiAgICAgICB9KTsKICogICAgICAgaW5qZWN0KGZ1bmN0aW9uKGdyZWV0KSB7CiAqICAgICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0Fob2ogYW5ndWxhciEnKTsKICogICAgICAgfSk7CiAqICAgICB9KTsKICogPC9wcmU+CiAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNwcm92aWRlcgogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFJlZ2lzdGVyIGEgcHJvdmlkZXIgZm9yIGEgc2VydmljZS4gVGhlIHByb3ZpZGVycyBjYW4gYmUgcmV0cmlldmVkIGFuZCBjYW4gaGF2ZSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gbWV0aG9kcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuIE5PVEU6IHRoZSBwcm92aWRlciB3aWxsIGJlIGF2YWlsYWJsZSB1bmRlciBgbmFtZSArICdQcm92aWRlcidgIGtleS4KICAgICAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogdGhlbiBpdCBzaG91bGQgaGF2ZSBhIGAkZ2V0YCBtZXRob2QuIFRoZSBgJGdldGAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB1c2luZwogICAgICogICAgICAgICAgICAgICB7QGxpbmsgQVVUTy4kaW5qZWN0b3IjaW52b2tlICRpbmplY3Rvci5pbnZva2UoKX0gd2hlbiBhbiBpbnN0YW5jZSBuZWVkcyB0byBiZSBjcmVhdGVkLgogICAgICogICAtIGBDb25zdHJ1Y3RvcmA6IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBwcm92aWRlciB3aWxsIGJlIGNyZWF0ZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlICRpbmplY3Rvci5pbnN0YW50aWF0ZSgpfSwgdGhlbiB0cmVhdGVkIGFzIGBvYmplY3RgLgogICAgICoKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNmYWN0b3J5CiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiBvbmx5IGAkZ2V0YCBtZXRob2QgaXMgcmVxdWlyZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSAkZ2V0Rm4gVGhlICRnZXRGbiBmb3IgdGhlIGluc3RhbmNlIGNyZWF0aW9uLiBJbnRlcm5hbGx5IHRoaXMgaXMgYSBzaG9ydCBoYW5kIGZvcgogICAgICogYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3NlcnZpY2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNob3J0IGhhbmQgZm9yIHJlZ2lzdGVyaW5nIHNlcnZpY2Ugb2YgZ2l2ZW4gY2xhc3MuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRwcm92aWRlI3ZhbHVlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciBjb25maWd1cmluZyBzZXJ2aWNlcyBpZiB0aGUgYCRnZXRgIG1ldGhvZCBpcyBhIGNvbnN0YW50LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNjb25zdGFudAogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgY29uc3RhbnQgdmFsdWUsIGJ1dCB1bmxpa2Uge0BsaW5rIEFVVE8uJHByb3ZpZGUjdmFsdWUgdmFsdWV9IGl0IGNhbiBiZSBpbmplY3RlZAogICAgICogaW50byBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChvdGhlciBtb2R1bGVzKSBhbmQgaXQgaXMgbm90IGludGVyY2VwdGFibGUgYnkKICAgICAqIHtAbGluayBBVVRPLiRwcm92aWRlI2RlY29yYXRvciBkZWNvcmF0b3J9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBjb25zdGFudC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIGNvbnN0YW50IHZhbHVlLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBEZWNvcmF0aW9uIG9mIHNlcnZpY2UsIGFsbG93cyB0aGUgZGVjb3JhdG9yIHRvIGludGVyY2VwdCB0aGUgc2VydmljZSBpbnN0YW5jZSBjcmVhdGlvbi4gVGhlCiAgICAgKiByZXR1cm5lZCBpbnN0YW5jZSBtYXkgYmUgdGhlIG9yaWdpbmFsIGluc3RhbmNlLCBvciBhIG5ldyBpbnN0YW5jZSB3aGljaCBkZWxlZ2F0ZXMgdG8gdGhlCiAgICAgKiBvcmlnaW5hbCBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc2VydmljZSB0byBkZWNvcmF0ZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZGVjb3JhdG9yIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlIHNlcnZpY2UgbmVlZHMgdG8gYmUKICAgICAqICAgIGluc3RhbnRpYXRlZC4gVGhlIGZ1bmN0aW9uIGlzIGNhbGxlZCB1c2luZyB0aGUge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZQogICAgICogICAgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLiBMb2NhbCBpbmplY3Rpb24gYXJndW1lbnRzOgogICAgICoKICAgICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAgICogICAgICBkZWNvcmF0ZWQgb3IgZGVsZWdhdGVkIHRvLgogICAgICovCgoKICAgIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICB2YXIgSU5TVEFOVElBVElORyA9IHt9LAogICAgICAgICAgICBwcm92aWRlclN1ZmZpeCA9ICdQcm92aWRlcicsCiAgICAgICAgICAgIHBhdGggPSBbXSwKICAgICAgICAgICAgbG9hZGVkTW9kdWxlcyA9IG5ldyBIYXNoTWFwKCksCiAgICAgICAgICAgIHByb3ZpZGVyQ2FjaGUgPSB7CiAgICAgICAgICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyOiBzdXBwb3J0T2JqZWN0KHByb3ZpZGVyKSwKICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1cHBvcnRPYmplY3QodmFsdWUpLAogICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgICAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm92aWRlckluamVjdG9yID0gY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5rbm93biBwcm92aWRlcjogIiArIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGluc3RhbmNlQ2FjaGUgPSB7fSwKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3RvciA9IChpbnN0YW5jZUNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGluc3RhbmNlQ2FjaGUsIGZ1bmN0aW9uIChzZXJ2aWNlbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VuYW1lICsgcHJvdmlkZXJTdWZmaXgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShwcm92aWRlci4kZ2V0LCBwcm92aWRlcik7CiAgICAgICAgICAgICAgICB9KSk7CgoKICAgICAgICBmb3JFYWNoKGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyAkcHJvdmlkZXIKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgZnVuY3Rpb24gc3VwcG9ydE9iamVjdChkZWxlZ2F0ZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChrZXksIHJldmVyc2VQYXJhbXMoZGVsZWdhdGUpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGVnYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm92aWRlcihuYW1lLCBwcm92aWRlcl8pIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvdmlkZXJfKSB8fCBpc0FycmF5KHByb3ZpZGVyXykpIHsKICAgICAgICAgICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvdmlkZXIgJyArIG5hbWUgKyAnIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgWyckaW5qZWN0b3InLCBmdW5jdGlvbiAoJGluamVjdG9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsdWUobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWx1ZSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgICAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgICAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHskZGVsZWdhdGU6IG9yaWdJbnN0YW5jZX0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTW9kdWxlIExvYWRpbmcKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChtb2R1bGVzVG9Mb2FkLCBmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobG9hZGVkTW9kdWxlcy5nZXQobW9kdWxlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgIHJ1bkJsb2NrcyA9IHJ1bkJsb2Nrcy5jb25jYXQobG9hZE1vZHVsZXMobW9kdWxlRm4ucmVxdWlyZXMpKS5jb25jYXQobW9kdWxlRm4uX3J1bkJsb2Nrcyk7CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gaW52b2tlQXJnc1swXSA9PSAnJGluamVjdG9yJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHByb3ZpZGVySW5qZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UpIGUubWVzc2FnZSArPSAnIGZyb20gJyArIG1vZHVsZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubWVzc2FnZSkgZS5tZXNzYWdlICs9ICcgZnJvbSAnICsgbW9kdWxlOwogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlKSBlLm1lc3NhZ2UgKz0gJyBmcm9tICcgKyBTdHJpbmcobW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2VOYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdTZXJ2aWNlIG5hbWUgZXhwZWN0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjYWNoZS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdDaXJjdWxhciBkZXBlbmRlbmN5OiAnICsgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsIGksCiAgICAgICAgICAgICAgICAgICAga2V5OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGxvY2Fsc1trZXldCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWZuLiRpbmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgd2UgbXVzdCBiZSBhbiBhcnJheS4KICAgICAgICAgICAgICAgICAgICBmbiA9IGZuW2xlbmd0aF07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8vIFBlcmZvcm1hbmNlIG9wdGltaXphdGlvbjogaHR0cDovL2pzcGVyZi5jb20vYXBwbHktdnMtY2FsbC12cy1pbnZva2UKICAgICAgICAgICAgICAgIHN3aXRjaCAoc2VsZiA/IC0xIDogYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICAwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICAxOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgMjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgNToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDY6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICA3OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSk7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAgODoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0sIGFyZ3NbNV0sIGFyZ3NbNl0sIGFyZ3NbN10pOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIDk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddLCBhcmdzWzhdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSwgYXJnc1s5XSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShUeXBlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIFR5cGUgaXMgYW5ub3RhdGVkIGFuZCB1c2UganVzdCB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXQgbi0xIGFzIHBhcmFtZXRlcgogICAgICAgICAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgICAgICAgICBpbnN0YW50aWF0ZTogaW5zdGFudGlhdGUsCiAgICAgICAgICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRhbmNob3JTY3JvbGwKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2hlbiBjYWxsZWQsIGl0IGNoZWNrcyBjdXJyZW50IHZhbHVlIG9mIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHRvIHJlbGF0ZWQgZWxlbWVudCwKICAgICAqIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAqIHtAbGluayBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCBIdG1sNSBzcGVjfS4KICAgICAqCiAgICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xsIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgICAqIFRoaXMgY2FuIGJlIGRpc2FibGVkIGJ5IGNhbGxpbmcgYCRhbmNob3JTY3JvbGxQcm92aWRlci5kaXNhYmxlQXV0b1Njcm9sbGluZygpYC4KICAgICAqLwogICAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgICAgICB2YXIgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uICgkd2luZG93LCAkbG9jYXRpb24sICRyb290U2NvcGUpIHsKICAgICAgICAgICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKCiAgICAgICAgICAgIC8vIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgZmlyc3QgYW5jaG9yIGZyb20gYSBOb2RlTGlzdAogICAgICAgICAgICAvLyBjYW4ndCB1c2UgZmlsdGVyLmZpbHRlciwgYXMgaXQgYWNjZXB0cyBvbmx5IGluc3RhbmNlcyBvZiBBcnJheQogICAgICAgICAgICAvLyBhbmQgSUUgY2FuJ3QgY29udmVydCBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBbXS5zbGljZQogICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogdXNlIGZpbHRlciBpZiB3ZSBjaGFuZ2UgaXQgdG8gYWNjZXB0IGxpc3RzIGFzIHdlbGwKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGxpc3QsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbCgpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAgICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBpZiAoIWhhc2gpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CgogICAgICAgICAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgICAgICAgICBlbHNlIGlmIChoYXNoID09PSAndG9wJykgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG9lcyBub3Qgc2Nyb2xsIHdoZW4gdXNlciBjbGlja3Mgb24gYW5jaG9yIGxpbmsgdGhhdCBpcyBjdXJyZW50bHkgb24KICAgICAgICAgICAgLy8gKG5vIHVybCBjaGFuZ2UsIG5vICRsb2NhdGlvbi5oYXNoKCkgY2hhbmdlKSwgYnJvd3NlciBuYXRpdmUgZG9lcyBzY3JvbGwKICAgICAgICAgICAgaWYgKGF1dG9TY3JvbGxpbmdFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkbG9jYXRpb24uaGFzaCgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbDsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGlzIG9iamVjdCBoYXMgdHdvIGdvYWxzOgogICAgICoKICAgICAqIC0gaGlkZSBhbGwgdGhlIGdsb2JhbCBzdGF0ZSBpbiB0aGUgYnJvd3NlciBjYXVzZWQgYnkgdGhlIHdpbmRvdyBvYmplY3QKICAgICAqIC0gYWJzdHJhY3QgYXdheSBhbGwgdGhlIGJyb3dzZXIgc3BlY2lmaWMgZmVhdHVyZXMgYW5kIGluY29uc2lzdGVuY2llcwogICAgICoKICAgICAqIEZvciB0ZXN0cyB3ZSBwcm92aWRlIHtAbGluayBuZ01vY2suJGJyb3dzZXIgbW9jayBpbXBsZW1lbnRhdGlvbn0gb2YgdGhlIGAkYnJvd3NlcmAKICAgICAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICAgICAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICAgICAqLwogICAgLyoqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkb2N1bWVudCBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogICAgICogQHBhcmFtIHtvYmplY3R9ICRzbmlmZmVyICRzbmlmZmVyIHNlcnZpY2UKICAgICAqLwogICAgZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgICAgICAgIGhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeSwKICAgICAgICAgICAgc2V0VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0LAogICAgICAgICAgICBjbGVhclRpbWVvdXQgPSB3aW5kb3cuY2xlYXJUaW1lb3V0LAogICAgICAgICAgICBwZW5kaW5nRGVmZXJJZHMgPSB7fTsKCiAgICAgICAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICAgICAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzID0gW107CgogICAgICAgIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgICAgICAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgICAgICAgc2VsZi4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgICAgICAgKiBjb3VudGVyLiBJZiB0aGUgY291bnRlciByZWFjaGVzIDAsIGFsbCB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AgYXJlIGV4ZWN1dGVkLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIE5vdGU6IHRoaXMgbWV0aG9kIGlzIHVzZWQgb25seSBieSBzY2VuYXJpbyBydW5uZXIKICAgICAgICAgKiBUT0RPKHZvanRhKTogcHJlZml4IHRoaXMgbWV0aG9kIHdpdGggJCQgPwogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIG5vIG91dHN0YW5kaW5nIHJlcXVlc3QKICAgICAgICAgKi8KICAgICAgICBzZWxmLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uIChwb2xsRm4pIHsKICAgICAgICAgICAgICAgIHBvbGxGbigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gUG9sbCBXYXRjaGVyIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgICAgICAgcG9sbFRpbWVvdXQ7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2FkZFBvbGxGbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBQb2xsIGZ1bmN0aW9uIHRvIGFkZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0aGF0IHBvbGxlciBwZXJpb2RpY2FsbHkgZXhlY3V0ZXMsCiAgICAgICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSB0aGUgYWRkZWQgZnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQocG9sbFRpbWVvdXQpKSBzdGFydFBvbGxlcigxMDAsIHNldFRpbWVvdXQpOwogICAgICAgICAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGludGVydmFsIEhvdyBvZnRlbiBzaG91bGQgYnJvd3NlciBjYWxsIHBvbGwgZnVuY3Rpb25zIChtcykKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHNldFRpbWVvdXQgUmVmZXJlbmNlIHRvIGEgcmVhbCBvciBmYWtlIGBzZXRUaW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENvbmZpZ3VyZXMgdGhlIHBvbGxlciB0byBydW4gaW4gdGhlIHNwZWNpZmllZCBpbnRlcnZhbHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQKICAgICAgICAgKiBzZXRUaW1lb3V0IGZuIGFuZCBraWNrcyBpdCBvZmYuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gc3RhcnRQb2xsZXIoaW50ZXJ2YWwsIHNldFRpbWVvdXQpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbiAocG9sbEZuKSB7CiAgICAgICAgICAgICAgICAgICAgcG9sbEZuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBVUkwgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gbG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgYmFzZUVsZW1lbnQgPSBkb2N1bWVudC5maW5kKCdiYXNlJyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR0VUVEVSOgogICAgICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICAgICAqCiAgICAgICAgICogU0VUVEVSOgogICAgICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICAgICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAgICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAgICAgKi8KICAgICAgICBzZWxmLnVybCA9IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgLy8gc2V0dGVyCiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICAgICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgICAgICAgICAvLyBnZXR0ZXIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHRoZSByZXBsYWNlbWVudCBpcyBhIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQwNzE3MgogICAgICAgICAgICAgICAgcmV0dXJuIGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csICInIik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgICAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgICAgICAgZnVuY3Rpb24gZmlyZVVybENoYW5nZSgpIHsKICAgICAgICAgICAgaWYgKGxhc3RCcm93c2VyVXJsID09IHNlbGYudXJsKCkpIHJldHVybjsKCiAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gc2VsZi51cmwoKTsKICAgICAgICAgICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgbGlzdGVuZXIoc2VsZi51cmwoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjb25VcmxDaGFuZ2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKiBAVE9ETyh2b2p0YSk6IHJlZmFjdG9yIHRvIHVzZSBub2RlJ3Mgc3ludGF4IGZvciBldmVudHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQsIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG9ubHkgY2FsbGVkIHdoZW4gdGhlIHVybCBpcyBjaGFuZ2VkIGJ5IG91dHNpZGUgb2YgYW5ndWxhcjoKICAgICAgICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICAgICAgICogLSB1c2VyIGNsaWNrcyBvbiBoaXN0b3J5IChmb3J3YXJkL2JhY2spIGJ1dHRvbgogICAgICAgICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICAgICAgICoKICAgICAgICAgKiBJdCdzIG5vdCBjYWxsZWQgd2hlbiB1cmwgaXMgY2hhbmdlZCBieSAkYnJvd3Nlci51cmwoKSBtZXRob2QKICAgICAgICAgKgogICAgICAgICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgICAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICAgICAgICovCiAgICAgICAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAgICAgICAgIC8vIGRvbid0IGZpcmUgcG9wc3RhdGUgd2hlbiB1c2VyIGNoYW5nZSB0aGUgYWRkcmVzcyBiYXIgYW5kIGRvbid0IGZpcmUgaGFzaGNoYW5nZSB3aGVuIHVybAogICAgICAgICAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAgICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSBqcUxpdGUod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAgICAgICAgIC8vIHBvbGxpbmcKICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5hZGRQb2xsRm4oZmlyZVVybENoYW5nZSk7CgogICAgICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gTWlzYyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nPX0KICAgICAgICAgKi8KICAgICAgICBzZWxmLmJhc2VIcmVmID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgICAgICAgICAgcmV0dXJuIGhyZWYgPyBocmVmLnJlcGxhY2UoL15odHRwcz9cOlwvXC9bXlwvXSovLCAnJykgOiAnJzsKICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIENvb2tpZXMgQVBJCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICB2YXIgbGFzdENvb2tpZXMgPSB7fTsKICAgICAgICB2YXIgbGFzdENvb2tpZVN0cmluZyA9ICcnOwogICAgICAgIHZhciBjb29raWVQYXRoID0gc2VsZi5iYXNlSHJlZigpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNjb29raWVzCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQ29va2llIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIENva2tpZSB2YWx1ZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhlIGNvb2tpZXMgbWV0aG9kIHByb3ZpZGVzIGEgJ3ByaXZhdGUnIGxvdyBsZXZlbCBhY2Nlc3MgdG8gYnJvd3NlciBjb29raWVzLgogICAgICAgICAqIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5LCB1c2UgdGhlICRjb29raWUgc2VydmljZSBpbnN0ZWFkLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZXMgdmFyeSBkZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50cyB0aGF0IHRoZSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIGFzIGZvbGxvd3M6CiAgICAgICAgICogPHVsPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMoKSAtPiBoYXNoIG9mIGFsbCBjb29raWVzLCB0aGlzIGlzIE5PVCBhIGNvcHkgb2YgdGhlIGludGVybmFsIHN0YXRlLCBzbyBkbyBub3QgbW9kaWZ5IGl0PC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llPC9saT4KICAgICAgICAgKiAgIDxsaT5jb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdCB3YXkpPC9saT4KICAgICAgICAgKiA8L3VsPgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgICAgICAgKi8KICAgICAgICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNvb2tpZUxlbmd0aCwgY29va2llQXJyYXksIGNvb2tpZSwgaSwgaW5kZXg7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtwYXRoPSIgKyBjb29raWVQYXRoICsgIjtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb29raWVMZW5ndGggPSAocmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgJz0nICsgZXNjYXBlKHZhbHVlKSArICc7cGF0aD0nICsgY29va2llUGF0aCkubGVuZ3RoICsgMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBlciBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyMTA5LnR4dCBicm93c2VyIG11c3QgYWxsb3cgYXQgbWluaW11bToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDIwIGNvb2tpZXMgcGVyIHVuaXF1ZSBkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSA0MDk2IGJ5dGVzIHBlciBjb29raWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciICsgbmFtZSArICInIHBvc3NpYmx5IG5vdCBzZXQgb3Igb3ZlcmZsb3dlZCBiZWNhdXNlIGl0IHdhcyB0b28gbGFyZ2UgKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgICAgICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcmVkLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25pb3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAgICAgICAqCiAgICAgICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAgICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAgICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24gKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyLmRlZmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgZGVmZXJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVseSBjYW5jZWxlZC4KICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyLmNhbmNlbCA9IGZ1bmN0aW9uIChkZWZlcklkKSB7CiAgICAgICAgICAgIGlmIChwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF0pIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgICAgICAgICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgIH0KCiAgICBmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9nJywgJyRzbmlmZmVyJywgJyRkb2N1bWVudCcsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkd2luZG93LCAkbG9nLCAkc25pZmZlciwgJGRvY3VtZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJyb3dzZXIoJHdpbmRvdywgJGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcik7CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmFjdG9yeSB0aGF0IGNvbnN0cnVjdHMgY2FjaGUgb2JqZWN0cy4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICAgKgogICAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlLgogICAgICogLSBge3sqfX1gIGBnZXQoe3N0cmluZ30ga2V5KWAg4oCUIFJldHVybnMgY2FjaGVkIHZhbHVlIGZvciBga2V5YCBvciB1bmRlZmluZWQgZm9yIGNhY2hlIG1pc3MuCiAgICAgKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZUFsbCgpYCDigJQgUmVtb3ZlcyBhbGwgY2FjaGVkIHZhbHVlcy4KICAgICAqIC0gYHt2b2lkfWAgYGRlc3Ryb3koKWAg4oCUIFJlbW92ZXMgcmVmZXJlbmNlcyB0byB0aGlzIGNhY2hlIGZyb20gJGNhY2hlRmFjdG9yeS4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDYWNoZUZhY3RvcnlQcm92aWRlcigpIHsKCiAgICAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY2FjaGVzID0ge307CgogICAgICAgICAgICBmdW5jdGlvbiBjYWNoZUZhY3RvcnkoY2FjaGVJZCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKGNhY2hlSWQgaW4gY2FjaGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ2NhY2hlSWQgJyArIGNhY2hlSWQgKyAnIHRha2VuJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHNpemUgPSAwLAogICAgICAgICAgICAgICAgICAgIHN0YXRzID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7aWQ6IGNhY2hlSWR9KSwKICAgICAgICAgICAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICAgICAgICAgICAgY2FwYWNpdHkgPSAob3B0aW9ucyAmJiBvcHRpb25zLmNhcGFjaXR5KSB8fCBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSB7fSwKICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc3RhbGVFbmQgPSBudWxsOwoKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF0gPSB7CgogICAgICAgICAgICAgICAgICAgIHB1dDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldIHx8IChscnVIYXNoW2tleV0gPSB7a2V5OiBrZXl9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubiwgbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBpbmZvOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7c2l6ZTogc2l6ZX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeSAhPSBmcmVzaEVuZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YWxlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxpbmsobmV4dEVudHJ5LCBwcmV2RW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGNhY2hlRmFjdG9yeS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSB7fTsKICAgICAgICAgICAgICAgIGZvckVhY2goY2FjaGVzLCBmdW5jdGlvbiAoY2FjaGUsIGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgICAgfTsKCgogICAgICAgICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24gKGNhY2hlSWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF07CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHRlbXBsYXRlQ2FjaGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENhY2hlIHVzZWQgZm9yIHN0b3JpbmcgaHRtbCB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbiAoJGNhY2hlRmFjdG9yeSkgewogICAgICAgICAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgndGVtcGxhdGVzJyk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyogISBWQVJJQUJMRS9GVU5DVElPTiBOQU1JTkcgQ09OVkVOVElPTlMgVEhBVCBBUFBMWSBUTyBUSElTIEZJTEUhCiAgICAgKgogICAgICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogICAgICoKICAgICAqIC0gIm5vZGUiIC0gRE9NIE5vZGUKICAgICAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogICAgICogLSAiJG5vZGUiIG9yICIkZWxlbWVudCIgLSBqcUxpdGUtd3JhcHBlZCBub2RlIG9yIGVsZW1lbnQKICAgICAqCiAgICAgKgogICAgICogQ29tcGlsZXIgcmVsYXRlZCBzdHVmZjoKICAgICAqCiAgICAgKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICAgICAqIC0gIm5vZGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUKICAgICAqIC0gImNoaWxkTGlua0ZuIiAtICBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBjaGlsZCBub2RlcyBvZiBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAgICAgKi8KCgogICAgdmFyIE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gPSAnTm9uLWFzc2lnbmFibGUgbW9kZWwgZXhwcmVzc2lvbjogJzsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbXBpbGVzIGEgcGllY2Ugb2YgSFRNTCBzdHJpbmcgb3IgRE9NIGludG8gYSB0ZW1wbGF0ZSBhbmQgcHJvZHVjZXMgYSB0ZW1wbGF0ZSBmdW5jdGlvbiwgd2hpY2gKICAgICAqIGNhbiB0aGVuIGJlIHVzZWQgdG8gbGluayB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gYW5kIHRoZSB0ZW1wbGF0ZSB0b2dldGhlci4KICAgICAqCiAgICAgKiBUaGUgY29tcGlsYXRpb24gaXMgYSBwcm9jZXNzIG9mIHdhbGtpbmcgdGhlIERPTSB0cmVlIGFuZCB0cnlpbmcgdG8gbWF0Y2ggRE9NIGVsZW1lbnRzIHRvCiAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uIEZvciBlYWNoIG1hdGNoIGl0CiAgICAgKiBleGVjdXRlcyBjb3JyZXNwb25kaW5nIHRlbXBsYXRlIGZ1bmN0aW9uIGFuZCBjb2xsZWN0cyB0aGUKICAgICAqIGluc3RhbmNlIGZ1bmN0aW9ucyBpbnRvIGEgc2luZ2xlIHRlbXBsYXRlIGZ1bmN0aW9uIHdoaWNoIGlzIHRoZW4gcmV0dXJuZWQuCiAgICAgKgogICAgICogVGhlIHRlbXBsYXRlIGZ1bmN0aW9uIGNhbiB0aGVuIGJlIHVzZWQgb25jZSB0byBwcm9kdWNlIHRoZSB2aWV3IG9yIGFzIGl0IGlzIHRoZSBjYXNlIHdpdGgKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgcmVwZWF0ZXJ9IG1hbnktdGltZXMsIGluIHdoaWNoCiAgICAgKiBjYXNlIGVhY2ggY2FsbCByZXN1bHRzIGluIGEgdmlldyB0aGF0IGlzIGEgRE9NIGNsb25lIG9mIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZS4KICAgICAqCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0iY29tcGlsZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICAvLyBkZWNsYXJlIGEgbmV3IG1vZHVsZSwgYW5kIGluamVjdCB0aGUgJGNvbXBpbGVQcm92aWRlcgogICAgIGFuZ3VsYXIubW9kdWxlKCdjb21waWxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0iaHRtbCI+PC90ZXh0YXJlYT4gPGJyPgogICAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBhdXRvIGNvbXBpbGUnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIGlucHV0KCdodG1sJykuZW50ZXIoJ3t7bmFtZX19IScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJ2Rpdltjb21waWxlXScpLnRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgoKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoZW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICAgICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZVssIGNsb25lQXR0YWNoRm5dKX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICAgKgogICAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgICAqICAgICAgICAgICAgICAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAgICogICAgICAgICAgICAgICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgICAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICAgKgogICAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAgICoKICAgICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwgZWxlbWVudAogICAgICogcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICAgKgogICAgICogLSBJZiB5b3UgYXJlIG5vdCBhc2tpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdG8gY2xvbmUgdGhlIHRlbXBsYXRlLCBjcmVhdGUgdGhlIERPTSBlbGVtZW50KHMpCiAgICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPHA+e3t0b3RhbH19PC9wPicpKHNjb3BlKTsKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgdGVtcGxhdGVIVE1MID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgICAqCiAgICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUhUTUwpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIC8vbm93IHdlIGhhdmUgcmVmZXJlbmNlIHRvIHRoZSBjbG9uZWQgRE9NIHZpYSBgY2xvbmVgCiAgICAgKiAgIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgaW5mb3JtYXRpb24gb24gaG93IHRoZSBjb21waWxlciB3b3Jrcywgc2VlIHRoZQogICAgICoge0BsaW5rIGd1aWRlL2NvbXBpbGVyIEFuZ3VsYXIgSFRNTCBDb21waWxlcn0gc2VjdGlvbiBvZiB0aGUgRGV2ZWxvcGVyIEd1aWRlLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAqIEBuYW1lIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICovCiAgICAkQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CiAgICBmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgICAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdcLV9dKylccysoLiopJC8sCiAgICAgICAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd1wtX10rKSg/Olw6KFteO10rKSk/Oz8pLywKICAgICAgICAgICAgTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiA9ICdUZW1wbGF0ZSBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB3YXM6ICcsCiAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfGZpbGUpOi87CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmVzIHdpdGggdGhlIGNvbXBpbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UuIChpZSA8Y29kZT5uZ0JpbmQ8L2NvZGU+IHdoaWNoIHdpbGwgbWF0Y2ggYXMKICAgICAgICAgKiAgICAgICAgICAgICAgICA8Y29kZT5uZy1iaW5kPC9jb2RlPikuCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBBbiBpbmplY3RhYmxlIGRpcmVjdGl2ZSBmYWN0cm95IGZ1bmN0aW9uLiBTZWUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZX0gZm9yIG1vcmUKICAgICAgICAgKiAgICAgICAgICAgICAgICBpbmZvLgogICAgICAgICAqIEByZXR1cm5zIHtuZy4kY29tcGlsZVByb3ZpZGVyfSBTZWxmIGZvciBjaGFpbmluZy4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmRpcmVjdGl2ZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG5hbWUpKSB7CiAgICAgICAgICAgICAgICBhc3NlcnRBcmcoZGlyZWN0aXZlRmFjdG9yeSwgJ2RpcmVjdGl2ZScpOwogICAgICAgICAgICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24gKGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlID0gJGluamVjdG9yLmludm9rZShkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0geyBjb21waWxlOiB2YWx1ZUZuKGRpcmVjdGl2ZSkgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlyZWN0aXZlLmNvbXBpbGUgJiYgZGlyZWN0aXZlLmxpbmspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5IHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZSB8fCAoZGlyZWN0aXZlLmNvbnRyb2xsZXIgJiYgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0EnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI3VybFNhbml0aXphdGlvbldoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgICAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICAgICAqCiAgICAgICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8gYW4KICAgICAgICAgKiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIHJlZ3VsYXIKICAgICAgICAgKiBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSB0aGUKICAgICAgICAgKiBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpdCBpcyB3cml0dGVuIGludG8gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAgICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICAgICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMudXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHJlZ2V4cCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cmxTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsKICAgICAgICAgICAgJyRpbmplY3RvcicsICckaW50ZXJwb2xhdGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJHBhcnNlJywKICAgICAgICAgICAgJyRjb250cm9sbGVyJywgJyRyb290U2NvcGUnLCAnJGRvY3VtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGludGVycG9sYXRlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcGFyc2UsICRjb250cm9sbGVyLCAkcm9vdFNjb3BlLCAkZG9jdW1lbnQpIHsKCiAgICAgICAgICAgICAgICB2YXIgQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBBdHRyaWJ1dGVzLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgICAgICAgICAgICAgICAqICAgICBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgd3JpdGVBdHRyLCBhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm9vbGVhbktleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTmFtZV8odGhpcy4kJGVsZW1lbnRbMF0pID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybFNhbml0aXphdGlvbk5vZGUuc2V0QXR0cmlidXRlKCdocmVmJywgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhyZWYgcHJvcGVydHkgYWx3YXlzIHJldHVybnMgbm9ybWFsaXplZCBhYnNvbHV0ZSB1cmwsIHNvIHdlIGNhbiBtYXRjaCBhZ2FpbnN0IHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxTYW5pdGl6YXRpb25Ob2RlLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vcm1hbGl6ZWRWYWwubWF0Y2godXJsU2FuaXRpemF0aW9uV2hpdGVsaXN0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIE9ic2VydmUgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICAgKiBUaGUgb2JzZXJ2ZXIgd2lsbCBuZXZlciBiZSBjYWxsZWQsIGlmIGdpdmVuIGF0dHJpYnV0ZSBpcyBub3QgaW50ZXJwb2xhdGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigqKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgYXR0cmlidXRlIHZhbHVlIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCopfSB0aGUgYGZuYCBGdW5jdGlvbiBwYXNzZWQgaW4uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9ic2VydmU6IGZ1bmN0aW9uIChrZXksIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycyA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sID09ICd9fScpCiAgICAgICAgICAgICAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1x7L2csIHN0YXJ0U3ltYm9sKS5yZXBsYWNlKC99fS9nLCBlbmRTeW1ib2wpOwogICAgICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHJldHVybiBjb21waWxlOwoKICAgICAgICAgICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgbWF4UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoISgkY29tcGlsZU5vZGVzIGluc3RhbmNlb2YganFMaXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBqcXVlcnkgYWx3YXlzIHJld3JhcHMsIHdoZXJlYXMgd2UgbmVlZCB0byBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgc2VsZWN0b3Igc28gdGhhdCB3ZSBjYW4gbW9kaWZ5IGl0LgogICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBXZSBjYW4gbm90IGNvbXBpbGUgdG9wIGxldmVsIHRleHQgZWxlbWVudHMgc2luY2UgdGV4dCBub2RlcyBjYW4gYmUgbWVyZ2VkIGFuZCB3ZSB3aWxsCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCgkY29tcGlsZU5vZGVzLCBmdW5jdGlvbiAobm9kZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMyAvKiB0ZXh0IG5vZGUgKi8gJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmcoc2NvcGUsICdzY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHNvbWV0aW1lcyBjaGFuZ2VzIHRoZSBzdHJ1Y3R1cmUgb2YgdGhlIERPTS4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRsaW5rTm9kZSA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IEpRTGl0ZVByb3RvdHlwZS5jbG9uZS5jYWxsKCRjb21waWxlTm9kZXMpIC8vIElNUE9SVEFOVCEhIQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXR0YWNoIHNjb3BlIG9ubHkgdG8gbm9uLXRleHQgbm9kZXMuCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9ICRsaW5rTm9kZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEgLyogZWxlbWVudCAqLyB8fCBub2RlLm5vZGVUeXBlID09IDkgLyogZG9jdW1lbnQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbGlua05vZGUuZXEoaSkuZGF0YSgnJHNjb3BlJywgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkbGlua05vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcG9zaXRlTGlua0ZuKSBjb21wb3NpdGVMaW5rRm4oc2NvcGUsICRsaW5rTm9kZSwgJGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRsaW5rTm9kZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHdyb25nTW9kZShsb2NhbE5hbWUsIG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5zdXBwb3J0ZWQgJyIgKyBtb2RlICsgIicgZm9yICciICsgbG9jYWxOYW1lICsgIicuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlLCBzaW5jZSBpdCBtZWFucyB0aGF0IHdlIGFyZSB0cnlpbmcgdG8gc2V0IGNsYXNzIG9uCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNWRyBlbGVtZW50LCB3aGVyZSBjbGFzcyBuYW1lIGlzIHJlYWQtb25seS4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAqIGZvciBhIHBhcnRpY3VsYXIgbm9kZSBhcmUgY29sbGVjdGVkIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhlIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9ucyByZXR1cm4gdmFsdWVzIC0gdGhlIGxpbmtpbmcgZnVuY3Rpb25zIC0gYXJlIGNvbWJpbmVkIGludG8gYSBjb21wb3NpdGUgbGlua2luZwogICAgICAgICAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZUxpc3R9IG5vZGVMaXN0IGFuIGFycmF5IG9mIG5vZGVzIG9yIE5vZGVMaXN0IHRvIGNvbXBpbGUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnQ9fSAkcm9vdEVsZW1lbnQgSWYgdGhlIG5vZGVMaXN0IGlzIHRoZSByb290IG9mIHRoZSBjb21waWxhdGlvbiB0cmVlIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBuZWVkZWQgc28gdGhhdCB0aGUganFMaXRlIGNvbGxlY3Rpb24gaXRlbXMgY2FuIGJlIHJlcGxhY2VkIHdpdGggd2lkZ2V0cy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4IGRpcmVjdGl2ZSBwcmlvcml0eQogICAgICAgICAgICAgICAgICogQHJldHVybnMgez9mdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlTm9kZXMobm9kZUxpc3QsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LCBtYXhQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBkaXJlY3RpdmVzLCBhdHRycywgbGlua0ZuRm91bmQ7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZUxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBuZXcgQXR0cmlidXRlcygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMobm9kZUxpc3RbaV0sIFtdLCBhdHRycywgbWF4UHJpb3JpdHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIG5vZGVMaXN0W2ldLCBhdHRycywgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMgfHwgIW5vZGVMaXN0W2ldLmNoaWxkTm9kZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm5zLnB1c2gobm9kZUxpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbnMucHVzaChjaGlsZExpbmtGbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCBjaGlsZFNjb3BlLCBjaGlsZFRyYW5zY2x1ZGVGbiwgaSwgaWksIG47CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWJsZU5vZGVMaXN0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gbm9kZUxpc3QubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG4gPSAwLCBpaSA9IGxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuID0gbGlua0Zuc1tpKytdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4uc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoaXNPYmplY3Qobm9kZUxpbmtGbi5zY29wZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUobm9kZSkuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IG5vZGVMaW5rRm4udHJhbnNjbHVkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRUcmFuc2NsdWRlRm4gfHwgKCFib3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAodHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjbG9uZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZVNjb3BlLCBjbG9uZUZuKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmQoJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlU2NvcGUsIHRyYW5zY2x1ZGVTY29wZS4kZGVzdHJveSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAgICAgICAgICogICAgICAgIHRoZSBmdW5jdGlvbiByZXR1cm5zLgogICAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IC8qIEVsZW1lbnQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKS50b0xvd2VyQ2FzZSgpKSwgJ0UnLCBtYXhQcmlvcml0eSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSAwLCBqaiA9IG5BdHRycyAmJiBuQXR0cnMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIgPSBuQXR0cnNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5OYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnTScsIG1heFByaW9yaXR5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQgY29tbWVudCdzIG5vZGUgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgICAgICAgICAqICAgICAgICBhcmd1bWVudCBoYXMgdGhlIHJvb3QganFMaXRlIGFycmF5IHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMgb24gaXQuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sIGpxQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIHByZXZlbnQgZnVydGhlciBwcm9jZXNzaW5nIG9mIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUgPSBuZXdTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCB0cmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9PSAnZWxlbWVudCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKyB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBqcUxpdGUoJHRlbXBsYXRlWzBdKSwgY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZShKUUxpdGVDbG9uZShjb21waWxlTm9kZSkpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOyAvLyBjbGVhciBjb250ZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRlbm9ybWFsaXplVGVtcGxhdGUoZGlyZWN0aXZlVmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJpbShkaXJlY3RpdmVWYWx1ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoTVVMVElfUk9PVF9URU1QTEFURV9FUlJPUiArIGRpcmVjdGl2ZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gc3BsaXQgaXQgaW50byB0d28gcGFydHMsIHRob3NlIHRoYXQgd2VyZSBhbHJlYWR5IGFwcGxpZWQgYW5kIHRob3NlIHRoYXQgd2VyZW4ndAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlLCBhZGQgdGhlbSB0byB0aGUgc2Vjb25kIGdyb3VwIGFuZCBzb3J0IHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAtIGFwcGVuZCB0aGUgc2Vjb25kIGdyb3VwIHdpdGggbmV3IGRpcmVjdGl2ZXMgdG8gdGhlIGZpcnN0IGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy5zcGxpY2UoaSArIDEsIGRpcmVjdGl2ZXMubGVuZ3RoIC0gKGkgKyAxKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUZW1wbGF0ZUF0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcy5zcGxpY2UoaSwgZGlyZWN0aXZlcy5sZW5ndGggLSBpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgZGlyZWN0aXZlLnJlcGxhY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkaXJlY3RpdmUuY29tcGlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBkaXJlY3RpdmUuY29tcGlsZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaW5rRm4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRMaW5rRm5zKGxpbmtGbi5wcmUsIGxpbmtGbi5wb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4udGVybWluYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IE1hdGgubWF4KHRlcm1pbmFsUHJpb3JpdHksIGRpcmVjdGl2ZS5wcmlvcml0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnNjb3BlID0gbmV3U2NvcGVEaXJlY3RpdmUgJiYgbmV3U2NvcGVEaXJlY3RpdmUuc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gdHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gbWlnaHQgYmUgbm9ybWFsIG9yIGRlbGF5ZWQgbm9kZUxpbmtGbiBkZXBlbmRpbmcgb24gaWYgdGVtcGxhdGVVcmwgaXMgcHJlc2VudAogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlTGlua0ZuOwoKICAgICAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRMaW5rRm5zKHByZSwgcG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3QucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdExpbmtGbnMucHVzaChwb3N0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocmVxdWlyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgodmFsdWUgPSByZXF1aXJlLmNoYXJBdCgwKSkgPT0gJ14nIHx8IHZhbHVlID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ14nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uYWwgPSBvcHRpb25hbCB8fCB2YWx1ZSA9PSAnPyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlICYmICFvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJObyBjb250cm9sbGVyOiAiICsgcmVxdWlyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocmVxdWlyZSwgZnVuY3Rpb24gKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGlsZU5vZGUgPT09IGxpbmtOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSlccyooXHcqKVxzKiQvOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlLiRwYXJlbnQgfHwgc2NvcGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uIChkZWZpbml0b24sIHNjb3BlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IG1hdGNoWzJdIHx8IHNjb3BlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0LCBwYXJlbnRTZXQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGNoYW5nZSwgb3Igd2Ugd2lsbCB0aHJvdyB0aGlzIGV4Y2VwdGlvbiBvbiBldmVyeSAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiArIGF0dHJzW2F0dHJOYW1lXSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgKGRpcmVjdGl2ZTogJyArIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lICsgJyknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBwYXJlbnRWYWx1ZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gc2NvcGVbc2NvcGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgb3V0IG9mIHN5bmMgYW5kIG5lZWQgdG8gY29weQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNoYW5nZWQgYW5kIGl0IGhhcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgcGFyZW50IGNhbiBiZSBhc3NpZ25lZCB0aGVuIGRvIHNvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTZXQocGFyZW50U2NvcGUsIHBhcmVudFZhbHVlID0gbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHBhcmVudFNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCBpc29sYXRlIHNjb3BlIGRlZmluaXRpb24gZm9yIGRpcmVjdGl2ZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSArICc6ICcgKyBkZWZpbml0b24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyRGlyZWN0aXZlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChjb250cm9sbGVyRGlyZWN0aXZlcywgZnVuY3Rpb24gKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IGJvdW5kVHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyQnICsgZGlyZWN0aXZlLm5hbWUgKyAnQ29udHJvbGxlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcHJlTGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUkVDVVJTSU9OCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gcG9zdExpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4gPSBwb3N0TGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rRm4oc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCBkZWNvcmF0ZXMgaXQgd2l0aCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIHByb3BlciBwYXJhbWV0ZXJzLiBXZQogICAgICAgICAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAgICAgICAgICogICBTdHJpbmcgY29udGFpbmluZyBhbnkgb2YgdGhlc2VzIGNoYXJhY3RlcnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICAgICAgICAgKiAgICogYEEnOiBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgICAqICAgKiBgQ2A6IGNsYXNzCiAgICAgICAgICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgYWRkZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtYXhQcmlvcml0eSA9PT0gdW5kZWZpbmVkIHx8IG1heFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QuaW5kZXhPZihsb2NhdGlvbikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdERpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICogb24gdGhlIHRlbXBsYXRlIG5lZWQgdG8gYmUgbWVyZ2VkIHdpdGggdGhlIGV4aXN0aW5nIGF0dHJpYnV0ZXMgaW4gdGhlIERPTS4KICAgICAgICAgICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gZHN0IGRlc3RpbmF0aW9uIGF0dHJpYnV0ZXMgKG9yaWdpbmFsIERPTSkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXMoZHN0LCBzcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgICAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBuZXcgYXR0cmlidXRlcyBvbiB0aGUgb2xkIGF0dHJzIG9iamVjdAogICAgICAgICAgICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsICRlbGVtZW50LmF0dHIoJ3N0eWxlJykgKyAnOycgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0QXR0cltrZXldID0gc3JjQXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdEF0dHJzLCAkcm9vdEVsZW1lbnQsIHJlcGxhY2UsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmtRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUgPSBkaXJlY3RpdmVzLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSgnPGRpdj4nICsgdHJpbShjb250ZW50KSArICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHRlbXBsYXRlLmxlbmd0aCAhPSAxIHx8IGNvbXBpbGVOb2RlLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihNVUxUSV9ST09UX1RFTVBMQVRFX0VSUk9SICsgY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wVGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIGRpcmVjdGl2ZXMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMudW5zaGlmdChkZXJpdmVkU3luY0RpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpbmtRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1Jvb3RFbGVtZW50ID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlID0gbGlua1F1ZXVlLnBvcCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IGxpbmtRdWV1ZS5wb3AoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBjb21waWxlTm9kZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9IEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgobGlua1Jvb3RFbGVtZW50LCBqcUxpdGUoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSksIGxpbmtOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbiAocmVzcG9uc2UsIGNvZGUsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHRlbXBsYXRlOiAnICsgY29uZmlnLnVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlua1F1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHJvb3RFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTm9kZUxpbmtGbihhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5wcmlvcml0eSAtIGEucHJpb3JpdHk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFzc2VydE5vRHVwbGljYXRlKHdoYXQsIHByZXZpb3VzRGlyZWN0aXZlLCBkaXJlY3RpdmUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ011bHRpcGxlIGRpcmVjdGl2ZXMgWycgKyBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lICsgJywgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUubmFtZSArICddIGFza2luZyBmb3IgJyArIHdoYXQgKyAnIG9uOiAnICsgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh0ZXh0LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHBhcmVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goaW50ZXJwb2xhdGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbMF0ubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHZhbHVlLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCgogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gYXR0ckludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGludGVycG9sYXRlIGNsYXNzZXMgYWdhaW4sIGluIHRoZSBjYXNlIHRoZSBlbGVtZW50IHdhcyByZXBsYWNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB0aGVyZWZvcmUgdGhlIHR3byBjbGFzcyBhdHRycyBnb3QgbWVyZ2VkIC0gd2Ugd2FudCB0byBpbnRlcnBvbGF0ZSB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyW25hbWVdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCQkb2JzZXJ2ZXJzW25hbWVdIHx8ICgkJG9ic2VydmVyc1tuYW1lXSA9IFtdKSkuJCRpbnRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIGEgc3BlY2lhbCBqcUxpdGUucmVwbGFjZVdpdGgsIHdoaWNoIGNhbiByZXBsYWNlIGl0ZW1zIHdoaWNoCiAgICAgICAgICAgICAgICAgKiBoYXZlIG5vIHBhcmVudHMsIHByb3ZpZGVkIHRoYXQgdGhlIGNvbnRhaW5pbmcganFMaXRlIGNvbGxlY3Rpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtKcUxpdGU9fSAkcm9vdEVsZW1lbnQgVGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZS4gVXNlZCBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgICAgICAgICAgICAgKiAgICBpbiB0aGUgcm9vdCBvZiB0aGUgdHJlZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlfSAkZWxlbWVudCBUaGUganFMaXRlIGVsZW1lbnQgd2hpY2ggd2UgYXJlIGdvaW5nIHRvIHJlcGxhY2UuIFdlIGtlZXAgdGhlIHNoZWxsLAogICAgICAgICAgICAgICAgICogICAgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Tm9kZX0gbmV3Tm9kZSBUaGUgbmV3IERPTSBub2RlLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsICRlbGVtZW50LCBuZXdOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZE5vZGUgPSAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkTm9kZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgICBpLCBpaTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50W2ldID09IG9sZE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSBuZXdOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IG9sZE5vZGVbanFMaXRlLmV4cGFuZG9dOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaVJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4KICAgICAqLwoKCiAgICAvKioKICAgICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAgICovCgogICAgZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLCAvKiBOb2RlTGlzdCAqLyBub2RlTGlzdCwgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICB9CgogICAgZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwgLyogTm9kZSAqLyBub2RlLCAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LCAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlciBzZXJ2aWNlfSBpcyB1c2VkIGJ5IEFuZ3VsYXIgdG8gY3JlYXRlIG5ldwogICAgICogY29udHJvbGxlcnMuCiAgICAgKgogICAgICogVGhpcyBwcm92aWRlciBhbGxvd3MgY29udHJvbGxlciByZWdpc3RyYXRpb24gdmlhIHRoZQogICAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgICAqLwogICAgZnVuY3Rpb24gJENvbnRyb2xsZXJQcm92aWRlcigpIHsKICAgICAgICB2YXIgY29udHJvbGxlcnMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGNvbnRyb2xsZXJQcm92aWRlcgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAgICAgKiAgICBhbm5vdGF0aW9ucyBpbiB0aGUgYXJyYXkgbm90YXRpb24pLgogICAgICAgICAqLwogICAgICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbiAobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlcnMsIG5hbWUpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sbGVyc1tuYW1lXSA9IGNvbnN0cnVjdG9yOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJGluamVjdG9yLCAkd2luZG93KSB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRjb250cm9sbGVyCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGNvbnN0cnVjdG9yIElmIGNhbGxlZCB3aXRoIGEgZnVuY3Rpb24gdGhlbiBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgdGhlCiAgICAgICAgICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICAgICAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgICAgICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGB3aW5kb3dbY29uc3RydWN0b3JdYCBvbiB0aGUgZ2xvYmFsIGB3aW5kb3dgIG9iamVjdAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIEluamVjdGlvbiBsb2NhbHMgZm9yIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gSW5zdGFuY2Ugb2YgZ2l2ZW4gY29udHJvbGxlci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIGAkY29udHJvbGxlcmAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgaW5zdGFudGlhdGluZyBjb250cm9sbGVycy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQncyBqdXN0IGEgc2ltcGxlIGNhbGwgdG8ge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0sIGJ1dCBleHRyYWN0ZWQgaW50bwogICAgICAgICAgICAgKiBhIHNlcnZpY2UsIHNvIHRoYXQgb25lIGNhbiBvdmVycmlkZSB0aGlzIHNlcnZpY2Ugd2l0aCB7QGxpbmsgaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTY0OTc4OAogICAgICAgICAgICAgKiBCQyB2ZXJzaW9ufS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoY29uc3RydWN0b3IsIGxvY2FscykgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGNvbnN0cnVjdG9yKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2V0dGVyKGxvY2Fscy4kc2NvcGUsIG5hbWUsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBuYW1lLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oY29uc3RydWN0b3IsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IsIGxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kZG9jdW1lbnQKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogICAgICogZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gJERvY3VtZW50UHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKHdpbmRvdykgewogICAgICAgICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRleGNlcHRpb25IYW5kbGVyCiAgICAgKiBAcmVxdWlyZXMgJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICAgKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBzaW1wbHkgZGVsZWdhdGVzIHRvIGAkbG9nLmVycm9yYCB3aGljaCBsb2dzIGl0IGludG8KICAgICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICAgKgogICAgICogSW4gdW5pdCB0ZXN0cywgaWYgYGFuZ3VsYXItbW9ja3MuanNgIGlzIGxvYWRlZCwgdGhpcyBzZXJ2aWNlIGlzIG92ZXJyaWRkZW4gYnkKICAgICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gY2F1c2Ugb3B0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGNvbnRleHQgaW4gd2hpY2gKICAgICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCBmdW5jdGlvbiAoJGxvZykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IuYXBwbHkoJGxvZywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRJbnRlcnBvbGF0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBzdGFydFN5bWJvbCA9ICd7eyc7CiAgICAgICAgdmFyIGVuZFN5bWJvbCA9ICd9fSc7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGVQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgc3RhcnRpbmcgc3ltYm9sIHRvLgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd8c2VsZn0gUmV0dXJucyB0aGUgc3ltYm9sIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcyBzZXR0ZXIuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgZW5kaW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuZW5kU3ltYm9sID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICAgICAgICAgIGVuZFN5bWJvbExlbmd0aCA9IGVuZFN5bWJvbC5sZW5ndGg7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJlcXVpcmVzICRwYXJzZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQ29tcGlsZXMgYSBzdHJpbmcgd2l0aCBtYXJrdXAgaW50byBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBUaGlzIHNlcnZpY2UgaXMgdXNlZCBieSB0aGUKICAgICAgICAgICAgICogSFRNTCB7QGxpbmsgbmcuJGNvbXBpbGUgJGNvbXBpbGV9IHNlcnZpY2UgZm9yIGRhdGEgYmluZGluZy4gU2VlCiAgICAgICAgICAgICAqIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciAkaW50ZXJwb2xhdGVQcm92aWRlcn0gZm9yIGNvbmZpZ3VyaW5nIHRoZQogICAgICAgICAgICAgKiBpbnRlcnBvbGF0aW9uIG1hcmt1cC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgIDxwcmU+CiAgICAgICAgICAgICB2YXIgJGludGVycG9sYXRlID0gLi4uOyAvLyBpbmplY3RlZAogICAgICAgICAgICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgnSGVsbG8ge3tuYW1lfX0hJyk7CiAgICAgICAgICAgICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgICAgICAgICA8L3ByZT4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG11c3RIYXZlRXhwcmVzc2lvbiBpZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBpbnRlcnBvbGF0aW9uIHN0cmluZyBtdXN0IGhhdmUKICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiBpbiBvcmRlciB0byByZXR1cm4gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gU3RyaW5ncyB3aXRoIG5vCiAgICAgICAgICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0KX0gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlIGludGVycG9sYXRlZAogICAgICAgICAgICAgKiAgICBzdHJpbmcuIFRoZSBmdW5jdGlvbiBoYXMgdGhlc2UgcGFyYW1ldGVyczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGA6IGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncyBhcmUgZXZhbHVhdGVkCiAgICAgICAgICAgICAqICAgICAgYWdhaW5zdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uICRpbnRlcnBvbGF0ZSh0ZXh0LCBtdXN0SGF2ZUV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4LAogICAgICAgICAgICAgICAgICAgIGVuZEluZGV4LAogICAgICAgICAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRleHQubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBmbiwKICAgICAgICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgICAgICAgY29uY2F0ID0gW107CgogICAgICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uIHx8IGhhc0ludGVycG9sYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBjb25jYXQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZuID0gZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbGVuZ3RoLCBwYXJ0OyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFydCAhPSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmNhdC5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICAgICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI2VuZFN5bWJvbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkaW50ZXJwb2xhdGU7CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIFVSTF9NQVRDSCA9IC9eKFteOl0rKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcez9bXHdcLi1dKlx9PykoOihbMC05XSspKT8oXC9bXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIFBBVEhfTUFUQ0ggPSAvXihbXlw/I10qKT8oXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgICAgIEhBU0hfTUFUQ0ggPSBQQVRIX01BVENILAogICAgICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzogMjF9OwoKCiAgICAvKioKICAgICAqIEVuY29kZSBwYXRoIHVzaW5nIGVuY29kZVVyaVNlZ21lbnQsIGlnbm9yaW5nIGZvcndhcmQgc2xhc2hlcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFBhdGggdG8gZW5jb2RlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICAgICAgICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJyksCiAgICAgICAgICAgIGkgPSBzZWdtZW50cy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBlbmNvZGVVcmlTZWdtZW50KHNlZ21lbnRzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7CiAgICB9CgogICAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWF0Y2hVcmwodXJsLCBvYmopIHsKICAgICAgICB2YXIgbWF0Y2ggPSBVUkxfTUFUQ0guZXhlYyh1cmwpOwoKICAgICAgICBtYXRjaCA9IHsKICAgICAgICAgICAgcHJvdG9jb2w6IG1hdGNoWzFdLAogICAgICAgICAgICBob3N0OiBtYXRjaFszXSwKICAgICAgICAgICAgcG9ydDogaW50KG1hdGNoWzVdKSB8fCBERUZBVUxUX1BPUlRTW21hdGNoWzFdXSB8fCBudWxsLAogICAgICAgICAgICBwYXRoOiBtYXRjaFs2XSB8fCAnLycsCiAgICAgICAgICAgIHNlYXJjaDogbWF0Y2hbOF0sCiAgICAgICAgICAgIGhhc2g6IG1hdGNoWzEwXQogICAgICAgIH07CgogICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgb2JqLiQkcHJvdG9jb2wgPSBtYXRjaC5wcm90b2NvbDsKICAgICAgICAgICAgb2JqLiQkaG9zdCA9IG1hdGNoLmhvc3Q7CiAgICAgICAgICAgIG9iai4kJHBvcnQgPSBtYXRjaC5wb3J0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChwcm90b2NvbCwgaG9zdCwgcG9ydCkgewogICAgICAgIHJldHVybiBwcm90b2NvbCArICc6Ly8nICsgaG9zdCArIChwb3J0ID09IERFRkFVTFRfUE9SVFNbcHJvdG9jb2xdID8gJycgOiAnOicgKyBwb3J0KTsKICAgIH0KCgogICAgZnVuY3Rpb24gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKSB7CiAgICAgICAgcmV0dXJuIGJhc2VQYXRoLnN1YnN0cigwLCBiYXNlUGF0aC5sYXN0SW5kZXhPZignLycpKTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSHRtbDVVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaHRtbDUgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSAhPSBiYXNlUGF0aCB8fCBpc1VuZGVmaW5lZChtYXRjaC5oYXNoKSB8fAogICAgICAgICAgICBtYXRjaC5oYXNoLmluZGV4T2YoaGFzaFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICAgICAgLy8gY29udmVydCBoYXNoYmFuZyB1cmwgLT4gaHRtbDUgdXJsCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpICsgbWF0Y2guaGFzaC5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gY29udmVydFRvSGFzaGJhbmdVcmwodXJsLCBiYXNlUGF0aCwgaGFzaFByZWZpeCkgewogICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCk7CgogICAgICAgIC8vIGFscmVhZHkgaGFzaGJhbmcgdXJsCiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5wYXRoKSA9PSBiYXNlUGF0aCAmJiAhaXNVbmRlZmluZWQobWF0Y2guaGFzaCkgJiYKICAgICAgICAgICAgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgaHRtbDUgdXJsIC0+IGhhc2hiYW5nIHVybAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSBtYXRjaC5zZWFyY2ggJiYgJz8nICsgbWF0Y2guc2VhcmNoIHx8ICcnLAogICAgICAgICAgICAgICAgaGFzaCA9IG1hdGNoLmhhc2ggJiYgJyMnICsgbWF0Y2guaGFzaCB8fCAnJywKICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4RnJvbUJhc2UoYmFzZVBhdGgpLAogICAgICAgICAgICAgICAgcGF0aCA9IG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKTsKCiAgICAgICAgICAgIGlmIChtYXRjaC5wYXRoLmluZGV4T2YocGF0aFByZWZpeCkgIT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdJbnZhbGlkIHVybCAiJyArIHVybCArICciLCBtaXNzaW5nIHBhdGggcHJlZml4ICInICsgcGF0aFByZWZpeCArICciICEnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KG1hdGNoLnByb3RvY29sLCBtYXRjaC5ob3N0LCBtYXRjaC5wb3J0KSArIGJhc2VQYXRoICsKICAgICAgICAgICAgICAgICcjJyArIGhhc2hQcmVmaXggKyBwYXRoICsgc2VhcmNoICsgaGFzaDsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25VcmwgcmVwcmVzZW50cyBhbiB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIVE1MNSB1cmwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoUHJlZml4CiAgICAgKi8KICAgIGZ1bmN0aW9uIExvY2F0aW9uVXJsKHVybCwgcGF0aFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4IHx8ICcnOwoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZSBnaXZlbiBodG1sNSAocmVndWxhcikgdXJsIHN0cmluZyBpbnRvIHByb3BlcnRpZXMKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3QWJzb2x1dGVVcmwgSFRNTDUgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAobmV3QWJzb2x1dGVVcmwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hVcmwobmV3QWJzb2x1dGVVcmwsIHRoaXMpOwoKICAgICAgICAgICAgaWYgKG1hdGNoLnBhdGguaW5kZXhPZihwYXRoUHJlZml4KSAhPT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgdXJsICInICsgbmV3QWJzb2x1dGVVcmwgKyAnIiwgbWlzc2luZyBwYXRoIHByZWZpeCAiJyArIHBhdGhQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLnBhdGguc3Vic3RyKHBhdGhQcmVmaXgubGVuZ3RoKSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoLnNlYXJjaCk7CiAgICAgICAgICAgIHRoaXMuJCRoYXNoID0gbWF0Y2guaGFzaCAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2guaGFzaCkgfHwgJyc7CgogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICAgICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICAgICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgICAgICAgdGhpcy4kJGFic1VybCA9IGNvbXBvc2VQcm90b2NvbEhvc3RQb3J0KHRoaXMuJCRwcm90b2NvbCwgdGhpcy4kJGhvc3QsIHRoaXMuJCRwb3J0KSArCiAgICAgICAgICAgICAgICBwYXRoUHJlZml4ICsgdGhpcy4kJHVybDsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJzb2x1dGVMaW5rVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy4kJHBhcnNlKHVybCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGh0bWw1IGhpc3RvcnkgYXBpIGlzIGRpc2FibGVkIG9yIG5vdCBzdXBwb3J0ZWQKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTGVnYWN5IHVybAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCkgewogICAgICAgIHZhciBiYXNlUGF0aDsKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG1hdGNoVXJsKHVybCwgdGhpcyk7CgoKICAgICAgICAgICAgaWYgKG1hdGNoLmhhc2ggJiYgbWF0Y2guaGFzaC5pbmRleE9mKGhhc2hQcmVmaXgpICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignSW52YWxpZCB1cmwgIicgKyB1cmwgKyAnIiwgbWlzc2luZyBoYXNoIHByZWZpeCAiJyArIGhhc2hQcmVmaXggKyAnIiAhJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJhc2VQYXRoID0gbWF0Y2gucGF0aCArIChtYXRjaC5zZWFyY2ggPyAnPycgKyBtYXRjaC5zZWFyY2ggOiAnJyk7CiAgICAgICAgICAgIG1hdGNoID0gSEFTSF9NQVRDSC5leGVjKChtYXRjaC5oYXNoIHx8ICcnKS5zdWJzdHIoaGFzaFByZWZpeC5sZW5ndGgpKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkcGF0aCA9IChtYXRjaFsxXS5jaGFyQXQoMCkgPT0gJy8nID8gJycgOiAnLycpICsgZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRwYXRoID0gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoWzNdKTsKICAgICAgICAgICAgdGhpcy4kJGhhc2ggPSBtYXRjaFs1XSAmJiBkZWNvZGVVUklDb21wb25lbnQobWF0Y2hbNV0pIHx8ICcnOwoKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydCh0aGlzLiQkcHJvdG9jb2wsIHRoaXMuJCRob3N0LCB0aGlzLiQkcG9ydCkgKwogICAgICAgICAgICAgICAgYmFzZVBhdGggKyAodGhpcy4kJHVybCA/ICcjJyArIGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsIDogJycpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJCRyZXdyaXRlQXBwVXJsID0gZnVuY3Rpb24gKGFic29sdXRlTGlua1VybCkgewogICAgICAgICAgICBpZiAoYWJzb2x1dGVMaW5rVXJsLmluZGV4T2YoYXBwQmFzZVVybCkgPT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFic29sdXRlTGlua1VybDsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHRoaXMuJCRwYXJzZSh1cmwpOwogICAgfQoKCiAgICBMb2NhdGlvblVybC5wcm90b3R5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICoge0BsaW5rIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IFJGQyAzOTg2fS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgKi8KICAgICAgICBhYnNVcmw6IGxvY2F0aW9uR2V0dGVyKCckJGFic1VybCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICAgICAgICovCiAgICAgICAgdXJsOiBmdW5jdGlvbiAodXJsLCByZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgICAgICAgICAgaWYgKG1hdGNoWzFdKSB0aGlzLnBhdGgoZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKSk7CiAgICAgICAgICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgICAgICAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycsIHJlcGxhY2UpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAgICAgICAqLwogICAgICAgIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI2hvc3QKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqLwogICAgICAgIGhvc3Q6IGxvY2F0aW9uR2V0dGVyKCckJGhvc3QnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwb3J0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcG9ydCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge051bWJlcn0gcG9ydAogICAgICAgICAqLwogICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwYXRoCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAgICAgICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhdGggTmV3IHBhdGgKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgICAgICAgKi8KICAgICAgICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2Ugc2VhcmNoIHBhcnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdDxzdHJpbmcsc3RyaW5nPj19IHNlYXJjaCBOZXcgc2VhcmNoIHBhcmFtcyAtIHN0cmluZyBvciBoYXNoIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGFyYW1WYWx1ZSBJZiBgc2VhcmNoYCBpcyBhIHN0cmluZywgdGhlbiBgcGFyYW1WYWx1ZWAgd2lsbCBvdmVycmlkZSBvbmx5IGEKICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHNlYXJjaAogICAgICAgICAqLwogICAgICAgIHNlYXJjaDogZnVuY3Rpb24gKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoc2VhcmNoKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkc2VhcmNoOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChwYXJhbVZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy4kJHNlYXJjaFtzZWFyY2hdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoW3NlYXJjaF0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IGlzU3RyaW5nKHNlYXJjaCkgPyBwYXJzZUtleVZhbHVlKHNlYXJjaCkgOiBzZWFyY2g7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jaGFzaAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGhhc2ggTmV3IGhhc2ggZnJhZ21lbnQKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgICAgICAgKi8KICAgICAgICBoYXNoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRoYXNoJywgaWRlbnRpdHkpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3JlcGxhY2UKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAgICAgICAqLwogICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9OwoKICAgIExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlID0gaW5oZXJpdChMb2NhdGlvblVybC5wcm90b3R5cGUpOwoKICAgIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKHVybCwgaGFzaFByZWZpeCwgYXBwQmFzZVVybCwgYmFzZUV4dHJhKSB7CiAgICAgICAgTG9jYXRpb25IYXNoYmFuZ1VybC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKCiAgICAgICAgdGhpcy4kJHJld3JpdGVBcHBVcmwgPSBmdW5jdGlvbiAoYWJzb2x1dGVMaW5rVXJsKSB7CiAgICAgICAgICAgIGlmIChhYnNvbHV0ZUxpbmtVcmwuaW5kZXhPZihhcHBCYXNlVXJsKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZVVybCArIGJhc2VFeHRyYSArICcjJyArIGhhc2hQcmVmaXggKyBhYnNvbHV0ZUxpbmtVcmwuc3Vic3RyKGFwcEJhc2VVcmwubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybC5wcm90b3R5cGUgPSBpbmhlcml0KExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlKTsKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKICAgICAgICB9OwogICAgfQoKCiAgICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5XTsKCiAgICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gcHJlcHJvY2Vzcyh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbgogICAgICoKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogICAgICoge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3dpbmRvdy5sb2NhdGlvbiB3aW5kb3cubG9jYXRpb259KSBhbmQgbWFrZXMgdGhlIFVSTAogICAgICogYXZhaWxhYmxlIHRvIHlvdXIgYXBwbGljYXRpb24uIENoYW5nZXMgdG8gdGhlIFVSTCBpbiB0aGUgYWRkcmVzcyBiYXIgYXJlIHJlZmxlY3RlZCBpbnRvCiAgICAgKiAkbG9jYXRpb24gc2VydmljZSBhbmQgY2hhbmdlcyB0byAkbG9jYXRpb24gYXJlIHJlZmxlY3RlZCBpbnRvIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLgogICAgICoKICAgICAqICoqVGhlICRsb2NhdGlvbiBzZXJ2aWNlOioqCiAgICAgKgogICAgICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogICAgICogICAtIFdhdGNoIGFuZCBvYnNlcnZlIHRoZSBVUkwuCiAgICAgKiAgIC0gQ2hhbmdlIHRoZSBVUkwuCiAgICAgKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogICAgICogICAtIENoYW5nZXMgdGhlIGFkZHJlc3MgYmFyLgogICAgICogICAtIENsaWNrcyB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiAob3IgY2xpY2tzIGEgSGlzdG9yeSBsaW5rKS4KICAgICAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogICAgICogLSBSZXByZXNlbnRzIHRoZSBVUkwgb2JqZWN0IGFzIGEgc2V0IG9mIG1ldGhvZHMgKHByb3RvY29sLCBob3N0LCBwb3J0LCBwYXRoLCBzZWFyY2gsIGhhc2gpLgogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnNlcnZpY2VzLiRsb2NhdGlvbiBEZXZlbG9wZXIgR3VpZGU6IEFuZ3VsYXIKICAgICAqIFNlcnZpY2VzOiBVc2luZyAkbG9jYXRpb259CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICAgICAqLwogICAgZnVuY3Rpb24gJExvY2F0aW9uUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbiAocHJlZml4KSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocHJlZml4KSkgewogICAgICAgICAgICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhc2hQcmVmaXg7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNodG1sNU1vZGUKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1vZGUgVXNlIEhUTUw1IHN0cmF0ZWd5IGlmIGF2YWlsYWJsZS4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAgICAgICAqLwogICAgICAgIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24gKG1vZGUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChtb2RlKSkgewogICAgICAgICAgICAgICAgaHRtbDVNb2RlID0gbW9kZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw1TW9kZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckc25pZmZlcicsICckcm9vdEVsZW1lbnQnLAogICAgICAgICAgICBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGJyb3dzZXIsICRzbmlmZmVyLCAkcm9vdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciAkbG9jYXRpb24sCiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGgsCiAgICAgICAgICAgICAgICAgICAgcGF0aFByZWZpeCwKICAgICAgICAgICAgICAgICAgICBpbml0VXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgICAgICAgICAgICAgaW5pdFVybFBhcnRzID0gbWF0Y2hVcmwoaW5pdFVybCksCiAgICAgICAgICAgICAgICAgICAgYXBwQmFzZVVybDsKCiAgICAgICAgICAgICAgICBpZiAoaHRtbDVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgYmFzZVBhdGggPSAkYnJvd3Nlci5iYXNlSHJlZigpIHx8ICcvJzsKICAgICAgICAgICAgICAgICAgICBwYXRoUHJlZml4ID0gcGF0aFByZWZpeEZyb21CYXNlKGJhc2VQYXRoKTsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlVXJsID0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zZVByb3RvY29sSG9zdFBvcnQoaW5pdFVybFBhcnRzLnByb3RvY29sLCBpbml0VXJsUGFydHMuaG9zdCwgaW5pdFVybFBhcnRzLnBvcnQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXggKyAnLyc7CgogICAgICAgICAgICAgICAgICAgIGlmICgkc25pZmZlci5oaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvblVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0h0bWw1VXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGhQcmVmaXgsIGFwcEJhc2VVcmwpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb0hhc2hiYW5nVXJsKGluaXRVcmwsIGJhc2VQYXRoLCBoYXNoUHJlZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hQcmVmaXgsIGFwcEJhc2VVcmwsIGJhc2VQYXRoLnN1YnN0cihwYXRoUHJlZml4Lmxlbmd0aCArIDEpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFwcEJhc2VVcmwgPQogICAgICAgICAgICAgICAgICAgICAgICBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChpbml0VXJsUGFydHMucHJvdG9jb2wsIGluaXRVcmxQYXJ0cy5ob3N0LCBpbml0VXJsUGFydHMucG9ydCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGluaXRVcmxQYXJ0cy5wYXRoIHx8ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaW5pdFVybFBhcnRzLnNlYXJjaCA/ICgnPycgKyBpbml0VXJsUGFydHMuc2VhcmNoKSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIycgKyBoYXNoUHJlZml4ICsgJy8nOwoKICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25IYXNoYmFuZ1VybChpbml0VXJsLCBoYXNoUHJlZml4LCBhcHBCYXNlVXJsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmV3cml0ZSBsaW5rIHdoZW4gb3BlbmluZyBpbiBuZXcgdGFiL3dpbmRvdyAoaW4gbGVnYWN5IGJyb3dzZXIpCiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsbSA9IGpxTGl0ZShldmVudC50YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGVBcHBVcmwoYWJzSHJlZik7CgogICAgICAgICAgICAgICAgICAgIGlmIChhYnNIcmVmICYmICFlbG0uYXR0cigndGFyZ2V0JykgJiYgcmV3cml0dGVuVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdFVybCkgewogICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSAkbG9jYXRpb24gd2hlbiAkYnJvd3NlciB1cmwgY2hhbmdlcwogICAgICAgICAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24gKG5ld1VybCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgbmV3VXJsLCAkbG9jYXRpb24uYWJzVXJsKCkpLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGxvY2F0aW9uLmFic1VybCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG5ld1VybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlIGJyb3dzZXIKICAgICAgICAgICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMDsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uICRsb2NhdGlvbldhdGNoKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlcGxhY2UgPSAkbG9jYXRpb24uJCRyZXBsYWNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWNoYW5nZUNvdW50ZXIgfHwgb2xkVXJsICE9ICRsb2NhdGlvbi5hYnNVcmwoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgY3VycmVudFJlcGxhY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUNvdW50ZXI7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2cKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTaW1wbGUgc2VydmljZSBmb3IgbG9nZ2luZy4gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgICAqCiAgICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICBNZXNzYWdlOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLndhcm4obWVzc2FnZSkiPndhcm48L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNsb2cKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIGxvZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2luZm8KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZXJyb3IKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhbiBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdFcnJvcjogJyArIGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wOwoKICAgICAgICAgICAgICAgIGlmIChsb2dGbi5hcHBseSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goZm9ybWF0RXJyb3IoYXJnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9nRm4uYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgICAgICAgICAgICAvLyBvciB3ZSBhcmUgSUUgd2hlcmUgY29uc29sZS5sb2cgZG9lc24ndCBoYXZlIGFwcGx5IHNvIHdlIGxvZyBhdCBsZWFzdCBmaXJzdCAyIGFyZ3MKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJnMSwgYXJnMikgewogICAgICAgICAgICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfV07CiAgICB9CgogICAgdmFyIE9QRVJBVE9SUyA9IHsKICAgICAgICAnbnVsbCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgICAndHJ1ZSc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAnZmFsc2UnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHVuZGVmaW5lZDogbm9vcCwKICAgICAgICAnKyc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgYSA9IGEoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgYiA9IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0RlZmluZWQoYikgPyBiIDogdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgJy0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIHJldHVybiAoaXNEZWZpbmVkKGEpID8gYSA6IDApIC0gKGlzRGVmaW5lZChiKSA/IGIgOiAwKTsKICAgICAgICB9LAogICAgICAgICcqJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICogYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJy8nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgLyBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAlIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICdeJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpIF4gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJz0nOiBub29wLAogICAgICAgICc9PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA9PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnIT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgIT0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJzwnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA+IGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICc8PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA8PSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnPj0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhKHNlbGYsIGxvY2FscykgPj0gYihzZWxmLCBsb2NhbHMpOwogICAgICAgIH0sCiAgICAgICAgJyYmJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgewogICAgICAgICAgICByZXR1cm4gYShzZWxmLCBsb2NhbHMpICYmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAogICAgICAgICd8fCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSB8fCBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfSwKICAgICAgICAnJic6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSAmIGIoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhfGI7fSwKICAgICAgICAnfCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgfSwKICAgICAgICAnISc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEpIHsKICAgICAgICAgICAgcmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBFU0NBUEUgPSB7Im4iOiAiXG4iLCAiZiI6ICJcZiIsICJyIjogIlxyIiwgInQiOiAiXHQiLCAidiI6ICJcdiIsICInIjogIiciLCAnIic6ICciJ307CgogICAgZnVuY3Rpb24gbGV4KHRleHQsIGNzcCkgewogICAgICAgIHZhciB0b2tlbnMgPSBbXSwKICAgICAgICAgICAgdG9rZW4sCiAgICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgICAganNvbiA9IFtdLAogICAgICAgICAgICBjaCwKICAgICAgICAgICAgbGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgICAgICAgICBpZiAoaXMoJyJcJycpKSB7CiAgICAgICAgICAgICAgICByZWFkU3RyaW5nKGNoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bWJlcihjaCkgfHwgaXMoJy4nKSAmJiBpc051bWJlcihwZWVrKCkpKSB7CiAgICAgICAgICAgICAgICByZWFkTnVtYmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNJZGVudChjaCkpIHsKICAgICAgICAgICAgICAgIHJlYWRJZGVudCgpOwogICAgICAgICAgICAgICAgLy8gaWRlbnRpZmllcnMgY2FuIG9ubHkgYmUgaWYgdGhlIHByZWNlZGluZyBjaGFyIHdhcyBhIHsgb3IgLAogICAgICAgICAgICAgICAgaWYgKHdhcygneywnKSAmJiBqc29uWzBdID09ICd7JyAmJgogICAgICAgICAgICAgICAgICAgICh0b2tlbiA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4uanNvbiA9IHRva2VuLnRleHQuaW5kZXhPZignLicpID09IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzKCcoKXt9W10uLDs6JykpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogY2gsCiAgICAgICAgICAgICAgICAgICAganNvbjogKHdhcygnOlssJykgJiYgaXMoJ3tbJykpIHx8IGlzKCd9XTosJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGlzKCd7WycpKSBqc29uLnVuc2hpZnQoY2gpOwogICAgICAgICAgICAgICAgaWYgKGlzKCd9XScpKSBqc29uLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjaDIgPSBjaCArIHBlZWsoKSwKICAgICAgICAgICAgICAgICAgICBmbiA9IE9QRVJBVE9SU1tjaF0sCiAgICAgICAgICAgICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgICAgICAgICAgICBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OiBpbmRleCwgdGV4dDogY2gyLCBmbjogZm4yfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IGluZGV4LCB0ZXh0OiBjaCwgZm46IGZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0Q2ggPSBjaDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuczsKCiAgICAgICAgZnVuY3Rpb24gaXMoY2hhcnMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLmluZGV4T2YoY2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2FzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGxhc3RDaCkgIT0gLTE7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrKCkgewogICAgICAgICAgICByZXR1cm4gaW5kZXggKyAxIDwgdGV4dC5sZW5ndGggPyB0ZXh0LmNoYXJBdChpbmRleCArIDEpIDogZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc051bWJlcihjaCkgewogICAgICAgICAgICByZXR1cm4gJzAnIDw9IGNoICYmIGNoIDw9ICc5JzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzV2hpdGVzcGFjZShjaCkgewogICAgICAgICAgICByZXR1cm4gY2ggPT0gJyAnIHx8IGNoID09ICdccicgfHwgY2ggPT0gJ1x0JyB8fAogICAgICAgICAgICAgICAgY2ggPT0gJ1xuJyB8fCBjaCA9PSAnXHYnIHx8IGNoID09ICdcdTAwQTAnOyAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNJZGVudChjaCkgewogICAgICAgICAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAgICAgJ18nID09IGNoIHx8IGNoID09ICckJzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRXhwT3BlcmF0b3IoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICctJyB8fCBjaCA9PSAnKycgfHwgaXNOdW1iZXIoY2gpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICAgICAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJMZXhlciBFcnJvcjogIiArIGVycm9yICsgIiBhdCBjb2x1bW4iICsKICAgICAgICAgICAgICAgIChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAiLSIgKyBpbmRleCArICIgWyIgKyB0ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKSArICJdIgogICAgICAgICAgICAgICAgICAgIDogIiAiICsgZW5kKSArCiAgICAgICAgICAgICAgICAiIGluIGV4cHJlc3Npb24gWyIgKyB0ZXh0ICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkTnVtYmVyKCkgewogICAgICAgICAgICB2YXIgbnVtYmVyID0gIiI7CiAgICAgICAgICAgIHZhciBzdGFydCA9IGluZGV4OwogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIGNoID0gbG93ZXJjYXNlKHRleHQuY2hhckF0KGluZGV4KSk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBlZWtDaCA9IHBlZWsoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIGlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBwZWVrQ2ggJiYgaXNOdW1iZXIocGVla0NoKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKCFwZWVrQ2ggfHwgIWlzTnVtYmVyKHBlZWtDaCkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBudW1iZXIgPSAxICogbnVtYmVyOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6IHN0YXJ0LCB0ZXh0OiBudW1iZXIsIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXI7CiAgICAgICAgICAgICAgICB9fSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkSWRlbnQoKSB7CiAgICAgICAgICAgIHZhciBpZGVudCA9ICIiLAogICAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleCwKICAgICAgICAgICAgICAgIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzSWRlbnQoY2gpIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicpIGxhc3REb3QgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgICAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgICAgICAgICBwZWVrSW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgICAgICAgdGV4dDogaWRlbnQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgICAgICAgICB0b2tlbi5mbiA9IHRva2VuLmpzb24gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCBjc3ApOwogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnLicsCiAgICAgICAgICAgICAgICAgICAganNvbjogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZFN0cmluZyhxdW90ZSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiOwogICAgICAgICAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICAgICAgICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ3UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZXggPSB0ZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGluZGV4ICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09IHF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3dFcnJvcigiVW50ZXJtaW5hdGVkIHF1b3RlIiwgc3RhcnQpOwogICAgICAgIH0KICAgIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gcGFyc2VyKHRleHQsIGpzb24sICRmaWx0ZXIsIGNzcCkgewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHRyYSBsZXZlbCBvZiBhbGlhc2luZyBpcyBoZXJlLCBqdXN0IGluIGNhc2UgdGhlIGxleGVyIG1pc3NlcyBzb21ldGhpbmcsIHNvIHRoYXQKICAgICAgICAgICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgICAgICAgICAgYXNzaWdubWVudCA9IGxvZ2ljYWxPUjsKICAgICAgICAgICAgZnVuY3Rpb25DYWxsID0KICAgICAgICAgICAgICAgIGZpZWxkQWNjZXNzID0KICAgICAgICAgICAgICAgICAgICBvYmplY3RJbmRleCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckNoYWluID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpcyBub3QgdmFsaWQganNvbiIsIHt0ZXh0OiB0ZXh0LCBpbmRleDogMH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFsdWUgPSBwcmltYXJ5KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnRzKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93RXJyb3IoImlzIGFuIHVuZXhwZWN0ZWQgdG9rZW4iLCB0b2tlbnNbMF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgZnVuY3Rpb24gdGhyb3dFcnJvcihtc2csIHRva2VuKSB7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJTeW50YXggRXJyb3I6IFRva2VuICciICsgdG9rZW4udGV4dCArCiAgICAgICAgICAgICAgICAiJyAiICsgbXNnICsgIiBhdCBjb2x1bW4gIiArCiAgICAgICAgICAgICAgICAodG9rZW4uaW5kZXggKyAxKSArICIgb2YgdGhlIGV4cHJlc3Npb24gWyIgKwogICAgICAgICAgICAgICAgdGV4dCArICJdIHN0YXJ0aW5nIGF0IFsiICsgdGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpICsgIl0uIik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246ICIgKyB0ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRva2Vuc1swXTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBlZWsoZTEsIGUyLCBlMywgZTQpIHsKICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnNbMF07CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgICAgICAgICAgICBpZiAodCA9PSBlMSB8fCB0ID09IGUyIHx8IHQgPT0gZTMgfHwgdCA9PSBlNCB8fAogICAgICAgICAgICAgICAgICAgICghZTEgJiYgIWUyICYmICFlMyAmJiAhZTQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4cGVjdChlMSwgZTIsIGUzLCBlNCkgewogICAgICAgICAgICB2YXIgdG9rZW4gPSBwZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgICAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgICAgICBpZiAoanNvbiAmJiAhdG9rZW4uanNvbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdG9rZW5zLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3VtZShlMSkgewogICAgICAgICAgICBpZiAoIWV4cGVjdChlMSkpIHsKICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImlzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbIiArIGUxICsgIl0iLCBwZWVrKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeUZuKGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmluYXJ5Rm4obGVmdCwgZm4sIHJpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGF0ZW1lbnRzKCkgewogICAgICAgICAgICB2YXIgc3RhdGVtZW50cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWx0ZXIoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICAgICAgICB2YXIgZm4gPSAkZmlsdGVyKHRva2VuLnRleHQpOwogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwcmVzc2lvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9hc3NpZ25tZW50KCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGxvZ2ljYWxPUigpOwogICAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPScpKSkgewogICAgICAgICAgICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoImltcGxpZXMgYXNzaWdubWVudCBidXQgWyIgKwogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnN1YnN0cmluZygwLCB0b2tlbi5pbmRleCkgKyAiXSBjYW4gbm90IGJlIGFzc2lnbmVkIHRvIiwgdG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmlnaHQgPSBsb2dpY2FsT1IoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxPUigpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBsb2dpY2FsQU5EKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJ3x8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9naWNhbEFORCgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBlcXVhbGl0eSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJyYmJykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGxvZ2ljYWxBTkQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBlcXVhbGl0eSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSByZWxhdGlvbmFsKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPT0nLCAnIT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCAnLScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBtdWx0aXBsaWNhdGl2ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG11bHRpcGxpY2F0aXZlKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHVuYXJ5KCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKCh0b2tlbiA9IGV4cGVjdCgnKicsICcvJywgJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgICAgICAgIHdoaWxlICgobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmdW5jdGlvbkNhbGwocHJpbWFyeSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSU1QT1NTSUJMRSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gX2ZpZWxkQWNjZXNzKG9iamVjdCkgewogICAgICAgICAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIGNzcCk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2NvcGUsIGxvY2Fscywgc2VsZikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNjb3BlLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9vYmplY3RJbmRleChvYmopIHsKICAgICAgICAgICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCgKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgICB2LCBwOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgdiA9IG9baV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHYgJiYgdi50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSB2OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgnJCR2JyBpbiB2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmooc2VsZiwgbG9jYWxzKVtpbmRleEZuKHNlbGYsIGxvY2FscyldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKICAgICAgICAgICAgICAgIC8vIElFIHN0dXBpZGl0eSEKICAgICAgICAgICAgICAgIHJldHVybiBmblB0ci5hcHBseQogICAgICAgICAgICAgICAgICAgID8gZm5QdHIuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgICAgICAgICAgICA6IGZuUHRyKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogICAgICAgIGZ1bmN0aW9uIGFycmF5RGVjbGFyYXRpb24oKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50Rm5zID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICddJykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChleHByZXNzaW9uKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50Rm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb2JqZWN0KCkgewogICAgICAgICAgICB2YXIga2V5VmFsdWVzID0gW107CiAgICAgICAgICAgIGlmIChwZWVrVG9rZW4oKS50ZXh0ICE9ICd9JykgewogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3VtZSgnfScpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5VmFsdWUgPSBrZXlWYWx1ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIHNldHRlcihvYmosIHBhdGgsIHNldFZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LnNoaWZ0KCk7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICAgICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eU9iaiA9IHt9OwogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgICB9CiAgICAgICAgb2JqW2VsZW1lbnQuc2hpZnQoKV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2VzaWJsZSBmcm9tIHRoZSBvYmplY3QgYnkgcGF0aC4gQW55IHVuZGVmaW5lZCB0cmF2ZXJzYWxzIGFyZSBpZ25vcmVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIHN0YXJ0aW5nIG9iamVjdAogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggcGF0aCB0byB0cmF2ZXJzZQogICAgICogQHBhcmFtIHtib29sZWFuPXRydWV9IGJpbmRGblRvU2NvcGUKICAgICAqIEByZXR1cm5zIHZhbHVlIGFzIGFjY2VzYmlsZSBieSBwYXRoCiAgICAgKi8KLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICB2YXIgZ2V0dGVyRm5DYWNoZSA9IHt9OwoKICAgIC8qKgogICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlICJCbGFjayBIb2xlIiB2YXJpYW50IGZyb206CiAgICAgKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9wYXRoLWV2YWx1YXRpb24tc2ltcGxpZmllZC83CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgaWYgKHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkxIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkzIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXk0IHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3ApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbigKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXQogICAgICAgICAgICAgICAgICAgICkoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB2YWw7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjb2RlID0gJ3ZhciBsLCBmbiwgcDtcbic7CiAgICAgICAgICAgIGZvckVhY2gocGF0aEtleXMsIGZ1bmN0aW9uIChrZXksIGluZGV4KSB7CiAgICAgICAgICAgICAgICBjb2RlICs9ICdpZihzID09PSBudWxsIHx8IHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgICAgICAgICAnbD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgJ3M9JyArIChpbmRleAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHNpbXBseSBkZXJlZmVyZW5jZSAncycgb24gYW55IC5kb3Qgbm90YXRpb24KICAgICAgICAgICAgICAgICAgICA/ICdzJwogICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICAgICAgICAgICAgOiAnKChrJiZrLmhhc093blByb3BlcnR5KCInICsga2V5ICsgJyIpKT9rOnMpJykgKyAnWyInICsga2V5ICsgJyJdJyArICc7XG4nICsKICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHA9cztcbicgKwogICAgICAgICAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nICsKICAgICAgICAgICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXSA9IGZuOwogICAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHBhcnNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgICAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAgICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICAgKgogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHRpcGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqCiAgICAgKiAgICBUaGUgcmV0dXJuIGZ1bmN0aW9uIGFsc28gaGFzIGFuIGBhc3NpZ25gIHByb3BlcnR5LCBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB3aGljaAogICAgICogICAgYWxsb3dzIG9uZSB0byBzZXQgdmFsdWVzIHRvIGV4cHJlc3Npb25zLgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNhY2hlID0ge307CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckZmlsdGVyJywgJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRmaWx0ZXIsICRzbmlmZmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXhwKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHApIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGUuaGFzT3duUHJvcGVydHkoZXhwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjYWNoZVtleHBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNhY2hlW2V4cF0gPSBwYXJzZXIoZXhwLCBmYWxzZSwgJGZpbHRlciwgJHNuaWZmZXIuY3NwKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHA7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJHEKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogICAgICoKICAgICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgICAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICAgICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAgICoKICAgICAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICAgICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgc2NvcGVgIGFyZQogICAgICogICAvLyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICAgICAqCiAgICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIC8vIHNpbmNlIHRoaXMgZm4gZXhlY3V0ZXMgYXN5bmMgaW4gYSBmdXR1cmUgdHVybiBvZiB0aGUgZXZlbnQgbG9vcCwgd2UgbmVlZCB0byB3cmFwCiAqICAgICAgIC8vIG91ciBjb2RlIGludG8gYW4gJGFwcGx5IGNhbGwgc28gdGhhdCB0aGUgbW9kZWwgY2hhbmdlcyBhcmUgcHJvcGVybHkgb2JzZXJ2ZWQuCiAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0pOwogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAgICAgKgogICAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAgICogY29tZXMgaW4gdGhlIHdheSBvZgogICAgICogW2d1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kKS4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgICAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAgICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIERlZmVycmVkIEFQSQogICAgICoKICAgICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAgICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24gb2YgdGhlIHRhc2suCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAgICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAgICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAgICAgKgogICAgICogKipQcm9wZXJ0aWVzKioKICAgICAqCiAgICAgKiAtIHByb21pc2Ug4oCTIGB7UHJvbWlzZX1gIOKAkyBwcm9taXNlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWZlcnJlZC4KICAgICAqCiAgICAgKgogICAgICogIyBUaGUgUHJvbWlzZSBBUEkKICAgICAqCiAgICAgKiBBIG5ldyBwcm9taXNlIGluc3RhbmNlIGlzIGNyZWF0ZWQgd2hlbiBhIGRlZmVycmVkIGluc3RhbmNlIGlzIGNyZWF0ZWQgYW5kIGNhbiBiZSByZXRyaWV2ZWQgYnkKICAgICAqIGNhbGxpbmcgYGRlZmVycmVkLnByb21pc2VgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBwcm9taXNlIG9iamVjdCBpcyB0byBhbGxvdyBmb3IgaW50ZXJlc3RlZCBwYXJ0aWVzIHRvIGdldCBhY2Nlc3MgdG8gdGhlIHJlc3VsdAogICAgICogb2YgdGhlIGRlZmVycmVkIHRhc2sgd2hlbiBpdCBjb21wbGV0ZXMuCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yIHdpbGwgYmUgcmVzb2x2ZWQKICAgICAqICAgb3IgcmVqZWN0ZWQgY2FsbHMgb25lIG9mIHRoZSBzdWNjZXNzIG9yIGVycm9yIGNhbGxiYWNrcyBhc3luY2hyb25vdXNseSBhcyBzb29uIGFzIHRoZSByZXN1bHQKICAgICAqICAgaXMgYXZhaWxhYmxlLiBUaGUgY2FsbGJhY2tzIGFyZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCB0aGUgcmVzdWx0IG9yIHJlamVjdGlvbiByZWFzb24uCiAgICAgKgogICAgICogICBUaGlzIG1ldGhvZCAqcmV0dXJucyBhIG5ldyBwcm9taXNlKiB3aGljaCBpcyByZXNvbHZlZCBvciByZWplY3RlZCB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICAgICAqICAgYHN1Y2Nlc3NDYWxsYmFja2Agb3IgYGVycm9yQ2FsbGJhY2tgLgogICAgICoKICAgICAqCiAgICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICAgKgogICAgICogQmVjYXVzZSBjYWxsaW5nIGB0aGVuYCBhcGkgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkgcG9zc2libGUKICAgICAqIHRvIGNyZWF0ZSBhIGNoYWluIG9mIHByb21pc2VzOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIHByb21pc2VCID0gcHJvbWlzZUEudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICogICAgIHJldHVybiByZXN1bHQgKyAxOwogKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlIHdpbGwgYmUKICAgICAqICAgLy8gdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgYXBpcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICogCiAqICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7IHJlc29sdmVkVmFsdWUgPSB2YWx1ZTsgfSk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICogCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqIAogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogICAgICAgIH1dOwogICAgfQoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICAgKiAgICAgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiBxRmFjdG9yeShuZXh0VGljaywgZXhjZXB0aW9uSGFuZGxlcikgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBkZWZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50aGVuKGNhbGxiYWNrWzBdLCBjYWxsYmFja1sxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlamVjdChyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgIHByb21pc2U6IHsKICAgICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFja10pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgICAgICB9OwoKCiAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudGhlbikgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjcmVqZWN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAgICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICAgICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAgICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgICAgICogYHJlamVjdGAuCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAqICAgICByZXR1cm4gcmVzdWx0OwogICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgKiAgICAgfQogICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICogICB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoZXJyYmFjayB8fCBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgICAgICAgKiB0aGUgcHJvbWlzZSBjb21lcyBmcm9tIGEgc291cmNlIHRoYXQgY2FuJ3QgYmUgdHJ1c3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIG9mIHRoZSBwYXNzZWQgdmFsdWUgb3IgcHJvbWlzZQogICAgICAgICAqLwogICAgICAgIHZhciB3aGVuID0gZnVuY3Rpb24gKHZhbHVlLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoY2FsbGJhY2sgfHwgZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHdyYXBwZWRFcnJiYWNrID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVycmJhY2sgfHwgZGVmYXVsdEVycmJhY2spKHJlYXNvbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUocmVmKHZhbHVlKS50aGVuKHdyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2spKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHdyYXBwZWRFcnJiYWNrKHJlYXNvbikpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgIH07CgoKICAgICAgICBmdW5jdGlvbiBkZWZhdWx0Q2FsbGJhY2sodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGRlZmF1bHRFcnJiYWNrKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gcmVqZWN0KHJlYXNvbik7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjYWxsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ29tYmluZXMgbXVsdGlwbGUgcHJvbWlzZXMgaW50byBhIHNpbmdsZSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiBhbGwgb2YgdGhlIGlucHV0CiAgICAgICAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheS48UHJvbWlzZT59IHByb21pc2VzIEFuIGFycmF5IG9mIHByb21pc2VzLgogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkgb2YgdmFsdWVzLAogICAgICAgICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5LiBJZiBhbnkgb2YKICAgICAgICAgKiAgIHRoZSBwcm9taXNlcyBpcyByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLCB0aGlzIHJlc3VsdGluZyBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUKICAgICAgICAgKiAgIHNhbWUgcmVqZWN0aW9uLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFsbChwcm9taXNlcykgewogICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBkZWZlcigpLAogICAgICAgICAgICAgICAgY291bnRlciA9IHByb21pc2VzLmxlbmd0aCwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBbXTsKCiAgICAgICAgICAgIGlmIChjb3VudGVyKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbiAocHJvbWlzZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IGluIHJlc3VsdHMpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCBpbiByZXN1bHRzKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChyZWFzb24pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRlZmVyOiBkZWZlciwKICAgICAgICAgICAgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgIHdoZW46IHdoZW4sCiAgICAgICAgICAgIGFsbDogYWxsCiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyByb3V0ZXMuIFNlZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gZm9yIGFuIGV4YW1wbGUuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVByb3ZpZGVyKCkgewogICAgICAgIHZhciByb3V0ZXMgPSB7fTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZVByb3ZpZGVyI3doZW4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLnBhdGhgKS4gSWYgYCRsb2NhdGlvbi5wYXRoYAogICAgICAgICAqICAgIGNvbnRhaW5zIHJlZHVuZGFudCB0cmFpbGluZyBzbGFzaCBvciBpcyBtaXNzaW5nIG9uZSwgdGhlIHJvdXRlIHdpbGwgc3RpbGwgbWF0Y2ggYW5kIHRoZQogICAgICAgICAqICAgIGAkbG9jYXRpb24ucGF0aGAgd2lsbCBiZSB1cGRhdGVkIHRvIGFkZCBvciBkcm9wIHRoZSB0cmFpbGluZyBzbGFzaCB0byBleGFjdGx5IG1hdGNoIHRoZQogICAgICAgICAqICAgIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiAgICBgcGF0aGAgY2FuIGNvbnRhaW4gbmFtZWQgZ3JvdXBzIHN0YXJ0aW5nIHdpdGggYSBjb2xvbiAoYDpuYW1lYCkuIEFsbCBjaGFyYWN0ZXJzIHVwIHRvIHRoZQogICAgICAgICAqICAgIG5leHQgc2xhc2ggYXJlIG1hdGNoZWQgYW5kIHN0b3JlZCBpbiBgJHJvdXRlUGFyYW1zYCB1bmRlciB0aGUgZ2l2ZW4gYG5hbWVgIHdoZW4gdGhlIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2hlcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSByb3V0ZSBNYXBwaW5nIGluZm9ybWF0aW9uIHRvIGJlIGFzc2lnbmVkIHRvIGAkcm91dGUuY3VycmVudGAgb24gcm91dGUKICAgICAgICAgKiAgICBtYXRjaC4KICAgICAgICAgKgogICAgICAgICAqICAgIE9iamVjdCBwcm9wZXJ0aWVzOgogICAgICAgICAqCiAgICAgICAgICogICAgLSBgY29udHJvbGxlcmAg4oCTIGB7KHN0cmluZ3xmdW5jdGlvbigpPX1gIOKAkyBDb250cm9sbGVyIGZuIHRoYXQgc2hvdWxkIGJlIGFzc29jaWF0ZWQgd2l0aCBuZXdseQogICAgICAgICAqICAgICAgY3JlYXRlZCBzY29wZSBvciB0aGUgbmFtZSBvZiBhIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyIHJlZ2lzdGVyZWQgY29udHJvbGxlcn0KICAgICAgICAgKiAgICAgIGlmIHBhc3NlZCBhcyBhIHN0cmluZy4KICAgICAgICAgKiAgICAtIGB0ZW1wbGF0ZWAg4oCTIGB7c3RyaW5nPX1gIOKAkyAgaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IG9yCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBuZ0luY2x1ZGV9IGRpcmVjdGl2ZXMuCiAgICAgICAgICogICAgICB0aGlzIHByb3BlcnR5IHRha2VzIHByZWNlZGVuY2Ugb3ZlciBgdGVtcGxhdGVVcmxgLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlVXJsYCDigJMgYHtzdHJpbmc9fWAg4oCTIHBhdGggdG8gYW4gaHRtbCB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9LgogICAgICAgICAqICAgIC0gYHJlc29sdmVgIC0gYHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24+PX1gIC0gQW4gb3B0aW9uYWwgbWFwIG9mIGRlcGVuZGVuY2llcyB3aGljaCBzaG91bGQKICAgICAgICAgKiAgICAgIGJlIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuIElmIGFueSBvZiB0aGVzZSBkZXBlbmRlbmNpZXMgYXJlIHByb21pc2VzLCB0aGV5IHdpbGwgYmUKICAgICAgICAgKiAgICAgIHJlc29sdmVkIGFuZCBjb252ZXJ0ZWQgdG8gYSB2YWx1ZSBiZWZvcmUgdGhlIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkIGFuZCB0aGUKICAgICAgICAgKiAgICAgIGAkcm91dGVDaGFuZ2VTdWNjZXNzYCBldmVudCBpcyBmaXJlZC4gVGhlIG1hcCBvYmplY3QgaXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYGtleWAg4oCTIGB7c3RyaW5nfWA6IGEgbmFtZSBvZiBhIGRlcGVuZGVuY3kgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4KICAgICAgICAgKiAgICAgIC0gYGZhY3RvcnlgIC0gYHtzdHJpbmd8ZnVuY3Rpb259YDogSWYgYHN0cmluZ2AgdGhlbiBpdCBpcyBhbiBhbGlhcyBmb3IgYSBzZXJ2aWNlLgogICAgICAgICAqICAgICAgICBPdGhlcndpc2UgaWYgZnVuY3Rpb24sIHRoZW4gaXQgaXMge0BsaW5rIGFwaS9BVVRPLiRpbmplY3RvciNpbnZva2UgaW5qZWN0ZWR9CiAgICAgICAgICogICAgICAgIGFuZCB0aGUgcmV0dXJuIHZhbHVlIGlzIHRyZWF0ZWQgYXMgdGhlIGRlcGVuZGVuY3kuIElmIHRoZSByZXN1bHQgaXMgYSBwcm9taXNlLCBpdCBpcyByZXNvbHZlZAogICAgICAgICAqICAgICAgICBiZWZvcmUgaXRzIHZhbHVlIGlzIGluamVjdGVkIGludG8gdGhlIGNvbnRyb2xsZXIuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGByZWRpcmVjdFRvYCDigJMgeyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSDigJMgdmFsdWUgdG8gdXBkYXRlCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gcGF0aCB3aXRoIGFuZCB0cmlnZ2VyIHJvdXRlIHJlZGlyZWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogICAgICBJZiBgcmVkaXJlY3RUb2AgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3QuPHN0cmluZz59YCAtIHJvdXRlIHBhcmFtZXRlcnMgZXh0cmFjdGVkIGZyb20gdGhlIGN1cnJlbnQKICAgICAgICAgKiAgICAgICAgYCRsb2NhdGlvbi5wYXRoKClgIGJ5IGFwcGx5aW5nIHRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlVXJsLgogICAgICAgICAqICAgICAgLSBge3N0cmluZ31gIC0gY3VycmVudCBgJGxvY2F0aW9uLnBhdGgoKWAKICAgICAgICAgKiAgICAgIC0gYHtPYmplY3R9YCAtIGN1cnJlbnQgYCRsb2NhdGlvbi5zZWFyY2goKWAKICAgICAgICAgKgogICAgICAgICAqICAgICAgVGhlIGN1c3RvbSBgcmVkaXJlY3RUb2AgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgc3RyaW5nIHdoaWNoIHdpbGwgYmUgdXNlZAogICAgICAgICAqICAgICAgdG8gdXBkYXRlIGAkbG9jYXRpb24ucGF0aCgpYCBhbmQgYCRsb2NhdGlvbi5zZWFyY2goKWAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBbcmVsb2FkT25TZWFyY2g9dHJ1ZV1gIC0ge2Jvb2xlYW49fSAtIHJlbG9hZCByb3V0ZSB3aGVuIG9ubHkgJGxvY2F0aW9uLnNlYXJjaCgpCiAgICAgICAgICogICAgY2hhbmdlcy4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgdGhlIG9wdGlvbiBpcyBzZXQgdG8gYGZhbHNlYCBhbmQgdXJsIGluIHRoZSBicm93c2VyIGNoYW5nZXMsIHRoZW4KICAgICAgICAgKiAgICAgIGAkcm91dGVVcGRhdGVgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoZSByb290IHNjb3BlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc2VsZgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIG5ldyByb3V0ZSBkZWZpbml0aW9uIHRvIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogICAgICAgICAqLwogICAgICAgIHRoaXMud2hlbiA9IGZ1bmN0aW9uIChwYXRoLCByb3V0ZSkgewogICAgICAgICAgICByb3V0ZXNbcGF0aF0gPSBleHRlbmQoe3JlbG9hZE9uU2VhcmNoOiB0cnVlfSwgcm91dGUpOwoKICAgICAgICAgICAgLy8gY3JlYXRlIHJlZGlyZWN0aW9uIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICAgICAgICAgIGlmIChwYXRoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVkaXJlY3RQYXRoID0gKHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PSAnLycpCiAgICAgICAgICAgICAgICAgICAgPyBwYXRoLnN1YnN0cigwLCBwYXRoLmxlbmd0aCAtIDEpCiAgICAgICAgICAgICAgICAgICAgOiBwYXRoICsgJy8nOwoKICAgICAgICAgICAgICAgIHJvdXRlc1tyZWRpcmVjdFBhdGhdID0ge3JlZGlyZWN0VG86IHBhdGh9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlUHJvdmlkZXIjb3RoZXJ3aXNlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb3V0ZVByb3ZpZGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHJvdXRlIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgb24gcm91dGUgY2hhbmdlIHdoZW4gbm8gb3RoZXIgcm91dGUgZGVmaW5pdGlvbgogICAgICAgICAqIGlzIG1hdGNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YC4KICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBzZWxmCiAgICAgICAgICovCiAgICAgICAgdGhpcy5vdGhlcndpc2UgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMud2hlbihudWxsLCBwYXJhbXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRsb2NhdGlvbicsICckcm91dGVQYXJhbXMnLCAnJHEnLCAnJGluamVjdG9yJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRsb2NhdGlvbiwgJHJvdXRlUGFyYW1zLCAkcSwgJGluamVjdG9yLCAkaHR0cCwgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb3V0ZVBhcmFtcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjdXJyZW50IFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICogVGhlIHJvdXRlIGRlZmluaXRpb24gY29udGFpbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtIGBjb250cm9sbGVyYDogVGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgYXMgZGVmaW5lIGluIHJvdXRlIGRlZmluaXRpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gYGxvY2Fsc2A6IEEgbWFwIG9mIGxvY2FscyB3aGljaCBpcyB1c2VkIGJ5IHtAbGluayBuZy4kY29udHJvbGxlciAkY29udHJvbGxlcn0gc2VydmljZSBmb3IKICAgICAgICAgICAgICAgICAqICAgICBjb250cm9sbGVyIGluc3RhbnRpYXRpb24uIFRoZSBgbG9jYWxzYCBjb250YWluCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgYHJlc29sdmVgIG1hcC4gQWRkaXRpb25hbGx5IHRoZSBgbG9jYWxzYCBhbHNvIGNvbnRhaW46CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgIC0gYCRzY29wZWAgLSBUaGUgY3VycmVudCByb3V0ZSBzY29wZS4KICAgICAgICAgICAgICAgICAqICAgICAtIGAkdGVtcGxhdGVgIC0gVGhlIGN1cnJlbnQgcm91dGUgdGVtcGxhdGUgSFRNTC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHkge0FycmF5LjxPYmplY3Q+fSByb3V0ZXMgQXJyYXkgb2YgYWxsIGNvbmZpZ3VyZWQgcm91dGVzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogSXMgdXNlZCBmb3IgZGVlcC1saW5raW5nIFVSTHMgdG8gY29udHJvbGxlcnMgYW5kIHZpZXdzIChIVE1MIHBhcnRpYWxzKS4KICAgICAgICAgICAgICAgICAqIEl0IHdhdGNoZXMgYCRsb2NhdGlvbi51cmwoKWAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgcGF0aCB0byBhbiBleGlzdGluZyByb3V0ZSBkZWZpbml0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFlvdSBjYW4gZGVmaW5lIHJvdXRlcyB0aHJvdWdoIHtAbGluayBuZy4kcm91dGVQcm92aWRlciAkcm91dGVQcm92aWRlcn0ncyBBUEkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgaXMgdHlwaWNhbGx5IHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9CiAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmUgYW5kIHRoZSB7QGxpbmsgbmcuJHJvdXRlUGFyYW1zICRyb3V0ZVBhcmFtc30gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgY2hhbmdpbmcgdGhlIFVSTCBoYXNoIGNhdXNlcyB0aGUgYCRyb3V0ZWAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZQogICAgICAgICAgICAgICAgIFVSTCwgYW5kIHRoZSBgbmdWaWV3YCBwdWxscyBpbiB0aGUgcGFydGlhbC4KCiAgICAgICAgICAgICAgICAgTm90ZSB0aGF0IHRoaXMgZXhhbXBsZSBpcyB1c2luZyB7QGxpbmsgbmcuZGlyZWN0aXZlOnNjcmlwdCBpbmxpbmVkIHRlbXBsYXRlc30KICAgICAgICAgICAgICAgICB0byBnZXQgaXQgd29ya2luZyBvbiBqc2ZpZGRsZSBhcyB3ZWxsLgoKICAgICAgICAgICAgICAgICA8ZXhhbXBsZSBtb2R1bGU9Im5nVmlldyI+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICAgICAgICAgQ2hvb3NlOgogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgICAgICAgIDxhIGhyZWY9IkJvb2svTW9ieS9jaC8xIj5Nb2J5OiBDaDE8L2E+IHwKICAgICAgICAgICAgICAgICA8YSBocmVmPSJCb29rL0dhdHNieSI+R2F0c2J5PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPiB8CiAgICAgICAgICAgICAgICAgPGEgaHJlZj0iQm9vay9TY2FybGV0Ij5TY2FybGV0IExldHRlcjwvYT48YnIvPgoKICAgICAgICAgICAgICAgICA8ZGl2IG5nLXZpZXc+PC9kaXY+CiAgICAgICAgICAgICAgICAgPGhyIC8+CgogICAgICAgICAgICAgICAgIDxwcmU+JGxvY2F0aW9uLnBhdGgoKSA9IHt7JGxvY2F0aW9uLnBhdGgoKX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZVVybCA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmx9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQucGFyYW1zID0ge3skcm91dGUuY3VycmVudC5wYXJhbXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZSA9IHt7JHJvdXRlLmN1cnJlbnQuc2NvcGUubmFtZX19PC9wcmU+CiAgICAgICAgICAgICAgICAgPHByZT4kcm91dGVQYXJhbXMgPSB7eyRyb3V0ZVBhcmFtc319PC9wcmU+CiAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJib29rLmh0bWwiPgogICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgICAgICAgICAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICAgICAgICAgICAgICA8L2ZpbGU+CgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImNoYXB0ZXIuaHRtbCI+CiAgICAgICAgICAgICAgICAgY29udHJvbGxlcjoge3tuYW1lfX08YnIgLz4KICAgICAgICAgICAgICAgICBCb29rIElkOiB7e3BhcmFtcy5ib29rSWR9fTxiciAvPgogICAgICAgICAgICAgICAgIENoYXB0ZXIgSWQ6IHt7cGFyYW1zLmNoYXB0ZXJJZH19CiAgICAgICAgICAgICAgICAgPC9maWxlPgoKICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGFuZ3VsYXIubW9kdWxlKCduZ1ZpZXcnLCBbXSwgZnVuY3Rpb24oJHJvdXRlUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnYm9vay5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEJvb2tDbnRsLAogICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAvLyBJIHdpbGwgY2F1c2UgYSAxIHNlY29uZCBkZWxheQogICAgICAgICAgICAgICBkZWxheTogZnVuY3Rpb24oJHEsICR0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgdmFyIGRlbGF5ID0gJHEuZGVmZXIoKTsKICAgICAgICAgICAgICAgICAkdGltZW91dChkZWxheS5yZXNvbHZlLCAxMDAwKTsKICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkucHJvbWlzZTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0pOwogICAgICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9Cb29rLzpib29rSWQvY2gvOmNoYXB0ZXJJZCcsIHsKICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgIGNvbnRyb2xsZXI6IENoYXB0ZXJDbnRsCiAgICAgICAgICAgfSk7CgogICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTsKICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE1haW5DbnRsKCRzY29wZSwgJHJvdXRlLCAkcm91dGVQYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAgJHNjb3BlLiRsb2NhdGlvbiA9ICRsb2NhdGlvbjsKICAgICAgICAgICAkc2NvcGUuJHJvdXRlUGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgICB9CgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAiQm9va0NudGwiOwogICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJDaGFwdGVyQ250bCI7CiAgICAgICAgICAgJHNjb3BlLnBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICAgfQogICAgICAgICAgICAgICAgIDwvZmlsZT4KCiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiTW9ieTogQ2gxIiknKS5jbGljaygpOwogICAgICAgICAgIHZhciBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IE1vYnkvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQ2hhcHRlciBJZFw6IDEvKTsKCiAgICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgICBzbGVlcCgyKTsgLy8gcHJvbWlzZXMgYXJlIG5vdCBwYXJ0IG9mIHNjZW5hcmlvIHdhaXRpbmcKICAgICAgICAgICBjb250ZW50ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXZpZXddJykudGV4dCgpOwogICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQm9va0NudGwvKTsKICAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDwvZXhhbXBsZT4KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm91dGUjJHJvdXRlQ2hhbmdlU3RhcnQKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBiZWZvcmUgYSByb3V0ZSBjaGFuZ2UuIEF0IHRoaXMgIHBvaW50IHRoZSByb3V0ZSBzZXJ2aWNlcyBzdGFydHMKICAgICAgICAgICAgICAgICAqIHJlc29sdmluZyBhbGwgb2YgdGhlIGRlcGVuZGVuY2llcyBuZWVkZWQgZm9yIHRoZSByb3V0ZSBjaGFuZ2UgdG8gb2NjdXJzLgogICAgICAgICAgICAgICAgICogVHlwaWNhbGx5IHRoaXMgaW52b2x2ZXMgZmV0Y2hpbmcgdGhlIHZpZXcgdGVtcGxhdGUgYXMgd2VsbCBhcyBhbnkgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICAgKiBkZWZpbmVkIGluIGByZXNvbHZlYCByb3V0ZSBwcm9wZXJ0eS4gT25jZSAgYWxsIG9mIHRoZSBkZXBlbmRlbmNpZXMgYXJlIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgKiBgJHJvdXRlQ2hhbmdlU3VjY2Vzc2AgaXMgZmlyZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gbmV4dCBGdXR1cmUgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSBjdXJyZW50IEN1cnJlbnQgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb3V0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIHJvdXRlIGRlcGVuZGVuY2llcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVmlldyBuZ1ZpZXd9IGxpc3RlbnMgZm9yIHRoZSBkaXJlY3RpdmUKICAgICAgICAgICAgICAgICAqIHRvIGluc3RhbnRpYXRlIHRoZSBjb250cm9sbGVyIGFuZCByZW5kZXIgdGhlIHZpZXcuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZXxVbmRlZmluZWR9IHByZXZpb3VzIFByZXZpb3VzIHJvdXRlIGluZm9ybWF0aW9uLCBvciB1bmRlZmluZWQgaWYgY3VycmVudCBpcyBmaXJzdCByb3V0ZSBlbnRlcmVkLgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb3V0ZSMkcm91dGVDaGFuZ2VFcnJvcgogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIGlmIGFueSBvZiB0aGUgcmVzb2x2ZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gY3VycmVudCBDdXJyZW50IHJvdXRlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtSb3V0ZX0gcHJldmlvdXMgUHJldmlvdXMgcm91dGUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1JvdXRlfSByZWplY3Rpb24gUmVqZWN0aW9uIG9mIHRoZSBwcm9taXNlLiBVc3VhbGx5IHRoZSBlcnJvciBvZiB0aGUgZmFpbGVkIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlIyRyb3V0ZVVwZGF0ZQogICAgICAgICAgICAgICAgICogQGV2ZW50T2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgYHJlbG9hZE9uU2VhcmNoYCBwcm9wZXJ0eSBoYXMgYmVlbiBzZXQgdG8gZmFsc2UsIGFuZCB3ZSBhcmUgcmV1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogaW5zdGFuY2Ugb2YgdGhlIENvbnRyb2xsZXIuCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgZm9yY2VSZWxvYWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAkcm91dGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlczogcm91dGVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvdXRlI3JlbG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBDYXVzZXMgYCRyb3V0ZWAgc2VydmljZSB0byByZWxvYWQgdGhlIGN1cnJlbnQgcm91dGUgZXZlbiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gaGFzbid0IGNoYW5nZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEFzIGEgcmVzdWx0IG9mIHRoYXQsIHtAbGluayBuZy5kaXJlY3RpdmU6bmdWaWV3IG5nVmlld30KICAgICAgICAgICAgICAgICAgICAgICAgICogY3JlYXRlcyBuZXcgc2NvcGUsIHJlaW5zdGFudGlhdGVzIHRoZSBjb250cm9sbGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmModXBkYXRlUm91dGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZVJvdXRlKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvdXRlOwoKICAgICAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0gb24ge3N0cmluZ30gY3VycmVudCB1cmwKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB3aGVuIHtzdHJpbmd9IHJvdXRlIHdoZW4gdGVtcGxhdGUgdG8gbWF0Y2ggdGhlIHVybCBhZ2FpbnN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHs/T2JqZWN0fQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzd2l0Y2hSb3V0ZU1hdGNoZXIob24sIHdoZW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiB0aGlzIGNvZGUgaXMgY29udm9sdXRlZCBhbmQgaW5lZmZpY2llbnQsIHdlIHNob3VsZCBjb25zdHJ1Y3QgdGhlIHJvdXRlIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gICByZWdleCBvbmx5IG9uY2UgYW5kIHRoZW4gcmV1c2UgaXQKCiAgICAgICAgICAgICAgICAgICAgLy8gRXNjYXBlIHJlZ2V4cCBzcGVjaWFsIGNoYXJhY3RlcnMuCiAgICAgICAgICAgICAgICAgICAgd2hlbiA9ICdeJyArIHdoZW4ucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICJcXCQmIikgKyAnJCc7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ2V4ID0gJycsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBkc3QgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlID0gLzooXHcrKS9nLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbU1hdGNoLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gMDsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChwYXJhbU1hdGNoID0gcmUuZXhlYyh3aGVuKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBlYWNoIDpwYXJhbSBpbiBgd2hlbmAgYW5kIHJlcGxhY2UgaXQgd2l0aCBhIGNhcHR1cmluZyBncm91cC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIGFsbCBvdGhlciBzZWN0aW9ucyBvZiB3aGVuIHVuY2hhbmdlZC4KICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gd2hlbi5zbGljZShsYXN0TWF0Y2hlZEluZGV4LCBwYXJhbU1hdGNoLmluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnZXggKz0gJyhbXlxcL10qKSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtTWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2hlZEluZGV4ID0gcmUubGFzdEluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgdHJhaWxpbmcgcGF0aCBwYXJ0LgogICAgICAgICAgICAgICAgICAgIHJlZ2V4ICs9IHdoZW4uc3Vic3RyKGxhc3RNYXRjaGVkSW5kZXgpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBvbi5tYXRjaChuZXcgUmVnRXhwKHJlZ2V4KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAobmFtZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzdFtuYW1lXSA9IG1hdGNoW2luZGV4ICsgMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBkc3QgOiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJvdXRlKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gcGFyc2VSb3V0ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gJHJvdXRlLmN1cnJlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIGxhc3QgJiYgbmV4dC4kJHJvdXRlID09PSBsYXN0LiQkcm91dGUKICAgICAgICAgICAgICAgICAgICAgICAgJiYgZXF1YWxzKG5leHQucGF0aFBhcmFtcywgbGFzdC5wYXRoUGFyYW1zKSAmJiAhbmV4dC5yZWxvYWRPblNlYXJjaCAmJiAhZm9yY2VSZWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdC5wYXJhbXMgPSBuZXh0LnBhcmFtczsKICAgICAgICAgICAgICAgICAgICAgICAgY29weShsYXN0LnBhcmFtcywgJHJvdXRlUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVVcGRhdGUnLCBsYXN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHQgfHwgbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVJlbG9hZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN0YXJ0JywgbmV4dCwgbGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRyb3V0ZS5jdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0LnJlZGlyZWN0VG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcobmV4dC5yZWRpcmVjdFRvKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24ucGF0aChpbnRlcnBvbGF0ZShuZXh0LnJlZGlyZWN0VG8sIG5leHQucGFyYW1zKSkuc2VhcmNoKG5leHQucGFyYW1zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24udXJsKG5leHQucmVkaXJlY3RUbyhuZXh0LnBhdGhQYXJhbXMsICRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJHEud2hlbihuZXh0KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXh0LnJlc29sdmUgfHwge30sIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGlzU3RyaW5nKHZhbHVlKSA/ICRpbmplY3Rvci5nZXQodmFsdWUpIDogJGluamVjdG9yLmludm9rZSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSA9IG5leHQudGVtcGxhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHRlbXBsYXRlID0gbmV4dC50ZW1wbGF0ZVVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gJGh0dHAuZ2V0KHRlbXBsYXRlLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaCgnJHRlbXBsYXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxLmFsbCh2YWx1ZXMpLnRoZW4oZnVuY3Rpb24gKHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNba2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWZ0ZXIgcm91dGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuKGZ1bmN0aW9uIChsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAkcm91dGUuY3VycmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5sb2NhbHMgPSBsb2NhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3B5KG5leHQucGFyYW1zLCAkcm91dGVQYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3VjY2VzcycsIG5leHQsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICRyb3V0ZS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlRXJyb3InLCBuZXh0LCBsYXN0LCBlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHRoZSBjdXJyZW50IGFjdGl2ZSByb3V0ZSwgYnkgbWF0Y2hpbmcgaXQgYWdhaW5zdCB0aGUgVVJMCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlUm91dGUoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTWF0Y2ggYSByb3V0ZQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbXMsIG1hdGNoOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2gocm91dGVzLCBmdW5jdGlvbiAocm91dGUsIHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaCAmJiAocGFyYW1zID0gc3dpdGNoUm91dGVNYXRjaGVyKCRsb2NhdGlvbi5wYXRoKCksIHBhdGgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBleHRlbmQoe30sICRsb2NhdGlvbi5zZWFyY2goKSwgcGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoUGFyYW1zOiBwYXJhbXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoLiQkcm91dGUgPSByb3V0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIE5vIHJvdXRlIG1hdGNoZWQ7IGZhbGxiYWNrIHRvICJvdGhlcndpc2UiIHJvdXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoIHx8IHJvdXRlc1tudWxsXSAmJiBpbmhlcml0KHJvdXRlc1tudWxsXSwge3BhcmFtczoge30sIHBhdGhQYXJhbXM6IHt9fSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyBpbnRlcnBvbGF0aW9uIG9mIHRoZSByZWRpcmVjdCBwYXRoIHdpdGggdGhlIHBhcmFtZXRycwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbnRlcnBvbGF0ZShzdHJpbmcsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKChzdHJpbmcgfHwgJycpLnNwbGl0KCc6JyksIGZ1bmN0aW9uIChzZWdtZW50LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlZ21lbnRNYXRjaCA9IHNlZ21lbnQubWF0Y2goLyhcdyspKC4qKS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHNlZ21lbnRNYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBhcmFtc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHNlZ21lbnRNYXRjaFsyXSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb3V0ZVBhcmFtcwogICAgICogQHJlcXVpcmVzICRyb3V0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3VycmVudCBzZXQgb2Ygcm91dGUgcGFyYW1ldGVycy4gVGhlIHJvdXRlIHBhcmFtZXRlcnMgYXJlIGEgY29tYmluYXRpb24gb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbn0gYHNlYXJjaCgpYCwgYW5kIGBwYXRoKClgLiBUaGUgYHBhdGhgIHBhcmFtZXRlcnMKICAgICAqIGFyZSBleHRyYWN0ZWQgd2hlbiB0aGUge0BsaW5rIG5nLiRyb3V0ZSAkcm91dGV9IHBhdGggaXMgbWF0Y2hlZC4KICAgICAqCiAgICAgKiBJbiBjYXNlIG9mIHBhcmFtZXRlciBuYW1lIGNvbGxpc2lvbiwgYHBhdGhgIHBhcmFtcyB0YWtlIHByZWNlZGVuY2Ugb3ZlciBgc2VhcmNoYCBwYXJhbXMuCiAgICAgKgogICAgICogVGhlIHNlcnZpY2UgZ3VhcmFudGVlcyB0aGF0IHRoZSBpZGVudGl0eSBvZiB0aGUgYCRyb3V0ZVBhcmFtc2Agb2JqZWN0IHdpbGwgcmVtYWluIHVuY2hhbmdlZAogICAgICogKGJ1dCBpdHMgcHJvcGVydGllcyB3aWxsIGxpa2VseSBjaGFuZ2UpIGV2ZW4gd2hlbiBhIHJvdXRlIGNoYW5nZSBvY2N1cnMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAgLy8gR2l2ZW46CiAgICAgKiAgLy8gVVJMOiBodHRwOi8vc2VydmVyLmNvbS9pbmRleC5odG1sIy9DaGFwdGVyLzEvU2VjdGlvbi8yP3NlYXJjaD1tb2J5CiAgICAgKiAgLy8gUm91dGU6IC9DaGFwdGVyLzpjaGFwdGVySWQvU2VjdGlvbi86c2VjdGlvbklkCiAgICAgKiAgLy8KICAgICAqICAvLyBUaGVuCiAgICAgKiAgJHJvdXRlUGFyYW1zID09PiB7Y2hhcHRlcklkOjEsIHNlY3Rpb25JZDoyLCBzZWFyY2g6J21vYnknfQogICAgICogPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb3V0ZVBhcmFtc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4oe30pOwogICAgfQoKICAgIC8qKgogICAgICogREVTSUdOIE5PVEVTCiAgICAgKgogICAgICogVGhlIGRlc2lnbiBkZWNpc2lvbnMgYmVoaW5kIHRoZSBzY29wZSBhcmUgaGVhdmlseSBmYXZvcmVkIGZvciBzcGVlZCBhbmQgbWVtb3J5IGNvbnN1bXB0aW9uLgogICAgICoKICAgICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICAgKiB2YWx1ZSBhcyBsYXN0IHRpbWUgc28gd2Ugb3B0aW1pemUgdGhlIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAgICogICAtIE5vIGNsb3N1cmVzLCBpbnN0ZWFkIHVzZSBwcm90b3R5cGljYWwgaW5oZXJpdGFuY2UgZm9yIEFQSQogICAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAgICoKICAgICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgICAqICAgICBpdGVtcyB0byB0aGUgYXJyYXkgYXQgdGhlIGJlZ2lubmluZyAoc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgICAqCiAgICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICAgKgogICAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICAgKiBhcmUgZXhwZW5zaXZlIHRvIGNvbnN0cnVjdC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogUHJvdmlkZXIgZm9yIHRoZSAkcm9vdFNjb3BlIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICAgKiBhc3N1bWluZyB0aGF0IHRoZSBtb2RlbCBpcyB1bnN0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBjaGlsZCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGFuZCBwcm92aWRlCiAgICAgKiBldmVudCBwcm9jZXNzaW5nIGxpZmUtY3ljbGUuIFNlZSB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICAgKi8KICAgIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgVFRMID0gMTA7CgogICAgICAgIHRoaXMuZGlnZXN0VHRsID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBUVEwgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gVFRMOwogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRwYXJzZScsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyLCAkcGFyc2UpIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQSByb290IHNjb3BlIGNhbiBiZSByZXRyaWV2ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlICRyb290U2NvcGV9IGtleSBmcm9tIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRuZXcgJG5ldygpfSBtZXRob2QuIChNb3N0IHNjb3BlcyBhcmUgY3JlYXRlZCBhdXRvbWF0aWNhbGx5IHdoZW4KICAgICAgICAgICAgICAgICAqIGNvbXBpbGVkIEhUTUwgdGVtcGxhdGUgaXMgZXhlY3V0ZWQuKQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgc2NvcGUgc25pcHBldCB0byBzaG93IGhvdyB5b3UgY2FuIGludGVyYWN0IHdpdGggdGhlIHNjb3BlLgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSkuaW52b2tlKGZ1bmN0aW9uKCRyb290U2NvcGUpIHsKICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcoKTsKICAgICAgICAgICBzY29wZS5zYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ1dvcmxkJzsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CgogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgc2NvcGUuZ3JlZXRpbmcgPSBzY29wZS5zYWx1dGF0aW9uICsgJyAnICsgc2NvcGUubmFtZSArICchJzsKICAgICAgICAgICB9KTsgLy8gaW5pdGlhbGl6ZSB0aGUgd2F0Y2gKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmdyZWV0aW5nKS50b0VxdWFsKHVuZGVmaW5lZCk7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdNaXNrbyc7CiAgICAgICAgICAgLy8gc3RpbGwgb2xkIHZhbHVlLCBzaW5jZSB3YXRjaGVzIGhhdmUgbm90IGJlZW4gY2FsbGVkIHlldAogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCh1bmRlZmluZWQpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7IC8vIGZpcmUgYWxsICB0aGUgd2F0Y2hlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5ncmVldGluZykudG9FcXVhbCgnSGVsbG8gTWlza28hJyk7CiAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgICAgICAgICAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgICAgICAgICAgcGFyZW50LnNhbHV0YXRpb24gPSAiSGVsbG8iOwogICAgICAgICAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgICAgICAgICBjaGlsZC5zYWx1dGF0aW9uID0gIldlbGNvbWUiOwogICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKCk+PX0gcHJvdmlkZXJzIE1hcCBvZiBzZXJ2aWNlIGZhY3Rvcnkgd2hpY2ggbmVlZCB0byBiZSBwcm92aWRlZAogICAgICAgICAgICAgICAgICogICAgIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsICo+PX0gaW5zdGFuY2VDYWNoZSBQcm92aWRlcyBwcmUtaW5zdGFudGlhdGVkIHNlcnZpY2VzIHdoaWNoIHNob3VsZAogICAgICAgICAgICAgICAgICogICAgIGFwcGVuZC9vdmVycmlkZSBzZXJ2aWNlcyBwcm92aWRlZCBieSBgcHJvdmlkZXJzYC4gVGhpcyBpcyBoYW5keSB3aGVuIHVuaXQtdGVzdGluZyBhbmQgaGF2aW5nCiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBOZXdseSBjcmVhdGVkIHNjb3BlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gU2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHBoYXNlID0gdGhpcy4kcGFyZW50ID0gdGhpcy4kJHdhdGNoZXJzID0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzWyd0aGlzJ10gPSB0aGlzLiRyb290ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRpZAogICAgICAgICAgICAgICAgICogQHByb3BlcnR5T2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgICAgICAgICAqLwoKCiAgICAgICAgICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24gKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIENoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihpc29sYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmVtb3ZlIGF0IHNvbWUgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdBUEktQ0hBTkdFOiBVc2UgJGNvbnRyb2xsZXIgdG8gaW5zdGFudGlhdGUgY29udHJvbGxlcnMuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcm9vdCA9IHRoaXMuJHJvb3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07IC8vIHNob3VsZCBiZSBhbm9ueW1vdXM7IFRoaXMgaXMgc28gdGhhdCB3aGVuIHRoZSBtaW5pZmllciBtdW5nZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBuYW1lIGl0IGRvZXMgbm90IGJlY29tZSByYW5kb20gc2V0IG9mIGNoYXJzLiBUaGVzZSB3aWxsIHRoZW4gc2hvdyB1cCBhcyBjbGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmFtZSBpbiB0aGUgZGVidWdnZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGlsZC5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgQ2hpbGQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFsndGhpcyddID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRwYXJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCR3YXRjaGVycyA9IGNoaWxkLiQkbmV4dFNpYmxpbmcgPSBjaGlsZC4kJGNoaWxkSGVhZCA9IGNoaWxkLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICogICBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB3aGljaCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0KICAgICAgICAgICAgICAgICAgICAgKiAgIHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICAgICAgICAgICAqICAgc2VlIGJlbG93KS4gVGhlIGluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yIGxhdGVyIGNvbXBhcmlzb24sIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gSXQgYWxzbyBtZWFucyB0aGF0IHdhdGNoaW5nIGNvbXBsZXggb3B0aW9ucyB3aWxsCiAgICAgICAgICAgICAgICAgICAgICogICBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4gVGhpcwogICAgICAgICAgICAgICAgICAgICAqICAgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEgY2hhbmdlIGlzCiAgICAgICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAvLyBsZXQncyBhc3N1bWUgdGhhdCBzY29wZSB3YXMgZGVwZW5kZW5jeSBpbmplY3RlZCBhcyB0aGUgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7IHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKX0gd2F0Y2hFeHByZXNzaW9uIEV4cHJlc3Npb24gdGhhdCBpcyBldmFsdWF0ZWQgb24gZWFjaAogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEEgY2hhbmdlIGluIHRoZSByZXR1cm4gdmFsdWUgdHJpZ2dlcnMgYQogICAgICAgICAgICAgICAgICAgICAqICAgIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGBzY29wZWAgYXMgYSBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpPX0gbGlzdGVuZXIgQ2FsbGJhY2sgY2FsbGVkIHdoZW5ldmVyIHRoZSByZXR1cm4gdmFsdWUgb2YKICAgICAgICAgICAgICAgICAgICAgKiAgIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZXMgYXMgcGFyYW1ldGVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG9iamVjdEVxdWFsaXR5IENvbXBhcmUgb2JqZWN0IGZvciBlcXVhbGl0eSByYXRoZXIgdGhhbiBmb3IgcmVmZXJlbmNlLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHdhdGNoOiBmdW5jdGlvbiAod2F0Y2hFeHAsIGxpc3RlbmVyLCBvYmplY3RFcXVhbGl0eSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0ID0gY29tcGlsZVRvRm4od2F0Y2hFeHAsICd3YXRjaCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlciA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSB1c2VyIHBhc3Mgc3RyaW5nLCB3ZSBuZWVkIHRvIGNvbXBpbGUgaXQsIGRvIHdlIHJlYWxseSBuZWVkIHRoaXMgPwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuRm4gPSBjb21waWxlVG9GbihsaXN0ZW5lciB8fCBub29wLCAnbGlzdGVuZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIuZm4gPSBmdW5jdGlvbiAobmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHdoaWxlIGxvb3AgcmVhZHMgaW4gcmV2ZXJzZSBvcmRlci4KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFByb2Nlc3NlcyBhbGwgb2YgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gb2YgdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZSB0aGUgbW9kZWwsIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30gdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICogZmlyaW5nLiBUaGlzIG1lYW5zIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gZ2V0IGludG8gYW4gaW5maW5pdGUgbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93CiAgICAgICAgICAgICAgICAgICAgICogYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgZXhjZWVkcyAxMC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFVzdWFsbHkgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgICAgICAgICAgICAgICAgICogSW5zdGVhZCBhIGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseSgpfSAodHlwaWNhbGx5IGZyb20gd2l0aGluIGEKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pIHdpbGwgZm9yY2UgYSBgJGRpZ2VzdCgpYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gIHdpdGgge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoICR3YXRjaCgpfQogICAgICAgICAgICAgICAgICAgICAqIHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFlvdSBtYXkgaGF2ZSBhIG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCBmcm9tIHdpdGhpbiB1bml0LXRlc3RzLCB0byBzaW11bGF0ZSB0aGUgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBsaWZlLWN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2c7CgogICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlID0gY3VycmVudC4kJGFzeW5jUXVldWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LiRldmFsKGFzeW5jUXVldWUuc2hpZnQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgod2F0Y2hlcnMgPSBjdXJyZW50LiQkd2F0Y2hlcnMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2Nlc3Mgb3VyIHdhdGNoZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1vc3QgY29tbW9uIHdhdGNoZXMgYXJlIG9uIHByaW1pdGl2ZXMsIGluIHdoaWNoIGNhc2Ugd2UgY2FuIHNob3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2lyY3VpdCBpdCB3aXRoID09PSBvcGVyYXRvciwgb25seSB3aGVuID09PSBmYWlscyBkbyB3ZSB1c2UgLmVxdWFscwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmICEod2F0Y2guZXEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlcXVhbHModmFsdWUsIGxhc3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBpc05hTih2YWx1ZSkgJiYgaXNOYU4obGFzdCkpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmxhc3QgPSB3YXRjaC5lcSA/IGNvcHkodmFsdWUpIDogdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmZuKHZhbHVlLCAoKGxhc3QgPT09IGluaXRXYXRjaFZhbCkgPyB2YWx1ZSA6IGxhc3QpLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCA9IDQgLSB0dGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdhdGNoTG9nW2xvZ0lkeF0pIHdhdGNoTG9nW2xvZ0lkeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZm46ICcgKyAod2F0Y2guZXhwLm5hbWUgfHwgd2F0Y2guZXhwLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB3YXRjaC5leHA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoTG9nW2xvZ0lkeF0ucHVzaChsb2dNc2cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fCAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlydHkgJiYgISh0dGwtLSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoVFRMICsgJyAkZGlnZXN0KCkgaXRlcmF0aW9ucyByZWFjaGVkLiBBYm9ydGluZyFcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnV2F0Y2hlcnMgZmlyZWQgaW4gdGhlIGxhc3QgNSBpdGVyYXRpb25zOiAnICsgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUmVtb3ZlcyB0aGUgY3VycmVudCBzY29wZSAoYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4pIGZyb20gdGhlIHBhcmVudCBzY29wZS4gUmVtb3ZhbCBpbXBsaWVzCiAgICAgICAgICAgICAgICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICAgICAgICAgICAgICAgKiBwcm9wYWdhdGUgdG8gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4gUmVtb3ZhbCBhbHNvIGltcGxpZXMgdGhhdCB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICAgICAqIHNjb3BlIGlzIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgYCRkZXN0cm95KClgIGlzIHVzdWFsbHkgdXNlZCBieSBkaXJlY3RpdmVzIHN1Y2ggYXMKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSBmb3IgbWFuYWdpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSnVzdCBiZWZvcmUgYSBzY29wZSBpcyBkZXN0cm95ZWQgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAgICAgICAgICAgICAgICogQXBwbGljYXRpb24gY29kZSBjYW4gcmVnaXN0ZXIgYSBgJGRlc3Ryb3lgIGV2ZW50IGhhbmRsZXIgdGhhdCB3aWxsIGdpdmUgaXQgY2hhbmNlIHRvCiAgICAgICAgICAgICAgICAgICAgICogcGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgZGVzdHJveSB0aGUgcm9vdCBzY29wZSBvciBhIHNjb3BlIHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUgPT0gdGhpcyB8fCB0aGlzLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRicm9hZGNhc3QoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZEhlYWQgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRUYWlsID0gdGhpcy4kJHByZXZTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kJHByZXZTaWJsaW5nKSB0aGlzLiQkcHJldlNpYmxpbmcuJCRuZXh0U2libGluZyA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRuZXh0U2libGluZykgdGhpcy4kJG5leHRTaWJsaW5nLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmc7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGJvZ3VzIGNvZGUgdGhhdCB3b3JrcyBhcm91bmQgQ2hyb21lJ3MgR0MgbGVhawogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzEzMTMjaXNzdWVjb21tZW50LTEwMzc4NDUxCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZEhlYWQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgYGV4cHJlc3Npb25gIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybmluZyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbiB0aGUKICAgICAgICAgICAgICAgICAgICAgKiBleHByZXNzaW9uIGFyZSBwcm9wYWdhdGVkICh1bmNhdWdodCkuIFRoaXMgaXMgdXNlZnVsIHdoZW4gZXZhbHVhdGluZyBBbmd1bGFyIGV4cHJlc3Npb25zLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICAgICAgICAgICAgc2NvcGUuYiA9IDI7CgogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoZnVuY3Rpb24oc2NvcGUpeyByZXR1cm4gc2NvcGUuYSArIHNjb3BlLmI7IH0pKS50b0VxdWFsKDMpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIHRoZSBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbDogZnVuY3Rpb24gKGV4cHIsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBleHByZXNzaW9uIG9uIHRoZSBjdXJyZW50IHNjb3BlIGF0IGEgbGF0ZXIgcG9pbnQgaW4gdGltZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBgJGV2YWxBc3luY2AgbWFrZXMgbm8gZ3VhcmFudGVlcyBhcyB0byB3aGVuIHRoZSBgZXhwcmVzc2lvbmAgd2lsbCBiZSBleGVjdXRlZCwgb25seSB0aGF0OgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGl0IHdpbGwgZXhlY3V0ZSBpbiB0aGUgY3VycmVudCBzY3JpcHQgZXhlY3V0aW9uIGNvbnRleHQgKGJlZm9yZSBhbnkgRE9NIHJlbmRlcmluZykuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyCiAgICAgICAgICAgICAgICAgICAgICogICAgIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKGV4cHIpOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIGAkYXBwbHkoKWAgaXMgdXNlZCB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gYW5ndWxhciBmcm9tIG91dHNpZGUgb2YgdGhlIGFuZ3VsYXIgZnJhbWV3b3JrLgogICAgICAgICAgICAgICAgICAgICAqIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUtY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKiBvZiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgZXhjZXB0aW9uIGhhbmRsaW5nfSwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMjIExpZmUgY3ljbGUKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKiAyLiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUgZXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAqICAgIHdhcyBleGVjdXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IG1ldGhvZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCBjdXJyZW50IGBzY29wZWAgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRldmFsKGV4cHIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIExpc3RlbnMgb24gZXZlbnRzIG9mIGEgZ2l2ZW4gdHlwZS4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRlbWl0ICRlbWl0fSBmb3IgZGlzY3Vzc2lvbiBvZgogICAgICAgICAgICAgICAgICAgICAqIGV2ZW50IGxpZmUgY3ljbGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZm9ybWF0IGlzOiBgZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pYC4gVGhlIGBldmVudGAgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICogcGFzc2VkIGludG8gdGhlIGxpc3RlbmVyIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHRhcmdldFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIG9uIHdoaWNoIHRoZSBldmVudCB3YXMgYCRlbWl0YC1lZCBvciBgJGJyb2FkY2FzdGAtZWQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgY3VycmVudCBzY29wZSB3aGljaCBpcyBoYW5kbGluZyB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBuYW1lYCAtIGB7c3RyaW5nfWA6IE5hbWUgb2YgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgc3RvcFByb3BhZ2F0aW9uYCAtIGB7ZnVuY3Rpb249fWA6IGNhbGxpbmcgYHN0b3BQcm9wYWdhdGlvbmAgZnVuY3Rpb24gd2lsbCBjYW5jZWwgZnVydGhlciBldmVudAogICAgICAgICAgICAgICAgICAgICAqICAgICBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBwcmV2ZW50RGVmYXVsdGAgLSBge2Z1bmN0aW9ufWA6IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0YCBzZXRzIGBkZWZhdWx0UHJldmVudGVkYCBmbGFnIHRvIHRydWUuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gbGlzdGVuIG9uLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkb246IGZ1bmN0aW9uIChuYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZWRMaXN0ZW5lcnMgPSB0aGlzLiQkbGlzdGVuZXJzW25hbWVdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldCBub3RpZmllZC4KICAgICAgICAgICAgICAgICAgICAgKiBBZnRlcndhcmRzLCB0aGUgZXZlbnQgdHJhdmVyc2VzIHVwd2FyZHMgdG93YXJkIHRoZSByb290IHNjb3BlIGFuZCBjYWxscyBhbGwgcmVnaXN0ZXJlZAogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzIGNhbmNlbHMgaXQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRlbWl0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW1wdHkgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG5hbWVkTGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxpc3RlbmVycyB3ZXJlIGRlcmVnaXN0ZXJlZCwgZGVmcmFnbWVudCB0aGUgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhdmVyc2UgdXB3YXJkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgPSBzY29wZS4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGJyb2FkY2FzdAogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCBkb3dud2FyZHMgdG8gYWxsIGNoaWxkIHNjb3BlcyAoYW5kIHRoZWlyIGNoaWxkcmVuKSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRicm9hZGNhc3RgIHdhcyBjYWxsZWQuIEFsbAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0IG5vdGlmaWVkLgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyd2FyZHMsIHRoZSBldmVudCBwcm9wYWdhdGVzIHRvIGFsbCBkaXJlY3QgYW5kIGluZGlyZWN0IHNjb3BlcyBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQKICAgICAgICAgICAgICAgICAgICAgKiBjYWxscyBhbGwgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IGNhbm5vdCBiZSBjYW5jZWxlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFueSBleGNlcHRpb24gZW1taXRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgICAgICAgICAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gYnJvYWRjYXN0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkYnJvYWRjYXN0OiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lckFyZ3MgPSBjb25jYXQoW2V2ZW50XSwgYXJndW1lbnRzLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyICRyb290U2NvcGUgPSBuZXcgU2NvcGUoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJHJvb3RTY29wZS4kJHBoYXNlICsgJyBhbHJlYWR5IGluIHByb2dyZXNzJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhclBoYXNlKCkgewogICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICAgICAgICAgKiBiZWNhdXNlIGl0J3MgdW5pcXVlIHdlIGNhbiBlYXNpbHkgdGVsbCBpdCBhcGFydCBmcm9tIG90aGVyIHZhbHVlcwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogISEhIFRoaXMgaXMgYW4gdW5kb2N1bWVudGVkICJwcml2YXRlIiBzZXJ2aWNlICEhIQogICAgICoKICAgICAqIEBuYW1lIG5nLiRzbmlmZmVyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGlzdG9yeSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaHRtbDUgaGlzdG9yeSBhcGkgPwogICAgICogQHByb3BlcnR5IHtib29sZWFufSBoYXNoY2hhbmdlIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBoYXNoY2hhbmdlIGV2ZW50ID8KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoaXMgaXMgdmVyeSBzaW1wbGUgaW1wbGVtZW50YXRpb24gb2YgdGVzdGluZyBicm93c2VyJ3MgZmVhdHVyZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRTbmlmZmVyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24gKCR3aW5kb3cpIHsKICAgICAgICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgICAgICAgICAgYW5kcm9pZCA9IGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCR3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpKSwKICAgICAgICAgICAgICAgIGhhc2hjaGFuZ2U6ICdvbmhhc2hjaGFuZ2UnIGluICR3aW5kb3cgJiYKICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAoISR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8ICR3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRNb2RlID4gNyksCiAgICAgICAgICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSUU5IGltcGxlbWVudHMgJ2lucHV0JyBldmVudCBpdCdzIHNvIGZ1YmFyZWQgdGhhdCB3ZSByYXRoZXIgcHJldGVuZCB0aGF0IGl0IGRvZXNuJ3QgaGF2ZQogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBJbiBwYXJ0aWN1bGFyIHRoZSBldmVudCBpcyBub3QgZmlyZWQgd2hlbiBiYWNrc3BhY2Ugb3IgZGVsZXRlIGtleSBhcmUgcHJlc3NlZCBvcgogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gY3V0IG9wZXJhdGlvbiBpcyBwZXJmb3JtZWQuCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50ID09ICdpbnB1dCcgJiYgbXNpZSA9PSA5KSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudFN1cHBvcnRbZXZlbnRdKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGl2RWxtID0gJHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTdXBwb3J0W2V2ZW50XSA9ICdvbicgKyBldmVudCBpbiBkaXZFbG07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnRTdXBwb3J0W2V2ZW50XTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiBjdXJyZW50bHkgdGhlcmUgaXMgbm8gd2F5IHRvIGZlYXR1cmUgZGV0ZWN0IENTUCB3aXRob3V0IHRyaWdnZXJpbmcgYWxlcnRzCiAgICAgICAgICAgICAgICBjc3A6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kd2luZG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICAgICAqIGlzIGdsb2JhbGx5IGF2YWlsYWJsZSBpbiBKYXZhU2NyaXB0LCBpdCBjYXVzZXMgdGVzdGFiaWxpdHkgcHJvYmxlbXMsIGJlY2F1c2UKICAgICAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogICAgICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogICAgICoKICAgICAqIEFsbCBleHByZXNzaW9ucyBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byBjdXJyZW50IHNjb3BlIHNvIHRoZXkgZG9uJ3QKICAgICAqIHN1ZmZlciBmcm9tIHdpbmRvdyBnbG9iYWxpdHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICRzY29wZS4kd2luZG93ID0gJHdpbmRvdzsKICAgICAgICAgICAkc2NvcGUuZ3JlZXRpbmcgPSAnSGVsbG8sIFdvcmxkISc7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJHdpbmRvdy5hbGVydChncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBkaXNwbGF5IHRoZSBncmVldGluZyBpbiB0aGUgaW5wdXQgYm94JywgZnVuY3Rpb24oKSB7CiAgICAgICBpbnB1dCgnZ3JlZXRpbmcnKS5lbnRlcignSGVsbG8sIEUyRSBUZXN0cycpOwogICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgLy8gZWxlbWVudCgnOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSB2YWx1ZUZuKHdpbmRvdyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBQYXJzZSBoZWFkZXJzIGludG8ga2V5IHZhbHVlIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBQYXJzZWQgaGVhZGVycyBhcyBrZXkgdmFsdWUgb2JqZWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgICAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgICAgICAgaWYgKCFoZWFkZXJzKSByZXR1cm4gcGFyc2VkOwoKICAgICAgICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAgICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBhY2Nlc3MgdG8gcGFyc2VkIGhlYWRlcnMuCiAgICAgKgogICAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICAgKiBAc2VlIHBhcnNlSGVhZGVycwogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc3RyaW5nPSl9IFJldHVybnMgYSBnZXR0ZXIgZnVuY3Rpb24gd2hpY2ggaWYgY2FsbGVkIHdpdGg6CiAgICAgKgogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICAgKiAgIC0gaWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIGhlYWRlcnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFoZWFkZXJzT2JqKSBoZWFkZXJzT2JqID0gcGFyc2VIZWFkZXJzKGhlYWRlcnMpOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGFpbiBhbGwgZ2l2ZW4gZnVuY3Rpb25zCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9ufEFycmF5LjxmdW5jdGlvbj4pfSBmbnMgRnVuY3Rpb24gb3IgYW4gYXJyYXkgb2YgZnVuY3Rpb25zLgogICAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGEoZGF0YSwgaGVhZGVycywgZm5zKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICAgICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICBkYXRhID0gZm4oZGF0YSwgaGVhZGVycyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkYXRhOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgICAgICAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwogICAgfQoKCiAgICBmdW5jdGlvbiAkSHR0cFByb3ZpZGVyKCkgewogICAgICAgIHZhciBKU09OX1NUQVJUID0gL15ccyooXFt8XHtbXlx7XSkvLAogICAgICAgICAgICBKU09OX0VORCA9IC9bXH1cXV1ccyokLywKICAgICAgICAgICAgUFJPVEVDVElPTl9QUkVGSVggPSAvXlwpXF1cfScsP1xuLzsKCiAgICAgICAgdmFyICRjb25maWcgPSB0aGlzLmRlZmF1bHRzID0gewogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gaW5jb21pbmcgcmVzcG9uc2UgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogW2Z1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKEpTT05fU1RBUlQudGVzdChkYXRhKSAmJiBKU09OX0VORC50ZXN0KGRhdGEpKQogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gZnJvbUpzb24oZGF0YSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IFtmdW5jdGlvbiAoZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICAgICAgICB9XSwKCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBjb21tb246IHsKICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicsCiAgICAgICAgICAgICAgICAgICAgJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J30sCiAgICAgICAgICAgICAgICBwdXQ6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgcHJvdmlkZXJSZXNwb25zZUludGVyY2VwdG9ycyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkaHR0cEJhY2tlbmQsICRicm93c2VyLCAkY2FjaGVGYWN0b3J5LCAkcm9vdFNjb3BlLCAkcSwgJGluamVjdG9yKSB7CgogICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyksCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKHByb3ZpZGVyUmVzcG9uc2VJbnRlcmNlcHRvcnMsIGZ1bmN0aW9uIChpbnRlcmNlcHRvcikgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSW50ZXJjZXB0b3JzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgIGlzU3RyaW5nKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGh0dHBCYWNrZW5kCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkY2FjaGVGYWN0b3J5CiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRxCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgY29yZSBBbmd1bGFyIHNlcnZpY2UgdGhhdCBmYWNpbGl0YXRlcyBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZQogICAgICAgICAgICAgICAgICogSFRUUCBzZXJ2ZXJzIHZpYSB0aGUgYnJvd3NlcidzIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3R9IG9iamVjdCBvciB2aWEge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlAgSlNPTlB9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciB1bml0IHRlc3RpbmcgYXBwbGljYXRpb25zIHRoYXQgdXNlIGAkaHR0cGAgc2VydmljZSwgc2VlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCAkaHR0cEJhY2tlbmQgbW9ja30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGEgaGlnaGVyIGxldmVsIG9mIGFic3RyYWN0aW9uLCBwbGVhc2UgY2hlY2sgb3V0IHRoZSB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UKICAgICAgICAgICAgICAgICAqICRyZXNvdXJjZX0gc2VydmljZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgQVBJIGlzIGJhc2VkIG9uIHRoZSB7QGxpbmsgbmcuJHEgZGVmZXJyZWQvcHJvbWlzZSBBUElzfSBleHBvc2VkIGJ5CiAgICAgICAgICAgICAgICAgKiB0aGUgJHEgc2VydmljZS4gV2hpbGUgZm9yIHNpbXBsZSB1c2FnZSBwYXR0ZXJucyB0aGlzIGRvZXNuJ3QgbWF0dGVyIG11Y2gsIGZvciBhZHZhbmNlZCB1c2FnZQogICAgICAgICAgICAgICAgICogaXQgaXMgaW1wb3J0YW50IHRvIGZhbWlsaWFyaXplIHlvdXJzZWxmIHdpdGggdGhlc2UgQVBJcyBhbmQgdGhlIGd1YXJhbnRlZXMgdGhleSBwcm92aWRlLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIEdlbmVyYWwgdXNhZ2UKICAgICAgICAgICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAgICAgICAgICAgICAqIHRoYXQgaXMgdXNlZCB0byBnZW5lcmF0ZSBhbiBIVFRQIHJlcXVlc3QgYW5kIHJldHVybnMgIGEge0BsaW5rIG5nLiRxIHByb21pc2V9CiAgICAgICAgICAgICAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAoe21ldGhvZDogJ0dFVCcsIHVybDogJy9zb21lVXJsJ30pLgogICAgICAgICAgICAgICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICAgICAgICAgICAgICogICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyBjYWxsZWQgYXN5bmNocm9ub3VzbHkgaWYgYW4gZXJyb3Igb2NjdXJzCiAgICAgKiAgICAgICAvLyBvciBzZXJ2ZXIgcmV0dXJucyByZXNwb25zZSB3aXRoIGFuIGVycm9yIHN0YXR1cy4KICAgICAqICAgICB9KTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIHRoZSByZXR1cm5lZCB2YWx1ZSBvZiBjYWxsaW5nIHRoZSAkaHR0cCBmdW5jdGlvbiBpcyBhIGBwcm9taXNlYCwgeW91IGNhbiBhbHNvIHVzZQogICAgICAgICAgICAgICAgICogdGhlIGB0aGVuYCBtZXRob2QgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzLCBhbmQgdGhlc2UgY2FsbGJhY2tzIHdpbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCDigJMKICAgICAgICAgICAgICAgICAqIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3BvbnNlLiBTZWUgdGhlIEFQSSBzaWduYXR1cmUgYW5kIHR5cGUgaW5mbyBiZWxvdyBmb3IgbW9yZQogICAgICAgICAgICAgICAgICogZGV0YWlscy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBIHJlc3BvbnNlIHN0YXR1cyBjb2RlIGJldHdlZW4gMjAwIGFuZCAyOTkgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3Mgc3RhdHVzIGFuZAogICAgICAgICAgICAgICAgICogd2lsbCByZXN1bHQgaW4gdGhlIHN1Y2Nlc3MgY2FsbGJhY2sgYmVpbmcgY2FsbGVkLiBOb3RlIHRoYXQgaWYgdGhlIHJlc3BvbnNlIGlzIGEgcmVkaXJlY3QsCiAgICAgICAgICAgICAgICAgKiBYTUxIdHRwUmVxdWVzdCB3aWxsIHRyYW5zcGFyZW50bHkgZm9sbG93IGl0LCBtZWFuaW5nIHRoYXQgdGhlIGVycm9yIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICAgICAgICAgICAgICAgKiBjYWxsZWQgZm9yIHN1Y2ggcmVzcG9uc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNpbmNlIGFsbCBpbnZvY2F0aW9ucyBvZiB0aGUgJGh0dHAgc2VydmljZSByZXF1aXJlIHBhc3NpbmcgaW4gYW4gSFRUUCBtZXRob2QgYW5kIFVSTCwgYW5kCiAgICAgICAgICAgICAgICAgKiBQT1NUL1BVVCByZXF1ZXN0cyByZXF1aXJlIHJlcXVlc3QgZGF0YSB0byBiZSBwcm92aWRlZCBhcyB3ZWxsLCBzaG9ydGN1dCBtZXRob2RzCiAgICAgICAgICAgICAgICAgKiB3ZXJlIGNyZWF0ZWQ6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgJGh0dHAuZ2V0KCcvc29tZVVybCcpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZ2V0ICRodHRwLmdldH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3B1dCAkaHR0cC5wdXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAgICAgICAgICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgICogb2JqZWN0LCB3aGljaCBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICAgICAgICAgICAgICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICogLyAqYAogICAgICAgICAgICAgICAgICogICAtIGBYLVJlcXVlc3RlZC1XaXRoOiBYTUxIdHRwUmVxdWVzdGAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICAgICAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0WydNeS1IZWFkZXInXT0ndmFsdWUnYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBZGRpdGlvbmFsbHksIHRoZSBkZWZhdWx0cyBjYW4gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogZmFzaGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAgICAgICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0IGludG8KICAgICAgICAgICAgICAgICAqICAgSlNPTiBmb3JtYXQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICAgICAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbgogICAgICAgICAgICAgICAgICogYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUgYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vcgogICAgICAgICAgICAgICAgICogYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byBgJGh0dHBgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBlbmFibGUgY2FjaGluZywgc2V0IHRoZSBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYHRydWVgLiBXaGVuIHRoZSBjYWNoZSBpcwogICAgICAgICAgICAgICAgICogZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiBsb2NhbCBjYWNoZS4gTmV4dCB0aW1lIHRoZQogICAgICAgICAgICAgICAgICogcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQgZXZlbiBpZiB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gY2FjaGUsIGRlbGl2ZXJ5IG9mIHRoZSBkYXRhIGlzIGFzeW5jaHJvbm91cyBpbgogICAgICAgICAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSWYgdGhlcmUgYXJlIG11bHRpcGxlIEdFVCByZXF1ZXN0cyBmb3IgdGhlIHNhbWUgVVJMIHRoYXQgc2hvdWxkIGJlIGNhY2hlZCB1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJlZm9yZSB5b3Ugc3RhcnQgY3JlYXRpbmcgaW50ZXJjZXB0b3JzLCBiZSBzdXJlIHRvIHVuZGVyc3RhbmQgdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIHB1cnBvc2VzIG9mIGdsb2JhbCBlcnJvciBoYW5kbGluZywgYXV0aGVudGljYXRpb24gb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAgICAgICAgICAgICAqIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nIG9mIHJlY2VpdmVkIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlIGFibGUgdG8gaW50ZXJjZXB0CiAgICAgICAgICAgICAgICAgKiByZXNwb25zZXMgZm9yIGh0dHAgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAgICAgICAgICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIHJlc3BvbnNlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgICAgICAgICAgICAgKiBwcm9taXNlIGFwaXN9IHRvIGZ1bGZpbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoZSBpbnRlcmNlcHRvcnMgYXJlIHNlcnZpY2UgZmFjdG9yaWVzIHRoYXQgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgJGh0dHBQcm92aWRlciBieQogICAgICAgICAgICAgICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLnJlc3BvbnNlSW50ZXJjZXB0b3JzYCBhcnJheS4gVGhlIGZhY3RvcnkgaXMgY2FsbGVkIGFuZAogICAgICAgICAgICAgICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yICDigJQgYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiB0YWtlcyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBhbmQgcmV0dXJucyB0aGUgb3JpZ2luYWwgb3IgYSBuZXcgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgKiAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICAgICAgICAgICAgICAgICAqICAgSlNPTiB2dWxuZXJhYmlsaXR5fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgICAgICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiBKU09OIHZ1bG5lcmFiaWxpdHl9IGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0gcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgYXV0b21hdGljYWxseSBzdHJpcCB0aGUgcHJlZml4IGJlZm9yZSBwcm9jZXNzaW5nIGl0IGFzIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICldfScsCiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0gaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAgICAgICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAgICAgICAgICAgICAqIGNhbGxlZCBgWFNSRi1UT0tFTmAgYW5kIHNldHMgaXQgYXMgdGhlIEhUVFAgaGVhZGVyIGBYLVhTUkYtVE9LRU5gLiBTaW5jZSBvbmx5IEphdmFTY3JpcHQgdGhhdAogICAgICAgICAgICAgICAgICogcnVucyBvbiB5b3VyIGRvbWFpbiBjb3VsZCByZWFkIHRoZSBjb29raWUsIHlvdXIgc2VydmVyIGNhbiBiZSBhc3N1cmVkIHRoYXQgdGhlIFhIUiBjYW1lIGZyb20KICAgICAgICAgICAgICAgICAqIEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICAgICAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAgICAgICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbSBtYWtpbmcKICAgICAgICAgICAgICAgICAqIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzIGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBjb29raWUgd2l0aCBhIHtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpIHNhbHR9IGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBPYmplY3QgZGVzY3JpYmluZyB0aGUgcmVxdWVzdCB0byBiZSBtYWRlIGFuZCBob3cgaXQgc2hvdWxkIGJlCiAgICAgICAgICAgICAgICAgKiAgICBwcm9jZXNzZWQuIFRoZSBvYmplY3QgaGFzIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgIC0gKiptZXRob2QqKiDigJMgYHtzdHJpbmd9YCDigJMgSFRUUCBtZXRob2QgKGUuZy4gJ0dFVCcsICdQT1NUJywgZXRjKQogICAgICAgICAgICAgICAgICogICAgLSAqKnVybCoqIOKAkyBge3N0cmluZ31gIOKAkyBBYnNvbHV0ZSBvciByZWxhdGl2ZSBVUkwgb2YgdGhlIHJlc291cmNlIHRoYXQgaXMgYmVpbmcgcmVxdWVzdGVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKnBhcmFtcyoqIOKAkyBge09iamVjdC48c3RyaW5nfE9iamVjdD59YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aGljaCB3aWxsIGJlIHR1cm5lZCB0bwogICAgICAgICAgICAgICAgICogICAgICBgP2tleTE9dmFsdWUxJmtleTI9dmFsdWUyYCBhZnRlciB0aGUgdXJsLiBJZiB0aGUgdmFsdWUgaXMgbm90IGEgc3RyaW5nLCBpdCB3aWxsIGJlIEpTT05pZmllZC4KICAgICAgICAgICAgICAgICAqICAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBEYXRhIHRvIGJlIHNlbnQgYXMgdGhlIHJlcXVlc3QgbWVzc2FnZSBkYXRhLgogICAgICAgICAgICAgICAgICogICAgLSAqKmhlYWRlcnMqKiDigJMgYHtPYmplY3R9YCDigJMgTWFwIG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgICAgICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICAgICAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAgICAgICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IFJldHVybnMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gb2JqZWN0IHdpdGggdGhlCiAgICAgICAgICAgICAgICAgKiAgIHN0YW5kYXJkIGB0aGVuYCBtZXRob2QgYW5kIHR3byBodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4gVGhlIGB0aGVuYAogICAgICAgICAgICAgICAgICogICBtZXRob2QgdGFrZXMgdHdvIGFyZ3VtZW50cyBhIHN1Y2Nlc3MgYW5kIGFuIGVycm9yIGNhbGxiYWNrIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdpdGggYQogICAgICAgICAgICAgICAgICogICByZXNwb25zZSBvYmplY3QuIFRoZSBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAgbWV0aG9kcyB0YWtlIGEgc2luZ2xlIGFyZ3VtZW50IC0gYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3Qgc3VjY2VlZHMgb3IgZmFpbHMgcmVzcGVjdGl2ZWx5LiBUaGUgYXJndW1lbnRzIHBhc3NlZCBpbnRvCiAgICAgICAgICAgICAgICAgKiAgIHRoZXNlIGZ1bmN0aW9ucyBhcmUgZGVzdHJ1Y3R1cmVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXNwb25zZSBvYmplY3QgcGFzc2VkIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiAgIGB0aGVuYCBtZXRob2QuIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgVGhlIHJlc3BvbnNlIGJvZHkgdHJhbnNmb3JtZWQgd2l0aCB0aGUgdHJhbnNmb3JtIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAgICAgICAgICAgICAqICAgLSAqKmhlYWRlcnMqKiDigJMgYHtmdW5jdGlvbihbaGVhZGVyTmFtZV0pfWAg4oCTIEhlYWRlciBnZXR0ZXIgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcGVuZGluZ1JlcXVlc3RzIEFycmF5IG9mIGNvbmZpZyBvYmplY3RzIGZvciBjdXJyZW50bHkgcGVuZGluZwogICAgICAgICAgICAgICAgICogICByZXF1ZXN0cy4gVGhpcyBpcyBwcmltYXJpbHkgbWVhbnQgdG8gYmUgdXNlZCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgICAgIDxleGFtcGxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iRmV0Y2hDdHJsIj4KICAgICAgICAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICAgICAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgPG9wdGlvbj5KU09OUDwvb3B0aW9uPgogICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+U2FtcGxlIEpTT05QPC9idXR0b24+CiAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+SW52YWxpZCBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICAgICAgICAgIDxwcmU+aHR0cCByZXNwb25zZSBkYXRhOiB7e2RhdGF9fTwvcHJlPgogICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEZldGNoQ3RybCgkc2NvcGUsICRodHRwLCAkdGVtcGxhdGVDYWNoZSkgewogICAgICAgICAgICAkc2NvcGUubWV0aG9kID0gJ0dFVCc7CiAgICAgICAgICAgICRzY29wZS51cmwgPSAnaHR0cC1oZWxsby5odG1sJzsKCiAgICAgICAgICAgICRzY29wZS5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS5jb2RlID0gbnVsbDsKICAgICAgICAgICAgICAkc2NvcGUucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgICAkaHR0cCh7bWV0aG9kOiAkc2NvcGUubWV0aG9kLCB1cmw6ICRzY29wZS51cmwsIGNhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhIHx8ICJSZXF1ZXN0IGZhaWxlZCI7CiAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAgICAgICAgICRzY29wZS5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICAgJHNjb3BlLnVybCA9IHVybDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICAgICAgICAgICAgICAgICBIZWxsbywgJGh0dHAhCiAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBHRVQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBhIEpTT05QIHJlcXVlc3QgdG8gYW5ndWxhcmpzLm9yZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJTYW1wbGUgSlNPTlAiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwogICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJJbnZhbGlkIEpTT05QIiknKS5jbGljaygpOwogICAgICAgICAgICBlbGVtZW50KCc6YnV0dG9uOmNvbnRhaW5zKCJmZXRjaCIpJykuY2xpY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3N0YXR1cycpKS50b0JlKCcwJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvQmUoJ1JlcXVlc3QgZmFpbGVkJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICA8L2ZpbGU+CiAgICAgICAgICAgICAgICAgPC9leGFtcGxlPgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAkaHR0cChjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcubWV0aG9kID0gdXBwZXJjYXNlKGNvbmZpZy5tZXRob2QpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxVHJhbnNmb3JtRm4gPSBjb25maWcudHJhbnNmb3JtUmVxdWVzdCB8fCAkY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BUcmFuc2Zvcm1GbiA9IGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSB8fCAkY29uZmlnLnRyYW5zZm9ybVJlc3BvbnNlLAogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gJGNvbmZpZy5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHsnWC1YU1JGLVRPS0VOJzogJGJyb3dzZXIuY29va2llcygpWydYU1JGLVRPS0VOJ119LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmSGVhZGVycy5jb21tb24sIGRlZkhlYWRlcnNbbG93ZXJjYXNlKGNvbmZpZy5tZXRob2QpXSwgY29uZmlnLmhlYWRlcnMpLAogICAgICAgICAgICAgICAgICAgICAgICByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihyZXFIZWFkZXJzKSwgcmVxVHJhbnNmb3JtRm4pLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZXFIZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycyk7CgoKICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2Zvcm0gZnV0dXJlIHJlc3BvbnNlCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBhcHBseSBpbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlSW50ZXJjZXB0b3JzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IGludGVyY2VwdG9yKHByb21pc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5lcnJvciA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFrZSBhIGNvcHkgc2luY2UgdGhlIHJlc3BvbnNlIG11c3QgYmUgY2FjaGVhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCByZXNwVHJhbnNmb3JtRm4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGlzU3VjY2VzcyhyZXNwb25zZS5zdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZXNwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICRxLnJlamVjdChyZXNwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNnZXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWxldGUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYERFTEVURWAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNoZWFkCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2pzb25wCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3Bvc3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcHV0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMgYXMgd2VsbCBhcyByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICRodHRwLmRlZmF1bHRzID0gJGNvbmZpZzsKCgogICAgICAgICAgICAgICAgcmV0dXJuICRodHRwOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAgICAgICAgICogJGh0dHBCYWNrZW5kLCAkY29uZmlnLCAkbG9nLCAkcm9vdFNjb3BlLCBkZWZhdWx0Q2FjaGUsICRodHRwLnBlbmRpbmdSZXF1ZXN0cwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCwKICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAgICAgICAgICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5wdXNoKGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwoKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jYWNoZSAmJiBjb25maWcubWV0aG9kID09ICdHRVQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlID0gaXNPYmplY3QoY29uZmlnLmNhY2hlKSA/IGNvbmZpZy5jYWNoZSA6IGRlZmF1bHRDYWNoZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRSZXNwID0gY2FjaGUuZ2V0KHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRSZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBjb3B5KGNhY2hlZFJlc3BbMl0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwLCAyMDAsIHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgICAgICAgICAgICAgICBpZiAoIWNhY2hlZFJlc3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAgICAgICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIFJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IE1hdGgubWF4KHN0YXR1cywgMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAoaXNTdWNjZXNzKHN0YXR1cykgPyBkZWZlcnJlZC5yZXNvbHZlIDogZGVmZXJyZWQucmVqZWN0KSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiByZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogaGVhZGVyc0dldHRlcihoZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBlbmRpbmdSZXEoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBpbmRleE9mKCRodHRwLnBlbmRpbmdSZXF1ZXN0cywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiB1cmw7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjYuMCIpOwogICAgICAgIH0gY2F0Y2ggKGUxKSB7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAuMy4wIik7CiAgICAgICAgfSBjYXRjaCAoZTIpIHsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUCIpOwogICAgICAgIH0gY2F0Y2ggKGUzKSB7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgWE1MSHR0cFJlcXVlc3QuIik7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRodHRwQmFja2VuZAogICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRkb2N1bWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogICAgICogWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IG9yIEpTT05QIGFuZCBkZWFscyB3aXRoIGJyb3dzZXIgaW5jb21wYXRpYmlsaXRpZXMuCiAgICAgKgogICAgICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogICAgICoge0BsaW5rIG5nLiRodHRwICRodHRwfSBvciB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UgJHJlc291cmNlfS4KICAgICAqCiAgICAgKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAgICAgKiAkaHR0cEJhY2tlbmR9IHdoaWNoIGNhbiBiZSB0cmFpbmVkIHdpdGggcmVzcG9uc2VzLgogICAgICovCiAgICBmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24gKCRicm93c2VyLCAkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyLmRlZmVyLCAkd2luZG93LmFuZ3VsYXIuY2FsbGJhY2tzLAogICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLCAkd2luZG93LmxvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoJzonLCAnJykpOwogICAgICAgIH1dOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBYSFIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQsIGxvY2F0aW9uUHJvdG9jb2wpIHsKICAgICAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1ldGhvZCwgdXJsLCBwb3N0LCBjYWxsYmFjaywgaGVhZGVycywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBqc29ucFJlcSh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsICdhbmd1bGFyLmNhbGxiYWNrcy4nICsgY2FsbGJhY2tJZCksCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgMjAwLCBjYWxsYmFja3NbY2FsbGJhY2tJZF0uZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIC0yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2NhbGxiYWNrSWRdOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYSFIoKTsKICAgICAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdmFyIHN0YXR1czsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgICAgICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIG9uY2UgRmlyZWZveCAyMSBnZXRzIHJlbGVhc2VkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWdpbjogd29ya2Fyb3VuZCB0byBvdmVyY29tZSBGaXJlZm94IENPUlMgaHR0cCByZXNwb25zZSBoZWFkZXJzIGJ1ZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MDg3MzUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCBhbHJlYWR5IHBhdGNoZWQgaW4gbmlnaHRseS4gU2hvdWxkIGxhbmQgaW4gRmlyZWZveCAyMS4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENPUlMgInNpbXBsZSByZXNwb25zZSBoZWFkZXJzIiBodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGVIZWFkZXJzID0gWyJDYWNoZS1Db250cm9sIiwgIkNvbnRlbnQtTGFuZ3VhZ2UiLCAiQ29udGVudC1UeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRXhwaXJlcyIsICJMYXN0LU1vZGlmaWVkIiwgIlByYWdtYSJdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNpbXBsZUhlYWRlcnMsIGZ1bmN0aW9uIChoZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzICs9IGhlYWRlciArICI6ICIgKyB2YWx1ZSArICJcbiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5kIG9mIHRoZSB3b3JrYXJvdW5kLgoKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMgfHwgeGhyLnN0YXR1cywgeGhyLnJlc3BvbnNlVGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgeGhyLnNlbmQocG9zdCB8fCAnJyk7CgogICAgICAgICAgICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXJEZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywgc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZykgewogICAgICAgICAgICAgICAgLy8gVVJMX01BVENIIGlzIGRlZmluZWQgaW4gc3JjL3NlcnZpY2UvbG9jYXRpb24uanMKICAgICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9ICh1cmwubWF0Y2goVVJMX01BVENIKSB8fCBbJycsIGxvY2F0aW9uUHJvdG9jb2xdKVsxXTsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CgogICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIGRvbmVXcmFwcGVyKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZVdyYXBwZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAkbG9jYWxlIHNlcnZpY2UgcHJvdmlkZXMgbG9jYWxpemF0aW9uIHJ1bGVzIGZvciB2YXJpb3VzIEFuZ3VsYXIgY29tcG9uZW50cy4gQXMgb2YgcmlnaHQgbm93IHRoZQogICAgICogb25seSBwdWJsaWMgYXBpIGlzOgogICAgICoKICAgICAqICogYGlkYCDigJMgYHtzdHJpbmd9YCDigJMgbG9jYWxlIGlkIGZvcm1hdHRlZCBhcyBgbGFuZ3VhZ2VJZC1jb3VudHJ5SWRgIChlLmcuIGBlbi11c2ApCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpZDogJ2VuLXVzJywKCiAgICAgICAgICAgICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgICAgICAgICAgICAgIERFQ0lNQUxfU0VQOiAnLicsCiAgICAgICAgICAgICAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgICAgICAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgICAgICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYWM6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB7IC8vQ3VycmVuY3kgUGF0dGVybgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEZyYWM6IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5lZ1ByZTogJyhcdTAwQTQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBDVVJSRU5DWV9TWU06ICckJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBEQVRFVElNRV9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgTU9OVEg6ICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVE1PTlRIOiAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgQU1QTVM6IFsnQU0nLCAnUE0nXSwKICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICAgICAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICAgICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiAkVGltZW91dFByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkYnJvd3NlciwgJHEsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRUaW1lb3V0YC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgd3JhcHBlZCBpbnRvIGEgdHJ5L2NhdGNoCiAgICAgICAgICAgICAgICAgKiBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlIHJldHVybiB2YWx1ZSBvZiByZWdpc3RlcmluZyBhIHRpbWVvdXQgZnVuY3Rpb24gaXMgYSBwcm9taXNlLCB3aGljaCB3aWxsIGJlIHJlc29sdmVkIHdoZW4KICAgICAgICAgICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRvIGNhbmNlbCBhIHRpbWVvdXQgcmVxdWVzdCwgY2FsbCBgJHRpbWVvdXQuY2FuY2VsKHByb21pc2UpYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiR0aW1lb3V0IGAkdGltZW91dC5mbHVzaCgpYH0gdG8KICAgICAgICAgICAgICAgICAqIHN5bmNocm9ub3VzbHkgZmx1c2ggdGhlIHF1ZXVlIG9mIGRlZmVycmVkIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdob3NlIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVsYXllZC4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIERlbGF5IGluIG1pbGxpc2Vjb25kcy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgKiAgIHdpbGwgaW52b2tlIGBmbmAgd2l0aGluIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5fSBibG9jay4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQuIFRoZSB2YWx1ZSB0aGlzCiAgICAgICAgICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICAgICAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQsIGNsZWFudXA7CgogICAgICAgICAgICAgICAgICAgIHRpbWVvdXRJZCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgICAgICAgICAgIGNsZWFudXAgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbdGltZW91dElkXSA9IGRlZmVycmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihjbGVhbnVwLCBjbGVhbnVwKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dCNjYW5jZWwKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAgICAgICAqIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIGhhc24ndCBleGVjdXRlZCB5ZXQgYW5kIHdhcyBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgICAgICAqICAgY2FuY2VsZWQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHRpbWVvdXQuY2FuY2VsID0gZnVuY3Rpb24gKHByb21pc2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXhlIHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uICgkaW5qZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChuYW1lICsgc3VmZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH1dOwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHJlZ2lzdGVyKCdjdXJyZW5jeScsIGN1cnJlbmN5RmlsdGVyKTsKICAgICAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdqc29uJywganNvbkZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbnVtYmVyJywgbnVtYmVyRmlsdGVyKTsKICAgICAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmZpbHRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIG5nLiRmaWx0ZXJ9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICAgKiAgIGBhcnJheWAuCiAgICAgKgogICAgICogICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgLSBgc3RyaW5nYDogUHJlZGljYXRlIHRoYXQgcmVzdWx0cyBpbiBhIHN1YnN0cmluZyBtYXRjaCB1c2luZyB0aGUgdmFsdWUgb2YgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgc3RyaW5nLiBBbGwgc3RyaW5ncyBvciBvYmplY3RzIHdpdGggc3RyaW5nIHByb3BlcnRpZXMgaW4gYGFycmF5YCB0aGF0IGNvbnRhaW4gdGhpcyBzdHJpbmcKICAgICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAgICoKICAgICAqICAgLSBgT2JqZWN0YDogQSBwYXR0ZXJuIG9iamVjdCBjYW4gYmUgdXNlZCB0byBmaWx0ZXIgc3BlY2lmaWMgcHJvcGVydGllcyBvbiBvYmplY3RzIGNvbnRhaW5lZAogICAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgICAqICAgICBwcm9wZXJ0eSBuYW1lIGAkYCBjYW4gYmUgdXNlZCAoYXMgaW4gYHskOiJ0ZXh0In1gKSB0byBhY2NlcHQgYSBtYXRjaCBhZ2FpbnN0IGFueQogICAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAgICogICAgIGNhbGxlZCBmb3IgZWFjaCBlbGVtZW50IG9mIGBhcnJheWAuIFRoZSBmaW5hbCByZXN1bHQgaXMgYW4gYXJyYXkgb2YgdGhvc2UgZWxlbWVudHMgdGhhdAogICAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgPC90cj4KICAgICA8L3RhYmxlPgogICAgIDxocj4KICAgICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgICAgTmFtZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLm5hbWUiPjxicj4KICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgICAgPHRhYmxlIGlkPSJzZWFyY2hPYmpSZXN1bHRzIj4KICAgICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2giPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8L3RyPgogICAgIDwvdGFibGU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCdtJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0FkYW0nXSk7CgogICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgdG9FcXVhbChbJ0pvaG4nLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcnJheSwgZXhwcmVzc2lvbikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIHZhciBwcmVkaWNhdGVzID0gW107CiAgICAgICAgICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmICghcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgaWYgKHRleHQuY2hhckF0KDApID09PSAnIScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIXNlYXJjaChvYmosIHRleHQuc3Vic3RyKDEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIG9iaikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnJyArIG9iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBzZWFyY2gob2JqW29iaktleV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImFycmF5IjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHskOiBleHByZXNzaW9ufTsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJycgKyBleHByZXNzaW9uW2tleV0pLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZXh0KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnICsgZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpjdXJyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgZGVmYXVsdCBjdXJyZW5jeSBzeW1ib2wgKCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5fX08YnI+CiAgICAgY3VzdG9tIGN1cnJlbmN5IGlkZW50aWZpZXIgKFVTRCQpOiB7e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIn19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3knKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeToiVVNEJCInKSkudG9CZSgnVVNEJDEsMjM0LjU2Jyk7CiAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnYW1vdW50JykuZW50ZXIoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBjdXJyZW5jeUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgICBmdW5jdGlvbiBjdXJyZW5jeUZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYW1vdW50LCBjdXJyZW5jeVN5bWJvbCkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY3VycmVuY3lTeW1ib2wpKSBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgICAgICAgICByZXR1cm4gZm9ybWF0TnVtYmVyKGFtb3VudCwgZm9ybWF0cy5QQVRURVJOU1sxXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsIDIpLgogICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOm51bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICAgKgogICAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICAgICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gW2ZyYWN0aW9uU2l6ZT0yXSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IHt7dmFsIHwgbnVtYmVyfX08YnI+CiAgICAgTm8gZnJhY3Rpb25zOiB7e3ZhbCB8IG51bWJlcjowfX08YnI+CiAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMSwyMzUnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMSwyMzQuNTY3OScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCd2YWwnKS5lbnRlcignMzM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTMsMzc0LjMzMzAnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCgogICAgbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgICAgZnJhY3Rpb25TaXplKTsKICAgICAgICB9OwogICAgfQoKICAgIHZhciBERUNJTUFMX1NFUCA9ICcuJzsKCiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSkgJSBncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSkgJSBsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgICAgICAgICB3aGlsZSAoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvbiArPSAnMCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfQoKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1ByZSA6IHBhdHRlcm4ucG9zUHJlKTsKICAgICAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICAgICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgICAgIHZhciBuZWcgPSAnJzsKICAgICAgICBpZiAobnVtIDwgMCkgewogICAgICAgICAgICBuZWcgPSAnLSc7CiAgICAgICAgICAgIG51bSA9IC1udW07CiAgICAgICAgfQogICAgICAgIG51bSA9ICcnICsgbnVtOwogICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgZGlnaXRzKSBudW0gPSAnMCcgKyBudW07CiAgICAgICAgaWYgKHRyaW0pCiAgICAgICAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICAgICAgcmV0dXJuIG5lZyArIG51bTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGF0ZUdldHRlcihuYW1lLCBzaXplLCBvZmZzZXQsIHRyaW0pIHsKICAgICAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIGlmIChvZmZzZXQgPiAwIHx8IHZhbHVlID4gLW9mZnNldCkKICAgICAgICAgICAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIpIHZhbHVlID0gMTI7CiAgICAgICAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZVN0ckdldHRlcihuYW1lLCBzaG9ydEZvcm0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgICAgICAgIHZhciBnZXQgPSB1cHBlcmNhc2Uoc2hvcnRGb3JtID8gKCdTSE9SVCcgKyBuYW1lKSA6IG5hbWUpOwoKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgICAgICAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICB2YXIgcGFkZGVkWm9uZSA9ICh6b25lID49IDApID8gIisiIDogIiI7CgogICAgICAgIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgICAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICAgICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgICB9CgogICAgZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgICB9CgogICAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgICAgICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICAgICAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgICAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICAgICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgICAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgICAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICAgICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgICAgIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICAgICAgIEVFRTogZGF0ZVN0ckdldHRlcignRGF5JywgdHJ1ZSksCiAgICAgICAgYTogYW1wbUdldHRlciwKICAgICAgICBaOiB0aW1lWm9uZUdldHRlcgogICAgfTsKCiAgICB2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkUnXSspfCg/OicoPzpbXiddfCcnKSonKXwoPzpFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFopKSguKikvLAogICAgICAgIE5VTUJFUl9TVFJJTkcgPSAvXlxkKyQvOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmRhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGVsZW1lbnRzOgogICAgICoKICAgICAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogICAgICogICAqIGAneXknYDogMiBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBwYWRkZWQgKDAwLTk5KS4gKGUuZy4gQUQgMjAwMSA9PiAwMSwgQUQgMjAxMCA9PiAxMCkKICAgICAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAgICAgKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAgICAgKiAgICogYCdNTU0nYDogTW9udGggaW4geWVhciAoSmFuLURlYykKICAgICAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAgICAgKiAgICogYCdkZCdgOiBEYXkgaW4gbW9udGgsIHBhZGRlZCAoMDEtMzEpCiAgICAgKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICAgICAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICAgICAqICAgKiBgJ0VFRSdgOiBEYXkgaW4gV2VlaywgKFN1bi1TYXQpCiAgICAgKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICAgICAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAgICAgKiAgICogYCdoaCdgOiBIb3VyIGluIGFtL3BtLCBwYWRkZWQgKDAxLTEyKQogICAgICogICAqIGAnaCdgOiBIb3VyIGluIGFtL3BtLCAoMS0xMikKICAgICAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogICAgICogICAqIGAnbSdgOiBNaW51dGUgaW4gaG91ciAoMC01OSkKICAgICAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAgICAgKiAgICogYCdhJ2A6IGFtL3BtIG1hcmtlcgogICAgICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtKzEyMDApCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogICAgICogICB7QGxpbmsgZ3VpZGUvaTE4biBsb2NhbGl6YWJsZSBmb3JtYXRzfToKICAgICAqCiAgICAgKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICAgICAqICAgICAoZS5nLiBTZXAgMywgMjAxMCAxMjowNTowOCBwbSkKICAgICAqICAgKiBgJ3Nob3J0J2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXkgaDptbSBhJ2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gOS8zLzEwIDEyOjA1IHBtKQogICAgICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICAgICAqICAgICAoZS5nLiBGcmlkYXksIFNlcHRlbWJlciAzLCAyMDEwKQogICAgICogICAqIGAnbG9uZ0RhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcHRlbWJlciAzLCAyMDEwCiAgICAgKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogICAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydFRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW0gYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDUgcG0pCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAgICogICBgImggJ2luIHRoZSBtb3JuaW5nJyJgKS4gSW4gb3JkZXIgdG8gb3V0cHV0IHNpbmdsZSBxdW90ZSwgdXNlIHR3byBzaW5nbGUgcXVvdGVzIGluIGEgc2VxdWVuY2UKICAgICAqICAgKGUuZy4gYCJoIG8nJ2Nsb2NrImApLgogICAgICoKICAgICAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogICAgICogICAgbnVtYmVyKSBvciB2YXJpb3VzIElTTyA4NjAxIGRhdGV0aW1lIHN0cmluZyBmb3JtYXRzIChlLmcuIHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWiBhbmQgaXRzCiAgICAgKiAgICBzaG9ydGVyIHZlcnNpb25zIGxpa2UgeXl5eS1NTS1kZFRISDptbVosIHl5eXktTU0tZGQgb3IgeXl5eU1NZGRUSEhtbXNzWikuIElmIG5vIHRpbWV6b25lIGlzCiAgICAgKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGZvcm1hdCBGb3JtYXR0aW5nIHJ1bGVzIChzZWUgRGVzY3JpcHRpb24pLiBJZiBub3Qgc3BlY2lmaWVkLAogICAgICogICAgYG1lZGl1bURhdGVgIGlzIHVzZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgc3RyaW5nIG9yIHRoZSBpbnB1dCBpZiBpbnB1dCBpcyBub3QgcmVjb2duaXplZCBhcyBkYXRlL21pbGxpcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08YnI+CiAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAge3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PGJyPgogICAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+OgogICAgIHt7JzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PGJyPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgZm9ybWF0IGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gKFwtfFwrKT9cZHs0fS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS4KICAgICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBkYXRlRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgICAgICAgdmFyIFJfSVNPODYwMV9TVFIgPSAvXihcZHs0fSktPyhcZFxkKS0/KFxkXGQpKD86VChcZFxkKSg/Ojo/KFxkXGQpKD86Oj8oXGRcZCkoPzpcLihcZCspKT8pPyk/KFp8KFsrLV0pKFxkXGQpOj8oXGRcZCkpPyk/JC87CgogICAgICAgIGZ1bmN0aW9uIGpzb25TdHJpbmdUb0RhdGUoc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKFJfSVNPODYwMV9TVFIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgICAgICAgICAgIHR6SG91ciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdHpNaW4gPSAwOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoWzldKSB7CiAgICAgICAgICAgICAgICAgICAgdHpIb3VyID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTBdKTsKICAgICAgICAgICAgICAgICAgICB0ek1pbiA9IGludChtYXRjaFs5XSArIG1hdGNoWzExXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKGludChtYXRjaFsxXSksIGludChtYXRjaFsyXSkgLSAxLCBpbnQobWF0Y2hbM10pKTsKICAgICAgICAgICAgICAgIGRhdGUuc2V0VVRDSG91cnMoaW50KG1hdGNoWzRdIHx8IDApIC0gdHpIb3VyLCBpbnQobWF0Y2hbNV0gfHwgMCkgLSB0ek1pbiwgaW50KG1hdGNoWzZdIHx8IDApLCBpbnQobWF0Y2hbN10gfHwgMCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdCkgewogICAgICAgICAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIGZuLCBtYXRjaDsKCiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgICAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgICAgICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgICAgICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgICAgOiB2YWx1ZS5yZXBsYWNlKC8oXid8JyQpL2csICcnKS5yZXBsYWNlKC8nJy9nLCAiJyIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiB0ZXh0OwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogICBBbGxvd3MgeW91IHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG9iamVjdCBpbnRvIEpTT04gc3RyaW5nLgogICAgICoKICAgICAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAgICAgKiAgIHRoZSBiaW5kaW5nIGlzIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIEpTT04uCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEpTT04gc3RyaW5nLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZToKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHByZT57eyB7J25hbWUnOid2YWx1ZSd9IHwganNvbiB9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJ7J25hbWUnOid2YWx1ZSd9IikpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiBqc29uRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAgICovCiAgICB2YXIgbG93ZXJjYXNlRmlsdGVyID0gdmFsdWVGbihsb3dlcmNhc2UpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjp1cHBlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICovCiAgICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6bGltaXRUbwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5LCBhcyBzcGVjaWZpZWQgYnkgdGhlCiAgICAgKiB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkuIElmIHRoZSBgbGltaXRgIG51bWJlciBpcwogICAgICogICAgIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBhcmUKICAgICAqICAgICBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN1Yi1hcnJheSBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5IGhhZCBsZXNzIHRoYW4gYGxpbWl0YAogICAgICogICAgIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxpbWl0ID0gMzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTGltaXQge3tudW1iZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGltaXQiPgogICAgIDxwPk91dHB1dDoge3sgbnVtYmVycyB8IGxpbWl0VG86bGltaXQgfX08L3A+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bGltaXQnKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlucHV0KCdsaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpsaW1pdCcpKS50b0VxdWFsKCdbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGxpbWl0KSB7CiAgICAgICAgICAgIGlmICghKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGxpbWl0ID0gaW50KGxpbWl0KTsKICAgICAgICAgICAgdmFyIG91dCA9IFtdLAogICAgICAgICAgICAgICAgaSwgbjsKCiAgICAgICAgICAgIC8vIGNoZWNrIHRoYXQgYXJyYXkgaXMgaXRlcmFibGUKICAgICAgICAgICAgaWYgKCFhcnJheSB8fCAhKGFycmF5IGluc3RhbmNlb2YgQXJyYXkpKQogICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKCiAgICAgICAgICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgICAgICAgICBpZiAobGltaXQgPiBhcnJheS5sZW5ndGgpCiAgICAgICAgICAgICAgICBsaW1pdCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgZWxzZSBpZiAobGltaXQgPCAtYXJyYXkubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSAtYXJyYXkubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBuID0gbGltaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpID0gYXJyYXkubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgICAgICAgICBuID0gYXJyYXkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2goYXJyYXlbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOm9yZGVyQnkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdG9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogICAgICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPn0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogICAgICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogICAgICoKICAgICAqICAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAgLSBgZnVuY3Rpb25gOiBHZXR0ZXIgZnVuY3Rpb24uIFRoZSByZXN1bHQgb2YgdGhpcyBmdW5jdGlvbiB3aWxsIGJlIHNvcnRlZCB1c2luZyB0aGUKICAgICAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvci4KICAgICAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJwogICAgICogICAgICB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkICduYW1lJy4gT3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbAogICAgICogICAgICBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZyBzb3J0IG9yZGVyIChmb3IgZXhhbXBsZSwgK25hbWUgb3IgLW5hbWUpLgogICAgICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgICAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXZlcnNlIFJldmVyc2UgdGhlIG9yZGVyIHRoZSBhcnJheS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAkc2NvcGUucHJlZGljYXRlID0gJy1hZ2UnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgICAgPGhyLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZT0nJyI+dW5zb3J0ZWQ8L2E+IF0KICAgICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgICAgPHRyPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnbmFtZSc7IHJldmVyc2U9ZmFsc2UiPk5hbWU8L2E+CiAgICAgKDxhIGhyZWYgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgPC90cj4KICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICAgIDwvdHI+CiAgICAgPC90YWJsZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGJlIHJldmVyc2Ugb3JkZXJlZCBieSBhZ2VkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwcmVkaWNhdGUnKSkudG9CZSgnLWFnZScpOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMjknLCAnMjEnLCAnMTknLCAnMTAnXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKdWxpZScsICdNaWtlJywgJ01hcnknLCAnSm9obiddKTsKICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHJlb3JkZXIgdGhlIHRhYmxlIHdoZW4gdXNlciBzZWxlY3RzIGRpZmZlcmVudCBwcmVkaWNhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiTmFtZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0pvaG4nLCAnSnVsaWUnLCAnTWFyeScsICdNaWtlJ10pOwogICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnMzUnLCAnMTAnLCAnMjknLCAnMTknLCAnMjEnXSk7CgogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5waG9uZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnNTU1LTk4NzYnLCAnNTU1LTg3NjUnLCAnNTU1LTU2NzgnLCAnNTU1LTQzMjEnLCAnNTU1LTEyMTInXSk7CiAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdKdWxpZScsICdBZGFtJywgJ01pa2UnLCAnSm9obiddKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIG9yZGVyQnlGaWx0ZXIuJGluamVjdCA9IFsnJHBhcnNlJ107CiAgICBmdW5jdGlvbiBvcmRlckJ5RmlsdGVyKCRwYXJzZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICAgICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGUgOiBbc29ydFByZWRpY2F0ZV07CiAgICAgICAgICAgIHNvcnRQcmVkaWNhdGUgPSBtYXAoc29ydFByZWRpY2F0ZSwgZnVuY3Rpb24gKHByZWRpY2F0ZSkgewogICAgICAgICAgICAgICAgdmFyIGRlc2NlbmRpbmcgPSBmYWxzZSwgZ2V0ID0gcHJlZGljYXRlIHx8IGlkZW50aXR5OwogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJysnIHx8IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXNjZW5kaW5nID0gcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLCBnZXQoYikpOwogICAgICAgICAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgYXJyYXlDb3B5ID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJhdG9yKG8xLCBvMikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0Jvb2xlYW4oZGVzY2VuZGluZykKICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXAoYiwgYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgOiBjb21wOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2MikgewogICAgICAgICAgICAgICAgdmFyIHQxID0gdHlwZW9mIHYxOwogICAgICAgICAgICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICAgICAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MSA9IHYxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYxID09PSB2MikgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYxIDwgdjIgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0MSA8IHQyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5nRGlyZWN0aXZlKGRpcmVjdGl2ZSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgZGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbGluazogZGlyZWN0aXZlCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBQyc7CiAgICAgICAgcmV0dXJuIHZhbHVlRm4oZGlyZWN0aXZlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTphCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTW9kaWZpZXMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgaHRtbCBBIHRhZywgc28gdGhhdCB0aGUgZGVmYXVsdCBhY3Rpb24gaXMgcHJldmVudGVkIHdoZW4gaHJlZgogICAgICogYXR0cmlidXRlIGlzIGVtcHR5LgogICAgICoKICAgICAqIFRoZSByZWFzb25pbmcgZm9yIHRoaXMgY2hhbmdlIGlzIHRvIGFsbG93IGVhc3kgY3JlYXRpb24gb2YgYWN0aW9uIGxpbmtzIHdpdGggYG5nQ2xpY2tgIGRpcmVjdGl2ZQogICAgICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAgICAgKiBgPGEgaHJlZj0iIiBuZy1jbGljaz0ibW9kZWwuJHNhdmUoKSI+U2F2ZTwvYT5gCiAgICAgKi8KICAgIHZhciBodG1sQW5jaG9yRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAgICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgICAgICAgICAvLyBidXQgb25seSBpZiBpdCBkb2Vzbid0IGhhdmUgbmFtZSBhdHRyaWJ1dGUsIGluIHdoaWNoIGNhc2UgaXQncyBhbiBhbmNob3IKICAgICAgICAgICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ2hyZWYnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgICAgICAgICAvLyB0byBuZXcgYXR0cmlidXRlIGNvbnRlbnQgaWYgYXR0cmlidXRlIGlzIHVwZGF0ZWQgd2l0aCB2YWx1ZSBjb250YWluaW5nIEAgYW5kIGVsZW1lbnQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJ0lFIGZpeCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LmF0dHIoJ2hyZWYnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIcmVmCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogICAgICogdGhlIHBhZ2Ugb3BlbiB0byBhIHdyb25nIFVSTCwgaWYgdGhlIHVzZXIgY2xpY2tzIHRoYXQgbGluayBiZWZvcmUKICAgICAqIGFuZ3VsYXIgaGFzIGEgY2hhbmNlIHRvIHJlcGxhY2UgdGhlIHt7aGFzaH19IHdpdGggYWN0dWFsIFVSTCwgdGhlCiAgICAgKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICAgICAqIFRoZSBgbmdIcmVmYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgQQogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVGhpcyBleGFtcGxlIHVzZXMgYGxpbmtgIHZhcmlhYmxlIGluc2lkZSBgaHJlZmAgYXR0cmlidXRlOgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiB3aXRob3V0IHZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0xJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTEnKS5hdHRyKCdocmVmJykpLnRvQmUoIiIpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMicpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0yJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0zJykuYXR0cignaHJlZicpKS50b0JlKCIvMTIzIik7CgogICAgICAgICAgZWxlbWVudCgnI2xpbmstMycpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoYnJvd3NlcigpLndpbmRvdygpLnBhdGgoKSkudG9FcXVhbCgnLzEyMycpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nLWhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgnNicpOwoKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLnVybCgpKS50b0VxdWFsKCcvNicpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NyYwogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBzcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBlbGVtZW50IElNRwogICAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdEaXNhYmxlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAgICAgKiA8cHJlPgogICAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICAgKiA8L2Rpdj4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBkaXNhYmxlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nRGlzYWJsZWRgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgYnV0dG9uJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5wcm9wKCdkaXNhYmxlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hlY2tlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBjaGVja2VkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJtYXN0ZXIiPjxici8+CiAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdtYXN0ZXInKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNdWx0aXBsZQogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSB0aGUgYG5nTXVsdGlwbGVgIGRpcmVjdGl2ZS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSBjaGVjayBtdWx0aXBsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICA8c2VsZWN0IGlkPSJzZWxlY3QiIG5nLW11bHRpcGxlPSJjaGVja2VkIj4KICAgICA8b3B0aW9uPk1pc2tvPC9vcHRpb24+CiAgICAgPG9wdGlvbj5JZ29yPC9vcHRpb24+CiAgICAgPG9wdGlvbj5Wb2p0YTwvb3B0aW9uPgogICAgIDxvcHRpb24+RGk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBtdWx0aXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc2VsZWN0JykucHJvcCgnbXVsdGlwbGUnKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IFNFTEVDVAogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ011bHRpcGxlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IHdpbGwgYmUgZXZhbHVhdGVkLgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUmVhZG9ubHkKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLXJlYWRvbmx5PSJjaGVja2VkIiB2YWx1ZT0iSSdtIEFuZ3VsYXIiLz4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1NlbGVjdGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHNlbGVjdGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlZCB0aGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgICAgPHNlbGVjdD4KICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHNlbGVjdCBHcmVldGluZ3MhJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnc2VsZWN0ZWQnKS5jaGVjaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLnByb3AoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IE9QVElPTgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24gKHByb3BOYW1lLCBhdHRyTmFtZSkgewogICAgICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0pOwoKCi8vIG5nLXNyYywgbmctaHJlZiBhcmUgaW50ZXJwb2xhdGVkCiAgICBmb3JFYWNoKFsnc3JjJywgJ2hyZWYnXSwgZnVuY3Rpb24gKGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIGVsZW1lbnQucHJvcChhdHRyTmFtZSwgYXR0clthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCiAgICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgICAgICRhZGRDb250cm9sOiBub29wLAogICAgICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICAgICAkc2V0RGlydHk6IG5vb3AKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybSB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgY29udGFpbmluZyBjb250cm9sIG9yIGZvcm0gaXMgaW52YWxpZC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIElzIGFuIG9iamVjdCBoYXNoLCBjb250YWluaW5nIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgY29udHJvbHMgb3IKICAgICAqICBmb3Jtcywgd2hlcmU6CiAgICAgKgogICAgICogIC0ga2V5cyBhcmUgdmFsaWRhdGlvbiB0b2tlbnMgKGVycm9yIG5hbWVzKSDigJQgc3VjaCBhcyBgcmVxdWlyZWRgLCBgdXJsYCBvciBgZW1haWxgKSwKICAgICAqICAtIHZhbHVlcyBhcmUgYXJyYXlzIG9mIGNvbnRyb2xzIG9yIGZvcm1zIHRoYXQgYXJlIGludmFsaWQgd2l0aCBnaXZlbiBlcnJvci4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIGBGb3JtQ29udHJvbGxlcmAga2VlcHMgdHJhY2sgb2YgYWxsIGl0cyBjb250cm9scyBhbmQgbmVzdGVkIGZvcm1zIGFzIHdlbGwgYXMgc3RhdGUgb2YgdGhlbSwKICAgICAqIHN1Y2ggYXMgYmVpbmcgdmFsaWQvaW52YWxpZCBvciBkaXJ0eS9wcmlzdGluZS4KICAgICAqCiAgICAgKiBFYWNoIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfSBkaXJlY3RpdmUgY3JlYXRlcyBhbiBpbnN0YW5jZQogICAgICogb2YgYEZvcm1Db250cm9sbGVyYC4KICAgICAqCiAgICAgKi8KLy9hc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgIEZvcm1Db250cm9sbGVyLiRpbmplY3QgPSBbJyRlbGVtZW50JywgJyRhdHRycycsICckc2NvcGUnXTsKICAgIGZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLAogICAgICAgICAgICBwYXJlbnRGb3JtID0gZWxlbWVudC5wYXJlbnQoKS5jb250cm9sbGVyKCdmb3JtJykgfHwgbnVsbEZvcm1DdHJsLAogICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgIGVycm9ycyA9IGZvcm0uJGVycm9yID0ge307CgogICAgICAgIC8vIGluaXQgc3RhdGUKICAgICAgICBmb3JtLiRuYW1lID0gYXR0cnMubmFtZTsKICAgICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgICAgICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgIGVsZW1lbnQuCiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgYWRkQ2xhc3MoKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICAgICAgICB9CgogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICBpZiAoY29udHJvbC4kbmFtZSAmJiAhZm9ybS5oYXNPd25Qcm9wZXJ0eShjb250cm9sLiRuYW1lKSkgewogICAgICAgICAgICAgICAgZm9ybVtjb250cm9sLiRuYW1lXSA9IGNvbnRyb2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRyZW1vdmVDb250cm9sID0gZnVuY3Rpb24gKGNvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgZm9ybVtjb250cm9sLiRuYW1lXSA9PT0gY29udHJvbCkgewogICAgICAgICAgICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uIChxdWV1ZSwgdmFsaWRhdGlvblRva2VuKSB7CiAgICAgICAgICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSA9IGZ1bmN0aW9uICh2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICAgICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZm9ybS4kaW52YWxpZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3JtLiRzZXREaXJ0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhQUklTVElORV9DTEFTUykuYWRkQ2xhc3MoRElSVFlfQ0xBU1MpOwogICAgICAgICAgICBmb3JtLiRkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIGZvcm0uJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgfTsKCiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRm9ybQogICAgICogQHJlc3RyaWN0IEVBQwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTmVzdGFibGUgYWxpYXMgb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGBmb3JtYH0gZGlyZWN0aXZlLiBIVE1MCiAgICAgKiBkb2VzIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGZvcm0gZWxlbWVudHMuIEl0IGlzIHVzZWZ1bCB0byBuZXN0IGZvcm1zLCBmb3IgZXhhbXBsZSBpZiB0aGUgdmFsaWRpdHkgb2YgYQogICAgICogc3ViLWdyb3VwIG9mIGNvbnRyb2xzIG5lZWRzIHRvIGJlIGRldGVybWluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lfG5nRm9ybSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICAqCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGlyZWN0aXZlIHRoYXQgaW5zdGFudGlhdGVzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogICAgICoKICAgICAqIElmIGBuYW1lYCBhdHRyaWJ1dGUgaXMgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIGlzIHB1Ymxpc2hlZCBvbnRvIHRoZSBjdXJyZW50IHNjb3BlIHVuZGVyCiAgICAgKiB0aGlzIG5hbWUuCiAgICAgKgogICAgICogIyBBbGlhczoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9CiAgICAgKgogICAgICogSW4gYW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICAgKiBmb3JtcyBhcmUgdmFsaWQgYXMgd2VsbC4gSG93ZXZlciBicm93c2VycyBkbyBub3QgYWxsb3cgbmVzdGluZyBvZiBgPGZvcm0+YCBlbGVtZW50cywgZm9yIHRoaXMKICAgICAqIHJlYXNvbiBhbmd1bGFyIHByb3ZpZGVzIHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfSBhbGlhcwogICAgICogd2hpY2ggYmVoYXZlcyBpZGVudGljYWwgdG8gYDxmb3JtPmAgYnV0IGFsbG93cyBmb3JtIG5lc3RpbmcuCiAgICAgKgogICAgICoKICAgICAqICMgQ1NTIGNsYXNzZXMKICAgICAqICAtIGBuZy12YWxpZGAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogICAgICogIC0gYG5nLWludmFsaWRgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBpbnZhbGlkLgogICAgICogIC0gYG5nLXByaXN0aW5lYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICAgKiAgLSBgbmctZGlydHlgIElzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICAgICAqCiAgICAgKgogICAgICogIyBTdWJtaXR0aW5nIGEgZm9ybSBhbmQgcHJldmVudGluZyBkZWZhdWx0IGFjdGlvbgogICAgICoKICAgICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAgICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAgICAgKiBwYWdlIHJlbG9hZCB0aGF0IHNlbmRzIHRoZSBkYXRhIHRvIHRoZSBzZXJ2ZXIuIEluc3RlYWQgc29tZSBqYXZhc2NyaXB0IGxvZ2ljIHNob3VsZCBiZSB0cmlnZ2VyZWQKICAgICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheS4KICAgICAqCiAgICAgKiBGb3IgdGhpcyByZWFzb24sIEFuZ3VsYXIgcHJldmVudHMgdGhlIGRlZmF1bHQgYWN0aW9uIChmb3JtIHN1Ym1pc3Npb24gdG8gdGhlIHNlcnZlcikgdW5sZXNzIHRoZQogICAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBvbmUgb2YgdGhlIGZvbGxvd2luZyB0d28gd2F5cyB0byBzcGVjaWZ5IHdoYXQgamF2YXNjcmlwdCBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCB3aGVuCiAgICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAgICoKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdCBuZ1N1Ym1pdH0gZGlyZWN0aXZlIG9uIHRoZSBmb3JtIGVsZW1lbnQKICAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgICAqCiAgICAgKiBUbyBwcmV2ZW50IGRvdWJsZSBleGVjdXRpb24gb2YgdGhlIGhhbmRsZXIsIHVzZSBvbmx5IG9uZSBvZiBuZ1N1Ym1pdCBvciBuZ0NsaWNrIGRpcmVjdGl2ZXMuIFRoaXMKICAgICAqIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgY29taW5nIGZyb20gdGhlIGh0bWwgc3BlYzoKICAgICAqCiAgICAgKiAtIElmIGEgZm9ybSBoYXMgb25seSBvbmUgaW5wdXQgZmllbGQgdGhlbiBoaXR0aW5nIGVudGVyIGluIHRoaXMgZmllbGQgdHJpZ2dlcnMgZm9ybSBzdWJtaXQKICAgICAqIChgbmdTdWJtaXRgKQogICAgICogLSBpZiBhIGZvcm0gaGFzIGhhcyAyKyBpbnB1dCBmaWVsZHMgYW5kIG5vIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4gaGl0dGluZyBlbnRlcgogICAgICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogICAgICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogICAgICogaGl0dGluZyBlbnRlciBpbiBhbnkgb2YgdGhlIGlucHV0IGZpZWxkcyB3aWxsIHRyaWdnZXIgdGhlIGNsaWNrIGhhbmRsZXIgb24gdGhlICpmaXJzdCogYnV0dG9uIG9yCiAgICAgKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+UmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8L2Zvcm0+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgndXNlclR5cGUnKS5lbnRlcignJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgZm9ybURpcmVjdGl2ZUZhY3RvcnkgPSBmdW5jdGlvbiAoaXNOZ0Zvcm0pIHsKICAgICAgICByZXR1cm4gWyckdGltZW91dCcsIGZ1bmN0aW9uICgkdGltZW91dCkgewogICAgICAgICAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6ICdmb3JtJywKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBGb3JtQ29udHJvbGxlciwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIChzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFjdGlvbiBpcyBub3QgcHJldmVudGVkLiBzZWUgIzEyMzgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFnZSByZWxvYWQgaWYgdGhlIGZvcm0gd2FzIGRlc3Ryb3llZCBieSBzdWJtaXNzaW9uIG9mIHRoZSBmb3JtIHZpYSBhIGNsaWNrIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdW5yZWdpc3RlciB0aGUgcHJldmVudERlZmF1bHQgbGlzdGVuZXIgc28gdGhhdCB3ZSBkb24ndCBub3QgbGVhayBtZW1vcnkgYnV0IGluIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3YXkgdGhhdCB3aWxsIGFjaGlldmUgdGhlIHByZXZlbnRpb24gb2YgdGhlIGRlZmF1bHQgYWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZm9ybUVsZW1lbnRbMF0sICdzdWJtaXQnLCBwcmV2ZW50RGVmYXVsdExpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlhcyA9IGF0dHIubmFtZSB8fCBhdHRyLm5nRm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVthbGlhc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZvcm1DdHJsLiRyZW1vdmVDb250cm9sKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW2FsaWFzXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRlbmQoY29udHJvbGxlciwgbnVsbEZvcm1DdHJsKTsgLy9zdG9wIHByb3BhZ2F0aW5nIGNoaWxkIGRlc3RydWN0aW9uIGhhbmRsZXJzIHVwd2FyZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gaXNOZ0Zvcm0gPyBleHRlbmQoY29weShmb3JtRGlyZWN0aXZlKSwge3Jlc3RyaWN0OiAnRUFDJ30pIDogZm9ybURpcmVjdGl2ZTsKICAgICAgICB9XTsKICAgIH07CgogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogICAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAgIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICAgIHZhciBFTUFJTF9SRUdFWFAgPSAvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDR9JC87CiAgICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgICB2YXIgaW5wdXRUeXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2d1ZXN0JzsKICAgICAgICAgICAgICRzY29wZS53b3JkID0gL15cdyokLzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBTaW5nbGUgd29yZDogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIKICAgICAgICAgbmctcGF0dGVybj0id29yZCIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnBhdHRlcm4iPgogICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2hlbGxvIHdvcmxkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ3RleHQnOiB0ZXh0SW5wdXRUeXBlLAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGlucHV0VHlwZQogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTppbnB1dC5udW1iZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRleHQgaW5wdXQgd2l0aCBudW1iZXIgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIFNldHMgdGhlIGBudW1iZXJgIHZhbGlkYXRpb24KICAgICAgICAgKiBlcnJvciBpZiBub3QgYSB2YWxpZCBudW1iZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgICAgIG1pbj0iMCIgbWF4PSI5OSIgcmVxdWlyZWQ+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5saXN0LiRlcnJvci5udW1iZXIiPgogICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnMTInKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJzEyMycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdudW1iZXInOiBudW1iZXJJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnVybAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIFVSTCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgdXJsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgY29udGVudCBpcyBub3QgYQogICAgICAgICAqIHZhbGlkIFVSTC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICAgICAqICAgIG1heGxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVVJMOiA8aW5wdXQgdHlwZT0idXJsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci51cmwiPgogICAgICAgICBOb3QgdmFsaWQgdXJsITwvc3Bhbj4KICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci51cmwgPSB7eyEhbXlGb3JtLiRlcnJvci51cmx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdodHRwOi8vZ29vZ2xlLmNvbScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgdXJsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3h4eCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAgICAgICAqIGFkZHJlc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgRW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IuZW1haWwiPgogICAgICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdtZUBleGFtcGxlLmNvbScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQucmFkaW8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgcmFkaW8gYnV0dG9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS5jb2xvciA9ICdibHVlJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0iYmx1ZSI+IEJsdWUgPGJyLz4KICAgICAgICAgPHR0PmNvbG9yID0ge3tjb2xvcn19PC90dD48YnIvPgogICAgICAgICA8L2Zvcm0+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbG9yJykpLnRvRXF1YWwoJ2JsdWUnKTsKCiAgICAgICAgICAgIGlucHV0KCdjb2xvcicpLnNlbGVjdCgncmVkJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTEgPSB0cnVlOwogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMiA9ICdZRVMnCiAgICAgICAgICAgfQogICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgICAgIDwvZm9ybT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMicpKS50b0VxdWFsKCdZRVMnKTsKCiAgICAgICAgICAgIGlucHV0KCd2YWx1ZTEnKS5jaGVjaygpOwogICAgICAgICAgICBpbnB1dCgndmFsdWUyJykuY2hlY2soKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlMScpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ05PJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgICAgICdoaWRkZW4nOiBub29wLAogICAgICAgICdidXR0b24nOiBub29wLAogICAgICAgICdzdWJtaXQnOiBub29wLAogICAgICAgICdyZXNldCc6IG5vb3AKICAgIH07CgoKICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRyaW0oZWxlbWVudC52YWwoKSk7CgogICAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBpZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgImlucHV0IiBldmVudCwgd2UgYXJlIGZpbmUgLSBleGNlcHQgb24gSUU5IHdoaWNoIGRvZXNuJ3QgZmlyZSB0aGUKICAgICAgICAvLyBpbnB1dCBldmVudCBvbiBiYWNrc3BhY2UsIGRlbGV0ZSBvciBjdXQKICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ2lucHV0JykpIHsKICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdpbnB1dCcsIGxpc3RlbmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdGltZW91dDsKCiAgICAgICAgICAgIHZhciBkZWZlckxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAgICAgICAgIC8vIGlnbm9yZQogICAgICAgICAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgICAgICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgICAgICAgICBlbGVtZW50LmJpbmQoJ2NoYW5nZScsIGxpc3RlbmVyKTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgbW9kaWZpZXMgaW5wdXQgdmFsdWUgdXNpbmcgY29udGV4dCBtZW51IGluIElFLCB3ZSBuZWVkICJwYXN0ZSIgYW5kICJjdXQiIGV2ZW50cyB0byBjYXRjaCBpdAogICAgICAgICAgICBpZiAoJHNuaWZmZXIuaGFzRXZlbnQoJ3Bhc3RlJykpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQudmFsKGlzRW1wdHkoY3RybC4kdmlld1ZhbHVlKSA/ICcnIDogY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgICAgIHZhciBwYXR0ZXJuID0gYXR0ci5uZ1BhdHRlcm4sCiAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3I7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uIChyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAocGF0dGVybikgewogICAgICAgICAgICBpZiAocGF0dGVybi5tYXRjaCgvXlwvKC4qKVwvJC8pKSB7CiAgICAgICAgICAgICAgICBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnN1YnN0cigxLCBwYXR0ZXJuLmxlbmd0aCAtIDIpKTsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybiwgdmFsdWUpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGF0dGVybk9iaiB8fCAhcGF0dGVybk9iai50ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdHRlcm4gKyAnIHRvIGJlIGEgUmVnRXhwIGJ1dCB3YXMgJyArIHBhdHRlcm5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGUocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoIDwgbWlubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbmxlbmd0aCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgLy8gbWF4IGxlbmd0aCB2YWxpZGF0b3IKICAgICAgICBpZiAoYXR0ci5uZ01heGxlbmd0aCkgewogICAgICAgICAgICB2YXIgbWF4bGVuZ3RoID0gaW50KGF0dHIubmdNYXhsZW5ndGgpOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA+IG1heGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXhsZW5ndGgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heGxlbmd0aCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbnVtYmVySW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGlzRW1wdHkodmFsdWUpOwogICAgICAgICAgICBpZiAoZW1wdHkgfHwgTlVNQkVSX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzRW1wdHkodmFsdWUpID8gJycgOiAnJyArIHZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoYXR0ci5taW4pIHsKICAgICAgICAgICAgdmFyIG1pbiA9IHBhcnNlRmxvYXQoYXR0ci5taW4pOwogICAgICAgICAgICB2YXIgbWluVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlIDwgbWluKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21pbicsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWluJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGF0dHIubWF4KSB7CiAgICAgICAgICAgIHZhciBtYXggPSBwYXJzZUZsb2F0KGF0dHIubWF4KTsKICAgICAgICAgICAgdmFyIG1heFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZSA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtYXgnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBpc051bWJlcih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdudW1iZXInLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gdXJsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgdXJsVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgndXJsJywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgICAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgICAgICB2YXIgZW1haWxWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ2VtYWlsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduYW1lJywgbmV4dFVpZCgpKTsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGVsZW1lbnRbMF0uY2hlY2tlZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9IGN0cmwuJHZpZXdWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdHJ1ZVZhbHVlOwogICAgICAgIH0pOwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IHRydWVWYWx1ZSA6IGZhbHNlVmFsdWU7CiAgICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnRleHRhcmVhCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCB0ZXh0YXJlYSBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gVGhlIGRhdGEtYmluZGluZyBhbmQgdmFsaWRhdGlvbgogICAgICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQKICAgICAqIEByZXN0cmljdCBFCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVE1MIGlucHV0IGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBJbnB1dCBjb250cm9sIGZvbGxvd3MgSFRNTDUgaW5wdXQgdHlwZXMKICAgICAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nUmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBpZiBzZXQgdG8gdHJ1ZQogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgVXNlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXNlck5hbWUiIG5nLW1vZGVsPSJ1c2VyLm5hbWUiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLnVzZXJOYW1lLiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPjxicj4KICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICAgIFRvbyBzaG9ydCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1heGxlbmd0aCI+CiAgICAgVG9vIGxvbmchPC9zcGFuPjxicj4KICAgICA8L2Zvcm0+CiAgICAgPGhyPgogICAgIDx0dD51c2VyID0ge3t1c2VyfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kdmFsaWQgPSB7e215Rm9ybS51c2VyTmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiR2YWxpZCA9IHt7bXlGb3JtLmxhc3ROYW1lLiR2YWxpZH19PC90dD48YnI+CiAgICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kZXJyb3IgPSB7e215Rm9ybS5sYXN0TmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5taW5sZW5ndGggPSB7eyEhbXlGb3JtLiRlcnJvci5taW5sZW5ndGh9fTwvdHQ+PGJyPgogICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLm5hbWUnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcignJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbGVzcyB0aGFuIHJlcXVpcmVkIG1pbiBsZW5ndGgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd1c2VyLmxhc3QnKS5lbnRlcigneHgnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9taW5sZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJ3NvbWUgcmlkaWN1bG91c2x5IGxvbmcgbmFtZScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkKICAgICAgICAgICAgLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKS50b01hdGNoKC9tYXhsZW5ndGgvKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICAgICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgICAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICAgICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogICAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBXaGVuZXZlciB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00sIGl0IGV4ZWN1dGVzCiAgICAgKiAgICAgYWxsIG9mIHRoZXNlIGZ1bmN0aW9ucyB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBXaGVuZXZlciB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcywgaXQgZXhlY3V0ZXMgYWxsIG9mCiAgICAgKiAgICAgdGhlc2UgZnVuY3Rpb25zIHRvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGUuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBiamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHByaXN0aW5lIFRydWUgaWYgdXNlciBoYXMgbm90IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbCB5ZXQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGludmFsaWQgVHJ1ZSBpZiBhdCBsZWFzdCBvbmUgZXJyb3Igb24gdGhlIGNvbnRyb2wuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGUsIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICAgKiBzcGVjaWZpY2FsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAgICogRE9NIGV2ZW50cy4gVGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgaXMgbWVhbnQgdG8gYmUgZXh0ZW5kZWQgYnkgb3RoZXIgZGlyZWN0aXZlcyB3aGVyZSwgdGhlCiAgICAgKiBkaXJlY3RpdmUgcHJvdmlkZXMgRE9NIG1hbmlwdWxhdGlvbiBhbmQgdGhlIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgdGhlIGRhdGEtYmluZGluZy4KICAgICAqCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAgICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIDxleGFtcGxlIG1vZHVsZT0iY3VzdG9tQ29udHJvbCI+CiAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICBbY29udGVudGVkaXRhYmxlXSB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7CiAgICAgICAgbWluLWhlaWdodDogMjBweDsKICAgICAgfQoKICAgICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGFuZ3VsYXIubW9kdWxlKCdjdXN0b21Db250cm9sJywgW10pLgogICAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0EnLCAvLyBvbmx5IGFjdGl2YXRlIG9uIGVsZW1lbnQgYXR0cmlidXRlCiAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBuZ01vZGVsKSB7CiAgICAgICAgICAgICAgaWYoIW5nTW9kZWwpIHJldHVybjsgLy8gZG8gbm90aGluZyBpZiBubyBuZy1tb2RlbAoKICAgICAgICAgICAgICAvLyBTcGVjaWZ5IGhvdyBVSSBzaG91bGQgYmUgdXBkYXRlZAogICAgICAgICAgICAgIG5nTW9kZWwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJyk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCdibHVyIGtleXVwIGNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlYWQoKTsgLy8gaW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAvLyBXcml0ZSBkYXRhIHRvIHRoZSBtb2RlbAogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoKSB7CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoZWxlbWVudC5odG1sKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgICA8ZGl2IGNvbnRlbnRlZGl0YWJsZQogICAgIG5hbWU9Im15V2lkZ2V0IiBuZy1tb2RlbD0idXNlckNvbnRlbnQiCiAgICAgcmVxdWlyZWQ+Q2hhbmdlIG1lITwvZGl2PgogICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICA8aHI+CiAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGRhdGEtYmluZCBhbmQgYmVjb21lIGludmFsaWQnLCBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGVudEVkaXRhYmxlID0gZWxlbWVudCgnW2NvbnRlbnRlZGl0YWJsZV0nKTsKCiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJ0NoYW5nZSBtZSEnKTsKICAgICAgICBpbnB1dCgndXNlckNvbnRlbnQnKS5lbnRlcignJyk7CiAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUucHJvcCgnY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLWludmFsaWQtcmVxdWlyZWQvKTsKICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgICogPC9leGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIE5nTW9kZWxDb250cm9sbGVyID0gWyckc2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJGF0dHJzJywgJyRlbGVtZW50JywgJyRwYXJzZScsCiAgICAgICAgZnVuY3Rpb24gKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlKSB7CiAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgICAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgICAgICAgICAgbmdNb2RlbFNldCA9IG5nTW9kZWxHZXQuYXNzaWduOwoKICAgICAgICAgICAgaWYgKCFuZ01vZGVsU2V0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihOT05fQVNTSUdOQUJMRV9NT0RFTF9FWFBSRVNTSU9OICsgJGF0dHIubmdNb2RlbCArCiAgICAgICAgICAgICAgICAgICAgJyAoJyArIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSArICcpJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAgICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgICAgICAkZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpLgogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0Vmlld1ZhbHVlCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmVhZCBhIHZhbHVlIGZyb20gdmlldy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBmcm9tIHdpdGhpbiBhIERPTSBldmVudCBoYW5kbGVyLgogICAgICAgICAgICAgKiBGb3IgZXhhbXBsZSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fSBvcgogICAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9IGRpcmVjdGl2ZXMgY2FsbCBpdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSXQgaW50ZXJuYWxseSBjYWxscyBhbGwgYHBhcnNlcnNgIGFuZCBpZiByZXN1bHRlZCB2YWx1ZSBpcyB2YWxpZCwgdXBkYXRlcyB0aGUgbW9kZWwgYW5kCiAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR2aWV3VmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBjaGFuZ2UgdG8gZGlydHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLiRwcmlzdGluZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKFBSSVNUSU5FX0NMQVNTKS5hZGRDbGFzcyhESVJUWV9DTEFTUyk7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3JFYWNoKHRoaXMuJHBhcnNlcnMsIGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxTZXQoJHNjb3BlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIG1vZGVsIC0+IHZhbHVlCiAgICAgICAgICAgIHZhciBjdHJsID0gdGhpczsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdNb2RlbFdhdGNoKCkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbmdNb2RlbEdldCgkc2NvcGUpOwoKICAgICAgICAgICAgICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgICAgICAgICAgICAgaWYgKGN0cmwuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBmb3JtYXR0ZXJzID0gY3RybC4kZm9ybWF0dGVycywKICAgICAgICAgICAgICAgICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaWR4LS0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kdmlld1ZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwKICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSXMgZGlyZWN0aXZlIHRoYXQgdGVsbHMgQW5ndWxhciB0byBkbyB0d28td2F5IGRhdGEgYmluZGluZy4gSXQgd29ya3MgdG9nZXRoZXIgd2l0aCBgaW5wdXRgLAogICAgICogYHNlbGVjdGAsIGB0ZXh0YXJlYWAuIFlvdSBjYW4gZWFzaWx5IHdyaXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMgdG8gdXNlIGBuZ01vZGVsYCBhcyB3ZWxsLgogICAgICoKICAgICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICAgKgogICAgICogLSBiaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAgICogICByZXF1aXJlLAogICAgICogLSBwcm92aWRpbmcgdmFsaWRhdGlvbiBiZWhhdmlvciAoaS5lLiByZXF1aXJlZCwgbnVtYmVyLCBlbWFpbCwgdXJsKSwKICAgICAqIC0ga2VlcGluZyBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKSwKICAgICAqIC0gc2V0dGluZyByZWxhdGVkIGNzcyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50IChgbmctdmFsaWRgLCBgbmctaW52YWxpZGAsIGBuZy1kaXJ0eWAsIGBuZy1wcmlzdGluZWApLAogICAgICogLSByZWdpc3RlciB0aGUgY29udHJvbCB3aXRoIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICAgKgogICAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAgICoKICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dCB0ZXh0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94IGNoZWNrYm94fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvIHJhZGlvfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlciBudW1iZXJ9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQuZW1haWwgZW1haWx9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudXJsIHVybH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICAgKgogICAgICovCiAgICB2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZm9ybUN0cmwuJHJlbW92ZUNvbnRyb2wobW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2hhbmdlCiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHVzZXIgY2hhbmdlcyB0aGUgaW5wdXQuCiAgICAgKiBUaGUgZXhwcmVzc2lvbiBpcyBub3QgZXZhbHVhdGVkIHdoZW4gdGhlIHZhbHVlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSB0aGUgbW9kZWwuCiAgICAgKgogICAgICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgaW5wdXQKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPGRvYzpleGFtcGxlPgogICAgICogICA8ZG9jOnNvdXJjZT4KICAgICAqICAgICA8c2NyaXB0PgogICAgICogICAgICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICogICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7CiAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICB9OwogKiAgICAgICB9CiAgICAgKiAgICAgPC9zY3JpcHQ+CiAgICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICAgICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgICAqICAgICAgIGRlYnVnID0ge3tjb25maXJtZWR9fTxiciAvPgogICAgICogICAgICAgY291bnRlciA9IHt7Y291bnRlcn19CiAgICAgKiAgICAgPC9kaXY+CiAgICAgKiAgIDwvZG9jOnNvdXJjZT4KICAgICAqICAgPGRvYzpzY2VuYXJpbz4KICAgICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAqICAgICAgIGVsZW1lbnQoJyNuZy1jaGFuZ2UtZXhhbXBsZTEnKS5jbGljaygpOwogKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcxJyk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb25maXJtZWQnKSkudG9FcXVhbCgndHJ1ZScpOwogKiAgICAgfSk7CiAgICAgKgogICAgICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMicpLmNsaWNrKCk7CiAqICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudGVyJykpLnRvRXF1YWwoJzAnKTsKICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvbmZpcm1lZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAqICAgICB9KTsKICAgICAqICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgKiA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKICAgIHZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIChpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA9PT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdMaXN0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBjb21tYS1zZXBhcmF0ZWQgc3RyaW5nIGludG8gYW4gYXJyYXkgb2Ygc3RyaW5ncy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAgICogICBzcGVjaWZpZWQgaW4gZm9ybSBgL3NvbWV0aGluZy9gIHRoZW4gdGhlIHZhbHVlIHdpbGwgYmUgY29udmVydGVkIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtaXNrbycsICd2b2p0YSddOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxpc3QuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHR0Pm5hbWVzID0ge3tuYW1lc319PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5uYW1lc0lucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbImlnb3IiLCJtaXNrbyIsInZvanRhIl0nKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCduYW1lcycpLmVudGVyKCcnKTsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCduYW1lcycpKS50b0VxdWFsKCdbXScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0xpc3REaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gbWF0Y2ggJiYgbmV3IFJlZ0V4cChtYXRjaFsxXSkgfHwgYXR0ci5uZ0xpc3QgfHwgJywnOwoKICAgICAgICAgICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uICh2aWV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwoKICAgICAgICAgICAgICAgICAgICBpZiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CgogICAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKHRwbCwgdHBsQXR0cikgewogICAgICAgICAgICAgICAgaWYgKENPTlNUQU5UX1ZBTFVFX1JFR0VYUC50ZXN0KHRwbEF0dHIubmdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHNjb3BlLiRldmFsKGF0dHIubmdWYWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogICAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAgICoKICAgICAqIE9uZSBzY2VuYXJpbyBpbiB3aGljaCB0aGUgdXNlIG9mIGBuZ0JpbmRgIGlzIHByZWZlcnJlZCBvdmVyIGB7eyBleHByZXNzaW9uIH19YCBiaW5kaW5nIGlzIHdoZW4KICAgICAqIGl0J3MgZGVzaXJhYmxlIHRvIHB1dCBiaW5kaW5ncyBpbnRvIHRlbXBsYXRlIHRoYXQgaXMgbW9tZW50YXJpbHkgZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cwogICAgICogcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlCiAgICAgKiBiaW5kaW5ncyBpbnZpc2libGUgdG8gdGhlIHVzZXIgd2hpbGUgdGhlIHBhZ2UgaXMgbG9hZGluZy4KICAgICAqCiAgICAgKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30gZGlyZWN0aXZlLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCaW5kIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBFbnRlciBhIG5hbWUgaW4gdGhlIExpdmUgUHJldmlldyB0ZXh0IGJveDsgdGhlIGdyZWV0aW5nIGJlbG93IHRoZSB0ZXh0IGJveCBjaGFuZ2VzIGluc3RhbnRseS4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1doaXJsZWQnOwogICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgICBIZWxsbyA8c3BhbiBuZy1iaW5kPSJuYW1lIj48L3NwYW4+IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS50b0JlKCdXaGlybGVkJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3dvcmxkJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdCaW5kRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgYXR0ci5uZ0JpbmQpOwogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0pOwogICAgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZFRlbXBsYXRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQmluZFRlbXBsYXRlYCBkaXJlY3RpdmUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICAgICAqIHRleHQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIHRlbXBsYXRlIGluIG5nQmluZFRlbXBsYXRlLgogICAgICogVW5saWtlIG5nQmluZCB0aGUgbmdCaW5kVGVtcGxhdGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAgICAgKiBleHByZXNzaW9ucy4gKFRoaXMgaXMgcmVxdWlyZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAgICAgKiBjYW4gbm90IGhhdmUgU1BBTiBlbGVtZW50cyBzdWNoIGFzIFRJVExFLCBvciBPUFRJT04gdG8gbmFtZSBhIGZldy4pCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1dvcmxkJzsKICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdIZWxsbycpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnbmFtZScpKS4KICAgICAgICAgICB0b0JlKCdXb3JsZCcpOwogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnc2FsdXRhdGlvbicpLmVudGVyKCdHcmVldGluZ3MnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcigndXNlcicpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuYmluZGluZygnc2FsdXRhdGlvbicpKS4KICAgICAgICAgICB0b0JlKCdHcmVldGluZ3MnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgdG9CZSgndXNlcicpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWxVbnNhZmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAgICogZWxlbWVudC4gKlRoZSBpbm5lckhUTUwtZWQgY29udGVudCB3aWxsIG5vdCBiZSBzYW5pdGl6ZWQhKiBZb3Ugc2hvdWxkIHVzZSB0aGlzIGRpcmVjdGl2ZSBvbmx5IGlmCiAgICAgKiB7QGxpbmsgbmdTYW5pdGl6ZS5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgaXMgdG9vCiAgICAgKiByZXN0cmljdGl2ZSBhbmQgd2hlbiB5b3UgYWJzb2x1dGVseSB0cnVzdCB0aGUgc291cmNlIG9mIHRoZSBjb250ZW50IHlvdSBhcmUgYmluZGluZyB0by4KICAgICAqCiAgICAgKiBTZWUge0BsaW5rIG5nU2FuaXRpemUuJHNhbml0aXplICRzYW5pdGl6ZX0gZG9jcyBmb3IgZXhhbXBsZXMuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWxVbnNhZmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKi8KICAgIHZhciBuZ0JpbmRIdG1sVW5zYWZlRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbFVuc2FmZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWxVbnNhZmUsIGZ1bmN0aW9uIG5nQmluZEh0bWxVbnNhZmVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgb2xkVmFsID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdjbGFzcycsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIG5nQ2xhc3MgPSBzY29wZS4kZXZhbChhdHRyW25hbWVdKTsKICAgICAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihuZ0NsYXNzLCBuZ0NsYXNzKTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgaWYgKG5hbWUgIT09ICduZ0NsYXNzJykgewogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCckaW5kZXgnLCBmdW5jdGlvbiAoJGluZGV4LCBvbGQkaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kICE9PSBvbGQkaW5kZXggJiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsIG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Mob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MobmV3VmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9sZFZhbCA9IGNvcHkobmV3VmFsKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNsYXNzKGNsYXNzVmFsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoY2xhc3NWYWwpICYmICFpc0FycmF5KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzVmFsID0gbWFwKGNsYXNzVmFsLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgcmV0dXJuIGsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoaXNBcnJheShjbGFzc1ZhbCkgPyBjbGFzc1ZhbC5qb2luKCcgJykgOiBjbGFzc1ZhbCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSAmJiAhaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc1ZhbCA9IG1hcChjbGFzc1ZhbCwgZnVuY3Rpb24gKHYsIGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHJldHVybiBrCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGlzQXJyYXkoY2xhc3NWYWwpID8gY2xhc3NWYWwuam9pbignICcpIDogY2xhc3NWYWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzYCBhbGxvd3MgeW91IHRvIHNldCBDU1MgY2xhc3Mgb24gSFRNTCBlbGVtZW50IGR5bmFtaWNhbGx5IGJ5IGRhdGFiaW5kaW5nIGFuCiAgICAgKiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MKICAgICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgICAgPGJyPgogICAgIDxzcGFuIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm15LWNsYXNzIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246Zmlyc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJzpidXR0b246bGFzdCcpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGFzc09kZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgICAqICAgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fQogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ2xhc3NFdmVuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogICAgICogICByZXN1bHQgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgIDwvc3Bhbj4KICAgICA8L2xpPgogICAgIDwvb2w+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbG9hawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAgICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0eXBpY2FsbHkgYSBmaW5lLWdyYWluZWQgYXBwbGljYXRpb24gaXMKICAgICAqIHByZWZlcmVkIGluIG9yZGVyIHRvIGJlbmVmaXQgZnJvbSBwcm9ncmVzc2l2ZSByZW5kZXJpbmcgb2YgdGhlIGJyb3dzZXIgdmlldy4KICAgICAqCiAgICAgKiBgbmdDbG9ha2Agd29ya3MgaW4gY29vcGVyYXRpb24gd2l0aCBhIGNzcyBydWxlIHRoYXQgaXMgZW1iZWRkZWQgd2l0aGluIGBhbmd1bGFyLmpzYCBhbmQKICAgICAqICBgYW5ndWxhci5taW4uanNgIGZpbGVzLiBGb2xsb3dpbmcgaXMgdGhlIGNzcyBydWxlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiBbbmdcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sIC5uZy1jbG9haywgLngtbmctY2xvYWsgewogKiAgIGRpc3BsYXk6IG5vbmU7CiAqIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICAgICAqIGFyZSB0YWdnZWQgd2l0aCB0aGUgYG5nLWNsb2FrYCBkaXJlY3RpdmUgYXJlIGhpZGRlbi4gV2hlbiBBbmd1bGFyIGNvbWVzIGFjcm9zcyB0aGlzIGRpcmVjdGl2ZQogICAgICogZHVyaW5nIHRoZSBjb21waWxhdGlvbiBvZiB0aGUgdGVtcGxhdGUgaXQgZGVsZXRlcyB0aGUgYG5nQ2xvYWtgIGVsZW1lbnQgYXR0cmlidXRlLCB3aGljaAogICAgICogbWFrZXMgdGhlIGNvbXBpbGVkIGVsZW1lbnQgdmlzaWJsZS4KICAgICAqCiAgICAgKiBGb3IgdGhlIGJlc3QgcmVzdWx0LCBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwgZmlsZTsKICAgICAqIGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSAoYWJvdmUpIG11c3QgYmUgaW5jbHVkZWQgaW4gdGhlIGV4dGVybmFsIHN0eWxlc2hlZXQgb2YgdGhlCiAgICAgKiBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBMZWdhY3kgYnJvd3NlcnMsIGxpa2UgSUU3LCBkbyBub3QgcHJvdmlkZSBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VwcG9ydCAoYWRkZWQgaW4gQ1NTIDIuMSkgc28gdGhleQogICAgICogY2Fubm90IG1hdGNoIHRoZSBgW25nXDpjbG9ha11gIHNlbGVjdG9yLiBUbyB3b3JrIGFyb3VuZCB0aGlzIGxpbWl0YXRpb24sIHlvdSBtdXN0IGFkZCB0aGUgY3NzCiAgICAgKiBjbGFzcyBgbmdDbG9ha2AgaW4gYWRkaXRpb24gdG8gYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcyBzaG93biBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICN0ZW1wbGF0ZTEnKS5hdHRyKCduZy1jbG9haycpKS4KICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3RlbXBsYXRlMicpLmF0dHIoJ25nLWNsb2FrJykpLgogICAgICAgICAgIG5vdCgpLnRvQmVEZWZpbmVkKCk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgdmFyIG5nQ2xvYWtEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCduZ0Nsb2FrJywgdW5kZWZpbmVkKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygnbmctY2xvYWsnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAgICogc3VwcG9ydHMgdGhlIHByaW5jaXBsZXMgYmVoaW5kIHRoZSBNb2RlbC1WaWV3LUNvbnRyb2xsZXIgZGVzaWduIHBhdHRlcm4uCiAgICAgKgogICAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgICAqCiAgICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgZGF0YSBpbiBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICAgKiAqIENvbnRyb2xsZXIg4oCUIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogICAgICogICBtZXRob2RzIHRoYXQgdHlwaWNhbGx5IGV4cHJlc3MgdGhlIGJ1c2luZXNzIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvbnRyb2xsZXIgTmFtZSBvZiBhIGdsb2JhbGx5IGFjY2Vzc2libGUgY29uc3RydWN0b3IgZnVuY3Rpb24gb3IgYW4KICAgICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAgICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBOb3RpY2UgdGhhdCB0aGUgc2NvcGUgYmVjb21lcyB0aGUgYHRoaXNgIGZvciB0aGUKICAgICAqIGNvbnRyb2xsZXIncyBpbnN0YW5jZS4gVGhpcyBhbGxvd3MgZm9yIGVhc3kgYWNjZXNzIHRvIHRoZSB2aWV3IGRhdGEgZnJvbSB0aGUgY29udHJvbGxlci4gQWxzbwogICAgICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICAgICAqIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAgICAgICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAgICAgICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICAgICAgICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwoKICAgICAkc2NvcGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICBhbGVydCh0aGlzLm5hbWUpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogICAgIH07CgogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfTsKCiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogICAgICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICAgICAgICAgIH07CiAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyIj4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICBDb250YWN0OgogICAgIDx1bD4KICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAgICAgPC9zZWxlY3Q+CiAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJjbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0icmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogICAgIDwvbGk+CiAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZy1jbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogICAgIDwvdWw+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBjb250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY+OmlucHV0JykudmFsKCkpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgyKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CgogICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBpbnB1dCcpLnZhbCgpKS50b0JlKCcnKTsKCiAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6bGFzdCBhOmNvbnRhaW5zKCJhZGQiKScpLmNsaWNrKCk7CiAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOm50aC1jaGlsZCgzKSBpbnB1dCcpLnZhbCgpKQogICAgIC50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUgPSBbZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgICBjb250cm9sbGVyOiAnQCcKICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDc3AKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGVsZW1lbnQgaHRtbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIFtDU1AgKENvbnRlbnQgU2VjdXJpdHkgUG9saWN5KV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKSBzdXBwb3J0LgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICAgKgogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICoKICAgICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBCeSBhcHBseWluZyBgbmdDc3BgCiAgICAgKiBpdCBpcyBiZSBwb3NzaWJsZSB0byBvcHQgaW50byB0aGUgQ1NQIGNvbXBhdGlibGUgbW9kZS4gV2hlbiB0aGlzIG1vZGUgaXMgb24gQW5ndWxhckpTIHdpbGwKICAgICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICAgKiBiZSByYWlzZWQuCiAgICAgKgogICAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgIDxwcmU+CiAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgPGh0bWwgbmctYXBwIG5nLWNzcD4KICAgICAuLi4KICAgICAuLi4KICAgICA8L2h0bWw+CiAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICRzbmlmZmVyLmNzcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nQ2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICAgKiBlbGVtZW50IGlzIGNsaWNrZWQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgICBJbmNyZW1lbnQKICAgICA8L2J1dHRvbj4KICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnY291bnQnKSkudG9CZSgnMCcpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzEnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIC8qCiAgICAgKiBBIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyBjcmVhdGlvbiBvZiBjdXN0b20gb25jbGljayBoYW5kbGVycyB0aGF0IGFyZSBkZWZpbmVkIGFzIGFuZ3VsYXIKICAgICAqIGV4cHJlc3Npb25zIGFuZCBhcmUgY29tcGlsZWQgYW5kIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS4KICAgICAqCiAgICAgKiBFdmVudHMgdGhhdCBhcmUgaGFuZGxlZCB2aWEgdGhlc2UgaGFuZGxlciBhcmUgYWx3YXlzIGNvbmZpZ3VyZWQgbm90IHRvIHByb3BhZ2F0ZSBmdXJ0aGVyLgogICAgICovCiAgICB2YXIgbmdFdmVudERpcmVjdGl2ZXMgPSB7fTsKICAgIGZvckVhY2goCiAgICAgICAgJ2NsaWNrIGRibGNsaWNrIG1vdXNlZG93biBtb3VzZXVwIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZW1vdmUgbW91c2VlbnRlciBtb3VzZWxlYXZlJy5zcGxpdCgnICcpLAogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgbmFtZSk7CiAgICAgICAgICAgIG5nRXZlbnREaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gWyckcGFyc2UnLCBmdW5jdGlvbiAoJHBhcnNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZChsb3dlcmNhc2UobmFtZSksIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6IGV2ZW50fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfV07CiAgICAgICAgfQogICAgKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0RibGNsaWNrCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nRGJsY2xpY2tgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGRibGNsaWNrIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0RibGNsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGRibGNsaWNrLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2Vkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWRvd24uIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZXVwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2V1cC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VvdmVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW92ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VvdmVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlb3Zlci4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlZW50ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZW50ZXIgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VlbnRlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZWVudGVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VsZWF2ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlbGVhdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW1vdmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbW92ZSBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW1vdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2Vtb3ZlLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3VibWl0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAgICAgKgogICAgICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICAgICAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgJHNjb3BlLnN1Ym1pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy50ZXh0KSB7CiAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICB0aGlzLnRleHQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idGV4dCIgbmFtZT0idGV4dCIgLz4KICAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiBpZD0ic3VibWl0IiB2YWx1ZT0iU3VibWl0IiAvPgogICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgIDwvZm9ybT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbXScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICAgIGV4cGVjdChpbnB1dCgndGV4dCcpLnZhbCgpKS50b0JlKCcnKTsKICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnW10nKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3N1Ym1pdCcpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICBleHBlY3QoYmluZGluZygnbGlzdCcpKS50b0JlKCdbImhlbGxvIl0nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1N1Ym1pdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICBlbGVtZW50LmJpbmQoJ3N1Ym1pdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGF0dHJzLm5nU3VibWl0KTsKICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZQogICAgICogQHJlc3RyaWN0IEVDQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRmV0Y2hlcywgY29tcGlsZXMgYW5kIGluY2x1ZGVzIGFuIGV4dGVybmFsIEhUTUwgZnJhZ21lbnQuCiAgICAgKgogICAgICogS2VlcCBpbiBtaW5kIHRoYXQgU2FtZSBPcmlnaW4gUG9saWN5IGFwcGxpZXMgdG8gaW5jbHVkZWQgcmVzb3VyY2VzCiAgICAgKiAoZS5nLiBuZ0luY2x1ZGUgd29uJ3Qgd29yayBmb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzIG9uIGFsbCBicm93c2VycyBhbmQgZm9yCiAgICAgKiAgZmlsZTovLyBhY2Nlc3Mgb24gc29tZSBicm93c2VycykuCiAgICAgKgogICAgICogQHNjb3BlCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nSW5jbHVkZXxzcmMgYW5ndWxhciBleHByZXNzaW9uIGV2YWx1YXRpbmcgdG8gVVJMLiBJZiB0aGUgc291cmNlIGlzIGEgc3RyaW5nIGNvbnN0YW50LAogICAgICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBuZXcgcGFydGlhbCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICAgICAqICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbH0gdG8gc2Nyb2xsIHRoZSB2aWV3cG9ydCBhZnRlciB0aGUgY29udGVudCBpcyBsb2FkZWQuCiAgICAgKgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gSWYgdGhlIGF0dHJpYnV0ZSBpcyBzZXQgd2l0aG91dCB2YWx1ZSwgZW5hYmxlIHNjcm9sbGluZy4KICAgICAqICAgICAgICAgICAgICAgICAgLSBPdGhlcndpc2UgZW5hYmxlIHNjcm9sbGluZyBvbmx5IGlmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnV0aHkgdmFsdWUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZT4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgICA8L3NlbGVjdD4KICAgICB1cmwgb2YgdGhlIHRlbXBsYXRlOiA8dHQ+e3t0ZW1wbGF0ZS51cmx9fTwvdHQ+CiAgICAgPGhyLz4KICAgICA8ZGl2IG5nLWluY2x1ZGUgc3JjPSJ0ZW1wbGF0ZS51cmwiPjwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICBbIHsgbmFtZTogJ3RlbXBsYXRlMS5odG1sJywgdXJsOiAndGVtcGxhdGUxLmh0bWwnfQogICAgICAgICAgLCB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICB9CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMS5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMi5odG1sIj4KICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUxLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMS5odG1sLyk7CiAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgc2VsZWN0KCd0ZW1wbGF0ZScpLm9wdGlvbignMScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkuCiAgICAgICAgIHRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWwvKTsKICAgICAgfSk7CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gYmxhbmsnLCBmdW5jdGlvbigpIHsKICAgICAgIHNlbGVjdCgndGVtcGxhdGUnKS5vcHRpb24oJycpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkudG9FcXVhbCgnJyk7CiAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50TG9hZGVkCiAgICAgKiBAZXZlbnRPZiBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlCiAgICAgKiBAZXZlbnRUeXBlIGVtaXQgb24gdGhlIGN1cnJlbnQgbmdJbmNsdWRlIHNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVsb2FkZWQuCiAgICAgKi8KICAgIHZhciBuZ0luY2x1ZGVEaXJlY3RpdmUgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRhbmNob3JTY3JvbGwnLCAnJGNvbXBpbGUnLAogICAgICAgIGZ1bmN0aW9uICgkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJywKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsZWFyQ29udGVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goc3JjRXhwLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldChzcmMsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTY29wZSkgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShjaGlsZFNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgKCFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkID09PSBjaGFuZ2VDb3VudGVyKSBjbGVhckNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgY2xlYXJDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJbml0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSW5pdGAgZGlyZWN0aXZlIHNwZWNpZmllcyBpbml0aWFsaXphdGlvbiB0YXNrcyB0byBiZSBleGVjdXRlZAogICAgICogIGJlZm9yZSB0aGUgdGVtcGxhdGUgZW50ZXJzIGV4ZWN1dGlvbiBtb2RlIGR1cmluZyBib290c3RyYXAuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSW5pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZ3JlZXRpbmc9J0hlbGxvJzsgcGVyc29uPSdXb3JsZCciPgogICAgIHt7Z3JlZXRpbmd9fSB7e3BlcnNvbn19IQogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgZ3JlZXRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2dyZWV0aW5nJykpLnRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZXJzb24nKSkudG9CZSgnV29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICAgICAqIGJ5IGFuZ3VsYXIuIFVzZSBgbmdOb25CaW5kYWJsZWAgdG8gbWFrZSBhbmd1bGFyIGlnbm9yZSBhIGNodW5rIG9mIEhUTUwuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICAgICAqIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgIDxkaXYgbmctbm9uLWJpbmRhYmxlPklnbm9yZWQ6IHt7MSArIDJ9fTwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctbm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCcxICsgMicpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCdkaXY6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgdG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsgdGVybWluYWw6IHRydWUsIHByaW9yaXR5OiAxMDAwIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nUGx1cmFsaXplCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICMgT3ZlcnZpZXcKICAgICAqIGBuZ1BsdXJhbGl6ZWAgaXMgYSBkaXJlY3RpdmUgdGhhdCBkaXNwbGF5cyBtZXNzYWdlcyBhY2NvcmRpbmcgdG8gZW4tVVMgbG9jYWxpemF0aW9uIHJ1bGVzLgogICAgICogVGhlc2UgcnVsZXMgYXJlIGJ1bmRsZWQgd2l0aCBhbmd1bGFyLmpzIGFuZCB0aGUgcnVsZXMgY2FuIGJlIG92ZXJyaWRkZW4KICAgICAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogICAgICogYnkgc3BlY2lmeWluZyB0aGUgbWFwcGluZ3MgYmV0d2VlbgogICAgICoge0BsaW5rIGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbAogICAgICogcGx1cmFsIGNhdGVnb3JpZXN9IGFuZCB0aGUgc3RyaW5ncyB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKgogICAgICogIyBQbHVyYWwgY2F0ZWdvcmllcyBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzCiAgICAgKiBUaGVyZSBhcmUgdHdvCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllc30gaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgICAqCiAgICAgKiBXaGlsZSBhIHB1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBZb3Ugd2lsbCBzZWUgdGhlIHVzZSBvZiBwbHVyYWwgY2F0ZWdvcmllcwogICAgICogYW5kIGV4cGxpY2l0IG51bWJlciBydWxlcyB0aHJvdWdob3V0IGxhdGVyIHBhcnRzIG9mIHRoaXMgZG9jdW1lbnRhdGlvbi4KICAgICAqCiAgICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplCiAgICAgKiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGJ5IHByb3ZpZGluZyAyIGF0dHJpYnV0ZXM6IGBjb3VudGAgYW5kIGB3aGVuYC4KICAgICAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGF0dHJpYnV0ZSwgYG9mZnNldGAuCiAgICAgKgogICAgICogVGhlIHZhbHVlIG9mIHRoZSBgY291bnRgIGF0dHJpYnV0ZSBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIHtAbGluayBndWlkZS9leHByZXNzaW9uCiAgICAgKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICAgKgogICAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdCBzbyB0aGF0IEFuZ3VsYXIKICAgICAqIGNhbiBpbnRlcnByZXQgaXQgY29ycmVjdGx5LgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY29uZmlndXJlIG5nUGx1cmFsaXplOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICogPC9uZy1wbHVyYWxpemU+CiAgICAgKjwvcHJlPgogICAgICoKICAgICAqIEluIHRoZSBleGFtcGxlLCBgIjA6IE5vYm9keSBpcyB2aWV3aW5nLiJgIGlzIGFuIGV4cGxpY2l0IG51bWJlciBydWxlLiBJZiB5b3UgZGlkIG5vdAogICAgICogc3BlY2lmeSB0aGlzIHJ1bGUsIDAgd291bGQgYmUgbWF0Y2hlZCB0byB0aGUgIm90aGVyIiBjYXRlZ29yeSBhbmQgIjAgcGVvcGxlIGFyZSB2aWV3aW5nIgogICAgICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAgICAgKiBvdGhlciBudW1iZXJzLCBmb3IgZXhhbXBsZSAxMiwgc28gdGhhdCBpbnN0ZWFkIG9mIHNob3dpbmcgIjEyIHBlb3BsZSBhcmUgdmlld2luZyIsIHlvdSBjYW4KICAgICAqIHNob3cgImEgZG96ZW4gcGVvcGxlIGFyZSB2aWV3aW5nIi4KICAgICAqCiAgICAgKiBZb3UgY2FuIHVzZSBhIHNldCBvZiBjbG9zZWQgYnJhY2VzKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogICAgICogaW50byBwbHVyYWxpemVkIHN0cmluZ3MuIEluIHRoZSBwcmV2aW91cyBleGFtcGxlLCBBbmd1bGFyIHdpbGwgcmVwbGFjZSBge31gIHdpdGgKICAgICAqIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT5ge3twZXJzb25Db3VudH19YDwvc3Bhbj4uIFRoZSBjbG9zZWQgYnJhY2VzIGB7fWAgaXMgYSBwbGFjZWhvbGRlcgogICAgICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZSB3aXRoIG9mZnNldAogICAgICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogICAgICogYSBiZXR0ZXIgdXNlciBleHBlcmllbmNlLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiB0aGUgbWVzc2FnZSAiNCBwZW9wbGUgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIsCiAgICAgKiB5b3UgbWlnaHQgZGlzcGxheSAiSm9obiwgS2F0ZSBhbmQgMiBvdGhlcnMgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIuCiAgICAgKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICAgICAqIExldCdzIHRha2UgYSBsb29rIGF0IGFuIGV4YW1wbGU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAgICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICAgKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAgICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAgICogaXMgc2hvd24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICAgKiBudW1iZXJzIGZyb20gMCB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBvZmZzZXQuIElmIHlvdSB1c2UgYW4gb2Zmc2V0IG9mIDMsIGZvciBleGFtcGxlLAogICAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZGVkIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvZGluZyBzdHJpbmdzLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAkc2NvcGUucGVyc29uQ291bnQgPSAxOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgUGVyc29uIDE6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24xIiB2YWx1ZT0iSWdvciIgLz48YnIvPgogICAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgICAgTnVtYmVyIG9mIFBlb3BsZTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbkNvdW50IiB2YWx1ZT0iMSIgLz48YnIvPgoKICAgICA8IS0tLSBFeGFtcGxlIHdpdGggc2ltcGxlIHBsdXJhbGl6YXRpb24gcnVsZXMgZm9yIGVuIGxvY2FsZSAtLS0+CiAgICAgV2l0aG91dCBPZmZzZXQ6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPjxicj4KCiAgICAgPCEtLS0gRXhhbXBsZSB3aXRoIG9mZnNldCAtLS0+CiAgICAgV2l0aCBPZmZzZXQoMik6CiAgICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6ICd7e3BlcnNvbjF9fSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCB7fSBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgIDwvbmctcGx1cmFsaXplPgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgc2hvdyBjb3JyZWN0IHBsdXJhbGl6ZWQgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJ0lnb3IgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uQ291bnQnKS5lbnRlcignMCcpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzMnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIHNob3cgZGF0YS1iaW5kZWQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgIHRvQmUoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uMScpLmVudGVyKCdEaScpOwogICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjInKS5lbnRlcignVm9qdGEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgdG9CZSgnRGksIFZvanRhIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBCUkFDRSA9IC97fS9nOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJFeHAgPSBhdHRyLmNvdW50LAogICAgICAgICAgICAgICAgICAgIHdoZW5FeHAgPSBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci53aGVuKSwgLy8gdGhpcyBpcyBiZWNhdXNlIHdlIGhhdmUge3t9fSBpbiBhdHRycwogICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGF0dHIub2Zmc2V0IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgd2hlbnMgPSBzY29wZS4kZXZhbCh3aGVuRXhwKSwKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZucyA9IHt9LAogICAgICAgICAgICAgICAgICAgIHN0YXJ0U3ltYm9sID0gJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sKCksCiAgICAgICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpOwoKICAgICAgICAgICAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgICAgICAgICAgICAgJGludGVycG9sYXRlKGV4cHJlc3Npb24ucmVwbGFjZShCUkFDRSwgc3RhcnRTeW1ib2wgKyBudW1iZXJFeHAgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICAgICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAgICoKICAgICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAgICoKICAgICAqICAgKiBgJGluZGV4YCDigJMgYHtudW1iZXJ9YCDigJMgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkKICAgICAqICAgKiBgJGZpcnN0YCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbWlkZGxlYCDigJMgYHtib29sZWFufWAg4oCTIHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICogICAqIGAkbGFzdGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGxhc3QgaW4gdGhlIGl0ZXJhdG9yLgogICAgICoKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFR3bwogICAgICogICBmb3JtYXRzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOgogICAgICoKICAgICAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAgICAgKiAgICAgaXMgYSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAgICAgKgogICAgICogICAgIEZvciBleGFtcGxlOiBgdHJhY2sgaW4gY2QudHJhY2tzYC4KICAgICAqCiAgICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICAgKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBpbml0aWFsaXplcyB0aGUgc2NvcGUgdG8gYSBsaXN0IG9mIG5hbWVzIGFuZAogICAgICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIGFnZToyNX0sIHtuYW1lOidNYXJ5JywgYWdlOjI4fV0iPgogICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXJlcGVhdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIHZhciByID0gdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykucmVwZWF0ZXIoJ3VsIGxpJyk7CiAgICAgICAgICAgZXhwZWN0KHIuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgICBleHBlY3Qoci5yb3coMCkpLnRvRXF1YWwoWyIxIiwiSm9obiIsIjI1Il0pOwogICAgICAgICAgIGV4cGVjdChyLnJvdygxKSkudG9FcXVhbChbIjIiLCJNYXJ5IiwiMjgiXSk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBpdGVyU3RhcnRFbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IGF0dHIubmdSZXBlYXQ7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKC9eXHMqKC4rKVxzK2luXHMrKC4qKVxzKiQvKSwKICAgICAgICAgICAgICAgICAgICBsaHMsIHJocywgdmFsdWVJZGVudCwga2V5SWRlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIG5nUmVwZWF0IGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uICsgIicuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaHMgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgbWF0Y2ggPSBsaHMubWF0Y2goL14oPzooW1wkXHddKyl8XCgoW1wkXHddKylccyosXHMqKFtcJFx3XSspXCkpJC8pOwogICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCInaXRlbScgaW4gJ2l0ZW0gaW4gY29sbGVjdGlvbicgc2hvdWxkIGJlIGlkZW50aWZpZXIgb3IgKGtleSwgdmFsdWUpIGJ1dCBnb3QgJyIgKwogICAgICAgICAgICAgICAgICAgICAgICBsaHMgKyAiJy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlSWRlbnQgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIGtleUlkZW50ID0gbWF0Y2hbMl07CgogICAgICAgICAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAgICAgICAgIC8vIGl0ZXJhdG9yLCBhbmQgdGhlIHZhbHVlIGlzIGFuIGFycmF5IG9mIG9iamVjdHMgd2l0aCBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgICAgICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAgICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgICAgICAgICAgLy8gICAtIGluZGV4OiBwb3NpdGlvbgogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCBhbiBhcnJheSBvZiB0aGVzZSBvYmplY3RzIHNpbmNlIHRoZSBzYW1lIG9iamVjdCBjYW4gYmUgcmV0dXJuZWQgZnJvbSB0aGUgaXRlcmF0b3IuCiAgICAgICAgICAgICAgICAvLyBXZSBleHBlY3QgdGhpcyB0byBiZSBhIHJhcmUgY2FzZS4KICAgICAgICAgICAgICAgIHZhciBsYXN0T3JkZXIgPSBuZXcgSGFzaFF1ZXVlTWFwKCk7CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nUmVwZWF0V2F0Y2goc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXgsIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHNjb3BlLiRldmFsKHJocyksCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGl0ZXJTdGFydEVsZW1lbnQsICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgICAgICAgLy8gU2FtZSBhcyBsYXN0T3JkZXIgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdE9yZGVyIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyID0gbmV3IEhhc2hRdWV1ZU1hcCgpLAogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUJvdW5kLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBrZXksIHZhbHVlLCAvLyBrZXkvdmFsdWUgb2YgaXRlcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICAgICAgICAgICAgICBsYXN0OyAgICAgICAvLyBsYXN0IG9iamVjdCBpbmZvcm1hdGlvbiB7c2NvcGUsIGVsZW1lbnQsIGluZGV4fQoKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG9iamVjdCwgZXh0cmFjdCBrZXlzLCBzb3J0IHRoZW0gYW5kIHVzZSB0byBkZXRlcm1pbmUgb3JkZXIgb2YgaXRlcmF0aW9uIG92ZXIgb2JqIHByb3BzCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkuc29ydCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gY29sbGVjdGlvbiB8fCBbXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGFycmF5Qm91bmQgPSBhcnJheS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgbm90IHVzaW5nIGZvckVhY2ggZm9yIHBlcmYgcmVhc29ucyAodHJ5aW5nIHRvIGF2b2lkICNjYWxsKQogICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IChjb2xsZWN0aW9uID09PSBhcnJheSkgPyBpbmRleCA6IGFycmF5W2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gbGFzdE9yZGVyLnNoaWZ0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzb2NpYXRlZCBzY29wZS9lbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbGFzdC5zY29wZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRPcmRlci5wdXNoKHZhbHVlLCBsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IGxhc3QuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleGlzdGluZyBpdGVtIHdoaWNoIGdvdCBtb3ZlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1heSBiZSBhIG5vb3AsIGlmIHRoZSBlbGVtZW50IGlzIG5leHQsIGJ1dCBJIGRvbid0IGtub3cgb2YgYSBnb29kIHdheSB0bwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpZ3VyZSB0aGlzIG91dCwgIHNpbmNlIGl0IHdvdWxkIHJlcXVpcmUgZXh0cmEgRE9NIGFjY2Vzcywgc28gbGV0J3MganVzdCBob3BlIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgYnJvd3NlcnMgcmVhbGl6ZXMgdGhhdCBpdCBpcyBub29wLCBhbmQgdHJlYXRzIGl0IGFzIHN1Y2guCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmFmdGVyKGxhc3QuZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gbGFzdC5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmV3IGl0ZW0gd2hpY2ggd2UgZG9uJ3Qga25vdyBhYm91dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnQpIGNoaWxkU2NvcGVba2V5SWRlbnRdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRpbmRleCA9IGluZGV4OwoKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSBhcnJheUJvdW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kbWlkZGxlID0gIShjaGlsZFNjb3BlLiRmaXJzdCB8fCBjaGlsZFNjb3BlLiRsYXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua2VyKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGNoaWxkU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IChjdXJzb3IgPSBjbG9uZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVyLnB1c2godmFsdWUsIGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vc2hyaW5rIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbGFzdE9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0T3JkZXIuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBsYXN0T3JkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChhcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFycmF5LnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGFzdE9yZGVyID0gbmV4dE9yZGVyOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTaG93CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGRpcmVjdGl2ZXMgc2hvdyBvciBoaWRlIGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Nob3cgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeQogICAgICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPiA8YnIvPgogICAgIEhpZGU6IDxzcGFuIG5nLWhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpmaXJzdDpoaWRkZW4nKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwoKICAgICAgICAgaW5wdXQoJ2NoZWNrZWQnKS5jaGVjaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KLy9UT0RPKG1pc2tvKTogcmVmYWN0b3IgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSB0aGUgRE9NCiAgICB2YXIgbmdTaG93RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTaG93LCBmdW5jdGlvbiBuZ1Nob3dXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICBlbGVtZW50LmNzcygnZGlzcGxheScsIHRvQm9vbGVhbih2YWx1ZSkgPyAnJyA6ICdub25lJyk7CiAgICAgICAgfSk7CiAgICB9KTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIaWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSGlkZWAgYW5kIGBuZ1Nob3dgIGRpcmVjdGl2ZXMgaGlkZSBvciBzaG93IGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgKEhUTUwpCiAgICAgKiBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICAgKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICBTaG93OiA8c3BhbiBuZy1zaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+IDxici8+CiAgICAgSGlkZTogPHNwYW4gbmctaGlkZT0iY2hlY2tlZCI+SSBoaWRlIHdoZW4geW91IGNoZWNrYm94IGlzIGNoZWNrZWQ/PC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCi8vVE9ETyhtaXNrbyk6IHJlZmFjdG9yIHRvIHJlbW92ZSBlbGVtZW50IGZyb20gdGhlIERPTQogICAgdmFyIG5nSGlkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odmFsdWUpID8gJ25vbmUnIDogJycpOwogICAgICAgIH0pOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTdHlsZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAgICAgKiAgICAgIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogICAgICogICAgICBrZXlzLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGU+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlTdHlsZT17fSI+CiAgICAgPGJyLz4KICAgICA8c3BhbiBuZy1zdHlsZT0ibXlTdHlsZSI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgPHByZT5teVN0eWxlPXt7bXlTdHlsZX19PC9wcmU+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigwLCAwLCAwKScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPXNldF0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDI1NSwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1jbGVhcl0nKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdTdHlsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU3R5bGUsIGZ1bmN0aW9uIG5nU3R5bGVXYXRjaEFjdGlvbihuZXdTdHlsZXMsIG9sZFN0eWxlcykgewogICAgICAgICAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gob2xkU3R5bGVzLCBmdW5jdGlvbiAodmFsLCBzdHlsZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY3NzKHN0eWxlLCAnJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3U3R5bGVzKSBlbGVtZW50LmNzcyhuZXdTdHlsZXMpOwogICAgICAgIH0sIHRydWUpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29uZGl0aW9uYWxseSBjaGFuZ2UgdGhlIERPTSBzdHJ1Y3R1cmUuCiAgICAgKgogICAgICogQHVzYWdlCiAgICAgKiA8QU5ZIG5nLXN3aXRjaD0iZXhwcmVzc2lvbiI+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTIiPi4uLjwvQU5ZPgogICAgICogICAuLi4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgICAqIDwvQU5ZPgogICAgICoKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAgICAgKiBAcGFyYW1EZXNjcmlwdGlvbgogICAgICogT24gY2hpbGQgZWxtZW50cyBhZGQ6CiAgICAgKgogICAgICogKiBgbmdTd2l0Y2hXaGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogICAgICogICBjYXNlIHdpbGwgYmUgZGlzcGxheWVkLgogICAgICogKiBgbmdTd2l0Y2hEZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc3NlcyBtYXRjaC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPHNlbGVjdCBuZy1tb2RlbD0ic2VsZWN0aW9uIiBuZy1vcHRpb25zPSJpdGVtIGZvciBpdGVtIGluIGl0ZW1zIj4KICAgICA8L3NlbGVjdD4KICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgIDxoci8+CiAgICAgPGRpdiBuZy1zd2l0Y2ggb249InNlbGVjdGlvbiIgPgogICAgIDxkaXYgbmctc3dpdGNoLXdoZW49InNldHRpbmdzIj5TZXR0aW5ncyBEaXY8L2Rpdj4KICAgICA8c3BhbiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9zcGFuPgogICAgIDxzcGFuIG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L3NwYW4+CiAgICAgPC9kaXY+CiAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgW25nLXN3aXRjaF0nKS50ZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICAgIH0pOwogICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ2hvbWUnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgICB9KTsKICAgICBpdCgnc2hvdWxkIHNlbGVjdCBkZWFmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIE5HX1NXSVRDSCA9ICduZy1zd2l0Y2gnOwogICAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgICAgcmVxdWlyZTogJ25nU3dpdGNoJywKICAgICAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsIGZ1bmN0aW9uIG5nU3dpdGNoQ29udHJvbGxlcigpIHsKICAgICAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICAgIH1dLAogICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICB2YXIgd2F0Y2hFeHByID0gYXR0ci5uZ1N3aXRjaCB8fCBhdHRyLm9uLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LAogICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZTsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaEV4cHIsIGZ1bmN0aW9uIG5nU3dpdGNoV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudCA9IHNlbGVjdGVkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGUgPSBjdHJsLmNhc2VzWychJyArIHZhbHVlXSB8fCBjdHJsLmNhc2VzWyc/J10pKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uIChjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnQgPSBjYXNlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoY2FzZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBwcmlvcml0eTogNTAwLAogICAgICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRycywgdHJhbnNjbHVkZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gPSB0cmFuc2NsdWRlOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgIHByaW9yaXR5OiA1MDAsCiAgICAgICAgcmVxdWlyZTogJ15uZ1N3aXRjaCcsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGN0cmwuY2FzZXNbJz8nXSA9IHRyYW5zY2x1ZGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnNlcnQgdGhlIHRyYW5zY2x1ZGVkIERPTSBoZXJlLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlIG1vZHVsZT0idHJhbnNjbHVkZSI+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnTmVxdWUgcG9ycm8gcXVpc3F1YW0gZXN0IHF1aSBkb2xvcmVtIGlwc3VtIHF1aWEgZG9sb3IuLi4nOwogICAgICAgICB9CgogICAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlJywgW10pCiAgICAgLmRpcmVjdGl2ZSgncGFuZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgICAgICBzY29wZTogJ2lzb2xhdGUnLAogICAgICAgICAgICAgICBsb2NhbHM6IHsgdGl0bGU6J2JpbmQnIH0sCiAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGdyYXkiPnt7dGl0bGV9fTwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgIH07CiAgICAgICAgIH0pOwogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICA8cGFuZSB0aXRsZT0ie3t0aXRsZX19Ij57e3RleHR9fTwvcGFuZT4KICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICBpdCgnc2hvdWxkIGhhdmUgdHJhbnNjbHVkZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd0aXRsZScpLmVudGVyKCdUSVRMRScpOwogICAgICAgICAgaW5wdXQoJ3RleHQnKS5lbnRlcignVEVYVCcpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RpdGxlJykpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIHZhciBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29udHJvbGxlcjogWyckdHJhbnNjbHVkZScsICckZWxlbWVudCcsIGZ1bmN0aW9uICgkdHJhbnNjbHVkZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgJHRyYW5zY2x1ZGUoZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9XQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3CiAgICAgKiBAcmVzdHJpY3QgRUNBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAjIE92ZXJ2aWV3CiAgICAgKiBgbmdWaWV3YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGNvbXBsZW1lbnRzIHRoZSB7QGxpbmsgbmcuJHJvdXRlICRyb3V0ZX0gc2VydmljZSBieQogICAgICogaW5jbHVkaW5nIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvZiB0aGUgY3VycmVudCByb3V0ZSBpbnRvIHRoZSBtYWluIGxheW91dCAoYGluZGV4Lmh0bWxgKSBmaWxlLgogICAgICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogICAgICogY29uZmlndXJhdGlvbiBvZiB0aGUgYCRyb3V0ZWAgc2VydmljZS4KICAgICAqCiAgICAgKiBAc2NvcGUKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1ZpZXciPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkNudGwiPgogICAgIENob29zZToKICAgICA8YSBocmVmPSJCb29rL01vYnkiPk1vYnk8L2E+IHwKICAgICA8YSBocmVmPSJCb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgPGEgaHJlZj0iQm9vay9HYXRzYnkiPkdhdHNieTwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svR2F0c2J5L2NoLzQ/a2V5PXZhbHVlIj5HYXRzYnk6IENoNDwvYT4gfAogICAgIDxhIGhyZWY9IkJvb2svU2NhcmxldCI+U2NhcmxldCBMZXR0ZXI8L2E+PGJyLz4KCiAgICAgPGRpdiBuZy12aWV3PjwvZGl2PgogICAgIDxociAvPgoKICAgICA8cHJlPiRsb2NhdGlvbi5wYXRoKCkgPSB7eyRsb2NhdGlvbi5wYXRoKCl9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlLmN1cnJlbnQudGVtcGxhdGVVcmwgPSB7eyRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlVXJsfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnBhcmFtcyA9IHt7JHJvdXRlLmN1cnJlbnQucGFyYW1zfX08L3ByZT4KICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgIDxwcmU+JHJvdXRlUGFyYW1zID0ge3skcm91dGVQYXJhbXN9fTwvcHJlPgogICAgIDwvZGl2PgogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0iYm9vay5odG1sIj4KICAgICBjb250cm9sbGVyOiB7e25hbWV9fTxiciAvPgogICAgIEJvb2sgSWQ6IHt7cGFyYW1zLmJvb2tJZH19PGJyIC8+CiAgICAgPC9maWxlPgoKICAgICA8ZmlsZSBuYW1lPSJjaGFwdGVyLmh0bWwiPgogICAgIGNvbnRyb2xsZXI6IHt7bmFtZX19PGJyIC8+CiAgICAgQm9vayBJZDoge3twYXJhbXMuYm9va0lkfX08YnIgLz4KICAgICBDaGFwdGVyIElkOiB7e3BhcmFtcy5jaGFwdGVySWR9fQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICBhbmd1bGFyLm1vZHVsZSgnbmdWaWV3JywgW10sIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgewogICAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbignL0Jvb2svOmJvb2tJZCcsIHsKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdib29rLmh0bWwnLAogICAgICAgICAgICBjb250cm9sbGVyOiBCb29rQ250bAogICAgICAgICAgfSk7CiAgICAgICAgICAkcm91dGVQcm92aWRlci53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7CiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnY2hhcHRlci5odG1sJywKICAgICAgICAgICAgY29udHJvbGxlcjogQ2hhcHRlckNudGwKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvbmZpZ3VyZSBodG1sNSB0byBnZXQgbGlua3Mgd29ya2luZyBvbiBqc2ZpZGRsZQogICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpOwogICAgICAgIH0pOwoKICAgICBmdW5jdGlvbiBNYWluQ250bCgkc2NvcGUsICRyb3V0ZSwgJHJvdXRlUGFyYW1zLCAkbG9jYXRpb24pIHsKICAgICAgICAgICRzY29wZS4kcm91dGUgPSAkcm91dGU7CiAgICAgICAgICAkc2NvcGUuJGxvY2F0aW9uID0gJGxvY2F0aW9uOwogICAgICAgICAgJHNjb3BlLiRyb3V0ZVBhcmFtcyA9ICRyb3V0ZVBhcmFtczsKICAgICAgICB9CgogICAgIGZ1bmN0aW9uIEJvb2tDbnRsKCRzY29wZSwgJHJvdXRlUGFyYW1zKSB7CiAgICAgICAgICAkc2NvcGUubmFtZSA9ICJCb29rQ250bCI7CiAgICAgICAgICAkc2NvcGUucGFyYW1zID0gJHJvdXRlUGFyYW1zOwogICAgICAgIH0KCiAgICAgZnVuY3Rpb24gQ2hhcHRlckNudGwoJHNjb3BlLCAkcm91dGVQYXJhbXMpIHsKICAgICAgICAgICRzY29wZS5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgICRzY29wZS5wYXJhbXMgPSAkcm91dGVQYXJhbXM7CiAgICAgICAgfQogICAgIDwvZmlsZT4KCiAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgIGl0KCdzaG91bGQgbG9hZCBhbmQgY29tcGlsZSBjb3JyZWN0IHRlbXBsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCdhOmNvbnRhaW5zKCJNb2J5OiBDaDEiKScpLmNsaWNrKCk7CiAgICAgICAgICB2YXIgY29udGVudCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy12aWV3XScpLnRleHQoKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9jb250cm9sbGVyXDogQ2hhcHRlckNudGwvKTsKICAgICAgICAgIGV4cGVjdChjb250ZW50KS50b01hdGNoKC9Cb29rIElkXDogTW9ieS8pOwogICAgICAgICAgZXhwZWN0KGNvbnRlbnQpLnRvTWF0Y2goL0NoYXB0ZXIgSWRcOiAxLyk7CgogICAgICAgICAgZWxlbWVudCgnYTpjb250YWlucygiU2NhcmxldCIpJykuY2xpY2soKTsKICAgICAgICAgIGNvbnRlbnQgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctdmlld10nKS50ZXh0KCk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvY29udHJvbGxlclw6IEJvb2tDbnRsLyk7CiAgICAgICAgICBleHBlY3QoY29udGVudCkudG9NYXRjaCgvQm9vayBJZFw6IFNjYXJsZXQvKTsKICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdWaWV3IyR2aWV3Q29udGVudExvYWRlZAogICAgICogQGV2ZW50T2YgbmcuZGlyZWN0aXZlOm5nVmlldwogICAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nVmlldyBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nVmlldyBjb250ZW50IGlzIHJlbG9hZGVkLgogICAgICovCiAgICB2YXIgbmdWaWV3RGlyZWN0aXZlID0gWyckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcm91dGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsCiAgICAgICAgJyRjb250cm9sbGVyJywKICAgICAgICBmdW5jdGlvbiAoJGh0dHAsICR0ZW1wbGF0ZUNhY2hlLCAkcm91dGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlLCAkY29udHJvbGxlcikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJzsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJG9uKCckcm91dGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUoKTsKCgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lMYXN0U2NvcGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0U2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJDb250ZW50KCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95TGFzdFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSAkcm91dGUuY3VycmVudCAmJiAkcm91dGUuY3VycmVudC5sb2NhbHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGxvY2FscyAmJiBsb2NhbHMuJHRlbXBsYXRlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdHJveUxhc3RTY29wZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gJHJvdXRlLmN1cnJlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUgPSBjdXJyZW50LnNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGUgPSBsYXN0U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGN1cnJlbnQuY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rKGxhc3RTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2NvcGUuJGVtaXQoJyR2aWV3Q29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gJGFuY2hvclNjcm9sbCBtaWdodCBsaXN0ZW4gb24gZXZlbnQuLi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNjcmlwdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTG9hZCBjb250ZW50IG9mIGEgc2NyaXB0IHRhZywgd2l0aCB0eXBlIGB0ZXh0L25nLXRlbXBsYXRlYCwgaW50byBgJHRlbXBsYXRlQ2FjaGVgLCBzbyB0aGF0IHRoZQogICAgICogdGVtcGxhdGUgY2FuIGJlIHVzZWQgYnkgYG5nSW5jbHVkZWAsIGBuZ1ZpZXdgIG9yIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMuCiAgICAgKgogICAgICogQHJlc3RyaWN0IEUKICAgICAqIEBwYXJhbSB7J3RleHQvbmctdGVtcGxhdGUnfSB0eXBlIG11c3QgYmUgc2V0IHRvIGAndGV4dC9uZy10ZW1wbGF0ZSdgCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0iL3RwbC5odG1sIj4KICAgICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgICA8L3NjcmlwdD4KCiAgICAgPGEgbmctY2xpY2s9ImN1cnJlbnRUcGw9Jy90cGwuaHRtbCciIGlkPSJ0cGwtbGluayI+TG9hZCBpbmxpbmVkIHRlbXBsYXRlPC9hPgogICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KCcjdHBsLWxpbmsnKS5jbGljaygpOwogICAgICAgIGV4cGVjdChlbGVtZW50KCcjdHBsLWNvbnRlbnQnKS50ZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24gKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgLy8gSUUgaXMgbm90IGNvbnNpc3RlbnQsIGluIHNjcmlwdHMgd2UgaGF2ZSB0byByZWFkIC50ZXh0IGJ1dCBpbiBvdGhlciBub2RlcyB3ZSBoYXZlIHRvIHJlYWQgLnRleHRDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50WzBdLnRleHQ7CgogICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6c2VsZWN0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBgU0VMRUNUYCBlbGVtZW50IHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuCiAgICAgKgogICAgICogIyBgbmdPcHRpb25zYAogICAgICoKICAgICAqIE9wdGlvbmFsbHkgYG5nT3B0aW9uc2AgYXR0cmlidXRlIGNhbiBiZSB1c2VkIHRvIGR5bmFtaWNhbGx5IGdlbmVyYXRlIGEgbGlzdCBvZiBgPG9wdGlvbj5gCiAgICAgKiBlbGVtZW50cyBmb3IgYSBgPHNlbGVjdD5gIGVsZW1lbnQgdXNpbmcgYW4gYXJyYXkgb3IgYW4gb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICAgKiBgbmdPcHRpb25zYCBleHByZXNzaW9uLgogICAgICrLncudCiAgICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIHNlbGVjdCBtZW51IGlzIHNlbGVjdCwgdGhlIHZhbHVlIG9mIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICAgKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogICAgICogZGlyZWN0aXZlIG9mIHRoZSBwYXJlbnQgc2VsZWN0IGVsZW1lbnQuCiAgICAgKgogICAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAgICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAgICoKICAgICAqIE5vdGU6IGBuZ09wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogICAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBjdXJyZW50bHkKICAgICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgb25seS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICAgICAqCiAgICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICAgKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqCiAgICAgKiBXaGVyZToKICAgICAqCiAgICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAgICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAgICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICAgKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogICAgICogICAgICBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIE15Q250cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgJHNjb3BlLmNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgICAgPHVsPgogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbG9yIGluIGNvbG9ycyI+CiAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnNwbGljZSgkaW5kZXgsIDEpIj5YPC9hPl0KICAgICA8L2xpPgogICAgIDxsaT4KICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgIDwvbGk+CiAgICAgPC91bD4KICAgICA8aHIvPgogICAgIENvbG9yIChudWxsIG5vdCBhbGxvd2VkKToKICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+PC9zZWxlY3Q+PGJyPgoKICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb2xvciIgbmctb3B0aW9ucz0iYy5uYW1lIGZvciBjIGluIGNvbG9ycyI+CiAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgIDwvc2VsZWN0PgogICAgIDwvc3Bhbj48YnIvPgoKICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZ3JvdXAgYnkgYy5zaGFkZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICBTZWxlY3QgPGEgaHJlZiBuZy1jbGljaz0iY29sb3I9e25hbWU6J25vdCBpbiBsaXN0J30iPmJvZ3VzPC9hPi48YnI+CiAgICAgPGhyLz4KICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpjb2xvcn0gIH19CiAgICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgICAgbmctc3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6Y29sb3IubmFtZX0iPgogICAgIDwvZGl2PgogICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIHNlbGVjdCgnY29sb3InKS5vcHRpb24oJzAnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygne3NlbGVjdGVkX2NvbG9yOmNvbG9yfScpKS50b01hdGNoKCdudWxsJyk7CiAgICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCiAgICB2YXIgbmdPcHRpb25zRGlyZWN0aXZlID0gdmFsdWVGbih7IHRlcm1pbmFsOiB0cnVlIH0pOwogICAgdmFyIHNlbGVjdERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCAnJHBhcnNlJywgZnVuY3Rpb24gKCRjb21waWxlLCAkcGFyc2UpIHsKICAgICAgICAvLzAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQ0NDAwMDAwMDAwMDU1NTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3NzAKICAgICAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKiguKj8pKD86XHMrYXNccysoLio/KSk/KD86XHMrZ3JvdXBccytieVxzKyguKikpP1xzK2ZvclxzKyg/OihbXCRcd11bXCRcd1xkXSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XGRdKilccyosXHMqKFtcJFx3XVtcJFx3XGRdKilccypcKSkpXHMraW5ccysoLiopJC8sCiAgICAgICAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uICgkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICAgICAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgICAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgICAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAgICAgICAgIC8vIHRvIGNyZWF0ZSBpdCBpbiA8c2VsZWN0PiBhbmQgSUUgYmFyZnMgb3RoZXJ3aXNlLgogICAgICAgICAgICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgICAgICAgICAgICBvcHRHcm91cFRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAgICAgICAgIC8vIGZpbmQgIm51bGwiIG9wdGlvbgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpLCBpaSA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW1wdHlPcHRpb24gPSBudWxsT3B0aW9uID0gY2hpbGRyZW4uZXEoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlICYmIChhdHRyLnJlcXVpcmVkIHx8IGF0dHIubmdSZXF1aXJlZCkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZWRWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsICFhdHRyLnJlcXVpcmVkIHx8ICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRwYXJzZXJzLnB1c2gocmVxdWlyZWRWYWxpZGF0b3IpOwogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRmb3JtYXR0ZXJzLnVuc2hpZnQocmVxdWlyZWRWYWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRWYWxpZGF0b3IobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNFeHApIE9wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlKSBNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBTaW5nbGUoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKTsKCgogICAgICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFZpZXc7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHNlbGVjdE11bHRpcGxlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKGxhc3RWaWV3LCBjdHJsLiR2aWV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmlldyA9IGNvcHkoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYmluZCgnY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2gob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE9wdGlvbnMoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgICAgICAgICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIG5nT3B0aW9ucyBpbiBmb3JtIG9mICdfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCBnb3QgJyIgKyBvcHRpb25zRXhwICsgIicuIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgICAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6ICcnfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuaHRtbCgnJykgYmVjYXVzZSBvdGhlcndpc2UgSUUgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGxhYmVsIGZyb20gdGhlIGVsZW1lbnQuIHd0Zj8KICAgICAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lmh0bWwoJycpOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gc2VsZWN0RWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyID0gcmVuZGVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogY2FuJ3Qgd2Ugb3B0aW1pemUgdGhpcyA/CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHJlbmRlcik7CgogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbkdyb3VwcyA9IHsnJzogW119LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IHZhbHVlc1trZXlOYW1lID8gbG9jYWxzW2tleU5hbWVdID0ga2V5c1tpbmRleF0gOiBpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWRTZXQucmVtb3ZlKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4LCAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiB3ZSBzaG91bGQgYmUgc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6ICcnLCBsYWJlbDogJycsIHNlbGVjdGVkOiAhc2VsZWN0ZWRTZXR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDogJz8nLCBsYWJlbDogJycsIHNlbGVjdGVkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3VwTmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbkdyb3VwLmxhYmVsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goZXhpc3RpbmdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIE9QVEdST1VQIGxhYmVsIGlmIG5vdCB0aGUgc2FtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gbnVsbDsgIC8vIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uR3JvdXBbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZXhpc3RpbmdPcHRpb24gPSBleGlzdGluZ09wdGlvbnNbaW5kZXggKyAxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudGV4dChleGlzdGluZ09wdGlvbi5sYWJlbCA9IG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmlkICE9PSBvcHRpb24uaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnRbMF0uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBudWxsT3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOyAvLyBpbmNyZW1lbnQgc2luY2UgdGhlIGV4aXN0aW5nT3B0aW9uc1swXSBpcyBwYXJlbnQgZWxlbWVudCBub3QgT1BUSU9OCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdPcHRpb25zLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnBvcCgpLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUR1JPVVBzIGZyb20gc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wb3AoKVswXS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIG9wdGlvbkRpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24gKCRpbnRlcnBvbGF0ZSkgewogICAgICAgIHZhciBudWxsU2VsZWN0Q3RybCA9IHsKICAgICAgICAgICAgYWRkT3B0aW9uOiBub29wLAogICAgICAgICAgICByZW1vdmVPcHRpb246IG5vb3AKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC50ZXh0KCksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgZWxlbWVudC50ZXh0KCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIHN0eWxlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0ZXJtaW5hbDogdHJ1ZQogICAgfSk7CgogICAgLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKICAgIC8vYnV0IHdlIHdpbGwgcmViaW5kIG9uIGJvb3RzdHJhcCBhZ2Fpbi4KICAgIGJpbmRKUXVlcnkoKTsKCiAgICBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcik7CgogICAganFMaXRlKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7CiAgICAgICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9ha3tkaXNwbGF5Om5vbmU7fW5nXFw6Zm9ybXtkaXNwbGF5OmJsb2NrO308L3N0eWxlPicpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 19:47:59 GMT",
                    "Content-Length": "599893",
                    "Date": "Fri, 07 Nov 2014 19:48:00 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}