{
    "url": "http://localhost:9999/xingyan/octopus/output/octopus.app.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statements:<ul><li>url = url || window.location.href;</li><li>url = fullUrl + url;</li><li>url = url.toLowerCase();</li><li>a.href = url;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/xingyan/octopus/output/octopus.app.debug.js",
                "path": "/xingyan/octopus/output/octopus.app.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94aW5neWFuL29jdG9wdXMvb3V0cHV0L29jdG9wdXMuYXBwLmRlYnVnLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUwOTc0DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDIxOjE2OjU4IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAyMToxNjo1NyBHTVQNCg0KLyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tu+8jOS4u+imgeeUqOS6jumAmueUqOe7hOS7tueahOexu+e7k+aehOWjsOaYjgogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiDlkb3lkI3nqbrpl7TliY3nvIAg8J+QmQogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzCiAgICAgKiBAZGVzYyDlkb3lkI3nqbrpl7Tor7TmmI4g5omA5pyJ5bCP5YaZ5a2X5q+N5byA5aS055qE5pa55rOV6YO95Y+v5Lul55u05o6l6LCD55SoIOWmgm9jdG9wdXMuZWFzaW5nLmxpbmVhci5lYXNlSW4KICAgICAqIOebuOWPje+8jOWkp+WGmeWtl+avjeW8gOWktOeahOWRveWQjeivtOaYjuivpeWvueixoeaYr+S4gOS4quexu+WvueixoSDpnIDopoHnlKjlhbPplK7lrZduZXcg5aaCIG5ldyBvY3RvcHVzLldpZGdldCgpCiAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICovCiAgICB2YXIgb2N0b3B1cywKICAgICAgICBvID0gb2N0b3B1cyA9IHt2ZXJzaW9uOiAiMS4xIn07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZGVmaW5lCiAgICAgKiBAZGVzYyDnsbvnlJ/miJAu5bCG6L+U5Zue5LiA5Liq5b2i5aaC4oCU4oCUCiAgICAgKiBmdW5jdGlvbiBDKCkgewogICAgICogICAgICB0aGlzLmluaXRpYWxpemUoKQogICAgICogfTsKICAgICAqIEMucHJvdG90eXBlID0geyBjb25zdHJ1Y3RvcjogQywgLi4uIH3nmoTlr7nosaEKICAgICAqIOaUr+aMgeS4pOS4quWPguaVsO+8jOesrOS4gOS4quS4uueItuexu++8iOWPr+S4jeWtmOWcqO+8ie+8jOesrOS6jOS4quS4uueUn+aIkOexu+eahOWQhOWxnuaAp+aWueazleWvueixoSDnlLHkuo7mr4/kuKrnsbvnmoTnlJ/miJDpg73ln7rkuo7lrZDnsbvlr7nniLbnsbvlr7nosaHnmoTmt7Hluqbmi7fotJ3vvIzlm6DmraTvvIwKICAgICAqIOS4uumBv+WFjeWtkOexu+WxnuaAp+abtOaUueWvueeItuexu+mAoOaIkOeahOS4jeWPr+aOp+W9seWTje+8jOmZpE51bWJlcnxTdHJpbmd8Qm9vbGVhbiDlpJbnmoTlr7nosaEg5Yid5aeL5YyW6YO95bu66K6u5pS+5Zyo5p6E6YCg5Ye95pWw5b2T5Lit5Y675YGaIOWIneWni+WMluWAvOW7uuiurgogICAgICog5Li6bnVsbAogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBuZXdDbGFzcyA9IG9jdG9wdXMuZGVmaW5lKHsKICAgICAqICAgICB3aWR0aDogNjQsCiAgICAgKiAgICAgbGVuZ3RoOiAiMTJweCIsCiAgICAgKiAgICAgcHJvcGVydHk6IG51bGwsCiAgICAgKiAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIHRoaXMucHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHt9KTsKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAgICovCiAgICBvLmRlZmluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBzID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICBpID0gYXJndW1lbnRzW2xlbiAtIDFdOwoKICAgICAgICB2YXIgbmMgPSB0eXBlb2YgaS5pbml0aWFsaXplID09ICJmdW5jdGlvbiIgPyBpLmluaXRpYWxpemUgOgogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIGlmKGxlbiA+IDEpIHsKICAgICAgICAgICAgdmFyIG5ld0FyZ3MgPSBbbmMsIHNdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLnNsaWNlKDEsIGxlbiAtIDEpLCBpKTsKICAgICAgICAgICAgby5pbmhlcml0LmFwcGx5KG51bGwsIG5ld0FyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZSA9IGk7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG5jOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmM7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLmluaGVyaXQKICAgICAqIEBkZXNjIOe7p+aJvwogICAgICogQHBhcmFtIGNoaWxkIHtGdW5jdGlvbn0g5a2Q57G7CiAgICAgKiBAcGFyYW0gZmF0aGVyIHtGdW5jdGlvbn0g54i257G7CiAgICAgKi8KICAgIG8uaW5oZXJpdCA9IGZ1bmN0aW9uKGNoaWxkLCBmYXRoZXIpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIGNwLAogICAgICAgICAgICBmcCA9IGZhdGhlci5wcm90b3R5cGU7CiAgICAgICAgZi5wcm90b3R5cGUgPSBmcDsKICAgICAgICBjcCA9IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBmOwogICAgICAgIGNwLmNvbnN0cnVjdG9yID0gY2hpbGQ7CiAgICAgICAgdmFyIGksIGwsIGs7CiAgICAgICAgZm9yKGkgPSAyLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBrID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZih0eXBlb2YgayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgayA9IGsucHJvdG90eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgayk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5leHRlbmQKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoeeahOWxnuaAp+WkjeWItue7meWPpuS4gOS4quWvueixoQogICAgICogQHBhcmFtIGRlc3RpbmF0aW9uIHtvYmplY3R9CiAgICAgKiBAcGFyYW0gc291cmNlIHtvYmplY3R9CiAgICAgKiBAcmV0dXJuIGRlc3RpbmF0aW9uIHtvYmplY3R9IOWkjeWItuWQjueahOWvueixoQogICAgICovCiAgICBvLmV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uIHx8IHt9OwogICAgICAgIGlmKHNvdXJjZSkgewogICAgICAgICAgICBmb3IodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc291cmNlW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIGlmKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSXNFdnQgPSB0eXBlb2Ygd2luZG93LkV2ZW50ID09ICJmdW5jdGlvbiIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSBpbnN0YW5jZW9mIHdpbmRvdy5FdmVudDsKCiAgICAgICAgICAgIGlmICghc291cmNlSXNFdnQgJiYgc291cmNlLmhhc093blByb3BlcnR5ICYmIHNvdXJjZS5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24udG9TdHJpbmcgPSBzb3VyY2UudG9TdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lc3BhY2Ugb2N0b3B1cy51dGlsCiAgICAgKiBAZGVzYyDlt6Xlhbfpm4blkIgg55u45b2T5LqOanF1ZXJ555qEZm4KICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8udXRpbCA9IG8udXRpbCB8fCB7fTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLnV0aWwubGFzdFNlcUlkCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBvLnV0aWwubGFzdFNlcUlkID0gMDsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNyZWF0ZVVuaXF1ZUlECiAgICAgKiBAcGFyYW0gcHJlZml4IHtTdHJpbmd9IOWJjee8gAogICAgICogQHJldHVybiB7U3RyaW5nfSDlhajlsYDllK/kuIDnmoTkuIDkuKrlrZfnrKbkuLIKICAgICAqLwogICAgby51dGlsLmNyZWF0ZVVuaXF1ZUlEID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICAgICAgcHJlZml4ID0gKHByZWZpeCA9PT0gbnVsbCB8fCBwcmVmaXggPT09IHVuZGVmaW5lZCkgPyAib2N0b3B1cyIgOiBwcmVmaXgucmVwbGFjZSgvXC4vZywgIl8iKTsKICAgICAgICBvLnV0aWwubGFzdFNlcUlkKys7CiAgICAgICAgcmV0dXJuIHByZWZpeCArIG8udXRpbC5sYXN0U2VxSWQ7CiAgICB9OwoKICAgIHdpbmRvdy5vY3RvcHVzID0gbzsKCn0pKHdpbmRvdyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiB1dGlsIC0gICDlt6Xlhbflh73mlbDpg6jliIYKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIOmBv+WFjeacquWjsOaYjiBvY3RvcHVzLnV0aWwKICAgICAqLwogICAgdmFyIHV0aWwgPSBvLnV0aWwgPSBvLnV0aWwgfHwge307CgogICAgLyoqCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLkxFRlQge1N0cmluZ30gImxlZnQiCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLlJJR0hUIHtTdHJpbmd9ICJyaWdodCIKICAgICAqIEBjb25zdCBvY3RvcHVzLnV0aWwuVVAge1N0cmluZ30gInVwIgogICAgICogQGNvbnN0IG9jdG9wdXMudXRpbC5ET1dOIHtTdHJpbmd9ICJkb3duIgogICAgICovCiAgICB1dGlsLkxFRlQgPSAibGVmdCI7CiAgICB1dGlsLlJJR0hUID0gInJpZ2h0IjsKICAgIHV0aWwuVVAgPSAidXAiOwogICAgdXRpbC5ET1dOID0gImRvd24iOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0Q2VudGVyCiAgICAgKiBAcGFyYW0gdG91Y2hlcyB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAgKiBAZGVzYyDojrflvpfmiYDmnInop6bmkbjngrnnmoTkuK3lv4MKICAgICAqLwogICAgdXRpbC5nZXRDZW50ZXIgPSBmdW5jdGlvbih0b3VjaGVzKSB7CiAgICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgICBmb3IodmFyIHQ9IDAsbGVuPXRvdWNoZXMubGVuZ3RoOyB0PGxlbjsgdCsrKSB7CiAgICAgICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICAgICAgdmFsdWVzWS5wdXNoKHRvdWNoZXNbdF0ucGFnZVkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgICAgcGFnZVk6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWSkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNZKSkgLyAyKQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0VmVsb2NpdHkKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOeerOenu+mAn+W6pgogICAgICogQHBhcmFtIGRlbHRhX3RpbWUge051bWJlcn0KICAgICAqIEBwYXJhbSBkZWx0YV94IHtOdW1iZXJ9CiAgICAgKiBAcGFyYW0gZGVsdGFfeSB7TnVtYmVyfQogICAgICogQHJldHVybiB7b2JqZWN0fSB45Li65qiq5ZCR6YCf5bqmIHnkuLrnurXlkJHpgJ/luqYKICAgICAqLwogICAgdXRpbC5nZXRWZWxvY2l0eSA9IGZ1bmN0aW9uKGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBNYXRoLmFicyhkZWx0YV94IC8gZGVsdGFfdGltZSkgfHwgMCwKICAgICAgICAgICAgeTogTWF0aC5hYnMoZGVsdGFfeSAvIGRlbHRhX3RpbWUpIHx8IDAKICAgICAgICB9OwoKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRBbmdsZQogICAgICogQGRlc2Mg6I635b6X5Lik54K56Ze06KeS5bqmCiAgICAgKiBAcGFyYW0gdG91Y2gxIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gdG91Y2gyIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0QW5nbGUgPSBmdW5jdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZLAogICAgICAgICAgICB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXREaXJlY3Rpb24KICAgICAqIEBkZXNjIOiOt+W+l+inpueisOa7keWKqOaWueWQkQogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICB1dGlsLmdldERpcmVjdGlvbiA9IGZ1bmN0aW9uKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHggPSBNYXRoLmFicyh0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVgpLAogICAgICAgICAgICB5ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZKTsKCiAgICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVggPiAwID8gdXRpbC5MRUZUIDogdXRpbC5SSUdIVDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gdXRpbC5VUCA6IHV0aWwuRE9XTjsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0RGlzdGFuY2UKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOi3neemuwogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7TnVtYmVyfQogICAgICovCiAgICB1dGlsLmdldERpc3RhbmNlID0gZnVuY3Rpb24odG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4ICogeCkgKyAoeSAqIHkpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRTY2FsZQogICAgICogQGRlc2Mg6I635b6X5Lik6Kem5pG454K55ruR5Yqo5ZCO5b6X5Yiw55qE5Lik6Kem5pG454K55LmL5LqO5LmL5YmN55qE5pS+5aSn5YCN5pWwCiAgICAgKiBAcGFyYW0gc3RhcnQge0FycmF5fQogICAgICogQHBhcmFtIGVuZCB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0U2NhbGUgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERpc3RhbmNlKGVuZFswXSwgZW5kWzFdKSAvCiAgICAgICAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmdldFJvdGF0aW9uCiAgICAgKiBAZGVzYyDojrflvpfkuKTop6bmkbjngrnmu5HliqjlkI7lvpfliLDnmoTkuKTop6bmkbjngrnkuYvkuo7kuYvliY3nmoTml4vovazluqbmlbAKICAgICAqIEBwYXJhbSBzdGFydCB7QXJyYXl9CiAgICAgKiBAcGFyYW0gZW5kIHtBcnJheX0KICAgICAqIEByZXR1cm4ge051bWJlcn0KICAgICAqLwogICAgdXRpbC5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QW5nbGUoZW5kWzFdLCBlbmRbMF0pIC0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW5jb2RlSHRtbAogICAgICogQGRlc2Mg5a+55a2X56ym5Liy5Lit55qE54m55q6K5a2X56ym6L+b6KGMaHRtbOe8lueggQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmVuY29kZUh0bWwgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nKHN0cikKICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgIiZhbXA7IikKICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgIiZsdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAiJmd0OyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC8iL2csICImcXVvdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiJiMzOTsiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5kZWNvZGVIdG1sCiAgICAgKiBAZGVzYyDlr7nlrZfnrKbkuLLkuK3nmoRodG1s6L+b6KGM57yW56CBCiAgICAgKiBAcGFyYW0gc3RyIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuaHRtbERlY29kZURpY3QgPSB7InF1b3QiOiAnIicsICJsdCI6ICI8IiwgImd0IjogIj4iLCAiYW1wIjogIiYiLCAiIzM5IjogIicifTsKICAgIHV0aWwuZGVjb2RlSHRtbCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8mKHF1b3R8bHR8Z3R8YW1wfCMzOSk7L2lnLCBmdW5jdGlvbihhbGwsIGtleSkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5odG1sRGVjb2RlRGljdFtrZXldOwogICAgICAgIH0pLnJlcGxhY2UoLyYjdShbYS1mXGRdezR9KTsvaWcsIGZ1bmN0aW9uKGFsbCwgaGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCgiMHgiICsgaGV4KSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UoLyYjKFxkKyk7L2lnLCBmdW5jdGlvbihhbGwsIG51bWJlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoK251bWJlcik7CiAgICAgICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmxvYWRJbWFnZQogICAgICogQGRlc2Mg5Yqg6L295Zu+54mH5pa55rOVCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9IOWbvueJh3VybAogICAgICogQHBhcmFtIHJlYWR5IHtGdW5jdGlvbn0g5q2k5pe25Zu+54mH5rKh5pyJ5Yqg6L295a6MIOS9huaYr+WuvemrmOW3suefpQogICAgICogQHBhcmFtIGxvYWQge0Z1bmN0aW9ufSDlm77niYdvbmxvYWTnmoRjYWxsYmFjawogICAgICogQHBhcmFtIGVycm9yIHtGdW5jdGlvbn0g5Zu+54mH5Yqg6L295aSx6LSl55qEY2FsbGJhY2sKICAgICAqLwogICAgdXRpbC5sb2FkSW1hZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXSwKICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGwsCiAgICAgICAgLy/nlKjmnaXmiafooYzpmJ/liJcKICAgICAgICAgICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdFtpXS5lbmQgPyBsaXN0LnNwbGljZShpLS0sIDEpIDogbGlzdFtpXSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICFsaXN0Lmxlbmd0aCAmJiBzdG9wKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgLy8g5YGc5q2i5omA5pyJ5a6a5pe25Zmo6Zif5YiXCiAgICAgICAgICAgIHN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh1cmwsIHJlYWR5LCBsb2FkLCBlcnJvcikgewogICAgICAgICAgICB2YXIgb25yZWFkeSwgd2lkdGgsIGhlaWdodCwgbmV3V2lkdGgsIG5ld0hlaWdodCwKICAgICAgICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgICAgICAgICAvLyDlpoLmnpzlm77niYfooqvnvJPlrZjvvIzliJnnm7TmjqXov5Tlm57nvJPlrZjmlbDmja4KICAgICAgICAgICAgaWYgKGltZy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgcmVhZHkuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgbG9hZCAmJiBsb2FkLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgIGhlaWdodCA9IGltZy5oZWlnaHQ7CiAgICAgICAgICAgIC8vIOWKoOi9vemUmeivr+WQjueahOS6i+S7tgogICAgICAgICAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGVycm9yICYmIGVycm9yLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIG9ucmVhZHkuZW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGltZyA9IGltZy5vbmxvYWQgPSBpbWcub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIOWbvueJh+WwuuWvuOWwsee7qgogICAgICAgICAgICBvbnJlYWR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbmV3V2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBpbWcuaGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKG5ld1dpZHRoICE9PSB3aWR0aCB8fCBuZXdIZWlnaHQgIT09IGhlaWdodCB8fCBuZXdXaWR0aCAqIG5ld0hlaWdodCA+IDEwMjQpIHsKICAgICAgICAgICAgICAgICAgICByZWFkeS5jYWxsKGltZyk7CiAgICAgICAgICAgICAgICAgICAgb25yZWFkeS5lbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgb25yZWFkeSgpOwogICAgICAgICAgICAvLyDlrozlhajliqDovb3lrozmr5XnmoTkuovku7YKICAgICAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIG9ubG9hZOWcqOWumuaXtuWZqOaXtumXtOW3ruiMg+WbtOWGheWPr+iDveavlG9ucmVhZHnlv6sKICAgICAgICAgICAgICAgIC8vIOi/memHjOi/m+ihjOajgOafpeW5tuS/neivgW9ucmVhZHnkvJjlhYjmiafooYwKICAgICAgICAgICAgICAgICFvbnJlYWR5LmVuZCAmJiBvbnJlYWR5KCk7CiAgICAgICAgICAgICAgICBsb2FkICYmIGxvYWQuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgLy8gSUUgZ2lm5Yqo55S75Lya5b6q546v5omn6KGMb25sb2Fk77yM572u56m6b25sb2Fk5Y2z5Y+vCiAgICAgICAgICAgICAgICBpbWcgPSBpbWcub25sb2FkID0gaW1nLm9uZXJyb3IgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyDliqDlhaXpmJ/liJfkuK3lrprmnJ/miafooYwKICAgICAgICAgICAgaWYoIW9ucmVhZHkuZW5kKSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2gob25yZWFkeSk7CiAgICAgICAgICAgICAgICAvLyDml6DorrrkvZXml7blj6rlhYHorrjlh7rnjrDkuIDkuKrlrprml7blmajvvIzlh4/lsJHmtY/op4jlmajmgKfog73mjZ/ogJcKICAgICAgICAgICAgICAgIGlmIChpbnRlcnZhbElkID09PSBudWxsKSBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodGljaywgNDApOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KSgpOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW1wdHkKICAgICAqIEBkZXNjIOepuuWHveaVsAogICAgICovCiAgICB1dGlsLmVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmJpbmQKICAgICAqIEBkZXNjIOaNouS9nOeUqOWfnwogICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBvYmplY3QpIHsKICAgICAgICAvLyBjcmVhdGUgYSByZWZlcmVuY2UgdG8gYWxsIGFyZ3VtZW50cyBwYXN0IHRoZSBzZWNvbmQgb25lCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMl0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gUHVzaCBvbiBhbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgZnJvbSB0aGUgYWN0dWFsIGZ1bmN0aW9uIGNhbGwuCiAgICAgICAgICAgIC8vIFRoZXNlIHdpbGwgY29tZSBhZnRlciB0aG9zZSBzZW50IHRvIHRoZSBiaW5kIGNhbGwuCiAgICAgICAgICAgIHZhciBuZXdBcmdzID0gYXJncy5jb25jYXQoCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMF0pCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iamVjdCwgbmV3QXJncyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5iaW5kQXNFdmVudExpc3RlbmVyCiAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOS9nOS4uuS6i+S7tuebkeWQrOeahOWHveaVsAogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDkvZznlKjln58KICAgICAqLwogICAgdXRpbC5iaW5kQXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24oZnVuYywgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwob2JqZWN0LCBldmVudCB8fCB3aW5kb3cuZXZlbnQpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNOb2RlCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/oioLngrkKICAgICAqIEBwYXJhbSBvIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKG8pIHsKICAgICAgICByZXR1cm4gISEobyAmJiBvLm5vZGVUeXBlID09PSAxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc09iamVjdAogICAgICogQGRlc2Mg5Yik5pat5a+56LGh5piv5ZCm5piv5a+56LGhCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzT2JqZWN0ID0gZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiAnZnVuY3Rpb24nID09IHR5cGVvZiBzb3VyY2UgfHwgISEoc291cmNlICYmICdvYmplY3QnID09IHR5cGVvZiBzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzU3RyaW5nCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/lrZfnrKbkuLIKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNTdHJpbmcgPSBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuICdbb2JqZWN0IFN0cmluZ10nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzQXJyYXkKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOe7hAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdXRpbC5pc0FycmF5ID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgcmV0dXJuICgnW29iamVjdCBBcnJheV0nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc051bWVyaWMKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOWtlwogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNOdW1lcmljID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG9iaikpICYmIGlzRmluaXRlKG9iaik7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNQbGFpbgogICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5piv5pmu6YCa5a+56LGhIOmdnmZ1bmN0aW9uCiAgICAgKi8KICAgIHV0aWwuaXNQbGFpbiAgPSBmdW5jdGlvbihvYmopewogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgICAgIGtleTsKICAgICAgICBpZiAoICFvYmogfHwKICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8CiAgICAgICAgICAgICEoJ2lzUHJvdG90eXBlT2YnIGluIG9iaikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAgICAgIWhhc093blByb3BlcnR5LmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgogICAgICAgICAgICAhaGFzT3duUHJvcGVydHkuY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpICkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQogICAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKCBvYmosIGtleSApOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzRW1wdHkKICAgICAqIEBkZXNjIOWIpOaWreS8oOWFpeeahOWPguaVsOaYr+WQpuS4uuepuu+8jAogICAgICogICAgICAg5YyF5ousdW5kZWZpbmVkLCBudWxsLCBmYWxzZSwgbnVtYmVyIDAsCiAgICAgKiAgICAgICBlbXB0eSBzdHJpbmcsIHN0cmluZyAiMCIsIHt9IGFuZCBbXQogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNFbXB0eSA9IGZ1bmN0aW9uKG1peGVkX3ZhcikgewogICAgICAgIHZhciB1bmRlZiwga2V5LCBpLCBsZW47CiAgICAgICAgdmFyIGVtcHR5VmFsdWVzID0gW3VuZGVmLCBudWxsLCBmYWxzZSwgMCwgIiIsICIwIl07CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVtcHR5VmFsdWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtaXhlZF92YXIgPT09IGVtcHR5VmFsdWVzW2ldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBtaXhlZF92YXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG1peGVkX3ZhcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNsb25lCiAgICAgKiBAZGVzYyDmt7Hluqbmi7fotJ3kuIDkuKrlr7nosaEKICAgICAqIEByZXR1cm4g5ou36LSd5ZCO55qE5a+56LGhCiAgICAgKi8KICAgIHV0aWwuY2xvbmUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gc291cmNlLCBpLCBsZW47CiAgICAgICAgaWYgKCFzb3VyY2UKICAgICAgICAgICAgfHwgc291cmNlIGluc3RhbmNlb2YgTnVtYmVyCiAgICAgICAgICAgIHx8IHNvdXJjZSBpbnN0YW5jZW9mIFN0cmluZwogICAgICAgICAgICB8fCBzb3VyY2UgaW5zdGFuY2VvZiBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmKHV0aWwuaXNOb2RlKHNvdXJjZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh1dGlsLmlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdExlbiA9IDAsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHNvdXJjZS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRMZW4rK10gPSB1dGlsLmNsb25lKHNvdXJjZVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNQbGFpbihzb3VyY2UpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBmb3IgKGkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gdXRpbC5jbG9uZShzb3VyY2VbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZWFjaAogICAgICogQHBhcmFtIHNvdXJjZSB7QXJyYXkgfCBPYmplY3R9CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICogQHJldHVybnMgeyp9CiAgICAgKiBAZGVzYyDpgY3ljobmlbDnu4TmiJblr7nosaEKICAgICAqLwogICAgdXRpbC5lYWNoID0gZnVuY3Rpb24oc291cmNlLCBjYWxsYmFjaykgewogICAgICAgIGlmKHV0aWwuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgIHJldHVybiBBcnJheS5mb3JFYWNoID8gc291cmNlLmZvckVhY2goY2FsbGJhY2spIDogZnVuY3Rpb24oYXIsIGZ1bmMpIHsKICAgICAgICAgICAgICAgIHZhciBsZW4gPSBhci5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5jYWxsKHRoaXMsIGFyW2ldLCBpKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KHNvdXJjZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBpZih1dGlsLmlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwodGhpcywgc291cmNlW2tdLCBrKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5mb3JtYXQKICAgICAqIEBwYXJhbSBzdHIge1N0cmluZ30g5b6F6L2s5o2i55qE5a2X56ym5LiyCiAgICAgKiBAcGFyYW0gZGF0YSB7fSDmlbDmja4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuZm9ybWF0ID0gZnVuY3Rpb24oc3RyLCBkYXRhKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oIylceyguKj8pXH0vZywgZnVuY3Rpb24oYWxsLCBmbGFnLCBwYXJhbSkgewogICAgICAgICAgICByZXR1cm4gZGF0YSAmJiB0eXBlb2YgZGF0YVtwYXJhbV0gIT0gInVuZGVmaW5lZCIgPyBkYXRhW3BhcmFtXSA6ICIiOwogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmFwcGx5RGVmYXVsdHMKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoemHjOayoeacieeahOWPguaVsOWkjeWItue7meWPpuS4gOS4quWvueixoSDkuI5leHRlbmTnmoTljLrliKvlnKjkuo4g5aaC5p6c5LiN5Lya5aSN5Yi25bey5a2Y5Zyo5bGe5oCnCiAgICAgKiBAcGFyYW0gdG8ge09iamVjdH0KICAgICAqIEBwYXJhbSBmcm9tIHtPYmplY3R9CiAgICAgKi8KICAgIHV0aWwuYXBwbHlEZWZhdWx0cyA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgaWYodG9ba2V5XSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAoIWZyb21Jc0V2dCAmJiBmcm9tLmhhc093blByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF0by5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgICAgICAgdG9ba2V5XSA9IGZyb21ba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighZnJvbUlzRXZ0ICYmIGZyb20gJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eQogICAgICAgICAgICAmJiBmcm9tLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpICYmICF0by5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgewogICAgICAgICAgICB0by50b1N0cmluZyA9IGZyb20udG9TdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0bzsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5hcHBseUFkZAogICAgICogQGRlc2Mg5bCG5LiA5Liq5a+56LGh6YeM55qE5Y+C5pWw5rex5bqm5ou36LSd57uZ5Y+m5LiA5Liq5a+56LGhIOWmguaenOWPguaVsOW3suWtmOWcqCDliJnopobnm5Yg5aaC5p6c5LiN5a2Y5ZyoIOWImei/veWKoAogICAgICogQHBhcmFtIHRvIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gZnJvbSAge09iamVjdH0KICAgICAqLwogICAgdXRpbC5hcHBseUFkZCA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yKHZhciBrIGluIGZyb20pIHsKICAgICAgICAgICAgaWYodXRpbC5pc09iamVjdCh0b1trXSkgJiYgdXRpbC5pc09iamVjdChmcm9tW2tdKSkgewogICAgICAgICAgICAgICAgdG9ba10gPSB1dGlsLmFwcGx5QWRkKHRvW2tdLCBmcm9tW2tdKTsKICAgICAgICAgICAgfSBlbHNlIGlmKGZyb21ba10gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdG9ba10gPSBmcm9tW2tdCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoIWZyb21Jc0V2dCAmJiBmcm9tICYmIGZyb20uaGFzT3duUHJvcGVydHkKICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSAmJiAhdG8uaGFzT3duUHJvcGVydHkoJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgdG8udG9TdHJpbmcgPSBmcm9tLnRvU3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG87CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwudXJsQXBwZW5kCiAgICAgKiBAZGVzYyDlsIbmjIflrprlrZfnrKbkuLLph4znmoTlhoXlrrnmi7zov5t1cmwKICAgICAqIEBwYXJhbSB1cmwge1N0cmluZ30KICAgICAqIEBwYXJhbSBwYXJhbVN0ciB7U3RyaW5nfQogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20iOwogICAgICogb2N0b3B1cy51dGlsLnVybEFwcGVuZCh1cmwsICJhPTEmYj0yIik7CiAgICAgKiByZXR1cm4gImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9hPTEmYj0yIgogICAgICovCiAgICB1dGlsLnVybEFwcGVuZCA9IGZ1bmN0aW9uKHVybCwgcGFyYW1TdHIpIHsKICAgICAgICB2YXIgbmV3VXJsID0gdXJsOwogICAgICAgIGlmKHBhcmFtU3RyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9ICh1cmwgKyAiICIpLnNwbGl0KC9bPyZdLyk7CiAgICAgICAgICAgIG5ld1VybCArPSAocGFydHMucG9wKCkgPT09ICIgIiA/CiAgICAgICAgICAgICAgICBwYXJhbVN0ciA6CiAgICAgICAgICAgICAgICBwYXJ0cy5sZW5ndGggPyAiJiIgKyBwYXJhbVN0ciA6ICI/IiArIHBhcmFtU3RyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1VybDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcKICAgICAqIEBkZXNjIOS7juaMh+WumuWQjeWAvOWvuemHjOaQnuWHuuadpeWtl+espuS4suW9ouW8jwogICAgICogQHBhcmFtIHBhcmFtcyB7T2JqZWN0fQogICAgICogQGV4YW1wbGUKICAgICAqIHBhcmFtID0geyBhOiAxLCBiOiAyIH0KICAgICAqIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcocGFyYW0pCiAgICAgKiByZXR1cm4gImE9MSZiPTIiCiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgdmFyIHBhcmFtc0FycmF5ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgaWYgKCh2YWx1ZSAhPSBudWxsKSAmJiAodHlwZW9mIHZhbHVlICE9ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICB2YXIgZW5jb2RlZFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbmNvZGVkSXRlbUFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaXRlbUluZGV4PTAsIGxlbj12YWx1ZS5sZW5ndGg7IGl0ZW1JbmRleDxsZW47IGl0ZW1JbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2YWx1ZVtpdGVtSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSXRlbUFycmF5LnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogaXRlbSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZFZhbHVlID0gZW5jb2RlZEl0ZW1BcnJheS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyYW1zQXJyYXkucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtc0FycmF5LmpvaW4oIiYiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJzCiAgICAgKiBAZGVzYyDku451cmzkuK0/5ZCO55qE5a2X56ym5Liy5Lul5a+56LGh5b2i5byP6L+U5ZueCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAgKiBAZXhhbXBsZQogICAgICogdXJsID0gImh0dHA6Ly93d3cuYmFpZHUuY29tP2E9MSZiPTIiCiAgICAgKiBvY3RvcHVzLnV0aWwuZ2V0UGFyYW1ldGVycyh1cmwpOwogICAgICogcmV0dXJuIHsgYTogMSwgYjogMiB9CiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHVybCA9ICh1cmwgPT09IG51bGwgfHwgdXJsID09PSB1bmRlZmluZWQpID8gd2luZG93LmxvY2F0aW9uLmhyZWYgOiB1cmw7CiAgICAgICAgdmFyIHBhcmFtc1N0cmluZyA9ICIiOwogICAgICAgIGlmKHVybC5pbmRleE9mKCI/IikgIT0gLTEpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdXJsLmluZGV4T2YoJz8nKSArIDE7CiAgICAgICAgICAgIHZhciBlbmQgPSB1cmwuaW5kZXhPZigiIyIpICE9IC0xID8KICAgICAgICAgICAgICAgIHVybC5pbmRleE9mKCcjJykgOiB1cmwubGVuZ3RoOwogICAgICAgICAgICBwYXJhbXNTdHJpbmcgPSB1cmwuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgICB2YXIgcGFyYW1ldGVycyA9IHt9OwogICAgICAgIHZhciBwYWlycyA9IHBhcmFtc1N0cmluZy5zcGxpdCgvWyY7XS8pLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcGFpcnMubGVuZ3RoOwogICAgICAgIGZvciggOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlID0gcGFpcnNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgaWYoa2V5VmFsdWVbMF0pIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZVswXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZGVjb2RlVVJJQ29tcG9uZW50KGtleSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSB1bmVzY2FwZShrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gKGtleVZhbHVlWzFdIHx8ICcnKS5yZXBsYWNlKC9cKy9nLCAiICIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZXNjYXBlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1ldGVyczsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5jcmVhdGVVcmxPYmplY3QKICAgICAqIEBkZXNjIOWIm+W7uuS4gOS4qnVybOWvueixoeeahOWQjeWAvOWvuQogICAgICog6YeM6Z2i5oyJ54WndzNjIHVybOagh+WHhuaPkOS+m+S6huavj+S4gOS4queahOWAvAogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20/YT0xJmI9MiNhYmM9MSI7CiAgICAgKiBvY3RvcHVzLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgKiByZXR1cm4KICAgICAqIHsKICAgICAqICBhcmdzOiBPYmplY3QsCiAgICAgKiAgYTogIjEiLAogICAgICogIGI6ICIyIiwKICAgICAqICBoYXNoOiAiI2FiYz0xIiwKICAgICAqICBob3N0OiAid3d3Lmdvb2dsZS5jb20iLAogICAgICogIHBhdGhuYW1lOiAiLyIsCiAgICAgKiAgcG9ydDogIjgwIiwKICAgICAqICBwcm90b2NvbDogImh0dHA6IiwKICAgICAqIH0KICAgICAqLwogICAgdXRpbC5jcmVhdGVVcmxPYmplY3QgPSBmdW5jdGlvbih1cmwsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgaWYoISgvXlx3KzpcL1wvLykudGVzdCh1cmwpKSB7CiAgICAgICAgICAgIHZhciBsb2MgPSB3aW5kb3cubG9jYXRpb247CiAgICAgICAgICAgIHZhciBwb3J0ID0gbG9jLnBvcnQgPyAiOiIgKyBsb2MucG9ydCA6ICIiOwogICAgICAgICAgICB2YXIgZnVsbFVybCA9IGxvYy5wcm90b2NvbCArICIvLyIgKyBsb2MuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCkgKyBwb3J0OwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZigiLyIpID09PSAwKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBmdWxsVXJsICsgdXJsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbG9jLnBhdGhuYW1lLnNwbGl0KCIvIik7CiAgICAgICAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgIHVybCA9IGZ1bGxVcmwgKyBwYXJ0cy5qb2luKCIvIikgKyAiLyIgKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlQ2FzZSkgewogICAgICAgICAgICB1cmwgPSB1cmwudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgIHZhciB1cmxPYmplY3QgPSB7fTsKICAgICAgICB1cmxPYmplY3QuaG9zdCA9IGEuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCk7CiAgICAgICAgdXJsT2JqZWN0LnByb3RvY29sID0gYS5wcm90b2NvbDsKICAgICAgICBpZihvcHRpb25zLmlnbm9yZVBvcnQ4MCkgewogICAgICAgICAgICB1cmxPYmplY3QucG9ydCA9IChhLnBvcnQgPT0gIjgwIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICIiIDogYS5wb3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVybE9iamVjdC5wb3J0ID0gKGEucG9ydCA9PSAiIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICI4MCIgOiBhLnBvcnQ7CiAgICAgICAgfQoKICAgICAgICAvL2hhc2gKICAgICAgICB1cmxPYmplY3QuaGFzaCA9IChvcHRpb25zLmlnbm9yZUhhc2ggfHwgYS5oYXNoID09PSAiIyIpID8gIiIgOiBhLmhhc2g7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gYS5zZWFyY2g7CiAgICAgICAgaWYgKCFxdWVyeVN0cmluZykgewogICAgICAgICAgICB2YXIgcU1hcmsgPSB1cmwuaW5kZXhPZigiPyIpOwogICAgICAgICAgICBxdWVyeVN0cmluZyA9IChxTWFyayAhPSAtMSkgPyB1cmwuc3Vic3RyKHFNYXJrKSA6ICIiOwogICAgICAgIH0KICAgICAgICB1cmxPYmplY3QuYXJncyA9IHV0aWwuZ2V0UGFyYW1ldGVycyhxdWVyeVN0cmluZyk7CiAgICAgICAgdXJsT2JqZWN0LnBhdGhuYW1lID0gKGEucGF0aG5hbWUuY2hhckF0KDApID09ICIvIikgPyBhLnBhdGhuYW1lIDogIi8iICsgYS5wYXRobmFtZTsKICAgICAgICByZXR1cm4gdXJsT2JqZWN0OwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLnRyaW0KICAgICAqIEBkZXNjIOWOu+aOieWtl+espuS4suS4pOS+p+epuueZvQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLnRyaW0gPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgICByZXR1cm4gISFzdHIudHJpbSA/IHN0ci50cmltKCkgOiBzdHIucmVwbGFjZShuZXcgUmVnRXhwKCIoXltcXHNcXHRcXHhhMFxcdTMwMDBdKyl8KFtcXHUzMDAwXFx4YTBcXHNcXHRdK1x4MjQpIiwgImciKSwgJycpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5yZW1vdmVJdGVtCiAgICAgKiBAcGFyYW0gc291cmNlCiAgICAgKiBAcGFyYW0gaXRlbQogICAgICovCiAgICB1dGlsLnJlbW92ZUl0ZW0gPSBmdW5jdGlvbihzb3VyY2UsIGl0ZW0pIHsKICAgICAgICB2YXIgbGVuID0gc291cmNlLmxlbmd0aCwKICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICBpZihzb3VyY2VbaV0gPT09IGl0ZW0pIHsKICAgICAgICAgICAgICAgIHNvdXJjZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC51cHBlckNhc2VPYmplY3QKICAgICAqIEBkZXNjIOWwhuaMh+WumuWvueixoemHjOeahGtleemmluWtl+avjeWkp+WGmQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLnVwcGVyQ2FzZU9iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgdU9iamVjdCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgdU9iamVjdFtrZXkudG9VcHBlckNhc2UoKV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVPYmplY3Q7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY2FtZWxpemUKICAgICAqIEBkZXNjIOmpvOWzsOWMluWtl+espuS4sgogICAgICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmNhbWVsaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdmFyIG9TdHJpbmdMaXN0ID0gc291cmNlLnNwbGl0KC9bXC18X3xcc3xcLl0vZyk7CiAgICAgICAgdmFyIGNhbWVsaXplZFN0cmluZyA9IG9TdHJpbmdMaXN0WzBdLAogICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgbGVuID0gb1N0cmluZ0xpc3QubGVuZ3RoOwogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzID0gb1N0cmluZ0xpc3RbaV07CiAgICAgICAgICAgIGNhbWVsaXplZFN0cmluZyArPSBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYW1lbGl6ZWRTdHJpbmc7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuc3R5bGVDc3MKICAgICAqIEBkZXNjIOWwhuWJjee8gOexu2NzcyDmoLflvI/ljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY3NzID0gIi13ZWJraXQtdHJhbnNpdGlvbiI7CiAgICAgKiBvY3RvcHVzLnV0aWwuc3R5bGVDc3MoY3NzKTsKICAgICAqIHJldHVybiAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqLwogICAgdXRpbC5zdHlsZUNzcyA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBmbGFnID0gdHJ1ZTsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoL1wtKFxTKS9nLCBmdW5jdGlvbigkMSwgJDIpIHsKICAgICAgICAgICAgcmV0dXJuIGZsYWcgPyAoZmxhZyA9IGZhbHNlLCAkMikgOiAkMi50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY3NzU3R5bGUKICAgICAqIEBkZXNjIOWwhuagt+W8j+WMlueahOWJjee8gCBjc3PljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgc3R5bGUgPSAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqIG9jdG9wdXMudXRpbC5jc3NTdHlsZShzdHlsZSk7CiAgICAgKiByZXR1cm4gLXdlYmtpdC10cmFuc2l0aW9uCiAgICAgKi8KICAgIHV0aWwuY3NzU3R5bGUgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoLyheXFN8W0EtWl0pL2csIGZ1bmN0aW9uKCQxKSB7CiAgICAgICAgICAgIHJldHVybiAiLSIgKyAkMS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwucmVxdWVzdEFuaW1hdGlvbgogICAgICovCiAgICB1dGlsLnJlcXVlc3RBbmltYXRpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxNik7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHJlcXVlc3QuYXBwbHkod2luZG93LCBbY2FsbGJhY2ssIGVsZW1lbnRdKTsKICAgICAgICB9OwogICAgfSkoKTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiBkb20gLSAgIGRvbeaTjeS9nOmDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlt6Xlhbflh73mlbDnmoTlkb3lkI3nqbrpl7QKICAgICAgICAgKi8KICAgICAgICB1ID0gby51dGlsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlo7DmmI5kb2N1bWVudAogICAgICAgICAqLwogICAgICAgIGRvYyA9IGRvY3VtZW50OwoKICAgIGZ1bmN0aW9uIGdldFNjcmVlbkJ5KHQpIHsKICAgICAgICB2YXIgdiA9IHdpbmRvd1siaW5uZXIiICsgdF0sCiAgICAgICAgICAgIF92ID0gKHUuaXNOdW1lcmljKHYpICYmIHYgPiAwKSA/IHYgOgogICAgICAgICAgICAgICAgKGRvYy5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IikgPyBkb2MuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgdF0gOiBvLmRvbVsiZ2V0IiArIHRdKGRvYy5ib2R5KTsKICAgICAgICByZXR1cm4gX3YgPiAwID8gX3YgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmRvbQogICAgICogQGRlc2Mg5LiA5Lqb5Z+656GA55qEZG9t5pON5L2cCiAgICAgKi8KICAgIG8uZG9tID0gewogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZwogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOmdoGlk5ou/5Liq6IqC54K5IOeUseS6juWPquaYr+eugOWNleaUr+aMgSDmsqHmnInlv4XopoHlhpnlvpfpgqPkuYjpq5jnuqcKICAgICAgICAgKi8KICAgICAgICBnOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSAodS5pc1N0cmluZyhlbCkgPyBkb2MuZ2V0RWxlbWVudEJ5SWQoZWwpIDogKHUuaXNPYmplY3QoZWwpICYmIGVsKSk7CiAgICAgICAgICAgIHJldHVybiBlbCB8fCBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uJAogICAgICAgICAqIEBwYXJhbSBmaWx0ZXIKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAZGVzYyDkuI3mg7Pph43lpI3nmoTljrvlhpnov5nkuYjlpJog5ou/5Yiw5LiA5Liq6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgJDogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yQWxsKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ub25lCiAgICAgICAgICogQHBhcmFtIGZpbHRlcgogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOaLv+WIsOaMh+WumuiKgueCueS4i+eahOaWh+aho+a1gemHjOeahOesrOS4gOS4quiKgueCuQogICAgICAgICAqLwogICAgICAgIG9uZTogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uaGFzQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKTmlq3oioLngrnmnIljbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lczsKICAgICAgICAgICAgcmV0dXJuICEhZWwuY2xhc3NMaXN0ID8gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpIDoKICAgICAgICAgICAgICAgIChuYW1lcyA9IGVsLmNsYXNzTmFtZSwgISFuYW1lcyAmJiBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIG5hbWUgKyAiKFxcc3wkKSIpLnRlc3QobmFtZXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmFkZENsYXNzCiAgICAgICAgICogQGRlc2Mg57uZ5oyH5a6a6IqC54K55aKe5YqgY2xhc3MKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWwsIG5hbWUpIHsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBuYW1lID0gbmFtZSB8fCBudWxsOwogICAgICAgICAgICBpZighbmFtZSkgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBjbGFzc0xpc3QgPSBlbC5jbGFzc0xpc3Q7CiAgICAgICAgICAgIGlmKCEhY2xhc3NMaXN0KSB7CiAgICAgICAgICAgICAgICBpZighY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmKCFvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgKz0gKGVsLmNsYXNzTmFtZSA/ICIgIiA6ICIiKSArIG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ucmVtb3ZlQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKDpmaTmjIflrproioLngrnnmoTmjIflrppjbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lcywKICAgICAgICAgICAgICAgIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKICAgICAgICAgICAgaWYoISFjbGFzc0xpc3QpIHsKICAgICAgICAgICAgICAgIGlmKGNsYXNzTGlzdC5jb250YWlucyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IGVsLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgICAgICBpZihuYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSB1LnRyaW0obmFtZXMpLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKCIoXnxcXHMrKSIgKyBuYW1lICsgIihcXHMrfCQpIiksICIgIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS50b2dnbGVDbGFzcwogICAgICAgICAqIEBkZXNjIHRvZ2dsZeaMh+WumuiKgueCueeahOaMh+Wumuagt+W8jwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudCB8IFN0cmluZ30g5oyH5a6a6IqC54K5CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30g5oyH5a6a5qC35byPCiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGVsLCBuYW1lKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHQgPSBvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSk7CiAgICAgICAgICAgIGlmKHQpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRXaWR0aAogICAgICAgICAqIEBkZXNjIOiOt+W+l+aMh+WumuiKgueCueeahOWuveW6pgogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRXaWR0aDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgdmFyIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHdpZHRoID0gISFlbC5vZmZzZXRXaWR0aCA/IGVsLm9mZnNldFdpZHRoIDogZWwuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHJldHVybiB3aWR0aCA+IDAgPyB3aWR0aCA6IDA7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5XaWR0aAogICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6I635b6X5bGP5bmV5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NyZWVuV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0U2NyZWVuQnkoIldpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5IZWlnaHQKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiOt+W+l+Wxj+W5lemrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTY3JlZW5CeSgiSGVpZ2h0Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRIZWlnaHQKICAgICAgICAgKiBAZGVzYyDojrflvpfmjIflrproioLngrnpq5jluqYKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0SGVpZ2h0OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gISFlbC5vZmZzZXRIZWlnaHQgPyBlbC5vZmZzZXRIZWlnaHQgOiBlbC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIHJldHVybiBoZWlnaHQgPiAwID8gaGVpZ2h0IDogMDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmluc2VydEFmdGVyCiAgICAgICAgICogQGRlc2Mg5o+S5Yiw5oyH5a6a6IqC54K55ZCO6Z2iCiAgICAgICAgICogQHBhcmFtIG5ld2RvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdGFyZG9tIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGluc2VydEFmdGVyOiBmdW5jdGlvbihuZXdkb20sIHRhcmRvbSkgewogICAgICAgICAgICBuZXdkb20gPSBvLmcobmV3ZG9tKTsKICAgICAgICAgICAgdGFyZG9tID0gby5nKHRhcmRvbSk7CiAgICAgICAgICAgIHRhcmRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdkb20sIHRhcmRvbS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIHJldHVybiBuZXdkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5pbnNlcnRGaXJzdAogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBwYXJhbSBjb250YWluZXIKICAgICAgICAgKi8KICAgICAgICBpbnNlcnRGaXJzdDogZnVuY3Rpb24oZWwsIGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpLAogICAgICAgICAgICAgICAgY29udGFpbmVyID0gby5nKGNvbnRhaW5lciksCiAgICAgICAgICAgICAgICBmaXJzdENoaWxkID0gY29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmKCFmaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShlbCwgZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNldFN0eWxlcwogICAgICAgICAqIEBkZXNjIOaJuemHj+i1i+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9CiAgICAgICAgICogQHBhcmFtIGlzaW5pdCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZXM6IGZ1bmN0aW9uKGVsLCBvYmosIGlzaW5pdCkgewogICAgICAgICAgICBpc2luaXQgPSBpc2luaXQgfHwgZmFsc2U7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoaXNpbml0KSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcih2YXIgayBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmKCFpc2luaXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2sgPSBrOwogICAgICAgICAgICAgICAgICAgIGlmKGsubWF0Y2goL14tKHdlYmtpdHxvfG1zfG1veikvZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2sgID0gdS5zdHlsZUNzcyhrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbX2tdID0gb2JqW2tdOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3NzVGV4dCArPSBrICsgIjogIiArIG9ialtrXSArICI7IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighIWNzc1RleHQpIHsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTdHlsZQogICAgICAgICAqIEBkZXNjIOiOt+WPluaMh+WumuiKgueCueeahOaMh+WumuWxnuaAp+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gc3R5bGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRTdHlsZTogZnVuY3Rpb24oZWwsIHN0eWxlKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGVsICYmIGVsLnN0eWxlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLnN0eWxlW3UuY2FtZWxpemUoc3R5bGUpXTsKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmRlZmF1bHRWaWV3ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjc3MgPSBkb2MuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY3NzID8gY3NzLmdldFByb3BlcnR5VmFsdWUoc3R5bGUpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLmN1cnJlbnRTdHlsZVt1LmNhbWVsaXplKHN0eWxlKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IFsnbGVmdCcsICd0b3AnLCAncmlnaHQnLCAnYm90dG9tJ107CiAgICAgICAgICAgICAgICBpZiAod2luZG93Lm9wZXJhICYmCiAgICAgICAgICAgICAgICAgICAgKHBvc2l0aW9ucy5pbmRleE9mKHN0eWxlKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAoby5kb20uZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSAnYXV0bycgPyBudWxsIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRQYXJlbnROb2RlCiAgICAgICAgICogQGRlc2Mg5p+l6K+i56ym5ZCI5p2h5Lu255qE56a75oyH5a6a6IqC54K55pyA6L+R55qE54i26IqC54K5CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50IHwgU3RyaW5nfSDooqvmn6Xmib7nmoTotbflp4voioLngrkKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOetm+mAieWZqAogICAgICAgICAqIEBwYXJhbSBtYXhEZXB0aCB7TnVtYmVyfSDmn6XnnIvnmoTmnIDmt7HlsYLmlbAKICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnROb2RlOiBmdW5jdGlvbihlbCwgZmlsdGVyLCBtYXhEZXB0aCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBtYXhEZXB0aCA9IG1heERlcHRoIHx8IDUwOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwLAogICAgICAgICAgICAgICAgX2VsID0gbnVsbDsKICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnROb2RlOwogICAgICAgICAgICB3aGlsZSh1LmlzTm9kZShlbCkgJiYgKGRlcHRoIDwgbWF4RGVwdGgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZmlsdGVyKTsKICAgICAgICAgICAgICAgIGlmKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGxpc3QsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodS5pc05vZGUoaXRlbSkgJiYgaXRlbSA9PSBlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbCA9IGVsLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZihfZWwgfHwgZWwudGFnTmFtZSA9PSAiSFRNTCIpCWJyZWFrOwogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2VsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZ2V0UG9zaXRpb24KICAgICAgICAgKiBAZGVzYyDojrflvpflhYPntKDnm7jlr7nkuo7mtY/op4jlmajlt6bkuIrop5LnmoTlnZDmoIcKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0UG9zaXRpb246IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIGRvYyA9ICEhZWwub3duZXJEb2N1bWVudCA/IGVsLm93bmVyRG9jdW1lbnQgOiBlbCwKICAgICAgICAgICAgICAgIGdldFN0eWxlID0gby5kb20uZ2V0U3R5bGUsCiAgICAgICAgICAgICAgICBwb3MgPSB7ImxlZnQiOiAwLCAidG9wIjogMH0sCiAgICAgICAgICAgICAgICB2aWV3cG9ydCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbDsKICAgICAgICAgICAgaWYoZWwgPT0gdmlld3BvcnQpewogICAgICAgICAgICAgICAgcmV0dXJuIHBvczsKICAgICAgICAgICAgfQogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBwb3MubGVmdCArPSBwYXJlbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgICAgIHBvcy50b3AgICs9IHBhcmVudC5vZmZzZXRUb3A7CiAgICAgICAgICAgICAgICBpZiAoZ2V0U3R5bGUocGFyZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zLmxlZnQgKz0gZG9jLmJvZHkuc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wICArPSBkb2MuYm9keS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9IHdoaWxlIChwYXJlbnQgJiYgcGFyZW50ICE9IGVsKTsKICAgICAgICAgICAgaWYoZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdhYnNvbHV0ZScpewogICAgICAgICAgICAgICAgcG9zLnRvcCAgLT0gZG9jLmJvZHkub2Zmc2V0VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IGVsLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQgIT0gZG9jLmJvZHkpIHsKICAgICAgICAgICAgICAgIHBvcy5sZWZ0IC09IHBhcmVudC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgaWYgKHBhcmVudC50YWdOYW1lICE9ICdUUicpIHsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wIC09IHBhcmVudC5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5jcmVhdGVEb20KICAgICAgICAgKiBAZGVzYyDliJvlu7pkb23oioLngrkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBkb23nsbvlnosKICAgICAgICAgKiBAcGFyYW0gYXR0cyB7T2JqZWN0fSBkb23lsZ7mgKflkI3lgLzlr7kKICAgICAgICAgKiBAcGFyYW0gc3R5cyB7T2JqZWN0fSBkb23moLflvI/lkI3lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVEb206IGZ1bmN0aW9uKHR5cGUsIGF0dHMsIHN0eXMpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGRvYy5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICBhdHRzICYmIHUuZWFjaChhdHRzLCBmdW5jdGlvbih2LCBhdHQpIHsKICAgICAgICAgICAgICAgIGlmKGF0dCA9PSAiaW5uZXJIVE1MIiB8fCBhdHQgPT0gImlubmVyVGV4dCIpIHsKICAgICAgICAgICAgICAgICAgICBkb21bYXR0XSA9IG8udXRpbC5lbmNvZGVIdG1sKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb20uc2V0QXR0cmlidXRlKGF0dCwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzdHlzICYmIG8uZG9tLnNldFN0eWxlcyhkb20sIHN0eXMsIHRydWUpOwogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uY2xvbmVOb2RlCiAgICAgICAgICogQGRlc2MgY2xvbmXoioLngrkg5Y+v5Lul5bCG5LqL5Lu25LiA6LW3Y2xvbmUg6K+l5LqL5Lu25b+F6aG75piv6YCa6L+H5q2k5qGG5p625Yqg5LiK55qECiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDlvoVjbG9uZeeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBldiB7Qm9vbGVhbn0g5piv5ZCmY2xvbmXkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gYyB7Qm9vbGVhbn0g5piv5ZCm5ou36LSd5a2Q6IqC54K5CiAgICAgICAgICovCiAgICAgICAgY2xvbmVOb2RlOiBmdW5jdGlvbihlbCwgZXYsIGMpIHsKICAgICAgICAgICAgZXYgPSBldiB8fCBmYWxzZTsKICAgICAgICAgICAgYyA9IGMgfHwgZmFsc2U7CiAgICAgICAgICAgIHZhciBjbG9uZUVsID0gby5nKGVsKS5jbG9uZU5vZGUoIWMpOwogICAgICAgICAgICBpZighZXYgfHwgIWVsLl9ldmVudENhY2hlSUQpIHJldHVybiBjbG9uZUVsOwogICAgICAgICAgICB2YXIgb2JzID0gby5ldmVudC5vYnNlcnZlcnNbZWwuX2V2ZW50Q2FjaGVJRF07CiAgICAgICAgICAgIHUuZWFjaChvYnMsIGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gaXRlbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIG9ic2VydmVyID0gdS5jbG9uZShpdGVtLm9ic2VydmVyKSwKICAgICAgICAgICAgICAgICAgICB1c2VDYXB0dXJlID0gdS5jbG9uZShpdGVtLnVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbihjbG9uZUVsLCBuYW1lLCBvYnNlcnZlciwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2xvbmVFbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNjcm9sbExpdGUKICAgICAgICAgKiBAZGVzYyDpkojlr7lpb3Porr7lpIfmu5rliqjmnaHmu5rliqjml7bkuovku7bkvKDmkq3mlrnlkJHlr7zoh7TnmoTmu5rliqjlvILluLjop6PlhrMKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOa7muWKqOeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBpc0hvcml6b24ge0Jvb2xlYW59IOaYr+WQpuaoquWQkQogICAgICAgICAqIEBwYXJhbSBwcmV2ZW50RnJvbSB7RE9NRWxlbWVudH0g5byV6LW3YnVn55qE5qC55rqQ5a655ZmoIOWPr+S4jeS8oAogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2Nyb2xsTGl0ZTogZnVuY3Rpb24oZWwsIGlzSG9yaXpvbiwgcHJldmVudEZyb20pIHsKICAgICAgICAgICAgdmFyIHBvcyA9IHsgbGVmdDogMCwgdG9wOiAwIH07CiAgICAgICAgICAgIGlmKHByZXZlbnRGcm9tKSB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RnJvbSA9IG8uZyhwcmV2ZW50RnJvbSk7CiAgICAgICAgICAgICAgICBvLmV2ZW50Lm9uKHByZXZlbnRGcm9tLCAidG91Y2htb3ZlIiwgZnVuY3Rpb24oZSkgeyBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7IH0sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyhlbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtb3ZlcmZsb3ctc2Nyb2xsaW5nIjogInRvdWNoIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgInRvdWNoc3RhcnQiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICBwb3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICB0b3A6IHRvdWNoZXNbMF0ucGFnZVkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZWwsICJ0b3VjaG1vdmUiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0LAogICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IHRhcmdldC5zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHRhcmdldC5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICAgIG1vdmVMZWZ0ID0gdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBtb3ZlVG9wID0gdG91Y2hlc1swXS5wYWdlWSwKICAgICAgICAgICAgICAgICAgICBzdGFydFRvcCA9IHBvcy50b3AsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRMZWZ0ID0gcG9zLmxlZnQ7CiAgICAgICAgICAgICAgICBpZihpc0hvcml6b24pIHsKICAgICAgICAgICAgICAgICAgICBpZigoc2Nyb2xsTGVmdCA8PSAwICYmIG1vdmVMZWZ0ID4gc3RhcnRMZWZ0KSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoc2Nyb2xsTGVmdCA+PSB0YXJnZXQuc2Nyb2xsV2lkdGggLSB0YXJnZXQuY2xpZW50V2lkdGggLSA1ICYmIG1vdmVMZWZ0IDwgc3RhcnRMZWZ0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYoKHNjcm9sbFRvcCA8PSAwICYmIG1vdmVUb3AgPiBzdGFydFRvcCkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHNjcm9sbFRvcCA+PSB0YXJnZXQuc2Nyb2xsSGVpZ2h0IC0gdGFyZ2V0LmNsaWVudEhlaWdodCAtIDUgJiYgbW92ZVRvcCA8IHN0YXJ0VG9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmRhdGEKICAgICAgICAgKiBAZGVzYyDor7vlj5bmiJborr7nva7mjIflrproioLngrnnmoTmlbDmja4KICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVMZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGF0dHJzIHtTdHJpbmcgfCBBcnJheX0KICAgICAgICAgKi8KICAgICAgICBkYXRhOiBmdW5jdGlvbihlbCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIHZzID0ge307CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYodS5pc1N0cmluZyhhdHRycykpIHsKICAgICAgICAgICAgICAgIHZhciBhcnMgPSBhdHRycy5zcGxpdCgiICIpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IGFycy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZihsZW4gPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5kYXRhc2V0ICYmIGVsLmRhdGFzZXRbYXJzWzBdXSB8fCBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtIiArIGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2l0ZW0gPSB1LmNhbWVsaXplKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmRhdGFzZXQgJiYgZWwuZGF0YXNldFtfaXRlbV0gfHwgZWwuZ2V0QXR0cmlidXRlKCJkYXRhLSIgKyBpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZGF0YS0iICsgaywgdnNba10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5hdHRyCiAgICAgICAgICogQGRlc2Mg6K+75Y+W5oiW6K6+572u5oyH5a6a6IqC54K555qE5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgYXR0cjogZnVuY3Rpb24oZWwsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciB2cyA9IHt9OwogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKHUuaXNTdHJpbmcoYXR0cnMpKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJzID0gYXR0cnMuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYobGVuID09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmdldEF0dHJpYnV0ZShpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrLCB2c1trXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZzOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAZGVzYyDlsIbluLjnlKjnmoTpgInmi6nlmajmlrnms5XnmoTlkb3lkI3nqbrpl7Tmj5DliY0KICAgICAqLwogICAgby5nID0gby5kb20uZzsKCiAgICBvLiQgPSBvLmRvbS4kOwoKICAgIG8ub25lID0gby5kb20ub25lOwoKICAgICF3aW5kb3cuJCAmJiAod2luZG93LiQgPSBvLiQpOwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5LqL5Lu26YOo5YiGIO+8jSAgIGV2ZW50CiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICog5a6a5LmJ5bqT5YaF5LqL5Lu25pSv5pKRCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuZXZlbnQKICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8uZXZlbnQgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvYnNlcnZlcnMKICAgICAgICAgKiBAZGVzYyDkuIDkuKrnvJPlrZjkuovku7bnm5HlkKznmoRoYXNo6KGoCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvYnNlcnZlcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5lbGVtZW50CiAgICAgICAgICogQGRlc2Mg6L+U5Zue5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiDop6blj5Hkuovku7bnmoToioLngrkge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1NpbmdsZVRvdWNoCiAgICAgICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5Y2V54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1NpbmdsZVRvdWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA9PSAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc011bHRpVG91Y2gKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblpJrngrkKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTXVsdGlUb3VjaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRvdWNoZXMgJiYgZXZlbnQudG91Y2hlcy5sZW5ndGggPiAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc0xlZnRDbGljawogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuaYr+W3pumUrueCueWHuwogICAgICAgICAqIEBwYXJhbSBldmVudCB7d2luZG93LmV2ZW50fQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMZWZ0Q2xpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhISgoKGV2ZW50LndoaWNoKSAmJiAoZXZlbnQud2hpY2ggPT0gMSkpIHx8CiAgICAgICAgICAgICAgICAoKGV2ZW50LmJ1dHRvbikgJiYgKGV2ZW50LmJ1dHRvbiA9PSAxKSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1JpZ2h0Q2xpY2sKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblj7PplK7ngrnlh7sKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmlnaHRDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICEhKCgoZXZlbnQud2hpY2gpICYmIChldmVudC53aGljaCA9PSAzKSkgfHwKICAgICAgICAgICAgICAgICgoZXZlbnQuYnV0dG9uKSAmJiAoZXZlbnQuYnV0dG9uID09IDIpKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3AKICAgICAgICAgKiBAZGVzYyDmiorkuovku7blgZzkuoYKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcGFyYW0gYWxsb3dEZWZhdWx0IHtCb29sZWFufSAtICAg5piv5ZCm5oqK6buY6K6k5ZON5bqU5YGc5LqGCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oZXZlbnQsIGFsbG93RGVmYXVsdCkgewogICAgICAgICAgICBpZiAoIWFsbG93RGVmYXVsdCkgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LmZpbmRFbGVtZW50CiAgICAgICAgICogQGRlc2Mg5om+5Yiw6Kem5Y+R5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBmaW5kRWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBvLmV2ZW50LmVsZW1lbnQoZXZlbnQpOwogICAgICAgICAgICB3aGlsZSAoZWxlbWVudC5wYXJlbnROb2RlICYmICghZWxlbWVudC50YWdOYW1lIHx8CiAgICAgICAgICAgICAgICAoZWxlbWVudC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgIT0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpKSkpewogICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQub24KICAgICAgICAgKiBAZGVzYyDnm5HlkKzkuovku7YKICAgICAgICAgKiBAcGFyYW0gZG9tIHtTdHJpbmcgfCBET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZG9tLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KCIgIiksCiAgICAgICAgICAgICAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pLAogICAgICAgICAgICAgICAgdGhhdCA9IG8uZXZlbnQ7CiAgICAgICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgICAgICBpZighdGhhdC5vYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWVsZW1lbnQuX2V2ZW50Q2FjaGVJRCkgewogICAgICAgICAgICAgICAgdmFyIGlkUHJlZml4ID0gImV2ZW50Q2FjaGVJRF8iOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZFByZWZpeCA9IGVsZW1lbnQuaWQgKyAiXyIgKyBpZFByZWZpeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQuX2V2ZW50Q2FjaGVJRCA9IG8udXRpbC5jcmVhdGVVbmlxdWVJRChpZFByZWZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIHRoYXQuX29uKGVsZW1lbnQsIG5hbWVzW2ldLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQuX29uCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBfb246IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICBpZihuYW1lID09ICJvcnRjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cgPyAib3JpZW50YXRpb25jaGFuZ2UiIDogInJlc2l6ZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobmFtZSA9PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIkRPTUNvbnRlbnRMb2FkZWQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsLl9ldmVudENhY2hlSUQsCiAgICAgICAgICAgICAgICB0aGF0ID0gby5ldmVudDsKICAgICAgICAgICAgaWYoIXRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdKSB7CiAgICAgICAgICAgICAgICB0aGF0Lm9ic2VydmVyc1tjYWNoZUlEXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdLnB1c2goewogICAgICAgICAgICAgICAgJ2VsZW1lbnQnOiBlbCwKICAgICAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgICAgICdvYnNlcnZlcic6IGZuLAogICAgICAgICAgICAgICAgJ3VzZUNhcHR1cmUnOiB1c2VDYXB0dXJlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihlbC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgZWwuYXR0YWNoRXZlbnQoJ29uJyArIG5hbWUsIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5zdG9wT2JzZXJ2aW5nRWxlbWVudAogICAgICAgICAqIEBkZXNjIOaKiuaMh+WumuiKgueCueeahOaJgOacieS6i+S7tuebkeWQrOWBnOaOiQogICAgICAgICAqIEBwYXJhbSBkb20ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RvcE9ic2VydmluZ0VsZW1lbnQ6IGZ1bmN0aW9uKGRvbSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pOwogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsZW1lbnQuX2V2ZW50Q2FjaGVJRDsKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRWxlbWVudE9ic2VydmVycyhvLmV2ZW50Lm9ic2VydmVyc1tjYWNoZUlEXSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3BFdmVudE9ic2VydmVyCiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gZXZlbnQge1N0cmluZ30g5oyH5a6a5YGc5o6J55qE5LqL5Lu257G75Z6LCiAgICAgICAgICogQGRlc2Mg5q2k5pa55rOV5Lya5bCG5oyH5a6a6IqC54K55LiK55qE5oyH5a6a5pa55rOV55qE5omA5pyJ5LqL5Lu255uR5ZCs5YGc5o6JIOaFjueUqAogICAgICAgICAqLwogICAgICAgIHN0b3BFdmVudE9ic2VydmVyOiBmdW5jdGlvbihkb20sIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjYWNoZUlEID0gby5nKGRvbSkuX2V2ZW50Q2FjaGVJRCwKICAgICAgICAgICAgICAgIHRoYXQgPSBvLmV2ZW50LAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdOwogICAgICAgICAgICBpZiAoZWxlbWVudE9ic2VydmVycykgewogICAgICAgICAgICAgICAgdmFyIGkgPSBlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZihldmVudCA9PSBlbnRyeS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGVudHJ5LmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkub2JzZXJ2ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS51c2VDYXB0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnMKICAgICAgICAgKiBAZGVzY+WFt+S9k+WBmuS6i+aDheeahOaWueazlQogICAgICAgICAqIEBwYXJhbSBlbGVtZW50T2JzZXJ2ZXJzIHtBcnJheX0g5LiA5aCG5LqL5Lu257yT5a2Y5a+56LGhCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gIGVsZW1lbnRPYnNlcnZlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKCA7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShlbnRyeS5lbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5vYnNlcnZlciwKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkudXNlQ2FwdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC51bgogICAgICAgICAqIEBkZXNjIOWNleWIoOS4gOS4quaMh+WumuS6i+S7tuebkeWQrAogICAgICAgICAqIEBwYXJhbSBkb20ge1N0cmluZyB8IERPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZm4ge0Z1bmN0aW9ufQogICAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIHtCb29sZWFufQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IOi/lOWbnuino+mZpOebkeWQrOaYr+WQpuaIkOWKnwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihkb20sIG5hbWUsIGZuLCB1c2VDYXB0dXJlKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGxlbiA9IG5hbWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGlmKGxlbiA9PSAwKSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gby5nKGRvbSksCiAgICAgICAgICAgICAgICBjYWNoZUlEID0gZWxlbWVudC5fZXZlbnRDYWNoZUlELAogICAgICAgICAgICAgICAgZm91bmRFbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSBvLmV2ZW50Ll91bihlbGVtZW50LCBuYW1lc1tpXSwgZm4sIHVzZUNhcHR1cmUsIGNhY2hlSUQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3VuZEVudHJ5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnVuCiAgICAgICAgICogQGRlc2Mg5Y2V5Yig5LiA5Liq5oyH5a6a5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSDov5Tlm57op6PpmaTnm5HlkKzmmK/lkKbmiJDlip8KICAgICAgICAgKi8KICAgICAgICBfdW46IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSwgaWQpIHsKICAgICAgICAgICAgaWYobmFtZSA9PSAib3J0Y2hhbmdlIikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93ID8gIm9yaWVudGF0aW9uY2hhbmdlIiA6ICJyZXNpemUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5hbWUgPT0gInJlYWR5IikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJET01Db250ZW50TG9hZGVkIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihuYW1lID09ICdrZXlwcmVzcycpIHsKICAgICAgICAgICAgICAgIGlmICggbmF2aWdhdG9yLmFwcFZlcnNpb24ubWF0Y2goL0tvbnF1ZXJvcnxTYWZhcml8S0hUTUwvKSB8fAogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICdrZXlkb3duJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZm91bmRFbnRyeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IG8uZXZlbnQub2JzZXJ2ZXJzW2lkXTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpPTA7CiAgICAgICAgICAgICAgICB3aGlsZSghZm91bmRFbnRyeSAmJiBpIDwgZWxlbWVudE9ic2VydmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVFbnRyeSA9IGVsZW1lbnRPYnNlcnZlcnNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKChjYWNoZUVudHJ5Lm5hbWUgPT0gbmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGNhY2hlRW50cnkub2JzZXJ2ZXIgPT0gZm4pICYmCiAgICAgICAgICAgICAgICAgICAgICAgIChjYWNoZUVudHJ5LnVzZUNhcHR1cmUgPT0gdXNlQ2FwdHVyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLmV2ZW50Lm9ic2VydmVyc1tpZF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZEVudHJ5KSB7CiAgICAgICAgICAgICAgICBpZiAoZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4sIHVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbCAmJiBlbC5kZXRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KCdvbicgKyBuYW1lLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZvdW5kRW50cnk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IHVubG9hZENhY2hlCiAgICAgICAgICogQGRlc2Mg6aG16Z2i6ZSA5q+B55qE5pe25YCZ5biM5pyb5Y+v5Lul6YeK5pS+5o6J5omA5pyJ55uR5ZCsCiAgICAgICAgICovCiAgICAgICAgdW5sb2FkQ2FjaGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoby5ldmVudCAmJiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVJRCBpbiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50T2JzZXJ2ZXJzID0gby5ldmVudC5vYnNlcnZlcnNbY2FjaGVJRF07CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5fcmVtb3ZlRWxlbWVudE9ic2VydmVycy5hcHBseSh0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBbZWxlbWVudE9ic2VydmVyc10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgby5ldmVudC5vYnNlcnZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgby5ldmVudC5vbih3aW5kb3csICJ1bmxvYWQiLCBvLmV2ZW50LnVubG9hZENhY2hlLCBmYWxzZSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5FdmVudHMKICAgICAqIEBkZXNjIOiHquWumuS5ieS6i+S7tuexuwogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDop4Llr5/orqLpmIXkuovku7bnmoTlr7nosaEg5b+F6ZyACiAgICAgKiBAcGFyYW0gZWxlbWVudCB7RE9NRWxlbWVudH0g5LiA5Liq5ZON5bqU5rWP6KeI5Zmo5LqL5Lu255qEZG9tIOmdnuW/hemcgCDlpoLmnpzmjIflrprkuobmraTlgLwg5YiZ6KGo56S66KaB5a+56K+l6IqC54K56L+b6KGM5LiA5qyh5oOo57ud5Lq65a+w55qE5bCB6KOFCiAgICAgKiBAcGFyYW0gZmFsbFRocm91Z2gge0Jvb2xlYW59CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICovCiAgICBvLkV2ZW50cyA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RhbnQgb2N0b3B1cy5FdmVudHMuQlJPV1NFUl9FVkVOVFMKICAgICAgICAgKiBAZGVzYyDluLjop4TnmoTmtY/op4jlmajkuovku7YKICAgICAgICAgKi8KICAgICAgICBCUk9XU0VSX0VWRU5UUzogWwogICAgICAgICAgICAibW91c2VvdmVyIiwgIm1vdXNlb3V0IiwgIm1vdXNlZG93biIsICJtb3VzZXVwIiwgIm1vdXNlbW92ZSIsCiAgICAgICAgICAgICJjbGljayIsICJkYmxjbGljayIsICJyaWdodGNsaWNrIiwgImRibHJpZ2h0Y2xpY2siLAogICAgICAgICAgICAicmVzaXplIiwKICAgICAgICAgICAgImZvY3VzIiwgImJsdXIiLAogICAgICAgICAgICAidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAidG91Y2hlbmQiLAogICAgICAgICAgICAia2V5ZG93biIKICAgICAgICBdLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsaXN0ZW5lcnMKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrOeahGhhc2jooagKICAgICAgICAgKi8KICAgICAgICBsaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9iagogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQGRlc2Mg5LqL5Lu25a+56LGh5omA5bGe55qE5Li75L2TCiAgICAgICAgICovCiAgICAgICAgb2JqOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqIEBkZXNjIOS6i+S7tue7keWumueahOiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudEhhbmRsZXIKICAgICAgICAgKiBAZGVzYyDnu5HlrprlnKjoioLngrnkuIrnmoTop6blj5Hlh73mlbAKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZXZlbnRIYW5kbGVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmYWxsVGhyb3VnaAogICAgICAgICAqIEBkZXNjIOS6i+S7tuaYr+WQpuWFgeiuuOS8oOaSrQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGZhbGxUaHJvdWdoOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9ucwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omA5pyJ6KKr5rOo5YaM55qE5paw55qE6Ieq5a6a5LmJ5LqL5Lu26ZyA6KaB6L+Z5Liq5a6e5L6LCiAgICAgICAgICog6Ieq5a6a5LmJ5LqL5Lu25piv5oyH5LulT3VwZW5nLkV2ZW50cy4q5byA5aS055qE6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICoga2V55Li66Ieq5a6a5LmJ5LqL5Lu25ZCN5aaCdGFwIHZhbHVl5Li66Ieq5a6a5LmJ5LqL5Lu25aaCT3VwZW5nLkV2ZW50cy5UYXAg5Y+q5piv5Li+5Liq5L6L5a2Q5LiN55So5aSq6K6k55yfCiAgICAgICAgICovCiAgICAgICAgZXh0ZW5zaW9uczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9uQ291bnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIGtleeaYr+iHquWumuS5ieS6i+S7tueahGtleSB2YWx1ZeaYr2hhbmRsZXLnmoTkuKrmlbAKICAgICAgICAgKi8KICAgICAgICBleHRlbnNpb25Db3VudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3M6IG9jdG9wdXMuRXZlbnRzLmluaXRpYWxpemUKICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9IOinguWvn+iuoumYheS6i+S7tueahOWvueixoSDlv4XpnIAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOS4gOS4quWTjeW6lOa1j+iniOWZqOS6i+S7tueahGRvbSDpnZ7lv4XpnIAg5aaC5p6c5oyH5a6a5LqG5q2k5YC8IOWImeihqOekuuimgeWvueivpeiKgueCuei/m+ihjOS4gOasoeaDqOe7neS6uuWvsOeahOWwgeijhQogICAgICAgICAqIEBwYXJhbSBmYWxsVGhyb3VnaCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9iaiwgZWwsIGZhbGxUaHJvdWdoLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm9iaiA9IG9iajsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IGZhbGxUaHJvdWdoOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5leHRlbnNpb25Db3VudCA9IHt9OwogICAgICAgICAgICBpZiAoZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hUb0VsZW1lbnQoZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5kZXN0cm95CiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWIm+W7uueahOS6i+S7tuWvueixoeiHquaIkeino+iEsQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZm9yICh2YXIgZSBpbiB0aGlzLmV4dGVuc2lvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5leHRlbnNpb25zW2VdICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbZV0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG51bGw7CiAgICAgICAgICAgIGlmICh0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3BPYnNlcnZpbmdFbGVtZW50KHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub2JqID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZXZlbnRIYW5kbGVyID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYXR0YWNoVG9FbGVtZW50CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGF0dGFjaFRvRWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcE9ic2VydmluZ0VsZW1lbnQodGhpcy5lbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50SGFuZGxlciA9IG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQnJvd3NlckV2ZW50LCB0aGlzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBlbDsKICAgICAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5CUk9XU0VSX0VWRU5UUy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24oZWwsIHRoaXMuQlJPV1NFUl9FVkVOVFNbaV0sIHRoaXMuZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyDkuI3ljrvmjolpZeS4i+S8mjLmjokKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgImRyYWdzdGFydCIsIG8uZXZlbnQuc3RvcCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGhhbmRsZUJyb3dzZXJFdmVudAogICAgICAgICAqIEBkZXNjIOWcqOaMh+WummRvbeiKgueCueeahOaDheWGteS4iyDlsIHoo4Xor6Vkb23op6blj5HnmoRldmVudOWxnuaApwogICAgICAgICAqLwogICAgICAgIGhhbmRsZUJyb3dzZXJFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZXZ0LnR5cGUsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldnQudG91Y2hlczsKICAgICAgICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSkgewogICAgICAgICAgICAgICAgdmFyIHggPSAwLAogICAgICAgICAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICAgICAgICAgIG51bSA9IHRvdWNoZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHRvdWNoLAogICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBudW07ICsraSkgewogICAgICAgICAgICAgICAgICAgIHRvdWNoID0gdG91Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICB4ICs9IHRvdWNoLmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgeSArPSB0b3VjaC5jbGllbnRZOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFggPSB4IC8gbnVtOwogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSB5IC8gbnVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5vbgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDmt7vliqDoh6rlrprkuYnkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvYmoge09iamVjdH0g5LqL5Lu257uR5a6a55qE5a+56LGhIOm7mOiupOS4unRoaXMub2JqZWN0CiAgICAgICAgICogQHBhcmFtIHByaW9yaXR5IHtCb29sZWFuIHwgT2JqZWN0fSDkuLp0cnVl5pe2IOWwhuWinuWKoOeahOWbnuiwg+aJlOWcqOinpuWPkeWbnuiwg+mYn+WIl+eahOmYn+WktCDlj6/ku6XnkIbop6PkuLrkvKrlkIzmraUKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqLCBwcmlvcml0eSkgewogICAgICAgICAgICBpZiAodHlwZSBpbiBvLkV2ZW50cyAmJiAhdGhpcy5leHRlbnNpb25zW3R5cGVdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbdHlwZV0gPSBuZXcgby5FdmVudHNbdHlwZV0odGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZ1bmMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9iaiA9PSBudWxsIHx8IG9iaiA9PSB1bmRlZmluZWQpICB7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdGhpcy5vYmo7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzW3R5cGVdID0gbGlzdGVuZXJzOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uQ291bnRbdHlwZV0gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0ge29iajogb2JqLCBmdW5jOiBmdW5jfTsKICAgICAgICAgICAgICAgIGlmIChwcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UodGhpcy5leHRlbnNpb25Db3VudFt0eXBlXSwgMCwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JpdHkgPT09ICJvYmplY3QiICYmIHByaW9yaXR5LmV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbkNvdW50W3R5cGVdKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnVuCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWPlua2iOiHquWumuS5ieS6i+S7tueahOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g6Kem5Y+R5Zue6LCDCiAgICAgICAgICogQHBhcmFtIG9iaiB7T2JqZWN0fSDpu5jorqToh6rouqsKICAgICAgICAgKi8KICAgICAgICB1bjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgIHsKICAgICAgICAgICAgICAgIG9iaiA9IHRoaXMub2JqOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsIGxlbj1saXN0ZW5lcnMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vYmogPT0gb2JqICYmIGxpc3RlbmVyc1tpXS5mdW5jID09IGZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy50cmlnZ2VyRXZlbnQKICAgICAgICAgKiBAZGVzYyDop6blj5Hkuovku7YKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDop6blj5Hkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZXZ0IHtldmVudH0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGV2dCkgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgIGlmKCFsaXN0ZW5lcnMgfHwgbGlzdGVuZXJzLmxlbmd0aCA9PSAwKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoZXZ0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2dCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dC5vYmogPSB0aGlzLm9iajsKICAgICAgICAgICAgZXZ0LmVsID0gdGhpcy5lbDsKICAgICAgICAgICAgaWYoIWV2dC50eXBlKSB7CiAgICAgICAgICAgICAgICBldnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jbG9uZeS4gOS7vQogICAgICAgICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuc2xpY2UoKTsKICAgICAgICAgICAgdmFyIGNvbnRpbnVlQ2hhaW4sCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgICAgICAgIC8vIGJpbmQgdGhlIGNvbnRleHQgdG8gY2FsbGJhY2sub2JqCiAgICAgICAgICAgICAgICBjb250aW51ZUNoYWluID0gY2FsbGJhY2suZnVuYy5hcHBseShjYWxsYmFjay5vYmosIFtldnRdKTsKICAgICAgICAgICAgICAgIGlmIChjb250aW51ZUNoYWluID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOi/lOWbnuWAvOS4umZhbHNl6KGo56S65Zue6LCD5Yiw5q2k5Li65q2iCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmZhbGxUaHJvdWdoKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZXZ0LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGludWVDaGFpbjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnJlbW92ZQogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDnm7TmjqXmiormjIflrprkuovku7bnsbvlnovnmoTnm5HlkKzlm57osIPnva7nqboKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcnNbdHlwZV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5FdmVudHMucmVnaXN0ZXIKICAgICAgICAgKiBAZGVzYyDmibnph4/lop7liqDkuovku7YKICAgICAgICAgKiBAcGFyYW0gZXZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy51bnJlZ2lzdGVyCiAgICAgICAgICogQGRlc2Mg5om56YeP5Y676Zmk5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGV2cyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAiT2N0b3B1cy5FdmVudHMiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupMKICogYWpheOaWueazlQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKi8KOyhmdW5jdGlvbiAobywgdW5kZWZpbmVkKSB7CgogICAgby5hamF4ID0gby5hamF4IHx8IHt9OwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmFqYXgKICAgICAqIEBkZXNjIGFqYXjor7fmsYLmlrnms5UKICAgICAqLwogICAgby5leHRlbmQoby5hamF4LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERFRkFVTFRfQ09ORklHCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKiB0eXBlIC0ge1N0cmluZ30gR0VULCBQT1NULCBQVVQsIERFTEVURSwgSEVBRCwgT1BUSU9OUy4g6buY6K6k5pivR0VULgogICAgICAgICAqIHVybCAtIHtTdHJpbmd9IOivt+axgueahOWcsOWdgAogICAgICAgICAqIGFzeW5jIC0ge0Jvb2xlYW59IOaYr+WQpuWQjOatpeivt+axgiAg6buY6K6k5pivdHJ1ZS4KICAgICAgICAgKiB1c2VyIC0ge1N0cmluZ30g55So5oi35ZCNCiAgICAgICAgICogcGFzc3dvcmQgLSB7U3RyaW5nfSDlr4bnoIEKICAgICAgICAgKiBkYXRhIC0ge1N0cmluZyB8IE9iamVjdH0gUE9TVOS4jlBVVOaPkOS6pOeahOaVsOaNrgogICAgICAgICAqIGNvbXBsZXRlIC0ge0Z1bmN0aW9ufQogICAgICAgICAqIHN1Y2Nlc3MgLSB7RnVuY3Rpb259CiAgICAgICAgICogZXJyb3IgLSB7RnVuY3Rpb259CiAgICAgICAgICogc2NvcGUgLSB7T2JqZWN0fQogICAgICAgICAqIGJlZm9yZVNlbmQgICAtICAge0Z1bmN0aW9ufSDor7fmsYLlj5Hlh7rliY3osIPnlKgKICAgICAgICAgKiB0aW1lb3V0ICAtICAge051bWJlcn0g5bu25pe2CiAgICAgICAgICovCiAgICAgICAgREVGQVVMVF9DT05GSUc6IHsKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICB1c2VyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHBhc3N3b3JkOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGNvbXBsZXRlOiBvLnV0aWwuZW1wdHksCiAgICAgICAgICAgIHN1Y2Nlc3M6IG51bGwsCiAgICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgICBzY29wZTogbnVsbCwKICAgICAgICAgICAgYmVmb3JlU2VuZDogbnVsbCwKICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgY3Jvc3NEb21haW46IGZhbHNlCiAgICAgICAgfSwKCiAgICAgICAganNvbnBJRDogMCwKCiAgICAgICAganNvblR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICBodG1sVHlwZTogJ3RleHQvaHRtbCcsCgogICAgICAgIFNDUklQVF9SRUdFWDogLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCiAgICAgICAgU0NSSVBUX1RZUEVfUkVHRVg6IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL2phdmFzY3JpcHQvaSwKICAgICAgICBYTUxfVFlQRV9SRUdFWDogL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwveG1sL2ksCiAgICAgICAgVVJMX1NQTElUX1JFR0VYOiAvKFteOl0qOilcL1wvKFteOl0qOj9bXkBdKkApPyhbXjpcL1w/XSopOj8oW15cL1w/XSopLywKICAgICAgICBCTEFOS19SRUdFWDogL15ccyokLywKICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCcsCiAgICAgICAgICAgIGpzb246ICAgdGhpcy5qc29uVHlwZSwKICAgICAgICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAgICAgIGh0bWw6ICAgdGhpcy5odG1sVHlwZSwKICAgICAgICAgICAgdGV4dDogICAndGV4dC9wbGFpbicKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB4aHIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgeGhyOiBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG1pbWVUb0RhdGFUeXBlCiAgICAgICAgICovCiAgICAgICAgbWltZVRvRGF0YVR5cGU6IGZ1bmN0aW9uKG1pbWUpIHsKICAgICAgICAgICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IHRoaXMuaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICAgICAgICAgICAgbWltZSA9PSB0aGlzLmpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLlNDUklQVF9UWVBFX1JFR0VYLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuWE1MX1RZUEVfUkVHRVgudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICogQGRlc2Mg5Y+R5Ye66K+35rGCIOWQhOenjQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOmFjee9rumhuQogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgY29uZmlnID0gby51dGlsLmFwcGx5RGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdENvbmZpZyksCiAgICAgICAgICAgICAgICBkYXRhVHlwZSA9IGNvbmZpZy5kYXRhVHlwZSwKICAgICAgICAgICAgICAgIHVybCA9IGNvbmZpZy51cmwsCiAgICAgICAgICAgICAgICBkYXRhID0gY29uZmlnLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgfHwge30sCiAgICAgICAgICAgICAgICB1cmxvYmogPSBvLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgICAgICAgIGlmKGNvbmZpZy50eXBlID09ICJqc29ucCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFqYXguYWpheEpTT05QKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFjb25maWcuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5jcm9zc0RvbWFpbiA9IHVybG9iai5ob3N0ICE9IHdpbmRvdy5sb2NhdGlvbi5ob3N0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gZmFsc2UsCiAgICAgICAgICAgICAgICBoZWFkZXJLZXk7CiAgICAgICAgICAgIGZvcihoZWFkZXJLZXkgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlcktleS50b0xvd2VyQ2FzZSgpID09PSAneC1yZXF1ZXN0ZWQtd2l0aCcpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID09PSBmYWxzZSB8fCAhY29uZmlnLmNyb3NzRG9tYWluKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10gPSAnWE1MSHR0cFJlcXVlc3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgPSAgby51dGlsLmdldFBhcmFtZXRlclN0cmluZyhkYXRhIHx8IHt9KTsKICAgICAgICAgICAgaWYoY29uZmlnLnR5cGUgIT0gIlBPU1QiKSB7CiAgICAgICAgICAgICAgICBjb25maWcudXJsID0gby51dGlsLnVybEFwcGVuZCh1cmwsIGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaW1lID0gdGhpcy5hY2NlcHRzW2RhdGFUeXBlXSwKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzID0ge30sCiAgICAgICAgICAgICAgICB4aHIgPSB0aGlzLnhocigpLCBhYm9ydFRpbWVvdXQ7CiAgICAgICAgICAgIGlmKG1pbWUpIHsKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWU7CiAgICAgICAgICAgICAgICBpZihtaW1lLmluZGV4T2YoJywnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgbWltZSA9IG1pbWUuc3BsaXQoJywnLCAyKVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVhZGVycyA9IG8uZXh0ZW5kKGJhc2VIZWFkZXJzLCBoZWFkZXJzIHx8IHt9KTsKICAgICAgICAgICAgeGhyLm9wZW4oCiAgICAgICAgICAgICAgICBjb25maWcudHlwZSwgY29uZmlnLnVybCwgY29uZmlnLmFzeW5jLCBjb25maWcudXNlciwgY29uZmlnLnBhc3N3b3JkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWJvcnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnJ1bkNhbGxiYWNrcygKICAgICAgICAgICAgICAgICAgICAgICAge3JlcXVlc3Q6IHhociwgY29uZmlnOiBjb25maWcsIHJlcXVlc3RVcmw6IGNvbmZpZy51cmx9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoY29uZmlnLmFzeW5jID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgeGhyLnNlbmQoZGF0YSA/IGRhdGEgOiBudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYoeGhyLnJlYWR5U3RhdGUgIT09IDApIHsgLy8gVzNDOiAwLVVOU0VOVAogICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2VuZChkYXRhID8gZGF0YSA6IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNvbmZpZy50aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmVycm9yLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5lcnJvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoeGhyLCAidGltZW91dCIpOwogICAgICAgICAgICAgICAgfSwgY29uZmlnLnRpbWVvdXQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcnVuQ2FsbGJhY2tzCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBydW5DYWxsYmFja3M6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvcHRpb25zLnJlcXVlc3Q7CiAgICAgICAgICAgIHZhciBjb25maWcgPSBvcHRpb25zLmNvbmZpZzsKICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmNvbXBsZXRlLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgIGNvbmZpZy5jb21wbGV0ZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3M7CiAgICAgICAgICAgIGlmKGNvbmZpZy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5zdWNjZXNzLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3VjY2VzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFpbHVyZTsKICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICBmYWlsdXJlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5lcnJvciwgY29uZmlnLnNjb3BlKSA6CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlKHJlcXVlc3QpOwogICAgICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlLAogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBjb25maWcuZGF0YVR5cGU7CiAgICAgICAgICAgIGlmKChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApIHx8IHJlcXVlc3Quc3RhdHVzID09IDMwNCB8fAogICAgICAgICAgICAgICAgKHJlcXVlc3Quc3RhdHVzID09IDAgJiYgby51dGlsLmNyZWF0ZVVybE9iamVjdChjb25maWcudXJsKS5wcm90b2NvbCA9PSAiZmlsZToiKSkgewogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCB0aGlzLm1pbWVUb0RhdGFUeXBlKHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoJ2NvbnRlbnQtdHlwZScpKTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlcXVlc3QucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoZGF0YVR5cGUgPT0gJ3htbCcpICByZXN1bHQgPSByZXF1ZXN0LnJlc3BvbnNlWE1MCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZihkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IHRoaXMuQkxBTktfUkVHRVgudGVzdChyZXN1bHQpID8gbnVsbCA6IEpTT04ucGFyc2UocmVzdWx0KQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBlcnJvciA9IGUgfQogICAgICAgICAgICAgICAgb3B0aW9ucy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICBpZihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhyZXF1ZXN0LCByZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYoZmFpbHVyZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWx1cmUocmVxdWVzdCwgImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguZ2V0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hZ2V06K+35rGCCiAgICAgICAgICogQHBhcmFtIGNvbmZpZyB7T2JqZWN0fQogICAgICAgICAqIEBwYXJhbSBjb25maWcudXJsIHtTdHJpbmd9IOivt+axguWcsOWdgAogICAgICAgICAqIEBwYXJhbSBjb25maWcuYXN5bmMge0Jvb2xlYW59IOWQjOW8guatpQogICAgICAgICAqIEBwYXJhbSBjb25maWcuY29tcGxldGUge0Z1bmN0aW9ufSDor7fmsYLnu5PmnZ/nmoRjYWxsYmFjawogICAgICAgICAqIEBwYXJhbSBjb25maWcuc3VjY2VzcyB7RnVuY3Rpb259IOivt+axguaIkOWKn+eahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5lcnJvciB7RnVuY3Rpb259IOivt+axguWksei0peeahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy50aW1lb3V0IHtOdW1iZXJ9IOi2heaXtuaXtumXtAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZ2V0IjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJHRVQifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5wb3N0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hcG9zdOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5kYXRhIHtPYmplY3R9IOaVsOaNrgogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwb3N0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnID0gby5leHRlbmQoY29uZmlnLCB7dHlwZTogIlBPU1QifSk7CiAgICAgICAgICAgIC8vIHNldCBjb250ZW50IHR5cGUgdG8gYXBwbGljYXRpb24veG1sIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0CiAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgPyBjb25maWcuaGVhZGVycyA6IHt9OwogICAgICAgICAgICBpZighKCJDT05URU5ULVRZUEUiIGluIG8udXRpbC51cHBlckNhc2VPYmplY3QoY29uZmlnLmhlYWRlcnMpKSkgewogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL3htbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4LnB1dAogICAgICAgICAqIEBkZXNjIOWPkeadoXB1dOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMcG9zdAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiUFVUIn0pOwogICAgICAgICAgICAvLyBzZXQgY29udGVudCB0eXBlIHRvIGFwcGxpY2F0aW9uL3htbCBpZiBpdCBpc24ndCBhbHJlYWR5IHNldAogICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzID8gY29uZmlnLmhlYWRlcnMgOiB7fTsKICAgICAgICAgICAgaWYoISgiQ09OVEVOVC1UWVBFIiBpbiBvLnV0aWwudXBwZXJDYXNlT2JqZWN0KGNvbmZpZy5oZWFkZXJzKSkpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5kZWxldGUKICAgICAgICAgKiBAZGVzYyDlj5HmnaFkZWxldGXor7fmsYIKICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtPYmplY3R9IOWQjGdldAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZGVsZXRlIjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJERUxFVEUifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5oZWFkCiAgICAgICAgICogQGRlc2Mg5Y+R5p2haGVhZOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGhlYWQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiSEVBRCJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4Lm9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDlj5HmnaFvcHRpb25z6K+35rGCLgogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIG9wdGlvbnM6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiT1BUSU9OUyJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIF9jcmVhdGVTY3JpcHRUYWcKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlU2NyaXB0VGFnOiBmdW5jdGlvbihzY3IsIHVybCwgY2hhcnNldCkgewogICAgICAgICAgICBzY3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwogICAgICAgICAgICBjaGFyc2V0ICYmIHNjci5zZXRBdHRyaWJ1dGUoJ2NoYXJzZXQnLCBjaGFyc2V0KTsKICAgICAgICAgICAgc2NyLnNldEF0dHJpYnV0ZSgnc3JjJywgdXJsKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3IpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQE1ldGhvZCBfcmVtb3ZlU2NyaXB0VGFnCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZVNjcmlwdFRhZzogZnVuY3Rpb24oc2NyKSB7CiAgICAgICAgICAgIGlmIChzY3IuY2xlYXJBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBzY3IuY2xlYXJBdHRyaWJ1dGVzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIHNjcikgewogICAgICAgICAgICAgICAgICAgIGlmIChzY3IuaGFzT3duUHJvcGVydHkoYXR0cikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHNjclthdHRyXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2NyICYmIHNjci5wYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgIHNjci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2NyID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIHNjcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguYWpheEpTT05QCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy51cmwge1N0cmluZ30g6K+35rGC5Zyw5Z2ACiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuY29tcGxldGUge0Z1bmN0aW9ufSDmiJDlip/lm57osIMKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5lcnJvciB7RnVuY3Rpb259IOWksei0peWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQge051bWJlcn0g6LaF5pe25pe26ZW/CiAgICAgICAgICovCiAgICAgICAgYWpheEpTT05QOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgcHJlZml4ID0gImpzb25wIiwKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvLnV0aWwuYXBwbHlEZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0Q29uZmlnKSwKICAgICAgICAgICAgICAgIGNoYXJzZXQgPSBvcHRpb25zWydjaGFyc2V0J10sCiAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uc1siZGF0YSJdIHx8IHt9LAogICAgICAgICAgICAgICAgdGltZU91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXSB8fCAwLAogICAgICAgICAgICAgICAgdGltZXIsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHVybCA9IG9wdGlvbnNbInVybCJdLAogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zWyJzdWNjZXNzIl0gfHwgb3B0aW9uc1siY29tcGxldGUiXSwKICAgICAgICAgICAgICAgIGpzb25wTmFtZSA9IG9wdGlvbnNbImpzb25wIl0gfHwgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgIGVycm9yID0gb3B0aW9uc1siZXJyb3IiXSB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKG8udXRpbC5pc1N0cmluZyhjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSA9IGNhbGxiYWNrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tOYW1lID0gcHJlZml4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjE0NzQ4MzY0OCkudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBnZXRDYWxsQmFjaygwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aW1lT3V0ID4gMCl7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZ2V0Q2FsbEJhY2soMSksIHRpbWVPdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZW1vdmVTY3JpcHRUYWcoc2NyaXB0KTsKICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVybCA9IG8udXRpbC51cmxBcHBlbmQoby51dGlsLnVybEFwcGVuZCh1cmwsCiAgICAgICAgICAgICAgICBvLnV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nKGRhdGEgfHwge30pKSwganNvbnBOYW1lICsgIj0iICsgY2FsbGJhY2tOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlU2NyaXB0VGFnKHNjcmlwdCwgdXJsLCBjaGFyc2V0KTsKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbEJhY2sob25UaW1lT3V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG9uVGltZU91dCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkod2luZG93LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gby51dGlsLmVtcHR5OwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge30KICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVtb3ZlU2NyaXB0VGFnKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zWyJ4aHIiXTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlR3ZWVuCiAgICAgKiBAZGVzYyDliqjnlLvnsbvvvIzlj6/ku6XpgJrov4fmlLnlj5jlsZ7mgKfjgIHotbflp4vlgLzjgIHnu5PmnZ/lgLznrYnphY3nva7orqnmjIflrproioLngrnlrozmiJDliqjmgIHov4fmuKEKICAgICAqIOazqOaEj++8mueUseS6juaDheWGtei/h+S6juWkjeadgiDlh6HmmK/mlLnlj5jlsZ7mgKfmmK90cmFuc2Zvcm3lsZ7mgKfmiJbljIXlkKt0cmFuc2Zvcm3lsZ7mgKfnmoTliqjnlLsg5Y+q6IO95oyJ54WnY3NzM+eahOW9ouW8j+i/m+ihjCDpu5jorqTliqjnlLvnsbvlnovmmK9lYXNlLW91dAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmjIflrprlrozmiJDliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZyB8IEFycmF5fSDlvoXmlLnlj5jnmoTlsZ7mgKcg5Y+v5Li65aSa5YC8CiAgICAgKiBAcGFyYW0gc3RhcnR2IHtTdHJpbmcgfCBOdW1iZXIgfCBBcnJheX0g6LW35aeL5YC8IOWmguS4uuaVsOe7hCDlv4XpobvkuI7mlLnlj5jlsZ7mgKfkuIDkuIDlr7nlupQg5ZCm5YiZ5Lya5oqb6ZSZCiAgICAgKiBAcGFyYW0gZW5kdiB7U3RyaW5nIHwgTnVtYmVyIHwgQXJyYXl9IOe7k+adn+WAvCDlhbfkvZPopoHmsYLlkIzotbflp4vlgLwKICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7TnVtYmVyfSDliqjljJbov4fmuKHnmoTml7bpl7Qg5Y2V5L2N5Li656eSL3MKICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Yqo55S757uT5p2f55qE5Zue6LCD5Ye95pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fSDlhbbku5bphY3nva7pobkg5Y+v5Li656m6IOm7mOiupOS4umpz5Yqo55S7IOWKqOeUu+exu+Wei+S4uiJvY3RvcHVzLmVhc2luZy4iCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5lYXNlIHtTdHJpbmcgfCBPYmplY3R9IOWKqOeUu+exuyDlpoLmnpzkuLrlrZfnrKbkuLIg5YiZ6YeH55SoY3NzM+eahHRyYW5zaXRpb27liqjnlLsg5ZCm5YiZ6ZyA6KaB5Lyg5YWlIm9jdG9wdXMuZWFzaW5nLlhYWCLnmoTliqjnlLvlr7nosaEKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgbmV3dHdlZW4gPSBuZXcgVHdlZW4oZWwsIFsid2lkdGgiLCAid2Via2l0VHJhbnNmb3JtIl0sIFs2NCwgInRyYW5zbGF0ZTNkKDAsIDAsIDApIl0sCiAgICAgKiAgWzEyOCwgInRyYW5zbGF0ZTNkKDMwcHgsIDAsIDApIl0sIC40LCBmdW5jdGlvbigpIHsKICAgICAqICAgICBjb25zb2xlLmxvZyhBbmltYXRpb24gZmluaXNoZWQhKTsKICAgICAqIH0sIHsKICAgICAqICAgICBlYXNlOiAiZWFzZS1vdXQiIHwgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAqIH0pOwogICAgICogQHRocm93CiAgICAgKiBAcmV0dXJuIHtvY3RvcHVzLlR3ZWVufQogICAgICovCiAgICBvLlR3ZWVuID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcm9wZXJ0eU5hbWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByb3BlcnR5TmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGZ1bmMKICAgICAgICAgKiB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZnVuYzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZWFzZQogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmVlZFBhcmFtcwogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBuZWVkUGFyYW1zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYXJhbXNEaWNzCiAgICAgICAgICoge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHBhcmFtc0RpY3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJlcXVlc3RBbmltYXRpb24KICAgICAgICAgKiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3RBbmltYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbG9yTGlzdAogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb2xvckxpc3Q6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHN0b3BSZXF1ZXN0CiAgICAgICAgICoge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc3RvcFJlcXVlc3Q6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZlY3RvcgogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgdmVjdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByZWZpeDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRQcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGV2ZW50UHJlZml4OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc09mZkNzcwogICAgICAgICAqIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzT2ZmQ3NzOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kRXZlbnQKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZEV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RyYW5zZm9ybQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzVHJhbnNmb3JtOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRUaW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGVsYXkKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGRlbGF5OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlR3ZWVuCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHBybywgc3RhcnR2LCBlbmR2LCBkdXJhdGlvbiwgZnVuYywgb3B0aW9ucykgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbCkpICAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBhIG5vZGUhIik7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmVsID0gZWw7CiAgICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gcHJvOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBzdGFydHY7CiAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBlbmR2OwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB0aGlzLm5lZWRQYXJhbXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb2xvckxpc3QgPSBbXTsKICAgICAgICAgICAgdGhpcy5wYXJhbXNEaWNzID0gWyJ3aWR0aCIsICJoZWlnaHQiLCAibGVmdCIsICJ0b3AiLCAicmlnaHQiLCAiYm90dG9tIiwgInBhZGRpbmciLAogICAgICAgICAgICAgICAgInBhZGRpbmctbGVmdCIsICJwYWRkaW5nLXRvcCIsICJwYWRkaW5nLWJvdHRvbSIsICJwYWRkaW5nLXJpZ2h0IiwgIm1hcmdpbiIsCiAgICAgICAgICAgICAgICAibWFyZ2luLWxlZnQiLCAibWFyZ2luLXRvcCIsICJtYXJnaW4tYm90dG9tIiwgIm1hcmdpbi1yaWdodCIsICJmb250LXNpemUiLAogICAgICAgICAgICAgICAgImJhY2tncm91bmQtcG9zaXRpb24iLCAibGluZS1oZWlnaHQiLCAiYm9yZGVyLXdpZHRoIiwgImJvcmRlci1sZWZ0LXdpZHRoIiwKICAgICAgICAgICAgICAgICJib3JkZXItdG9wLXdpZHRoIiwgImJvcmRlci1yaWdodC13aWR0aCIsICJib3JkZXItYm90dG9tLXdpZHRoIl07CiAgICAgICAgICAgIHZhciBsZWdhbGl0eSA9IHRoaXMuY2hlY2soKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8ICh0aGlzLmlzVHJhbnNmb3JtID8gImVhc2Utb3V0IiA6IG8uZWFzaW5nLmxpbmVhci5lYXNlT3V0KTsKICAgICAgICAgICAgdGhpcy5kZWxheSA9IHRoaXMuZGVsYXkgfHwgMDsKICAgICAgICAgICAgaWYoIWxlZ2FsaXR5KSB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgYXJndW1lbnRzISIpOwogICAgICAgICAgICBpZihvLnV0aWwuaXNPYmplY3QodGhpcy5lYXNlKSAmJiAhdGhpcy5pc1RyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uID0gby51dGlsLnJlcXVlc3RBbmltYXRpb247CiAgICAgICAgICAgICAgICBpZih0aGlzLmRlbGF5ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlV2l0aEpzKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5kZWxheSAqIDEwMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVXaXRoSnMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmVjdG9yID0geyIiIDogIiIsIFdlYmtpdDogIndlYmtpdCIsIE1vejogIiIsIE86ICJvIiwgbXM6ICJNUyJ9OwogICAgICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMudmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuc3R5bGVbayArICJUcmFuc2l0aW9uUHJvcGVydHkiXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJlZml4ID0gJy0nICsgay50b0xvd2VyQ2FzZSgpICsgJy0nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRQcmVmaXggPSB0aGlzLnZlY3RvcltrXQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmlzT2ZmQ3NzID0gKHRoaXMuZXZlbnRQcmVmaXggPT0gbnVsbCAmJiB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9PSB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgdGhpcy5lbmRFdmVudCA9IHRoaXMuZXZlbnRQcmVmaXggPyB0aGlzLmV2ZW50UHJlZml4ICsgIlRyYW5zaXRpb25FbmQiIDogInRyYW5zaXRpb25FbmQiOwogICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlV2l0aENzcygpOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVjawogICAgICAgICAqIEBkZXNjIOajgOafpeWPguaVsOaYr+WQpm9rCiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBvLnV0aWwuaXNBcnJheSh0aGlzLnByb3BlcnR5TmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNBcnJheSh0aGlzLnN0YXJ0VmFsdWUpICYmIG8udXRpbC5pc0FycmF5KHRoaXMuZW5kVmFsdWUpLAogICAgICAgICAgICAgICAgcGFzcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgX3Bhc3M7CiAgICAgICAgICAgIGlmKCFxdWV1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IFt0aGlzLnByb3BlcnR5TmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBbdGhpcy5zdGFydFZhbHVlXTsKICAgICAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBbdGhpcy5lbmRWYWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmFtc01hdGNoID0gKHRoaXMucHJvcGVydHlOYW1lLmxlbmd0aCA9PSB0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoKSAmJgogICAgICAgICAgICAgICAgICAgICh0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoID09IHRoaXMuZW5kVmFsdWUubGVuZ3RoKTsKICAgICAgICAgICAgaWYocGFyYW1zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIHZhciB1bk9rID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgICAgIF9wYXNzID0gdGhpcy5jaGVja1ZhbHVlKHRoaXMucHJvcGVydHlOYW1lW2ldLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIGlmKCFfcGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB1bk9rID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZWVkUGFyYW1zW2ldID0gdGhpcy5wYXJhbXNEaWNzLmluZGV4T2YodGhpcy5wcm9wZXJ0eU5hbWVbaV0pICE9IC0xOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbG9yID0gbmV3IFJlZ0V4cCgiL2NvbG9yfGJhY2tncm91bmQtY29sb3J8Ym9yZGVyLWNvbG9yL2kiKS50ZXN0KHRoaXMucHJvcGVydHlOYW1lW2ldKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9yTGlzdFtpXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNDb2xvcjogaXNDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRWYWx1ZTogaXNDb2xvciA/IHRoaXMuZ2V0Q29sb3IodGhpcy5zdGFydFZhbHVlW2ldKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZFZhbHVlOiBpc0NvbG9yID8gdGhpcy5nZXRDb2xvcih0aGlzLmVuZFZhbHVlW2ldKSA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFzcyA9ICF1bk9rICYmICFpc05hTih0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tWYWx1ZQogICAgICAgICAqIEBkZXNjIOmqjOivgeWAvOaYr+WQpuWQiOazlQogICAgICAgICAqLwogICAgICAgIGNoZWNrVmFsdWU6IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSwgc3RhcnRWYWx1ZSwgZW5kVmFsdWUpewogICAgICAgICAgICB2YXIgcGFzcyA9IGZhbHNlOwogICAgICAgICAgICBpZigvdHJhbnNmb3JtL2kudGVzdChwcm9wZXJ0eU5hbWUpIHx8IC8td2Via2l0LS9pLnRlc3QocHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICAgICAgdGhpcy5pc1RyYW5zZm9ybSA9IHRydWU7CiAgICAgICAgICAgICAgICBwYXNzID0gISFzdGFydFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhzdGFydFZhbHVlKSAmJiAhIWVuZFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhlbmRWYWx1ZSkKICAgICAgICAgICAgfSBlbHNlIGlmKHByb3BlcnR5TmFtZS5pbmRleE9mKCdjb2xvcicpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gLyheXHMqKXwoXHMqJCkvZzsKICAgICAgICAgICAgICAgIHBhc3MgPSAhIXN0YXJ0VmFsdWUgJiYgc3RhcnRWYWx1ZS5yZXBsYWNlKHJlZywgJycpICE9ICcnICYmICEhIGVuZFZhbHVlICYmIGVuZFZhbHVlLnJlcGxhY2UocmVnLCAnJykgIT0gJycKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSAhaXNOYU4oc3RhcnRWYWx1ZSkgJiYgIWlzTmFOKGVuZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29sb3IKICAgICAgICAgKi8KICAgICAgICBnZXRDb2xvcjogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8oXlxzKil8KFxzKiQpL2csICcnKTsKICAgICAgICAgICAgdmFyIHJnYlJlZyA9IC9eXHMqcmdiXHMqXChccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXClccyokL2k7CiAgICAgICAgICAgIHZhciBzaXhSZWdBID0gL15ccypcI1thLXpBLVowLTldezN9XHMqJC87CiAgICAgICAgICAgIHZhciBzaXhSZWdCID0gL15ccypcI1thLXpBLVowLTldezZ9XHMqJC87CiAgICAgICAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgICAgICAgaWYocmdiUmVnLnRlc3Qoc3RyKSl7IC8vIOS7pVJHQuW9ouW8j+aMh+WumueahOminOiJsgogICAgICAgICAgICAgICAgdmFyIG5TdHIgPSBzdHIuc3BsaXQoJygnKVsxXS5zcGxpdCgnKScpWzBdLnNwbGl0KCcsJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IG5TdHIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goblN0cltpXSAvIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzaXhSZWdCLnRlc3Qoc3RyKSkgeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsiAoNuS9jSkKICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLnJlcGxhY2UoJyMnLCAnJykubWF0Y2goLyhcd3xcZCl7Mn0vZyk7CgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCA7IGkgPCBtLmxlbmd0aDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyBtW2ldKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2l4UmVnQS50ZXN0KHN0cikpeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsigz5L2NKQogICAgICAgICAgICAgICAgdmFyIGNBcnIgPSBzdHIucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IGNBcnIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyAoY0FycltpXSArIGNBcnJbaV0pKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVXaXRoSnMKICAgICAgICAgKiDmiafooYwKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlV2l0aEpzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdG9wUmVxdWVzdCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBjdXJUaW1lID0gMDsKICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmVsIHx8IHRoYXQuc3RvcFJlcXVlc3QpewogICAgICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuZ2V0U2V0VmFsdWUoY3VyVGltZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYoY3VyVGltZSA+PSB0aGF0LmR1cmF0aW9uICogMTAwMCl7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nZXRTZXRWYWx1ZShudWxsLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhhdC5mdW5jICYmIHRoYXQuZnVuYygpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1clRpbWUgKz0gMTY7CiAgICAgICAgICAgICAgICB0aGF0LnJlcXVlc3RBbmltYXRpb24oYW5pbWF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uKGFuaW1hdGUsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleGVjdXRlV2l0aENzcwogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGVXaXRoQ3NzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc09mZkNzcykgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHZhciBwcm9hcnIgPSB0aGlzLnByb3BlcnR5TmFtZSwKICAgICAgICAgICAgICAgIGxlbiA9IHByb2Fyci5sZW5ndGgsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25BcnIgPSBbXSwKICAgICAgICAgICAgICAgIF9wcmVmaXggPSB0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVtfcHJlZml4XSA9ICIiOwogICAgICAgICAgICBvLnV0aWwuZWFjaChwcm9hcnIsIGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgICAgICB0aGF0LmVsLnN0eWxlW2l0ZW1dID0gdGhhdC5nZXRWYWx1ZSh0aGF0LnN0YXJ0VmFsdWVbaW5kZXhdLCBpbmRleCk7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uQXJyLnB1c2goaXRlbSArICIgIiArIHRoYXQuZHVyYXRpb24gKyAicyAiICsgdGhhdC5lYXNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgdGhpcy5lbmRFdmVudCwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkVuZEV2ZW50Q29tcGxldGVkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGVbX3ByZWZpeF0gPSB0cmFuc2l0aW9uQXJyLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGF0OwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcig7IHogPCBsZW47IHorKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWUgPSBfdGhpcy5lbmRWYWx1ZVt6XTsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZWwuc3R5bGVbcHJvYXJyW3pdXSA9IF90aGlzLmdldFZhbHVlKGN1clZhbHVlLCB6KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xlYXJFdmVudFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRUaW1lciA9IHNldFRpbWVvdXQoby51dGlsLmJpbmQoX3RoaXMub25GaW5pc2gsIF90aGlzKSwgX3RoaXMuZHVyYXRpb24gKiAxMDAwKTsKCiAgICAgICAgICAgICAgICB9LCB0aGF0LmRlbGF5ICogMTAwMCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjbGVhckV2ZW50VGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhckV2ZW50VGltZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5ldmVudFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRUaW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25GaW5pc2gKICAgICAgICAgKi8KICAgICAgICBvbkZpbmlzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW3RoaXMucHJlZml4ICsgInRyYW5zaXRpb24iXSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZnVuYyAmJiB0aGlzLmZ1bmMoKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uRW5kRXZlbnRDb21wbGV0ZWQKICAgICAgICAgKi8KICAgICAgICBvbkVuZEV2ZW50Q29tcGxldGVkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmKGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jbGVhckV2ZW50VGltZXIoKTsKICAgICAgICAgICAgdGhpcy5vbkZpbmlzaCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5Ud2Vlbi5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5o6J5Yqo55S7IOW5tuino+iEseiHquaIkQogICAgICAgICAqLwogICAgICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmVuZEV2ZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFJlcXVlc3QgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mdW5jICYmIHRoaXMuZnVuYygpOwogICAgICAgICAgICAgICAgaWYodGhpcy5lbCkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVt0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIl0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuVHdlZW4uZGVzdHJveQogICAgICAgICAqIEBkZXNjIOeci+WQjeWtl+WwseefpemBk+W5suWYm+eahAogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0U2V0VmFsdWUKICAgICAgICAgKiBAZGVzYyDlj5blh7rlvZPliY3nmoTlsZ7mgKflgLwKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIGN1clRpbWUgIC0gICB7TnVtYmVyfQogICAgICAgICAqIGlzRW5kICAgIC0gICB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBnZXRTZXRWYWx1ZTogZnVuY3Rpb24oY3VyVGltZSwgaXNFbmQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlSW5mbyA9IFtdLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoOwogICAgICAgICAgICBmb3IoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWU7CiAgICAgICAgICAgICAgICBpZih0aGlzLmNvbG9yTGlzdFtpXS5pc0NvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0UlIgPSB0aGlzLmNvbG9yTGlzdFtpXS5zdGFydFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydEdHID0gdGhpcy5jb2xvckxpc3RbaV0uc3RhcnRWYWx1ZVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLnN0YXJ0VmFsdWVbMl0sCgogICAgICAgICAgICAgICAgICAgICAgICBlbmRSUiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRHRyA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzJdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcnIsIGdnLCBiYjsKICAgICAgICAgICAgICAgICAgICBpZihpc0VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICByciA9IGVuZFJSOwogICAgICAgICAgICAgICAgICAgICAgICBnZyA9IGVuZEdHOwogICAgICAgICAgICAgICAgICAgICAgICBiYiA9IGVuZEJCOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJyID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydFJSLCBlbmRSUiAtIHN0YXJ0UlIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdnID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEdHLCBlbmRHRyAtIHN0YXJ0R0csIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJiID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEJCLCBlbmRCQiAtIHN0YXJ0QkIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gJ3JnYignICsgcnIgKyAnLCAnICsgZ2cgKyAnLCAnICsgYmIgKyAnKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKGlzRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gdGhpcy5lbmRWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA9IHRoaXMuZWFzZShjdXJUaW1lLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0gLSB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZHVyYXRpb24gKiAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZUluZm8ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiB0aGlzLnByb3BlcnR5TmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA6IGN1clZhbHVlLAogICAgICAgICAgICAgICAgICAgIGlzQ29sb3I6IHRoaXMuY29sb3JMaXN0W2ldLmlzQ29sb3IKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodmFsdWVJbmZvKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFZhbHVlCiAgICAgICAgICogQGRlc2Mg5pS55Y+Y5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlSW5mbykgewogICAgICAgICAgICB2YXIgc2V0SW5mbyA9IHt9LAogICAgICAgICAgICAgICAgbmVlZFNldCA9IGZhbHNlLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdmFsdWVJbmZvLmxlbmd0aDsKICAgICAgICAgICAgZm9yKDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHZhbHVlSW5mb1tpXS5wcm9wZXJ0eU5hbWUsCiAgICAgICAgICAgICAgICAgICAgY3VyVmFsdWUgPSB2YWx1ZUluZm9baV0uY3VyVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgaXNDb2xvciA9IHZhbHVlSW5mb1tpXS5pc0NvbG9yOwogICAgICAgICAgICAgICAgaWYocHJvcGVydHlOYW1lID09ICdzY3JvbGxMZWZ0JyB8fCBwcm9wZXJ0eU5hbWUgPT0gJ3Njcm9sbFRvcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsW3Byb3BlcnR5TmFtZV0gPSB0aGlzLmdldFZhbHVlKGN1clZhbHVlLCBpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SW5mb1twcm9wZXJ0eU5hbWVdID0gaXNDb2xvciA/IGN1clZhbHVlIDogdGhpcy5nZXRWYWx1ZShjdXJWYWx1ZSwgaSk7CiAgICAgICAgICAgICAgICAgICAgbmVlZFNldCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKG5lZWRTZXQpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIHNldEluZm8pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2tleV0gPSBzZXRJbmZvW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgICAgLSAgIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG9yZGVyICAgIC0gICB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgb3JkZXIpewogICAgICAgICAgICByZXR1cm4gdGhpcy5uZWVkUGFyYW1zW29yZGVyXSA/IHZhbHVlICsgJ3B4JyA6IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlR3ZWVuIgogICAgfSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5TdGVwVHdlZW4KICAgICAqLwogICAgby5TdGVwVHdlZW4gPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHR5cGUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaViOaenOS8mOWFiOaIluaAp+iDveS8mOWFiAogICAgICAgICAqLwogICAgICAgIHR5cGU6ICJub3JtYWwiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlYXNlCiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIEBkZXNjIOS4jm9jdG9wdXMudHdlZW7kuI3lkIwg6L+Z6YeM55qEZHVyYXRpb27ooajnpLrliqjnlLvmiafooYznmoTmrKHmlbAKICAgICAgICAgKi8KICAgICAgICBkdXJhdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZnVuYwogICAgICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmdW5jOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb3VudAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwbGF5aW5nCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWcqOWKqOeUuwogICAgICAgICAqLwogICAgICAgIHBsYXlpbmc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8IG8uZWFzaW5nLmV4cG8uZWFzZU91dDsKICAgICAgICAgICAgdGhpcy5zdGFydCh0aGlzLnN0YXJ0VmFsdWUsIHRoaXMuZW5kVmFsdWUsIHRoaXMuZHVyYXRpb24sIHRoaXMuZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICogQHBhcmFtIHN0YXJ0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gZW5kVmFsdWUKICAgICAgICAgKiBAcGFyYW0gZHVyYXRpb24KICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihzdGFydFZhbHVlLCBlbmRWYWx1ZSwgZHVyYXRpb24sIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydFZhbHVlID0gc3RhcnRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5lbmRWYWx1ZSA9IGVuZFZhbHVlOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSAwOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuc3RhcnQuY2FsbCh0aGlzLCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuU3RlcFR3ZWVuLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLliqjnlLsKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMucGxheWluZykgcmV0dXJuOwoKICAgICAgICAgICAgaWYodGhpcy5mdW5jICYmIHRoaXMuZnVuYy5kb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZG9uZS5jYWxsKHRoaXMsIHRoaXMuZW5kVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZGVzdHJveQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZ1bmMgPSBudWxsOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLmVuZFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwbGF5CiAgICAgICAgICovCiAgICAgICAgcGxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMucGxheWluZyA9PSBmYWxzZSkJcmV0dXJuOwogICAgICAgICAgICB2YXIgdmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuc3RhcnRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLnN0YXJ0VmFsdWVba107CiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZW5kVmFsdWVba107CiAgICAgICAgICAgICAgICBpZihiID09IG51bGwgfHwgZiA9PSBudWxsIHx8IGlzTmFOKGIpIHx8IGlzTmFOKGYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHZhbHVlIGZvciBUd2VlbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGMgPSBmIC0gYjsKICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdGhpcy5lYXNlLmFwcGx5KHRoaXMsIFt0aGlzLmNvdW50LCBiLCBjLCB0aGlzLmR1cmF0aW9uXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb3VudCsrOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLmVhY2hTdGVwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZWFjaFN0ZXAuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5jb3VudCA+IHRoaXMuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlN0ZXBUd2VlbiIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmVhc2luZwogICAgICogQGRlc2Mg5Yqo55S75pa55rOVIOavj+S4quaWueazlemDveWMheaLrCAiZWFzZUluIiDmuJDlv6sgImVhc2VPdXQiIOa4kOaFoiAiZWFzZUluT3V0IiDnuqDnu5PnmoTkuInkuKrlgLzlj6/pgIkKICAgICAqLwogICAgby5lYXNpbmcgPSBvLmVhc2luZyB8fCB7fTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmxpbmVhcgogICAgICogQGRlc2Mg57q/5oCn5Yqo55S7CiAgICAgKi8KICAgIG8uZWFzaW5nLmxpbmVhciA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbgogICAgICAgICAqIEBkZXNjIOe6v+aAp+a4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDnur/mgKfmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6v+aAp+e6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmV4cG8KICAgICAqIEBkZXNjIOaMh+aVsOabsue6v+eahOe8k+WKqAogICAgICoKICAgICAqLwogICAgby5lYXNpbmcuZXhwbyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmV4cG8uZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICh0PT0wKSA/IGIgOiBjICogTWF0aC5wb3coMiwgMTAgKiAodC9kIC0gMSkpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gKHQ9PWQpID8gYitjIDogYyAqICgtTWF0aC5wb3coMiwgLTEwICogdC9kKSArIDEpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAodD09MCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICh0PT1kKSByZXR1cm4gYitjOwogICAgICAgICAgICBpZiAoKHQvPWQvMikgPCAxKSByZXR1cm4gYy8yICogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSArIGI7CiAgICAgICAgICAgIHJldHVybiBjLzIgKiAoLU1hdGgucG93KDIsIC0xMCAqIC0tdCkgKyAyKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnF1YWQKICAgICAqIEBkZXNjIOS6jOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFkID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhZC5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyoodC89ZCkqdCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YWQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC1jICoodC89ZCkqKHQtMikgKyBiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWFkLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodC89ZC8yKSA8IDEpIHJldHVybiBjLzIqdCp0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIC1jLzIgKiAoKC0tdCkqKHQtMikgLSAxKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmJhY2sKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOWklueahOS4gOerr+aIluS4pOerr+aJqeWxleWKqOeUu+S4gOasoe+8jOS7peS6p+eUn+S7juWFtuiMg+WbtOWkluWbnuaLieeahOaViOaenOOAggogICAgICog6YCa5L+X6K6y5bCx5piv5YWI5ZCR5ZCOIOWGjeWQkeWPjeaWueWQkQogICAgICovCiAgICBvLmVhc2luZy5iYWNrID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYmFjay5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCwgcykgewogICAgICAgICAgICBpZiAocyA9PSB1bmRlZmluZWQpIHMgPSAxLjcwMTU4OwogICAgICAgICAgICByZXR1cm4gYyAqICh0IC89IGQpICogdCAqICgocyArIDEpICogdCAtIHMpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIHJldHVybiBjICogKCh0ID0gdCAvIGQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5ib3VuY2UKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOeahOS4gOerr+aIluS4pOerr+WGhea3u+WKoOW8uei3s+aViOaenOOAguexu+S8vOS4gOS4queQg+iQveWQkeWcsOadv+WPiOW8uei1t+WQju+8jOWHoOasoemAkOa4kOWHj+Wwj+eahOWbnuW8uei/kOWKqAogICAgICovCiAgICBvLmVhc2luZy5ib3VuY2UgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5ib3VuY2UuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgLSBvLmVhc2luZy5ib3VuY2UuZWFzZU91dChkIC0gdCwgMCwgYywgZCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmJvdW5jZS5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCkgPCAoMSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiB0ICogdCkgKyBiCiAgICAgICAgICAgIH0gZWxzZSBpZiAodCA8ICgyIC8gMi43NSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjICogKDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgLjc1KSArIGIKICAgICAgICAgICAgfSBlbHNlIGlmICh0IDwgKDIuNSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi4yNSAvIDIuNzUpKSAqIHQgKyAuOTM3NSkgKyBiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi42MjUgLyAyLjc1KSkgKiB0ICsgLjk4NDM3NSkgKyBiCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYm91bmNlLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICh0IDwgZCAvIDIpIHJldHVybiBvLmVhc2luZy5ib3VuY2UuZWFzZUluKHQgKiAyLCAwLCBjLCBkKSAqIC41ICsgYjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gby5lYXNpbmcuYm91bmNlLmVhc2VPdXQodCAqIDIgLSBkLCAwLCBjLCBkKSAqIC41ICsgYyAqIC41ICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5lbGFzdGljCiAgICAgKiBAZGVzYyDmt7vliqDkuIDnq6/miJbkuKTnq6/otoXlh7rov4fmuKHojIPlm7TnmoTlvLnmgKfmlYjmnpwg5YW25Lit55qE6L+Q5Yqo55Sx5oyJ54Wn5oyH5pWw5pa55byP6KGw5YeP55qE5q2j5bym5rOi5p2l5a6a5LmJCiAgICAgKiDmjIfmlbDoobDlh4/nmoTmraPlvKbmm7Lnur/nvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuZWxhc3RpYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkKSA9PSAxKSByZXR1cm4gYiArIGM7CiAgICAgICAgICAgIGlmICghcCkgcCA9IGQgKiAuMzsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgcmV0dXJuIC0gKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZWxhc3RpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwKSByZXR1cm4gYjsKICAgICAgICAgICAgaWYgKCh0IC89IGQpID09IDEpIHJldHVybiBiICsgYzsKICAgICAgICAgICAgaWYgKCFwKSBwID0gZCAqIC4zOwogICAgICAgICAgICBpZiAoIWEgfHwgYSA8IE1hdGguYWJzKGMpKSB7CiAgICAgICAgICAgICAgICBhID0gYzsKICAgICAgICAgICAgICAgIHZhciBzID0gcCAvIDQKICAgICAgICAgICAgfSBlbHNlIHZhciBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oYyAvIGEpOwogICAgICAgICAgICByZXR1cm4gKGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICsgYyArIGIpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPT0gMikgcmV0dXJuIGIgKyBjOwogICAgICAgICAgICBpZiAoIXApIHAgPSBkICogKC4zICogMS41KTsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgaWYgKHQgPCAxKSByZXR1cm4gLSAuNSAqIChhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAqIGQgLSBzKSAqICgyICogTWF0aC5QSSkgLyBwKSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICogLjUgKyBjICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jaXJjCiAgICAgKiBAZGVzYyDlnIblvaLmm7Lnur/nmoTnvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuY2lyYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqIChNYXRoLnNxcnQoMSAtICh0IC89IGQpICogdCkgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY2lyYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqIE1hdGguc3FydCgxIC0gKHQgPSB0IC8gZCAtIDEpICogdCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiAtIGMgLyAyICogKE1hdGguc3FydCgxIC0gdCAqIHQpIC0gMSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYyAvIDIgKiAoTWF0aC5zcXJ0KDEgLSAodCAtPSAyKSAqIHQpICsgMSkgKyBiCiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnNpbmUKICAgICAqIEBkZXNjIOato+W8puabsue6v+e8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5zaW5lID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuc2luZS5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gLSBjICogTWF0aC5jb3ModCAvIGQgKiAoTWF0aC5QSSAvIDIpKSArIGMgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnNpbmUuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiBNYXRoLnNpbih0IC8gZCAqIChNYXRoLlBJIC8gMikpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5zaW5lLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiAtIGMgLyAyICogKE1hdGguY29zKE1hdGguUEkgKiB0IC8gZCkgLSAxKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVpbnQKICAgICAqIEBkZXNjIOS6lOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWludCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogKHQgLz0gZCkgKiB0ICogdCAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWludC5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgKiB0ICsgMSkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiB0ICogdCAqIHQgKiB0ICogdCArIGI7CiAgICAgICAgICAgIHJldHVybiBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVhcnQKICAgICAqIEBkZXNjIOWbm+asoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFydCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YXJ0LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICogdCArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiBjIC8gMiAqIHQgKiB0ICogdCAqIHQgKyBiOwogICAgICAgICAgICByZXR1cm4gLSBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAtIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jdWJpYwogICAgICogQGRlc2Mg5LiJ5qyh5pa555qE57yT5YqoCiAgICAgKi8KICAgIG8uZWFzaW5nLmN1YmljID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY3ViaWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCAvIDIpIDwgMSkgcmV0dXJuIGMgLyAyICogdCAqIHQgKiB0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5qih5Z2X566h55CGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKCS8qKgoJICogQG5hbWVzcGFjZSBvY3RvcHVzLmFwcAoJICogQGRlc2Mgb2N0b3B1cyBhcHDmqKHlnZfnu5PmnoQKCSAqLwogICAgby5hcHAgPSAoZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBhcHAgPSBudWxsOwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqIEBwYXJhbSBpbW1lZGlhdGUKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck1vZHVsZShpZCwgZnVuYywgaW1tZWRpYXRlKSB7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5yZWdpc3Rlck1vZHVsZShpZCwgZnVuYywgaW1tZWRpYXRlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0aWFsaXplCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuICFhcHAgPyAoYXBwID0gbmV3IG8uQXBwKG9wdGlvbnMpLCBhcHApIDogKCEhb3B0aW9ucyA/IChjb25zb2xlLndhcm4oIlRoZSBhcHAgaGFzIGFscmVhZHkgZXhpc3QhIEZhaWx1cmUgdG8gc2V0IHVwIHRoZSBjb25maWciKSwgYXBwKSA6IGFwcCk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAuYWRkQ29uZmlnCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFkZENvbmZpZyhpZCwgb2JqKSB7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5hZGRDb25maWcoaWQsIG9iaik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJBcGkoaWQsIG9iail7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5yZWdpc3RlckFwaShpZCwgb2JqKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAuYWRkQ29uZmlnCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhZGRDb25maWc6IGFkZENvbmZpZywKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJBcGkKICAgICAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICAgICAqIEBwYXJhbSBvYmoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlZ2lzdGVyQXBpOiByZWdpc3RlckFwaSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJNb2R1bGUKICAgICAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICAgICAqIEBwYXJhbSBmdW5jCiAgICAgICAgICAgICAqIEBwYXJhbSBpbW1lZGlhdGUKICAgICAgICAgICAgICogQGRlc2Mg5rOo5YaM5LiA5Liq5qih5Z2XCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZWdpc3Rlck1vZHVsZTogcmVnaXN0ZXJNb2R1bGUsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmluaXRpYWxpemUKICAgICAgICAgICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyWYXBw5a+56LGhIOWmguaenOS4jeiiq+iwg+eUqOWImeaMieeFp+m7mOiupOWxnuaAp+WIneWni+WMlgogICAgICAgICAgICAgKiBAcmV0dXJucyB7b2N0b3B1cy5BcHB8YXBwfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaW5pdGlhbGl6ZTogaW5pdGlhbGl6ZQogICAgICAgIH07CiAgICB9KSgpOwoKICAgIG8uQXBwID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpZAogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgaWQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2MgYXBw55qE5qC56IqC54K5CiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZpZXdFbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOWPr+inhuiKgueCuQogICAgICAgICAqLwogICAgICAgIHZpZXdFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbGF5ZXJzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqIEBkZXNjIOeuoeeQhueahOaooeWdlwogICAgICAgICAqLwogICAgICAgIGxheWVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY3VycmVudExheWVyCiAgICAgICAgICogQHR5cGUge28uTGF5ZXJ9CiAgICAgICAgICovCiAgICAgICAgY3VycmVudExheWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjbWRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIGNtZHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1DcmVhdG9yCiAgICAgICAgICogQGRlc2Mg55Sf5oiQ5ZmoCiAgICAgICAgICovCiAgICAgICAgbUNyZWF0b3I6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50cwogICAgICAgICAqIEB0eXBlIHtvLkV2ZW50c30KICAgICAgICAgKi8KICAgICAgICBldmVudHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50TGlzdGVuZXJzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBldmVudExpc3RlbmVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY21kTWFuYWdlcgogICAgICAgICAqIEB0eXBlIHtvLkNtZE1hbmFnZXJ9CiAgICAgICAgICovCiAgICAgICAgY21kTWFuYWdlcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRDYWNoZXMKICAgICAgICAgKiBAZGVzYyDkuovku7bnvJPlrZgg5Li76KaB6Ziy5q2iIOS4gOS6m+aooeWdl+acquWwseS9jeaXtueahOS6i+S7tuWIhuWPkQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBldmVudENhY2hlczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNMb2FkCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMb2FkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlnCiAgICAgICAgICogQGRlc2Mg6YWN572u6aG5CiAgICAgICAgICovCiAgICAgICAgY29uZmlnOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Jlc2l6ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgd2lkZ2V0cwogICAgICAgICAqLwogICAgICAgIHdpZGdldHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzSW5pdERvbQogICAgICAgICAqLwogICAgICAgIGlzSW5pdERvbTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNhY2hlRXZlbnREaXNwYXRjaAogICAgICAgICAqIEBkZXNjIOS6i+S7tue8k+WGsuWZqAogICAgICAgICAqLwogICAgICAgIGNhY2hlRXZlbnREaXNwYXRjaDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlncwogICAgICAgICAqIEBkZXNjIOmFjee9rumhuQogICAgICAgICAqLwogICAgICAgIGNvbmZpZ3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMubUNyZWF0b3IgPSB7fTsKICAgICAgICAgICAgdGhpcy5ldmVudENhY2hlcyA9IFtdOwogICAgICAgICAgICB0aGlzLmNvbmZpZ3MgPSB7fTsKICAgICAgICAgICAgdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2ggPSB7fTsKICAgICAgICAgICAgdGhpcy5pZCA9IGNvbmZpZy5pZCB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKCiAgICAgICAgICAgIC8v55uR5ZCsd2luZG935LqL5Lu2IOWQr+WKqOaooeWdlwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgInJlYWR5Iiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd0xvYWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAidW5sb2FkIiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd1VubG9hZCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJyZXNpemUiLCBvLnV0aWwuYmluZCh0aGlzLm9uV2luZG93UmVzaXplLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBpZigib3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdykgewogICAgICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcmllbnRhdGlvbmNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMub25PcmllbnRhdGlvbkNoYW5nZWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgICAgIGlmKGNvbmZpZy5ldmVudExpc3RlbmVycyAmJiBvLnV0aWwuaXNPYmplY3QoY29uZmlnLmV2ZW50TGlzdGVuZXJzKSkgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycyA9IGNvbmZpZy5ldmVudExpc3RlbmVyczsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnJlZ2lzdGVyKHRoaXMuZXZlbnRMaXN0ZW5lcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8v5ZG95Luk5pCe5LiK5Y67CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlciA9IG5ldyBvLkNtZE1hbmFnZXIoewogICAgICAgICAgICAgICAgYXBwOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihjb25maWcuY21kcykgewogICAgICAgICAgICAgICAgdGhpcy5jbWRzID0gY29uZmlnLmNtZHM7CiAgICAgICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmNtZHMsIG8udXRpbC5iaW5kKHRoaXMucmVnaXN0ZXJDbWQsIHRoaXMpKTsKICAgICAgICAgICAgICAgIHRoaXMuY21kcy5sZW5ndGggPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJDbWQKICAgICAgICAgKiBAcGFyYW0gY21kIHtvY3RvcHVzLkNtZH0KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckNtZDogZnVuY3Rpb24oY21kKSB7CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlci5yZWdpc3RlcihjbWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmV4ZWN1dGVDbWQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBvcHMge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDmiafooYzmjIflrprlkb3ku6QKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ21kOiBmdW5jdGlvbihuYW1lLCBvcHMpIHsKICAgICAgICAgICAgdGhpcy5jbWRNYW5hZ2VyLmV4ZWN1dGVDb21tYW5kKG5hbWUsIG9wcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudW5yZWdpc3RlckNtZAogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgdW5yZWdpc3RlckNtZDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIudW5yZWdpc3RlcihuYW1lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZWdpc3Rlck1lbWJlcgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOazqOWGjOeahOenjeexuyDlj6/pgInmqKHlnZfmiJbogIVhcGkKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30g5rOo5YaM55qEaWQKICAgICAgICAgKiBAcGFyYW0gY3JlYXRvciB7T2JqZWN0IHwgRnVuY3Rpb259IOaehOmAoOWZqAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyTWVtYmVyOiBmdW5jdGlvbih0eXBlLCBpZCwgY3JlYXRvcikgewogICAgICAgICAgICB0aGlzLm1DcmVhdG9yW3R5cGVdID0gdGhpcy5tQ3JlYXRvclt0eXBlXSB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubUNyZWF0b3JbdHlwZV1baWRdID0gewogICAgICAgICAgICAgICAgY3JlYXRvcjogY3JlYXRvciwKICAgICAgICAgICAgICAgIGluc3RhbmNlOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc3RhcnRNZW1iZXIKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0YXJ0TWVtYmVyOiBmdW5jdGlvbih0eXBlLCBpZCkgewogICAgICAgICAgICB2YXIgY3JlYXRvciA9IHRoaXMubUNyZWF0b3JbdHlwZV1baWRdOwogICAgICAgICAgICBpZighY3JlYXRvciB8fCBjcmVhdG9yLmluc3RhbmNlKSAgIHJldHVybjsKICAgICAgICAgICAgY3JlYXRvci5pbnN0YW5jZSA9IGNyZWF0b3IuY3JlYXRvcih0aGlzLCB0aGlzLmdldENvbmZpZyhpZCkpOwogICAgICAgICAgICBjcmVhdG9yLmluc3RhbmNlLmluaXQgJiYgY3JlYXRvci5pbnN0YW5jZS5pbml0KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gbQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyQXBpOiBmdW5jdGlvbihpZCwgbSkgewogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVtYmVyKCJhcGkiLCBpZCwgbSk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRBcGkoaWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG0ge09iamVjdCB8IHNyLk1vZHVsZX0KICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyTW9kdWxlOiBmdW5jdGlvbihpZCwgbSwgaW1tZWRpYXRlKSB7CiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJNZW1iZXIoIm1vZHVsZSIsIGlkLCBtKTsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmlzTG9hZCB8fCAhIWltbWVkaWF0ZSkgPyAodGhpcy5zdGFydE1vZHVsZShpZCksIHRydWUpIDogZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0TW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRNZW1iZXIoIm1vZHVsZSIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc3RhcnRBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBzdGFydEFwaTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydE1lbWJlcigiYXBpIiwgaWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBnZXRBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBnZXRBcGk6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yWyJhcGkiXVtpZF0uaW5zdGFuY2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmdldE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGdldE1vZHVsZTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubUNyZWF0b3JbIm1vZHVsZSJdW2lkXS5pbnN0YW5jZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc3RvcE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0b3BNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVJdGVtID0gdGhpcy5tQ3JlYXRvclsibW9kdWxlIl1baWRdOwogICAgICAgICAgICBpZighbW9kdWxlSXRlbS5pbnN0YW5jZSkgICByZXR1cm47CiAgICAgICAgICAgIGlmIChtb2R1bGVJdGVtLmluc3RhbmNlLmRlc3Ryb3kpIHsKICAgICAgICAgICAgICAgIG1vZHVsZUl0ZW0uaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vZHVsZUl0ZW0uaW5zdGFuY2UgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLm9uCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30g5LqL5Lu25ZCNCiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufSDlm57osIMKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbih0eXBlLCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC51bgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuWQjQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Zue6LCDCiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAubm90aWZ5CiAgICAgICAgICogQGRlc2Mg6Kem5Y+R5p+Q6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZXZ0IHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbih0eXBlLCBldnQpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNMb2FkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50Q2FjaGVzLnB1c2goW3R5cGUsIGV2dF0pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnRyaWdnZXJFdmVudCh0eXBlLCBldnQpOwogICAgICAgICAgICBmb3IodmFyIGsgaW4gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2gpIHsKICAgICAgICAgICAgICAgIGlmKGsuaW5kZXhPZih0eXBlKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50RGlzcGF0Y2goaywgdHlwZSwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC50cmlnZ2VyRXZlbnREaXNwYXRjaAogICAgICAgICAqIEBkZXNjIOmAmuefpee8k+WGsuWZqCDmtLvmnaXkuoYKICAgICAgICAgKiBAcGFyYW0gaWQg57yT5Yay5Zmo55qEa2V5CiAgICAgICAgICogQHBhcmFtIHR5cGUg5a6M5oiQ55qE5bel5L2cdHlwZQogICAgICAgICAqIEBwYXJhbSBldnQg5a6M5oiQ55qE5bel5L2c5bim5p2l55qE5Y+Y6YePCiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlckV2ZW50RGlzcGF0Y2g6IGZ1bmN0aW9uKGlkLCB0eXBlLCBldnQpIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoID0gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbaWRdOwogICAgICAgICAgICBpZighZGlzcGF0Y2ggJiYgZGlzcGF0Y2guaGl0RmxhZyA9PSBkaXNwYXRjaC5oaXRzICB8fCBkaXNwYXRjaFsiY2FjaGVEYXRhIl1bdHlwZV0pICByZXR1cm47CiAgICAgICAgICAgIGRpc3BhdGNoWyJjYWNoZURhdGEiXVt0eXBlXSA9IGV2dDsKICAgICAgICAgICAgaWYoKytkaXNwYXRjaC5oaXRGbGFnID09IGRpc3BhdGNoLmhpdHMpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoLmZ1bmMuYXBwbHkodGhpcywgW2Rpc3BhdGNoLmNhY2hlRGF0YV0pOwogICAgICAgICAgICAgICAgZGlzcGF0Y2ggPSBudWxsOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2lkXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmFkZENvbmZpZwogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqIEBwYXJhbSBjb25maWcKICAgICAgICAgKi8KICAgICAgICBhZGRDb25maWc6IGZ1bmN0aW9uKGlkLCBjb25maWcpewogICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge307CiAgICAgICAgICAgIHZhciBjLCBwOwogICAgICAgICAgICBpZihpZCkgewogICAgICAgICAgICAgICAgYyA9IHRoaXMuY29uZmlnc1tpZF0gPSB0aGlzLmNvbmZpZ3NbaWRdIHx8IHt9OwogICAgICAgICAgICAgICAgZm9yKHAgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgY1twXSA9IGNvbmZpZ1twXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcihwIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnc1twXSA9IGNvbmZpZ1twXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRDb25maWcKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBnZXRDb25maWc6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3NbaWRdIHx8IHt9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmludm9rZUV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDlkK/nlKjkuIDkuKrkuovku7bnvJPlhrLlmagg55So5p2l5aSE55CG5aSa5qyh5LqL5Lu25a6M5oiQ5omN5YGa5p+Q5LqL5oOF55qE6ZyA5rGCCiAgICAgICAgICovCiAgICAgICAgaW52b2tlRXZlbnREaXNwYXRjaDogZnVuY3Rpb24oZXZlbnRzLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2V2ZW50c10sCiAgICAgICAgICAgICAgICBsZW4gPSBTdHJpbmcoZXZlbnRzKS5zcGxpdCgiLCIpLmxlbmd0aDsKICAgICAgICAgICAgaWYoZGlzcGF0Y2ggJiYgZGlzcGF0Y2guaGl0RmxhZyA9PSBsZW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhpcyBraW5kIG9mIEV2ZW50RGlzcGF0Y2ggaGFzIGFscmVhZHkgaW52b2tlZCEiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtldmVudHNdID0gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbZXZlbnRzXSB8fCB7CiAgICAgICAgICAgICAgICBoaXRzOiBsZW4sCiAgICAgICAgICAgICAgICBoaXRGbGFnOiAwLAogICAgICAgICAgICAgICAgY2FjaGVEYXRhOiB7fSwKICAgICAgICAgICAgICAgIGZ1bmM6IGZ1bmMKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dMb2FkCiAgICAgICAgICogQGRlc2Mg55uR5ZCsb25sb2Fk5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25XaW5kb3dMb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXSwgZnVuY3Rpb24oaXRlbSwgaykgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydE1vZHVsZShrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaXNMb2FkID0gdHJ1ZTsKICAgICAgICAgICAgaWYodGhpcy5ldmVudENhY2hlcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICB3aGlsZShpdGVtID0gdGhpcy5ldmVudENhY2hlcy5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnkoaXRlbVswXSwgaXRlbVsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLU1vZHVsZUNvbXBsZXRlZCIsIHt9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dVbmxvYWQKICAgICAgICAgKiBAZGVzYyDnm5HlkKzpobXpnaLnmoR1bmxvYWTkuovku7Yg6ZKI5a+55L2O54mI5pys5rWP6KeI5ZmoIOS4u+imgeWBmuS4gOS6m+WGheWtmOWbnuaUtuW3peS9nCDoh7Pkuo7pq5jnuqfmtY/op4jlmagg5aW95ZCnIOS9oOWPr+S7peiupOS4uuaIkeWcqOiHquasuuasuuS6ugogICAgICAgICAqLwogICAgICAgIG9uV2luZG93VW5sb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXSwgZnVuY3Rpb24oaXRlbSwgaykgewogICAgICAgICAgICAgICAgdGhhdC5zdG9wTW9kdWxlKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzTG9hZCkgICAgY29uc29sZS5lcnJvcigiVGhlIHBhZ2UgaGFzbid0IGxvYWRlZCEiKTsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBpZighZWwpICAgIGNvbnNvbGUuZXJyb3IoIkludmFsaWQgbm9kZSB0byByZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuaW5pdERvbU1vZGUoZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0RG9tTW9kZQogICAgICAgICAqLwogICAgICAgIGluaXREb21Nb2RlOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICAvL+iKgueCueaooeW8jwogICAgICAgICAgICB0aGlzLmlzSW5pdERvbSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZywKICAgICAgICAgICAgICAgIG5vZGUgPSBlbCwKICAgICAgICAgICAgICAgIGlkID0gdGhpcy5pZCArICJfT2N0b3B1c19WaWV3UG9ydCI7CiAgICAgICAgICAgIHRoaXMuZWwgPSBvLmRvbS5jbG9uZU5vZGUobm9kZSwgdHJ1ZSk7CiAgICAgICAgICAgIHRoaXMudmlld0VsID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1cy12aWV3cG9ydCIsCiAgICAgICAgICAgICAgICBzdHlsZTogIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IHBvc2l0aW9uOiByZWxhdGl2ZTsgei1pbmRleDogMzAwOyBvdmVyZmxvdzogaGlkZGVuIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0aGlzLnZpZXdFbCk7CiAgICAgICAgICAgIC8v5aaC5p6c5piv6IqC54K55qih5byP5LiU5oul5pyJ5Zu+5bGCCiAgICAgICAgICAgIGlmKGNvbmZpZy5sYXllcnMpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5lYWNoKGNvbmZpZy5sYXllcnMsIG8udXRpbC5iaW5kKHRoaXMuYWRkTGF5ZXIsIHRoaXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL+WmguaenOaYr+iKgueCueaooeW8j+S4lOWIneWni+WMlndpZGdldOaOp+S7tgogICAgICAgICAgICBpZihjb25maWcud2lkZ2V0cykgewogICAgICAgICAgICAgICAgby51dGlsLmVhY2goY29uZmlnLndpZGdldHMsIG8udXRpbC5iaW5kKHRoaXMuYWRkV2lkZ2V0LCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUJlZm9yZUFwcENvbXBsZXRlZCIpOwogICAgICAgICAgICAvL+aKiuiiq+aQnuW+l+mdouebruWFqOmdnueahGVs5Yqg5YWl5paH5qGj5rWBCiAgICAgICAgICAgIGlmKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy5lbCwgbm9kZSk7CiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtQXBwQ29tcGxldGVkIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25PcmllbnRhdGlvbkNoYW5nZWQKICAgICAgICAgKiBAZGVzYyDnm5HlkKzmqKrnq5blsY/liIfmjaLkuovku7YKICAgICAgICAgKi8KICAgICAgICBvbk9yaWVudGF0aW9uQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1Pbk9yaWVudGF0aW9uQ2hhbmdlZCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvbldpbmRvd1Jlc2l6ZQogICAgICAgICAqLwogICAgICAgIG9uV2luZG93UmVzaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNSZXNpemUpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMuY2hlY2tTaXplLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVja1NpemUKICAgICAgICAgKi8KICAgICAgICBjaGVja1NpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1PbldpbmRvd1Jlc2l6ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmFkZExheWVyCiAgICAgICAgICogQGRlc2Mg57uZ5b2T5YmNZG9t5LiK5aKe5Yqg5Zu+5bGCIOWmguaenOS4jeWtmOWcqHRoaXMuZWwg5YiZ5q2k5pa55rOV5rKh5a6e6ZmF5pWI5p6cCiAgICAgICAgICogQHBhcmFtIGxheWVyIHtvY3RvcHVzLkxheWVyfQogICAgICAgICAqLwogICAgICAgIGFkZExheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBpZighdGhpcy5sYXllcnMpICAgIHRoaXMubGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmKHRoaXMubGF5ZXJzLmluZGV4T2YobGF5ZXIpICE9IC0xKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgZWwgPSBsYXllci5nZXRFbCgpOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyhlbCwgIm9jdG9wdXMtYXBwLWxheWVyIik7CiAgICAgICAgICAgIHRoaXMuc2V0TGF5ZXJaSW5kZXgobGF5ZXIsIHRoaXMubGF5ZXJzLmxlbmd0aCk7CiAgICAgICAgICAgIGlmKGxheWVyLmlzQmFzZUxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld0VsLmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihsYXllci5pc0N1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudExheWVyKGxheWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKICAgICAgICAgICAgbGF5ZXIuc2V0QXBwKHRoaXMpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtTGF5ZXJBZGQiLCB7bGF5ZXI6IGxheWVyfSk7CiAgICAgICAgICAgIGxheWVyLmFmdGVyQWRkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc2V0Q3VycmVudExheWVyCiAgICAgICAgICogQHBhcmFtIGxheWVyCiAgICAgICAgICovCiAgICAgICAgc2V0Q3VycmVudExheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnRMYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIuc2V0Q3VycmVudChmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIgPSBsYXllcjsKICAgICAgICAgICAgdGhpcy50b3BMYXllcihsYXllcik7CiAgICAgICAgICAgIGxheWVyLnNldEN1cnJlbnQodHJ1ZSk7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1DdXJyZW50TGF5ZXJDaGFuZ2VkIiwge2xheWVyOiBsYXllcn0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzZXRMYXllclpJbmRleAogICAgICAgICAqIEBkZXNjIOiuvue9ruWbvuWxgueahGluZGV4CiAgICAgICAgICogQHBhcmFtIGxheWVyIHtvY3RvcHVzLkxheWVyfQogICAgICAgICAqIEBwYXJhbSB6SWR4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2V0TGF5ZXJaSW5kZXg6IGZ1bmN0aW9uKGxheWVyLCB6SWR4KSB7CiAgICAgICAgICAgIGxheWVyLnNldFpJbmRleCh0aGlzLlpfSU5ERVhfQkFTRVtsYXllci5pc0Jhc2VMYXllciA/ICJCYXNlTGF5ZXIiIDogIkxheWVyIl0gKyB6SWR4ICogNSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlc2V0TGF5ZXJzWkluZGV4CiAgICAgICAgICogQGRlc2MgcmVzZXTlm77lsYJ6aW5kZXgKICAgICAgICAgKi8KICAgICAgICByZXNldExheWVyc1pJbmRleDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5sYXllcnMsIGZ1bmN0aW9uKGxheWVyLCBpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnNldExheWVyWkluZGV4KGxheWVyLCBpKTsKICAgICAgICAgICAgfSkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VG9wWkluZGV4CiAgICAgICAgICovCiAgICAgICAgZ2V0VG9wWkluZGV4OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRvcEluZGV4ID0gewogICAgICAgICAgICAgICAgemluZGV4OiAwLAogICAgICAgICAgICAgICAgaW5kZXg6IDAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5sYXllcnMsIGZ1bmN0aW9uKGxheWVyLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ppbmRleCA9IGxheWVyLmdldEVsKCkuc3R5bGUuekluZGV4IHx8IDA7CiAgICAgICAgICAgICAgICBpZihfemluZGV4ID4gdG9wSW5kZXguemluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgdG9wSW5kZXggPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHppbmRleDogX3ppbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG9wSW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudG9wTGF5ZXIKICAgICAgICAgKi8KICAgICAgICB0b3BMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgdmFyIHRvcEluZGV4ID0gdGhpcy5nZXRUb3BaSW5kZXgoKSwKICAgICAgICAgICAgICAgIGluZGV4ID0gbGF5ZXIuZWwuc3R5bGUuekluZGV4OwogICAgICAgICAgICBpZih0b3BJbmRleCA9PSBpbmRleCkJcmV0dXJuOwogICAgICAgICAgICBsYXllci5lbC5zdHlsZS56SW5kZXggPSB0b3BJbmRleC56aW5kZXg7CiAgICAgICAgICAgIHRoaXMubGF5ZXJzW3RvcEluZGV4LmluZGV4XS5lbC5zdHlsZS56SW5kZXggPSBpbmRleDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRMYXllcgogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOmdoGlk6I635Y+W5Zu+5bGCCiAgICAgICAgICovCiAgICAgICAgZ2V0TGF5ZXI6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHZhciBsYXllciA9IG51bGw7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihfbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGlmKGlkID09IF9sYXllci5pZCkgewogICAgICAgICAgICAgICAgICAgIGxheWVyID0gX2xheWVyOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGxheWVyOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlbW92ZUxheWVyCiAgICAgICAgICogQHBhcmFtIGxheWVyCiAgICAgICAgICogQGRlc2Mg5Yig5o6J5Zu+5bGCCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlTGF5ZXI6IGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgICAgICAgIGxheWVyLmdldEVsKCkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChsYXllci5nZXRFbCgpKTsKICAgICAgICAgICAgby51dGlsLnJlbW92ZUl0ZW0odGhpcy5sYXllcnMsIGxheWVyKTsKICAgICAgICAgICAgbGF5ZXIucmVtb3ZlQXBwKHRoaXMpOwogICAgICAgICAgICBsYXllci5hcHAgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlc2V0TGF5ZXJzWkluZGV4KCk7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1MYXllclJlbW92ZSIsIHtsYXllcjogbGF5ZXJ9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRXaWRnZXQKICAgICAgICAgKiBAcGFyYW0gd2lkZ2V0IHtvY3RvcHVzLldpZGdldH0KICAgICAgICAgKiBAcGFyYW0gYXV0byB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmt7vliqB3aWRnZXTliLBhcHDph4wKICAgICAgICAgKi8KICAgICAgICBhZGRXaWRnZXQ6IGZ1bmN0aW9uKHdpZGdldCwgYXV0bykgewogICAgICAgICAgICBpZighdGhpcy53aWRnZXRzKSAgICB0aGlzLndpZGdldHMgPSBbXTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy53aWRnZXRzLmluZGV4T2Yod2lkZ2V0KTsKICAgICAgICAgICAgaWYoaW5kZXggPiAtMSkgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy53aWRnZXRzLnB1c2god2lkZ2V0KQogICAgICAgICAgICBpZighYXV0bykgewogICAgICAgICAgICAgICAgd2lkZ2V0LmNvbnRhaW5lciA9IHdpZGdldC5vdXRzaWRlVmlld3BvcnQgPyB0aGlzLmVsIDogdGhpcy52aWV3RWw7CiAgICAgICAgICAgICAgICB3aWRnZXQucmVuZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2lkZ2V0LnNldFpJbmRleCh0aGlzLlpfSU5ERVhfQkFTRS5XaWRnZXQgKyB0aGlzLndpZGdldHMubGVuZ3RoICogNSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0V2lkZ2V0CiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0V2lkZ2V0OiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgd2lkZ2V0ID0gbnVsbCwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy53aWRnZXRzLmxlbmd0aDsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy53aWRnZXRzLCBmdW5jdGlvbihfd2lkZ2V0KSB7CiAgICAgICAgICAgICAgICBpZihfd2lkZ2V0LmlkID09IGlkKSB7CiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0ID0gX3dpZGdldDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB3aWRnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVtb3ZlV2lkZ2V0CiAgICAgICAgICogQHBhcmFtIHdpZGdldCB7b2N0b3B1cy5XaWRnZXR9CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlV2lkZ2V0OiBmdW5jdGlvbih3aWRnZXQpIHsKICAgICAgICAgICAgaWYgKCh3aWRnZXQpICYmICh3aWRnZXQgPT0gdGhpcy5nZXRXaWRnZXQod2lkZ2V0LmlkKSkpIHsKICAgICAgICAgICAgICAgIHdpZGdldC5lbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdpZGdldC5lbCk7CiAgICAgICAgICAgICAgICBvLnV0aWwucmVtb3ZlSXRlbSh0aGlzLndpZGdldHMsIHdpZGdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBaX0lOREVYX0JBU0U6IHsKICAgICAgICAgICAgQmFzZUxheWVyOiAwLAogICAgICAgICAgICBMYXllcjogMzUwLAogICAgICAgICAgICBXaWRnZXQ6IDc1MCwKICAgICAgICAgICAgTWFzazogMTAwMCwKICAgICAgICAgICAgUG9wdXA6IDE1MDAKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5BcHAiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlkb3ku6TmiJbmk43kvZwKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkNtZCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgbmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYWN0aXZlCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgYWN0aXZlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXBwCiAgICAgICAgICogQHR5cGUge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIGFwcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihuYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZSB8fCB0aGlzLkNMQVNTX05BTUU7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWQuYWN0aXZhdGUKICAgICAgICAgKiBAZGVzYyDmv4DmtLvlkb3ku6TnirbmgIEKICAgICAgICAgKi8KICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWQuZGVhY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOaMgui1t+WRveS7pOeKtuaAgQogICAgICAgICAqLwogICAgICAgIGRlYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmV4ZWN1dGUKICAgICAgICAgKiBAcGFyYW0gb3B0aW9uCiAgICAgICAgICogQGRlc2Mg5omn6KGM5ZG95LukCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkJcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLnVuZXhlY3V0ZQogICAgICAgICAqIEBkZXNjIOWunueOsOatpOaWueazleeahOWRveS7pOaUr+aMgXVuZG8gcmVkbwogICAgICAgICAqLwogICAgICAgIHVuZXhlY3V0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLnNldEFwcAogICAgICAgICAqIEBwYWdlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKiBAZGVzYyDnu5Hlrprlkb3ku6TliLBhcHAKICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICBpZih0aGlzLmFwcCAhPSBhcHApIHsKICAgICAgICAgICAgICAgIHRoaXMuYXBwID0gYXBwOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5DbWQiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlkb3ku6TnrqHnkIbnsbsKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkNtZE1hbmFnZXIgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbW1hbmRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIGNvbW1hbmRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBleGVjdXRlQ21kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ21kczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgbmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICAhIXRoaXMuYXBwID8gKHRoaXMuc2V0QXBwKHRoaXMuYXBwKSwgdHJ1ZSkgOiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lIHx8IG8udXRpbC5jcmVhdGVVbmlxdWVJRCh0aGlzLkNMQVNTX05BTUUgKyAiXyIpOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzID0gdGhpcy5jb21tYW5kcyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5leGVjdXRlQ21kcyA9IHRoaXMuZXhlY3V0ZUNtZHMgfHwgW107CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLnNldEFwcAogICAgICAgICAqIEBwYXJhbSBhcHAge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIHNldEFwcDogZnVuY3Rpb24oYXBwKSB7CiAgICAgICAgICAgIHRoaXMuYXBwID09IGFwcCA/IGZhbHNlIDogKHRoaXMuYXBwID0gYXBwLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIucmVnaXN0ZXIKICAgICAgICAgKiBAcGFyYW0gY29tbWFuZCB7by5DbWR9CiAgICAgICAgICogQGRlc2Mg5rOo5YaM5LiA5Liq5ZG95Luk5Yiw5ZG95Luk566h55CG5ZmoCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChjb21tYW5kKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29tbWFuZHMuaW5kZXhPZihjb21tYW5kKTsKICAgICAgICAgICAgaWYoaW5kZXggIT0gLTEpCXJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcy5wdXNoKGNvbW1hbmQpOwogICAgICAgICAgICBjb21tYW5kLnNldEFwcCh0aGlzLmFwcCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci51bnJlZ2lzdGVyCiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICB1bnJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuZ2V0Q29tbWFuZEluZGV4QnlOYW1lKG5hbWUpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkJcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBnZXRDb21tYW5kSW5kZXhCeU5hbWUKICAgICAgICAgKi8KICAgICAgICBnZXRDb21tYW5kSW5kZXhCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMuY29tbWFuZHMubGVuZ3RoLAogICAgICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGlmKG5hbWUgPT0gdGhpcy5jb21tYW5kc1tpXS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5leGVjdXRlQ29tbWFuZAogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9IOWRveS7pOWQjQogICAgICAgICAqIEBwYXJhbSBvcHRpb24ge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ29tbWFuZDogZnVuY3Rpb24obmFtZSwgb3B0aW9uKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuZ2V0Q29tbWFuZEluZGV4QnlOYW1lKG5hbWUpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkJcmV0dXJuOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzW2luZGV4XS5leGVjdXRlKG9wdGlvbik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLmRlc3Ryb3kKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuYXBwID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5DbWRNYW5hZ2VyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu257uT5p6E5paH5Lu2CiAqIOWumuS5ieWbvuWxguWfuuexuwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIG8uTGF5ZXIgPSBvLmRlZmluZSh7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb25maWcKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGNvbmZpZzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNDdXJyZW50CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNDdXJyZW50OiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnQKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5FdmVudHN9CiAgICAgICAgICovCiAgICAgICAgZXZlbnQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuTGF5ZXIuaXNCYXNlTGF5ZXIKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0Jhc2VMYXllcjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXBwCiAgICAgICAgICogQHR5cGUge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIGFwcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZyA9IG8uZXh0ZW5kKHt9LCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5pZCA9IGNvbmZpZy5pZCB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKICAgICAgICAgICAgdGhpcy5lbCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgaWQ6IHRoaXMuaWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaXNDdXJyZW50ID0gY29uZmlnLmlzQ3VycmVudCB8fCB0aGlzLmlzQ3VycmVudDsKICAgICAgICAgICAgdGhpcy5pc0Jhc2VMYXllciA9IGNvbmZpZy5pc0Jhc2VMYXllciB8fCB0aGlzLmlzQmFzZUxheWVyOwogICAgICAgICAgICBpZih0aGlzLmlzQ3VycmVudCB8fCB0aGlzLmlzQmFzZUxheWVyKSB7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1iYXNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ldmVudCA9IG5ldyBvLkV2ZW50cyh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLmdldEVsCiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIub24KICAgICAgICAgKiBAZGVzYyDkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbih0eXBlLCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnVuCiAgICAgICAgICogQGRlc2Mg5LqL5Lu25Y+W5raI55uR5ZCsCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5zZXRBcHAKICAgICAgICAgKiBAZGVzYyDnu5HlrpphcHAKICAgICAgICAgKiBAcGFyYW0gYXBwIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICByZXR1cm4gYXBwID09IHRoaXMuYXBwID8gZmFsc2UgOiAodGhpcy5hcHAgPSBhcHAsIHRydWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuYWZ0ZXJBZGQKICAgICAgICAgKiBAZGVzYyDnu5HlrprlhaVhcHDlkI7osIPnlKgKICAgICAgICAgKi8KICAgICAgICBhZnRlckFkZDogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuc2V0Q3VycmVudAogICAgICAgICAqIEBwYXJhbSBjdXJyZW50IHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIHNldEN1cnJlbnQ6IGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICAgICAgaWYoKGN1cnJlbnQgJiYgdGhpcy5pc0N1cnJlbnQpIHx8ICghY3VycmVudCAmJiAhdGhpcy5pc0N1cnJlbnQpKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgY3VycmVudCA/IG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzLWxheWVyLXNob3ciKSA6IG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMuZWwsICJvY3RvcHVzLWxheWVyLXNob3ciKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnNldFpJbmRleAogICAgICAgICAqIEBwYXJhbSB6SW5kZXgge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBzZXRaSW5kZXg6IGZ1bmN0aW9uKHpJbmRleCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IHpJbmRleDsKICAgICAgICB9LAoKICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIGRlYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICByZW1vdmVBcHA6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5MYXllciIKICAgIH0pOwp9KShvY3RvcHVzKTs=",
                "body": "LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tu+8jOS4u+imgeeUqOS6jumAmueUqOe7hOS7tueahOexu+e7k+aehOWjsOaYjgogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiDlkb3lkI3nqbrpl7TliY3nvIAg8J+QmQogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzCiAgICAgKiBAZGVzYyDlkb3lkI3nqbrpl7Tor7TmmI4g5omA5pyJ5bCP5YaZ5a2X5q+N5byA5aS055qE5pa55rOV6YO95Y+v5Lul55u05o6l6LCD55SoIOWmgm9jdG9wdXMuZWFzaW5nLmxpbmVhci5lYXNlSW4KICAgICAqIOebuOWPje+8jOWkp+WGmeWtl+avjeW8gOWktOeahOWRveWQjeivtOaYjuivpeWvueixoeaYr+S4gOS4quexu+WvueixoSDpnIDopoHnlKjlhbPplK7lrZduZXcg5aaCIG5ldyBvY3RvcHVzLldpZGdldCgpCiAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICovCiAgICB2YXIgb2N0b3B1cywKICAgICAgICBvID0gb2N0b3B1cyA9IHt2ZXJzaW9uOiAiMS4xIn07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZGVmaW5lCiAgICAgKiBAZGVzYyDnsbvnlJ/miJAu5bCG6L+U5Zue5LiA5Liq5b2i5aaC4oCU4oCUCiAgICAgKiBmdW5jdGlvbiBDKCkgewogICAgICogICAgICB0aGlzLmluaXRpYWxpemUoKQogICAgICogfTsKICAgICAqIEMucHJvdG90eXBlID0geyBjb25zdHJ1Y3RvcjogQywgLi4uIH3nmoTlr7nosaEKICAgICAqIOaUr+aMgeS4pOS4quWPguaVsO+8jOesrOS4gOS4quS4uueItuexu++8iOWPr+S4jeWtmOWcqO+8ie+8jOesrOS6jOS4quS4uueUn+aIkOexu+eahOWQhOWxnuaAp+aWueazleWvueixoSDnlLHkuo7mr4/kuKrnsbvnmoTnlJ/miJDpg73ln7rkuo7lrZDnsbvlr7nniLbnsbvlr7nosaHnmoTmt7Hluqbmi7fotJ3vvIzlm6DmraTvvIwKICAgICAqIOS4uumBv+WFjeWtkOexu+WxnuaAp+abtOaUueWvueeItuexu+mAoOaIkOeahOS4jeWPr+aOp+W9seWTje+8jOmZpE51bWJlcnxTdHJpbmd8Qm9vbGVhbiDlpJbnmoTlr7nosaEg5Yid5aeL5YyW6YO95bu66K6u5pS+5Zyo5p6E6YCg5Ye95pWw5b2T5Lit5Y675YGaIOWIneWni+WMluWAvOW7uuiurgogICAgICog5Li6bnVsbAogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBuZXdDbGFzcyA9IG9jdG9wdXMuZGVmaW5lKHsKICAgICAqICAgICB3aWR0aDogNjQsCiAgICAgKiAgICAgbGVuZ3RoOiAiMTJweCIsCiAgICAgKiAgICAgcHJvcGVydHk6IG51bGwsCiAgICAgKiAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIHRoaXMucHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHt9KTsKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAgICovCiAgICBvLmRlZmluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBzID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICBpID0gYXJndW1lbnRzW2xlbiAtIDFdOwoKICAgICAgICB2YXIgbmMgPSB0eXBlb2YgaS5pbml0aWFsaXplID09ICJmdW5jdGlvbiIgPyBpLmluaXRpYWxpemUgOgogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIGlmKGxlbiA+IDEpIHsKICAgICAgICAgICAgdmFyIG5ld0FyZ3MgPSBbbmMsIHNdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLnNsaWNlKDEsIGxlbiAtIDEpLCBpKTsKICAgICAgICAgICAgby5pbmhlcml0LmFwcGx5KG51bGwsIG5ld0FyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZSA9IGk7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG5jOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmM7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLmluaGVyaXQKICAgICAqIEBkZXNjIOe7p+aJvwogICAgICogQHBhcmFtIGNoaWxkIHtGdW5jdGlvbn0g5a2Q57G7CiAgICAgKiBAcGFyYW0gZmF0aGVyIHtGdW5jdGlvbn0g54i257G7CiAgICAgKi8KICAgIG8uaW5oZXJpdCA9IGZ1bmN0aW9uKGNoaWxkLCBmYXRoZXIpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIGNwLAogICAgICAgICAgICBmcCA9IGZhdGhlci5wcm90b3R5cGU7CiAgICAgICAgZi5wcm90b3R5cGUgPSBmcDsKICAgICAgICBjcCA9IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBmOwogICAgICAgIGNwLmNvbnN0cnVjdG9yID0gY2hpbGQ7CiAgICAgICAgdmFyIGksIGwsIGs7CiAgICAgICAgZm9yKGkgPSAyLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBrID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZih0eXBlb2YgayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgayA9IGsucHJvdG90eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgayk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5leHRlbmQKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoeeahOWxnuaAp+WkjeWItue7meWPpuS4gOS4quWvueixoQogICAgICogQHBhcmFtIGRlc3RpbmF0aW9uIHtvYmplY3R9CiAgICAgKiBAcGFyYW0gc291cmNlIHtvYmplY3R9CiAgICAgKiBAcmV0dXJuIGRlc3RpbmF0aW9uIHtvYmplY3R9IOWkjeWItuWQjueahOWvueixoQogICAgICovCiAgICBvLmV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uIHx8IHt9OwogICAgICAgIGlmKHNvdXJjZSkgewogICAgICAgICAgICBmb3IodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc291cmNlW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIGlmKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSXNFdnQgPSB0eXBlb2Ygd2luZG93LkV2ZW50ID09ICJmdW5jdGlvbiIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSBpbnN0YW5jZW9mIHdpbmRvdy5FdmVudDsKCiAgICAgICAgICAgIGlmICghc291cmNlSXNFdnQgJiYgc291cmNlLmhhc093blByb3BlcnR5ICYmIHNvdXJjZS5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24udG9TdHJpbmcgPSBzb3VyY2UudG9TdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lc3BhY2Ugb2N0b3B1cy51dGlsCiAgICAgKiBAZGVzYyDlt6Xlhbfpm4blkIgg55u45b2T5LqOanF1ZXJ555qEZm4KICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8udXRpbCA9IG8udXRpbCB8fCB7fTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLnV0aWwubGFzdFNlcUlkCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBvLnV0aWwubGFzdFNlcUlkID0gMDsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNyZWF0ZVVuaXF1ZUlECiAgICAgKiBAcGFyYW0gcHJlZml4IHtTdHJpbmd9IOWJjee8gAogICAgICogQHJldHVybiB7U3RyaW5nfSDlhajlsYDllK/kuIDnmoTkuIDkuKrlrZfnrKbkuLIKICAgICAqLwogICAgby51dGlsLmNyZWF0ZVVuaXF1ZUlEID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICAgICAgcHJlZml4ID0gKHByZWZpeCA9PT0gbnVsbCB8fCBwcmVmaXggPT09IHVuZGVmaW5lZCkgPyAib2N0b3B1cyIgOiBwcmVmaXgucmVwbGFjZSgvXC4vZywgIl8iKTsKICAgICAgICBvLnV0aWwubGFzdFNlcUlkKys7CiAgICAgICAgcmV0dXJuIHByZWZpeCArIG8udXRpbC5sYXN0U2VxSWQ7CiAgICB9OwoKICAgIHdpbmRvdy5vY3RvcHVzID0gbzsKCn0pKHdpbmRvdyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiB1dGlsIC0gICDlt6Xlhbflh73mlbDpg6jliIYKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIOmBv+WFjeacquWjsOaYjiBvY3RvcHVzLnV0aWwKICAgICAqLwogICAgdmFyIHV0aWwgPSBvLnV0aWwgPSBvLnV0aWwgfHwge307CgogICAgLyoqCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLkxFRlQge1N0cmluZ30gImxlZnQiCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLlJJR0hUIHtTdHJpbmd9ICJyaWdodCIKICAgICAqIEBjb25zdCBvY3RvcHVzLnV0aWwuVVAge1N0cmluZ30gInVwIgogICAgICogQGNvbnN0IG9jdG9wdXMudXRpbC5ET1dOIHtTdHJpbmd9ICJkb3duIgogICAgICovCiAgICB1dGlsLkxFRlQgPSAibGVmdCI7CiAgICB1dGlsLlJJR0hUID0gInJpZ2h0IjsKICAgIHV0aWwuVVAgPSAidXAiOwogICAgdXRpbC5ET1dOID0gImRvd24iOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0Q2VudGVyCiAgICAgKiBAcGFyYW0gdG91Y2hlcyB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAgKiBAZGVzYyDojrflvpfmiYDmnInop6bmkbjngrnnmoTkuK3lv4MKICAgICAqLwogICAgdXRpbC5nZXRDZW50ZXIgPSBmdW5jdGlvbih0b3VjaGVzKSB7CiAgICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgICBmb3IodmFyIHQ9IDAsbGVuPXRvdWNoZXMubGVuZ3RoOyB0PGxlbjsgdCsrKSB7CiAgICAgICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICAgICAgdmFsdWVzWS5wdXNoKHRvdWNoZXNbdF0ucGFnZVkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgICAgcGFnZVk6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWSkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNZKSkgLyAyKQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0VmVsb2NpdHkKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOeerOenu+mAn+W6pgogICAgICogQHBhcmFtIGRlbHRhX3RpbWUge051bWJlcn0KICAgICAqIEBwYXJhbSBkZWx0YV94IHtOdW1iZXJ9CiAgICAgKiBAcGFyYW0gZGVsdGFfeSB7TnVtYmVyfQogICAgICogQHJldHVybiB7b2JqZWN0fSB45Li65qiq5ZCR6YCf5bqmIHnkuLrnurXlkJHpgJ/luqYKICAgICAqLwogICAgdXRpbC5nZXRWZWxvY2l0eSA9IGZ1bmN0aW9uKGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBNYXRoLmFicyhkZWx0YV94IC8gZGVsdGFfdGltZSkgfHwgMCwKICAgICAgICAgICAgeTogTWF0aC5hYnMoZGVsdGFfeSAvIGRlbHRhX3RpbWUpIHx8IDAKICAgICAgICB9OwoKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRBbmdsZQogICAgICogQGRlc2Mg6I635b6X5Lik54K56Ze06KeS5bqmCiAgICAgKiBAcGFyYW0gdG91Y2gxIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gdG91Y2gyIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0QW5nbGUgPSBmdW5jdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZLAogICAgICAgICAgICB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXREaXJlY3Rpb24KICAgICAqIEBkZXNjIOiOt+W+l+inpueisOa7keWKqOaWueWQkQogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICB1dGlsLmdldERpcmVjdGlvbiA9IGZ1bmN0aW9uKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHggPSBNYXRoLmFicyh0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVgpLAogICAgICAgICAgICB5ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZKTsKCiAgICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVggPiAwID8gdXRpbC5MRUZUIDogdXRpbC5SSUdIVDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gdXRpbC5VUCA6IHV0aWwuRE9XTjsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0RGlzdGFuY2UKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOi3neemuwogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7TnVtYmVyfQogICAgICovCiAgICB1dGlsLmdldERpc3RhbmNlID0gZnVuY3Rpb24odG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4ICogeCkgKyAoeSAqIHkpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRTY2FsZQogICAgICogQGRlc2Mg6I635b6X5Lik6Kem5pG454K55ruR5Yqo5ZCO5b6X5Yiw55qE5Lik6Kem5pG454K55LmL5LqO5LmL5YmN55qE5pS+5aSn5YCN5pWwCiAgICAgKiBAcGFyYW0gc3RhcnQge0FycmF5fQogICAgICogQHBhcmFtIGVuZCB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0U2NhbGUgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERpc3RhbmNlKGVuZFswXSwgZW5kWzFdKSAvCiAgICAgICAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmdldFJvdGF0aW9uCiAgICAgKiBAZGVzYyDojrflvpfkuKTop6bmkbjngrnmu5HliqjlkI7lvpfliLDnmoTkuKTop6bmkbjngrnkuYvkuo7kuYvliY3nmoTml4vovazluqbmlbAKICAgICAqIEBwYXJhbSBzdGFydCB7QXJyYXl9CiAgICAgKiBAcGFyYW0gZW5kIHtBcnJheX0KICAgICAqIEByZXR1cm4ge051bWJlcn0KICAgICAqLwogICAgdXRpbC5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QW5nbGUoZW5kWzFdLCBlbmRbMF0pIC0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW5jb2RlSHRtbAogICAgICogQGRlc2Mg5a+55a2X56ym5Liy5Lit55qE54m55q6K5a2X56ym6L+b6KGMaHRtbOe8lueggQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmVuY29kZUh0bWwgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nKHN0cikKICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgIiZhbXA7IikKICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgIiZsdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAiJmd0OyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC8iL2csICImcXVvdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiJiMzOTsiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5kZWNvZGVIdG1sCiAgICAgKiBAZGVzYyDlr7nlrZfnrKbkuLLkuK3nmoRodG1s6L+b6KGM57yW56CBCiAgICAgKiBAcGFyYW0gc3RyIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuaHRtbERlY29kZURpY3QgPSB7InF1b3QiOiAnIicsICJsdCI6ICI8IiwgImd0IjogIj4iLCAiYW1wIjogIiYiLCAiIzM5IjogIicifTsKICAgIHV0aWwuZGVjb2RlSHRtbCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8mKHF1b3R8bHR8Z3R8YW1wfCMzOSk7L2lnLCBmdW5jdGlvbihhbGwsIGtleSkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5odG1sRGVjb2RlRGljdFtrZXldOwogICAgICAgIH0pLnJlcGxhY2UoLyYjdShbYS1mXGRdezR9KTsvaWcsIGZ1bmN0aW9uKGFsbCwgaGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCgiMHgiICsgaGV4KSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UoLyYjKFxkKyk7L2lnLCBmdW5jdGlvbihhbGwsIG51bWJlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoK251bWJlcik7CiAgICAgICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmxvYWRJbWFnZQogICAgICogQGRlc2Mg5Yqg6L295Zu+54mH5pa55rOVCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9IOWbvueJh3VybAogICAgICogQHBhcmFtIHJlYWR5IHtGdW5jdGlvbn0g5q2k5pe25Zu+54mH5rKh5pyJ5Yqg6L295a6MIOS9huaYr+WuvemrmOW3suefpQogICAgICogQHBhcmFtIGxvYWQge0Z1bmN0aW9ufSDlm77niYdvbmxvYWTnmoRjYWxsYmFjawogICAgICogQHBhcmFtIGVycm9yIHtGdW5jdGlvbn0g5Zu+54mH5Yqg6L295aSx6LSl55qEY2FsbGJhY2sKICAgICAqLwogICAgdXRpbC5sb2FkSW1hZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXSwKICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGwsCiAgICAgICAgLy/nlKjmnaXmiafooYzpmJ/liJcKICAgICAgICAgICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdFtpXS5lbmQgPyBsaXN0LnNwbGljZShpLS0sIDEpIDogbGlzdFtpXSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICFsaXN0Lmxlbmd0aCAmJiBzdG9wKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgLy8g5YGc5q2i5omA5pyJ5a6a5pe25Zmo6Zif5YiXCiAgICAgICAgICAgIHN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh1cmwsIHJlYWR5LCBsb2FkLCBlcnJvcikgewogICAgICAgICAgICB2YXIgb25yZWFkeSwgd2lkdGgsIGhlaWdodCwgbmV3V2lkdGgsIG5ld0hlaWdodCwKICAgICAgICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgICAgICAgICAvLyDlpoLmnpzlm77niYfooqvnvJPlrZjvvIzliJnnm7TmjqXov5Tlm57nvJPlrZjmlbDmja4KICAgICAgICAgICAgaWYgKGltZy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgcmVhZHkuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgbG9hZCAmJiBsb2FkLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgIGhlaWdodCA9IGltZy5oZWlnaHQ7CiAgICAgICAgICAgIC8vIOWKoOi9vemUmeivr+WQjueahOS6i+S7tgogICAgICAgICAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGVycm9yICYmIGVycm9yLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIG9ucmVhZHkuZW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGltZyA9IGltZy5vbmxvYWQgPSBpbWcub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIOWbvueJh+WwuuWvuOWwsee7qgogICAgICAgICAgICBvbnJlYWR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbmV3V2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBpbWcuaGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKG5ld1dpZHRoICE9PSB3aWR0aCB8fCBuZXdIZWlnaHQgIT09IGhlaWdodCB8fCBuZXdXaWR0aCAqIG5ld0hlaWdodCA+IDEwMjQpIHsKICAgICAgICAgICAgICAgICAgICByZWFkeS5jYWxsKGltZyk7CiAgICAgICAgICAgICAgICAgICAgb25yZWFkeS5lbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgb25yZWFkeSgpOwogICAgICAgICAgICAvLyDlrozlhajliqDovb3lrozmr5XnmoTkuovku7YKICAgICAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIG9ubG9hZOWcqOWumuaXtuWZqOaXtumXtOW3ruiMg+WbtOWGheWPr+iDveavlG9ucmVhZHnlv6sKICAgICAgICAgICAgICAgIC8vIOi/memHjOi/m+ihjOajgOafpeW5tuS/neivgW9ucmVhZHnkvJjlhYjmiafooYwKICAgICAgICAgICAgICAgICFvbnJlYWR5LmVuZCAmJiBvbnJlYWR5KCk7CiAgICAgICAgICAgICAgICBsb2FkICYmIGxvYWQuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgLy8gSUUgZ2lm5Yqo55S75Lya5b6q546v5omn6KGMb25sb2Fk77yM572u56m6b25sb2Fk5Y2z5Y+vCiAgICAgICAgICAgICAgICBpbWcgPSBpbWcub25sb2FkID0gaW1nLm9uZXJyb3IgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyDliqDlhaXpmJ/liJfkuK3lrprmnJ/miafooYwKICAgICAgICAgICAgaWYoIW9ucmVhZHkuZW5kKSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2gob25yZWFkeSk7CiAgICAgICAgICAgICAgICAvLyDml6DorrrkvZXml7blj6rlhYHorrjlh7rnjrDkuIDkuKrlrprml7blmajvvIzlh4/lsJHmtY/op4jlmajmgKfog73mjZ/ogJcKICAgICAgICAgICAgICAgIGlmIChpbnRlcnZhbElkID09PSBudWxsKSBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodGljaywgNDApOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KSgpOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW1wdHkKICAgICAqIEBkZXNjIOepuuWHveaVsAogICAgICovCiAgICB1dGlsLmVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmJpbmQKICAgICAqIEBkZXNjIOaNouS9nOeUqOWfnwogICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBvYmplY3QpIHsKICAgICAgICAvLyBjcmVhdGUgYSByZWZlcmVuY2UgdG8gYWxsIGFyZ3VtZW50cyBwYXN0IHRoZSBzZWNvbmQgb25lCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMl0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gUHVzaCBvbiBhbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgZnJvbSB0aGUgYWN0dWFsIGZ1bmN0aW9uIGNhbGwuCiAgICAgICAgICAgIC8vIFRoZXNlIHdpbGwgY29tZSBhZnRlciB0aG9zZSBzZW50IHRvIHRoZSBiaW5kIGNhbGwuCiAgICAgICAgICAgIHZhciBuZXdBcmdzID0gYXJncy5jb25jYXQoCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMF0pCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iamVjdCwgbmV3QXJncyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5iaW5kQXNFdmVudExpc3RlbmVyCiAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOS9nOS4uuS6i+S7tuebkeWQrOeahOWHveaVsAogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDkvZznlKjln58KICAgICAqLwogICAgdXRpbC5iaW5kQXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24oZnVuYywgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwob2JqZWN0LCBldmVudCB8fCB3aW5kb3cuZXZlbnQpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNOb2RlCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/oioLngrkKICAgICAqIEBwYXJhbSBvIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKG8pIHsKICAgICAgICByZXR1cm4gISEobyAmJiBvLm5vZGVUeXBlID09PSAxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc09iamVjdAogICAgICogQGRlc2Mg5Yik5pat5a+56LGh5piv5ZCm5piv5a+56LGhCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzT2JqZWN0ID0gZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiAnZnVuY3Rpb24nID09IHR5cGVvZiBzb3VyY2UgfHwgISEoc291cmNlICYmICdvYmplY3QnID09IHR5cGVvZiBzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzU3RyaW5nCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/lrZfnrKbkuLIKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNTdHJpbmcgPSBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuICdbb2JqZWN0IFN0cmluZ10nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzQXJyYXkKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOe7hAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdXRpbC5pc0FycmF5ID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgcmV0dXJuICgnW29iamVjdCBBcnJheV0nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc051bWVyaWMKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOWtlwogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNOdW1lcmljID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG9iaikpICYmIGlzRmluaXRlKG9iaik7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNQbGFpbgogICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5piv5pmu6YCa5a+56LGhIOmdnmZ1bmN0aW9uCiAgICAgKi8KICAgIHV0aWwuaXNQbGFpbiAgPSBmdW5jdGlvbihvYmopewogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgICAgIGtleTsKICAgICAgICBpZiAoICFvYmogfHwKICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8CiAgICAgICAgICAgICEoJ2lzUHJvdG90eXBlT2YnIGluIG9iaikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAgICAgIWhhc093blByb3BlcnR5LmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgogICAgICAgICAgICAhaGFzT3duUHJvcGVydHkuY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpICkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQogICAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKCBvYmosIGtleSApOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzRW1wdHkKICAgICAqIEBkZXNjIOWIpOaWreS8oOWFpeeahOWPguaVsOaYr+WQpuS4uuepuu+8jAogICAgICogICAgICAg5YyF5ousdW5kZWZpbmVkLCBudWxsLCBmYWxzZSwgbnVtYmVyIDAsCiAgICAgKiAgICAgICBlbXB0eSBzdHJpbmcsIHN0cmluZyAiMCIsIHt9IGFuZCBbXQogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNFbXB0eSA9IGZ1bmN0aW9uKG1peGVkX3ZhcikgewogICAgICAgIHZhciB1bmRlZiwga2V5LCBpLCBsZW47CiAgICAgICAgdmFyIGVtcHR5VmFsdWVzID0gW3VuZGVmLCBudWxsLCBmYWxzZSwgMCwgIiIsICIwIl07CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVtcHR5VmFsdWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtaXhlZF92YXIgPT09IGVtcHR5VmFsdWVzW2ldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBtaXhlZF92YXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG1peGVkX3ZhcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNsb25lCiAgICAgKiBAZGVzYyDmt7Hluqbmi7fotJ3kuIDkuKrlr7nosaEKICAgICAqIEByZXR1cm4g5ou36LSd5ZCO55qE5a+56LGhCiAgICAgKi8KICAgIHV0aWwuY2xvbmUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gc291cmNlLCBpLCBsZW47CiAgICAgICAgaWYgKCFzb3VyY2UKICAgICAgICAgICAgfHwgc291cmNlIGluc3RhbmNlb2YgTnVtYmVyCiAgICAgICAgICAgIHx8IHNvdXJjZSBpbnN0YW5jZW9mIFN0cmluZwogICAgICAgICAgICB8fCBzb3VyY2UgaW5zdGFuY2VvZiBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmKHV0aWwuaXNOb2RlKHNvdXJjZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh1dGlsLmlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdExlbiA9IDAsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHNvdXJjZS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRMZW4rK10gPSB1dGlsLmNsb25lKHNvdXJjZVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNQbGFpbihzb3VyY2UpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBmb3IgKGkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gdXRpbC5jbG9uZShzb3VyY2VbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZWFjaAogICAgICogQHBhcmFtIHNvdXJjZSB7QXJyYXkgfCBPYmplY3R9CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICogQHJldHVybnMgeyp9CiAgICAgKiBAZGVzYyDpgY3ljobmlbDnu4TmiJblr7nosaEKICAgICAqLwogICAgdXRpbC5lYWNoID0gZnVuY3Rpb24oc291cmNlLCBjYWxsYmFjaykgewogICAgICAgIGlmKHV0aWwuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgIHJldHVybiBBcnJheS5mb3JFYWNoID8gc291cmNlLmZvckVhY2goY2FsbGJhY2spIDogZnVuY3Rpb24oYXIsIGZ1bmMpIHsKICAgICAgICAgICAgICAgIHZhciBsZW4gPSBhci5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5jYWxsKHRoaXMsIGFyW2ldLCBpKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KHNvdXJjZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBpZih1dGlsLmlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwodGhpcywgc291cmNlW2tdLCBrKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5mb3JtYXQKICAgICAqIEBwYXJhbSBzdHIge1N0cmluZ30g5b6F6L2s5o2i55qE5a2X56ym5LiyCiAgICAgKiBAcGFyYW0gZGF0YSB7fSDmlbDmja4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuZm9ybWF0ID0gZnVuY3Rpb24oc3RyLCBkYXRhKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oIylceyguKj8pXH0vZywgZnVuY3Rpb24oYWxsLCBmbGFnLCBwYXJhbSkgewogICAgICAgICAgICByZXR1cm4gZGF0YSAmJiB0eXBlb2YgZGF0YVtwYXJhbV0gIT0gInVuZGVmaW5lZCIgPyBkYXRhW3BhcmFtXSA6ICIiOwogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmFwcGx5RGVmYXVsdHMKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoemHjOayoeacieeahOWPguaVsOWkjeWItue7meWPpuS4gOS4quWvueixoSDkuI5leHRlbmTnmoTljLrliKvlnKjkuo4g5aaC5p6c5LiN5Lya5aSN5Yi25bey5a2Y5Zyo5bGe5oCnCiAgICAgKiBAcGFyYW0gdG8ge09iamVjdH0KICAgICAqIEBwYXJhbSBmcm9tIHtPYmplY3R9CiAgICAgKi8KICAgIHV0aWwuYXBwbHlEZWZhdWx0cyA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgaWYodG9ba2V5XSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAoIWZyb21Jc0V2dCAmJiBmcm9tLmhhc093blByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF0by5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgICAgICAgdG9ba2V5XSA9IGZyb21ba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighZnJvbUlzRXZ0ICYmIGZyb20gJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eQogICAgICAgICAgICAmJiBmcm9tLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpICYmICF0by5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgewogICAgICAgICAgICB0by50b1N0cmluZyA9IGZyb20udG9TdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0bzsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5hcHBseUFkZAogICAgICogQGRlc2Mg5bCG5LiA5Liq5a+56LGh6YeM55qE5Y+C5pWw5rex5bqm5ou36LSd57uZ5Y+m5LiA5Liq5a+56LGhIOWmguaenOWPguaVsOW3suWtmOWcqCDliJnopobnm5Yg5aaC5p6c5LiN5a2Y5ZyoIOWImei/veWKoAogICAgICogQHBhcmFtIHRvIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gZnJvbSAge09iamVjdH0KICAgICAqLwogICAgdXRpbC5hcHBseUFkZCA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yKHZhciBrIGluIGZyb20pIHsKICAgICAgICAgICAgaWYodXRpbC5pc09iamVjdCh0b1trXSkgJiYgdXRpbC5pc09iamVjdChmcm9tW2tdKSkgewogICAgICAgICAgICAgICAgdG9ba10gPSB1dGlsLmFwcGx5QWRkKHRvW2tdLCBmcm9tW2tdKTsKICAgICAgICAgICAgfSBlbHNlIGlmKGZyb21ba10gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdG9ba10gPSBmcm9tW2tdCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoIWZyb21Jc0V2dCAmJiBmcm9tICYmIGZyb20uaGFzT3duUHJvcGVydHkKICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSAmJiAhdG8uaGFzT3duUHJvcGVydHkoJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgdG8udG9TdHJpbmcgPSBmcm9tLnRvU3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG87CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwudXJsQXBwZW5kCiAgICAgKiBAZGVzYyDlsIbmjIflrprlrZfnrKbkuLLph4znmoTlhoXlrrnmi7zov5t1cmwKICAgICAqIEBwYXJhbSB1cmwge1N0cmluZ30KICAgICAqIEBwYXJhbSBwYXJhbVN0ciB7U3RyaW5nfQogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20iOwogICAgICogb2N0b3B1cy51dGlsLnVybEFwcGVuZCh1cmwsICJhPTEmYj0yIik7CiAgICAgKiByZXR1cm4gImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9hPTEmYj0yIgogICAgICovCiAgICB1dGlsLnVybEFwcGVuZCA9IGZ1bmN0aW9uKHVybCwgcGFyYW1TdHIpIHsKICAgICAgICB2YXIgbmV3VXJsID0gdXJsOwogICAgICAgIGlmKHBhcmFtU3RyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9ICh1cmwgKyAiICIpLnNwbGl0KC9bPyZdLyk7CiAgICAgICAgICAgIG5ld1VybCArPSAocGFydHMucG9wKCkgPT09ICIgIiA/CiAgICAgICAgICAgICAgICBwYXJhbVN0ciA6CiAgICAgICAgICAgICAgICBwYXJ0cy5sZW5ndGggPyAiJiIgKyBwYXJhbVN0ciA6ICI/IiArIHBhcmFtU3RyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1VybDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcKICAgICAqIEBkZXNjIOS7juaMh+WumuWQjeWAvOWvuemHjOaQnuWHuuadpeWtl+espuS4suW9ouW8jwogICAgICogQHBhcmFtIHBhcmFtcyB7T2JqZWN0fQogICAgICogQGV4YW1wbGUKICAgICAqIHBhcmFtID0geyBhOiAxLCBiOiAyIH0KICAgICAqIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcocGFyYW0pCiAgICAgKiByZXR1cm4gImE9MSZiPTIiCiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgdmFyIHBhcmFtc0FycmF5ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgaWYgKCh2YWx1ZSAhPSBudWxsKSAmJiAodHlwZW9mIHZhbHVlICE9ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICB2YXIgZW5jb2RlZFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbmNvZGVkSXRlbUFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaXRlbUluZGV4PTAsIGxlbj12YWx1ZS5sZW5ndGg7IGl0ZW1JbmRleDxsZW47IGl0ZW1JbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2YWx1ZVtpdGVtSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSXRlbUFycmF5LnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogaXRlbSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZFZhbHVlID0gZW5jb2RlZEl0ZW1BcnJheS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyYW1zQXJyYXkucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtc0FycmF5LmpvaW4oIiYiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJzCiAgICAgKiBAZGVzYyDku451cmzkuK0/5ZCO55qE5a2X56ym5Liy5Lul5a+56LGh5b2i5byP6L+U5ZueCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAgKiBAZXhhbXBsZQogICAgICogdXJsID0gImh0dHA6Ly93d3cuYmFpZHUuY29tP2E9MSZiPTIiCiAgICAgKiBvY3RvcHVzLnV0aWwuZ2V0UGFyYW1ldGVycyh1cmwpOwogICAgICogcmV0dXJuIHsgYTogMSwgYjogMiB9CiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHVybCA9ICh1cmwgPT09IG51bGwgfHwgdXJsID09PSB1bmRlZmluZWQpID8gd2luZG93LmxvY2F0aW9uLmhyZWYgOiB1cmw7CiAgICAgICAgdmFyIHBhcmFtc1N0cmluZyA9ICIiOwogICAgICAgIGlmKHVybC5pbmRleE9mKCI/IikgIT0gLTEpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdXJsLmluZGV4T2YoJz8nKSArIDE7CiAgICAgICAgICAgIHZhciBlbmQgPSB1cmwuaW5kZXhPZigiIyIpICE9IC0xID8KICAgICAgICAgICAgICAgIHVybC5pbmRleE9mKCcjJykgOiB1cmwubGVuZ3RoOwogICAgICAgICAgICBwYXJhbXNTdHJpbmcgPSB1cmwuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgICB2YXIgcGFyYW1ldGVycyA9IHt9OwogICAgICAgIHZhciBwYWlycyA9IHBhcmFtc1N0cmluZy5zcGxpdCgvWyY7XS8pLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcGFpcnMubGVuZ3RoOwogICAgICAgIGZvciggOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlID0gcGFpcnNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgaWYoa2V5VmFsdWVbMF0pIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZVswXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZGVjb2RlVVJJQ29tcG9uZW50KGtleSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSB1bmVzY2FwZShrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gKGtleVZhbHVlWzFdIHx8ICcnKS5yZXBsYWNlKC9cKy9nLCAiICIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZXNjYXBlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1ldGVyczsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5jcmVhdGVVcmxPYmplY3QKICAgICAqIEBkZXNjIOWIm+W7uuS4gOS4qnVybOWvueixoeeahOWQjeWAvOWvuQogICAgICog6YeM6Z2i5oyJ54WndzNjIHVybOagh+WHhuaPkOS+m+S6huavj+S4gOS4queahOWAvAogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20/YT0xJmI9MiNhYmM9MSI7CiAgICAgKiBvY3RvcHVzLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgKiByZXR1cm4KICAgICAqIHsKICAgICAqICBhcmdzOiBPYmplY3QsCiAgICAgKiAgYTogIjEiLAogICAgICogIGI6ICIyIiwKICAgICAqICBoYXNoOiAiI2FiYz0xIiwKICAgICAqICBob3N0OiAid3d3Lmdvb2dsZS5jb20iLAogICAgICogIHBhdGhuYW1lOiAiLyIsCiAgICAgKiAgcG9ydDogIjgwIiwKICAgICAqICBwcm90b2NvbDogImh0dHA6IiwKICAgICAqIH0KICAgICAqLwogICAgdXRpbC5jcmVhdGVVcmxPYmplY3QgPSBmdW5jdGlvbih1cmwsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgaWYoISgvXlx3KzpcL1wvLykudGVzdCh1cmwpKSB7CiAgICAgICAgICAgIHZhciBsb2MgPSB3aW5kb3cubG9jYXRpb247CiAgICAgICAgICAgIHZhciBwb3J0ID0gbG9jLnBvcnQgPyAiOiIgKyBsb2MucG9ydCA6ICIiOwogICAgICAgICAgICB2YXIgZnVsbFVybCA9IGxvYy5wcm90b2NvbCArICIvLyIgKyBsb2MuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCkgKyBwb3J0OwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZigiLyIpID09PSAwKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBmdWxsVXJsICsgdXJsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbG9jLnBhdGhuYW1lLnNwbGl0KCIvIik7CiAgICAgICAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgIHVybCA9IGZ1bGxVcmwgKyBwYXJ0cy5qb2luKCIvIikgKyAiLyIgKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlQ2FzZSkgewogICAgICAgICAgICB1cmwgPSB1cmwudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgIHZhciB1cmxPYmplY3QgPSB7fTsKICAgICAgICB1cmxPYmplY3QuaG9zdCA9IGEuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCk7CiAgICAgICAgdXJsT2JqZWN0LnByb3RvY29sID0gYS5wcm90b2NvbDsKICAgICAgICBpZihvcHRpb25zLmlnbm9yZVBvcnQ4MCkgewogICAgICAgICAgICB1cmxPYmplY3QucG9ydCA9IChhLnBvcnQgPT0gIjgwIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICIiIDogYS5wb3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVybE9iamVjdC5wb3J0ID0gKGEucG9ydCA9PSAiIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICI4MCIgOiBhLnBvcnQ7CiAgICAgICAgfQoKICAgICAgICAvL2hhc2gKICAgICAgICB1cmxPYmplY3QuaGFzaCA9IChvcHRpb25zLmlnbm9yZUhhc2ggfHwgYS5oYXNoID09PSAiIyIpID8gIiIgOiBhLmhhc2g7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gYS5zZWFyY2g7CiAgICAgICAgaWYgKCFxdWVyeVN0cmluZykgewogICAgICAgICAgICB2YXIgcU1hcmsgPSB1cmwuaW5kZXhPZigiPyIpOwogICAgICAgICAgICBxdWVyeVN0cmluZyA9IChxTWFyayAhPSAtMSkgPyB1cmwuc3Vic3RyKHFNYXJrKSA6ICIiOwogICAgICAgIH0KICAgICAgICB1cmxPYmplY3QuYXJncyA9IHV0aWwuZ2V0UGFyYW1ldGVycyhxdWVyeVN0cmluZyk7CiAgICAgICAgdXJsT2JqZWN0LnBhdGhuYW1lID0gKGEucGF0aG5hbWUuY2hhckF0KDApID09ICIvIikgPyBhLnBhdGhuYW1lIDogIi8iICsgYS5wYXRobmFtZTsKICAgICAgICByZXR1cm4gdXJsT2JqZWN0OwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLnRyaW0KICAgICAqIEBkZXNjIOWOu+aOieWtl+espuS4suS4pOS+p+epuueZvQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLnRyaW0gPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgICByZXR1cm4gISFzdHIudHJpbSA/IHN0ci50cmltKCkgOiBzdHIucmVwbGFjZShuZXcgUmVnRXhwKCIoXltcXHNcXHRcXHhhMFxcdTMwMDBdKyl8KFtcXHUzMDAwXFx4YTBcXHNcXHRdK1x4MjQpIiwgImciKSwgJycpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5yZW1vdmVJdGVtCiAgICAgKiBAcGFyYW0gc291cmNlCiAgICAgKiBAcGFyYW0gaXRlbQogICAgICovCiAgICB1dGlsLnJlbW92ZUl0ZW0gPSBmdW5jdGlvbihzb3VyY2UsIGl0ZW0pIHsKICAgICAgICB2YXIgbGVuID0gc291cmNlLmxlbmd0aCwKICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICBpZihzb3VyY2VbaV0gPT09IGl0ZW0pIHsKICAgICAgICAgICAgICAgIHNvdXJjZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC51cHBlckNhc2VPYmplY3QKICAgICAqIEBkZXNjIOWwhuaMh+WumuWvueixoemHjOeahGtleemmluWtl+avjeWkp+WGmQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLnVwcGVyQ2FzZU9iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgdU9iamVjdCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgdU9iamVjdFtrZXkudG9VcHBlckNhc2UoKV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVPYmplY3Q7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY2FtZWxpemUKICAgICAqIEBkZXNjIOmpvOWzsOWMluWtl+espuS4sgogICAgICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmNhbWVsaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdmFyIG9TdHJpbmdMaXN0ID0gc291cmNlLnNwbGl0KC9bXC18X3xcc3xcLl0vZyk7CiAgICAgICAgdmFyIGNhbWVsaXplZFN0cmluZyA9IG9TdHJpbmdMaXN0WzBdLAogICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgbGVuID0gb1N0cmluZ0xpc3QubGVuZ3RoOwogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzID0gb1N0cmluZ0xpc3RbaV07CiAgICAgICAgICAgIGNhbWVsaXplZFN0cmluZyArPSBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYW1lbGl6ZWRTdHJpbmc7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuc3R5bGVDc3MKICAgICAqIEBkZXNjIOWwhuWJjee8gOexu2NzcyDmoLflvI/ljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY3NzID0gIi13ZWJraXQtdHJhbnNpdGlvbiI7CiAgICAgKiBvY3RvcHVzLnV0aWwuc3R5bGVDc3MoY3NzKTsKICAgICAqIHJldHVybiAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqLwogICAgdXRpbC5zdHlsZUNzcyA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBmbGFnID0gdHJ1ZTsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoL1wtKFxTKS9nLCBmdW5jdGlvbigkMSwgJDIpIHsKICAgICAgICAgICAgcmV0dXJuIGZsYWcgPyAoZmxhZyA9IGZhbHNlLCAkMikgOiAkMi50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY3NzU3R5bGUKICAgICAqIEBkZXNjIOWwhuagt+W8j+WMlueahOWJjee8gCBjc3PljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgc3R5bGUgPSAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqIG9jdG9wdXMudXRpbC5jc3NTdHlsZShzdHlsZSk7CiAgICAgKiByZXR1cm4gLXdlYmtpdC10cmFuc2l0aW9uCiAgICAgKi8KICAgIHV0aWwuY3NzU3R5bGUgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoLyheXFN8W0EtWl0pL2csIGZ1bmN0aW9uKCQxKSB7CiAgICAgICAgICAgIHJldHVybiAiLSIgKyAkMS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwucmVxdWVzdEFuaW1hdGlvbgogICAgICovCiAgICB1dGlsLnJlcXVlc3RBbmltYXRpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxNik7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHJlcXVlc3QuYXBwbHkod2luZG93LCBbY2FsbGJhY2ssIGVsZW1lbnRdKTsKICAgICAgICB9OwogICAgfSkoKTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiBkb20gLSAgIGRvbeaTjeS9nOmDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlt6Xlhbflh73mlbDnmoTlkb3lkI3nqbrpl7QKICAgICAgICAgKi8KICAgICAgICB1ID0gby51dGlsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlo7DmmI5kb2N1bWVudAogICAgICAgICAqLwogICAgICAgIGRvYyA9IGRvY3VtZW50OwoKICAgIGZ1bmN0aW9uIGdldFNjcmVlbkJ5KHQpIHsKICAgICAgICB2YXIgdiA9IHdpbmRvd1siaW5uZXIiICsgdF0sCiAgICAgICAgICAgIF92ID0gKHUuaXNOdW1lcmljKHYpICYmIHYgPiAwKSA/IHYgOgogICAgICAgICAgICAgICAgKGRvYy5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IikgPyBkb2MuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgdF0gOiBvLmRvbVsiZ2V0IiArIHRdKGRvYy5ib2R5KTsKICAgICAgICByZXR1cm4gX3YgPiAwID8gX3YgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmRvbQogICAgICogQGRlc2Mg5LiA5Lqb5Z+656GA55qEZG9t5pON5L2cCiAgICAgKi8KICAgIG8uZG9tID0gewogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZwogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOmdoGlk5ou/5Liq6IqC54K5IOeUseS6juWPquaYr+eugOWNleaUr+aMgSDmsqHmnInlv4XopoHlhpnlvpfpgqPkuYjpq5jnuqcKICAgICAgICAgKi8KICAgICAgICBnOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSAodS5pc1N0cmluZyhlbCkgPyBkb2MuZ2V0RWxlbWVudEJ5SWQoZWwpIDogKHUuaXNPYmplY3QoZWwpICYmIGVsKSk7CiAgICAgICAgICAgIHJldHVybiBlbCB8fCBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uJAogICAgICAgICAqIEBwYXJhbSBmaWx0ZXIKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAZGVzYyDkuI3mg7Pph43lpI3nmoTljrvlhpnov5nkuYjlpJog5ou/5Yiw5LiA5Liq6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgJDogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yQWxsKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ub25lCiAgICAgICAgICogQHBhcmFtIGZpbHRlcgogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOaLv+WIsOaMh+WumuiKgueCueS4i+eahOaWh+aho+a1gemHjOeahOesrOS4gOS4quiKgueCuQogICAgICAgICAqLwogICAgICAgIG9uZTogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uaGFzQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKTmlq3oioLngrnmnIljbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lczsKICAgICAgICAgICAgcmV0dXJuICEhZWwuY2xhc3NMaXN0ID8gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpIDoKICAgICAgICAgICAgICAgIChuYW1lcyA9IGVsLmNsYXNzTmFtZSwgISFuYW1lcyAmJiBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIG5hbWUgKyAiKFxcc3wkKSIpLnRlc3QobmFtZXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmFkZENsYXNzCiAgICAgICAgICogQGRlc2Mg57uZ5oyH5a6a6IqC54K55aKe5YqgY2xhc3MKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWwsIG5hbWUpIHsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBuYW1lID0gbmFtZSB8fCBudWxsOwogICAgICAgICAgICBpZighbmFtZSkgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBjbGFzc0xpc3QgPSBlbC5jbGFzc0xpc3Q7CiAgICAgICAgICAgIGlmKCEhY2xhc3NMaXN0KSB7CiAgICAgICAgICAgICAgICBpZighY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmKCFvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgKz0gKGVsLmNsYXNzTmFtZSA/ICIgIiA6ICIiKSArIG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ucmVtb3ZlQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKDpmaTmjIflrproioLngrnnmoTmjIflrppjbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lcywKICAgICAgICAgICAgICAgIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKICAgICAgICAgICAgaWYoISFjbGFzc0xpc3QpIHsKICAgICAgICAgICAgICAgIGlmKGNsYXNzTGlzdC5jb250YWlucyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IGVsLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgICAgICBpZihuYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSB1LnRyaW0obmFtZXMpLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKCIoXnxcXHMrKSIgKyBuYW1lICsgIihcXHMrfCQpIiksICIgIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS50b2dnbGVDbGFzcwogICAgICAgICAqIEBkZXNjIHRvZ2dsZeaMh+WumuiKgueCueeahOaMh+Wumuagt+W8jwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudCB8IFN0cmluZ30g5oyH5a6a6IqC54K5CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30g5oyH5a6a5qC35byPCiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGVsLCBuYW1lKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHQgPSBvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSk7CiAgICAgICAgICAgIGlmKHQpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRXaWR0aAogICAgICAgICAqIEBkZXNjIOiOt+W+l+aMh+WumuiKgueCueeahOWuveW6pgogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRXaWR0aDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgdmFyIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHdpZHRoID0gISFlbC5vZmZzZXRXaWR0aCA/IGVsLm9mZnNldFdpZHRoIDogZWwuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHJldHVybiB3aWR0aCA+IDAgPyB3aWR0aCA6IDA7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5XaWR0aAogICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6I635b6X5bGP5bmV5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NyZWVuV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0U2NyZWVuQnkoIldpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5IZWlnaHQKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiOt+W+l+Wxj+W5lemrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTY3JlZW5CeSgiSGVpZ2h0Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRIZWlnaHQKICAgICAgICAgKiBAZGVzYyDojrflvpfmjIflrproioLngrnpq5jluqYKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0SGVpZ2h0OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gISFlbC5vZmZzZXRIZWlnaHQgPyBlbC5vZmZzZXRIZWlnaHQgOiBlbC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIHJldHVybiBoZWlnaHQgPiAwID8gaGVpZ2h0IDogMDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmluc2VydEFmdGVyCiAgICAgICAgICogQGRlc2Mg5o+S5Yiw5oyH5a6a6IqC54K55ZCO6Z2iCiAgICAgICAgICogQHBhcmFtIG5ld2RvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdGFyZG9tIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGluc2VydEFmdGVyOiBmdW5jdGlvbihuZXdkb20sIHRhcmRvbSkgewogICAgICAgICAgICBuZXdkb20gPSBvLmcobmV3ZG9tKTsKICAgICAgICAgICAgdGFyZG9tID0gby5nKHRhcmRvbSk7CiAgICAgICAgICAgIHRhcmRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdkb20sIHRhcmRvbS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIHJldHVybiBuZXdkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5pbnNlcnRGaXJzdAogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBwYXJhbSBjb250YWluZXIKICAgICAgICAgKi8KICAgICAgICBpbnNlcnRGaXJzdDogZnVuY3Rpb24oZWwsIGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpLAogICAgICAgICAgICAgICAgY29udGFpbmVyID0gby5nKGNvbnRhaW5lciksCiAgICAgICAgICAgICAgICBmaXJzdENoaWxkID0gY29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmKCFmaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShlbCwgZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNldFN0eWxlcwogICAgICAgICAqIEBkZXNjIOaJuemHj+i1i+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9CiAgICAgICAgICogQHBhcmFtIGlzaW5pdCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZXM6IGZ1bmN0aW9uKGVsLCBvYmosIGlzaW5pdCkgewogICAgICAgICAgICBpc2luaXQgPSBpc2luaXQgfHwgZmFsc2U7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoaXNpbml0KSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcih2YXIgayBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmKCFpc2luaXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2sgPSBrOwogICAgICAgICAgICAgICAgICAgIGlmKGsubWF0Y2goL14tKHdlYmtpdHxvfG1zfG1veikvZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2sgID0gdS5zdHlsZUNzcyhrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbX2tdID0gb2JqW2tdOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3NzVGV4dCArPSBrICsgIjogIiArIG9ialtrXSArICI7IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighIWNzc1RleHQpIHsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTdHlsZQogICAgICAgICAqIEBkZXNjIOiOt+WPluaMh+WumuiKgueCueeahOaMh+WumuWxnuaAp+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gc3R5bGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRTdHlsZTogZnVuY3Rpb24oZWwsIHN0eWxlKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGVsICYmIGVsLnN0eWxlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLnN0eWxlW3UuY2FtZWxpemUoc3R5bGUpXTsKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmRlZmF1bHRWaWV3ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjc3MgPSBkb2MuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY3NzID8gY3NzLmdldFByb3BlcnR5VmFsdWUoc3R5bGUpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLmN1cnJlbnRTdHlsZVt1LmNhbWVsaXplKHN0eWxlKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IFsnbGVmdCcsICd0b3AnLCAncmlnaHQnLCAnYm90dG9tJ107CiAgICAgICAgICAgICAgICBpZiAod2luZG93Lm9wZXJhICYmCiAgICAgICAgICAgICAgICAgICAgKHBvc2l0aW9ucy5pbmRleE9mKHN0eWxlKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAoby5kb20uZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSAnYXV0bycgPyBudWxsIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRQYXJlbnROb2RlCiAgICAgICAgICogQGRlc2Mg5p+l6K+i56ym5ZCI5p2h5Lu255qE56a75oyH5a6a6IqC54K55pyA6L+R55qE54i26IqC54K5CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50IHwgU3RyaW5nfSDooqvmn6Xmib7nmoTotbflp4voioLngrkKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOetm+mAieWZqAogICAgICAgICAqIEBwYXJhbSBtYXhEZXB0aCB7TnVtYmVyfSDmn6XnnIvnmoTmnIDmt7HlsYLmlbAKICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnROb2RlOiBmdW5jdGlvbihlbCwgZmlsdGVyLCBtYXhEZXB0aCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBtYXhEZXB0aCA9IG1heERlcHRoIHx8IDUwOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwLAogICAgICAgICAgICAgICAgX2VsID0gbnVsbDsKICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnROb2RlOwogICAgICAgICAgICB3aGlsZSh1LmlzTm9kZShlbCkgJiYgKGRlcHRoIDwgbWF4RGVwdGgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZmlsdGVyKTsKICAgICAgICAgICAgICAgIGlmKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGxpc3QsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodS5pc05vZGUoaXRlbSkgJiYgaXRlbSA9PSBlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbCA9IGVsLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZihfZWwgfHwgZWwudGFnTmFtZSA9PSAiSFRNTCIpCWJyZWFrOwogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2VsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZ2V0UG9zaXRpb24KICAgICAgICAgKiBAZGVzYyDojrflvpflhYPntKDnm7jlr7nkuo7mtY/op4jlmajlt6bkuIrop5LnmoTlnZDmoIcKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0UG9zaXRpb246IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIGRvYyA9ICEhZWwub3duZXJEb2N1bWVudCA/IGVsLm93bmVyRG9jdW1lbnQgOiBlbCwKICAgICAgICAgICAgICAgIGdldFN0eWxlID0gby5kb20uZ2V0U3R5bGUsCiAgICAgICAgICAgICAgICBwb3MgPSB7ImxlZnQiOiAwLCAidG9wIjogMH0sCiAgICAgICAgICAgICAgICB2aWV3cG9ydCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbDsKICAgICAgICAgICAgaWYoZWwgPT0gdmlld3BvcnQpewogICAgICAgICAgICAgICAgcmV0dXJuIHBvczsKICAgICAgICAgICAgfQogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBwb3MubGVmdCArPSBwYXJlbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgICAgIHBvcy50b3AgICs9IHBhcmVudC5vZmZzZXRUb3A7CiAgICAgICAgICAgICAgICBpZiAoZ2V0U3R5bGUocGFyZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zLmxlZnQgKz0gZG9jLmJvZHkuc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wICArPSBkb2MuYm9keS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9IHdoaWxlIChwYXJlbnQgJiYgcGFyZW50ICE9IGVsKTsKICAgICAgICAgICAgaWYoZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdhYnNvbHV0ZScpewogICAgICAgICAgICAgICAgcG9zLnRvcCAgLT0gZG9jLmJvZHkub2Zmc2V0VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IGVsLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQgIT0gZG9jLmJvZHkpIHsKICAgICAgICAgICAgICAgIHBvcy5sZWZ0IC09IHBhcmVudC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgaWYgKHBhcmVudC50YWdOYW1lICE9ICdUUicpIHsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wIC09IHBhcmVudC5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5jcmVhdGVEb20KICAgICAgICAgKiBAZGVzYyDliJvlu7pkb23oioLngrkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBkb23nsbvlnosKICAgICAgICAgKiBAcGFyYW0gYXR0cyB7T2JqZWN0fSBkb23lsZ7mgKflkI3lgLzlr7kKICAgICAgICAgKiBAcGFyYW0gc3R5cyB7T2JqZWN0fSBkb23moLflvI/lkI3lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVEb206IGZ1bmN0aW9uKHR5cGUsIGF0dHMsIHN0eXMpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGRvYy5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICBhdHRzICYmIHUuZWFjaChhdHRzLCBmdW5jdGlvbih2LCBhdHQpIHsKICAgICAgICAgICAgICAgIGlmKGF0dCA9PSAiaW5uZXJIVE1MIiB8fCBhdHQgPT0gImlubmVyVGV4dCIpIHsKICAgICAgICAgICAgICAgICAgICBkb21bYXR0XSA9IG8udXRpbC5lbmNvZGVIdG1sKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb20uc2V0QXR0cmlidXRlKGF0dCwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzdHlzICYmIG8uZG9tLnNldFN0eWxlcyhkb20sIHN0eXMsIHRydWUpOwogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uY2xvbmVOb2RlCiAgICAgICAgICogQGRlc2MgY2xvbmXoioLngrkg5Y+v5Lul5bCG5LqL5Lu25LiA6LW3Y2xvbmUg6K+l5LqL5Lu25b+F6aG75piv6YCa6L+H5q2k5qGG5p625Yqg5LiK55qECiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDlvoVjbG9uZeeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBldiB7Qm9vbGVhbn0g5piv5ZCmY2xvbmXkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gYyB7Qm9vbGVhbn0g5piv5ZCm5ou36LSd5a2Q6IqC54K5CiAgICAgICAgICovCiAgICAgICAgY2xvbmVOb2RlOiBmdW5jdGlvbihlbCwgZXYsIGMpIHsKICAgICAgICAgICAgZXYgPSBldiB8fCBmYWxzZTsKICAgICAgICAgICAgYyA9IGMgfHwgZmFsc2U7CiAgICAgICAgICAgIHZhciBjbG9uZUVsID0gby5nKGVsKS5jbG9uZU5vZGUoIWMpOwogICAgICAgICAgICBpZighZXYgfHwgIWVsLl9ldmVudENhY2hlSUQpIHJldHVybiBjbG9uZUVsOwogICAgICAgICAgICB2YXIgb2JzID0gby5ldmVudC5vYnNlcnZlcnNbZWwuX2V2ZW50Q2FjaGVJRF07CiAgICAgICAgICAgIHUuZWFjaChvYnMsIGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gaXRlbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIG9ic2VydmVyID0gdS5jbG9uZShpdGVtLm9ic2VydmVyKSwKICAgICAgICAgICAgICAgICAgICB1c2VDYXB0dXJlID0gdS5jbG9uZShpdGVtLnVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbihjbG9uZUVsLCBuYW1lLCBvYnNlcnZlciwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2xvbmVFbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNjcm9sbExpdGUKICAgICAgICAgKiBAZGVzYyDpkojlr7lpb3Porr7lpIfmu5rliqjmnaHmu5rliqjml7bkuovku7bkvKDmkq3mlrnlkJHlr7zoh7TnmoTmu5rliqjlvILluLjop6PlhrMKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOa7muWKqOeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBpc0hvcml6b24ge0Jvb2xlYW59IOaYr+WQpuaoquWQkQogICAgICAgICAqIEBwYXJhbSBwcmV2ZW50RnJvbSB7RE9NRWxlbWVudH0g5byV6LW3YnVn55qE5qC55rqQ5a655ZmoIOWPr+S4jeS8oAogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2Nyb2xsTGl0ZTogZnVuY3Rpb24oZWwsIGlzSG9yaXpvbiwgcHJldmVudEZyb20pIHsKICAgICAgICAgICAgdmFyIHBvcyA9IHsgbGVmdDogMCwgdG9wOiAwIH07CiAgICAgICAgICAgIGlmKHByZXZlbnRGcm9tKSB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RnJvbSA9IG8uZyhwcmV2ZW50RnJvbSk7CiAgICAgICAgICAgICAgICBvLmV2ZW50Lm9uKHByZXZlbnRGcm9tLCAidG91Y2htb3ZlIiwgZnVuY3Rpb24oZSkgeyBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7IH0sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyhlbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtb3ZlcmZsb3ctc2Nyb2xsaW5nIjogInRvdWNoIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgInRvdWNoc3RhcnQiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICBwb3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICB0b3A6IHRvdWNoZXNbMF0ucGFnZVkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZWwsICJ0b3VjaG1vdmUiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0LAogICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IHRhcmdldC5zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHRhcmdldC5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICAgIG1vdmVMZWZ0ID0gdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBtb3ZlVG9wID0gdG91Y2hlc1swXS5wYWdlWSwKICAgICAgICAgICAgICAgICAgICBzdGFydFRvcCA9IHBvcy50b3AsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRMZWZ0ID0gcG9zLmxlZnQ7CiAgICAgICAgICAgICAgICBpZihpc0hvcml6b24pIHsKICAgICAgICAgICAgICAgICAgICBpZigoc2Nyb2xsTGVmdCA8PSAwICYmIG1vdmVMZWZ0ID4gc3RhcnRMZWZ0KSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoc2Nyb2xsTGVmdCA+PSB0YXJnZXQuc2Nyb2xsV2lkdGggLSB0YXJnZXQuY2xpZW50V2lkdGggLSA1ICYmIG1vdmVMZWZ0IDwgc3RhcnRMZWZ0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYoKHNjcm9sbFRvcCA8PSAwICYmIG1vdmVUb3AgPiBzdGFydFRvcCkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHNjcm9sbFRvcCA+PSB0YXJnZXQuc2Nyb2xsSGVpZ2h0IC0gdGFyZ2V0LmNsaWVudEhlaWdodCAtIDUgJiYgbW92ZVRvcCA8IHN0YXJ0VG9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmRhdGEKICAgICAgICAgKiBAZGVzYyDor7vlj5bmiJborr7nva7mjIflrproioLngrnnmoTmlbDmja4KICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVMZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGF0dHJzIHtTdHJpbmcgfCBBcnJheX0KICAgICAgICAgKi8KICAgICAgICBkYXRhOiBmdW5jdGlvbihlbCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIHZzID0ge307CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYodS5pc1N0cmluZyhhdHRycykpIHsKICAgICAgICAgICAgICAgIHZhciBhcnMgPSBhdHRycy5zcGxpdCgiICIpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IGFycy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZihsZW4gPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5kYXRhc2V0ICYmIGVsLmRhdGFzZXRbYXJzWzBdXSB8fCBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtIiArIGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2l0ZW0gPSB1LmNhbWVsaXplKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmRhdGFzZXQgJiYgZWwuZGF0YXNldFtfaXRlbV0gfHwgZWwuZ2V0QXR0cmlidXRlKCJkYXRhLSIgKyBpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZGF0YS0iICsgaywgdnNba10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5hdHRyCiAgICAgICAgICogQGRlc2Mg6K+75Y+W5oiW6K6+572u5oyH5a6a6IqC54K555qE5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgYXR0cjogZnVuY3Rpb24oZWwsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciB2cyA9IHt9OwogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKHUuaXNTdHJpbmcoYXR0cnMpKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJzID0gYXR0cnMuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYobGVuID09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmdldEF0dHJpYnV0ZShpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrLCB2c1trXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZzOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAZGVzYyDlsIbluLjnlKjnmoTpgInmi6nlmajmlrnms5XnmoTlkb3lkI3nqbrpl7Tmj5DliY0KICAgICAqLwogICAgby5nID0gby5kb20uZzsKCiAgICBvLiQgPSBvLmRvbS4kOwoKICAgIG8ub25lID0gby5kb20ub25lOwoKICAgICF3aW5kb3cuJCAmJiAod2luZG93LiQgPSBvLiQpOwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5LqL5Lu26YOo5YiGIO+8jSAgIGV2ZW50CiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICog5a6a5LmJ5bqT5YaF5LqL5Lu25pSv5pKRCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuZXZlbnQKICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8uZXZlbnQgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvYnNlcnZlcnMKICAgICAgICAgKiBAZGVzYyDkuIDkuKrnvJPlrZjkuovku7bnm5HlkKznmoRoYXNo6KGoCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvYnNlcnZlcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5lbGVtZW50CiAgICAgICAgICogQGRlc2Mg6L+U5Zue5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiDop6blj5Hkuovku7bnmoToioLngrkge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1NpbmdsZVRvdWNoCiAgICAgICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5Y2V54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1NpbmdsZVRvdWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA9PSAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc011bHRpVG91Y2gKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblpJrngrkKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTXVsdGlUb3VjaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRvdWNoZXMgJiYgZXZlbnQudG91Y2hlcy5sZW5ndGggPiAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc0xlZnRDbGljawogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuaYr+W3pumUrueCueWHuwogICAgICAgICAqIEBwYXJhbSBldmVudCB7d2luZG93LmV2ZW50fQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMZWZ0Q2xpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhISgoKGV2ZW50LndoaWNoKSAmJiAoZXZlbnQud2hpY2ggPT0gMSkpIHx8CiAgICAgICAgICAgICAgICAoKGV2ZW50LmJ1dHRvbikgJiYgKGV2ZW50LmJ1dHRvbiA9PSAxKSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1JpZ2h0Q2xpY2sKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblj7PplK7ngrnlh7sKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmlnaHRDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICEhKCgoZXZlbnQud2hpY2gpICYmIChldmVudC53aGljaCA9PSAzKSkgfHwKICAgICAgICAgICAgICAgICgoZXZlbnQuYnV0dG9uKSAmJiAoZXZlbnQuYnV0dG9uID09IDIpKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3AKICAgICAgICAgKiBAZGVzYyDmiorkuovku7blgZzkuoYKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcGFyYW0gYWxsb3dEZWZhdWx0IHtCb29sZWFufSAtICAg5piv5ZCm5oqK6buY6K6k5ZON5bqU5YGc5LqGCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oZXZlbnQsIGFsbG93RGVmYXVsdCkgewogICAgICAgICAgICBpZiAoIWFsbG93RGVmYXVsdCkgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LmZpbmRFbGVtZW50CiAgICAgICAgICogQGRlc2Mg5om+5Yiw6Kem5Y+R5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBmaW5kRWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBvLmV2ZW50LmVsZW1lbnQoZXZlbnQpOwogICAgICAgICAgICB3aGlsZSAoZWxlbWVudC5wYXJlbnROb2RlICYmICghZWxlbWVudC50YWdOYW1lIHx8CiAgICAgICAgICAgICAgICAoZWxlbWVudC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgIT0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpKSkpewogICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQub24KICAgICAgICAgKiBAZGVzYyDnm5HlkKzkuovku7YKICAgICAgICAgKiBAcGFyYW0gZG9tIHtTdHJpbmcgfCBET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZG9tLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KCIgIiksCiAgICAgICAgICAgICAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pLAogICAgICAgICAgICAgICAgdGhhdCA9IG8uZXZlbnQ7CiAgICAgICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgICAgICBpZighdGhhdC5vYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWVsZW1lbnQuX2V2ZW50Q2FjaGVJRCkgewogICAgICAgICAgICAgICAgdmFyIGlkUHJlZml4ID0gImV2ZW50Q2FjaGVJRF8iOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZFByZWZpeCA9IGVsZW1lbnQuaWQgKyAiXyIgKyBpZFByZWZpeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQuX2V2ZW50Q2FjaGVJRCA9IG8udXRpbC5jcmVhdGVVbmlxdWVJRChpZFByZWZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIHRoYXQuX29uKGVsZW1lbnQsIG5hbWVzW2ldLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQuX29uCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBfb246IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICBpZihuYW1lID09ICJvcnRjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cgPyAib3JpZW50YXRpb25jaGFuZ2UiIDogInJlc2l6ZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobmFtZSA9PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIkRPTUNvbnRlbnRMb2FkZWQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsLl9ldmVudENhY2hlSUQsCiAgICAgICAgICAgICAgICB0aGF0ID0gby5ldmVudDsKICAgICAgICAgICAgaWYoIXRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdKSB7CiAgICAgICAgICAgICAgICB0aGF0Lm9ic2VydmVyc1tjYWNoZUlEXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdLnB1c2goewogICAgICAgICAgICAgICAgJ2VsZW1lbnQnOiBlbCwKICAgICAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgICAgICdvYnNlcnZlcic6IGZuLAogICAgICAgICAgICAgICAgJ3VzZUNhcHR1cmUnOiB1c2VDYXB0dXJlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihlbC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgZWwuYXR0YWNoRXZlbnQoJ29uJyArIG5hbWUsIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5zdG9wT2JzZXJ2aW5nRWxlbWVudAogICAgICAgICAqIEBkZXNjIOaKiuaMh+WumuiKgueCueeahOaJgOacieS6i+S7tuebkeWQrOWBnOaOiQogICAgICAgICAqIEBwYXJhbSBkb20ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RvcE9ic2VydmluZ0VsZW1lbnQ6IGZ1bmN0aW9uKGRvbSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pOwogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsZW1lbnQuX2V2ZW50Q2FjaGVJRDsKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRWxlbWVudE9ic2VydmVycyhvLmV2ZW50Lm9ic2VydmVyc1tjYWNoZUlEXSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3BFdmVudE9ic2VydmVyCiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gZXZlbnQge1N0cmluZ30g5oyH5a6a5YGc5o6J55qE5LqL5Lu257G75Z6LCiAgICAgICAgICogQGRlc2Mg5q2k5pa55rOV5Lya5bCG5oyH5a6a6IqC54K55LiK55qE5oyH5a6a5pa55rOV55qE5omA5pyJ5LqL5Lu255uR5ZCs5YGc5o6JIOaFjueUqAogICAgICAgICAqLwogICAgICAgIHN0b3BFdmVudE9ic2VydmVyOiBmdW5jdGlvbihkb20sIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjYWNoZUlEID0gby5nKGRvbSkuX2V2ZW50Q2FjaGVJRCwKICAgICAgICAgICAgICAgIHRoYXQgPSBvLmV2ZW50LAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdOwogICAgICAgICAgICBpZiAoZWxlbWVudE9ic2VydmVycykgewogICAgICAgICAgICAgICAgdmFyIGkgPSBlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZihldmVudCA9PSBlbnRyeS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGVudHJ5LmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkub2JzZXJ2ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS51c2VDYXB0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnMKICAgICAgICAgKiBAZGVzY+WFt+S9k+WBmuS6i+aDheeahOaWueazlQogICAgICAgICAqIEBwYXJhbSBlbGVtZW50T2JzZXJ2ZXJzIHtBcnJheX0g5LiA5aCG5LqL5Lu257yT5a2Y5a+56LGhCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gIGVsZW1lbnRPYnNlcnZlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKCA7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShlbnRyeS5lbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5vYnNlcnZlciwKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkudXNlQ2FwdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC51bgogICAgICAgICAqIEBkZXNjIOWNleWIoOS4gOS4quaMh+WumuS6i+S7tuebkeWQrAogICAgICAgICAqIEBwYXJhbSBkb20ge1N0cmluZyB8IERPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZm4ge0Z1bmN0aW9ufQogICAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIHtCb29sZWFufQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IOi/lOWbnuino+mZpOebkeWQrOaYr+WQpuaIkOWKnwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihkb20sIG5hbWUsIGZuLCB1c2VDYXB0dXJlKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGxlbiA9IG5hbWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGlmKGxlbiA9PSAwKSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gby5nKGRvbSksCiAgICAgICAgICAgICAgICBjYWNoZUlEID0gZWxlbWVudC5fZXZlbnRDYWNoZUlELAogICAgICAgICAgICAgICAgZm91bmRFbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSBvLmV2ZW50Ll91bihlbGVtZW50LCBuYW1lc1tpXSwgZm4sIHVzZUNhcHR1cmUsIGNhY2hlSUQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3VuZEVudHJ5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnVuCiAgICAgICAgICogQGRlc2Mg5Y2V5Yig5LiA5Liq5oyH5a6a5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSDov5Tlm57op6PpmaTnm5HlkKzmmK/lkKbmiJDlip8KICAgICAgICAgKi8KICAgICAgICBfdW46IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSwgaWQpIHsKICAgICAgICAgICAgaWYobmFtZSA9PSAib3J0Y2hhbmdlIikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93ID8gIm9yaWVudGF0aW9uY2hhbmdlIiA6ICJyZXNpemUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5hbWUgPT0gInJlYWR5IikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJET01Db250ZW50TG9hZGVkIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihuYW1lID09ICdrZXlwcmVzcycpIHsKICAgICAgICAgICAgICAgIGlmICggbmF2aWdhdG9yLmFwcFZlcnNpb24ubWF0Y2goL0tvbnF1ZXJvcnxTYWZhcml8S0hUTUwvKSB8fAogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICdrZXlkb3duJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZm91bmRFbnRyeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IG8uZXZlbnQub2JzZXJ2ZXJzW2lkXTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpPTA7CiAgICAgICAgICAgICAgICB3aGlsZSghZm91bmRFbnRyeSAmJiBpIDwgZWxlbWVudE9ic2VydmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVFbnRyeSA9IGVsZW1lbnRPYnNlcnZlcnNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKChjYWNoZUVudHJ5Lm5hbWUgPT0gbmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGNhY2hlRW50cnkub2JzZXJ2ZXIgPT0gZm4pICYmCiAgICAgICAgICAgICAgICAgICAgICAgIChjYWNoZUVudHJ5LnVzZUNhcHR1cmUgPT0gdXNlQ2FwdHVyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLmV2ZW50Lm9ic2VydmVyc1tpZF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZEVudHJ5KSB7CiAgICAgICAgICAgICAgICBpZiAoZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4sIHVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbCAmJiBlbC5kZXRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KCdvbicgKyBuYW1lLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZvdW5kRW50cnk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IHVubG9hZENhY2hlCiAgICAgICAgICogQGRlc2Mg6aG16Z2i6ZSA5q+B55qE5pe25YCZ5biM5pyb5Y+v5Lul6YeK5pS+5o6J5omA5pyJ55uR5ZCsCiAgICAgICAgICovCiAgICAgICAgdW5sb2FkQ2FjaGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoby5ldmVudCAmJiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVJRCBpbiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50T2JzZXJ2ZXJzID0gby5ldmVudC5vYnNlcnZlcnNbY2FjaGVJRF07CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5fcmVtb3ZlRWxlbWVudE9ic2VydmVycy5hcHBseSh0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBbZWxlbWVudE9ic2VydmVyc10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgby5ldmVudC5vYnNlcnZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgby5ldmVudC5vbih3aW5kb3csICJ1bmxvYWQiLCBvLmV2ZW50LnVubG9hZENhY2hlLCBmYWxzZSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5FdmVudHMKICAgICAqIEBkZXNjIOiHquWumuS5ieS6i+S7tuexuwogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDop4Llr5/orqLpmIXkuovku7bnmoTlr7nosaEg5b+F6ZyACiAgICAgKiBAcGFyYW0gZWxlbWVudCB7RE9NRWxlbWVudH0g5LiA5Liq5ZON5bqU5rWP6KeI5Zmo5LqL5Lu255qEZG9tIOmdnuW/hemcgCDlpoLmnpzmjIflrprkuobmraTlgLwg5YiZ6KGo56S66KaB5a+56K+l6IqC54K56L+b6KGM5LiA5qyh5oOo57ud5Lq65a+w55qE5bCB6KOFCiAgICAgKiBAcGFyYW0gZmFsbFRocm91Z2gge0Jvb2xlYW59CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICovCiAgICBvLkV2ZW50cyA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RhbnQgb2N0b3B1cy5FdmVudHMuQlJPV1NFUl9FVkVOVFMKICAgICAgICAgKiBAZGVzYyDluLjop4TnmoTmtY/op4jlmajkuovku7YKICAgICAgICAgKi8KICAgICAgICBCUk9XU0VSX0VWRU5UUzogWwogICAgICAgICAgICAibW91c2VvdmVyIiwgIm1vdXNlb3V0IiwgIm1vdXNlZG93biIsICJtb3VzZXVwIiwgIm1vdXNlbW92ZSIsCiAgICAgICAgICAgICJjbGljayIsICJkYmxjbGljayIsICJyaWdodGNsaWNrIiwgImRibHJpZ2h0Y2xpY2siLAogICAgICAgICAgICAicmVzaXplIiwKICAgICAgICAgICAgImZvY3VzIiwgImJsdXIiLAogICAgICAgICAgICAidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAidG91Y2hlbmQiLAogICAgICAgICAgICAia2V5ZG93biIKICAgICAgICBdLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsaXN0ZW5lcnMKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrOeahGhhc2jooagKICAgICAgICAgKi8KICAgICAgICBsaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9iagogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQGRlc2Mg5LqL5Lu25a+56LGh5omA5bGe55qE5Li75L2TCiAgICAgICAgICovCiAgICAgICAgb2JqOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqIEBkZXNjIOS6i+S7tue7keWumueahOiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudEhhbmRsZXIKICAgICAgICAgKiBAZGVzYyDnu5HlrprlnKjoioLngrnkuIrnmoTop6blj5Hlh73mlbAKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZXZlbnRIYW5kbGVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmYWxsVGhyb3VnaAogICAgICAgICAqIEBkZXNjIOS6i+S7tuaYr+WQpuWFgeiuuOS8oOaSrQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGZhbGxUaHJvdWdoOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9ucwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omA5pyJ6KKr5rOo5YaM55qE5paw55qE6Ieq5a6a5LmJ5LqL5Lu26ZyA6KaB6L+Z5Liq5a6e5L6LCiAgICAgICAgICog6Ieq5a6a5LmJ5LqL5Lu25piv5oyH5LulT3VwZW5nLkV2ZW50cy4q5byA5aS055qE6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICoga2V55Li66Ieq5a6a5LmJ5LqL5Lu25ZCN5aaCdGFwIHZhbHVl5Li66Ieq5a6a5LmJ5LqL5Lu25aaCT3VwZW5nLkV2ZW50cy5UYXAg5Y+q5piv5Li+5Liq5L6L5a2Q5LiN55So5aSq6K6k55yfCiAgICAgICAgICovCiAgICAgICAgZXh0ZW5zaW9uczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9uQ291bnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIGtleeaYr+iHquWumuS5ieS6i+S7tueahGtleSB2YWx1ZeaYr2hhbmRsZXLnmoTkuKrmlbAKICAgICAgICAgKi8KICAgICAgICBleHRlbnNpb25Db3VudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3M6IG9jdG9wdXMuRXZlbnRzLmluaXRpYWxpemUKICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9IOinguWvn+iuoumYheS6i+S7tueahOWvueixoSDlv4XpnIAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOS4gOS4quWTjeW6lOa1j+iniOWZqOS6i+S7tueahGRvbSDpnZ7lv4XpnIAg5aaC5p6c5oyH5a6a5LqG5q2k5YC8IOWImeihqOekuuimgeWvueivpeiKgueCuei/m+ihjOS4gOasoeaDqOe7neS6uuWvsOeahOWwgeijhQogICAgICAgICAqIEBwYXJhbSBmYWxsVGhyb3VnaCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9iaiwgZWwsIGZhbGxUaHJvdWdoLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm9iaiA9IG9iajsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IGZhbGxUaHJvdWdoOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5leHRlbnNpb25Db3VudCA9IHt9OwogICAgICAgICAgICBpZiAoZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hUb0VsZW1lbnQoZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5kZXN0cm95CiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWIm+W7uueahOS6i+S7tuWvueixoeiHquaIkeino+iEsQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZm9yICh2YXIgZSBpbiB0aGlzLmV4dGVuc2lvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5leHRlbnNpb25zW2VdICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbZV0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG51bGw7CiAgICAgICAgICAgIGlmICh0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3BPYnNlcnZpbmdFbGVtZW50KHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub2JqID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZXZlbnRIYW5kbGVyID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYXR0YWNoVG9FbGVtZW50CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGF0dGFjaFRvRWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcE9ic2VydmluZ0VsZW1lbnQodGhpcy5lbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50SGFuZGxlciA9IG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQnJvd3NlckV2ZW50LCB0aGlzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBlbDsKICAgICAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5CUk9XU0VSX0VWRU5UUy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24oZWwsIHRoaXMuQlJPV1NFUl9FVkVOVFNbaV0sIHRoaXMuZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyDkuI3ljrvmjolpZeS4i+S8mjLmjokKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgImRyYWdzdGFydCIsIG8uZXZlbnQuc3RvcCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGhhbmRsZUJyb3dzZXJFdmVudAogICAgICAgICAqIEBkZXNjIOWcqOaMh+WummRvbeiKgueCueeahOaDheWGteS4iyDlsIHoo4Xor6Vkb23op6blj5HnmoRldmVudOWxnuaApwogICAgICAgICAqLwogICAgICAgIGhhbmRsZUJyb3dzZXJFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZXZ0LnR5cGUsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldnQudG91Y2hlczsKICAgICAgICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSkgewogICAgICAgICAgICAgICAgdmFyIHggPSAwLAogICAgICAgICAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICAgICAgICAgIG51bSA9IHRvdWNoZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHRvdWNoLAogICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBudW07ICsraSkgewogICAgICAgICAgICAgICAgICAgIHRvdWNoID0gdG91Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICB4ICs9IHRvdWNoLmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgeSArPSB0b3VjaC5jbGllbnRZOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFggPSB4IC8gbnVtOwogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSB5IC8gbnVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5vbgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDmt7vliqDoh6rlrprkuYnkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvYmoge09iamVjdH0g5LqL5Lu257uR5a6a55qE5a+56LGhIOm7mOiupOS4unRoaXMub2JqZWN0CiAgICAgICAgICogQHBhcmFtIHByaW9yaXR5IHtCb29sZWFuIHwgT2JqZWN0fSDkuLp0cnVl5pe2IOWwhuWinuWKoOeahOWbnuiwg+aJlOWcqOinpuWPkeWbnuiwg+mYn+WIl+eahOmYn+WktCDlj6/ku6XnkIbop6PkuLrkvKrlkIzmraUKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqLCBwcmlvcml0eSkgewogICAgICAgICAgICBpZiAodHlwZSBpbiBvLkV2ZW50cyAmJiAhdGhpcy5leHRlbnNpb25zW3R5cGVdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbdHlwZV0gPSBuZXcgby5FdmVudHNbdHlwZV0odGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZ1bmMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9iaiA9PSBudWxsIHx8IG9iaiA9PSB1bmRlZmluZWQpICB7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdGhpcy5vYmo7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzW3R5cGVdID0gbGlzdGVuZXJzOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uQ291bnRbdHlwZV0gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0ge29iajogb2JqLCBmdW5jOiBmdW5jfTsKICAgICAgICAgICAgICAgIGlmIChwcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UodGhpcy5leHRlbnNpb25Db3VudFt0eXBlXSwgMCwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JpdHkgPT09ICJvYmplY3QiICYmIHByaW9yaXR5LmV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbkNvdW50W3R5cGVdKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnVuCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWPlua2iOiHquWumuS5ieS6i+S7tueahOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g6Kem5Y+R5Zue6LCDCiAgICAgICAgICogQHBhcmFtIG9iaiB7T2JqZWN0fSDpu5jorqToh6rouqsKICAgICAgICAgKi8KICAgICAgICB1bjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgIHsKICAgICAgICAgICAgICAgIG9iaiA9IHRoaXMub2JqOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsIGxlbj1saXN0ZW5lcnMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vYmogPT0gb2JqICYmIGxpc3RlbmVyc1tpXS5mdW5jID09IGZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy50cmlnZ2VyRXZlbnQKICAgICAgICAgKiBAZGVzYyDop6blj5Hkuovku7YKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDop6blj5Hkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZXZ0IHtldmVudH0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGV2dCkgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgIGlmKCFsaXN0ZW5lcnMgfHwgbGlzdGVuZXJzLmxlbmd0aCA9PSAwKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoZXZ0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2dCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dC5vYmogPSB0aGlzLm9iajsKICAgICAgICAgICAgZXZ0LmVsID0gdGhpcy5lbDsKICAgICAgICAgICAgaWYoIWV2dC50eXBlKSB7CiAgICAgICAgICAgICAgICBldnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jbG9uZeS4gOS7vQogICAgICAgICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuc2xpY2UoKTsKICAgICAgICAgICAgdmFyIGNvbnRpbnVlQ2hhaW4sCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgICAgICAgIC8vIGJpbmQgdGhlIGNvbnRleHQgdG8gY2FsbGJhY2sub2JqCiAgICAgICAgICAgICAgICBjb250aW51ZUNoYWluID0gY2FsbGJhY2suZnVuYy5hcHBseShjYWxsYmFjay5vYmosIFtldnRdKTsKICAgICAgICAgICAgICAgIGlmIChjb250aW51ZUNoYWluID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOi/lOWbnuWAvOS4umZhbHNl6KGo56S65Zue6LCD5Yiw5q2k5Li65q2iCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmZhbGxUaHJvdWdoKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZXZ0LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGludWVDaGFpbjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnJlbW92ZQogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDnm7TmjqXmiormjIflrprkuovku7bnsbvlnovnmoTnm5HlkKzlm57osIPnva7nqboKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcnNbdHlwZV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5FdmVudHMucmVnaXN0ZXIKICAgICAgICAgKiBAZGVzYyDmibnph4/lop7liqDkuovku7YKICAgICAgICAgKiBAcGFyYW0gZXZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy51bnJlZ2lzdGVyCiAgICAgICAgICogQGRlc2Mg5om56YeP5Y676Zmk5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGV2cyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAiT2N0b3B1cy5FdmVudHMiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupMKICogYWpheOaWueazlQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKi8KOyhmdW5jdGlvbiAobywgdW5kZWZpbmVkKSB7CgogICAgby5hamF4ID0gby5hamF4IHx8IHt9OwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmFqYXgKICAgICAqIEBkZXNjIGFqYXjor7fmsYLmlrnms5UKICAgICAqLwogICAgby5leHRlbmQoby5hamF4LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERFRkFVTFRfQ09ORklHCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKiB0eXBlIC0ge1N0cmluZ30gR0VULCBQT1NULCBQVVQsIERFTEVURSwgSEVBRCwgT1BUSU9OUy4g6buY6K6k5pivR0VULgogICAgICAgICAqIHVybCAtIHtTdHJpbmd9IOivt+axgueahOWcsOWdgAogICAgICAgICAqIGFzeW5jIC0ge0Jvb2xlYW59IOaYr+WQpuWQjOatpeivt+axgiAg6buY6K6k5pivdHJ1ZS4KICAgICAgICAgKiB1c2VyIC0ge1N0cmluZ30g55So5oi35ZCNCiAgICAgICAgICogcGFzc3dvcmQgLSB7U3RyaW5nfSDlr4bnoIEKICAgICAgICAgKiBkYXRhIC0ge1N0cmluZyB8IE9iamVjdH0gUE9TVOS4jlBVVOaPkOS6pOeahOaVsOaNrgogICAgICAgICAqIGNvbXBsZXRlIC0ge0Z1bmN0aW9ufQogICAgICAgICAqIHN1Y2Nlc3MgLSB7RnVuY3Rpb259CiAgICAgICAgICogZXJyb3IgLSB7RnVuY3Rpb259CiAgICAgICAgICogc2NvcGUgLSB7T2JqZWN0fQogICAgICAgICAqIGJlZm9yZVNlbmQgICAtICAge0Z1bmN0aW9ufSDor7fmsYLlj5Hlh7rliY3osIPnlKgKICAgICAgICAgKiB0aW1lb3V0ICAtICAge051bWJlcn0g5bu25pe2CiAgICAgICAgICovCiAgICAgICAgREVGQVVMVF9DT05GSUc6IHsKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICB1c2VyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHBhc3N3b3JkOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGNvbXBsZXRlOiBvLnV0aWwuZW1wdHksCiAgICAgICAgICAgIHN1Y2Nlc3M6IG51bGwsCiAgICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgICBzY29wZTogbnVsbCwKICAgICAgICAgICAgYmVmb3JlU2VuZDogbnVsbCwKICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgY3Jvc3NEb21haW46IGZhbHNlCiAgICAgICAgfSwKCiAgICAgICAganNvbnBJRDogMCwKCiAgICAgICAganNvblR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICBodG1sVHlwZTogJ3RleHQvaHRtbCcsCgogICAgICAgIFNDUklQVF9SRUdFWDogLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCiAgICAgICAgU0NSSVBUX1RZUEVfUkVHRVg6IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL2phdmFzY3JpcHQvaSwKICAgICAgICBYTUxfVFlQRV9SRUdFWDogL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwveG1sL2ksCiAgICAgICAgVVJMX1NQTElUX1JFR0VYOiAvKFteOl0qOilcL1wvKFteOl0qOj9bXkBdKkApPyhbXjpcL1w/XSopOj8oW15cL1w/XSopLywKICAgICAgICBCTEFOS19SRUdFWDogL15ccyokLywKICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCcsCiAgICAgICAgICAgIGpzb246ICAgdGhpcy5qc29uVHlwZSwKICAgICAgICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAgICAgIGh0bWw6ICAgdGhpcy5odG1sVHlwZSwKICAgICAgICAgICAgdGV4dDogICAndGV4dC9wbGFpbicKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB4aHIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgeGhyOiBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG1pbWVUb0RhdGFUeXBlCiAgICAgICAgICovCiAgICAgICAgbWltZVRvRGF0YVR5cGU6IGZ1bmN0aW9uKG1pbWUpIHsKICAgICAgICAgICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IHRoaXMuaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICAgICAgICAgICAgbWltZSA9PSB0aGlzLmpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLlNDUklQVF9UWVBFX1JFR0VYLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuWE1MX1RZUEVfUkVHRVgudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICogQGRlc2Mg5Y+R5Ye66K+35rGCIOWQhOenjQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOmFjee9rumhuQogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgY29uZmlnID0gby51dGlsLmFwcGx5RGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdENvbmZpZyksCiAgICAgICAgICAgICAgICBkYXRhVHlwZSA9IGNvbmZpZy5kYXRhVHlwZSwKICAgICAgICAgICAgICAgIHVybCA9IGNvbmZpZy51cmwsCiAgICAgICAgICAgICAgICBkYXRhID0gY29uZmlnLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgfHwge30sCiAgICAgICAgICAgICAgICB1cmxvYmogPSBvLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgICAgICAgIGlmKGNvbmZpZy50eXBlID09ICJqc29ucCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFqYXguYWpheEpTT05QKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFjb25maWcuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5jcm9zc0RvbWFpbiA9IHVybG9iai5ob3N0ICE9IHdpbmRvdy5sb2NhdGlvbi5ob3N0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gZmFsc2UsCiAgICAgICAgICAgICAgICBoZWFkZXJLZXk7CiAgICAgICAgICAgIGZvcihoZWFkZXJLZXkgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlcktleS50b0xvd2VyQ2FzZSgpID09PSAneC1yZXF1ZXN0ZWQtd2l0aCcpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID09PSBmYWxzZSB8fCAhY29uZmlnLmNyb3NzRG9tYWluKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10gPSAnWE1MSHR0cFJlcXVlc3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgPSAgby51dGlsLmdldFBhcmFtZXRlclN0cmluZyhkYXRhIHx8IHt9KTsKICAgICAgICAgICAgaWYoY29uZmlnLnR5cGUgIT0gIlBPU1QiKSB7CiAgICAgICAgICAgICAgICBjb25maWcudXJsID0gby51dGlsLnVybEFwcGVuZCh1cmwsIGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaW1lID0gdGhpcy5hY2NlcHRzW2RhdGFUeXBlXSwKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzID0ge30sCiAgICAgICAgICAgICAgICB4aHIgPSB0aGlzLnhocigpLCBhYm9ydFRpbWVvdXQ7CiAgICAgICAgICAgIGlmKG1pbWUpIHsKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWU7CiAgICAgICAgICAgICAgICBpZihtaW1lLmluZGV4T2YoJywnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgbWltZSA9IG1pbWUuc3BsaXQoJywnLCAyKVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVhZGVycyA9IG8uZXh0ZW5kKGJhc2VIZWFkZXJzLCBoZWFkZXJzIHx8IHt9KTsKICAgICAgICAgICAgeGhyLm9wZW4oCiAgICAgICAgICAgICAgICBjb25maWcudHlwZSwgY29uZmlnLnVybCwgY29uZmlnLmFzeW5jLCBjb25maWcudXNlciwgY29uZmlnLnBhc3N3b3JkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWJvcnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnJ1bkNhbGxiYWNrcygKICAgICAgICAgICAgICAgICAgICAgICAge3JlcXVlc3Q6IHhociwgY29uZmlnOiBjb25maWcsIHJlcXVlc3RVcmw6IGNvbmZpZy51cmx9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoY29uZmlnLmFzeW5jID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgeGhyLnNlbmQoZGF0YSA/IGRhdGEgOiBudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYoeGhyLnJlYWR5U3RhdGUgIT09IDApIHsgLy8gVzNDOiAwLVVOU0VOVAogICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2VuZChkYXRhID8gZGF0YSA6IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNvbmZpZy50aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmVycm9yLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5lcnJvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoeGhyLCAidGltZW91dCIpOwogICAgICAgICAgICAgICAgfSwgY29uZmlnLnRpbWVvdXQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcnVuQ2FsbGJhY2tzCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBydW5DYWxsYmFja3M6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvcHRpb25zLnJlcXVlc3Q7CiAgICAgICAgICAgIHZhciBjb25maWcgPSBvcHRpb25zLmNvbmZpZzsKICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmNvbXBsZXRlLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgIGNvbmZpZy5jb21wbGV0ZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3M7CiAgICAgICAgICAgIGlmKGNvbmZpZy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5zdWNjZXNzLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3VjY2VzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFpbHVyZTsKICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICBmYWlsdXJlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5lcnJvciwgY29uZmlnLnNjb3BlKSA6CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlKHJlcXVlc3QpOwogICAgICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlLAogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBjb25maWcuZGF0YVR5cGU7CiAgICAgICAgICAgIGlmKChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApIHx8IHJlcXVlc3Quc3RhdHVzID09IDMwNCB8fAogICAgICAgICAgICAgICAgKHJlcXVlc3Quc3RhdHVzID09IDAgJiYgby51dGlsLmNyZWF0ZVVybE9iamVjdChjb25maWcudXJsKS5wcm90b2NvbCA9PSAiZmlsZToiKSkgewogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCB0aGlzLm1pbWVUb0RhdGFUeXBlKHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoJ2NvbnRlbnQtdHlwZScpKTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlcXVlc3QucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoZGF0YVR5cGUgPT0gJ3htbCcpICByZXN1bHQgPSByZXF1ZXN0LnJlc3BvbnNlWE1MCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZihkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IHRoaXMuQkxBTktfUkVHRVgudGVzdChyZXN1bHQpID8gbnVsbCA6IEpTT04ucGFyc2UocmVzdWx0KQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBlcnJvciA9IGUgfQogICAgICAgICAgICAgICAgb3B0aW9ucy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICBpZihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhyZXF1ZXN0LCByZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYoZmFpbHVyZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWx1cmUocmVxdWVzdCwgImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguZ2V0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hZ2V06K+35rGCCiAgICAgICAgICogQHBhcmFtIGNvbmZpZyB7T2JqZWN0fQogICAgICAgICAqIEBwYXJhbSBjb25maWcudXJsIHtTdHJpbmd9IOivt+axguWcsOWdgAogICAgICAgICAqIEBwYXJhbSBjb25maWcuYXN5bmMge0Jvb2xlYW59IOWQjOW8guatpQogICAgICAgICAqIEBwYXJhbSBjb25maWcuY29tcGxldGUge0Z1bmN0aW9ufSDor7fmsYLnu5PmnZ/nmoRjYWxsYmFjawogICAgICAgICAqIEBwYXJhbSBjb25maWcuc3VjY2VzcyB7RnVuY3Rpb259IOivt+axguaIkOWKn+eahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5lcnJvciB7RnVuY3Rpb259IOivt+axguWksei0peeahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy50aW1lb3V0IHtOdW1iZXJ9IOi2heaXtuaXtumXtAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZ2V0IjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJHRVQifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5wb3N0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hcG9zdOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5kYXRhIHtPYmplY3R9IOaVsOaNrgogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwb3N0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnID0gby5leHRlbmQoY29uZmlnLCB7dHlwZTogIlBPU1QifSk7CiAgICAgICAgICAgIC8vIHNldCBjb250ZW50IHR5cGUgdG8gYXBwbGljYXRpb24veG1sIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0CiAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgPyBjb25maWcuaGVhZGVycyA6IHt9OwogICAgICAgICAgICBpZighKCJDT05URU5ULVRZUEUiIGluIG8udXRpbC51cHBlckNhc2VPYmplY3QoY29uZmlnLmhlYWRlcnMpKSkgewogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL3htbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4LnB1dAogICAgICAgICAqIEBkZXNjIOWPkeadoXB1dOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMcG9zdAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiUFVUIn0pOwogICAgICAgICAgICAvLyBzZXQgY29udGVudCB0eXBlIHRvIGFwcGxpY2F0aW9uL3htbCBpZiBpdCBpc24ndCBhbHJlYWR5IHNldAogICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzID8gY29uZmlnLmhlYWRlcnMgOiB7fTsKICAgICAgICAgICAgaWYoISgiQ09OVEVOVC1UWVBFIiBpbiBvLnV0aWwudXBwZXJDYXNlT2JqZWN0KGNvbmZpZy5oZWFkZXJzKSkpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5kZWxldGUKICAgICAgICAgKiBAZGVzYyDlj5HmnaFkZWxldGXor7fmsYIKICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtPYmplY3R9IOWQjGdldAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZGVsZXRlIjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJERUxFVEUifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5oZWFkCiAgICAgICAgICogQGRlc2Mg5Y+R5p2haGVhZOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGhlYWQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiSEVBRCJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4Lm9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDlj5HmnaFvcHRpb25z6K+35rGCLgogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIG9wdGlvbnM6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiT1BUSU9OUyJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIF9jcmVhdGVTY3JpcHRUYWcKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlU2NyaXB0VGFnOiBmdW5jdGlvbihzY3IsIHVybCwgY2hhcnNldCkgewogICAgICAgICAgICBzY3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwogICAgICAgICAgICBjaGFyc2V0ICYmIHNjci5zZXRBdHRyaWJ1dGUoJ2NoYXJzZXQnLCBjaGFyc2V0KTsKICAgICAgICAgICAgc2NyLnNldEF0dHJpYnV0ZSgnc3JjJywgdXJsKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3IpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQE1ldGhvZCBfcmVtb3ZlU2NyaXB0VGFnCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZVNjcmlwdFRhZzogZnVuY3Rpb24oc2NyKSB7CiAgICAgICAgICAgIGlmIChzY3IuY2xlYXJBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBzY3IuY2xlYXJBdHRyaWJ1dGVzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIHNjcikgewogICAgICAgICAgICAgICAgICAgIGlmIChzY3IuaGFzT3duUHJvcGVydHkoYXR0cikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHNjclthdHRyXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2NyICYmIHNjci5wYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgIHNjci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2NyID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIHNjcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguYWpheEpTT05QCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy51cmwge1N0cmluZ30g6K+35rGC5Zyw5Z2ACiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuY29tcGxldGUge0Z1bmN0aW9ufSDmiJDlip/lm57osIMKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5lcnJvciB7RnVuY3Rpb259IOWksei0peWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQge051bWJlcn0g6LaF5pe25pe26ZW/CiAgICAgICAgICovCiAgICAgICAgYWpheEpTT05QOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgcHJlZml4ID0gImpzb25wIiwKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvLnV0aWwuYXBwbHlEZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0Q29uZmlnKSwKICAgICAgICAgICAgICAgIGNoYXJzZXQgPSBvcHRpb25zWydjaGFyc2V0J10sCiAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uc1siZGF0YSJdIHx8IHt9LAogICAgICAgICAgICAgICAgdGltZU91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXSB8fCAwLAogICAgICAgICAgICAgICAgdGltZXIsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHVybCA9IG9wdGlvbnNbInVybCJdLAogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zWyJzdWNjZXNzIl0gfHwgb3B0aW9uc1siY29tcGxldGUiXSwKICAgICAgICAgICAgICAgIGpzb25wTmFtZSA9IG9wdGlvbnNbImpzb25wIl0gfHwgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgIGVycm9yID0gb3B0aW9uc1siZXJyb3IiXSB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKG8udXRpbC5pc1N0cmluZyhjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSA9IGNhbGxiYWNrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tOYW1lID0gcHJlZml4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjE0NzQ4MzY0OCkudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBnZXRDYWxsQmFjaygwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aW1lT3V0ID4gMCl7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZ2V0Q2FsbEJhY2soMSksIHRpbWVPdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZW1vdmVTY3JpcHRUYWcoc2NyaXB0KTsKICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVybCA9IG8udXRpbC51cmxBcHBlbmQoby51dGlsLnVybEFwcGVuZCh1cmwsCiAgICAgICAgICAgICAgICBvLnV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nKGRhdGEgfHwge30pKSwganNvbnBOYW1lICsgIj0iICsgY2FsbGJhY2tOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlU2NyaXB0VGFnKHNjcmlwdCwgdXJsLCBjaGFyc2V0KTsKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbEJhY2sob25UaW1lT3V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG9uVGltZU91dCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkod2luZG93LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gby51dGlsLmVtcHR5OwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge30KICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVtb3ZlU2NyaXB0VGFnKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zWyJ4aHIiXTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlR3ZWVuCiAgICAgKiBAZGVzYyDliqjnlLvnsbvvvIzlj6/ku6XpgJrov4fmlLnlj5jlsZ7mgKfjgIHotbflp4vlgLzjgIHnu5PmnZ/lgLznrYnphY3nva7orqnmjIflrproioLngrnlrozmiJDliqjmgIHov4fmuKEKICAgICAqIOazqOaEj++8mueUseS6juaDheWGtei/h+S6juWkjeadgiDlh6HmmK/mlLnlj5jlsZ7mgKfmmK90cmFuc2Zvcm3lsZ7mgKfmiJbljIXlkKt0cmFuc2Zvcm3lsZ7mgKfnmoTliqjnlLsg5Y+q6IO95oyJ54WnY3NzM+eahOW9ouW8j+i/m+ihjCDpu5jorqTliqjnlLvnsbvlnovmmK9lYXNlLW91dAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmjIflrprlrozmiJDliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZyB8IEFycmF5fSDlvoXmlLnlj5jnmoTlsZ7mgKcg5Y+v5Li65aSa5YC8CiAgICAgKiBAcGFyYW0gc3RhcnR2IHtTdHJpbmcgfCBOdW1iZXIgfCBBcnJheX0g6LW35aeL5YC8IOWmguS4uuaVsOe7hCDlv4XpobvkuI7mlLnlj5jlsZ7mgKfkuIDkuIDlr7nlupQg5ZCm5YiZ5Lya5oqb6ZSZCiAgICAgKiBAcGFyYW0gZW5kdiB7U3RyaW5nIHwgTnVtYmVyIHwgQXJyYXl9IOe7k+adn+WAvCDlhbfkvZPopoHmsYLlkIzotbflp4vlgLwKICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7TnVtYmVyfSDliqjljJbov4fmuKHnmoTml7bpl7Qg5Y2V5L2N5Li656eSL3MKICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Yqo55S757uT5p2f55qE5Zue6LCD5Ye95pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fSDlhbbku5bphY3nva7pobkg5Y+v5Li656m6IOm7mOiupOS4umpz5Yqo55S7IOWKqOeUu+exu+Wei+S4uiJvY3RvcHVzLmVhc2luZy4iCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5lYXNlIHtTdHJpbmcgfCBPYmplY3R9IOWKqOeUu+exuyDlpoLmnpzkuLrlrZfnrKbkuLIg5YiZ6YeH55SoY3NzM+eahHRyYW5zaXRpb27liqjnlLsg5ZCm5YiZ6ZyA6KaB5Lyg5YWlIm9jdG9wdXMuZWFzaW5nLlhYWCLnmoTliqjnlLvlr7nosaEKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgbmV3dHdlZW4gPSBuZXcgVHdlZW4oZWwsIFsid2lkdGgiLCAid2Via2l0VHJhbnNmb3JtIl0sIFs2NCwgInRyYW5zbGF0ZTNkKDAsIDAsIDApIl0sCiAgICAgKiAgWzEyOCwgInRyYW5zbGF0ZTNkKDMwcHgsIDAsIDApIl0sIC40LCBmdW5jdGlvbigpIHsKICAgICAqICAgICBjb25zb2xlLmxvZyhBbmltYXRpb24gZmluaXNoZWQhKTsKICAgICAqIH0sIHsKICAgICAqICAgICBlYXNlOiAiZWFzZS1vdXQiIHwgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAqIH0pOwogICAgICogQHRocm93CiAgICAgKiBAcmV0dXJuIHtvY3RvcHVzLlR3ZWVufQogICAgICovCiAgICBvLlR3ZWVuID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcm9wZXJ0eU5hbWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByb3BlcnR5TmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGZ1bmMKICAgICAgICAgKiB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZnVuYzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZWFzZQogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmVlZFBhcmFtcwogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBuZWVkUGFyYW1zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYXJhbXNEaWNzCiAgICAgICAgICoge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHBhcmFtc0RpY3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJlcXVlc3RBbmltYXRpb24KICAgICAgICAgKiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3RBbmltYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbG9yTGlzdAogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb2xvckxpc3Q6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHN0b3BSZXF1ZXN0CiAgICAgICAgICoge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc3RvcFJlcXVlc3Q6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZlY3RvcgogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgdmVjdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByZWZpeDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRQcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGV2ZW50UHJlZml4OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc09mZkNzcwogICAgICAgICAqIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzT2ZmQ3NzOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kRXZlbnQKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZEV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RyYW5zZm9ybQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzVHJhbnNmb3JtOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRUaW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGVsYXkKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGRlbGF5OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlR3ZWVuCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHBybywgc3RhcnR2LCBlbmR2LCBkdXJhdGlvbiwgZnVuYywgb3B0aW9ucykgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbCkpICAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBhIG5vZGUhIik7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmVsID0gZWw7CiAgICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gcHJvOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBzdGFydHY7CiAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBlbmR2OwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB0aGlzLm5lZWRQYXJhbXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb2xvckxpc3QgPSBbXTsKICAgICAgICAgICAgdGhpcy5wYXJhbXNEaWNzID0gWyJ3aWR0aCIsICJoZWlnaHQiLCAibGVmdCIsICJ0b3AiLCAicmlnaHQiLCAiYm90dG9tIiwgInBhZGRpbmciLAogICAgICAgICAgICAgICAgInBhZGRpbmctbGVmdCIsICJwYWRkaW5nLXRvcCIsICJwYWRkaW5nLWJvdHRvbSIsICJwYWRkaW5nLXJpZ2h0IiwgIm1hcmdpbiIsCiAgICAgICAgICAgICAgICAibWFyZ2luLWxlZnQiLCAibWFyZ2luLXRvcCIsICJtYXJnaW4tYm90dG9tIiwgIm1hcmdpbi1yaWdodCIsICJmb250LXNpemUiLAogICAgICAgICAgICAgICAgImJhY2tncm91bmQtcG9zaXRpb24iLCAibGluZS1oZWlnaHQiLCAiYm9yZGVyLXdpZHRoIiwgImJvcmRlci1sZWZ0LXdpZHRoIiwKICAgICAgICAgICAgICAgICJib3JkZXItdG9wLXdpZHRoIiwgImJvcmRlci1yaWdodC13aWR0aCIsICJib3JkZXItYm90dG9tLXdpZHRoIl07CiAgICAgICAgICAgIHZhciBsZWdhbGl0eSA9IHRoaXMuY2hlY2soKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8ICh0aGlzLmlzVHJhbnNmb3JtID8gImVhc2Utb3V0IiA6IG8uZWFzaW5nLmxpbmVhci5lYXNlT3V0KTsKICAgICAgICAgICAgdGhpcy5kZWxheSA9IHRoaXMuZGVsYXkgfHwgMDsKICAgICAgICAgICAgaWYoIWxlZ2FsaXR5KSB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgYXJndW1lbnRzISIpOwogICAgICAgICAgICBpZihvLnV0aWwuaXNPYmplY3QodGhpcy5lYXNlKSAmJiAhdGhpcy5pc1RyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uID0gby51dGlsLnJlcXVlc3RBbmltYXRpb247CiAgICAgICAgICAgICAgICBpZih0aGlzLmRlbGF5ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlV2l0aEpzKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5kZWxheSAqIDEwMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVXaXRoSnMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmVjdG9yID0geyIiIDogIiIsIFdlYmtpdDogIndlYmtpdCIsIE1vejogIiIsIE86ICJvIiwgbXM6ICJNUyJ9OwogICAgICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMudmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuc3R5bGVbayArICJUcmFuc2l0aW9uUHJvcGVydHkiXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJlZml4ID0gJy0nICsgay50b0xvd2VyQ2FzZSgpICsgJy0nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRQcmVmaXggPSB0aGlzLnZlY3RvcltrXQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmlzT2ZmQ3NzID0gKHRoaXMuZXZlbnRQcmVmaXggPT0gbnVsbCAmJiB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9PSB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgdGhpcy5lbmRFdmVudCA9IHRoaXMuZXZlbnRQcmVmaXggPyB0aGlzLmV2ZW50UHJlZml4ICsgIlRyYW5zaXRpb25FbmQiIDogInRyYW5zaXRpb25FbmQiOwogICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlV2l0aENzcygpOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVjawogICAgICAgICAqIEBkZXNjIOajgOafpeWPguaVsOaYr+WQpm9rCiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBvLnV0aWwuaXNBcnJheSh0aGlzLnByb3BlcnR5TmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNBcnJheSh0aGlzLnN0YXJ0VmFsdWUpICYmIG8udXRpbC5pc0FycmF5KHRoaXMuZW5kVmFsdWUpLAogICAgICAgICAgICAgICAgcGFzcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgX3Bhc3M7CiAgICAgICAgICAgIGlmKCFxdWV1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IFt0aGlzLnByb3BlcnR5TmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBbdGhpcy5zdGFydFZhbHVlXTsKICAgICAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBbdGhpcy5lbmRWYWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmFtc01hdGNoID0gKHRoaXMucHJvcGVydHlOYW1lLmxlbmd0aCA9PSB0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoKSAmJgogICAgICAgICAgICAgICAgICAgICh0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoID09IHRoaXMuZW5kVmFsdWUubGVuZ3RoKTsKICAgICAgICAgICAgaWYocGFyYW1zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIHZhciB1bk9rID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgICAgIF9wYXNzID0gdGhpcy5jaGVja1ZhbHVlKHRoaXMucHJvcGVydHlOYW1lW2ldLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIGlmKCFfcGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB1bk9rID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZWVkUGFyYW1zW2ldID0gdGhpcy5wYXJhbXNEaWNzLmluZGV4T2YodGhpcy5wcm9wZXJ0eU5hbWVbaV0pICE9IC0xOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbG9yID0gbmV3IFJlZ0V4cCgiL2NvbG9yfGJhY2tncm91bmQtY29sb3J8Ym9yZGVyLWNvbG9yL2kiKS50ZXN0KHRoaXMucHJvcGVydHlOYW1lW2ldKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9yTGlzdFtpXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNDb2xvcjogaXNDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRWYWx1ZTogaXNDb2xvciA/IHRoaXMuZ2V0Q29sb3IodGhpcy5zdGFydFZhbHVlW2ldKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZFZhbHVlOiBpc0NvbG9yID8gdGhpcy5nZXRDb2xvcih0aGlzLmVuZFZhbHVlW2ldKSA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFzcyA9ICF1bk9rICYmICFpc05hTih0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tWYWx1ZQogICAgICAgICAqIEBkZXNjIOmqjOivgeWAvOaYr+WQpuWQiOazlQogICAgICAgICAqLwogICAgICAgIGNoZWNrVmFsdWU6IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSwgc3RhcnRWYWx1ZSwgZW5kVmFsdWUpewogICAgICAgICAgICB2YXIgcGFzcyA9IGZhbHNlOwogICAgICAgICAgICBpZigvdHJhbnNmb3JtL2kudGVzdChwcm9wZXJ0eU5hbWUpIHx8IC8td2Via2l0LS9pLnRlc3QocHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICAgICAgdGhpcy5pc1RyYW5zZm9ybSA9IHRydWU7CiAgICAgICAgICAgICAgICBwYXNzID0gISFzdGFydFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhzdGFydFZhbHVlKSAmJiAhIWVuZFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhlbmRWYWx1ZSkKICAgICAgICAgICAgfSBlbHNlIGlmKHByb3BlcnR5TmFtZS5pbmRleE9mKCdjb2xvcicpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gLyheXHMqKXwoXHMqJCkvZzsKICAgICAgICAgICAgICAgIHBhc3MgPSAhIXN0YXJ0VmFsdWUgJiYgc3RhcnRWYWx1ZS5yZXBsYWNlKHJlZywgJycpICE9ICcnICYmICEhIGVuZFZhbHVlICYmIGVuZFZhbHVlLnJlcGxhY2UocmVnLCAnJykgIT0gJycKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSAhaXNOYU4oc3RhcnRWYWx1ZSkgJiYgIWlzTmFOKGVuZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29sb3IKICAgICAgICAgKi8KICAgICAgICBnZXRDb2xvcjogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8oXlxzKil8KFxzKiQpL2csICcnKTsKICAgICAgICAgICAgdmFyIHJnYlJlZyA9IC9eXHMqcmdiXHMqXChccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXClccyokL2k7CiAgICAgICAgICAgIHZhciBzaXhSZWdBID0gL15ccypcI1thLXpBLVowLTldezN9XHMqJC87CiAgICAgICAgICAgIHZhciBzaXhSZWdCID0gL15ccypcI1thLXpBLVowLTldezZ9XHMqJC87CiAgICAgICAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgICAgICAgaWYocmdiUmVnLnRlc3Qoc3RyKSl7IC8vIOS7pVJHQuW9ouW8j+aMh+WumueahOminOiJsgogICAgICAgICAgICAgICAgdmFyIG5TdHIgPSBzdHIuc3BsaXQoJygnKVsxXS5zcGxpdCgnKScpWzBdLnNwbGl0KCcsJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IG5TdHIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goblN0cltpXSAvIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzaXhSZWdCLnRlc3Qoc3RyKSkgeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsiAoNuS9jSkKICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLnJlcGxhY2UoJyMnLCAnJykubWF0Y2goLyhcd3xcZCl7Mn0vZyk7CgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCA7IGkgPCBtLmxlbmd0aDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyBtW2ldKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2l4UmVnQS50ZXN0KHN0cikpeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsigz5L2NKQogICAgICAgICAgICAgICAgdmFyIGNBcnIgPSBzdHIucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IGNBcnIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyAoY0FycltpXSArIGNBcnJbaV0pKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVXaXRoSnMKICAgICAgICAgKiDmiafooYwKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlV2l0aEpzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdG9wUmVxdWVzdCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBjdXJUaW1lID0gMDsKICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmVsIHx8IHRoYXQuc3RvcFJlcXVlc3QpewogICAgICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuZ2V0U2V0VmFsdWUoY3VyVGltZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYoY3VyVGltZSA+PSB0aGF0LmR1cmF0aW9uICogMTAwMCl7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nZXRTZXRWYWx1ZShudWxsLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhhdC5mdW5jICYmIHRoYXQuZnVuYygpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1clRpbWUgKz0gMTY7CiAgICAgICAgICAgICAgICB0aGF0LnJlcXVlc3RBbmltYXRpb24oYW5pbWF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uKGFuaW1hdGUsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleGVjdXRlV2l0aENzcwogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGVXaXRoQ3NzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc09mZkNzcykgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHZhciBwcm9hcnIgPSB0aGlzLnByb3BlcnR5TmFtZSwKICAgICAgICAgICAgICAgIGxlbiA9IHByb2Fyci5sZW5ndGgsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25BcnIgPSBbXSwKICAgICAgICAgICAgICAgIF9wcmVmaXggPSB0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVtfcHJlZml4XSA9ICIiOwogICAgICAgICAgICBvLnV0aWwuZWFjaChwcm9hcnIsIGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgICAgICB0aGF0LmVsLnN0eWxlW2l0ZW1dID0gdGhhdC5nZXRWYWx1ZSh0aGF0LnN0YXJ0VmFsdWVbaW5kZXhdLCBpbmRleCk7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uQXJyLnB1c2goaXRlbSArICIgIiArIHRoYXQuZHVyYXRpb24gKyAicyAiICsgdGhhdC5lYXNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgdGhpcy5lbmRFdmVudCwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkVuZEV2ZW50Q29tcGxldGVkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGVbX3ByZWZpeF0gPSB0cmFuc2l0aW9uQXJyLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGF0OwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcig7IHogPCBsZW47IHorKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWUgPSBfdGhpcy5lbmRWYWx1ZVt6XTsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZWwuc3R5bGVbcHJvYXJyW3pdXSA9IF90aGlzLmdldFZhbHVlKGN1clZhbHVlLCB6KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xlYXJFdmVudFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRUaW1lciA9IHNldFRpbWVvdXQoby51dGlsLmJpbmQoX3RoaXMub25GaW5pc2gsIF90aGlzKSwgX3RoaXMuZHVyYXRpb24gKiAxMDAwKTsKCiAgICAgICAgICAgICAgICB9LCB0aGF0LmRlbGF5ICogMTAwMCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjbGVhckV2ZW50VGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhckV2ZW50VGltZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5ldmVudFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRUaW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25GaW5pc2gKICAgICAgICAgKi8KICAgICAgICBvbkZpbmlzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW3RoaXMucHJlZml4ICsgInRyYW5zaXRpb24iXSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZnVuYyAmJiB0aGlzLmZ1bmMoKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uRW5kRXZlbnRDb21wbGV0ZWQKICAgICAgICAgKi8KICAgICAgICBvbkVuZEV2ZW50Q29tcGxldGVkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmKGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jbGVhckV2ZW50VGltZXIoKTsKICAgICAgICAgICAgdGhpcy5vbkZpbmlzaCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5Ud2Vlbi5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5o6J5Yqo55S7IOW5tuino+iEseiHquaIkQogICAgICAgICAqLwogICAgICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmVuZEV2ZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFJlcXVlc3QgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mdW5jICYmIHRoaXMuZnVuYygpOwogICAgICAgICAgICAgICAgaWYodGhpcy5lbCkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVt0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIl0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuVHdlZW4uZGVzdHJveQogICAgICAgICAqIEBkZXNjIOeci+WQjeWtl+WwseefpemBk+W5suWYm+eahAogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0U2V0VmFsdWUKICAgICAgICAgKiBAZGVzYyDlj5blh7rlvZPliY3nmoTlsZ7mgKflgLwKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIGN1clRpbWUgIC0gICB7TnVtYmVyfQogICAgICAgICAqIGlzRW5kICAgIC0gICB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBnZXRTZXRWYWx1ZTogZnVuY3Rpb24oY3VyVGltZSwgaXNFbmQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlSW5mbyA9IFtdLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoOwogICAgICAgICAgICBmb3IoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWU7CiAgICAgICAgICAgICAgICBpZih0aGlzLmNvbG9yTGlzdFtpXS5pc0NvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0UlIgPSB0aGlzLmNvbG9yTGlzdFtpXS5zdGFydFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydEdHID0gdGhpcy5jb2xvckxpc3RbaV0uc3RhcnRWYWx1ZVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLnN0YXJ0VmFsdWVbMl0sCgogICAgICAgICAgICAgICAgICAgICAgICBlbmRSUiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRHRyA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzJdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcnIsIGdnLCBiYjsKICAgICAgICAgICAgICAgICAgICBpZihpc0VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICByciA9IGVuZFJSOwogICAgICAgICAgICAgICAgICAgICAgICBnZyA9IGVuZEdHOwogICAgICAgICAgICAgICAgICAgICAgICBiYiA9IGVuZEJCOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJyID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydFJSLCBlbmRSUiAtIHN0YXJ0UlIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdnID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEdHLCBlbmRHRyAtIHN0YXJ0R0csIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJiID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEJCLCBlbmRCQiAtIHN0YXJ0QkIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gJ3JnYignICsgcnIgKyAnLCAnICsgZ2cgKyAnLCAnICsgYmIgKyAnKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKGlzRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gdGhpcy5lbmRWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA9IHRoaXMuZWFzZShjdXJUaW1lLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0gLSB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZHVyYXRpb24gKiAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZUluZm8ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiB0aGlzLnByb3BlcnR5TmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA6IGN1clZhbHVlLAogICAgICAgICAgICAgICAgICAgIGlzQ29sb3I6IHRoaXMuY29sb3JMaXN0W2ldLmlzQ29sb3IKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodmFsdWVJbmZvKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFZhbHVlCiAgICAgICAgICogQGRlc2Mg5pS55Y+Y5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlSW5mbykgewogICAgICAgICAgICB2YXIgc2V0SW5mbyA9IHt9LAogICAgICAgICAgICAgICAgbmVlZFNldCA9IGZhbHNlLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdmFsdWVJbmZvLmxlbmd0aDsKICAgICAgICAgICAgZm9yKDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHZhbHVlSW5mb1tpXS5wcm9wZXJ0eU5hbWUsCiAgICAgICAgICAgICAgICAgICAgY3VyVmFsdWUgPSB2YWx1ZUluZm9baV0uY3VyVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgaXNDb2xvciA9IHZhbHVlSW5mb1tpXS5pc0NvbG9yOwogICAgICAgICAgICAgICAgaWYocHJvcGVydHlOYW1lID09ICdzY3JvbGxMZWZ0JyB8fCBwcm9wZXJ0eU5hbWUgPT0gJ3Njcm9sbFRvcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsW3Byb3BlcnR5TmFtZV0gPSB0aGlzLmdldFZhbHVlKGN1clZhbHVlLCBpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SW5mb1twcm9wZXJ0eU5hbWVdID0gaXNDb2xvciA/IGN1clZhbHVlIDogdGhpcy5nZXRWYWx1ZShjdXJWYWx1ZSwgaSk7CiAgICAgICAgICAgICAgICAgICAgbmVlZFNldCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKG5lZWRTZXQpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIHNldEluZm8pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2tleV0gPSBzZXRJbmZvW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgICAgLSAgIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG9yZGVyICAgIC0gICB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgb3JkZXIpewogICAgICAgICAgICByZXR1cm4gdGhpcy5uZWVkUGFyYW1zW29yZGVyXSA/IHZhbHVlICsgJ3B4JyA6IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlR3ZWVuIgogICAgfSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5TdGVwVHdlZW4KICAgICAqLwogICAgby5TdGVwVHdlZW4gPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHR5cGUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaViOaenOS8mOWFiOaIluaAp+iDveS8mOWFiAogICAgICAgICAqLwogICAgICAgIHR5cGU6ICJub3JtYWwiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlYXNlCiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIEBkZXNjIOS4jm9jdG9wdXMudHdlZW7kuI3lkIwg6L+Z6YeM55qEZHVyYXRpb27ooajnpLrliqjnlLvmiafooYznmoTmrKHmlbAKICAgICAgICAgKi8KICAgICAgICBkdXJhdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZnVuYwogICAgICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmdW5jOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb3VudAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwbGF5aW5nCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWcqOWKqOeUuwogICAgICAgICAqLwogICAgICAgIHBsYXlpbmc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8IG8uZWFzaW5nLmV4cG8uZWFzZU91dDsKICAgICAgICAgICAgdGhpcy5zdGFydCh0aGlzLnN0YXJ0VmFsdWUsIHRoaXMuZW5kVmFsdWUsIHRoaXMuZHVyYXRpb24sIHRoaXMuZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICogQHBhcmFtIHN0YXJ0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gZW5kVmFsdWUKICAgICAgICAgKiBAcGFyYW0gZHVyYXRpb24KICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihzdGFydFZhbHVlLCBlbmRWYWx1ZSwgZHVyYXRpb24sIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydFZhbHVlID0gc3RhcnRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5lbmRWYWx1ZSA9IGVuZFZhbHVlOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSAwOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuc3RhcnQuY2FsbCh0aGlzLCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuU3RlcFR3ZWVuLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLliqjnlLsKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMucGxheWluZykgcmV0dXJuOwoKICAgICAgICAgICAgaWYodGhpcy5mdW5jICYmIHRoaXMuZnVuYy5kb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZG9uZS5jYWxsKHRoaXMsIHRoaXMuZW5kVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZGVzdHJveQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZ1bmMgPSBudWxsOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLmVuZFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwbGF5CiAgICAgICAgICovCiAgICAgICAgcGxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMucGxheWluZyA9PSBmYWxzZSkJcmV0dXJuOwogICAgICAgICAgICB2YXIgdmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuc3RhcnRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLnN0YXJ0VmFsdWVba107CiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZW5kVmFsdWVba107CiAgICAgICAgICAgICAgICBpZihiID09IG51bGwgfHwgZiA9PSBudWxsIHx8IGlzTmFOKGIpIHx8IGlzTmFOKGYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHZhbHVlIGZvciBUd2VlbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGMgPSBmIC0gYjsKICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdGhpcy5lYXNlLmFwcGx5KHRoaXMsIFt0aGlzLmNvdW50LCBiLCBjLCB0aGlzLmR1cmF0aW9uXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb3VudCsrOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLmVhY2hTdGVwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZWFjaFN0ZXAuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5jb3VudCA+IHRoaXMuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlN0ZXBUd2VlbiIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmVhc2luZwogICAgICogQGRlc2Mg5Yqo55S75pa55rOVIOavj+S4quaWueazlemDveWMheaLrCAiZWFzZUluIiDmuJDlv6sgImVhc2VPdXQiIOa4kOaFoiAiZWFzZUluT3V0IiDnuqDnu5PnmoTkuInkuKrlgLzlj6/pgIkKICAgICAqLwogICAgby5lYXNpbmcgPSBvLmVhc2luZyB8fCB7fTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmxpbmVhcgogICAgICogQGRlc2Mg57q/5oCn5Yqo55S7CiAgICAgKi8KICAgIG8uZWFzaW5nLmxpbmVhciA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbgogICAgICAgICAqIEBkZXNjIOe6v+aAp+a4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDnur/mgKfmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6v+aAp+e6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmV4cG8KICAgICAqIEBkZXNjIOaMh+aVsOabsue6v+eahOe8k+WKqAogICAgICoKICAgICAqLwogICAgby5lYXNpbmcuZXhwbyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmV4cG8uZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICh0PT0wKSA/IGIgOiBjICogTWF0aC5wb3coMiwgMTAgKiAodC9kIC0gMSkpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gKHQ9PWQpID8gYitjIDogYyAqICgtTWF0aC5wb3coMiwgLTEwICogdC9kKSArIDEpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAodD09MCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICh0PT1kKSByZXR1cm4gYitjOwogICAgICAgICAgICBpZiAoKHQvPWQvMikgPCAxKSByZXR1cm4gYy8yICogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSArIGI7CiAgICAgICAgICAgIHJldHVybiBjLzIgKiAoLU1hdGgucG93KDIsIC0xMCAqIC0tdCkgKyAyKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnF1YWQKICAgICAqIEBkZXNjIOS6jOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFkID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhZC5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyoodC89ZCkqdCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YWQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC1jICoodC89ZCkqKHQtMikgKyBiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWFkLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodC89ZC8yKSA8IDEpIHJldHVybiBjLzIqdCp0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIC1jLzIgKiAoKC0tdCkqKHQtMikgLSAxKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmJhY2sKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOWklueahOS4gOerr+aIluS4pOerr+aJqeWxleWKqOeUu+S4gOasoe+8jOS7peS6p+eUn+S7juWFtuiMg+WbtOWkluWbnuaLieeahOaViOaenOOAggogICAgICog6YCa5L+X6K6y5bCx5piv5YWI5ZCR5ZCOIOWGjeWQkeWPjeaWueWQkQogICAgICovCiAgICBvLmVhc2luZy5iYWNrID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYmFjay5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCwgcykgewogICAgICAgICAgICBpZiAocyA9PSB1bmRlZmluZWQpIHMgPSAxLjcwMTU4OwogICAgICAgICAgICByZXR1cm4gYyAqICh0IC89IGQpICogdCAqICgocyArIDEpICogdCAtIHMpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIHJldHVybiBjICogKCh0ID0gdCAvIGQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5ib3VuY2UKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOeahOS4gOerr+aIluS4pOerr+WGhea3u+WKoOW8uei3s+aViOaenOOAguexu+S8vOS4gOS4queQg+iQveWQkeWcsOadv+WPiOW8uei1t+WQju+8jOWHoOasoemAkOa4kOWHj+Wwj+eahOWbnuW8uei/kOWKqAogICAgICovCiAgICBvLmVhc2luZy5ib3VuY2UgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5ib3VuY2UuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgLSBvLmVhc2luZy5ib3VuY2UuZWFzZU91dChkIC0gdCwgMCwgYywgZCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmJvdW5jZS5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCkgPCAoMSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiB0ICogdCkgKyBiCiAgICAgICAgICAgIH0gZWxzZSBpZiAodCA8ICgyIC8gMi43NSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjICogKDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgLjc1KSArIGIKICAgICAgICAgICAgfSBlbHNlIGlmICh0IDwgKDIuNSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi4yNSAvIDIuNzUpKSAqIHQgKyAuOTM3NSkgKyBiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi42MjUgLyAyLjc1KSkgKiB0ICsgLjk4NDM3NSkgKyBiCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYm91bmNlLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICh0IDwgZCAvIDIpIHJldHVybiBvLmVhc2luZy5ib3VuY2UuZWFzZUluKHQgKiAyLCAwLCBjLCBkKSAqIC41ICsgYjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gby5lYXNpbmcuYm91bmNlLmVhc2VPdXQodCAqIDIgLSBkLCAwLCBjLCBkKSAqIC41ICsgYyAqIC41ICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5lbGFzdGljCiAgICAgKiBAZGVzYyDmt7vliqDkuIDnq6/miJbkuKTnq6/otoXlh7rov4fmuKHojIPlm7TnmoTlvLnmgKfmlYjmnpwg5YW25Lit55qE6L+Q5Yqo55Sx5oyJ54Wn5oyH5pWw5pa55byP6KGw5YeP55qE5q2j5bym5rOi5p2l5a6a5LmJCiAgICAgKiDmjIfmlbDoobDlh4/nmoTmraPlvKbmm7Lnur/nvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuZWxhc3RpYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkKSA9PSAxKSByZXR1cm4gYiArIGM7CiAgICAgICAgICAgIGlmICghcCkgcCA9IGQgKiAuMzsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgcmV0dXJuIC0gKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZWxhc3RpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwKSByZXR1cm4gYjsKICAgICAgICAgICAgaWYgKCh0IC89IGQpID09IDEpIHJldHVybiBiICsgYzsKICAgICAgICAgICAgaWYgKCFwKSBwID0gZCAqIC4zOwogICAgICAgICAgICBpZiAoIWEgfHwgYSA8IE1hdGguYWJzKGMpKSB7CiAgICAgICAgICAgICAgICBhID0gYzsKICAgICAgICAgICAgICAgIHZhciBzID0gcCAvIDQKICAgICAgICAgICAgfSBlbHNlIHZhciBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oYyAvIGEpOwogICAgICAgICAgICByZXR1cm4gKGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICsgYyArIGIpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPT0gMikgcmV0dXJuIGIgKyBjOwogICAgICAgICAgICBpZiAoIXApIHAgPSBkICogKC4zICogMS41KTsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgaWYgKHQgPCAxKSByZXR1cm4gLSAuNSAqIChhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAqIGQgLSBzKSAqICgyICogTWF0aC5QSSkgLyBwKSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICogLjUgKyBjICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jaXJjCiAgICAgKiBAZGVzYyDlnIblvaLmm7Lnur/nmoTnvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuY2lyYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqIChNYXRoLnNxcnQoMSAtICh0IC89IGQpICogdCkgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY2lyYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqIE1hdGguc3FydCgxIC0gKHQgPSB0IC8gZCAtIDEpICogdCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiAtIGMgLyAyICogKE1hdGguc3FydCgxIC0gdCAqIHQpIC0gMSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYyAvIDIgKiAoTWF0aC5zcXJ0KDEgLSAodCAtPSAyKSAqIHQpICsgMSkgKyBiCiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnNpbmUKICAgICAqIEBkZXNjIOato+W8puabsue6v+e8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5zaW5lID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuc2luZS5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gLSBjICogTWF0aC5jb3ModCAvIGQgKiAoTWF0aC5QSSAvIDIpKSArIGMgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnNpbmUuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiBNYXRoLnNpbih0IC8gZCAqIChNYXRoLlBJIC8gMikpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5zaW5lLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiAtIGMgLyAyICogKE1hdGguY29zKE1hdGguUEkgKiB0IC8gZCkgLSAxKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVpbnQKICAgICAqIEBkZXNjIOS6lOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWludCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogKHQgLz0gZCkgKiB0ICogdCAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWludC5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgKiB0ICsgMSkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiB0ICogdCAqIHQgKiB0ICogdCArIGI7CiAgICAgICAgICAgIHJldHVybiBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVhcnQKICAgICAqIEBkZXNjIOWbm+asoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFydCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YXJ0LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICogdCArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiBjIC8gMiAqIHQgKiB0ICogdCAqIHQgKyBiOwogICAgICAgICAgICByZXR1cm4gLSBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAtIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jdWJpYwogICAgICogQGRlc2Mg5LiJ5qyh5pa555qE57yT5YqoCiAgICAgKi8KICAgIG8uZWFzaW5nLmN1YmljID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY3ViaWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCAvIDIpIDwgMSkgcmV0dXJuIGMgLyAyICogdCAqIHQgKiB0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5qih5Z2X566h55CGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKCS8qKgoJICogQG5hbWVzcGFjZSBvY3RvcHVzLmFwcAoJICogQGRlc2Mgb2N0b3B1cyBhcHDmqKHlnZfnu5PmnoQKCSAqLwogICAgby5hcHAgPSAoZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBhcHAgPSBudWxsOwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqIEBwYXJhbSBpbW1lZGlhdGUKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck1vZHVsZShpZCwgZnVuYywgaW1tZWRpYXRlKSB7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5yZWdpc3Rlck1vZHVsZShpZCwgZnVuYywgaW1tZWRpYXRlKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0aWFsaXplCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuICFhcHAgPyAoYXBwID0gbmV3IG8uQXBwKG9wdGlvbnMpLCBhcHApIDogKCEhb3B0aW9ucyA/IChjb25zb2xlLndhcm4oIlRoZSBhcHAgaGFzIGFscmVhZHkgZXhpc3QhIEZhaWx1cmUgdG8gc2V0IHVwIHRoZSBjb25maWciKSwgYXBwKSA6IGFwcCk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAuYWRkQ29uZmlnCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFkZENvbmZpZyhpZCwgb2JqKSB7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5hZGRDb25maWcoaWQsIG9iaik7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJBcGkoaWQsIG9iail7CiAgICAgICAgICAgIGluaXRpYWxpemUodW5kZWZpbmVkKS5yZWdpc3RlckFwaShpZCwgb2JqKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAuYWRkQ29uZmlnCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhZGRDb25maWc6IGFkZENvbmZpZywKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJBcGkKICAgICAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICAgICAqIEBwYXJhbSBvYmoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlZ2lzdGVyQXBpOiByZWdpc3RlckFwaSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hcHAucmVnaXN0ZXJNb2R1bGUKICAgICAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICAgICAqIEBwYXJhbSBmdW5jCiAgICAgICAgICAgICAqIEBwYXJhbSBpbW1lZGlhdGUKICAgICAgICAgICAgICogQGRlc2Mg5rOo5YaM5LiA5Liq5qih5Z2XCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZWdpc3Rlck1vZHVsZTogcmVnaXN0ZXJNb2R1bGUsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmluaXRpYWxpemUKICAgICAgICAgICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyWYXBw5a+56LGhIOWmguaenOS4jeiiq+iwg+eUqOWImeaMieeFp+m7mOiupOWxnuaAp+WIneWni+WMlgogICAgICAgICAgICAgKiBAcmV0dXJucyB7b2N0b3B1cy5BcHB8YXBwfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaW5pdGlhbGl6ZTogaW5pdGlhbGl6ZQogICAgICAgIH07CiAgICB9KSgpOwoKICAgIG8uQXBwID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpZAogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgaWQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2MgYXBw55qE5qC56IqC54K5CiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZpZXdFbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOWPr+inhuiKgueCuQogICAgICAgICAqLwogICAgICAgIHZpZXdFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbGF5ZXJzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqIEBkZXNjIOeuoeeQhueahOaooeWdlwogICAgICAgICAqLwogICAgICAgIGxheWVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY3VycmVudExheWVyCiAgICAgICAgICogQHR5cGUge28uTGF5ZXJ9CiAgICAgICAgICovCiAgICAgICAgY3VycmVudExheWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjbWRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIGNtZHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1DcmVhdG9yCiAgICAgICAgICogQGRlc2Mg55Sf5oiQ5ZmoCiAgICAgICAgICovCiAgICAgICAgbUNyZWF0b3I6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50cwogICAgICAgICAqIEB0eXBlIHtvLkV2ZW50c30KICAgICAgICAgKi8KICAgICAgICBldmVudHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50TGlzdGVuZXJzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBldmVudExpc3RlbmVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY21kTWFuYWdlcgogICAgICAgICAqIEB0eXBlIHtvLkNtZE1hbmFnZXJ9CiAgICAgICAgICovCiAgICAgICAgY21kTWFuYWdlcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRDYWNoZXMKICAgICAgICAgKiBAZGVzYyDkuovku7bnvJPlrZgg5Li76KaB6Ziy5q2iIOS4gOS6m+aooeWdl+acquWwseS9jeaXtueahOS6i+S7tuWIhuWPkQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBldmVudENhY2hlczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNMb2FkCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMb2FkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlnCiAgICAgICAgICogQGRlc2Mg6YWN572u6aG5CiAgICAgICAgICovCiAgICAgICAgY29uZmlnOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Jlc2l6ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgd2lkZ2V0cwogICAgICAgICAqLwogICAgICAgIHdpZGdldHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzSW5pdERvbQogICAgICAgICAqLwogICAgICAgIGlzSW5pdERvbTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNhY2hlRXZlbnREaXNwYXRjaAogICAgICAgICAqIEBkZXNjIOS6i+S7tue8k+WGsuWZqAogICAgICAgICAqLwogICAgICAgIGNhY2hlRXZlbnREaXNwYXRjaDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlncwogICAgICAgICAqIEBkZXNjIOmFjee9rumhuQogICAgICAgICAqLwogICAgICAgIGNvbmZpZ3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMubUNyZWF0b3IgPSB7fTsKICAgICAgICAgICAgdGhpcy5ldmVudENhY2hlcyA9IFtdOwogICAgICAgICAgICB0aGlzLmNvbmZpZ3MgPSB7fTsKICAgICAgICAgICAgdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2ggPSB7fTsKICAgICAgICAgICAgdGhpcy5pZCA9IGNvbmZpZy5pZCB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKCiAgICAgICAgICAgIC8v55uR5ZCsd2luZG935LqL5Lu2IOWQr+WKqOaooeWdlwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgInJlYWR5Iiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd0xvYWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAidW5sb2FkIiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd1VubG9hZCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJyZXNpemUiLCBvLnV0aWwuYmluZCh0aGlzLm9uV2luZG93UmVzaXplLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBpZigib3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdykgewogICAgICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcmllbnRhdGlvbmNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMub25PcmllbnRhdGlvbkNoYW5nZWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgICAgIGlmKGNvbmZpZy5ldmVudExpc3RlbmVycyAmJiBvLnV0aWwuaXNPYmplY3QoY29uZmlnLmV2ZW50TGlzdGVuZXJzKSkgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycyA9IGNvbmZpZy5ldmVudExpc3RlbmVyczsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnJlZ2lzdGVyKHRoaXMuZXZlbnRMaXN0ZW5lcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8v5ZG95Luk5pCe5LiK5Y67CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlciA9IG5ldyBvLkNtZE1hbmFnZXIoewogICAgICAgICAgICAgICAgYXBwOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihjb25maWcuY21kcykgewogICAgICAgICAgICAgICAgdGhpcy5jbWRzID0gY29uZmlnLmNtZHM7CiAgICAgICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmNtZHMsIG8udXRpbC5iaW5kKHRoaXMucmVnaXN0ZXJDbWQsIHRoaXMpKTsKICAgICAgICAgICAgICAgIHRoaXMuY21kcy5sZW5ndGggPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJDbWQKICAgICAgICAgKiBAcGFyYW0gY21kIHtvY3RvcHVzLkNtZH0KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckNtZDogZnVuY3Rpb24oY21kKSB7CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlci5yZWdpc3RlcihjbWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmV4ZWN1dGVDbWQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBvcHMge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDmiafooYzmjIflrprlkb3ku6QKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ21kOiBmdW5jdGlvbihuYW1lLCBvcHMpIHsKICAgICAgICAgICAgdGhpcy5jbWRNYW5hZ2VyLmV4ZWN1dGVDb21tYW5kKG5hbWUsIG9wcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudW5yZWdpc3RlckNtZAogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgdW5yZWdpc3RlckNtZDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIudW5yZWdpc3RlcihuYW1lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZWdpc3Rlck1lbWJlcgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOazqOWGjOeahOenjeexuyDlj6/pgInmqKHlnZfmiJbogIVhcGkKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30g5rOo5YaM55qEaWQKICAgICAgICAgKiBAcGFyYW0gY3JlYXRvciB7T2JqZWN0IHwgRnVuY3Rpb259IOaehOmAoOWZqAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyTWVtYmVyOiBmdW5jdGlvbih0eXBlLCBpZCwgY3JlYXRvcikgewogICAgICAgICAgICB0aGlzLm1DcmVhdG9yW3R5cGVdID0gdGhpcy5tQ3JlYXRvclt0eXBlXSB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubUNyZWF0b3JbdHlwZV1baWRdID0gewogICAgICAgICAgICAgICAgY3JlYXRvcjogY3JlYXRvciwKICAgICAgICAgICAgICAgIGluc3RhbmNlOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc3RhcnRNZW1iZXIKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0YXJ0TWVtYmVyOiBmdW5jdGlvbih0eXBlLCBpZCkgewogICAgICAgICAgICB2YXIgY3JlYXRvciA9IHRoaXMubUNyZWF0b3JbdHlwZV1baWRdOwogICAgICAgICAgICBpZighY3JlYXRvciB8fCBjcmVhdG9yLmluc3RhbmNlKSAgIHJldHVybjsKICAgICAgICAgICAgY3JlYXRvci5pbnN0YW5jZSA9IGNyZWF0b3IuY3JlYXRvcih0aGlzLCB0aGlzLmdldENvbmZpZyhpZCkpOwogICAgICAgICAgICBjcmVhdG9yLmluc3RhbmNlLmluaXQgJiYgY3JlYXRvci5pbnN0YW5jZS5pbml0KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gbQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyQXBpOiBmdW5jdGlvbihpZCwgbSkgewogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVtYmVyKCJhcGkiLCBpZCwgbSk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRBcGkoaWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG0ge09iamVjdCB8IHNyLk1vZHVsZX0KICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyTW9kdWxlOiBmdW5jdGlvbihpZCwgbSwgaW1tZWRpYXRlKSB7CiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJNZW1iZXIoIm1vZHVsZSIsIGlkLCBtKTsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmlzTG9hZCB8fCAhIWltbWVkaWF0ZSkgPyAodGhpcy5zdGFydE1vZHVsZShpZCksIHRydWUpIDogZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0TW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRNZW1iZXIoIm1vZHVsZSIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc3RhcnRBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBzdGFydEFwaTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydE1lbWJlcigiYXBpIiwgaWQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBnZXRBcGkKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBnZXRBcGk6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yWyJhcGkiXVtpZF0uaW5zdGFuY2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmdldE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGdldE1vZHVsZTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubUNyZWF0b3JbIm1vZHVsZSJdW2lkXS5pbnN0YW5jZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc3RvcE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0b3BNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVJdGVtID0gdGhpcy5tQ3JlYXRvclsibW9kdWxlIl1baWRdOwogICAgICAgICAgICBpZighbW9kdWxlSXRlbS5pbnN0YW5jZSkgICByZXR1cm47CiAgICAgICAgICAgIGlmIChtb2R1bGVJdGVtLmluc3RhbmNlLmRlc3Ryb3kpIHsKICAgICAgICAgICAgICAgIG1vZHVsZUl0ZW0uaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vZHVsZUl0ZW0uaW5zdGFuY2UgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLm9uCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30g5LqL5Lu25ZCNCiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufSDlm57osIMKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbih0eXBlLCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC51bgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuWQjQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Zue6LCDCiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAubm90aWZ5CiAgICAgICAgICogQGRlc2Mg6Kem5Y+R5p+Q6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZXZ0IHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbih0eXBlLCBldnQpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNMb2FkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50Q2FjaGVzLnB1c2goW3R5cGUsIGV2dF0pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnRyaWdnZXJFdmVudCh0eXBlLCBldnQpOwogICAgICAgICAgICBmb3IodmFyIGsgaW4gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2gpIHsKICAgICAgICAgICAgICAgIGlmKGsuaW5kZXhPZih0eXBlKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50RGlzcGF0Y2goaywgdHlwZSwgZXZ0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC50cmlnZ2VyRXZlbnREaXNwYXRjaAogICAgICAgICAqIEBkZXNjIOmAmuefpee8k+WGsuWZqCDmtLvmnaXkuoYKICAgICAgICAgKiBAcGFyYW0gaWQg57yT5Yay5Zmo55qEa2V5CiAgICAgICAgICogQHBhcmFtIHR5cGUg5a6M5oiQ55qE5bel5L2cdHlwZQogICAgICAgICAqIEBwYXJhbSBldnQg5a6M5oiQ55qE5bel5L2c5bim5p2l55qE5Y+Y6YePCiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlckV2ZW50RGlzcGF0Y2g6IGZ1bmN0aW9uKGlkLCB0eXBlLCBldnQpIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoID0gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbaWRdOwogICAgICAgICAgICBpZighZGlzcGF0Y2ggJiYgZGlzcGF0Y2guaGl0RmxhZyA9PSBkaXNwYXRjaC5oaXRzICB8fCBkaXNwYXRjaFsiY2FjaGVEYXRhIl1bdHlwZV0pICByZXR1cm47CiAgICAgICAgICAgIGRpc3BhdGNoWyJjYWNoZURhdGEiXVt0eXBlXSA9IGV2dDsKICAgICAgICAgICAgaWYoKytkaXNwYXRjaC5oaXRGbGFnID09IGRpc3BhdGNoLmhpdHMpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoLmZ1bmMuYXBwbHkodGhpcywgW2Rpc3BhdGNoLmNhY2hlRGF0YV0pOwogICAgICAgICAgICAgICAgZGlzcGF0Y2ggPSBudWxsOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2lkXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmFkZENvbmZpZwogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqIEBwYXJhbSBjb25maWcKICAgICAgICAgKi8KICAgICAgICBhZGRDb25maWc6IGZ1bmN0aW9uKGlkLCBjb25maWcpewogICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge307CiAgICAgICAgICAgIHZhciBjLCBwOwogICAgICAgICAgICBpZihpZCkgewogICAgICAgICAgICAgICAgYyA9IHRoaXMuY29uZmlnc1tpZF0gPSB0aGlzLmNvbmZpZ3NbaWRdIHx8IHt9OwogICAgICAgICAgICAgICAgZm9yKHAgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgY1twXSA9IGNvbmZpZ1twXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcihwIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnc1twXSA9IGNvbmZpZ1twXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRDb25maWcKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICBnZXRDb25maWc6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3NbaWRdIHx8IHt9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmludm9rZUV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDlkK/nlKjkuIDkuKrkuovku7bnvJPlhrLlmagg55So5p2l5aSE55CG5aSa5qyh5LqL5Lu25a6M5oiQ5omN5YGa5p+Q5LqL5oOF55qE6ZyA5rGCCiAgICAgICAgICovCiAgICAgICAgaW52b2tlRXZlbnREaXNwYXRjaDogZnVuY3Rpb24oZXZlbnRzLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2V2ZW50c10sCiAgICAgICAgICAgICAgICBsZW4gPSBTdHJpbmcoZXZlbnRzKS5zcGxpdCgiLCIpLmxlbmd0aDsKICAgICAgICAgICAgaWYoZGlzcGF0Y2ggJiYgZGlzcGF0Y2guaGl0RmxhZyA9PSBsZW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhpcyBraW5kIG9mIEV2ZW50RGlzcGF0Y2ggaGFzIGFscmVhZHkgaW52b2tlZCEiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtldmVudHNdID0gdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbZXZlbnRzXSB8fCB7CiAgICAgICAgICAgICAgICBoaXRzOiBsZW4sCiAgICAgICAgICAgICAgICBoaXRGbGFnOiAwLAogICAgICAgICAgICAgICAgY2FjaGVEYXRhOiB7fSwKICAgICAgICAgICAgICAgIGZ1bmM6IGZ1bmMKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dMb2FkCiAgICAgICAgICogQGRlc2Mg55uR5ZCsb25sb2Fk5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25XaW5kb3dMb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXSwgZnVuY3Rpb24oaXRlbSwgaykgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydE1vZHVsZShrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaXNMb2FkID0gdHJ1ZTsKICAgICAgICAgICAgaWYodGhpcy5ldmVudENhY2hlcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICB3aGlsZShpdGVtID0gdGhpcy5ldmVudENhY2hlcy5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnkoaXRlbVswXSwgaXRlbVsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLU1vZHVsZUNvbXBsZXRlZCIsIHt9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dVbmxvYWQKICAgICAgICAgKiBAZGVzYyDnm5HlkKzpobXpnaLnmoR1bmxvYWTkuovku7Yg6ZKI5a+55L2O54mI5pys5rWP6KeI5ZmoIOS4u+imgeWBmuS4gOS6m+WGheWtmOWbnuaUtuW3peS9nCDoh7Pkuo7pq5jnuqfmtY/op4jlmagg5aW95ZCnIOS9oOWPr+S7peiupOS4uuaIkeWcqOiHquasuuasuuS6ugogICAgICAgICAqLwogICAgICAgIG9uV2luZG93VW5sb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXSwgZnVuY3Rpb24oaXRlbSwgaykgewogICAgICAgICAgICAgICAgdGhhdC5zdG9wTW9kdWxlKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzTG9hZCkgICAgY29uc29sZS5lcnJvcigiVGhlIHBhZ2UgaGFzbid0IGxvYWRlZCEiKTsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBpZighZWwpICAgIGNvbnNvbGUuZXJyb3IoIkludmFsaWQgbm9kZSB0byByZW5kZXIhIik7CiAgICAgICAgICAgIHRoaXMuaW5pdERvbU1vZGUoZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0RG9tTW9kZQogICAgICAgICAqLwogICAgICAgIGluaXREb21Nb2RlOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICAvL+iKgueCueaooeW8jwogICAgICAgICAgICB0aGlzLmlzSW5pdERvbSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZywKICAgICAgICAgICAgICAgIG5vZGUgPSBlbCwKICAgICAgICAgICAgICAgIGlkID0gdGhpcy5pZCArICJfT2N0b3B1c19WaWV3UG9ydCI7CiAgICAgICAgICAgIHRoaXMuZWwgPSBvLmRvbS5jbG9uZU5vZGUobm9kZSwgdHJ1ZSk7CiAgICAgICAgICAgIHRoaXMudmlld0VsID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1cy12aWV3cG9ydCIsCiAgICAgICAgICAgICAgICBzdHlsZTogIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IHBvc2l0aW9uOiByZWxhdGl2ZTsgei1pbmRleDogMzAwOyBvdmVyZmxvdzogaGlkZGVuIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0aGlzLnZpZXdFbCk7CiAgICAgICAgICAgIC8v5aaC5p6c5piv6IqC54K55qih5byP5LiU5oul5pyJ5Zu+5bGCCiAgICAgICAgICAgIGlmKGNvbmZpZy5sYXllcnMpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5lYWNoKGNvbmZpZy5sYXllcnMsIG8udXRpbC5iaW5kKHRoaXMuYWRkTGF5ZXIsIHRoaXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL+WmguaenOaYr+iKgueCueaooeW8j+S4lOWIneWni+WMlndpZGdldOaOp+S7tgogICAgICAgICAgICBpZihjb25maWcud2lkZ2V0cykgewogICAgICAgICAgICAgICAgby51dGlsLmVhY2goY29uZmlnLndpZGdldHMsIG8udXRpbC5iaW5kKHRoaXMuYWRkV2lkZ2V0LCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUJlZm9yZUFwcENvbXBsZXRlZCIpOwogICAgICAgICAgICAvL+aKiuiiq+aQnuW+l+mdouebruWFqOmdnueahGVs5Yqg5YWl5paH5qGj5rWBCiAgICAgICAgICAgIGlmKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy5lbCwgbm9kZSk7CiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtQXBwQ29tcGxldGVkIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25PcmllbnRhdGlvbkNoYW5nZWQKICAgICAgICAgKiBAZGVzYyDnm5HlkKzmqKrnq5blsY/liIfmjaLkuovku7YKICAgICAgICAgKi8KICAgICAgICBvbk9yaWVudGF0aW9uQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1Pbk9yaWVudGF0aW9uQ2hhbmdlZCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvbldpbmRvd1Jlc2l6ZQogICAgICAgICAqLwogICAgICAgIG9uV2luZG93UmVzaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNSZXNpemUpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMuY2hlY2tTaXplLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVja1NpemUKICAgICAgICAgKi8KICAgICAgICBjaGVja1NpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1PbldpbmRvd1Jlc2l6ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmFkZExheWVyCiAgICAgICAgICogQGRlc2Mg57uZ5b2T5YmNZG9t5LiK5aKe5Yqg5Zu+5bGCIOWmguaenOS4jeWtmOWcqHRoaXMuZWwg5YiZ5q2k5pa55rOV5rKh5a6e6ZmF5pWI5p6cCiAgICAgICAgICogQHBhcmFtIGxheWVyIHtvY3RvcHVzLkxheWVyfQogICAgICAgICAqLwogICAgICAgIGFkZExheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBpZighdGhpcy5sYXllcnMpICAgIHRoaXMubGF5ZXJzID0gW107CiAgICAgICAgICAgIGlmKHRoaXMubGF5ZXJzLmluZGV4T2YobGF5ZXIpICE9IC0xKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgZWwgPSBsYXllci5nZXRFbCgpOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyhlbCwgIm9jdG9wdXMtYXBwLWxheWVyIik7CiAgICAgICAgICAgIHRoaXMuc2V0TGF5ZXJaSW5kZXgobGF5ZXIsIHRoaXMubGF5ZXJzLmxlbmd0aCk7CiAgICAgICAgICAgIGlmKGxheWVyLmlzQmFzZUxheWVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld0VsLmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihsYXllci5pc0N1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudExheWVyKGxheWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKICAgICAgICAgICAgbGF5ZXIuc2V0QXBwKHRoaXMpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtTGF5ZXJBZGQiLCB7bGF5ZXI6IGxheWVyfSk7CiAgICAgICAgICAgIGxheWVyLmFmdGVyQWRkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuc2V0Q3VycmVudExheWVyCiAgICAgICAgICogQHBhcmFtIGxheWVyCiAgICAgICAgICovCiAgICAgICAgc2V0Q3VycmVudExheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnRMYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIuc2V0Q3VycmVudChmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIgPSBsYXllcjsKICAgICAgICAgICAgdGhpcy50b3BMYXllcihsYXllcik7CiAgICAgICAgICAgIGxheWVyLnNldEN1cnJlbnQodHJ1ZSk7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1DdXJyZW50TGF5ZXJDaGFuZ2VkIiwge2xheWVyOiBsYXllcn0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzZXRMYXllclpJbmRleAogICAgICAgICAqIEBkZXNjIOiuvue9ruWbvuWxgueahGluZGV4CiAgICAgICAgICogQHBhcmFtIGxheWVyIHtvY3RvcHVzLkxheWVyfQogICAgICAgICAqIEBwYXJhbSB6SWR4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2V0TGF5ZXJaSW5kZXg6IGZ1bmN0aW9uKGxheWVyLCB6SWR4KSB7CiAgICAgICAgICAgIGxheWVyLnNldFpJbmRleCh0aGlzLlpfSU5ERVhfQkFTRVtsYXllci5pc0Jhc2VMYXllciA/ICJCYXNlTGF5ZXIiIDogIkxheWVyIl0gKyB6SWR4ICogNSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlc2V0TGF5ZXJzWkluZGV4CiAgICAgICAgICogQGRlc2MgcmVzZXTlm77lsYJ6aW5kZXgKICAgICAgICAgKi8KICAgICAgICByZXNldExheWVyc1pJbmRleDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5sYXllcnMsIGZ1bmN0aW9uKGxheWVyLCBpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnNldExheWVyWkluZGV4KGxheWVyLCBpKTsKICAgICAgICAgICAgfSkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VG9wWkluZGV4CiAgICAgICAgICovCiAgICAgICAgZ2V0VG9wWkluZGV4OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRvcEluZGV4ID0gewogICAgICAgICAgICAgICAgemluZGV4OiAwLAogICAgICAgICAgICAgICAgaW5kZXg6IDAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5sYXllcnMsIGZ1bmN0aW9uKGxheWVyLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ppbmRleCA9IGxheWVyLmdldEVsKCkuc3R5bGUuekluZGV4IHx8IDA7CiAgICAgICAgICAgICAgICBpZihfemluZGV4ID4gdG9wSW5kZXguemluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgdG9wSW5kZXggPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHppbmRleDogX3ppbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG9wSW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudG9wTGF5ZXIKICAgICAgICAgKi8KICAgICAgICB0b3BMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgdmFyIHRvcEluZGV4ID0gdGhpcy5nZXRUb3BaSW5kZXgoKSwKICAgICAgICAgICAgICAgIGluZGV4ID0gbGF5ZXIuZWwuc3R5bGUuekluZGV4OwogICAgICAgICAgICBpZih0b3BJbmRleCA9PSBpbmRleCkJcmV0dXJuOwogICAgICAgICAgICBsYXllci5lbC5zdHlsZS56SW5kZXggPSB0b3BJbmRleC56aW5kZXg7CiAgICAgICAgICAgIHRoaXMubGF5ZXJzW3RvcEluZGV4LmluZGV4XS5lbC5zdHlsZS56SW5kZXggPSBpbmRleDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRMYXllcgogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOmdoGlk6I635Y+W5Zu+5bGCCiAgICAgICAgICovCiAgICAgICAgZ2V0TGF5ZXI6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHZhciBsYXllciA9IG51bGw7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihfbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGlmKGlkID09IF9sYXllci5pZCkgewogICAgICAgICAgICAgICAgICAgIGxheWVyID0gX2xheWVyOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGxheWVyOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlbW92ZUxheWVyCiAgICAgICAgICogQHBhcmFtIGxheWVyCiAgICAgICAgICogQGRlc2Mg5Yig5o6J5Zu+5bGCCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlTGF5ZXI6IGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgICAgICAgIGxheWVyLmdldEVsKCkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChsYXllci5nZXRFbCgpKTsKICAgICAgICAgICAgby51dGlsLnJlbW92ZUl0ZW0odGhpcy5sYXllcnMsIGxheWVyKTsKICAgICAgICAgICAgbGF5ZXIucmVtb3ZlQXBwKHRoaXMpOwogICAgICAgICAgICBsYXllci5hcHAgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlc2V0TGF5ZXJzWkluZGV4KCk7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1MYXllclJlbW92ZSIsIHtsYXllcjogbGF5ZXJ9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRXaWRnZXQKICAgICAgICAgKiBAcGFyYW0gd2lkZ2V0IHtvY3RvcHVzLldpZGdldH0KICAgICAgICAgKiBAcGFyYW0gYXV0byB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmt7vliqB3aWRnZXTliLBhcHDph4wKICAgICAgICAgKi8KICAgICAgICBhZGRXaWRnZXQ6IGZ1bmN0aW9uKHdpZGdldCwgYXV0bykgewogICAgICAgICAgICBpZighdGhpcy53aWRnZXRzKSAgICB0aGlzLndpZGdldHMgPSBbXTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy53aWRnZXRzLmluZGV4T2Yod2lkZ2V0KTsKICAgICAgICAgICAgaWYoaW5kZXggPiAtMSkgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy53aWRnZXRzLnB1c2god2lkZ2V0KQogICAgICAgICAgICBpZighYXV0bykgewogICAgICAgICAgICAgICAgd2lkZ2V0LmNvbnRhaW5lciA9IHdpZGdldC5vdXRzaWRlVmlld3BvcnQgPyB0aGlzLmVsIDogdGhpcy52aWV3RWw7CiAgICAgICAgICAgICAgICB3aWRnZXQucmVuZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2lkZ2V0LnNldFpJbmRleCh0aGlzLlpfSU5ERVhfQkFTRS5XaWRnZXQgKyB0aGlzLndpZGdldHMubGVuZ3RoICogNSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0V2lkZ2V0CiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0V2lkZ2V0OiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgd2lkZ2V0ID0gbnVsbCwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy53aWRnZXRzLmxlbmd0aDsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy53aWRnZXRzLCBmdW5jdGlvbihfd2lkZ2V0KSB7CiAgICAgICAgICAgICAgICBpZihfd2lkZ2V0LmlkID09IGlkKSB7CiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0ID0gX3dpZGdldDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB3aWRnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVtb3ZlV2lkZ2V0CiAgICAgICAgICogQHBhcmFtIHdpZGdldCB7b2N0b3B1cy5XaWRnZXR9CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlV2lkZ2V0OiBmdW5jdGlvbih3aWRnZXQpIHsKICAgICAgICAgICAgaWYgKCh3aWRnZXQpICYmICh3aWRnZXQgPT0gdGhpcy5nZXRXaWRnZXQod2lkZ2V0LmlkKSkpIHsKICAgICAgICAgICAgICAgIHdpZGdldC5lbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdpZGdldC5lbCk7CiAgICAgICAgICAgICAgICBvLnV0aWwucmVtb3ZlSXRlbSh0aGlzLndpZGdldHMsIHdpZGdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBaX0lOREVYX0JBU0U6IHsKICAgICAgICAgICAgQmFzZUxheWVyOiAwLAogICAgICAgICAgICBMYXllcjogMzUwLAogICAgICAgICAgICBXaWRnZXQ6IDc1MCwKICAgICAgICAgICAgTWFzazogMTAwMCwKICAgICAgICAgICAgUG9wdXA6IDE1MDAKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5BcHAiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlkb3ku6TmiJbmk43kvZwKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkNtZCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgbmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYWN0aXZlCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgYWN0aXZlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXBwCiAgICAgICAgICogQHR5cGUge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIGFwcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihuYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZSB8fCB0aGlzLkNMQVNTX05BTUU7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWQuYWN0aXZhdGUKICAgICAgICAgKiBAZGVzYyDmv4DmtLvlkb3ku6TnirbmgIEKICAgICAgICAgKi8KICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWQuZGVhY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOaMgui1t+WRveS7pOeKtuaAgQogICAgICAgICAqLwogICAgICAgIGRlYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmV4ZWN1dGUKICAgICAgICAgKiBAcGFyYW0gb3B0aW9uCiAgICAgICAgICogQGRlc2Mg5omn6KGM5ZG95LukCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkJcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLnVuZXhlY3V0ZQogICAgICAgICAqIEBkZXNjIOWunueOsOatpOaWueazleeahOWRveS7pOaUr+aMgXVuZG8gcmVkbwogICAgICAgICAqLwogICAgICAgIHVuZXhlY3V0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLnNldEFwcAogICAgICAgICAqIEBwYWdlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKiBAZGVzYyDnu5Hlrprlkb3ku6TliLBhcHAKICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICBpZih0aGlzLmFwcCAhPSBhcHApIHsKICAgICAgICAgICAgICAgIHRoaXMuYXBwID0gYXBwOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5DbWQiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlkb3ku6TnrqHnkIbnsbsKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkNtZE1hbmFnZXIgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbW1hbmRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIGNvbW1hbmRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBleGVjdXRlQ21kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ21kczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmFtZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgbmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICAhIXRoaXMuYXBwID8gKHRoaXMuc2V0QXBwKHRoaXMuYXBwKSwgdHJ1ZSkgOiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lIHx8IG8udXRpbC5jcmVhdGVVbmlxdWVJRCh0aGlzLkNMQVNTX05BTUUgKyAiXyIpOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzID0gdGhpcy5jb21tYW5kcyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5leGVjdXRlQ21kcyA9IHRoaXMuZXhlY3V0ZUNtZHMgfHwgW107CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLnNldEFwcAogICAgICAgICAqIEBwYXJhbSBhcHAge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIHNldEFwcDogZnVuY3Rpb24oYXBwKSB7CiAgICAgICAgICAgIHRoaXMuYXBwID09IGFwcCA/IGZhbHNlIDogKHRoaXMuYXBwID0gYXBwLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIucmVnaXN0ZXIKICAgICAgICAgKiBAcGFyYW0gY29tbWFuZCB7by5DbWR9CiAgICAgICAgICogQGRlc2Mg5rOo5YaM5LiA5Liq5ZG95Luk5Yiw5ZG95Luk566h55CG5ZmoCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChjb21tYW5kKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29tbWFuZHMuaW5kZXhPZihjb21tYW5kKTsKICAgICAgICAgICAgaWYoaW5kZXggIT0gLTEpCXJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcy5wdXNoKGNvbW1hbmQpOwogICAgICAgICAgICBjb21tYW5kLnNldEFwcCh0aGlzLmFwcCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci51bnJlZ2lzdGVyCiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICB1bnJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuZ2V0Q29tbWFuZEluZGV4QnlOYW1lKG5hbWUpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkJcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBnZXRDb21tYW5kSW5kZXhCeU5hbWUKICAgICAgICAgKi8KICAgICAgICBnZXRDb21tYW5kSW5kZXhCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMuY29tbWFuZHMubGVuZ3RoLAogICAgICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGlmKG5hbWUgPT0gdGhpcy5jb21tYW5kc1tpXS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5leGVjdXRlQ29tbWFuZAogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9IOWRveS7pOWQjQogICAgICAgICAqIEBwYXJhbSBvcHRpb24ge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBleGVjdXRlQ29tbWFuZDogZnVuY3Rpb24obmFtZSwgb3B0aW9uKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuZ2V0Q29tbWFuZEluZGV4QnlOYW1lKG5hbWUpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkJcmV0dXJuOwogICAgICAgICAgICB0aGlzLmNvbW1hbmRzW2luZGV4XS5leGVjdXRlKG9wdGlvbik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLmRlc3Ryb3kKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuYXBwID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5DbWRNYW5hZ2VyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu257uT5p6E5paH5Lu2CiAqIOWumuS5ieWbvuWxguWfuuexuwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIG8uTGF5ZXIgPSBvLmRlZmluZSh7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb25maWcKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGNvbmZpZzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNDdXJyZW50CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNDdXJyZW50OiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnQKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5FdmVudHN9CiAgICAgICAgICovCiAgICAgICAgZXZlbnQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuTGF5ZXIuaXNCYXNlTGF5ZXIKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0Jhc2VMYXllcjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXBwCiAgICAgICAgICogQHR5cGUge29jdG9wdXMuQXBwfQogICAgICAgICAqLwogICAgICAgIGFwcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZyA9IG8uZXh0ZW5kKHt9LCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5pZCA9IGNvbmZpZy5pZCB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKICAgICAgICAgICAgdGhpcy5lbCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgaWQ6IHRoaXMuaWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaXNDdXJyZW50ID0gY29uZmlnLmlzQ3VycmVudCB8fCB0aGlzLmlzQ3VycmVudDsKICAgICAgICAgICAgdGhpcy5pc0Jhc2VMYXllciA9IGNvbmZpZy5pc0Jhc2VMYXllciB8fCB0aGlzLmlzQmFzZUxheWVyOwogICAgICAgICAgICBpZih0aGlzLmlzQ3VycmVudCB8fCB0aGlzLmlzQmFzZUxheWVyKSB7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1iYXNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ldmVudCA9IG5ldyBvLkV2ZW50cyh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLmdldEVsCiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIub24KICAgICAgICAgKiBAZGVzYyDkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbih0eXBlLCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnVuCiAgICAgICAgICogQGRlc2Mg5LqL5Lu25Y+W5raI55uR5ZCsCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5zZXRBcHAKICAgICAgICAgKiBAZGVzYyDnu5HlrpphcHAKICAgICAgICAgKiBAcGFyYW0gYXBwIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICByZXR1cm4gYXBwID09IHRoaXMuYXBwID8gZmFsc2UgOiAodGhpcy5hcHAgPSBhcHAsIHRydWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuYWZ0ZXJBZGQKICAgICAgICAgKiBAZGVzYyDnu5HlrprlhaVhcHDlkI7osIPnlKgKICAgICAgICAgKi8KICAgICAgICBhZnRlckFkZDogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuc2V0Q3VycmVudAogICAgICAgICAqIEBwYXJhbSBjdXJyZW50IHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIHNldEN1cnJlbnQ6IGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICAgICAgaWYoKGN1cnJlbnQgJiYgdGhpcy5pc0N1cnJlbnQpIHx8ICghY3VycmVudCAmJiAhdGhpcy5pc0N1cnJlbnQpKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNDdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgY3VycmVudCA/IG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzLWxheWVyLXNob3ciKSA6IG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMuZWwsICJvY3RvcHVzLWxheWVyLXNob3ciKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnNldFpJbmRleAogICAgICAgICAqIEBwYXJhbSB6SW5kZXgge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBzZXRaSW5kZXg6IGZ1bmN0aW9uKHpJbmRleCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IHpJbmRleDsKICAgICAgICB9LAoKICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIGRlYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICByZW1vdmVBcHA6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5MYXllciIKICAgIH0pOwp9KShvY3RvcHVzKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:16:57 GMT",
                    "Content-Length": "150974",
                    "Date": "Fri, 07 Nov 2014 21:16:58 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}