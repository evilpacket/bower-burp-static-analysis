{
    "url": "http://localhost:9999/fex-team/ueditor/_test/qunit/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.href</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var mainPageLocation = location.href.slice(0, paramsIndex);</li><li>banner.innerHTML = '&lt;a href=\"' + mainPageLocation + '\"&gt;' + banner.innerHTML + '&lt;/a&gt; &amp;#8250; &lt;a href=\"\"&gt;' + testName + '&lt;/a&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/fex-team/ueditor/_test/qunit/qunit.js",
                "path": "/fex-team/ueditor/_test/qunit/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mZXgtdGVhbS91ZWRpdG9yL190ZXN0L3F1bml0L3F1bml0LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzcyNjENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDA6MzE6MjEgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAwOjMxOjIwIEdNVA0KDQovKgogKiBRVW5pdCAtIEEgSmF2YVNjcmlwdCBVbml0IFRlc3RpbmcgRnJhbWV3b3JrCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAxMSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIG9yIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICovCgooZnVuY3Rpb24od2luZG93KSB7Cgp2YXIgZGVmaW5lZCA9IHsKCXNldFRpbWVvdXQ6IHR5cGVvZiB3aW5kb3cuc2V0VGltZW91dCAhPT0gInVuZGVmaW5lZCIsCglzZXNzaW9uU3RvcmFnZTogKGZ1bmN0aW9uKCkgewoJCXRyeSB7CgkJCXJldHVybiAhIXNlc3Npb25TdG9yYWdlLmdldEl0ZW07CgkJfSBjYXRjaChlKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KICB9KSgpCn07Cgp2YXIgdGVzdElkID0gMDsKCnZhciBUZXN0ID0gZnVuY3Rpb24obmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjaykgewoJdGhpcy5uYW1lID0gbmFtZTsKCXRoaXMudGVzdE5hbWUgPSB0ZXN0TmFtZTsKCXRoaXMuZXhwZWN0ZWQgPSBleHBlY3RlZDsKCXRoaXMudGVzdEVudmlyb25tZW50QXJnID0gdGVzdEVudmlyb25tZW50QXJnOwoJdGhpcy5hc3luYyA9IGFzeW5jOwoJdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoJdGhpcy5hc3NlcnRpb25zID0gW107Cn07ClRlc3QucHJvdG90eXBlID0gewoJaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CgkJaWYgKHRlc3RzKSB7CgkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJCQliLmlubmVySFRNTCA9ICJSdW5uaW5nICIgKyB0aGlzLm5hbWU7CgkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCQkJbGkuY2xhc3NOYW1lID0gInJ1bm5pbmciOwoJCQkJbGkuaWQgPSB0aGlzLmlkID0gInRlc3Qtb3V0cHV0IiArIHRlc3RJZCsrOwoJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsKCQl9Cgl9LAoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLm1vZHVsZSAhPSBjb25maWcucHJldmlvdXNNb2R1bGUpIHsKCQkJaWYgKCBjb25maWcucHJldmlvdXNNb2R1bGUgKSB7CgkJCQlRVW5pdC5tb2R1bGVEb25lKCB7CgkJCQkJbmFtZTogY29uZmlnLnByZXZpb3VzTW9kdWxlLAoJCQkJCWZhaWxlZDogY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKCQkJCQlwYXNzZWQ6IGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgLSBjb25maWcubW9kdWxlU3RhdHMuYmFkLAoJCQkJCXRvdGFsOiBjb25maWcubW9kdWxlU3RhdHMuYWxsCgkJCQl9ICk7CgkJCX0KCQkJY29uZmlnLnByZXZpb3VzTW9kdWxlID0gdGhpcy5tb2R1bGU7CgkJCWNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsKCQkJUVVuaXQubW9kdWxlU3RhcnQoIHsKCQkJCW5hbWU6IHRoaXMubW9kdWxlCgkJCX0gKTsKCQl9CgoJCWNvbmZpZy5jdXJyZW50ID0gdGhpczsKCQl0aGlzLnRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7CgkJCXNldHVwOiBmdW5jdGlvbigpIHt9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7fQoJCX0sIHRoaXMubW9kdWxlVGVzdEVudmlyb25tZW50KTsKCQlpZiAodGhpcy50ZXN0RW52aXJvbm1lbnRBcmcpIHsKCQkJZXh0ZW5kKHRoaXMudGVzdEVudmlyb25tZW50LCB0aGlzLnRlc3RFbnZpcm9ubWVudEFyZyk7CgkJfQoKCQlRVW5pdC50ZXN0U3RhcnQoIHsKCQkJbmFtZTogdGhpcy50ZXN0TmFtZQoJCX0gKTsKCgkJLy8gYWxsb3cgdXRpbGl0eSBmdW5jdGlvbnMgdG8gYWNjZXNzIHRoZSBjdXJyZW50IHRlc3QgZW52aXJvbm1lbnQKCQkvLyBUT0RPIHdoeT8/CgkJUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0aGlzLnRlc3RFbnZpcm9ubWVudDsKCQkKCQl0cnkgewoJCQlpZiAoICFjb25maWcucG9sbHV0aW9uICkgewoJCQkJc2F2ZUdsb2JhbCgpOwoJCQl9CgoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyB0aGlzLnRlc3ROYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCX0KCX0sCglydW46IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5hc3luYyApIHsKCQkJUVVuaXQuc3RvcCgpOwoJCX0KCgkJaWYgKCBjb25maWcubm90cnljYXRjaCApIHsKCQkJdGhpcy5jYWxsYmFjay5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQl0aGlzLmNhbGxiYWNrLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOwoJCX0gY2F0Y2goZSkgewoJCQlmYWlsKCJUZXN0ICIgKyB0aGlzLnRlc3ROYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIsIGUsIHRoaXMuY2FsbGJhY2spOwoJCQlRVW5pdC5vayggZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAodGhpcy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSArICIgLSAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGUpICk7CgkJCS8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5CgkJCXNhdmVHbG9iYWwoKTsKCgkJCS8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcKCQkJaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7CgkJCQlzdGFydCgpOwoJCQl9CgkJfQoJfSwKCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQl0cnkgewoJCQljaGVja1BvbGx1dGlvbigpOwoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyB0aGlzLnRlc3ROYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCX0KCX0sCglmaW5pc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5leHBlY3RlZCAmJiB0aGlzLmV4cGVjdGVkICE9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyB0aGlzLmV4cGVjdGVkICsgIiBhc3NlcnRpb25zLCBidXQgIiArIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOwoJCX0KCQkKCQl2YXIgZ29vZCA9IDAsIGJhZCA9IDAsCgkJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CgoJCWNvbmZpZy5zdGF0cy5hbGwgKz0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsKCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7CgoJCWlmICggdGVzdHMgKSB7CgkJCXZhciBvbCAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvbCIpOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJdmFyIGFzc2VydGlvbiA9IHRoaXMuYXNzZXJ0aW9uc1tpXTsKCgkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJbGkuY2xhc3NOYW1lID0gYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIjsKCQkJCWxpLmlubmVySFRNTCA9IGFzc2VydGlvbi5tZXNzYWdlIHx8IChhc3NlcnRpb24ucmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJCQkJb2wuYXBwZW5kQ2hpbGQoIGxpICk7CgoJCQkJaWYgKCBhc3NlcnRpb24ucmVzdWx0ICkgewoJCQkJCWdvb2QrKzsKCQkJCX0gZWxzZSB7CgkJCQkJYmFkKys7CgkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCX0KCQkJfQoKCQkJLy8gc3RvcmUgcmVzdWx0IHdoZW4gcG9zc2libGUKCQkJUVVuaXQuY29uZmlnLnJlb3JkZXIgJiYgZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCJxdW5pdC0iICsgdGhpcy50ZXN0TmFtZSwgYmFkKTsKCgkJCWlmIChiYWQgPT0gMCkgewoJCQkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCQkJfQoKCQkJdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKCQkJYi5pbm5lckhUTUwgPSB0aGlzLm5hbWUgKyAiIDxiIGNsYXNzPSdjb3VudHMnPig8YiBjbGFzcz0nZmFpbGVkJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzZWQnPiIgKyBnb29kICsgIjwvYj4sICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsKCQkJCgkJCWFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5OwoJCQkJbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKCQkJfSk7CgkJCQoJCQlhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7CgkJCQl2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7CgkJCQlpZiAoIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJzcGFuIiB8fCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAiYiIgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCQlpZiAoIHdpbmRvdy5sb2NhdGlvbiAmJiB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN0cm9uZyIgKSB7CgkJCQkJd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9ICI/IiArIGVuY29kZVVSSUNvbXBvbmVudChnZXRUZXh0KFt0YXJnZXRdKS5yZXBsYWNlKC9cKC4rXCkkLywgIiIpLnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKSk7CgkJCQl9CgkJCX0pOwoKCQkJdmFyIGxpID0gaWQodGhpcy5pZCk7CgkJCWxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKCQkJbGkucmVtb3ZlQ2hpbGQoIGxpLmZpcnN0Q2hpbGQgKTsKCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsKCQkJbGkuYXBwZW5kQ2hpbGQoIG9sICk7CgoJCX0gZWxzZSB7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggIXRoaXMuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7CgkJCQkJYmFkKys7CgkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCX0KCQkJfQoJCX0KCgkJdHJ5IHsKCQkJUVVuaXQucmVzZXQoKTsKCQl9IGNhdGNoKGUpIHsKCQkJZmFpbCgicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyB0aGlzLnRlc3ROYW1lICsgIiwgZXhjZXB0aW9uIGFuZCByZXNldCBmbiBmb2xsb3dzIiwgZSwgUVVuaXQucmVzZXQpOwoJCX0KCgkJUVVuaXQudGVzdERvbmUoIHsKCQkJbmFtZTogdGhpcy50ZXN0TmFtZSwKCQkJZmFpbGVkOiBiYWQsCgkJCXBhc3NlZDogdGhpcy5hc3NlcnRpb25zLmxlbmd0aCAtIGJhZCwKCQkJdG90YWw6IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGgKCQl9ICk7Cgl9LAoJCglxdWV1ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRlc3QgPSB0aGlzOwoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQl0ZXN0LmluaXQoKTsKCQl9KTsKCQlmdW5jdGlvbiBydW4oKSB7CgkJCS8vIGVhY2ggb2YgdGhlc2UgY2FuIGJ5IGFzeW5jCgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC5zZXR1cCgpOwoJCQl9KTsKCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCQl0ZXN0LnJ1bigpOwoJCQl9KTsKCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCQl0ZXN0LnRlYXJkb3duKCk7CgkJCX0pOwoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJCXRlc3QuZmluaXNoKCk7CgkJCX0pOwoJCX0KCQkvLyBkZWZlciB3aGVuIHByZXZpb3VzIHRlc3QgcnVuIHBhc3NlZCwgaWYgc3RvcmFnZSBpcyBhdmFpbGFibGUKCQl2YXIgYmFkID0gUVVuaXQuY29uZmlnLnJlb3JkZXIgJiYgZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJiArc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgicXVuaXQtIiArIHRoaXMudGVzdE5hbWUpOwoJCWlmIChiYWQpIHsKCQkJcnVuKCk7CgkJfSBlbHNlIHsKCQkJc3luY2hyb25pemUocnVuKTsKCQl9OwoJfQoJCn07Cgp2YXIgUVVuaXQgPSB7CgoJLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCgltb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgewoJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCQljb25maWcuY3VycmVudE1vZHVsZVRlc3RFbnZpcm9tZW50ID0gdGVzdEVudmlyb25tZW50OwoJfSwKCglhc3luY1Rlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2spIHsKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gMDsKCQl9CgoJCVFVbml0LnRlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSk7Cgl9LAoJCgl0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgewoJCXZhciBuYW1lID0gJzxzcGFuIGNsYXNzPSJ0ZXN0LW5hbWUiPicgKyB0ZXN0TmFtZSArICc8L3NwYW4+JywgdGVzdEVudmlyb25tZW50QXJnOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgkJLy8gaXMgMm5kIGFyZ3VtZW50IGEgdGVzdEVudmlyb25tZW50PwoJCWlmICggZXhwZWN0ZWQgJiYgdHlwZW9mIGV4cGVjdGVkID09PSAnb2JqZWN0JykgewoJCQl0ZXN0RW52aXJvbm1lbnRBcmcgPSAgZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgoJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJCW5hbWUgPSAnPHNwYW4gY2xhc3M9Im1vZHVsZS1uYW1lIj4nICsgY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiPC9zcGFuPjogIiArIG5hbWU7CgkJfQoKCQlpZiAoICF2YWxpZFRlc3QoY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiOiAiICsgdGVzdE5hbWUpICkgewoJCQlyZXR1cm47CgkJfQoJCQoJCXZhciB0ZXN0ID0gbmV3IFRlc3QobmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjayk7CgkJdGVzdC5tb2R1bGUgPSBjb25maWcuY3VycmVudE1vZHVsZTsKCQl0ZXN0Lm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IGNvbmZpZy5jdXJyZW50TW9kdWxlVGVzdEVudmlyb21lbnQ7CgkJdGVzdC5xdWV1ZSgpOwoJfSwKCQoJLyoqCgkgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCgkgKi8KCWV4cGVjdDogZnVuY3Rpb24oYXNzZXJ0cykgewoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkID0gYXNzZXJ0czsKCX0sCgoJLyoqCgkgKiBBc3NlcnRzIHRydWUuCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwoJICovCglvazogZnVuY3Rpb24oYSwgbXNnKSB7CgkJYSA9ICEhYTsKCQl2YXIgZGV0YWlscyA9IHsKCQkJcmVzdWx0OiBhLAoJCQltZXNzYWdlOiBtc2cKCQl9OwoJCW1zZyA9IGVzY2FwZUh0bWwobXNnKTsKCQlRVW5pdC5sb2coZGV0YWlscyk7CgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKCQkJcmVzdWx0OiBhLAoJCQltZXNzYWdlOiBtc2cKCQl9KTsKCX0sCgoJLyoqCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KCSAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KCSAqCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKCSAqCgkgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsKCSAqCgkgKiBAcGFyYW0gT2JqZWN0IGFjdHVhbAoJICogQHBhcmFtIE9iamVjdCBleHBlY3RlZAoJICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKCSAqLwoJZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCW5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCQoJZGVlcEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChRVW5pdC5lcXVpdihhY3R1YWwsIGV4cGVjdGVkKSwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCW5vdERlZXBFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goIVFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJc3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkID09PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3RTdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goZXhwZWN0ZWQgIT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCXJhaXNlczogZnVuY3Rpb24oYmxvY2ssIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJdmFyIGFjdHVhbCwgb2sgPSBmYWxzZTsKCQoJCWlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnKSB7CgkJCW1lc3NhZ2UgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSBudWxsOwoJCX0KCQoJCXRyeSB7CgkJCWJsb2NrKCk7CgkJfSBjYXRjaCAoZSkgewoJCQlhY3R1YWwgPSBlOwoJCX0KCQoJCWlmIChhY3R1YWwpIHsKCQkJLy8gd2UgZG9uJ3Qgd2FudCB0byB2YWxpZGF0ZSB0aHJvd24gZXJyb3IKCQkJaWYgKCFleHBlY3RlZCkgewoJCQkJb2sgPSB0cnVlOwoJCQkvLyBleHBlY3RlZCBpcyBhIHJlZ2V4cAkKCQkJfSBlbHNlIGlmIChRVW5pdC5vYmplY3RUeXBlKGV4cGVjdGVkKSA9PT0gInJlZ2V4cCIpIHsKCQkJCW9rID0gZXhwZWN0ZWQudGVzdChhY3R1YWwpOwoJCQkvLyBleHBlY3RlZCBpcyBhIGNvbnN0cnVjdG9yCQoJCQl9IGVsc2UgaWYgKGFjdHVhbCBpbnN0YW5jZW9mIGV4cGVjdGVkKSB7CgkJCQlvayA9IHRydWU7CgkJCS8vIGV4cGVjdGVkIGlzIGEgdmFsaWRhdGlvbiBmdW5jdGlvbiB3aGljaCByZXR1cm5zIHRydWUgaXMgdmFsaWRhdGlvbiBwYXNzZWQJCgkJCX0gZWxzZSBpZiAoZXhwZWN0ZWQuY2FsbCh7fSwgYWN0dWFsKSA9PT0gdHJ1ZSkgewoJCQkJb2sgPSB0cnVlOwoJCQl9CgkJfQoJCQkKCQlRVW5pdC5vayhvaywgbWVzc2FnZSk7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbigpIHsKCQljb25maWcuc2VtYXBob3JlLS07CgkJaWYgKGNvbmZpZy5zZW1hcGhvcmUgPiAwKSB7CgkJCS8vIGRvbid0IHN0YXJ0IHVudGlsIGVxdWFsIG51bWJlciBvZiBzdG9wLWNhbGxzCgkJCXJldHVybjsKCQl9CgkJaWYgKGNvbmZpZy5zZW1hcGhvcmUgPCAwKSB7CgkJCS8vIGlnbm9yZSBpZiBzdGFydCBpcyBjYWxsZWQgbW9yZSBvZnRlbiB0aGVuIHN0b3AKCQkJY29uZmlnLnNlbWFwaG9yZSA9IDA7CgkJfQoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKCQlpZiAoIGRlZmluZWQuc2V0VGltZW91dCApIHsKCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNvbmZpZy50aW1lb3V0ICkgewoJCQkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CgkJCQl9CgoJCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgkJCQlwcm9jZXNzKCk7CgkJCX0sIDEzKTsKCQl9IGVsc2UgewoJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJcHJvY2VzcygpOwoJCX0KCX0sCgkKCXN0b3A6IGZ1bmN0aW9uKHRpbWVvdXQpIHsKCQljb25maWcuc2VtYXBob3JlKys7CgkJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCgkJaWYgKCB0aW1lb3V0ICYmIGRlZmluZWQuc2V0VGltZW91dCApIHsKCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKCQkJY29uZmlnLnRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwoJCQkJUVVuaXQuc3RhcnQoKTsKCQkJfSwgdGltZW91dCk7CgkJfQoJfQoKfTsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkClFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOwpRVW5pdC5zYW1lID0gUVVuaXQuZGVlcEVxdWFsOwoKLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUKdmFyIGNvbmZpZyA9IHsKCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KCXF1ZXVlOiBbXSwKCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQoJYmxvY2tpbmc6IHRydWUsCgkKCS8vIGJ5IGRlZmF1bHQsIHJ1biBwcmV2aW91c2x5IGZhaWxlZCB0ZXN0cyBmaXJzdAoJLy8gdmVyeSB1c2VmdWwgaW4gY29tYmluYXRpb24gd2l0aCAiSGlkZSBwYXNzZWQgdGVzdHMiIGNoZWNrZWQKCXJlb3JkZXI6IHRydWUKfTsKCi8vIExvYWQgcGFyYW1hdGVycwooZnVuY3Rpb24oKSB7Cgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoKCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsKCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOwoJCWlmICggR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIiApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJCWNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vdHJ5Y2F0Y2giICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQkJY29uZmlnLm5vdHJ5Y2F0Y2ggPSB0cnVlOwoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQl9Cgl9CgkKCS8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOwoJCgkvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90CglRVW5pdC5pc0xvY2FsID0gISEobG9jYXRpb24ucHJvdG9jb2wgPT09ICdmaWxlOicpOwp9KSgpOwoKLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJwovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsKCWV4dGVuZCh3aW5kb3csIFFVbml0KTsKCXdpbmRvdy5RVW5pdCA9IFFVbml0Owp9IGVsc2UgewoJZXh0ZW5kKGV4cG9ydHMsIFFVbml0KTsKCWV4cG9ydHMuUVVuaXQgPSBRVW5pdDsKfQoKLy8gZGVmaW5lIHRoZXNlIGFmdGVyIGV4cG9zaW5nIGdsb2JhbHMgdG8ga2VlcCB0aGVtIGluIHRoZXNlIFFVbml0IG5hbWVzcGFjZSBvbmx5CmV4dGVuZChRVW5pdCwgewoJY29uZmlnOiBjb25maWcsCgoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiBvcHRpb25zCglpbml0OiBmdW5jdGlvbigpIHsKCQlleHRlbmQoY29uZmlnLCB7CgkJCXN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCgkJCW1vZHVsZVN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCgkJCXN0YXJ0ZWQ6ICtuZXcgRGF0ZSwKCQkJdXBkYXRlUmF0ZTogMTAwMCwKCQkJYmxvY2tpbmc6IGZhbHNlLAoJCQlhdXRvc3RhcnQ6IHRydWUsCgkJCWF1dG9ydW46IGZhbHNlLAoJCQlmaWx0ZXJzOiBbXSwKCQkJcXVldWU6IFtdLAoJCQlzZW1hcGhvcmU6IDAKCQl9KTsKCgkJdmFyIHRlc3RzID0gaWQoICJxdW5pdC10ZXN0cyIgKSwKCQkJYmFubmVyID0gaWQoICJxdW5pdC1iYW5uZXIiICksCgkJCXJlc3VsdCA9IGlkKCAicXVuaXQtdGVzdHJlc3VsdCIgKTsKCgkJaWYgKCB0ZXN0cyApIHsKCQkJdGVzdHMuaW5uZXJIVE1MID0gIiI7CgkJfQoKCQlpZiAoIGJhbm5lciApIHsKCQkJYmFubmVyLmNsYXNzTmFtZSA9ICIiOwoJCX0KCgkJaWYgKCByZXN1bHQgKSB7CgkJCXJlc3VsdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCByZXN1bHQgKTsKCQl9CgkJCgkJaWYgKCB0ZXN0cyApIHsKCQkJcmVzdWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInAiICk7CgkJCXJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsKCQkJcmVzdWx0LmNsYXNzTmFtZSA9ICJyZXN1bHQiOwoJCQl0ZXN0cy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggcmVzdWx0LCB0ZXN0cyApOwoJCQlyZXN1bHQuaW5uZXJIVE1MID0gJ1J1bm5pbmcuLi48YnIvPiZuYnNwOyc7CgkJfQoJfSwKCQoJLyoqCgkgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KCSAqIAoJICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgdXNlcyBqUXVlcnkncyBodG1sKCksIG90aGVyd2lzZSBqdXN0IGlubmVySFRNTC4KCSAqLwoJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggd2luZG93LmpRdWVyeSApIHsKCQkJalF1ZXJ5KCAiI21haW4sICNxdW5pdC1maXh0dXJlIiApLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7CgkJfSBlbHNlIHsKCQkJdmFyIG1haW4gPSBpZCggJ21haW4nICkgfHwgaWQoICdxdW5pdC1maXh0dXJlJyApOwoJCQlpZiAoIG1haW4gKSB7CgkJCQltYWluLmlubmVySFRNTCA9IGNvbmZpZy5maXh0dXJlOwoJCQl9CgkJfQoJfSwKCQoJLyoqCgkgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCgkgKgoJICogQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7CgkgKgoJICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQoJICogQHBhcmFtIFN0cmluZyB0eXBlCgkgKi8KCXRyaWdnZXJFdmVudDogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGV2ZW50ICkgewoJCWlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnQgKSB7CgkJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CgkJCWV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKCQkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCQkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoKCQl9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsKCQkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsKCQl9Cgl9LAoJCgkvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCglpczogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQlyZXR1cm4gUVVuaXQub2JqZWN0VHlwZSggb2JqICkgPT0gdHlwZTsKCX0sCgkKCW9iamVjdFR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CgkJaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CgkJCQlyZXR1cm4gInVuZGVmaW5lZCI7CgoJCS8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CgkJfQoJCWlmIChvYmogPT09IG51bGwpIHsKCQkJCXJldHVybiAibnVsbCI7CgkJfQoKCQl2YXIgdHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCggb2JqICkKCQkJLm1hdGNoKC9eXFtvYmplY3RccyguKilcXSQvKVsxXSB8fCAnJzsKCgkJc3dpdGNoICh0eXBlKSB7CgkJCQljYXNlICdOdW1iZXInOgoJCQkJCQlpZiAoaXNOYU4ob2JqKSkgewoJCQkJCQkJCXJldHVybiAibmFuIjsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlyZXR1cm4gIm51bWJlciI7CgkJCQkJCX0KCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQljYXNlICdCb29sZWFuJzoKCQkJCWNhc2UgJ0FycmF5JzoKCQkJCWNhc2UgJ0RhdGUnOgoJCQkJY2FzZSAnUmVnRXhwJzoKCQkJCWNhc2UgJ0Z1bmN0aW9uJzoKCQkJCQkJcmV0dXJuIHR5cGUudG9Mb3dlckNhc2UoKTsKCQl9CgkJaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CgkJCQlyZXR1cm4gIm9iamVjdCI7CgkJfQoJCXJldHVybiB1bmRlZmluZWQ7Cgl9LAoJCglwdXNoOiBmdW5jdGlvbihyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQl2YXIgZGV0YWlscyA9IHsKCQkJcmVzdWx0OiByZXN1bHQsCgkJCW1lc3NhZ2U6IG1lc3NhZ2UsCgkJCWFjdHVhbDogYWN0dWFsLAoJCQlleHBlY3RlZDogZXhwZWN0ZWQKCQl9OwoJCQoJCW1lc3NhZ2UgPSBlc2NhcGVIdG1sKG1lc3NhZ2UpIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CgkJbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1tZXNzYWdlIj4nICsgbWVzc2FnZSArICI8L3NwYW4+IjsKCQlleHBlY3RlZCA9IGVzY2FwZUh0bWwoUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSk7CgkJYWN0dWFsID0gZXNjYXBlSHRtbChRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSk7CgkJdmFyIG91dHB1dCA9IG1lc3NhZ2UgKyAnPHRhYmxlPjx0ciBjbGFzcz0idGVzdC1leHBlY3RlZCI+PHRoPkV4cGVjdGVkOiA8L3RoPjx0ZD48cHJlPicgKyBleHBlY3RlZCArICc8L3ByZT48L3RkPjwvdHI+JzsKCQlpZiAoYWN0dWFsICE9IGV4cGVjdGVkKSB7CgkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LWFjdHVhbCI+PHRoPlJlc3VsdDogPC90aD48dGQ+PHByZT4nICsgYWN0dWFsICsgJzwvcHJlPjwvdGQ+PC90cj4nOwoJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1kaWZmIj48dGg+RGlmZjogPC90aD48dGQ+PHByZT4nICsgUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKSArJzwvcHJlPjwvdGQ+PC90cj4nOwoJCX0KCQlpZiAoIXJlc3VsdCkgewoJCQl2YXIgc291cmNlID0gc291cmNlRnJvbVN0YWNrdHJhY2UoKTsKCQkJaWYgKHNvdXJjZSkgewoJCQkJZGV0YWlscy5zb3VyY2UgPSBzb3VyY2U7CgkJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1zb3VyY2UiPjx0aD5Tb3VyY2U6IDwvdGg+PHRkPjxwcmU+JyArIHNvdXJjZSArJzwvcHJlPjwvdGQ+PC90cj4nOwoJCQl9CgkJfQoJCW91dHB1dCArPSAiPC90YWJsZT4iOwoJCQoJCVFVbml0LmxvZyhkZXRhaWxzKTsKCQkKCQljb25maWcuY3VycmVudC5hc3NlcnRpb25zLnB1c2goewoJCQlyZXN1bHQ6ICEhcmVzdWx0LAoJCQltZXNzYWdlOiBvdXRwdXQKCQl9KTsKCX0sCgkKCS8vIExvZ2dpbmcgY2FsbGJhY2tzOyBhbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCB3aXRoIHRoZSBsaXN0ZWQgcHJvcGVydGllcwoJLy8gcnVuIHRlc3QvbG9ncy5odG1sIGZvciBhbnkgcmVsYXRlZCBjaGFuZ2VzCgliZWdpbjogZnVuY3Rpb24oKSB7fSwKCS8vIGRvbmU6IHsgZmFpbGVkLCBwYXNzZWQsIHRvdGFsLCBydW50aW1lIH0KCWRvbmU6IGZ1bmN0aW9uKCkge30sCgkvLyBsb2c6IHsgcmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlIH0KCWxvZzogZnVuY3Rpb24oKSB7fSwKCS8vIHRlc3RTdGFydDogeyBuYW1lIH0KCXRlc3RTdGFydDogZnVuY3Rpb24oKSB7fSwKCS8vIHRlc3REb25lOiB7IG5hbWUsIGZhaWxlZCwgcGFzc2VkLCB0b3RhbCB9Cgl0ZXN0RG9uZTogZnVuY3Rpb24oKSB7fSwKCS8vIG1vZHVsZVN0YXJ0OiB7IG5hbWUgfQoJbW9kdWxlU3RhcnQ6IGZ1bmN0aW9uKCkge30sCgkvLyBtb2R1bGVEb25lOiB7IG5hbWUsIGZhaWxlZCwgcGFzc2VkLCB0b3RhbCB9Cgltb2R1bGVEb25lOiBmdW5jdGlvbigpIHt9Cn0pOwoKaWYgKCB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7Cn0KCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsKCVFVbml0LmJlZ2luKHt9KTsKCQoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQoJdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKCVFVbml0LmluaXQoKTsKCWV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7CgoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgoJdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKCWlmICggdXNlckFnZW50ICkgewoJCXVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJfQoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1oZWFkZXIiKTsKCWlmICggYmFubmVyICkgewoJCXZhciBwYXJhbXNJbmRleCA9IGxvY2F0aW9uLmhyZWYubGFzdEluZGV4T2YobG9jYXRpb24uc2VhcmNoKTsKCQlpZiAoIHBhcmFtc0luZGV4ID4gLTEgKSB7CgkJCXZhciBtYWluUGFnZUxvY2F0aW9uID0gbG9jYXRpb24uaHJlZi5zbGljZSgwLCBwYXJhbXNJbmRleCk7CgkJCWlmICggbWFpblBhZ2VMb2NhdGlvbiA9PSBsb2NhdGlvbi5ocmVmICkgewoJCQkJYmFubmVyLmlubmVySFRNTCA9ICc8YSBocmVmPSIiPiAnICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICc7CgkJCX0gZWxzZSB7CgkJCQl2YXIgdGVzdE5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQobG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpKTsKCQkJCWJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iJyArIG1haW5QYWdlTG9jYXRpb24gKyAnIj4nICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICYjODI1MDsgPGEgaHJlZj0iIj4nICsgdGVzdE5hbWUgKyAnPC9hPic7CgkJCX0KCQl9Cgl9CgkKCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJaWYgKCB0b29sYmFyICkgewoJCXZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCWZpbHRlci50eXBlID0gImNoZWNrYm94IjsKCQlmaWx0ZXIuaWQgPSAicXVuaXQtZmlsdGVyLXBhc3MiOwoJCWFkZEV2ZW50KCBmaWx0ZXIsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgb2wgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicXVuaXQtdGVzdHMiKTsKCQkJaWYgKCBmaWx0ZXIuY2hlY2tlZCApIHsKCQkJCW9sLmNsYXNzTmFtZSA9IG9sLmNsYXNzTmFtZSArICIgaGlkZXBhc3MiOwoJCQl9IGVsc2UgewoJCQkJdmFyIHRtcCA9ICIgIiArIG9sLmNsYXNzTmFtZS5yZXBsYWNlKCAvW1xuXHRccl0vZywgIiAiICkgKyAiICI7CgkJCQlvbC5jbGFzc05hbWUgPSB0bXAucmVwbGFjZSgvIGhpZGVwYXNzIC8sICIgIik7CgkJCX0KCQkJaWYgKCBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICkgewoJCQkJc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgicXVuaXQtZmlsdGVyLXBhc3NlZC10ZXN0cyIsIGZpbHRlci5jaGVja2VkID8gInRydWUiIDogIiIpOwoJCQl9CgkJfSk7CgkJaWYgKCBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oInF1bml0LWZpbHRlci1wYXNzZWQtdGVzdHMiKSApIHsKCQkJZmlsdGVyLmNoZWNrZWQgPSB0cnVlOwoJCQl2YXIgb2wgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicXVuaXQtdGVzdHMiKTsKCQkJb2wuY2xhc3NOYW1lID0gb2wuY2xhc3NOYW1lICsgIiBoaWRlcGFzcyI7CgkJfQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOwoKCQl2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7CgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgcGFzc2VkIHRlc3RzIjsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoJfQoKCXZhciBtYWluID0gaWQoJ21haW4nKSB8fCBpZCgncXVuaXQtZml4dHVyZScpOwoJaWYgKCBtYWluICkgewoJCWNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7Cgl9CgoJaWYgKGNvbmZpZy5hdXRvc3RhcnQpIHsKCQlRVW5pdC5zdGFydCgpOwoJfQp9KTsKCmZ1bmN0aW9uIGRvbmUoKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7CgoJLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzCglpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCVFVbml0Lm1vZHVsZURvbmUoIHsKCQkJbmFtZTogY29uZmlnLmN1cnJlbnRNb2R1bGUsCgkJCWZhaWxlZDogY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKCQkJcGFzc2VkOiBjb25maWcubW9kdWxlU3RhdHMuYWxsIC0gY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKCQkJdG90YWw6IGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwKCQl9ICk7Cgl9CgoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAoJCXJ1bnRpbWUgPSArbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwKCQlwYXNzZWQgPSBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwKCQlodG1sID0gWwoJCQknVGVzdHMgY29tcGxldGVkIGluICcsCgkJCXJ1bnRpbWUsCgkJCScgbWlsbGlzZWNvbmRzLjxici8+JywKCQkJJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsCgkJCXBhc3NlZCwKCQkJJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9InRvdGFsIj4nLAoJCQljb25maWcuc3RhdHMuYWxsLAoJCQknPC9zcGFuPiBwYXNzZWQsIDxzcGFuIGNsYXNzPSJmYWlsZWQiPicsCgkJCWNvbmZpZy5zdGF0cy5iYWQsCgkJCSc8L3NwYW4+IGZhaWxlZC4nCgkJXS5qb2luKCcnKTsKCglpZiAoIGJhbm5lciApIHsKCQliYW5uZXIuY2xhc3NOYW1lID0gKGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIpOwoJfQoKCWlmICggdGVzdHMgKSB7CQoJCWlkKCAicXVuaXQtdGVzdHJlc3VsdCIgKS5pbm5lckhUTUwgPSBodG1sOwoJfQoKCVFVbml0LmRvbmUoIHsKCQlmYWlsZWQ6IGNvbmZpZy5zdGF0cy5iYWQsCgkJcGFzc2VkOiBwYXNzZWQsIAoJCXRvdGFsOiBjb25maWcuc3RhdHMuYWxsLAoJCXJ1bnRpbWU6IHJ1bnRpbWUKCX0gKTsKfQoKZnVuY3Rpb24gdmFsaWRUZXN0KCBuYW1lICkgewoJdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsCgkJcnVuID0gZmFsc2U7CgoJaWYgKCAhaSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCQoJd2hpbGUgKCBpLS0gKSB7CgkJdmFyIGZpbHRlciA9IGNvbmZpZy5maWx0ZXJzW2ldLAoJCQlub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCgkJaWYgKCBub3QgKSB7CgkJCWZpbHRlciA9IGZpbHRlci5zbGljZSgxKTsKCQl9CgoJCWlmICggbmFtZS5pbmRleE9mKGZpbHRlcikgIT09IC0xICkgewoJCQlyZXR1cm4gIW5vdDsKCQl9CgoJCWlmICggbm90ICkgewoJCQlydW4gPSB0cnVlOwoJCX0KCX0KCglyZXR1cm4gcnVuOwp9CgovLyBzbyBmYXIgc3VwcG9ydHMgb25seSBGaXJlZm94LCBDaHJvbWUgYW5kIE9wZXJhIChidWdneSkKLy8gY291bGQgYmUgZXh0ZW5kZWQgaW4gdGhlIGZ1dHVyZSB0byB1c2Ugc29tZXRoaW5nIGxpa2UgaHR0cHM6Ly9naXRodWIuY29tL2Nzbm92ZXIvVHJhY2VLaXQKZnVuY3Rpb24gc291cmNlRnJvbVN0YWNrdHJhY2UoKSB7Cgl0cnkgewoJCXRocm93IG5ldyBFcnJvcigpOwoJfSBjYXRjaCAoIGUgKSB7CgkJaWYgKGUuc3RhY2t0cmFjZSkgewoJCQkvLyBPcGVyYQoJCQlyZXR1cm4gZS5zdGFja3RyYWNlLnNwbGl0KCJcbiIpWzZdOwoJCX0gZWxzZSBpZiAoZS5zdGFjaykgewoJCQkvLyBGaXJlZm94LCBDaHJvbWUKCQkJcmV0dXJuIGUuc3RhY2suc3BsaXQoIlxuIilbNF07CgkJfQoJfQp9CgpmdW5jdGlvbiBlc2NhcGVIdG1sKHMpIHsKCWlmICghcykgewoJCXJldHVybiAiIjsKCX0KCXMgPSBzICsgIiI7CglyZXR1cm4gcy5yZXBsYWNlKC9bXCYiPD5cXF0vZywgZnVuY3Rpb24ocykgewoJCXN3aXRjaChzKSB7CgkJCWNhc2UgIiYiOiByZXR1cm4gIiZhbXA7IjsKCQkJY2FzZSAiXFwiOiByZXR1cm4gIlxcXFwiOwoJCQljYXNlICciJzogcmV0dXJuICdcIic7CgkJCWNhc2UgIjwiOiByZXR1cm4gIiZsdDsiOwoJCQljYXNlICI+IjogcmV0dXJuICImZ3Q7IjsKCQkJZGVmYXVsdDogcmV0dXJuIHM7CgkJfQoJfSk7Cn0KCmZ1bmN0aW9uIHN5bmNocm9uaXplKCBjYWxsYmFjayApIHsKCWNvbmZpZy5xdWV1ZS5wdXNoKCBjYWxsYmFjayApOwoKCWlmICggY29uZmlnLmF1dG9ydW4gJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQlwcm9jZXNzKCk7Cgl9Cn0KCmZ1bmN0aW9uIHByb2Nlc3MoKSB7Cgl2YXIgc3RhcnQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoKCXdoaWxlICggY29uZmlnLnF1ZXVlLmxlbmd0aCAmJiAhY29uZmlnLmJsb2NraW5nICkgewoJCWlmICggY29uZmlnLnVwZGF0ZVJhdGUgPD0gMCB8fCAoKChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSBzdGFydCkgPCBjb25maWcudXBkYXRlUmF0ZSkgKSB7CgkJCWNvbmZpZy5xdWV1ZS5zaGlmdCgpKCk7CgkJfSBlbHNlIHsKCQkJd2luZG93LnNldFRpbWVvdXQoIHByb2Nlc3MsIDEzICk7CgkJCWJyZWFrOwoJCX0KCX0KICBpZiAoIWNvbmZpZy5ibG9ja2luZyAmJiAhY29uZmlnLnF1ZXVlLmxlbmd0aCkgewogICAgZG9uZSgpOwogIH0KfQoKZnVuY3Rpb24gc2F2ZUdsb2JhbCgpIHsKCWNvbmZpZy5wb2xsdXRpb24gPSBbXTsKCQoJaWYgKCBjb25maWcubm9nbG9iYWxzICkgewoJCWZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgewoJCQljb25maWcucG9sbHV0aW9uLnB1c2goIGtleSApOwoJCX0KCX0KfQoKZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7Cgl2YXIgb2xkID0gY29uZmlnLnBvbGx1dGlvbjsKCXNhdmVHbG9iYWwoKTsKCQoJdmFyIG5ld0dsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsKCWlmICggbmV3R2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7CgkJY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQrKzsKCX0KCgl2YXIgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKCBjb25maWcucG9sbHV0aW9uLCBvbGQgKTsKCWlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsKCQljb25maWcuY3VycmVudC5leHBlY3RlZCsrOwoJfQp9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7Cgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrICkgewoJCWZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7CgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgewoJCQkJcmVzdWx0LnNwbGljZShpLCAxKTsKCQkJCWktLTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CglpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOwoJCWNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsKCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgoJfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsKCQlvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7Cgl9Cn0KCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7Cglmb3IgKCB2YXIgcHJvcCBpbiBiICkgewoJCWFbcHJvcF0gPSBiW3Byb3BdOwoJfQoKCXJldHVybiBhOwp9CgpmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7Cgl9IGVsc2UgewoJCWZuKCk7Cgl9Cn0KCmZ1bmN0aW9uIGlkKG5hbWUpIHsKCXJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJgoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7Cn0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwogICAgdmFyIHBhcmVudHMgPSBbXTsgLy8gc3RhY2sgdG8gYXZvaWRpbmcgbG9vcHMgZnJvbSBjaXJjdWxhciByZWZlcmVuY2luZwoKICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICBmdW5jdGlvbiBiaW5kQ2FsbGJhY2tzKG8sIGNhbGxiYWNrcywgYXJncykgewogICAgICAgIHZhciBwcm9wID0gUVVuaXQub2JqZWN0VHlwZShvKTsKICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBpZiAoUVVuaXQub2JqZWN0VHlwZShjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsCiAgICAgICAgZnVuY3Rpb24gdXNlU3RyaWN0RXF1YWxpdHkoYiwgYSkgewogICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgIC8vIHRvIGNhdGNoIHNob3J0IGFubm90YWlvbiBWUyAnbmV3JyBhbm5vdGF0aW9uIG9mIGEgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgIC8vIGUuZy4gdmFyIGkgPSAxOwogICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PSBiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJzdHJpbmciOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVsbCI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksCgogICAgICAgICAgICAibmFuIjogZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gInJlZ2V4cCIgJiYKICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZgogICAgICAgICAgICAgICAgICAgIGEuZ2xvYmFsID09PSBiLmdsb2JhbCAmJiAvLyBhbmQgaXRzIG1vZGlmZXJzIChnbWkpIC4uLgogICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmCiAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApCiAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5CiAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGksIGosIGxvb3A7CiAgICAgICAgICAgICAgICB2YXIgbGVuOwoKICAgICAgICAgICAgICAgIC8vIGIgY291bGQgYmUgYW4gb2JqZWN0IGxpdGVyYWwgaGVyZQogICAgICAgICAgICAgICAgaWYgKCAhIChRVW5pdC5vYmplY3RUeXBlKGIpID09PSAiYXJyYXkiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0gICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvL2RvbnQgcmV3YWxrIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgIm9iamVjdCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsKICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0CiAgICAgICAgICAgICAgICB2YXIgYVByb3BlcnRpZXMgPSBbXSwgYlByb3BlcnRpZXMgPSBbXTsgLy8gY29sbGVjdGlvbiBvZiBzdHJpbmdzCgogICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YKICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBjYWxsZXJzLnB1c2goYS5jb25zdHJ1Y3Rvcik7CiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOyAvL2Rvbid0IGdvIGRvd24gdGhlIHNhbWUgcGF0aCB0d2ljZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0oKTsKCiAgICBpbm5lckVxdWl2ID0gZnVuY3Rpb24gKCkgeyAvLyBjYW4gdGFrZSBtdWx0aXBsZSBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGVuZCB0cmFuc2l0aW9uCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IFFVbml0Lm9iamVjdFR5cGUoYSkgIT09IFFVbml0Lm9iamVjdFR5cGUoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7CgovKioKICoganNEdW1wCiAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQogKiBMaWNlbnNlZCB1bmRlciBCU0QgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvYnNkLWxpY2Vuc2UucGhwKQogKiBEYXRlOiA1LzE1LzIwMDgKICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuCiAqIEB2ZXJzaW9uIDEuMC4wCiAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcgogKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9CiAqLwpRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7CglmdW5jdGlvbiBxdW90ZSggc3RyICkgewoJCXJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKCX07CglmdW5jdGlvbiBsaXRlcmFsKCBvICkgewoJCXJldHVybiBvICsgJyc7CQoJfTsKCWZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgewoJCXZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAoJCQliYXNlID0ganNEdW1wLmluZGVudCgpLAoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CgkJaWYgKCBhcnIuam9pbiApCgkJCWFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsKCQlpZiAoICFhcnIgKQoJCQlyZXR1cm4gcHJlICsgcG9zdDsKCQlyZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7Cgl9OwoJZnVuY3Rpb24gYXJyYXkoIGFyciApIHsKCQl2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwkJCQkJCgkJdGhpcy51cCgpOwoJCXdoaWxlICggaS0tICkKCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CQkJCQoJCXRoaXMuZG93bigpOwoJCXJldHVybiBqb2luKCAnWycsIHJldCwgJ10nICk7Cgl9OwoJCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgkKCXZhciBqc0R1bXAgPSB7CgkJcGFyc2U6ZnVuY3Rpb24oIG9iaiwgdHlwZSApIHsgLy90eXBlIGlzIHVzZWQgbW9zdGx5IGludGVybmFsbHksIHlvdSBjYW4gZml4IGEgKGN1c3RvbSl0eXBlIGluIGFkdmFuY2UKCQkJdmFyCXBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07CgkJCXR5cGUgPSB0eXBlb2YgcGFyc2VyOwkJCQoJCQkKCQkJcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6CgkJCQkgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoKCQkJCSAgIHRoaXMucGFyc2Vycy5lcnJvcjsKCQl9LAoJCXR5cGVPZjpmdW5jdGlvbiggb2JqICkgewoJCQl2YXIgdHlwZTsKCQkJaWYgKCBvYmogPT09IG51bGwgKSB7CgkJCQl0eXBlID0gIm51bGwiOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CgkJCQl0eXBlID0gInVuZGVmaW5lZCI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG9iaikpIHsKCQkJCXR5cGUgPSAicmVnZXhwIjsKCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG9iaikpIHsKCQkJCXR5cGUgPSAiZGF0ZSI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIkZ1bmN0aW9uIiwgb2JqKSkgewoJCQkJdHlwZSA9ICJmdW5jdGlvbiI7CgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iai5zZXRJbnRlcnZhbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvYmouZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQl0eXBlID0gIndpbmRvdyI7CgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlID09PSA5KSB7CgkJCQl0eXBlID0gImRvY3VtZW50IjsKCQkJfSBlbHNlIGlmIChvYmoubm9kZVR5cGUpIHsKCQkJCXR5cGUgPSAibm9kZSI7CgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIG9iai5sZW5ndGggPj0gMCkgewoJCQkJdHlwZSA9ICJhcnJheSI7CgkJCX0gZWxzZSB7CgkJCQl0eXBlID0gdHlwZW9mIG9iajsKCQkJfQoJCQlyZXR1cm4gdHlwZTsKCQl9LAoJCXNlcGFyYXRvcjpmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMubXVsdGlsaW5lID8JdGhpcy5IVE1MID8gJzxiciAvPicgOiAnXG4nIDogdGhpcy5IVE1MID8gJyZuYnNwOycgOiAnICc7CgkJfSwKCQlpbmRlbnQ6ZnVuY3Rpb24oIGV4dHJhICkgey8vIGV4dHJhIGNhbiBiZSBhIG51bWJlciwgc2hvcnRjdXQgZm9yIGluY3JlYXNpbmctY2FsbGluZy1kZWNyZWFzaW5nCgkJCWlmICggIXRoaXMubXVsdGlsaW5lICkKCQkJCXJldHVybiAnJzsKCQkJdmFyIGNociA9IHRoaXMuaW5kZW50Q2hhcjsKCQkJaWYgKCB0aGlzLkhUTUwgKQoJCQkJY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csJyAgICcpLnJlcGxhY2UoLyAvZywnJm5ic3A7Jyk7CgkJCXJldHVybiBBcnJheSggdGhpcy5fZGVwdGhfICsgKGV4dHJhfHwwKSApLmpvaW4oY2hyKTsKCQl9LAoJCXVwOmZ1bmN0aW9uKCBhICkgewoJCQl0aGlzLl9kZXB0aF8gKz0gYSB8fCAxOwoJCX0sCgkJZG93bjpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfIC09IGEgfHwgMTsKCQl9LAoJCXNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgewoJCQl0aGlzLnBhcnNlcnNbbmFtZV0gPSBwYXJzZXI7CgkJfSwKCQkvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0KCQlxdW90ZTpxdW90ZSwgCgkJbGl0ZXJhbDpsaXRlcmFsLAoJCWpvaW46am9pbiwKCQkvLwoJCV9kZXB0aF86IDEsCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXIKCQlwYXJzZXJzOnsKCQkJd2luZG93OiAnW1dpbmRvd10nLAoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLAoJCQllcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KCQkJdW5rbm93bjogJ1tVbmtub3duXScsCgkJCSdudWxsJzonbnVsbCcsCgkJCSd1bmRlZmluZWQnOid1bmRlZmluZWQnLAoJCQknZnVuY3Rpb24nOmZ1bmN0aW9uKCBmbiApIHsKCQkJCXZhciByZXQgPSAnZnVuY3Rpb24nLAoJCQkJCW5hbWUgPSAnbmFtZScgaW4gZm4gPyBmbi5uYW1lIDogKHJlTmFtZS5leGVjKGZuKXx8W10pWzFdOy8vZnVuY3Rpb25zIG5ldmVyIGhhdmUgbmFtZSBpbiBJRQoJCQkJaWYgKCBuYW1lICkKCQkJCQlyZXQgKz0gJyAnICsgbmFtZTsKCQkJCXJldCArPSAnKCc7CgkJCQkKCQkJCXJldCA9IFsgcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsKCQkJCXJldHVybiBqb2luKCByZXQsIFFVbml0LmpzRHVtcC5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOwoJCQl9LAoJCQlhcnJheTogYXJyYXksCgkJCW5vZGVsaXN0OiBhcnJheSwKCQkJYXJndW1lbnRzOiBhcnJheSwKCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7CgkJCQl2YXIgcmV0ID0gWyBdOwoJCQkJUVVuaXQuanNEdW1wLnVwKCk7CgkJCQlmb3IgKCB2YXIga2V5IGluIG1hcCApCgkJCQkJcmV0LnB1c2goIFFVbml0LmpzRHVtcC5wYXJzZShrZXksJ2tleScpICsgJzogJyArIFFVbml0LmpzRHVtcC5wYXJzZShtYXBba2V5XSkgKTsKCQkJCVFVbml0LmpzRHVtcC5kb3duKCk7CgkJCQlyZXR1cm4gam9pbiggJ3snLCByZXQsICd9JyApOwoJCQl9LAoJCQlub2RlOmZ1bmN0aW9uKCBub2RlICkgewoJCQkJdmFyIG9wZW4gPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmbHQ7JyA6ICc8JywKCQkJCQljbG9zZSA9IFFVbml0LmpzRHVtcC5IVE1MID8gJyZndDsnIDogJz4nOwoJCQkJCQoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJCQlyZXQgPSBvcGVuICsgdGFnOwoJCQkJCQoJCQkJZm9yICggdmFyIGEgaW4gUVVuaXQuanNEdW1wLkRPTUF0dHJzICkgewoJCQkJCXZhciB2YWwgPSBub2RlW1FVbml0LmpzRHVtcC5ET01BdHRyc1thXV07CgkJCQkJaWYgKCB2YWwgKQoJCQkJCQlyZXQgKz0gJyAnICsgYSArICc9JyArIFFVbml0LmpzRHVtcC5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOwoJCQkJfQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOwoJCQl9LAoJCQlmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24oIGZuICkgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uCgkJCQl2YXIgbCA9IGZuLmxlbmd0aDsKCQkJCWlmICggIWwgKSByZXR1cm4gJyc7CQkJCQoJCQkJCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOwoJCQkJd2hpbGUgKCBsLS0gKQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwoJCQl9LAoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCgkJCXN0cmluZzpxdW90ZSwKCQkJZGF0ZTpxdW90ZSwKCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKCQkJbnVtYmVyOmxpdGVyYWwsCgkJCSdib29sZWFuJzpsaXRlcmFsCgkJfSwKCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKCQkJaWQ6J2lkJywKCQkJbmFtZTonbmFtZScsCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScKCQl9LAoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQoJCWluZGVudENoYXI6JyAgJywvL2luZGVudGF0aW9uIHVuaXQKCQltdWx0aWxpbmU6dHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KCX07CgoJcmV0dXJuIGpzRHVtcDsKfSkoKTsKCi8vIGZyb20gU2l6emxlLmpzCmZ1bmN0aW9uIGdldFRleHQoIGVsZW1zICkgewoJdmFyIHJldCA9ICIiLCBlbGVtOwoKCWZvciAoIHZhciBpID0gMDsgZWxlbXNbaV07IGkrKyApIHsKCQllbGVtID0gZWxlbXNbaV07CgoJCS8vIEdldCB0aGUgdGV4dCBmcm9tIHRleHQgbm9kZXMgYW5kIENEQVRBIG5vZGVzCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDQgKSB7CgkJCXJldCArPSBlbGVtLm5vZGVWYWx1ZTsKCgkJLy8gVHJhdmVyc2UgZXZlcnl0aGluZyBlbHNlLCBleGNlcHQgY29tbWVudCBub2RlcwoJCX0gZWxzZSBpZiAoIGVsZW0ubm9kZVR5cGUgIT09IDggKSB7CgkJCXJldCArPSBnZXRUZXh0KCBlbGVtLmNoaWxkTm9kZXMgKTsKCQl9Cgl9CgoJcmV0dXJuIHJldDsKfTsKCi8qCiAqIEphdmFzY3JpcHQgRGlmZiBBbGdvcml0aG0KICogIEJ5IEpvaG4gUmVzaWcgKGh0dHA6Ly9lam9obi5vcmcvKQogKiAgTW9kaWZpZWQgYnkgQ2h1IEFsYW4gInNwcml0ZSIKICoKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKgogKiBNb3JlIEluZm86CiAqICBodHRwOi8vZWpvaG4ub3JnL3Byb2plY3RzL2phdmFzY3JpcHQtZGlmZi1hbGdvcml0aG0vCiAqICAKICogVXNhZ2U6IFFVbml0LmRpZmYoZXhwZWN0ZWQsIGFjdHVhbCkKICogCiAqIFFVbml0LmRpZmYoInRoZSBxdWljayBicm93biBmb3gganVtcGVkIG92ZXIiLCAidGhlIHF1aWNrIGZveCBqdW1wcyBvdmVyIikgPT0gInRoZSAgcXVpY2sgPGRlbD5icm93biA8L2RlbD4gZm94IDxkZWw+anVtcGVkIDwvZGVsPjxpbnM+anVtcHMgPC9pbnM+IG92ZXIiCiAqLwpRVW5pdC5kaWZmID0gKGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24gZGlmZihvLCBuKXsKCQl2YXIgbnMgPSBuZXcgT2JqZWN0KCk7CgkJdmFyIG9zID0gbmV3IE9iamVjdCgpOwoJCQoJCWZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgewoJCQlpZiAobnNbbltpXV0gPT0gbnVsbCkgCgkJCQluc1tuW2ldXSA9IHsKCQkJCQlyb3dzOiBuZXcgQXJyYXkoKSwKCQkJCQlvOiBudWxsCgkJCQl9OwoJCQluc1tuW2ldXS5yb3dzLnB1c2goaSk7CgkJfQoJCQoJCWZvciAodmFyIGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgewoJCQlpZiAob3Nbb1tpXV0gPT0gbnVsbCkgCgkJCQlvc1tvW2ldXSA9IHsKCQkJCQlyb3dzOiBuZXcgQXJyYXkoKSwKCQkJCQluOiBudWxsCgkJCQl9OwoJCQlvc1tvW2ldXS5yb3dzLnB1c2goaSk7CgkJfQoJCQoJCWZvciAodmFyIGkgaW4gbnMpIHsKCQkJaWYgKG5zW2ldLnJvd3MubGVuZ3RoID09IDEgJiYgdHlwZW9mKG9zW2ldKSAhPSAidW5kZWZpbmVkIiAmJiBvc1tpXS5yb3dzLmxlbmd0aCA9PSAxKSB7CgkJCQluW25zW2ldLnJvd3NbMF1dID0gewoJCQkJCXRleHQ6IG5bbnNbaV0ucm93c1swXV0sCgkJCQkJcm93OiBvc1tpXS5yb3dzWzBdCgkJCQl9OwoJCQkJb1tvc1tpXS5yb3dzWzBdXSA9IHsKCQkJCQl0ZXh0OiBvW29zW2ldLnJvd3NbMF1dLAoJCQkJCXJvdzogbnNbaV0ucm93c1swXQoJCQkJfTsKCQkJfQoJCX0KCQkKCQlmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoIC0gMTsgaSsrKSB7CgkJCWlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgKyAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgKyAxIDwgby5sZW5ndGggJiYgb1tuW2ldLnJvdyArIDFdLnRleHQgPT0gbnVsbCAmJgoJCQluW2kgKyAxXSA9PSBvW25baV0ucm93ICsgMV0pIHsKCQkJCW5baSArIDFdID0gewoJCQkJCXRleHQ6IG5baSArIDFdLAoJCQkJCXJvdzogbltpXS5yb3cgKyAxCgkJCQl9OwoJCQkJb1tuW2ldLnJvdyArIDFdID0gewoJCQkJCXRleHQ6IG9bbltpXS5yb3cgKyAxXSwKCQkJCQlyb3c6IGkgKyAxCgkJCQl9OwoJCQl9CgkJfQoJCQoJCWZvciAodmFyIGkgPSBuLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKCQkJaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSAtIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyA+IDAgJiYgb1tuW2ldLnJvdyAtIDFdLnRleHQgPT0gbnVsbCAmJgoJCQluW2kgLSAxXSA9PSBvW25baV0ucm93IC0gMV0pIHsKCQkJCW5baSAtIDFdID0gewoJCQkJCXRleHQ6IG5baSAtIDFdLAoJCQkJCXJvdzogbltpXS5yb3cgLSAxCgkJCQl9OwoJCQkJb1tuW2ldLnJvdyAtIDFdID0gewoJCQkJCXRleHQ6IG9bbltpXS5yb3cgLSAxXSwKCQkJCQlyb3c6IGkgLSAxCgkJCQl9OwoJCQl9CgkJfQoJCQoJCXJldHVybiB7CgkJCW86IG8sCgkJCW46IG4KCQl9OwoJfQoJCglyZXR1cm4gZnVuY3Rpb24obywgbil7CgkJbyA9IG8ucmVwbGFjZSgvXHMrJC8sICcnKTsKCQluID0gbi5yZXBsYWNlKC9ccyskLywgJycpOwoJCXZhciBvdXQgPSBkaWZmKG8gPT0gIiIgPyBbXSA6IG8uc3BsaXQoL1xzKy8pLCBuID09ICIiID8gW10gOiBuLnNwbGl0KC9ccysvKSk7CgoJCXZhciBzdHIgPSAiIjsKCQkKCQl2YXIgb1NwYWNlID0gby5tYXRjaCgvXHMrL2cpOwoJCWlmIChvU3BhY2UgPT0gbnVsbCkgewoJCQlvU3BhY2UgPSBbIiAiXTsKCQl9CgkJZWxzZSB7CgkJCW9TcGFjZS5wdXNoKCIgIik7CgkJfQoJCXZhciBuU3BhY2UgPSBuLm1hdGNoKC9ccysvZyk7CgkJaWYgKG5TcGFjZSA9PSBudWxsKSB7CgkJCW5TcGFjZSA9IFsiICJdOwoJCX0KCQllbHNlIHsKCQkJblNwYWNlLnB1c2goIiAiKTsKCQl9CgkJCgkJaWYgKG91dC5uLmxlbmd0aCA9PSAwKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3V0Lm8ubGVuZ3RoOyBpKyspIHsKCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9baV0gKyBvU3BhY2VbaV0gKyAiPC9kZWw+IjsKCQkJfQoJCX0KCQllbHNlIHsKCQkJaWYgKG91dC5uWzBdLnRleHQgPT0gbnVsbCkgewoJCQkJZm9yIChuID0gMDsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKykgewoJCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsKCQkJCX0KCQkJfQoJCQkKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQubi5sZW5ndGg7IGkrKykgewoJCQkJaWYgKG91dC5uW2ldLnRleHQgPT0gbnVsbCkgewoJCQkJCXN0ciArPSAnPGlucz4nICsgb3V0Lm5baV0gKyBuU3BhY2VbaV0gKyAiPC9pbnM+IjsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXZhciBwcmUgPSAiIjsKCQkJCQkKCQkJCQlmb3IgKG4gPSBvdXQubltpXS5yb3cgKyAxOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7CgkJCQkJCXByZSArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsKCQkJCQl9CgkJCQkJc3RyICs9ICIgIiArIG91dC5uW2ldLnRleHQgKyBuU3BhY2VbaV0gKyBwcmU7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIHN0cjsKCX07Cn0pKCk7Cgp9KSh0aGlzKTsK",
                "body": "LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKiAKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTEgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCAoTUlULUxJQ0VOU0UudHh0KQogKiBvciBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIGRlZmluZWQgPSB7CglzZXRUaW1lb3V0OiB0eXBlb2Ygd2luZG93LnNldFRpbWVvdXQgIT09ICJ1bmRlZmluZWQiLAoJc2Vzc2lvblN0b3JhZ2U6IChmdW5jdGlvbigpIHsKCQl0cnkgewoJCQlyZXR1cm4gISFzZXNzaW9uU3RvcmFnZS5nZXRJdGVtOwoJCX0gY2F0Y2goZSl7CgkJCXJldHVybiBmYWxzZTsKCQl9CiAgfSkoKQp9OwoKdmFyIHRlc3RJZCA9IDA7Cgp2YXIgVGVzdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3ROYW1lLCBleHBlY3RlZCwgdGVzdEVudmlyb25tZW50QXJnLCBhc3luYywgY2FsbGJhY2spIHsKCXRoaXMubmFtZSA9IG5hbWU7Cgl0aGlzLnRlc3ROYW1lID0gdGVzdE5hbWU7Cgl0aGlzLmV4cGVjdGVkID0gZXhwZWN0ZWQ7Cgl0aGlzLnRlc3RFbnZpcm9ubWVudEFyZyA9IHRlc3RFbnZpcm9ubWVudEFyZzsKCXRoaXMuYXN5bmMgPSBhc3luYzsKCXRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKCXRoaXMuYXNzZXJ0aW9ucyA9IFtdOwp9OwpUZXN0LnByb3RvdHlwZSA9IHsKCWluaXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoJCWlmICh0ZXN0cykgewoJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwoJCQkJYi5pbm5lckhUTUwgPSAiUnVubmluZyAiICsgdGhpcy5uYW1lOwoJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsKCQkJCWxpLmNsYXNzTmFtZSA9ICJydW5uaW5nIjsKCQkJCWxpLmlkID0gdGhpcy5pZCA9ICJ0ZXN0LW91dHB1dCIgKyB0ZXN0SWQrKzsKCQkJdGVzdHMuYXBwZW5kQ2hpbGQoIGxpICk7CgkJfQoJfSwKCXNldHVwOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5tb2R1bGUgIT0gY29uZmlnLnByZXZpb3VzTW9kdWxlKSB7CgkJCWlmICggY29uZmlnLnByZXZpb3VzTW9kdWxlICkgewoJCQkJUVVuaXQubW9kdWxlRG9uZSggewoJCQkJCW5hbWU6IGNvbmZpZy5wcmV2aW91c01vZHVsZSwKCQkJCQlmYWlsZWQ6IGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsCgkJCQkJcGFzc2VkOiBjb25maWcubW9kdWxlU3RhdHMuYWxsIC0gY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKCQkJCQl0b3RhbDogY29uZmlnLm1vZHVsZVN0YXRzLmFsbAoJCQkJfSApOwoJCQl9CgkJCWNvbmZpZy5wcmV2aW91c01vZHVsZSA9IHRoaXMubW9kdWxlOwoJCQljb25maWcubW9kdWxlU3RhdHMgPSB7IGFsbDogMCwgYmFkOiAwIH07CgkJCVFVbml0Lm1vZHVsZVN0YXJ0KCB7CgkJCQluYW1lOiB0aGlzLm1vZHVsZQoJCQl9ICk7CgkJfQoKCQljb25maWcuY3VycmVudCA9IHRoaXM7CgkJdGhpcy50ZXN0RW52aXJvbm1lbnQgPSBleHRlbmQoewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkge30KCQl9LCB0aGlzLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7CgkJaWYgKHRoaXMudGVzdEVudmlyb25tZW50QXJnKSB7CgkJCWV4dGVuZCh0aGlzLnRlc3RFbnZpcm9ubWVudCwgdGhpcy50ZXN0RW52aXJvbm1lbnRBcmcpOwoJCX0KCgkJUVVuaXQudGVzdFN0YXJ0KCB7CgkJCW5hbWU6IHRoaXMudGVzdE5hbWUKCQl9ICk7CgoJCS8vIGFsbG93IHV0aWxpdHkgZnVuY3Rpb25zIHRvIGFjY2VzcyB0aGUgY3VycmVudCB0ZXN0IGVudmlyb25tZW50CgkJLy8gVE9ETyB3aHk/PwoJCVFVbml0LmN1cnJlbnRfdGVzdEVudmlyb25tZW50ID0gdGhpcy50ZXN0RW52aXJvbm1lbnQ7CgkJCgkJdHJ5IHsKCQkJaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKCQkJCXNhdmVHbG9iYWwoKTsKCQkJfQoKCQkJdGhpcy50ZXN0RW52aXJvbm1lbnQuc2V0dXAuY2FsbCh0aGlzLnRlc3RFbnZpcm9ubWVudCk7CgkJfSBjYXRjaChlKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgdGhpcy50ZXN0TmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQl9Cgl9LAoJcnVuOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuYXN5bmMgKSB7CgkJCVFVbml0LnN0b3AoKTsKCQl9CgoJCWlmICggY29uZmlnLm5vdHJ5Y2F0Y2ggKSB7CgkJCXRoaXMuY2FsbGJhY2suY2FsbCh0aGlzLnRlc3RFbnZpcm9ubWVudCk7CgkJCXJldHVybjsKCQl9CgkJdHJ5IHsKCQkJdGhpcy5jYWxsYmFjay5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJZmFpbCgiVGVzdCAiICsgdGhpcy50ZXN0TmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCB0aGlzLmNhbGxiYWNrKTsKCQkJUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKyAxKSArICI6ICIgKyBlLm1lc3NhZ2UgKyAiIC0gIiArIFFVbml0LmpzRHVtcC5wYXJzZShlKSApOwoJCQkvLyBlbHNlIG5leHQgdGVzdCB3aWxsIGNhcnJ5IHRoZSByZXNwb25zaWJpbGl0eQoJCQlzYXZlR2xvYmFsKCk7CgoJCQkvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nCgkJCWlmICggY29uZmlnLmJsb2NraW5nICkgewoJCQkJc3RhcnQoKTsKCQkJfQoJCX0KCX0sCgl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJY2hlY2tQb2xsdXRpb24oKTsKCQkJdGhpcy50ZXN0RW52aXJvbm1lbnQudGVhcmRvd24uY2FsbCh0aGlzLnRlc3RFbnZpcm9ubWVudCk7CgkJfSBjYXRjaChlKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgdGhpcy50ZXN0TmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQl9Cgl9LAoJZmluaXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZXhwZWN0ZWQgJiYgdGhpcy5leHBlY3RlZCAhPSB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICkgewoJCQlRVW5pdC5vayggZmFsc2UsICJFeHBlY3RlZCAiICsgdGhpcy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKCQl9CgkJCgkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwLAoJCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoKCQljb25maWcuc3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7CgkJY29uZmlnLm1vZHVsZVN0YXRzLmFsbCArPSB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOwoKCQlpZiAoIHRlc3RzICkgewoJCQl2YXIgb2wgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsKCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCXZhciBhc3NlcnRpb24gPSB0aGlzLmFzc2VydGlvbnNbaV07CgoJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQkJCWxpLmNsYXNzTmFtZSA9IGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCI7CgkJCQlsaS5pbm5lckhUTUwgPSBhc3NlcnRpb24ubWVzc2FnZSB8fCAoYXNzZXJ0aW9uLnJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKCQkJCW9sLmFwcGVuZENoaWxkKCBsaSApOwoKCQkJCWlmICggYXNzZXJ0aW9uLnJlc3VsdCApIHsKCQkJCQlnb29kKys7CgkJCQl9IGVsc2UgewoJCQkJCWJhZCsrOwoJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsKCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7CgkJCQl9CgkJCX0KCgkJCS8vIHN0b3JlIHJlc3VsdCB3aGVuIHBvc3NpYmxlCgkJCVFVbml0LmNvbmZpZy5yZW9yZGVyICYmIGRlZmluZWQuc2Vzc2lvblN0b3JhZ2UgJiYgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgicXVuaXQtIiArIHRoaXMudGVzdE5hbWUsIGJhZCk7CgoJCQlpZiAoYmFkID09IDApIHsKCQkJCW9sLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJCX0KCgkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJCWIuaW5uZXJIVE1MID0gdGhpcy5uYW1lICsgIiA8YiBjbGFzcz0nY291bnRzJz4oPGIgY2xhc3M9J2ZhaWxlZCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzc2VkJz4iICsgZ29vZCArICI8L2I+LCAiICsgdGhpcy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiI7CgkJCQoJCQlhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCXZhciBuZXh0ID0gYi5uZXh0U2libGluZywgZGlzcGxheSA9IG5leHQuc3R5bGUuZGlzcGxheTsKCQkJCW5leHQuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXkgPT09ICJub25lIiA/ICJibG9jayIgOiAibm9uZSI7CgkJCX0pOwoJCQkKCQkJYWRkRXZlbnQoYiwgImRibGNsaWNrIiwgZnVuY3Rpb24oZSkgewoJCQkJdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50OwoJCQkJaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAic3BhbiIgfHwgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImIiICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQkJaWYgKCB3aW5kb3cubG9jYXRpb24gJiYgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgewoJCQkJCXdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPSAiPyIgKyBlbmNvZGVVUklDb21wb25lbnQoZ2V0VGV4dChbdGFyZ2V0XSkucmVwbGFjZSgvXCguK1wpJC8sICIiKS5yZXBsYWNlKC8oXlxzKnxccyokKS9nLCAiIikpOwoJCQkJfQoJCQl9KTsKCgkJCXZhciBsaSA9IGlkKHRoaXMuaWQpOwoJCQlsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7CgkJCWxpLnJlbW92ZUNoaWxkKCBsaS5maXJzdENoaWxkICk7CgkJCWxpLmFwcGVuZENoaWxkKCBiICk7CgkJCWxpLmFwcGVuZENoaWxkKCBvbCApOwoKCQl9IGVsc2UgewoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoICF0aGlzLmFzc2VydGlvbnNbaV0ucmVzdWx0ICkgewoJCQkJCWJhZCsrOwoJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsKCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7CgkJCQl9CgkJCX0KCQl9CgoJCXRyeSB7CgkJCVFVbml0LnJlc2V0KCk7CgkJfSBjYXRjaChlKSB7CgkJCWZhaWwoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgdGhpcy50ZXN0TmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIFFVbml0LnJlc2V0KTsKCQl9CgoJCVFVbml0LnRlc3REb25lKCB7CgkJCW5hbWU6IHRoaXMudGVzdE5hbWUsCgkJCWZhaWxlZDogYmFkLAoJCQlwYXNzZWQ6IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggLSBiYWQsCgkJCXRvdGFsOiB0aGlzLmFzc2VydGlvbnMubGVuZ3RoCgkJfSApOwoJfSwKCQoJcXVldWU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ZXN0ID0gdGhpczsKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJdGVzdC5pbml0KCk7CgkJfSk7CgkJZnVuY3Rpb24gcnVuKCkgewoJCQkvLyBlYWNoIG9mIHRoZXNlIGNhbiBieSBhc3luYwoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJCXRlc3Quc2V0dXAoKTsKCQkJfSk7CgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC5ydW4oKTsKCQkJfSk7CgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC50ZWFyZG93bigpOwoJCQl9KTsKCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCQl0ZXN0LmZpbmlzaCgpOwoJCQl9KTsKCQl9CgkJLy8gZGVmZXIgd2hlbiBwcmV2aW91cyB0ZXN0IHJ1biBwYXNzZWQsIGlmIHN0b3JhZ2UgaXMgYXZhaWxhYmxlCgkJdmFyIGJhZCA9IFFVbml0LmNvbmZpZy5yZW9yZGVyICYmIGRlZmluZWQuc2Vzc2lvblN0b3JhZ2UgJiYgK3Nlc3Npb25TdG9yYWdlLmdldEl0ZW0oInF1bml0LSIgKyB0aGlzLnRlc3ROYW1lKTsKCQlpZiAoYmFkKSB7CgkJCXJ1bigpOwoJCX0gZWxzZSB7CgkJCXN5bmNocm9uaXplKHJ1bik7CgkJfTsKCX0KCQp9OwoKdmFyIFFVbml0ID0gewoKCS8vIGNhbGwgb24gc3RhcnQgb2YgbW9kdWxlIHRlc3QgdG8gcHJlcGVuZCBuYW1lIHRvIGFsbCB0ZXN0cwoJbW9kdWxlOiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHsKCQljb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CgkJY29uZmlnLmN1cnJlbnRNb2R1bGVUZXN0RW52aXJvbWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCX0sCgoJYXN5bmNUZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IDA7CgkJfQoKCQlRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOwoJfSwKCQoJdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsKCQl2YXIgbmFtZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1uYW1lIj4nICsgdGVzdE5hbWUgKyAnPC9zcGFuPicsIHRlc3RFbnZpcm9ubWVudEFyZzsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoJCS8vIGlzIDJuZCBhcmd1bWVudCBhIHRlc3RFbnZpcm9ubWVudD8KCQlpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsKCQkJdGVzdEVudmlyb25tZW50QXJnID0gIGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoKCQlpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCQluYW1lID0gJzxzcGFuIGNsYXNzPSJtb2R1bGUtbmFtZSI+JyArIGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjwvc3Bhbj46ICIgKyBuYW1lOwoJCX0KCgkJaWYgKCAhdmFsaWRUZXN0KGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjogIiArIHRlc3ROYW1lKSApIHsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgdGVzdCA9IG5ldyBUZXN0KG5hbWUsIHRlc3ROYW1lLCBleHBlY3RlZCwgdGVzdEVudmlyb25tZW50QXJnLCBhc3luYywgY2FsbGJhY2spOwoJCXRlc3QubW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7CgkJdGVzdC5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSBjb25maWcuY3VycmVudE1vZHVsZVRlc3RFbnZpcm9tZW50OwoJCXRlc3QucXVldWUoKTsKCX0sCgkKCS8qKgoJICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgoJICovCglleHBlY3Q6IGZ1bmN0aW9uKGFzc2VydHMpIHsKCQljb25maWcuY3VycmVudC5leHBlY3RlZCA9IGFzc2VydHM7Cgl9LAoKCS8qKgoJICogQXNzZXJ0cyB0cnVlLgoJICogQGV4YW1wbGUgb2soICJhc2RmYXNkZiIubGVuZ3RoID4gNSwgIlRoZXJlIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFycyIgKTsKCSAqLwoJb2s6IGZ1bmN0aW9uKGEsIG1zZykgewoJCWEgPSAhIWE7CgkJdmFyIGRldGFpbHMgPSB7CgkJCXJlc3VsdDogYSwKCQkJbWVzc2FnZTogbXNnCgkJfTsKCQltc2cgPSBlc2NhcGVIdG1sKG1zZyk7CgkJUVVuaXQubG9nKGRldGFpbHMpOwoJCWNvbmZpZy5jdXJyZW50LmFzc2VydGlvbnMucHVzaCh7CgkJCXJlc3VsdDogYSwKCQkJbWVzc2FnZTogbXNnCgkJfSk7Cgl9LAoKCS8qKgoJICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuCgkgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCgkgKgoJICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApCgkgKgoJICogQGV4YW1wbGUgZXF1YWwoIGZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CgkgKgoJICogQHBhcmFtIE9iamVjdCBhY3R1YWwKCSAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKCSAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpCgkgKi8KCWVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goZXhwZWN0ZWQgIT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgkKCWRlZXBFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3REZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKCFRVW5pdC5lcXVpdihhY3R1YWwsIGV4cGVjdGVkKSwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCXN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkICE9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglyYWlzZXM6IGZ1bmN0aW9uKGJsb2NrLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCXZhciBhY3R1YWwsIG9rID0gZmFsc2U7CgkKCQlpZiAodHlwZW9mIGV4cGVjdGVkID09PSAnc3RyaW5nJykgewoJCQltZXNzYWdlID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgkKCQl0cnkgewoJCQlibG9jaygpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJYWN0dWFsID0gZTsKCQl9CgkKCQlpZiAoYWN0dWFsKSB7CgkJCS8vIHdlIGRvbid0IHdhbnQgdG8gdmFsaWRhdGUgdGhyb3duIGVycm9yCgkJCWlmICghZXhwZWN0ZWQpIHsKCQkJCW9rID0gdHJ1ZTsKCQkJLy8gZXhwZWN0ZWQgaXMgYSByZWdleHAJCgkJCX0gZWxzZSBpZiAoUVVuaXQub2JqZWN0VHlwZShleHBlY3RlZCkgPT09ICJyZWdleHAiKSB7CgkJCQlvayA9IGV4cGVjdGVkLnRlc3QoYWN0dWFsKTsKCQkJLy8gZXhwZWN0ZWQgaXMgYSBjb25zdHJ1Y3RvcgkKCQkJfSBlbHNlIGlmIChhY3R1YWwgaW5zdGFuY2VvZiBleHBlY3RlZCkgewoJCQkJb2sgPSB0cnVlOwoJCQkvLyBleHBlY3RlZCBpcyBhIHZhbGlkYXRpb24gZnVuY3Rpb24gd2hpY2ggcmV0dXJucyB0cnVlIGlzIHZhbGlkYXRpb24gcGFzc2VkCQoJCQl9IGVsc2UgaWYgKGV4cGVjdGVkLmNhbGwoe30sIGFjdHVhbCkgPT09IHRydWUpIHsKCQkJCW9rID0gdHJ1ZTsKCQkJfQoJCX0KCQkJCgkJUVVuaXQub2sob2ssIG1lc3NhZ2UpOwoJfSwKCglzdGFydDogZnVuY3Rpb24oKSB7CgkJY29uZmlnLnNlbWFwaG9yZS0tOwoJCWlmIChjb25maWcuc2VtYXBob3JlID4gMCkgewoJCQkvLyBkb24ndCBzdGFydCB1bnRpbCBlcXVhbCBudW1iZXIgb2Ygc3RvcC1jYWxscwoJCQlyZXR1cm47CgkJfQoJCWlmIChjb25maWcuc2VtYXBob3JlIDwgMCkgewoJCQkvLyBpZ25vcmUgaWYgc3RhcnQgaXMgY2FsbGVkIG1vcmUgb2Z0ZW4gdGhlbiBzdG9wCgkJCWNvbmZpZy5zZW1hcGhvcmUgPSAwOwoJCX0KCQkvLyBBIHNsaWdodCBkZWxheSwgdG8gYXZvaWQgYW55IGN1cnJlbnQgY2FsbGJhY2tzCgkJaWYgKCBkZWZpbmVkLnNldFRpbWVvdXQgKSB7CgkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjb25maWcudGltZW91dCApIHsKCQkJCQljbGVhclRpbWVvdXQoY29uZmlnLnRpbWVvdXQpOwoJCQkJfQoKCQkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCQkJcHJvY2VzcygpOwoJCQl9LCAxMyk7CgkJfSBlbHNlIHsKCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgkJCXByb2Nlc3MoKTsKCQl9Cgl9LAoJCglzdG9wOiBmdW5jdGlvbih0aW1lb3V0KSB7CgkJY29uZmlnLnNlbWFwaG9yZSsrOwoJCWNvbmZpZy5ibG9ja2luZyA9IHRydWU7CgoJCWlmICggdGltZW91dCAmJiBkZWZpbmVkLnNldFRpbWVvdXQgKSB7CgkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CgkJCWNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJUZXN0IHRpbWVkIG91dCIgKTsKCQkJCVFVbml0LnN0YXJ0KCk7CgkJCX0sIHRpbWVvdXQpOwoJCX0KCX0KCn07CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgZGVwcmVjYXRlZApRVW5pdC5lcXVhbHMgPSBRVW5pdC5lcXVhbDsKUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsKCi8vIE1haW50YWluIGludGVybmFsIHN0YXRlCnZhciBjb25maWcgPSB7CgkvLyBUaGUgcXVldWUgb2YgdGVzdHMgdG8gcnVuCglxdWV1ZTogW10sCgoJLy8gYmxvY2sgdW50aWwgZG9jdW1lbnQgcmVhZHkKCWJsb2NraW5nOiB0cnVlLAoJCgkvLyBieSBkZWZhdWx0LCBydW4gcHJldmlvdXNseSBmYWlsZWQgdGVzdHMgZmlyc3QKCS8vIHZlcnkgdXNlZnVsIGluIGNvbWJpbmF0aW9uIHdpdGggIkhpZGUgcGFzc2VkIHRlc3RzIiBjaGVja2VkCglyZW9yZGVyOiB0cnVlCn07CgovLyBMb2FkIHBhcmFtYXRlcnMKKGZ1bmN0aW9uKCkgewoJdmFyIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uIHx8IHsgc2VhcmNoOiAiIiwgcHJvdG9jb2w6ICJmaWxlOiIgfSwKCQlHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsKCglmb3IgKCB2YXIgaSA9IDA7IGkgPCBHRVRQYXJhbXMubGVuZ3RoOyBpKysgKSB7CgkJR0VUUGFyYW1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KCBHRVRQYXJhbXNbaV0gKTsKCQlpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vZ2xvYmFscyIgKSB7CgkJCUdFVFBhcmFtcy5zcGxpY2UoIGksIDEgKTsKCQkJaS0tOwoJCQljb25maWcubm9nbG9iYWxzID0gdHJ1ZTsKCQl9IGVsc2UgaWYgKCBHRVRQYXJhbXNbaV0gPT09ICJub3RyeWNhdGNoIiApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJCWNvbmZpZy5ub3RyeWNhdGNoID0gdHJ1ZTsKCQl9IGVsc2UgaWYgKCBHRVRQYXJhbXNbaV0uc2VhcmNoKCc9JykgPiAtMSApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJfQoJfQoJCgkvLyByZXN0cmljdCBtb2R1bGVzL3Rlc3RzIGJ5IGdldCBwYXJhbWV0ZXJzCgljb25maWcuZmlsdGVycyA9IEdFVFBhcmFtczsKCQoJLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdAoJUVVuaXQuaXNMb2NhbCA9ICEhKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKTsKfSkoKTsKCi8vIEV4cG9zZSB0aGUgQVBJIGFzIGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycKLy8gb2JqZWN0IGV4aXN0cywgaW4gdGhhdCBjYXNlIHdlIGFzc3VtZSB3ZSdyZSBpbiBDb21tb25KUwppZiAoIHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gInVuZGVmaW5lZCIgKSB7CglleHRlbmQod2luZG93LCBRVW5pdCk7Cgl3aW5kb3cuUVVuaXQgPSBRVW5pdDsKfSBlbHNlIHsKCWV4dGVuZChleHBvcnRzLCBRVW5pdCk7CglleHBvcnRzLlFVbml0ID0gUVVuaXQ7Cn0KCi8vIGRlZmluZSB0aGVzZSBhZnRlciBleHBvc2luZyBnbG9iYWxzIHRvIGtlZXAgdGhlbSBpbiB0aGVzZSBRVW5pdCBuYW1lc3BhY2Ugb25seQpleHRlbmQoUVVuaXQsIHsKCWNvbmZpZzogY29uZmlnLAoKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwoJaW5pdDogZnVuY3Rpb24oKSB7CgkJZXh0ZW5kKGNvbmZpZywgewoJCQlzdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQltb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQlzdGFydGVkOiArbmV3IERhdGUsCgkJCXVwZGF0ZVJhdGU6IDEwMDAsCgkJCWJsb2NraW5nOiBmYWxzZSwKCQkJYXV0b3N0YXJ0OiB0cnVlLAoJCQlhdXRvcnVuOiBmYWxzZSwKCQkJZmlsdGVyczogW10sCgkJCXF1ZXVlOiBbXSwKCQkJc2VtYXBob3JlOiAwCgkJfSk7CgoJCXZhciB0ZXN0cyA9IGlkKCAicXVuaXQtdGVzdHMiICksCgkJCWJhbm5lciA9IGlkKCAicXVuaXQtYmFubmVyIiApLAoJCQlyZXN1bHQgPSBpZCggInF1bml0LXRlc3RyZXN1bHQiICk7CgoJCWlmICggdGVzdHMgKSB7CgkJCXRlc3RzLmlubmVySFRNTCA9ICIiOwoJCX0KCgkJaWYgKCBiYW5uZXIgKSB7CgkJCWJhbm5lci5jbGFzc05hbWUgPSAiIjsKCQl9CgoJCWlmICggcmVzdWx0ICkgewoJCQlyZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmVzdWx0ICk7CgkJfQoJCQoJCWlmICggdGVzdHMgKSB7CgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJwIiApOwoJCQlyZXN1bHQuaWQgPSAicXVuaXQtdGVzdHJlc3VsdCI7CgkJCXJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsKCQkJdGVzdHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHJlc3VsdCwgdGVzdHMgKTsKCQkJcmVzdWx0LmlubmVySFRNTCA9ICdSdW5uaW5nLi4uPGJyLz4mbmJzcDsnOwoJCX0KCX0sCgkKCS8qKgoJICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCgkgKiAKCSAqIElmIGpRdWVyeSBpcyBhdmFpbGFibGUsIHVzZXMgalF1ZXJ5J3MgaHRtbCgpLCBvdGhlcndpc2UganVzdCBpbm5lckhUTUwuCgkgKi8KCXJlc2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHdpbmRvdy5qUXVlcnkgKSB7CgkJCWpRdWVyeSggIiNtYWluLCAjcXVuaXQtZml4dHVyZSIgKS5odG1sKCBjb25maWcuZml4dHVyZSApOwoJCX0gZWxzZSB7CgkJCXZhciBtYWluID0gaWQoICdtYWluJyApIHx8IGlkKCAncXVuaXQtZml4dHVyZScgKTsKCQkJaWYgKCBtYWluICkgewoJCQkJbWFpbi5pbm5lckhUTUwgPSBjb25maWcuZml4dHVyZTsKCQkJfQoJCX0KCX0sCgkKCS8qKgoJICogVHJpZ2dlciBhbiBldmVudCBvbiBhbiBlbGVtZW50LgoJICoKCSAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwoJICoKCSAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0KCSAqIEBwYXJhbSBTdHJpbmcgdHlwZQoJICovCgl0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsKCQlpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewoJCQlldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOwoJCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCgkJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CgkJCWVsZW0uZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsKCgkJfSBlbHNlIGlmICggZWxlbS5maXJlRXZlbnQgKSB7CgkJCWVsZW0uZmlyZUV2ZW50KCJvbiIrdHlwZSk7CgkJfQoJfSwKCQoJLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZwoJaXM6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoIG9iaiApID09IHR5cGU7Cgl9LAoJCglvYmplY3RUeXBlOiBmdW5jdGlvbiggb2JqICkgewoJCWlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewoJCQkJcmV0dXJuICJ1bmRlZmluZWQiOwoKCQkvLyBjb25zaWRlcjogdHlwZW9mIG51bGwgPT09IG9iamVjdAoJCX0KCQlpZiAob2JqID09PSBudWxsKSB7CgkJCQlyZXR1cm4gIm51bGwiOwoJCX0KCgkJdmFyIHR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIG9iaiApCgkJCS5tYXRjaCgvXlxbb2JqZWN0XHMoLiopXF0kLylbMV0gfHwgJyc7CgoJCXN3aXRjaCAodHlwZSkgewoJCQkJY2FzZSAnTnVtYmVyJzoKCQkJCQkJaWYgKGlzTmFOKG9iaikpIHsKCQkJCQkJCQlyZXR1cm4gIm5hbiI7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcmV0dXJuICJudW1iZXIiOwoJCQkJCQl9CgkJCQljYXNlICdTdHJpbmcnOgoJCQkJY2FzZSAnQm9vbGVhbic6CgkJCQljYXNlICdBcnJheSc6CgkJCQljYXNlICdEYXRlJzoKCQkJCWNhc2UgJ1JlZ0V4cCc6CgkJCQljYXNlICdGdW5jdGlvbic6CgkJCQkJCXJldHVybiB0eXBlLnRvTG93ZXJDYXNlKCk7CgkJfQoJCWlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewoJCQkJcmV0dXJuICJvYmplY3QiOwoJCX0KCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCQoJcHVzaDogZnVuY3Rpb24ocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJdmFyIGRldGFpbHMgPSB7CgkJCXJlc3VsdDogcmVzdWx0LAoJCQltZXNzYWdlOiBtZXNzYWdlLAoJCQlhY3R1YWw6IGFjdHVhbCwKCQkJZXhwZWN0ZWQ6IGV4cGVjdGVkCgkJfTsKCQkKCQltZXNzYWdlID0gZXNjYXBlSHRtbChtZXNzYWdlKSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJCW1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9InRlc3QtbWVzc2FnZSI+JyArIG1lc3NhZ2UgKyAiPC9zcGFuPiI7CgkJZXhwZWN0ZWQgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkpOwoJCWFjdHVhbCA9IGVzY2FwZUh0bWwoUVVuaXQuanNEdW1wLnBhcnNlKGFjdHVhbCkpOwoJCXZhciBvdXRwdXQgPSBtZXNzYWdlICsgJzx0YWJsZT48dHIgY2xhc3M9InRlc3QtZXhwZWN0ZWQiPjx0aD5FeHBlY3RlZDogPC90aD48dGQ+PHByZT4nICsgZXhwZWN0ZWQgKyAnPC9wcmU+PC90ZD48L3RyPic7CgkJaWYgKGFjdHVhbCAhPSBleHBlY3RlZCkgewoJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1hY3R1YWwiPjx0aD5SZXN1bHQ6IDwvdGg+PHRkPjxwcmU+JyArIGFjdHVhbCArICc8L3ByZT48L3RkPjwvdHI+JzsKCQkJb3V0cHV0ICs9ICc8dHIgY2xhc3M9InRlc3QtZGlmZiI+PHRoPkRpZmY6IDwvdGg+PHRkPjxwcmU+JyArIFFVbml0LmRpZmYoZXhwZWN0ZWQsIGFjdHVhbCkgKyc8L3ByZT48L3RkPjwvdHI+JzsKCQl9CgkJaWYgKCFyZXN1bHQpIHsKCQkJdmFyIHNvdXJjZSA9IHNvdXJjZUZyb21TdGFja3RyYWNlKCk7CgkJCWlmIChzb3VyY2UpIHsKCQkJCWRldGFpbHMuc291cmNlID0gc291cmNlOwoJCQkJb3V0cHV0ICs9ICc8dHIgY2xhc3M9InRlc3Qtc291cmNlIj48dGg+U291cmNlOiA8L3RoPjx0ZD48cHJlPicgKyBzb3VyY2UgKyc8L3ByZT48L3RkPjwvdHI+JzsKCQkJfQoJCX0KCQlvdXRwdXQgKz0gIjwvdGFibGU+IjsKCQkKCQlRVW5pdC5sb2coZGV0YWlscyk7CgkJCgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKCQkJcmVzdWx0OiAhIXJlc3VsdCwKCQkJbWVzc2FnZTogb3V0cHV0CgkJfSk7Cgl9LAoJCgkvLyBMb2dnaW5nIGNhbGxiYWNrczsgYWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQgd2l0aCB0aGUgbGlzdGVkIHByb3BlcnRpZXMKCS8vIHJ1biB0ZXN0L2xvZ3MuaHRtbCBmb3IgYW55IHJlbGF0ZWQgY2hhbmdlcwoJYmVnaW46IGZ1bmN0aW9uKCkge30sCgkvLyBkb25lOiB7IGZhaWxlZCwgcGFzc2VkLCB0b3RhbCwgcnVudGltZSB9Cglkb25lOiBmdW5jdGlvbigpIHt9LAoJLy8gbG9nOiB7IHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSB9Cglsb2c6IGZ1bmN0aW9uKCkge30sCgkvLyB0ZXN0U3RhcnQ6IHsgbmFtZSB9Cgl0ZXN0U3RhcnQ6IGZ1bmN0aW9uKCkge30sCgkvLyB0ZXN0RG9uZTogeyBuYW1lLCBmYWlsZWQsIHBhc3NlZCwgdG90YWwgfQoJdGVzdERvbmU6IGZ1bmN0aW9uKCkge30sCgkvLyBtb2R1bGVTdGFydDogeyBuYW1lIH0KCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbigpIHt9LAoJLy8gbW9kdWxlRG9uZTogeyBuYW1lLCBmYWlsZWQsIHBhc3NlZCwgdG90YWwgfQoJbW9kdWxlRG9uZTogZnVuY3Rpb24oKSB7fQp9KTsKCmlmICggdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOwp9CgphZGRFdmVudCh3aW5kb3csICJsb2FkIiwgZnVuY3Rpb24oKSB7CglRVW5pdC5iZWdpbih7fSk7CgkKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKCXZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7CglRVW5pdC5pbml0KCk7CglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoKCXZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7CglpZiAoIHVzZXJBZ2VudCApIHsKCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCX0KCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtaGVhZGVyIik7CglpZiAoIGJhbm5lciApIHsKCQl2YXIgcGFyYW1zSW5kZXggPSBsb2NhdGlvbi5ocmVmLmxhc3RJbmRleE9mKGxvY2F0aW9uLnNlYXJjaCk7CgkJaWYgKCBwYXJhbXNJbmRleCA+IC0xICkgewoJCQl2YXIgbWFpblBhZ2VMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYuc2xpY2UoMCwgcGFyYW1zSW5kZXgpOwoJCQlpZiAoIG1haW5QYWdlTG9jYXRpb24gPT0gbG9jYXRpb24uaHJlZiApIHsKCQkJCWJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iIj4gJyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAnOwoJCQl9IGVsc2UgewoJCQkJdmFyIHRlc3ROYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKSk7CgkJCQliYW5uZXIuaW5uZXJIVE1MID0gJzxhIGhyZWY9IicgKyBtYWluUGFnZUxvY2F0aW9uICsgJyI+JyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAmIzgyNTA7IDxhIGhyZWY9IiI+JyArIHRlc3ROYW1lICsgJzwvYT4nOwoJCQl9CgkJfQoJfQoJCgl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKCWlmICggdG9vbGJhciApIHsKCQl2YXIgZmlsdGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCQlmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7CgkJZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsKCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJdmFyIG9sID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInF1bml0LXRlc3RzIik7CgkJCWlmICggZmlsdGVyLmNoZWNrZWQgKSB7CgkJCQlvbC5jbGFzc05hbWUgPSBvbC5jbGFzc05hbWUgKyAiIGhpZGVwYXNzIjsKCQkJfSBlbHNlIHsKCQkJCXZhciB0bXAgPSAiICIgKyBvbC5jbGFzc05hbWUucmVwbGFjZSggL1tcblx0XHJdL2csICIgIiApICsgIiAiOwoJCQkJb2wuY2xhc3NOYW1lID0gdG1wLnJlcGxhY2UoLyBoaWRlcGFzcyAvLCAiICIpOwoJCQl9CgkJCWlmICggZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSApIHsKCQkJCXNlc3Npb25TdG9yYWdlLnNldEl0ZW0oInF1bml0LWZpbHRlci1wYXNzZWQtdGVzdHMiLCBmaWx0ZXIuY2hlY2tlZCA/ICJ0cnVlIiA6ICIiKTsKCQkJfQoJCX0pOwoJCWlmICggZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJxdW5pdC1maWx0ZXItcGFzc2VkLXRlc3RzIikgKSB7CgkJCWZpbHRlci5jaGVja2VkID0gdHJ1ZTsKCQkJdmFyIG9sID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInF1bml0LXRlc3RzIik7CgkJCW9sLmNsYXNzTmFtZSA9IG9sLmNsYXNzTmFtZSArICIgaGlkZXBhc3MiOwoJCX0KCQl0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsKCgkJdmFyIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOwoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsKCX0KCgl2YXIgbWFpbiA9IGlkKCdtYWluJykgfHwgaWQoJ3F1bml0LWZpeHR1cmUnKTsKCWlmICggbWFpbiApIHsKCQljb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOwoJfQoKCWlmIChjb25maWcuYXV0b3N0YXJ0KSB7CgkJUVVuaXQuc3RhcnQoKTsKCX0KfSk7CgpmdW5jdGlvbiBkb25lKCkgewoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOwoKCS8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cwoJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQlRVW5pdC5tb2R1bGVEb25lKCB7CgkJCW5hbWU6IGNvbmZpZy5jdXJyZW50TW9kdWxlLAoJCQlmYWlsZWQ6IGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsCgkJCXBhc3NlZDogY29uZmlnLm1vZHVsZVN0YXRzLmFsbCAtIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsCgkJCXRvdGFsOiBjb25maWcubW9kdWxlU3RhdHMuYWxsCgkJfSApOwoJfQoKCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCgkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKCQlydW50aW1lID0gK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsCgkJcGFzc2VkID0gY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsCgkJaHRtbCA9IFsKCQkJJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLAoJCQlydW50aW1lLAoJCQknIG1pbGxpc2Vjb25kcy48YnIvPicsCgkJCSc8c3BhbiBjbGFzcz0icGFzc2VkIj4nLAoJCQlwYXNzZWQsCgkJCSc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJ0b3RhbCI+JywKCQkJY29uZmlnLnN0YXRzLmFsbCwKCQkJJzwvc3Bhbj4gcGFzc2VkLCA8c3BhbiBjbGFzcz0iZmFpbGVkIj4nLAoJCQljb25maWcuc3RhdHMuYmFkLAoJCQknPC9zcGFuPiBmYWlsZWQuJwoJCV0uam9pbignJyk7CgoJaWYgKCBiYW5uZXIgKSB7CgkJYmFubmVyLmNsYXNzTmFtZSA9IChjb25maWcuc3RhdHMuYmFkID8gInF1bml0LWZhaWwiIDogInF1bml0LXBhc3MiKTsKCX0KCglpZiAoIHRlc3RzICkgewkKCQlpZCggInF1bml0LXRlc3RyZXN1bHQiICkuaW5uZXJIVE1MID0gaHRtbDsKCX0KCglRVW5pdC5kb25lKCB7CgkJZmFpbGVkOiBjb25maWcuc3RhdHMuYmFkLAoJCXBhc3NlZDogcGFzc2VkLCAKCQl0b3RhbDogY29uZmlnLnN0YXRzLmFsbCwKCQlydW50aW1lOiBydW50aW1lCgl9ICk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoKCWlmICggIWkgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgkKCXdoaWxlICggaS0tICkgewoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7CgoJCWlmICggbm90ICkgewoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7CgkJfQoKCQlpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsKCQkJcmV0dXJuICFub3Q7CgkJfQoKCQlpZiAoIG5vdCApIHsKCQkJcnVuID0gdHJ1ZTsKCQl9Cgl9CgoJcmV0dXJuIHJ1bjsKfQoKLy8gc28gZmFyIHN1cHBvcnRzIG9ubHkgRmlyZWZveCwgQ2hyb21lIGFuZCBPcGVyYSAoYnVnZ3kpCi8vIGNvdWxkIGJlIGV4dGVuZGVkIGluIHRoZSBmdXR1cmUgdG8gdXNlIHNvbWV0aGluZyBsaWtlIGh0dHBzOi8vZ2l0aHViLmNvbS9jc25vdmVyL1RyYWNlS2l0CmZ1bmN0aW9uIHNvdXJjZUZyb21TdGFja3RyYWNlKCkgewoJdHJ5IHsKCQl0aHJvdyBuZXcgRXJyb3IoKTsKCX0gY2F0Y2ggKCBlICkgewoJCWlmIChlLnN0YWNrdHJhY2UpIHsKCQkJLy8gT3BlcmEKCQkJcmV0dXJuIGUuc3RhY2t0cmFjZS5zcGxpdCgiXG4iKVs2XTsKCQl9IGVsc2UgaWYgKGUuc3RhY2spIHsKCQkJLy8gRmlyZWZveCwgQ2hyb21lCgkJCXJldHVybiBlLnN0YWNrLnNwbGl0KCJcbiIpWzRdOwoJCX0KCX0KfQoKZnVuY3Rpb24gZXNjYXBlSHRtbChzKSB7CglpZiAoIXMpIHsKCQlyZXR1cm4gIiI7Cgl9CglzID0gcyArICIiOwoJcmV0dXJuIHMucmVwbGFjZSgvW1wmIjw+XFxdL2csIGZ1bmN0aW9uKHMpIHsKCQlzd2l0Y2gocykgewoJCQljYXNlICImIjogcmV0dXJuICImYW1wOyI7CgkJCWNhc2UgIlxcIjogcmV0dXJuICJcXFxcIjsKCQkJY2FzZSAnIic6IHJldHVybiAnXCInOwoJCQljYXNlICI8IjogcmV0dXJuICImbHQ7IjsKCQkJY2FzZSAiPiI6IHJldHVybiAiJmd0OyI7CgkJCWRlZmF1bHQ6IHJldHVybiBzOwoJCX0KCX0pOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7Cgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJcHJvY2VzcygpOwoJfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCkgewoJdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgl3aGlsZSAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQlpZiAoIGNvbmZpZy51cGRhdGVSYXRlIDw9IDAgfHwgKCgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQpIDwgY29uZmlnLnVwZGF0ZVJhdGUpICkgewoJCQljb25maWcucXVldWUuc2hpZnQoKSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5zZXRUaW1lb3V0KCBwcm9jZXNzLCAxMyApOwoJCQlicmVhazsKCQl9Cgl9CiAgaWYgKCFjb25maWcuYmxvY2tpbmcgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgIGRvbmUoKTsKICB9Cn0KCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7Cgljb25maWcucG9sbHV0aW9uID0gW107CgkKCWlmICggY29uZmlnLm5vZ2xvYmFscyApIHsKCQlmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsKCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICkgewoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247CglzYXZlR2xvYmFsKCk7CgkKCXZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7CglpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIG5ld0dsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkKys7Cgl9CgoJdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7CglpZiAoIGRlbGV0ZWRHbG9iYWxzLmxlbmd0aCA+IDAgKSB7CgkJb2soIGZhbHNlLCAiRGVsZXRlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBkZWxldGVkR2xvYmFscy5qb2luKCIsICIpICk7CgkJY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQrKzsKCX0KfQoKLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYgpmdW5jdGlvbiBkaWZmKCBhLCBiICkgewoJdmFyIHJlc3VsdCA9IGEuc2xpY2UoKTsKCWZvciAoIHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKyApIHsKCQlmb3IgKCB2YXIgaiA9IDA7IGogPCBiLmxlbmd0aDsgaisrICkgewoJCQlpZiAoIHJlc3VsdFtpXSA9PT0gYltqXSApIHsKCQkJCXJlc3VsdC5zcGxpY2UoaSwgMSk7CgkJCQlpLS07CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCXJldHVybiByZXN1bHQ7Cn0KCmZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgewoJaWYgKCB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7CgkJY29uc29sZS5lcnJvcihtZXNzYWdlKTsKCQljb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7CgkJY29uc29sZS53YXJuKGNhbGxiYWNrLnRvU3RyaW5nKCkpOwoKCX0gZWxzZSBpZiAoIHdpbmRvdy5vcGVyYSAmJiBvcGVyYS5wb3N0RXJyb3IgKSB7CgkJb3BlcmEucG9zdEVycm9yKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2sudG9TdHJpbmcpOwoJfQp9CgpmdW5jdGlvbiBleHRlbmQoYSwgYikgewoJZm9yICggdmFyIHByb3AgaW4gYiApIHsKCQlhW3Byb3BdID0gYltwcm9wXTsKCX0KCglyZXR1cm4gYTsKfQoKZnVuY3Rpb24gYWRkRXZlbnQoZWxlbSwgdHlwZSwgZm4pIHsKCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZm4sIGZhbHNlICk7Cgl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCWVsZW0uYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBmbiApOwoJfSBlbHNlIHsKCQlmbigpOwoJfQp9CgpmdW5jdGlvbiBpZChuYW1lKSB7CglyZXR1cm4gISEodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgJiYKCQlkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbmFtZSApOwp9CgovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLgovLyBEaXNjdXNzaW9ucyBhbmQgcmVmZXJlbmNlOiBodHRwOi8vcGhpbHJhdGhlLmNvbS9hcnRpY2xlcy9lcXVpdgovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYKLy8gQXV0aG9yOiBQaGlsaXBwZSBSYXRow6kgPHByYXRoZUBnbWFpbC5jb20+ClFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbgogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMKICAgIHZhciBwYXJlbnRzID0gW107IC8vIHN0YWNrIHRvIGF2b2lkaW5nIGxvb3BzIGZyb20gY2lyY3VsYXIgcmVmZXJlbmNpbmcKCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLgogICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICB2YXIgcHJvcCA9IFFVbml0Lm9iamVjdFR5cGUobyk7CiAgICAgICAgaWYgKHByb3ApIHsKICAgICAgICAgICAgaWYgKFFVbml0Lm9iamVjdFR5cGUoY2FsbGJhY2tzW3Byb3BdKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXTsgLy8gb3IgdW5kZWZpbmVkCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwKICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgIGlmICggISAoUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9ICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxlbiA9IGEubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7Ly9kb250IHJld2FsayBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGksIGosIGxvb3A7CiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsgLy9kb24ndCBnbyBkb3duIHRoZSBzYW1lIHBhdGggdHdpY2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYikgewogICAgICAgICAgICAgICAgICAgIGJQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYidzIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFbnN1cmVzIGlkZW50aWNhbCBwcm9wZXJ0aWVzIG5hbWUKICAgICAgICAgICAgICAgIHJldHVybiBlcSAmJiBpbm5lckVxdWl2KGFQcm9wZXJ0aWVzLnNvcnQoKSwgYlByb3BlcnRpZXMuc29ydCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KCk7CgogICAgaW5uZXJFcXVpdiA9IGZ1bmN0aW9uICgpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsKICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNhdGNoIHRoZSBtb3N0IHlvdSBjYW4KICAgICAgICAgICAgfSBlbHNlIGlmIChhID09PSBudWxsIHx8IGIgPT09IG51bGwgfHwgdHlwZW9mIGEgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fCBRVW5pdC5vYmplY3RUeXBlKGEpICE9PSBRVW5pdC5vYmplY3RUeXBlKGIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7CiAgICB9OwoKICAgIHJldHVybiBpbm5lckVxdWl2OwoKfSgpOwoKLyoqCiAqIGpzRHVtcAogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkKICogRGF0ZTogNS8xNS8yMDA4CiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogKiBAdmVyc2lvbiAxLjAuMAogKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogKi8KUVVuaXQuanNEdW1wID0gKGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsKCQlyZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7Cgl9OwoJZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsKCQlyZXR1cm4gbyArICcnOwkKCX07CglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsKCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwKCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwoJCWlmICggYXJyLmpvaW4gKQoJCQlhcnIgPSBhcnIuam9pbiggJywnICsgcyArIGlubmVyICk7CgkJaWYgKCAhYXJyICkKCQkJcmV0dXJuIHByZSArIHBvc3Q7CgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwoJfTsKCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7CgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsJCQkJCQoJCXRoaXMudXAoKTsKCQl3aGlsZSAoIGktLSApCgkJCXJldFtpXSA9IHRoaXMucGFyc2UoIGFycltpXSApOwkJCQkKCQl0aGlzLmRvd24oKTsKCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOwoJfTsKCQoJdmFyIHJlTmFtZSA9IC9eZnVuY3Rpb24gKFx3KykvOwoJCgl2YXIganNEdW1wID0gewoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCgkJCXZhcglwYXJzZXIgPSB0aGlzLnBhcnNlcnNbIHR5cGUgfHwgdGhpcy50eXBlT2Yob2JqKSBdOwoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsJCQkKCQkJCgkJCXJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCggdGhpcywgb2JqICkgOgoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7CgkJfSwKCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApIHsKCQkJdmFyIHR5cGU7CgkJCWlmICggb2JqID09PSBudWxsICkgewoJCQkJdHlwZSA9ICJudWxsIjsKCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewoJCQkJdHlwZSA9ICJ1bmRlZmluZWQiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7CgkJCQl0eXBlID0gInJlZ2V4cCI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvYmopKSB7CgkJCQl0eXBlID0gImRhdGUiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsKCQkJCXR5cGUgPSAiZnVuY3Rpb24iOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmouc2V0SW50ZXJ2YWwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2JqLmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygb2JqLm5vZGVUeXBlID09PSAidW5kZWZpbmVkIikgewoJCQkJdHlwZSA9ICJ3aW5kb3ciOwoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSA9PT0gOSkgewoJCQkJdHlwZSA9ICJkb2N1bWVudCI7CgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7CgkJCQl0eXBlID0gIm5vZGUiOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAibnVtYmVyIiAmJiBvYmoubGVuZ3RoID49IDApIHsKCQkJCXR5cGUgPSAiYXJyYXkiOwoJCQl9IGVsc2UgewoJCQkJdHlwZSA9IHR5cGVvZiBvYmo7CgkJCX0KCQkJcmV0dXJuIHR5cGU7CgkJfSwKCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwoJCX0sCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwoJCQlpZiAoICF0aGlzLm11bHRpbGluZSApCgkJCQlyZXR1cm4gJyc7CgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CgkJCWlmICggdGhpcy5IVE1MICkKCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOwoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CgkJfSwKCQl1cDpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKCQl9LAoJCWRvd246ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CgkJfSwKCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsKCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwoJCX0sCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtCgkJcXVvdGU6cXVvdGUsIAoJCWxpdGVyYWw6bGl0ZXJhbCwKCQlqb2luOmpvaW4sCgkJLy8KCQlfZGVwdGhfOiAxLAoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCgkJcGFyc2Vyczp7CgkJCXdpbmRvdzogJ1tXaW5kb3ddJywKCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuCgkJCXVua25vd246ICdbVW5rbm93bl0nLAoJCQknbnVsbCc6J251bGwnLAoJCQkndW5kZWZpbmVkJzondW5kZWZpbmVkJywKCQkJJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7CgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCQkJCWlmICggbmFtZSApCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7CgkJCQlyZXQgKz0gJygnOwoJCQkJCgkJCQlyZXQgPSBbIHJldCwgUVVuaXQuanNEdW1wLnBhcnNlKCBmbiwgJ2Z1bmN0aW9uQXJncycgKSwgJyl7J10uam9pbignJyk7CgkJCQlyZXR1cm4gam9pbiggcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsKCQkJfSwKCQkJYXJyYXk6IGFycmF5LAoJCQlub2RlbGlzdDogYXJyYXksCgkJCWFyZ3VtZW50czogYXJyYXksCgkJCW9iamVjdDpmdW5jdGlvbiggbWFwICkgewoJCQkJdmFyIHJldCA9IFsgXTsKCQkJCVFVbml0LmpzRHVtcC51cCgpOwoJCQkJZm9yICggdmFyIGtleSBpbiBtYXAgKQoJCQkJCXJldC5wdXNoKCBRVW5pdC5qc0R1bXAucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyBRVW5pdC5qc0R1bXAucGFyc2UobWFwW2tleV0pICk7CgkJCQlRVW5pdC5qc0R1bXAuZG93bigpOwoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKCQkJfSwKCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsKCQkJCXZhciBvcGVuID0gUVVuaXQuanNEdW1wLkhUTUwgPyAnJmx0OycgOiAnPCcsCgkJCQkJY2xvc2UgPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsKCQkJCQkKCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsKCQkJCQkKCQkJCWZvciAoIHZhciBhIGluIFFVbml0LmpzRHVtcC5ET01BdHRycyApIHsKCQkJCQl2YXIgdmFsID0gbm9kZVtRVW5pdC5qc0R1bXAuRE9NQXR0cnNbYV1dOwoJCQkJCWlmICggdmFsICkKCQkJCQkJcmV0ICs9ICcgJyArIGEgKyAnPScgKyBRVW5pdC5qc0R1bXAucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsKCQkJCX0KCQkJCXJldHVybiByZXQgKyBjbG9zZSArIG9wZW4gKyAnLycgKyB0YWcgKyBjbG9zZTsKCQkJfSwKCQkJZnVuY3Rpb25BcmdzOmZ1bmN0aW9uKCBmbiApIHsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbgoJCQkJdmFyIGwgPSBmbi5sZW5ndGg7CgkJCQlpZiAoICFsICkgcmV0dXJuICcnOwkJCQkKCQkJCQoJCQkJdmFyIGFyZ3MgPSBBcnJheShsKTsKCQkJCXdoaWxlICggbC0tICkKCQkJCQlhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJwoJCQkJcmV0dXJuICcgJyArIGFyZ3Muam9pbignLCAnKSArICcgJzsKCQkJfSwKCQkJa2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAoJCQlmdW5jdGlvbkNvZGU6J1tjb2RlXScsIC8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgY29udGVudCBvZiB0aGUgZnVuY3Rpb24KCQkJYXR0cmlidXRlOnF1b3RlLCAvL25vZGUgY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyBhbiBodG1sIGF0dHJpYnV0ZSB2YWx1ZQoJCQlzdHJpbmc6cXVvdGUsCgkJCWRhdGU6cXVvdGUsCgkJCXJlZ2V4cDpsaXRlcmFsLCAvL3JlZ2V4CgkJCW51bWJlcjpsaXRlcmFsLAoJCQknYm9vbGVhbic6bGl0ZXJhbAoJCX0sCgkJRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lCgkJCWlkOidpZCcsCgkJCW5hbWU6J25hbWUnLAoJCQknY2xhc3MnOidjbGFzc05hbWUnCgkJfSwKCQlIVE1MOmZhbHNlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkKCQlpbmRlbnRDaGFyOicgICcsLy9pbmRlbnRhdGlvbiB1bml0CgkJbXVsdGlsaW5lOnRydWUgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuCgl9OwoKCXJldHVybiBqc0R1bXA7Cn0pKCk7CgovLyBmcm9tIFNpenpsZS5qcwpmdW5jdGlvbiBnZXRUZXh0KCBlbGVtcyApIHsKCXZhciByZXQgPSAiIiwgZWxlbTsKCglmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zW2ldOwoKCQkvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7CgoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgewoJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbS5jaGlsZE5vZGVzICk7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn07CgovKgogKiBKYXZhc2NyaXB0IERpZmYgQWxnb3JpdGhtCiAqICBCeSBKb2huIFJlc2lnIChodHRwOi8vZWpvaG4ub3JnLykKICogIE1vZGlmaWVkIGJ5IENodSBBbGFuICJzcHJpdGUiCiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICoKICogTW9yZSBJbmZvOgogKiAgaHR0cDovL2Vqb2huLm9yZy9wcm9qZWN0cy9qYXZhc2NyaXB0LWRpZmYtYWxnb3JpdGhtLwogKiAgCiAqIFVzYWdlOiBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpCiAqIAogKiBRVW5pdC5kaWZmKCJ0aGUgcXVpY2sgYnJvd24gZm94IGp1bXBlZCBvdmVyIiwgInRoZSBxdWljayBmb3gganVtcHMgb3ZlciIpID09ICJ0aGUgIHF1aWNrIDxkZWw+YnJvd24gPC9kZWw+IGZveCA8ZGVsPmp1bXBlZCA8L2RlbD48aW5zPmp1bXBzIDwvaW5zPiBvdmVyIgogKi8KUVVuaXQuZGlmZiA9IChmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIGRpZmYobywgbil7CgkJdmFyIG5zID0gbmV3IE9iamVjdCgpOwoJCXZhciBvcyA9IG5ldyBPYmplY3QoKTsKCQkKCQlmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoOyBpKyspIHsKCQkJaWYgKG5zW25baV1dID09IG51bGwpIAoJCQkJbnNbbltpXV0gPSB7CgkJCQkJcm93czogbmV3IEFycmF5KCksCgkJCQkJbzogbnVsbAoJCQkJfTsKCQkJbnNbbltpXV0ucm93cy5wdXNoKGkpOwoJCX0KCQkKCQlmb3IgKHZhciBpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKCQkJaWYgKG9zW29baV1dID09IG51bGwpIAoJCQkJb3Nbb1tpXV0gPSB7CgkJCQkJcm93czogbmV3IEFycmF5KCksCgkJCQkJbjogbnVsbAoJCQkJfTsKCQkJb3Nbb1tpXV0ucm93cy5wdXNoKGkpOwoJCX0KCQkKCQlmb3IgKHZhciBpIGluIG5zKSB7CgkJCWlmIChuc1tpXS5yb3dzLmxlbmd0aCA9PSAxICYmIHR5cGVvZihvc1tpXSkgIT0gInVuZGVmaW5lZCIgJiYgb3NbaV0ucm93cy5sZW5ndGggPT0gMSkgewoJCQkJbltuc1tpXS5yb3dzWzBdXSA9IHsKCQkJCQl0ZXh0OiBuW25zW2ldLnJvd3NbMF1dLAoJCQkJCXJvdzogb3NbaV0ucm93c1swXQoJCQkJfTsKCQkJCW9bb3NbaV0ucm93c1swXV0gPSB7CgkJCQkJdGV4dDogb1tvc1tpXS5yb3dzWzBdXSwKCQkJCQlyb3c6IG5zW2ldLnJvd3NbMF0KCQkJCX07CgkJCX0KCQl9CgkJCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBuLmxlbmd0aCAtIDE7IGkrKykgewoJCQlpZiAobltpXS50ZXh0ICE9IG51bGwgJiYgbltpICsgMV0udGV4dCA9PSBudWxsICYmIG5baV0ucm93ICsgMSA8IG8ubGVuZ3RoICYmIG9bbltpXS5yb3cgKyAxXS50ZXh0ID09IG51bGwgJiYKCQkJbltpICsgMV0gPT0gb1tuW2ldLnJvdyArIDFdKSB7CgkJCQluW2kgKyAxXSA9IHsKCQkJCQl0ZXh0OiBuW2kgKyAxXSwKCQkJCQlyb3c6IG5baV0ucm93ICsgMQoJCQkJfTsKCQkJCW9bbltpXS5yb3cgKyAxXSA9IHsKCQkJCQl0ZXh0OiBvW25baV0ucm93ICsgMV0sCgkJCQkJcm93OiBpICsgMQoJCQkJfTsKCQkJfQoJCX0KCQkKCQlmb3IgKHZhciBpID0gbi5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7CgkJCWlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgLSAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgPiAwICYmIG9bbltpXS5yb3cgLSAxXS50ZXh0ID09IG51bGwgJiYKCQkJbltpIC0gMV0gPT0gb1tuW2ldLnJvdyAtIDFdKSB7CgkJCQluW2kgLSAxXSA9IHsKCQkJCQl0ZXh0OiBuW2kgLSAxXSwKCQkJCQlyb3c6IG5baV0ucm93IC0gMQoJCQkJfTsKCQkJCW9bbltpXS5yb3cgLSAxXSA9IHsKCQkJCQl0ZXh0OiBvW25baV0ucm93IC0gMV0sCgkJCQkJcm93OiBpIC0gMQoJCQkJfTsKCQkJfQoJCX0KCQkKCQlyZXR1cm4gewoJCQlvOiBvLAoJCQluOiBuCgkJfTsKCX0KCQoJcmV0dXJuIGZ1bmN0aW9uKG8sIG4pewoJCW8gPSBvLnJlcGxhY2UoL1xzKyQvLCAnJyk7CgkJbiA9IG4ucmVwbGFjZSgvXHMrJC8sICcnKTsKCQl2YXIgb3V0ID0gZGlmZihvID09ICIiID8gW10gOiBvLnNwbGl0KC9ccysvKSwgbiA9PSAiIiA/IFtdIDogbi5zcGxpdCgvXHMrLykpOwoKCQl2YXIgc3RyID0gIiI7CgkJCgkJdmFyIG9TcGFjZSA9IG8ubWF0Y2goL1xzKy9nKTsKCQlpZiAob1NwYWNlID09IG51bGwpIHsKCQkJb1NwYWNlID0gWyIgIl07CgkJfQoJCWVsc2UgewoJCQlvU3BhY2UucHVzaCgiICIpOwoJCX0KCQl2YXIgblNwYWNlID0gbi5tYXRjaCgvXHMrL2cpOwoJCWlmIChuU3BhY2UgPT0gbnVsbCkgewoJCQluU3BhY2UgPSBbIiAiXTsKCQl9CgkJZWxzZSB7CgkJCW5TcGFjZS5wdXNoKCIgIik7CgkJfQoJCQoJCWlmIChvdXQubi5sZW5ndGggPT0gMCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IG91dC5vLmxlbmd0aDsgaSsrKSB7CgkJCQlzdHIgKz0gJzxkZWw+JyArIG91dC5vW2ldICsgb1NwYWNlW2ldICsgIjwvZGVsPiI7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCWlmIChvdXQublswXS50ZXh0ID09IG51bGwpIHsKCQkJCWZvciAobiA9IDA7IG4gPCBvdXQuby5sZW5ndGggJiYgb3V0Lm9bbl0udGV4dCA9PSBudWxsOyBuKyspIHsKCQkJCQlzdHIgKz0gJzxkZWw+JyArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CgkJCQl9CgkJCX0KCQkJCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3V0Lm4ubGVuZ3RoOyBpKyspIHsKCQkJCWlmIChvdXQubltpXS50ZXh0ID09IG51bGwpIHsKCQkJCQlzdHIgKz0gJzxpbnM+JyArIG91dC5uW2ldICsgblNwYWNlW2ldICsgIjwvaW5zPiI7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQl2YXIgcHJlID0gIiI7CgkJCQkJCgkJCQkJZm9yIChuID0gb3V0Lm5baV0ucm93ICsgMTsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKykgewoJCQkJCQlwcmUgKz0gJzxkZWw+JyArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CgkJCQkJfQoJCQkJCXN0ciArPSAiICIgKyBvdXQubltpXS50ZXh0ICsgblNwYWNlW2ldICsgcHJlOwoJCQkJfQoJCQl9CgkJfQoJCQoJCXJldHVybiBzdHI7Cgl9Owp9KSgpOwoKfSkodGhpcyk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 00:31:20 GMT",
                    "Content-Length": "37261",
                    "Date": "Sun, 09 Nov 2014 00:31:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}