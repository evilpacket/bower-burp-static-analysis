{
    "url": "http://localhost:9999/glassesfactory/kazitori.js/src/js/kazitori.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/glassesfactory/kazitori.js/src/js/kazitori.js",
                "path": "/glassesfactory/kazitori.js/src/js/kazitori.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9nbGFzc2VzZmFjdG9yeS9rYXppdG9yaS5qcy9zcmMvanMva2F6aXRvcmkuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTExNDkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDc6NTc6NTggR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA3OjU3OjU4IEdNVA0KDQp2YXIgRGVmZmVyZWQsIEV2ZW50RGlzcGF0Y2hlciwgS2F6aXRvcmksIEtheml0b3JpRXZlbnQsIFJ1bGUsIFZBUklBQkxFX1RZUEVTLCBkZWxlZ2F0ZXIsIGVzY2FwZVJlZ0V4cCwgZmlsZVBhdHRlcm4sIGdlbmVyaWNQYXJhbSwgbmFtZWRQYXJhbSwgb3B0aW9uYWxQYXJhbSwgcm91dGVTdHJpcHBlciwgc3BsYXRQYXJhbSwgdHJhaWxpbmdTbGFzaCwKICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9LAogIF9faW5kZXhPZiA9IFtdLmluZGV4T2YgfHwgZnVuY3Rpb24oaXRlbSkgeyBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7IGlmIChpIGluIHRoaXMgJiYgdGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7IH0gcmV0dXJuIC0xOyB9LAogIF9fc2xpY2UgPSBbXS5zbGljZSwKICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSwKICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTsKCmRlbGVnYXRlciA9IGZ1bmN0aW9uKHRhcmdldCwgZnVuYykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmdW5jLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICB9Owp9OwoKdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoKcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKZXNjYXBlUmVnRXhwID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgpuYW1lZFBhcmFtID0gLzwoXHcrfFtBLVphLXpfLV0rOlx3Kyk+L2c7CgpnZW5lcmljUGFyYW0gPSAvKFtBLVphLXpfLV0rKTooXHcrKS87CgpmaWxlUGF0dGVybiA9IC9cdytcLlthLXpBLVowLTldezMsNjR9LzsKCm9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CgpzcGxhdFBhcmFtID0gL1wqXHcrL2c7CgoKLypVUkwg5aSJ5pWw44Gr5a++44GX44Gm5oyH5a6a44Gn44GN44KL5Z6LICovCgpWQVJJQUJMRV9UWVBFUyA9IFsKICB7CiAgICBuYW1lOiAiaW50IiwKICAgIGNhc3Q6IE51bWJlcgogIH0sIHsKICAgIG5hbWU6ICJzdHJpbmciLAogICAgY2FzdDogU3RyaW5nCiAgfQpdOwoKCi8qKgoqIEtheml0b3JpLmpzIOOBryBwdXNoU3RhdGUg44KS44GE44GE5oSf44GY44Gr44GV44Gw44GE44Gm44GP44KM44KL44Or44O844K/44O844Op44Kk44OW44Op44Oq44Gn44GZ44CCPGJyPgoqIOOCt+ODs+ODl+ODq+OBi+OBpOimi+mAmuOBl+OCiOOBjyBwdXNoU3RhdGUg44Kz44Oz44OG44Oz44OE44Gu44Or44O844OG44Kj44Oz44Kw44KS5a6a576p44GZ44KL44GT44Go44GM44Gn44GN44G+44GZ44CCCioKKiDkvb/jgYTmlrnjga/jgajjgabjgoLnsKHljZjjgIIKKiA8dWw+PGxpPktheml0b3JpIOOCkue2meaJv+OBl+OBn+OCr+ODqeOCueOCkuS9nOOCizwvbGk+PGxpPnJvdXRlcyDjgavmibHjgYTjgZ/jgYQgVVJMIOOBqOOAgeOBneOCjOOBq+WvvuW/nOOBl+OBn+ODoeOCveODg+ODieOCkuaMh+WumuOAgjwvbGk+PGxpPuOCpOODs+OCueOCv+ODs+OCueWMljwvbGk+PC91bD4KKgoqIDxoND5leGFtcGxlPC9oND4KKiAgICAgIGNsYXNzIFJvdXRlciBleHRlbmRzIEtheml0b3JpCiogICAgICAgIHJvdXRlczoKKiAgICAgICAgICAiLyI6ICJpbmRleCIKKiAgICAgICAgICAiLzxpbnQ6aWQ+IjogInNob3ciCioKKiAgICAgICAgaW5kZXg6KCktPgoqICAgICAgICAgIGNvbnNvbGUubG9nICJpbmRleCEiCiogICAgICAgIHNob3c6KGlkKS0+CiogICAgICAgICAgY29uc29sZS5sb2cgaWQKKgoqICAgICAgJCgoKS0+CiogICAgICAgIGFwcCA9IG5ldyBSb3V0ZXIoKQoqICAgICAgKQoqCiogS2F6aXRvcmkg44Gn44GvIHB1c2hTdGF0ZSDjgafpnZ7lkIzmnJ/jgrPjg7Pjg4bjg7Pjg4TjgpLkvZzjgaPjgabjgYTjgY/kuIrjgaflv4XopoHjgajjgarjgovjgafjgYLjgo3jgYbmqZ/og73jgpLku5bjgavjgoLmsqLlsbHnlKjmhI/jgZfjgabjgYTjgb7jgZnjgII8YnI+Ciog6Kmz57Sw44GvIEFQSSDkuIDopqfjgYvjgonnorroqo3jgZfjgabkuIvjgZXjgYTjgIIKKiBAbW9kdWxlIEtheml0b3JpLmpzCiogQG1haW4gS2F6aXRvcmkKICovCgoKLyoqCiogIEtheml0b3JpIOOBruODoeOCpOODs+OCr+ODqeOCuQoqCiogIEBjbGFzcyBLYXppdG9yaQoqICBAY29uc3RydWN0b3IKICovCgpLYXppdG9yaSA9IChmdW5jdGlvbigpIHsKICBLYXppdG9yaS5wcm90b3R5cGUuVkVSU0lPTiA9ICIxLjAuMiI7CgogIEtheml0b3JpLnByb3RvdHlwZS5oaXN0b3J5ID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmxvY2F0aW9uID0gbnVsbDsKCgogIC8qKgogICog44Oe44OD44OB44GZ44KLVVJM44Gu44Or44O844Or44Go44CB44Gd44KM44Gr5a++5b+c44GZ44KL5Yem55CG44KS5a6a576p44GX44G+44GZ44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiAgICAgcm91dGVzOgogICogICAgICAgJy8nOidpbmRleCcKICAqICAgICAgICcvPGludDppZD4nOidzaG93JwogICoKICAqIEBwcm9wZXJ0eSByb3V0ZXMKICAqIEB0eXBlIE9iamVjdAogICogQGRlZmF1bHQge30KICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnJvdXRlcyA9IHt9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuaGFuZGxlcnMgPSBbXTsKCgogIC8qKgogICog44Oe44OD44OB44GX44GfIFVSTCDjgavlr77jgZnjgovlh6bnkIbjgpLooYzjgYbliY3jgavlrp/ooYzjgZfjgZ/jgYTlh6bnkIbjgpLlrprnvqnjgZfjgb7jgZnjgIIKICAqIEBwcm9wZXJ0eSBiZWZvcmVzCiAgKiBAdHlwZSBPYmplY3QKICAqIEBkZWZhdWx0IHt9CiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5iZWZvcmVzID0ge307CgogIEtheml0b3JpLnByb3RvdHlwZS5iZWZvcmVIYW5kbGVycyA9IFtdOwoKCiAgLyoqCiAgKiBVUkwg44GM5aSJ44KP44KL6Zqb44CB5LqL5YmN44Gr5a6f6KGM44GX44Gf44GE5Yem55CG44KS5a6a576p44GX44G+44GZ44CCPGJyPgogICog44GT44Gu44OX44Ot44OR44OG44Kj44Gr55m76Yyy44GV44KM44Gf5Yem55CG44Gv44CB5LiO44GI44KJ44KM44GfIFVSTCDjgavjg57jg4Pjg4HjgZnjgovjgYvjganjgYbjgYvjgavjgYvjgYvjgo/jgonjgZrjgIHluLjjgavlrp/ooYzjgZXjgozjgb7jgZnjgIIKICAqIEBwcm9wZXJ0eSBiZWZvcmVBbnl0aW1lSGFuZGxlcgogICogQHR5cGUgQXJyYXkKICAqIEBkZWZhdWx0IFtdCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5iZWZvcmVBbnl0aW1lSGFuZGxlciA9IG51bGw7CgogIEtheml0b3JpLnByb3RvdHlwZS5hZnRlcmhhbmRsZXJzID0gW107CgoKICAvKioKICAqIOeJueWumuOBruODleOCoeOCpOODq+WQjeOBjCBVUkwg44Gr5ZCr44G+44KM44Gm44GE44Gf5pmC44CB44Or44O844OI44Go44GX44Gm5Yem55CG44GZ44KL44Oq44K544OI44Gn44GZ44CCCiAgKiBAcHJvcGVydHkgcm9vdEZpbGVzCiAgKiBAdHlwZSBBcnJheQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUucm9vdEZpbGVzID0gWydpbmRleC5odG1sJywgJ2luZGV4Lmh0bScsICdpbmRleC5waHAnLCAndW5rby5odG1sJ107CgoKICAvKioKICAqIOODq+ODvOODiOOCkuaMh+WumuOBl+OBvuOBmeOAgjxicj4KICAqIOOBk+OBk+OBp+aMh+WumuOBleOCjOOBn+WApOOBjCBVUkwg44GuIHByZWZpeCDjgajjgZfjgablv4XjgZrjgaTjgY3jgb7jgZnjgII8YnI+CiAgKiDniannkIbnmoTjgasgVVJMIOOBruODq+ODvOODiOOCiOOCiiAx44OH44Kj44Os44Kv44OI44Oq5LiL44GM44Gj44Gf566H5omA44GnIHB1c2hTdGF0ZSDjgpLooYzjgYTjgZ/jgYTloLTlkIg8YnI+CiAgKiDjgZPjga7lgKTjgpIgLyDku6XlpJbjgavmjIflrprjgZfjgb7jgZnjgIIKICAqIDxoND5leGFtcGxlPC9oND4KICAqIOOCs+ODs+ODhuODs+ODhOOCkumFjee9ruOBmeOCi+Wun+ODh+OCo+ODrOOCr+ODiOODquOBjCBleGFtcGxlIOOBoOOBo+OBn+WgtOWQiAogICoKICAqICAgICBhcHAgPSBuZXcgUm91dGVyKHtyb290OicvZXhhbXBsZS8nfSkKICAqIEBwcm9wZXJ0eSByb290CiAgKiBAdHlwZSBTdHJpbmcKICAqIEBkZWZhdWx0IC8KICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnJvb3QgPSBudWxsOwoKCiAgLyoqCiAgKiDnj77lnKjjga4gVVJMIOOBq+ODnuODg+ODgeOBmeOCi+ODq+ODvOODq+OBjOOBquOBi+OBo+OBn+WgtOWQiOOBq+WkieabtOOBmeOCiyBVUkwKICAqIEBwcm9wZXJ0eSBub3RGb3VuZAogICogQHR5cGUgU3RyaW5nCiAgKiBAZGVmYXVsdCBudWxsCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5ub3RGb3VuZCA9IG51bGw7CgogIEtheml0b3JpLnByb3RvdHlwZS5kaXJlY3QgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuaXNJRSA9IGZhbHNlOwoKCiAgLyoqCiAgKiBVUkwg44KS5a6f6Zqb44Gr44Gv5aSJ5pu044GX44Gq44GE44KI44GG44Gr44GZ44KL44GL44Gp44GG44GL44KS5rG65a6a44GX44G+44GZ44CCPGJyPgogICogdHJ1ZSDjgavjgZfjgZ/loLTlkIjjgIFVUkwg44Gv5aSJ5pu044GV44KM44Ga44CB5YaF6YOo44Gn5L+d5oyB44GX44Gm44GE44KL54q25oWL566h55CG44Kq44OW44K444Kn44Kv44OI44KS5Z+65rqW44Gr5bGV6ZaL44GX44G+44GZ44CCCiAgKiBAcHJvcGVydHkgc2lsZW50CiAgKiBAdHlwZSBCb29sZWFuCiAgKiBAZGVmYXVsdCBmYWxzZQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuc2lsZW50ID0gZmFsc2U7CgoKICAvKioKICAqIHB1c2hTdGF0ZSDjgbjjga7nm6PoppbjgYzplovlp4vjgZXjgozjgabjgYTjgovjgYvjganjgYbjgYsKICAqIEBwcm9wZXJ0eSBzdGFydGVkCiAgKiBAdHlwZSBCb29sZWFuCiAgKiBAZGVmYXVsdCBmYWxzZQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuc3RhcnRlZCA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3BhcmFtcyA9IHsKICAgIHBhcmFtczogW10sCiAgICAnZnJhZ21lbnQnOiAnJwogIH07CgoKICAvKioKICAqIGJlZm9yZSDlh6bnkIbjgYzlpLHmlZfjgZfjgZ/mmYLjgavlrp/ooYzjgZXjgozjgb7jgZnjgII8YnI+CiAgKiDjg4fjg5Xjgqnjg6vjg4jjgafjga/nqbrjga4gZnVuY3Rpb24g44Gr44Gq44Gj44Gm44GE44G+44GZ44CCCiAgKgogICogQG1ldGhvZCBiZWZvcmVGYWlsZWRIYW5kbGVyCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5iZWZvcmVGYWlsZWRIYW5kbGVyID0gZnVuY3Rpb24oKSB7fTsKCgogIC8qaXNCZWZvcmVGb3JjZSAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuaXNCZWZvcmVGb3JjZSA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuaXNUZW1hZSA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2NoYW5nZU9wdGlvbnMgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuaXNOb3RGb3VuZEZvcmNlID0gZmFsc2U7CgogIEtheml0b3JpLnByb3RvdHlwZS5fbm90Rm91bmQgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuYnJlYWtlciA9IHt9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2Rpc3BhdGNoZXIgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JlZm9yZURlZmZlciA9IG51bGw7CgoKICAvKioKICAqIOePvuWcqOOBriBVUkwg44KS6L+U44GX44G+44GZ44CCCiAgKiBAcHJvcGVydHkgZnJhZ21lbnQKICAqIEB0eXBlIFN0cmluZwogICogQGRlZmF1bHQgbnVsbAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuZnJhZ21lbnQgPSBudWxsOwoKCiAgLyoqCiAgKiDnj77lnKjjga4gVVJMIOOBi+OCiSAx44Gk5YmN44GuIFVSTCDjgpLov5TjgZfjgb7jgZnjgIIKICAqIEBwcm9wZXJ0eSBsYXN0RnJhZ21lbnQKICAqIEB0eXBlIFN0cmluZwogICogQGRlZmF1bHQgbnVsbAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUubGFzdEZyYWdtZW50ID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzVXNlckFjdGlvbiA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2lzRmlyc3RSZXF1ZXN0ID0gdHJ1ZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzSW5pdFJlcGxhY2UgPSB0cnVlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuaXNMYXN0U2xhc2ggPSBmYWxzZTsKCgogIC8qKgogICog5LiA5pmC5YGc5q2i44GX44Gm44GE44KL44GL44Gp44GG44GL44KS6L+U44GX44G+44GZ44CCCiAgKgogICogQHByb3BlcnR5IGlzU3VzcGVuZAogICogQHR5cGUgQm9vbGVhbgogICogQGRlZmF1bHQgZmFsc2UKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzU3VzcGVuZCA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3Byb2Nlc3NTdGVwID0gewogICAgJ3N0YXR1cyc6ICdudWxsJywKICAgICdhcmdzJzogW10KICB9OwoKICBmdW5jdGlvbiBLYXppdG9yaShvcHRpb25zKSB7CiAgICB0aGlzLm9ic2VydmVVUkxIYW5kbGVyID0gX19iaW5kKHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5iZWZvcmVGYWlsZWQgPSBfX2JpbmQodGhpcy5iZWZvcmVGYWlsZWQsIHRoaXMpOwogICAgdGhpcy5leGVjdXRlSGFuZGxlcnMgPSBfX2JpbmQodGhpcy5leGVjdXRlSGFuZGxlcnMsIHRoaXMpOwogICAgdGhpcy5fZXhlY3V0ZUJlZm9yZXMgPSBfX2JpbmQodGhpcy5fZXhlY3V0ZUJlZm9yZXMsIHRoaXMpOwogICAgdGhpcy5iZWZvcmVDb21wbGV0ZSA9IF9fYmluZCh0aGlzLmJlZm9yZUNvbXBsZXRlLCB0aGlzKTsKICAgIHZhciBkb2NNb2RlLCBlLCB3aW47CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnY29uc3RydWN0b3InOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyA9IFtvcHRpb25zXTsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHsKICAgICAgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIH0KICAgIHRoaXMucm9vdCA9IG9wdGlvbnMuaGFzT3duUHJvcGVydHkoInJvb3QiKSA/IG9wdGlvbnMucm9vdCA6IHRoaXMucm9vdCA9PT0gbnVsbCA/ICcvJyA6IHRoaXMucm9vdDsKICAgIHRoaXMuaXNUZW1hZSA9IG9wdGlvbnMuaXNUZW1hZSA/IG9wdGlvbnMuaXNUZW1hZSA6IGZhbHNlOwogICAgdGhpcy5zaWxlbnQgPSBvcHRpb25zLnNpbGVudCA/IG9wdGlvbnMuc2lsZW50IDogZmFsc2U7CiAgICB0aGlzLmlzSW5pdFJlcGxhY2UgPSBvcHRpb25zLmhhc093blByb3BlcnR5KCJpc0luaXRSZXBsYWNlIikgPyBvcHRpb25zLmlzSW5pdFJlcGxhY2UgOiB0cnVlOwogICAgdGhpcy5pc0xhc3RTbGFzaCA9IG9wdGlvbnMuaGFzT3duUHJvcGVydHkoImlzTGFzdFNsYXNoIikgPyBvcHRpb25zLmlzTGFzdFNsYXNoIDogZmFsc2U7CiAgICB0aGlzLl9wYXJhbXMgPSB7CiAgICAgIHBhcmFtczogW10sCiAgICAgIHF1ZXJpZXM6IHt9LAogICAgICBmcmFnbWVudDogbnVsbAogICAgfTsKICAgIGlmICh0aGlzLm5vdEZvdW5kID09PSBudWxsKSB7CiAgICAgIHRoaXMubm90Rm91bmQgPSBvcHRpb25zLm5vdEZvdW5kID8gb3B0aW9ucy5ub3RGb3VuZCA6IHRoaXMucm9vdDsKICAgIH0KICAgIHdpbiA9IHdpbmRvdzsKICAgIGlmICh0eXBlb2Ygd2luICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luLmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW4uaGlzdG9yeTsKICAgIH0KICAgIGRvY01vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICB0aGlzLmlzSUUgPSB3aW4ubmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ21zaWUnKSAhPT0gLTE7CiAgICB0aGlzLmlzT2xkSUUgPSB0aGlzLmlzSUUgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPCA5KTsKICAgIHRoaXMuX2Rpc3BhdGNoZXIgPSBuZXcgRXZlbnREaXNwYXRjaGVyKCk7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICB0aGlzLmJlZm9yZUhhbmRsZXJzID0gW107CiAgICB0aGlzLl9iaW5kQmVmb3JlcygpOwogICAgdGhpcy5fYmluZFJ1bGVzKCk7CiAgICB0aGlzLl9iaW5kTm90Rm91bmQoKTsKICAgIHRyeSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncGFyYW1zJywgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJhbXMucGFyYW1zOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncXVlcmllcycsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyYW1zLnF1ZXJpZXM7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICBlID0gX2Vycm9yOwogICAgICBpZiAodGhpcy5pc09sZElFKSB7CiAgICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLl9wYXJhbXMucGFyYW1zOwogICAgICAgIHRoaXMucXVlcmllcyA9IHRoaXMuX3BhcmFtcy5xdWVyaWVzOwogICAgICB9CiAgICB9CiAgICBpZiAoKHRoaXMub3B0aW9ucy5pc0F1dG9TdGFydCA9PSBudWxsKSB8fCB0aGlzLm9wdGlvbnMuaXNBdXRvU3RhcnQgIT09IGZhbHNlKSB7CiAgICAgIHRoaXMuc3RhcnQoKTsKICAgIH0KICB9CgoKICAvKioKICAqIEtheml0b3JpLmpzIOOCkumWi+Wni+OBl+OBvuOBmeOAgjxicj4KICAqIFNUQVJUIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogQG1ldGhvZCBzdGFydAogICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMg44Kq44OX44K344On44OzCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBhdFJvb3QsIGZyYWdtZW50LCBmcmFtZSwgaWVGcmFnLCBvdmVycmlkZSwgd2luOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzID0gJ3N0YXJ0JzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbb3B0aW9uc107CiAgICBpZiAodGhpcy5zdGFydGVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignbW91IGhhemltIG1hdHRlcnUnKTsKICAgIH0KICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7CiAgICB3aW4gPSB3aW5kb3c7CiAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLl9leHRlbmQoe30sIHsKICAgICAgcm9vdDogJy8nCiAgICB9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgdGhpcy5faGFzUHVzaFN0YXRlID0gISEodGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgdGhpcy5fd2FudENoYW5nZUhhc2ggPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICBhdFJvb3QgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwogICAgaWYgKHRoaXMuaXNJRSAmJiAhYXRSb290ICYmICF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5pc0luaXRSZXBsYWNlKSB7CiAgICAgIGllRnJhZyA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSh0aGlzLnJvb3QsICcnKTsKICAgICAgdGhpcy5fdXBkYXRlSGFzaElFKGllRnJhZyk7CiAgICB9CiAgICBpZiAodGhpcy5pc09sZElFICYmIHRoaXMuX3dhbnRDaGFuZ2VIYXNoKSB7CiAgICAgIGZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaWZyYW1lIik7CiAgICAgIGZyYW1lLnNldEF0dHJpYnV0ZSgic3JjIiwgImphdmFzY3JpcHQ6MCIpOwogICAgICBmcmFtZS5zZXRBdHRyaWJ1dGUoInRhYmluZGV4IiwgIi0xIik7CiAgICAgIGZyYW1lLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZnJhbWUpOwogICAgICB0aGlzLmlmcmFtZSA9IGZyYW1lLmNvbnRlbnRXaW5kb3c7CiAgICAgIHRoaXMuY2hhbmdlKGZyYWdtZW50KTsKICAgIH0KICAgIHRoaXMuX2FkZFBvcFN0YXRlSGFuZGxlcigpOwogICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgdGhpcy5sb2NhdGlvbi5oYXNoKSB7CiAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmxhc3RGcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKICAgIH0KICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LlNUQVJULCB0aGlzLmZyYWdtZW50KSk7CiAgICBvdmVycmlkZSA9IHRoaXMucm9vdDsKICAgIGlmICghdGhpcy5zaWxlbnQpIHsKICAgICAgaWYgKCF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290KSB7CiAgICAgICAgb3ZlcnJpZGUgPSB0aGlzLmZyYWdtZW50OwogICAgICB9IGVsc2UgaWYgKCFhdFJvb3QpIHsKICAgICAgICBvdmVycmlkZSA9IHRoaXMuZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLmxvYWRVUkwob3ZlcnJpZGUpOwogIH07CgoKICAvKioKICAqIEtheml0b3JpLmpzIOOCkuWBnOatouOBl+OBvuOBmeOAgjxicj4KICAqIFNUT1Ag44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiBAbWV0aG9kIHN0b3AKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgIHZhciB3aW47CiAgICB3aW4gPSB3aW5kb3c7CiAgICB3aW4ucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLm9ic2VydmVVUkxIYW5kbGVyKTsKICAgIHdpbi5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5vYnNlcnZlVVJMSGFuZGxlcik7CiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LlNUT1AsIHRoaXMuZnJhZ21lbnQpKTsKICB9OwoKCiAgLyoqCiAgKiDjg5bjg6njgqbjgrbjga7jg5Ljgrnjg4jjg6rjg7zmqZ/og73jgpLliKnnlKjjgZfjgabjgIzpgLLjgoDjgI3jgpLlrp/ooYzjgZfjgb7jgZnjgII8YnI+CiAgKiDmiJDlip/jgZfjgZ/loLTlkIggTkVYVCDjgqTjg5njg7Pjg4jjgYzjg4fjgqPjgrnjg5Hjg4Pjg4HjgZXjgozjgb7jgZnjgIIKICAqIEBtZXRob2QgdG9yaWthemkKICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS50b3Jpa2F6aSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiB0aGlzLmRpcmVjdGlvbihvcHRpb25zLCAibmV4dCIpOwogIH07CgoKICAvKioKICAqIOODluODqeOCpuOCtuODkuOCueODiOODquODvOapn+iDveOCkuWIqeeUqOOBl+OBpuOAjOaIu+OCi+OAjeOCkuWun+ihjOOBl+OBvuOBmeOAgjxicj4KICAqIOaIkOWKn+OBl+OBn+WgtOWQiCBQUkVWIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogQG1ldGhvZCBvbW9rYXppCiAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUub21va2F6aSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiB0aGlzLmRpcmVjdGlvbihvcHRpb25zLCAicHJldiIpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5kaXJlY3Rpb24gPSBmdW5jdGlvbihvcHRpb24sIGRpcmVjdGlvbikgewogICAgdmFyIHRtcEZyYWc7CiAgICBpZiAoIXRoaXMuc3RhcnRlZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0bXBGcmFnID0gdGhpcy5sYXN0RnJhZ21lbnQ7CiAgICB0aGlzLmxhc3RGcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgIHRoaXMuZGlyZWN0ID0gZGlyZWN0aW9uOwogICAgdGhpcy5pc1VzZXJBY3Rpb24gPSB0cnVlOwogICAgdGhpcy5fcmVtb3ZlUG9wU3RhdGVIYW5kbGVyKCk7CiAgICBpZiAoZGlyZWN0aW9uID09PSAicHJldiIpIHsKICAgICAgdGhpcy5oaXN0b3J5LmJhY2soKTsKICAgICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuUFJFViwgdG1wRnJhZywgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAibmV4dCIpIHsKICAgICAgdGhpcy5oaXN0b3J5LmZvcndhcmQoKTsKICAgICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuTkVYVCwgdG1wRnJhZywgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2FkZFBvcFN0YXRlSGFuZGxlcigpOwogICAgcmV0dXJuIHRoaXMubG9hZFVSTCh0bXBGcmFnKTsKICB9OwoKCiAgLyoqCiAgKiB1cmwg44KS5aSJ5pu044GX44G+44GZ44CCPGJyPgogICog54Sh5LqLIFVSTCDjgYzliIfjgormm7/jgo/jgaPjgZ/loLTlkIjjgIFDSEFOR0Ug44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiAgICAgYXBwLmNoYW5nZSgnL3NvbWV1cmwnKTsKICAqIEBtZXRob2QgY2hhbmdlCiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQg5aSJ5pu044GX44Gf44GEIFVSTAogICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMg44Kq44OX44K344On44OzCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5jaGFuZ2UgPSBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgdmFyIGZyYWcsIG1hdGNoZWQsIG5leHQsIHVybDsKICAgIGlmICghdGhpcy5zdGFydGVkKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1cyA9ICdjaGFuZ2UnOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyA9IFtmcmFnbWVudCwgb3B0aW9uc107CiAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IHsKICAgICAgICAndHJpZ2dlcic6IG9wdGlvbnMKICAgICAgfTsKICAgIH0KICAgIHRoaXMuX2NoYW5nZU9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5pc0JlZm9yZUZvcmNlID0gb3B0aW9ucy5pc0JlZm9yZUZvcmNlICE9PSBmYWxzZTsKICAgIGZyYWcgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsKICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMubGFzdEZyYWdtZW50ID0gdGhpcy5mcmFnbWVudDsKICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnOwogICAgbmV4dCA9IHRoaXMuZnJhZ21lbnQ7CiAgICB1cmwgPSB0aGlzLnJvb3QgKyB0aGlzLl9yZXBsYWNlLmFwcGx5KGZyYWcsIFtyb3V0ZVN0cmlwcGVyLCAnJ10pOwogICAgbWF0Y2hlZCA9IHRoaXMuX21hdGNoQ2hlY2sodGhpcy5mcmFnbWVudCwgdGhpcy5oYW5kbGVycyk7CiAgICBpZiAobWF0Y2hlZCA9PT0gZmFsc2UgJiYgdGhpcy5pc05vdEZvdW5kRm9yY2UgPT09IGZhbHNlKSB7CiAgICAgIGlmICh0aGlzLm5vdEZvdW5kICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fbm90Rm91bmQuY2FsbGJhY2sodGhpcy5mcmFnbWVudCk7CiAgICAgICAgdXJsID0gdGhpcy5yb290ICsgdGhpcy5fbm90Rm91bmQucnVsZS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwogICAgICB9CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50Lk5PVF9GT1VORCkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5pc1RlbWFlICYmICh0aGlzLmJlZm9yZUFueXRpbWVIYW5kbGVyIHx8IHRoaXMuYmVmb3JlSGFuZGxlcnMubGVuZ3RoID4gMCkpIHsKICAgICAgdGhpcy5fZXhlY3V0ZUJlZm9yZXMoZnJhZyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl91cmxDaGFuZ2UoZnJhZywgb3B0aW9ucyk7CiAgICB9CiAgfTsKCgogIC8qKgogICogcHVzaFN0YXRlIOOBp+OBr+OBquOBjyByZXBsYWNlU3RhdGUg44Gn5Yem55CG44GX44G+44GZ44CCPGJyPgogICogcmVwbGFjZVN0YXRlIOOBr+ePvuWcqOOBriBVUkwg44KS572u44GN5o+b44GI44KL44Gf44KB44CB5bGl5q2044Gr44Gv6L+95Yqg44GV44KM44G+44Gb44KT44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiAgICAgYXBwLnJlcGxhY2UoJy9zb21ldXJsJyk7CiAgKiBAbWV0aG9kIHJlcGxhY2UKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudCDlpInmm7TjgZfjgZ/jgYQgVVJMCiAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyDjgqrjg5fjgrfjg6fjg7MKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnJlcGxhY2UgPSBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzID0gJ3JlcGxhY2UnOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyA9IFtmcmFnbWVudCwgb3B0aW9uc107CiAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IHsKICAgICAgICByZXBsYWNlOiB0cnVlCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKCFvcHRpb25zLnJlcGxhY2UgfHwgb3B0aW9ucy5yZXBsYWNlID09PSBmYWxzZSkgewogICAgICBvcHRpb25zLnJlcGxhY2UgPSB0cnVlOwogICAgfQogICAgdGhpcy5jaGFuZ2UoZnJhZ21lbnQsIG9wdGlvbnMpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fdXJsQ2hhbmdlID0gZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgIHZhciBpc0ZpbGUsIGlzTGFzdFNsYXNoLCB1cmw7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnX3VybENoYW5nZSc7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5hcmdzID0gW2ZyYWdtZW50LCBvcHRpb25zXTsKICAgIGlmICh0aGlzLmlzU3VzcGVuZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IHRoaXMuX2NoYW5nZU9wdGlvbnM7CiAgICB9CiAgICB1cmwgPSB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgaXNGaWxlID0gdXJsLm1hdGNoKGZpbGVQYXR0ZXJuKTsKICAgIGlzTGFzdFNsYXNoID0gdXJsLm1hdGNoKHRyYWlsaW5nU2xhc2gpOwogICAgaWYgKHRoaXMuaXNMYXN0U2xhc2ggJiYgIWlzRmlsZSAmJiAhaXNMYXN0U2xhc2gpIHsKICAgICAgdXJsICs9ICIvIjsKICAgIH0KICAgIGlmICghdGhpcy5zaWxlbnQpIHsKICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudENoYW5nZUhhc2gpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICBpZiAoIW9wdGlvbnMucmVwbGFjZSkgewogICAgICAgICAgICB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgfQogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuQ0hBTkdFLCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgaWYgKG9wdGlvbnMuaW50ZXJuYWwgJiYgb3B0aW9ucy5pbnRlcm5hbCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5JTlRFUk5BTF9DSEFOR0UsIHRoaXMuZnJhZ21lbnQsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgICB9CiAgICB0aGlzLmxvYWRVUkwodGhpcy5mcmFnbWVudCwgb3B0aW9ucyk7CiAgfTsKCgogIC8qKgogICog5Lit5q2i44GX44G+44GZ44CCCiAgKiBAbWV0aG9kIHJlamVjdAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5SRUpFQ1QsIHRoaXMuZnJhZ21lbnQpKTsKICAgIGlmICh0aGlzLl9iZWZvcmVEZWZmZXIpIHsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFLCB0aGlzLmJlZm9yZUNvbXBsZXRlKTsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0ZBSUxFRCwgdGhpcy5iZWZvcmVGYWlsZWQpOwogICAgICB0aGlzLl9iZWZvcmVEZWZmZXIgPSBudWxsOwogICAgfQogIH07CgoKICAvKioKICAqIOWHpueQhuOCkuS4gOaZguWBnOatouOBl+OBvuOBmeOAgjxicj4KICAqIFNVU1BFTkQg44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiBAbWV0aG9kIHN1c3BlbmQKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnN1c3BlbmQgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9iZWZvcmVEZWZmZXIgIT0gbnVsbCkgewogICAgICB0aGlzLl9iZWZvcmVEZWZmZXIuc3VzcGVuZCgpOwogICAgfQogICAgdGhpcy5zdGFydGVkID0gZmFsc2U7CiAgICB0aGlzLmlzU3VzcGVuZCA9IHRydWU7CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5TVVNQRU5ELCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogIH07CgoKICAvKioKICAqIOWHpueQhuOCkuWGjemWi+OBl+OBvuOBmeOAgjxicj4KICAqIFJFU1VNRSDjgqTjg5njg7Pjg4jjgYzjg4fjgqPjgrnjg5Hjg4Pjg4HjgZXjgozjgb7jgZnjgIIKICAqIEBtZXRob2QgcmVzdW1lCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9iZWZvcmVEZWZmZXIgIT0gbnVsbCkgewogICAgICB0aGlzLl9iZWZvcmVEZWZmZXIucmVzdW1lKCk7CiAgICB9CiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlOwogICAgdGhpcy5pc1N1c3BlbmQgPSBmYWxzZTsKICAgIHRoaXNbdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzXSh0aGlzLl9wcm9jZXNzU3RlcC5hcmdzKTsKICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LlJFU1VNRSwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUucmVnaXN0ZXJIYW5kbGVyID0gZnVuY3Rpb24ocnVsZSwgbmFtZSwgaXNCZWZvcmUsIGNhbGxiYWNrKSB7CiAgICB2YXIgY2hpbGQsIGUsIHRhcmdldDsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgaWYgKGlzQmVmb3JlKSB7CiAgICAgICAgY2FsbGJhY2sgPSB0aGlzLl9iaW5kRnVuY3Rpb25zKG5hbWUpOwogICAgICB9IGVsc2UgaWYgKG5hbWUgaW5zdGFuY2VvZiBLYXppdG9yaSkgewogICAgICAgIHRoaXMuX2JpbmRDaGlsZChydWxlLCBuYW1lKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGlmIChuYW1lLmhhc093blByb3BlcnR5KCdfX3N1cGVyX18nKSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2hpbGQgPSBuZXcgbmFtZSh7CiAgICAgICAgICAgICAgJ2lzQXV0b1N0YXJ0JzogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2JpbmRDaGlsZChydWxlLCBjaGlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7CiAgICAgICAgICAgIGUgPSBfZXJyb3I7CiAgICAgICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIH0KICAgIH0KICAgIHRhcmdldCA9IGlzQmVmb3JlID8gdGhpcy5iZWZvcmVIYW5kbGVycyA6IHRoaXMuaGFuZGxlcnM7CiAgICB0YXJnZXQudW5zaGlmdChuZXcgUnVsZShydWxlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICB2YXIgYXJnczsKICAgICAgYXJncyA9IHRoaXMucm91dGVyLmV4dHJhY3RQYXJhbXModGhpcywgZnJhZ21lbnQpOwogICAgICByZXR1cm4gY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcy5yb3V0ZXIsIGFyZ3MpOwogICAgfSwgdGhpcykpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iaW5kQ2hpbGQgPSBmdW5jdGlvbihydWxlLCBjaGlsZCkgewogICAgdmFyIGNoaWxkQmVmb3JlLCBjaGlsZEJlZm9yZXMsIGNoaWxkSGFuZGxlcnMsIGNoaWxkUnVsZSwgX2ksIF9qLCBfbGVuLCBfbGVuMTsKICAgIGNoaWxkLnJlamVjdCgpOwogICAgY2hpbGQuc3RvcCgpOwogICAgY2hpbGRIYW5kbGVycyA9IGNoaWxkLmhhbmRsZXJzLmNvbmNhdCgpOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBjaGlsZEhhbmRsZXJzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGNoaWxkUnVsZSA9IGNoaWxkSGFuZGxlcnNbX2ldOwogICAgICBjaGlsZFJ1bGUudXBkYXRlKHJ1bGUpOwogICAgfQogICAgdGhpcy5oYW5kbGVycyA9IGNoaWxkSGFuZGxlcnMuY29uY2F0KHRoaXMuaGFuZGxlcnMpOwogICAgY2hpbGRCZWZvcmVzID0gY2hpbGQuYmVmb3JlSGFuZGxlcnMuY29uY2F0KCk7CiAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBjaGlsZEJlZm9yZXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgIGNoaWxkQmVmb3JlID0gY2hpbGRCZWZvcmVzW19qXTsKICAgICAgY2hpbGRCZWZvcmUudXBkYXRlKHJ1bGUpOwogICAgfQogICAgdGhpcy5iZWZvcmVIYW5kbGVycyA9IGNoaWxkQmVmb3Jlcy5jb25jYXQodGhpcy5iZWZvcmVIYW5kbGVycyk7CiAgICBpZiAoY2hpbGQuYmVmb3JlQW55dGltZUhhbmRsZXIpIHsKICAgICAgdGhpcy5sYXN0QW55dGltZSA9IHRoaXMuYmVmb3JlQW55dGltZS5jb25jYXQoKTsKICAgICAgdGhpcy5fYmluZEJlZm9yZUFueXRpbWUodGhpcy5iZWZvcmVBbnl0aW1lLCBbY2hpbGQuYmVmb3JlQW55dGltZUhhbmRsZXIuY2FsbGJhY2tdKTsKICAgIH0KICB9OwoKCiAgLyoqCiAgKiDjg6vjg7zjgr/jg7zjgpLli5XnmoTjgavov73liqDjgZfjgb7jgZnjgII8YnI+CiAgKiDjg6vjg7zjgr/jg7zjga7ov73liqDjgavmiJDlip/jgZfjgZ/loLTlkIjjgIFBRERFRCDjgqTjg5njg7Pjg4jjgYzjg4fjgqPjgrnjg5Hjg4Pjg4HjgZXjgozjgb7jgZnjgIIKICAqIDxoND5leGFtcGxlPC9oND4KICAqICAgICBmb29Sb3V0ZXIgPSBuZXcgRm9vUm91dGVyKCk7CiAgKiAgICAgYXBwLmFwcGVuZFJvdXRlcihmb28pOwogICogQG1ldGhvZCBhcHBlbmRSb3V0ZXIKICAqIEBwYXJhbSB7T2JqZWN0fSBjaGlsZAogICogQHBhcmFtIHtTdHJpbmd9IGNoaWxkUm9vdAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuYXBwZW5kUm91dGVyID0gZnVuY3Rpb24oY2hpbGQsIGNoaWxkUm9vdCkgewogICAgdmFyIGUsIHJ1bGUsIF9pbnN0YW5jZTsKICAgIGlmICghY2hpbGQgaW5zdGFuY2VvZiBLYXppdG9yaSAmJiB0eXBlb2YgY2hpbGQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCLlvJXmlbDjga7lgKTjgYzkuI3mraPjgafjgZnjgIIg5byV5pWw44Go44GX44Gm5LiO44GI44KJ44KM44KL44Kq44OW44K444Kn44Kv44OI44GvIEtheml0b3JpIOOCkue2meaJv+OBl+OBpuOBhOOCi+W/heimgeOBjOOBguOCiuOBvuOBmeOAgiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBLYXppdG9yaSkgewogICAgICBydWxlID0gdGhpcy5fZ2V0Q2hpbGRSdWxlKGNoaWxkLCBjaGlsZFJvb3QpOwogICAgICB0aGlzLl9iaW5kQ2hpbGQocnVsZSwgY2hpbGQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjaGlsZC5oYXNPd25Qcm9wZXJ0eSgnX19zdXBlcl9fJykpIHsKICAgICAgICB0cnkgewogICAgICAgICAgX2luc3RhbmNlID0gbmV3IGNoaWxkKHsKICAgICAgICAgICAgJ2lzQXV0b1N0YXJ0JzogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgICAgcnVsZSA9IHRoaXMuX2dldENoaWxkUnVsZShfaW5zdGFuY2UsIGNoaWxkUm9vdCk7CiAgICAgICAgICB0aGlzLl9iaW5kQ2hpbGQocnVsZSwgX2luc3RhbmNlKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICAgICAgZSA9IF9lcnJvcjsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigi5byV5pWw44Gu5YCk44GM5LiN5q2j44Gn44GZ44CCIOW8leaVsOOBqOOBl+OBpuS4juOBiOOCieOCjOOCi+OCquODluOCuOOCp+OCr+ODiOOBryBLYXppdG9yaSDjgpLntpnmib/jgZfjgabjgYTjgovlv4XopoHjgYzjgYLjgorjgb7jgZnjgIIiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkFEREVELCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9nZXRDaGlsZFJ1bGUgPSBmdW5jdGlvbihjaGlsZCwgY2hpbGRSb290KSB7CiAgICB2YXIgcnVsZTsKICAgIHJ1bGUgPSBjaGlsZC5yb290OwogICAgaWYgKGNoaWxkUm9vdCkgewogICAgICBydWxlID0gY2hpbGRSb290OwogICAgfQogICAgaWYgKHJ1bGUubWF0Y2godHJhaWxpbmdTbGFzaCkpIHsKICAgICAgcnVsZSA9IHJ1bGUucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICB9CiAgICBpZiAocnVsZSA9PT0gdGhpcy5yb290KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigi44GL44G244Gj44Gm44KLIik7CiAgICB9CiAgICByZXR1cm4gcnVsZTsKICB9OwoKCiAgLyoqCiAgKiDli5XnmoTjgavov73liqDjgZfjgZ/jg6vjg7zjgr/jg7zjgpLliYrpmaTjgZfjgb7jgZnjgIIKICAqIOODq+ODvOOCv+ODvOOBruWJiumZpOOBq+aIkOWKn+OBl+OBn+WgtOWQiOOAgVJFTU9WRUQg44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiAgICAgZm9vID0gbmV3IEZvb1JvdXRlcigpOwogICogICAgIGFwcC5hcHBlbmRSb3V0ZXIoZm9vKTsKICAqICAgICBhcHAucmVtb3ZlUm91dGVyKGZvbyk7CiAgKiBAbWV0aG9kIHJlbW92ZVJvdXRlcgogICogQHBhcmFtIHtPYmplY3R9IGNoaWxkCiAgKiBAcGFyYW0ge1N0cmluZ30gY2hpbGRSb290CiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5yZW1vdmVSb3V0ZXIgPSBmdW5jdGlvbihjaGlsZCwgY2hpbGRSb290KSB7CiAgICB2YXIgZSwgX2luc3RhbmNlOwogICAgaWYgKCFjaGlsZCBpbnN0YW5jZW9mIEtheml0b3JpICYmIHR5cGVvZiBjaGlsZCAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIuW8leaVsOOBruWApOOBjOS4jeato+OBp+OBmeOAgiDlvJXmlbDjgajjgZfjgabkuI7jgYjjgonjgozjgovjgqrjg5bjgrjjgqfjgq/jg4jjga8gS2F6aXRvcmkg44KS57aZ5om/44GX44Gm44GE44KL5b+F6KaB44GM44GC44KK44G+44GZ44CCIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIEtheml0b3JpKSB7CiAgICAgIHRoaXMuX3VuYmluZENoaWxkKGNoaWxkLCBjaGlsZFJvb3QpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGNoaWxkLmhhc093blByb3BlcnR5KCdfX3N1cGVyX18nKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBfaW5zdGFuY2UgPSBuZXcgY2hpbGQoewogICAgICAgICAgICAnaXNBdXRvU3RhcnQnOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLl91bmJpbmRDaGlsZChfaW5zdGFuY2UsIGNoaWxkUm9vdCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgICAgIGUgPSBfZXJyb3I7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIuW8leaVsOOBruWApOOBjOS4jeato+OBp+OBmeOAgiDlvJXmlbDjgajjgZfjgabkuI7jgYjjgonjgozjgovjgqrjg5bjgrjjgqfjgq/jg4jjga8gS2F6aXRvcmkg44KS57aZ5om/44GX44Gm44GE44KL5b+F6KaB44GM44GC44KK44G+44GZ44CCIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5SRU1PVkVELCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl91bmJpbmRDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkLCBjaGlsZFJvb3QpIHsKICAgIHZhciBiZWZvcmVSdWxlLCBpLCBsZW4sIG5ld0JlZm9yZXMsIG5ld0hhbmRsZXJzLCBydWxlLCBydWxlT2JqOwogICAgcnVsZSA9IHRoaXMuX2dldENoaWxkUnVsZShjaGlsZCwgY2hpbGRSb290KTsKICAgIGkgPSAwOwogICAgbGVuID0gdGhpcy5oYW5kbGVycy5sZW5ndGg7CiAgICBuZXdIYW5kbGVycyA9IFtdOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgcnVsZU9iaiA9IHRoaXMuaGFuZGxlcnMuc2hpZnQoKTsKICAgICAgaWYgKChydWxlT2JqLnJ1bGUubWF0Y2gocnVsZSkpID09PSBudWxsKSB7CiAgICAgICAgbmV3SGFuZGxlcnMudW5zaGlmdChydWxlT2JqKTsKICAgICAgfQogICAgICBpKys7CiAgICB9CiAgICB0aGlzLmhhbmRsZXJzID0gbmV3SGFuZGxlcnM7CiAgICBpID0gMDsKICAgIGxlbiA9IHRoaXMuYmVmb3JlSGFuZGxlcnMubGVuZ3RoOwogICAgbmV3QmVmb3JlcyA9IFtdOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgYmVmb3JlUnVsZSA9IHRoaXMuYmVmb3JlSGFuZGxlcnMuc2hpZnQoKTsKICAgICAgaWYgKChiZWZvcmVSdWxlLnJ1bGUubWF0Y2gocnVsZSkpID09PSBudWxsKSB7CiAgICAgICAgbmV3QmVmb3Jlcy51bnNoaWZ0KGJlZm9yZVJ1bGUpOwogICAgICB9CiAgICAgIGkrKzsKICAgIH0KICAgIHRoaXMuYmVmb3JlSGFuZGxlcnMgPSBuZXdCZWZvcmVzOwogIH07CgoKICAvKioKICAqIOODluODqeOCpuOCtuOBi+OCieePvuWcqOOBriBVUkwg44KS6Kqt44G/6L6844G/44G+44GZ44CCCiAgKiBAbWV0aG9kIGxvYWRVUkwKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudE92ZXJyaWRlCiAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUubG9hZFVSTCA9IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUsIG9wdGlvbnMpIHsKICAgIHZhciBmcmFnbWVudDsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1cyA9ICdsb2FkVVJMJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbZnJhZ21lbnRPdmVycmlkZSwgb3B0aW9uc107CiAgICBpZiAodGhpcy5pc1N1c3BlbmQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsKICAgIGlmICh0aGlzLmlzVGVtYWUgPT09IGZhbHNlICYmICh0aGlzLmJlZm9yZUFueXRpbWVIYW5kbGVyIHx8IHRoaXMuYmVmb3JlSGFuZGxlcnMubGVuZ3RoID4gMCkpIHsKICAgICAgdGhpcy5fZXhlY3V0ZUJlZm9yZXMoZnJhZ21lbnQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5leGVjdXRlSGFuZGxlcnMoKTsKICAgIH0KICB9OwoKCiAgLyoqCiAgKiDmjIflrprjgZfjgZ8g5paH5a2X5YiX44Gr5a++5b+c44GX44GfIFVSTCDjg6vjg7zjg6vjgYzoqK3lrprjgZXjgozjgabjgYTjgovjgYvjganjgYbjgYs8YnI+CiAgKiBCb29sZWFuIOOBp+i/lOOBl+OBvuOBmeOAggogICogPGg0PmV4YW1wbGU8L2g0PgogICogICAgIGFwcC5tYXRjaCgnL2hvZ2UnKTsKICAqIEBtZXRob2QgbWF0Y2gKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudAogICogQHJldHVybiB7Qm9vbGVhbn0KICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLm1hdGNoID0gZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgIHZhciBtYXRjaGVkOwogICAgbWF0Y2hlZCA9IHRoaXMuX21hdGNoQ2hlY2soZnJhZ21lbnQsIHRoaXMuaGFuZGxlcnMsIHRydWUpOwogICAgcmV0dXJuIG1hdGNoZWQubGVuZ3RoID4gMDsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlQ29tcGxldGUgPSBmdW5jdGlvbihldmVudCkgewogICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFLCB0aGlzLmJlZm9yZUNvbXBsZXRlKTsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9GQUlMRUQsIHRoaXMuYmVmb3JlRmFpbGVkKTsKICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkJFRk9SRV9FWEVDVVRFRCwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIGlmICh0aGlzLmlzVGVtYWUpIHsKICAgICAgdGhpcy5fdXJsQ2hhbmdlKHRoaXMuZnJhZ21lbnQsIHRoaXMuX2NoYW5nZU9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5leGVjdXRlSGFuZGxlcnMoKTsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2V4ZWN1dGVCZWZvcmVzID0gZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgIHZhciBoYW5kbGVyLCBtYXRjaGVkLCBfaSwgX2xlbjsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1cyA9ICdfZXhlY3V0ZUJlZm9yZXMnOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyA9IFtmcmFnbWVudF07CiAgICB0aGlzLl9iZWZvcmVEZWZmZXIgPSBuZXcgRGVmZmVyZWQoKTsKICAgIGlmICh0aGlzLmJlZm9yZUFueXRpbWVIYW5kbGVyICE9IG51bGwpIHsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLmRlZmZlcmVkKChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihkKSB7CiAgICAgICAgICBfdGhpcy5iZWZvcmVBbnl0aW1lSGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICBkLmV4ZWN1dGUoZCk7CiAgICAgICAgfTsKICAgICAgfSkodGhpcykpOwogICAgfQogICAgbWF0Y2hlZCA9IHRoaXMuX21hdGNoQ2hlY2soZnJhZ21lbnQsIHRoaXMuYmVmb3JlSGFuZGxlcnMpOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtYXRjaGVkLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGhhbmRsZXIgPSBtYXRjaGVkW19pXTsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLmRlZmZlcmVkKGZ1bmN0aW9uKGQpIHsKICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICBkLmV4ZWN1dGUoZCk7CiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fYmVmb3JlRGVmZmVyLmFkZEV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFLCB0aGlzLmJlZm9yZUNvbXBsZXRlKTsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5hZGRFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9GQUlMRUQsIHRoaXMuYmVmb3JlRmFpbGVkKTsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5leGVjdXRlKHRoaXMuX2JlZm9yZURlZmZlcik7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmV4ZWN1dGVIYW5kbGVycyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhhbmRsZXIsIGlzTWF0Y2hlZCwgbWF0Y2gsIG1hdGNoZWQsIF9pLCBfaiwgX2xlbiwgX2xlbjE7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnZXhlY3V0ZUhhbmRsZXJzJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbXTsKICAgIGlmICh0aGlzLmlzU3VzcGVuZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBtYXRjaGVkID0gdGhpcy5fbWF0Y2hDaGVjayh0aGlzLmZyYWdtZW50LCB0aGlzLmhhbmRsZXJzKTsKICAgIGlzTWF0Y2hlZCA9IHRydWU7CiAgICBpZiAobWF0Y2hlZCA9PT0gZmFsc2UgfHwgbWF0Y2hlZC5sZW5ndGggPCAxKSB7CiAgICAgIGlmICh0aGlzLm5vdEZvdW5kICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fbm90Rm91bmQuY2FsbGJhY2sodGhpcy5mcmFnbWVudCk7CiAgICAgIH0KICAgICAgaXNNYXRjaGVkID0gZmFsc2U7CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50Lk5PVF9GT1VORCkpOwogICAgfSBlbHNlIGlmIChtYXRjaGVkLmxlbmd0aCA+IDEpIHsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtYXRjaGVkLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgbWF0Y2ggPSBtYXRjaGVkW19pXTsKICAgICAgICBpZiAodGhpcy5mcmFnbWVudC5pbmRleE9mKG1hdGNoLnJ1bGUpID4gLTEpIHsKICAgICAgICAgIG1hdGNoLmNhbGxiYWNrKHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gbWF0Y2hlZC5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICBoYW5kbGVyID0gbWF0Y2hlZFtfal07CiAgICAgICAgaGFuZGxlci5jYWxsYmFjayh0aGlzLmZyYWdtZW50KTsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuX2lzRmlyc3RSZXF1ZXN0KSB7CiAgICAgIHNldFRpbWVvdXQoKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgX3RoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkZJUlNUX1JFUVVFU1QsIF90aGlzLmZyYWdtZW50LCBudWxsKSk7CiAgICAgICAgICBpZiAoaXNNYXRjaGVkKSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuRVhFQ1VURUQsIF90aGlzLmZyYWdtZW50LCBudWxsKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSkodGhpcyksIDApOwogICAgICB0aGlzLl9pc0ZpcnN0UmVxdWVzdCA9IGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzTWF0Y2hlZCkgewogICAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkVYRUNVVEVELCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbWF0Y2hlZDsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlRmFpbGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHRoaXMuYmVmb3JlRmFpbGVkSGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0ZBSUxFRCwgdGhpcy5iZWZvcmVGYWlsZWQpOwogICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFLCB0aGlzLmJlZm9yZUNvbXBsZXRlKTsKICAgIGlmICh0aGlzLmlzQmVmb3JlRm9yY2UpIHsKICAgICAgdGhpcy5iZWZvcmVDb21wbGV0ZSgpOwogICAgfQogICAgdGhpcy5fYmVmb3JlRGVmZmVyID0gbnVsbDsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUub2JzZXJ2ZVVSTEhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgdmFyIGN1cnJlbnQ7CiAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICB9CiAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAodGhpcy5pZnJhbWUpIHsKICAgICAgdGhpcy5jaGFuZ2UoY3VycmVudCk7CiAgICB9CiAgICBpZiAodGhpcy5sYXN0RnJhZ21lbnQgPT09IGN1cnJlbnQgJiYgdGhpcy5pc1VzZXJBY3Rpb24gPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LlBSRVYsIGN1cnJlbnQsIHRoaXMuZnJhZ21lbnQpKTsKICAgIH0gZWxzZSBpZiAodGhpcy5sYXN0RnJhZ21lbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pc1VzZXJBY3Rpb24gPT09IGZhbHNlKSB7CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50Lk5FWFQsIGN1cnJlbnQsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgICB9CiAgICB0aGlzLmlzVXNlckFjdGlvbiA9IGZhbHNlOwogICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuQ0hBTkdFLCBjdXJyZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgcmV0dXJuIHRoaXMubG9hZFVSTChjdXJyZW50KTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JpbmRSdWxlcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHJvdXRlcywgcnVsZSwgX2ksIF9sZW47CiAgICBpZiAodGhpcy5yb3V0ZXMgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb3V0ZXMgPSB0aGlzLl9rZXlzKHRoaXMucm91dGVzKTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcm91dGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIHJ1bGUgPSByb3V0ZXNbX2ldOwogICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcihydWxlLCB0aGlzLnJvdXRlc1tydWxlXSwgZmFsc2UpOwogICAgfQogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fYmluZEJlZm9yZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciBiZWZvcmVzLCBrZXksIF9pLCBfbGVuOwogICAgaWYgKHRoaXMuYmVmb3JlQW55dGltZSkgewogICAgICB0aGlzLl9iaW5kQmVmb3JlQW55dGltZSh0aGlzLmJlZm9yZUFueXRpbWUpOwogICAgfQogICAgaWYgKHRoaXMuYmVmb3JlcyA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGJlZm9yZXMgPSB0aGlzLl9rZXlzKHRoaXMuYmVmb3Jlcyk7CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGJlZm9yZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAga2V5ID0gYmVmb3Jlc1tfaV07CiAgICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyKGtleSwgdGhpcy5iZWZvcmVzW2tleV0sIHRydWUpOwogICAgfQogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fYmluZEJlZm9yZUFueXRpbWUgPSBmdW5jdGlvbihmdW5jcywgYmluZGVkRnVuY3MpIHsKICAgIHZhciBjYWxsYmFjazsKICAgIGNhbGxiYWNrID0gdGhpcy5fYmluZEZ1bmN0aW9ucyhmdW5jcywgYmluZGVkRnVuY3MpOwogICAgdGhpcy5iZWZvcmVBbnl0aW1lSGFuZGxlciA9IHsKICAgICAgY2FsbGJhY2s6IHRoaXMuX2JpbmRlcihmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzOwogICAgICAgIGFyZ3MgPSBbZnJhZ21lbnRdOwogICAgICAgIHJldHVybiBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfSwgdGhpcykKICAgIH07CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iaW5kTm90Rm91bmQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgbm90Rm91bmRGcmFnbWVudCwgbm90Rm91bmRGdW5jTmFtZSwgcnVsZSwgX2ksIF9sZW4sIF9yZWY7CiAgICBpZiAodGhpcy5ub3RGb3VuZCA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0eXBlb2YgdGhpcy5ub3RGb3VuZCA9PT0gInN0cmluZyIpIHsKICAgICAgX3JlZiA9IHRoaXMuaGFuZGxlcnM7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIHJ1bGUgPSBfcmVmW19pXTsKICAgICAgICBpZiAocnVsZS5ydWxlID09PSAnLycgKyB0aGlzLm5vdEZvdW5kLnJlcGxhY2UodGhpcy5yb290LCAnJykpIHsKICAgICAgICAgIHRoaXMuX25vdEZvdW5kID0gcnVsZTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG5vdEZvdW5kRnJhZ21lbnQgPSB0aGlzLl9rZXlzKHRoaXMubm90Rm91bmQpWzBdOwogICAgfQogICAgbm90Rm91bmRGdW5jTmFtZSA9IHRoaXMubm90Rm91bmRbbm90Rm91bmRGcmFnbWVudF07CiAgICBpZiAodHlwZW9mIG5vdEZvdW5kRnVuY05hbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2FsbGJhY2sgPSBub3RGb3VuZEZ1bmNOYW1lOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSB0aGlzW25vdEZvdW5kRnVuY05hbWVdOwogICAgfQogICAgdGhpcy5fbm90Rm91bmQgPSBuZXcgUnVsZShub3RGb3VuZEZyYWdtZW50LCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICB2YXIgYXJnczsKICAgICAgYXJncyA9IHRoaXMucm91dGVyLmV4dHJhY3RQYXJhbXModGhpcywgZnJhZ21lbnQpOwogICAgICByZXR1cm4gY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcy5yb3V0ZXIsIGFyZ3MpOwogICAgfSwgdGhpcyk7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl91cGRhdGVIYXNoID0gZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICB2YXIgYXRSb290LCBocmVmOwogICAgYXRSb290ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKICAgIGlmICghYXRSb290KSB7CiAgICAgIGxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgZnJhZ21lbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocmVwbGFjZSkgewogICAgICBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgIH0gZWxzZSB7CiAgICAgIGxvY2F0aW9uLmhhc2ggPSAiIyIgKyBmcmFnbWVudDsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3VwZGF0ZUhhc2hJRSA9IGZ1bmN0aW9uKGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICBsb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjLycgKyBmcmFnbWVudCk7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9tYXRjaENoZWNrID0gZnVuY3Rpb24oZnJhZ21lbnQsIGhhbmRsZXJzLCB0ZXN0KSB7CiAgICB2YXIgYSwgYXJncywgYXJnc01hdGNoLCBhcmdzTWF0Y2hlZCwgaGFuZGxlciwgaGFzUXVlcnksIGksIGxlbiwgbWF0Y2gsIG1hdGNoZWQsIHQsIHRtcEZyYWcsIF9pLCBfaiwgX2xlbiwgX2xlbjE7CiAgICBpZiAodGVzdCA9PSBudWxsKSB7CiAgICAgIHRlc3QgPSBmYWxzZTsKICAgIH0KICAgIG1hdGNoZWQgPSBbXTsKICAgIHRtcEZyYWcgPSBmcmFnbWVudDsKICAgIGlmICh0bXBGcmFnICE9PSB2b2lkIDAgJiYgdG1wRnJhZyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgaGFzUXVlcnkgPSB0aGlzLl9tYXRjaC5hcHBseSh0bXBGcmFnLCBbLyhcP1tcd1xkPXxdKykvZ10pOwogICAgfQogICAgaWYgKGhhc1F1ZXJ5KSB7CiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQuc3BsaXQoJz8nKVswXTsKICAgIH0KICAgIGZvciAoX2kgPSAwLCBfbGVuID0gaGFuZGxlcnMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgaGFuZGxlciA9IGhhbmRsZXJzW19pXTsKICAgICAgaWYgKGhhbmRsZXIucnVsZSA9PT0gZnJhZ21lbnQpIHsKICAgICAgICBtYXRjaGVkLnB1c2goaGFuZGxlcik7CiAgICAgIH0gZWxzZSBpZiAoaGFuZGxlci50ZXN0KGZyYWdtZW50KSkgewogICAgICAgIGlmIChoYW5kbGVyLmlzVmFyaWFibGUgJiYgaGFuZGxlci50eXBlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBhcmdzID0gdGhpcy5leHRyYWN0UGFyYW1zKGhhbmRsZXIsIGZyYWdtZW50LCB0ZXN0KTsKICAgICAgICAgIGFyZ3NNYXRjaCA9IFtdOwogICAgICAgICAgbGVuID0gYXJncy5sZW5ndGg7CiAgICAgICAgICBpID0gMDsKICAgICAgICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgICAgICAgIGEgPSBhcmdzW2ldOwogICAgICAgICAgICB0ID0gaGFuZGxlci50eXBlc1tpXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGlmICh0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhcmdzTWF0Y2gucHVzaCh0cnVlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJnc01hdGNoLnB1c2godGhpcy5fdHlwZUNoZWNrKGEsIHQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgICAgfQogICAgICAgICAgYXJnc01hdGNoZWQgPSB0cnVlOwogICAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gYXJnc01hdGNoLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICAgICAgICBtYXRjaCA9IGFyZ3NNYXRjaFtfal07CiAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICBhcmdzTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJnc01hdGNoZWQpIHsKICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGhhbmRsZXIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaGVkLnB1c2goaGFuZGxlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAobWF0Y2hlZC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CgoKICAvKioKICAqIFVSTCDjg6vjg7zjg4jku6XkuIvjgpLlj5blvpcKICAqIEBtZXRob2QgZ2V0RnJhZ21lbnQKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuZ2V0RnJhZ21lbnQgPSBmdW5jdGlvbihmcmFnbWVudCkgewogICAgdmFyIGZyYWcsIGluZGV4LCBtYXRjaGVkLCByb290LCBfaSwgX2xlbiwgX3JlZjsKICAgIGlmICgoZnJhZ21lbnQgPT0gbnVsbCkgfHwgZnJhZ21lbnQgPT09IHZvaWQgMCkgewogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50Q2hhbmdlSGFzaCkgewogICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICBtYXRjaGVkID0gZmFsc2U7CiAgICAgICAgZnJhZyA9IGZyYWdtZW50OwogICAgICAgIGlmIChmcmFnLm1hdGNoKC9eXC8vKSkgewogICAgICAgICAgZnJhZyA9IGZyYWcuc3Vic3RyKDEpOwogICAgICAgIH0KICAgICAgICByb290ID0gdGhpcy5yb290OwogICAgICAgIGlmIChyb290Lm1hdGNoKC9eXC8vKSkgewogICAgICAgICAgcm9vdCA9IHJvb3Quc3Vic3RyKDEpOwogICAgICAgIH0KICAgICAgICBfcmVmID0gdGhpcy5yb290RmlsZXM7CiAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBpbmRleCA9IF9yZWZbX2ldOwogICAgICAgICAgaWYgKGluZGV4ID09PSBmcmFnIHx8IHJvb3QgKyBpbmRleCA9PT0gZnJhZykgewogICAgICAgICAgICBtYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoZWQpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5yb290OwogICAgICAgIH0KICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2g7CiAgICAgICAgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICBpZiAoZnJhZ21lbnQuaW5kZXhPZihyb290KSA+IC0xKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnN1YnN0cihyb290Lmxlbmd0aCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgIGlmIChmcmFnbWVudC5pbmRleE9mKHRoaXMucm9vdCkgPiAtMSAmJiBmcmFnbWVudC5pbmRleE9mKHJvb3QpID4gLTEpIHsKICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnN1YnN0cihyb290Lmxlbmd0aCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0eXBlb2YgZnJhZ21lbnQgPT09ICJzdHJpbmciKSB7CiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgIGlmIChmcmFnbWVudCA9PT0gIiIpIHsKICAgICAgICBmcmFnbWVudCA9ICIvIjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZyYWdtZW50OwogIH07CgoKICAvKioKICAqIFVSTCDjga4gIyDku6XpmY3jgpLlj5blvpcKICAqIEBtZXRob2QgZ2V0SGFzaAogICogQHJldHVybiB7U3RyaW5nfSBVUkwg44GuICMg5Lul6ZmN44Gu5paH5a2X5YiXCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5nZXRIYXNoID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbWF0Y2g7CiAgICBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICBpZiAobWF0Y2ggIT0gbnVsbCkgewogICAgICByZXR1cm4gbWF0Y2hbMV07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKCgogIC8qKgogICogVVJMIOODkeODqeODoeODvOOCv+OCkuWIhuinowogICogQG1ldGhvZCBleHRyYWN0UGFyYW1zCiAgKiBAcGFyYW0ge1J1bGV9IHJ1bGUKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudAogICogQHBhcmFtIHtCb29sZWFufSB0ZXN0CiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5leHRyYWN0UGFyYW1zID0gZnVuY3Rpb24ocnVsZSwgZnJhZ21lbnQsIHRlc3QpIHsKICAgIHZhciBrLCBrdiwgbGFzdCwgbmV3UGFyYW0sIG5ld1F1ZXJpZXMsIHBhcmFtLCBxLCBxdWVyaWVzLCBxdWVyeSwgcXVlcnlQYXJhbXMsIHYsIF9pLCBfbGVuOwogICAgaWYgKHRlc3QgPT0gbnVsbCkgewogICAgICB0ZXN0ID0gZmFsc2U7CiAgICB9CiAgICBpZiAodGhpcy5fcGFyYW1zLnBhcmFtcy5sZW5ndGggPiAwICYmIHRoaXMuX3BhcmFtcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmFtcy5wYXJhbXM7CiAgICB9CiAgICBwYXJhbSA9IHJ1bGUuX3JlZ2V4cC5leGVjKGZyYWdtZW50KTsKICAgIGlmIChwYXJhbSA9PT0gbnVsbCAmJiBmcmFnbWVudC5pbmRleE9mKCc/JykgPiAtMSkgewogICAgICBwYXJhbSA9IFswLCAnPycgKyBmcmFnbWVudC5zcGxpdCgnPycpWzFdXTsKICAgIH0KICAgIHRoaXMuX3BhcmFtcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgaWYgKHBhcmFtICE9IG51bGwpIHsKICAgICAgbmV3UGFyYW0gPSBwYXJhbS5zbGljZSgxKTsKICAgICAgbGFzdCA9IHBhcmFtW3BhcmFtLmxlbmd0aCAtIDFdOwogICAgICBpZiAobGFzdC5pbmRleE9mKCc/JykgPiAtMSkgewogICAgICAgIG5ld1F1ZXJpZXMgPSB7fTsKICAgICAgICBxdWVyaWVzID0gbGFzdC5zcGxpdCgnPycpWzFdOwogICAgICAgIHF1ZXJ5UGFyYW1zID0gcXVlcmllcy5zcGxpdCgnJicpOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcXVlcnlQYXJhbXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgIHF1ZXJ5ID0gcXVlcnlQYXJhbXNbX2ldOwogICAgICAgICAga3YgPSBxdWVyeS5zcGxpdCgnPScpOwogICAgICAgICAgayA9IGt2WzBdOwogICAgICAgICAgdiA9IGt2WzFdID8ga3ZbMV0gOiAiIjsKICAgICAgICAgIGlmICh2LmluZGV4T2YoJ3wnKSA+IC0xKSB7CiAgICAgICAgICAgIHYgPSB2LnNwbGl0KCJ8Iik7CiAgICAgICAgICB9CiAgICAgICAgICBuZXdRdWVyaWVzW2tdID0gdjsKICAgICAgICB9CiAgICAgICAgbmV3UGFyYW0ucG9wKCk7CiAgICAgICAgbmV3UGFyYW0ucHVzaChsYXN0LnNwbGl0KCc/JylbMF0pOwogICAgICAgIHEgPSB7CiAgICAgICAgICAicXVlcmllcyI6IG5ld1F1ZXJpZXMKICAgICAgICB9OwogICAgICAgIG5ld1BhcmFtLnB1c2gocSk7CiAgICAgICAgaWYgKCF0ZXN0KSB7CiAgICAgICAgICB0aGlzLl9wYXJhbXMucGFyYW1zID0gdGhpcy5fZ2V0Q2FzdGVkUGFyYW1zKHJ1bGUsIG5ld1BhcmFtLnNsaWNlKDApKTsKICAgICAgICAgIHRoaXMuX3BhcmFtcy5xdWVyaWVzID0gbmV3UXVlcmllczsKICAgICAgICAgIGlmICh0aGlzLmlzT2xkSUUpIHsKICAgICAgICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLl9wYXJhbXMucGFyYW1zOwogICAgICAgICAgICB0aGlzLnF1ZXJpZXMgPSB0aGlzLl9wYXJhbXMucXVlcmllczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0ZXN0KSB7CiAgICAgICAgICB0aGlzLl9wYXJhbXMucGFyYW1zID0gdGhpcy5fZ2V0Q2FzdGVkUGFyYW1zKHJ1bGUsIG5ld1BhcmFtKTsKICAgICAgICAgIGlmICh0aGlzLmlzT2xkSUUpIHsKICAgICAgICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLl9wYXJhbXMucGFyYW1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3UGFyYW07CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9wYXJhbXMucGFyYW1zID0gW107CiAgICAgIGlmICh0aGlzLmlzT2xkSUUpIHsKICAgICAgICB0aGlzLnBhcmFtID0gW107CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9nZXRDYXN0ZWRQYXJhbXMgPSBmdW5jdGlvbihydWxlLCBwYXJhbXMpIHsKICAgIHZhciBjYXN0ZWRQYXJhbXMsIGksIGxlbiwgdHlwZSwgX2ksIF9sZW47CiAgICBpID0gMDsKICAgIGlmICghcGFyYW1zKSB7CiAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9CiAgICBpZiAocnVsZS50eXBlcy5sZW5ndGggPCAxKSB7CiAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9CiAgICBsZW4gPSBwYXJhbXMubGVuZ3RoOwogICAgY2FzdGVkUGFyYW1zID0gW107CiAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICBpZiAocnVsZS50eXBlc1tpXSA9PT0gbnVsbCkgewogICAgICAgIGNhc3RlZFBhcmFtcy5wdXNoKHBhcmFtc1tpXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhcmFtc1tpXSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBjYXN0ZWRQYXJhbXMucHVzaChwYXJhbXNbaV0pOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gVkFSSUFCTEVfVFlQRVMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgIHR5cGUgPSBWQVJJQUJMRV9UWVBFU1tfaV07CiAgICAgICAgICBpZiAocnVsZS50eXBlc1tpXSA9PT0gdHlwZS5uYW1lKSB7CiAgICAgICAgICAgIGNhc3RlZFBhcmFtcy5wdXNoKHR5cGUuY2FzdChwYXJhbXNbaV0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaSsrOwogICAgfQogICAgcmV0dXJuIGNhc3RlZFBhcmFtczsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB0aGlzLl9kaXNwYXRjaGVyLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5yZW1vdmVFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHRoaXMuX2Rpc3BhdGNoZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcik7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmRpc3BhdGNoRXZlbnQgPSBmdW5jdGlvbihldmVudCkgewogICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2FkZFBvcFN0YXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHdpbjsKICAgIHdpbiA9IHdpbmRvdzsKICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgPT09IHRydWUpIHsKICAgICAgd2luLmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5vYnNlcnZlVVJMSGFuZGxlcik7CiAgICB9CiAgICBpZiAodGhpcy5fd2FudENoYW5nZUhhc2ggPT09IHRydWUgJiYgIXRoaXMuaXNPbGRJRSkgewogICAgICB3aW4uYWRkRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgfSBlbHNlIGlmICh0aGlzLl93YW50Q2hhbmdlSGFzaCA9PT0gdHJ1ZSkgewogICAgICB3aW4uYXR0YWNoRXZlbnQoJ29uaGFzaGNoYW5nZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgfQogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fcmVtb3ZlUG9wU3RhdGVIYW5kbGVyID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgd2luOwogICAgd2luID0gd2luZG93OwogICAgd2luLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5vYnNlcnZlVVJMSGFuZGxlcik7CiAgICB3aW4ucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgaWYgKHRoaXMuaXNPbGRJRSkgewogICAgICB3aW4uZGV0YWNoRXZlbnQoJ29uaGFzaGNoYW5nZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgfQogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgogIEtheml0b3JpLnByb3RvdHlwZS5fcmVwbGFjZSA9IFN0cmluZy5wcm90b3R5cGUucmVwbGFjZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9tYXRjaCA9IFN0cmluZy5wcm90b3R5cGUubWF0Y2g7CgogIEtheml0b3JpLnByb3RvdHlwZS5fa2V5cyA9IE9iamVjdC5rZXlzIHx8IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleSwga2V5czsKICAgIGlmIChvYmogPT09ICFPYmplY3Qob2JqKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdvYmplY3QgamEgbmFpJyk7CiAgICB9CiAgICBrZXlzID0gW107CiAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICAgIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgICB9CiAgICB9CiAgICByZXR1cm4ga2V5czsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JpbmRlciA9IGZ1bmN0aW9uKGZ1bmMsIG9iaikgewogICAgdmFyIGFyZ3MsIHNsaWNlOwogICAgc2xpY2UgPSB0aGlzLl9zbGljZTsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iaiB8fCB7fSwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CiAgICB0aGlzLl9lYWNoKHRoaXMuX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIHZhciBwcm9wLCBfcmVzdWx0czsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIF9yZXN1bHRzID0gW107CiAgICAgICAgZm9yIChwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgX3Jlc3VsdHMucHVzaChvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2VhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXIsIGN0eCkgewogICAgdmFyIGVhY2gsIGksIGssIGw7CiAgICBpZiAob2JqID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoOwogICAgaWYgKGVhY2ggJiYgb2JqLmZvckVhY2ggPT09IGVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlciwgY3R4KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgaSA9IDA7CiAgICAgIGwgPSBvYmoubGVuZ3RoOwogICAgICB3aGlsZSAoaSA8IGwpIHsKICAgICAgICBpZiAoaXRlci5jYWxsKGN0eCwgb2JqW2ldLCBpLCBvYmopID09PSB0aGlzLmJyZWFrZXIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaSsrOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGsgaW4gb2JqKSB7CiAgICAgICAgaWYgKF9faW5kZXhPZi5jYWxsKG9iaiwgaykgPj0gMCkgewogICAgICAgICAgaWYgKGl0ZXIuY2FsbChjdHgsIG9ialtrXSwgaywgb2JqKSA9PT0gdGhpcy5icmVha2VyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JpbmRGdW5jdGlvbnMgPSBmdW5jdGlvbihmdW5jcywgaW5zZXJ0KSB7CiAgICB2YXIgYmluZGVkRnVuY3MsIGNhbGxiYWNrLCBmLCBmdW5jLCBmdW5jTmFtZSwgaSwgbGVuLCBuYW1lcywgbmV3RiwgX2ksIF9sZW47CiAgICBpZiAodHlwZW9mIGZ1bmNzID09PSAnc3RyaW5nJykgewogICAgICBmdW5jcyA9IGZ1bmNzLnNwbGl0KCcsJyk7CiAgICB9CiAgICBiaW5kZWRGdW5jcyA9IFtdOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBmdW5jcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICBmdW5jTmFtZSA9IGZ1bmNzW19pXTsKICAgICAgZnVuYyA9IHRoaXNbZnVuY05hbWVdOwogICAgICBpZiAoZnVuYyA9PSBudWxsKSB7CiAgICAgICAgbmFtZXMgPSBmdW5jTmFtZS5zcGxpdCgnLicpOwogICAgICAgIGlmIChuYW1lcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICBmID0gd2luZG93W25hbWVzWzBdXTsKICAgICAgICAgIGkgPSAxOwogICAgICAgICAgbGVuID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgICAgICAgbmV3RiA9IGZbbmFtZXNbaV1dOwogICAgICAgICAgICBpZiAobmV3RiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZiA9IG5ld0Y7CiAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jID0gZjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnVuYyA9IHdpbmRvd1tmdW5jTmFtZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmdW5jICE9IG51bGwpIHsKICAgICAgICBiaW5kZWRGdW5jcy5wdXNoKGZ1bmMpOwogICAgICB9CiAgICB9CiAgICBpZiAoaW5zZXJ0KSB7CiAgICAgIGJpbmRlZEZ1bmNzID0gaW5zZXJ0LmNvbmNhdChiaW5kZWRGdW5jcyk7CiAgICB9CiAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncywgX2osIF9sZW4xOwogICAgICBhcmdzID0gMSA8PSBhcmd1bWVudHMubGVuZ3RoID8gX19zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkgOiBbXTsKICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gYmluZGVkRnVuY3MubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgICAgZnVuYyA9IGJpbmRlZEZ1bmNzW19qXTsKICAgICAgICBmdW5jLmFwcGx5KHRoaXMsIF9fc2xpY2UuY2FsbChhcmdzKSk7CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl90eXBlQ2hlY2sgPSBmdW5jdGlvbihhLCB0KSB7CiAgICB2YXIgbWF0Y2hlZCwgdHlwZSwgX2ksIF9sZW47CiAgICBtYXRjaGVkID0gZmFsc2U7CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IFZBUklBQkxFX1RZUEVTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIHR5cGUgPSBWQVJJQUJMRV9UWVBFU1tfaV07CiAgICAgIGlmICh0LnRvTG93ZXJDYXNlKCkgPT09IHR5cGUubmFtZSkgewogICAgICAgIGlmICh0eXBlLmNhc3QoYSkpIHsKICAgICAgICAgIG1hdGNoZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hdGNoZWQ7CiAgfTsKCiAgcmV0dXJuIEtheml0b3JpOwoKfSkoKTsKCgovKioKKiBwdXNoU3RhdGUg44Gn5Yem55CG44GX44Gf44GE44Or44O844Or44KS5a6a576p44GZ44KL44Kv44Op44K5CioKKiBAY2xhc3MgUnVsZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7U3RyaW5nfSBydWxlCiogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKKiBAcGFyYW0ge0theml0b3JpfSByb3V0ZXIKICovCgpSdWxlID0gKGZ1bmN0aW9uKCkgewoKICAvKioKICAqIOODq+ODvOODq+aWh+Wtl+WIlwogICogQHByb3BlcnR5IHJ1bGUKICAqIEB0eXBlIFN0cmluZwogICogQGRlZmF1bHQgIiIKICAgKi8KICBSdWxlLnByb3RvdHlwZS5ydWxlID0gIiI7CgogIFJ1bGUucHJvdG90eXBlLl9yZWdleHAgPSBudWxsOwoKCiAgLyoqCiAgKiDjgrPjg7zjg6vjg5Djg4Pjgq/plqLmlbAKICAqIOODq+ODvOODq+OBqOODnuODg+ODgeOBmeOCi+WgtOWQiOWun+ihjOOBleOCjOOBvuOBmeOAggogICogQHByb3BlcnR5IGNhbGxiYWNrCiAgKiBAdHlwZTogRnVuY3Rpb24KICAqIEBkZWZhdWx0IG51bGwKICAgKi8KCiAgUnVsZS5wcm90b3R5cGUuY2FsbGJhY2sgPSBudWxsOwoKICBSdWxlLnByb3RvdHlwZS5uYW1lID0gIiI7CgogIFJ1bGUucHJvdG90eXBlLnJvdXRlciA9IG51bGw7CgogIFJ1bGUucHJvdG90eXBlLmlzVmFyaWFibGUgPSBmYWxzZTsKCiAgUnVsZS5wcm90b3R5cGUudHlwZXMgPSBbXTsKCiAgZnVuY3Rpb24gUnVsZShydWxlLCBjYWxsYmFjaywgcm91dGVyKSB7CiAgICB0aGlzLnVwZGF0ZSA9IF9fYmluZCh0aGlzLnVwZGF0ZSwgdGhpcyk7CiAgICBpZiAodHlwZW9mIHJ1bGUgIT09ICJzdHJpbmciICYmIHR5cGVvZiBydWxlICE9PSAiTnVtYmVyIikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLnJvdXRlciA9IHJvdXRlcjsKICAgIHRoaXMudXBkYXRlKHJ1bGUpOwogIH0KCgogIC8qKgogICogUnVsZSDjgajjgZfjgablrprnvqnjgZfjgZ/jg5Hjgr/jg7zjg7PjgaggZnJhZ21lbnQg44Go44GX44Gm5LiO44GI44KJ44KM44Gf5paH5a2X5YiX44GM44Oe44OD44OB44GZ44KL44GL44Gp44GG44GL44OG44K544OI44GZ44KLCiAgKiBAbWV0aG9kIHRlc3QKICAqIEBwYXJhbSB7U3RyaW5nfSBmcmFnbWVudAogICogQHJldHVybiB7Qm9vbGVhbn0g44Oe44OD44OB44GZ44KL5aC05ZCIIHRydWUg44KS6L+U44GZCiAgICovCgogIFJ1bGUucHJvdG90eXBlLnRlc3QgPSBmdW5jdGlvbihmcmFnbWVudCkgewogICAgcmV0dXJuIHRoaXMuX3JlZ2V4cC50ZXN0KGZyYWdtZW50KTsKICB9OwoKICBSdWxlLnByb3RvdHlwZS5fcnVsZVRvUmVnRXhwID0gZnVuY3Rpb24ocnVsZSkgewogICAgdmFyIG5ld1J1bGU7CiAgICBuZXdSdWxlID0gcnVsZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKS5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykucmVwbGFjZShuYW1lZFBhcmFtLCAnKFteXC9dKyknKS5yZXBsYWNlKHNwbGF0UGFyYW0sICcoLio/KScpOwogICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgbmV3UnVsZSArICckJyk7CiAgfTsKCgogIC8qKgogICog5LiO44GI44KJ44KM44GfIHBhdGgg44Gn54++5Zyo44GuIFJ1bGUg44KS44Ki44OD44OX44OH44O844OI44GX44G+44GZ44CCCiAgKiBAbWV0aG9kIHVwZGF0ZQogICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKi8KCiAgUnVsZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24ocGF0aCkgewogICAgdmFyIG0sIG1hdGNoZWQsIHJlLCB0LCBfaSwgX2xlbjsKICAgIHRoaXMucnVsZSA9IHBhdGggKyB0aGlzLnJ1bGU7CiAgICBpZiAodGhpcy5ydWxlICE9PSAnLycpIHsKICAgICAgdGhpcy5ydWxlID0gdGhpcy5ydWxlLnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgfQogICAgdGhpcy5fcmVnZXhwID0gdGhpcy5fcnVsZVRvUmVnRXhwKHRoaXMucnVsZSk7CiAgICByZSA9IG5ldyBSZWdFeHAobmFtZWRQYXJhbSk7CiAgICBtYXRjaGVkID0gcGF0aC5tYXRjaChyZSk7CiAgICBpZiAobWF0Y2hlZCAhPT0gbnVsbCkgewogICAgICB0aGlzLmlzVmFyaWFibGUgPSB0cnVlOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IG1hdGNoZWQubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBtID0gbWF0Y2hlZFtfaV07CiAgICAgICAgdCA9IG0ubWF0Y2goZ2VuZXJpY1BhcmFtKSB8fCBudWxsOwogICAgICAgIHRoaXMudHlwZXMucHVzaCh0ICE9PSBudWxsID8gdFsxXSA6IG51bGwpOwogICAgICB9CiAgICB9CiAgfTsKCiAgcmV0dXJuIFJ1bGU7Cgp9KSgpOwoKCi8qKgoqIOOCpOODmeODs+ODiOODh+OCo+OCueODkeODg+ODgeODowoqIEBjbGFzcyBFdmVudERpc3BhdGNoZXIKKiBAY29uc3RydWN0b3IKICovCgpFdmVudERpc3BhdGNoZXIgPSAoZnVuY3Rpb24oKSB7CiAgZnVuY3Rpb24gRXZlbnREaXNwYXRjaGVyKCkge30KCiAgRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSB7fTsKCiAgRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZS5hZGRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICh0aGlzLmxpc3RlbmVyc1t0eXBlXSA9PT0gdm9pZCAwKSB7CiAgICAgIHRoaXMubGlzdGVuZXJzW3R5cGVdID0gW107CiAgICB9CiAgICBpZiAodGhpcy5faW5BcnJheShsaXN0ZW5lciwgdGhpcy5saXN0ZW5lcnNbdHlwZV0pIDwgMCkgewogICAgICB0aGlzLmxpc3RlbmVyc1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgIH0KICB9OwoKICBFdmVudERpc3BhdGNoZXIucHJvdG90eXBlLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIGFyciwgaSwgbGVuLCBwcm9wOwogICAgbGVuID0gMDsKICAgIGZvciAocHJvcCBpbiB0aGlzLmxpc3RlbmVycykgewogICAgICBsZW4rKzsKICAgIH0KICAgIGlmIChsZW4gPCAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGFyciA9IHRoaXMubGlzdGVuZXJzW3R5cGVdOwogICAgaWYgKCFhcnIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaSA9IDA7CiAgICBsZW4gPSBhcnIubGVuZ3RoOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgaWYgKGFycltpXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICBpZiAobGVuID09PSAxKSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFyci5zcGxpY2UoaSwgMSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGkrKzsKICAgIH0KICB9OwoKICBFdmVudERpc3BhdGNoZXIucHJvdG90eXBlLmRpc3BhdGNoRXZlbnQgPSBmdW5jdGlvbihldmVudCkgewogICAgdmFyIGFyeSwgaGFuZGxlciwgX2ksIF9sZW47CiAgICBhcnkgPSB0aGlzLmxpc3RlbmVyc1tldmVudC50eXBlXTsKICAgIGlmIChhcnkgIT09IHZvaWQgMCkgewogICAgICBldmVudC50YXJnZXQgPSB0aGlzOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGFyeS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGhhbmRsZXIgPSBhcnlbX2ldOwogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgIH0KICB9OwoKICBFdmVudERpc3BhdGNoZXIucHJvdG90eXBlLl9pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXkpIHsKICAgIHZhciBpLCBsZW47CiAgICBpID0gMDsKICAgIGxlbiA9IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIGlmIChhcnJheVtpXSA9PT0gZWxlbSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICAgIGkrKzsKICAgIH0KICAgIHJldHVybiAtMTsKICB9OwoKICByZXR1cm4gRXZlbnREaXNwYXRjaGVyOwoKfSkoKTsKCkRlZmZlcmVkID0gKGZ1bmN0aW9uKF9zdXBlcikgewogIF9fZXh0ZW5kcyhEZWZmZXJlZCwgX3N1cGVyKTsKCiAgRGVmZmVyZWQucHJvdG90eXBlLnF1ZXVlID0gW107CgogIERlZmZlcmVkLnByb3RvdHlwZS5pc1N1c3BlbmQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gRGVmZmVyZWQoKSB7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICB0aGlzLmlzU3VzcGVuZCA9IGZhbHNlOwogIH0KCiAgRGVmZmVyZWQucHJvdG90eXBlLmRlZmZlcmVkID0gZnVuY3Rpb24oZnVuYykgewogICAgdGhpcy5xdWV1ZS5wdXNoKGZ1bmMpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgRGVmZmVyZWQucHJvdG90eXBlLmV4ZWN1dGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBlcnJvciwgdGFzazsKICAgIGlmICh0aGlzLmlzU3VzcGVuZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICB0YXNrID0gdGhpcy5xdWV1ZS5zaGlmdCgpOwogICAgICBpZiAodGFzaykgewogICAgICAgIHRhc2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBpZiAodGhpcy5xdWV1ZS5sZW5ndGggPCAxKSB7CiAgICAgICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFKSk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICBlcnJvciA9IF9lcnJvcjsKICAgICAgcmV0dXJuIHRoaXMucmVqZWN0KGVycm9yKTsKICAgIH0KICB9OwoKICBEZWZmZXJlZC5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgIHZhciBtZXNzYWdlOwogICAgbWVzc2FnZSA9ICFlcnJvciA/ICJ1c2VyIHJlamVjdCIgOiBlcnJvcjsKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7CiAgICAgIHR5cGU6IEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9GQUlMRUQsCiAgICAgIGluZGV4OiB0aGlzLmluZGV4LAogICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICB9KTsKICAgIHRoaXMuaXNTdXNwZW5kID0gZmFsc2U7CiAgfTsKCiAgRGVmZmVyZWQucHJvdG90eXBlLnN1c3BlbmQgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaXNTdXNwZW5kID0gdHJ1ZTsKICB9OwoKICBEZWZmZXJlZC5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmlzU3VzcGVuZCA9IGZhbHNlOwogICAgdGhpcy5leGVjdXRlKCk7CiAgfTsKCiAgcmV0dXJuIERlZmZlcmVkOwoKfSkoRXZlbnREaXNwYXRjaGVyKTsKCgovKioKKiBwdXNoU3RhdGUg5Yem55CG44KEIEtheml0b3JpIOOBq+OBvuOBpOOCj+OCi+OCpOODmeODs+ODiAoqIEBjbGFzcyBLYXppdG9yaUV2ZW50CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtTdHJpbmd9IHR5cGUKKiBAcGFyYW0ge1N0cmluZ30gbmV4dAoqIEBwYXJhbSB7U3RyaW5nfSBwcmV2CiAqLwoKS2F6aXRvcmlFdmVudCA9IChmdW5jdGlvbigpIHsKICBLYXppdG9yaUV2ZW50LnByb3RvdHlwZS5uZXh0ID0gbnVsbDsKCiAgS2F6aXRvcmlFdmVudC5wcm90b3R5cGUucHJldiA9IG51bGw7CgogIEtheml0b3JpRXZlbnQucHJvdG90eXBlLnR5cGUgPSBudWxsOwoKICBmdW5jdGlvbiBLYXppdG9yaUV2ZW50KHR5cGUsIG5leHQsIHByZXYpIHsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLm5leHQgPSBuZXh0OwogICAgdGhpcy5wcmV2ID0gcHJldjsKICB9CgogIEtheml0b3JpRXZlbnQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IEtheml0b3JpRXZlbnQodGhpcy50eXBlLCB0aGlzLm5leHQsIHRoaXMucHJldik7CiAgfTsKCiAgS2F6aXRvcmlFdmVudC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiAiS2F6aXRvcmlFdmVudCA6OiAiICsgInR5cGU6IiArIHRoaXMudHlwZSArICIgbmV4dDoiICsgU3RyaW5nKHRoaXMubmV4dCkgKyAiIHByZXY6IiArIFN0cmluZyh0aGlzLnByZXYpOwogIH07CgogIHJldHVybiBLYXppdG9yaUV2ZW50OwoKfSkoKTsKCgovKioKKiDjgr/jgrnjgq/jgq3jg6Xjg7zjgYznqbrjgavjgarjgaPjgZ8KKiBAcHJvcGVydHkgVEFTS19RVUVVRV9DT01QTEVURQoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHRhc2tfcXVldWVfY29tcGxldGUKICovCgpLYXppdG9yaUV2ZW50LlRBU0tfUVVFVUVfQ09NUExFVEUgPSAndGFza19xdWV1ZV9jb21wbGV0ZSc7CgoKLyoqCiog44K/44K544Kv44Kt44Ol44O844GM5Lit5pat44GV44KM44GfCiogQHByb3BlcnR5IFRBU0tfUVVFVUVfRkFJTEVECiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgdGFza19xdWV1ZV9mYWlsZWQKICovCgpLYXppdG9yaUV2ZW50LlRBU0tfUVVFVUVfRkFJTEVEID0gJ3Rhc2tfcXVldWVfZmFpbGVkJzsKCgovKioKKiBVUkwg44GM5aSJ5pu044GV44KM44GfCiogQHByb3BlcnR5IENIQU5HRQoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGNoYW5nZQogKi8KCktheml0b3JpRXZlbnQuQ0hBTkdFID0gJ2NoYW5nZSc7CgoKLyoqCiogVVJMIOOBq+eZu+mMsuOBleOCjOOBn+ODoeOCveODg+ODieOBjOOBoeOCg+OCk+OBqOWun+ihjOOBleOCjOOBnwoqIEBwcm9wZXJ0eSBFWEVDVVRFRAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGV4ZWN1dGVkCiAqLwoKS2F6aXRvcmlFdmVudC5FWEVDVVRFRCA9ICdleGVjdXRlZCc7CgoKLyoqCiog5LqL5YmN5Yem55CG44GM5a6M5LqG44GX44GfCiogQHByb3BlcnR5IEJFRk9SRV9FWEVDVVRFRAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGJlZm9yZV9leGVjdXRlZAogKi8KCktheml0b3JpRXZlbnQuQkVGT1JFX0VYRUNVVEVEID0gJ2JlZm9yZV9leGVjdXRlZCc7CgoKLyoqCiog44Om44O844K244O844Ki44Kv44K344On44Oz5Lul5aSW44GnIFVSTCDjga7lpInmm7TjgYzjgYLjgaPjgZ8KKiBAcHJvcGVydHkgSU5URVJOQUxfQ0hBTkdFCiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgaW50ZXJuYWxfY2hhbmdlCiAqLwoKS2F6aXRvcmlFdmVudC5JTlRFUk5BTF9DSEFOR0UgPSAnaW50ZXJuYWxfY2hhbmdlJzsKCktheml0b3JpRXZlbnQuVVNFUl9DSEFOR0UgPSAndXNlcl9jaGFuZ2UnOwoKCi8qKgoqIOODkuOCueODiOODquODvOODkOODg+OCr+OBl+OBnwoqIEBwcm9wZXJ0eSBQUkVWCiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgcHJldgogKi8KCktheml0b3JpRXZlbnQuUFJFViA9ICdwcmV2JzsKCgovKioKKiDjg5Ljgrnjg4jjg6rjg7zjg43jgq/jgrnjg4jjgZfjgZ/mmYIKKiBAcHJvcGVydHkgTkVYVAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IG5leHQKICovCgpLYXppdG9yaUV2ZW50Lk5FWFQgPSAnbmV4dCc7CgoKLyoqCiogS2F6aXRvcmkg44GM5Lit5pat44GX44GfCiogQHByb3BlcnR5IFJFSkVDVAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHJlamVjdAogKi8KCktheml0b3JpRXZlbnQuUkVKRUNUID0gJ3JlamVjdCc7CgoKLyoqCiogVVJMIOOBq+ODnuODg+ODgeOBmeOCi+WHpueQhuOBjOimi+OBpOOBi+OCieOBquOBi+OBo+OBnwoqIEBwcm9wZXJ0eSBOT1RfRk9VTkQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBub3RfZm91bmQKICovCgpLYXppdG9yaUV2ZW50Lk5PVF9GT1VORCA9ICdub3RfZm91bmQnOwoKCi8qKgoqIEtheml0b3JpIOOBjOmWi+Wni+OBl+OBnwoqIEBwcm9wZXJ0eSBTVEFSVAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHN0YXJ0CiAqLwoKS2F6aXRvcmlFdmVudC5TVEFSVCA9ICdzdGFydCc7CgoKLyoqCiogS2F6aXRvcmkg44GM5YGc5q2i44GX44GfCiogQHByb3BlcnR5IFNUT1AKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBzdG9wCiAqLwoKS2F6aXRvcmlFdmVudC5TVE9QID0gJ3N0b3AnOwoKCi8qKgoqIEtheml0b3JpIOOBjOS4gOaZguWBnOatouOBl+OBnwoqIEBwcm9wZXJ0eSBTVVNQRU5ECiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgU1VTUEVORAogKi8KCktheml0b3JpRXZlbnQuU1VTUEVORCA9ICdTVVNQRU5EJzsKCgovKioKKiBLYXppdG9yaSDjgYzlho3plovjgZfjgZ8KKiBAcHJvcGVydHkgUkVTVU1FCiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgcmVzdW1lCiAqLwoKS2F6aXRvcmlFdmVudC5SRVNVTUUgPSAncmVzdW1lJzsKCgovKioKKiBLYXppdG9yaSDjgYzplovlp4vjgZfjgabjgYvjgonjgIHkuIDnlarmnIDliJ3jga7jgqLjgq/jgrvjgrnjgYzjgYLjgaPjgZ8KKiBAcHJvcGVydHkgRklSU1RfUkVRVUVTVAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGZpcnN0X3JlcXVlc3QKICovCgpLYXppdG9yaUV2ZW50LkZJUlNUX1JFUVVFU1QgPSAnZmlyc3RfcmVxdWVzdCc7CgoKLyoqCiog44Or44O844K/44O844GM6L+95Yqg44GV44KM44GfCiogQHByb3BlcnR5IEFEREVECiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgYWRkZWQKICovCgpLYXppdG9yaUV2ZW50LkFEREVEID0gJ2FkZGVkJzsKCgovKioKKiDjg6vjg7zjgr/jg7zjgYzliYrpmaTjgZXjgozjgZ8KKiBAcHJvcGVydHkgUkVNT1ZFRAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHJlbW92ZWQKICovCgpLYXppdG9yaUV2ZW50LlJFTU9WRUQgPSAncmVtb3ZlZCc7Cg==",
                "body": "dmFyIERlZmZlcmVkLCBFdmVudERpc3BhdGNoZXIsIEtheml0b3JpLCBLYXppdG9yaUV2ZW50LCBSdWxlLCBWQVJJQUJMRV9UWVBFUywgZGVsZWdhdGVyLCBlc2NhcGVSZWdFeHAsIGZpbGVQYXR0ZXJuLCBnZW5lcmljUGFyYW0sIG5hbWVkUGFyYW0sIG9wdGlvbmFsUGFyYW0sIHJvdXRlU3RyaXBwZXIsIHNwbGF0UGFyYW0sIHRyYWlsaW5nU2xhc2gsCiAgX19iaW5kID0gZnVuY3Rpb24oZm4sIG1lKXsgcmV0dXJuIGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShtZSwgYXJndW1lbnRzKTsgfTsgfSwKICBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfSwKICBfX3NsaWNlID0gW10uc2xpY2UsCiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksCiAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07CgpkZWxlZ2F0ZXIgPSBmdW5jdGlvbih0YXJnZXQsIGZ1bmMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZnVuYy5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgfTsKfTsKCnRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCnJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCmVzY2FwZVJlZ0V4cCA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKbmFtZWRQYXJhbSA9IC88KFx3K3xbQS1aYS16Xy1dKzpcdyspPi9nOwoKZ2VuZXJpY1BhcmFtID0gLyhbQS1aYS16Xy1dKyk6KFx3KykvOwoKZmlsZVBhdHRlcm4gPSAvXHcrXC5bYS16QS1aMC05XXszLDY0fS87CgpvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwoKc3BsYXRQYXJhbSA9IC9cKlx3Ky9nOwoKCi8qVVJMIOWkieaVsOOBq+WvvuOBl+OBpuaMh+WumuOBp+OBjeOCi+WeiyAqLwoKVkFSSUFCTEVfVFlQRVMgPSBbCiAgewogICAgbmFtZTogImludCIsCiAgICBjYXN0OiBOdW1iZXIKICB9LCB7CiAgICBuYW1lOiAic3RyaW5nIiwKICAgIGNhc3Q6IFN0cmluZwogIH0KXTsKCgovKioKKiBLYXppdG9yaS5qcyDjga8gcHVzaFN0YXRlIOOCkuOBhOOBhOaEn+OBmOOBq+OBleOBsOOBhOOBpuOBj+OCjOOCi+ODq+ODvOOCv+ODvOODqeOCpOODluODqeODquOBp+OBmeOAgjxicj4KKiDjgrfjg7Pjg5fjg6vjgYvjgaTopovpgJrjgZfjgojjgY8gcHVzaFN0YXRlIOOCs+ODs+ODhuODs+ODhOOBruODq+ODvOODhuOCo+ODs+OCsOOCkuWumue+qeOBmeOCi+OBk+OBqOOBjOOBp+OBjeOBvuOBmeOAggoqCiog5L2/44GE5pa544Gv44Go44Gm44KC57Ch5Y2Y44CCCiogPHVsPjxsaT5LYXppdG9yaSDjgpLntpnmib/jgZfjgZ/jgq/jg6njgrnjgpLkvZzjgos8L2xpPjxsaT5yb3V0ZXMg44Gr5omx44GE44Gf44GEIFVSTCDjgajjgIHjgZ3jgozjgavlr77lv5zjgZfjgZ/jg6Hjgr3jg4Pjg4njgpLmjIflrprjgII8L2xpPjxsaT7jgqTjg7Pjgrnjgr/jg7PjgrnljJY8L2xpPjwvdWw+CioKKiA8aDQ+ZXhhbXBsZTwvaDQ+CiogICAgICBjbGFzcyBSb3V0ZXIgZXh0ZW5kcyBLYXppdG9yaQoqICAgICAgICByb3V0ZXM6CiogICAgICAgICAgIi8iOiAiaW5kZXgiCiogICAgICAgICAgIi88aW50OmlkPiI6ICJzaG93IgoqCiogICAgICAgIGluZGV4OigpLT4KKiAgICAgICAgICBjb25zb2xlLmxvZyAiaW5kZXghIgoqICAgICAgICBzaG93OihpZCktPgoqICAgICAgICAgIGNvbnNvbGUubG9nIGlkCioKKiAgICAgICQoKCktPgoqICAgICAgICBhcHAgPSBuZXcgUm91dGVyKCkKKiAgICAgICkKKgoqIEtheml0b3JpIOOBp+OBryBwdXNoU3RhdGUg44Gn6Z2e5ZCM5pyf44Kz44Oz44OG44Oz44OE44KS5L2c44Gj44Gm44GE44GP5LiK44Gn5b+F6KaB44Go44Gq44KL44Gn44GC44KN44GG5qmf6IO944KS5LuW44Gr44KC5rKi5bGx55So5oSP44GX44Gm44GE44G+44GZ44CCPGJyPgoqIOips+e0sOOBryBBUEkg5LiA6Kan44GL44KJ56K66KqN44GX44Gm5LiL44GV44GE44CCCiogQG1vZHVsZSBLYXppdG9yaS5qcwoqIEBtYWluIEtheml0b3JpCiAqLwoKCi8qKgoqICBLYXppdG9yaSDjga7jg6HjgqTjg7Pjgq/jg6njgrkKKgoqICBAY2xhc3MgS2F6aXRvcmkKKiAgQGNvbnN0cnVjdG9yCiAqLwoKS2F6aXRvcmkgPSAoZnVuY3Rpb24oKSB7CiAgS2F6aXRvcmkucHJvdG90eXBlLlZFUlNJT04gPSAiMS4wLjIiOwoKICBLYXppdG9yaS5wcm90b3R5cGUuaGlzdG9yeSA9IG51bGw7CgogIEtheml0b3JpLnByb3RvdHlwZS5sb2NhdGlvbiA9IG51bGw7CgoKICAvKioKICAqIOODnuODg+ODgeOBmeOCi1VSTOOBruODq+ODvOODq+OBqOOAgeOBneOCjOOBq+WvvuW/nOOBmeOCi+WHpueQhuOCkuWumue+qeOBl+OBvuOBmeOAggogICogPGg0PmV4YW1wbGU8L2g0PgogICogICAgIHJvdXRlczoKICAqICAgICAgICcvJzonaW5kZXgnCiAgKiAgICAgICAnLzxpbnQ6aWQ+Jzonc2hvdycKICAqCiAgKiBAcHJvcGVydHkgcm91dGVzCiAgKiBAdHlwZSBPYmplY3QKICAqIEBkZWZhdWx0IHt9CiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5yb3V0ZXMgPSB7fTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmhhbmRsZXJzID0gW107CgoKICAvKioKICAqIOODnuODg+ODgeOBl+OBnyBVUkwg44Gr5a++44GZ44KL5Yem55CG44KS6KGM44GG5YmN44Gr5a6f6KGM44GX44Gf44GE5Yem55CG44KS5a6a576p44GX44G+44GZ44CCCiAgKiBAcHJvcGVydHkgYmVmb3JlcwogICogQHR5cGUgT2JqZWN0CiAgKiBAZGVmYXVsdCB7fQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlcyA9IHt9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlSGFuZGxlcnMgPSBbXTsKCgogIC8qKgogICogVVJMIOOBjOWkieOCj+OCi+mam+OAgeS6i+WJjeOBq+Wun+ihjOOBl+OBn+OBhOWHpueQhuOCkuWumue+qeOBl+OBvuOBmeOAgjxicj4KICAqIOOBk+OBruODl+ODreODkeODhuOCo+OBq+eZu+mMsuOBleOCjOOBn+WHpueQhuOBr+OAgeS4juOBiOOCieOCjOOBnyBVUkwg44Gr44Oe44OD44OB44GZ44KL44GL44Gp44GG44GL44Gr44GL44GL44KP44KJ44Ga44CB5bi444Gr5a6f6KGM44GV44KM44G+44GZ44CCCiAgKiBAcHJvcGVydHkgYmVmb3JlQW55dGltZUhhbmRsZXIKICAqIEB0eXBlIEFycmF5CiAgKiBAZGVmYXVsdCBbXQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlQW55dGltZUhhbmRsZXIgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuYWZ0ZXJoYW5kbGVycyA9IFtdOwoKCiAgLyoqCiAgKiDnibnlrprjga7jg5XjgqHjgqTjg6vlkI3jgYwgVVJMIOOBq+WQq+OBvuOCjOOBpuOBhOOBn+aZguOAgeODq+ODvOODiOOBqOOBl+OBpuWHpueQhuOBmeOCi+ODquOCueODiOOBp+OBmeOAggogICogQHByb3BlcnR5IHJvb3RGaWxlcwogICogQHR5cGUgQXJyYXkKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnJvb3RGaWxlcyA9IFsnaW5kZXguaHRtbCcsICdpbmRleC5odG0nLCAnaW5kZXgucGhwJywgJ3Vua28uaHRtbCddOwoKCiAgLyoqCiAgKiDjg6vjg7zjg4jjgpLmjIflrprjgZfjgb7jgZnjgII8YnI+CiAgKiDjgZPjgZPjgafmjIflrprjgZXjgozjgZ/lgKTjgYwgVVJMIOOBriBwcmVmaXgg44Go44GX44Gm5b+F44Ga44Gk44GN44G+44GZ44CCPGJyPgogICog54mp55CG55qE44GrIFVSTCDjga7jg6vjg7zjg4jjgojjgoogMeODh+OCo+ODrOOCr+ODiOODquS4i+OBjOOBo+OBn+euh+aJgOOBpyBwdXNoU3RhdGUg44KS6KGM44GE44Gf44GE5aC05ZCIPGJyPgogICog44GT44Gu5YCk44KSIC8g5Lul5aSW44Gr5oyH5a6a44GX44G+44GZ44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiDjgrPjg7Pjg4bjg7Pjg4TjgpLphY3nva7jgZnjgovlrp/jg4fjgqPjg6zjgq/jg4jjg6rjgYwgZXhhbXBsZSDjgaDjgaPjgZ/loLTlkIgKICAqCiAgKiAgICAgYXBwID0gbmV3IFJvdXRlcih7cm9vdDonL2V4YW1wbGUvJ30pCiAgKiBAcHJvcGVydHkgcm9vdAogICogQHR5cGUgU3RyaW5nCiAgKiBAZGVmYXVsdCAvCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5yb290ID0gbnVsbDsKCgogIC8qKgogICog54++5Zyo44GuIFVSTCDjgavjg57jg4Pjg4HjgZnjgovjg6vjg7zjg6vjgYzjgarjgYvjgaPjgZ/loLTlkIjjgavlpInmm7TjgZnjgosgVVJMCiAgKiBAcHJvcGVydHkgbm90Rm91bmQKICAqIEB0eXBlIFN0cmluZwogICogQGRlZmF1bHQgbnVsbAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUubm90Rm91bmQgPSBudWxsOwoKICBLYXppdG9yaS5wcm90b3R5cGUuZGlyZWN0ID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzSUUgPSBmYWxzZTsKCgogIC8qKgogICogVVJMIOOCkuWun+mam+OBq+OBr+WkieabtOOBl+OBquOBhOOCiOOBhuOBq+OBmeOCi+OBi+OBqeOBhuOBi+OCkuaxuuWumuOBl+OBvuOBmeOAgjxicj4KICAqIHRydWUg44Gr44GX44Gf5aC05ZCI44CBVVJMIOOBr+WkieabtOOBleOCjOOBmuOAgeWGhemDqOOBp+S/neaMgeOBl+OBpuOBhOOCi+eKtuaFi+euoeeQhuOCquODluOCuOOCp+OCr+ODiOOCkuWfuua6luOBq+WxlemWi+OBl+OBvuOBmeOAggogICogQHByb3BlcnR5IHNpbGVudAogICogQHR5cGUgQm9vbGVhbgogICogQGRlZmF1bHQgZmFsc2UKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnNpbGVudCA9IGZhbHNlOwoKCiAgLyoqCiAgKiBwdXNoU3RhdGUg44G444Gu55uj6KaW44GM6ZaL5aeL44GV44KM44Gm44GE44KL44GL44Gp44GG44GLCiAgKiBAcHJvcGVydHkgc3RhcnRlZAogICogQHR5cGUgQm9vbGVhbgogICogQGRlZmF1bHQgZmFsc2UKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnN0YXJ0ZWQgPSBmYWxzZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9wYXJhbXMgPSB7CiAgICBwYXJhbXM6IFtdLAogICAgJ2ZyYWdtZW50JzogJycKICB9OwoKCiAgLyoqCiAgKiBiZWZvcmUg5Yem55CG44GM5aSx5pWX44GX44Gf5pmC44Gr5a6f6KGM44GV44KM44G+44GZ44CCPGJyPgogICog44OH44OV44Kp44Or44OI44Gn44Gv56m644GuIGZ1bmN0aW9uIOOBq+OBquOBo+OBpuOBhOOBvuOBmeOAggogICoKICAqIEBtZXRob2QgYmVmb3JlRmFpbGVkSGFuZGxlcgogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuYmVmb3JlRmFpbGVkSGFuZGxlciA9IGZ1bmN0aW9uKCkge307CgoKICAvKmlzQmVmb3JlRm9yY2UgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzQmVmb3JlRm9yY2UgPSBmYWxzZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzVGVtYWUgPSBmYWxzZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9jaGFuZ2VPcHRpb25zID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzTm90Rm91bmRGb3JjZSA9IGZhbHNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX25vdEZvdW5kID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmJyZWFrZXIgPSB7fTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9kaXNwYXRjaGVyID0gbnVsbDsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iZWZvcmVEZWZmZXIgPSBudWxsOwoKCiAgLyoqCiAgKiDnj77lnKjjga4gVVJMIOOCkui/lOOBl+OBvuOBmeOAggogICogQHByb3BlcnR5IGZyYWdtZW50CiAgKiBAdHlwZSBTdHJpbmcKICAqIEBkZWZhdWx0IG51bGwKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmZyYWdtZW50ID0gbnVsbDsKCgogIC8qKgogICog54++5Zyo44GuIFVSTCDjgYvjgokgMeOBpOWJjeOBriBVUkwg44KS6L+U44GX44G+44GZ44CCCiAgKiBAcHJvcGVydHkgbGFzdEZyYWdtZW50CiAgKiBAdHlwZSBTdHJpbmcKICAqIEBkZWZhdWx0IG51bGwKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmxhc3RGcmFnbWVudCA9IG51bGw7CgogIEtheml0b3JpLnByb3RvdHlwZS5pc1VzZXJBY3Rpb24gPSBmYWxzZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9pc0ZpcnN0UmVxdWVzdCA9IHRydWU7CgogIEtheml0b3JpLnByb3RvdHlwZS5pc0luaXRSZXBsYWNlID0gdHJ1ZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmlzTGFzdFNsYXNoID0gZmFsc2U7CgoKICAvKioKICAqIOS4gOaZguWBnOatouOBl+OBpuOBhOOCi+OBi+OBqeOBhuOBi+OCkui/lOOBl+OBvuOBmeOAggogICoKICAqIEBwcm9wZXJ0eSBpc1N1c3BlbmQKICAqIEB0eXBlIEJvb2xlYW4KICAqIEBkZWZhdWx0IGZhbHNlCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5pc1N1c3BlbmQgPSBmYWxzZTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9wcm9jZXNzU3RlcCA9IHsKICAgICdzdGF0dXMnOiAnbnVsbCcsCiAgICAnYXJncyc6IFtdCiAgfTsKCiAgZnVuY3Rpb24gS2F6aXRvcmkob3B0aW9ucykgewogICAgdGhpcy5vYnNlcnZlVVJMSGFuZGxlciA9IF9fYmluZCh0aGlzLm9ic2VydmVVUkxIYW5kbGVyLCB0aGlzKTsKICAgIHRoaXMuYmVmb3JlRmFpbGVkID0gX19iaW5kKHRoaXMuYmVmb3JlRmFpbGVkLCB0aGlzKTsKICAgIHRoaXMuZXhlY3V0ZUhhbmRsZXJzID0gX19iaW5kKHRoaXMuZXhlY3V0ZUhhbmRsZXJzLCB0aGlzKTsKICAgIHRoaXMuX2V4ZWN1dGVCZWZvcmVzID0gX19iaW5kKHRoaXMuX2V4ZWN1dGVCZWZvcmVzLCB0aGlzKTsKICAgIHRoaXMuYmVmb3JlQ29tcGxldGUgPSBfX2JpbmQodGhpcy5iZWZvcmVDb21wbGV0ZSwgdGhpcyk7CiAgICB2YXIgZG9jTW9kZSwgZSwgd2luOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzID0gJ2NvbnN0cnVjdG9yJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbb3B0aW9uc107CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB7CiAgICAgIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB9CiAgICB0aGlzLnJvb3QgPSBvcHRpb25zLmhhc093blByb3BlcnR5KCJyb290IikgPyBvcHRpb25zLnJvb3QgOiB0aGlzLnJvb3QgPT09IG51bGwgPyAnLycgOiB0aGlzLnJvb3Q7CiAgICB0aGlzLmlzVGVtYWUgPSBvcHRpb25zLmlzVGVtYWUgPyBvcHRpb25zLmlzVGVtYWUgOiBmYWxzZTsKICAgIHRoaXMuc2lsZW50ID0gb3B0aW9ucy5zaWxlbnQgPyBvcHRpb25zLnNpbGVudCA6IGZhbHNlOwogICAgdGhpcy5pc0luaXRSZXBsYWNlID0gb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgiaXNJbml0UmVwbGFjZSIpID8gb3B0aW9ucy5pc0luaXRSZXBsYWNlIDogdHJ1ZTsKICAgIHRoaXMuaXNMYXN0U2xhc2ggPSBvcHRpb25zLmhhc093blByb3BlcnR5KCJpc0xhc3RTbGFzaCIpID8gb3B0aW9ucy5pc0xhc3RTbGFzaCA6IGZhbHNlOwogICAgdGhpcy5fcGFyYW1zID0gewogICAgICBwYXJhbXM6IFtdLAogICAgICBxdWVyaWVzOiB7fSwKICAgICAgZnJhZ21lbnQ6IG51bGwKICAgIH07CiAgICBpZiAodGhpcy5ub3RGb3VuZCA9PT0gbnVsbCkgewogICAgICB0aGlzLm5vdEZvdW5kID0gb3B0aW9ucy5ub3RGb3VuZCA/IG9wdGlvbnMubm90Rm91bmQgOiB0aGlzLnJvb3Q7CiAgICB9CiAgICB3aW4gPSB3aW5kb3c7CiAgICBpZiAodHlwZW9mIHdpbiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbi5sb2NhdGlvbjsKICAgICAgdGhpcy5oaXN0b3J5ID0gd2luLmhpc3Rvcnk7CiAgICB9CiAgICBkb2NNb2RlID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgdGhpcy5pc0lFID0gd2luLm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdtc2llJykgIT09IC0xOwogICAgdGhpcy5pc09sZElFID0gdGhpcy5pc0lFICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDwgOSk7CiAgICB0aGlzLl9kaXNwYXRjaGVyID0gbmV3IEV2ZW50RGlzcGF0Y2hlcigpOwogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgdGhpcy5iZWZvcmVIYW5kbGVycyA9IFtdOwogICAgdGhpcy5fYmluZEJlZm9yZXMoKTsKICAgIHRoaXMuX2JpbmRSdWxlcygpOwogICAgdGhpcy5fYmluZE5vdEZvdW5kKCk7CiAgICB0cnkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3BhcmFtcycsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyYW1zLnBhcmFtczsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3F1ZXJpZXMnLCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcmFtcy5xdWVyaWVzOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgZSA9IF9lcnJvcjsKICAgICAgaWYgKHRoaXMuaXNPbGRJRSkgewogICAgICAgIHRoaXMucGFyYW1zID0gdGhpcy5fcGFyYW1zLnBhcmFtczsKICAgICAgICB0aGlzLnF1ZXJpZXMgPSB0aGlzLl9wYXJhbXMucXVlcmllczsKICAgICAgfQogICAgfQogICAgaWYgKCh0aGlzLm9wdGlvbnMuaXNBdXRvU3RhcnQgPT0gbnVsbCkgfHwgdGhpcy5vcHRpb25zLmlzQXV0b1N0YXJ0ICE9PSBmYWxzZSkgewogICAgICB0aGlzLnN0YXJ0KCk7CiAgICB9CiAgfQoKCiAgLyoqCiAgKiBLYXppdG9yaS5qcyDjgpLplovlp4vjgZfjgb7jgZnjgII8YnI+CiAgKiBTVEFSVCDjgqTjg5njg7Pjg4jjgYzjg4fjgqPjgrnjg5Hjg4Pjg4HjgZXjgozjgb7jgZnjgIIKICAqIEBtZXRob2Qgc3RhcnQKICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIOOCquODl+OCt+ODp+ODswogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgYXRSb290LCBmcmFnbWVudCwgZnJhbWUsIGllRnJhZywgb3ZlcnJpZGUsIHdpbjsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1cyA9ICdzdGFydCc7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5hcmdzID0gW29wdGlvbnNdOwogICAgaWYgKHRoaXMuc3RhcnRlZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ21vdSBoYXppbSBtYXR0ZXJ1Jyk7CiAgICB9CiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlOwogICAgd2luID0gd2luZG93OwogICAgdGhpcy5vcHRpb25zID0gdGhpcy5fZXh0ZW5kKHt9LCB7CiAgICAgIHJvb3Q6ICcvJwogICAgfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSA9ICEhKHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgIHRoaXMuX3dhbnRDaGFuZ2VIYXNoID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgYXRSb290ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKICAgIGlmICh0aGlzLmlzSUUgJiYgIWF0Um9vdCAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuaXNJbml0UmVwbGFjZSkgewogICAgICBpZUZyYWcgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UodGhpcy5yb290LCAnJyk7CiAgICAgIHRoaXMuX3VwZGF0ZUhhc2hJRShpZUZyYWcpOwogICAgfQogICAgaWYgKHRoaXMuaXNPbGRJRSAmJiB0aGlzLl93YW50Q2hhbmdlSGFzaCkgewogICAgICBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpOwogICAgICBmcmFtZS5zZXRBdHRyaWJ1dGUoInNyYyIsICJqYXZhc2NyaXB0OjAiKTsKICAgICAgZnJhbWUuc2V0QXR0cmlidXRlKCJ0YWJpbmRleCIsICItMSIpOwogICAgICBmcmFtZS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZyYW1lKTsKICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5jb250ZW50V2luZG93OwogICAgICB0aGlzLmNoYW5nZShmcmFnbWVudCk7CiAgICB9CiAgICB0aGlzLl9hZGRQb3BTdGF0ZUhhbmRsZXIoKTsKICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIHRoaXMubG9jYXRpb24uaGFzaCkgewogICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5sYXN0RnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CiAgICB9CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5TVEFSVCwgdGhpcy5mcmFnbWVudCkpOwogICAgb3ZlcnJpZGUgPSB0aGlzLnJvb3Q7CiAgICBpZiAoIXRoaXMuc2lsZW50KSB7CiAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCkgewogICAgICAgIG92ZXJyaWRlID0gdGhpcy5mcmFnbWVudDsKICAgICAgfSBlbHNlIGlmICghYXRSb290KSB7CiAgICAgICAgb3ZlcnJpZGUgPSB0aGlzLmZyYWdtZW50OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5sb2FkVVJMKG92ZXJyaWRlKTsKICB9OwoKCiAgLyoqCiAgKiBLYXppdG9yaS5qcyDjgpLlgZzmraLjgZfjgb7jgZnjgII8YnI+CiAgKiBTVE9QIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogQG1ldGhvZCBzdG9wCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgd2luOwogICAgd2luID0gd2luZG93OwogICAgd2luLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5vYnNlcnZlVVJMSGFuZGxlcik7CiAgICB3aW4ucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgdGhpcy5zdGFydGVkID0gZmFsc2U7CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5TVE9QLCB0aGlzLmZyYWdtZW50KSk7CiAgfTsKCgogIC8qKgogICog44OW44Op44Km44K244Gu44OS44K544OI44Oq44O85qmf6IO944KS5Yip55So44GX44Gm44CM6YCy44KA44CN44KS5a6f6KGM44GX44G+44GZ44CCPGJyPgogICog5oiQ5Yqf44GX44Gf5aC05ZCIIE5FWFQg44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiBAbWV0aG9kIHRvcmlrYXppCiAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUudG9yaWthemkgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5kaXJlY3Rpb24ob3B0aW9ucywgIm5leHQiKTsKICB9OwoKCiAgLyoqCiAgKiDjg5bjg6njgqbjgrbjg5Ljgrnjg4jjg6rjg7zmqZ/og73jgpLliKnnlKjjgZfjgabjgIzmiLvjgovjgI3jgpLlrp/ooYzjgZfjgb7jgZnjgII8YnI+CiAgKiDmiJDlip/jgZfjgZ/loLTlkIggUFJFViDjgqTjg5njg7Pjg4jjgYzjg4fjgqPjgrnjg5Hjg4Pjg4HjgZXjgozjgb7jgZnjgIIKICAqIEBtZXRob2Qgb21va2F6aQogICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLm9tb2themkgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5kaXJlY3Rpb24ob3B0aW9ucywgInByZXYiKTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuZGlyZWN0aW9uID0gZnVuY3Rpb24ob3B0aW9uLCBkaXJlY3Rpb24pIHsKICAgIHZhciB0bXBGcmFnOwogICAgaWYgKCF0aGlzLnN0YXJ0ZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdG1wRnJhZyA9IHRoaXMubGFzdEZyYWdtZW50OwogICAgdGhpcy5sYXN0RnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICB0aGlzLmRpcmVjdCA9IGRpcmVjdGlvbjsKICAgIHRoaXMuaXNVc2VyQWN0aW9uID0gdHJ1ZTsKICAgIHRoaXMuX3JlbW92ZVBvcFN0YXRlSGFuZGxlcigpOwogICAgaWYgKGRpcmVjdGlvbiA9PT0gInByZXYiKSB7CiAgICAgIHRoaXMuaGlzdG9yeS5iYWNrKCk7CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LlBSRVYsIHRtcEZyYWcsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gIm5leHQiKSB7CiAgICAgIHRoaXMuaGlzdG9yeS5mb3J3YXJkKCk7CiAgICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50Lk5FWFQsIHRtcEZyYWcsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9hZGRQb3BTdGF0ZUhhbmRsZXIoKTsKICAgIHJldHVybiB0aGlzLmxvYWRVUkwodG1wRnJhZyk7CiAgfTsKCgogIC8qKgogICogdXJsIOOCkuWkieabtOOBl+OBvuOBmeOAgjxicj4KICAqIOeEoeS6iyBVUkwg44GM5YiH44KK5pu/44KP44Gj44Gf5aC05ZCI44CBQ0hBTkdFIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogPGg0PmV4YW1wbGU8L2g0PgogICogICAgIGFwcC5jaGFuZ2UoJy9zb21ldXJsJyk7CiAgKiBAbWV0aG9kIGNoYW5nZQogICogQHBhcmFtIHtTdHJpbmd9IGZyYWdtZW50IOWkieabtOOBl+OBn+OBhCBVUkwKICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIOOCquODl+OCt+ODp+ODswogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuY2hhbmdlID0gZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgIHZhciBmcmFnLCBtYXRjaGVkLCBuZXh0LCB1cmw7CiAgICBpZiAoIXRoaXMuc3RhcnRlZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnY2hhbmdlJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbZnJhZ21lbnQsIG9wdGlvbnNdOwogICAgaWYgKCFvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSB7CiAgICAgICAgJ3RyaWdnZXInOiBvcHRpb25zCiAgICAgIH07CiAgICB9CiAgICB0aGlzLl9jaGFuZ2VPcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuaXNCZWZvcmVGb3JjZSA9IG9wdGlvbnMuaXNCZWZvcmVGb3JjZSAhPT0gZmFsc2U7CiAgICBmcmFnID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmxhc3RGcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQ7CiAgICB0aGlzLmZyYWdtZW50ID0gZnJhZzsKICAgIG5leHQgPSB0aGlzLmZyYWdtZW50OwogICAgdXJsID0gdGhpcy5yb290ICsgdGhpcy5fcmVwbGFjZS5hcHBseShmcmFnLCBbcm91dGVTdHJpcHBlciwgJyddKTsKICAgIG1hdGNoZWQgPSB0aGlzLl9tYXRjaENoZWNrKHRoaXMuZnJhZ21lbnQsIHRoaXMuaGFuZGxlcnMpOwogICAgaWYgKG1hdGNoZWQgPT09IGZhbHNlICYmIHRoaXMuaXNOb3RGb3VuZEZvcmNlID09PSBmYWxzZSkgewogICAgICBpZiAodGhpcy5ub3RGb3VuZCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX25vdEZvdW5kLmNhbGxiYWNrKHRoaXMuZnJhZ21lbnQpOwogICAgICAgIHVybCA9IHRoaXMucm9vdCArIHRoaXMuX25vdEZvdW5kLnJ1bGUucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKICAgICAgfQogICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5OT1RfRk9VTkQpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuaXNUZW1hZSAmJiAodGhpcy5iZWZvcmVBbnl0aW1lSGFuZGxlciB8fCB0aGlzLmJlZm9yZUhhbmRsZXJzLmxlbmd0aCA+IDApKSB7CiAgICAgIHRoaXMuX2V4ZWN1dGVCZWZvcmVzKGZyYWcpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdXJsQ2hhbmdlKGZyYWcsIG9wdGlvbnMpOwogICAgfQogIH07CgoKICAvKioKICAqIHB1c2hTdGF0ZSDjgafjga/jgarjgY8gcmVwbGFjZVN0YXRlIOOBp+WHpueQhuOBl+OBvuOBmeOAgjxicj4KICAqIHJlcGxhY2VTdGF0ZSDjga/nj77lnKjjga4gVVJMIOOCkue9ruOBjeaPm+OBiOOCi+OBn+OCgeOAgeWxpeattOOBq+OBr+i/veWKoOOBleOCjOOBvuOBm+OCk+OAggogICogPGg0PmV4YW1wbGU8L2g0PgogICogICAgIGFwcC5yZXBsYWNlKCcvc29tZXVybCcpOwogICogQG1ldGhvZCByZXBsYWNlCiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQg5aSJ5pu044GX44Gf44GEIFVSTAogICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMg44Kq44OX44K344On44OzCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5yZXBsYWNlID0gZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1cyA9ICdyZXBsYWNlJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbZnJhZ21lbnQsIG9wdGlvbnNdOwogICAgaWYgKCFvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSB7CiAgICAgICAgcmVwbGFjZTogdHJ1ZQogICAgICB9OwogICAgfSBlbHNlIGlmICghb3B0aW9ucy5yZXBsYWNlIHx8IG9wdGlvbnMucmVwbGFjZSA9PT0gZmFsc2UpIHsKICAgICAgb3B0aW9ucy5yZXBsYWNlID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMuY2hhbmdlKGZyYWdtZW50LCBvcHRpb25zKTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3VybENoYW5nZSA9IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICB2YXIgaXNGaWxlLCBpc0xhc3RTbGFzaCwgdXJsOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzID0gJ191cmxDaGFuZ2UnOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyA9IFtmcmFnbWVudCwgb3B0aW9uc107CiAgICBpZiAodGhpcy5pc1N1c3BlbmQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSB0aGlzLl9jaGFuZ2VPcHRpb25zOwogICAgfQogICAgdXJsID0gdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgIGlzRmlsZSA9IHVybC5tYXRjaChmaWxlUGF0dGVybik7CiAgICBpc0xhc3RTbGFzaCA9IHVybC5tYXRjaCh0cmFpbGluZ1NsYXNoKTsKICAgIGlmICh0aGlzLmlzTGFzdFNsYXNoICYmICFpc0ZpbGUgJiYgIWlzTGFzdFNsYXNoKSB7CiAgICAgIHVybCArPSAiLyI7CiAgICB9CiAgICBpZiAoIXRoaXMuc2lsZW50KSB7CiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRDaGFuZ2VIYXNoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgaWYgKCFvcHRpb25zLnJlcGxhY2UpIHsKICAgICAgICAgICAgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkNIQU5HRSwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIGlmIChvcHRpb25zLmludGVybmFsICYmIG9wdGlvbnMuaW50ZXJuYWwgPT09IHRydWUpIHsKICAgICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuSU5URVJOQUxfQ0hBTkdFLCB0aGlzLmZyYWdtZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgfQogICAgdGhpcy5sb2FkVVJMKHRoaXMuZnJhZ21lbnQsIG9wdGlvbnMpOwogIH07CgoKICAvKioKICAqIOS4reatouOBl+OBvuOBmeOAggogICogQG1ldGhvZCByZWplY3QKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuUkVKRUNULCB0aGlzLmZyYWdtZW50KSk7CiAgICBpZiAodGhpcy5fYmVmb3JlRGVmZmVyKSB7CiAgICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9DT01QTEVURSwgdGhpcy5iZWZvcmVDb21wbGV0ZSk7CiAgICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9GQUlMRUQsIHRoaXMuYmVmb3JlRmFpbGVkKTsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyID0gbnVsbDsKICAgIH0KICB9OwoKCiAgLyoqCiAgKiDlh6bnkIbjgpLkuIDmmYLlgZzmraLjgZfjgb7jgZnjgII8YnI+CiAgKiBTVVNQRU5EIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogQG1ldGhvZCBzdXNwZW5kCiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5zdXNwZW5kID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fYmVmb3JlRGVmZmVyICE9IG51bGwpIHsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLnN1c3BlbmQoKTsKICAgIH0KICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlOwogICAgdGhpcy5pc1N1c3BlbmQgPSB0cnVlOwogICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuU1VTUEVORCwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICB9OwoKCiAgLyoqCiAgKiDlh6bnkIbjgpLlho3plovjgZfjgb7jgZnjgII8YnI+CiAgKiBSRVNVTUUg44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiBAbWV0aG9kIHJlc3VtZQogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fYmVmb3JlRGVmZmVyICE9IG51bGwpIHsKICAgICAgdGhpcy5fYmVmb3JlRGVmZmVyLnJlc3VtZSgpOwogICAgfQogICAgdGhpcy5zdGFydGVkID0gdHJ1ZTsKICAgIHRoaXMuaXNTdXNwZW5kID0gZmFsc2U7CiAgICB0aGlzW3RoaXMuX3Byb2Nlc3NTdGVwLnN0YXR1c10odGhpcy5fcHJvY2Vzc1N0ZXAuYXJncyk7CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5SRVNVTUUsIHRoaXMuZnJhZ21lbnQsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLnJlZ2lzdGVySGFuZGxlciA9IGZ1bmN0aW9uKHJ1bGUsIG5hbWUsIGlzQmVmb3JlLCBjYWxsYmFjaykgewogICAgdmFyIGNoaWxkLCBlLCB0YXJnZXQ7CiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIGlmIChpc0JlZm9yZSkgewogICAgICAgIGNhbGxiYWNrID0gdGhpcy5fYmluZEZ1bmN0aW9ucyhuYW1lKTsKICAgICAgfSBlbHNlIGlmIChuYW1lIGluc3RhbmNlb2YgS2F6aXRvcmkpIHsKICAgICAgICB0aGlzLl9iaW5kQ2hpbGQocnVsZSwgbmFtZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBpZiAobmFtZS5oYXNPd25Qcm9wZXJ0eSgnX19zdXBlcl9fJykpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNoaWxkID0gbmV3IG5hbWUoewogICAgICAgICAgICAgICdpc0F1dG9TdGFydCc6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9iaW5kQ2hpbGQocnVsZSwgY2hpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICAgICAgICBlID0gX2Vycm9yOwogICAgICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICB9CiAgICB9CiAgICB0YXJnZXQgPSBpc0JlZm9yZSA/IHRoaXMuYmVmb3JlSGFuZGxlcnMgOiB0aGlzLmhhbmRsZXJzOwogICAgdGFyZ2V0LnVuc2hpZnQobmV3IFJ1bGUocnVsZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgdmFyIGFyZ3M7CiAgICAgIGFyZ3MgPSB0aGlzLnJvdXRlci5leHRyYWN0UGFyYW1zKHRoaXMsIGZyYWdtZW50KTsKICAgICAgcmV0dXJuIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMucm91dGVyLCBhcmdzKTsKICAgIH0sIHRoaXMpKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fYmluZENoaWxkID0gZnVuY3Rpb24ocnVsZSwgY2hpbGQpIHsKICAgIHZhciBjaGlsZEJlZm9yZSwgY2hpbGRCZWZvcmVzLCBjaGlsZEhhbmRsZXJzLCBjaGlsZFJ1bGUsIF9pLCBfaiwgX2xlbiwgX2xlbjE7CiAgICBjaGlsZC5yZWplY3QoKTsKICAgIGNoaWxkLnN0b3AoKTsKICAgIGNoaWxkSGFuZGxlcnMgPSBjaGlsZC5oYW5kbGVycy5jb25jYXQoKTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gY2hpbGRIYW5kbGVycy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICBjaGlsZFJ1bGUgPSBjaGlsZEhhbmRsZXJzW19pXTsKICAgICAgY2hpbGRSdWxlLnVwZGF0ZShydWxlKTsKICAgIH0KICAgIHRoaXMuaGFuZGxlcnMgPSBjaGlsZEhhbmRsZXJzLmNvbmNhdCh0aGlzLmhhbmRsZXJzKTsKICAgIGNoaWxkQmVmb3JlcyA9IGNoaWxkLmJlZm9yZUhhbmRsZXJzLmNvbmNhdCgpOwogICAgZm9yIChfaiA9IDAsIF9sZW4xID0gY2hpbGRCZWZvcmVzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICBjaGlsZEJlZm9yZSA9IGNoaWxkQmVmb3Jlc1tfal07CiAgICAgIGNoaWxkQmVmb3JlLnVwZGF0ZShydWxlKTsKICAgIH0KICAgIHRoaXMuYmVmb3JlSGFuZGxlcnMgPSBjaGlsZEJlZm9yZXMuY29uY2F0KHRoaXMuYmVmb3JlSGFuZGxlcnMpOwogICAgaWYgKGNoaWxkLmJlZm9yZUFueXRpbWVIYW5kbGVyKSB7CiAgICAgIHRoaXMubGFzdEFueXRpbWUgPSB0aGlzLmJlZm9yZUFueXRpbWUuY29uY2F0KCk7CiAgICAgIHRoaXMuX2JpbmRCZWZvcmVBbnl0aW1lKHRoaXMuYmVmb3JlQW55dGltZSwgW2NoaWxkLmJlZm9yZUFueXRpbWVIYW5kbGVyLmNhbGxiYWNrXSk7CiAgICB9CiAgfTsKCgogIC8qKgogICog44Or44O844K/44O844KS5YuV55qE44Gr6L+95Yqg44GX44G+44GZ44CCPGJyPgogICog44Or44O844K/44O844Gu6L+95Yqg44Gr5oiQ5Yqf44GX44Gf5aC05ZCI44CBQURERUQg44Kk44OZ44Oz44OI44GM44OH44Kj44K544OR44OD44OB44GV44KM44G+44GZ44CCCiAgKiA8aDQ+ZXhhbXBsZTwvaDQ+CiAgKiAgICAgZm9vUm91dGVyID0gbmV3IEZvb1JvdXRlcigpOwogICogICAgIGFwcC5hcHBlbmRSb3V0ZXIoZm9vKTsKICAqIEBtZXRob2QgYXBwZW5kUm91dGVyCiAgKiBAcGFyYW0ge09iamVjdH0gY2hpbGQKICAqIEBwYXJhbSB7U3RyaW5nfSBjaGlsZFJvb3QKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmFwcGVuZFJvdXRlciA9IGZ1bmN0aW9uKGNoaWxkLCBjaGlsZFJvb3QpIHsKICAgIHZhciBlLCBydWxlLCBfaW5zdGFuY2U7CiAgICBpZiAoIWNoaWxkIGluc3RhbmNlb2YgS2F6aXRvcmkgJiYgdHlwZW9mIGNoaWxkICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigi5byV5pWw44Gu5YCk44GM5LiN5q2j44Gn44GZ44CCIOW8leaVsOOBqOOBl+OBpuS4juOBiOOCieOCjOOCi+OCquODluOCuOOCp+OCr+ODiOOBryBLYXppdG9yaSDjgpLntpnmib/jgZfjgabjgYTjgovlv4XopoHjgYzjgYLjgorjgb7jgZnjgIIiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgS2F6aXRvcmkpIHsKICAgICAgcnVsZSA9IHRoaXMuX2dldENoaWxkUnVsZShjaGlsZCwgY2hpbGRSb290KTsKICAgICAgdGhpcy5fYmluZENoaWxkKHJ1bGUsIGNoaWxkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgewogICAgICBpZiAoY2hpbGQuaGFzT3duUHJvcGVydHkoJ19fc3VwZXJfXycpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIF9pbnN0YW5jZSA9IG5ldyBjaGlsZCh7CiAgICAgICAgICAgICdpc0F1dG9TdGFydCc6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJ1bGUgPSB0aGlzLl9nZXRDaGlsZFJ1bGUoX2luc3RhbmNlLCBjaGlsZFJvb3QpOwogICAgICAgICAgdGhpcy5fYmluZENoaWxkKHJ1bGUsIF9pbnN0YW5jZSk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgICAgIGUgPSBfZXJyb3I7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIuW8leaVsOOBruWApOOBjOS4jeato+OBp+OBmeOAgiDlvJXmlbDjgajjgZfjgabkuI7jgYjjgonjgozjgovjgqrjg5bjgrjjgqfjgq/jg4jjga8gS2F6aXRvcmkg44KS57aZ5om/44GX44Gm44GE44KL5b+F6KaB44GM44GC44KK44G+44GZ44CCIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5BRERFRCwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fZ2V0Q2hpbGRSdWxlID0gZnVuY3Rpb24oY2hpbGQsIGNoaWxkUm9vdCkgewogICAgdmFyIHJ1bGU7CiAgICBydWxlID0gY2hpbGQucm9vdDsKICAgIGlmIChjaGlsZFJvb3QpIHsKICAgICAgcnVsZSA9IGNoaWxkUm9vdDsKICAgIH0KICAgIGlmIChydWxlLm1hdGNoKHRyYWlsaW5nU2xhc2gpKSB7CiAgICAgIHJ1bGUgPSBydWxlLnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgfQogICAgaWYgKHJ1bGUgPT09IHRoaXMucm9vdCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIuOBi+OBtuOBo+OBpuOCiyIpOwogICAgfQogICAgcmV0dXJuIHJ1bGU7CiAgfTsKCgogIC8qKgogICog5YuV55qE44Gr6L+95Yqg44GX44Gf44Or44O844K/44O844KS5YmK6Zmk44GX44G+44GZ44CCCiAgKiDjg6vjg7zjgr/jg7zjga7liYrpmaTjgavmiJDlip/jgZfjgZ/loLTlkIjjgIFSRU1PVkVEIOOCpOODmeODs+ODiOOBjOODh+OCo+OCueODkeODg+ODgeOBleOCjOOBvuOBmeOAggogICogPGg0PmV4YW1wbGU8L2g0PgogICogICAgIGZvbyA9IG5ldyBGb29Sb3V0ZXIoKTsKICAqICAgICBhcHAuYXBwZW5kUm91dGVyKGZvbyk7CiAgKiAgICAgYXBwLnJlbW92ZVJvdXRlcihmb28pOwogICogQG1ldGhvZCByZW1vdmVSb3V0ZXIKICAqIEBwYXJhbSB7T2JqZWN0fSBjaGlsZAogICogQHBhcmFtIHtTdHJpbmd9IGNoaWxkUm9vdAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUucmVtb3ZlUm91dGVyID0gZnVuY3Rpb24oY2hpbGQsIGNoaWxkUm9vdCkgewogICAgdmFyIGUsIF9pbnN0YW5jZTsKICAgIGlmICghY2hpbGQgaW5zdGFuY2VvZiBLYXppdG9yaSAmJiB0eXBlb2YgY2hpbGQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCLlvJXmlbDjga7lgKTjgYzkuI3mraPjgafjgZnjgIIg5byV5pWw44Go44GX44Gm5LiO44GI44KJ44KM44KL44Kq44OW44K444Kn44Kv44OI44GvIEtheml0b3JpIOOCkue2meaJv+OBl+OBpuOBhOOCi+W/heimgeOBjOOBguOCiuOBvuOBmeOAgiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBLYXppdG9yaSkgewogICAgICB0aGlzLl91bmJpbmRDaGlsZChjaGlsZCwgY2hpbGRSb290KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChjaGlsZC5oYXNPd25Qcm9wZXJ0eSgnX19zdXBlcl9fJykpIHsKICAgICAgICB0cnkgewogICAgICAgICAgX2luc3RhbmNlID0gbmV3IGNoaWxkKHsKICAgICAgICAgICAgJ2lzQXV0b1N0YXJ0JzogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5fdW5iaW5kQ2hpbGQoX2luc3RhbmNlLCBjaGlsZFJvb3QpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7CiAgICAgICAgICBlID0gX2Vycm9yOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCLlvJXmlbDjga7lgKTjgYzkuI3mraPjgafjgZnjgIIg5byV5pWw44Go44GX44Gm5LiO44GI44KJ44KM44KL44Kq44OW44K444Kn44Kv44OI44GvIEtheml0b3JpIOOCkue2meaJv+OBl+OBpuOBhOOCi+W/heimgeOBjOOBguOCiuOBvuOBmeOAgiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdGhpcy5fZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuUkVNT1ZFRCwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fdW5iaW5kQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCwgY2hpbGRSb290KSB7CiAgICB2YXIgYmVmb3JlUnVsZSwgaSwgbGVuLCBuZXdCZWZvcmVzLCBuZXdIYW5kbGVycywgcnVsZSwgcnVsZU9iajsKICAgIHJ1bGUgPSB0aGlzLl9nZXRDaGlsZFJ1bGUoY2hpbGQsIGNoaWxkUm9vdCk7CiAgICBpID0gMDsKICAgIGxlbiA9IHRoaXMuaGFuZGxlcnMubGVuZ3RoOwogICAgbmV3SGFuZGxlcnMgPSBbXTsKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIHJ1bGVPYmogPSB0aGlzLmhhbmRsZXJzLnNoaWZ0KCk7CiAgICAgIGlmICgocnVsZU9iai5ydWxlLm1hdGNoKHJ1bGUpKSA9PT0gbnVsbCkgewogICAgICAgIG5ld0hhbmRsZXJzLnVuc2hpZnQocnVsZU9iaik7CiAgICAgIH0KICAgICAgaSsrOwogICAgfQogICAgdGhpcy5oYW5kbGVycyA9IG5ld0hhbmRsZXJzOwogICAgaSA9IDA7CiAgICBsZW4gPSB0aGlzLmJlZm9yZUhhbmRsZXJzLmxlbmd0aDsKICAgIG5ld0JlZm9yZXMgPSBbXTsKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIGJlZm9yZVJ1bGUgPSB0aGlzLmJlZm9yZUhhbmRsZXJzLnNoaWZ0KCk7CiAgICAgIGlmICgoYmVmb3JlUnVsZS5ydWxlLm1hdGNoKHJ1bGUpKSA9PT0gbnVsbCkgewogICAgICAgIG5ld0JlZm9yZXMudW5zaGlmdChiZWZvcmVSdWxlKTsKICAgICAgfQogICAgICBpKys7CiAgICB9CiAgICB0aGlzLmJlZm9yZUhhbmRsZXJzID0gbmV3QmVmb3JlczsKICB9OwoKCiAgLyoqCiAgKiDjg5bjg6njgqbjgrbjgYvjgonnj77lnKjjga4gVVJMIOOCkuiqreOBv+i+vOOBv+OBvuOBmeOAggogICogQG1ldGhvZCBsb2FkVVJMCiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnRPdmVycmlkZQogICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmxvYWRVUkwgPSBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlLCBvcHRpb25zKSB7CiAgICB2YXIgZnJhZ21lbnQ7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnbG9hZFVSTCc7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5hcmdzID0gW2ZyYWdtZW50T3ZlcnJpZGUsIG9wdGlvbnNdOwogICAgaWYgKHRoaXMuaXNTdXNwZW5kKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICBpZiAodGhpcy5pc1RlbWFlID09PSBmYWxzZSAmJiAodGhpcy5iZWZvcmVBbnl0aW1lSGFuZGxlciB8fCB0aGlzLmJlZm9yZUhhbmRsZXJzLmxlbmd0aCA+IDApKSB7CiAgICAgIHRoaXMuX2V4ZWN1dGVCZWZvcmVzKGZyYWdtZW50KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZXhlY3V0ZUhhbmRsZXJzKCk7CiAgICB9CiAgfTsKCgogIC8qKgogICog5oyH5a6a44GX44GfIOaWh+Wtl+WIl+OBq+WvvuW/nOOBl+OBnyBVUkwg44Or44O844Or44GM6Kit5a6a44GV44KM44Gm44GE44KL44GL44Gp44GG44GLPGJyPgogICogQm9vbGVhbiDjgafov5TjgZfjgb7jgZnjgIIKICAqIDxoND5leGFtcGxlPC9oND4KICAqICAgICBhcHAubWF0Y2goJy9ob2dlJyk7CiAgKiBAbWV0aG9kIG1hdGNoCiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQKICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCgogIEtheml0b3JpLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICB2YXIgbWF0Y2hlZDsKICAgIG1hdGNoZWQgPSB0aGlzLl9tYXRjaENoZWNrKGZyYWdtZW50LCB0aGlzLmhhbmRsZXJzLCB0cnVlKTsKICAgIHJldHVybiBtYXRjaGVkLmxlbmd0aCA+IDA7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmJlZm9yZUNvbXBsZXRlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9DT01QTEVURSwgdGhpcy5iZWZvcmVDb21wbGV0ZSk7CiAgICB0aGlzLl9iZWZvcmVEZWZmZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcihLYXppdG9yaUV2ZW50LlRBU0tfUVVFVUVfRkFJTEVELCB0aGlzLmJlZm9yZUZhaWxlZCk7CiAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5CRUZPUkVfRVhFQ1VURUQsIHRoaXMuZnJhZ21lbnQsIHRoaXMubGFzdEZyYWdtZW50KSk7CiAgICBpZiAodGhpcy5pc1RlbWFlKSB7CiAgICAgIHRoaXMuX3VybENoYW5nZSh0aGlzLmZyYWdtZW50LCB0aGlzLl9jaGFuZ2VPcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZXhlY3V0ZUhhbmRsZXJzKCk7CiAgICB9CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9leGVjdXRlQmVmb3JlcyA9IGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICB2YXIgaGFuZGxlciwgbWF0Y2hlZCwgX2ksIF9sZW47CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5zdGF0dXMgPSAnX2V4ZWN1dGVCZWZvcmVzJzsKICAgIHRoaXMuX3Byb2Nlc3NTdGVwLmFyZ3MgPSBbZnJhZ21lbnRdOwogICAgdGhpcy5fYmVmb3JlRGVmZmVyID0gbmV3IERlZmZlcmVkKCk7CiAgICBpZiAodGhpcy5iZWZvcmVBbnl0aW1lSGFuZGxlciAhPSBudWxsKSB7CiAgICAgIHRoaXMuX2JlZm9yZURlZmZlci5kZWZmZXJlZCgoZnVuY3Rpb24oX3RoaXMpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZCkgewogICAgICAgICAgX3RoaXMuYmVmb3JlQW55dGltZUhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgZC5leGVjdXRlKGQpOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpKTsKICAgIH0KICAgIG1hdGNoZWQgPSB0aGlzLl9tYXRjaENoZWNrKGZyYWdtZW50LCB0aGlzLmJlZm9yZUhhbmRsZXJzKTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gbWF0Y2hlZC5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICBoYW5kbGVyID0gbWF0Y2hlZFtfaV07CiAgICAgIHRoaXMuX2JlZm9yZURlZmZlci5kZWZmZXJlZChmdW5jdGlvbihkKSB7CiAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgZC5leGVjdXRlKGQpOwogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX2JlZm9yZURlZmZlci5hZGRFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9DT01QTEVURSwgdGhpcy5iZWZvcmVDb21wbGV0ZSk7CiAgICB0aGlzLl9iZWZvcmVEZWZmZXIuYWRkRXZlbnRMaXN0ZW5lcihLYXppdG9yaUV2ZW50LlRBU0tfUVVFVUVfRkFJTEVELCB0aGlzLmJlZm9yZUZhaWxlZCk7CiAgICB0aGlzLl9iZWZvcmVEZWZmZXIuZXhlY3V0ZSh0aGlzLl9iZWZvcmVEZWZmZXIpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5leGVjdXRlSGFuZGxlcnMgPSBmdW5jdGlvbigpIHsKICAgIHZhciBoYW5kbGVyLCBpc01hdGNoZWQsIG1hdGNoLCBtYXRjaGVkLCBfaSwgX2osIF9sZW4sIF9sZW4xOwogICAgdGhpcy5fcHJvY2Vzc1N0ZXAuc3RhdHVzID0gJ2V4ZWN1dGVIYW5kbGVycyc7CiAgICB0aGlzLl9wcm9jZXNzU3RlcC5hcmdzID0gW107CiAgICBpZiAodGhpcy5pc1N1c3BlbmQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbWF0Y2hlZCA9IHRoaXMuX21hdGNoQ2hlY2sodGhpcy5mcmFnbWVudCwgdGhpcy5oYW5kbGVycyk7CiAgICBpc01hdGNoZWQgPSB0cnVlOwogICAgaWYgKG1hdGNoZWQgPT09IGZhbHNlIHx8IG1hdGNoZWQubGVuZ3RoIDwgMSkgewogICAgICBpZiAodGhpcy5ub3RGb3VuZCAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX25vdEZvdW5kLmNhbGxiYWNrKHRoaXMuZnJhZ21lbnQpOwogICAgICB9CiAgICAgIGlzTWF0Y2hlZCA9IGZhbHNlOwogICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5OT1RfRk9VTkQpKTsKICAgIH0gZWxzZSBpZiAobWF0Y2hlZC5sZW5ndGggPiAxKSB7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gbWF0Y2hlZC5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIG1hdGNoID0gbWF0Y2hlZFtfaV07CiAgICAgICAgaWYgKHRoaXMuZnJhZ21lbnQuaW5kZXhPZihtYXRjaC5ydWxlKSA+IC0xKSB7CiAgICAgICAgICBtYXRjaC5jYWxsYmFjayh0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IG1hdGNoZWQubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgICAgaGFuZGxlciA9IG1hdGNoZWRbX2pdOwogICAgICAgIGhhbmRsZXIuY2FsbGJhY2sodGhpcy5mcmFnbWVudCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLl9pc0ZpcnN0UmVxdWVzdCkgewogICAgICBzZXRUaW1lb3V0KChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIF90aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5GSVJTVF9SRVFVRVNULCBfdGhpcy5mcmFnbWVudCwgbnVsbCkpOwogICAgICAgICAgaWYgKGlzTWF0Y2hlZCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkVYRUNVVEVELCBfdGhpcy5mcmFnbWVudCwgbnVsbCkpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKHRoaXMpLCAwKTsKICAgICAgdGhpcy5faXNGaXJzdFJlcXVlc3QgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChpc01hdGNoZWQpIHsKICAgICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5FWEVDVVRFRCwgdGhpcy5mcmFnbWVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hdGNoZWQ7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmJlZm9yZUZhaWxlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB0aGlzLmJlZm9yZUZhaWxlZEhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9GQUlMRUQsIHRoaXMuYmVmb3JlRmFpbGVkKTsKICAgIHRoaXMuX2JlZm9yZURlZmZlci5yZW1vdmVFdmVudExpc3RlbmVyKEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9DT01QTEVURSwgdGhpcy5iZWZvcmVDb21wbGV0ZSk7CiAgICBpZiAodGhpcy5pc0JlZm9yZUZvcmNlKSB7CiAgICAgIHRoaXMuYmVmb3JlQ29tcGxldGUoKTsKICAgIH0KICAgIHRoaXMuX2JlZm9yZURlZmZlciA9IG51bGw7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLm9ic2VydmVVUkxIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBjdXJyZW50OwogICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgfQogICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKHRoaXMuaWZyYW1lKSB7CiAgICAgIHRoaXMuY2hhbmdlKGN1cnJlbnQpOwogICAgfQogICAgaWYgKHRoaXMubGFzdEZyYWdtZW50ID09PSBjdXJyZW50ICYmIHRoaXMuaXNVc2VyQWN0aW9uID09PSBmYWxzZSkgewogICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5QUkVWLCBjdXJyZW50LCB0aGlzLmZyYWdtZW50KSk7CiAgICB9IGVsc2UgaWYgKHRoaXMubGFzdEZyYWdtZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaXNVc2VyQWN0aW9uID09PSBmYWxzZSkgewogICAgICB0aGlzLl9kaXNwYXRjaGVyLmRpc3BhdGNoRXZlbnQobmV3IEtheml0b3JpRXZlbnQoS2F6aXRvcmlFdmVudC5ORVhULCBjdXJyZW50LCB0aGlzLmxhc3RGcmFnbWVudCkpOwogICAgfQogICAgdGhpcy5pc1VzZXJBY3Rpb24gPSBmYWxzZTsKICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChuZXcgS2F6aXRvcmlFdmVudChLYXppdG9yaUV2ZW50LkNIQU5HRSwgY3VycmVudCwgdGhpcy5sYXN0RnJhZ21lbnQpKTsKICAgIHJldHVybiB0aGlzLmxvYWRVUkwoY3VycmVudCk7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iaW5kUnVsZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciByb3V0ZXMsIHJ1bGUsIF9pLCBfbGVuOwogICAgaWYgKHRoaXMucm91dGVzID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVzID0gdGhpcy5fa2V5cyh0aGlzLnJvdXRlcyk7CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHJvdXRlcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICBydWxlID0gcm91dGVzW19pXTsKICAgICAgdGhpcy5yZWdpc3RlckhhbmRsZXIocnVsZSwgdGhpcy5yb3V0ZXNbcnVsZV0sIGZhbHNlKTsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JpbmRCZWZvcmVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYmVmb3Jlcywga2V5LCBfaSwgX2xlbjsKICAgIGlmICh0aGlzLmJlZm9yZUFueXRpbWUpIHsKICAgICAgdGhpcy5fYmluZEJlZm9yZUFueXRpbWUodGhpcy5iZWZvcmVBbnl0aW1lKTsKICAgIH0KICAgIGlmICh0aGlzLmJlZm9yZXMgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBiZWZvcmVzID0gdGhpcy5fa2V5cyh0aGlzLmJlZm9yZXMpOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBiZWZvcmVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGtleSA9IGJlZm9yZXNbX2ldOwogICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcihrZXksIHRoaXMuYmVmb3Jlc1trZXldLCB0cnVlKTsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2JpbmRCZWZvcmVBbnl0aW1lID0gZnVuY3Rpb24oZnVuY3MsIGJpbmRlZEZ1bmNzKSB7CiAgICB2YXIgY2FsbGJhY2s7CiAgICBjYWxsYmFjayA9IHRoaXMuX2JpbmRGdW5jdGlvbnMoZnVuY3MsIGJpbmRlZEZ1bmNzKTsKICAgIHRoaXMuYmVmb3JlQW55dGltZUhhbmRsZXIgPSB7CiAgICAgIGNhbGxiYWNrOiB0aGlzLl9iaW5kZXIoZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJnczsKICAgICAgICBhcmdzID0gW2ZyYWdtZW50XTsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0sIHRoaXMpCiAgICB9OwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fYmluZE5vdEZvdW5kID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2FsbGJhY2ssIG5vdEZvdW5kRnJhZ21lbnQsIG5vdEZvdW5kRnVuY05hbWUsIHJ1bGUsIF9pLCBfbGVuLCBfcmVmOwogICAgaWYgKHRoaXMubm90Rm91bmQgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodHlwZW9mIHRoaXMubm90Rm91bmQgPT09ICJzdHJpbmciKSB7CiAgICAgIF9yZWYgPSB0aGlzLmhhbmRsZXJzOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBydWxlID0gX3JlZltfaV07CiAgICAgICAgaWYgKHJ1bGUucnVsZSA9PT0gJy8nICsgdGhpcy5ub3RGb3VuZC5yZXBsYWNlKHRoaXMucm9vdCwgJycpKSB7CiAgICAgICAgICB0aGlzLl9ub3RGb3VuZCA9IHJ1bGU7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBub3RGb3VuZEZyYWdtZW50ID0gdGhpcy5fa2V5cyh0aGlzLm5vdEZvdW5kKVswXTsKICAgIH0KICAgIG5vdEZvdW5kRnVuY05hbWUgPSB0aGlzLm5vdEZvdW5kW25vdEZvdW5kRnJhZ21lbnRdOwogICAgaWYgKHR5cGVvZiBub3RGb3VuZEZ1bmNOYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrID0gbm90Rm91bmRGdW5jTmFtZTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrID0gdGhpc1tub3RGb3VuZEZ1bmNOYW1lXTsKICAgIH0KICAgIHRoaXMuX25vdEZvdW5kID0gbmV3IFJ1bGUobm90Rm91bmRGcmFnbWVudCwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgdmFyIGFyZ3M7CiAgICAgIGFyZ3MgPSB0aGlzLnJvdXRlci5leHRyYWN0UGFyYW1zKHRoaXMsIGZyYWdtZW50KTsKICAgICAgcmV0dXJuIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMucm91dGVyLCBhcmdzKTsKICAgIH0sIHRoaXMpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fdXBkYXRlSGFzaCA9IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgdmFyIGF0Um9vdCwgaHJlZjsKICAgIGF0Um9vdCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICBpZiAoIWF0Um9vdCkgewogICAgICBsb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIGZyYWdtZW50KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHJlcGxhY2UpIHsKICAgICAgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICB9IGVsc2UgewogICAgICBsb2NhdGlvbi5oYXNoID0gIiMiICsgZnJhZ21lbnQ7CiAgICB9CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl91cGRhdGVIYXNoSUUgPSBmdW5jdGlvbihmcmFnbWVudCwgcmVwbGFjZSkgewogICAgbG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyAnIy8nICsgZnJhZ21lbnQpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fbWF0Y2hDaGVjayA9IGZ1bmN0aW9uKGZyYWdtZW50LCBoYW5kbGVycywgdGVzdCkgewogICAgdmFyIGEsIGFyZ3MsIGFyZ3NNYXRjaCwgYXJnc01hdGNoZWQsIGhhbmRsZXIsIGhhc1F1ZXJ5LCBpLCBsZW4sIG1hdGNoLCBtYXRjaGVkLCB0LCB0bXBGcmFnLCBfaSwgX2osIF9sZW4sIF9sZW4xOwogICAgaWYgKHRlc3QgPT0gbnVsbCkgewogICAgICB0ZXN0ID0gZmFsc2U7CiAgICB9CiAgICBtYXRjaGVkID0gW107CiAgICB0bXBGcmFnID0gZnJhZ21lbnQ7CiAgICBpZiAodG1wRnJhZyAhPT0gdm9pZCAwICYmIHRtcEZyYWcgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGhhc1F1ZXJ5ID0gdGhpcy5fbWF0Y2guYXBwbHkodG1wRnJhZywgWy8oXD9bXHdcZD18XSspL2ddKTsKICAgIH0KICAgIGlmIChoYXNRdWVyeSkgewogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnNwbGl0KCc/JylbMF07CiAgICB9CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGhhbmRsZXJzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGhhbmRsZXIgPSBoYW5kbGVyc1tfaV07CiAgICAgIGlmIChoYW5kbGVyLnJ1bGUgPT09IGZyYWdtZW50KSB7CiAgICAgICAgbWF0Y2hlZC5wdXNoKGhhbmRsZXIpOwogICAgICB9IGVsc2UgaWYgKGhhbmRsZXIudGVzdChmcmFnbWVudCkpIHsKICAgICAgICBpZiAoaGFuZGxlci5pc1ZhcmlhYmxlICYmIGhhbmRsZXIudHlwZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgYXJncyA9IHRoaXMuZXh0cmFjdFBhcmFtcyhoYW5kbGVyLCBmcmFnbWVudCwgdGVzdCk7CiAgICAgICAgICBhcmdzTWF0Y2ggPSBbXTsKICAgICAgICAgIGxlbiA9IGFyZ3MubGVuZ3RoOwogICAgICAgICAgaSA9IDA7CiAgICAgICAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICAgICAgICBhID0gYXJnc1tpXTsKICAgICAgICAgICAgdCA9IGhhbmRsZXIudHlwZXNbaV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgYSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBpZiAodCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXJnc01hdGNoLnB1c2godHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFyZ3NNYXRjaC5wdXNoKHRoaXMuX3R5cGVDaGVjayhhLCB0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgIH0KICAgICAgICAgIGFyZ3NNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGFyZ3NNYXRjaC5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICAgICAgbWF0Y2ggPSBhcmdzTWF0Y2hbX2pdOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgYXJnc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyZ3NNYXRjaGVkKSB7CiAgICAgICAgICAgIG1hdGNoZWQucHVzaChoYW5kbGVyKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlZC5wdXNoKGhhbmRsZXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG1hdGNoZWQubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9OwoKCiAgLyoqCiAgKiBVUkwg44Or44O844OI5Lul5LiL44KS5Y+W5b6XCiAgKiBAbWV0aG9kIGdldEZyYWdtZW50CiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQKICAgKi8KCiAgS2F6aXRvcmkucHJvdG90eXBlLmdldEZyYWdtZW50ID0gZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgIHZhciBmcmFnLCBpbmRleCwgbWF0Y2hlZCwgcm9vdCwgX2ksIF9sZW4sIF9yZWY7CiAgICBpZiAoKGZyYWdtZW50ID09IG51bGwpIHx8IGZyYWdtZW50ID09PSB2b2lkIDApIHsKICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudENoYW5nZUhhc2gpIHsKICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgbWF0Y2hlZCA9IGZhbHNlOwogICAgICAgIGZyYWcgPSBmcmFnbWVudDsKICAgICAgICBpZiAoZnJhZy5tYXRjaCgvXlwvLykpIHsKICAgICAgICAgIGZyYWcgPSBmcmFnLnN1YnN0cigxKTsKICAgICAgICB9CiAgICAgICAgcm9vdCA9IHRoaXMucm9vdDsKICAgICAgICBpZiAocm9vdC5tYXRjaCgvXlwvLykpIHsKICAgICAgICAgIHJvb3QgPSByb290LnN1YnN0cigxKTsKICAgICAgICB9CiAgICAgICAgX3JlZiA9IHRoaXMucm9vdEZpbGVzOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgaW5kZXggPSBfcmVmW19pXTsKICAgICAgICAgIGlmIChpbmRleCA9PT0gZnJhZyB8fCByb290ICsgaW5kZXggPT09IGZyYWcpIHsKICAgICAgICAgICAgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaGVkKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMucm9vdDsKICAgICAgICB9CiAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudCArIHRoaXMubG9jYXRpb24uc2VhcmNoOwogICAgICAgIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgaWYgKGZyYWdtZW50LmluZGV4T2Yocm9vdCkgPiAtMSkgewogICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICBpZiAoZnJhZ21lbnQuaW5kZXhPZih0aGlzLnJvb3QpID4gLTEgJiYgZnJhZ21lbnQuaW5kZXhPZihyb290KSA+IC0xKSB7CiAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICB9CiAgICB9CiAgICBpZiAodHlwZW9mIGZyYWdtZW50ID09PSAic3RyaW5nIikgewogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICBpZiAoZnJhZ21lbnQgPT09ICIiKSB7CiAgICAgICAgZnJhZ21lbnQgPSAiLyI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmcmFnbWVudDsKICB9OwoKCiAgLyoqCiAgKiBVUkwg44GuICMg5Lul6ZmN44KS5Y+W5b6XCiAgKiBAbWV0aG9kIGdldEhhc2gKICAqIEByZXR1cm4ge1N0cmluZ30gVVJMIOOBriAjIOS7pemZjeOBruaWh+Wtl+WIlwogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuZ2V0SGFzaCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG1hdGNoOwogICAgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgaWYgKG1hdGNoICE9IG51bGwpIHsKICAgICAgcmV0dXJuIG1hdGNoWzFdOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogIH07CgoKICAvKioKICAqIFVSTCDjg5Hjg6njg6Hjg7zjgr/jgpLliIbop6MKICAqIEBtZXRob2QgZXh0cmFjdFBhcmFtcwogICogQHBhcmFtIHtSdWxlfSBydWxlCiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQKICAqIEBwYXJhbSB7Qm9vbGVhbn0gdGVzdAogICAqLwoKICBLYXppdG9yaS5wcm90b3R5cGUuZXh0cmFjdFBhcmFtcyA9IGZ1bmN0aW9uKHJ1bGUsIGZyYWdtZW50LCB0ZXN0KSB7CiAgICB2YXIgaywga3YsIGxhc3QsIG5ld1BhcmFtLCBuZXdRdWVyaWVzLCBwYXJhbSwgcSwgcXVlcmllcywgcXVlcnksIHF1ZXJ5UGFyYW1zLCB2LCBfaSwgX2xlbjsKICAgIGlmICh0ZXN0ID09IG51bGwpIHsKICAgICAgdGVzdCA9IGZhbHNlOwogICAgfQogICAgaWYgKHRoaXMuX3BhcmFtcy5wYXJhbXMubGVuZ3RoID4gMCAmJiB0aGlzLl9wYXJhbXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSB7CiAgICAgIHJldHVybiB0aGlzLl9wYXJhbXMucGFyYW1zOwogICAgfQogICAgcGFyYW0gPSBydWxlLl9yZWdleHAuZXhlYyhmcmFnbWVudCk7CiAgICBpZiAocGFyYW0gPT09IG51bGwgJiYgZnJhZ21lbnQuaW5kZXhPZignPycpID4gLTEpIHsKICAgICAgcGFyYW0gPSBbMCwgJz8nICsgZnJhZ21lbnQuc3BsaXQoJz8nKVsxXV07CiAgICB9CiAgICB0aGlzLl9wYXJhbXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgIGlmIChwYXJhbSAhPSBudWxsKSB7CiAgICAgIG5ld1BhcmFtID0gcGFyYW0uc2xpY2UoMSk7CiAgICAgIGxhc3QgPSBwYXJhbVtwYXJhbS5sZW5ndGggLSAxXTsKICAgICAgaWYgKGxhc3QuaW5kZXhPZignPycpID4gLTEpIHsKICAgICAgICBuZXdRdWVyaWVzID0ge307CiAgICAgICAgcXVlcmllcyA9IGxhc3Quc3BsaXQoJz8nKVsxXTsKICAgICAgICBxdWVyeVBhcmFtcyA9IHF1ZXJpZXMuc3BsaXQoJyYnKTsKICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHF1ZXJ5UGFyYW1zLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBxdWVyeSA9IHF1ZXJ5UGFyYW1zW19pXTsKICAgICAgICAgIGt2ID0gcXVlcnkuc3BsaXQoJz0nKTsKICAgICAgICAgIGsgPSBrdlswXTsKICAgICAgICAgIHYgPSBrdlsxXSA/IGt2WzFdIDogIiI7CiAgICAgICAgICBpZiAodi5pbmRleE9mKCd8JykgPiAtMSkgewogICAgICAgICAgICB2ID0gdi5zcGxpdCgifCIpOwogICAgICAgICAgfQogICAgICAgICAgbmV3UXVlcmllc1trXSA9IHY7CiAgICAgICAgfQogICAgICAgIG5ld1BhcmFtLnBvcCgpOwogICAgICAgIG5ld1BhcmFtLnB1c2gobGFzdC5zcGxpdCgnPycpWzBdKTsKICAgICAgICBxID0gewogICAgICAgICAgInF1ZXJpZXMiOiBuZXdRdWVyaWVzCiAgICAgICAgfTsKICAgICAgICBuZXdQYXJhbS5wdXNoKHEpOwogICAgICAgIGlmICghdGVzdCkgewogICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcmFtcyA9IHRoaXMuX2dldENhc3RlZFBhcmFtcyhydWxlLCBuZXdQYXJhbS5zbGljZSgwKSk7CiAgICAgICAgICB0aGlzLl9wYXJhbXMucXVlcmllcyA9IG5ld1F1ZXJpZXM7CiAgICAgICAgICBpZiAodGhpcy5pc09sZElFKSB7CiAgICAgICAgICAgIHRoaXMucGFyYW1zID0gdGhpcy5fcGFyYW1zLnBhcmFtczsKICAgICAgICAgICAgdGhpcy5xdWVyaWVzID0gdGhpcy5fcGFyYW1zLnF1ZXJpZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGVzdCkgewogICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcmFtcyA9IHRoaXMuX2dldENhc3RlZFBhcmFtcyhydWxlLCBuZXdQYXJhbSk7CiAgICAgICAgICBpZiAodGhpcy5pc09sZElFKSB7CiAgICAgICAgICAgIHRoaXMucGFyYW1zID0gdGhpcy5fcGFyYW1zLnBhcmFtczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5ld1BhcmFtOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcGFyYW1zLnBhcmFtcyA9IFtdOwogICAgICBpZiAodGhpcy5pc09sZElFKSB7CiAgICAgICAgdGhpcy5wYXJhbSA9IFtdOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fZ2V0Q2FzdGVkUGFyYW1zID0gZnVuY3Rpb24ocnVsZSwgcGFyYW1zKSB7CiAgICB2YXIgY2FzdGVkUGFyYW1zLCBpLCBsZW4sIHR5cGUsIF9pLCBfbGVuOwogICAgaSA9IDA7CiAgICBpZiAoIXBhcmFtcykgewogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQogICAgaWYgKHJ1bGUudHlwZXMubGVuZ3RoIDwgMSkgewogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQogICAgbGVuID0gcGFyYW1zLmxlbmd0aDsKICAgIGNhc3RlZFBhcmFtcyA9IFtdOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgaWYgKHJ1bGUudHlwZXNbaV0gPT09IG51bGwpIHsKICAgICAgICBjYXN0ZWRQYXJhbXMucHVzaChwYXJhbXNbaV0pOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXJhbXNbaV0gPT09ICJvYmplY3QiKSB7CiAgICAgICAgY2FzdGVkUGFyYW1zLnB1c2gocGFyYW1zW2ldKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IFZBUklBQkxFX1RZUEVTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICB0eXBlID0gVkFSSUFCTEVfVFlQRVNbX2ldOwogICAgICAgICAgaWYgKHJ1bGUudHlwZXNbaV0gPT09IHR5cGUubmFtZSkgewogICAgICAgICAgICBjYXN0ZWRQYXJhbXMucHVzaCh0eXBlLmNhc3QocGFyYW1zW2ldKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGkrKzsKICAgIH0KICAgIHJldHVybiBjYXN0ZWRQYXJhbXM7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdGhpcy5fZGlzcGF0Y2hlci5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyKTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB0aGlzLl9kaXNwYXRjaGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHRoaXMuX2Rpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9hZGRQb3BTdGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciB3aW47CiAgICB3aW4gPSB3aW5kb3c7CiAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlID09PSB0cnVlKSB7CiAgICAgIHdpbi5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgfQogICAgaWYgKHRoaXMuX3dhbnRDaGFuZ2VIYXNoID09PSB0cnVlICYmICF0aGlzLmlzT2xkSUUpIHsKICAgICAgd2luLmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLm9ic2VydmVVUkxIYW5kbGVyKTsKICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudENoYW5nZUhhc2ggPT09IHRydWUpIHsKICAgICAgd2luLmF0dGFjaEV2ZW50KCdvbmhhc2hjaGFuZ2UnLCB0aGlzLm9ic2VydmVVUkxIYW5kbGVyKTsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3JlbW92ZVBvcFN0YXRlSGFuZGxlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHdpbjsKICAgIHdpbiA9IHdpbmRvdzsKICAgIHdpbi5yZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMub2JzZXJ2ZVVSTEhhbmRsZXIpOwogICAgd2luLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLm9ic2VydmVVUkxIYW5kbGVyKTsKICAgIGlmICh0aGlzLmlzT2xkSUUpIHsKICAgICAgd2luLmRldGFjaEV2ZW50KCdvbmhhc2hjaGFuZ2UnLCB0aGlzLm9ic2VydmVVUkxIYW5kbGVyKTsKICAgIH0KICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3NsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX3JlcGxhY2UgPSBTdHJpbmcucHJvdG90eXBlLnJlcGxhY2U7CgogIEtheml0b3JpLnByb3RvdHlwZS5fbWF0Y2ggPSBTdHJpbmcucHJvdG90eXBlLm1hdGNoOwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2tleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIHZhciBrZXksIGtleXM7CiAgICBpZiAob2JqID09PSAhT2JqZWN0KG9iaikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignb2JqZWN0IGphIG5haScpOwogICAgfQogICAga2V5cyA9IFtdOwogICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgICBrZXlzW2tleXMubGVuZ3RoXSA9IGtleTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iaW5kZXIgPSBmdW5jdGlvbihmdW5jLCBvYmopIHsKICAgIHZhciBhcmdzLCBzbGljZTsKICAgIHNsaWNlID0gdGhpcy5fc2xpY2U7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZnVuYy5hcHBseShvYmogfHwge30sIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKICB9OwoKICBLYXppdG9yaS5wcm90b3R5cGUuX2V4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgdGhpcy5fZWFjaCh0aGlzLl9zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICB2YXIgcHJvcCwgX3Jlc3VsdHM7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBfcmVzdWx0cyA9IFtdOwogICAgICAgIGZvciAocHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIF9yZXN1bHRzLnB1c2gob2JqW3Byb3BdID0gc291cmNlW3Byb3BdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9lYWNoID0gZnVuY3Rpb24ob2JqLCBpdGVyLCBjdHgpIHsKICAgIHZhciBlYWNoLCBpLCBrLCBsOwogICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaDsKICAgIGlmIChlYWNoICYmIG9iai5mb3JFYWNoID09PSBlYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXIsIGN0eCk7CiAgICB9IGVsc2UgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSB7CiAgICAgIGkgPSAwOwogICAgICBsID0gb2JqLmxlbmd0aDsKICAgICAgd2hpbGUgKGkgPCBsKSB7CiAgICAgICAgaWYgKGl0ZXIuY2FsbChjdHgsIG9ialtpXSwgaSwgb2JqKSA9PT0gdGhpcy5icmVha2VyKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGkrKzsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChrIGluIG9iaikgewogICAgICAgIGlmIChfX2luZGV4T2YuY2FsbChvYmosIGspID49IDApIHsKICAgICAgICAgIGlmIChpdGVyLmNhbGwoY3R4LCBvYmpba10sIGssIG9iaikgPT09IHRoaXMuYnJlYWtlcikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgS2F6aXRvcmkucHJvdG90eXBlLl9iaW5kRnVuY3Rpb25zID0gZnVuY3Rpb24oZnVuY3MsIGluc2VydCkgewogICAgdmFyIGJpbmRlZEZ1bmNzLCBjYWxsYmFjaywgZiwgZnVuYywgZnVuY05hbWUsIGksIGxlbiwgbmFtZXMsIG5ld0YsIF9pLCBfbGVuOwogICAgaWYgKHR5cGVvZiBmdW5jcyA9PT0gJ3N0cmluZycpIHsKICAgICAgZnVuY3MgPSBmdW5jcy5zcGxpdCgnLCcpOwogICAgfQogICAgYmluZGVkRnVuY3MgPSBbXTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZnVuY3MubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgZnVuY05hbWUgPSBmdW5jc1tfaV07CiAgICAgIGZ1bmMgPSB0aGlzW2Z1bmNOYW1lXTsKICAgICAgaWYgKGZ1bmMgPT0gbnVsbCkgewogICAgICAgIG5hbWVzID0gZnVuY05hbWUuc3BsaXQoJy4nKTsKICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMSkgewogICAgICAgICAgZiA9IHdpbmRvd1tuYW1lc1swXV07CiAgICAgICAgICBpID0gMTsKICAgICAgICAgIGxlbiA9IG5hbWVzLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgICAgICAgIG5ld0YgPSBmW25hbWVzW2ldXTsKICAgICAgICAgICAgaWYgKG5ld0YgIT0gbnVsbCkgewogICAgICAgICAgICAgIGYgPSBuZXdGOwogICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuYyA9IGY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZ1bmMgPSB3aW5kb3dbZnVuY05hbWVdOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZnVuYyAhPSBudWxsKSB7CiAgICAgICAgYmluZGVkRnVuY3MucHVzaChmdW5jKTsKICAgICAgfQogICAgfQogICAgaWYgKGluc2VydCkgewogICAgICBiaW5kZWRGdW5jcyA9IGluc2VydC5jb25jYXQoYmluZGVkRnVuY3MpOwogICAgfQogICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MsIF9qLCBfbGVuMTsKICAgICAgYXJncyA9IDEgPD0gYXJndW1lbnRzLmxlbmd0aCA/IF9fc2xpY2UuY2FsbChhcmd1bWVudHMsIDApIDogW107CiAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGJpbmRlZEZ1bmNzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICAgIGZ1bmMgPSBiaW5kZWRGdW5jc1tfal07CiAgICAgICAgZnVuYy5hcHBseSh0aGlzLCBfX3NsaWNlLmNhbGwoYXJncykpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIGNhbGxiYWNrOwogIH07CgogIEtheml0b3JpLnByb3RvdHlwZS5fdHlwZUNoZWNrID0gZnVuY3Rpb24oYSwgdCkgewogICAgdmFyIG1hdGNoZWQsIHR5cGUsIF9pLCBfbGVuOwogICAgbWF0Y2hlZCA9IGZhbHNlOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBWQVJJQUJMRV9UWVBFUy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICB0eXBlID0gVkFSSUFCTEVfVFlQRVNbX2ldOwogICAgICBpZiAodC50b0xvd2VyQ2FzZSgpID09PSB0eXBlLm5hbWUpIHsKICAgICAgICBpZiAodHlwZS5jYXN0KGEpKSB7CiAgICAgICAgICBtYXRjaGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXRjaGVkOwogIH07CgogIHJldHVybiBLYXppdG9yaTsKCn0pKCk7CgoKLyoqCiogcHVzaFN0YXRlIOOBp+WHpueQhuOBl+OBn+OBhOODq+ODvOODq+OCkuWumue+qeOBmeOCi+OCr+ODqeOCuQoqCiogQGNsYXNzIFJ1bGUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1N0cmluZ30gcnVsZQoqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiogQHBhcmFtIHtLYXppdG9yaX0gcm91dGVyCiAqLwoKUnVsZSA9IChmdW5jdGlvbigpIHsKCiAgLyoqCiAgKiDjg6vjg7zjg6vmloflrZfliJcKICAqIEBwcm9wZXJ0eSBydWxlCiAgKiBAdHlwZSBTdHJpbmcKICAqIEBkZWZhdWx0ICIiCiAgICovCiAgUnVsZS5wcm90b3R5cGUucnVsZSA9ICIiOwoKICBSdWxlLnByb3RvdHlwZS5fcmVnZXhwID0gbnVsbDsKCgogIC8qKgogICog44Kz44O844Or44OQ44OD44Kv6Zai5pWwCiAgKiDjg6vjg7zjg6vjgajjg57jg4Pjg4HjgZnjgovloLTlkIjlrp/ooYzjgZXjgozjgb7jgZnjgIIKICAqIEBwcm9wZXJ0eSBjYWxsYmFjawogICogQHR5cGU6IEZ1bmN0aW9uCiAgKiBAZGVmYXVsdCBudWxsCiAgICovCgogIFJ1bGUucHJvdG90eXBlLmNhbGxiYWNrID0gbnVsbDsKCiAgUnVsZS5wcm90b3R5cGUubmFtZSA9ICIiOwoKICBSdWxlLnByb3RvdHlwZS5yb3V0ZXIgPSBudWxsOwoKICBSdWxlLnByb3RvdHlwZS5pc1ZhcmlhYmxlID0gZmFsc2U7CgogIFJ1bGUucHJvdG90eXBlLnR5cGVzID0gW107CgogIGZ1bmN0aW9uIFJ1bGUocnVsZSwgY2FsbGJhY2ssIHJvdXRlcikgewogICAgdGhpcy51cGRhdGUgPSBfX2JpbmQodGhpcy51cGRhdGUsIHRoaXMpOwogICAgaWYgKHR5cGVvZiBydWxlICE9PSAic3RyaW5nIiAmJiB0eXBlb2YgcnVsZSAhPT0gIk51bWJlciIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7CiAgICB0aGlzLnVwZGF0ZShydWxlKTsKICB9CgoKICAvKioKICAqIFJ1bGUg44Go44GX44Gm5a6a576p44GX44Gf44OR44K/44O844Oz44GoIGZyYWdtZW50IOOBqOOBl+OBpuS4juOBiOOCieOCjOOBn+aWh+Wtl+WIl+OBjOODnuODg+ODgeOBmeOCi+OBi+OBqeOBhuOBi+ODhuOCueODiOOBmeOCiwogICogQG1ldGhvZCB0ZXN0CiAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQKICAqIEByZXR1cm4ge0Jvb2xlYW59IOODnuODg+ODgeOBmeOCi+WgtOWQiCB0cnVlIOOCkui/lOOBmQogICAqLwoKICBSdWxlLnByb3RvdHlwZS50ZXN0ID0gZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgIHJldHVybiB0aGlzLl9yZWdleHAudGVzdChmcmFnbWVudCk7CiAgfTsKCiAgUnVsZS5wcm90b3R5cGUuX3J1bGVUb1JlZ0V4cCA9IGZ1bmN0aW9uKHJ1bGUpIHsKICAgIHZhciBuZXdSdWxlOwogICAgbmV3UnVsZSA9IHJ1bGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpLnJlcGxhY2UobmFtZWRQYXJhbSwgJyhbXlwvXSspJykucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG5ld1J1bGUgKyAnJCcpOwogIH07CgoKICAvKioKICAqIOS4juOBiOOCieOCjOOBnyBwYXRoIOOBp+ePvuWcqOOBriBSdWxlIOOCkuOCouODg+ODl+ODh+ODvOODiOOBl+OBvuOBmeOAggogICogQG1ldGhvZCB1cGRhdGUKICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICovCgogIFJ1bGUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKHBhdGgpIHsKICAgIHZhciBtLCBtYXRjaGVkLCByZSwgdCwgX2ksIF9sZW47CiAgICB0aGlzLnJ1bGUgPSBwYXRoICsgdGhpcy5ydWxlOwogICAgaWYgKHRoaXMucnVsZSAhPT0gJy8nKSB7CiAgICAgIHRoaXMucnVsZSA9IHRoaXMucnVsZS5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgIH0KICAgIHRoaXMuX3JlZ2V4cCA9IHRoaXMuX3J1bGVUb1JlZ0V4cCh0aGlzLnJ1bGUpOwogICAgcmUgPSBuZXcgUmVnRXhwKG5hbWVkUGFyYW0pOwogICAgbWF0Y2hlZCA9IHBhdGgubWF0Y2gocmUpOwogICAgaWYgKG1hdGNoZWQgIT09IG51bGwpIHsKICAgICAgdGhpcy5pc1ZhcmlhYmxlID0gdHJ1ZTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtYXRjaGVkLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgbSA9IG1hdGNoZWRbX2ldOwogICAgICAgIHQgPSBtLm1hdGNoKGdlbmVyaWNQYXJhbSkgfHwgbnVsbDsKICAgICAgICB0aGlzLnR5cGVzLnB1c2godCAhPT0gbnVsbCA/IHRbMV0gOiBudWxsKTsKICAgICAgfQogICAgfQogIH07CgogIHJldHVybiBSdWxlOwoKfSkoKTsKCgovKioKKiDjgqTjg5njg7Pjg4jjg4fjgqPjgrnjg5Hjg4Pjg4Hjg6MKKiBAY2xhc3MgRXZlbnREaXNwYXRjaGVyCiogQGNvbnN0cnVjdG9yCiAqLwoKRXZlbnREaXNwYXRjaGVyID0gKGZ1bmN0aW9uKCkgewogIGZ1bmN0aW9uIEV2ZW50RGlzcGF0Y2hlcigpIHt9CgogIEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGUubGlzdGVuZXJzID0ge307CgogIEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBpZiAodGhpcy5saXN0ZW5lcnNbdHlwZV0gPT09IHZvaWQgMCkgewogICAgICB0aGlzLmxpc3RlbmVyc1t0eXBlXSA9IFtdOwogICAgfQogICAgaWYgKHRoaXMuX2luQXJyYXkobGlzdGVuZXIsIHRoaXMubGlzdGVuZXJzW3R5cGVdKSA8IDApIHsKICAgICAgdGhpcy5saXN0ZW5lcnNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9CiAgfTsKCiAgRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZS5yZW1vdmVFdmVudExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHZhciBhcnIsIGksIGxlbiwgcHJvcDsKICAgIGxlbiA9IDA7CiAgICBmb3IgKHByb3AgaW4gdGhpcy5saXN0ZW5lcnMpIHsKICAgICAgbGVuKys7CiAgICB9CiAgICBpZiAobGVuIDwgMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBhcnIgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgIGlmICghYXJyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGkgPSAwOwogICAgbGVuID0gYXJyLmxlbmd0aDsKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIGlmIChhcnJbaV0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgaWYgKGxlbiA9PT0gMSkgewogICAgICAgICAgZGVsZXRlIHRoaXMubGlzdGVuZXJzW3R5cGVdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnIuc3BsaWNlKGksIDEpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpKys7CiAgICB9CiAgfTsKCiAgRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZS5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBhcnksIGhhbmRsZXIsIF9pLCBfbGVuOwogICAgYXJ5ID0gdGhpcy5saXN0ZW5lcnNbZXZlbnQudHlwZV07CiAgICBpZiAoYXJ5ICE9PSB2b2lkIDApIHsKICAgICAgZXZlbnQudGFyZ2V0ID0gdGhpczsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhcnkubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBoYW5kbGVyID0gYXJ5W19pXTsKICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgZXZlbnQpOwogICAgICB9CiAgICB9CiAgfTsKCiAgRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZS5faW5BcnJheSA9IGZ1bmN0aW9uKGVsZW0sIGFycmF5KSB7CiAgICB2YXIgaSwgbGVuOwogICAgaSA9IDA7CiAgICBsZW4gPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICBpZiAoYXJyYXlbaV0gPT09IGVsZW0pIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgICBpKys7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgcmV0dXJuIEV2ZW50RGlzcGF0Y2hlcjsKCn0pKCk7CgpEZWZmZXJlZCA9IChmdW5jdGlvbihfc3VwZXIpIHsKICBfX2V4dGVuZHMoRGVmZmVyZWQsIF9zdXBlcik7CgogIERlZmZlcmVkLnByb3RvdHlwZS5xdWV1ZSA9IFtdOwoKICBEZWZmZXJlZC5wcm90b3R5cGUuaXNTdXNwZW5kID0gZmFsc2U7CgogIGZ1bmN0aW9uIERlZmZlcmVkKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5pc1N1c3BlbmQgPSBmYWxzZTsKICB9CgogIERlZmZlcmVkLnByb3RvdHlwZS5kZWZmZXJlZCA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHRoaXMucXVldWUucHVzaChmdW5jKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIERlZmZlcmVkLnByb3RvdHlwZS5leGVjdXRlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZXJyb3IsIHRhc2s7CiAgICBpZiAodGhpcy5pc1N1c3BlbmQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgdGFzayA9IHRoaXMucXVldWUuc2hpZnQoKTsKICAgICAgaWYgKHRhc2spIHsKICAgICAgICB0YXNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMucXVldWUubGVuZ3RoIDwgMSkgewogICAgICAgIHRoaXMucXVldWUgPSBbXTsKICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBLYXppdG9yaUV2ZW50KEtheml0b3JpRXZlbnQuVEFTS19RVUVVRV9DT01QTEVURSkpOwogICAgICB9CiAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgZXJyb3IgPSBfZXJyb3I7CiAgICAgIHJldHVybiB0aGlzLnJlamVjdChlcnJvcik7CiAgICB9CiAgfTsKCiAgRGVmZmVyZWQucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICB2YXIgbWVzc2FnZTsKICAgIG1lc3NhZ2UgPSAhZXJyb3IgPyAidXNlciByZWplY3QiIDogZXJyb3I7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICB0eXBlOiBLYXppdG9yaUV2ZW50LlRBU0tfUVVFVUVfRkFJTEVELAogICAgICBpbmRleDogdGhpcy5pbmRleCwKICAgICAgbWVzc2FnZTogbWVzc2FnZQogICAgfSk7CiAgICB0aGlzLmlzU3VzcGVuZCA9IGZhbHNlOwogIH07CgogIERlZmZlcmVkLnByb3RvdHlwZS5zdXNwZW5kID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmlzU3VzcGVuZCA9IHRydWU7CiAgfTsKCiAgRGVmZmVyZWQucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5pc1N1c3BlbmQgPSBmYWxzZTsKICAgIHRoaXMuZXhlY3V0ZSgpOwogIH07CgogIHJldHVybiBEZWZmZXJlZDsKCn0pKEV2ZW50RGlzcGF0Y2hlcik7CgoKLyoqCiogcHVzaFN0YXRlIOWHpueQhuOChCBLYXppdG9yaSDjgavjgb7jgaTjgo/jgovjgqTjg5njg7Pjg4gKKiBAY2xhc3MgS2F6aXRvcmlFdmVudAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiogQHBhcmFtIHtTdHJpbmd9IG5leHQKKiBAcGFyYW0ge1N0cmluZ30gcHJldgogKi8KCktheml0b3JpRXZlbnQgPSAoZnVuY3Rpb24oKSB7CiAgS2F6aXRvcmlFdmVudC5wcm90b3R5cGUubmV4dCA9IG51bGw7CgogIEtheml0b3JpRXZlbnQucHJvdG90eXBlLnByZXYgPSBudWxsOwoKICBLYXppdG9yaUV2ZW50LnByb3RvdHlwZS50eXBlID0gbnVsbDsKCiAgZnVuY3Rpb24gS2F6aXRvcmlFdmVudCh0eXBlLCBuZXh0LCBwcmV2KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5uZXh0ID0gbmV4dDsKICAgIHRoaXMucHJldiA9IHByZXY7CiAgfQoKICBLYXppdG9yaUV2ZW50LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBLYXppdG9yaUV2ZW50KHRoaXMudHlwZSwgdGhpcy5uZXh0LCB0aGlzLnByZXYpOwogIH07CgogIEtheml0b3JpRXZlbnQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIktheml0b3JpRXZlbnQgOjogIiArICJ0eXBlOiIgKyB0aGlzLnR5cGUgKyAiIG5leHQ6IiArIFN0cmluZyh0aGlzLm5leHQpICsgIiBwcmV2OiIgKyBTdHJpbmcodGhpcy5wcmV2KTsKICB9OwoKICByZXR1cm4gS2F6aXRvcmlFdmVudDsKCn0pKCk7CgoKLyoqCiog44K/44K544Kv44Kt44Ol44O844GM56m644Gr44Gq44Gj44GfCiogQHByb3BlcnR5IFRBU0tfUVVFVUVfQ09NUExFVEUKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCB0YXNrX3F1ZXVlX2NvbXBsZXRlCiAqLwoKS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0NPTVBMRVRFID0gJ3Rhc2tfcXVldWVfY29tcGxldGUnOwoKCi8qKgoqIOOCv+OCueOCr+OCreODpeODvOOBjOS4reaWreOBleOCjOOBnwoqIEBwcm9wZXJ0eSBUQVNLX1FVRVVFX0ZBSUxFRAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHRhc2tfcXVldWVfZmFpbGVkCiAqLwoKS2F6aXRvcmlFdmVudC5UQVNLX1FVRVVFX0ZBSUxFRCA9ICd0YXNrX3F1ZXVlX2ZhaWxlZCc7CgoKLyoqCiogVVJMIOOBjOWkieabtOOBleOCjOOBnwoqIEBwcm9wZXJ0eSBDSEFOR0UKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBjaGFuZ2UKICovCgpLYXppdG9yaUV2ZW50LkNIQU5HRSA9ICdjaGFuZ2UnOwoKCi8qKgoqIFVSTCDjgavnmbvpjLLjgZXjgozjgZ/jg6Hjgr3jg4Pjg4njgYzjgaHjgoPjgpPjgajlrp/ooYzjgZXjgozjgZ8KKiBAcHJvcGVydHkgRVhFQ1VURUQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBleGVjdXRlZAogKi8KCktheml0b3JpRXZlbnQuRVhFQ1VURUQgPSAnZXhlY3V0ZWQnOwoKCi8qKgoqIOS6i+WJjeWHpueQhuOBjOWujOS6huOBl+OBnwoqIEBwcm9wZXJ0eSBCRUZPUkVfRVhFQ1VURUQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBiZWZvcmVfZXhlY3V0ZWQKICovCgpLYXppdG9yaUV2ZW50LkJFRk9SRV9FWEVDVVRFRCA9ICdiZWZvcmVfZXhlY3V0ZWQnOwoKCi8qKgoqIOODpuODvOOCtuODvOOCouOCr+OCt+ODp+ODs+S7peWkluOBpyBVUkwg44Gu5aSJ5pu044GM44GC44Gj44GfCiogQHByb3BlcnR5IElOVEVSTkFMX0NIQU5HRQoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGludGVybmFsX2NoYW5nZQogKi8KCktheml0b3JpRXZlbnQuSU5URVJOQUxfQ0hBTkdFID0gJ2ludGVybmFsX2NoYW5nZSc7CgpLYXppdG9yaUV2ZW50LlVTRVJfQ0hBTkdFID0gJ3VzZXJfY2hhbmdlJzsKCgovKioKKiDjg5Ljgrnjg4jjg6rjg7zjg5Djg4Pjgq/jgZfjgZ8KKiBAcHJvcGVydHkgUFJFVgoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHByZXYKICovCgpLYXppdG9yaUV2ZW50LlBSRVYgPSAncHJldic7CgoKLyoqCiog44OS44K544OI44Oq44O844ON44Kv44K544OI44GX44Gf5pmCCiogQHByb3BlcnR5IE5FWFQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBuZXh0CiAqLwoKS2F6aXRvcmlFdmVudC5ORVhUID0gJ25leHQnOwoKCi8qKgoqIEtheml0b3JpIOOBjOS4reaWreOBl+OBnwoqIEBwcm9wZXJ0eSBSRUpFQ1QKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCByZWplY3QKICovCgpLYXppdG9yaUV2ZW50LlJFSkVDVCA9ICdyZWplY3QnOwoKCi8qKgoqIFVSTCDjgavjg57jg4Pjg4HjgZnjgovlh6bnkIbjgYzopovjgaTjgYvjgonjgarjgYvjgaPjgZ8KKiBAcHJvcGVydHkgTk9UX0ZPVU5ECiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgbm90X2ZvdW5kCiAqLwoKS2F6aXRvcmlFdmVudC5OT1RfRk9VTkQgPSAnbm90X2ZvdW5kJzsKCgovKioKKiBLYXppdG9yaSDjgYzplovlp4vjgZfjgZ8KKiBAcHJvcGVydHkgU1RBUlQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBzdGFydAogKi8KCktheml0b3JpRXZlbnQuU1RBUlQgPSAnc3RhcnQnOwoKCi8qKgoqIEtheml0b3JpIOOBjOWBnOatouOBl+OBnwoqIEBwcm9wZXJ0eSBTVE9QCiogQHR5cGUgU3RyaW5nCiogQGRlZmF1bHQgc3RvcAogKi8KCktheml0b3JpRXZlbnQuU1RPUCA9ICdzdG9wJzsKCgovKioKKiBLYXppdG9yaSDjgYzkuIDmmYLlgZzmraLjgZfjgZ8KKiBAcHJvcGVydHkgU1VTUEVORAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IFNVU1BFTkQKICovCgpLYXppdG9yaUV2ZW50LlNVU1BFTkQgPSAnU1VTUEVORCc7CgoKLyoqCiogS2F6aXRvcmkg44GM5YaN6ZaL44GX44GfCiogQHByb3BlcnR5IFJFU1VNRQoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IHJlc3VtZQogKi8KCktheml0b3JpRXZlbnQuUkVTVU1FID0gJ3Jlc3VtZSc7CgoKLyoqCiogS2F6aXRvcmkg44GM6ZaL5aeL44GX44Gm44GL44KJ44CB5LiA55Wq5pyA5Yid44Gu44Ki44Kv44K744K544GM44GC44Gj44GfCiogQHByb3BlcnR5IEZJUlNUX1JFUVVFU1QKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCBmaXJzdF9yZXF1ZXN0CiAqLwoKS2F6aXRvcmlFdmVudC5GSVJTVF9SRVFVRVNUID0gJ2ZpcnN0X3JlcXVlc3QnOwoKCi8qKgoqIOODq+ODvOOCv+ODvOOBjOi/veWKoOOBleOCjOOBnwoqIEBwcm9wZXJ0eSBBRERFRAoqIEB0eXBlIFN0cmluZwoqIEBkZWZhdWx0IGFkZGVkCiAqLwoKS2F6aXRvcmlFdmVudC5BRERFRCA9ICdhZGRlZCc7CgoKLyoqCiog44Or44O844K/44O844GM5YmK6Zmk44GV44KM44GfCiogQHByb3BlcnR5IFJFTU9WRUQKKiBAdHlwZSBTdHJpbmcKKiBAZGVmYXVsdCByZW1vdmVkCiAqLwoKS2F6aXRvcmlFdmVudC5SRU1PVkVEID0gJ3JlbW92ZWQnOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 07:57:58 GMT",
                    "Content-Length": "51149",
                    "Date": "Fri, 07 Nov 2014 07:57:58 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}