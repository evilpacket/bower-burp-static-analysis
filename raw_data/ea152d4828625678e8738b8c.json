{
    "url": "http://localhost:9999/onilabs/stratifiedjs/src/deps/html2canvas/build/html2canvas.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>link.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/onilabs/stratifiedjs/src/deps/html2canvas/build/html2canvas.js",
                "path": "/onilabs/stratifiedjs/src/deps/html2canvas/build/html2canvas.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vbmlsYWJzL3N0cmF0aWZpZWRqcy9zcmMvZGVwcy9odG1sMmNhbnZhcy9idWlsZC9odG1sMmNhbnZhcy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTQwMDkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMTQ6NTM6MTEgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDE0OjUzOjExIEdNVA0KDQovKgogIGh0bWwyY2FudmFzIDAuNC4xIDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDEzIE5pa2xhcyB2b24gSGVydHplbgoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCl7CgoidXNlIHN0cmljdCI7Cgp2YXIgX2h0bWwyY2FudmFzID0ge30sCnByZXZpb3VzRWxlbWVudCwKY29tcHV0ZWRDU1MsCmh0bWwyY2FudmFzOwoKX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsKCl9odG1sMmNhbnZhcy5VdGlsLmxvZyA9IGZ1bmN0aW9uKGEpIHsKICBpZiAoX2h0bWwyY2FudmFzLmxvZ2dpbmcgJiYgd2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUubG9nKSB7CiAgICB3aW5kb3cuY29uc29sZS5sb2coYSk7CiAgfQp9OwoKX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQgPSAoZnVuY3Rpb24oaXNOYXRpdmUpewogIHJldHVybiBmdW5jdGlvbihpbnB1dCkgewogICAgcmV0dXJuIGlzTmF0aXZlID8gaXNOYXRpdmUuYXBwbHkoaW5wdXQpIDogKChpbnB1dCB8fCAnJykgKyAnJykucmVwbGFjZSggL15ccyt8XHMrJC9nICwgJycgKTsKICB9Owp9KShTdHJpbmcucHJvdG90eXBlLnRyaW0pOwoKX2h0bWwyY2FudmFzLlV0aWwuYXNGbG9hdCA9IGZ1bmN0aW9uKHYpIHsKICByZXR1cm4gcGFyc2VGbG9hdCh2KTsKfTsKCihmdW5jdGlvbigpIHsKICAvLyBUT0RPOiBzdXBwb3J0IGFsbCBwb3NzaWJsZSBsZW5ndGggdmFsdWVzCiAgdmFyIFRFWFRfU0hBRE9XX1BST1BFUlRZID0gLygocmdiYXxyZ2IpXChbXlwpXStcKShccy0/XGQrcHgpezAsfSkvZzsKICB2YXIgVEVYVF9TSEFET1dfVkFMVUVTID0gLygtP1xkK3B4KXwoIy4rKXwocmdiXCguK1wpKXwocmdiYVwoLitcKSkvZzsKICBfaHRtbDJjYW52YXMuVXRpbC5wYXJzZVRleHRTaGFkb3dzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlIHx8IHZhbHVlID09PSAnbm9uZScpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQoKICAgIC8vIGZpbmQgbXVsdGlwbGUgc2hhZG93IGRlY2xhcmF0aW9ucwogICAgdmFyIHNoYWRvd3MgPSB2YWx1ZS5tYXRjaChURVhUX1NIQURPV19QUk9QRVJUWSksCiAgICAgIHJlc3VsdHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBzaGFkb3dzICYmIChpIDwgc2hhZG93cy5sZW5ndGgpOyBpKyspIHsKICAgICAgdmFyIHMgPSBzaGFkb3dzW2ldLm1hdGNoKFRFWFRfU0hBRE9XX1ZBTFVFUyk7CiAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgY29sb3I6IHNbMF0sCiAgICAgICAgb2Zmc2V0WDogc1sxXSA/IHNbMV0ucmVwbGFjZSgncHgnLCAnJykgOiAwLAogICAgICAgIG9mZnNldFk6IHNbMl0gPyBzWzJdLnJlcGxhY2UoJ3B4JywgJycpIDogMCwKICAgICAgICBibHVyOiBzWzNdID8gc1szXS5yZXBsYWNlKCdweCcsICcnKSA6IDAKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Owp9KSgpOwoKX2h0bWwyY2FudmFzLlV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIHZhciB3aGl0ZXNwYWNlID0gJyBcclxuXHQnLAogICAgICAgIG1ldGhvZCwgZGVmaW5pdGlvbiwgcHJlZml4LCBwcmVmaXhfaSwgYmxvY2ssIHJlc3VsdHMgPSBbXSwKICAgICAgICBjLCBtb2RlID0gMCwgbnVtUGFyZW4gPSAwLCBxdW90ZSwgYXJnczsKCiAgICB2YXIgYXBwZW5kUmVzdWx0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZihtZXRob2QpIHsKICAgICAgICAgICAgaWYoZGVmaW5pdGlvbi5zdWJzdHIoIDAsIDEgKSA9PT0gJyInKSB7CiAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gZGVmaW5pdGlvbi5zdWJzdHIoIDEsIGRlZmluaXRpb24ubGVuZ3RoIC0gMiApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGRlZmluaXRpb24pIHsKICAgICAgICAgICAgICAgIGFyZ3MucHVzaChkZWZpbml0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihtZXRob2Quc3Vic3RyKCAwLCAxICkgPT09ICctJyAmJgogICAgICAgICAgICAgICAgICAgIChwcmVmaXhfaSA9IG1ldGhvZC5pbmRleE9mKCAnLScsIDEgKSArIDEpID4gMCkgewogICAgICAgICAgICAgICAgcHJlZml4ID0gbWV0aG9kLnN1YnN0ciggMCwgcHJlZml4X2kpOwogICAgICAgICAgICAgICAgbWV0aG9kID0gbWV0aG9kLnN1YnN0ciggcHJlZml4X2kgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICAgICAgcHJlZml4OiBwcmVmaXgsCiAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZC50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgYXJncyA9IFtdOyAvL2ZvciBzb21lIG9kZCByZWFzb24sIHNldHRpbmcgLmxlbmd0aCA9IDAgZGlkbid0IHdvcmsgaW4gc2FmYXJpCiAgICAgICAgbWV0aG9kID0KICAgICAgICAgICAgcHJlZml4ID0KICAgICAgICAgICAgZGVmaW5pdGlvbiA9CiAgICAgICAgICAgIGJsb2NrID0gJyc7CiAgICB9OwoKICAgIGFwcGVuZFJlc3VsdCgpOwogICAgZm9yKHZhciBpID0gMCwgaWkgPSB2YWx1ZS5sZW5ndGg7IGk8aWk7IGkrKykgewogICAgICAgIGMgPSB2YWx1ZVtpXTsKICAgICAgICBpZihtb2RlID09PSAwICYmIHdoaXRlc3BhY2UuaW5kZXhPZiggYyApID4gLTEpewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoKGMpIHsKICAgICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgICAgICBpZighcXVvdGUpIHsKICAgICAgICAgICAgICAgICAgICBxdW90ZSA9IGM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKHF1b3RlID09PSBjKSB7CiAgICAgICAgICAgICAgICAgICAgcXVvdGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcoJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBtb2RlID0gMTsKICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBudW1QYXJlbisrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcpJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZihudW1QYXJlbiA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2RlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kUmVzdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bVBhcmVuLS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcsJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBhcHBlbmRSZXN1bHQoKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZihudW1QYXJlbiA9PT0gMCAmJiAhbWV0aG9kLm1hdGNoKC9edXJsJC9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBibG9jayArPSBjOwogICAgICAgIGlmKG1vZGUgPT09IDApIHsgbWV0aG9kICs9IGM7IH0KICAgICAgICBlbHNlIHsgZGVmaW5pdGlvbiArPSBjOyB9CiAgICB9CiAgICBhcHBlbmRSZXN1bHQoKTsKCiAgICByZXR1cm4gcmVzdWx0czsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgdmFyIGNsaWVudFJlY3QsIGJvdW5kcyA9IHt9OwoKICBpZiAoZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QpewogICAgY2xpZW50UmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgLy8gVE9ETyBhZGQgc2Nyb2xsIHBvc2l0aW9uIHRvIGJvdW5kcywgc28gbm8gc2Nyb2xsaW5nIG9mIHdpbmRvdyBuZWNlc3NhcnkKICAgIGJvdW5kcy50b3AgPSBjbGllbnRSZWN0LnRvcDsKICAgIGJvdW5kcy5ib3R0b20gPSBjbGllbnRSZWN0LmJvdHRvbSB8fCAoY2xpZW50UmVjdC50b3AgKyBjbGllbnRSZWN0LmhlaWdodCk7CiAgICBib3VuZHMubGVmdCA9IGNsaWVudFJlY3QubGVmdDsKCiAgICBib3VuZHMud2lkdGggPSBlbGVtZW50Lm9mZnNldFdpZHRoOwogICAgYm91bmRzLmhlaWdodCA9IGVsZW1lbnQub2Zmc2V0SGVpZ2h0OwogIH0KCiAgcmV0dXJuIGJvdW5kczsKfTsKCi8vIFRPRE8gaWRlYWxseSwgd2UnZCB3YW50IGV2ZXJ5dGhpbmcgdG8gZ28gdGhyb3VnaCB0aGlzIGZ1bmN0aW9uIGluc3RlYWQgb2YgVXRpbC5Cb3VuZHMsCi8vIGJ1dCB3b3VsZCByZXF1aXJlIGZ1cnRoZXIgd29yayB0byBjYWxjdWxhdGUgdGhlIGNvcnJlY3QgcG9zaXRpb25zIGZvciBlbGVtZW50cyB3aXRoIG9mZnNldFBhcmVudHMKX2h0bWwyY2FudmFzLlV0aWwuT2Zmc2V0Qm91bmRzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICB2YXIgcGFyZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQgPyBfaHRtbDJjYW52YXMuVXRpbC5PZmZzZXRCb3VuZHMoZWxlbWVudC5vZmZzZXRQYXJlbnQpIDoge3RvcDogMCwgbGVmdDogMH07CgogIHJldHVybiB7CiAgICB0b3A6IGVsZW1lbnQub2Zmc2V0VG9wICsgcGFyZW50LnRvcCwKICAgIGJvdHRvbTogZWxlbWVudC5vZmZzZXRUb3AgKyBlbGVtZW50Lm9mZnNldEhlaWdodCArIHBhcmVudC50b3AsCiAgICBsZWZ0OiBlbGVtZW50Lm9mZnNldExlZnQgKyBwYXJlbnQubGVmdCwKICAgIHdpZHRoOiBlbGVtZW50Lm9mZnNldFdpZHRoLAogICAgaGVpZ2h0OiBlbGVtZW50Lm9mZnNldEhlaWdodAogIH07Cn07CgpmdW5jdGlvbiB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSwgdmFsdWUgKSB7CiAgICB2YXIgcnNMZWZ0ID0gZWxlbWVudC5ydW50aW1lU3R5bGUgJiYgZWxlbWVudC5ydW50aW1lU3R5bGVbYXR0cmlidXRlXSwKICAgICAgICBsZWZ0LAogICAgICAgIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCiAgICAvLyBDaGVjayBpZiB3ZSBhcmUgbm90IGRlYWxpbmcgd2l0aCBwaXhlbHMsIChPcGVyYSBoYXMgaXNzdWVzIHdpdGggdGhpcykKICAgIC8vIFBvcnRlZCBmcm9tIGpRdWVyeSBjc3MuanMKICAgIC8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMKICAgIC8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCiAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgIC8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscwoKICAgIGlmICggIS9eLT9bMC05XStcLj9bMC05XSooPzpweCk/JC9pLnRlc3QoIHZhbHVlICkgJiYgL14tP1xkLy50ZXN0KHZhbHVlKSApIHsKICAgICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgICAgICAgbGVmdCA9IHN0eWxlLmxlZnQ7CgogICAgICAgIC8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKICAgICAgICBpZiAocnNMZWZ0KSB7CiAgICAgICAgICAgIGVsZW1lbnQucnVudGltZVN0eWxlLmxlZnQgPSBlbGVtZW50LmN1cnJlbnRTdHlsZS5sZWZ0OwogICAgICAgIH0KICAgICAgICBzdHlsZS5sZWZ0ID0gYXR0cmlidXRlID09PSAiZm9udFNpemUiID8gIjFlbSIgOiAodmFsdWUgfHwgMCk7CiAgICAgICAgdmFsdWUgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgICAgICAgc3R5bGUubGVmdCA9IGxlZnQ7CiAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICBlbGVtZW50LnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0OwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoIS9eKHRoaW58bWVkaXVtfHRoaWNrKSQvaS50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQodmFsdWUpKSArICJweCI7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwp9CgpmdW5jdGlvbiBhc0ludCh2YWwpIHsKICAgIHJldHVybiBwYXJzZUludCh2YWwsIDEwKTsKfQoKZnVuY3Rpb24gaXNQZXJjZW50YWdlKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMTsKfQoKZnVuY3Rpb24gcGFyc2VCYWNrZ3JvdW5kU2l6ZVBvc2l0aW9uKHZhbHVlLCBlbGVtZW50LCBhdHRyaWJ1dGUsIGluZGV4KSB7CiAgICB2YWx1ZSA9ICh2YWx1ZSB8fCAnJykuc3BsaXQoJywnKTsKICAgIHZhbHVlID0gdmFsdWVbaW5kZXggfHwgMF0gfHwgdmFsdWVbMF0gfHwgJ2F1dG8nOwogICAgdmFsdWUgPSBfaHRtbDJjYW52YXMuVXRpbC50cmltVGV4dCh2YWx1ZSkuc3BsaXQoJyAnKTsKICAgIGlmKGF0dHJpYnV0ZSA9PT0gJ2JhY2tncm91bmRTaXplJyAmJiAodmFsdWVbMF0gJiYgdmFsdWVbMF0ubWF0Y2goL14oY292ZXJ8Y29udGFpbnxhdXRvKSQvKSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHZhbHVlWzBdID0gKHZhbHVlWzBdLmluZGV4T2YoICIlIiApID09PSAtMSkgPyB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSArICJYIiwgdmFsdWVbMF0pIDogdmFsdWVbMF07CiAgICAgICAgaWYodmFsdWVbMV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZihhdHRyaWJ1dGUgPT09ICdiYWNrZ3JvdW5kU2l6ZScpIHsKICAgICAgICAgICAgICAgIHZhbHVlWzFdID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSUUgOSBkb2Vzbid0IHJldHVybiBkb3VibGUgZGlnaXQgYWx3YXlzCiAgICAgICAgICAgICAgICB2YWx1ZVsxXSA9IHZhbHVlWzBdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhbHVlWzFdID0gKHZhbHVlWzFdLmluZGV4T2YoIiUiKSA9PT0gLTEpID8gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUgKyAiWSIsIHZhbHVlWzFdKSA6IHZhbHVlWzFdOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgpfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCkgewogICAgaWYgKHByZXZpb3VzRWxlbWVudCAhPT0gZWxlbWVudCkgewogICAgICBjb21wdXRlZENTUyA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCk7CiAgICB9CgogICAgdmFyIHZhbHVlID0gY29tcHV0ZWRDU1NbYXR0cmlidXRlXTsKCiAgICBpZiAoL15iYWNrZ3JvdW5kKFNpemV8UG9zaXRpb24pJC8udGVzdChhdHRyaWJ1dGUpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlQmFja2dyb3VuZFNpemVQb3NpdGlvbih2YWx1ZSwgZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCk7CiAgICB9IGVsc2UgaWYgKC9ib3JkZXIoVG9wfEJvdHRvbSkoTGVmdHxSaWdodClSYWRpdXMvLnRlc3QoYXR0cmlidXRlKSkgewogICAgICB2YXIgYXJyID0gdmFsdWUuc3BsaXQoIiAiKTsKICAgICAgaWYgKGFyci5sZW5ndGggPD0gMSkgewogICAgICAgICAgYXJyWzFdID0gYXJyWzBdOwogICAgICB9CiAgICAgIHJldHVybiBhcnIubWFwKGFzSW50KTsKICAgIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwucmVzaXplQm91bmRzID0gZnVuY3Rpb24oIGN1cnJlbnRfd2lkdGgsIGN1cnJlbnRfaGVpZ2h0LCB0YXJnZXRfd2lkdGgsIHRhcmdldF9oZWlnaHQsIHN0cmV0Y2hfbW9kZSApewogIHZhciB0YXJnZXRfcmF0aW8gPSB0YXJnZXRfd2lkdGggLyB0YXJnZXRfaGVpZ2h0LAogICAgY3VycmVudF9yYXRpbyA9IGN1cnJlbnRfd2lkdGggLyBjdXJyZW50X2hlaWdodCwKICAgIG91dHB1dF93aWR0aCwgb3V0cHV0X2hlaWdodDsKCiAgaWYoIXN0cmV0Y2hfbW9kZSB8fCBzdHJldGNoX21vZGUgPT09ICdhdXRvJykgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgfSBlbHNlIGlmKHRhcmdldF9yYXRpbyA8IGN1cnJlbnRfcmF0aW8gXiBzdHJldGNoX21vZGUgPT09ICdjb250YWluJykgewogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgICBvdXRwdXRfd2lkdGggPSB0YXJnZXRfaGVpZ2h0ICogY3VycmVudF9yYXRpbzsKICB9IGVsc2UgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF93aWR0aCAvIGN1cnJlbnRfcmF0aW87CiAgfQoKICByZXR1cm4gewogICAgd2lkdGg6IG91dHB1dF93aWR0aCwKICAgIGhlaWdodDogb3V0cHV0X2hlaWdodAogIH07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kUG9zaXRpb24gPSBmdW5jdGlvbihlbGVtZW50LCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSApIHsKICAgIHZhciBiYWNrZ3JvdW5kUG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kUG9zaXRpb24nLCBpbWFnZUluZGV4KSwKICAgICAgICBsZWZ0UG9zaXRpb24sCiAgICAgICAgdG9wUG9zaXRpb247CiAgICBpZiAoYmFja2dyb3VuZFBvc2l0aW9uLmxlbmd0aCA9PT0gMSl7CiAgICAgICAgYmFja2dyb3VuZFBvc2l0aW9uID0gW2JhY2tncm91bmRQb3NpdGlvblswXSwgYmFja2dyb3VuZFBvc2l0aW9uWzBdXTsKICAgIH0KCiAgICBpZiAoaXNQZXJjZW50YWdlKGJhY2tncm91bmRQb3NpdGlvblswXSkpewogICAgICAgIGxlZnRQb3NpdGlvbiA9IChib3VuZHMud2lkdGggLSAoYmFja2dyb3VuZFNpemUgfHwgaW1hZ2UpLndpZHRoKSAqIChwYXJzZUZsb2F0KGJhY2tncm91bmRQb3NpdGlvblswXSkgLyAxMDApOwogICAgfSBlbHNlIHsKICAgICAgICBsZWZ0UG9zaXRpb24gPSBwYXJzZUludChiYWNrZ3JvdW5kUG9zaXRpb25bMF0sIDEwKTsKICAgIH0KCiAgICBpZiAoYmFja2dyb3VuZFBvc2l0aW9uWzFdID09PSAnYXV0bycpIHsKICAgICAgICB0b3BQb3NpdGlvbiA9IGxlZnRQb3NpdGlvbiAvIGltYWdlLndpZHRoICogaW1hZ2UuaGVpZ2h0OwogICAgfSBlbHNlIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFBvc2l0aW9uWzFdKSl7CiAgICAgICAgdG9wUG9zaXRpb24gPSAgKGJvdW5kcy5oZWlnaHQgLSAoYmFja2dyb3VuZFNpemUgfHwgaW1hZ2UpLmhlaWdodCkgKiBwYXJzZUZsb2F0KGJhY2tncm91bmRQb3NpdGlvblsxXSkgLyAxMDA7CiAgICB9IGVsc2UgewogICAgICAgIHRvcFBvc2l0aW9uID0gcGFyc2VJbnQoYmFja2dyb3VuZFBvc2l0aW9uWzFdLCAxMCk7CiAgICB9CgogICAgaWYgKGJhY2tncm91bmRQb3NpdGlvblswXSA9PT0gJ2F1dG8nKSB7CiAgICAgICAgbGVmdFBvc2l0aW9uID0gdG9wUG9zaXRpb24gLyBpbWFnZS5oZWlnaHQgKiBpbWFnZS53aWR0aDsKICAgIH0KCiAgICByZXR1cm4ge2xlZnQ6IGxlZnRQb3NpdGlvbiwgdG9wOiB0b3BQb3NpdGlvbn07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kU2l6ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgpIHsKICB2YXIgYmFja2dyb3VuZFNpemUgPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kU2l6ZScsIGltYWdlSW5kZXgpLCB3aWR0aCwgaGVpZ2h0OwoKICBpZiAoYmFja2dyb3VuZFNpemUubGVuZ3RoID09PSAxKSB7CiAgICBiYWNrZ3JvdW5kU2l6ZSA9IFtiYWNrZ3JvdW5kU2l6ZVswXSwgYmFja2dyb3VuZFNpemVbMF1dOwogIH0KCiAgaWYgKGlzUGVyY2VudGFnZShiYWNrZ3JvdW5kU2l6ZVswXSkpIHsKICAgIHdpZHRoID0gYm91bmRzLndpZHRoICogcGFyc2VGbG9hdChiYWNrZ3JvdW5kU2l6ZVswXSkgLyAxMDA7CiAgfSBlbHNlIGlmICgvY29udGFpbnxjb3Zlci8udGVzdChiYWNrZ3JvdW5kU2l6ZVswXSkpIHsKICAgIHJldHVybiBfaHRtbDJjYW52YXMuVXRpbC5yZXNpemVCb3VuZHMoaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCBiYWNrZ3JvdW5kU2l6ZVswXSk7CiAgfSBlbHNlIHsKICAgIHdpZHRoID0gcGFyc2VJbnQoYmFja2dyb3VuZFNpemVbMF0sIDEwKTsKICB9CgogIGlmIChiYWNrZ3JvdW5kU2l6ZVswXSA9PT0gJ2F1dG8nICYmIGJhY2tncm91bmRTaXplWzFdID09PSAnYXV0bycpIHsKICAgIGhlaWdodCA9IGltYWdlLmhlaWdodDsKICB9IGVsc2UgaWYgKGJhY2tncm91bmRTaXplWzFdID09PSAnYXV0bycpIHsKICAgIGhlaWdodCA9IHdpZHRoIC8gaW1hZ2Uud2lkdGggKiBpbWFnZS5oZWlnaHQ7CiAgfSBlbHNlIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFNpemVbMV0pKSB7CiAgICBoZWlnaHQgPSAgYm91bmRzLmhlaWdodCAqIHBhcnNlRmxvYXQoYmFja2dyb3VuZFNpemVbMV0pIC8gMTAwOwogIH0gZWxzZSB7CiAgICBoZWlnaHQgPSBwYXJzZUludChiYWNrZ3JvdW5kU2l6ZVsxXSwgMTApOwogIH0KCiAgaWYgKGJhY2tncm91bmRTaXplWzBdID09PSAnYXV0bycpIHsKICAgIHdpZHRoID0gaGVpZ2h0IC8gaW1hZ2UuaGVpZ2h0ICogaW1hZ2Uud2lkdGg7CiAgfQoKICByZXR1cm4ge3dpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHR9Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFJlcGVhdCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGltYWdlSW5kZXgpIHsKICB2YXIgYmFja2dyb3VuZFJlcGVhdCA9IF9odG1sMmNhbnZhcy5VdGlsLmdldENTUyhlbGVtZW50LCAiYmFja2dyb3VuZFJlcGVhdCIpLnNwbGl0KCIsIikubWFwKF9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0KTsKICByZXR1cm4gYmFja2dyb3VuZFJlcGVhdFtpbWFnZUluZGV4XSB8fCBiYWNrZ3JvdW5kUmVwZWF0WzBdOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kID0gZnVuY3Rpb24gKG9wdGlvbnMsIGRlZmF1bHRzKSB7CiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgZGVmYXVsdHNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgIH0KICB9CiAgcmV0dXJuIGRlZmF1bHRzOwp9OwoKCi8qCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKICB2YXIgY2hpbGRyZW47CiAgdHJ5IHsKICAgIGNoaWxkcmVuID0gKGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiSUZSQU1FIikgPyBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOiAoZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgdmFyIHJldCA9IFtdOwogICAgICBpZiAoYXJyYXkgIT09IG51bGwpIHsKICAgICAgICAoZnVuY3Rpb24oZmlyc3QsIHNlY29uZCApIHsKICAgICAgICAgIHZhciBpID0gZmlyc3QubGVuZ3RoLAogICAgICAgICAgaiA9IDA7CgogICAgICAgICAgaWYgKHR5cGVvZiBzZWNvbmQubGVuZ3RoID09PSAibnVtYmVyIikgewogICAgICAgICAgICBmb3IgKHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKykgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChzZWNvbmRbal0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbaisrXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7CgogICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgIH0pKHJldCwgYXJyYXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9KShlbGVtLmNoaWxkTm9kZXMpOwoKICB9IGNhdGNoIChleCkgewogICAgX2h0bWwyY2FudmFzLlV0aWwubG9nKCJodG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuIGZhaWxlZCB3aXRoIGV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgY2hpbGRyZW4gPSBbXTsKICB9CiAgcmV0dXJuIGNoaWxkcmVuOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuaXNUcmFuc3BhcmVudCA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikgewogIHJldHVybiAoIWJhY2tncm91bmRDb2xvciB8fCBiYWNrZ3JvdW5kQ29sb3IgPT09ICJ0cmFuc3BhcmVudCIgfHwgYmFja2dyb3VuZENvbG9yID09PSAicmdiYSgwLCAwLCAwLCAwKSIpOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuRm9udCA9IChmdW5jdGlvbiAoKSB7CgogIHZhciBmb250RGF0YSA9IHt9OwoKICByZXR1cm4gZnVuY3Rpb24oZm9udCwgZm9udFNpemUsIGRvYykgewogICAgaWYgKGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXTsKICAgIH0KCiAgICB2YXIgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgaW1nID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2ltZycpLAogICAgc3BhbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyksCiAgICBzYW1wbGVUZXh0ID0gJ0hpZGRlbiBUZXh0JywKICAgIGJhc2VsaW5lLAogICAgbWlkZGxlLAogICAgbWV0cmljc09iajsKCiAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7CiAgICBjb250YWluZXIuc3R5bGUubWFyZ2luID0gMDsKICAgIGNvbnRhaW5lci5zdHlsZS5wYWRkaW5nID0gMDsKCiAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpOwoKICAgIC8vIGh0dHA6Ly9wcm9iYWJseXByb2dyYW1taW5nLmNvbS8yMDA5LzAzLzE1L3RoZS10aW5pZXN0LWdpZi1ldmVyIChoYW5kdGlueXdoaXRlLmdpZikKICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUJBUC8vL3dBQUFDd0FBQUFBQVFBQkFBQUNBa1FCQURzPSI7CiAgICBpbWcud2lkdGggPSAxOwogICAgaW1nLmhlaWdodCA9IDE7CgogICAgaW1nLnN0eWxlLm1hcmdpbiA9IDA7CiAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7CiAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJiYXNlbGluZSI7CgogICAgc3Bhbi5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgIHNwYW4uc3R5bGUubWFyZ2luID0gMDsKICAgIHNwYW4uc3R5bGUucGFkZGluZyA9IDA7CgogICAgc3Bhbi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2FtcGxlVGV4dCkpOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwYW4pOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGltZyk7CiAgICBiYXNlbGluZSA9IChpbWcub2Zmc2V0VG9wIC0gc3Bhbi5vZmZzZXRUb3ApICsgMTsKCiAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3Bhbik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHNhbXBsZVRleHQpKTsKCiAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOwogICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAic3VwZXIiOwoKICAgIG1pZGRsZSA9IChpbWcub2Zmc2V0VG9wLWNvbnRhaW5lci5vZmZzZXRUb3ApICsgMTsKICAgIG1ldHJpY3NPYmogPSB7CiAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwKICAgICAgbGluZVdpZHRoOiAxLAogICAgICBtaWRkbGU6IG1pZGRsZQogICAgfTsKCiAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsKCiAgICBkb2MuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgIHJldHVybiBtZXRyaWNzT2JqOwogIH07Cn0pKCk7CgooZnVuY3Rpb24oKXsKICB2YXIgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogICAgR2VuZXJhdGUgPSB7fTsKCiAgX2h0bWwyY2FudmFzLkdlbmVyYXRlID0gR2VuZXJhdGU7CgogIHZhciByZUdyYWRpZW50cyA9IFsKICAvXigtd2Via2l0LWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1ncmFkaWVudClcKChsaW5lYXJ8cmFkaWFsKSxccygoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pLFxzKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXC1dKylcKSQvLAogIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXpcLV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1tb3otcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3Kylccz8oW2EtelwtXSopKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW8tcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3KylccyhbYS16XC1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLwogIF07CgogIC8qCiAqIFRPRE86IEFkZCBJRTEwIHZlbmRvciBwcmVmaXggKC1tcykgc3VwcG9ydAogKiBUT0RPOiBBZGQgVzNDIGdyYWRpZW50IChsaW5lYXItZ3JhZGllbnQpIHN1cHBvcnQKICogVE9ETzogQWRkIG9sZCBXZWJraXQgLXdlYmtpdC1ncmFkaWVudChyYWRpYWwsIC4uLikgc3VwcG9ydAogKiBUT0RPOiBNYXliZSBzb21lIFJlZ0V4cCBvcHRpbWl6YXRpb25zIGFyZSBwb3NzaWJsZSA7bykKICovCiAgR2VuZXJhdGUucGFyc2VHcmFkaWVudCA9IGZ1bmN0aW9uKGNzcywgYm91bmRzKSB7CiAgICB2YXIgZ3JhZGllbnQsIGksIGxlbiA9IHJlR3JhZGllbnRzLmxlbmd0aCwgbTEsIHN0b3AsIG0yLCBtMkxlbiwgc3RlcCwgbTMsIHRsLHRyLGJyLGJsOwoKICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7CiAgICAgIG0xID0gY3NzLm1hdGNoKHJlR3JhZGllbnRzW2ldKTsKICAgICAgaWYobTEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmKG0xKSB7CiAgICAgIHN3aXRjaChtMVsxXSkgewogICAgICAgIGNhc2UgJy13ZWJraXQtbGluZWFyLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctby1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IG51bGwsCiAgICAgICAgICAgIHkwOiBudWxsLAogICAgICAgICAgICB4MTogbnVsbCwKICAgICAgICAgICAgeTE6IG51bGwsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvXHcrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIHN3aXRjaChtMltpXSkgewogICAgICAgICAgICAgICAgY2FzZSAndG9wJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAwOwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IDA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IDA7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmKGdyYWRpZW50LngwID09PSBudWxsICYmIGdyYWRpZW50LngxID09PSBudWxsKXsgLy8gY2VudGVyCiAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOwogICAgICAgICAgfQogICAgICAgICAgaWYoZ3JhZGllbnQueTAgPT09IG51bGwgJiYgZ3JhZGllbnQueTEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQgLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30oPzolfHB4KSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICBzdG9wIC89IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6IG0xWzJdID09PSAncmFkaWFsJyA/ICdjaXJjbGUnIDogbTFbMl0sIC8vIFRPRE86IEFkZCByYWRpYWwgZ3JhZGllbnQgc3VwcG9ydCBmb3Igb2xkZXIgbW96aWxsYSBkZWZpbml0aW9ucwogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiAwLAogICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC54MSA9IChtMlszXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkxID0gKG0yWzRdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbNF0ubWF0Y2goLygoPzpmcm9tfHRvfGNvbG9yLXN0b3ApXCgoPzpbMC05XC5dKyxccyk/KD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XClcKSkrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLyhmcm9tfHRvfGNvbG9yLXN0b3ApXCgoWzAtOVwuXSspPyg/Oixccyk/KCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVwpLyk7CiAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHsKICAgICAgICAgICAgICAgIHN0b3AgPSAwLjA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAndG8nKSB7CiAgICAgICAgICAgICAgICBzdG9wID0gMS4wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLW1vei1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7CgogICAgICAgICAgLy8gbTJbMV0gPT0gMCUgICAtPiBsZWZ0CiAgICAgICAgICAvLyBtMlsxXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMV0gPT0gMTAwJSAtPiByaWdodAoKICAgICAgICAgIC8vIG0yWzJdID09IDAlICAgLT4gdG9wCiAgICAgICAgICAvLyBtMlsyXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMl0gPT0gMTAwJSAtPiBib3R0b20KCiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLSBncmFkaWVudC54MDsKICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSUpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJSk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10peyAvLyBwZXJjZW50YWdlCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctd2Via2l0LXJhZGlhbC1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1vLXJhZGlhbC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdjaXJjbGUnLAogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiBib3VuZHMud2lkdGgsCiAgICAgICAgICAgIHkxOiBib3VuZHMuaGVpZ2h0LAogICAgICAgICAgICBjeDogMCwKICAgICAgICAgICAgY3k6IDAsCiAgICAgICAgICAgIHJ4OiAwLAogICAgICAgICAgICByeTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gY2VudGVyCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQuY3ggPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC5jeSA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHNpemUKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goL1x3Ky8pOwogICAgICAgICAgbTMgPSBtMVs0XS5tYXRjaCgvW2EtelwtXSovKTsKICAgICAgICAgIGlmKG0yICYmIG0zKXsKICAgICAgICAgICAgc3dpdGNoKG0zWzBdKXsKICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1jb3JuZXInOgogICAgICAgICAgICAgIGNhc2UgJ2NvdmVyJzogLy8gaXMgZXF1aXZhbGVudCB0byBmYXJ0aGVzdC1jb3JuZXIKICAgICAgICAgICAgICBjYXNlICcnOiAvLyBtb3ppbGxhIHJlbW92ZXMgImNvdmVyIiBmcm9tIGRlZmluaXRpb24gOigKICAgICAgICAgICAgICAgIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LWNvcm5lcic6CiAgICAgICAgICAgICAgICB0bCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYnIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBibCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4odGwsIHRyLCBiciwgYmwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LXNpZGUnOgogICAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW4nOiAvLyBpcyBlcXVpdmFsZW50IHRvIGNsb3Nlc3Qtc2lkZQogICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICBncmFkaWVudC50eXBlID0gbTJbMF07CgogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgIjMwcHggNDBweCIgc2l6ZXMgKHdlYmtpdCBvbmx5KQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY29sb3Igc3RvcHMKICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpewogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGdyYWRpZW50OwogIH07CgogIGZ1bmN0aW9uIGFkZFNjcm9sbFN0b3BzKGdyYWQpIHsKICAgIHJldHVybiBmdW5jdGlvbihjb2xvclN0b3ApIHsKICAgICAgdHJ5IHsKICAgICAgICBncmFkLmFkZENvbG9yU3RvcChjb2xvclN0b3Auc3RvcCwgY29sb3JTdG9wLmNvbG9yKTsKICAgICAgfQogICAgICBjYXRjaChlKSB7CiAgICAgICAgVXRpbC5sb2coWydmYWlsZWQgdG8gYWRkIGNvbG9yIHN0b3A6ICcsIGUsICc7IHRyaWVkIHRvIGFkZDogJywgY29sb3JTdG9wXSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBHZW5lcmF0ZS5HcmFkaWVudCA9IGZ1bmN0aW9uKHNyYywgYm91bmRzKSB7CiAgICBpZihib3VuZHMud2lkdGggPT09IDAgfHwgYm91bmRzLmhlaWdodCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksCiAgICBncmFkaWVudCwgZ3JhZDsKCiAgICBjYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKCiAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgbXVsdGkgZGVmaW5lZCBiYWNrZ3JvdW5kIGdyYWRpZW50cwogICAgZ3JhZGllbnQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudChzcmMsIGJvdW5kcyk7CgogICAgaWYoZ3JhZGllbnQpIHsKICAgICAgc3dpdGNoKGdyYWRpZW50LnR5cGUpIHsKICAgICAgICBjYXNlICdsaW5lYXInOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChncmFkaWVudC54MCwgZ3JhZGllbnQueTAsIGdyYWRpZW50LngxLCBncmFkaWVudC55MSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdjaXJjbGUnOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIDAsIGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgZ3JhZGllbnQucngpOwogICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5mb3JFYWNoKGFkZFNjcm9sbFN0b3BzKGdyYWQpKTsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnZWxsaXBzZSc6CiAgICAgICAgICB2YXIgY2FudmFzUmFkaWFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCiAgICAgICAgICAgIGN0eFJhZGlhbCA9IGNhbnZhc1JhZGlhbC5nZXRDb250ZXh0KCcyZCcpLAogICAgICAgICAgICByaSA9IE1hdGgubWF4KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSksCiAgICAgICAgICAgIGRpID0gcmkgKiAyOwoKICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsKCiAgICAgICAgICBncmFkID0gY3R4UmFkaWFsLmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgMCwgZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCByaSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwoKICAgICAgICAgIGN0eFJhZGlhbC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4UmFkaWFsLmZpbGxSZWN0KDAsIDAsIGRpLCBkaSk7CgogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbZ3JhZGllbnQuY29sb3JTdG9wcy5sZW5ndGggLSAxXS5jb2xvcjsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgY3R4LmRyYXdJbWFnZShjYW52YXNSYWRpYWwsIGdyYWRpZW50LmN4IC0gZ3JhZGllbnQucngsIGdyYWRpZW50LmN5IC0gZ3JhZGllbnQucnksIDIgKiBncmFkaWVudC5yeCwgMiAqIGdyYWRpZW50LnJ5KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNhbnZhczsKICB9OwoKICBHZW5lcmF0ZS5MaXN0QWxwaGEgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgIHZhciB0bXAgPSAiIiwKICAgIG1vZHVsdXM7CgogICAgZG8gewogICAgICBtb2R1bHVzID0gbnVtYmVyICUgMjY7CiAgICAgIHRtcCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoKG1vZHVsdXMpICsgNjQpICsgdG1wOwogICAgICBudW1iZXIgPSBudW1iZXIgLyAyNjsKICAgIH13aGlsZSgobnVtYmVyKjI2KSA+IDI2KTsKCiAgICByZXR1cm4gdG1wOwogIH07CgogIEdlbmVyYXRlLkxpc3RSb21hbiA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHJvbWFuQXJyYXkgPSBbIk0iLCAiQ00iLCAiRCIsICJDRCIsICJDIiwgIlhDIiwgIkwiLCAiWEwiLCAiWCIsICJJWCIsICJWIiwgIklWIiwgIkkiXSwKICAgIGRlY2ltYWwgPSBbMTAwMCwgOTAwLCA1MDAsIDQwMCwgMTAwLCA5MCwgNTAsIDQwLCAxMCwgOSwgNSwgNCwgMV0sCiAgICByb21hbiA9ICIiLAogICAgdiwKICAgIGxlbiA9IHJvbWFuQXJyYXkubGVuZ3RoOwoKICAgIGlmIChudW1iZXIgPD0gMCB8fCBudW1iZXIgPj0gNDAwMCkgewogICAgICByZXR1cm4gbnVtYmVyOwogICAgfQoKICAgIGZvciAodj0wOyB2IDwgbGVuOyB2Kz0xKSB7CiAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgewogICAgICAgIG51bWJlciAtPSBkZWNpbWFsW3ZdOwogICAgICAgIHJvbWFuICs9IHJvbWFuQXJyYXlbdl07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcm9tYW47CiAgfTsKfSkoKTsKZnVuY3Rpb24gaDJjUmVuZGVyQ29udGV4dCh3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIHN0b3JhZ2UgPSBbXTsKICByZXR1cm4gewogICAgc3RvcmFnZTogc3RvcmFnZSwKICAgIHdpZHRoOiB3aWR0aCwKICAgIGhlaWdodDogaGVpZ2h0LAogICAgY2xpcDogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiY2xpcCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICB0cmFuc2xhdGU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInRyYW5zbGF0ZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInNhdmUiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgcmVzdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAicmVzdG9yZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsUmVjdDogZnVuY3Rpb24gKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGxSZWN0IiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGNyZWF0ZVBhdHRlcm46IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImNyZWF0ZVBhdHRlcm4iLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZHJhd1NoYXBlOiBmdW5jdGlvbigpIHsKCiAgICAgIHZhciBzaGFwZSA9IFtdOwoKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJkcmF3U2hhcGUiLAogICAgICAgICdhcmd1bWVudHMnOiBzaGFwZQogICAgICB9KTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgbW92ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAibW92ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBsaW5lVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJsaW5lVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFyY1RvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAiYXJjVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJiZXppZXJDdXJ2ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAicXVhZHJhdGljQ3VydmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9LAogICAgZHJhd0ltYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZHJhd0ltYWdlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbFRleHQiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgc2V0VmFyaWFibGU6IGZ1bmN0aW9uICh2YXJpYWJsZSwgdmFsdWUpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAidmFyaWFibGUiLAogICAgICAgIG5hbWU6IHZhcmlhYmxlLAogICAgICAgICdhcmd1bWVudHMnOiB2YWx1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH07Cn0KX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKGltYWdlcywgb3B0aW9ucywgY2IpIHsKICB3aW5kb3cuc2Nyb2xsKDAsMCk7CgogIHZhciBlbGVtZW50ID0gKCggb3B0aW9ucy5lbGVtZW50cyA9PT0gdW5kZWZpbmVkICkgPyBkb2N1bWVudC5ib2R5IDogb3B0aW9ucy5lbGVtZW50c1swXSksIC8vIHNlbGVjdCBib2R5IGJ5IGRlZmF1bHQKICBudW1EcmF3cyA9IDAsCiAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBzdXBwb3J0ID0gVXRpbC5TdXBwb3J0KG9wdGlvbnMsIGRvYyksCiAgaWdub3JlRWxlbWVudHNSZWdFeHAgPSBuZXcgUmVnRXhwKCIoIiArIG9wdGlvbnMuaWdub3JlRWxlbWVudHMgKyAiKSIpLAogIGJvZHkgPSBkb2MuYm9keSwKICBnZXRDU1MgPSBVdGlsLmdldENTUywKICBwc2V1ZG9IaWRlID0gIl9fX2h0bWwyY2FudmFzX19fcHNldWRvZWxlbWVudCIsCiAgaGlkZVBzZXVkb0VsZW1lbnRzU3R5bGVzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CgogIGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcy5pbm5lckhUTUwgPSAnLicgKyBwc2V1ZG9IaWRlICsKICAnLXBhcmVudDpiZWZvcmUgeyBjb250ZW50OiAiIiAhaW1wb3J0YW50OyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0nICsKICAnLicgKyBwc2V1ZG9IaWRlICsgJy1wYXJlbnQ6YWZ0ZXIgeyBjb250ZW50OiAiIiAhaW1wb3J0YW50OyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0nOwoKICBib2R5LmFwcGVuZENoaWxkKGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcyk7CgogIGltYWdlcyA9IGltYWdlcyB8fCB7fTsKCiAgaW5pdCgpOwoKICBmdW5jdGlvbiBpbml0KCkgewogICAgdmFyIGJhY2tncm91bmQgPSBnZXRDU1MoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiksCiAgICAgIHRyYW5zcGFyZW50QmFja2dyb3VuZCA9IChVdGlsLmlzVHJhbnNwYXJlbnQoYmFja2dyb3VuZCkgJiYgZWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keSksCiAgICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBudWxsLCBmYWxzZSwgdHJhbnNwYXJlbnRCYWNrZ3JvdW5kKTsKCiAgICAvLyBjcmVhdGUgcHNldWRvIGVsZW1lbnRzIGluIGEgc2luZ2xlIHBhc3MgdG8gcHJldmVudCBzeW5jaHJvbm91cyBsYXlvdXRzCiAgICBhZGRQc2V1ZG9FbGVtZW50cyhlbGVtZW50KTsKCiAgICBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRyYW5zcGFyZW50QmFja2dyb3VuZCkgewogICAgICAgIGJhY2tncm91bmQgPSBzdGFjay5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgIH0KCiAgICAgIHJlbW92ZVBzZXVkb0VsZW1lbnRzKCk7CgogICAgICBVdGlsLmxvZygnRG9uZSBwYXJzaW5nLCBtb3ZpbmcgdG8gUmVuZGVyLicpOwoKICAgICAgY2IoewogICAgICAgIGJhY2tncm91bmRDb2xvcjogYmFja2dyb3VuZCwKICAgICAgICBzdGFjazogc3RhY2sKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8vIEdpdmVuIGEgcm9vdCBlbGVtZW50LCBmaW5kIGFsbCBwc2V1ZG8gZWxlbWVudHMgYmVsb3csIGNyZWF0ZSBlbGVtZW50cyBtb2NraW5nIHBzZXVkbyBlbGVtZW50IHN0eWxlcwogIC8vIHNvIHdlIGNhbiBwcm9jZXNzIHRoZW0gYXMgbm9ybWFsIGVsZW1lbnRzLCBhbmQgaGlkZSB0aGUgb3JpZ2luYWwgcHNldWRvIGVsZW1lbnRzIHNvIHRoZXkgZG9uJ3QgaW50ZXJmZXJlCiAgLy8gd2l0aCBsYXlvdXQuCiAgZnVuY3Rpb24gYWRkUHNldWRvRWxlbWVudHMoZWwpIHsKICAgIC8vIFRoZXNlIGFyZSBkb25lIGluIGRpc2NyZXRlIHN0ZXBzIHRvIHByZXZlbnQgYSByZWxheW91dCBsb29wIGNhdXNlZCBieSBhZGRDbGFzcygpIGludmFsaWRhdGluZwogICAgLy8gbGF5b3V0cyAmIGdldFBzZXVkb0VsZW1lbnQgY2FsbGluZyBnZXRDb21wdXRlZFN0eWxlLgogICAgdmFyIGpvYnMgPSBbXSwgY2xhc3NlcyA9IFtdOwogICAgZ2V0UHNldWRvRWxlbWVudENsYXNzZXMoKTsKICAgIHRyeSB7CiAgICAgIGZpbmRQc2V1ZG9FbGVtZW50cyhlbCk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBQYXJzZTogRXhjZXB0aW9uIGNhdWdodCBpbiBmaW5kUHNldWRvRWxlbWVudHM6ICIgKyBlLm1lc3NhZ2UpOwogICAgfQogICAgcnVuSm9icygpOwoKICAgIGZ1bmN0aW9uIGdldFBzZXVkb0VsZW1lbnRDbGFzc2VzKCl7CiAgICAgIHZhciBmaW5kUHN1ZWRvRWxzID0gLzpiZWZvcmV8OmFmdGVyLzsKICAgICAgdmFyIHNoZWV0cyA9IGRvY3VtZW50LnN0eWxlU2hlZXRzOwogICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHNoZWV0cy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJ1bGVzID0gc2hlZXRzW2ldLmNzc1J1bGVzOwogICAgICAgICAgZm9yICh2YXIgayA9IDAsIGwgPSBydWxlcy5sZW5ndGg7IGsgPCBsOyBrKyspIHsKICAgICAgICAgICAgaWYgKCFydWxlc1trXS5zZWxlY3RvclRleHQpIGNvbnRpbnVlOwogICAgICAgICAgICB2YXIgc2VsZWN0b3JzID0gcnVsZXNba10uc2VsZWN0b3JUZXh0LnNwbGl0KC8gKiwgKi8pOwogICAgICAgICAgICBmb3IgKHZhciBtID0gMCwgbiA9IHNlbGVjdG9ycy5sZW5ndGg7IG0gPCBuOyBtKyspIHsKICAgICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSBzZWxlY3RvcnNbbV07CiAgICAgICAgICAgICAgaWYoZmluZFBzdWVkb0Vscy50ZXN0KHNlbGVjdG9yc1ttXSkpIHsKICAgICAgICAgICAgICAgIC8vIFRyaW0gb2ZmIHRoZSA6YWZ0ZXIgYW5kIDpiZWZvcmUgKG9yIDo6YWZ0ZXIgYW5kIDo6YmVmb3JlKQogICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5tYXRjaCgvKF5bXjpdKikvKVsxXTsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci50cmltKCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2goc2VsZWN0b3JzW21dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkgeyAvLyB3aWxsIHRocm93IHNlY3VyaXR5IGV4Y2VwdGlvbiBmb3Igc3R5bGUgc2hlZXRzIGxvYWRlZCBmcm9tIGV4dGVybmFsIGRvbWFpbnMKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBVc2luZyB0aGUgbGlzdCBvZiBlbGVtZW50cyB3ZSBrbm93IGhvdyBwc2V1ZG8gZWwgc3R5bGVzLCBjcmVhdGUgZmFrZSBwc2V1ZG8gZWxlbWVudHMuCiAgICBmdW5jdGlvbiBmaW5kUHNldWRvRWxlbWVudHMoZWwpIHsKICAgICAgdmFyIGVscyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoY2xhc3Nlcy5qb2luKCcsJykpOwogICAgICBmb3IodmFyIGkgPSAwLCBqID0gZWxzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIGNyZWF0ZVBzZXVkb0VsZW1lbnRzKGVsc1tpXSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgcHNldWRvIGVsZW1lbnRzICYgYWRkIHRoZW0gdG8gYSBqb2IgcXVldWUuCiAgICBmdW5jdGlvbiBjcmVhdGVQc2V1ZG9FbGVtZW50cyhlbCkgewogICAgICB2YXIgYmVmb3JlID0gZ2V0UHNldWRvRWxlbWVudChlbCwgJzpiZWZvcmUnKSwKICAgICAgYWZ0ZXIgPSBnZXRQc2V1ZG9FbGVtZW50KGVsLCAnOmFmdGVyJyk7CgogICAgICBpZihiZWZvcmUpIHsKICAgICAgICBqb2JzLnB1c2goe3R5cGU6ICdiZWZvcmUnLCBwc2V1ZG86IGJlZm9yZSwgZWw6IGVsfSk7CiAgICAgIH0KCiAgICAgIGlmIChhZnRlcikgewogICAgICAgIGpvYnMucHVzaCh7dHlwZTogJ2FmdGVyJywgcHNldWRvOiBhZnRlciwgZWw6IGVsfSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBBZGRzIGEgY2xhc3MgdG8gdGhlIHBzZXVkbydzIHBhcmVudCB0byBwcmV2ZW50IHRoZSBvcmlnaW5hbCBiZWZvcmUvYWZ0ZXIgZnJvbSBtZXNzaW5nCiAgICAvLyB3aXRoIGxheW91dHMuCiAgICAvLyBFeGVjdXRlIHRoZSBpbnNlcnRzICYgYWRkQ2xhc3MoKSBjYWxscyBpbiBhIGJhdGNoIHRvIHByZXZlbnQgcmVsYXlvdXRzLgogICAgZnVuY3Rpb24gcnVuSm9icygpIHsKICAgICAgLy8gQWRkIENsYXNzCiAgICAgIGpvYnMuZm9yRWFjaChmdW5jdGlvbihqb2IpewogICAgICAgIGFkZENsYXNzKGpvYi5lbCwgcHNldWRvSGlkZSArICItcGFyZW50Iik7CiAgICAgIH0pOwoKICAgICAgLy8gSW5zZXJ0IGVsCiAgICAgIGpvYnMuZm9yRWFjaChmdW5jdGlvbihqb2IpewogICAgICAgIGlmKGpvYi50eXBlID09PSAnYmVmb3JlJyl7CiAgICAgICAgICBqb2IuZWwuaW5zZXJ0QmVmb3JlKGpvYi5wc2V1ZG8sIGpvYi5lbC5maXJzdENoaWxkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgam9iLmVsLmFwcGVuZENoaWxkKGpvYi5wc2V1ZG8pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKCgogIC8vIERlbGV0ZSBvdXIgZmFrZSBwc2V1ZG8gZWxlbWVudHMgZnJvbSB0aGUgRE9NLiBUaGlzIHdpbGwgcmVtb3ZlIHRob3NlIGFjdHVhbCBlbGVtZW50cwogIC8vIGFuZCB0aGUgY2xhc3NlcyBvbiB0aGVpciBwYXJlbnRzIHRoYXQgaGlkZSB0aGUgYWN0dWFsIHBzZXVkbyBlbGVtZW50cy4KICAvLyBOb3RlIHRoYXQgTm9kZUxpc3RzIGFyZSAnbGl2ZScgY29sbGVjdGlvbnMgc28geW91IGNhbid0IHVzZSBhIGZvciBsb29wIGhlcmUuIFRoZXkgYXJlCiAgLy8gYWN0dWFsbHkgZGVsZXRlZCBmcm9tIHRoZSBOb2RlTGlzdCBhZnRlciBlYWNoIGl0ZXJhdGlvbi4KICBmdW5jdGlvbiByZW1vdmVQc2V1ZG9FbGVtZW50cygpewogICAgLy8gZGVsZXRlIHBzZXVkbyBlbGVtZW50cwogICAgYm9keS5yZW1vdmVDaGlsZChoaWRlUHNldWRvRWxlbWVudHNTdHlsZXMpOwogICAgdmFyIHBzZXVkb3MgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHBzZXVkb0hpZGUgKyAiLWVsZW1lbnQiKTsKICAgIHdoaWxlIChwc2V1ZG9zLmxlbmd0aCkgewogICAgICBwc2V1ZG9zWzBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocHNldWRvc1swXSk7CiAgICB9CgogICAgLy8gUmVtb3ZlIHBzZXVkbyBoaWRpbmcgY2xhc3NlcwogICAgdmFyIHBhcmVudHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHBzZXVkb0hpZGUgKyAiLXBhcmVudCIpOwogICAgd2hpbGUocGFyZW50cy5sZW5ndGgpIHsKICAgICAgcmVtb3ZlQ2xhc3MocGFyZW50c1swXSwgcHNldWRvSGlkZSArICItcGFyZW50Iik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBlbC5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUgKyAiICIgKyBjbGFzc05hbWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUucmVwbGFjZShjbGFzc05hbWUsICIiKS50cmltKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYXNDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgcmV0dXJuIGVsLmNsYXNzTmFtZS5pbmRleE9mKGNsYXNzTmFtZSkgPiAtMTsKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIGRvZXNuJ3Qgd29yayBpbiA8IElFOCwgYnV0IHdlIGRvbid0IHN1cHBvcnQgdGhhdCBhbnlob3cKICBmdW5jdGlvbiBub2RlTGlzdFRvQXJyYXkgKG5vZGVMaXN0KSB7CiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobm9kZUxpc3QpOwogIH0KCiAgZnVuY3Rpb24gZG9jdW1lbnRXaWR0aCAoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LnNjcm9sbFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFdpZHRoKSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkub2Zmc2V0V2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGRvY3VtZW50SGVpZ2h0ICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuc2Nyb2xsSGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbEhlaWdodCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZ2V0Q1NTSW50KGVsZW1lbnQsIGF0dHJpYnV0ZSkgewogICAgdmFyIHZhbCA9IHBhcnNlSW50KGdldENTUyhlbGVtZW50LCBhdHRyaWJ1dGUpLCAxMCk7CiAgICByZXR1cm4gKGlzTmFOKHZhbCkpID8gMCA6IHZhbDsgLy8gYm9yZGVycyBpbiBvbGQgSUUgYXJlIHRocm93aW5nICdtZWRpdW0nIGZvciBkZW1vLmh0bWwKICB9CgogIGZ1bmN0aW9uIHJlbmRlclJlY3QgKGN0eCwgeCwgeSwgdywgaCwgYmdjb2xvcikgewogICAgaWYgKGJnY29sb3IgIT09ICJ0cmFuc3BhcmVudCIpewogICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGJnY29sb3IpOwogICAgICBjdHguZmlsbFJlY3QoeCwgeSwgdywgaCk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FwaXRhbGl6ZShtLCBwMSwgcDIpIHsKICAgIGlmIChtLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIHAxICsgcDIudG9VcHBlckNhc2UoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRleHRUcmFuc2Zvcm0gKHRleHQsIHRyYW5zZm9ybSkgewogICAgc3dpdGNoKHRyYW5zZm9ybSl7CiAgICAgIGNhc2UgImxvd2VyY2FzZSI6CiAgICAgICAgcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKTsKICAgICAgY2FzZSAiY2FwaXRhbGl6ZSI6CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSggLyhefFxzfDp8LXxcKHxcKSkoW2Etel0pL2csIGNhcGl0YWxpemUpOwogICAgICBjYXNlICJ1cHBlcmNhc2UiOgogICAgICAgIHJldHVybiB0ZXh0LnRvVXBwZXJDYXNlKCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBub0xldHRlclNwYWNpbmcobGV0dGVyX3NwYWNpbmcpIHsKICAgIHJldHVybiAoL14obm9ybWFsfG5vbmV8MHB4KSQvLnRlc3QobGV0dGVyX3NwYWNpbmcpKTsKICB9CgogIGZ1bmN0aW9uIGRyYXdUZXh0KGN1cnJlbnRUZXh0LCB4LCB5LCBjdHgpewogICAgaWYgKGN1cnJlbnRUZXh0ICE9PSBudWxsICYmIFV0aWwudHJpbVRleHQoY3VycmVudFRleHQpLmxlbmd0aCA+IDApIHsKICAgICAgY3R4LmZpbGxUZXh0KGN1cnJlbnRUZXh0LCB4LCB5KTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWwsIHRleHRfZGVjb3JhdGlvbiwgY29sb3IpIHsKICAgIHZhciBhbGlnbiA9IGZhbHNlLAogICAgYm9sZCA9IGdldENTUyhlbCwgImZvbnRXZWlnaHQiKSwKICAgIGZhbWlseSA9IGdldENTUyhlbCwgImZvbnRGYW1pbHkiKSwKICAgIHNpemUgPSBnZXRDU1MoZWwsICJmb250U2l6ZSIpLAogICAgc2hhZG93cyA9IFV0aWwucGFyc2VUZXh0U2hhZG93cyhnZXRDU1MoZWwsICJ0ZXh0U2hhZG93IikpOwoKICAgIHN3aXRjaChwYXJzZUludChib2xkLCAxMCkpewogICAgICBjYXNlIDQwMToKICAgICAgICBib2xkID0gImJvbGQiOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDQwMDoKICAgICAgICBib2xkID0gIm5vcm1hbCI7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBjb2xvcik7CiAgICBjdHguc2V0VmFyaWFibGUoImZvbnQiLCBbZ2V0Q1NTKGVsLCAiZm9udFN0eWxlIiksIGdldENTUyhlbCwgImZvbnRWYXJpYW50IiksIGJvbGQsIHNpemUsIGZhbWlseV0uam9pbigiICIpKTsKICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgKGFsaWduKSA/ICJyaWdodCIgOiAibGVmdCIpOwoKICAgIGlmIChzaGFkb3dzLmxlbmd0aCkgewogICAgICAvLyBUT0RPOiBzdXBwb3J0IG11bHRpcGxlIHRleHQgc2hhZG93cwogICAgICAvLyBhcHBseSB0aGUgZmlyc3QgdGV4dCBzaGFkb3cKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dDb2xvciIsIHNoYWRvd3NbMF0uY29sb3IpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd09mZnNldFgiLCBzaGFkb3dzWzBdLm9mZnNldFgpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd09mZnNldFkiLCBzaGFkb3dzWzBdLm9mZnNldFkpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd0JsdXIiLCBzaGFkb3dzWzBdLmJsdXIpOwogICAgfQoKICAgIGlmICh0ZXh0X2RlY29yYXRpb24gIT09ICJub25lIil7CiAgICAgIHJldHVybiBVdGlsLkZvbnQoZmFtaWx5LCBzaXplLCBkb2MpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGV4dERlY29yYXRpb24oY3R4LCB0ZXh0X2RlY29yYXRpb24sIGJvdW5kcywgbWV0cmljcywgY29sb3IpIHsKICAgIHN3aXRjaCh0ZXh0X2RlY29yYXRpb24pIHsKICAgICAgY2FzZSAidW5kZXJsaW5lIjoKICAgICAgICAvLyBEcmF3cyBhIGxpbmUgYXQgdGhlIGJhc2VsaW5lIG9mIHRoZSBmb250CiAgICAgICAgLy8gVE9ETyBBcyBzb21lIGJyb3dzZXJzIGRpc3BsYXkgdGhlIGxpbmUgYXMgbW9yZSB0aGFuIDFweCBpZiB0aGUgZm9udC1zaXplIGlzIGJpZywgbmVlZCB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50IGJvdGggaW4gcG9zaXRpb24gYW5kIHNpemUKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGgucm91bmQoYm91bmRzLnRvcCArIG1ldHJpY3MuYmFzZWxpbmUgKyBtZXRyaWNzLmxpbmVXaWR0aCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJvdmVybGluZSI6CiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3ApLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibGluZS10aHJvdWdoIjoKICAgICAgICAvLyBUT0RPIHRyeSBhbmQgZmluZCBleGFjdCBwb3NpdGlvbiBmb3IgbGluZS10aHJvdWdoCiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLmNlaWwoYm91bmRzLnRvcCArIG1ldHJpY3MubWlkZGxlICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldFRleHRCb3VuZHMoc3RhdGUsIHRleHQsIHRleHREZWNvcmF0aW9uLCBpc0xhc3QsIHRyYW5zZm9ybSkgewogICAgdmFyIGJvdW5kczsKICAgIGlmIChzdXBwb3J0LnJhbmdlQm91bmRzICYmICF0cmFuc2Zvcm0pIHsKICAgICAgaWYgKHRleHREZWNvcmF0aW9uICE9PSAibm9uZSIgfHwgVXRpbC50cmltVGV4dCh0ZXh0KS5sZW5ndGggIT09IDApIHsKICAgICAgICBib3VuZHMgPSB0ZXh0UmFuZ2VCb3VuZHModGV4dCwgc3RhdGUubm9kZSwgc3RhdGUudGV4dE9mZnNldCk7CiAgICAgIH0KICAgICAgc3RhdGUudGV4dE9mZnNldCArPSB0ZXh0Lmxlbmd0aDsKICAgIH0gZWxzZSBpZiAoc3RhdGUubm9kZSAmJiB0eXBlb2Ygc3RhdGUubm9kZS5ub2RlVmFsdWUgPT09ICJzdHJpbmciICl7CiAgICAgIHZhciBuZXdUZXh0Tm9kZSA9IChpc0xhc3QpID8gc3RhdGUubm9kZS5zcGxpdFRleHQodGV4dC5sZW5ndGgpIDogbnVsbDsKICAgICAgYm91bmRzID0gdGV4dFdyYXBwZXJCb3VuZHMoc3RhdGUubm9kZSwgdHJhbnNmb3JtKTsKICAgICAgc3RhdGUubm9kZSA9IG5ld1RleHROb2RlOwogICAgfQogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIHRleHRSYW5nZUJvdW5kcyh0ZXh0LCB0ZXh0Tm9kZSwgdGV4dE9mZnNldCkgewogICAgdmFyIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICByYW5nZS5zZXRTdGFydCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCk7CiAgICByYW5nZS5zZXRFbmQodGV4dE5vZGUsIHRleHRPZmZzZXQgKyB0ZXh0Lmxlbmd0aCk7CiAgICByZXR1cm4gcmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgfQoKICBmdW5jdGlvbiB0ZXh0V3JhcHBlckJvdW5kcyhvbGRUZXh0Tm9kZSwgdHJhbnNmb3JtKSB7CiAgICB2YXIgcGFyZW50ID0gb2xkVGV4dE5vZGUucGFyZW50Tm9kZSwKICAgIHdyYXBFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3dyYXBwZXInKSwKICAgIGJhY2t1cFRleHQgPSBvbGRUZXh0Tm9kZS5jbG9uZU5vZGUodHJ1ZSk7CgogICAgd3JhcEVsZW1lbnQuYXBwZW5kQ2hpbGQob2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcEVsZW1lbnQsIG9sZFRleHROb2RlKTsKCiAgICB2YXIgYm91bmRzID0gdHJhbnNmb3JtID8gVXRpbC5PZmZzZXRCb3VuZHMod3JhcEVsZW1lbnQpIDogVXRpbC5Cb3VuZHMod3JhcEVsZW1lbnQpOwogICAgcGFyZW50LnJlcGxhY2VDaGlsZChiYWNrdXBUZXh0LCB3cmFwRWxlbWVudCk7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKSB7CiAgICB2YXIgY3R4ID0gc3RhY2suY3R4LAogICAgY29sb3IgPSBnZXRDU1MoZWwsICJjb2xvciIpLAogICAgdGV4dERlY29yYXRpb24gPSBnZXRDU1MoZWwsICJ0ZXh0RGVjb3JhdGlvbiIpLAogICAgdGV4dEFsaWduID0gZ2V0Q1NTKGVsLCAidGV4dEFsaWduIiksCiAgICBtZXRyaWNzLAogICAgdGV4dExpc3QsCiAgICBzdGF0ZSA9IHsKICAgICAgbm9kZTogdGV4dE5vZGUsCiAgICAgIHRleHRPZmZzZXQ6IDAKICAgIH07CgogICAgaWYgKFV0aWwudHJpbVRleHQodGV4dE5vZGUubm9kZVZhbHVlKS5sZW5ndGggPiAwKSB7CiAgICAgIHRleHROb2RlLm5vZGVWYWx1ZSA9IHRleHRUcmFuc2Zvcm0odGV4dE5vZGUubm9kZVZhbHVlLCBnZXRDU1MoZWwsICJ0ZXh0VHJhbnNmb3JtIikpOwogICAgICB0ZXh0QWxpZ24gPSB0ZXh0QWxpZ24ucmVwbGFjZShbIi13ZWJraXQtYXV0byJdLFsiYXV0byJdKTsKCiAgICAgIHRleHRMaXN0ID0gKCFvcHRpb25zLmxldHRlclJlbmRlcmluZyAmJiAvXihsZWZ0fHJpZ2h0fGp1c3RpZnl8YXV0bykkLy50ZXN0KHRleHRBbGlnbikgJiYgbm9MZXR0ZXJTcGFjaW5nKGdldENTUyhlbCwgImxldHRlclNwYWNpbmciKSkpID8KICAgICAgdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KC8oXGJ8ICkvKQogICAgICA6IHRleHROb2RlLm5vZGVWYWx1ZS5zcGxpdCgiIik7CgogICAgICBtZXRyaWNzID0gc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsLCB0ZXh0RGVjb3JhdGlvbiwgY29sb3IpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbmVzZSkgewogICAgICAgIHRleHRMaXN0LmZvckVhY2goZnVuY3Rpb24od29yZCwgaW5kZXgpIHsKICAgICAgICAgIGlmICgvLipbXHU0RTAwLVx1OUZBNV0uKiQvLnRlc3Qod29yZCkpIHsKICAgICAgICAgICAgd29yZCA9IHdvcmQuc3BsaXQoIiIpOwogICAgICAgICAgICB3b3JkLnVuc2hpZnQoaW5kZXgsIDEpOwogICAgICAgICAgICB0ZXh0TGlzdC5zcGxpY2UuYXBwbHkodGV4dExpc3QsIHdvcmQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB0ZXh0TGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHRleHQsIGluZGV4KSB7CiAgICAgICAgdmFyIGJvdW5kcyA9IGdldFRleHRCb3VuZHMoc3RhdGUsIHRleHQsIHRleHREZWNvcmF0aW9uLCAoaW5kZXggPCB0ZXh0TGlzdC5sZW5ndGggLSAxKSwgc3RhY2sudHJhbnNmb3JtLm1hdHJpeCk7CiAgICAgICAgaWYgKGJvdW5kcykgewogICAgICAgICAgZHJhd1RleHQodGV4dCwgYm91bmRzLmxlZnQsIGJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICAgICAgICByZW5kZXJUZXh0RGVjb3JhdGlvbihjdHgsIHRleHREZWNvcmF0aW9uLCBib3VuZHMsIG1ldHJpY3MsIGNvbG9yKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbGlzdFBvc2l0aW9uIChlbGVtZW50LCB2YWwpIHsKICAgIHZhciBib3VuZEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvdW5kZWxlbWVudCIgKSwKICAgIG9yaWdpbmFsVHlwZSwKICAgIGJvdW5kczsKCiAgICBib3VuZEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOwoKICAgIG9yaWdpbmFsVHlwZSA9IGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZTsKICAgIGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZSA9ICJub25lIjsKCiAgICBib3VuZEVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHZhbCkpOwoKICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJvdW5kRWxlbWVudCwgZWxlbWVudC5maXJzdENoaWxkKTsKCiAgICBib3VuZHMgPSBVdGlsLkJvdW5kcyhib3VuZEVsZW1lbnQpOwogICAgZWxlbWVudC5yZW1vdmVDaGlsZChib3VuZEVsZW1lbnQpOwogICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gb3JpZ2luYWxUeXBlOwogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIGVsZW1lbnRJbmRleChlbCkgewogICAgdmFyIGkgPSAtMSwKICAgIGNvdW50ID0gMSwKICAgIGNoaWxkcyA9IGVsLnBhcmVudE5vZGUuY2hpbGROb2RlczsKCiAgICBpZiAoZWwucGFyZW50Tm9kZSkgewogICAgICB3aGlsZShjaGlsZHNbKytpXSAhPT0gZWwpIHsKICAgICAgICBpZiAoY2hpbGRzW2ldLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICBjb3VudCsrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY291bnQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsaXN0SXRlbVRleHQoZWxlbWVudCwgdHlwZSkgewogICAgdmFyIGN1cnJlbnRJbmRleCA9IGVsZW1lbnRJbmRleChlbGVtZW50KSwgdGV4dDsKICAgIHN3aXRjaCh0eXBlKXsKICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVjaW1hbC1sZWFkaW5nLXplcm8iOgogICAgICAgIHRleHQgPSAoY3VycmVudEluZGV4LnRvU3RyaW5nKCkubGVuZ3RoID09PSAxKSA/IGN1cnJlbnRJbmRleCA9ICIwIiArIGN1cnJlbnRJbmRleC50b1N0cmluZygpIDogY3VycmVudEluZGV4LnRvU3RyaW5nKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInVwcGVyLXJvbWFuIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxvd2VyLXJvbWFuIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibG93ZXItYWxwaGEiOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ1cHBlci1hbHBoYSI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiB0ZXh0ICsgIi4gIjsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckxpc3RJdGVtKGVsZW1lbnQsIHN0YWNrLCBlbEJvdW5kcykgewogICAgdmFyIHgsCiAgICB0ZXh0LAogICAgY3R4ID0gc3RhY2suY3R4LAogICAgdHlwZSA9IGdldENTUyhlbGVtZW50LCAibGlzdFN0eWxlVHlwZSIpLAogICAgbGlzdEJvdW5kczsKCiAgICBpZiAoL14oZGVjaW1hbHxkZWNpbWFsLWxlYWRpbmctemVyb3x1cHBlci1hbHBoYXx1cHBlci1sYXRpbnx1cHBlci1yb21hbnxsb3dlci1hbHBoYXxsb3dlci1ncmVla3xsb3dlci1sYXRpbnxsb3dlci1yb21hbikkL2kudGVzdCh0eXBlKSkgewogICAgICB0ZXh0ID0gbGlzdEl0ZW1UZXh0KGVsZW1lbnQsIHR5cGUpOwogICAgICBsaXN0Qm91bmRzID0gbGlzdFBvc2l0aW9uKGVsZW1lbnQsIHRleHQpOwogICAgICBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWxlbWVudCwgIm5vbmUiLCBnZXRDU1MoZWxlbWVudCwgImNvbG9yIikpOwoKICAgICAgaWYgKGdldENTUyhlbGVtZW50LCAibGlzdFN0eWxlUG9zaXRpb24iKSA9PT0gImluc2lkZSIpIHsKICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7CiAgICAgICAgeCA9IGVsQm91bmRzLmxlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBkcmF3VGV4dCh0ZXh0LCB4LCBsaXN0Qm91bmRzLmJvdHRvbSwgY3R4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvYWRJbWFnZSAoc3JjKXsKICAgIHZhciBpbWcgPSBpbWFnZXNbc3JjXTsKICAgIHJldHVybiAoaW1nICYmIGltZy5zdWNjZWVkZWQgPT09IHRydWUpID8gaW1nLmltZyA6IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gY2xpcEJvdW5kcyhzcmMsIGRzdCl7CiAgICB2YXIgeCA9IE1hdGgubWF4KHNyYy5sZWZ0LCBkc3QubGVmdCksCiAgICB5ID0gTWF0aC5tYXgoc3JjLnRvcCwgZHN0LnRvcCksCiAgICB4MiA9IE1hdGgubWluKChzcmMubGVmdCArIHNyYy53aWR0aCksIChkc3QubGVmdCArIGRzdC53aWR0aCkpLAogICAgeTIgPSBNYXRoLm1pbigoc3JjLnRvcCArIHNyYy5oZWlnaHQpLCAoZHN0LnRvcCArIGRzdC5oZWlnaHQpKTsKCiAgICByZXR1cm4gewogICAgICBsZWZ0OngsCiAgICAgIHRvcDp5LAogICAgICB3aWR0aDp4Mi14LAogICAgICBoZWlnaHQ6eTIteQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHNldFooZWxlbWVudCwgc3RhY2ssIHBhcmVudFN0YWNrKXsKICAgIHZhciBuZXdDb250ZXh0LAogICAgaXNQb3NpdGlvbmVkID0gc3RhY2suY3NzUG9zaXRpb24gIT09ICdzdGF0aWMnLAogICAgekluZGV4ID0gaXNQb3NpdGlvbmVkID8gZ2V0Q1NTKGVsZW1lbnQsICd6SW5kZXgnKSA6ICdhdXRvJywKICAgIG9wYWNpdHkgPSBnZXRDU1MoZWxlbWVudCwgJ29wYWNpdHknKSwKICAgIGlzRmxvYXRlZCA9IGdldENTUyhlbGVtZW50LCAnY3NzRmxvYXQnKSAhPT0gJ25vbmUnOwoKICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0d1aWRlL0NTUy9VbmRlcnN0YW5kaW5nX3pfaW5kZXgvVGhlX3N0YWNraW5nX2NvbnRleHQKICAgIC8vIFdoZW4gYSBuZXcgc3RhY2tpbmcgY29udGV4dCBzaG91bGQgYmUgY3JlYXRlZDoKICAgIC8vIHRoZSByb290IGVsZW1lbnQgKEhUTUwpLAogICAgLy8gcG9zaXRpb25lZCAoYWJzb2x1dGVseSBvciByZWxhdGl2ZWx5KSB3aXRoIGEgei1pbmRleCB2YWx1ZSBvdGhlciB0aGFuICJhdXRvIiwKICAgIC8vIGVsZW1lbnRzIHdpdGggYW4gb3BhY2l0eSB2YWx1ZSBsZXNzIHRoYW4gMS4gKFNlZSB0aGUgc3BlY2lmaWNhdGlvbiBmb3Igb3BhY2l0eSksCiAgICAvLyBvbiBtb2JpbGUgV2ViS2l0IGFuZCBDaHJvbWUgMjIrLCBwb3NpdGlvbjogZml4ZWQgYWx3YXlzIGNyZWF0ZXMgYSBuZXcgc3RhY2tpbmcgY29udGV4dCwgZXZlbiB3aGVuIHotaW5kZXggaXMgImF1dG8iIChTZWUgdGhpcyBwb3N0KQoKICAgIHN0YWNrLnpJbmRleCA9IG5ld0NvbnRleHQgPSBoMmN6Q29udGV4dCh6SW5kZXgpOwogICAgbmV3Q29udGV4dC5pc1Bvc2l0aW9uZWQgPSBpc1Bvc2l0aW9uZWQ7CiAgICBuZXdDb250ZXh0LmlzRmxvYXRlZCA9IGlzRmxvYXRlZDsKICAgIG5ld0NvbnRleHQub3BhY2l0eSA9IG9wYWNpdHk7CiAgICBuZXdDb250ZXh0Lm93blN0YWNraW5nID0gKHpJbmRleCAhPT0gJ2F1dG8nIHx8IG9wYWNpdHkgPCAxKTsKICAgIG5ld0NvbnRleHQuZGVwdGggPSBwYXJlbnRTdGFjayA/IChwYXJlbnRTdGFjay56SW5kZXguZGVwdGggKyAxKSA6IDA7CgogICAgaWYgKHBhcmVudFN0YWNrKSB7CiAgICAgIHBhcmVudFN0YWNrLnpJbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGgyY3pDb250ZXh0KHppbmRleCkgewogICAgcmV0dXJuIHsKICAgICAgZGVwdGg6IDAsCiAgICAgIHppbmRleDogemluZGV4LAogICAgICBjaGlsZHJlbjogW10KICAgIH07CiAgfQoKICBmdW5jdGlvbiByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGltYWdlLCBib3VuZHMsIGJvcmRlcnMpIHsKCiAgICB2YXIgcGFkZGluZ0xlZnQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdMZWZ0JyksCiAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nVG9wJyksCiAgICBwYWRkaW5nUmlnaHQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdSaWdodCcpLAogICAgcGFkZGluZ0JvdHRvbSA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ0JvdHRvbScpOwoKICAgIGRyYXdJbWFnZSgKICAgICAgY3R4LAogICAgICBpbWFnZSwKICAgICAgMCwgLy9zeAogICAgICAwLCAvL3N5CiAgICAgIGltYWdlLndpZHRoLCAvL3N3CiAgICAgIGltYWdlLmhlaWdodCwgLy9zaAogICAgICBib3VuZHMubGVmdCArIHBhZGRpbmdMZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgLy9keAogICAgICBib3VuZHMudG9wICsgcGFkZGluZ1RvcCArIGJvcmRlcnNbMF0ud2lkdGgsIC8vIGR5CiAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdwogICAgICBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoICsgcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pIC8vZGgKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlckRhdGEoZWxlbWVudCkgewogICAgcmV0dXJuIFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il0ubWFwKGZ1bmN0aW9uKHNpZGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogZ2V0Q1NTSW50KGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdXaWR0aCcpLAogICAgICAgIGNvbG9yOiBnZXRDU1MoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ0NvbG9yJykKICAgICAgfTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyUmFkaXVzRGF0YShlbGVtZW50KSB7CiAgICByZXR1cm4gWyJUb3BMZWZ0IiwgIlRvcFJpZ2h0IiwgIkJvdHRvbVJpZ2h0IiwgIkJvdHRvbUxlZnQiXS5tYXAoZnVuY3Rpb24oc2lkZSkgewogICAgICByZXR1cm4gZ2V0Q1NTKGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdSYWRpdXMnKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0Q3VydmVQb2ludHMoeCwgeSwgcjEsIHIyKSB7CiAgICB2YXIga2FwcGEgPSA0ICogKChNYXRoLnNxcnQoMikgLSAxKSAvIDMpOwogICAgdmFyIG94ID0gKHIxKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCiAgICBveSA9IChyMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgdmVydGljYWwKICAgIHhtID0geCArIHIxLCAvLyB4LW1pZGRsZQogICAgeW0gPSB5ICsgcjI7IC8vIHktbWlkZGxlCiAgICByZXR1cm4gewogICAgICB0b3BMZWZ0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgeDp4LAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnltIC0gb3kKICAgICAgfSwgewogICAgICAgIHg6eG0gLSBveCwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5CiAgICAgIH0pLAogICAgICB0b3BSaWdodDogYmV6aWVyQ3VydmUoewogICAgICAgIHg6eCwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eCArIG94LAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnltIC0gb3kKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5bQogICAgICB9KSwKICAgICAgYm90dG9tUmlnaHQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnkgKyBveQogICAgICB9LCB7CiAgICAgICAgeDp4ICsgb3gsCiAgICAgICAgeTp5bQogICAgICB9LCB7CiAgICAgICAgeDp4LAogICAgICAgIHk6eW0KICAgICAgfSksCiAgICAgIGJvdHRvbUxlZnQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eG0gLSBveCwKICAgICAgICB5OnltCiAgICAgIH0sIHsKICAgICAgICB4OngsCiAgICAgICAgeTp5ICsgb3kKICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnkKICAgICAgfSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBiZXppZXJDdXJ2ZShzdGFydCwgc3RhcnRDb250cm9sLCBlbmRDb250cm9sLCBlbmQpIHsKCiAgICB2YXIgbGVycCA9IGZ1bmN0aW9uIChhLCBiLCB0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDphLnggKyAoYi54IC0gYS54KSAqIHQsCiAgICAgICAgeTphLnkgKyAoYi55IC0gYS55KSAqIHQKICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICBzdGFydENvbnRyb2w6IHN0YXJ0Q29udHJvbCwKICAgICAgZW5kQ29udHJvbDogZW5kQ29udHJvbCwKICAgICAgZW5kOiBlbmQsCiAgICAgIHN1YmRpdmlkZTogZnVuY3Rpb24odCkgewogICAgICAgIHZhciBhYiA9IGxlcnAoc3RhcnQsIHN0YXJ0Q29udHJvbCwgdCksCiAgICAgICAgYmMgPSBsZXJwKHN0YXJ0Q29udHJvbCwgZW5kQ29udHJvbCwgdCksCiAgICAgICAgY2QgPSBsZXJwKGVuZENvbnRyb2wsIGVuZCwgdCksCiAgICAgICAgYWJiYyA9IGxlcnAoYWIsIGJjLCB0KSwKICAgICAgICBiY2NkID0gbGVycChiYywgY2QsIHQpLAogICAgICAgIGRlc3QgPSBsZXJwKGFiYmMsIGJjY2QsIHQpOwogICAgICAgIHJldHVybiBbYmV6aWVyQ3VydmUoc3RhcnQsIGFiLCBhYmJjLCBkZXN0KSwgYmV6aWVyQ3VydmUoZGVzdCwgYmNjZCwgY2QsIGVuZCldOwogICAgICB9LAogICAgICBjdXJ2ZVRvOiBmdW5jdGlvbihib3JkZXJBcmdzKSB7CiAgICAgICAgYm9yZGVyQXJncy5wdXNoKFsiYmV6aWVyQ3VydmUiLCBzdGFydENvbnRyb2wueCwgc3RhcnRDb250cm9sLnksIGVuZENvbnRyb2wueCwgZW5kQ29udHJvbC55LCBlbmQueCwgZW5kLnldKTsKICAgICAgfSwKICAgICAgY3VydmVUb1JldmVyc2VkOiBmdW5jdGlvbihib3JkZXJBcmdzKSB7CiAgICAgICAgYm9yZGVyQXJncy5wdXNoKFsiYmV6aWVyQ3VydmUiLCBlbmRDb250cm9sLngsIGVuZENvbnRyb2wueSwgc3RhcnRDb250cm9sLngsIHN0YXJ0Q29udHJvbC55LCBzdGFydC54LCBzdGFydC55XSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXMxLCByYWRpdXMyLCBjb3JuZXIxLCBjb3JuZXIyLCB4LCB5KSB7CiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGNvcm5lcjFbMF0uc3RhcnQueCwgY29ybmVyMVswXS5zdGFydC55XSk7CiAgICAgIGNvcm5lcjFbMF0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgICAgY29ybmVyMVsxXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIHgsIHldKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMlswXSA+IDAgfHwgcmFkaXVzMlsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGNvcm5lcjJbMF0uc3RhcnQueCwgY29ybmVyMlswXS5zdGFydC55XSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkcmF3U2lkZShib3JkZXJEYXRhLCByYWRpdXMxLCByYWRpdXMyLCBvdXRlcjEsIGlubmVyMSwgb3V0ZXIyLCBpbm5lcjIpIHsKICAgIHZhciBib3JkZXJBcmdzID0gW107CgogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBvdXRlcjFbMV0uc3RhcnQueCwgb3V0ZXIxWzFdLnN0YXJ0LnldKTsKICAgICAgb3V0ZXIxWzFdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzFbMF0sIGJvcmRlckRhdGEuYzFbMV1dKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMlswXSA+IDAgfHwgcmFkaXVzMlsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIG91dGVyMlswXS5zdGFydC54LCBvdXRlcjJbMF0uc3RhcnQueV0pOwogICAgICBvdXRlcjJbMF0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGlubmVyMlswXS5lbmQueCwgaW5uZXIyWzBdLmVuZC55XSk7CiAgICAgIGlubmVyMlswXS5jdXJ2ZVRvUmV2ZXJzZWQoYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzJbMF0sIGJvcmRlckRhdGEuYzJbMV1dKTsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMzWzBdLCBib3JkZXJEYXRhLmMzWzFdXSk7CiAgICB9CgogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBpbm5lcjFbMV0uZW5kLngsIGlubmVyMVsxXS5lbmQueV0pOwogICAgICBpbm5lcjFbMV0uY3VydmVUb1JldmVyc2VkKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmM0WzBdLCBib3JkZXJEYXRhLmM0WzFdXSk7CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckFyZ3M7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVDdXJ2ZVBvaW50cyhib3VuZHMsIGJvcmRlclJhZGl1cywgYm9yZGVycykgewoKICAgIHZhciB4ID0gYm91bmRzLmxlZnQsCiAgICB5ID0gYm91bmRzLnRvcCwKICAgIHdpZHRoID0gYm91bmRzLndpZHRoLAogICAgaGVpZ2h0ID0gYm91bmRzLmhlaWdodCwKCiAgICB0bGggPSBib3JkZXJSYWRpdXNbMF1bMF0sCiAgICB0bHYgPSBib3JkZXJSYWRpdXNbMF1bMV0sCiAgICB0cmggPSBib3JkZXJSYWRpdXNbMV1bMF0sCiAgICB0cnYgPSBib3JkZXJSYWRpdXNbMV1bMV0sCiAgICBicmggPSBib3JkZXJSYWRpdXNbMl1bMF0sCiAgICBicnYgPSBib3JkZXJSYWRpdXNbMl1bMV0sCiAgICBibGggPSBib3JkZXJSYWRpdXNbM11bMF0sCiAgICBibHYgPSBib3JkZXJSYWRpdXNbM11bMV0sCgogICAgdG9wV2lkdGggPSB3aWR0aCAtIHRyaCwKICAgIHJpZ2h0SGVpZ2h0ID0gaGVpZ2h0IC0gYnJ2LAogICAgYm90dG9tV2lkdGggPSB3aWR0aCAtIGJyaCwKICAgIGxlZnRIZWlnaHQgPSBoZWlnaHQgLSBibHY7CgogICAgcmV0dXJuIHsKICAgICAgdG9wTGVmdE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4LAogICAgICAgIHksCiAgICAgICAgdGxoLAogICAgICAgIHRsdgogICAgICAgICkudG9wTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcExlZnRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgTWF0aC5tYXgoMCwgdGxoIC0gYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgdGx2IC0gYm9yZGVyc1swXS53aWR0aCkKICAgICAgICApLnRvcExlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BSaWdodE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgdG9wV2lkdGgsCiAgICAgICAgeSwKICAgICAgICB0cmgsCiAgICAgICAgdHJ2CiAgICAgICAgKS50b3BSaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcFJpZ2h0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBNYXRoLm1pbih0b3BXaWR0aCwgd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICB5ICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgICAodG9wV2lkdGggPiB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpID8gMCA6dHJoIC0gYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB0cnYgLSBib3JkZXJzWzBdLndpZHRoCiAgICAgICAgKS50b3BSaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbVJpZ2h0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3R0b21XaWR0aCwKICAgICAgICB5ICsgcmlnaHRIZWlnaHQsCiAgICAgICAgYnJoLAogICAgICAgIGJydgogICAgICAgICkuYm90dG9tUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21SaWdodElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgTWF0aC5taW4oYm90dG9tV2lkdGgsIHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgeSArIE1hdGgubWluKHJpZ2h0SGVpZ2h0LCBoZWlnaHQgKyBib3JkZXJzWzBdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBicmggLSBib3JkZXJzWzFdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBicnYgLSBib3JkZXJzWzJdLndpZHRoKQogICAgICAgICkuYm90dG9tUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21MZWZ0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHgsCiAgICAgICAgeSArIGxlZnRIZWlnaHQsCiAgICAgICAgYmxoLAogICAgICAgIGJsdgogICAgICAgICkuYm90dG9tTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbUxlZnRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgeSArIGxlZnRIZWlnaHQsCiAgICAgICAgTWF0aC5tYXgoMCwgYmxoIC0gYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYmx2IC0gYm9yZGVyc1syXS53aWR0aCkKICAgICAgICApLmJvdHRvbUxlZnQuc3ViZGl2aWRlKDAuNSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBnZXRCb3JkZXJDbGlwKGVsZW1lbnQsIGJvcmRlclBvaW50cywgYm9yZGVycywgcmFkaXVzLCBib3VuZHMpIHsKICAgIHZhciBiYWNrZ3JvdW5kQ2xpcCA9IGdldENTUyhlbGVtZW50LCAnYmFja2dyb3VuZENsaXAnKSwKICAgIGJvcmRlckFyZ3MgPSBbXTsKCiAgICBzd2l0Y2goYmFja2dyb3VuZENsaXApIHsKICAgICAgY2FzZSAiY29udGVudC1ib3giOgogICAgICBjYXNlICJwYWRkaW5nLWJveCI6CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzBdLCByYWRpdXNbMV0sIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3VuZHMubGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMV0sIHJhZGl1c1syXSwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCAtIGJvcmRlcnNbMV0ud2lkdGgsIGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMl0sIHJhZGl1c1szXSwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoIC0gYm9yZGVyc1sxXS53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQgLSBib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbM10sIHJhZGl1c1swXSwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCAtIGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMF0sIHJhZGl1c1sxXSwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMV0sIHJhZGl1c1syXSwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzJdLCByYWRpdXNbM10sIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1szXSwgcmFkaXVzWzBdLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBib3JkZXJBcmdzOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VCb3JkZXJzKGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyl7CiAgICB2YXIgeCA9IGJvdW5kcy5sZWZ0LAogICAgeSA9IGJvdW5kcy50b3AsCiAgICB3aWR0aCA9IGJvdW5kcy53aWR0aCwKICAgIGhlaWdodCA9IGJvdW5kcy5oZWlnaHQsCiAgICBib3JkZXJTaWRlLAogICAgYngsCiAgICBieSwKICAgIGJ3LAogICAgYmgsCiAgICBib3JkZXJBcmdzLAogICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1iYWNrZ3JvdW5kLyN0aGUtYm9yZGVyLXJhZGl1cwogICAgYm9yZGVyUmFkaXVzID0gZ2V0Qm9yZGVyUmFkaXVzRGF0YShlbGVtZW50KSwKICAgIGJvcmRlclBvaW50cyA9IGNhbGN1bGF0ZUN1cnZlUG9pbnRzKGJvdW5kcywgYm9yZGVyUmFkaXVzLCBib3JkZXJzKSwKICAgIGJvcmRlckRhdGEgPSB7CiAgICAgIGNsaXA6IGdldEJvcmRlckNsaXAoZWxlbWVudCwgYm9yZGVyUG9pbnRzLCBib3JkZXJzLCBib3JkZXJSYWRpdXMsIGJvdW5kcyksCiAgICAgIGJvcmRlcnM6IFtdCiAgICB9OwoKICAgIGZvciAoYm9yZGVyU2lkZSA9IDA7IGJvcmRlclNpZGUgPCA0OyBib3JkZXJTaWRlKyspIHsKCiAgICAgIGlmIChib3JkZXJzW2JvcmRlclNpZGVdLndpZHRoID4gMCkgewogICAgICAgIGJ4ID0geDsKICAgICAgICBieSA9IHk7CiAgICAgICAgYncgPSB3aWR0aDsKICAgICAgICBiaCA9IGhlaWdodCAtIChib3JkZXJzWzJdLndpZHRoKTsKCiAgICAgICAgc3dpdGNoKGJvcmRlclNpZGUpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgLy8gdG9wIGJvcmRlcgogICAgICAgICAgICBiaCA9IGJvcmRlcnNbMF0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYngsIGJ5XSwKICAgICAgICAgICAgICBjMjogW2J4ICsgYncsIGJ5XSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYncgLSBib3JkZXJzWzFdLndpZHRoLCBieSArIGJoXSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYm9yZGVyc1szXS53aWR0aCwgYnkgKyBiaF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzBdLCBib3JkZXJSYWRpdXNbMV0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAvLyByaWdodCBib3JkZXIKICAgICAgICAgICAgYnggPSB4ICsgd2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCk7CiAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1sxXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCArIGJ3LCBieV0sCiAgICAgICAgICAgICAgYzI6IFtieCArIGJ3LCBieSArIGJoICsgYm9yZGVyc1syXS53aWR0aF0sCiAgICAgICAgICAgICAgYzM6IFtieCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzQ6IFtieCwgYnkgKyBib3JkZXJzWzBdLndpZHRoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMV0sIGJvcmRlclJhZGl1c1syXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgLy8gYm90dG9tIGJvcmRlcgogICAgICAgICAgICBieSA9IChieSArIGhlaWdodCkgLSAoYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgICAgIGJoID0gYm9yZGVyc1syXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCArIGJ3LCBieSArIGJoXSwKICAgICAgICAgICAgICBjMjogW2J4LCBieSArIGJoXSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYm9yZGVyc1szXS53aWR0aCwgYnldLAogICAgICAgICAgICAgIGM0OiBbYnggKyBidyAtIGJvcmRlcnNbM10ud2lkdGgsIGJ5XQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMl0sIGJvcmRlclJhZGl1c1szXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIC8vIGxlZnQgYm9yZGVyCiAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1szXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCwgYnkgKyBiaCArIGJvcmRlcnNbMl0ud2lkdGhdLAogICAgICAgICAgICAgIGMyOiBbYngsIGJ5XSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYncsIGJ5ICsgYm9yZGVyc1swXS53aWR0aF0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJ3LCBieSArIGJoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbM10sIGJvcmRlclJhZGl1c1swXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgYm9yZGVyRGF0YS5ib3JkZXJzLnB1c2goewogICAgICAgICAgYXJnczogYm9yZGVyQXJncywKICAgICAgICAgIGNvbG9yOiBib3JkZXJzW2JvcmRlclNpZGVdLmNvbG9yCiAgICAgICAgfSk7CgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckRhdGE7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTaGFwZShjdHgsIGFyZ3MpIHsKICAgIHZhciBzaGFwZSA9IGN0eC5kcmF3U2hhcGUoKTsKICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbihib3JkZXIsIGluZGV4KSB7CiAgICAgIHNoYXBlWyhpbmRleCA9PT0gMCkgPyAibW92ZVRvIiA6IGJvcmRlclswXSArICJUbyIgXS5hcHBseShudWxsLCBib3JkZXIuc2xpY2UoMSkpOwogICAgfSk7CiAgICByZXR1cm4gc2hhcGU7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCb3JkZXJzKGN0eCwgYm9yZGVyQXJncywgY29sb3IpIHsKICAgIGlmIChjb2xvciAhPT0gInRyYW5zcGFyZW50IikgewogICAgICBjdHguc2V0VmFyaWFibGUoICJmaWxsU3R5bGUiLCBjb2xvcik7CiAgICAgIGNyZWF0ZVNoYXBlKGN0eCwgYm9yZGVyQXJncyk7CiAgICAgIGN0eC5maWxsKCk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyRm9ybVZhbHVlIChlbCwgYm91bmRzLCBzdGFjayl7CgogICAgdmFyIHZhbHVlV3JhcCA9IGRvYy5jcmVhdGVFbGVtZW50KCd2YWx1ZXdyYXAnKSwKICAgIGNzc1Byb3BlcnR5QXJyYXkgPSBbJ2xpbmVIZWlnaHQnLCd0ZXh0QWxpZ24nLCdmb250RmFtaWx5JywnY29sb3InLCdmb250U2l6ZScsJ3BhZGRpbmdMZWZ0JywncGFkZGluZ1RvcCcsJ3dpZHRoJywnaGVpZ2h0JywnYm9yZGVyJywnYm9yZGVyTGVmdFdpZHRoJywnYm9yZGVyVG9wV2lkdGgnXSwKICAgIHRleHRWYWx1ZSwKICAgIHRleHROb2RlOwoKICAgIGNzc1Byb3BlcnR5QXJyYXkuZm9yRWFjaChmdW5jdGlvbihwcm9wZXJ0eSkgewogICAgICB0cnkgewogICAgICAgIHZhbHVlV3JhcC5zdHlsZVtwcm9wZXJ0eV0gPSBnZXRDU1MoZWwsIHByb3BlcnR5KTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgLy8gT2xkZXIgSUUgaGFzIGlzc3VlcyB3aXRoICJib3JkZXIiCiAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBQYXJzZTogRXhjZXB0aW9uIGNhdWdodCBpbiByZW5kZXJGb3JtVmFsdWU6ICIgKyBlLm1lc3NhZ2UpOwogICAgICB9CiAgICB9KTsKCiAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyQ29sb3IgPSAiYmxhY2siOwogICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlclN0eWxlID0gInNvbGlkIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CgogICAgaWYgKC9eKHN1Ym1pdHxyZXNldHxidXR0b258dGV4dHxwYXNzd29yZCkkLy50ZXN0KGVsLnR5cGUpIHx8IGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7CiAgICAgIHZhbHVlV3JhcC5zdHlsZS5saW5lSGVpZ2h0ID0gZ2V0Q1NTKGVsLCAiaGVpZ2h0Iik7CiAgICB9CgogICAgdmFsdWVXcmFwLnN0eWxlLnRvcCA9IGJvdW5kcy50b3AgKyAicHgiOwogICAgdmFsdWVXcmFwLnN0eWxlLmxlZnQgPSBib3VuZHMubGVmdCArICJweCI7CgogICAgdGV4dFZhbHVlID0gKGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIikgPyAoZWwub3B0aW9uc1tlbC5zZWxlY3RlZEluZGV4XSB8fCAwKS50ZXh0IDogZWwudmFsdWU7CiAgICBpZighdGV4dFZhbHVlKSB7CiAgICAgIHRleHRWYWx1ZSA9IGVsLnBsYWNlaG9sZGVyOwogICAgfQoKICAgIHRleHROb2RlID0gZG9jLmNyZWF0ZVRleHROb2RlKHRleHRWYWx1ZSk7CgogICAgdmFsdWVXcmFwLmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgIGJvZHkuYXBwZW5kQ2hpbGQodmFsdWVXcmFwKTsKCiAgICByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spOwogICAgYm9keS5yZW1vdmVDaGlsZCh2YWx1ZVdyYXApOwogIH0KCiAgZnVuY3Rpb24gZHJhd0ltYWdlIChjdHgpIHsKICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoY3R4LCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIG51bURyYXdzKz0xOwogIH0KCiAgZnVuY3Rpb24gZ2V0UHNldWRvRWxlbWVudChlbCwgd2hpY2gpIHsKICAgIHZhciBlbFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwsIHdoaWNoKTsKICAgIHZhciBwYXJlbnRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsKICAgIC8vIElmIG5vIGNvbnRlbnQgYXR0cmlidXRlIGlzIHByZXNlbnQsIHRoZSBwc2V1ZG8gZWxlbWVudCBpcyBoaWRkZW4sCiAgICAvLyBvciB0aGUgcGFyZW50IGhhcyBhIGNvbnRlbnQgcHJvcGVydHkgZXF1YWwgdG8gdGhlIGNvbnRlbnQgb24gdGhlIHBzZXVkbyBlbGVtZW50LAogICAgLy8gbW92ZSBhbG9uZy4KICAgIGlmKCFlbFN0eWxlIHx8ICFlbFN0eWxlLmNvbnRlbnQgfHwgZWxTdHlsZS5jb250ZW50ID09PSAibm9uZSIgfHwgZWxTdHlsZS5jb250ZW50ID09PSAiLW1vei1hbHQtY29udGVudCIgfHwKICAgICAgIGVsU3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IHBhcmVudFN0eWxlLmNvbnRlbnQgPT09IGVsU3R5bGUuY29udGVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29udGVudCA9IGVsU3R5bGUuY29udGVudCArICcnOwoKICAgIC8vIFN0cmlwIGlubmVyIHF1b3RlcwogICAgaWYoY29udGVudFswXSA9PT0gIiciIHx8IGNvbnRlbnRbMF0gPT09ICJcIiIpIHsKICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgvKF5bJyJdKXwoWyciXSQpL2csICcnKTsKICAgIH0KCiAgICB2YXIgaXNJbWFnZSA9IGNvbnRlbnQuc3Vic3RyKCAwLCAzICkgPT09ICd1cmwnLAogICAgZWxwcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIGlzSW1hZ2UgPyAnaW1nJyA6ICdzcGFuJyApOwoKICAgIGVscHMuY2xhc3NOYW1lID0gcHNldWRvSGlkZSArICItZWxlbWVudCAiOwoKICAgIE9iamVjdC5rZXlzKGVsU3R5bGUpLmZpbHRlcihpbmRleGVkUHJvcGVydHkpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAvLyBQcmV2ZW50IGFzc2lnbmluZyBvZiByZWFkIG9ubHkgQ1NTIFJ1bGVzLCBleC4gbGVuZ3RoLCBwYXJlbnRSdWxlCiAgICAgIHRyeSB7CiAgICAgICAgZWxwcy5zdHlsZVtwcm9wXSA9IGVsU3R5bGVbcHJvcF07CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBVdGlsLmxvZyhbJ1RyaWVkIHRvIGFzc2lnbiByZWFkb25seSBwcm9wZXJ0eSAnLCBwcm9wLCAnRXJyb3I6JywgZV0pOwogICAgICB9CiAgICB9KTsKCiAgICBpZihpc0ltYWdlKSB7CiAgICAgIGVscHMuc3JjID0gVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdOwogICAgfSBlbHNlIHsKICAgICAgZWxwcy5pbm5lckhUTUwgPSBjb250ZW50OwogICAgfQogICAgcmV0dXJuIGVscHM7CiAgfQoKICBmdW5jdGlvbiBpbmRleGVkUHJvcGVydHkocHJvcGVydHkpIHsKICAgIHJldHVybiAoaXNOYU4od2luZG93LnBhcnNlSW50KHByb3BlcnR5LCAxMCkpKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpIHsKICAgIHZhciBvZmZzZXRYID0gTWF0aC5yb3VuZChib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0KSwKICAgIG9mZnNldFkgPSBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wKTsKCiAgICBjdHguY3JlYXRlUGF0dGVybihpbWFnZSk7CiAgICBjdHgudHJhbnNsYXRlKG9mZnNldFgsIG9mZnNldFkpOwogICAgY3R4LmZpbGwoKTsKICAgIGN0eC50cmFuc2xhdGUoLW9mZnNldFgsIC1vZmZzZXRZKTsKICB9CgogIGZ1bmN0aW9uIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICB2YXIgYXJncyA9IFtdOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCksIE1hdGgucm91bmQodG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCArIHdpZHRoKSwgTWF0aC5yb3VuZCh0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0ICsgd2lkdGgpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGNyZWF0ZVNoYXBlKGN0eCwgYXJncyk7CiAgICBjdHguc2F2ZSgpOwogICAgY3R4LmNsaXAoKTsKICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpOwogICAgY3R4LnJlc3RvcmUoKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRDb2xvcihjdHgsIGJhY2tncm91bmRCb3VuZHMsIGJnY29sb3IpIHsKICAgIHJlbmRlclJlY3QoCiAgICAgIGN0eCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5sZWZ0LAogICAgICBiYWNrZ3JvdW5kQm91bmRzLnRvcCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy53aWR0aCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5oZWlnaHQsCiAgICAgIGJnY29sb3IKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcoZWwsIGJvdW5kcywgY3R4LCBpbWFnZSwgaW1hZ2VJbmRleCkgewogICAgdmFyIGJhY2tncm91bmRTaXplID0gVXRpbC5CYWNrZ3JvdW5kU2l6ZShlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCksCiAgICBiYWNrZ3JvdW5kUG9zaXRpb24gPSBVdGlsLkJhY2tncm91bmRQb3NpdGlvbihlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCwgYmFja2dyb3VuZFNpemUpLAogICAgYmFja2dyb3VuZFJlcGVhdCA9IFV0aWwuQmFja2dyb3VuZFJlcGVhdChlbCwgaW1hZ2VJbmRleCk7CgogICAgaW1hZ2UgPSByZXNpemVJbWFnZShpbWFnZSwgYmFja2dyb3VuZFNpemUpOwoKICAgIHN3aXRjaCAoYmFja2dyb3VuZFJlcGVhdCkgewogICAgICBjYXNlICJyZXBlYXQteCI6CiAgICAgIGNhc2UgInJlcGVhdCBuby1yZXBlYXQiOgogICAgICAgIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywKICAgICAgICAgIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgOTk5OTksIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInJlcGVhdC15IjoKICAgICAgY2FzZSAibm8tcmVwZWF0IHJlcGVhdCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCwgYm91bmRzLnRvcCwgaW1hZ2Uud2lkdGgsIDk5OTk5KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibm8tcmVwZWF0IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIHsKICAgICAgICAgIHRvcDogYm91bmRzLnRvcCwKICAgICAgICAgIGxlZnQ6IGJvdW5kcy5sZWZ0LAogICAgICAgICAgd2lkdGg6IGltYWdlLndpZHRoLAogICAgICAgICAgaGVpZ2h0OiBpbWFnZS5oZWlnaHQKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRJbWFnZShlbGVtZW50LCBib3VuZHMsIGN0eCkgewogICAgdmFyIGJhY2tncm91bmRJbWFnZSA9IGdldENTUyhlbGVtZW50LCAiYmFja2dyb3VuZEltYWdlIiksCiAgICBiYWNrZ3JvdW5kSW1hZ2VzID0gVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShiYWNrZ3JvdW5kSW1hZ2UpLAogICAgaW1hZ2UsCiAgICBpbWFnZUluZGV4ID0gYmFja2dyb3VuZEltYWdlcy5sZW5ndGg7CgogICAgd2hpbGUoaW1hZ2VJbmRleC0tKSB7CiAgICAgIGJhY2tncm91bmRJbWFnZSA9IGJhY2tncm91bmRJbWFnZXNbaW1hZ2VJbmRleF07CgogICAgICBpZiAoIWJhY2tncm91bmRJbWFnZS5hcmdzIHx8IGJhY2tncm91bmRJbWFnZS5hcmdzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIga2V5ID0gYmFja2dyb3VuZEltYWdlLm1ldGhvZCA9PT0gJ3VybCcgPwogICAgICBiYWNrZ3JvdW5kSW1hZ2UuYXJnc1swXSA6CiAgICAgIGJhY2tncm91bmRJbWFnZS52YWx1ZTsKCiAgICAgIGltYWdlID0gbG9hZEltYWdlKGtleSk7CgogICAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBiYWNrZ3JvdW5kLW9yaWdpbgogICAgICBpZiAoaW1hZ2UpIHsKICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0aW5nKGVsZW1lbnQsIGJvdW5kcywgY3R4LCBpbWFnZSwgaW1hZ2VJbmRleCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBFcnJvciBsb2FkaW5nIGJhY2tncm91bmQ6IiwgYmFja2dyb3VuZEltYWdlKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzaXplSW1hZ2UoaW1hZ2UsIGJvdW5kcykgewogICAgaWYoaW1hZ2Uud2lkdGggPT09IGJvdW5kcy53aWR0aCAmJiBpbWFnZS5oZWlnaHQgPT09IGJvdW5kcy5oZWlnaHQpIHsKICAgICAgcmV0dXJuIGltYWdlOwogICAgfQoKICAgIHZhciBjdHgsIGNhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgIGNhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0OwogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBkcmF3SW1hZ2UoY3R4LCBpbWFnZSwgMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0ICk7CiAgICByZXR1cm4gY2FudmFzOwogIH0KCiAgZnVuY3Rpb24gc2V0T3BhY2l0eShjdHgsIGVsZW1lbnQsIHBhcmVudFN0YWNrKSB7CiAgICByZXR1cm4gY3R4LnNldFZhcmlhYmxlKCJnbG9iYWxBbHBoYSIsIGdldENTUyhlbGVtZW50LCAib3BhY2l0eSIpICogKChwYXJlbnRTdGFjaykgPyBwYXJlbnRTdGFjay5vcGFjaXR5IDogMSkpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlUHgoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoInB4IiwgIiIpOwogIH0KCiAgZnVuY3Rpb24gZ2V0VHJhbnNmb3JtKGVsZW1lbnQsIHBhcmVudFN0YWNrKSB7CiAgICB2YXIgdHJhbnNmb3JtUmVnRXhwID0gLyhtYXRyaXgpXCgoLispXCkvOwogICAgdmFyIHRyYW5zZm9ybSA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItd2Via2l0LXRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1vei10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1vLXRyYW5zZm9ybSIpOwogICAgdmFyIHRyYW5zZm9ybU9yaWdpbiA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLXdlYmtpdC10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbW96LXRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItby10cmFuc2Zvcm0tb3JpZ2luIikgfHwgIjBweCAwcHgiOwoKICAgIHRyYW5zZm9ybU9yaWdpbiA9IHRyYW5zZm9ybU9yaWdpbi5zcGxpdCgiICIpLm1hcChyZW1vdmVQeCkubWFwKFV0aWwuYXNGbG9hdCk7CgogICAgdmFyIG1hdHJpeDsKICAgIGlmICh0cmFuc2Zvcm0gJiYgdHJhbnNmb3JtICE9PSAibm9uZSIpIHsKICAgICAgdmFyIG1hdGNoID0gdHJhbnNmb3JtLm1hdGNoKHRyYW5zZm9ybVJlZ0V4cCk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIHN3aXRjaChtYXRjaFsxXSkgewogICAgICAgICAgY2FzZSAibWF0cml4IjoKICAgICAgICAgICAgbWF0cml4ID0gbWF0Y2hbMl0uc3BsaXQoIiwiKS5tYXAoVXRpbC50cmltVGV4dCkubWFwKFV0aWwuYXNGbG9hdCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG9yaWdpbjogdHJhbnNmb3JtT3JpZ2luLAogICAgICBtYXRyaXg6IG1hdHJpeAogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSkgewogICAgdmFyIGN0eCA9IGgyY1JlbmRlckNvbnRleHQoKCFwYXJlbnRTdGFjaykgPyBkb2N1bWVudFdpZHRoKCkgOiBib3VuZHMud2lkdGggLCAoIXBhcmVudFN0YWNrKSA/IGRvY3VtZW50SGVpZ2h0KCkgOiBib3VuZHMuaGVpZ2h0KSwKICAgIHN0YWNrID0gewogICAgICBjdHg6IGN0eCwKICAgICAgb3BhY2l0eTogc2V0T3BhY2l0eShjdHgsIGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgICAgY3NzUG9zaXRpb246IGdldENTUyhlbGVtZW50LCAicG9zaXRpb24iKSwKICAgICAgYm9yZGVyczogZ2V0Qm9yZGVyRGF0YShlbGVtZW50KSwKICAgICAgdHJhbnNmb3JtOiB0cmFuc2Zvcm0sCiAgICAgIGNsaXA6IChwYXJlbnRTdGFjayAmJiBwYXJlbnRTdGFjay5jbGlwKSA/IFV0aWwuRXh0ZW5kKCB7fSwgcGFyZW50U3RhY2suY2xpcCApIDogbnVsbAogICAgfTsKCiAgICBzZXRaKGVsZW1lbnQsIHN0YWNrLCBwYXJlbnRTdGFjayk7CgogICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uCiAgICBpZiAob3B0aW9ucy51c2VPdmVyZmxvdyA9PT0gdHJ1ZSAmJiAvKGhpZGRlbnxzY3JvbGx8YXV0bykvLnRlc3QoZ2V0Q1NTKGVsZW1lbnQsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbGVtZW50Lm5vZGVOYW1lKSA9PT0gZmFsc2UpewogICAgICBzdGFjay5jbGlwID0gKHN0YWNrLmNsaXApID8gY2xpcEJvdW5kcyhzdGFjay5jbGlwLCBib3VuZHMpIDogYm91bmRzOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGdldEJhY2tncm91bmRCb3VuZHMoYm9yZGVycywgYm91bmRzLCBjbGlwKSB7CiAgICB2YXIgYmFja2dyb3VuZEJvdW5kcyA9IHsKICAgICAgbGVmdDogYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLAogICAgICB0b3A6IGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICB3aWR0aDogYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgaGVpZ2h0OiBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQogICAgfTsKCiAgICBpZiAoY2xpcCkgewogICAgICBiYWNrZ3JvdW5kQm91bmRzID0gY2xpcEJvdW5kcyhiYWNrZ3JvdW5kQm91bmRzLCBjbGlwKTsKICAgIH0KCiAgICByZXR1cm4gYmFja2dyb3VuZEJvdW5kczsKICB9CgogIGZ1bmN0aW9uIGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pIHsKICAgIHZhciBib3VuZHMgPSAodHJhbnNmb3JtLm1hdHJpeCkgPyBVdGlsLk9mZnNldEJvdW5kcyhlbGVtZW50KSA6IFV0aWwuQm91bmRzKGVsZW1lbnQpOwogICAgdHJhbnNmb3JtLm9yaWdpblswXSArPSBib3VuZHMubGVmdDsKICAgIHRyYW5zZm9ybS5vcmlnaW5bMV0gKz0gYm91bmRzLnRvcDsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsZW1lbnQsIHBhcmVudFN0YWNrLCBpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICB2YXIgdHJhbnNmb3JtID0gZ2V0VHJhbnNmb3JtKGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgIGJvdW5kcyA9IGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pLAogICAgaW1hZ2UsCiAgICBzdGFjayA9IGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSksCiAgICBib3JkZXJzID0gc3RhY2suYm9yZGVycywKICAgIGN0eCA9IHN0YWNrLmN0eCwKICAgIGJhY2tncm91bmRCb3VuZHMgPSBnZXRCYWNrZ3JvdW5kQm91bmRzKGJvcmRlcnMsIGJvdW5kcywgc3RhY2suY2xpcCksCiAgICBib3JkZXJEYXRhID0gcGFyc2VCb3JkZXJzKGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyksCiAgICBiYWNrZ3JvdW5kQ29sb3IgPSAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbGVtZW50Lm5vZGVOYW1lKSkgPyAiI2VmZWZlZiIgOiBnZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRDb2xvciIpOwoKCiAgICBjcmVhdGVTaGFwZShjdHgsIGJvcmRlckRhdGEuY2xpcCk7CgogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5jbGlwKCk7CgogICAgaWYgKGJhY2tncm91bmRCb3VuZHMuaGVpZ2h0ID4gMCAmJiBiYWNrZ3JvdW5kQm91bmRzLndpZHRoID4gMCAmJiAhaWdub3JlQmFja2dyb3VuZCkgewogICAgICByZW5kZXJCYWNrZ3JvdW5kQ29sb3IoY3R4LCBib3VuZHMsIGJhY2tncm91bmRDb2xvcik7CiAgICAgIHJlbmRlckJhY2tncm91bmRJbWFnZShlbGVtZW50LCBiYWNrZ3JvdW5kQm91bmRzLCBjdHgpOwogICAgfSBlbHNlIGlmIChpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9ICBiYWNrZ3JvdW5kQ29sb3I7CiAgICB9CgogICAgY3R4LnJlc3RvcmUoKTsKCiAgICBib3JkZXJEYXRhLmJvcmRlcnMuZm9yRWFjaChmdW5jdGlvbihib3JkZXIpIHsKICAgICAgcmVuZGVyQm9yZGVycyhjdHgsIGJvcmRlci5hcmdzLCBib3JkZXIuY29sb3IpOwogICAgfSk7CgogICAgc3dpdGNoKGVsZW1lbnQubm9kZU5hbWUpewogICAgICBjYXNlICJJTUciOgogICAgICAgIGlmICgoaW1hZ2UgPSBsb2FkSW1hZ2UoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKSkpIHsKICAgICAgICAgIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgaW1hZ2UsIGJvdW5kcywgYm9yZGVycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyA8aW1nPjoiICsgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIklOUFVUIjoKICAgICAgICAvLyBUT0RPIGFkZCBhbGwgcmVsZXZhbnQgdHlwZSdzLCBpLmUuIEhUTUw1IG5ldyBzdHVmZgogICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdAogICAgICAgIGlmICgvXih0ZXh0fHVybHxlbWFpbHxzdWJtaXR8YnV0dG9ufHJlc2V0KSQvLnRlc3QoZWxlbWVudC50eXBlKSAmJiAoZWxlbWVudC52YWx1ZSB8fCBlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlRFWFRBUkVBIjoKICAgICAgICBpZiAoKGVsZW1lbnQudmFsdWUgfHwgZWxlbWVudC5wbGFjZWhvbGRlciB8fCAiIikubGVuZ3RoID4gMCl7CiAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWxlbWVudCwgYm91bmRzLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJTRUxFQ1QiOgogICAgICAgIGlmICgoZWxlbWVudC5vcHRpb25zfHxlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkxJIjoKICAgICAgICByZW5kZXJMaXN0SXRlbShlbGVtZW50LCBzdGFjaywgYmFja2dyb3VuZEJvdW5kcyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkNBTlZBUyI6CiAgICAgICAgcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkgewogICAgcmV0dXJuIChnZXRDU1MoZWxlbWVudCwgJ2Rpc3BsYXknKSAhPT0gIm5vbmUiICYmIGdldENTUyhlbGVtZW50LCAndmlzaWJpbGl0eScpICE9PSAiaGlkZGVuIiAmJiAhZWxlbWVudC5oYXNBdHRyaWJ1dGUoImRhdGEtaHRtbDJjYW52YXMtaWdub3JlIikpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VFbGVtZW50IChlbGVtZW50LCBzdGFjaywgY2IpIHsKICAgIGlmICghY2IpIHsKICAgICAgY2IgPSBmdW5jdGlvbigpe307CiAgICB9CiAgICBpZiAoaXNFbGVtZW50VmlzaWJsZShlbGVtZW50KSkgewogICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgc3RhY2ssIGZhbHNlKSB8fCBzdGFjazsKICAgICAgaWYgKCFpZ25vcmVFbGVtZW50c1JlZ0V4cC50ZXN0KGVsZW1lbnQubm9kZU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIGNiKTsKICAgICAgfQogICAgfQogICAgY2IoKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIGNiKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBVdGlsLkNoaWxkcmVuKGVsZW1lbnQpOwogICAgLy8gQWZ0ZXIgYWxsIG5vZGVzIGhhdmUgcHJvY2Vzc2VkLCBmaW5pc2hlZCgpIHdpbGwgY2FsbCB0aGUgY2IuCiAgICAvLyBXZSBhZGQgb25lIGFuZCBraWNrIGl0IG9mZiBzbyB0aGlzIHdpbGwgc3RpbGwgd29yayB3aGVuIGNoaWxkcmVuLmxlbmd0aCA9PT0gMC4KICAgIC8vIE5vdGUgdGhhdCB1bmxlc3MgYXN5bmMgaXMgdHJ1ZSwgdGhpcyB3aWxsIGhhcHBlbiBzeW5jaHJvbm91c2x5LCBqdXN0IHdpbGwgY2FsbGJhY2tzLgogICAgdmFyIGpvYnMgPSBjaGlsZHJlbi5sZW5ndGggKyAxOwogICAgZmluaXNoZWQoKTsKCiAgICBpZiAob3B0aW9ucy5hc3luYykgewogICAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBEb24ndCBibG9jayB0aGUgcGFnZSBmcm9tIHJlbmRlcmluZwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcGFyc2VOb2RlKG5vZGUpOyB9LCAwKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjaGlsZHJlbi5mb3JFYWNoKHBhcnNlTm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VOb2RlKG5vZGUpIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IG5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgcGFyc2VFbGVtZW50KG5vZGUsIHN0YWNrLCBmaW5pc2hlZCk7CiAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gbm9kZS5URVhUX05PREUpIHsKICAgICAgICByZW5kZXJUZXh0KGVsZW1lbnQsIG5vZGUsIHN0YWNrKTsKICAgICAgICBmaW5pc2hlZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGZpbmlzaGVkKCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZpbmlzaGVkKGVsKSB7CiAgICAgIGlmICgtLWpvYnMgPD0gMCl7CiAgICAgICAgVXRpbC5sb2coImZpbmlzaGVkIHJlbmRlcmluZyAiICsgY2hpbGRyZW4ubGVuZ3RoICsgIiBjaGlsZHJlbi4iKTsKICAgICAgICBjYigpOwogICAgICB9CiAgICB9CiAgfQp9OwpfaHRtbDJjYW52YXMuUHJlbG9hZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICB2YXIgaW1hZ2VzID0gewogICAgbnVtTG9hZGVkOiAwLCAgIC8vIGFsc28gZmFpbGVkIGFyZSBjb3VudGVkIGhlcmUKICAgIG51bUZhaWxlZDogMCwKICAgIG51bVRvdGFsOiAwLAogICAgY2xlYW51cERvbmU6IGZhbHNlCiAgfSwKICBwYWdlT3JpZ2luLAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBtZXRob2RzLAogIGksCiAgY291bnQgPSAwLAogIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksCiAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LAogIGRvbUltYWdlcyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ltZycpLCAvLyBGZXRjaCBpbWFnZXMgb2YgdGhlIHByZXNlbnQgZWxlbWVudCBvbmx5CiAgaW1nTGVuID0gZG9tSW1hZ2VzLmxlbmd0aCwKICBsaW5rID0gZG9jLmNyZWF0ZUVsZW1lbnQoImEiKSwKICBzdXBwb3J0Q09SUyA9IChmdW5jdGlvbiggaW1nICl7CiAgICByZXR1cm4gKGltZy5jcm9zc09yaWdpbiAhPT0gdW5kZWZpbmVkKTsKICB9KShuZXcgSW1hZ2UoKSksCiAgdGltZW91dFRpbWVyOwoKICBsaW5rLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICBwYWdlT3JpZ2luICA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CgogIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbih1cmwpewogICAgbGluay5ocmVmID0gdXJsOwogICAgbGluay5ocmVmID0gbGluay5ocmVmOyAvLyBZRVMsIEJFTElFVkUgSVQgT1IgTk9ULCB0aGF0IGlzIHJlcXVpcmVkIGZvciBJRTkgLSBodHRwOi8vanNmaWRkbGUubmV0L25pa2xhc3ZoLzJlNDhiLwogICAgdmFyIG9yaWdpbiA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CiAgICByZXR1cm4gKG9yaWdpbiA9PT0gcGFnZU9yaWdpbik7CiAgfQoKICBmdW5jdGlvbiBzdGFydCgpewogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBzdGFydDogaW1hZ2VzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CiAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7CiAgICAgIFV0aWwubG9nKCJGaW5pc2hlZCBsb2FkaW5nIGltYWdlczogIyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY29tcGxldGUgPT09ICJmdW5jdGlvbiIpewogICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsKICAgICAgfQoKICAgIH0KICB9CgogIC8vIFRPRE8gbW9kaWZ5IHByb3h5IHRvIHNlcnZlIGltYWdlcyB3aXRoIENPUlMgZW5hYmxlZCwgd2hlcmUgYXZhaWxhYmxlCiAgZnVuY3Rpb24gcHJveHlHZXRJbWFnZSh1cmwsIGltZywgaW1hZ2VPYmopewogICAgdmFyIGNhbGxiYWNrX25hbWUsCiAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LAogICAgc2NyaXB0OwoKICAgIGxpbmsuaHJlZiA9IHVybDsKICAgIHVybCA9IGxpbmsuaHJlZjsgLy8gd29yayBhcm91bmQgZm9yIHBhZ2VzIHdpdGggYmFzZSBocmVmPSIiIHNldCAtIFdBUk5JTkc6IHRoaXMgbWF5IGNoYW5nZSB0aGUgdXJsCgogICAgY2FsbGJhY2tfbmFtZSA9ICdodG1sMmNhbnZhc18nICsgKGNvdW50KyspOwogICAgaW1hZ2VPYmouY2FsbGJhY2tuYW1lID0gY2FsbGJhY2tfbmFtZTsKCiAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7CiAgICAgIHNjcmlwdFVybCArPSAiJiI7CiAgICB9IGVsc2UgewogICAgICBzY3JpcHRVcmwgKz0gIj8iOwogICAgfQogICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsKICAgIHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCiAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSBmdW5jdGlvbihhKXsKICAgICAgaWYgKGEuc3Vic3RyaW5nKDAsNikgPT09ICJlcnJvcjoiKXsKICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICAgIHN0YXJ0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgaW1nLnNyYyA9IGE7CiAgICAgIH0KICAgICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gdW5kZWZpbmVkOyAvLyB0byB3b3JrIHdpdGggSUU8OSAgLy8gTk9URTogdGhhdCB0aGUgdW5kZWZpbmVkIGNhbGxiYWNrIHByb3BlcnR5LW5hbWUgc3RpbGwgZXhpc3RzIG9uIHRoZSB3aW5kb3cgb2JqZWN0IChmb3IgSUU8OSkKICAgICAgdHJ5IHsKICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrX25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgIH0gY2F0Y2goZXgpIHt9CiAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIHNjcmlwdCA9IG51bGw7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5zY3JpcHQ7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5jYWxsYmFja25hbWU7CiAgICB9OwoKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCBzY3JpcHRVcmwpOwogICAgaW1hZ2VPYmouc2NyaXB0ID0gc2NyaXB0OwogICAgd2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCB0eXBlKSwKICAgIGNvbnRlbnQgPSBzdHlsZS5jb250ZW50OwogICAgaWYgKGNvbnRlbnQuc3Vic3RyKDAsIDMpID09PSAndXJsJykgewogICAgICBtZXRob2RzLmxvYWRJbWFnZShfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdKTsKICAgIH0KICAgIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKHN0eWxlLmJhY2tncm91bmRJbWFnZSwgZWxlbWVudCk7CiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudEltYWdlcyhlbGVtZW50KSB7CiAgICBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCAiOmJlZm9yZSIpOwogICAgbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgIjphZnRlciIpOwogIH0KCiAgZnVuY3Rpb24gbG9hZEdyYWRpZW50SW1hZ2UoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpIHsKICAgIHZhciBpbWcgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuR3JhZGllbnQoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpOwoKICAgIGlmIChpbWcgIT09IHVuZGVmaW5lZCl7CiAgICAgIGltYWdlc1tiYWNrZ3JvdW5kSW1hZ2VdID0gewogICAgICAgIGltZzogaW1nLAogICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQogICAgICB9OwogICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICBzdGFydCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52YWxpZEJhY2tncm91bmRzKGJhY2tncm91bmRfaW1hZ2UpIHsKICAgIHJldHVybiAoYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZCAmJiBiYWNrZ3JvdW5kX2ltYWdlLmFyZ3MgJiYgYmFja2dyb3VuZF9pbWFnZS5hcmdzLmxlbmd0aCA+IDAgKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKGJhY2tncm91bmRfaW1hZ2UsIGVsKSB7CiAgICB2YXIgYm91bmRzOwoKICAgIF9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRfaW1hZ2UpLmZpbHRlcihpbnZhbGlkQmFja2dyb3VuZHMpLmZvckVhY2goZnVuY3Rpb24oYmFja2dyb3VuZF9pbWFnZSkgewogICAgICBpZiAoYmFja2dyb3VuZF9pbWFnZS5tZXRob2QgPT09ICd1cmwnKSB7CiAgICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5hcmdzWzBdKTsKICAgICAgfSBlbHNlIGlmKGJhY2tncm91bmRfaW1hZ2UubWV0aG9kLm1hdGNoKC9cLT9ncmFkaWVudCQvKSkgewogICAgICAgIGlmKGJvdW5kcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoZWwpOwogICAgICAgIH0KICAgICAgICBsb2FkR3JhZGllbnRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlLnZhbHVlLCBib3VuZHMpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEltYWdlcyAoZWwpIHsKICAgIHZhciBlbE5vZGVUeXBlID0gZmFsc2U7CgogICAgLy8gRmlyZWZveCBmYWlscyB3aXRoIHBlcm1pc3Npb24gZGVuaWVkIG9uIHBhZ2VzIHdpdGggaWZyYW1lcwogICAgdHJ5IHsKICAgICAgVXRpbC5DaGlsZHJlbihlbCkuZm9yRWFjaChnZXRJbWFnZXMpOwogICAgfQogICAgY2F0Y2goIGUgKSB7fQoKICAgIHRyeSB7CiAgICAgIGVsTm9kZVR5cGUgPSBlbC5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsKICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gYWNjZXNzIHNvbWUgZWxlbWVudCdzIG5vZGVUeXBlIC0gRXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICB9CgogICAgaWYgKGVsTm9kZVR5cGUgPT09IDEgfHwgZWxOb2RlVHlwZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxvYWRQc2V1ZG9FbGVtZW50SW1hZ2VzKGVsKTsKICAgICAgdHJ5IHsKICAgICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhVdGlsLmdldENTUyhlbCwgJ2JhY2tncm91bmRJbWFnZScpLCBlbCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGdldCBiYWNrZ3JvdW5kLWltYWdlIC0gRXhjZXB0aW9uOiAiICsgZS5tZXNzYWdlKTsKICAgICAgfQogICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7CiAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICggaW1hZ2VPYmoudGltZXIgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZAogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gdHJ1ZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoaW1nLmNyb3NzT3JpZ2luID09PSAiYW5vbnltb3VzIikgewogICAgICAgIC8vIENPUlMgZmFpbGVkCiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKCiAgICAgICAgLy8gbGV0J3MgdHJ5IHdpdGggcHJveHkgaW5zdGVhZAogICAgICAgIGlmICggb3B0aW9ucy5wcm94eSApIHsKICAgICAgICAgIHZhciBzcmMgPSBpbWcuc3JjOwogICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBpbWFnZU9iai5pbWcgPSBpbWc7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwoKICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIGltZy5zcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgfQoKICBtZXRob2RzID0gewogICAgbG9hZEltYWdlOiBmdW5jdGlvbiggc3JjICkgewogICAgICB2YXIgaW1nLCBpbWFnZU9iajsKICAgICAgaWYgKCBzcmMgJiYgaW1hZ2VzW3NyY10gPT09IHVuZGVmaW5lZCApIHsKICAgICAgICBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsKICAgICAgICAgIGltZy5zcmMgPSBzcmMucmVwbGFjZSgvdXJsXChbJyJdezAsfXxbJyJdezAsfVwpJC9pZywgJycpOwogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgIH0gZWxzZSBpZiAoIGlzU2FtZU9yaWdpbiggc3JjICkgfHwgb3B0aW9ucy5hbGxvd1RhaW50ID09PSAgdHJ1ZSApIHsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgfSBlbHNlIGlmICggc3VwcG9ydENPUlMgJiYgIW9wdGlvbnMuYWxsb3dUYWludCAmJiBvcHRpb25zLnVzZUNPUlMgKSB7CiAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTCgogICAgICAgICAgaW1nLmNyb3NzT3JpZ2luID0gImFub255bW91cyI7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwogICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgcHJveHlHZXRJbWFnZSggc3JjLCBpbWcsIGltYWdlT2JqICk7CiAgICAgICAgfQogICAgICB9CgogICAgfSwKICAgIGNsZWFudXBET006IGZ1bmN0aW9uKGNhdXNlKSB7CiAgICAgIHZhciBpbWcsIHNyYzsKICAgICAgaWYgKCFpbWFnZXMuY2xlYW51cERvbmUpIHsKICAgICAgICBpZiAoY2F1c2UgJiYgdHlwZW9mIGNhdXNlID09PSAic3RyaW5nIikgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGJlY2F1c2U6ICIgKyBjYXVzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBhZnRlciB0aW1lb3V0OiAiICsgb3B0aW9ucy50aW1lb3V0ICsgIiBtcy4iKTsKICAgICAgICB9CgogICAgICAgIGZvciAoc3JjIGluIGltYWdlcykgewogICAgICAgICAgaWYgKGltYWdlcy5oYXNPd25Qcm9wZXJ0eShzcmMpKSB7CiAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLyBjYW5jZWwgcHJveHkgaW1hZ2UgcmVxdWVzdAogICAgICAgICAgICAgIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpCiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV07ICAvLyBmb3IgYWxsIGJyb3dzZXIgdGhhdCBzdXBwb3J0IHRoaXMKICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICAgIGlmIChpbWcuc2NyaXB0ICYmIGltZy5zY3JpcHQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsICJhYm91dDpibGFuayIpOyAgLy8gdHJ5IHRvIGNhbmNlbCBydW5uaW5nIHJlcXVlc3QKICAgICAgICAgICAgICAgIGltZy5zY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpbWcuc2NyaXB0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFuZWQgdXAgZmFpbGVkIGltZzogJyIgKyBzcmMgKyAiJyBTdGVwczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cwogICAgICAgIGlmKHdpbmRvdy5zdG9wICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHdpbmRvdy5zdG9wKCk7CiAgICAgICAgfSBlbHNlIGlmKGRvY3VtZW50LmV4ZWNDb21tYW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoZG9jdW1lbnQuY2xvc2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZG9jdW1lbnQuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsKICAgICAgICBpZiAoIShjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgc3RhcnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgIH0KICAgIH0KICB9OwoKICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgewogICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOwogIH0KCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkIHN0YXJ0czogZmluZGluZyBiYWNrZ3JvdW5kLWltYWdlcycpOwogIGltYWdlcy5maXJzdFJ1biA9IHRydWU7CgogIGdldEltYWdlcyhlbGVtZW50KTsKCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBGaW5kaW5nIGltYWdlcycpOwogIC8vIGxvYWQgPGltZz4gaW1hZ2VzCiAgZm9yIChpID0gMDsgaSA8IGltZ0xlbjsgaSs9MSl7CiAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOwogIH0KCiAgaW1hZ2VzLmZpcnN0UnVuID0gZmFsc2U7CiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBEb25lLicpOwogIGlmIChpbWFnZXMubnVtVG90YWwgPT09IGltYWdlcy5udW1Mb2FkZWQpIHsKICAgIHN0YXJ0KCk7CiAgfQoKICByZXR1cm4gbWV0aG9kczsKfTsKCl9odG1sMmNhbnZhcy5SZW5kZXJlciA9IGZ1bmN0aW9uKHBhcnNlUXVldWUsIG9wdGlvbnMpewogIGZ1bmN0aW9uIHNvcnRaaW5kZXgoYSwgYikgewogICAgaWYgKGEgPT09ICdjaGlsZHJlbicpIHsKICAgICAgcmV0dXJuIC0xOwogICAgfSBlbHNlIGlmIChiID09PSAnY2hpbGRyZW4nKSB7CiAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGEgLSBiOwogICAgfQogIH0KCiAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvemluZGV4Lmh0bWwKICBmdW5jdGlvbiBjcmVhdGVSZW5kZXJRdWV1ZShwYXJzZVF1ZXVlKSB7CiAgICB2YXIgcXVldWUgPSBbXSwKICAgIHJvb3RDb250ZXh0OwoKICAgIHJvb3RDb250ZXh0ID0gKGZ1bmN0aW9uIGJ1aWxkU3RhY2tpbmdDb250ZXh0KHJvb3ROb2RlKSB7CiAgICAgIHZhciByb290Q29udGV4dCA9IHt9OwogICAgICBmdW5jdGlvbiBpbnNlcnQoY29udGV4dCwgbm9kZSwgc3BlY2lhbFBhcmVudCkgewogICAgICAgIHZhciB6aSA9IChub2RlLnpJbmRleC56aW5kZXggPT09ICdhdXRvJykgPyAwIDogTnVtYmVyKG5vZGUuekluZGV4LnppbmRleCksCiAgICAgICAgY29udGV4dEZvckNoaWxkcmVuID0gY29udGV4dCwgLy8gdGhlIHN0YWNraW5nIGNvbnRleHQgZm9yIGNoaWxkcmVuCiAgICAgICAgaXNQb3NpdGlvbmVkID0gbm9kZS56SW5kZXguaXNQb3NpdGlvbmVkLAogICAgICAgIGlzRmxvYXRlZCA9IG5vZGUuekluZGV4LmlzRmxvYXRlZCwKICAgICAgICBzdHViID0ge25vZGU6IG5vZGV9LAogICAgICAgIGNoaWxkcmVuRGVzdCA9IHNwZWNpYWxQYXJlbnQ7IC8vIHdoZXJlIGNoaWxkcmVuIHdpdGhvdXQgei1pbmRleCBzaG91bGQgYmUgcHVzaGVkIGludG8KCiAgICAgICAgaWYgKG5vZGUuekluZGV4Lm93blN0YWNraW5nKSB7CiAgICAgICAgICBjb250ZXh0Rm9yQ2hpbGRyZW4gPSBzdHViLmNvbnRleHQgPSB7CiAgICAgICAgICAgICAgY2hpbGRyZW46IFt7bm9kZTpub2RlLCBjaGlsZHJlbjogW119XQogICAgICAgICAgfTsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgaWYgKGlzUG9zaXRpb25lZCB8fCBpc0Zsb2F0ZWQpIHsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHN0dWIuY2hpbGRyZW4gPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmICh6aSA9PT0gMCAmJiBzcGVjaWFsUGFyZW50KSB7CiAgICAgICAgICBzcGVjaWFsUGFyZW50LnB1c2goc3R1Yik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghY29udGV4dFt6aV0pIHsgY29udGV4dFt6aV0gPSBbXTsgfQogICAgICAgICAgY29udGV4dFt6aV0ucHVzaChzdHViKTsKICAgICAgICB9CgogICAgICAgIG5vZGUuekluZGV4LmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGROb2RlKSB7CiAgICAgICAgICBpbnNlcnQoY29udGV4dEZvckNoaWxkcmVuLCBjaGlsZE5vZGUsIGNoaWxkcmVuRGVzdCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaW5zZXJ0KHJvb3RDb250ZXh0LCByb290Tm9kZSk7CiAgICAgIHJldHVybiByb290Q29udGV4dDsKICAgIH0pKHBhcnNlUXVldWUpOwoKICAgIGZ1bmN0aW9uIHNvcnRaKGNvbnRleHQpIHsKICAgICAgT2JqZWN0LmtleXMoY29udGV4dCkuc29ydChzb3J0WmluZGV4KS5mb3JFYWNoKGZ1bmN0aW9uKHppKSB7CiAgICAgICAgdmFyIG5vblBvc2l0aW9uZWQgPSBbXSwKICAgICAgICBmbG9hdGVkID0gW10sCiAgICAgICAgcG9zaXRpb25lZCA9IFtdLAogICAgICAgIGxpc3QgPSBbXTsKCiAgICAgICAgLy8gcG9zaXRpb25lZCBhZnRlciBzdGF0aWMKICAgICAgICBjb250ZXh0W3ppXS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIGlmICh2Lm5vZGUuekluZGV4LmlzUG9zaXRpb25lZCB8fCB2Lm5vZGUuekluZGV4Lm9wYWNpdHkgPCAxKSB7CiAgICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtY29sb3IvI3RyYW5zcGFyZW5jeQogICAgICAgICAgICAvLyBub24tcG9zaXRpb25lZCBlbGVtZW50IHdpdGggb3BhY3RpeSA8IDEgc2hvdWxkIGJlIHN0YWNrZWQgYXMgaWYgaXQgd2VyZSBhIHBvc2l0aW9uZWQgZWxlbWVudCB3aXRoIOKAmHotaW5kZXg6IDDigJkgYW5kIOKAmG9wYWNpdHk6IDHigJkuCiAgICAgICAgICAgIHBvc2l0aW9uZWQucHVzaCh2KTsKICAgICAgICAgIH0gZWxzZSBpZiAodi5ub2RlLnpJbmRleC5pc0Zsb2F0ZWQpIHsKICAgICAgICAgICAgZmxvYXRlZC5wdXNoKHYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbm9uUG9zaXRpb25lZC5wdXNoKHYpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAoZnVuY3Rpb24gd2FsayhhcnIpIHsKICAgICAgICAgIGFyci5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgbGlzdC5wdXNoKHYpOwogICAgICAgICAgICBpZiAodi5jaGlsZHJlbikgeyB3YWxrKHYuY2hpbGRyZW4pOyB9CiAgICAgICAgICB9KTsKICAgICAgICB9KShub25Qb3NpdGlvbmVkLmNvbmNhdChmbG9hdGVkLCBwb3NpdGlvbmVkKSk7CgogICAgICAgIGxpc3QuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICBpZiAodi5jb250ZXh0KSB7CiAgICAgICAgICAgIHNvcnRaKHYuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKHYubm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIHNvcnRaKHJvb3RDb250ZXh0KTsKCiAgICByZXR1cm4gcXVldWU7CiAgfQoKICBmdW5jdGlvbiBnZXRSZW5kZXJlcihyZW5kZXJlck5hbWUpIHsKICAgIHZhciByZW5kZXJlcjsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMucmVuZGVyZXIgPT09ICJzdHJpbmciICYmIF9odG1sMmNhbnZhcy5SZW5kZXJlcltyZW5kZXJlck5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmVuZGVyZXIgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXJbcmVuZGVyZXJOYW1lXShvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlbmRlcmVyTmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICByZW5kZXJlciA9IHJlbmRlcmVyTmFtZShvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByZW5kZXJlciIpOwogICAgfQoKICAgIGlmICggdHlwZW9mIHJlbmRlcmVyICE9PSAiZnVuY3Rpb24iICkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVuZGVyZXIgZGVmaW5lZCIpOwogICAgfQogICAgcmV0dXJuIHJlbmRlcmVyOwogIH0KCiAgcmV0dXJuIGdldFJlbmRlcmVyKG9wdGlvbnMucmVuZGVyZXIpKHBhcnNlUXVldWUsIG9wdGlvbnMsIGRvY3VtZW50LCBjcmVhdGVSZW5kZXJRdWV1ZShwYXJzZVF1ZXVlLnN0YWNrKSwgX2h0bWwyY2FudmFzKTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLlN1cHBvcnQgPSBmdW5jdGlvbiAob3B0aW9ucywgZG9jKSB7CgogIGZ1bmN0aW9uIHN1cHBvcnRTVkdSZW5kZXJpbmcoKSB7CiAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICBjYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksCiAgICBjdHggPSAoY2FudmFzLmdldENvbnRleHQgPT09IHVuZGVmaW5lZCkgPyBmYWxzZSA6IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgaWYgKGN0eCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY2FudmFzLndpZHRoID0gY2FudmFzLmhlaWdodCA9IDEwOwogICAgaW1nLnNyYyA9IFsKICAgICJkYXRhOmltYWdlL3N2Zyt4bWwsIiwKICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgIjxmb3JlaWduT2JqZWN0IHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwKICAgICI8ZGl2IHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyBzdHlsZT0nd2lkdGg6MTA7aGVpZ2h0OjEwOyc+IiwKICAgICJzdXAiLAogICAgIjwvZGl2PiIsCiAgICAiPC9mb3JlaWduT2JqZWN0PiIsCiAgICAiPC9zdmc+IgogICAgXS5qb2luKCIiKTsKICAgIHRyeSB7CiAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwKTsKICAgICAgY2FudmFzLnRvRGF0YVVSTCgpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIF9odG1sMmNhbnZhcy5VdGlsLmxvZygnaHRtbDJjYW52YXM6IFBhcnNlOiBTVkcgcG93ZXJlZCByZW5kZXJpbmcgYXZhaWxhYmxlJyk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vIFRlc3Qgd2hldGhlciB3ZSBjYW4gdXNlIHJhbmdlcyB0byBtZWFzdXJlIGJvdW5kaW5nIGJveGVzCiAgLy8gT3BlcmEgZG9lc24ndCBwcm92aWRlIHZhbGlkIGJvdW5kcy5oZWlnaHQvYm90dG9tIGV2ZW4gdGhvdWdoIGl0IHN1cHBvcnRzIHRoZSBtZXRob2QuCgogIGZ1bmN0aW9uIHN1cHBvcnRSYW5nZUJvdW5kcygpIHsKICAgIHZhciByLCB0ZXN0RWxlbWVudCwgcmFuZ2VCb3VuZHMsIHJhbmdlSGVpZ2h0LCBzdXBwb3J0ID0gZmFsc2U7CgogICAgaWYgKGRvYy5jcmVhdGVSYW5nZSkgewogICAgICByID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICAgIGlmIChyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgIHRlc3RFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2JvdW5kdGVzdCcpOwogICAgICAgIHRlc3RFbGVtZW50LnN0eWxlLmhlaWdodCA9ICIxMjNweCI7CiAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQodGVzdEVsZW1lbnQpOwoKICAgICAgICByLnNlbGVjdE5vZGUodGVzdEVsZW1lbnQpOwogICAgICAgIHJhbmdlQm91bmRzID0gci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICByYW5nZUhlaWdodCA9IHJhbmdlQm91bmRzLmhlaWdodDsKCiAgICAgICAgaWYgKHJhbmdlSGVpZ2h0ID09PSAxMjMpIHsKICAgICAgICAgIHN1cHBvcnQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBkb2MuYm9keS5yZW1vdmVDaGlsZCh0ZXN0RWxlbWVudCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gc3VwcG9ydDsKICB9CgogIHJldHVybiB7CiAgICByYW5nZUJvdW5kczogc3VwcG9ydFJhbmdlQm91bmRzKCksCiAgICBzdmdSZW5kZXJpbmc6IG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIHN1cHBvcnRTVkdSZW5kZXJpbmcoKQogIH07Cn07CndpbmRvdy5odG1sMmNhbnZhcyA9IGZ1bmN0aW9uKGVsZW1lbnRzLCBvcHRzKSB7CiAgZWxlbWVudHMgPSAoZWxlbWVudHMubGVuZ3RoKSA/IGVsZW1lbnRzIDogW2VsZW1lbnRzXTsKICB2YXIgcXVldWUsCiAgY2FudmFzLAogIG9wdGlvbnMgPSB7CiAgICAvLyBnZW5lcmFsCiAgICBsb2dnaW5nOiBmYWxzZSwKICAgIGVsZW1lbnRzOiBlbGVtZW50cywKICAgIGJhY2tncm91bmQ6ICIjZmZmIiwKCiAgICAvLyBwcmVsb2FkIG9wdGlvbnMKICAgIHByb3h5OiBudWxsLAogICAgdGltZW91dDogMCwgICAgLy8gbm8gdGltZW91dAogICAgdXNlQ09SUzogZmFsc2UsIC8vIHRyeSB0byBsb2FkIGltYWdlcyBhcyBDT1JTICh3aGVyZSBhdmFpbGFibGUpLCBiZWZvcmUgZmFsbGluZyBiYWNrIHRvIHByb3h5CiAgICBhbGxvd1RhaW50OiBmYWxzZSwgLy8gd2hldGhlciB0byBhbGxvdyBpbWFnZXMgdG8gdGFpbnQgdGhlIGNhbnZhcywgd29uJ3QgbmVlZCBwcm94eSBpZiBzZXQgdG8gdHJ1ZQoKICAgIC8vIHBhcnNlIG9wdGlvbnMKICAgIHN2Z1JlbmRlcmluZzogZmFsc2UsIC8vIHVzZSBzdmcgcG93ZXJlZCByZW5kZXJpbmcgd2hlcmUgYXZhaWxhYmxlIChGRjExKykKICAgIGlnbm9yZUVsZW1lbnRzOiAiSUZSQU1FfE9CSkVDVHxQQVJBTSIsCiAgICB1c2VPdmVyZmxvdzogdHJ1ZSwKICAgIGxldHRlclJlbmRlcmluZzogZmFsc2UsCiAgICBjaGluZXNlOiBmYWxzZSwKICAgIGFzeW5jOiBmYWxzZSwgLy8gSWYgdHJ1ZSwgcGFyc2luZyB3aWxsIG5vdCBibG9jaywgYnV0IGlmIHRoZSB1c2VyIHNjcm9sbHMgZHVyaW5nIHBhcnNlIHRoZSBpbWFnZSBjYW4gZ2V0IHdlaXJkCgogICAgLy8gcmVuZGVyIG9wdGlvbnMKICAgIHdpZHRoOiBudWxsLAogICAgaGVpZ2h0OiBudWxsLAogICAgdGFpbnRUZXN0OiB0cnVlLCAvLyBkbyBhIHRhaW50IHRlc3Qgd2l0aCBhbGwgaW1hZ2VzIGJlZm9yZSBhcHBseWluZyB0byBjYW52YXMKICAgIHJlbmRlcmVyOiAiQ2FudmFzIgogIH07CgogIG9wdGlvbnMgPSBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucyk7CgogIF9odG1sMmNhbnZhcy5sb2dnaW5nID0gb3B0aW9ucy5sb2dnaW5nOwogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbiggaW1hZ2VzICkgewoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnByZWxvYWRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIG9wdGlvbnMub25wcmVsb2FkZWQoIGltYWdlcyApID09PSBmYWxzZSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zLCBmdW5jdGlvbihxdWV1ZSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25wYXJzZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY2FudmFzID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgb3B0aW9ucyApOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucmVuZGVyZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBvcHRpb25zLm9ucmVuZGVyZWQoIGNhbnZhcyApOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvLyBmb3IgcGFnZXMgd2l0aG91dCBpbWFnZXMsIHdlIHN0aWxsIHdhbnQgdGhpcyB0byBiZSBhc3luYywgaS5lLiByZXR1cm4gbWV0aG9kcyBiZWZvcmUgZXhlY3V0aW5nCiAgd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CiAgICBfaHRtbDJjYW52YXMuUHJlbG9hZCggb3B0aW9ucyApOwogIH0sIDAgKTsKCiAgcmV0dXJuIHsKICAgIHJlbmRlcjogZnVuY3Rpb24oIHF1ZXVlLCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcHJlbG9hZDogZnVuY3Rpb24oIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUHJlbG9hZCggX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgbG9nOiBfaHRtbDJjYW52YXMuVXRpbC5sb2cKICB9Owp9OwoKd2luZG93Lmh0bWwyY2FudmFzLmxvZyA9IF9odG1sMmNhbnZhcy5VdGlsLmxvZzsgLy8gZm9yIHJlbmRlcmVycwp3aW5kb3cuaHRtbDJjYW52YXMuUmVuZGVyZXIgPSB7CiAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkCn07Cl9odG1sMmNhbnZhcy5SZW5kZXJlci5DYW52YXMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHZhciBkb2MgPSBkb2N1bWVudCwKICBzYWZlSW1hZ2VzID0gW10sCiAgdGVzdENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIGNhbnZhcyA9IG9wdGlvbnMuY2FudmFzIHx8IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKCiAgZnVuY3Rpb24gY3JlYXRlU2hhcGUoY3R4LCBhcmdzKSB7CiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKSB7CiAgICAgIGN0eFthcmcubmFtZV0uYXBwbHkoY3R4LCBhcmdbJ2FyZ3VtZW50cyddKTsKICAgIH0pOwogICAgY3R4LmNsb3NlUGF0aCgpOwogIH0KCiAgZnVuY3Rpb24gc2FmZUltYWdlKGl0ZW0pIHsKICAgIGlmIChzYWZlSW1hZ2VzLmluZGV4T2YoaXRlbVsnYXJndW1lbnRzJ11bMF0uc3JjKSA9PT0gLTEpIHsKICAgICAgdGVzdGN0eC5kcmF3SW1hZ2UoaXRlbVsnYXJndW1lbnRzJ11bMF0sIDAsIDApOwogICAgICB0cnkgewogICAgICAgIHRlc3RjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIDEsIDEpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICB0ZXN0Q2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICAgIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHNhZmVJbWFnZXMucHVzaChpdGVtWydhcmd1bWVudHMnXVswXS5zcmMpOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJJdGVtKGN0eCwgaXRlbSkgewogICAgc3dpdGNoKGl0ZW0udHlwZSl7CiAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICBjdHhbaXRlbS5uYW1lXSA9IGl0ZW1bJ2FyZ3VtZW50cyddOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgc3dpdGNoKGl0ZW0ubmFtZSkgewogICAgICAgICAgY2FzZSAiY3JlYXRlUGF0dGVybiI6CiAgICAgICAgICAgIGlmIChpdGVtWydhcmd1bWVudHMnXVswXS53aWR0aCA+IDAgJiYgaXRlbVsnYXJndW1lbnRzJ11bMF0uaGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY3R4LmNyZWF0ZVBhdHRlcm4oaXRlbVsnYXJndW1lbnRzJ11bMF0sICJyZXBlYXQiKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IEVycm9yIGNyZWF0aW5nIHBhdHRlcm4iLCBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdTaGFwZSI6CiAgICAgICAgICAgIGNyZWF0ZVNoYXBlKGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdJbWFnZSI6CiAgICAgICAgICAgIGlmIChpdGVtWydhcmd1bWVudHMnXVs4XSA+IDAgJiYgaXRlbVsnYXJndW1lbnRzJ11bN10gPiAwKSB7CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnRhaW50VGVzdCB8fCAob3B0aW9ucy50YWludFRlc3QgJiYgc2FmZUltYWdlKGl0ZW0pKSkgewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZS5hcHBseSggY3R4LCBpdGVtWydhcmd1bWVudHMnXSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGN0eFtpdGVtLm5hbWVdLmFwcGx5KGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBmdW5jdGlvbihwYXJzZWREYXRhLCBvcHRpb25zLCBkb2N1bWVudCwgcXVldWUsIF9odG1sMmNhbnZhcykgewogICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpLAogICAgbmV3Q2FudmFzLAogICAgYm91bmRzLAogICAgZnN0eWxlLAogICAgelN0YWNrID0gcGFyc2VkRGF0YS5zdGFjazsKCiAgICBjYW52YXMud2lkdGggPSBjYW52YXMuc3R5bGUud2lkdGggPSAgb3B0aW9ucy53aWR0aCB8fCB6U3RhY2suY3R4LndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCB6U3RhY2suY3R4LmhlaWdodDsKCiAgICBmc3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgY3R4LmZpbGxTdHlsZSA9IChVdGlsLmlzVHJhbnNwYXJlbnQocGFyc2VkRGF0YS5iYWNrZ3JvdW5kQ29sb3IpICYmIG9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdW5kZWZpbmVkKSA/IG9wdGlvbnMuYmFja2dyb3VuZCA6IHBhcnNlZERhdGEuYmFja2dyb3VuZENvbG9yOwogICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBjdHguZmlsbFN0eWxlID0gZnN0eWxlOwogICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihzdG9yYWdlQ29udGV4dCkgewogICAgICAvLyBzZXQgY29tbW9uIHNldHRpbmdzIGZvciBjYW52YXMKICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwogICAgICBjdHguc2F2ZSgpOwoKICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5tYXRyaXgpIHsKICAgICAgICBjdHgudHJhbnNsYXRlKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMF0sIHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMV0pOwogICAgICAgIGN0eC50cmFuc2Zvcm0uYXBwbHkoY3R4LCBzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ubWF0cml4KTsKICAgICAgICBjdHgudHJhbnNsYXRlKC1zdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzBdLCAtc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblsxXSk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4LnJlY3Qoc3RvcmFnZUNvbnRleHQuY2xpcC5sZWZ0LCBzdG9yYWdlQ29udGV4dC5jbGlwLnRvcCwgc3RvcmFnZUNvbnRleHQuY2xpcC53aWR0aCwgc3RvcmFnZUNvbnRleHQuY2xpcC5oZWlnaHQpOwogICAgICAgIGN0eC5jbGlwKCk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZSkgewogICAgICAgIHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmVuZGVySXRlbShjdHgsIGl0ZW0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CgogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FudmFzIHJlbmRlcmVyIGRvbmUgLSByZXR1cm5pbmcgY2FudmFzIG9iaiIpOwoKICAgIGlmIChvcHRpb25zLmVsZW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbMF0gPT09ICJvYmplY3QiICYmIG9wdGlvbnMuZWxlbWVudHNbMF0ubm9kZU5hbWUgIT09ICJCT0RZIikgewogICAgICAgIC8vIGNyb3AgaW1hZ2UgdG8gdGhlIGJvdW5kcyBvZiBzZWxlY3RlZCAoc2luZ2xlKSBlbGVtZW50CiAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKG9wdGlvbnMuZWxlbWVudHNbMF0pOwogICAgICAgIG5ld0NhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIG5ld0NhbnZhcy53aWR0aCA9IE1hdGguY2VpbChib3VuZHMud2lkdGgpOwogICAgICAgIG5ld0NhbnZhcy5oZWlnaHQgPSBNYXRoLmNlaWwoYm91bmRzLmhlaWdodCk7CiAgICAgICAgY3R4ID0gbmV3Q2FudmFzLmdldENvbnRleHQoIjJkIik7CgogICAgICAgIGN0eC5kcmF3SW1hZ2UoY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGNhbnZhcyA9IG51bGw7CiAgICAgICAgcmV0dXJuIG5ld0NhbnZhczsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjYW52YXM7CiAgfTsKfTsKfSkod2luZG93LGRvY3VtZW50KTsK",
                "body": "LyoKICBodG1sMmNhbnZhcyAwLjQuMSA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMyBOaWtsYXMgdm9uIEhlcnR6ZW4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKKi8KCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpewoKInVzZSBzdHJpY3QiOwoKdmFyIF9odG1sMmNhbnZhcyA9IHt9LApwcmV2aW91c0VsZW1lbnQsCmNvbXB1dGVkQ1NTLApodG1sMmNhbnZhczsKCl9odG1sMmNhbnZhcy5VdGlsID0ge307CgpfaHRtbDJjYW52YXMuVXRpbC5sb2cgPSBmdW5jdGlvbihhKSB7CiAgaWYgKF9odG1sMmNhbnZhcy5sb2dnaW5nICYmIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLmxvZykgewogICAgd2luZG93LmNvbnNvbGUubG9nKGEpOwogIH0KfTsKCl9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0ID0gKGZ1bmN0aW9uKGlzTmF0aXZlKXsKICByZXR1cm4gZnVuY3Rpb24oaW5wdXQpIHsKICAgIHJldHVybiBpc05hdGl2ZSA/IGlzTmF0aXZlLmFwcGx5KGlucHV0KSA6ICgoaW5wdXQgfHwgJycpICsgJycpLnJlcGxhY2UoIC9eXHMrfFxzKyQvZyAsICcnICk7CiAgfTsKfSkoU3RyaW5nLnByb3RvdHlwZS50cmltKTsKCl9odG1sMmNhbnZhcy5VdGlsLmFzRmxvYXQgPSBmdW5jdGlvbih2KSB7CiAgcmV0dXJuIHBhcnNlRmxvYXQodik7Cn07CgooZnVuY3Rpb24oKSB7CiAgLy8gVE9ETzogc3VwcG9ydCBhbGwgcG9zc2libGUgbGVuZ3RoIHZhbHVlcwogIHZhciBURVhUX1NIQURPV19QUk9QRVJUWSA9IC8oKHJnYmF8cmdiKVwoW15cKV0rXCkoXHMtP1xkK3B4KXswLH0pL2c7CiAgdmFyIFRFWFRfU0hBRE9XX1ZBTFVFUyA9IC8oLT9cZCtweCl8KCMuKyl8KHJnYlwoLitcKSl8KHJnYmFcKC4rXCkpL2c7CiAgX2h0bWwyY2FudmFzLlV0aWwucGFyc2VUZXh0U2hhZG93cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKCF2YWx1ZSB8fCB2YWx1ZSA9PT0gJ25vbmUnKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgICAvLyBmaW5kIG11bHRpcGxlIHNoYWRvdyBkZWNsYXJhdGlvbnMKICAgIHZhciBzaGFkb3dzID0gdmFsdWUubWF0Y2goVEVYVF9TSEFET1dfUFJPUEVSVFkpLAogICAgICByZXN1bHRzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgc2hhZG93cyAmJiAoaSA8IHNoYWRvd3MubGVuZ3RoKTsgaSsrKSB7CiAgICAgIHZhciBzID0gc2hhZG93c1tpXS5tYXRjaChURVhUX1NIQURPV19WQUxVRVMpOwogICAgICByZXN1bHRzLnB1c2goewogICAgICAgIGNvbG9yOiBzWzBdLAogICAgICAgIG9mZnNldFg6IHNbMV0gPyBzWzFdLnJlcGxhY2UoJ3B4JywgJycpIDogMCwKICAgICAgICBvZmZzZXRZOiBzWzJdID8gc1syXS5yZXBsYWNlKCdweCcsICcnKSA6IDAsCiAgICAgICAgYmx1cjogc1szXSA/IHNbM10ucmVwbGFjZSgncHgnLCAnJykgOiAwCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKfSkoKTsKCl9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICB2YXIgd2hpdGVzcGFjZSA9ICcgXHJcblx0JywKICAgICAgICBtZXRob2QsIGRlZmluaXRpb24sIHByZWZpeCwgcHJlZml4X2ksIGJsb2NrLCByZXN1bHRzID0gW10sCiAgICAgICAgYywgbW9kZSA9IDAsIG51bVBhcmVuID0gMCwgcXVvdGUsIGFyZ3M7CgogICAgdmFyIGFwcGVuZFJlc3VsdCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYobWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGRlZmluaXRpb24uc3Vic3RyKCAwLCAxICkgPT09ICciJykgewogICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uc3Vic3RyKCAxLCBkZWZpbml0aW9uLmxlbmd0aCAtIDIgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZGVmaW5pdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobWV0aG9kLnN1YnN0ciggMCwgMSApID09PSAnLScgJiYKICAgICAgICAgICAgICAgICAgICAocHJlZml4X2kgPSBtZXRob2QuaW5kZXhPZiggJy0nLCAxICkgKyAxKSA+IDApIHsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1ldGhvZC5zdWJzdHIoIDAsIHByZWZpeF9pKTsKICAgICAgICAgICAgICAgIG1ldGhvZCA9IG1ldGhvZC5zdWJzdHIoIHByZWZpeF9pICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICAgICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jaywKICAgICAgICAgICAgICAgIGFyZ3M6IGFyZ3MKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGFyZ3MgPSBbXTsgLy9mb3Igc29tZSBvZGQgcmVhc29uLCBzZXR0aW5nIC5sZW5ndGggPSAwIGRpZG4ndCB3b3JrIGluIHNhZmFyaQogICAgICAgIG1ldGhvZCA9CiAgICAgICAgICAgIHByZWZpeCA9CiAgICAgICAgICAgIGRlZmluaXRpb24gPQogICAgICAgICAgICBibG9jayA9ICcnOwogICAgfTsKCiAgICBhcHBlbmRSZXN1bHQoKTsKICAgIGZvcih2YXIgaSA9IDAsIGlpID0gdmFsdWUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICBjID0gdmFsdWVbaV07CiAgICAgICAgaWYobW9kZSA9PT0gMCAmJiB3aGl0ZXNwYWNlLmluZGV4T2YoIGMgKSA+IC0xKXsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHN3aXRjaChjKSB7CiAgICAgICAgICAgIGNhc2UgJyInOgogICAgICAgICAgICAgICAgaWYoIXF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgcXVvdGUgPSBjOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZihxdW90ZSA9PT0gYykgewogICAgICAgICAgICAgICAgICAgIHF1b3RlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnKCc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbnVtUGFyZW4rKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnKSc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYobnVtUGFyZW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZFJlc3VsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBudW1QYXJlbi0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnLCc6CiAgICAgICAgICAgICAgICBpZihxdW90ZSkgeyBicmVhazsgfQogICAgICAgICAgICAgICAgZWxzZSBpZihtb2RlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kUmVzdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChtb2RlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYobnVtUGFyZW4gPT09IDAgJiYgIW1ldGhvZC5tYXRjaCgvXnVybCQvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICBpZihtb2RlID09PSAwKSB7IG1ldGhvZCArPSBjOyB9CiAgICAgICAgZWxzZSB7IGRlZmluaXRpb24gKz0gYzsgfQogICAgfQogICAgYXBwZW5kUmVzdWx0KCk7CgogICAgcmV0dXJuIHJlc3VsdHM7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogIHZhciBjbGllbnRSZWN0LCBib3VuZHMgPSB7fTsKCiAgaWYgKGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KXsKICAgIGNsaWVudFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgIC8vIFRPRE8gYWRkIHNjcm9sbCBwb3NpdGlvbiB0byBib3VuZHMsIHNvIG5vIHNjcm9sbGluZyBvZiB3aW5kb3cgbmVjZXNzYXJ5CiAgICBib3VuZHMudG9wID0gY2xpZW50UmVjdC50b3A7CiAgICBib3VuZHMuYm90dG9tID0gY2xpZW50UmVjdC5ib3R0b20gfHwgKGNsaWVudFJlY3QudG9wICsgY2xpZW50UmVjdC5oZWlnaHQpOwogICAgYm91bmRzLmxlZnQgPSBjbGllbnRSZWN0LmxlZnQ7CgogICAgYm91bmRzLndpZHRoID0gZWxlbWVudC5vZmZzZXRXaWR0aDsKICAgIGJvdW5kcy5oZWlnaHQgPSBlbGVtZW50Lm9mZnNldEhlaWdodDsKICB9CgogIHJldHVybiBib3VuZHM7Cn07CgovLyBUT0RPIGlkZWFsbHksIHdlJ2Qgd2FudCBldmVyeXRoaW5nIHRvIGdvIHRocm91Z2ggdGhpcyBmdW5jdGlvbiBpbnN0ZWFkIG9mIFV0aWwuQm91bmRzLAovLyBidXQgd291bGQgcmVxdWlyZSBmdXJ0aGVyIHdvcmsgdG8gY2FsY3VsYXRlIHRoZSBjb3JyZWN0IHBvc2l0aW9ucyBmb3IgZWxlbWVudHMgd2l0aCBvZmZzZXRQYXJlbnRzCl9odG1sMmNhbnZhcy5VdGlsLk9mZnNldEJvdW5kcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgdmFyIHBhcmVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50ID8gX2h0bWwyY2FudmFzLlV0aWwuT2Zmc2V0Qm91bmRzKGVsZW1lbnQub2Zmc2V0UGFyZW50KSA6IHt0b3A6IDAsIGxlZnQ6IDB9OwoKICByZXR1cm4gewogICAgdG9wOiBlbGVtZW50Lm9mZnNldFRvcCArIHBhcmVudC50b3AsCiAgICBib3R0b206IGVsZW1lbnQub2Zmc2V0VG9wICsgZWxlbWVudC5vZmZzZXRIZWlnaHQgKyBwYXJlbnQudG9wLAogICAgbGVmdDogZWxlbWVudC5vZmZzZXRMZWZ0ICsgcGFyZW50LmxlZnQsCiAgICB3aWR0aDogZWxlbWVudC5vZmZzZXRXaWR0aCwKICAgIGhlaWdodDogZWxlbWVudC5vZmZzZXRIZWlnaHQKICB9Owp9OwoKZnVuY3Rpb24gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUsIHZhbHVlICkgewogICAgdmFyIHJzTGVmdCA9IGVsZW1lbnQucnVudGltZVN0eWxlICYmIGVsZW1lbnQucnVudGltZVN0eWxlW2F0dHJpYnV0ZV0sCiAgICAgICAgbGVmdCwKICAgICAgICBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7CgogICAgLy8gQ2hlY2sgaWYgd2UgYXJlIG5vdCBkZWFsaW5nIHdpdGggcGl4ZWxzLCAoT3BlcmEgaGFzIGlzc3VlcyB3aXRoIHRoaXMpCiAgICAvLyBQb3J0ZWQgZnJvbSBqUXVlcnkgY3NzLmpzCiAgICAvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCiAgICAvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgogICAgLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyCiAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKCiAgICBpZiAoICEvXi0/WzAtOV0rXC4/WzAtOV0qKD86cHgpPyQvaS50ZXN0KCB2YWx1ZSApICYmIC9eLT9cZC8udGVzdCh2YWx1ZSkgKSB7CiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIGxlZnQgPSBzdHlsZS5sZWZ0OwoKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICBlbGVtZW50LnJ1bnRpbWVTdHlsZS5sZWZ0ID0gZWxlbWVudC5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgICB9CiAgICAgICAgc3R5bGUubGVmdCA9IGF0dHJpYnV0ZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogKHZhbHVlIHx8IDApOwogICAgICAgIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0OwogICAgICAgIGlmIChyc0xlZnQpIHsKICAgICAgICAgICAgZWxlbWVudC5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKICAgICAgICB9CiAgICB9CgogICAgaWYgKCEvXih0aGlufG1lZGl1bXx0aGljaykkL2kudGVzdCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChwYXJzZUZsb2F0KHZhbHVlKSkgKyAicHgiOwogICAgfQoKICAgIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gYXNJbnQodmFsKSB7CiAgICByZXR1cm4gcGFyc2VJbnQodmFsLCAxMCk7Cn0KCmZ1bmN0aW9uIGlzUGVyY2VudGFnZSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZS50b1N0cmluZygpLmluZGV4T2YoIiUiKSAhPT0gLTE7Cn0KCmZ1bmN0aW9uIHBhcnNlQmFja2dyb3VuZFNpemVQb3NpdGlvbih2YWx1ZSwgZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCkgewogICAgdmFsdWUgPSAodmFsdWUgfHwgJycpLnNwbGl0KCcsJyk7CiAgICB2YWx1ZSA9IHZhbHVlW2luZGV4IHx8IDBdIHx8IHZhbHVlWzBdIHx8ICdhdXRvJzsKICAgIHZhbHVlID0gX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQodmFsdWUpLnNwbGl0KCcgJyk7CiAgICBpZihhdHRyaWJ1dGUgPT09ICdiYWNrZ3JvdW5kU2l6ZScgJiYgKHZhbHVlWzBdICYmIHZhbHVlWzBdLm1hdGNoKC9eKGNvdmVyfGNvbnRhaW58YXV0bykkLykpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZVswXSA9ICh2YWx1ZVswXS5pbmRleE9mKCAiJSIgKSA9PT0gLTEpID8gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUgKyAiWCIsIHZhbHVlWzBdKSA6IHZhbHVlWzBdOwogICAgICAgIGlmKHZhbHVlWzFdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYoYXR0cmlidXRlID09PSAnYmFja2dyb3VuZFNpemUnKSB7CiAgICAgICAgICAgICAgICB2YWx1ZVsxXSA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIElFIDkgZG9lc24ndCByZXR1cm4gZG91YmxlIGRpZ2l0IGFsd2F5cwogICAgICAgICAgICAgICAgdmFsdWVbMV0gPSB2YWx1ZVswXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YWx1ZVsxXSA9ICh2YWx1ZVsxXS5pbmRleE9mKCIlIikgPT09IC0xKSA/IHRvUFgoZWxlbWVudCwgYXR0cmlidXRlICsgIlkiLCB2YWx1ZVsxXSkgOiB2YWx1ZVsxXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKfQoKX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTID0gZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIGlmIChwcmV2aW91c0VsZW1lbnQgIT09IGVsZW1lbnQpIHsKICAgICAgY29tcHV0ZWRDU1MgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsIG51bGwpOwogICAgfQoKICAgIHZhciB2YWx1ZSA9IGNvbXB1dGVkQ1NTW2F0dHJpYnV0ZV07CgogICAgaWYgKC9eYmFja2dyb3VuZChTaXplfFBvc2l0aW9uKSQvLnRlc3QoYXR0cmlidXRlKSkgewogICAgICAgIHJldHVybiBwYXJzZUJhY2tncm91bmRTaXplUG9zaXRpb24odmFsdWUsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpOwogICAgfSBlbHNlIGlmICgvYm9yZGVyKFRvcHxCb3R0b20pKExlZnR8UmlnaHQpUmFkaXVzLy50ZXN0KGF0dHJpYnV0ZSkpIHsKICAgICAgdmFyIGFyciA9IHZhbHVlLnNwbGl0KCIgIik7CiAgICAgIGlmIChhcnIubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgIGFyclsxXSA9IGFyclswXTsKICAgICAgfQogICAgICByZXR1cm4gYXJyLm1hcChhc0ludCk7CiAgICB9CgogIHJldHVybiB2YWx1ZTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLnJlc2l6ZUJvdW5kcyA9IGZ1bmN0aW9uKCBjdXJyZW50X3dpZHRoLCBjdXJyZW50X2hlaWdodCwgdGFyZ2V0X3dpZHRoLCB0YXJnZXRfaGVpZ2h0LCBzdHJldGNoX21vZGUgKXsKICB2YXIgdGFyZ2V0X3JhdGlvID0gdGFyZ2V0X3dpZHRoIC8gdGFyZ2V0X2hlaWdodCwKICAgIGN1cnJlbnRfcmF0aW8gPSBjdXJyZW50X3dpZHRoIC8gY3VycmVudF9oZWlnaHQsCiAgICBvdXRwdXRfd2lkdGgsIG91dHB1dF9oZWlnaHQ7CgogIGlmKCFzdHJldGNoX21vZGUgfHwgc3RyZXRjaF9tb2RlID09PSAnYXV0bycpIHsKICAgIG91dHB1dF93aWR0aCA9IHRhcmdldF93aWR0aDsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfaGVpZ2h0OwogIH0gZWxzZSBpZih0YXJnZXRfcmF0aW8gPCBjdXJyZW50X3JhdGlvIF4gc3RyZXRjaF9tb2RlID09PSAnY29udGFpbicpIHsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfaGVpZ2h0OwogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X2hlaWdodCAqIGN1cnJlbnRfcmF0aW87CiAgfSBlbHNlIHsKICAgIG91dHB1dF93aWR0aCA9IHRhcmdldF93aWR0aDsKICAgIG91dHB1dF9oZWlnaHQgPSB0YXJnZXRfd2lkdGggLyBjdXJyZW50X3JhdGlvOwogIH0KCiAgcmV0dXJuIHsKICAgIHdpZHRoOiBvdXRwdXRfd2lkdGgsCiAgICBoZWlnaHQ6IG91dHB1dF9oZWlnaHQKICB9Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uID0gZnVuY3Rpb24oZWxlbWVudCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCwgYmFja2dyb3VuZFNpemUgKSB7CiAgICB2YXIgYmFja2dyb3VuZFBvc2l0aW9uID0gIF9odG1sMmNhbnZhcy5VdGlsLmdldENTUyhlbGVtZW50LCAnYmFja2dyb3VuZFBvc2l0aW9uJywgaW1hZ2VJbmRleCksCiAgICAgICAgbGVmdFBvc2l0aW9uLAogICAgICAgIHRvcFBvc2l0aW9uOwogICAgaWYgKGJhY2tncm91bmRQb3NpdGlvbi5sZW5ndGggPT09IDEpewogICAgICAgIGJhY2tncm91bmRQb3NpdGlvbiA9IFtiYWNrZ3JvdW5kUG9zaXRpb25bMF0sIGJhY2tncm91bmRQb3NpdGlvblswXV07CiAgICB9CgogICAgaWYgKGlzUGVyY2VudGFnZShiYWNrZ3JvdW5kUG9zaXRpb25bMF0pKXsKICAgICAgICBsZWZ0UG9zaXRpb24gPSAoYm91bmRzLndpZHRoIC0gKGJhY2tncm91bmRTaXplIHx8IGltYWdlKS53aWR0aCkgKiAocGFyc2VGbG9hdChiYWNrZ3JvdW5kUG9zaXRpb25bMF0pIC8gMTAwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgbGVmdFBvc2l0aW9uID0gcGFyc2VJbnQoYmFja2dyb3VuZFBvc2l0aW9uWzBdLCAxMCk7CiAgICB9CgogICAgaWYgKGJhY2tncm91bmRQb3NpdGlvblsxXSA9PT0gJ2F1dG8nKSB7CiAgICAgICAgdG9wUG9zaXRpb24gPSBsZWZ0UG9zaXRpb24gLyBpbWFnZS53aWR0aCAqIGltYWdlLmhlaWdodDsKICAgIH0gZWxzZSBpZiAoaXNQZXJjZW50YWdlKGJhY2tncm91bmRQb3NpdGlvblsxXSkpewogICAgICAgIHRvcFBvc2l0aW9uID0gIChib3VuZHMuaGVpZ2h0IC0gKGJhY2tncm91bmRTaXplIHx8IGltYWdlKS5oZWlnaHQpICogcGFyc2VGbG9hdChiYWNrZ3JvdW5kUG9zaXRpb25bMV0pIC8gMTAwOwogICAgfSBlbHNlIHsKICAgICAgICB0b3BQb3NpdGlvbiA9IHBhcnNlSW50KGJhY2tncm91bmRQb3NpdGlvblsxXSwgMTApOwogICAgfQoKICAgIGlmIChiYWNrZ3JvdW5kUG9zaXRpb25bMF0gPT09ICdhdXRvJykgewogICAgICAgIGxlZnRQb3NpdGlvbiA9IHRvcFBvc2l0aW9uIC8gaW1hZ2UuaGVpZ2h0ICogaW1hZ2Uud2lkdGg7CiAgICB9CgogICAgcmV0dXJuIHtsZWZ0OiBsZWZ0UG9zaXRpb24sIHRvcDogdG9wUG9zaXRpb259Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFNpemUgPSBmdW5jdGlvbihlbGVtZW50LCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4KSB7CiAgdmFyIGJhY2tncm91bmRTaXplID0gIF9odG1sMmNhbnZhcy5VdGlsLmdldENTUyhlbGVtZW50LCAnYmFja2dyb3VuZFNpemUnLCBpbWFnZUluZGV4KSwgd2lkdGgsIGhlaWdodDsKCiAgaWYgKGJhY2tncm91bmRTaXplLmxlbmd0aCA9PT0gMSkgewogICAgYmFja2dyb3VuZFNpemUgPSBbYmFja2dyb3VuZFNpemVbMF0sIGJhY2tncm91bmRTaXplWzBdXTsKICB9CgogIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFNpemVbMF0pKSB7CiAgICB3aWR0aCA9IGJvdW5kcy53aWR0aCAqIHBhcnNlRmxvYXQoYmFja2dyb3VuZFNpemVbMF0pIC8gMTAwOwogIH0gZWxzZSBpZiAoL2NvbnRhaW58Y292ZXIvLnRlc3QoYmFja2dyb3VuZFNpemVbMF0pKSB7CiAgICByZXR1cm4gX2h0bWwyY2FudmFzLlV0aWwucmVzaXplQm91bmRzKGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCwgYmFja2dyb3VuZFNpemVbMF0pOwogIH0gZWxzZSB7CiAgICB3aWR0aCA9IHBhcnNlSW50KGJhY2tncm91bmRTaXplWzBdLCAxMCk7CiAgfQoKICBpZiAoYmFja2dyb3VuZFNpemVbMF0gPT09ICdhdXRvJyAmJiBiYWNrZ3JvdW5kU2l6ZVsxXSA9PT0gJ2F1dG8nKSB7CiAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgfSBlbHNlIGlmIChiYWNrZ3JvdW5kU2l6ZVsxXSA9PT0gJ2F1dG8nKSB7CiAgICBoZWlnaHQgPSB3aWR0aCAvIGltYWdlLndpZHRoICogaW1hZ2UuaGVpZ2h0OwogIH0gZWxzZSBpZiAoaXNQZXJjZW50YWdlKGJhY2tncm91bmRTaXplWzFdKSkgewogICAgaGVpZ2h0ID0gIGJvdW5kcy5oZWlnaHQgKiBwYXJzZUZsb2F0KGJhY2tncm91bmRTaXplWzFdKSAvIDEwMDsKICB9IGVsc2UgewogICAgaGVpZ2h0ID0gcGFyc2VJbnQoYmFja2dyb3VuZFNpemVbMV0sIDEwKTsKICB9CgogIGlmIChiYWNrZ3JvdW5kU2l6ZVswXSA9PT0gJ2F1dG8nKSB7CiAgICB3aWR0aCA9IGhlaWdodCAvIGltYWdlLmhlaWdodCAqIGltYWdlLndpZHRoOwogIH0KCiAgcmV0dXJuIHt3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0fTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJhY2tncm91bmRSZXBlYXQgPSBmdW5jdGlvbihlbGVtZW50LCBpbWFnZUluZGV4KSB7CiAgdmFyIGJhY2tncm91bmRSZXBlYXQgPSBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRSZXBlYXQiKS5zcGxpdCgiLCIpLm1hcChfaHRtbDJjYW52YXMuVXRpbC50cmltVGV4dCk7CiAgcmV0dXJuIGJhY2tncm91bmRSZXBlYXRbaW1hZ2VJbmRleF0gfHwgYmFja2dyb3VuZFJlcGVhdFswXTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkZWZhdWx0cykgewogIGZvciAodmFyIGtleSBpbiBvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIGRlZmF1bHRzW2tleV0gPSBvcHRpb25zW2tleV07CiAgICB9CiAgfQogIHJldHVybiBkZWZhdWx0czsKfTsKCgovKgogKiBEZXJpdmVkIGZyb20galF1ZXJ5LmNvbnRlbnRzKCkKICogQ29weXJpZ2h0IDIwMTAsIEpvaG4gUmVzaWcKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCl9odG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgdmFyIGNoaWxkcmVuOwogIHRyeSB7CiAgICBjaGlsZHJlbiA9IChlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gIklGUkFNRSIpID8gZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDogKGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgIHZhciByZXQgPSBbXTsKICAgICAgaWYgKGFycmF5ICE9PSBudWxsKSB7CiAgICAgICAgKGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQgKSB7CiAgICAgICAgICB2YXIgaSA9IGZpcnN0Lmxlbmd0aCwKICAgICAgICAgIGogPSAwOwoKICAgICAgICAgIGlmICh0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgZm9yICh2YXIgbCA9IHNlY29uZC5sZW5ndGg7IGogPCBsOyBqKyspIHsKICAgICAgICAgICAgICBmaXJzdFtpKytdID0gc2Vjb25kW2pdOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAoc2Vjb25kW2pdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBmaXJzdFtpKytdID0gc2Vjb25kW2orK107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmaXJzdC5sZW5ndGggPSBpOwoKICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9KShyZXQsIGFycmF5KTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfSkoZWxlbS5jaGlsZE5vZGVzKTsKCiAgfSBjYXRjaCAoZXgpIHsKICAgIF9odG1sMmNhbnZhcy5VdGlsLmxvZygiaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiBmYWlsZWQgd2l0aCBleGNlcHRpb246ICIgKyBleC5tZXNzYWdlKTsKICAgIGNoaWxkcmVuID0gW107CiAgfQogIHJldHVybiBjaGlsZHJlbjsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLmlzVHJhbnNwYXJlbnQgPSBmdW5jdGlvbihiYWNrZ3JvdW5kQ29sb3IpIHsKICByZXR1cm4gKCFiYWNrZ3JvdW5kQ29sb3IgfHwgYmFja2dyb3VuZENvbG9yID09PSAidHJhbnNwYXJlbnQiIHx8IGJhY2tncm91bmRDb2xvciA9PT0gInJnYmEoMCwgMCwgMCwgMCkiKTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkZvbnQgPSAoZnVuY3Rpb24gKCkgewoKICB2YXIgZm9udERhdGEgPSB7fTsKCiAgcmV0dXJuIGZ1bmN0aW9uKGZvbnQsIGZvbnRTaXplLCBkb2MpIHsKICAgIGlmIChmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV07CiAgICB9CgogICAgdmFyIGNvbnRhaW5lciA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgIGltZyA9IGRvYy5jcmVhdGVFbGVtZW50KCdpbWcnKSwKICAgIHNwYW4gPSBkb2MuY3JlYXRlRWxlbWVudCgnc3BhbicpLAogICAgc2FtcGxlVGV4dCA9ICdIaWRkZW4gVGV4dCcsCiAgICBiYXNlbGluZSwKICAgIG1pZGRsZSwKICAgIG1ldHJpY3NPYmo7CgogICAgY29udGFpbmVyLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgIGNvbnRhaW5lci5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgIGNvbnRhaW5lci5zdHlsZS5mb250U2l6ZSA9IGZvbnRTaXplOwogICAgY29udGFpbmVyLnN0eWxlLm1hcmdpbiA9IDA7CiAgICBjb250YWluZXIuc3R5bGUucGFkZGluZyA9IDA7CgogICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKCiAgICAvLyBodHRwOi8vcHJvYmFibHlwcm9ncmFtbWluZy5jb20vMjAwOS8wMy8xNS90aGUtdGluaWVzdC1naWYtZXZlciAoaGFuZHRpbnl3aGl0ZS5naWYpCiAgICBpbWcuc3JjID0gImRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaEFRQUJBSUFCQVAvLy93QUFBQ3dBQUFBQUFRQUJBQUFDQWtRQkFEcz0iOwogICAgaW1nLndpZHRoID0gMTsKICAgIGltZy5oZWlnaHQgPSAxOwoKICAgIGltZy5zdHlsZS5tYXJnaW4gPSAwOwogICAgaW1nLnN0eWxlLnBhZGRpbmcgPSAwOwogICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAiYmFzZWxpbmUiOwoKICAgIHNwYW4uc3R5bGUuZm9udEZhbWlseSA9IGZvbnQ7CiAgICBzcGFuLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7CiAgICBzcGFuLnN0eWxlLm1hcmdpbiA9IDA7CiAgICBzcGFuLnN0eWxlLnBhZGRpbmcgPSAwOwoKICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHNhbXBsZVRleHQpKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcGFuKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChpbWcpOwogICAgYmFzZWxpbmUgPSAoaW1nLm9mZnNldFRvcCAtIHNwYW4ub2Zmc2V0VG9wKSArIDE7CgogICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHNwYW4pOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShzYW1wbGVUZXh0KSk7CgogICAgY29udGFpbmVyLnN0eWxlLmxpbmVIZWlnaHQgPSAibm9ybWFsIjsKICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gInN1cGVyIjsKCiAgICBtaWRkbGUgPSAoaW1nLm9mZnNldFRvcC1jb250YWluZXIub2Zmc2V0VG9wKSArIDE7CiAgICBtZXRyaWNzT2JqID0gewogICAgICBiYXNlbGluZTogYmFzZWxpbmUsCiAgICAgIGxpbmVXaWR0aDogMSwKICAgICAgbWlkZGxlOiBtaWRkbGUKICAgIH07CgogICAgZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXSA9IG1ldHJpY3NPYmo7CgogICAgZG9jLmJvZHkucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsKCiAgICByZXR1cm4gbWV0cmljc09iajsKICB9Owp9KSgpOwoKKGZ1bmN0aW9uKCl7CiAgdmFyIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICAgIEdlbmVyYXRlID0ge307CgogIF9odG1sMmNhbnZhcy5HZW5lcmF0ZSA9IEdlbmVyYXRlOwoKICB2YXIgcmVHcmFkaWVudHMgPSBbCiAgL14oLXdlYmtpdC1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW8tbGluZWFyLWdyYWRpZW50KVwoKFthLXpcc10rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC13ZWJraXQtZ3JhZGllbnQpXCgobGluZWFyfHJhZGlhbCksXHMoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSxccyg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKVwtXSspXCkkLywKICAvXigtbW96LWxpbmVhci1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC13ZWJraXQtcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3KylccyhbYS16XC1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtbW96LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHM/KFthLXpcLV0qKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1vLXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2EtelwtXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8KICBdOwoKICAvKgogKiBUT0RPOiBBZGQgSUUxMCB2ZW5kb3IgcHJlZml4ICgtbXMpIHN1cHBvcnQKICogVE9ETzogQWRkIFczQyBncmFkaWVudCAobGluZWFyLWdyYWRpZW50KSBzdXBwb3J0CiAqIFRPRE86IEFkZCBvbGQgV2Via2l0IC13ZWJraXQtZ3JhZGllbnQocmFkaWFsLCAuLi4pIHN1cHBvcnQKICogVE9ETzogTWF5YmUgc29tZSBSZWdFeHAgb3B0aW1pemF0aW9ucyBhcmUgcG9zc2libGUgO28pCiAqLwogIEdlbmVyYXRlLnBhcnNlR3JhZGllbnQgPSBmdW5jdGlvbihjc3MsIGJvdW5kcykgewogICAgdmFyIGdyYWRpZW50LCBpLCBsZW4gPSByZUdyYWRpZW50cy5sZW5ndGgsIG0xLCBzdG9wLCBtMiwgbTJMZW4sIHN0ZXAsIG0zLCB0bCx0cixicixibDsKCiAgICBmb3IoaSA9IDA7IGkgPCBsZW47IGkrPTEpewogICAgICBtMSA9IGNzcy5tYXRjaChyZUdyYWRpZW50c1tpXSk7CiAgICAgIGlmKG0xKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZihtMSkgewogICAgICBzd2l0Y2gobTFbMV0pIHsKICAgICAgICBjYXNlICctd2Via2l0LWxpbmVhci1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW8tbGluZWFyLWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgICAgIHgwOiBudWxsLAogICAgICAgICAgICB5MDogbnVsbCwKICAgICAgICAgICAgeDE6IG51bGwsCiAgICAgICAgICAgIHkxOiBudWxsLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goL1x3Ky9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBzd2l0Y2gobTJbaV0pIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3RvcCc6CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gMDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IDA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAwOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAwOwogICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZihncmFkaWVudC54MCA9PT0gbnVsbCAmJiBncmFkaWVudC54MSA9PT0gbnVsbCl7IC8vIGNlbnRlcgogICAgICAgICAgICBncmFkaWVudC54MCA9IGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoIC8gMjsKICAgICAgICAgIH0KICAgICAgICAgIGlmKGdyYWRpZW50LnkwID09PSBudWxsICYmIGdyYWRpZW50LnkxID09PSBudWxsKXsgLy8gY2VudGVyCiAgICAgICAgICAgIGdyYWRpZW50LnkwID0gZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC8gMjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9KD86JXxweCkpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJXxweCk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gcHggLSBzdHVwaWQgb3BlcmEKICAgICAgICAgICAgICAgICAgc3RvcCAvPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJy13ZWJraXQtZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiBtMVsyXSA9PT0gJ3JhZGlhbCcgPyAnY2lyY2xlJyA6IG0xWzJdLCAvLyBUT0RPOiBBZGQgcmFkaWFsIGdyYWRpZW50IHN1cHBvcnQgZm9yIG9sZGVyIG1vemlsbGEgZGVmaW5pdGlvbnMKICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/LFxzKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAobTJbM10gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MSA9IChtMls0XSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzRdLm1hdGNoKC8oKD86ZnJvbXx0b3xjb2xvci1zdG9wKVwoKD86WzAtOVwuXSssXHMpPyg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpXCkpKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oZnJvbXx0b3xjb2xvci1zdG9wKVwoKFswLTlcLl0rKT8oPzosXHMpPygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlcKS8pOwogICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICBpZihtM1sxXSA9PT0gJ2Zyb20nKSB7CiAgICAgICAgICAgICAgICBzdG9wID0gMC4wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZihtM1sxXSA9PT0gJ3RvJykgewogICAgICAgICAgICAgICAgc3RvcCA9IDEuMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1szXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJy1tb3otbGluZWFyLWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgeDE6IDAsCiAgICAgICAgICAgIHkxOiAwLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwoKICAgICAgICAgIC8vIG0yWzFdID09IDAlICAgLT4gbGVmdAogICAgICAgICAgLy8gbTJbMV0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgIC8vIG0yWzFdID09IDEwMCUgLT4gcmlnaHQKCiAgICAgICAgICAvLyBtMlsyXSA9PSAwJSAgIC0+IHRvcAogICAgICAgICAgLy8gbTJbMl0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgIC8vIG0yWzJdID09IDEwMCUgLT4gYm90dG9tCgogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkwID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoIC0gZ3JhZGllbnQueDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAtIGdyYWRpZW50LnkwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30lKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCUpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdKXsgLy8gcGVyY2VudGFnZQogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1tb3otcmFkaWFsLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctby1yYWRpYWwtZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnY2lyY2xlJywKICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICB4MTogYm91bmRzLndpZHRoLAogICAgICAgICAgICB5MTogYm91bmRzLmhlaWdodCwKICAgICAgICAgICAgY3g6IDAsCiAgICAgICAgICAgIGN5OiAwLAogICAgICAgICAgICByeDogMCwKICAgICAgICAgICAgcnk6IDAsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGNlbnRlcgogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIGdyYWRpZW50LmN4ID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQuY3kgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBzaXplCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC9cdysvKTsKICAgICAgICAgIG0zID0gbTFbNF0ubWF0Y2goL1thLXpcLV0qLyk7CiAgICAgICAgICBpZihtMiAmJiBtMyl7CiAgICAgICAgICAgIHN3aXRjaChtM1swXSl7CiAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3QtY29ybmVyJzoKICAgICAgICAgICAgICBjYXNlICdjb3Zlcic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gZmFydGhlc3QtY29ybmVyCiAgICAgICAgICAgICAgY2FzZSAnJzogLy8gbW96aWxsYSByZW1vdmVzICJjb3ZlciIgZnJvbSBkZWZpbml0aW9uIDooCiAgICAgICAgICAgICAgICB0bCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYnIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBibCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgodGwsIHRyLCBiciwgYmwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnY2xvc2VzdC1jb3JuZXInOgogICAgICAgICAgICAgICAgdGwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIHRyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYmwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWluKHRsLCB0ciwgYnIsIGJsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2ZhcnRoZXN0LXNpZGUnOgogICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICBncmFkaWVudC50eXBlID0gbTJbMF07CgogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeSA9IE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnY2xvc2VzdC1zaWRlJzoKICAgICAgICAgICAgICBjYXNlICdjb250YWluJzogLy8gaXMgZXF1aXZhbGVudCB0byBjbG9zZXN0LXNpZGUKICAgICAgICAgICAgICAgIGlmKG0yWzBdID09PSAnY2lyY2xlJyl7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gZWxsaXBzZQoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOwoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yICIzMHB4IDQwcHgiIHNpemVzICh3ZWJraXQgb25seSkKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGNvbG9yIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzVdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30oPzolfHB4KSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICBzdG9wIC89IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBncmFkaWVudDsKICB9OwoKICBmdW5jdGlvbiBhZGRTY3JvbGxTdG9wcyhncmFkKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oY29sb3JTdG9wKSB7CiAgICAgIHRyeSB7CiAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoY29sb3JTdG9wLnN0b3AsIGNvbG9yU3RvcC5jb2xvcik7CiAgICAgIH0KICAgICAgY2F0Y2goZSkgewogICAgICAgIFV0aWwubG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGNvbG9yU3RvcF0pOwogICAgICB9CiAgICB9OwogIH0KCiAgR2VuZXJhdGUuR3JhZGllbnQgPSBmdW5jdGlvbihzcmMsIGJvdW5kcykgewogICAgaWYoYm91bmRzLndpZHRoID09PSAwIHx8IGJvdW5kcy5oZWlnaHQgPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLAogICAgZ3JhZGllbnQsIGdyYWQ7CgogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CgogICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yIG11bHRpIGRlZmluZWQgYmFja2dyb3VuZCBncmFkaWVudHMKICAgIGdyYWRpZW50ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLnBhcnNlR3JhZGllbnQoc3JjLCBib3VuZHMpOwoKICAgIGlmKGdyYWRpZW50KSB7CiAgICAgIHN3aXRjaChncmFkaWVudC50eXBlKSB7CiAgICAgICAgY2FzZSAnbGluZWFyJzoKICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoZ3JhZGllbnQueDAsIGdyYWRpZW50LnkwLCBncmFkaWVudC54MSwgZ3JhZGllbnQueTEpOwogICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5mb3JFYWNoKGFkZFNjcm9sbFN0b3BzKGdyYWQpKTsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnY2lyY2xlJzoKICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCAwLCBncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIGdyYWRpZW50LnJ4KTsKICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMuZm9yRWFjaChhZGRTY3JvbGxTdG9wcyhncmFkKSk7CiAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2VsbGlwc2UnOgogICAgICAgICAgdmFyIGNhbnZhc1JhZGlhbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgICAgICAgICBjdHhSYWRpYWwgPSBjYW52YXNSYWRpYWwuZ2V0Q29udGV4dCgnMmQnKSwKICAgICAgICAgICAgcmkgPSBNYXRoLm1heChncmFkaWVudC5yeCwgZ3JhZGllbnQucnkpLAogICAgICAgICAgICBkaSA9IHJpICogMjsKCiAgICAgICAgICBjYW52YXNSYWRpYWwud2lkdGggPSBjYW52YXNSYWRpYWwuaGVpZ2h0ID0gZGk7CgogICAgICAgICAgZ3JhZCA9IGN0eFJhZGlhbC5jcmVhdGVSYWRpYWxHcmFkaWVudChncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIDAsIGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgcmkpOwogICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5mb3JFYWNoKGFkZFNjcm9sbFN0b3BzKGdyYWQpKTsKCiAgICAgICAgICBjdHhSYWRpYWwuZmlsbFN0eWxlID0gZ3JhZDsKICAgICAgICAgIGN0eFJhZGlhbC5maWxsUmVjdCgwLCAwLCBkaSwgZGkpOwoKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkaWVudC5jb2xvclN0b3BzW2dyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoIC0gMV0uY29sb3I7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoY2FudmFzUmFkaWFsLCBncmFkaWVudC5jeCAtIGdyYWRpZW50LnJ4LCBncmFkaWVudC5jeSAtIGdyYWRpZW50LnJ5LCAyICogZ3JhZGllbnQucngsIDIgKiBncmFkaWVudC5yeSk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjYW52YXM7CiAgfTsKCiAgR2VuZXJhdGUuTGlzdEFscGhhID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICB2YXIgdG1wID0gIiIsCiAgICBtb2R1bHVzOwoKICAgIGRvIHsKICAgICAgbW9kdWx1cyA9IG51bWJlciAlIDI2OwogICAgICB0bXAgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChtb2R1bHVzKSArIDY0KSArIHRtcDsKICAgICAgbnVtYmVyID0gbnVtYmVyIC8gMjY7CiAgICB9d2hpbGUoKG51bWJlcioyNikgPiAyNik7CgogICAgcmV0dXJuIHRtcDsKICB9OwoKICBHZW5lcmF0ZS5MaXN0Um9tYW4gPSBmdW5jdGlvbihudW1iZXIpIHsKICAgIHZhciByb21hbkFycmF5ID0gWyJNIiwgIkNNIiwgIkQiLCAiQ0QiLCAiQyIsICJYQyIsICJMIiwgIlhMIiwgIlgiLCAiSVgiLCAiViIsICJJViIsICJJIl0sCiAgICBkZWNpbWFsID0gWzEwMDAsIDkwMCwgNTAwLCA0MDAsIDEwMCwgOTAsIDUwLCA0MCwgMTAsIDksIDUsIDQsIDFdLAogICAgcm9tYW4gPSAiIiwKICAgIHYsCiAgICBsZW4gPSByb21hbkFycmF5Lmxlbmd0aDsKCiAgICBpZiAobnVtYmVyIDw9IDAgfHwgbnVtYmVyID49IDQwMDApIHsKICAgICAgcmV0dXJuIG51bWJlcjsKICAgIH0KCiAgICBmb3IgKHY9MDsgdiA8IGxlbjsgdis9MSkgewogICAgICB3aGlsZSAobnVtYmVyID49IGRlY2ltYWxbdl0pIHsKICAgICAgICBudW1iZXIgLT0gZGVjaW1hbFt2XTsKICAgICAgICByb21hbiArPSByb21hbkFycmF5W3ZdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJvbWFuOwogIH07Cn0pKCk7CmZ1bmN0aW9uIGgyY1JlbmRlckNvbnRleHQod2lkdGgsIGhlaWdodCkgewogIHZhciBzdG9yYWdlID0gW107CiAgcmV0dXJuIHsKICAgIHN0b3JhZ2U6IHN0b3JhZ2UsCiAgICB3aWR0aDogd2lkdGgsCiAgICBoZWlnaHQ6IGhlaWdodCwKICAgIGNsaXA6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImNsaXAiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgdHJhbnNsYXRlOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJ0cmFuc2xhdGUiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZmlsbDogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBzYXZlOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJzYXZlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHJlc3RvcmU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInJlc3RvcmUiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZmlsbFJlY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsUmVjdCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBjcmVhdGVQYXR0ZXJuOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJjcmVhdGVQYXR0ZXJuIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGRyYXdTaGFwZTogZnVuY3Rpb24oKSB7CgogICAgICB2YXIgc2hhcGUgPSBbXTsKCiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZHJhd1NoYXBlIiwKICAgICAgICAnYXJndW1lbnRzJzogc2hhcGUKICAgICAgfSk7CgogICAgICByZXR1cm4gewogICAgICAgIG1vdmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogIm1vdmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgbGluZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAibGluZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhcmNUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogImFyY1RvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBiZXppZXJDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAiYmV6aWVyQ3VydmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgcXVhZHJhdGljQ3VydmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogInF1YWRyYXRpY0N1cnZlVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgfSwKICAgIGRyYXdJbWFnZTogZnVuY3Rpb24gKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImRyYXdJbWFnZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsVGV4dDogZnVuY3Rpb24gKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGxUZXh0IiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHNldFZhcmlhYmxlOiBmdW5jdGlvbiAodmFyaWFibGUsIHZhbHVlKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogInZhcmlhYmxlIiwKICAgICAgICBuYW1lOiB2YXJpYWJsZSwKICAgICAgICAnYXJndW1lbnRzJzogdmFsdWUKICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9Owp9Cl9odG1sMmNhbnZhcy5QYXJzZSA9IGZ1bmN0aW9uIChpbWFnZXMsIG9wdGlvbnMsIGNiKSB7CiAgd2luZG93LnNjcm9sbCgwLDApOwoKICB2YXIgZWxlbWVudCA9ICgoIG9wdGlvbnMuZWxlbWVudHMgPT09IHVuZGVmaW5lZCApID8gZG9jdW1lbnQuYm9keSA6IG9wdGlvbnMuZWxlbWVudHNbMF0pLCAvLyBzZWxlY3QgYm9keSBieSBkZWZhdWx0CiAgbnVtRHJhd3MgPSAwLAogIGRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudCwKICBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgc3VwcG9ydCA9IFV0aWwuU3VwcG9ydChvcHRpb25zLCBkb2MpLAogIGlnbm9yZUVsZW1lbnRzUmVnRXhwID0gbmV3IFJlZ0V4cCgiKCIgKyBvcHRpb25zLmlnbm9yZUVsZW1lbnRzICsgIikiKSwKICBib2R5ID0gZG9jLmJvZHksCiAgZ2V0Q1NTID0gVXRpbC5nZXRDU1MsCiAgcHNldWRvSGlkZSA9ICJfX19odG1sMmNhbnZhc19fX3BzZXVkb2VsZW1lbnQiLAogIGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcyA9IGRvYy5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwoKICBoaWRlUHNldWRvRWxlbWVudHNTdHlsZXMuaW5uZXJIVE1MID0gJy4nICsgcHNldWRvSGlkZSArCiAgJy1wYXJlbnQ6YmVmb3JlIHsgY29udGVudDogIiIgIWltcG9ydGFudDsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9JyArCiAgJy4nICsgcHNldWRvSGlkZSArICctcGFyZW50OmFmdGVyIHsgY29udGVudDogIiIgIWltcG9ydGFudDsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9JzsKCiAgYm9keS5hcHBlbmRDaGlsZChoaWRlUHNldWRvRWxlbWVudHNTdHlsZXMpOwoKICBpbWFnZXMgPSBpbWFnZXMgfHwge307CgogIGluaXQoKTsKCiAgZnVuY3Rpb24gaW5pdCgpIHsKICAgIHZhciBiYWNrZ3JvdW5kID0gZ2V0Q1NTKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgImJhY2tncm91bmRDb2xvciIpLAogICAgICB0cmFuc3BhcmVudEJhY2tncm91bmQgPSAoVXRpbC5pc1RyYW5zcGFyZW50KGJhY2tncm91bmQpICYmIGVsZW1lbnQgPT09IGRvY3VtZW50LmJvZHkpLAogICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgbnVsbCwgZmFsc2UsIHRyYW5zcGFyZW50QmFja2dyb3VuZCk7CgogICAgLy8gY3JlYXRlIHBzZXVkbyBlbGVtZW50cyBpbiBhIHNpbmdsZSBwYXNzIHRvIHByZXZlbnQgc3luY2hyb25vdXMgbGF5b3V0cwogICAgYWRkUHNldWRvRWxlbWVudHMoZWxlbWVudCk7CgogICAgcGFyc2VDaGlsZHJlbihlbGVtZW50LCBzdGFjaywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0cmFuc3BhcmVudEJhY2tncm91bmQpIHsKICAgICAgICBiYWNrZ3JvdW5kID0gc3RhY2suYmFja2dyb3VuZENvbG9yOwogICAgICB9CgogICAgICByZW1vdmVQc2V1ZG9FbGVtZW50cygpOwoKICAgICAgVXRpbC5sb2coJ0RvbmUgcGFyc2luZywgbW92aW5nIHRvIFJlbmRlci4nKTsKCiAgICAgIGNiKHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGJhY2tncm91bmQsCiAgICAgICAgc3RhY2s6IHN0YWNrCiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvLyBHaXZlbiBhIHJvb3QgZWxlbWVudCwgZmluZCBhbGwgcHNldWRvIGVsZW1lbnRzIGJlbG93LCBjcmVhdGUgZWxlbWVudHMgbW9ja2luZyBwc2V1ZG8gZWxlbWVudCBzdHlsZXMKICAvLyBzbyB3ZSBjYW4gcHJvY2VzcyB0aGVtIGFzIG5vcm1hbCBlbGVtZW50cywgYW5kIGhpZGUgdGhlIG9yaWdpbmFsIHBzZXVkbyBlbGVtZW50cyBzbyB0aGV5IGRvbid0IGludGVyZmVyZQogIC8vIHdpdGggbGF5b3V0LgogIGZ1bmN0aW9uIGFkZFBzZXVkb0VsZW1lbnRzKGVsKSB7CiAgICAvLyBUaGVzZSBhcmUgZG9uZSBpbiBkaXNjcmV0ZSBzdGVwcyB0byBwcmV2ZW50IGEgcmVsYXlvdXQgbG9vcCBjYXVzZWQgYnkgYWRkQ2xhc3MoKSBpbnZhbGlkYXRpbmcKICAgIC8vIGxheW91dHMgJiBnZXRQc2V1ZG9FbGVtZW50IGNhbGxpbmcgZ2V0Q29tcHV0ZWRTdHlsZS4KICAgIHZhciBqb2JzID0gW10sIGNsYXNzZXMgPSBbXTsKICAgIGdldFBzZXVkb0VsZW1lbnRDbGFzc2VzKCk7CiAgICB0cnkgewogICAgICBmaW5kUHNldWRvRWxlbWVudHMoZWwpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUGFyc2U6IEV4Y2VwdGlvbiBjYXVnaHQgaW4gZmluZFBzZXVkb0VsZW1lbnRzOiAiICsgZS5tZXNzYWdlKTsKICAgIH0KICAgIHJ1bkpvYnMoKTsKCiAgICBmdW5jdGlvbiBnZXRQc2V1ZG9FbGVtZW50Q2xhc3NlcygpewogICAgICB2YXIgZmluZFBzdWVkb0VscyA9IC86YmVmb3JlfDphZnRlci87CiAgICAgIHZhciBzaGVldHMgPSBkb2N1bWVudC5zdHlsZVNoZWV0czsKICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBzaGVldHMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBydWxlcyA9IHNoZWV0c1tpXS5jc3NSdWxlczsKICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBsID0gcnVsZXMubGVuZ3RoOyBrIDwgbDsgaysrKSB7CiAgICAgICAgICAgIGlmICghcnVsZXNba10uc2VsZWN0b3JUZXh0KSBjb250aW51ZTsKICAgICAgICAgICAgdmFyIHNlbGVjdG9ycyA9IHJ1bGVzW2tdLnNlbGVjdG9yVGV4dC5zcGxpdCgvICosICovKTsKICAgICAgICAgICAgZm9yICh2YXIgbSA9IDAsIG4gPSBzZWxlY3RvcnMubGVuZ3RoOyBtIDwgbjsgbSsrKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdG9yID0gc2VsZWN0b3JzW21dOwogICAgICAgICAgICAgIGlmKGZpbmRQc3VlZG9FbHMudGVzdChzZWxlY3RvcnNbbV0pKSB7CiAgICAgICAgICAgICAgICAvLyBUcmltIG9mZiB0aGUgOmFmdGVyIGFuZCA6YmVmb3JlIChvciA6OmFmdGVyIGFuZCA6OmJlZm9yZSkKICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IubWF0Y2goLyheW146XSopLylbMV07CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IudHJpbSgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHNlbGVjdG9yc1ttXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHsgLy8gd2lsbCB0aHJvdyBzZWN1cml0eSBleGNlcHRpb24gZm9yIHN0eWxlIHNoZWV0cyBsb2FkZWQgZnJvbSBleHRlcm5hbCBkb21haW5zCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gVXNpbmcgdGhlIGxpc3Qgb2YgZWxlbWVudHMgd2Uga25vdyBob3cgcHNldWRvIGVsIHN0eWxlcywgY3JlYXRlIGZha2UgcHNldWRvIGVsZW1lbnRzLgogICAgZnVuY3Rpb24gZmluZFBzZXVkb0VsZW1lbnRzKGVsKSB7CiAgICAgIHZhciBlbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGNsYXNzZXMuam9pbignLCcpKTsKICAgICAgZm9yKHZhciBpID0gMCwgaiA9IGVscy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICBjcmVhdGVQc2V1ZG9FbGVtZW50cyhlbHNbaV0pOwogICAgICB9CiAgICB9CgogICAgLy8gQ3JlYXRlIHBzZXVkbyBlbGVtZW50cyAmIGFkZCB0aGVtIHRvIGEgam9iIHF1ZXVlLgogICAgZnVuY3Rpb24gY3JlYXRlUHNldWRvRWxlbWVudHMoZWwpIHsKICAgICAgdmFyIGJlZm9yZSA9IGdldFBzZXVkb0VsZW1lbnQoZWwsICc6YmVmb3JlJyksCiAgICAgIGFmdGVyID0gZ2V0UHNldWRvRWxlbWVudChlbCwgJzphZnRlcicpOwoKICAgICAgaWYoYmVmb3JlKSB7CiAgICAgICAgam9icy5wdXNoKHt0eXBlOiAnYmVmb3JlJywgcHNldWRvOiBiZWZvcmUsIGVsOiBlbH0pOwogICAgICB9CgogICAgICBpZiAoYWZ0ZXIpIHsKICAgICAgICBqb2JzLnB1c2goe3R5cGU6ICdhZnRlcicsIHBzZXVkbzogYWZ0ZXIsIGVsOiBlbH0pOwogICAgICB9CiAgICB9CgogICAgLy8gQWRkcyBhIGNsYXNzIHRvIHRoZSBwc2V1ZG8ncyBwYXJlbnQgdG8gcHJldmVudCB0aGUgb3JpZ2luYWwgYmVmb3JlL2FmdGVyIGZyb20gbWVzc2luZwogICAgLy8gd2l0aCBsYXlvdXRzLgogICAgLy8gRXhlY3V0ZSB0aGUgaW5zZXJ0cyAmIGFkZENsYXNzKCkgY2FsbHMgaW4gYSBiYXRjaCB0byBwcmV2ZW50IHJlbGF5b3V0cy4KICAgIGZ1bmN0aW9uIHJ1bkpvYnMoKSB7CiAgICAgIC8vIEFkZCBDbGFzcwogICAgICBqb2JzLmZvckVhY2goZnVuY3Rpb24oam9iKXsKICAgICAgICBhZGRDbGFzcyhqb2IuZWwsIHBzZXVkb0hpZGUgKyAiLXBhcmVudCIpOwogICAgICB9KTsKCiAgICAgIC8vIEluc2VydCBlbAogICAgICBqb2JzLmZvckVhY2goZnVuY3Rpb24oam9iKXsKICAgICAgICBpZihqb2IudHlwZSA9PT0gJ2JlZm9yZScpewogICAgICAgICAgam9iLmVsLmluc2VydEJlZm9yZShqb2IucHNldWRvLCBqb2IuZWwuZmlyc3RDaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGpvYi5lbC5hcHBlbmRDaGlsZChqb2IucHNldWRvKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCgoKICAvLyBEZWxldGUgb3VyIGZha2UgcHNldWRvIGVsZW1lbnRzIGZyb20gdGhlIERPTS4gVGhpcyB3aWxsIHJlbW92ZSB0aG9zZSBhY3R1YWwgZWxlbWVudHMKICAvLyBhbmQgdGhlIGNsYXNzZXMgb24gdGhlaXIgcGFyZW50cyB0aGF0IGhpZGUgdGhlIGFjdHVhbCBwc2V1ZG8gZWxlbWVudHMuCiAgLy8gTm90ZSB0aGF0IE5vZGVMaXN0cyBhcmUgJ2xpdmUnIGNvbGxlY3Rpb25zIHNvIHlvdSBjYW4ndCB1c2UgYSBmb3IgbG9vcCBoZXJlLiBUaGV5IGFyZQogIC8vIGFjdHVhbGx5IGRlbGV0ZWQgZnJvbSB0aGUgTm9kZUxpc3QgYWZ0ZXIgZWFjaCBpdGVyYXRpb24uCiAgZnVuY3Rpb24gcmVtb3ZlUHNldWRvRWxlbWVudHMoKXsKICAgIC8vIGRlbGV0ZSBwc2V1ZG8gZWxlbWVudHMKICAgIGJvZHkucmVtb3ZlQ2hpbGQoaGlkZVBzZXVkb0VsZW1lbnRzU3R5bGVzKTsKICAgIHZhciBwc2V1ZG9zID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShwc2V1ZG9IaWRlICsgIi1lbGVtZW50Iik7CiAgICB3aGlsZSAocHNldWRvcy5sZW5ndGgpIHsKICAgICAgcHNldWRvc1swXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHBzZXVkb3NbMF0pOwogICAgfQoKICAgIC8vIFJlbW92ZSBwc2V1ZG8gaGlkaW5nIGNsYXNzZXMKICAgIHZhciBwYXJlbnRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShwc2V1ZG9IaWRlICsgIi1wYXJlbnQiKTsKICAgIHdoaWxlKHBhcmVudHMubGVuZ3RoKSB7CiAgICAgIHJlbW92ZUNsYXNzKHBhcmVudHNbMF0sIHBzZXVkb0hpZGUgKyAiLXBhcmVudCIpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWRkQ2xhc3MgKGVsLCBjbGFzc05hbWUpIHsKICAgIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lICsgIiAiICsgY2xhc3NOYW1lOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MgKGVsLCBjbGFzc05hbWUpIHsKICAgIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lLnJlcGxhY2UoY2xhc3NOYW1lLCAiIikudHJpbSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaGFzQ2xhc3MgKGVsLCBjbGFzc05hbWUpIHsKICAgIHJldHVybiBlbC5jbGFzc05hbWUuaW5kZXhPZihjbGFzc05hbWUpID4gLTE7CiAgfQoKICAvLyBOb3RlIHRoYXQgdGhpcyBkb2Vzbid0IHdvcmsgaW4gPCBJRTgsIGJ1dCB3ZSBkb24ndCBzdXBwb3J0IHRoYXQgYW55aG93CiAgZnVuY3Rpb24gbm9kZUxpc3RUb0FycmF5IChub2RlTGlzdCkgewogICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG5vZGVMaXN0KTsKICB9CgogIGZ1bmN0aW9uIGRvY3VtZW50V2lkdGggKCkgewogICAgcmV0dXJuIE1hdGgubWF4KAogICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50Lm9mZnNldFdpZHRoKSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50V2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiBkb2N1bWVudEhlaWdodCAoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LnNjcm9sbEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGdldENTU0ludChlbGVtZW50LCBhdHRyaWJ1dGUpIHsKICAgIHZhciB2YWwgPSBwYXJzZUludChnZXRDU1MoZWxlbWVudCwgYXR0cmlidXRlKSwgMTApOwogICAgcmV0dXJuIChpc05hTih2YWwpKSA/IDAgOiB2YWw7IC8vIGJvcmRlcnMgaW4gb2xkIElFIGFyZSB0aHJvd2luZyAnbWVkaXVtJyBmb3IgZGVtby5odG1sCiAgfQoKICBmdW5jdGlvbiByZW5kZXJSZWN0IChjdHgsIHgsIHksIHcsIGgsIGJnY29sb3IpIHsKICAgIGlmIChiZ2NvbG9yICE9PSAidHJhbnNwYXJlbnQiKXsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBiZ2NvbG9yKTsKICAgICAgY3R4LmZpbGxSZWN0KHgsIHksIHcsIGgpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhcGl0YWxpemUobSwgcDEsIHAyKSB7CiAgICBpZiAobS5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBwMSArIHAyLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0ZXh0VHJhbnNmb3JtICh0ZXh0LCB0cmFuc2Zvcm0pIHsKICAgIHN3aXRjaCh0cmFuc2Zvcm0pewogICAgICBjYXNlICJsb3dlcmNhc2UiOgogICAgICAgIHJldHVybiB0ZXh0LnRvTG93ZXJDYXNlKCk7CiAgICAgIGNhc2UgImNhcGl0YWxpemUiOgogICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoIC8oXnxcc3w6fC18XCh8XCkpKFthLXpdKS9nLCBjYXBpdGFsaXplKTsKICAgICAgY2FzZSAidXBwZXJjYXNlIjoKICAgICAgICByZXR1cm4gdGV4dC50b1VwcGVyQ2FzZSgpOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogIH0KCiAgZnVuY3Rpb24gbm9MZXR0ZXJTcGFjaW5nKGxldHRlcl9zcGFjaW5nKSB7CiAgICByZXR1cm4gKC9eKG5vcm1hbHxub25lfDBweCkkLy50ZXN0KGxldHRlcl9zcGFjaW5nKSk7CiAgfQoKICBmdW5jdGlvbiBkcmF3VGV4dChjdXJyZW50VGV4dCwgeCwgeSwgY3R4KXsKICAgIGlmIChjdXJyZW50VGV4dCAhPT0gbnVsbCAmJiBVdGlsLnRyaW1UZXh0KGN1cnJlbnRUZXh0KS5sZW5ndGggPiAwKSB7CiAgICAgIGN0eC5maWxsVGV4dChjdXJyZW50VGV4dCwgeCwgeSk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsLCB0ZXh0X2RlY29yYXRpb24sIGNvbG9yKSB7CiAgICB2YXIgYWxpZ24gPSBmYWxzZSwKICAgIGJvbGQgPSBnZXRDU1MoZWwsICJmb250V2VpZ2h0IiksCiAgICBmYW1pbHkgPSBnZXRDU1MoZWwsICJmb250RmFtaWx5IiksCiAgICBzaXplID0gZ2V0Q1NTKGVsLCAiZm9udFNpemUiKSwKICAgIHNoYWRvd3MgPSBVdGlsLnBhcnNlVGV4dFNoYWRvd3MoZ2V0Q1NTKGVsLCAidGV4dFNoYWRvdyIpKTsKCiAgICBzd2l0Y2gocGFyc2VJbnQoYm9sZCwgMTApKXsKICAgICAgY2FzZSA0MDE6CiAgICAgICAgYm9sZCA9ICJib2xkIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSA0MDA6CiAgICAgICAgYm9sZCA9ICJub3JtYWwiOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgY29sb3IpOwogICAgY3R4LnNldFZhcmlhYmxlKCJmb250IiwgW2dldENTUyhlbCwgImZvbnRTdHlsZSIpLCBnZXRDU1MoZWwsICJmb250VmFyaWFudCIpLCBib2xkLCBzaXplLCBmYW1pbHldLmpvaW4oIiAiKSk7CiAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsIChhbGlnbikgPyAicmlnaHQiIDogImxlZnQiKTsKCiAgICBpZiAoc2hhZG93cy5sZW5ndGgpIHsKICAgICAgLy8gVE9ETzogc3VwcG9ydCBtdWx0aXBsZSB0ZXh0IHNoYWRvd3MKICAgICAgLy8gYXBwbHkgdGhlIGZpcnN0IHRleHQgc2hhZG93CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93Q29sb3IiLCBzaGFkb3dzWzBdLmNvbG9yKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dPZmZzZXRYIiwgc2hhZG93c1swXS5vZmZzZXRYKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dPZmZzZXRZIiwgc2hhZG93c1swXS5vZmZzZXRZKTsKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dCbHVyIiwgc2hhZG93c1swXS5ibHVyKTsKICAgIH0KCiAgICBpZiAodGV4dF9kZWNvcmF0aW9uICE9PSAibm9uZSIpewogICAgICByZXR1cm4gVXRpbC5Gb250KGZhbWlseSwgc2l6ZSwgZG9jKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlclRleHREZWNvcmF0aW9uKGN0eCwgdGV4dF9kZWNvcmF0aW9uLCBib3VuZHMsIG1ldHJpY3MsIGNvbG9yKSB7CiAgICBzd2l0Y2godGV4dF9kZWNvcmF0aW9uKSB7CiAgICAgIGNhc2UgInVuZGVybGluZSI6CiAgICAgICAgLy8gRHJhd3MgYSBsaW5lIGF0IHRoZSBiYXNlbGluZSBvZiB0aGUgZm9udAogICAgICAgIC8vIFRPRE8gQXMgc29tZSBicm93c2VycyBkaXNwbGF5IHRoZSBsaW5lIGFzIG1vcmUgdGhhbiAxcHggaWYgdGhlIGZvbnQtc2l6ZSBpcyBiaWcsIG5lZWQgdG8gdGFrZSB0aGF0IGludG8gYWNjb3VudCBib3RoIGluIHBvc2l0aW9uIGFuZCBzaXplCiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBtZXRyaWNzLmJhc2VsaW5lICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAib3ZlcmxpbmUiOgogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5yb3VuZChib3VuZHMudG9wKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxpbmUtdGhyb3VnaCI6CiAgICAgICAgLy8gVE9ETyB0cnkgYW5kIGZpbmQgZXhhY3QgcG9zaXRpb24gZm9yIGxpbmUtdGhyb3VnaAogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5jZWlsKGJvdW5kcy50b3AgKyBtZXRyaWNzLm1pZGRsZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRUZXh0Qm91bmRzKHN0YXRlLCB0ZXh0LCB0ZXh0RGVjb3JhdGlvbiwgaXNMYXN0LCB0cmFuc2Zvcm0pIHsKICAgIHZhciBib3VuZHM7CiAgICBpZiAoc3VwcG9ydC5yYW5nZUJvdW5kcyAmJiAhdHJhbnNmb3JtKSB7CiAgICAgIGlmICh0ZXh0RGVjb3JhdGlvbiAhPT0gIm5vbmUiIHx8IFV0aWwudHJpbVRleHQodGV4dCkubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgYm91bmRzID0gdGV4dFJhbmdlQm91bmRzKHRleHQsIHN0YXRlLm5vZGUsIHN0YXRlLnRleHRPZmZzZXQpOwogICAgICB9CiAgICAgIHN0YXRlLnRleHRPZmZzZXQgKz0gdGV4dC5sZW5ndGg7CiAgICB9IGVsc2UgaWYgKHN0YXRlLm5vZGUgJiYgdHlwZW9mIHN0YXRlLm5vZGUubm9kZVZhbHVlID09PSAic3RyaW5nIiApewogICAgICB2YXIgbmV3VGV4dE5vZGUgPSAoaXNMYXN0KSA/IHN0YXRlLm5vZGUuc3BsaXRUZXh0KHRleHQubGVuZ3RoKSA6IG51bGw7CiAgICAgIGJvdW5kcyA9IHRleHRXcmFwcGVyQm91bmRzKHN0YXRlLm5vZGUsIHRyYW5zZm9ybSk7CiAgICAgIHN0YXRlLm5vZGUgPSBuZXdUZXh0Tm9kZTsKICAgIH0KICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiB0ZXh0UmFuZ2VCb3VuZHModGV4dCwgdGV4dE5vZGUsIHRleHRPZmZzZXQpIHsKICAgIHZhciByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgcmFuZ2Uuc2V0U3RhcnQodGV4dE5vZGUsIHRleHRPZmZzZXQpOwogICAgcmFuZ2Uuc2V0RW5kKHRleHROb2RlLCB0ZXh0T2Zmc2V0ICsgdGV4dC5sZW5ndGgpOwogICAgcmV0dXJuIHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KCiAgZnVuY3Rpb24gdGV4dFdyYXBwZXJCb3VuZHMob2xkVGV4dE5vZGUsIHRyYW5zZm9ybSkgewogICAgdmFyIHBhcmVudCA9IG9sZFRleHROb2RlLnBhcmVudE5vZGUsCiAgICB3cmFwRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCd3cmFwcGVyJyksCiAgICBiYWNrdXBUZXh0ID0gb2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpOwoKICAgIHdyYXBFbGVtZW50LmFwcGVuZENoaWxkKG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKSk7CiAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBFbGVtZW50LCBvbGRUZXh0Tm9kZSk7CgogICAgdmFyIGJvdW5kcyA9IHRyYW5zZm9ybSA/IFV0aWwuT2Zmc2V0Qm91bmRzKHdyYXBFbGVtZW50KSA6IFV0aWwuQm91bmRzKHdyYXBFbGVtZW50KTsKICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQoYmFja3VwVGV4dCwgd3JhcEVsZW1lbnQpOwogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjaykgewogICAgdmFyIGN0eCA9IHN0YWNrLmN0eCwKICAgIGNvbG9yID0gZ2V0Q1NTKGVsLCAiY29sb3IiKSwKICAgIHRleHREZWNvcmF0aW9uID0gZ2V0Q1NTKGVsLCAidGV4dERlY29yYXRpb24iKSwKICAgIHRleHRBbGlnbiA9IGdldENTUyhlbCwgInRleHRBbGlnbiIpLAogICAgbWV0cmljcywKICAgIHRleHRMaXN0LAogICAgc3RhdGUgPSB7CiAgICAgIG5vZGU6IHRleHROb2RlLAogICAgICB0ZXh0T2Zmc2V0OiAwCiAgICB9OwoKICAgIGlmIChVdGlsLnRyaW1UZXh0KHRleHROb2RlLm5vZGVWYWx1ZSkubGVuZ3RoID4gMCkgewogICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUgPSB0ZXh0VHJhbnNmb3JtKHRleHROb2RlLm5vZGVWYWx1ZSwgZ2V0Q1NTKGVsLCAidGV4dFRyYW5zZm9ybSIpKTsKICAgICAgdGV4dEFsaWduID0gdGV4dEFsaWduLnJlcGxhY2UoWyItd2Via2l0LWF1dG8iXSxbImF1dG8iXSk7CgogICAgICB0ZXh0TGlzdCA9ICghb3B0aW9ucy5sZXR0ZXJSZW5kZXJpbmcgJiYgL14obGVmdHxyaWdodHxqdXN0aWZ5fGF1dG8pJC8udGVzdCh0ZXh0QWxpZ24pICYmIG5vTGV0dGVyU3BhY2luZyhnZXRDU1MoZWwsICJsZXR0ZXJTcGFjaW5nIikpKSA/CiAgICAgIHRleHROb2RlLm5vZGVWYWx1ZS5zcGxpdCgvKFxifCApLykKICAgICAgOiB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoIiIpOwoKICAgICAgbWV0cmljcyA9IHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbCwgdGV4dERlY29yYXRpb24sIGNvbG9yKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaW5lc2UpIHsKICAgICAgICB0ZXh0TGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHdvcmQsIGluZGV4KSB7CiAgICAgICAgICBpZiAoLy4qW1x1NEUwMC1cdTlGQTVdLiokLy50ZXN0KHdvcmQpKSB7CiAgICAgICAgICAgIHdvcmQgPSB3b3JkLnNwbGl0KCIiKTsKICAgICAgICAgICAgd29yZC51bnNoaWZ0KGluZGV4LCAxKTsKICAgICAgICAgICAgdGV4dExpc3Quc3BsaWNlLmFwcGx5KHRleHRMaXN0LCB3b3JkKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGV4dExpc3QuZm9yRWFjaChmdW5jdGlvbih0ZXh0LCBpbmRleCkgewogICAgICAgIHZhciBib3VuZHMgPSBnZXRUZXh0Qm91bmRzKHN0YXRlLCB0ZXh0LCB0ZXh0RGVjb3JhdGlvbiwgKGluZGV4IDwgdGV4dExpc3QubGVuZ3RoIC0gMSksIHN0YWNrLnRyYW5zZm9ybS5tYXRyaXgpOwogICAgICAgIGlmIChib3VuZHMpIHsKICAgICAgICAgIGRyYXdUZXh0KHRleHQsIGJvdW5kcy5sZWZ0LCBib3VuZHMuYm90dG9tLCBjdHgpOwogICAgICAgICAgcmVuZGVyVGV4dERlY29yYXRpb24oY3R4LCB0ZXh0RGVjb3JhdGlvbiwgYm91bmRzLCBtZXRyaWNzLCBjb2xvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxpc3RQb3NpdGlvbiAoZWxlbWVudCwgdmFsKSB7CiAgICB2YXIgYm91bmRFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJib3VuZGVsZW1lbnQiICksCiAgICBvcmlnaW5hbFR5cGUsCiAgICBib3VuZHM7CgogICAgYm91bmRFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiaW5saW5lIjsKCiAgICBvcmlnaW5hbFR5cGUgPSBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGU7CiAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSAibm9uZSI7CgogICAgYm91bmRFbGVtZW50LmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZSh2YWwpKTsKCiAgICBlbGVtZW50Lmluc2VydEJlZm9yZShib3VuZEVsZW1lbnQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7CgogICAgYm91bmRzID0gVXRpbC5Cb3VuZHMoYm91bmRFbGVtZW50KTsKICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoYm91bmRFbGVtZW50KTsKICAgIGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZSA9IG9yaWdpbmFsVHlwZTsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiBlbGVtZW50SW5kZXgoZWwpIHsKICAgIHZhciBpID0gLTEsCiAgICBjb3VudCA9IDEsCiAgICBjaGlsZHMgPSBlbC5wYXJlbnROb2RlLmNoaWxkTm9kZXM7CgogICAgaWYgKGVsLnBhcmVudE5vZGUpIHsKICAgICAgd2hpbGUoY2hpbGRzWysraV0gIT09IGVsKSB7CiAgICAgICAgaWYgKGNoaWxkc1tpXS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGNvdW50OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbGlzdEl0ZW1UZXh0KGVsZW1lbnQsIHR5cGUpIHsKICAgIHZhciBjdXJyZW50SW5kZXggPSBlbGVtZW50SW5kZXgoZWxlbWVudCksIHRleHQ7CiAgICBzd2l0Y2godHlwZSl7CiAgICAgIGNhc2UgImRlY2ltYWwiOgogICAgICAgIHRleHQgPSBjdXJyZW50SW5kZXg7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImRlY2ltYWwtbGVhZGluZy16ZXJvIjoKICAgICAgICB0ZXh0ID0gKGN1cnJlbnRJbmRleC50b1N0cmluZygpLmxlbmd0aCA9PT0gMSkgPyBjdXJyZW50SW5kZXggPSAiMCIgKyBjdXJyZW50SW5kZXgudG9TdHJpbmcoKSA6IGN1cnJlbnRJbmRleC50b1N0cmluZygpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ1cHBlci1yb21hbiI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsb3dlci1yb21hbiI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxvd2VyLWFscGhhIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBwZXItYWxwaGEiOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gdGV4dCArICIuICI7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJMaXN0SXRlbShlbGVtZW50LCBzdGFjaywgZWxCb3VuZHMpIHsKICAgIHZhciB4LAogICAgdGV4dCwKICAgIGN0eCA9IHN0YWNrLmN0eCwKICAgIHR5cGUgPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVR5cGUiKSwKICAgIGxpc3RCb3VuZHM7CgogICAgaWYgKC9eKGRlY2ltYWx8ZGVjaW1hbC1sZWFkaW5nLXplcm98dXBwZXItYWxwaGF8dXBwZXItbGF0aW58dXBwZXItcm9tYW58bG93ZXItYWxwaGF8bG93ZXItZ3JlZWt8bG93ZXItbGF0aW58bG93ZXItcm9tYW4pJC9pLnRlc3QodHlwZSkpIHsKICAgICAgdGV4dCA9IGxpc3RJdGVtVGV4dChlbGVtZW50LCB0eXBlKTsKICAgICAgbGlzdEJvdW5kcyA9IGxpc3RQb3NpdGlvbihlbGVtZW50LCB0ZXh0KTsKICAgICAgc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsZW1lbnQsICJub25lIiwgZ2V0Q1NTKGVsZW1lbnQsICJjb2xvciIpKTsKCiAgICAgIGlmIChnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVBvc2l0aW9uIikgPT09ICJpbnNpZGUiKSB7CiAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAibGVmdCIpOwogICAgICAgIHggPSBlbEJvdW5kcy5sZWZ0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZHJhd1RleHQodGV4dCwgeCwgbGlzdEJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2FkSW1hZ2UgKHNyYyl7CiAgICB2YXIgaW1nID0gaW1hZ2VzW3NyY107CiAgICByZXR1cm4gKGltZyAmJiBpbWcuc3VjY2VlZGVkID09PSB0cnVlKSA/IGltZy5pbWcgOiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGNsaXBCb3VuZHMoc3JjLCBkc3QpewogICAgdmFyIHggPSBNYXRoLm1heChzcmMubGVmdCwgZHN0LmxlZnQpLAogICAgeSA9IE1hdGgubWF4KHNyYy50b3AsIGRzdC50b3ApLAogICAgeDIgPSBNYXRoLm1pbigoc3JjLmxlZnQgKyBzcmMud2lkdGgpLCAoZHN0LmxlZnQgKyBkc3Qud2lkdGgpKSwKICAgIHkyID0gTWF0aC5taW4oKHNyYy50b3AgKyBzcmMuaGVpZ2h0KSwgKGRzdC50b3AgKyBkc3QuaGVpZ2h0KSk7CgogICAgcmV0dXJuIHsKICAgICAgbGVmdDp4LAogICAgICB0b3A6eSwKICAgICAgd2lkdGg6eDIteCwKICAgICAgaGVpZ2h0OnkyLXkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzZXRaKGVsZW1lbnQsIHN0YWNrLCBwYXJlbnRTdGFjayl7CiAgICB2YXIgbmV3Q29udGV4dCwKICAgIGlzUG9zaXRpb25lZCA9IHN0YWNrLmNzc1Bvc2l0aW9uICE9PSAnc3RhdGljJywKICAgIHpJbmRleCA9IGlzUG9zaXRpb25lZCA/IGdldENTUyhlbGVtZW50LCAnekluZGV4JykgOiAnYXV0bycsCiAgICBvcGFjaXR5ID0gZ2V0Q1NTKGVsZW1lbnQsICdvcGFjaXR5JyksCiAgICBpc0Zsb2F0ZWQgPSBnZXRDU1MoZWxlbWVudCwgJ2Nzc0Zsb2F0JykgIT09ICdub25lJzsKCiAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9HdWlkZS9DU1MvVW5kZXJzdGFuZGluZ196X2luZGV4L1RoZV9zdGFja2luZ19jb250ZXh0CiAgICAvLyBXaGVuIGEgbmV3IHN0YWNraW5nIGNvbnRleHQgc2hvdWxkIGJlIGNyZWF0ZWQ6CiAgICAvLyB0aGUgcm9vdCBlbGVtZW50IChIVE1MKSwKICAgIC8vIHBvc2l0aW9uZWQgKGFic29sdXRlbHkgb3IgcmVsYXRpdmVseSkgd2l0aCBhIHotaW5kZXggdmFsdWUgb3RoZXIgdGhhbiAiYXV0byIsCiAgICAvLyBlbGVtZW50cyB3aXRoIGFuIG9wYWNpdHkgdmFsdWUgbGVzcyB0aGFuIDEuIChTZWUgdGhlIHNwZWNpZmljYXRpb24gZm9yIG9wYWNpdHkpLAogICAgLy8gb24gbW9iaWxlIFdlYktpdCBhbmQgQ2hyb21lIDIyKywgcG9zaXRpb246IGZpeGVkIGFsd2F5cyBjcmVhdGVzIGEgbmV3IHN0YWNraW5nIGNvbnRleHQsIGV2ZW4gd2hlbiB6LWluZGV4IGlzICJhdXRvIiAoU2VlIHRoaXMgcG9zdCkKCiAgICBzdGFjay56SW5kZXggPSBuZXdDb250ZXh0ID0gaDJjekNvbnRleHQoekluZGV4KTsKICAgIG5ld0NvbnRleHQuaXNQb3NpdGlvbmVkID0gaXNQb3NpdGlvbmVkOwogICAgbmV3Q29udGV4dC5pc0Zsb2F0ZWQgPSBpc0Zsb2F0ZWQ7CiAgICBuZXdDb250ZXh0Lm9wYWNpdHkgPSBvcGFjaXR5OwogICAgbmV3Q29udGV4dC5vd25TdGFja2luZyA9ICh6SW5kZXggIT09ICdhdXRvJyB8fCBvcGFjaXR5IDwgMSk7CiAgICBuZXdDb250ZXh0LmRlcHRoID0gcGFyZW50U3RhY2sgPyAocGFyZW50U3RhY2suekluZGV4LmRlcHRoICsgMSkgOiAwOwoKICAgIGlmIChwYXJlbnRTdGFjaykgewogICAgICBwYXJlbnRTdGFjay56SW5kZXguY2hpbGRyZW4ucHVzaChzdGFjayk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoMmN6Q29udGV4dCh6aW5kZXgpIHsKICAgIHJldHVybiB7CiAgICAgIGRlcHRoOiAwLAogICAgICB6aW5kZXg6IHppbmRleCwKICAgICAgY2hpbGRyZW46IFtdCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBpbWFnZSwgYm91bmRzLCBib3JkZXJzKSB7CgogICAgdmFyIHBhZGRpbmdMZWZ0ID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nTGVmdCcpLAogICAgcGFkZGluZ1RvcCA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ1RvcCcpLAogICAgcGFkZGluZ1JpZ2h0ID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nUmlnaHQnKSwKICAgIHBhZGRpbmdCb3R0b20gPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdCb3R0b20nKTsKCiAgICBkcmF3SW1hZ2UoCiAgICAgIGN0eCwKICAgICAgaW1hZ2UsCiAgICAgIDAsIC8vc3gKICAgICAgMCwgLy9zeQogICAgICBpbWFnZS53aWR0aCwgLy9zdwogICAgICBpbWFnZS5oZWlnaHQsIC8vc2gKICAgICAgYm91bmRzLmxlZnQgKyBwYWRkaW5nTGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIC8vZHgKICAgICAgYm91bmRzLnRvcCArIHBhZGRpbmdUb3AgKyBib3JkZXJzWzBdLndpZHRoLCAvLyBkeQogICAgICBib3VuZHMud2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCArIGJvcmRlcnNbM10ud2lkdGggKyBwYWRkaW5nTGVmdCArIHBhZGRpbmdSaWdodCksIC8vZHcKICAgICAgYm91bmRzLmhlaWdodCAtIChib3JkZXJzWzBdLndpZHRoICsgYm9yZGVyc1syXS53aWR0aCArIHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tKSAvL2RoCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiBnZXRCb3JkZXJEYXRhKGVsZW1lbnQpIHsKICAgIHJldHVybiBbIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCJdLm1hcChmdW5jdGlvbihzaWRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgd2lkdGg6IGdldENTU0ludChlbGVtZW50LCAnYm9yZGVyJyArIHNpZGUgKyAnV2lkdGgnKSwKICAgICAgICBjb2xvcjogZ2V0Q1NTKGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdDb2xvcicpCiAgICAgIH07CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlclJhZGl1c0RhdGEoZWxlbWVudCkgewogICAgcmV0dXJuIFsiVG9wTGVmdCIsICJUb3BSaWdodCIsICJCb3R0b21SaWdodCIsICJCb3R0b21MZWZ0Il0ubWFwKGZ1bmN0aW9uKHNpZGUpIHsKICAgICAgcmV0dXJuIGdldENTUyhlbGVtZW50LCAnYm9yZGVyJyArIHNpZGUgKyAnUmFkaXVzJyk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEN1cnZlUG9pbnRzKHgsIHksIHIxLCByMikgewogICAgdmFyIGthcHBhID0gNCAqICgoTWF0aC5zcXJ0KDIpIC0gMSkgLyAzKTsKICAgIHZhciBveCA9IChyMSkgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgaG9yaXpvbnRhbAogICAgb3kgPSAocjIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IHZlcnRpY2FsCiAgICB4bSA9IHggKyByMSwgLy8geC1taWRkbGUKICAgIHltID0geSArIHIyOyAvLyB5LW1pZGRsZQogICAgcmV0dXJuIHsKICAgICAgdG9wTGVmdDogYmV6aWVyQ3VydmUoewogICAgICAgIHg6eCwKICAgICAgICB5OnltCiAgICAgIH0sIHsKICAgICAgICB4OngsCiAgICAgICAgeTp5bSAtIG95CiAgICAgIH0sIHsKICAgICAgICB4OnhtIC0gb3gsCiAgICAgICAgeTp5CiAgICAgIH0sIHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eQogICAgICB9KSwKICAgICAgdG9wUmlnaHQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OngsCiAgICAgICAgeTp5CiAgICAgIH0sIHsKICAgICAgICB4OnggKyBveCwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5bSAtIG95CiAgICAgIH0sIHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eW0KICAgICAgfSksCiAgICAgIGJvdHRvbVJpZ2h0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5ICsgb3kKICAgICAgfSwgewogICAgICAgIHg6eCArIG94LAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnltCiAgICAgIH0pLAogICAgICBib3R0b21MZWZ0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnltCiAgICAgIH0sIHsKICAgICAgICB4OnhtIC0gb3gsCiAgICAgICAgeTp5bQogICAgICB9LCB7CiAgICAgICAgeDp4LAogICAgICAgIHk6eSArIG95CiAgICAgIH0sIHsKICAgICAgICB4OngsCiAgICAgICAgeTp5CiAgICAgIH0pCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gYmV6aWVyQ3VydmUoc3RhcnQsIHN0YXJ0Q29udHJvbCwgZW5kQ29udHJvbCwgZW5kKSB7CgogICAgdmFyIGxlcnAgPSBmdW5jdGlvbiAoYSwgYiwgdCkgewogICAgICByZXR1cm4gewogICAgICAgIHg6YS54ICsgKGIueCAtIGEueCkgKiB0LAogICAgICAgIHk6YS55ICsgKGIueSAtIGEueSkgKiB0CiAgICAgIH07CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgc3RhcnRDb250cm9sOiBzdGFydENvbnRyb2wsCiAgICAgIGVuZENvbnRyb2w6IGVuZENvbnRyb2wsCiAgICAgIGVuZDogZW5kLAogICAgICBzdWJkaXZpZGU6IGZ1bmN0aW9uKHQpIHsKICAgICAgICB2YXIgYWIgPSBsZXJwKHN0YXJ0LCBzdGFydENvbnRyb2wsIHQpLAogICAgICAgIGJjID0gbGVycChzdGFydENvbnRyb2wsIGVuZENvbnRyb2wsIHQpLAogICAgICAgIGNkID0gbGVycChlbmRDb250cm9sLCBlbmQsIHQpLAogICAgICAgIGFiYmMgPSBsZXJwKGFiLCBiYywgdCksCiAgICAgICAgYmNjZCA9IGxlcnAoYmMsIGNkLCB0KSwKICAgICAgICBkZXN0ID0gbGVycChhYmJjLCBiY2NkLCB0KTsKICAgICAgICByZXR1cm4gW2JlemllckN1cnZlKHN0YXJ0LCBhYiwgYWJiYywgZGVzdCksIGJlemllckN1cnZlKGRlc3QsIGJjY2QsIGNkLCBlbmQpXTsKICAgICAgfSwKICAgICAgY3VydmVUbzogZnVuY3Rpb24oYm9yZGVyQXJncykgewogICAgICAgIGJvcmRlckFyZ3MucHVzaChbImJlemllckN1cnZlIiwgc3RhcnRDb250cm9sLngsIHN0YXJ0Q29udHJvbC55LCBlbmRDb250cm9sLngsIGVuZENvbnRyb2wueSwgZW5kLngsIGVuZC55XSk7CiAgICAgIH0sCiAgICAgIGN1cnZlVG9SZXZlcnNlZDogZnVuY3Rpb24oYm9yZGVyQXJncykgewogICAgICAgIGJvcmRlckFyZ3MucHVzaChbImJlemllckN1cnZlIiwgZW5kQ29udHJvbC54LCBlbmRDb250cm9sLnksIHN0YXJ0Q29udHJvbC54LCBzdGFydENvbnRyb2wueSwgc3RhcnQueCwgc3RhcnQueV0pOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzMSwgcmFkaXVzMiwgY29ybmVyMSwgY29ybmVyMiwgeCwgeSkgewogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBjb3JuZXIxWzBdLnN0YXJ0LngsIGNvcm5lcjFbMF0uc3RhcnQueV0pOwogICAgICBjb3JuZXIxWzBdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICAgIGNvcm5lcjFbMV0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCB4LCB5XSk7CiAgICB9CgogICAgaWYgKHJhZGl1czJbMF0gPiAwIHx8IHJhZGl1czJbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBjb3JuZXIyWzBdLnN0YXJ0LngsIGNvcm5lcjJbMF0uc3RhcnQueV0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZHJhd1NpZGUoYm9yZGVyRGF0YSwgcmFkaXVzMSwgcmFkaXVzMiwgb3V0ZXIxLCBpbm5lcjEsIG91dGVyMiwgaW5uZXIyKSB7CiAgICB2YXIgYm9yZGVyQXJncyA9IFtdOwoKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgb3V0ZXIxWzFdLnN0YXJ0LngsIG91dGVyMVsxXS5zdGFydC55XSk7CiAgICAgIG91dGVyMVsxXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMxWzBdLCBib3JkZXJEYXRhLmMxWzFdXSk7CiAgICB9CgogICAgaWYgKHJhZGl1czJbMF0gPiAwIHx8IHJhZGl1czJbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBvdXRlcjJbMF0uc3RhcnQueCwgb3V0ZXIyWzBdLnN0YXJ0LnldKTsKICAgICAgb3V0ZXIyWzBdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBpbm5lcjJbMF0uZW5kLngsIGlubmVyMlswXS5lbmQueV0pOwogICAgICBpbm5lcjJbMF0uY3VydmVUb1JldmVyc2VkKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMyWzBdLCBib3JkZXJEYXRhLmMyWzFdXSk7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jM1swXSwgYm9yZGVyRGF0YS5jM1sxXV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgaW5uZXIxWzFdLmVuZC54LCBpbm5lcjFbMV0uZW5kLnldKTsKICAgICAgaW5uZXIxWzFdLmN1cnZlVG9SZXZlcnNlZChib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jNFswXSwgYm9yZGVyRGF0YS5jNFsxXV0pOwogICAgfQoKICAgIHJldHVybiBib3JkZXJBcmdzOwogIH0KCiAgZnVuY3Rpb24gY2FsY3VsYXRlQ3VydmVQb2ludHMoYm91bmRzLCBib3JkZXJSYWRpdXMsIGJvcmRlcnMpIHsKCiAgICB2YXIgeCA9IGJvdW5kcy5sZWZ0LAogICAgeSA9IGJvdW5kcy50b3AsCiAgICB3aWR0aCA9IGJvdW5kcy53aWR0aCwKICAgIGhlaWdodCA9IGJvdW5kcy5oZWlnaHQsCgogICAgdGxoID0gYm9yZGVyUmFkaXVzWzBdWzBdLAogICAgdGx2ID0gYm9yZGVyUmFkaXVzWzBdWzFdLAogICAgdHJoID0gYm9yZGVyUmFkaXVzWzFdWzBdLAogICAgdHJ2ID0gYm9yZGVyUmFkaXVzWzFdWzFdLAogICAgYnJoID0gYm9yZGVyUmFkaXVzWzJdWzBdLAogICAgYnJ2ID0gYm9yZGVyUmFkaXVzWzJdWzFdLAogICAgYmxoID0gYm9yZGVyUmFkaXVzWzNdWzBdLAogICAgYmx2ID0gYm9yZGVyUmFkaXVzWzNdWzFdLAoKICAgIHRvcFdpZHRoID0gd2lkdGggLSB0cmgsCiAgICByaWdodEhlaWdodCA9IGhlaWdodCAtIGJydiwKICAgIGJvdHRvbVdpZHRoID0gd2lkdGggLSBicmgsCiAgICBsZWZ0SGVpZ2h0ID0gaGVpZ2h0IC0gYmx2OwoKICAgIHJldHVybiB7CiAgICAgIHRvcExlZnRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIHRsaCwKICAgICAgICB0bHYKICAgICAgICApLnRvcExlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BMZWZ0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHkgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICAgIE1hdGgubWF4KDAsIHRsaCAtIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIHRsdiAtIGJvcmRlcnNbMF0ud2lkdGgpCiAgICAgICAgKS50b3BMZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wUmlnaHRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIHRvcFdpZHRoLAogICAgICAgIHksCiAgICAgICAgdHJoLAogICAgICAgIHRydgogICAgICAgICkudG9wUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BSaWdodElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgTWF0aC5taW4odG9wV2lkdGgsIHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgKHRvcFdpZHRoID4gd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSA/IDAgOnRyaCAtIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgdHJ2IC0gYm9yZGVyc1swXS53aWR0aAogICAgICAgICkudG9wUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21SaWdodE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm90dG9tV2lkdGgsCiAgICAgICAgeSArIHJpZ2h0SGVpZ2h0LAogICAgICAgIGJyaCwKICAgICAgICBicnYKICAgICAgICApLmJvdHRvbVJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tUmlnaHRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIE1hdGgubWluKGJvdHRvbVdpZHRoLCB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIHkgKyBNYXRoLm1pbihyaWdodEhlaWdodCwgaGVpZ2h0ICsgYm9yZGVyc1swXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYnJoIC0gYm9yZGVyc1sxXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYnJ2IC0gYm9yZGVyc1syXS53aWR0aCkKICAgICAgICApLmJvdHRvbVJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tTGVmdE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4LAogICAgICAgIHkgKyBsZWZ0SGVpZ2h0LAogICAgICAgIGJsaCwKICAgICAgICBibHYKICAgICAgICApLmJvdHRvbUxlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21MZWZ0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHkgKyBsZWZ0SGVpZ2h0LAogICAgICAgIE1hdGgubWF4KDAsIGJsaCAtIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJsdiAtIGJvcmRlcnNbMl0ud2lkdGgpCiAgICAgICAgKS5ib3R0b21MZWZ0LnN1YmRpdmlkZSgwLjUpCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyQ2xpcChlbGVtZW50LCBib3JkZXJQb2ludHMsIGJvcmRlcnMsIHJhZGl1cywgYm91bmRzKSB7CiAgICB2YXIgYmFja2dyb3VuZENsaXAgPSBnZXRDU1MoZWxlbWVudCwgJ2JhY2tncm91bmRDbGlwJyksCiAgICBib3JkZXJBcmdzID0gW107CgogICAgc3dpdGNoKGJhY2tncm91bmRDbGlwKSB7CiAgICAgIGNhc2UgImNvbnRlbnQtYm94IjoKICAgICAgY2FzZSAicGFkZGluZy1ib3giOgogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1swXSwgcmFkaXVzWzFdLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLCBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzFdLCByYWRpdXNbMl0sIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGggLSBib3JkZXJzWzFdLndpZHRoLCBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzJdLCByYWRpdXNbM10sIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCAtIGJvcmRlcnNbMV0ud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0IC0gYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzNdLCByYWRpdXNbMF0sIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQgLSBib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzBdLCByYWRpdXNbMV0sIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzFdLCByYWRpdXNbMl0sIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGgsIGJvdW5kcy50b3ApOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1syXSwgcmFkaXVzWzNdLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbM10sIHJhZGl1c1swXSwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gYm9yZGVyQXJnczsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQm9yZGVycyhlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpewogICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgIHkgPSBib3VuZHMudG9wLAogICAgd2lkdGggPSBib3VuZHMud2lkdGgsCiAgICBoZWlnaHQgPSBib3VuZHMuaGVpZ2h0LAogICAgYm9yZGVyU2lkZSwKICAgIGJ4LAogICAgYnksCiAgICBidywKICAgIGJoLAogICAgYm9yZGVyQXJncywKICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtYmFja2dyb3VuZC8jdGhlLWJvcmRlci1yYWRpdXMKICAgIGJvcmRlclJhZGl1cyA9IGdldEJvcmRlclJhZGl1c0RhdGEoZWxlbWVudCksCiAgICBib3JkZXJQb2ludHMgPSBjYWxjdWxhdGVDdXJ2ZVBvaW50cyhib3VuZHMsIGJvcmRlclJhZGl1cywgYm9yZGVycyksCiAgICBib3JkZXJEYXRhID0gewogICAgICBjbGlwOiBnZXRCb3JkZXJDbGlwKGVsZW1lbnQsIGJvcmRlclBvaW50cywgYm9yZGVycywgYm9yZGVyUmFkaXVzLCBib3VuZHMpLAogICAgICBib3JkZXJzOiBbXQogICAgfTsKCiAgICBmb3IgKGJvcmRlclNpZGUgPSAwOyBib3JkZXJTaWRlIDwgNDsgYm9yZGVyU2lkZSsrKSB7CgogICAgICBpZiAoYm9yZGVyc1tib3JkZXJTaWRlXS53aWR0aCA+IDApIHsKICAgICAgICBieCA9IHg7CiAgICAgICAgYnkgPSB5OwogICAgICAgIGJ3ID0gd2lkdGg7CiAgICAgICAgYmggPSBoZWlnaHQgLSAoYm9yZGVyc1syXS53aWR0aCk7CgogICAgICAgIHN3aXRjaChib3JkZXJTaWRlKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIC8vIHRvcCBib3JkZXIKICAgICAgICAgICAgYmggPSBib3JkZXJzWzBdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4LCBieV0sCiAgICAgICAgICAgICAgYzI6IFtieCArIGJ3LCBieV0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJ3IC0gYm9yZGVyc1sxXS53aWR0aCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJvcmRlcnNbM10ud2lkdGgsIGJ5ICsgYmhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1swXSwgYm9yZGVyUmFkaXVzWzFdLAogICAgICAgICAgICBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgLy8gcmlnaHQgYm9yZGVyCiAgICAgICAgICAgIGJ4ID0geCArIHdpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGgpOwogICAgICAgICAgICBidyA9IGJvcmRlcnNbMV0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYnggKyBidywgYnldLAogICAgICAgICAgICAgIGMyOiBbYnggKyBidywgYnkgKyBiaCArIGJvcmRlcnNbMl0ud2lkdGhdLAogICAgICAgICAgICAgIGMzOiBbYngsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGM0OiBbYngsIGJ5ICsgYm9yZGVyc1swXS53aWR0aF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzFdLCBib3JkZXJSYWRpdXNbMl0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIC8vIGJvdHRvbSBib3JkZXIKICAgICAgICAgICAgYnkgPSAoYnkgKyBoZWlnaHQpIC0gKGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgICAgICBiaCA9IGJvcmRlcnNbMl0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYnggKyBidywgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzI6IFtieCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJvcmRlcnNbM10ud2lkdGgsIGJ5XSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYncgLSBib3JkZXJzWzNdLndpZHRoLCBieV0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzJdLCBib3JkZXJSYWRpdXNbM10sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAvLyBsZWZ0IGJvcmRlcgogICAgICAgICAgICBidyA9IGJvcmRlcnNbM10ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYngsIGJ5ICsgYmggKyBib3JkZXJzWzJdLndpZHRoXSwKICAgICAgICAgICAgICBjMjogW2J4LCBieV0sCiAgICAgICAgICAgICAgYzM6IFtieCArIGJ3LCBieSArIGJvcmRlcnNbMF0ud2lkdGhdLAogICAgICAgICAgICAgIGM0OiBbYnggKyBidywgYnkgKyBiaF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzNdLCBib3JkZXJSYWRpdXNbMF0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGJvcmRlckRhdGEuYm9yZGVycy5wdXNoKHsKICAgICAgICAgIGFyZ3M6IGJvcmRlckFyZ3MsCiAgICAgICAgICBjb2xvcjogYm9yZGVyc1tib3JkZXJTaWRlXS5jb2xvcgogICAgICAgIH0pOwoKICAgICAgfQogICAgfQoKICAgIHJldHVybiBib3JkZXJEYXRhOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlU2hhcGUoY3R4LCBhcmdzKSB7CiAgICB2YXIgc2hhcGUgPSBjdHguZHJhd1NoYXBlKCk7CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYm9yZGVyLCBpbmRleCkgewogICAgICBzaGFwZVsoaW5kZXggPT09IDApID8gIm1vdmVUbyIgOiBib3JkZXJbMF0gKyAiVG8iIF0uYXBwbHkobnVsbCwgYm9yZGVyLnNsaWNlKDEpKTsKICAgIH0pOwogICAgcmV0dXJuIHNoYXBlOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQm9yZGVycyhjdHgsIGJvcmRlckFyZ3MsIGNvbG9yKSB7CiAgICBpZiAoY29sb3IgIT09ICJ0cmFuc3BhcmVudCIpIHsKICAgICAgY3R4LnNldFZhcmlhYmxlKCAiZmlsbFN0eWxlIiwgY29sb3IpOwogICAgICBjcmVhdGVTaGFwZShjdHgsIGJvcmRlckFyZ3MpOwogICAgICBjdHguZmlsbCgpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckZvcm1WYWx1ZSAoZWwsIGJvdW5kcywgc3RhY2spewoKICAgIHZhciB2YWx1ZVdyYXAgPSBkb2MuY3JlYXRlRWxlbWVudCgndmFsdWV3cmFwJyksCiAgICBjc3NQcm9wZXJ0eUFycmF5ID0gWydsaW5lSGVpZ2h0JywndGV4dEFsaWduJywnZm9udEZhbWlseScsJ2NvbG9yJywnZm9udFNpemUnLCdwYWRkaW5nTGVmdCcsJ3BhZGRpbmdUb3AnLCd3aWR0aCcsJ2hlaWdodCcsJ2JvcmRlcicsJ2JvcmRlckxlZnRXaWR0aCcsJ2JvcmRlclRvcFdpZHRoJ10sCiAgICB0ZXh0VmFsdWUsCiAgICB0ZXh0Tm9kZTsKCiAgICBjc3NQcm9wZXJ0eUFycmF5LmZvckVhY2goZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YWx1ZVdyYXAuc3R5bGVbcHJvcGVydHldID0gZ2V0Q1NTKGVsLCBwcm9wZXJ0eSk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIC8vIE9sZGVyIElFIGhhcyBpc3N1ZXMgd2l0aCAiYm9yZGVyIgogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUGFyc2U6IEV4Y2VwdGlvbiBjYXVnaHQgaW4gcmVuZGVyRm9ybVZhbHVlOiAiICsgZS5tZXNzYWdlKTsKICAgICAgfQogICAgfSk7CgogICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlckNvbG9yID0gImJsYWNrIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJTdHlsZSA9ICJzb2xpZCI7CiAgICB2YWx1ZVdyYXAuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICB2YWx1ZVdyYXAuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwoKICAgIGlmICgvXihzdWJtaXR8cmVzZXR8YnV0dG9ufHRleHR8cGFzc3dvcmQpJC8udGVzdChlbC50eXBlKSB8fCBlbC5ub2RlTmFtZSA9PT0gIlNFTEVDVCIpewogICAgICB2YWx1ZVdyYXAuc3R5bGUubGluZUhlaWdodCA9IGdldENTUyhlbCwgImhlaWdodCIpOwogICAgfQoKICAgIHZhbHVlV3JhcC5zdHlsZS50b3AgPSBib3VuZHMudG9wICsgInB4IjsKICAgIHZhbHVlV3JhcC5zdHlsZS5sZWZ0ID0gYm91bmRzLmxlZnQgKyAicHgiOwoKICAgIHRleHRWYWx1ZSA9IChlbC5ub2RlTmFtZSA9PT0gIlNFTEVDVCIpID8gKGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0gfHwgMCkudGV4dCA6IGVsLnZhbHVlOwogICAgaWYoIXRleHRWYWx1ZSkgewogICAgICB0ZXh0VmFsdWUgPSBlbC5wbGFjZWhvbGRlcjsKICAgIH0KCiAgICB0ZXh0Tm9kZSA9IGRvYy5jcmVhdGVUZXh0Tm9kZSh0ZXh0VmFsdWUpOwoKICAgIHZhbHVlV3JhcC5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICBib2R5LmFwcGVuZENoaWxkKHZhbHVlV3JhcCk7CgogICAgcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKTsKICAgIGJvZHkucmVtb3ZlQ2hpbGQodmFsdWVXcmFwKTsKICB9CgogIGZ1bmN0aW9uIGRyYXdJbWFnZSAoY3R4KSB7CiAgICBjdHguZHJhd0ltYWdlLmFwcGx5KGN0eCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBudW1EcmF3cys9MTsKICB9CgogIGZ1bmN0aW9uIGdldFBzZXVkb0VsZW1lbnQoZWwsIHdoaWNoKSB7CiAgICB2YXIgZWxTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsLCB3aGljaCk7CiAgICB2YXIgcGFyZW50U3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCk7CiAgICAvLyBJZiBubyBjb250ZW50IGF0dHJpYnV0ZSBpcyBwcmVzZW50LCB0aGUgcHNldWRvIGVsZW1lbnQgaXMgaGlkZGVuLAogICAgLy8gb3IgdGhlIHBhcmVudCBoYXMgYSBjb250ZW50IHByb3BlcnR5IGVxdWFsIHRvIHRoZSBjb250ZW50IG9uIHRoZSBwc2V1ZG8gZWxlbWVudCwKICAgIC8vIG1vdmUgYWxvbmcuCiAgICBpZighZWxTdHlsZSB8fCAhZWxTdHlsZS5jb250ZW50IHx8IGVsU3R5bGUuY29udGVudCA9PT0gIm5vbmUiIHx8IGVsU3R5bGUuY29udGVudCA9PT0gIi1tb3otYWx0LWNvbnRlbnQiIHx8CiAgICAgICBlbFN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fCBwYXJlbnRTdHlsZS5jb250ZW50ID09PSBlbFN0eWxlLmNvbnRlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGNvbnRlbnQgPSBlbFN0eWxlLmNvbnRlbnQgKyAnJzsKCiAgICAvLyBTdHJpcCBpbm5lciBxdW90ZXMKICAgIGlmKGNvbnRlbnRbMF0gPT09ICInIiB8fCBjb250ZW50WzBdID09PSAiXCIiKSB7CiAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoLyheWyciXSl8KFsnIl0kKS9nLCAnJyk7CiAgICB9CgogICAgdmFyIGlzSW1hZ2UgPSBjb250ZW50LnN1YnN0ciggMCwgMyApID09PSAndXJsJywKICAgIGVscHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBpc0ltYWdlID8gJ2ltZycgOiAnc3BhbicgKTsKCiAgICBlbHBzLmNsYXNzTmFtZSA9IHBzZXVkb0hpZGUgKyAiLWVsZW1lbnQgIjsKCiAgICBPYmplY3Qua2V5cyhlbFN0eWxlKS5maWx0ZXIoaW5kZXhlZFByb3BlcnR5KS5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgLy8gUHJldmVudCBhc3NpZ25pbmcgb2YgcmVhZCBvbmx5IENTUyBSdWxlcywgZXguIGxlbmd0aCwgcGFyZW50UnVsZQogICAgICB0cnkgewogICAgICAgIGVscHMuc3R5bGVbcHJvcF0gPSBlbFN0eWxlW3Byb3BdOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgVXRpbC5sb2coWydUcmllZCB0byBhc3NpZ24gcmVhZG9ubHkgcHJvcGVydHkgJywgcHJvcCwgJ0Vycm9yOicsIGVdKTsKICAgICAgfQogICAgfSk7CgogICAgaWYoaXNJbWFnZSkgewogICAgICBlbHBzLnNyYyA9IFV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoY29udGVudClbMF0uYXJnc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIGVscHMuaW5uZXJIVE1MID0gY29udGVudDsKICAgIH0KICAgIHJldHVybiBlbHBzOwogIH0KCiAgZnVuY3Rpb24gaW5kZXhlZFByb3BlcnR5KHByb3BlcnR5KSB7CiAgICByZXR1cm4gKGlzTmFOKHdpbmRvdy5wYXJzZUludChwcm9wZXJ0eSwgMTApKSk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0KGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzKSB7CiAgICB2YXIgb2Zmc2V0WCA9IE1hdGgucm91bmQoYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCksCiAgICBvZmZzZXRZID0gTWF0aC5yb3VuZChib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCk7CgogICAgY3R4LmNyZWF0ZVBhdHRlcm4oaW1hZ2UpOwogICAgY3R4LnRyYW5zbGF0ZShvZmZzZXRYLCBvZmZzZXRZKTsKICAgIGN0eC5maWxsKCk7CiAgICBjdHgudHJhbnNsYXRlKC1vZmZzZXRYLCAtb2Zmc2V0WSk7CiAgfQoKICBmdW5jdGlvbiBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsIGxlZnQsIHRvcCwgd2lkdGgsIGhlaWdodCkgewogICAgdmFyIGFyZ3MgPSBbXTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQpLCBNYXRoLnJvdW5kKHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQgKyB3aWR0aCksIE1hdGgucm91bmQodG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCArIHdpZHRoKSwgTWF0aC5yb3VuZChoZWlnaHQgKyB0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0KSwgTWF0aC5yb3VuZChoZWlnaHQgKyB0b3ApXSk7CiAgICBjcmVhdGVTaGFwZShjdHgsIGFyZ3MpOwogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5jbGlwKCk7CiAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0KGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzKTsKICAgIGN0eC5yZXN0b3JlKCk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kQ29sb3IoY3R4LCBiYWNrZ3JvdW5kQm91bmRzLCBiZ2NvbG9yKSB7CiAgICByZW5kZXJSZWN0KAogICAgICBjdHgsCiAgICAgIGJhY2tncm91bmRCb3VuZHMubGVmdCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy50b3AsCiAgICAgIGJhY2tncm91bmRCb3VuZHMud2lkdGgsCiAgICAgIGJhY2tncm91bmRCb3VuZHMuaGVpZ2h0LAogICAgICBiZ2NvbG9yCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0aW5nKGVsLCBib3VuZHMsIGN0eCwgaW1hZ2UsIGltYWdlSW5kZXgpIHsKICAgIHZhciBiYWNrZ3JvdW5kU2l6ZSA9IFV0aWwuQmFja2dyb3VuZFNpemUoZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgpLAogICAgYmFja2dyb3VuZFBvc2l0aW9uID0gVXRpbC5CYWNrZ3JvdW5kUG9zaXRpb24oZWwsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgsIGJhY2tncm91bmRTaXplKSwKICAgIGJhY2tncm91bmRSZXBlYXQgPSBVdGlsLkJhY2tncm91bmRSZXBlYXQoZWwsIGltYWdlSW5kZXgpOwoKICAgIGltYWdlID0gcmVzaXplSW1hZ2UoaW1hZ2UsIGJhY2tncm91bmRTaXplKTsKCiAgICBzd2l0Y2ggKGJhY2tncm91bmRSZXBlYXQpIHsKICAgICAgY2FzZSAicmVwZWF0LXgiOgogICAgICBjYXNlICJyZXBlYXQgbm8tcmVwZWF0IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCwgYm91bmRzLnRvcCArIGJhY2tncm91bmRQb3NpdGlvbi50b3AsIDk5OTk5LCBpbWFnZS5oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJyZXBlYXQteSI6CiAgICAgIGNhc2UgIm5vLXJlcGVhdCByZXBlYXQiOgogICAgICAgIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywKICAgICAgICAgIGJvdW5kcy5sZWZ0ICsgYmFja2dyb3VuZFBvc2l0aW9uLmxlZnQsIGJvdW5kcy50b3AsIGltYWdlLndpZHRoLCA5OTk5OSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIm5vLXJlcGVhdCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCwgYm91bmRzLnRvcCArIGJhY2tncm91bmRQb3NpdGlvbi50b3AsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCB7CiAgICAgICAgICB0b3A6IGJvdW5kcy50b3AsCiAgICAgICAgICBsZWZ0OiBib3VuZHMubGVmdCwKICAgICAgICAgIHdpZHRoOiBpbWFnZS53aWR0aCwKICAgICAgICAgIGhlaWdodDogaW1hZ2UuaGVpZ2h0CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kSW1hZ2UoZWxlbWVudCwgYm91bmRzLCBjdHgpIHsKICAgIHZhciBiYWNrZ3JvdW5kSW1hZ2UgPSBnZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRJbWFnZSIpLAogICAgYmFja2dyb3VuZEltYWdlcyA9IFV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZEltYWdlKSwKICAgIGltYWdlLAogICAgaW1hZ2VJbmRleCA9IGJhY2tncm91bmRJbWFnZXMubGVuZ3RoOwoKICAgIHdoaWxlKGltYWdlSW5kZXgtLSkgewogICAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBiYWNrZ3JvdW5kSW1hZ2VzW2ltYWdlSW5kZXhdOwoKICAgICAgaWYgKCFiYWNrZ3JvdW5kSW1hZ2UuYXJncyB8fCBiYWNrZ3JvdW5kSW1hZ2UuYXJncy5sZW5ndGggPT09IDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIGtleSA9IGJhY2tncm91bmRJbWFnZS5tZXRob2QgPT09ICd1cmwnID8KICAgICAgYmFja2dyb3VuZEltYWdlLmFyZ3NbMF0gOgogICAgICBiYWNrZ3JvdW5kSW1hZ2UudmFsdWU7CgogICAgICBpbWFnZSA9IGxvYWRJbWFnZShrZXkpOwoKICAgICAgLy8gVE9ETyBhZGQgc3VwcG9ydCBmb3IgYmFja2dyb3VuZC1vcmlnaW4KICAgICAgaWYgKGltYWdlKSB7CiAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdGluZyhlbGVtZW50LCBib3VuZHMsIGN0eCwgaW1hZ2UsIGltYWdlSW5kZXgpOwogICAgICB9IGVsc2UgewogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyBiYWNrZ3JvdW5kOiIsIGJhY2tncm91bmRJbWFnZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc2l6ZUltYWdlKGltYWdlLCBib3VuZHMpIHsKICAgIGlmKGltYWdlLndpZHRoID09PSBib3VuZHMud2lkdGggJiYgaW1hZ2UuaGVpZ2h0ID09PSBib3VuZHMuaGVpZ2h0KSB7CiAgICAgIHJldHVybiBpbWFnZTsKICAgIH0KCiAgICB2YXIgY3R4LCBjYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICBjYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgZHJhd0ltYWdlKGN0eCwgaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOwogICAgcmV0dXJuIGNhbnZhczsKICB9CgogIGZ1bmN0aW9uIHNldE9wYWNpdHkoY3R4LCBlbGVtZW50LCBwYXJlbnRTdGFjaykgewogICAgcmV0dXJuIGN0eC5zZXRWYXJpYWJsZSgiZ2xvYmFsQWxwaGEiLCBnZXRDU1MoZWxlbWVudCwgIm9wYWNpdHkiKSAqICgocGFyZW50U3RhY2spID8gcGFyZW50U3RhY2sub3BhY2l0eSA6IDEpKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVB4KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKCJweCIsICIiKTsKICB9CgogIGZ1bmN0aW9uIGdldFRyYW5zZm9ybShlbGVtZW50LCBwYXJlbnRTdGFjaykgewogICAgdmFyIHRyYW5zZm9ybVJlZ0V4cCA9IC8obWF0cml4KVwoKC4rKVwpLzsKICAgIHZhciB0cmFuc2Zvcm0gPSBnZXRDU1MoZWxlbWVudCwgInRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLXdlYmtpdC10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tb3otdHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbXMtdHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItby10cmFuc2Zvcm0iKTsKICAgIHZhciB0cmFuc2Zvcm1PcmlnaW4gPSBnZXRDU1MoZWxlbWVudCwgInRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi13ZWJraXQtdHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1vei10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbXMtdHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLW8tdHJhbnNmb3JtLW9yaWdpbiIpIHx8ICIwcHggMHB4IjsKCiAgICB0cmFuc2Zvcm1PcmlnaW4gPSB0cmFuc2Zvcm1PcmlnaW4uc3BsaXQoIiAiKS5tYXAocmVtb3ZlUHgpLm1hcChVdGlsLmFzRmxvYXQpOwoKICAgIHZhciBtYXRyaXg7CiAgICBpZiAodHJhbnNmb3JtICYmIHRyYW5zZm9ybSAhPT0gIm5vbmUiKSB7CiAgICAgIHZhciBtYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCh0cmFuc2Zvcm1SZWdFeHApOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBzd2l0Y2gobWF0Y2hbMV0pIHsKICAgICAgICAgIGNhc2UgIm1hdHJpeCI6CiAgICAgICAgICAgIG1hdHJpeCA9IG1hdGNoWzJdLnNwbGl0KCIsIikubWFwKFV0aWwudHJpbVRleHQpLm1hcChVdGlsLmFzRmxvYXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBvcmlnaW46IHRyYW5zZm9ybU9yaWdpbiwKICAgICAgbWF0cml4OiBtYXRyaXgKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTdGFjayhlbGVtZW50LCBwYXJlbnRTdGFjaywgYm91bmRzLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBjdHggPSBoMmNSZW5kZXJDb250ZXh0KCghcGFyZW50U3RhY2spID8gZG9jdW1lbnRXaWR0aCgpIDogYm91bmRzLndpZHRoICwgKCFwYXJlbnRTdGFjaykgPyBkb2N1bWVudEhlaWdodCgpIDogYm91bmRzLmhlaWdodCksCiAgICBzdGFjayA9IHsKICAgICAgY3R4OiBjdHgsCiAgICAgIG9wYWNpdHk6IHNldE9wYWNpdHkoY3R4LCBlbGVtZW50LCBwYXJlbnRTdGFjayksCiAgICAgIGNzc1Bvc2l0aW9uOiBnZXRDU1MoZWxlbWVudCwgInBvc2l0aW9uIiksCiAgICAgIGJvcmRlcnM6IGdldEJvcmRlckRhdGEoZWxlbWVudCksCiAgICAgIHRyYW5zZm9ybTogdHJhbnNmb3JtLAogICAgICBjbGlwOiAocGFyZW50U3RhY2sgJiYgcGFyZW50U3RhY2suY2xpcCkgPyBVdGlsLkV4dGVuZCgge30sIHBhcmVudFN0YWNrLmNsaXAgKSA6IG51bGwKICAgIH07CgogICAgc2V0WihlbGVtZW50LCBzdGFjaywgcGFyZW50U3RhY2spOwoKICAgIC8vIFRPRE8gY29ycmVjdCBvdmVyZmxvdyBmb3IgYWJzb2x1dGUgY29udGVudCByZXNpZGluZyB1bmRlciBhIHN0YXRpYyBwb3NpdGlvbgogICAgaWYgKG9wdGlvbnMudXNlT3ZlcmZsb3cgPT09IHRydWUgJiYgLyhoaWRkZW58c2Nyb2xsfGF1dG8pLy50ZXN0KGdldENTUyhlbGVtZW50LCAib3ZlcmZsb3ciKSkgPT09IHRydWUgJiYgLyhCT0RZKS9pLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkgPT09IGZhbHNlKXsKICAgICAgc3RhY2suY2xpcCA9IChzdGFjay5jbGlwKSA/IGNsaXBCb3VuZHMoc3RhY2suY2xpcCwgYm91bmRzKSA6IGJvdW5kczsKICAgIH0KCiAgICByZXR1cm4gc3RhY2s7CiAgfQoKICBmdW5jdGlvbiBnZXRCYWNrZ3JvdW5kQm91bmRzKGJvcmRlcnMsIGJvdW5kcywgY2xpcCkgewogICAgdmFyIGJhY2tncm91bmRCb3VuZHMgPSB7CiAgICAgIGxlZnQ6IGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgdG9wOiBib3VuZHMudG9wICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgd2lkdGg6IGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgIGhlaWdodDogYm91bmRzLmhlaWdodCAtIChib3JkZXJzWzBdLndpZHRoICsgYm9yZGVyc1syXS53aWR0aCkKICAgIH07CgogICAgaWYgKGNsaXApIHsKICAgICAgYmFja2dyb3VuZEJvdW5kcyA9IGNsaXBCb3VuZHMoYmFja2dyb3VuZEJvdW5kcywgY2xpcCk7CiAgICB9CgogICAgcmV0dXJuIGJhY2tncm91bmRCb3VuZHM7CiAgfQoKICBmdW5jdGlvbiBnZXRCb3VuZHMoZWxlbWVudCwgdHJhbnNmb3JtKSB7CiAgICB2YXIgYm91bmRzID0gKHRyYW5zZm9ybS5tYXRyaXgpID8gVXRpbC5PZmZzZXRCb3VuZHMoZWxlbWVudCkgOiBVdGlsLkJvdW5kcyhlbGVtZW50KTsKICAgIHRyYW5zZm9ybS5vcmlnaW5bMF0gKz0gYm91bmRzLmxlZnQ7CiAgICB0cmFuc2Zvcm0ub3JpZ2luWzFdICs9IGJvdW5kcy50b3A7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyRWxlbWVudChlbGVtZW50LCBwYXJlbnRTdGFjaywgaWdub3JlQmFja2dyb3VuZCkgewogICAgdmFyIHRyYW5zZm9ybSA9IGdldFRyYW5zZm9ybShlbGVtZW50LCBwYXJlbnRTdGFjayksCiAgICBib3VuZHMgPSBnZXRCb3VuZHMoZWxlbWVudCwgdHJhbnNmb3JtKSwKICAgIGltYWdlLAogICAgc3RhY2sgPSBjcmVhdGVTdGFjayhlbGVtZW50LCBwYXJlbnRTdGFjaywgYm91bmRzLCB0cmFuc2Zvcm0pLAogICAgYm9yZGVycyA9IHN0YWNrLmJvcmRlcnMsCiAgICBjdHggPSBzdGFjay5jdHgsCiAgICBiYWNrZ3JvdW5kQm91bmRzID0gZ2V0QmFja2dyb3VuZEJvdW5kcyhib3JkZXJzLCBib3VuZHMsIHN0YWNrLmNsaXApLAogICAgYm9yZGVyRGF0YSA9IHBhcnNlQm9yZGVycyhlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpLAogICAgYmFja2dyb3VuZENvbG9yID0gKGlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpID8gIiNlZmVmZWYiIDogZ2V0Q1NTKGVsZW1lbnQsICJiYWNrZ3JvdW5kQ29sb3IiKTsKCgogICAgY3JlYXRlU2hhcGUoY3R4LCBib3JkZXJEYXRhLmNsaXApOwoKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguY2xpcCgpOwoKICAgIGlmIChiYWNrZ3JvdW5kQm91bmRzLmhlaWdodCA+IDAgJiYgYmFja2dyb3VuZEJvdW5kcy53aWR0aCA+IDAgJiYgIWlnbm9yZUJhY2tncm91bmQpIHsKICAgICAgcmVuZGVyQmFja2dyb3VuZENvbG9yKGN0eCwgYm91bmRzLCBiYWNrZ3JvdW5kQ29sb3IpOwogICAgICByZW5kZXJCYWNrZ3JvdW5kSW1hZ2UoZWxlbWVudCwgYmFja2dyb3VuZEJvdW5kcywgY3R4KTsKICAgIH0gZWxzZSBpZiAoaWdub3JlQmFja2dyb3VuZCkgewogICAgICBzdGFjay5iYWNrZ3JvdW5kQ29sb3IgPSAgYmFja2dyb3VuZENvbG9yOwogICAgfQoKICAgIGN0eC5yZXN0b3JlKCk7CgogICAgYm9yZGVyRGF0YS5ib3JkZXJzLmZvckVhY2goZnVuY3Rpb24oYm9yZGVyKSB7CiAgICAgIHJlbmRlckJvcmRlcnMoY3R4LCBib3JkZXIuYXJncywgYm9yZGVyLmNvbG9yKTsKICAgIH0pOwoKICAgIHN3aXRjaChlbGVtZW50Lm5vZGVOYW1lKXsKICAgICAgY2FzZSAiSU1HIjoKICAgICAgICBpZiAoKGltYWdlID0gbG9hZEltYWdlKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdzcmMnKSkpKSB7CiAgICAgICAgICByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGltYWdlLCBib3VuZHMsIGJvcmRlcnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgPGltZz46IiArIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdzcmMnKSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJJTlBVVCI6CiAgICAgICAgLy8gVE9ETyBhZGQgYWxsIHJlbGV2YW50IHR5cGUncywgaS5lLiBIVE1MNSBuZXcgc3R1ZmYKICAgICAgICAvLyB0b2RvIGFkZCBzdXBwb3J0IGZvciBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgZm9yIGJyb3dzZXJzIHdoaWNoIHN1cHBvcnQgaXQKICAgICAgICBpZiAoL14odGV4dHx1cmx8ZW1haWx8c3VibWl0fGJ1dHRvbnxyZXNldCkkLy50ZXN0KGVsZW1lbnQudHlwZSkgJiYgKGVsZW1lbnQudmFsdWUgfHwgZWxlbWVudC5wbGFjZWhvbGRlciB8fCAiIikubGVuZ3RoID4gMCl7CiAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWxlbWVudCwgYm91bmRzLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJURVhUQVJFQSI6CiAgICAgICAgaWYgKChlbGVtZW50LnZhbHVlIHx8IGVsZW1lbnQucGxhY2Vob2xkZXIgfHwgIiIpLmxlbmd0aCA+IDApewogICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsZW1lbnQsIGJvdW5kcywgc3RhY2spOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiU0VMRUNUIjoKICAgICAgICBpZiAoKGVsZW1lbnQub3B0aW9uc3x8ZWxlbWVudC5wbGFjZWhvbGRlciB8fCAiIikubGVuZ3RoID4gMCl7CiAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWxlbWVudCwgYm91bmRzLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJMSSI6CiAgICAgICAgcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGJhY2tncm91bmRCb3VuZHMpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJDQU5WQVMiOgogICAgICAgIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgZWxlbWVudCwgYm91bmRzLCBib3JkZXJzKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gc3RhY2s7CiAgfQoKICBmdW5jdGlvbiBpc0VsZW1lbnRWaXNpYmxlKGVsZW1lbnQpIHsKICAgIHJldHVybiAoZ2V0Q1NTKGVsZW1lbnQsICdkaXNwbGF5JykgIT09ICJub25lIiAmJiBnZXRDU1MoZWxlbWVudCwgJ3Zpc2liaWxpdHknKSAhPT0gImhpZGRlbiIgJiYgIWVsZW1lbnQuaGFzQXR0cmlidXRlKCJkYXRhLWh0bWwyY2FudmFzLWlnbm9yZSIpKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlRWxlbWVudCAoZWxlbWVudCwgc3RhY2ssIGNiKSB7CiAgICBpZiAoIWNiKSB7CiAgICAgIGNiID0gZnVuY3Rpb24oKXt9OwogICAgfQogICAgaWYgKGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkpIHsKICAgICAgc3RhY2sgPSByZW5kZXJFbGVtZW50KGVsZW1lbnQsIHN0YWNrLCBmYWxzZSkgfHwgc3RhY2s7CiAgICAgIGlmICghaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbGVtZW50Lm5vZGVOYW1lKSkgewogICAgICAgIHJldHVybiBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrLCBjYik7CiAgICAgIH0KICAgIH0KICAgIGNiKCk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrLCBjYikgewogICAgdmFyIGNoaWxkcmVuID0gVXRpbC5DaGlsZHJlbihlbGVtZW50KTsKICAgIC8vIEFmdGVyIGFsbCBub2RlcyBoYXZlIHByb2Nlc3NlZCwgZmluaXNoZWQoKSB3aWxsIGNhbGwgdGhlIGNiLgogICAgLy8gV2UgYWRkIG9uZSBhbmQga2ljayBpdCBvZmYgc28gdGhpcyB3aWxsIHN0aWxsIHdvcmsgd2hlbiBjaGlsZHJlbi5sZW5ndGggPT09IDAuCiAgICAvLyBOb3RlIHRoYXQgdW5sZXNzIGFzeW5jIGlzIHRydWUsIHRoaXMgd2lsbCBoYXBwZW4gc3luY2hyb25vdXNseSwganVzdCB3aWxsIGNhbGxiYWNrcy4KICAgIHZhciBqb2JzID0gY2hpbGRyZW4ubGVuZ3RoICsgMTsKICAgIGZpbmlzaGVkKCk7CgogICAgaWYgKG9wdGlvbnMuYXN5bmMpIHsKICAgICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gRG9uJ3QgYmxvY2sgdGhlIHBhZ2UgZnJvbSByZW5kZXJpbmcKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IHBhcnNlTm9kZShub2RlKTsgfSwgMCk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGRyZW4uZm9yRWFjaChwYXJzZU5vZGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhcnNlTm9kZShub2RlKSB7CiAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBub2RlLkVMRU1FTlRfTk9ERSkgewogICAgICAgIHBhcnNlRWxlbWVudChub2RlLCBzdGFjaywgZmluaXNoZWQpOwogICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IG5vZGUuVEVYVF9OT0RFKSB7CiAgICAgICAgcmVuZGVyVGV4dChlbGVtZW50LCBub2RlLCBzdGFjayk7CiAgICAgICAgZmluaXNoZWQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2hlZCgpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBmaW5pc2hlZChlbCkgewogICAgICBpZiAoLS1qb2JzIDw9IDApewogICAgICAgIFV0aWwubG9nKCJmaW5pc2hlZCByZW5kZXJpbmcgIiArIGNoaWxkcmVuLmxlbmd0aCArICIgY2hpbGRyZW4uIik7CiAgICAgICAgY2IoKTsKICAgICAgfQogICAgfQogIH0KfTsKX2h0bWwyY2FudmFzLlByZWxvYWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgdmFyIGltYWdlcyA9IHsKICAgIG51bUxvYWRlZDogMCwgICAvLyBhbHNvIGZhaWxlZCBhcmUgY291bnRlZCBoZXJlCiAgICBudW1GYWlsZWQ6IDAsCiAgICBudW1Ub3RhbDogMCwKICAgIGNsZWFudXBEb25lOiBmYWxzZQogIH0sCiAgcGFnZU9yaWdpbiwKICBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgbWV0aG9kcywKICBpLAogIGNvdW50ID0gMCwKICBlbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50c1swXSB8fCBkb2N1bWVudC5ib2R5LAogIGRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudCwKICBkb21JbWFnZXMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWcnKSwgLy8gRmV0Y2ggaW1hZ2VzIG9mIHRoZSBwcmVzZW50IGVsZW1lbnQgb25seQogIGltZ0xlbiA9IGRvbUltYWdlcy5sZW5ndGgsCiAgbGluayA9IGRvYy5jcmVhdGVFbGVtZW50KCJhIiksCiAgc3VwcG9ydENPUlMgPSAoZnVuY3Rpb24oIGltZyApewogICAgcmV0dXJuIChpbWcuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCk7CiAgfSkobmV3IEltYWdlKCkpLAogIHRpbWVvdXRUaW1lcjsKCiAgbGluay5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgcGFnZU9yaWdpbiAgPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwoKICBmdW5jdGlvbiBpc1NhbWVPcmlnaW4odXJsKXsKICAgIGxpbmsuaHJlZiA9IHVybDsKICAgIGxpbmsuaHJlZiA9IGxpbmsuaHJlZjsgLy8gWUVTLCBCRUxJRVZFIElUIE9SIE5PVCwgdGhhdCBpcyByZXF1aXJlZCBmb3IgSUU5IC0gaHR0cDovL2pzZmlkZGxlLm5ldC9uaWtsYXN2aC8yZTQ4Yi8KICAgIHZhciBvcmlnaW4gPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwogICAgcmV0dXJuIChvcmlnaW4gPT09IHBhZ2VPcmlnaW4pOwogIH0KCiAgZnVuY3Rpb24gc3RhcnQoKXsKICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogc3RhcnQ6IGltYWdlczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwogICAgaWYgKCFpbWFnZXMuZmlyc3RSdW4gJiYgaW1hZ2VzLm51bUxvYWRlZCA+PSBpbWFnZXMubnVtVG90YWwpewogICAgICBVdGlsLmxvZygiRmluaXNoZWQgbG9hZGluZyBpbWFnZXM6ICMgIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBsZXRlID09PSAiZnVuY3Rpb24iKXsKICAgICAgICBvcHRpb25zLmNvbXBsZXRlKGltYWdlcyk7CiAgICAgIH0KCiAgICB9CiAgfQoKICAvLyBUT0RPIG1vZGlmeSBwcm94eSB0byBzZXJ2ZSBpbWFnZXMgd2l0aCBDT1JTIGVuYWJsZWQsIHdoZXJlIGF2YWlsYWJsZQogIGZ1bmN0aW9uIHByb3h5R2V0SW1hZ2UodXJsLCBpbWcsIGltYWdlT2JqKXsKICAgIHZhciBjYWxsYmFja19uYW1lLAogICAgc2NyaXB0VXJsID0gb3B0aW9ucy5wcm94eSwKICAgIHNjcmlwdDsKCiAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICB1cmwgPSBsaW5rLmhyZWY7IC8vIHdvcmsgYXJvdW5kIGZvciBwYWdlcyB3aXRoIGJhc2UgaHJlZj0iIiBzZXQgLSBXQVJOSU5HOiB0aGlzIG1heSBjaGFuZ2UgdGhlIHVybAoKICAgIGNhbGxiYWNrX25hbWUgPSAnaHRtbDJjYW52YXNfJyArIChjb3VudCsrKTsKICAgIGltYWdlT2JqLmNhbGxiYWNrbmFtZSA9IGNhbGxiYWNrX25hbWU7CgogICAgaWYgKHNjcmlwdFVybC5pbmRleE9mKCI/IikgPiAtMSkgewogICAgICBzY3JpcHRVcmwgKz0gIiYiOwogICAgfSBlbHNlIHsKICAgICAgc2NyaXB0VXJsICs9ICI/IjsKICAgIH0KICAgIHNjcmlwdFVybCArPSAndXJsPScgKyBlbmNvZGVVUklDb21wb25lbnQodXJsKSArICcmY2FsbGJhY2s9JyArIGNhbGxiYWNrX25hbWU7CiAgICBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgogICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gZnVuY3Rpb24oYSl7CiAgICAgIGlmIChhLnN1YnN0cmluZygwLDYpID09PSAiZXJyb3I6Iil7CiAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICBzdGFydCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgIGltZy5zcmMgPSBhOwogICAgICB9CiAgICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpCiAgICAgIHRyeSB7CiAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja19uYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcwogICAgICB9IGNhdGNoKGV4KSB7fQogICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICBzY3JpcHQgPSBudWxsOwogICAgICBkZWxldGUgaW1hZ2VPYmouc2NyaXB0OwogICAgICBkZWxldGUgaW1hZ2VPYmouY2FsbGJhY2tuYW1lOwogICAgfTsKCiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInRleHQvamF2YXNjcmlwdCIpOwogICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgc2NyaXB0VXJsKTsKICAgIGltYWdlT2JqLnNjcmlwdCA9IHNjcmlwdDsKICAgIHdpbmRvdy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CgogIH0KCiAgZnVuY3Rpb24gbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgdHlwZSkgewogICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgdHlwZSksCiAgICBjb250ZW50ID0gc3R5bGUuY29udGVudDsKICAgIGlmIChjb250ZW50LnN1YnN0cigwLCAzKSA9PT0gJ3VybCcpIHsKICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoX2h0bWwyY2FudmFzLlV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoY29udGVudClbMF0uYXJnc1swXSk7CiAgICB9CiAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhzdHlsZS5iYWNrZ3JvdW5kSW1hZ2UsIGVsZW1lbnQpOwogIH0KCiAgZnVuY3Rpb24gbG9hZFBzZXVkb0VsZW1lbnRJbWFnZXMoZWxlbWVudCkgewogICAgbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgIjpiZWZvcmUiKTsKICAgIGxvYWRQc2V1ZG9FbGVtZW50KGVsZW1lbnQsICI6YWZ0ZXIiKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRHcmFkaWVudEltYWdlKGJhY2tncm91bmRJbWFnZSwgYm91bmRzKSB7CiAgICB2YXIgaW1nID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50KGJhY2tncm91bmRJbWFnZSwgYm91bmRzKTsKCiAgICBpZiAoaW1nICE9PSB1bmRlZmluZWQpewogICAgICBpbWFnZXNbYmFja2dyb3VuZEltYWdlXSA9IHsKICAgICAgICBpbWc6IGltZywKICAgICAgICBzdWNjZWVkZWQ6IHRydWUKICAgICAgfTsKICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgc3RhcnQoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGludmFsaWRCYWNrZ3JvdW5kcyhiYWNrZ3JvdW5kX2ltYWdlKSB7CiAgICByZXR1cm4gKGJhY2tncm91bmRfaW1hZ2UgJiYgYmFja2dyb3VuZF9pbWFnZS5tZXRob2QgJiYgYmFja2dyb3VuZF9pbWFnZS5hcmdzICYmIGJhY2tncm91bmRfaW1hZ2UuYXJncy5sZW5ndGggPiAwICk7CiAgfQoKICBmdW5jdGlvbiBsb2FkQmFja2dyb3VuZEltYWdlcyhiYWNrZ3JvdW5kX2ltYWdlLCBlbCkgewogICAgdmFyIGJvdW5kczsKCiAgICBfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlKS5maWx0ZXIoaW52YWxpZEJhY2tncm91bmRzKS5mb3JFYWNoKGZ1bmN0aW9uKGJhY2tncm91bmRfaW1hZ2UpIHsKICAgICAgaWYgKGJhY2tncm91bmRfaW1hZ2UubWV0aG9kID09PSAndXJsJykgewogICAgICAgIG1ldGhvZHMubG9hZEltYWdlKGJhY2tncm91bmRfaW1hZ2UuYXJnc1swXSk7CiAgICAgIH0gZWxzZSBpZihiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZC5tYXRjaCgvXC0/Z3JhZGllbnQkLykpIHsKICAgICAgICBpZihib3VuZHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKGVsKTsKICAgICAgICB9CiAgICAgICAgbG9hZEdyYWRpZW50SW1hZ2UoYmFja2dyb3VuZF9pbWFnZS52YWx1ZSwgYm91bmRzKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRJbWFnZXMgKGVsKSB7CiAgICB2YXIgZWxOb2RlVHlwZSA9IGZhbHNlOwoKICAgIC8vIEZpcmVmb3ggZmFpbHMgd2l0aCBwZXJtaXNzaW9uIGRlbmllZCBvbiBwYWdlcyB3aXRoIGlmcmFtZXMKICAgIHRyeSB7CiAgICAgIFV0aWwuQ2hpbGRyZW4oZWwpLmZvckVhY2goZ2V0SW1hZ2VzKTsKICAgIH0KICAgIGNhdGNoKCBlICkge30KCiAgICB0cnkgewogICAgICBlbE5vZGVUeXBlID0gZWwubm9kZVR5cGU7CiAgICB9IGNhdGNoIChleCkgewogICAgICBlbE5vZGVUeXBlID0gZmFsc2U7CiAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGFjY2VzcyBzb21lIGVsZW1lbnQncyBub2RlVHlwZSAtIEV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgfQoKICAgIGlmIChlbE5vZGVUeXBlID09PSAxIHx8IGVsTm9kZVR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICBsb2FkUHNldWRvRWxlbWVudEltYWdlcyhlbCk7CiAgICAgIHRyeSB7CiAgICAgICAgbG9hZEJhY2tncm91bmRJbWFnZXMoVXRpbC5nZXRDU1MoZWwsICdiYWNrZ3JvdW5kSW1hZ2UnKSwgZWwpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IGZhaWxlZCB0byBnZXQgYmFja2dyb3VuZC1pbWFnZSAtIEV4Y2VwdGlvbjogIiArIGUubWVzc2FnZSk7CiAgICAgIH0KICAgICAgbG9hZEJhY2tncm91bmRJbWFnZXMoZWwpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaikgewogICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIGltYWdlT2JqLnRpbWVyICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgLy8gQ09SUyBzdWNjZWVkZWQKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBpbWFnZU9iai50aW1lciApOwogICAgICB9CgogICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IHRydWU7CiAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgIHN0YXJ0KCk7CiAgICB9OwogICAgaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKGltZy5jcm9zc09yaWdpbiA9PT0gImFub255bW91cyIpIHsKICAgICAgICAvLyBDT1JTIGZhaWxlZAogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7CgogICAgICAgIC8vIGxldCdzIHRyeSB3aXRoIHByb3h5IGluc3RlYWQKICAgICAgICBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICB2YXIgc3JjID0gaW1nLnNyYzsKICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgaW1hZ2VPYmouaW1nID0gaW1nOwogICAgICAgICAgaW1nLnNyYyA9IHNyYzsKCiAgICAgICAgICBwcm94eUdldEltYWdlKCBpbWcuc3JjLCBpbWcsIGltYWdlT2JqICk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgIHN0YXJ0KCk7CiAgICB9OwogIH0KCiAgbWV0aG9kcyA9IHsKICAgIGxvYWRJbWFnZTogZnVuY3Rpb24oIHNyYyApIHsKICAgICAgdmFyIGltZywgaW1hZ2VPYmo7CiAgICAgIGlmICggc3JjICYmIGltYWdlc1tzcmNdID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgaWYgKCBzcmMubWF0Y2goL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaSkgKSB7CiAgICAgICAgICBpbWcuc3JjID0gc3JjLnJlcGxhY2UoL3VybFwoWyciXXswLH18WyciXXswLH1cKSQvaWcsICcnKTsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICB9IGVsc2UgaWYgKCBpc1NhbWVPcmlnaW4oIHNyYyApIHx8IG9wdGlvbnMuYWxsb3dUYWludCA9PT0gIHRydWUgKSB7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwogICAgICAgIH0gZWxzZSBpZiAoIHN1cHBvcnRDT1JTICYmICFvcHRpb25zLmFsbG93VGFpbnQgJiYgb3B0aW9ucy51c2VDT1JTICkgewogICAgICAgICAgLy8gYXR0ZW1wdCB0byBsb2FkIHdpdGggQ09SUwoKICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgICAgaW1nLnNyYyA9IHNyYzsKICAgICAgICB9IGVsc2UgaWYgKCBvcHRpb25zLnByb3h5ICkgewogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIHNyYywgaW1nLCBpbWFnZU9iaiApOwogICAgICAgIH0KICAgICAgfQoKICAgIH0sCiAgICBjbGVhbnVwRE9NOiBmdW5jdGlvbihjYXVzZSkgewogICAgICB2YXIgaW1nLCBzcmM7CiAgICAgIGlmICghaW1hZ2VzLmNsZWFudXBEb25lKSB7CiAgICAgICAgaWYgKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBiZWNhdXNlOiAiICsgY2F1c2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYWZ0ZXIgdGltZW91dDogIiArIG9wdGlvbnMudGltZW91dCArICIgbXMuIik7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHNyYyBpbiBpbWFnZXMpIHsKICAgICAgICAgIGlmIChpbWFnZXMuaGFzT3duUHJvcGVydHkoc3JjKSkgewogICAgICAgICAgICBpbWcgPSBpbWFnZXNbc3JjXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbWcgPT09ICJvYmplY3QiICYmIGltZy5jYWxsYmFja25hbWUgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gY2FuY2VsIHByb3h5IGltYWdlIHJlcXVlc3QKICAgICAgICAgICAgICB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2ltZy5jYWxsYmFja25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgfSBjYXRjaChleCkge30KICAgICAgICAgICAgICBpZiAoaW1nLnNjcmlwdCAmJiBpbWcuc2NyaXB0LnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgIGltZy5zY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCAiYWJvdXQ6YmxhbmsiKTsgIC8vIHRyeSB0byBjYW5jZWwgcnVubmluZyByZXF1ZXN0CiAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1nLnNjcmlwdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbmVkIHVwIGZhaWxlZCBpbWc6ICciICsgc3JjICsgIicgU3RlcHM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBjYW5jZWwgYW55IHBlbmRpbmcgcmVxdWVzdHMKICAgICAgICBpZih3aW5kb3cuc3RvcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB3aW5kb3cuc3RvcCgpOwogICAgICAgIH0gZWxzZSBpZihkb2N1bWVudC5leGVjQ29tbWFuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiU3RvcCIsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRvY3VtZW50LmNsb3NlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRvY3VtZW50LmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIGltYWdlcy5jbGVhbnVwRG9uZSA9IHRydWU7CiAgICAgICAgaWYgKCEoY2F1c2UgJiYgdHlwZW9mIGNhdXNlID09PSAic3RyaW5nIikpIHsKICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHJlbmRlcmluZ0RvbmU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGltZW91dFRpbWVyKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICB9CiAgICB9CiAgfTsKCiAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHsKICAgIHRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG1ldGhvZHMuY2xlYW51cERPTSwgb3B0aW9ucy50aW1lb3V0KTsKICB9CgogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZCBzdGFydHM6IGZpbmRpbmcgYmFja2dyb3VuZC1pbWFnZXMnKTsKICBpbWFnZXMuZmlyc3RSdW4gPSB0cnVlOwoKICBnZXRJbWFnZXMoZWxlbWVudCk7CgogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRmluZGluZyBpbWFnZXMnKTsKICAvLyBsb2FkIDxpbWc+IGltYWdlcwogIGZvciAoaSA9IDA7IGkgPCBpbWdMZW47IGkrPTEpewogICAgbWV0aG9kcy5sb2FkSW1hZ2UoIGRvbUltYWdlc1tpXS5nZXRBdHRyaWJ1dGUoICJzcmMiICkgKTsKICB9CgogIGltYWdlcy5maXJzdFJ1biA9IGZhbHNlOwogIFV0aWwubG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRG9uZS4nKTsKICBpZiAoaW1hZ2VzLm51bVRvdGFsID09PSBpbWFnZXMubnVtTG9hZGVkKSB7CiAgICBzdGFydCgpOwogIH0KCiAgcmV0dXJuIG1ldGhvZHM7Cn07CgpfaHRtbDJjYW52YXMuUmVuZGVyZXIgPSBmdW5jdGlvbihwYXJzZVF1ZXVlLCBvcHRpb25zKXsKICBmdW5jdGlvbiBzb3J0WmluZGV4KGEsIGIpIHsKICAgIGlmIChhID09PSAnY2hpbGRyZW4nKSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0gZWxzZSBpZiAoYiA9PT0gJ2NoaWxkcmVuJykgewogICAgICByZXR1cm4gMTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhIC0gYjsKICAgIH0KICB9CgogIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3ppbmRleC5odG1sCiAgZnVuY3Rpb24gY3JlYXRlUmVuZGVyUXVldWUocGFyc2VRdWV1ZSkgewogICAgdmFyIHF1ZXVlID0gW10sCiAgICByb290Q29udGV4dDsKCiAgICByb290Q29udGV4dCA9IChmdW5jdGlvbiBidWlsZFN0YWNraW5nQ29udGV4dChyb290Tm9kZSkgewogICAgICB2YXIgcm9vdENvbnRleHQgPSB7fTsKICAgICAgZnVuY3Rpb24gaW5zZXJ0KGNvbnRleHQsIG5vZGUsIHNwZWNpYWxQYXJlbnQpIHsKICAgICAgICB2YXIgemkgPSAobm9kZS56SW5kZXguemluZGV4ID09PSAnYXV0bycpID8gMCA6IE51bWJlcihub2RlLnpJbmRleC56aW5kZXgpLAogICAgICAgIGNvbnRleHRGb3JDaGlsZHJlbiA9IGNvbnRleHQsIC8vIHRoZSBzdGFja2luZyBjb250ZXh0IGZvciBjaGlsZHJlbgogICAgICAgIGlzUG9zaXRpb25lZCA9IG5vZGUuekluZGV4LmlzUG9zaXRpb25lZCwKICAgICAgICBpc0Zsb2F0ZWQgPSBub2RlLnpJbmRleC5pc0Zsb2F0ZWQsCiAgICAgICAgc3R1YiA9IHtub2RlOiBub2RlfSwKICAgICAgICBjaGlsZHJlbkRlc3QgPSBzcGVjaWFsUGFyZW50OyAvLyB3aGVyZSBjaGlsZHJlbiB3aXRob3V0IHotaW5kZXggc2hvdWxkIGJlIHB1c2hlZCBpbnRvCgogICAgICAgIGlmIChub2RlLnpJbmRleC5vd25TdGFja2luZykgewogICAgICAgICAgY29udGV4dEZvckNoaWxkcmVuID0gc3R1Yi5jb250ZXh0ID0gewogICAgICAgICAgICAgIGNoaWxkcmVuOiBbe25vZGU6bm9kZSwgY2hpbGRyZW46IFtdfV0KICAgICAgICAgIH07CiAgICAgICAgICBjaGlsZHJlbkRlc3QgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIGlmIChpc1Bvc2l0aW9uZWQgfHwgaXNGbG9hdGVkKSB7CiAgICAgICAgICBjaGlsZHJlbkRlc3QgPSBzdHViLmNoaWxkcmVuID0gW107CiAgICAgICAgfQoKICAgICAgICBpZiAoemkgPT09IDAgJiYgc3BlY2lhbFBhcmVudCkgewogICAgICAgICAgc3BlY2lhbFBhcmVudC5wdXNoKHN0dWIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIWNvbnRleHRbemldKSB7IGNvbnRleHRbemldID0gW107IH0KICAgICAgICAgIGNvbnRleHRbemldLnB1c2goc3R1Yik7CiAgICAgICAgfQoKICAgICAgICBub2RlLnpJbmRleC5jaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkTm9kZSkgewogICAgICAgICAgaW5zZXJ0KGNvbnRleHRGb3JDaGlsZHJlbiwgY2hpbGROb2RlLCBjaGlsZHJlbkRlc3QpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGluc2VydChyb290Q29udGV4dCwgcm9vdE5vZGUpOwogICAgICByZXR1cm4gcm9vdENvbnRleHQ7CiAgICB9KShwYXJzZVF1ZXVlKTsKCiAgICBmdW5jdGlvbiBzb3J0Wihjb250ZXh0KSB7CiAgICAgIE9iamVjdC5rZXlzKGNvbnRleHQpLnNvcnQoc29ydFppbmRleCkuZm9yRWFjaChmdW5jdGlvbih6aSkgewogICAgICAgIHZhciBub25Qb3NpdGlvbmVkID0gW10sCiAgICAgICAgZmxvYXRlZCA9IFtdLAogICAgICAgIHBvc2l0aW9uZWQgPSBbXSwKICAgICAgICBsaXN0ID0gW107CgogICAgICAgIC8vIHBvc2l0aW9uZWQgYWZ0ZXIgc3RhdGljCiAgICAgICAgY29udGV4dFt6aV0uZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICBpZiAodi5ub2RlLnpJbmRleC5pc1Bvc2l0aW9uZWQgfHwgdi5ub2RlLnpJbmRleC5vcGFjaXR5IDwgMSkgewogICAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLWNvbG9yLyN0cmFuc3BhcmVuY3kKICAgICAgICAgICAgLy8gbm9uLXBvc2l0aW9uZWQgZWxlbWVudCB3aXRoIG9wYWN0aXkgPCAxIHNob3VsZCBiZSBzdGFja2VkIGFzIGlmIGl0IHdlcmUgYSBwb3NpdGlvbmVkIGVsZW1lbnQgd2l0aCDigJh6LWluZGV4OiAw4oCZIGFuZCDigJhvcGFjaXR5OiAx4oCZLgogICAgICAgICAgICBwb3NpdGlvbmVkLnB1c2godik7CiAgICAgICAgICB9IGVsc2UgaWYgKHYubm9kZS56SW5kZXguaXNGbG9hdGVkKSB7CiAgICAgICAgICAgIGZsb2F0ZWQucHVzaCh2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5vblBvc2l0aW9uZWQucHVzaCh2KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgKGZ1bmN0aW9uIHdhbGsoYXJyKSB7CiAgICAgICAgICBhcnIuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIGxpc3QucHVzaCh2KTsKICAgICAgICAgICAgaWYgKHYuY2hpbGRyZW4pIHsgd2Fsayh2LmNoaWxkcmVuKTsgfQogICAgICAgICAgfSk7CiAgICAgICAgfSkobm9uUG9zaXRpb25lZC5jb25jYXQoZmxvYXRlZCwgcG9zaXRpb25lZCkpOwoKICAgICAgICBsaXN0LmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgaWYgKHYuY29udGV4dCkgewogICAgICAgICAgICBzb3J0Wih2LmNvbnRleHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVldWUucHVzaCh2Lm5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICBzb3J0Wihyb290Q29udGV4dCk7CgogICAgcmV0dXJuIHF1ZXVlOwogIH0KCiAgZnVuY3Rpb24gZ2V0UmVuZGVyZXIocmVuZGVyZXJOYW1lKSB7CiAgICB2YXIgcmVuZGVyZXI7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLnJlbmRlcmVyID09PSAic3RyaW5nIiAmJiBfaHRtbDJjYW52YXMuUmVuZGVyZXJbcmVuZGVyZXJOYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJlbmRlcmVyID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyW3JlbmRlcmVyTmFtZV0ob3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXJlck5hbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVuZGVyZXIgPSByZW5kZXJlck5hbWUob3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcmVuZGVyZXIiKTsKICAgIH0KCiAgICBpZiAoIHR5cGVvZiByZW5kZXJlciAhPT0gImZ1bmN0aW9uIiApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJlbmRlcmVyIGRlZmluZWQiKTsKICAgIH0KICAgIHJldHVybiByZW5kZXJlcjsKICB9CgogIHJldHVybiBnZXRSZW5kZXJlcihvcHRpb25zLnJlbmRlcmVyKShwYXJzZVF1ZXVlLCBvcHRpb25zLCBkb2N1bWVudCwgY3JlYXRlUmVuZGVyUXVldWUocGFyc2VRdWV1ZS5zdGFjayksIF9odG1sMmNhbnZhcyk7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5TdXBwb3J0ID0gZnVuY3Rpb24gKG9wdGlvbnMsIGRvYykgewoKICBmdW5jdGlvbiBzdXBwb3J0U1ZHUmVuZGVyaW5nKCkgewogICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpLAogICAgY2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogICAgY3R4ID0gKGNhbnZhcy5nZXRDb250ZXh0ID09PSB1bmRlZmluZWQpID8gZmFsc2UgOiBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIGlmIChjdHggPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5oZWlnaHQgPSAxMDsKICAgIGltZy5zcmMgPSBbCiAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAiPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwKICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nMTAnIGhlaWdodD0nMTAnPiIsCiAgICAiPGRpdiB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J3dpZHRoOjEwO2hlaWdodDoxMDsnPiIsCiAgICAic3VwIiwKICAgICI8L2Rpdj4iLAogICAgIjwvZm9yZWlnbk9iamVjdD4iLAogICAgIjwvc3ZnPiIKICAgIF0uam9pbigiIik7CiAgICB0cnkgewogICAgICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7CiAgICAgIGNhbnZhcy50b0RhdGFVUkwoKTsKICAgIH0gY2F0Y2goZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBfaHRtbDJjYW52YXMuVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQYXJzZTogU1ZHIHBvd2VyZWQgcmVuZGVyaW5nIGF2YWlsYWJsZScpOwogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLyBUZXN0IHdoZXRoZXIgd2UgY2FuIHVzZSByYW5nZXMgdG8gbWVhc3VyZSBib3VuZGluZyBib3hlcwogIC8vIE9wZXJhIGRvZXNuJ3QgcHJvdmlkZSB2YWxpZCBib3VuZHMuaGVpZ2h0L2JvdHRvbSBldmVuIHRob3VnaCBpdCBzdXBwb3J0cyB0aGUgbWV0aG9kLgoKICBmdW5jdGlvbiBzdXBwb3J0UmFuZ2VCb3VuZHMoKSB7CiAgICB2YXIgciwgdGVzdEVsZW1lbnQsIHJhbmdlQm91bmRzLCByYW5nZUhlaWdodCwgc3VwcG9ydCA9IGZhbHNlOwoKICAgIGlmIChkb2MuY3JlYXRlUmFuZ2UpIHsKICAgICAgciA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICBpZiAoci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICB0ZXN0RWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCdib3VuZHRlc3QnKTsKICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTIzcHgiOwogICAgICAgIHRlc3RFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHRlc3RFbGVtZW50KTsKCiAgICAgICAgci5zZWxlY3ROb2RlKHRlc3RFbGVtZW50KTsKICAgICAgICByYW5nZUJvdW5kcyA9IHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgcmFuZ2VIZWlnaHQgPSByYW5nZUJvdW5kcy5oZWlnaHQ7CgogICAgICAgIGlmIChyYW5nZUhlaWdodCA9PT0gMTIzKSB7CiAgICAgICAgICBzdXBwb3J0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZG9jLmJvZHkucmVtb3ZlQ2hpbGQodGVzdEVsZW1lbnQpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHN1cHBvcnQ7CiAgfQoKICByZXR1cm4gewogICAgcmFuZ2VCb3VuZHM6IHN1cHBvcnRSYW5nZUJvdW5kcygpLAogICAgc3ZnUmVuZGVyaW5nOiBvcHRpb25zLnN2Z1JlbmRlcmluZyAmJiBzdXBwb3J0U1ZHUmVuZGVyaW5nKCkKICB9Owp9Owp3aW5kb3cuaHRtbDJjYW52YXMgPSBmdW5jdGlvbihlbGVtZW50cywgb3B0cykgewogIGVsZW1lbnRzID0gKGVsZW1lbnRzLmxlbmd0aCkgPyBlbGVtZW50cyA6IFtlbGVtZW50c107CiAgdmFyIHF1ZXVlLAogIGNhbnZhcywKICBvcHRpb25zID0gewogICAgLy8gZ2VuZXJhbAogICAgbG9nZ2luZzogZmFsc2UsCiAgICBlbGVtZW50czogZWxlbWVudHMsCiAgICBiYWNrZ3JvdW5kOiAiI2ZmZiIsCgogICAgLy8gcHJlbG9hZCBvcHRpb25zCiAgICBwcm94eTogbnVsbCwKICAgIHRpbWVvdXQ6IDAsICAgIC8vIG5vIHRpbWVvdXQKICAgIHVzZUNPUlM6IGZhbHNlLCAvLyB0cnkgdG8gbG9hZCBpbWFnZXMgYXMgQ09SUyAod2hlcmUgYXZhaWxhYmxlKSwgYmVmb3JlIGZhbGxpbmcgYmFjayB0byBwcm94eQogICAgYWxsb3dUYWludDogZmFsc2UsIC8vIHdoZXRoZXIgdG8gYWxsb3cgaW1hZ2VzIHRvIHRhaW50IHRoZSBjYW52YXMsIHdvbid0IG5lZWQgcHJveHkgaWYgc2V0IHRvIHRydWUKCiAgICAvLyBwYXJzZSBvcHRpb25zCiAgICBzdmdSZW5kZXJpbmc6IGZhbHNlLCAvLyB1c2Ugc3ZnIHBvd2VyZWQgcmVuZGVyaW5nIHdoZXJlIGF2YWlsYWJsZSAoRkYxMSspCiAgICBpZ25vcmVFbGVtZW50czogIklGUkFNRXxPQkpFQ1R8UEFSQU0iLAogICAgdXNlT3ZlcmZsb3c6IHRydWUsCiAgICBsZXR0ZXJSZW5kZXJpbmc6IGZhbHNlLAogICAgY2hpbmVzZTogZmFsc2UsCiAgICBhc3luYzogZmFsc2UsIC8vIElmIHRydWUsIHBhcnNpbmcgd2lsbCBub3QgYmxvY2ssIGJ1dCBpZiB0aGUgdXNlciBzY3JvbGxzIGR1cmluZyBwYXJzZSB0aGUgaW1hZ2UgY2FuIGdldCB3ZWlyZAoKICAgIC8vIHJlbmRlciBvcHRpb25zCiAgICB3aWR0aDogbnVsbCwKICAgIGhlaWdodDogbnVsbCwKICAgIHRhaW50VGVzdDogdHJ1ZSwgLy8gZG8gYSB0YWludCB0ZXN0IHdpdGggYWxsIGltYWdlcyBiZWZvcmUgYXBwbHlpbmcgdG8gY2FudmFzCiAgICByZW5kZXJlcjogIkNhbnZhcyIKICB9OwoKICBvcHRpb25zID0gX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpOwoKICBfaHRtbDJjYW52YXMubG9nZ2luZyA9IG9wdGlvbnMubG9nZ2luZzsKICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oIGltYWdlcyApIHsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMub25wcmVsb2FkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCBvcHRpb25zLm9ucHJlbG9hZGVkKCBpbWFnZXMgKSA9PT0gZmFsc2UgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgb3B0aW9ucywgZnVuY3Rpb24ocXVldWUpIHsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucGFyc2VkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgaWYgKCBvcHRpb25zLm9ucGFyc2VkKCBxdWV1ZSApID09PSBmYWxzZSApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNhbnZhcyA9IF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIG9wdGlvbnMgKTsKCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnJlbmRlcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgb3B0aW9ucy5vbnJlbmRlcmVkKCBjYW52YXMgKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLy8gZm9yIHBhZ2VzIHdpdGhvdXQgaW1hZ2VzLCB3ZSBzdGlsbCB3YW50IHRoaXMgdG8gYmUgYXN5bmMsIGkuZS4gcmV0dXJuIG1ldGhvZHMgYmVmb3JlIGV4ZWN1dGluZwogIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpewogICAgX2h0bWwyY2FudmFzLlByZWxvYWQoIG9wdGlvbnMgKTsKICB9LCAwICk7CgogIHJldHVybiB7CiAgICByZW5kZXI6IGZ1bmN0aW9uKCBxdWV1ZSwgb3B0cyApIHsKICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiggaW1hZ2VzLCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlBhcnNlKCBpbWFnZXMsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIHByZWxvYWQ6IGZ1bmN0aW9uKCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlByZWxvYWQoIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgfSwKICAgIGxvZzogX2h0bWwyY2FudmFzLlV0aWwubG9nCiAgfTsKfTsKCndpbmRvdy5odG1sMmNhbnZhcy5sb2cgPSBfaHRtbDJjYW52YXMuVXRpbC5sb2c7IC8vIGZvciByZW5kZXJlcnMKd2luZG93Lmh0bWwyY2FudmFzLlJlbmRlcmVyID0gewogIENhbnZhczogdW5kZWZpbmVkIC8vIFdlIGFyZSBhc3N1bWluZyB0aGlzIHdpbGwgYmUgdXNlZAp9OwpfaHRtbDJjYW52YXMuUmVuZGVyZXIuQ2FudmFzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICB2YXIgZG9jID0gZG9jdW1lbnQsCiAgc2FmZUltYWdlcyA9IFtdLAogIHRlc3RDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICB0ZXN0Y3R4ID0gdGVzdENhbnZhcy5nZXRDb250ZXh0KCIyZCIpLAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBjYW52YXMgPSBvcHRpb25zLmNhbnZhcyB8fCBkb2MuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CgogIGZ1bmN0aW9uIGNyZWF0ZVNoYXBlKGN0eCwgYXJncykgewogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uKGFyZykgewogICAgICBjdHhbYXJnLm5hbWVdLmFwcGx5KGN0eCwgYXJnWydhcmd1bWVudHMnXSk7CiAgICB9KTsKICAgIGN0eC5jbG9zZVBhdGgoKTsKICB9CgogIGZ1bmN0aW9uIHNhZmVJbWFnZShpdGVtKSB7CiAgICBpZiAoc2FmZUltYWdlcy5pbmRleE9mKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLnNyYykgPT09IC0xKSB7CiAgICAgIHRlc3RjdHguZHJhd0ltYWdlKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLCAwLCAwKTsKICAgICAgdHJ5IHsKICAgICAgICB0ZXN0Y3R4LmdldEltYWdlRGF0YSgwLCAwLCAxLCAxKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgdGVzdENhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgICB0ZXN0Y3R4ID0gdGVzdENhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBzYWZlSW1hZ2VzLnB1c2goaXRlbVsnYXJndW1lbnRzJ11bMF0uc3JjKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVySXRlbShjdHgsIGl0ZW0pIHsKICAgIHN3aXRjaChpdGVtLnR5cGUpewogICAgICBjYXNlICJ2YXJpYWJsZSI6CiAgICAgICAgY3R4W2l0ZW0ubmFtZV0gPSBpdGVtWydhcmd1bWVudHMnXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgIHN3aXRjaChpdGVtLm5hbWUpIHsKICAgICAgICAgIGNhc2UgImNyZWF0ZVBhdHRlcm4iOgogICAgICAgICAgICBpZiAoaXRlbVsnYXJndW1lbnRzJ11bMF0ud2lkdGggPiAwICYmIGl0ZW1bJ2FyZ3VtZW50cyddWzBdLmhlaWdodCA+IDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGN0eC5jcmVhdGVQYXR0ZXJuKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLCAicmVwZWF0Iik7CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBFcnJvciBjcmVhdGluZyBwYXR0ZXJuIiwgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJkcmF3U2hhcGUiOgogICAgICAgICAgICBjcmVhdGVTaGFwZShjdHgsIGl0ZW1bJ2FyZ3VtZW50cyddKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJkcmF3SW1hZ2UiOgogICAgICAgICAgICBpZiAoaXRlbVsnYXJndW1lbnRzJ11bOF0gPiAwICYmIGl0ZW1bJ2FyZ3VtZW50cyddWzddID4gMCkgewogICAgICAgICAgICAgIGlmICghb3B0aW9ucy50YWludFRlc3QgfHwgKG9wdGlvbnMudGFpbnRUZXN0ICYmIHNhZmVJbWFnZShpdGVtKSkpIHsKICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoIGN0eCwgaXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjdHhbaXRlbS5uYW1lXS5hcHBseShjdHgsIGl0ZW1bJ2FyZ3VtZW50cyddKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICByZXR1cm4gZnVuY3Rpb24ocGFyc2VkRGF0YSwgb3B0aW9ucywgZG9jdW1lbnQsIHF1ZXVlLCBfaHRtbDJjYW52YXMpIHsKICAgIHZhciBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKSwKICAgIG5ld0NhbnZhcywKICAgIGJvdW5kcywKICAgIGZzdHlsZSwKICAgIHpTdGFjayA9IHBhcnNlZERhdGEuc3RhY2s7CgogICAgY2FudmFzLndpZHRoID0gY2FudmFzLnN0eWxlLndpZHRoID0gIG9wdGlvbnMud2lkdGggfHwgelN0YWNrLmN0eC53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQ7CgogICAgZnN0eWxlID0gY3R4LmZpbGxTdHlsZTsKICAgIGN0eC5maWxsU3R5bGUgPSAoVXRpbC5pc1RyYW5zcGFyZW50KHBhcnNlZERhdGEuYmFja2dyb3VuZENvbG9yKSAmJiBvcHRpb25zLmJhY2tncm91bmQgIT09IHVuZGVmaW5lZCkgPyBvcHRpb25zLmJhY2tncm91bmQgOiBwYXJzZWREYXRhLmJhY2tncm91bmRDb2xvcjsKICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgY3R4LmZpbGxTdHlsZSA9IGZzdHlsZTsKICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oc3RvcmFnZUNvbnRleHQpIHsKICAgICAgLy8gc2V0IGNvbW1vbiBzZXR0aW5ncyBmb3IgY2FudmFzCiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsKICAgICAgY3R4LnNhdmUoKTsKCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ubWF0cml4KSB7CiAgICAgICAgY3R4LnRyYW5zbGF0ZShzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzBdLCBzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzFdKTsKICAgICAgICBjdHgudHJhbnNmb3JtLmFwcGx5KGN0eCwgc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm1hdHJpeCk7CiAgICAgICAgY3R4LnRyYW5zbGF0ZSgtc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblswXSwgLXN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMV0pOwogICAgICB9CgogICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY2xpcCl7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5yZWN0KHN0b3JhZ2VDb250ZXh0LmNsaXAubGVmdCwgc3RvcmFnZUNvbnRleHQuY2xpcC50b3AsIHN0b3JhZ2VDb250ZXh0LmNsaXAud2lkdGgsIHN0b3JhZ2VDb250ZXh0LmNsaXAuaGVpZ2h0KTsKICAgICAgICBjdHguY2xpcCgpOwogICAgICB9CgogICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2UpIHsKICAgICAgICBzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIHJlbmRlckl0ZW0oY3R4LCBpdGVtKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0pOwoKICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IENhbnZhcyByZW5kZXJlciBkb25lIC0gcmV0dXJuaW5nIGNhbnZhcyBvYmoiKTsKCiAgICBpZiAob3B0aW9ucy5lbGVtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmVsZW1lbnRzWzBdID09PSAib2JqZWN0IiAmJiBvcHRpb25zLmVsZW1lbnRzWzBdLm5vZGVOYW1lICE9PSAiQk9EWSIpIHsKICAgICAgICAvLyBjcm9wIGltYWdlIHRvIHRoZSBib3VuZHMgb2Ygc2VsZWN0ZWQgKHNpbmdsZSkgZWxlbWVudAogICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyhvcHRpb25zLmVsZW1lbnRzWzBdKTsKICAgICAgICBuZXdDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBuZXdDYW52YXMud2lkdGggPSBNYXRoLmNlaWwoYm91bmRzLndpZHRoKTsKICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gTWF0aC5jZWlsKGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGN0eCA9IG5ld0NhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwoKICAgICAgICBjdHguZHJhd0ltYWdlKGNhbnZhcywgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCwgMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICBjYW52YXMgPSBudWxsOwogICAgICAgIHJldHVybiBuZXdDYW52YXM7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH07Cn07Cn0pKHdpbmRvdyxkb2N1bWVudCk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 14:53:11 GMT",
                    "Content-Length": "94009",
                    "Date": "Sat, 08 Nov 2014 14:53:11 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}